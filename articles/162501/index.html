<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Measuring the performance of "cloud" drives - saving MySQL</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Recently, in the cloud environments and hosting more and more began to fall "virtual" hard drives. The hoster‚Äôs technical service can assure that the ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Measuring the performance of "cloud" drives - saving MySQL</h1><div class="post__text post__text-html js-mediator-article">  Recently, in the cloud environments and hosting more and more began to fall "virtual" hard drives.  The hoster‚Äôs technical service can assure that the ‚Äúvirtual‚Äù disk is as fast as a dozen raids 10 (raid 100 ;-)) and holds hundreds or even thousands of IOPS ‚Äî however, MySQL is noticeably slower for clients.  And how to prove it to a hoster? <br><br>  The problem is that measuring the ‚Äúspeed‚Äù of a virtual hard disk from inside a virtual machine is not easy, because  it is unclear what to measure in the first place, what and why.  And you need to do this to convince the virtual configuration administrators that this is not about the application and MySQL settings.  And it was necessary, as they say, to simply ‚Äúwash our hands‚Äù before reading the <a href="http://www.hds.com/products/storage-systems/hitachi-unified-storage-100-family.html">manual to the vault</a> . <br><br>  In this article, I will illustrate a simple method for finding the ‚Äútipping point‚Äù of virtual hard disk performance using the tools available in distributions - sysbench and iostat.  We will also measure the ‚Äútipping point‚Äù of Amazon‚Äôs known EBS virtual discs, both conventional EBS and Provisioned IOPS EBS (1000 and 2000 IOPS). <br><a name="habracut"></a><br><h4>  Theory </h4><br>  To hell!  Too many dimensions and letters ‚Äî sequential read / write, random read / write, rewrite, the effect of the kernel file cache, query queue optimization, options for the file system architecture ... let's see how the disk, or what is behind it in the network is hidden, breathed. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      And so that it was not boring, let's add a little romance to gnu.org :-) <br><br><img src="https://habrastorage.org/storage2/1e7/db7/8a4/1e7db78a423b959dec82a8b35fb33e40.jpg"><br><br><h4>  How MySQL loads the disk </h4><br>  For InnoDB, for a typical web application, if the dataset does not fit in the RAM (this is why the database was invented ;-)), the information will mainly be read from disk in a random order (buffer pool pages and clustered on disk), and recorded - sequentially (transaction logs and binary log). <br><br>  Periodically buffer pool from RAM will be flushed to disk - random write.  We immediately exclude the absence of a write cache and a ‚Äúbattery‚Äù in the virtual storage - it should be, otherwise MySQL in ACID mode (innodb-flush-log-at-trx-commit = 1) will simply die of regret. <br><br>  It is important to understand here that MySQL client requests are executed in parallel threads - and the disk will be loaded, respectively, by several threads simultaneously. <br><br><h4>  Create load </h4><br>  Let's start with a simple Amazon EBS disk.  We will load the virtual disk with the <a href="http://sysbench.sourceforge.net/">sysbench</a> tool (it is available in CentOS in packages, it is easy to assemble from source): <br><pre><code class="bash hljs">yum install sysbench mkdir -p /mount/disk_ebs/mysql/test_folder <span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> /mount/disk_ebs/mysql/test_folder sysbench --<span class="hljs-built_in"><span class="hljs-built_in">test</span></span>=fileio --file-total-size=16G prepare</code> </pre> <br>  The important point is that we create a total amount of test files (16G), which is at least 2 times the amount of RAM in the virtual machine (do not ask why 2 times ;-), the more - the better).  This is necessary to reduce the effect of the operating system file cache - when re-launching test files, it is better, therefore, to regenerate again (or create several test folders and switch between them). <br><br>  Now we create load in N threads, emulating ~ N clients of the DBMS server that execute queries (yes, I know that there are several service flows inside the DBMS, but for now let's not complicate things).  Suppose it is expected that 10 Apaches will simultaneously work with the database: <br><pre> <code class="bash hljs">sysbench --num-threads=10 --<span class="hljs-built_in"><span class="hljs-built_in">test</span></span>=fileio --file-test-mode=rndrw --max-time=180 --file-rw-ratio=<span class="hljs-string"><span class="hljs-string">'2'</span></span> --file-total-size=16G --max-requests=1000000 run</code> </pre><br><br><h4>  What are we measuring? </h4><br>  Now the fun part.  We are not interested in what results sysbench will show - it only gives us a load.  We are just watching how the virtual disk feels under load: <br><pre> <code class="bash hljs">iostat ‚Äìxm 10 Device: rrqm/s wrqm/sr/sw/s rMB/s wMB/s avgrq-sz avgqu-sz await svctm %util xvdm 0.00 0.00 120.50 0.00 2.05 0.00 34.79 10.50 87.47 8.30 100.00</code> </pre><br>  The disk is ‚Äúswamped‚Äù with requests most of the CPU time, as seen by ‚Äú% util = 100‚Äù - the disk driver accumulates requests into the queue and as the device is ready it ‚Äúfeeds‚Äù them (some confuse this indicator with the bus bandwidth to the disk, which, of course Wrong).  It is clear that if the driver is forced to wait almost all the time, then the disk is loaded to capacity. <br><br>  The average processing time for a single ‚Äúsvctm‚Äù request is 8.3 ms.  Too much, but normal for Amazon drives.  There is nothing criminal - ordinary physics. <br><br>  The average waiting time for processing an ‚Äúawait‚Äù request is 87.47 ms and the average length of the request queue in the avgqu-sz disk driver is 10.5.  This is a lot, wait almost 100 ms to process a single request!  Obviously, how this value is obtained - roughly the queue size (avgqu-sz) is multiplied by the processing time of a single request (svctm). <br><br>  So, we see that only 10 concurrent requests for arbitrary read / write (keys - file-test-mode = rndrw and - file-rw-ratio = '2') result in slowing down work with a virtual hard disk. <br><br>  So much so that you have to wait for one request for almost 100 ms.  And if the web page creates 200 disk requests - how long will it be built?  20 seconds? <br><br>  Interestingly, and at what number of threads does the Amazon disk begin to accumulate the queue and serve requests faster at least 50 ms (better than generally less than 20 ms - subjectively)?  We see that with 5 threads.  Of course, this is a weak indicator, you cannot do without a software raid ... <br><pre> <code class="bash hljs">Device: rrqm/s wrqm/sr/sw/s rMB/s wMB/s avgrq-sz avgqu-sz await svctm %util xvdm 0.00 0.00 127.50 0.00 2.05 0.00 32.88 5.10 39.78 7.84 100.00</code> </pre><br>  We see that the queue size is 5.1 and the execution time of one request is 39.78. <br><br><h4>  Testing Amazon's ‚Äúfast‚Äù virtual disks </h4><br>  Relatively recently, Amazon announced "fast" drives with a guaranteed number of IOPS (IOPS theory is as extensive as our country google, <a href="http://en.wikipedia.org/wiki/IOPS">en.wikipedia.org/wiki/IOPS</a> ).  We know that mere mortal SATA drives do not hold more than 100 IOPS (simultaneous read and write), and, unfortunately, also mortal 15k SAS drives ‚Äî no more than ~ 200 IOPS.  It is also known that SSD disks and SAN on other technologies can master hundreds, and even thousands of IOPS - it is clear that they are much more expensive. <br><br>  So, let's see at what number of simultaneous streams the ‚Äúfast‚Äù Amazon virtual disks start to blunt and collect requests into the queue.  Break the goat left leg! <br><img src="https://habrastorage.org/storage2/6a2/aec/668/6a2aec668218189153509777ab0fb2a1.jpg"><br><br><h5>  EBS Disk with 1000 IOPS </h5><br>  <b>One thread:</b> <br><pre> <code class="bash hljs">Device: rrqm/s wrqm/sr/sw/s rMB/s wMB/s avgrq-sz avgqu-sz await svctm %util xvdk 0.00 0.00 1084.50 0.00 27.33 0.00 51.61 3.72 3.43 0.91 99.20</code> </pre><br>  Pay attention to the short processing time of the request by the virtual disk itself - 0.91 ms.  Apparently the array on the SSD ;-) The queue size is ~ 4, and the average time for one request is 3.43 ms. <br><br>  <b>20 threads:</b> <br><pre> <code class="bash hljs">Device: rrqm/s wrqm/sr/sw/s rMB/s wMB/s avgrq-sz avgqu-sz await svctm %util xvdk 0.00 0.00 1059.50 0.00 26.37 0.00 50.98 55.39 51.97 0.94 100.00</code> </pre><br>  We see that at 20 threads the request will have to wait ~ 50 ms due to the queue formation of 55 requests. <br><br><h5>  EBS Disk since 2000 IOPS </h5><br>  <b>20 threads:</b> <br><pre> <code class="bash hljs">Device: rrqm/s wrqm/sr/sw/s rMB/s wMB/s avgrq-sz avgqu-sz await svctm %util xvdl 0.00 0.00 1542.50 0.00 36.29 0.00 48.18 33.20 21.29 0.65 100.00</code> </pre><br><br>  <b>50 threads:</b> <br><pre> <code class="bash hljs">Device: rrqm/s wrqm/sr/sw/s rMB/s wMB/s avgrq-sz avgqu-sz await svctm %util xvdl 0.00 0.00 1498.50 0.00 36.63 0.00 50.06 86.17 57.05 0.67 100.00</code> </pre><br><br><h4>  Results of measurements </h4><br>  We see that the EBS disk with 2000 IOPS shows approximately the same latency (~ 50ms) on 50 streams, as a disk with 1000 IOPS on 20 streams and a regular EBS disk on 6-7 streams (apparently, in ordinary EBS disks IOPS is within 200 -300). <br><br><h4>  What else happens </h4><br>  Virtual hard drives often give surprises.  Sometimes they were simply under-tuned, because  did not have time to finish reading man ... <br><br>  I recently encountered a similar case when, when creating a multi-threaded test load on an empty MySQL server at a ‚Äúbig-expensive-fast-networked‚Äù virtual disk, the svctm rate ranged from 0.5 to 1 ms at night and from ~ 10 to 100 ms - during the day ( I wanted to measure the full moon, did not wait).  MySQL, of course - braked.  The reason was parallel use of network storage and unaware of each other projects, and not the settings of MySQL, which they tried to make guilty ;-) <br><br><h4>  Summary </h4><br>  Using the tools at hand, we rather quickly determined the competitive limit of multi-threaded load at which the virtual disk starts to accumulate the queue and serve quite typical MySQL requests for 50 ms or more.  Now we can assume how many disks to put together in a raid to ensure latency, say, 10-20 ms for a given number of clients.  It is clear that these are approximate data, but they will certainly help to move further, especially if you measure the performance of a real hard disk / raid and come with a cloud of champagne to a cloud hoster ;-) <br><br>  In conclusion, I congratulate everyone on the past holiday, I wish you fast virtual disks, reliable servers and accurate measurements!  Come to us at <a href="http://bitrix24.ru/">Bitrix24</a> .  Good luck! </div><p>Source: <a href="https://habr.com/ru/post/162501/">https://habr.com/ru/post/162501/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../162487/index.html">Video review laptop Lenovo IdeaPad S400</a></li>
<li><a href="../162491/index.html">Every fifth vacancy in IT for a young specialist</a></li>
<li><a href="../162493/index.html">Who do employers hunt for?</a></li>
<li><a href="../162497/index.html">All that you were shy to ask about backups of Microsoft SQL Server</a></li>
<li><a href="../162499/index.html">Service direct SIP calls call2sip.ru</a></li>
<li><a href="../162503/index.html">Sony VAIO Duo 11 Ultrabook (tablet) video review (SVD-1121QR)</a></li>
<li><a href="../162505/index.html">Russian AI Cup: results</a></li>
<li><a href="../162507/index.html">Linux is growing! New Mint 14 for OEM; lightweight DSL, Core and Puppy, and more and more Linux jobs in the new State of Linux infographic</a></li>
<li><a href="../162509/index.html">NIC Teaming on Windows Server 2012</a></li>
<li><a href="../162511/index.html">Framework in Marmalade (part 4)</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>