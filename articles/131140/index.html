<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Using the event trace tool in Erlang</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Here is one of the common problems of multi-threaded (concurrent) systems: events occur constantly in different parts of the program at different time...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Using the event trace tool in Erlang</h1><div class="post__text post__text-html js-mediator-article">  Here is one of the common problems of multi-threaded (concurrent) systems: events occur constantly in different parts of the program at different times, and you do not have the ability to control the cause and time of their occurrence.  To track down a problem, we can often use a sequence diagram.  For example, such (thanks to Wikipedia): <br><br><img src="https://habrastorage.org/getpro/habr/post_images/f61/f90/9d2/f61f909d28069d1e63703ac51b64c128.gif"><br><br>  The purpose of this diagram is to show the interaction between the various parallel components of the system.  In this example, Fred, Bob, Hank and Renee in a restaurant.  Everyone can easily draw a similar chart on paper.  The problem is that the sketches on paper may differ from what happens during the execution of your program. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Wouldn't it be great if you could build similar charts based on the program‚Äôs trace data automatically?  Well, Erlang will help you with this. <a name="habracut"></a>  I will use some code to illustrate an example of how to do this. <br><br><h2>  Step 1. Build the trace function </h2><br>  The first step is to build a trace function.  Mine looks like this and is located in the utp module. <br><pre><code class="erlang hljs"><span class="hljs-function"><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">report_event</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(DetailLevel, FromTo, Label, Contents)</span></span></span><span class="hljs-function"> -&gt;</span></span> <span class="hljs-comment"><span class="hljs-comment">%% NB External call ?MODULE:report_event(DetailLevel, FromTo, FromTo, Label, Contents). report_event(_DetailLevel, _From, _To, _Label, _Contents) -&gt; hopefully_traced.</span></span></code> </pre> <br><br>  The main idea is in the second function.  This is a stub function with five arguments, which is immediately processed.  The return value "hopefully_traced" is arbitrary, but it shows what we want to return from this function.  The first function is used when we monitor outgoing and received events by the same component. <br><br>  Argument Description: <br><ul><li>  DetailLevel: a number from 0 to 100. It indicates the significance level of this event.  By assigning smaller events to major events, and larger numbers to less significant ones, we enable the tracer to hide some of the events, thereby achieving the desired level of granularity. </li><li>  From: event source. </li><li>  To: to whom the event is intended. </li><li>  Label: notation label of the message. </li><li>  Contents: what will be displayed when clicking on an event.  It can provide more detailed information about the event without cluttering the chart. </li></ul><br><h2>  Step 2. Trace the events in the program </h2><br>  When something important happens in the program, we call ‚Äúutp: report_event / 5‚Äù (we substitute here the name of the trace function, which we declared in step 1).  By default, this function will not do anything, but later we can catch it using the Erlang trace capabilities.  Here is an example of the interaction described above: <br><pre> <code class="erlang hljs"><span class="hljs-function"><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">trace_test</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> -&gt;</span></span> Events = [{fred, bob, order_food}, {bob, hank, order_food}, {bob, fred, serve_wine}, {hank, bob, pickup}, {bob, fred, serve_feed}, {fred, renee, pay}], [utp:report_event(<span class="hljs-number"><span class="hljs-number">50</span></span>, F, T, L, []) || {F,T,L} &lt;- Events].</code> </pre><br><br>  Keep in mind that anything can be traced by calling this function in various places of your code.  Instead of running multiple debugging blocks, you can add a call to the trace function anywhere in the program.  Also note that I have a little shrunk the example above using a list generator, since  I do not care about the level of detail of events and their contents. <br><br><h2>  Step 3. Call the <a href="https://habr.com/ru/post/131140/">application</a> "et" </h2><br>  Next, we need to call the "et" application in the correct way.  I wrote the utp_filter module, which makes this call, despite the fact that it does not contain any filtering functions yet: <br><pre> <code class="erlang hljs"><span class="hljs-function"><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">start</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(ExtraOptions)</span></span></span><span class="hljs-function"> -&gt;</span></span> Options = [{event_order, event_ts}, {scale, <span class="hljs-number"><span class="hljs-number">2</span></span>}, {max_actors, <span class="hljs-number"><span class="hljs-number">10</span></span>}, {detail_level, <span class="hljs-number"><span class="hljs-number">90</span></span>}, {actors, [fred, bob, hank, renee]}, {trace_pattern, {utp, max}}, {trace_global, true}, {title, <span class="hljs-string"><span class="hljs-string">"uTP tracer"</span></span>} | ExtraOptions], et_viewer:start(Options).</code> </pre><br><br>  This module initializes et_viewer in such a way that it can be used with our example.  The order of events - ‚Äúevent_ts‚Äù means that we add time stamps when events occur, not when they are received.  The ‚Äúactors‚Äù attribute sets the order in which the actors appear.  The attribute "trace_pattern" is very important.  It allows you to track the call ‚Äúutp: report_event / 5‚Äù.  You can also specify many other options, or the event will select them by itself.  Do not specify the module in which the trace function is located. <br><br><h2>  Step 4. Testing </h2><br>  If we call utp_filter: start ([]) by running et viewer described in step 3, we can run the trace test from step 2: <br><br><img src="http://1.bp.blogspot.com/-UUYkdPGEEsY/TqQ3iJjOjKI/AAAAAAAAARQ/9NxkrZf8Mes/s400/Screenshot+at+2011-10-23+17%253A47%253A57.png"><br><br>  This should be similar to the Wikipedia example, except for what is obtained by tracing our program.  In particular, this idea was used by me to capture and find bugs in variants of the uTP TCP stack: <br><br><img src="http://1.bp.blogspot.com/-ejD5oeV0-0Y/TqQ4INwx0lI/AAAAAAAAARY/YqTKwgbmrzE/s1600/Screenshot-uTP+tracer+%2528filter%253A+all%2529-2.png"><br><br>  (Despite the fact that the diagram is small, it still displays the basic idea - this example is not to show the diagram, but in order to gain worldwide fame :).  For a TCP-like protocol, this is a very powerful tool: the output of tcpdump (1) and strace (1), as well as the internal state of the protocol on a single diagram.  I found a few bugs with the help of these tools simply by viewing the interaction of the program. <br><br>  It's all.  With the above code, you can use a graphical tracer at any time.  If you do not include it, the overhead of using the trace functions is insignificant, and if you turn it on, you can see how the code behaves in this situation. <br><br><a name="otp_application"></a>  Application (Application) - the term Erlang / OTP, in <a href="http://erlanger.ru/wiki/index.php/OTP_Applications">more detail</a> </div><p>Source: <a href="https://habr.com/ru/post/131140/">https://habr.com/ru/post/131140/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../131131/index.html">Aspia 0.2.5</a></li>
<li><a href="../131132/index.html">Scoop as it is</a></li>
<li><a href="../131133/index.html">Groupon. Show me the money or how knowledge of numbers can help a business</a></li>
<li><a href="../131135/index.html">Antineurons and learning from mistakes</a></li>
<li><a href="../131139/index.html">We return the stitched HTC Desire S to stock status</a></li>
<li><a href="../131141/index.html">SEO-shniki do not know what they are doing</a></li>
<li><a href="../131142/index.html">The team of animators working on Avatar and Tron + Wemo Media are working on a project for the virtual ocean theBlu</a></li>
<li><a href="../131143/index.html">Common API for shorteners / link converters</a></li>
<li><a href="../131144/index.html">Droider Chart. Issue 75 talking</a></li>
<li><a href="../131145/index.html">Google is going to connect Blogger and social network Google+</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>