<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>From govnokoda in Highload. We use TARANtool. 5 recipes to improve performance</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="One leader of a social game startup asked me to increase the productivity of his project. At this stage a prototype of the project was made and launch...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>From govnokoda in Highload. We use TARANtool. 5 recipes to improve performance</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/storage2/cd4/3b0/b2b/cd43b0b2b27bf50c1984198a9023db52.gif" align="left">  One leader of a social game startup asked me to increase the productivity of his project.  At this stage a prototype of the project was made and launched.  And we must pay tribute to the developers that the project worked and even brought some profit.  But, to launch an advertising campaign did not make sense, since the project could not withstand any loads.  MySQL fell down (35% of errors). <br><br>  The code of the project ... In general, I was left with the impression that an under-educated student wrote it ... And this, despite the fact that partial refactoring was already done by another programmer.  The only thing that pleased, is that no framework was used.  Of course, this is always the flame question: Jesus or Magomed?  To be or not to be?  Unix or Windows?  To use or not to use?  IMHO, My opinion: frameworks are sharpened by a narrow range of typical tasks.  A social project is usually not a typical task ... But, in general, the project seemed interesting to me and I decided to undertake improvement.  At this entry can be completed ... <br><br>  Probably, only the lazy WEB developer, who knows at least something in this area, didn‚Äôt write about the performance improvement and the highload topic.  In principle, something new, in this article you will not find.  The main ideas for developing highload projects were described by me in a series of <a href="http://highloadblog.ru/articles/12.html">HighLoad</a> articles <a href="http://highloadblog.ru/articles/12.html">.</a>  <a href="http://highloadblog.ru/articles/12.html">Three whales.</a>  .  If you're wondering how I increased the performance of a PHP project using the NoSQL <a href="http://tarantool.org/">tarantool</a> repository, then welcome under cat. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Although, it is fundamentally possible to use another, suitable for this range of tasks, key / value storage, and the implementation of server logic can be in any other scripting language. <br><a name="habracut"></a><br><h5>  Recipe 1. Analyzing the code </h5><br>  All terribly trite.  They wrote about it hundreds of times before me, and hundreds more articles will be written ... However, ‚Äúwe are the smartest‚Äù and stubbornly step on the same rake.  I will not discover America if I say that the bottleneck in 99% of all WEB projects is the database.  And which of this should be concluded? <br>  That's right - you need to <i><b>minimize the number of requests.</b></i>  .  And how to do it, if in the course of logic the code occurs five times: <br><br><blockquote>  <font color="#000088">$ user</font> <font color="#339933">=</font> <font color="#000000">new</font> User <font color="#009900">(</font> <font color="#009900">)</font> <font color="#339933">;</font> <br>  <font color="#000088">$ userData</font> <font color="#339933">=</font> <font color="#000088">$ user</font> <font color="#339933">-&gt;</font> <font color="#004000">getById</font> <font color="#009900">(</font> <font color="#000088">$ uid</font> <font color="#009900">)</font> <font color="#339933">;</font> </blockquote><br>  When profiling queries it comes up that we have executed five identical ‚Äúselects‚Äù: <font color="#993333">SELECT</font> <font color="#66cc66">*</font> FROM users <font color="#993333">WHERE</font> id <font color="#66cc66">=</font> $ uid; <br>  And it is implemented quite simply: use the internal (private) static field or property of the User object: <br><blockquote>  <font color="#000000">class</font> User <font color="#009900">{</font> <br><br>  <font color="#000000">private</font> static <font color="#000088">$ userData</font> <font color="#339933">=</font> <font color="#009900">NULL</font> <font color="#339933">;</font> <br><br>  <font color="#000000">private</font> <font color="#000000">function</font> getById_loc <font color="#009900">(</font> <font color="#000088">$ uid</font> <font color="#009900">)</font> <font color="#009900">{</font> <br>  <font color="#666666">// some code to access the database.</font> <br>  <font color="#009900">}</font> <br><br>  <font color="#000000">public</font> <font color="#000000">function</font> getById <font color="#009900">(</font> <font color="#000088">$ uid</font> <font color="#009900">)</font> <font color="#009900">{</font> <br>  <font color="#b1b100">if</font> <font color="#009900">(</font> <font color="#000000">self</font> <font color="#339933">::</font> <font color="#000088">$ userData</font> <font color="#009900">)</font> <font color="#b1b100">return</font> <font color="#000000">self</font> <font color="#339933">::</font> <font color="#000088">$ userData</font> <font color="#339933">;</font> <br>  <font color="#000000">self</font> <font color="#339933">::</font> <font color="#000088">$ userData</font> <font color="#339933">=</font> <font color="#000088">$ this</font> <font color="#339933">-&gt;</font> <font color="#004000">getById_loc</font> <font color="#009900">(</font> <font color="#000088">$ uid</font> <font color="#009900">)</font> <font color="#339933">;</font> <br>  <font color="#b1b100">return</font> <font color="#000000">self</font> <font color="#339933">::</font> <font color="#000088">$ userData</font> <font color="#339933">;</font> <br>  <font color="#009900">}</font> <br>  <font color="#009900">}</font> </blockquote><br><br>  The second thing that immediately catches the eye.  This is when there are two methods nearby: <br><blockquote>  <font color="#0000ff">$ User</font> <font color="#339933">-&gt;</font> <font color="#004000">updateBalance</font> <font color="#009900">(</font> <font color="#0000ff">$ sum</font> <font color="#009900">)</font> <font color="#339933">;</font> <br>  <font color="#0000ff">$ User</font> <font color="#339933">-&gt;</font> <font color="#004000">updateRating</font> <font color="#009900">(</font> <font color="#0000ff">$ rating</font> <font color="#009900">)</font> <font color="#339933">;</font> <br></blockquote><br>  which leads to the execution of two queries to one table in a row, one after the other: <br>  <font color="#993333">UPDATE</font> users <font color="#993333">SET</font> balance <font color="#66cc66">=</font> balance <font color="#66cc66">+</font> $ sum <font color="#993333">WHERE</font> id <font color="#66cc66">=</font> $ uid; <br>  <font color="#993333">UPDATE</font> users <font color="#993333">SET</font> rating <font color="#66cc66">=</font> $ rating <font color="#993333">WHERE</font> id <font color="#66cc66">=</font> $ uid; <br>  Although, if we move our brains a little bit, we could easily form one request: <br><blockquote>  <font color="#993333">UPDATE</font> users <font color="#993333">SET</font> <br>  balance <font color="#66cc66">=</font> balance <font color="#66cc66">+</font> $ sum <font color="#66cc66">,</font> <br>  rating <font color="#66cc66">=</font> $ rating <br>  <font color="#993333">WHERE</font> id <font color="#66cc66">=</font> $ uid; <br></blockquote><br>  This can be done in two ways: either we write another method $ user-&gt; updateBalanceAndRating ($ sum, $ rating), or we implement something universal, as they say, for all occasions: <br><blockquote>  <font color="#0000ff">$ user</font> <font color="#339933">-&gt;</font> <font color="#004000">updateFieldAdd</font> <font color="#009900">(</font> <font color="#0000ff">'balance'</font> <font color="#339933">,</font> <font color="#0000ff">$ sum</font> <font color="#009900">)</font> <font color="#339933">;</font>  <font color="#666666">// remember the field, add operation - addition, operand</font> <br>  <font color="#0000ff">$ user</font> <font color="#339933">-&gt;</font> <font color="#004000">updateFieldAssign</font> <font color="#009900">(</font> <font color="#0000ff">'rating'</font> <font color="#339933">,</font> <font color="#0000ff">$ rating</font> <font color="#009900">)</font> <font color="#339933">;</font>  <font color="#666666">// remember the field, the operation assign - assignment, operand</font> <br>  <font color="#0000ff">$ user</font> <font color="#339933">-&gt;</font> <font color="#004000">execUpdate</font> <font color="#009900">(</font> <font color="#009900">)</font> <font color="#339933">;</font>  <font color="#666666">// form and execute the query</font> </blockquote><br><br>  Only the introduction of these two simple methods has reduced the number of queries to the database from 10-12 to 3-5.  But honestly, the existing code has yet to refactor and refactor.  Of course, most Habrouseurs are far from being losers, but profiling and analysis is always ‚ÄúGod help us‚Äù. <br><br><h5>  Recipe 2. Caching </h5><br>  What is caching, I hope you do not need to press.  As Dima Koterov wrote in his article about the development of a highload project, ‚Äúwe need to cache everything we can.‚Äù  In this project, there were timid attempts at some caching.  However, everything turned out according to Chernomyrdin: they wanted to do it better, but cached, not what is most often used;). <br><br>  As noted above, in order to reduce the load on the database, it is necessary to reduce the number of queries.  And how to reduce them?  It's very simple - a part of the unchanged data (reference books on units, tributaries and weapons) is simply to be taken out of the database, for example, into configs.  Configs can be either in XML, and are corrected by girls from the gameplay team in any XML editor, or in a ready-made form: in the PHP array ‚Äî if the developer of the gameplay and code is one person.  Parsing XML on the fly is a difficult thing, so I do a preliminary XSLT conversion directly into PHP code (in the form of an associative array, which is loaded along with the main code).  However, after each change in the XML config file, you must run the XSLT transformation script or the console utility.  Yes, this is not caching, this is a slight improvement, and you should not single it out into a separate recipe, but you should not forget about it either. <br><br>  Thus, having stuffed all the directories into configs, we still get rid of a couple of queries.  Well, what - it became easier? .. At least, after applying recipes 1 and 2, the base stopped falling.  Well, at least some result ... <br><br><h5>  Recipe 3. Data Analysis </h5><br>  There really will have to analyze the code and think ... And there is, by the way, over what ... You need to find out what data the user changes, which of the user data is unchanged, what is requested most often.  Here you need to visually run through the code and understand the logic of the project. <br><br>  In our project, the most frequently requested information was the game user profile, gifts and awards.  All this data was placed in the NoSQL repository, and all other data, especially related to payments, remained in MySQL.  As NoSQL storage tarantool was chosen. <br><br><h5>  And yet - why TARANtool? </h5><br>  At the Highload ++ 2011 Conference, Tarantool Development Manager, Kostya Osipova was asked: <br>  - Why do you have such a poisonous name? <br>  - Well, you can consider the name as a ram and tools, i.e.  as a tool (tool) ramming for your projects. <br><br>  So, the factors influencing the choice of NoSQL storage were: <br>  - My personal acquaintance with the project team tent Kostya Osipov, who promised support and advice <br>  - Experience of implementing this repository in a previous project.  Unfortunately the project did not take off :(, but it was interesting. <br>  - The study of new features tarantool, it has been almost two years since its previous use <br>  - High performance of this NoSQL storage and high availability of data. <br>  - The persistence of data, when falling on the disk remains an up-to-date copy, which can always be raised. <br>  - well, and if it is not very modest, then I myself am the author of the first version of the PHP extension for Tarantool, so if necessary I can patch or fix the bug. <br><br>  And, to be more serious, I just like the unique features of this NoSQL data warehouse: using secondary keys and manipulating data space on the server side using stored procedures. <br><br><h5>  Data Analysis (continued) </h5><br>  Consider a user profile, a users table.  It has mutable and non-mutable data.  The editable data includes: balance, rating, pvp points, units, tutorial steps, etc. <br>  Non-editable data includes social_id, login, avatar url, personal codes, etc. ... Among the variable data there are frequently changed and rarely changed.  However, non-editable data may be requested frequently. <br><br>  We select frequently requested data.  We will cache them in tarantool.  Now a little about the NoSQL storage itself ... <br><br><h5>  TARANtool.  Short review </h5><br>  Tarantool is, as mentioned above, high-performance key / value NoSQL storage.  All data is in RAM, and presented in the form of tuples, so their retrieval in speed is not inferior to redis or slightly slower (by 6-7 milliseconds per 1000 operations) memcached. <br><br>  And yet, we note that Tarantool is a data warehouse, and not a memory caching system, such as memcache.  All data is in RAM, but is permanently stored (synced from the sync system call) into files (snap 0000..01.snap).  Unlike traditional memcached &amp; redis, tarantool has additional features: <br>  - the possibility of imposing secondary indexes on data <br>  - indexes can be composite <br>  - indexes can be of type HASH, TREE or BITSET.  Planned introduction of the GEO index. <br>  - sampling on one or several indices simultaneously. <br>  - removal of data in parts (analogue LIMIT / OFFSET). <br><br>  Tarantool handles data that is combined into spaces (space).  <b>Space</b> is the equivalent of a table in MySQL.  In tarantool digital numbering of spaces is used (0, 1, 2, 3 ...).  In the foreseeable future, we plan to use namespaces (an analogue of table names in MySQL.). <br><br>  An index can be applied to each space.  Indices can be superimposed, both on a numeric (int32 or int64), and on a character field.  As with spaces, digital indexing is defined in tarantool. <br><br>  The exchange between the client and the server takes place <b>tuples</b> .  A tuple is an analogue of a row in a MySQL table.  In mathematics, a tuple is an ordered finite set of length n.  Each element of a tuple is a <b>data element</b> or field.  Basically, the tarantula does not distinguish between the types of data fields.  For it is a set of bytes.  But if we use an index, i.e.  impose an index on this field, then its type must match the type of the field.  There is another name for the tuple: tuple. <br><br>  All indices are registered in the config, which is human-perceivable: YAML.  Example of the config part: <br>  space <font color="#66cc66">[</font> <font color="#cc66cc">0</font> <font color="#66cc66">]</font> .enabled <font color="#66cc66">=</font> <font color="#cc66cc">1</font> <br>  space <font color="#66cc66">[</font> <font color="#cc66cc">0</font> <font color="#66cc66">]</font> .index <font color="#66cc66">[</font> <font color="#cc66cc">0</font> <font color="#66cc66">]</font> .  <font color="#b1b100">type</font> <font color="#66cc66">=</font> <font color="#ff0000">"HASH"</font> <br>  space <font color="#66cc66">[</font> <font color="#cc66cc">0</font> <font color="#66cc66">]</font> .index <font color="#66cc66">[</font> <font color="#cc66cc">0</font> <font color="#66cc66">]</font> .unique <font color="#66cc66">=</font> <font color="#cc66cc">1</font> <br>  space <font color="#66cc66">[</font> <font color="#cc66cc">0</font> <font color="#66cc66">]</font> .index <font color="#66cc66">[</font> <font color="#cc66cc">0</font> <font color="#66cc66">]</font> .key_field <font color="#66cc66">[</font> <font color="#cc66cc">0</font> <font color="#66cc66">]</font> .fieldno <font color="#66cc66">=</font> <font color="#cc66cc">0</font> <br>  space <font color="#66cc66">[</font> <font color="#cc66cc">0</font> <font color="#66cc66">]</font> .index <font color="#66cc66">[</font> <font color="#cc66cc">0</font> <font color="#66cc66">]</font> .key_field <font color="#66cc66">[</font> <font color="#cc66cc">0</font> <font color="#66cc66">]</font> .  <font color="#b1b100">type</font> <font color="#66cc66">=</font> <font color="#ff0000">"NUM"</font> <br>  In the config we describe the primary and secondary indices for each space.  If we make a sample only by PRIMARY KEY, then the description of only the primary index is enough (see the example above).  If we want among our users to choose the best rated or pvp-battles, then we impose a secondary index on these fields.  Let the second field be indexed (fieldno = 1, counting from zero) int32_t - rating: <br><br>  space <font color="#66cc66">[</font> <font color="#cc66cc">0</font> <font color="#66cc66">]</font> .index <font color="#66cc66">[</font> <font color="#cc66cc">1</font> <font color="#66cc66">]</font> .  <font color="#b1b100">type</font> <font color="#66cc66">=</font> <font color="#ff0000">"TREE"</font> <font color="#66cc66">//</font> makes the type TREE, which allows you to make selections on operations more and less <br>  space <font color="#66cc66">[</font> <font color="#cc66cc">0</font> <font color="#66cc66">]</font> .index <font color="#66cc66">[</font> <font color="#cc66cc">1</font> <font color="#66cc66">]</font> .unique <font color="#66cc66">=</font> <font color="#cc66cc">0</font> <font color="#66cc66">//</font> remove the identity <br>  space <font color="#66cc66">[</font> <font color="#cc66cc">0</font> <font color="#66cc66">]</font> .index <font color="#66cc66">[</font> <font color="#cc66cc">1</font> <font color="#66cc66">]</font> .key_field <font color="#66cc66">[</font> <font color="#cc66cc">0</font> <font color="#66cc66">]</font> .fieldno <font color="#66cc66">=</font> <font color="#cc66cc">1</font> <font color="#66cc66">//</font> specify the number of the field to be indexed <br>  space <font color="#66cc66">[</font> <font color="#cc66cc">0</font> <font color="#66cc66">]</font> .index <font color="#66cc66">[</font> <font color="#cc66cc">1</font> <font color="#66cc66">]</font> .key_field <font color="#66cc66">[</font> <font color="#cc66cc">0</font> <font color="#66cc66">]</font> .  <font color="#b1b100">type</font> <font color="#66cc66">=</font> <font color="#ff0000">"NUM"</font> <font color="#66cc66">//</font> type int32_t <br><br>  Since we have a Social Game project, the primary key will correspond to social_id.  For most social networks - this is 64-key.  The index type will be HASH, and the data type is STR.  Ideally, I would like NUM64, but unfortunately, PHP does not work well with the long long type.  The driver does not recognize the type and size of the primary key of the used space.  At the moment, if you use a 64-bit key, as long as you cannot search for it using a 32-bit value.  It should be packaged as a 64-bit key in the package.  Now the driver does this only if the value exceeds the 32-bit range.  Therefore, it is safer to work with the <i>STRING</i> type. <br><br><h5>  Memory calculation </h5><br>  It must be remembered that tarantool is a solution of <b><i>memory only</i></b> , therefore it is important to calculate the estimated amount of RAM occupied.  The calculation is made as follows: <br><br>  Before each tuple, a variable of the varint type (analogous to the perl 'w' in pack) and 12 bytes from the header for each tuple will be stored.  Specifically, for pro data, you can read, having studied the <a href="https://github.com/mailru/tarantool/blob/master/doc/box-protocol.txt">protocol</a> or after reading the article <a href="http://habrahabr.ru/post/118036/">Tarantool Data and Protocol</a> . <br><br>  Additionally, about 15 percent is occupied by data for allocators.  If we, for example, have 10 fields and the size of the user data fit into 256 bytes, then for 1.5M there will be approximately the following calculation: <br>  (10 * 1 + 256 + 12) * 1.15 * 1 500 000 = 921150000 ~ = 440 MB per day <br><br>  Also, all indexes are in memory, which occupies: <br>  - for one node stores 68 bytes of service information in the tree <br>  - for one node in the hash stores 56 bytes of service information <br><br>  To store the index for 1.5M users, a little more than 80Mb is enough, just together, to store 1.5 M profiles you need a little more than half a gigabyte.  If we add another key (type TREE), then this is an additional 90M of RAM. <br><br>  To whom how, but by today's standards - not quite so much. <br><br><h5>  Recipe 4. Getting rid of MySQL in the foreground </h5><br>  As we already said, transferring user profile data to tarantool, we want to have their actual copies in MySQL.  Therefore, all UPDATE operations have to be performed.  As a result, having made caching, we have achieved not much.  But, the main effect is still reached: MySQL has stopped falling.  So, how can you speed up the script several times?  This is possible if you get rid of MySQL queries altogether.  But how is it possible?  It is necessary to transfer information about a change in the database to some other, background script that will perform INSERT / UPDATE operations. <br><br>  This information is transmitted through the queue.  There are several industrial solutions that allow you to run remote tasks: Gaerman, Celery, as well as RabbitMQ, ZMQ, redis and other queue servers can be adapted.  But why introduce a new entity into the project if you can use tarantool as a queue server. <br><br>  The tarantula has a queue implementation <a href="">github.com/mailru/tntlua/blob/master/queue.lua</a> and recommend it for use. <br>  However, it was implemented a little bit easier.  Create a new space: <br><br>  space <font color="#66cc66">[</font> <font color="#cc66cc">1</font> <font color="#66cc66">]</font> .enabled <font color="#66cc66">=</font> <font color="#cc66cc">1</font> <br>  space <font color="#66cc66">[</font> <font color="#cc66cc">1</font> <font color="#66cc66">]</font> .index <font color="#66cc66">[</font> <font color="#cc66cc">0</font> <font color="#66cc66">]</font> .  <font color="#b1b100">type</font> <font color="#66cc66">=</font> <font color="#ff0000">"TREE"</font> <br>  space <font color="#66cc66">[</font> <font color="#cc66cc">1</font> <font color="#66cc66">]</font> .index <font color="#66cc66">[</font> <font color="#cc66cc">0</font> <font color="#66cc66">]</font> .unique <font color="#66cc66">=</font> <font color="#cc66cc">1</font> <br>  space <font color="#66cc66">[</font> <font color="#cc66cc">1</font> <font color="#66cc66">]</font> .index <font color="#66cc66">[</font> <font color="#cc66cc">0</font> <font color="#66cc66">]</font> .key_field <font color="#66cc66">[</font> <font color="#cc66cc">0</font> <font color="#66cc66">]</font> .fieldno <font color="#66cc66">=</font> <font color="#cc66cc">0</font> <br>  space <font color="#66cc66">[</font> <font color="#cc66cc">1</font> <font color="#66cc66">]</font> .index <font color="#66cc66">[</font> <font color="#cc66cc">0</font> <font color="#66cc66">]</font> .key_field <font color="#66cc66">[</font> <font color="#cc66cc">0</font> <font color="#66cc66">]</font> .  <font color="#b1b100">type</font> <font color="#66cc66">=</font> <font color="#ff0000">"NUM"</font> <br><br><br>  In this space we will write the following fields: <br>  - id, auto increment field.  Must be indexed.  Superimposed primary index type TREE. <br>  - type - type of operation, some numeric constant, which is used to determine the number of the SQL statement template. <br>  - data - some data to insert / update. <br><br>  In the foreground script will be the following code: <br>  define <font color="#66cc66">(</font> <font color="#ff0000">'UPDATE_SPIN_COUNT'</font> , <font color="#cc66cc">1</font> <font color="#66cc66">)</font> <font color="#66cc66">;</font> <br>  define <font color="#66cc66">(</font> <font color="#ff0000">'UPDATE_USER_BALANCE'</font> , <font color="#cc66cc">2</font> <font color="#66cc66">)</font> <font color="#66cc66">;</font> <br>  ... <br>  $ res <font color="#66cc66">=</font> $ tnt- <font color="#66cc66">&gt;</font> call <font color="#66cc66">(</font> <font color="#ff0000">'box.auto_increment'</font> , array <font color="#66cc66">(</font> <font color="#66cc66">(</font> <font color="#b1b100">string</font> <font color="#66cc66">)</font> <font color="blue">TBL_QUEUES</font> , <font color="blue">UPDATE_SPIN_COUNT</font> , $ spinCount, $ uid <font color="#66cc66">)</font> <font color="#66cc66">)</font> <font color="#66cc66">;</font> <br>  The stored procedure <font color="blue">box.auto_increment</font> is built-in, it inserts data tuple primary key value - max + 1. Parameters: <br>  - the number of the space where the data will be inserted <br>  - the data itself <br>  - optional parameter flag, default is set to ‚Äúreturn a new key‚Äù <br>  <i>It should be noted that the type of the variable, the number of the space (the constant <font color="blue">TBL_QUEUES</font> ) must be cast to the <b>STRING</b> type.</i>  This script calls the lua procedure, which writes the data to the FIFO queue (auto-increment number, the type of task being performed, and the data itself). <br><br>  Further, the background script, which can be executed even on another remote machine, takes data from the queue and executes SQL: <br><br><blockquote>  define <font color="#66cc66">(</font> <font color="#ff0000">'UPDATE_SPIN_COUNT'</font> , <font color="#cc66cc">1</font> <font color="#66cc66">)</font> <font color="#66cc66">;</font> <br>  define <font color="#66cc66">(</font> <font color="#ff0000">'UPDATE_USER_BALANCE'</font> , <font color="#cc66cc">2</font> <font color="#66cc66">)</font> <font color="#66cc66">;</font> <br>  ... <br>  $ res <font color="#66cc66">=</font> $ this- <font color="#66cc66">&gt;</font> callProc <font color="#66cc66">(</font> <font color="#ff0000">'my_pop'</font> , array <font color="#66cc66">(</font> <font color="#66cc66">(</font> <font color="#b1b100">string</font> <font color="#66cc66">)</font> TBL_QUEUES <font color="#66cc66">)</font> <font color="#66cc66">)</font> <font color="#66cc66">;</font> <br><br>  <font color="#66cc66">/ *</font> <br>  if empty then returns: <br>  array <font color="#66cc66">(</font> <font color="#cc66cc">2</font> <font color="#66cc66">)</font> <font color="#66cc66">{</font> <br>  <font color="#66cc66">[</font> <font color="#ff0000">"count"</font> <font color="#66cc66">]</font> <font color="#66cc66">=&gt;</font> int <font color="#66cc66">(</font> <font color="#cc66cc">0</font> <font color="#66cc66">)</font> <br>  <font color="#66cc66">[</font> <font color="#ff0000">"tuples_list"</font> <font color="#66cc66">]</font> <font color="#66cc66">=&gt;</font> array <font color="#66cc66">(</font> <font color="#cc66cc">0</font> <font color="#66cc66">)</font> <font color="#66cc66">{</font> <font color="#66cc66">}</font> <br>  <font color="#66cc66">}</font> <br><br>  <font color="#66cc66">* /</font> <br>  <font color="#b1b100">if</font> <font color="#66cc66">(</font> <font color="#66cc66">!</font> $ res <font color="#66cc66">[</font> <font color="#ff0000">'count'</font> <font color="#66cc66">]</font> <font color="#66cc66">)</font> <font color="#b1b100">return</font> <font color="#66cc66">;</font> <br><br>  $ tuple <font color="#66cc66">=</font> $ res <font color="#66cc66">[</font> <font color="#ff0000">'tuples_list'</font> <font color="#66cc66">]</font> <font color="#66cc66">[</font> <font color="#cc66cc">0</font> <font color="#66cc66">]</font> <font color="#66cc66">;</font> <br>  switch <font color="#66cc66">(</font> $ tuple <font color="#66cc66">[</font> <font color="#cc66cc">1</font> <font color="#66cc66">]</font> <font color="#66cc66">)</font> <font color="#66cc66">{</font> <br>  case UPDATE_SPIN_COUNT: <br>  $ sql <font color="#66cc66">=</font> <font color="#ff0000">"UPDATE users SET spinCount = {$ tuple [2]} WHERE uid = {$ tuple [3]}"</font> <font color="#66cc66">;</font> <br>  <font color="#b1b100">break</font> <font color="#66cc66">;</font> <br><br>  case <font color="#cc66cc">UPDATE_USER_BALANCE</font> : <br>  $ sql <font color="#66cc66">=</font> <font color="#ff0000">"UPDATE users SET money = money + {$ tuple [2]} WHERE uid = {$ tuple [3]}"</font> <font color="#66cc66">;</font> <br>  <font color="#b1b100">break</font> <font color="#66cc66">;</font> <br><br>  default: <br>  throw new Exception <font color="#66cc66">(</font> <font color="#ff0000">'unknow task type'</font> <font color="#66cc66">)</font> <font color="#66cc66">;</font> <br>  <font color="#b1b100">break</font> <font color="#66cc66">;</font> <br>  <font color="#66cc66">}</font> <br><br>  $ this- <font color="#66cc66">&gt;</font> execSQL <font color="#66cc66">(</font> $ sql <font color="#66cc66">)</font> <font color="#66cc66">;</font> </blockquote><br><br>  As a result, our front script only works with a fast tarantula, and the bad ground script, hangs as a daemon or runs on the crown and saves data in MySQL on a separate server, without wasting WEB server resources.  As a result, you can win in performance over 30%.  The topic of background scripts is worth a separate article. <br><br>  However, this is not all.  To run the lua procedure my_pop, it must be initialized.  To do this, the following code must be placed in the init.lua file, which must be in work_dir or script_dir. <br><br><blockquote>  <font color="#b1b100">function</font> my_pop <font color="#66cc66">(</font> spaceno <font color="#66cc66">)</font> <br>  spaceno <font color="#66cc66">=</font> <font color="#b1b100">tonumber</font> <font color="#66cc66">(</font> spaceno <font color="#66cc66">)</font> <br>  <font color="#b1b100">local</font> min_tuple <font color="#66cc66">=</font> box.space <font color="#66cc66">[</font> spaceno <font color="#66cc66">]</font> .index <font color="#66cc66">[</font> <font color="#cc66cc">0</font> <font color="#66cc66">]</font> .idx: <font color="#b1b100">min</font> <font color="#66cc66">(</font> <font color="#66cc66">)</font> <br>  <font color="#b1b100">local</font> <font color="#b1b100">min</font> <font color="#66cc66">=</font> <font color="#cc66cc">0</font> <br>  <font color="#b1b100">if</font> min_tuple ~ <font color="#66cc66">=</font> <font color="#b1b100">nil</font> <font color="#b1b100">then</font> <br>  <font color="#b1b100">min</font> <font color="#66cc66">=</font> box.  <font color="#b1b100">unpack</font> <font color="#66cc66">(</font> <font color="#ff0000">'i'</font> , min_tuple <font color="#66cc66">[</font> <font color="#cc66cc">0</font> <font color="#66cc66">]</font> <font color="#66cc66">)</font> <br>  <font color="#b1b100">else</font> <br>  <font color="#b1b100">return</font> <br>  <font color="#b1b100">end</font> <br><br>  <font color="#b1b100">local</font> ret <font color="#66cc66">=</font> box.select <font color="#66cc66">(</font> spaceno, <font color="#cc66cc">0</font> , <font color="#b1b100">min</font> <font color="#66cc66">)</font> <br>  box.delete <font color="#66cc66">(</font> spaceno, <font color="#b1b100">min</font> <font color="#66cc66">)</font> <br><br>  <font color="#b1b100">return</font> ret <br><br>  <font color="#b1b100">end</font> </blockquote><br><br>  The value of work_dir is specified in tarantool.conf. <br><br><h5>  Recipe 5. Caching only those profiles who actively play </h5><br>  As we have already implemented, all our profiles are stored in tarantool, and all changes are stored in the MySQL file by the background script.  We always have relevant, in accordance with the CAP theorem, with a slight delay, data. <br><br>  And what if our project scored not 1.5 million, but three or 5 million users?  The user logged in, did not like the game - left.  And the data remained in the tarantula, occupy the memory and are not used ... Therefore, for more efficient use, and just for faster data retrieval, it makes sense to store only those users who constantly play. <br><br>  In other words, those users who do not play, i.e.  did not go into the game, for example more than a week, you can delete from the operational cache.  Since we have an up-to-date copy in the database, we can always restore it in the operational cache.  The code of the classes using the operational cache is built according to the standard type of caching: <br><br><blockquote>  <font color="#000000">class</font> User <font color="#000000">extends</font> DbModel <font color="#009900">{</font> <br><br>  <font color="#000000">public</font> <font color="#000000">function</font> getByUid <font color="#009900">(</font> <font color="#000088">$ uid</font> <font color="#009900">)</font> <font color="#009900">{</font> <br><br>  <font color="#000088">$ result</font> <font color="#339933">=</font> this <font color="#339933">-&gt;</font> <font color="#004000">getFromCache</font> <font color="#009900">(</font> <font color="#000088">$ uid</font> <font color="#009900">)</font> <font color="#339933">;</font> <br><br>  <font color="#b1b100">if</font> <font color="#009900">(</font> <font color="#339933">!</font> <font color="#990000">is_null</font> <font color="#009900">(</font> <font color="#000088">$ result</font> <font color="#009900">)</font> <font color="#009900">)</font> <font color="#009900">{</font> <br>  <font color="#b1b100">return</font> <font color="#000088">$ result</font> <font color="#339933">;</font> <br>  <font color="#009900">}</font> <br><br>  <font color="#000088">$ result</font> <font color="#339933">=</font> <font color="#000088">$ this</font> <font color="#339933">-&gt;</font> <font color="#004000">execSQL</font> <font color="#009900">(</font> <font color="#0000ff">"SELECT * FROM users WHERE uid = <font color="#006699">$ uid</font> "</font> <font color="#009900">)</font> <font color="#339933">;</font> <br>  <font color="#000088">$ this</font> <font color="#339933">-&gt;</font> <font color="#004000">setToCache</font> <font color="#009900">(</font> <font color="#000088">$ result</font> <font color="#009900">)</font> <font color="#339933">;</font> <br><br>  <font color="#b1b100">return</font> <font color="#000088">$ result</font> <font color="#339933">;</font> <br>  <font color="#009900">}</font> <br>  <font color="#339933">....</font> <br>  <font color="#009900">}</font> </blockquote><br><br>  Cleaning can be done in several ways: <br>  - select the cron script with the list of all ‚Äúexpired‚Äù records from the database and delete them in the tarantula <br>  - set up a cleaning broker in a tarantula (I did not do this myself) <a href="https://github.com/mailru/tarantool/wiki/Brokers-ru">github.com/mailru/tarantool/wiki/Brokers-ru</a> <br>  - write a stored procedure on lua to remove all the "expired" records and run its call to the crown. <br><br>  We are looking forward to a new type of storage from the development team, so that not all data (tuples) are lifted from the disk into RAM, but only the most demanded.  Approximately, as in Mongo DB.  Then recipe 5 disappears by itself. <br><br><h5>  Instead of conclusion </h5><br>  All of the above can be implemented in any of the languages ‚Äã‚Äãin which your social project is implemented (PHP, Perl, Python, Ruby, Java). <br>  Any key / value storage from the following manifolds can be used as a NoSQL online cache data store: <br>  - memcached, there is no persistence and you have to worry a little about the implementation of the queues, but this can be solved using the APPEND operation <br>  - membase, not very successful development and it seems to have ceased to be supported by its creators. <br>  - a bunch of memcacheDb &amp; memcacheQ <br>  - radish, in principle there is everything to implement this functionality <br>  - TokyoTyrant, KyotoTyrant - in principle, queues can be implemented on lua procedures <br>  - LevelDb Daemon, decent development of the guys from the Mamba.  Small finished and the queue you have in your pocket. <br>  - we offer something special in the comments <br><br>  Well, in the conclusion of a little about pears or a little bit of PR. <br>  About demons, and specifically their possible tasks, the interaction and the subtleties of their implementation, I plan to tell at DevConf 2013 " <a href="http://devconf.ru/offers/2">PHP demons in social games</a> ."  And also I will highlight some features that allowed me to increase the productivity of implemented projects.  If interested, then I will touch on the topic of the tarantula (for this I used the vote) So, see you at DevConf 2013. <br><br>  Ps.  already the third hour of the night, possible achapotki ... pliiiz in private - I will immediately correct.  Thanks in advance. </div><p>Source: <a href="https://habr.com/ru/post/113298/">https://habr.com/ru/post/113298/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../113289/index.html">Office equipment inventory</a></li>
<li><a href="../113290/index.html">From IT person to CIO ... through the Cloud</a></li>
<li><a href="../113291/index.html">Spanish authorities are suing Google</a></li>
<li><a href="../113295/index.html">Canadians have created an automated mini-laboratory for blood analysis.</a></li>
<li><a href="../113296/index.html">Anonymous attack Aaron Barr, who exposed them</a></li>
<li><a href="../113299/index.html">Master Class. Making a case on the iPad</a></li>
<li><a href="../113301/index.html">Cory Doctorow, "The Younger Brother"</a></li>
<li><a href="../113303/index.html">We test Panasonic 3D Image Sensor D-imager</a></li>
<li><a href="../113304/index.html">The catalog of interesting places on satellite images of Google</a></li>
<li><a href="../113307/index.html">What's new in my area? Track OpenStreetMap edits with your watch list!</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>