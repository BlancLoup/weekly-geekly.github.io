<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Create a multiplayer web game in the genre .io</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Released in 2015, Agar.io became the progenitor of the new genre of .io games , whose popularity has greatly increased since then. I experienced the g...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Create a multiplayer web game in the genre .io</h1><div class="post__text post__text-html js-mediator-article"><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/c7c/405/7a7/c7c4057a7ab7333ee3cb9aba5ecc8c37.jpg" alt="image"></div><br>  Released in 2015, <a href="https://agar.io/" rel="noopener noreferrer">Agar.io</a> became the progenitor of the new genre <a href="https://www.google.com/search%3Fq%3D.io%2Bgame" rel="noopener noreferrer"><strong>of .io games</strong></a> , whose popularity has greatly increased since then.  I experienced the growing popularity of .io games: in the last three years I have <a href="https://victorzhou.com/about/">created and sold two games of this genre.</a>  . <br><br>  In case you have never heard of such games before: these are free multiplayer web games that are easy to participate in (no account is required).  Usually they push together a number of opposing players in the same arena.  Other famous games of the genre .io: <a href="https://slither.io/" rel="noopener noreferrer">Slither.io</a> and <a href="https://diep.io/" rel="noopener noreferrer">Diep.io.</a> <br><br>  In this post we will understand how <strong>to create a game from scratch .io</strong> .  To do this, it will be enough just knowledge of Javascript: you need to understand things like the syntax <a href="https://www.w3schools.com/js/js_es6.asp" rel="noopener noreferrer">ES6</a> , the keyword <code>this</code> and <a href="https://developers.google.com/web/fundamentals/primers/promises" rel="noopener noreferrer">Promises</a> .  Even if you know Javascript is not perfect, you can still figure out most of the post. <br><a name="habracut"></a><br><h2>  Sample .io game </h2><br>  To help you learn, we will refer to the <a href="https://example-io-game.victorzhou.com/">example of the .io game</a> .  Try to play it! 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <div style="text-align:center;"><img src="https://habrastorage.org/webt/um/yq/qj/umyqqjon22wmshrz8o8wtyeaxl0.png"></div><br>  The game is quite simple: you control the ship in the arena, where there are other players.  Your ship automatically shoots projectiles and you try to hit other players while avoiding their projectiles. <br><br><h2>  1. Overview / Project Structure </h2><br><blockquote>  I recommend <a href="https://github.com/vzhou842/example-.io-game" rel="noopener noreferrer"><strong>downloading the source code of the</strong></a> sample game so that you can follow me. </blockquote><br>  The example uses the following: <br><br><ul><li>  <a href="https://expressjs.com/" rel="noopener noreferrer">Express</a> is the most popular Node.js web framework that manages the game‚Äôs web server. </li><li>  <a href="https://socket.io/" rel="noopener noreferrer">socket.io</a> is a websocket library for exchanging data between a browser and a server. </li><li>  <a href="https://webpack.js.org/">Webpack</a> - module manager.  About why to use Webpack, you can read <a href="https://victorzhou.com/blog/why-you-should-use-webpack/">here</a> . </li></ul><br>  Here is the structure of the project directory: <br><br><pre> <code class="hljs axapta"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span>/ assets/ ... src/ <span class="hljs-keyword"><span class="hljs-keyword">client</span></span>/ css/ ... html/ <span class="hljs-keyword"><span class="hljs-keyword">index</span></span>.html <span class="hljs-keyword"><span class="hljs-keyword">index</span></span>.js ... <span class="hljs-keyword"><span class="hljs-keyword">server</span></span>/ <span class="hljs-keyword"><span class="hljs-keyword">server</span></span>.js ... shared/ constants.js</code> </pre> <br><h3>  public / </h3><br>  Everything in the <code>public/</code> folder will be statically transmitted by the server.  <code>public/assets/</code> contains images used by our project. <br><br><h3>  src / </h3><br>  All source code is in the <code>src/</code> folder.  The names <code>client/</code> and <code>server/</code> speak for themselves, and <code>shared/</code> contains a file of constants imported by both the client and the server. <br><br><h2>  2. Build / project options </h2><br>  As mentioned above, we use the <a href="https://webpack.js.org/">Webpack</a> module manager to build the project.  Let's take a look at our Webpack configuration: <br><br><h5>  webpack.common.js: </h5><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">const</span></span> path = require(<span class="hljs-string"><span class="hljs-string">'path'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> MiniCssExtractPlugin = require(<span class="hljs-string"><span class="hljs-string">'mini-css-extract-plugin'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">module</span></span>.exports = { entry: { game: <span class="hljs-string"><span class="hljs-string">'./src/client/index.js'</span></span>, }, output: { filename: <span class="hljs-string"><span class="hljs-string">'[name].[contenthash].js'</span></span>, path: path.resolve(__dirname, <span class="hljs-string"><span class="hljs-string">'dist'</span></span>), }, <span class="hljs-keyword"><span class="hljs-keyword">module</span></span>: { rules: [ { test: /\.js$/, exclude: /node_modules/, use: { loader: <span class="hljs-string"><span class="hljs-string">"babel-loader"</span></span>, options: { presets: [<span class="hljs-string"><span class="hljs-string">'@babel/preset-env'</span></span>], }, }, }, { test: /\.css$/, use: [ { loader: MiniCssExtractPlugin.loader, }, <span class="hljs-string"><span class="hljs-string">'css-loader'</span></span>, ], }, ], }, plugins: [ <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> MiniCssExtractPlugin({ filename: <span class="hljs-string"><span class="hljs-string">'[name].[contenthash].css'</span></span>, }), <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> HtmlWebpackPlugin({ filename: <span class="hljs-string"><span class="hljs-string">'index.html'</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">template</span></span>: <span class="hljs-string"><span class="hljs-string">'src/client/html/index.html'</span></span>, }), ], };</code> </pre> <br>  The most important are the following lines: <br><br><ul><li>  <code>src/client/index.js</code> is the entry point of the Javascript client (JS).  Webpack will start from here and recursively look for other imported files. </li><li>  The output JS of our Webpack assembly will be located in the <code>dist/</code> directory.  I will call this file our <strong>js package</strong> . </li><li>  We use <a href="https://babeljs.io/" rel="noopener noreferrer">Babel</a> , and in particular the <a href="https://babeljs.io/docs/en/babel-preset-env" rel="noopener noreferrer">@ babel / preset-env</a> configuration for transpiling our JS code for older browsers. </li><li>  We use a plugin to extract all the CSS referenced by the JS files, and to combine them in one place.  I will call it our <strong>CSS package</strong> . </li></ul><br>  You may have noticed the strange names of the package files <code>'[name].[contenthash].ext'</code> .  They contain <a href="https://webpack.js.org/configuration/output/" rel="noopener noreferrer">substitutions for</a> Webpack <a href="https://webpack.js.org/configuration/output/" rel="noopener noreferrer">file names</a> : <code>[name]</code> will be replaced with the name of the input point (in our case it is a <code>game</code> ), and <code>[contenthash]</code> will be replaced with a hash of the file contents.  We do this to <a href="https://webpack.js.org/guides/caching/" rel="noopener noreferrer">optimize the project for hashing</a> ‚Äî you can order browsers to endlessly cache our JS packages, because <strong>if the package changes, its file name also</strong> changes (the <code>contenthash</code> changes).  The finished result is the file name of the <code>game.dbeee76e91a97d0c7207.js</code> file. <br><br>  The <code>webpack.common.js</code> file is the base configuration file that we import into the development and finished project configurations.  Here, for example, development configuration: <br><br><h5>  webpack.dev.js </h5><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">const</span></span> merge = require(<span class="hljs-string"><span class="hljs-string">'webpack-merge'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> common = require(<span class="hljs-string"><span class="hljs-string">'./webpack.common.js'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">module</span></span>.exports = merge(common, { mode: <span class="hljs-string"><span class="hljs-string">'development'</span></span>, });</code> </pre> <br>  For efficiency, we use <code>webpack.dev.js</code> in the development <code>webpack.dev.js</code> , and switch to <code>webpack.prod.js</code> to optimize the size of the packages when deployed to production. <br><br><h3>  Local setting </h3><br>  I recommend installing the project on a local machine so that you can follow the steps listed in this post.  The setup is simple: first, <a href="https://nodejs.org/en/download/">Node</a> and <a href="https://www.npmjs.com/get-npm">NPM</a> must be installed on the system.  Next you need to run <br><br><pre> <code class="cpp hljs">$ git clone https:<span class="hljs-comment"><span class="hljs-comment">//github.com/vzhou842/example-.io-game.git $ cd example-.io-game $ npm install</span></span></code> </pre> <br>  and you are ready to go!  To start the development server, just run <br><br><pre> <code class="cpp hljs">$ npm run develop</code> </pre> <br>  and go to the web browser on <a href="http://localhost:3000/" rel="noopener noreferrer">localhost: 3000</a> .  The development server will automatically rebuild the JS and CSS packages as the code changes - just refresh the page to see all the changes! <br><br><h2>  3. Customer entry points </h2><br>  Let's get to the game code itself.  For a start, we will need the <code>index.html</code> page, when visiting the site the browser will load it first.  Our page will be pretty simple: <br><br><h5>  index.html </h5><br><pre>  &lt;! DOCTYPE html&gt;
 &lt;html&gt;
 &lt;head&gt;
   &lt;title&gt; An example .io game &lt;/ title&gt;
   &lt;link type = "text / css" rel = "stylesheet" href = "/ game.bundle.css"&gt;
 &lt;/ head&gt;
 &lt;body&gt;
   &lt;canvas id = "game-canvas"&gt; &lt;/ canvas&gt;
   &lt;script async src = "/ game.bundle.js"&gt; &lt;/ script&gt;
   &lt;div id = "play-menu" class = "hidden"&gt;
     &lt;input type = "text" id = "username-input" placeholder = "Username" /&gt;
     &lt;button id = "play-button"&gt; PLAY &lt;/ button&gt;
   &lt;/ div&gt;
 &lt;/ body&gt;
 &lt;/ html&gt; </pre><br>  <i>This code sample is slightly simplified for clarity, I will do the same with many other post examples.</i>  <i>The full code can always be viewed on <a href="https://github.com/vzhou842/example-.io-game">Github</a> .</i> <br><br>  We have: <br><br><ul><li>  <a href="https://www.w3schools.com/html/html5_canvas.asp">The HTML5 Canvas element</a> ( <code>&lt;canvas&gt;</code> ) that we will use to render the game. </li><li>  <code>&lt;link&gt;</code> to add our CSS package. </li><li>  <code>&lt;script&gt;</code> to add our javascript package. </li><li>  Main menu with user name <code>&lt;input&gt;</code> and button ‚ÄúPLAY‚Äù ( <code>&lt;button&gt;</code> ). </li></ul><br>  After loading the home page in the browser, Javascript code will start to run, starting with the input point JS file: <code>src/client/index.js</code> . <br><br><h5>  index.js </h5><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> { connect, play } <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'./networking'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> { startRendering, stopRendering } <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'./render'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> { startCapturingInput, stopCapturingInput } <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'./input'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> { downloadAssets } <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'./assets'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> { initState } <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'./state'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> { setLeaderboardHidden } <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'./leaderboard'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> <span class="hljs-string"><span class="hljs-string">'./css/main.css'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> playMenu = <span class="hljs-built_in"><span class="hljs-built_in">document</span></span>.getElementById(<span class="hljs-string"><span class="hljs-string">'play-menu'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> playButton = <span class="hljs-built_in"><span class="hljs-built_in">document</span></span>.getElementById(<span class="hljs-string"><span class="hljs-string">'play-button'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> usernameInput = <span class="hljs-built_in"><span class="hljs-built_in">document</span></span>.getElementById(<span class="hljs-string"><span class="hljs-string">'username-input'</span></span>); <span class="hljs-built_in"><span class="hljs-built_in">Promise</span></span>.all([ connect(), downloadAssets(), ]).then(<span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> =&gt;</span></span> { playMenu.classList.remove(<span class="hljs-string"><span class="hljs-string">'hidden'</span></span>); usernameInput.focus(); playButton.onclick = <span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> =&gt;</span></span> { <span class="hljs-comment"><span class="hljs-comment">// Play! play(usernameInput.value); playMenu.classList.add('hidden'); initState(); startCapturingInput(); startRendering(); setLeaderboardHidden(false); }; });</span></span></code> </pre> <br>  This may seem complicated, but in reality there are not so many actions happening here: <br><br><ol><li>  Import several other JS files. </li><li>  Import CSS (for Webpack to know that you need to include it in our CSS package). </li><li>  Run <code>connect()</code> to establish a connection with the server and launch <code>downloadAssets()</code> to download the images needed to render the game. </li><li>  <em>After completing step 3</em> , the main menu ( <code>playMenu</code> ) is <code>playMenu</code> . </li><li>  Configuring the "PLAY" button click handler.  When the button is pressed, the code initializes the game and informs the server that we are ready to play. </li></ol><br>  The main "meat" of our client-server logic is in those files that were imported by the <code>index.js</code> file.  Now we consider them all in order. <br><br><h2>  4. Client data exchange </h2><br>  In this game, we use the well-known library <a href="https://socket.io/">socket.io</a> to communicate with the server.  Socket.io has built-in support for <a href="https://developer.mozilla.org/en-US/docs/Web/API/WebSockets_API">WebSockets</a> , which are well suited for two-way communication: we can send messages to the server <em>and the</em> server can send messages to us via the same connection. <br><br>  We will have one <code>src/client/networking.js</code> file that will handle <strong>all</strong> communications with the server: <br><br><h5>  networking.js </h5><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> io <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'socket.io-client'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> { processGameUpdate } <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'./state'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> Constants = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'../shared/constants'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> socket = io(<span class="hljs-string"><span class="hljs-string">`ws://</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${</span></span><span class="hljs-built_in"><span class="hljs-string"><span class="hljs-subst"><span class="hljs-built_in">window</span></span></span></span><span class="hljs-string"><span class="hljs-subst">.location.host}</span></span></span><span class="hljs-string">`</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> connectedPromise = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-built_in"><span class="hljs-built_in">Promise</span></span>(<span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">resolve</span></span></span><span class="hljs-function"> =&gt;</span></span> { socket.on(<span class="hljs-string"><span class="hljs-string">'connect'</span></span>, () =&gt; { <span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.log(<span class="hljs-string"><span class="hljs-string">'Connected to server!'</span></span>); resolve(); }); }); <span class="hljs-keyword"><span class="hljs-keyword">export</span></span> <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> connect = <span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">onGameOver</span></span></span><span class="hljs-function"> =&gt;</span></span> ( connectedPromise.then(<span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> =&gt;</span></span> { <span class="hljs-comment"><span class="hljs-comment">// Register callbacks socket.on(Constants.MSG_TYPES.GAME_UPDATE, processGameUpdate); socket.on(Constants.MSG_TYPES.GAME_OVER, onGameOver); }) ); export const play = username =&gt; { socket.emit(Constants.MSG_TYPES.JOIN_GAME, username); }; export const updateDirection = dir =&gt; { socket.emit(Constants.MSG_TYPES.INPUT, dir); };</span></span></code> </pre> <br>  <i>This code is also slightly shortened for clarity.</i> <br><br>  There are three main actions in this file: <br><br><ul><li>  We are trying to connect to the server.  <code>connectedPromise</code> allowed only when we have established a connection. </li><li>  If the connection is successfully established, we register callback functions ( <code>processGameUpdate()</code> and <code>onGameOver()</code> ) for messages that we can receive from the server. </li><li>  We export <code>play()</code> and <code>updateDirection()</code> so that other files can use them. </li></ul><br><h2>  5. Client Rendering </h2><br>  It is time to display a picture on the screen! <br><br>  ... but before we can do this, you need to download all the images (resources) that are needed for this.  Let's write a resource manager: <br><br><h5>  assets.js </h5><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">const</span></span> ASSET_NAMES = [<span class="hljs-string"><span class="hljs-string">'ship.svg'</span></span>, <span class="hljs-string"><span class="hljs-string">'bullet.svg'</span></span>]; <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> assets = {}; <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> downloadPromise = <span class="hljs-built_in"><span class="hljs-built_in">Promise</span></span>.all(ASSET_NAMES.map(downloadAsset)); <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">downloadAsset</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">assetName</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-built_in"><span class="hljs-built_in">Promise</span></span>(<span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">resolve</span></span></span><span class="hljs-function"> =&gt;</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> asset = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Image(); asset.onload = <span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> =&gt;</span></span> { <span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.log(<span class="hljs-string"><span class="hljs-string">`Downloaded </span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${assetName}</span></span></span><span class="hljs-string">`</span></span>); assets[assetName] = asset; resolve(); }; asset.src = <span class="hljs-string"><span class="hljs-string">`/assets/</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${assetName}</span></span></span><span class="hljs-string">`</span></span>; }); } <span class="hljs-keyword"><span class="hljs-keyword">export</span></span> <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> downloadAssets = <span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> =&gt;</span></span> downloadPromise; <span class="hljs-keyword"><span class="hljs-keyword">export</span></span> <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> getAsset = <span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">assetName</span></span></span><span class="hljs-function"> =&gt;</span></span> assets[assetName];</code> </pre> <br>  Resource management is not so difficult to implement!  The main point is to keep the <code>assets</code> object, which will bind the key of the file name to the value of the <code>Image</code> object.  When the resource is loaded, we save it in the <code>assets</code> object for a quick receipt in the future.  When downloading of each individual resource will be allowed (that is, <strong>all</strong> resources will be downloaded), we allow <code>downloadPromise</code> . <br><br>  After downloading the resources, you can start rendering.  As mentioned earlier, we use <a href="https://www.w3schools.com/html/html5_canvas.asp">HTML5 Canvas</a> ( <code>&lt;canvas&gt;</code> ) for drawing on a web page.  Our game is pretty simple, so we only need to draw the following: <br><br><ol><li>  Background </li><li>  Player ship </li><li>  Other players in the game </li><li>  Shells </li></ol><br>  Here are the important snippets of <code>src/client/render.js</code> that draw exactly the four points listed above: <br><br><h5>  render.js </h5><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> { getAsset } <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'./assets'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> { getCurrentState } <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'./state'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> Constants = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'../shared/constants'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> { PLAYER_RADIUS, PLAYER_MAX_HP, BULLET_RADIUS, MAP_SIZE } = Constants; <span class="hljs-comment"><span class="hljs-comment">// Get the canvas graphics context const canvas = document.getElementById('game-canvas'); const context = canvas.getContext('2d'); // Make the canvas fullscreen canvas.width = window.innerWidth; canvas.height = window.innerHeight; function render() { const { me, others, bullets } = getCurrentState(); if (!me) { return; } // Draw background renderBackground(me.x, me.y); // Draw all bullets bullets.forEach(renderBullet.bind(null, me)); // Draw all players renderPlayer(me, me); others.forEach(renderPlayer.bind(null, me)); } // ... Helper functions here excluded let renderInterval = null; export function startRendering() { renderInterval = setInterval(render, 1000 / 60); } export function stopRendering() { clearInterval(renderInterval); }</span></span></code> </pre> <br>  <i>This code is also abbreviated for clarity.</i> <br><br>  <code>render()</code> is the main function of this file.  <code>startRendering()</code> and <code>stopRendering()</code> control the activation of the render cycle at 60 FPS. <br><br>  Specific implementations of individual rendering rendering functions (for example, <code>renderBullet()</code> ) are not so important, but here is one simple example: <br><br><h5>  render.js </h5><br><pre> <code class="javascript hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">renderBullet</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">me, bullet</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> { x, y } = bullet; context.drawImage( getAsset(<span class="hljs-string"><span class="hljs-string">'bullet.svg'</span></span>), canvas.width / <span class="hljs-number"><span class="hljs-number">2</span></span> + x - me.x - BULLET_RADIUS, canvas.height / <span class="hljs-number"><span class="hljs-number">2</span></span> + y - me.y - BULLET_RADIUS, BULLET_RADIUS * <span class="hljs-number"><span class="hljs-number">2</span></span>, BULLET_RADIUS * <span class="hljs-number"><span class="hljs-number">2</span></span>, ); }</code> </pre> <br>  Notice that we use the <code>getAsset()</code> method that was previously seen in <code>asset.js</code> ! <br><br><blockquote>  If you are interested in exploring other auxiliary rendering functions, then read the rest of <a href="">src / client / render.js</a> . </blockquote><br><h2>  6. Client input </h2><br>  It is time to make the game <em>playable</em> !  The control scheme will be very simple: you can use the mouse (on a computer) or touch the screen (on a mobile device) to change the direction of movement.  To do this, we will register <a href="https://developer.mozilla.org/en-US/docs/Web/API/EventListener">Event Listeners</a> for Mouse and Touch events. <br>  All this will be <code>src/client/input.js</code> : <br><br><h5>  input.js </h5><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> { updateDirection } <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'./networking'</span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onMouseInput</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">e</span></span></span><span class="hljs-function">) </span></span>{ handleInput(e.clientX, e.clientY); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onTouchInput</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">e</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> touch = e.touches[<span class="hljs-number"><span class="hljs-number">0</span></span>]; handleInput(touch.clientX, touch.clientY); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">handleInput</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">x, y</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> dir = <span class="hljs-built_in"><span class="hljs-built_in">Math</span></span>.atan2(x - <span class="hljs-built_in"><span class="hljs-built_in">window</span></span>.innerWidth / <span class="hljs-number"><span class="hljs-number">2</span></span>, <span class="hljs-built_in"><span class="hljs-built_in">window</span></span>.innerHeight / <span class="hljs-number"><span class="hljs-number">2</span></span> - y); updateDirection(dir); } <span class="hljs-keyword"><span class="hljs-keyword">export</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">startCapturingInput</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-built_in"><span class="hljs-built_in">window</span></span>.addEventListener(<span class="hljs-string"><span class="hljs-string">'mousemove'</span></span>, onMouseInput); <span class="hljs-built_in"><span class="hljs-built_in">window</span></span>.addEventListener(<span class="hljs-string"><span class="hljs-string">'touchmove'</span></span>, onTouchInput); } <span class="hljs-keyword"><span class="hljs-keyword">export</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">stopCapturingInput</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-built_in"><span class="hljs-built_in">window</span></span>.removeEventListener(<span class="hljs-string"><span class="hljs-string">'mousemove'</span></span>, onMouseInput); <span class="hljs-built_in"><span class="hljs-built_in">window</span></span>.removeEventListener(<span class="hljs-string"><span class="hljs-string">'touchmove'</span></span>, onTouchInput); }</code> </pre> <br>  <code>onMouseInput()</code> and <code>onTouchInput()</code> are Event Listeners that call <code>updateDirection()</code> (from <code>networking.js</code> ) when an input event occurs (for example, when you move the mouse).  <code>updateDirection()</code> handles messaging with a server that processes an input event and updates the game state accordingly. <br><br><h2>  7. Customer Status </h2><br><blockquote>  This section is the most difficult in the first part of the post.  Do not be discouraged if you do not understand it from the first reading!  You can even skip it and come back to it later. </blockquote><br>  The last piece of the puzzle that is needed to complete the client-server code is <strong>state</strong> .  Remember the code snippet from the Client Rendering section? <br><br><h5>  render.js </h5><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> { getCurrentState } <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'./state'</span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">render</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> { me, others, bullets } = getCurrentState(); <span class="hljs-comment"><span class="hljs-comment">// Do the rendering // ... }</span></span></code> </pre> <br>  <code>getCurrentState()</code> should be able to provide us with the current state of the game in the client <strong>at any time</strong> based on the updates received from the server.  Here is an example of a game update that a server can send: <br><br><pre> <code class="cpp hljs">{ <span class="hljs-string"><span class="hljs-string">"t"</span></span>: <span class="hljs-number"><span class="hljs-number">1555960373725</span></span>, <span class="hljs-string"><span class="hljs-string">"me"</span></span>: { <span class="hljs-string"><span class="hljs-string">"x"</span></span>: <span class="hljs-number"><span class="hljs-number">2213.8050880413657</span></span>, <span class="hljs-string"><span class="hljs-string">"y"</span></span>: <span class="hljs-number"><span class="hljs-number">1469.370893425012</span></span>, <span class="hljs-string"><span class="hljs-string">"direction"</span></span>: <span class="hljs-number"><span class="hljs-number">1.3082443894581433</span></span>, <span class="hljs-string"><span class="hljs-string">"id"</span></span>: <span class="hljs-string"><span class="hljs-string">"AhzgAtklgo2FJvwWAADO"</span></span>, <span class="hljs-string"><span class="hljs-string">"hp"</span></span>: <span class="hljs-number"><span class="hljs-number">100</span></span> }, <span class="hljs-string"><span class="hljs-string">"others"</span></span>: [], <span class="hljs-string"><span class="hljs-string">"bullets"</span></span>: [ { <span class="hljs-string"><span class="hljs-string">"id"</span></span>: <span class="hljs-string"><span class="hljs-string">"RUJfJ8Y18n"</span></span>, <span class="hljs-string"><span class="hljs-string">"x"</span></span>: <span class="hljs-number"><span class="hljs-number">2354.029197099604</span></span>, <span class="hljs-string"><span class="hljs-string">"y"</span></span>: <span class="hljs-number"><span class="hljs-number">1431.6848318262666</span></span> }, { <span class="hljs-string"><span class="hljs-string">"id"</span></span>: <span class="hljs-string"><span class="hljs-string">"ctg5rht5s"</span></span>, <span class="hljs-string"><span class="hljs-string">"x"</span></span>: <span class="hljs-number"><span class="hljs-number">2260.546457727445</span></span>, <span class="hljs-string"><span class="hljs-string">"y"</span></span>: <span class="hljs-number"><span class="hljs-number">1456.8088728920968</span></span> } ], <span class="hljs-string"><span class="hljs-string">"leaderboard"</span></span>: [ { <span class="hljs-string"><span class="hljs-string">"username"</span></span>: <span class="hljs-string"><span class="hljs-string">"Player"</span></span>, <span class="hljs-string"><span class="hljs-string">"score"</span></span>: <span class="hljs-number"><span class="hljs-number">3</span></span> } ] }</code> </pre> <br>  Each game update contains five identical fields: <br><br><ul><li>  <strong>t</strong> : server timestamp indicating when this update was created. </li><li>  <strong>me</strong> : information about the player receiving this update. </li><li>  <strong>others</strong> : an array of information about other players participating in the same game. </li><li>  <strong>bullets</strong> : an array of information about the shells in the game. </li><li>  <strong>leaderboard</strong> : current leaderboard data.  In this post we will not take them into account. </li></ul><br><h3>  7.1 Naive client state </h3><br>  The naive implementation of <code>getCurrentState()</code> can only directly return the data of the latest received game update. <br><br><h5>  naive-state.js </h5><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">let</span></span> lastGameUpdate = <span class="hljs-literal"><span class="hljs-literal">null</span></span>; <span class="hljs-comment"><span class="hljs-comment">// Handle a newly received game update. export function processGameUpdate(update) { lastGameUpdate = update; } export function getCurrentState() { return lastGameUpdate; }</span></span></code> </pre> <br>  Beautiful and clear!  But if everything was so simple.  One of the reasons why this implementation is problematic: <strong>it limits the rendering frame rate to the server clock frequency</strong> . <br><br><blockquote>  <strong>Frame Rate</strong> : The number of frames (i.e. <code>render()</code> calls) per second, or FPS.  In games, they usually strive to achieve at least 60 FPS. </blockquote><br><blockquote>  <strong>Tick ‚Äã‚ÄãRate</strong> : The frequency with which the server sends game updates to clients.  <strong>Often it is lower than the frame rate</strong> .  In our game, the server operates at a frequency of 30 clocks per second. </blockquote><br>  If we just render the latest update of the game, then the FPS will in fact never be able to exceed 30, because <em>we never get more than 30 updates per second from the server</em> .  Even if we call <code>render()</code> 60 times a second, half of these calls will simply redraw the same thing, in essence, without doing anything.  Another problem with the naive implementation is that it is <strong>subject to delays</strong> .  With the ideal Internet speed, the client will receive a game update exactly every 33 ms (30 per second): <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/bc3/815/7c9/bc38157c91d436b5fedf948b60c8a213.svg"></div><br>  Unfortunately, nothing is perfect.  A more realistic picture would be: <br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/836/45f/75e/83645f75e556bc5c1c38111a69510734.svg"></div><br>  A naive implementation is practically the worst case when it comes to delays.  If a game update is received with a delay of 50 ms, the <strong>client is braked</strong> for an extra 50 ms, because it still renders the game state from the previous update.  You can imagine how inconvenient this is for the player: because of arbitrary braking, the game will seem torn and unstable. <br><br><h3>  7.2 Improved client status </h3><br>  We will make some improvements to the naive implementation.  First, we use <strong>a rendering delay of</strong> 100 ms.  This means that the ‚Äúcurrent‚Äù client state will always lag behind the game state on the server by 100 ms.  For example, if the server time is <strong>150</strong> , then the client will render the state in which the server was at time <strong>50</strong> : <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/788/1b5/c78/7881b5c789321648ff1ff70d15b881d4.svg"></div><br>  This gives us a 100 ms buffer that allows us to experience an unpredictable time for receiving game updates: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/c1e/494/615/c1e4946159c599c7a2a9196968755e4b.svg"></div><br>  The cost of this will be a constant <a href="https://en.wikipedia.org/wiki/Input_lag" rel="noopener noreferrer">input delay (input lag)</a> for 100 ms.  This is a minor sacrifice for smooth gameplay - most players (especially casual ones) will not even notice this delay.  People are much easier to adapt to the constant delay of 100 ms, than to play with an unpredictable delay. <br><br><blockquote>  We can use another technique called <a href="https://en.wikipedia.org/wiki/Client-side_prediction" rel="noopener noreferrer">‚Äúclient side prediction,‚Äù</a> which does a good job of reducing perceived delays, but it will not be considered in this post. </blockquote><br>  Another improvement we use is <strong>linear interpolation</strong> .  Because of the delay in rendering, we usually overtake the current time in the client by at least one update.  When <code>getCurrentState()</code> is called, we can perform <a href="https://en.wikipedia.org/wiki/Linear_interpolation" rel="noopener noreferrer">linear interpolation</a> between game updates just before and after the current time in the client: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/2ca/1c8/91c/2ca1c891ce7db0341dc78c2f88e16ce4.svg"></div><br>  This solves the problem with the frame rate: now we can render unique frames with any frequency we need! <br><br><h3>  7.3 Implementing an improved client state </h3><br>  An example implementation in <code>src/client/state.js</code> uses both rendering delay and linear interpolation, but this is not for long.  Let's break the code into two parts.  Here is the first: <br><br><h5>  state.js part 1 </h5><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">const</span></span> RENDER_DELAY = <span class="hljs-number"><span class="hljs-number">100</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> gameUpdates = []; <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> gameStart = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> firstServerTimestamp = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">export</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">initState</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ gameStart = <span class="hljs-number"><span class="hljs-number">0</span></span>; firstServerTimestamp = <span class="hljs-number"><span class="hljs-number">0</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">export</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">processGameUpdate</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">update</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!firstServerTimestamp) { firstServerTimestamp = update.t; gameStart = <span class="hljs-built_in"><span class="hljs-built_in">Date</span></span>.now(); } gameUpdates.push(update); <span class="hljs-comment"><span class="hljs-comment">// Keep only one game update before the current server time const base = getBaseUpdate(); if (base &gt; 0) { gameUpdates.splice(0, base); } } function currentServerTime() { return firstServerTimestamp + (Date.now() - gameStart) - RENDER_DELAY; } // Returns the index of the base update, the first game update before // current server time, or -1 if N/A. function getBaseUpdate() { const serverTime = currentServerTime(); for (let i = gameUpdates.length - 1; i &gt;= 0; i--) { if (gameUpdates[i].t &lt;= serverTime) { return i; } } return -1; }</span></span></code> </pre> <br>  The first step is to figure out what <code>currentServerTime()</code> does.  As we saw earlier, the server timestamp is included in every game update.  We want to use the rendering delay to render the picture, lagging the server by 100 ms, but <strong>we will never know the current time on the server</strong> , because we cannot know how long any of the updates reached us.  The Internet is unpredictable and its speed can vary greatly! <br><br>  To get around this problem, you can use a reasonable approximation: we <strong>pretend that the first update arrived instantly</strong> .  If this were true, then we would know the server time at this particular moment!  We save the server timestamp in <code>firstServerTimestamp</code> and save our <strong>local</strong> (client) timestamp at the same time in <code>gameStart</code> . <br><br>  Oh, wait a minute.  <b>Shouldn't there be time on the server = time in the client?</b>  Why do we distinguish between "server time stamp" and "client time stamp"?  This is a great question!  It turns out that this is not the same thing.  <code>Date.now()</code> will return different time stamps in the client and server, and this depends on local factors for these machines.  <strong>Never assume that the time stamps will be the same on all machines.</strong> <br><br>  Now we understand what <code>currentServerTime()</code> does: it returns the <strong>timestamp of the current rendering time server</strong> .<font style="vertical-align: inherit;"><font style="vertical-align: inherit;">In other words, this is the current server time ( </font></font><code>firstServerTimestamp &lt;+ (Date.now() - gameStart)</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">) minus the rendering delay ( </font></font><code>RENDER_DELAY</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">). </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Now let's see how we handle game updates. When retrieving an update from the server, it is invoked </font></font><code>processGameUpdate()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, and we save the new update to an array </font></font><code>gameUpdates</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. Then, to check the memory usage, we delete all the old updates to the </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">base update</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , because we don‚Äôt need them anymore. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">What is a "basic update"? This is the </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">first update we find when moving back from the current server time</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . Remember this scheme?</font></font><br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/2ca/1c8/91c/2ca1c891ce7db0341dc78c2f88e16ce4.svg"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Updating the game directly to the left of Client Render Time is a basic update. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">What is the base update used for? </font><font style="vertical-align: inherit;">Why can we drop updates to the base one? </font><font style="vertical-align: inherit;">To understand this, let's </font></font><em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">finally</font></font></em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> consider the implementation </font></font><code>getCurrentState()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">:</font></font><br><br><h5><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> state.js part 2 </font></font></h5><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">export</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getCurrentState</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!firstServerTimestamp) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> {}; } <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> base = getBaseUpdate(); <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> serverTime = currentServerTime(); <span class="hljs-comment"><span class="hljs-comment">// If base is the most recent update we have, use its state. // Else, interpolate between its state and the state of (base + 1). if (base &lt; 0) { return gameUpdates[gameUpdates.length - 1]; } else if (base === gameUpdates.length - 1) { return gameUpdates[base]; } else { const baseUpdate = gameUpdates[base]; const next = gameUpdates[base + 1]; const r = (serverTime - baseUpdate.t) / (next.t - baseUpdate.t); return { me: interpolateObject(baseUpdate.me, next.me, r), others: interpolateObjectArray(baseUpdate.others, next.others, r), bullets: interpolateObjectArray(baseUpdate.bullets, next.bullets, r), }; } }</span></span></code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> We handle three cases: </font></font><br><br><ol><li> <code>base &lt; 0</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">means that up to the current rendering time there are no updates (see implementation above </font></font><code>getBaseUpdate()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">). </font><font style="vertical-align: inherit;">This can happen immediately at the beginning of the game due to the delay in rendering. </font><font style="vertical-align: inherit;">In this case, we use the latest update received.</font></font></li><li> <code>base</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">- This is the latest update that we have. </font><font style="vertical-align: inherit;">This may be due to network latency or poor Internet connection. </font><font style="vertical-align: inherit;">In this case, we also use the latest update that we have.</font></font></li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">We have an update both before and after the current rendering time, so you can </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">interpolate</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> !</font></font></li></ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">All that remains </font></font><code>state.js</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">is a realization of linear interpolation, which is a simple (but boring) mathematics. </font><font style="vertical-align: inherit;">If you want to study it yourself, then open it </font></font><code>state.js</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">on </font></font><a href="" rel="noopener noreferrer"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Github</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font><br><br><h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Part 2. Backend server </font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">In this section, we will look at the Node.js backend, which manages our </font></font><a href="https://example-io-game.victorzhou.com/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">example .io game</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font><br><br><h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 1. Server entry point </font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">To manage the web server, we will use the popular Node.js web framework called </font></font><a href="https://expressjs.com/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Express</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">It will be configured by our server entry point file </font></font><code>src/server/server.js</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">:</font></font><br><br><h5><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> server.js part 1 </font></font></h5><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">const</span></span> express = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'express'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> webpack = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'webpack'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> webpackDevMiddleware = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'webpack-dev-middleware'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> webpackConfig = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'../../webpack.dev.js'</span></span>); <span class="hljs-comment"><span class="hljs-comment">// Setup an Express server const app = express(); app.use(express.static('public')); if (process.env.NODE_ENV === 'development') { // Setup Webpack for development const compiler = webpack(webpackConfig); app.use(webpackDevMiddleware(compiler)); } else { // Static serve the dist/ folder in production app.use(express.static('dist')); } // Listen on port const port = process.env.PORT || 3000; const server = app.listen(port); console.log(`Server listening on port ${port}`);</span></span></code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Remember that in the first part we discussed the Webpack? </font><font style="vertical-align: inherit;">This is where we will use our Webpack configurations. </font><font style="vertical-align: inherit;">We will apply them in two ways:</font></font><br><br><ul><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Use </font></font><a href="https://github.com/webpack/webpack-dev-middleware"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">webpack-dev-middleware</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> to automatically rebuild our development packages, or</font></font></li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Statically transfer the folder </font></font><code>dist/</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">in which Webpack will write our files after the production build.</font></font></li></ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Another important task </font></font><code>server.js</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">is to configure the </font></font><a href="https://socket.io/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">socket.io</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> server </font><font style="vertical-align: inherit;">, which simply connects to the Express server:</font></font><br><br><h5><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> server.js part 2 </font></font></h5><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">const</span></span> socketio = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'socket.io'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> Constants = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'../shared/constants'</span></span>); <span class="hljs-comment"><span class="hljs-comment">// Setup Express // ... const server = app.listen(port); console.log(`Server listening on port ${port}`); // Setup socket.io const io = socketio(server); // Listen for socket.io connections io.on('connection', socket =&gt; { console.log('Player connected!', socket.id); socket.on(Constants.MSG_TYPES.JOIN_GAME, joinGame); socket.on(Constants.MSG_TYPES.INPUT, handleInput); socket.on('disconnect', onDisconnect); });</span></span></code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">After successfully connecting the socket.io to the server, we set up event handlers for the new socket. </font><font style="vertical-align: inherit;">Event handlers process messages received from clients by delegating to a singleton object </font></font><code>game</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">:</font></font><br><br><h5><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> server.js part 3 </font></font></h5><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">const</span></span> Game = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'./game'</span></span>); <span class="hljs-comment"><span class="hljs-comment">// ... // Setup the Game const game = new Game(); function joinGame(username) { game.addPlayer(this, username); } function handleInput(dir) { game.handleInput(this, dir); } function onDisconnect() { game.removePlayer(this); }</span></span></code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">We are creating a game of the .io genre, so we need only one copy </font></font><code>Game</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">(‚ÄúGame‚Äù) - all players play in the same arena! </font><font style="vertical-align: inherit;">In the next section, we will look at how this class works </font></font><code>Game</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">.</font></font><br><br><h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 2. Game server </font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The class </font></font><code>Game</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">contains the most important server-side logic. </font><font style="vertical-align: inherit;">It has two main tasks: </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">player control</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> and </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">game simulation</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Let's start with the first task - control the players.</font></font><br><br><h5><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> game.js, part 1 </font></font></h5><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">const</span></span> Constants = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'../shared/constants'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> Player = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'./player'</span></span>); <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Game</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">constructor</span></span>() { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.sockets = {}; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.players = {}; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.bullets = []; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.lastUpdateTime = <span class="hljs-built_in"><span class="hljs-built_in">Date</span></span>.now(); <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.shouldSendUpdate = <span class="hljs-literal"><span class="hljs-literal">false</span></span>; setInterval(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.update.bind(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>), <span class="hljs-number"><span class="hljs-number">1000</span></span> / <span class="hljs-number"><span class="hljs-number">60</span></span>); } addPlayer(socket, username) { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.sockets[socket.id] = socket; <span class="hljs-comment"><span class="hljs-comment">// Generate a position to start this player at. const x = Constants.MAP_SIZE * (0.25 + Math.random() * 0.5); const y = Constants.MAP_SIZE * (0.25 + Math.random() * 0.5); this.players[socket.id] = new Player(socket.id, username, x, y); } removePlayer(socket) { delete this.sockets[socket.id]; delete this.players[socket.id]; } handleInput(socket, dir) { if (this.players[socket.id]) { this.players[socket.id].setDirection(dir); } } // ... }</span></span></code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">In this game, we will identify players by </font></font><code>id</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">their socket.io socket field (if you mess up, then go back to </font></font><code>server.js</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">). </font><font style="vertical-align: inherit;">Socket.io itself assigns each socket a unique one </font></font><code>id</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, so we don‚Äôt need to worry about it. </font><font style="vertical-align: inherit;">I will call it </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">player ID</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">With this in mind, let's examine the instance variables in the class </font></font><code>Game</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">:</font></font><br><br><ul><li> <code>sockets</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">- this is the object that binds the player ID to the socket that is associated with the player. </font><font style="vertical-align: inherit;">It allows us to get access to sockets by their player IDs for a constant time.</font></font></li><li> <code>players</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - this is the object that binds the player ID to the object code&gt; Player </font></font></li></ul><br> <code>bullets</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Is an array of objects </font></font><code>Bullet</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">that does not have a specific order. </font></font><br> <code>lastUpdateTime</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">- This is the timestamp of the last update of the game. </font><font style="vertical-align: inherit;">Soon we will see how it is used. </font></font><br> <code>shouldSendUpdate</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Is an auxiliary variable. </font><font style="vertical-align: inherit;">We will see its use soon too. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Methods </font></font><code>addPlayer()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, </font></font><code>removePlayer()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">and </font></font><code>handleInput()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">no need to explain, they are used in </font></font><code>server.js</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">If you need to refresh your memory, go back a little higher. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The last line </font></font><code>constructor()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">starts </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">the</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> game </font><strong><font style="vertical-align: inherit;">update cycle</font></strong><font style="vertical-align: inherit;"> (with a frequency of 60 updates / s):</font></font><br><br><h5><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> game.js, part 2 </font></font></h5><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">const</span></span> Constants = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'../shared/constants'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> applyCollisions = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'./collisions'</span></span>); <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Game</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-comment"><span class="hljs-comment">// ... update() { // Calculate time elapsed const now = Date.now(); const dt = (now - this.lastUpdateTime) / 1000; this.lastUpdateTime = now; // Update each bullet const bulletsToRemove = []; this.bullets.forEach(bullet =&gt; { if (bullet.update(dt)) { // Destroy this bullet bulletsToRemove.push(bullet); } }); this.bullets = this.bullets.filter( bullet =&gt; !bulletsToRemove.includes(bullet), ); // Update each player Object.keys(this.sockets).forEach(playerID =&gt; { const player = this.players[playerID]; const newBullet = player.update(dt); if (newBullet) { this.bullets.push(newBullet); } }); // Apply collisions, give players score for hitting bullets const destroyedBullets = applyCollisions( Object.values(this.players), this.bullets, ); destroyedBullets.forEach(b =&gt; { if (this.players[b.parentID]) { this.players[b.parentID].onDealtDamage(); } }); this.bullets = this.bullets.filter( bullet =&gt; !destroyedBullets.includes(bullet), ); // Check if any players are dead Object.keys(this.sockets).forEach(playerID =&gt; { const socket = this.sockets[playerID]; const player = this.players[playerID]; if (player.hp &lt;= 0) { socket.emit(Constants.MSG_TYPES.GAME_OVER); this.removePlayer(socket); } }); // Send a game update to each player every other time if (this.shouldSendUpdate) { const leaderboard = this.getLeaderboard(); Object.keys(this.sockets).forEach(playerID =&gt; { const socket = this.sockets[playerID]; const player = this.players[playerID]; socket.emit( Constants.MSG_TYPES.GAME_UPDATE, this.createUpdate(player, leaderboard), ); }); this.shouldSendUpdate = false; } else { this.shouldSendUpdate = true; } } // ... }</span></span></code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The method </font></font><code>update()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">probably contains the most important part of server-side logic. </font><font style="vertical-align: inherit;">In order we list everything that he does:</font></font><br><br><ol><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Calculates how much time </font></font><code>dt</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">has passed since the last one </font></font><code>update()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">.</font></font></li><li>        .      .    ,  <code>bullet.update()</code> <strong> <code>true</code> ,     </strong> (    ). </li><li>        .       ‚Äî <code>player.update()</code> <strong>   <code>Bullet</code></strong> . </li><li>         <code>applyCollisions()</code> ,    ,    .        ,    (  <code>player.onDealtDamage()</code> ),       <code>bullets</code> . </li><li>      . </li><li>      <strong> </strong>    <code>update()</code> .         <code>shouldSendUpdate</code> .   <code>update()</code>  60 /,     30 /.  , <strong> </strong>   30 / (       ). </li></ol><br><blockquote> <strong>     <em> </em> ?</strong>   . 30     ‚Äì   ! </blockquote><br><blockquote> <strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Why then just not call </font></font><code>update()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">30 times a second? </font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">To improve the simulation of the game. </font><font style="vertical-align: inherit;">The more often it is called </font></font><code>update()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, the more accurate the game simulation will be. </font><font style="vertical-align: inherit;">But do not get too carried away with the number of calls </font></font><code>update()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, because this is a computationally expensive task - 60 per second is quite enough.</font></font></blockquote><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The rest of the class </font></font><code>Game</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">consists of helper methods used in </font></font><code>update()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">:</font></font><br><br><h5><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> game.js, part 3 </font></font></h5><br><pre> <code class="javascript hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Game</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-comment"><span class="hljs-comment">// ... getLeaderboard() { return Object.values(this.players) .sort((p1, p2) =&gt; p2.score - p1.score) .slice(0, 5) .map(p =&gt; ({ username: p.username, score: Math.round(p.score) })); } createUpdate(player, leaderboard) { const nearbyPlayers = Object.values(this.players).filter( p =&gt; p !== player &amp;&amp; p.distanceTo(player) &lt;= Constants.MAP_SIZE / 2, ); const nearbyBullets = this.bullets.filter( b =&gt; b.distanceTo(player) &lt;= Constants.MAP_SIZE / 2, ); return { t: Date.now(), me: player.serializeForUpdate(), others: nearbyPlayers.map(p =&gt; p.serializeForUpdate()), bullets: nearbyBullets.map(b =&gt; b.serializeForUpdate()), leaderboard, }; } }</span></span></code> </pre> <br> <code>getLeaderboard()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">it's pretty simple - it sorts the players by the number of points, takes the top five and returns the username and score for each. </font></font><br><br> <code>createUpdate()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">used </font></font><code>update()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">to create game updates that are passed to players. </font><font style="vertical-align: inherit;">Its main task is to call methods </font></font><code>serializeForUpdate()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">implemented for classes </font></font><code>Player</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">and </font></font><code>Bullet</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Note that it only transfers data to each player about the </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">closest</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> players and shells - there is no need to transfer information about game objects that are far from the player!</font></font><br><br><h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 3. Game objects on the server </font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">In our game, the shells and the players are actually very similar: they are abstract round moving game objects. </font><font style="vertical-align: inherit;">To take advantage of this similarity between players and projectiles, let's start by implementing the base class </font></font><code>Object</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">:</font></font><br><br><h5><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> object.js </font></font></h5><br><pre> <code class="javascript hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Object</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">constructor</span></span>(id, x, y, dir, speed) { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.id = id; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.x = x; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.y = y; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.direction = dir; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.speed = speed; } update(dt) { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.x += dt * <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.speed * <span class="hljs-built_in"><span class="hljs-built_in">Math</span></span>.sin(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.direction); <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.y -= dt * <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.speed * <span class="hljs-built_in"><span class="hljs-built_in">Math</span></span>.cos(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.direction); } distanceTo(object) { <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> dx = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.x - object.x; <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> dy = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.y - object.y; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-built_in"><span class="hljs-built_in">Math</span></span>.sqrt(dx * dx + dy * dy); } setDirection(dir) { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.direction = dir; } serializeForUpdate() { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> { <span class="hljs-attr"><span class="hljs-attr">id</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.id, <span class="hljs-attr"><span class="hljs-attr">x</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.x, <span class="hljs-attr"><span class="hljs-attr">y</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.y, }; } }</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">There is nothing complicated going on here. </font><font style="vertical-align: inherit;">This class will be a good reference point for expansion. </font><font style="vertical-align: inherit;">Let's see how the class </font></font><code>Bullet</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">uses </font></font><code>Object</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">:</font></font><br><br><h5><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> bullet.js </font></font></h5><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">const</span></span> shortid = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'shortid'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> ObjectClass = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'./object'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> Constants = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'../shared/constants'</span></span>); <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Bullet</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ObjectClass</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">constructor</span></span>(parentID, x, y, dir) { <span class="hljs-keyword"><span class="hljs-keyword">super</span></span>(shortid(), x, y, dir, Constants.BULLET_SPEED); <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.parentID = parentID; } <span class="hljs-comment"><span class="hljs-comment">// Returns true if the bullet should be destroyed update(dt) { super.update(dt); return this.x &lt; 0 || this.x &gt; Constants.MAP_SIZE || this.y &lt; 0 || this.y &gt; Constants.MAP_SIZE; } }</span></span></code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The implementation is </font></font><code>Bullet</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">very short! </font><font style="vertical-align: inherit;">We added to </font></font><code>Object</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">only the following extensions:</font></font><br><br><ul><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Use package </font></font><a href="https://www.npmjs.com/package/shortid"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">shortid</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> for random </font></font><code>id</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">projectile </font><font style="vertical-align: inherit;">generation </font><font style="vertical-align: inherit;">.</font></font></li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Adding a field </font></font><code>parentID</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">so that you can track the player who created this projectile.</font></font></li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Adding a return value to </font></font><code>update()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, which is equal </font></font><code>true</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">if the projectile is outside the arena (remember, we talked about this in the last section?).</font></font></li></ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Let's go to </font></font><code>Player</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">:</font></font><br><br><h5><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> player.js </font></font></h5><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">const</span></span> ObjectClass = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'./object'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> Bullet = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'./bullet'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> Constants = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'../shared/constants'</span></span>); <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Player</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ObjectClass</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">constructor</span></span>(id, username, x, y) { <span class="hljs-keyword"><span class="hljs-keyword">super</span></span>(id, x, y, <span class="hljs-built_in"><span class="hljs-built_in">Math</span></span>.random() * <span class="hljs-number"><span class="hljs-number">2</span></span> * <span class="hljs-built_in"><span class="hljs-built_in">Math</span></span>.PI, Constants.PLAYER_SPEED); <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.username = username; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.hp = Constants.PLAYER_MAX_HP; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.fireCooldown = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.score = <span class="hljs-number"><span class="hljs-number">0</span></span>; } <span class="hljs-comment"><span class="hljs-comment">// Returns a newly created bullet, or null. update(dt) { super.update(dt); // Update score this.score += dt * Constants.SCORE_PER_SECOND; // Make sure the player stays in bounds this.x = Math.max(0, Math.min(Constants.MAP_SIZE, this.x)); this.y = Math.max(0, Math.min(Constants.MAP_SIZE, this.y)); // Fire a bullet, if needed this.fireCooldown -= dt; if (this.fireCooldown &lt;= 0) { this.fireCooldown += Constants.PLAYER_FIRE_COOLDOWN; return new Bullet(this.id, this.x, this.y, this.direction); } return null; } takeBulletDamage() { this.hp -= Constants.BULLET_DAMAGE; } onDealtDamage() { this.score += Constants.SCORE_BULLET_HIT; } serializeForUpdate() { return { ...(super.serializeForUpdate()), direction: this.direction, hp: this.hp, }; } }</span></span></code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Players are harder than shells, so several more fields should be stored in this class. His method </font></font><code>update()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">does a great job, in particular, returns the newly created projectile, if not left </font></font><code>fireCooldown</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">(remember, we talked about this in the previous section?). It also extends the method </font></font><code>serializeForUpdate()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">because we need to include additional fields in the game update for the player. </font></font><br><br> <strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Having a base class </font></font><code>Object</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">is an important step to avoid code recurrence</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . For example, without a class, </font></font><code>Object</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">each game object should have the same implementation </font></font><code>distanceTo()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, and synchronizing the copy-paste of all these implementations in several files would be a nightmare. </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">This becomes especially important for large projects</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> when the number of expanding </font></font><code>Object</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">classes grows.</font></font><br><br><h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 4. Collision Detection </font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The only thing left for us is to recognize when the shells hit the players! </font><font style="vertical-align: inherit;">Recall this code snippet from a method </font></font><code>update()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">in a class </font></font><code>Game</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">:</font></font><br><br><h5><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> game.js </font></font></h5><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">const</span></span> applyCollisions = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'./collisions'</span></span>); <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Game</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-comment"><span class="hljs-comment">// ... update() { // ... // Apply collisions, give players score for hitting bullets const destroyedBullets = applyCollisions( Object.values(this.players), this.bullets, ); destroyedBullets.forEach(b =&gt; { if (this.players[b.parentID]) { this.players[b.parentID].onDealtDamage(); } }); this.bullets = this.bullets.filter( bullet =&gt; !destroyedBullets.includes(bullet), ); // ... } }</span></span></code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">We need to implement a method </font></font><code>applyCollisions()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">that returns all the shells that hit the players. </font><font style="vertical-align: inherit;">Fortunately, it is not so difficult to do, because</font></font><br><br><ul><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> All colliding objects are circles, and this is the simplest figure for the implementation of collision recognition. </font></font></li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">We already have a method </font></font><code>distanceTo()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">that we implemented in a class in the previous section </font></font><code>Object</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">.</font></font></li></ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Here is our implementation of collision recognition: </font></font><br><br><h5><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> collisions.js </font></font></h5><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">const</span></span> Constants = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'../shared/constants'</span></span>); <span class="hljs-comment"><span class="hljs-comment">// Returns an array of bullets to be destroyed. function applyCollisions(players, bullets) { const destroyedBullets = []; for (let i = 0; i &lt; bullets.length; i++) { // Look for a player (who didn't create the bullet) to collide each bullet with. // As soon as we find one, break out of the loop to prevent double counting a bullet. for (let j = 0; j &lt; players.length; j++) { const bullet = bullets[i]; const player = players[j]; if ( bullet.parentID !== player.id &amp;&amp; player.distanceTo(bullet) &lt;= Constants.PLAYER_RADIUS + Constants.BULLET_RADIUS ) { destroyedBullets.push(bullet); player.takeBulletDamage(); break; } } } return destroyedBullets; }</span></span></code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">This simple collision detection is based on the fact that </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">two circles collide if the distance between their centers is less than the sum of their radii</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Here is the case when the distance between the centers of two circles is exactly equal to the sum of their radii:</font></font><br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/63f/e73/2c8/63fe732c87ed1872522787e3cc4d5ab2.svg"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Here you need to carefully consider a couple of aspects: </font></font><br><br><ul><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The projectile must not fall into the player who created it. </font><font style="vertical-align: inherit;">This can be achieved by comparing </font></font><code>bullet.parentID</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">with </font></font><code>player.id</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">.</font></font></li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">A shell must hit only once in the extreme case of a simultaneous collision with several players. </font><font style="vertical-align: inherit;">We will solve this problem with the help of the operator </font></font><code>break</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">: as soon as a player is found that faces a projectile, we stop searching and proceed to the next projectile.</font></font></li></ul><br><h2>  the end </h2><br>  That's all!<font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> We looked at everything you need to know to create a .io web game. </font></font> What's next? <strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Build your own .io game! </font></font></strong> <br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">All of the example code is open source and uploaded on </font></font><a href="https://github.com/vzhou842/example-.io-game"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Github</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font></div><p>Source: <a href="https://habr.com/ru/post/450574/">https://habr.com/ru/post/450574/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../450548/index.html">‚ÄúIsolation of the Runet‚Äù or ‚ÄúSovereign Internet‚Äù</a></li>
<li><a href="../450552/index.html">Show laboratory "Advanced nanomaterials and optoelectronic devices" ITMO University</a></li>
<li><a href="../450554/index.html">Breaking a design pattern - Singleton in PHP</a></li>
<li><a href="../450564/index.html">Glitter and poverty: how the digital revolution made musicians poorer</a></li>
<li><a href="../450568/index.html">Each poison has its own antidote. How to escape or at least try (upd: about antidotes for household poisoning)</a></li>
<li><a href="../450576/index.html">New rules for anonymity messengers</a></li>
<li><a href="../450578/index.html">What is heard on the radio? Receive and decode the most interesting signals. Part 2, VHF</a></li>
<li><a href="../450582/index.html">Principles of operation of the PIM protocol</a></li>
<li><a href="../450586/index.html">Fish Redux - the new Redux library for Flutter</a></li>
<li><a href="../450592/index.html">In Germany, the cost of a trip on an electric car may be higher than on a diesel car.</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>