<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>How we migrated from InboxSDK to Gmail.js</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="To develop our customer support solution, we chose the Gmail service, since this is one of the most popular email clients. And to expand its capabilit...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>How we migrated from InboxSDK to Gmail.js</h1><div class="post__text post__text-html js-mediator-article">  To develop our customer support solution, we chose the Gmail service, since this is one of the most popular email clients.  And to expand its capabilities - ready library InboxSDK.  At the time of development, it had the functionality we needed, and this decision helped us quickly enter the market with the first version of the product and gain user base.  On the other hand, InboxSDK is a closed library from a third-party developer and it had flaws that had to be solved later. <br><br><img src="https://habrastorage.org/web/51f/19e/b55/51f19eb555cf4b36b1fc14c5dc225530.jpg"><br><a name="habracut"></a><br><h3>  Why did we choose InboxSDK? </h3><br>  <a href="https://deskun.com/%3Futm_source%3Dhabrahabr%26utm_medium%3Dblog%26utm_campaign%3Darticle_7%26utm_content%3D1">Deskun is</a> implemented as an extension for Google Chrome and <a href="https://deskun.com/%3Futm_source%3Dhabrahabr%26utm_medium%3Dblog%26utm_campaign%3Darticle_7%26utm_content%3D1">Yandex Browser</a> .  It fully operates on the basis of the Gmail mail service.  For our part, it was necessary to choose a library that could expand the functionality of the mail and work with its client part.  We settled on InboxSDK (ISDK). <br><br>  A key feature of Gmail, for which users love it so much, is the automatic grouping of letters by dialogue.  At the internal level (on Gmail servers), each letter has its own identifier and the identifier of the dialogue to which it belongs.  But the problem is that in the web client the global message IDs are not contained in the page code anywhere, and the global dialogue IDs are only contained in the hash of the open dialog URL.  Instead, the HTML elements of each message and dialogue are marked with local IDs like ": a5,: b6, etc.", received by the main (fairly large and obfuscated) Gmail script.  Since local IDs change from page to page and from session to session, for the normal operation of extensions dealing with Gmail mail, it is necessary to quickly establish the connection between local and global IDs.  This is what the InboxSDK library does, in which, besides the functions for obtaining identifiers of letters, drafts, and dialogs, the possibilities for improving the user interface are also available. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Despite the fact that the ISDK contains a large number of different methods for working with Gmail, this library has one unpleasant feature - Streak, which in turn, provides its own CRM system inside Gmail, is developing it.  That is, is an indirect competitor of Deskun. <br><br><h3>  InboxSDK Problems </h3><br>  Developing your own closed project based on another closed project is at least wrong.  Especially if these projects are similar and you can always be denied access to the API simply because you are competitors.  Even if this does not happen, at least you have no control over the changes and accessibility.  Library developers are not in a hurry to help in writing third-party services based on their library, and the changelogs of new revisions do not carry any useful information.  Even the site InboxSDK is practically not updated since launch.  And you can forget about fixing bugs at the request of users or adding features that do not relate to the needs of the Streak itself.  First of all, Steak makes a library for itself. <br><br>  <b>The first problem</b> .  For the work of the library, a binding to some specific and stable (stable - which do not change when switching the view, changing the state, etc.) classes is used.  For example, in some cases, keystrokes on focused elements are emulated.  And any changes to the Gmail interface can disrupt the work of the library itself and third-party development based on InboxSDK. <br><br>  <b>The second problem</b> .  Since the library is connected remotely using the loader, there may be interruptions in the delivery of content over the CDN network.  For some time we tried to understand what was going wrong, and then we found out that the library, on the basis of which our plugin works, simply does not load for some users.  At some point, it turned out that already 10% of our clients could not work with the service.  If there were problems with loading InboxSDK, then the work of all platforms built on this library was terminated.  It is important to understand that the problem may have a point character, and may not always depend on the hosting.  And from our side to correct the source of the problem can be completely impossible and it only remained to wait. <br><br>  <b>The third problem</b> .  InboxSDK is not an open library.  The publicly declared functions include a maximum of one third of all available.  This is about 400 KB of packaged code that has to be parsed literally right after parsing the main Gmail scripts.  Download time for mail.google.com on slow machines is critical. <br><br>  <b>The fourth problem</b> .  Changes to the library are made not just regularly, but several times a week.  Unfortunately, most of these changes do not contain bug fixes and do not add new features, but are aimed at the needs of the main developer Streak.  There was a situation when due to one update there was a conflict with the code in the client part of our plugin.  In December, a new minor (shadow, without changejlog) version for InboxSDK was released, in which the recipient insertion function was changed.  It was implemented in such a way that after adding addressees there was a trigger for saving a draft copy.  The saving itself was done in a rather interesting way - it was just a simulation of pressing a certain key across the input field.  Before all changes, pressing was implemented using ‚ÄúEnter‚Äù, but it was in that change that they began to press the symbol with the code ‚Äú190‚Äù (¬æ).  In our case, when opening an answer form, recipients of this ticket are automatically substituted.  Thus, a conflict has turned out: during the response in the ticket, the symbol  was inserted in the recipient field. <br><br><img src="https://habrastorage.org/web/912/823/161/912823161d4e46a282a30cb087ed0642.png"><br><br><h3>  Switch from InboxSDK to gmail.js <br></h3><br>  As a result, we gradually decided to switch to something more open, and the Gmail.js library (GJS) became the foundation for a future solution.  Unlike InboxSDK, the Gmail.js library is fully open.  Its development depends on the community and the functionality can develop at a very good pace. <br><br>  During the transition, we encountered two main problems: <br><br>  <b>First</b> , for the Gmail.js library to function, you need access to the window's window object, in which Gmail stores some technical information.  The extension in its ‚Äúsandbox‚Äù has access only to the DOM page, but not to its environment. <br><br>  <b>Secondly</b> , in order to completely eliminate changes to the client part of the plug-in, you need not just a wrapper, but you also need to add functions that are not in the library itself. <br><br>  For the first problem, there is no perfect solution.  All of them are connected with some inconveniences - implementation by adding your own script directly to the page of the <code>script</code> website with postMessage, Custom Event or writing directly to the DOM. <br><br>  We decided to implement a bridge that, using GJS, reports certain events directly to the plugin.  In the current implementation, through the injection technology, the GJS library and our bridge are implemented in the page.  Thus GJS works in the right environment.  For all extensions, the Google Chrome browser provides a set of methods for working with it.  Accordingly, if you do an extension through a direct injection (like the GJS library), then it will lose all the possibilities of working with API extensions, so very important and necessary functionality can be lost. <br><br>  To solve the second problem, it was necessary to analyze the behavior of not only the InboxSDK, but also the work of the Gmail client side.  Now in our extension there are places in the code that are tied to the attributes and classes of the inbox: in some cases they additionally expanded the capabilities of the library, and in some they corrected some inbox errors.  Consequently, in order not to disrupt the client side of the plug-in, it was necessary to add the necessary classes and attributes in the same way, add them to certain elements, for certain events and under certain conditions.  Earlier it was mentioned that there is no API for working with the client part of Gmail.  But there is stored a lot of necessary information.  For example, user settings, a list of available mail aliases, a set of included experimental features, and other important technical information. <br><br><h3>  Total </h3><br>  We managed to make the transition from one library to another, without changing the logic and code in the client part of the plugin.  The final solution is not just the use of the GJS library; rather, we have created our own hybrid library, ISDK and GJS.  Gmail.js served as the foundation, but our development is functionally similar to InboxSDK.  If the Habrahabr community is interesting, and there are many requests to share our code, then we will put it in order and post it. <br><br><h3>  <a href="https://deskun.com/%3Futm_source%3Dhabrahabr%26utm_medium%3Dblog%26utm_campaign%3Darticle_7%26utm_content%3D2">Deskun</a> </h3></div><p>Source: <a href="https://habr.com/ru/post/335874/">https://habr.com/ru/post/335874/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../335858/index.html">Why not rely on user error reports</a></li>
<li><a href="../335866/index.html">Memoization and Currying (Python)</a></li>
<li><a href="../335868/index.html">Redux store: horizontal expansion</a></li>
<li><a href="../335870/index.html">What is DNSBL and how can you not get there</a></li>
<li><a href="../335872/index.html">HAProxy as LoadBalan—Åer for RDP truss. Reliable solution for $ 0</a></li>
<li><a href="../335876/index.html">Traveling over the hill and back: how not to get a job abroad</a></li>
<li><a href="../335878/index.html">Pragmatic functional programming</a></li>
<li><a href="../335880/index.html">Nodebackup - saving data from containers (docker) and the rest</a></li>
<li><a href="../335882/index.html">Counting the number of links to an entry in the table via Foreign Keys</a></li>
<li><a href="../335884/index.html">New application for solving the problem P vs. NP</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>