<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Optical Switch with Sound Effect on Arduino</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Good day! 
 In this post I want to share with habr a community about the principle of work made by me 
 proximity switch. The switch is planned to be ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Optical Switch with Sound Effect on Arduino</h1><div class="post__text post__text-html js-mediator-article">  Good day! <br>  In this post I want to share with habr a community about the principle of work made by me <br>  proximity switch.  The switch is planned to be used in the smart home system. <br><br>  The basis of the switch is a recently improved Arduino controller clone sold by me, sold under the name <a href="http://carmonitor.ru/ru/product_info.php%3Fproducts_id%3D120">Carduino Nano V.7</a> <br><img src="https://habrastorage.org/getpro/geektimes/post_images/2f8/75c/f56/2f875cf56c6356c6a46d64192ce22835.png" alt="image"><br><br><a name="habracut"></a><br>  <b>The switch works as follows:</b> <br>  Arduino from the output of the D5 constantly produces a PWM signal with a frequency of 976 Hz and a duty cycle of 50%.  To exit <br>  D5 through the current-limiting resistor connected LED emitting a light signal in the infrared.  A phototransistor connected to the input of the Arduino D2 detects <br>  IR reflected by hand.  Arduino receives an IR signal, checks it for accuracy and if the signal from 20 consecutive pulses corresponds to a frequency of 976 Hz, then the controller turns on the blue LED (L) at the output of the D13 Arduino and starts to play a sound effect through the SPK output of the controller.  All the same thing happens when turning off the LED (L). 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      <b>Reproduction:</b> <br>  When playing sound effects, a WAV sound file format without compression is used, with a frequency of 16000 Hz and a depth of 8 bits. <br>  To improve the quality of sound reproduction, linear interpolation is used.  For this, the sampling takes place at a frequency of 96000 Hz and 4 intermediate samples calculated by the method of linear interpolation are inserted between the original samples.  In this way, the quantization noise is reduced, the quality is improved, and additional filters are not required to play sounds. <br><br>  <b>The scheme is simple to build it, I used</b> <br>  1-Carduino Nano V.7 <br>  2-IR LED from the old remote control from the TV, the LED must be heat shrinked to avoid side radiation <br>  3-Phototransistor LTR-3208E <br>  4-Dynamic head from a children's toy <br>  5-resistors 10k and 68th <br><br><img src="https://habrastorage.org/getpro/geektimes/post_images/b09/e6f/3a9/b09e6f3a9d7577e62b4ef52bc486933f.png" alt="image"><br><br>  How the scheme I collected on the breadboard works, you can look at the video. <br><iframe width="560" height="315" src="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://www.youtube.com/embed/Yq0GpQMtrdE%3Ffeature%3Doembed&amp;xid=25657,15700021,15700186,15700191,15700253,15700256,15700259&amp;usg=ALkJrhhFk2Aois6E2JSUy-hFh2z7PGAkOA" frameborder="0" allowfullscreen=""></iframe><br><br>  <b>Code for Arduino Nano:</b> <br><br><pre><code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt;TimerOne.h&gt; #include &lt;avr/delay.h&gt; #include &lt;avr/pgmspace.h&gt; #include "fife.h" #include "hi.h" //////// //////////////////////////////////// #define speakerPin 11 volatile uint16_t sample=0; volatile uint8_t lastSample, FirstSample; volatile byte new_data,future_data,old_data; volatile byte stat=0; unsigned char *wave; unsigned int length; //////// //////////////////////////////////// uint8_t state = 0; volatile uint16_t timerCount, lengthImpuls; volatile uint16_t Counter=0; //////////// /////////////////////////////// void setup() { pinMode(speakerPin, OUTPUT); //   digitalWrite(speakerPin, LOW); //     pinMode(2, INPUT); // ,   // digitalWrite(2, HIGH); //   pinMode(13, OUTPUT); // pinMode(5, OUTPUT); //     TCCR0B = TCCR0B &amp; 0b11111000 | 3; //  976 analogWrite(5,128 ); //  attachInterrupt(0, Ir_sens, RISING); //    Timer1.initialize(10); //  Timer1.attachInterrupt(callback); //  } ////////////   /////////////////////////////// void callback() { timerCount++; } ////////////  /////////////////////////////// void Ir_sens() { lengthImpuls = timerCount; timerCount=0; Counter++; } ///////////////////////     OCR2/////////////////// ISR(TIMER2_COMPA_vect) { switch (stat) { case 0:{ old_data = pgm_read_byte(&amp;wave[sample]); OCR2A = old_data; stat=1; ++sample; if (sample == length) stat=4; future_data = pgm_read_byte(&amp;wave[sample]); new_data = (old_data+future_data)/2; } break; case 1: {OCR2A=(old_data+new_data)/2; stat=2; } break; case 2: {OCR2A = new_data; stat=3; } break; case 3: {OCR2A=(new_data+future_data)/2; stat=0; } break; case 4: if(lastSample==0) stat=5; else {--lastSample; OCR2A=lastSample;} break; case 5: stopPlayback(); break; } } ////////////  /////////////////////////////// void loop() { if(lengthImpuls&gt;105 || lengthImpuls&lt;99) Counter=0; if(lengthImpuls&gt;99 &amp;&amp; lengthImpuls&lt;105 &amp;&amp; Counter&gt;20) { state=~state; digitalWrite(13, state); if(state&gt;0) play_wave((unsigned char *)hi, hi_length); if(state==0) play_wave((unsigned char *)fife, fife_length); _delay_ms(200); while(Counter&gt;10) { if(lengthImpuls&gt;105 || lengthImpuls&lt;99) Counter=0; } lengthImpuls=0; } } //////////// /////////////////////////////// void play_wave(unsigned char *wave_data, unsigned int wave_length) { wave=wave_data; length=wave_length; startPlayback(); } void startPlayback() { sample=0; stat=0; ASSR |=(1&lt;&lt;AS2); TCCR2A |= ((1&lt;&lt;COM2B1)|(0&lt;&lt;COM2B0)|(1&lt;&lt;COM2A1)|(0&lt;&lt;COM2A0)|(1&lt;&lt;WGM21)|(0&lt;&lt;WGM20)); TCCR2B = ((0 &lt;&lt; CS22) | (0 &lt;&lt; CS21) | (1 &lt;&lt; CS20) | (0&lt;&lt;WGM22) | (1&lt;&lt;FOC2A) | (1&lt;&lt;FOC2B)); lastSample = pgm_read_byte(&amp;wave[length-1]); TCNT2 = 0; TIMSK2|=(1&lt;&lt;OCIE2A); sei(); for (int i=0; i &lt;50; i++) { new_data=i; stat=2; sample = 0; _delay_us(1); } stat=0; } //////////// /////////////////////////////// void stopPlayback() { TIMSK2&amp;=(0&lt;&lt;OCIE2A); TCCR2B &amp;=(0&lt;&lt;CS10); }</span></span></span></span></code> </pre> <br><br>  Download the <a href="http://cyber-place.ru/attachment.php%3Fattachmentid%3D363%26d%3D1337581934">source in</a> one file <br><br>  In the following article: <br>  The Arduino Nano will be replaced by an Atmega328 controller, the entire circuit with the power supply will be assembled on a separate board and installed in the corridor switch. </div><p>Source: <a href="https://habr.com/ru/post/144180/">https://habr.com/ru/post/144180/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../144173/index.html">Another copter: part one, description and selection of parts</a></li>
<li><a href="../144175/index.html">Geospatial types in SQL Server Reporting Services reports</a></li>
<li><a href="../144176/index.html">Object tuples in Java and their collections</a></li>
<li><a href="../144178/index.html">[Translation] We simplify the work with the server using selective synchronization in Dropbox</a></li>
<li><a href="../144179/index.html">Study of power consumption and features of the computer in various power saving modes</a></li>
<li><a href="../144182/index.html">Object collections in PHP</a></li>
<li><a href="../144183/index.html">Podcast WebProfessionals - Team in web development: one in the field is not a warrior</a></li>
<li><a href="../144185/index.html">Forrester Review: The Rise and Fall of Information Security Technologies</a></li>
<li><a href="../144186/index.html">How many daily downloads does an app need to get to the Top on the App Store?</a></li>
<li><a href="../144187/index.html">PHDays 2012 Master Classes: From Wi-Fi Network Protection to SAP and Web 2.0 Security</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>