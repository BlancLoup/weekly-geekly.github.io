<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Fix client Last.FM or how to get a free radio</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="First, a brief educational program: 
 Last.fm is an online music project, the main service of which is the collection of information about the music t...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Fix client Last.FM or how to get a free radio</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/getpro/habr/post_images/7e7/16a/ad8/7e716aad8a85d730b09509113e7dadf4.jpg" alt="image"><br>  First, a brief educational program: <br><blockquote>  Last.fm is an online music project, the main service of which is the collection of information about the music that a user listens to and its cataloging in individual and general charts.  (c) Wikipedia <br></blockquote><br><br>  Once upon a time, when the grass was greener, and interested individuals in the IT community did not yet know what Instagram is - <a href="http://www.last.fm/">Last.FM</a> project was generally free and made it possible to listen to the ‚Äúradio‚Äù made up of songs from favorite and similar performers without any or restrictions.  Then the commercial component began to take their own, free radio left only for some countries, which forced the inhabitants of the CIS countries to search for a proxy or pay $ 3 a month for the possibility of using the service. <br><br>  Of course, nobody wanted to bother with a proxy, and users began to look for ways to listen to the radio for free.  As it turned out, Last.FM did not actually close access to the possibility of free listening, but this was not feasible for the latest version of the official client.  Bottom line: some of the audience switched to alternative clients, some stopped updating their old client, while others either paid or went to other services. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      So what was the change that made it impossible to listen to the radio for free in new versions of the client?  Let's try to figure it out. <br><a name="habracut"></a><br>  First we need new and old customers.  A new one can be downloaded from the <a href="http://last.fm/">official site</a> , and an old one, for example, from a <a href="http://rutracker.org/forum/viewtopic.php%3Ft%3D3737124">rutraker</a> .  Let's put a new and old client on different virtual machines and go to the forehead: let's see what the sniffer shows when trying to start playing a radio station. <br><br> <a href=""><img src="https://habrastorage.org/getpro/habr/post_images/f57/913/fda/f57913fda640f95163c5d1bdf7e5d3d3.jpg" alt="image"></a> <br><br>  As we can see, the <a href="http://ru.wikipedia.org/wiki/Http">HTTP protocol is used</a> , which will greatly facilitate our further analysis (binary undocumented protocols are more difficult to parse, of course). <br>  Now compare requests from old and new customers: <br><br> <a href=""><img src="https://habrastorage.org/getpro/habr/post_images/f57/913/fda/f57913fda640f95163c5d1bdf7e5d3d3.jpg" alt="image"></a> <a href=""><img src="https://habrastorage.org/getpro/habr/post_images/1af/c6e/ef3/1afc6eef3ed35fe55c4daca273a0522f.jpg" alt="image"></a> <br><br>  The only difference that catches your eye is the additional parameter api_key in a <a href="http://ru.wikipedia.org/wiki/Http">GET request</a> .  Let's try to understand whether it affects the behavior of the client.  Run the client under some debugger (I will use <a href="http://www.ollydbg.de/">OllyDbg</a> ), let it boot (F9), open the process memory (Alt + M) and look for the parameter of interest (Ctrl + B) in it. <br><br> <a href=""><img src="https://habrastorage.org/getpro/habr/post_images/1b3/918/88f/1b391888fda162d4e83e1d77a11e6375.jpg" alt="image"></a> <br><br>  In memory, there were 4 places that contained the desired parameter, all of which are located in the LastFmTools1 library.  Let's see how this parameter is used in the code.  To do this, select the byte containing the &amp; character, which is located immediately before the api_key text. <br><br> <a href=""><img src="https://habrastorage.org/getpro/habr/post_images/1ed/645/89c/1ed64589ce99bf9176ee7fadaaf8be5f.jpg" alt="image"></a> <br><br>  Why him?  A GET request is constructed from fragments of the form key = value, which are separated by an ampersand.  In this case, the developers did not begin to form an associative array with the request parameters, and then combine pairs of it with something like the PHP <a href="http://php.net/manual/en/function.implode.php">implode</a> function, but simply hard-coded the query as ready-made chunks. <br><br> <a href=""><img src="https://habrastorage.org/getpro/habr/post_images/6dc/52f/172/6dc52f1721ce858310462129d77cc488.jpg" alt="image"></a> <br><br>  We see that in front of us, in fact, the classic <a href="http://ru.wikipedia.org/wiki/C-%25D1%2581%25D1%2582%25D1%2580%25D0%25BE%25D0%25BA%25D0%25B0">C-string</a> , which consists of <a href="http://ru.wikipedia.org/wiki/ASCII">ASCII</a> characters and ends with a zero-byte.  Thus, we can perform manipulations with the data in memory and trim the string to a harmless ampersand, which will not spoil the request and allow us to see how the last client will behave in this case.  Replace the character following the &amp; with a zero-byte wherever the line api_key occurs, and again we try to start playing the radio. <br><br> <a href=""><img src="https://habrastorage.org/getpro/habr/post_images/e14/624/5a4/e146245a407292c510f8e38c20e0caee.jpg" alt="image"></a> <br><br>  Oh miracle!  The radio is playing as if nothing had happened!  But we don‚Äôt want to run the program under the debugger every time to listen to the free radio.  Then we take any <a href="http://ru.wikipedia.org/wiki/Hex-%25D1%2580%25D0%25B5%25D0%25B4%25D0%25B0%25D0%25BA%25D1%2582%25D0%25BE%25D1%2580">hex editor</a> , open the LastFmTools1.dll file in it (it is in the Last.FM directory), find the places where the line &amp; api_key occurs, and, as I described above, replace the byte after the ampersand with a zero-byte. <br><br>  Voila, we got the ready-to-use client of the latest version with a free radio. <br><br>  Those interested can also read about how to create an <a href="http://kaimi.ru/2010/09/lastfm-broadcast-addon/">add-on for Last.FM, which allows you to stream the radio over the network</a> and how to <a href="http://kaimi.ru/2011/08/lastfm-taskbar-controls/">add Last.FM client management via the taskbar</a> . </div><p>Source: <a href="https://habr.com/ru/post/145318/">https://habr.com/ru/post/145318/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../145311/index.html">New line from Lenovo</a></li>
<li><a href="../145312/index.html">Worldwide Start IPv6 Day</a></li>
<li><a href="../145313/index.html">Runetology (150): Founder Championship.com Dmitry Sergeyev</a></li>
<li><a href="../145315/index.html">Algorithm for modeling a multidimensional array of data distributed according to the normal law</a></li>
<li><a href="../145317/index.html">A good example of using closures in PHP</a></li>
<li><a href="../145321/index.html">Ultrabooks on Computex 2012</a></li>
<li><a href="../145322/index.html">Development of Metro-application Evernote for Windows 8</a></li>
<li><a href="../145324/index.html">Search Engine Shodan Risks Industrial Control Systems</a></li>
<li><a href="../145325/index.html">Haiku Installation Guide</a></li>
<li><a href="../145327/index.html">Homemade silicon carbide LED</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>