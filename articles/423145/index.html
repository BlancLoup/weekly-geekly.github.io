<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>PHP extension and Kotlin Native. Part three, probably final</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="The first part describes quite basic things about toolkit customization and general concepts. 

 The second part is about, so to speak, the first appr...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>PHP extension and Kotlin Native. Part three, probably final</h1><div class="post__text post__text-html js-mediator-article"><img align="right" src="https://habrastorage.org/webt/o7/db/cw/o7dbcwsbe8kad4jkw84guc_2n4m.png">  The <a href="https://habr.com/company/alfa/blog/415471/">first part</a> describes quite basic things about toolkit customization and general concepts. <br><br>  <a href="https://habr.com/company/alfa/blog/416719/">The second part is</a> about, so to speak, the first approach to the projectile, ideas, plans, plans. <br><br>  In this article there will be a little more hardcore about interop C and K / N, a lot of macros, pain, hopelessness and the "rays of good."  Of course there will be a chapter with a story about achievements (you cannot praise yourself ... and as a bonus, a story about an epic fakape. <br><a name="habracut"></a><br>  <b>Disclaimer:</b> all of the following is considered in the context of writing a library for PHP. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h2>  Chapter one.  Interop naive </h2><br>  How to use the K / N functions in C is described in the first part of the cycle.  Accordingly, here I will explain how to use C functions in K / N. <br><br>  <a href="">Official documentation is</a> rather stingy and laconic, however, for simple projects, it is quite enough. <br><br>  In short, you need to create a special file with the <b>.def</b> extension and specify the necessary header files in it. <br><br><pre><code class="hljs nginx"><span class="hljs-attribute"><span class="hljs-attribute">headers</span></span> = php.h</code> </pre> <br>  Then feed it to a program called <b>cinterop</b> . <br><br><pre> <code class="hljs vala"><span class="hljs-meta"><span class="hljs-meta"># cinterop -def php.def -o php</span></span></code> </pre><br>  At the exit, you will receive a library of <b>libphp.klib</b> , containing llvm bitcode and various meta-information. <br><br>  Then you can safely use the functions and macros described in the header file ( <code>#define</code> ), without forgetting to connect the library at the compilation stage. <br><br><pre> <code class="hljs vala"><span class="hljs-meta"><span class="hljs-meta"># kotlinc -opt -produce static ${SOURCES} -l libphp.klib -o myLib</span></span></code> </pre><br>  But there is a nuance.  And not one. <br><br><h3>  In the form as described above, the library will not gather </h3><br>  Why?  Because php.h contains the following lines: <br><br><pre> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"php_version.h"</span></span></span><span class="hljs-meta"> #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"zend.h"</span></span></span><span class="hljs-meta"> #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"zend_sort.h"</span></span></span><span class="hljs-meta"> #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"php_compat.h"</span></span></span><span class="hljs-meta"> #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"zend_API.h"</span></span></span></span></code> </pre><br>  Here it should be noted that llvm does the compilation of the library, but it has the <b>-I</b> key, and cinterop has the <b>-copt</b> key.  Well, you understand.  As a result, to compile <b>php.h is</b> enough of such a command. <br><br><pre> <code class="hljs mel"># cinterop -def my.def -o myLib -I${PHP_LIB_ROOT} -copt -I${PHP_LIB_ROOT} \ -copt -I${PHP_LIB_ROOT}/main \ -copt -I${PHP_LIB_ROOT}/Zend \ -copt -I${PHP_LIB_ROOT}/TSRM</code> </pre><br><h3>  Macros.  I love you and hate you!  No, I just hate it. </h3><br>  All you need to know about <code>#define</code> in the interop C part&gt; K / N is <br><blockquote>  Everyth of the Kotlin property.  Other macros are not supported. </blockquote><br>  And then we remember that the PHP extension is a macro on a macro and chases the macro and try not to cry. <br><br>  But it is not all that bad.  To work around this situation, K / N developers provided a coil of blue electrical tape to attach <b>custom declarations</b> to the def file.  It looks like this (for example, take the macro <code>Z_TYPE_P</code> ) <br><br><pre> <code class="cpp hljs">headers = php.h --- <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">inline</span></span> zend_uchar __zp_get_arg_type(zval *z_value) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> Z_TYPE_P(z_value); }</code> </pre> <br>  Now in the K / N code you can use the function <code>__zp_get_arg_type</code> <br><br><h2>  Chapter two  PHP INI-settings or macro with a sub-subdirect. </h2><br>  This is the ‚Äúray of good‚Äù in the direction of the PHP source. <br><br>  There are 4 macros for extracting settings: <br><br><pre> <code class="cpp hljs">INI_INT(val) INI_FLT(val) INI_STR(val) INI_BOOL(val)</code> </pre><br>  Where <code>val</code> is a string with the name of the setting. <br><br>  And now let's take a look at the example of <code>INI_STR</code> , and see how this macro is defined. <br><br><pre> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> INI_STR(name) zend_ini_string_ex((name), sizeof(name)-1, 0, NULL)</span></span></code> </pre> <br>  Already noticed his "fatal flaw"? <br><br>  If not, then I'll tell you - this is the <code>sizeof</code> function.  When you use a macro directly, then everything is fine: <br><br><pre> <code class="cpp hljs">php_printf(<span class="hljs-string"><span class="hljs-string">"The value is : %s"</span></span>, INI_STR(<span class="hljs-string"><span class="hljs-string">"my.ini"</span></span>));</code> </pre> <br>  When you use it through a proxy function from a <b>.def</b> file, the carriage turns into a pumpkin, and <b>sizeof (name)</b> returns the size of the pointer.  Checkmate Kotlin Native. <br><br>  Bypass options, in fact, only two. <br><br><ol><li>  To use not macros, but functions to which they are attached. </li><li>  Hardcode function wrappers for each required setting. </li></ol><br>  The first option is better for everyone than the second, except for one thing - no one will guarantee that the macro declaration will not change.  Therefore, for my project, I, with a deep sense of dissatisfaction, chose the second option. <br><br><h2>  Chapter Three  Debag?  What debag? </h2><br><h3>  Act 1 - interop. </h3><br>  At one point, after winding up the blue tape to the def-file of the 20 next proxy functions, I received a remarkable error. <br><br><pre> <code class="hljs javascript">Exception <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> thread <span class="hljs-string"><span class="hljs-string">"main"</span></span> java.lang.Error: <span class="hljs-regexp"><span class="hljs-regexp">/tmp/</span></span>tmp399964332777824085.c:<span class="hljs-number"><span class="hljs-number">103</span></span>:<span class="hljs-number"><span class="hljs-number">38</span></span>: error: too many <span class="hljs-built_in"><span class="hljs-built_in">arguments</span></span> to <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">call</span></span></span><span class="hljs-function">, </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">expected</span></span></span><span class="hljs-function"> 2, </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">have</span></span></span><span class="hljs-function"> 3 </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">at</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">org</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">jetbrains</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">kotlin</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">native</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">interop</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">indexer</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">UtilsKt</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ensureNoCompileErrors</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">Utils.kt:</span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">137</span></span></span></span></span><span class="hljs-function">) </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">at</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">org</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">jetbrains</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">kotlin</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">native</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">interop</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">indexer</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">IndexerKt</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">indexDeclarations</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">Indexer.kt:</span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">902</span></span></span></span></span><span class="hljs-function">) </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">at</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">org</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">jetbrains</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">kotlin</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">native</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">interop</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">indexer</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">IndexerKt</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">buildNativeIndexImpl</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">Indexer.kt:</span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">892</span></span></span></span></span><span class="hljs-function">) </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">at</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">org</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">jetbrains</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">kotlin</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">native</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">interop</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">indexer</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">NativeIndexKt</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">buildNativeIndex</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">NativeIndex.kt:</span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">56</span></span></span></span></span><span class="hljs-function">) </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">at</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">org</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">jetbrains</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">kotlin</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">native</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">interop</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">gen</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">jvm</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">MainKt</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">processCLib</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">main.kt:</span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">283</span></span></span></span></span><span class="hljs-function">) </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">at</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">org</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">jetbrains</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">kotlin</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">native</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">interop</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">gen</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">jvm</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">MainKt</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">interop</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">main.kt:</span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">38</span></span></span></span></span><span class="hljs-function">) </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">at</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">org</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">jetbrains</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">kotlin</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">cli</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">utilities</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">InteropCompilerKt</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">invokeInterop</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">InteropCompiler.kt:</span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">100</span></span></span></span></span><span class="hljs-function">) </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">at</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">org</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">jetbrains</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">kotlin</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">cli</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">utilities</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">MainKt</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">main</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">main.kt:</span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">29</span></span></span></span></span><span class="hljs-function">)</span></span></code> </pre><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/m_/sg/xb/m_sgxb-qifca4cx1tccuvbxa6ra.png"></div><br>  Comment the half, rebuild, if the commentary repeated the half of the rest, we collect ... And considering that the compile process of the headers is quite long ... (yes, it seemed so faster than to climb the top ten source files and meticulously, with a magnifying glass, to verify). <br><br>  The second "ray of good" goes in the direction of JetBrains. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/q0/9u/dd/q09uddpi04rrxoc76xnk5meecow.png"></div><br><h3>  Act 2 - runtime. </h3><br>  I receive in <b>segmentation fault</b> .  Well, ok, it happens.  I climb into the debugger.  Ummm ... STA? <br><br><pre> <code class="hljs css"><span class="hljs-selector-tag"><span class="hljs-selector-tag">Program</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">received</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">signal</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">SIGSEGV</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">Segmentation</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">fault</span></span>. <span class="hljs-selector-tag"><span class="hljs-selector-tag">kfun</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:kotlinx.cinterop.toKString</span></span>@<span class="hljs-keyword"><span class="hljs-keyword">kotlinx</span></span>.<span class="hljs-keyword"><span class="hljs-keyword">cinterop</span></span>.<span class="hljs-keyword"><span class="hljs-keyword">CPointer</span></span>&lt;<span class="hljs-keyword"><span class="hljs-keyword">kotlinx</span></span>.<span class="hljs-keyword"><span class="hljs-keyword">cinterop</span></span>.<span class="hljs-keyword"><span class="hljs-keyword">ByteVarOf</span></span>&lt;<span class="hljs-keyword"><span class="hljs-keyword">kotlin</span></span>.<span class="hljs-keyword"><span class="hljs-keyword">Byte</span></span>&gt;&gt;.()<span class="hljs-keyword"><span class="hljs-keyword">kotlin</span></span>.<span class="hljs-keyword"><span class="hljs-keyword">String</span></span> () at /opt/buildAgent/work/<span class="hljs-number"><span class="hljs-number">4</span></span>d622a065c544371/Interop/Runtime/src/main/kotlin/kotlinx/cinterop/Utils.kt:<span class="hljs-number"><span class="hljs-number">402</span></span> <span class="hljs-number"><span class="hljs-number">402</span></span> /opt/buildAgent/work/<span class="hljs-number"><span class="hljs-number">4</span></span>d622a065c544371/Interop/Runtime/src/main/kotlin/kotlinx/cinterop/Utils.kt: No such file or directory.</code> </pre><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/cr/nq/ek/crnqekwr9fheufvuxcc9ixhnsjc.png"></div><br><h2>  Chapter Four  I poured tea into your tea so that you can drink tea while you drink tea. </h2><br>  Here it is necessary to tell how that figovin that I make works. <br><br>  You write DSL describing the future PHP extension, write K / N code with the implementation of functions, classes and methods, then run <code>make</code> and, miraculously, get a ready-made library that can be connected to PHP. <br><br>  The assembly can be divided into 4 stages: <br><br><ol><li>  Creating a layer between C and K / N (the same <code>cinterop</code> ) </li><li>  C-code extension generation </li><li>  Compiling library with logic </li><li>  Compiling target library </li></ol><br>  The task is to add the ability to create instances of a PHP class in the K / N code.  For example, so that a class can have a <code>getInstance()</code> method defined.  And you want to make it so that it is convenient to use. <br><br>  In C, this problem is solved once or twice. <br><br><pre> <code class="cpp hljs">zval *obj = <span class="hljs-built_in"><span class="hljs-built_in">malloc</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">sizeof</span></span>(zval)); object_init_ex(obj, myClass);</code> </pre> <br>  It would seem simple - take it and carry it to K / N, but here‚Äôs <code>myClass</code> ... <br><br>  But <code>myClass</code> is a global variable of the type <code>zend_class_entry*</code> , declared in the C code of the project and with an unknown name in advance. <br><br>  Watch your hands.  It is necessary to compile the library from K / N code, which will have a function, which needs to have access to <code>myClass</code> , which is defined in the generated, but not compiled C code, from which this function will be called later. <br><br>  In the end, the implementation of this functionality led to the addition of two new artifacts: <b>.h</b> and <b>.kt</b> at the stage of code generation, complication of the cinterop stage and an epic backup, which I will tell you at the very end. <br><br><h2>  Chapter Five  What's in a name? </h2><br>  Tale of why: <br><br><pre> <code class="hljs cs"><span class="hljs-keyword"><span class="hljs-keyword">enum</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">ArgumentType</span></span> { PHP_STRING, PHP_LONG, PHP_DOUBLE, PHP_NULL, ... }</code> </pre> <br>  better than: <br><br><pre> <code class="hljs cpp"><span class="hljs-keyword"><span class="hljs-keyword">enum</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ArgumentType</span></span></span><span class="hljs-class"> {</span></span> STRING, LONG, DOUBLE, <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, ... }</code> </pre> <br>  Yes, there is even no need to explain.  This is what <code>ArgumentType.NULL</code> turns into in the header file of the Kotlin library: <br><br><pre> <code class="cpp hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> {</span></span> extension_kt_kref_php_extension_dsl_ArgumentType (*get)(); <span class="hljs-comment"><span class="hljs-comment">/* enum entry for NULL. */</span></span> } <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>;</code> </pre> <br>  And that's how gcc responds to it. <br><br><pre> <code class="hljs pgsql">/root/simpleExtension/phpmodule/extension_kt_api.h:<span class="hljs-number"><span class="hljs-number">113</span></span>:<span class="hljs-number"><span class="hljs-number">17</span></span>: error: expected identifier <span class="hljs-keyword"><span class="hljs-keyword">or</span></span> <span class="hljs-string"><span class="hljs-string">'('</span></span> <span class="hljs-keyword"><span class="hljs-keyword">before</span></span> <span class="hljs-string"><span class="hljs-string">'void'</span></span> } <span class="hljs-keyword"><span class="hljs-keyword">NULL</span></span>; ^</code> </pre><br>  A curtain!  Watch out for names. <br><br><h2>  The last chapter.  Do not praise yourself - no one praises. </h2><br>  By and large, I achieved my goals.  Immersed in the topic, ‚Äúframework‚Äù for writing PHP extensions on Kotlin Native, in general, is ready.  It remains to add some, not the most critical, functionality and polish. <br><br>  The project itself and, I hope, good documentation for it, can be viewed <a href="https://github.com/rjhdby/kotlin-native-php-extension">on the githaba</a> . <br><br>  What can I say about K / N?  Only good.  It is a pleasure to write on it, but small shoals and roughness can be attributed to the fact that he has not even got out of the cradle :) <br><br><h2>  Chapter last.  Rays of good, without quotes. </h2><br>  But now, absolutely seriously and with deep respect, I want to thank the guys from JetBrains and the residents of the Kotlin Native slack channel.  You are super! <br><br>  And a special thank you to <b>Nikolai Igotti</b> . <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/tn/gr/px/tngrpxjotuvwziojqifyaxff5-y.png"></div><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/d1/5r/sn/d15rsndzgsxzin-aeglanekvtv4.png"></div><br><h2>  Bonus  Epic fakap. </h2><br>  The context is described in chapter four. <br><br>  Actually, when everything was added to the state in which it was compiled without errors, a problem arose - during testing, PHP was opened to me from a completely unfamiliar side. <br><br><pre> <code class="hljs objectivec"><span class="hljs-meta"><span class="hljs-meta"># php -dextension=./phpmodule/modules/extension.so -r </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"var_dump(ExampleClass::getInstance());"</span></span></span><span class="hljs-meta"> *RECURSION* #</span></span></code> </pre><br>  "Figase!" - I thought, I got into the PHP source and found this piece. <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">case</span></span> IS_OBJECT: <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (Z_IS_RECURSIVE_P(struc)) { PUTS(<span class="hljs-string"><span class="hljs-string">"*RECURSION*\n"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>; }</code> </pre> <br>  Adding debugging: <br><br><pre> <code class="cpp hljs"><span class="hljs-built_in"><span class="hljs-built_in">printf</span></span>(<span class="hljs-string"><span class="hljs-string">"%u"</span></span>, Z_IS_RECURSIVE_P(struc))</code> </pre> <br>  Led to: <br><br><pre> <code class="hljs pgsql">undefined symbol: Z_IS_RECURSIVE_P <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> <span class="hljs-type"><span class="hljs-type">Unknown</span></span> <span class="hljs-keyword"><span class="hljs-keyword">on</span></span> <span class="hljs-type"><span class="hljs-type">line</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span></code> </pre><br>  ‚ÄúDamn!‚Äù I thought again. <br><br>  At that moment, when I guessed to look at the php.h (7.1.8) actually used on the linux host, and not the one that I pulled from the master brunch (7.3.x) from the github, the day passed.  Straight ashamed. <br><br>  But as it turned out, it was not a reel. <br><br>  The correct recursion check code, at all stages of the life of the object under my control, reported that everything is OK and should work.  And this means that you should carefully look at the places that I do not control.  That was exactly one - in which my object is returned to the function <code>var_dump</code> <br><br><pre> <code class="cpp hljs">RETURN_OBJ( example_symbols()-&gt;kotlin.root.php.extension.proxy.objectToZval( example_symbols()-&gt;kotlin.root.exampleclass.getInstance(<span class="hljs-comment"><span class="hljs-comment">/* */</span></span>) ) )</code> </pre> <br>  Open the macro RETURN_OBJ to the end.  Remove from the nervous and pregnant monitors! <br><br><pre> <code class="cpp hljs"><span class="hljs-number"><span class="hljs-number">1</span></span>) RETURN_OBJ(r) <span class="hljs-number"><span class="hljs-number">2</span></span>) { RETVAL_OBJ(r); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>; } <span class="hljs-number"><span class="hljs-number">3</span></span>) { ZVAL_OBJ(return_value, r); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>; } <span class="hljs-number"><span class="hljs-number">4</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> { zval *__z = (return_value); Z_OBJ_P(__z) = (r); Z_TYPE_INFO_P(__z) = IS_OBJECT_EX; } <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (<span class="hljs-number"><span class="hljs-number">0</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>; } <span class="hljs-number"><span class="hljs-number">5</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> { zval *__z = (return_value); Z_OBJ(*(__z)) = (r); Z_TYPE_INFO(*(__z)) = (IS_OBJECT | (IS_TYPE_REFCOUNTED &lt;&lt; Z_TYPE_FLAGS_SHIFT)); } <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (<span class="hljs-number"><span class="hljs-number">0</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>; } <span class="hljs-number"><span class="hljs-number">6</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> { zval *__z = (return_value); (*(__z)).value.obj = (r); (*(__z)).u1.type_info = (<span class="hljs-number"><span class="hljs-number">8</span></span> | ((<span class="hljs-number"><span class="hljs-number">1</span></span>&lt;&lt;<span class="hljs-number"><span class="hljs-number">0</span></span>) &lt;&lt; <span class="hljs-number"><span class="hljs-number">8</span></span>)); } <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (<span class="hljs-number"><span class="hljs-number">0</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>; }</code> </pre> <br>  This is where I felt ashamed the second time.  I, completely in the blue eye, shoved <code>zval*</code> where waited for <code>zend_object*</code> and spent almost two days searching for an error. <br><br>  Thank you for your attention, all Kotlin!  :) <br><br>  Ps.  If there is a kind soul who subtracts my clumsy English and corrects the documentation - there will be no limit to my gratitude. </div><p>Source: <a href="https://habr.com/ru/post/423145/">https://habr.com/ru/post/423145/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../423135/index.html">Happy programmer's day: several educational training robots for children</a></li>
<li><a href="../423137/index.html">Browser extensions for GitHub that will increase the productivity of your work</a></li>
<li><a href="../423139/index.html">Fence Hole, Effective Managers & Engineers</a></li>
<li><a href="../423141/index.html">Claude Shannon: how genius solves problems</a></li>
<li><a href="../423143/index.html">October Slerm: Intensive by Kuburnetes</a></li>
<li><a href="../423147/index.html">On the strategy and data storage format in the Hadoop era</a></li>
<li><a href="../423149/index.html">Direct comparison of laser myopia correction methods or what you pay for when choosing ReLEx SMILE</a></li>
<li><a href="../423151/index.html">Global Objects in PHP</a></li>
<li><a href="../423153/index.html">Node.js tutorial, part 2: JavaScript, V8, some development techniques</a></li>
<li><a href="../423155/index.html">MIT course "Computer Systems Security". Lecture 8: "Model of network security", part 2</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>