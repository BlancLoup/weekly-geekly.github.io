<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Use Java smart cards to protect software. Chapter 2. Java smart card from the applet developer's point of view</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="In this series of articles we will discuss the use of Java smart cards (cheaper analog keys of electronic keys) to protect software. The cycle is divi...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Use Java smart cards to protect software. Chapter 2. Java smart card from the applet developer's point of view</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/files/22d/989/e78/22d989e78ad04030bec8bf788de74983.gif" alt="image"><br><br>  In this series of articles we will discuss the use of Java smart cards (cheaper analog keys of electronic keys) to protect software.  The cycle is divided into several chapters. <br><br>  To read and understand the information from the articles you will need the following skills: <br><ul><li>  Basics of software development for Windows (programming skills are enough in any visual environment, such as Delphi or Visual Basic) </li><li>  Basic knowledge from the field of cryptography (what is a cipher, symmetric, asymmetric algorithm, initialization vector, CBC, etc. I recommend Applied Cryptography by Bruce Schneier for mandatory reading). </li><li>  Basic programming skills in any language, even remotely resembling Java syntax (Java, C ++, C #, PHP, etc.) </li></ul><br>  The purpose of the cycle is to acquaint the reader with Java maps (there is very little literature in Russian on their use).  The cycle does not claim the status of "Guidelines for the development of software protection based on Java cards" or the title of "Handbook of Java cards." 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h4>  The composition of the cycle: </h4><br><ul><li>  <a href="http://habrahabr.ru/post/255529/">Chapter 1. Java card.</a>  <a href="http://habrahabr.ru/post/255529/">General information.</a> </li><li>  <a href="http://habrahabr.ru/post/255531/">Chapter 2. Java map from the point of view of the applet developer</a> </li><li>  <a href="http://habrahabr.ru/post/255533/">Chapter 3. Installing and Configuring IDE</a> </li><li>  <a href="http://habrahabr.ru/post/255535/">Chapter 4. We write the first applet</a> </li><li>  <a href="http://habrahabr.ru/post/255537/">Chapter 5. Security</a> </li></ul><br><a name="habracut"></a><br><h4>  1. APDU command. </h4><br>  The command passed to the applet is called the APDU command.  The APDU command consists of five bytes of the header + data.  However, the data itself can not be sent.  Five bytes of the header: <br><ul><li>  <b>CLA</b> - command class.  Specifies the class of the command to be sent.  Usually takes the values ‚Äã‚Äã0x00, 0x80, 0x84. </li><li>  <b>INS</b> - command instruction.  Specifies the actual action that the applet should perform. </li><li>  <b>P1</b> is the first parameter.  May send additional instructions to the applet. </li><li>  <b>P2</b> is the second parameter.  May send additional instructions to the applet. </li><li>  <b>LC</b> is the length of the data following the header.  0 if there is no data. </li><li>  <b>The data</b> .  Additional command data. </li></ul><br>  For example: <br><pre><code class="bash hljs">00A4040008A000000003000000</code> </pre> <br><pre> <code class="bash hljs">[0x00] (CLA) [0xA4] (INS) [0x04] (P1) [0x00] (P2) [0x08] (LC) [0xA0 0x00 0x00 0x00 0x03 0x00 0x00 0x00] (DATA)</code> </pre><br><br>  <b>0x00, 0xA4</b> is a SELECT APPLICATION command that selects an applet for later data exchange.  To transfer a command to your applet, you must first select it with this command.  The parameter <b>P1 = 0x04</b> means that the applet is selected by its name (AID, see below).  The parameter <b>P2 = 0x00</b> means that we want to select an applet that strictly corresponds to the transferred name.  As data (8 bytes), we passed the name of the applet ( <b>"a000000003000000"</b> is the standard name for the CardManager applet in some map variants).  For details on the standard applet commands, see <a href="http://www.globalplatform.org/specificationscard.asp">Global Platform Card Spec</a> 2.1.1, p.105 <br><br>  As you can see, the maximum size of the command APDU is 255 + 5 = 260 bytes (there is, however, support for ‚Äúlong commands, but I have never used them).  However, in practice, rarely use commands longer than a hundred bytes.  I try to ensure that commands do not exceed 127 bytes in length.  The reason for this precaution is simple: you may get cards whose APDU buffer size is less than 260 bytes and the long command simply will not accept the card.  Have to send it in parts. <br><br>  For their applets, it is better to choose the CLA value in the 0xD0-0xFE range, and the INS value is any that is not used by standard commands, except for the 0x60-0x6F, 0x90-0x9F ranges (this is a technical limitation of the <b>T = 0</b> protocol). <br><br><h4>  2. AID.  Packages </h4><br>  The name of the applet is called AID (Application Identifier).  Several applets or simply classes can be combined into a package (in fact, the concept of a package with reference to Java cards is the same as in Java itself).  The package also has an identifier (Package AID).  The first bytes of the AID applet must be equal to the AID of its packet.  For example, I have a package A0101010101010, and in it an applet with AID A010101010101055.  The minimum length of an AID is 5 bytes.  Maximum - 16. <br><br><h4>  3. Applet firewall.  Communicating applets. </h4><br>  By default, applets are completely independent of each other.  They have no way to transfer data to each other.  However, one applet can implement the Shareable interface, giving others access to some of its methods.  Only primitive data types and links to the APDU buffer can cross the border between applets (the place where the incoming command is usually placed in the card and the response to it is formed), since it is, in fact, common to all card applets. <br><br>  Using the JavaCard API, various applets can talk to each other (using the Shareable interface).  This allows, for example, to implement a permanent applet that returns the serial number of the card and a second applet that implements the set of functions you require.  At the same time, the second applet can be safely updated, and the first one can be left on the map forever.  Then he will be able to perform some operations dependent on the serial number (for example, to encrypt data uniquely for this serial number). <br><br><h4>  4. Return codes. </h4><br>  After running the command, the applet returns a two-byte result code.  A successful result code may be accompanied by a set of response bytes.  A list of possible return codes is <a href="http://www.cardwerk.com/smartcards/smartcard_standard_ISO7816-4_5_basic_organizations.aspx">here</a> .  Usually, the successful completion of the operation is <b>90 00</b> . <br><br><h4>  5. Work with memory. </h4><br>  All members of the applet class are located in the memory EEPROM of the card, which is rather slow.  But usually cards have some small (up to several kilobytes) amount of transient memory, which is somewhat similar to RAM.  Access to it is carried out several times faster.  Such memory is allocated on request by calling <i>JCSystem.makeTransientByteArray ()</i> .  Please note that the amount of this memory is limited (the few kilobytes I mentioned are allocated to all card applets). <br><br><h4>  6. Data transfer protocols. </h4><br>  Two protocols are used to communicate with the cards - <b>T = 0</b> and <b>T = 1</b> .  <b>T = 0</b> is considered to be oriented on the transmission of characters, and <b>T = 1</b> - oriented on the transmission of blocks of information.  However, for us, these nuances do not matter.  Simply speaking, these protocols differ only in that in the case of the T = 1 protocol, the data is transmitted by the stream, as we are used to (question-flow =&gt; flow-response), and in the case of T = 0, we have hemorrhoids with the need to form a command differently depending on whether we are transmitting data or not, whether we are waiting for data or not (details can be seen in the description of <a href="https://msdn.microsoft.com/en-us/library/windows/desktop/aa379804%2528v%3Dvs.85%2529.aspx">SCardTransmit</a> . I will not consider the details of the protocols here (in due time they delivered me some hemorrhoids when the client suddenly had cards with T = 1, and my software worked only with T = 0), I note only that  sim ilar to select components to work with maps that provide transparent support for both protocols. The interested differences I address my Delphi-component, which I use to communicate with the cards. I tried to embed a transparent support for both of them. As far as I got it, time will tell. <br><br><h4>  7. ATR and other card information </h4><br>  <b>ATR = Answer To Reset</b> is a set of bytes returned by the card for its identification.  If it so happens that during the implementation of a certain project you had to use different types of cards, studying ATR is a good way to distinguish them.  You can get ATR by calling SCardGetAttrib. <br><br>  <b>CPLC Data (Card Production Life Cycle Data)</b> is a set of data about the card that CardManager applet normally returns when sending <b>0x80 0xCA 0x9F 0x7F</b> commands to it.  This data contains some system information about the card, such as, for example, the serial number of the EEPROM.  I want to note that it is difficult to count on the uniqueness of, for example, the serial number of the EEPROM.  If you intend to have a serial number on the card, write an applet that will read / write this number.  Since I did not find the decoding of the CPLC Data fields in the official documentation, I quote the structure of this data in Delphi here: <br><br><pre> <code class="delphi hljs"> TFSCardAPICPLCData = <span class="hljs-keyword"><span class="hljs-keyword">packed</span></span> <span class="hljs-keyword"><span class="hljs-keyword">record</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> CPLCTag: <span class="hljs-keyword"><span class="hljs-keyword">array</span></span>[<span class="hljs-number"><span class="hljs-number">0</span></span>..<span class="hljs-number"><span class="hljs-number">1</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">of</span></span> Byte; <span class="hljs-comment"><span class="hljs-comment">// Expected: 9F 7F CPLCLength: Byte; // Expected: 2A IntegratedCircuitROMFabricator: array[0..1] of Byte; IntegratedCircuitROMType: array[0..1] of Byte; ROMOSidentifier: array[0..1] of Byte; OSReleaseDate: array[0..1] of Byte; OSReleaseLevel: array[0..1] of Byte; EEPROMFabricationDate: array[0..1] of Byte; EEPROMSerialNumber: array[0..3] of Byte; EEPROMBatchIdentifier: array[0..1] of Byte; EEPROMModuleFabricator: array[0..1] of Byte; EEPROMModulePackagingDate: array[0..1] of Byte; EEPROMIntegratedCircuitCardManufacturer: array[0..1] of Byte; EEPROMEmbeddingDate: array[0..1] of Byte; EEPROMPrePersonalizer: array[0..1] of Byte; EEPROMPrePersonalizationDate: array[0..1] of Byte; EEPROMPrePersonalizationEquipmentIdentifier: array[0..3] of Byte; EEPROMPersonalizer: array[0..1] of Byte; EEPROMPersonalizationDate: array[0..1] of Byte; EEPROMPersonalizationEquipmentIdentifier: array[0..3] of Byte; end;</span></span></code> </pre><br>  By the way, I came across cards that returned an error in response to a CPLC request.  In fact, this means that the CPLC block was not registered in them during production. <br><br><h4>  8. Interception of data sent to / from the card </h4><br>  Since any software communicates with the card through the standard Windows libraries, always assume that any communication "there" and "back" can be intercepted.  There are even special utilities for this, like <a href="http://www.fernandes.org/apduview/">APDUView</a> .  Therefore, all data exchange with the card must be encrypted.  Which automatically assumes that your program must necessarily be protected by a protector such as <a href="http://www.oreans.com/themida.php">Themida</a> . <br><br><h4>  9. A little about performance </h4><br>  I conducted some tests with the cards that I had on hand.  The test results are very approximate (I did not create any special conditions, the applet was used primitive).  A 12Kb (kilobyte) data card (Gemalto TOP IM GX) can transfer in approximately 2.177 seconds.  Encryption and transmission of 12Kb of 3DES2 data takes about 8.823 seconds, AES256 - 4.420 seconds. <br><br>  It may seem that it is sparse.  However, in this case, I always advise my clients to recall programming for the ZX Spectrum. So let the miracle happen on a few kilobytes. <br><br><h4>  10. Gratitude to patient readers. </h4><br>  Thanks to everyone who read to this place.  Gratitude and indignation are accepted. <br><br>  I will welcome any questions in the comments and try to update the article so that it includes the answers. </div><p>Source: <a href="https://habr.com/ru/post/255531/">https://habr.com/ru/post/255531/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../255519/index.html">Return oriented programming. We collect exploit in pieces</a></li>
<li><a href="../255523/index.html">SQL Language Tutorial (DDL, DML) on the example of MS SQL Server dialect. Part two</a></li>
<li><a href="../255525/index.html">Encryption and decryption - accessing the OpenSSL API using JNI calls</a></li>
<li><a href="../255527/index.html">Ordinary Primes: The Secrets of the Weavers' Secret Society</a></li>
<li><a href="../255529/index.html">Use Java smart cards to protect software. Chapter 1. General Information</a></li>
<li><a href="../255533/index.html">Use Java smart cards to protect software. Chapter 3. Installing and Configuring IDE</a></li>
<li><a href="../255535/index.html">Use Java smart cards to protect software. Chapter 4. We write the first applet</a></li>
<li><a href="../255537/index.html">Use Java smart cards to protect software. Chapter 5. Security</a></li>
<li><a href="../255539/index.html">Release elementary OS "Freya"</a></li>
<li><a href="../255547/index.html">Krovi: Big Data - as dream. Unplanned Series 5: Big Game. Private opinion</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>