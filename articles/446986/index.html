<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Crouching in the shadows or searching for that light</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Assembler is my favorite language ... but life is so short. 
 I continue the cycle of research on the issue of suitable shadows for a bagel. After pub...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Crouching in the shadows or searching for that light</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/webt/d-/wj/wu/d-wjwubdpihumypc3b7tv43ihzy.png"><br><blockquote>  Assembler is my favorite language ... but life is so short. </blockquote><br>  I continue the cycle of research on the issue of suitable shadows for a bagel.  After publishing <a href="https://habr.com/ru/post/430438/">once</a> and <a href="https://habr.com/ru/post/431304/">twice, I have</a> somewhat cooled down on this topic, but the effect of incomplete action prompts me to return to the marania of pixels, and complete the <a href="https://ru.wikipedia.org/wiki/%25D0%2593%25D0%25B5%25D1%2588%25D1%2582%25D0%25B0%25D0%25BB%25D1%258C%25D1%2582-%25D1%2582%25D0%25B5%25D1%2580%25D0%25B0%25D0%25BF%25D0%25B8%25D1%258F">gestalt</a> . <br><br>  Knowing myself, I am sure that the game will hardly get embodied, but perhaps some of the public will be interested in my work on this thorny path.  And so begin. <br><a name="habracut"></a><br>  Already at the end of the last cycle I came to understand that calculating graphics on a CPU is already the last century, but natural stubbornness kept saying: not all the possibilities have been used yet, there are also options for interesting solutions. <br><br>  Reverse ray tracing was not embodied.  More precisely, its kind, where for each pixel of the image (block of pixels) a ray is forwarded and the level of illumination of the current point is determined.  The algorithm itself is described in the last article and there is no point in returning to it.  For back ray tracing, the code was further simplified, the entire trigonometry was removed completely, which in the future could give an acceptable result. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <div class="spoiler">  <b class="spoiler_title">Pascal</b> <div class="spoiler_text"><pre><code class="delphi hljs"><span class="hljs-keyword"><span class="hljs-keyword">const</span></span> tile_size = <span class="hljs-number"><span class="hljs-number">32</span></span>; <span class="hljs-comment"><span class="hljs-comment">//   tile_size1 : single = 0.03125; // 1/32 -    block_size = 4; // /    Size_X:Byte = 32; //    X Size_Y:Byte = 24; //    Y //--------------------------------- function is_no_empty(x,y:Integer):Integer; begin if (x&gt;=0) AND (x&lt;Size_X) AND (y&gt;=0) AND (y&lt;Size_Y) then begin if map[x,y]=1 then begin is_no_empty:=1; end else if map[x,y]=2 then begin is_no_empty:=2; end else is_no_empty:=0; end else is_no_empty:=-1; end; //--------------------------------- function crossing(r_view, x,y:Single; xi,yj, i,j:Integer):Byte; var di,dj,ddi,ddj :Shortint; //   k,i2,j2 :integer; //    key:Boolean; last_k, transp_key :Byte; sum_lenX,sum_lenY, Dx,Dy,Dx1,DY1, l :Single; //  sec1,cosec1, temp_x,temp_y, dx0,dy0 :Single; //   i0,j0 :Integer; //       begin temp_x := i*block_size; temp_y := j*block_size; i0 := trunc(temp_x * tile_size1); j0 := trunc(temp_y * tile_size1); l := sqrt(sqr(temp_y-y) + sqr(temp_x-x)) + 0.0000001; transp_key := 0; //     if is_no_empty(xi,yj)&gt;0 then inc(transp_key); if (xi=i0) and (yj=j0) then begin crossing := min(255,transp_key*64+ l * r_view); exit; end; dx0 := (temp_x-x)/l+0.0000001; dy0 := (temp_y-y)/l+0.0000001; key := False; last_k :=0; //   if dx0&lt;0 then begin di :=-1; ddi:= 0; end else begin di := 1; ddi:= 1; end; if dy0&lt;0 then begin dj :=-1; ddj:= 0; end else begin dj := 1; ddj:= 1; end; sum_lenX := 0; sum_lenY := 0; sec1 := 1/dx0; cosec1 := 1/dy0; //       Y temp_x := x-(xi+ddi) * tile_size ; temp_y := y-(yj+ddj) * tile_size ; Dx := sqrt(sqr(temp_x) + sqr(temp_x * sec1 * dy0)); DY := sqrt(sqr(temp_y) + sqr(temp_y * cosec1 * dx0)); //      Y Dx1 := abs(tile_size * sec1); Dy1 := abs(tile_size * cosec1); repeat if sum_lenX+DX &lt; sum_lenY+DY then begin xi += di; k := is_no_empty(xi,yj); sum_lenX += DX; if DX&lt;&gt;Dx1 then DX := Dx1; end else begin yj += dj; k := is_no_empty(xi,yj); sum_lenY += DY; if DY&lt;&gt;Dy1 then DY := Dy1; end; if key Then begin if (xi&lt;&gt;i2) Or (yj&lt;&gt;j2) then begin //  (  ) if last_k=1 then begin crossing := 255; exit; end; //   (  ) if transp_key&gt;2 then begin crossing := 255; exit; end; inc(transp_key); key:= false; end; end; if k&gt;0 then begin i2:=xi; j2:=yj; key:=true; last_k:=k; end; //    if (xi=i0) and (yj=j0) then begin crossing := min(255, transp_key*64+ l * r_view); exit; end; until k=-1; //     end; //--------------------------------- .................. x0:= mouse_x; y0:= mouse_y; //       x1 := x0 div tile_size; y1 := y0 div tile_size; koef := tile_size div block_size; //      (     ) for j:=0 to Size_Y * koef do for i:=0 to Size_X * koef do picture_mask.SetPixel(i, j, BGRA(0,0,0,crossing(x0, y0, x1, y1, i, j))); ..................</span></span></code> </pre> <br></div></div><br>  Alas, the result turned out to be much worse than expected, it was enough to expand the picture to full screen, FPS aimed for units. <br><br><img src="https://habrastorage.org/webt/to/b_/sa/tob_sau5axwf2lhnxxfswnfuuv8.png"><br><br>  Grouping pixels into macroblocks to reduce computations and applying subsequent smoothing improved performance slightly.  The effect frankly did not like the word at all. <br><br><img src="https://habrastorage.org/webt/hj/s5/sr/hjs5srli3gslf1yuerzb8b2kjq4.png"><br><br>  The algorithm paralleled well, but it didn‚Äôt wash out many streams, the effect seemed much worse than in the previous article, even with better picture quality. <br>  It turned out to be a dead end.  It was necessary to admit, the CPU in calculating the graphics in my eyes had exhausted itself.  A curtain. <br><br><div class="spoiler">  <b class="spoiler_title">Digression 1</b> <div class="spoiler_text">  Over the past decade, there has been almost no progress in the development of general-purpose processors.  If approached by the user, then the maximum observed performance gain is no more than 30% per core.  Progress, to put it mildly, is insignificant.  If we omit the extension of the length of the vector instructions, and some acceleration of the conveyor blocks, then this is an increase in the number of working cores.  Safe work with threads, it‚Äôs still fun, but not all tasks can be successfully paralleled.  I would like to have a working core, albeit one, but since it is 5-10 faster, but as they say, alas. <br>  Here on Habr√© there is an excellent series of articles <a href="https://habr.com/ru/company/intel/blog/158223/">"Life in the era of" dark "silicon,"</a> which explains some of the prerequisites for the current state of affairs, but also returns from heaven to earth.  In the next decade, we can not expect any significant increase in computing per core.  But we can expect further development of the number of GPU cores and their general acceleration.  Even on my old laptop, the estimated total GPU performance is 20 times higher than a single CPU thread.  Even if it is efficient to load all 4 cores of the processor, it is much less than we would like. <br>  I pay tribute to the developers of the graphics of the past, who made their masterpieces without hardware accelerators, real masters. <br></div></div><br>  So, we deal with the GPU.  It turned out to be somewhat unexpected for me that in this practice very few people just scatter polygons in shape.  All more or less interesting things are created using <a href="https://ru.wikipedia.org/wiki/%25D0%25A8%25D0%25B5%25D0%25B9%25D0%25B4%25D0%25B5%25D1%2580">shaders</a> .  Discarding ready-made 3D engines, I tried to study the technology offal as they are at a deep level.  The same processors are the same assembler, only a few trimmed instruction set and their own specific work.  For the sample I stopped at <a href="https://ru.wikipedia.org/wiki/OpenGL_Shading_Language">GLSL</a> , C-like syntax, simplicity, a lot of training lessons and examples, including those in Habr√©. <br>  Since I was mostly used to writing on <a href="https://ru.wikipedia.org/wiki/%25D0%259F%25D0%25B0%25D1%2581%25D0%25BA%25D0%25B0%25D0%25BB%25D1%258C_(%25D1%258F%25D0%25B7%25D1%258B%25D0%25BA_%25D0%25BF%25D1%2580%25D0%25BE%25D0%25B3%25D1%2580%25D0%25B0%25D0%25BC%25D0%25BC%25D0%25B8%25D1%2580%25D0%25BE%25D0%25B2%25D0%25B0%25D0%25BD%25D0%25B8%25D1%258F)">Pascal</a> , the challenge was how to connect OpenGL <br>  to the project.  I managed to find two ways to connect: the <a href="https://ru.wikipedia.org/wiki/GLFW">GLFW</a> library and the <a href="https://ru.wikipedia.org/wiki/GLFW">dglOpenGL</a> header file.  The only thing in the first I could not connect shaders, but apparently it is from the curvature of my hands. <br><br><div class="spoiler">  <b class="spoiler_title">Digression 2</b> <div class="spoiler_text">  Many friends ask me why I write on Pascal?  Obviously, this is an endangered language, its community is steadily falling, there is almost no development.  Low-level system vendors prefer C, and Java, Python, Ruby or whatever is now at its peak. <br>  For me, Pascal is like a first love.  Two decades ago, back in the days of <a href="https://ru.wikipedia.org/wiki/Turbo_Pascal">Turbo Pascal 5.5</a> , he sunk into my soul and has since walked through my life, be it Delphi or in recent years <a href="https://ru.wikipedia.org/wiki/Lazarus">Lazarus</a> .  I like the predictability of the language, the relative low level (assembler inserts and viewing processor instructions), compatibility with C. The main thing is that the code is collected and executed without problems, and the fact that it is not fashionable is outdated, and there are not some features, this is nonsense.  It is said that there are people who still write to <a href="https://ru.wikipedia.org/wiki/%25D0%259B%25D0%25B8%25D1%2581%25D0%25BF">LISP</a> , but he is generally half a century old. <br></div></div><br>  So, plunge into the development.  For the trial step, we will not take accurate realistic shading models, but try to implement what we have tried before, but with the performance of the GPU, so to speak, for visual comparison. <br><br>  Initially, I thought of getting a shadow of approximately the same shape for an object using triangles. <br><br><img src="https://habrastorage.org/webt/up/ps/la/uppslarm4raiqopjfumiogecono.png"><br><br>  To create a smooth circle effect, you need a mass of polygons.  But what if you use triangles to a minimum, using a pixel shader to create a hole in the shape.  The idea came to me after reading the <a href="https://habr.com/ru/post/253791/">article by a</a> respected master, which opened the opportunity to create spheres with a shader. <br><br><img src="https://habrastorage.org/webt/ph/hu/tg/phhutg9hwan_hlukufz4twdjp7i.png"><br><br>  If you extend the triangle beyond the screen, you end up with this: <br><br><img src="https://habrastorage.org/webt/80/tm/wy/80tmwydb6qratckw2hzzqpdanxk.png"><br><br>  The borders of the shadow turned out to be very hard and, moreover, stepped.  But there is a way to get an acceptable result without using <a href="https://ru.wikipedia.org/wiki/%25D0%2598%25D0%25B7%25D0%25B1%25D1%258B%25D1%2582%25D0%25BE%25D1%2587%25D0%25BD%25D0%25B0%25D1%258F_%25D0%25B2%25D1%258B%25D0%25B1%25D0%25BE%25D1%2580%25D0%25BA%25D0%25B0_%25D1%2581%25D0%25B3%25D0%25BB%25D0%25B0%25D0%25B6%25D0%25B8%25D0%25B2%25D0%25B0%25D0%25BD%25D0%25B8%25D1%258F">supersampling</a> , this is the use of smoothed borders.  To do this, a little change the scheme.  The corners of polygons at the intersection of the tangent to the circle will be made transparent. <br><br><img src="https://habrastorage.org/webt/r7/er/bg/r7erbgdvqlaxcwrtp7im6m6j97u.png"><br><br>  The result is better, but still looks unnatural. <br><br><img src="https://habrastorage.org/webt/k9/r8/qw/k9r8qw-kcrabolq1vqyqgvr5b8o.png"><br><br>  Add a slight smoothing of the circle to give softness, and also change the appearance of the gradient from linear to power. <br><br><img src="https://habrastorage.org/webt/s9/mo/a2/s9moa2rhsslrktn808o2cwoxiwy.png"><br><br>  It is an acceptable result. <br>  And as a result we will add the objects imitating obstacles on the form. <br><br><img src="https://habrastorage.org/webt/fo/f8/4c/fof84cbrg5n_kea_4k9js5tiqi4.png"><br><br><div class="spoiler">  <b class="spoiler_title">Shader code</b> <div class="spoiler_text"> <code>//   <br> <br> #version 330 core <br> layout (location = 0) in vec2 aVertexPosition; <br> void main(void) { <br> gl_Position = vec4(aVertexPosition.xy, 0, 1.0); <br> } <br> <br> //   <br> <br> #version 330 core <br> layout (points) in; <br> layout (triangle_strip, max_vertices = 5) out; <br> uniform mat4 uModelViewMatrix; <br> uniform float uRadius; <br> uniform vec2 uHeroPoint; <br> out float fTransparency; <br> out vec2 vCenter; <br> void main(){ <br> vCenter = gl_in[0].gl_Position.xy; <br> vec2 d = uHeroPoint - vCenter; <br> float l = length(d); <br> float i = uRadius / l; <br> float ii = i*i; <br> float ij = i * sqrt(1 - ii); <br> vec2 p1 = vec2(vCenter.x + dx*ii - dy*ij , vCenter.y + dx*ij + dy*ii); <br> vec2 p2 = vec2(vCenter.x + dx*ii + dy*ij , vCenter.y - dx*ij + dy*ii); <br> d = uHeroPoint - p1; <br> vec2 p3 = vec2(p1 - d/length(d)*1000000); <br> d = uHeroPoint - p2; <br> vec2 p4 = vec2(p2 - d/length(d)*1000000); <br> fTransparency = 0; <br> gl_Position = uModelViewMatrix * vec4(p1, 0, 1); <br> EmitVertex(); <br> fTransparency = 1; <br> gl_Position = uModelViewMatrix * vec4(p3, 0, 1); <br> EmitVertex(); <br> gl_Position = uModelViewMatrix * vec4(vCenter, 0, 1); <br> EmitVertex(); <br> gl_Position = uModelViewMatrix * vec4(p4, 0, 1); <br> EmitVertex(); <br> fTransparency = 0; <br> gl_Position = uModelViewMatrix * vec4(p2, 0, 1); <br> EmitVertex(); <br> EndPrimitive(); <br> } <br> <br> //   <br> <br> #version 330 core <br> precision mediump float; <br> varying float fTransparency; <br> varying vec2 vCenter; <br> uniform float uRadius; <br> uniform vec2 uScreenHalfSize; <br> uniform float uShadowTransparency; <br> uniform float uShadowSmoothness; <br> out vec4 FragColor; <br> void main(){ <br> float l = distance(vec2((gl_FragCoord.xy - uScreenHalfSize.xy)/uScreenHalfSize.y), vCenter.xy); <br> if (l&lt;uRadius) {discard;} <br> else {FragColor = vec4(0, 0, 0, min(pow(fTransparency, uShadowSmoothness), (l-uRadius)/uRadius*10)*uShadowTransparency);} <br> } <br></code> <br></div></div><br>  I hope it was informative <br><br>  Your humble servant, pixel raiser, Rebuilder. <br><br>  I attach a small <a href="https://yadi.sk/d/FOuhpGDQ4opH7A">demo</a> .  (EXE Windows) <br><br>  PS The title of the article contains <a href="https://ru.wikipedia.org/wiki/%25D0%259F%25D0%25B0%25D1%2581%25D1%2585%25D0%25B0%25D0%25BB%25D1%258C%25D0%25BD%25D0%25BE%25D0%25B5_%25D1%258F%25D0%25B9%25D1%2586%25D0%25BE_(%25D0%25B2%25D0%25B8%25D1%2580%25D1%2582%25D1%2583%25D0%25B0%25D0%25BB%25D1%258C%25D0%25BD%25D0%25BE%25D0%25B5)">Easter eggs</a> , a reference to the trilogy of the <a href="https://ru.wikipedia.org/wiki/%25D0%259A%25D1%2580%25D0%25B0%25D0%25B4%25D1%2583%25D1%2589%25D0%25B8%25D0%25B9%25D1%2581%25D1%258F_%25D0%25B2_%25D1%2582%25D0%25B5%25D0%25BD%25D0%25B8">Chronicles of Siala</a> .  Excellent work in the style of fantasy, about the misfortunes of the horns, from Alexei Pekhov. </div><p>Source: <a href="https://habr.com/ru/post/446986/">https://habr.com/ru/post/446986/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../446976/index.html">Paradoxes about data compression</a></li>
<li><a href="../446978/index.html">Breakuot-like game on PIC12F1572</a></li>
<li><a href="../446980/index.html">How to publish a mobile game, and not make my mistakes</a></li>
<li><a href="../446982/index.html">CS center graduates return to teach</a></li>
<li><a href="../446984/index.html">Shake Space Invaders analogue in 1 kilobyte (original 1978 takes 8)</a></li>
<li><a href="../446988/index.html">How I taught Scala</a></li>
<li><a href="../446990/index.html">Input delay on retro consoles and emulators</a></li>
<li><a href="../446992/index.html">John Maeda: ‚ÄúActually, design is not so important‚Äù</a></li>
<li><a href="../446994/index.html">Cosmos as a vague memory</a></li>
<li><a href="../446996/index.html">The pomodoro method is not as cool as it could be</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>