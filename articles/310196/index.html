<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>MapReduce from scrap materials. Part II - Basic Implementation Interfaces</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="In the previous part of the series we (in the 100,500th time) tried to tell about the main techniques and stages of the Google MapReduce approach, I m...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>MapReduce from scrap materials. Part II - Basic Implementation Interfaces</h1><div class="post__text post__text-html js-mediator-article"><p> <em><a href="http://fineartamerica.com/featured/take-it-like-a-man-joan-pollak.html"><img src="https://habrastorage.org/files/e4c/cac/f03/e4ccacf0316840bca92ee668bfdb1f95.jpg" align="left" width="288" height="240" alt="Take it like a man by Joan Pollak"></a></em>  <em><a href="https://habrahabr.ru/company/intersystems/blog/310180/">In the previous part of the series</a> we (in the 100,500th time) tried to tell about the main techniques and stages of the Google MapReduce approach, I must admit that the first part was going to be the ‚Äúcaptain‚Äù to let the target articles about the next articles to be known about MapReduce.</em>  <em>We did not have time to show a single line of how we are going to implement all this in Cach√© ObjectScript.</em>  <em>And about this our story today (and in the following days).</em> </p><br><p>  Recall the initial message of our mini-project: you are still planning to implement the MapReduce algorithm using the available tools in Cach√© ObjectScript.  When creating interfaces, we will try to adhere to the API that we described in the previous article about the original implementation of Google MapReduce, any deviations will be announced accordingly. </p><br><a name="habracut"></a><br><p>  Let's start with the implementation of abstract interfaces Mapper and Reducer. </p><br><pre><code class="hljs php"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">Class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">MR</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Base</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Mapper</span></span></span><span class="hljs-class"> </span></span>{ Method Map(MapInput <span class="hljs-keyword"><span class="hljs-keyword">As</span></span> MR.Base.Iterator, MapOutput <span class="hljs-keyword"><span class="hljs-keyword">As</span></span> MR.Base.Emitter) [ <span class="hljs-keyword"><span class="hljs-keyword">Abstract</span></span> ] { } } <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">Class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">MR</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Base</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Reducer</span></span></span><span class="hljs-class"> </span></span>{ Method Reduce(ReduceInput <span class="hljs-keyword"><span class="hljs-keyword">As</span></span> MR.Base.Iterator, ReduceOutput <span class="hljs-keyword"><span class="hljs-keyword">As</span></span> MR.Base.Emitter) [ <span class="hljs-keyword"><span class="hljs-keyword">Abstract</span></span> ] { } }</code> </pre> <br><p>  Initially, as in the canonical implementation, we made 2 separate interfaces MapInput and ReduceInput.  But it immediately became obvious that they serve the same goal, and provide the same methods - their goal is to walk through the data stream to the end, including  they are both iterators.  Therefore, in the end, we reduce them to the general interface MR.Base.Iterator: </p><br><pre> <code class="hljs pgsql"><span class="hljs-keyword"><span class="hljs-keyword">Class</span></span> MR.Base.Iterator { <span class="hljs-keyword"><span class="hljs-keyword">Method</span></span> GetNext() <span class="hljs-keyword"><span class="hljs-keyword">As</span></span> %String [Abstract ] { } <span class="hljs-keyword"><span class="hljs-keyword">Method</span></span> IsAtEnd() <span class="hljs-keyword"><span class="hljs-keyword">As</span></span> %<span class="hljs-type"><span class="hljs-type">Boolean</span></span> [Abstract ] { } }</code> </pre> <br><h2 id="ispolzovanie-globalov-v-kachestve-kanalov-svyazi">  Using globals as communication channels </h2><br><p>  The original Google MapReduce implementation used the Google GFS file system as a transport between nodes and algorithm stages.  Cach√© has its own mechanism for distributing (coherent) data between nodes (if you don‚Äôt use bare TCP / UDP), this is the ECP ( <a href="http://docs.intersystems.com/documentation/cache/latest/pdfs/GDDM.pdf">Enterprise Case Protocol</a> ).  It is usually used by application servers to retrieve data from remote database servers.  But nothing stops us from building on the basis of such peer-to-peer ECP connections some virtual control bus, where we will add data in the form of pairs &lt;key, value&gt; or similar data.  This data will be sent between the actors involved in the algorithm's pipelines (that is, the emit sent by the Mapper object will be written to the ECP bus and read by the Reducer object).  If the actors work within a single node, for example, they can use fast globals displayed in CACHETEMP or ordinary globals if the implemented algorithm is multistage and needs reliability and logging. </p><br><p>  In any case, be it local (for configuration on one node) globals, or globals of a remote node connected via ECP, globals are a convenient and well-proven transport for transferring data between Cach√© cluster nodes, in this case, between the functions involved in MapReduce and classes. </p><br><blockquote>  Therefore, a natural solution to simplify our system will be using the Cach√© environment for transferring data between nodes of an ECP cluster instead of GFS or HDFS file systems.  The functional characteristics of the ECP will make other simplifications (but more on that later). </blockquote><br><h2 id="emittery-i-chernaya-magiya">  Emitters and black magic </h2><br><p>  As we already told <a href="https://habrahabr.ru/company/intersystems/blog/310180/">in the previous series</a> , from the moment when the data moves away from the Mapper object, until the moment they arrive at the Reducer input, in the classical implementation on the master, the heavy operation of mixing and sorting takes place. </p><br><p>  In an environment that uses globals for transport quality, in a MUMPS / Cach√© ObjectScript environment, we can completely avoid the extra cost of such sorting, since  aggregation and sorting will be done by the underlying btree * repository. </p><br><p>  Having such design requirements, we will create a basic emitter interface: </p><br><pre> <code class="hljs php"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">Class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">MR</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Base</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Emitter</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">Extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">MR</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Base</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Iterator</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-comment"><span class="hljs-comment">/// emit $listbuild(key,value(s)) Method Emit(EmitList... As %String) [Abstract ] { } }</span></span></code> </pre> <br><p>  The emitter should be similar to the interface of the input iterator shown above (because we inherited from MR.Base.Iterator), but in addition to the data-through interface, the emitter should also be able to send data to its intermediate storage (i.e. add emit function). </p><br><p>  Initially, our Emit function was very similar to the classical implementation and took only 2 arguments as a pair of &lt;key, value&gt;, but then we came across a (rare) need to pass something more multidimensional, longer than a pair of values ‚Äã‚Äã(for example, a tuple of any arity ), therefore, at the moment, Emit has become a function of receiving a variable number of arguments. </p><br><p>  Note that in most cases, in practice, only a couple of arguments &lt;key, value&gt; will arrive here, as we saw in the classical implementation. </p><br><p>  <em>This is still an abstract interface, more meat will be added very soon.</em> </p><br><p>  If we, during processing, had to preserve the order of the incoming elements, then we would use the implementation below: </p><br><pre> <code class="hljs haskell">/// <span class="hljs-type"><span class="hljs-type">Emitter</span></span> which maintains the order <span class="hljs-keyword"><span class="hljs-keyword">of</span></span> (key,value(s)) <span class="hljs-type"><span class="hljs-type">Class</span></span> <span class="hljs-type"><span class="hljs-type">MR</span></span>.<span class="hljs-type"><span class="hljs-type">Emitter</span></span>.<span class="hljs-type"><span class="hljs-type">Ordered</span></span> <span class="hljs-type"><span class="hljs-type">Extends</span></span> (%<span class="hljs-type"><span class="hljs-type">RegisteredObject</span></span>, <span class="hljs-type"><span class="hljs-type">MR</span></span>.<span class="hljs-type"><span class="hljs-type">Base</span></span>.<span class="hljs-type"><span class="hljs-type">Emitter</span></span>) { /// global name serving <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">data</span></span></span><span class="hljs-class"> channel </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Property</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">GlobalName</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">As</span></span></span><span class="hljs-class"> %</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">String</span></span></span><span class="hljs-class">; </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Method</span></span></span><span class="hljs-class"> %</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">OnNew</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">initval</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">As</span></span></span><span class="hljs-class"> %</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">String</span></span></span><span class="hljs-class">) </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">As</span></span></span><span class="hljs-class"> %</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Status</span></span></span><span class="hljs-class"> { $$$</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ThrowOnError</span></span></span><span class="hljs-class">($</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">length</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">initval</span></span></span><span class="hljs-class">)&gt;0) </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">set</span></span></span><span class="hljs-class"> ..</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">GlobalName</span></span></span><span class="hljs-class"> = </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">initval</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">quit</span></span></span><span class="hljs-class"> $$$</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">OK</span></span></span><span class="hljs-class"> } </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Parameter</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">AUTOCLEANUP</span></span></span><span class="hljs-class"> = 1; </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Method</span></span></span><span class="hljs-class"> %</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">OnClose</span></span></span><span class="hljs-class">() </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">As</span></span></span><span class="hljs-class"> %</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Status</span></span></span><span class="hljs-class"> { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">if</span></span></span><span class="hljs-class"> ..#</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">AUTOCLEANUP</span></span></span><span class="hljs-class"> { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">if</span></span></span><span class="hljs-class"> $</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">data</span></span></span><span class="hljs-class">(@</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">i</span></span></span><span class="hljs-class">%</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">GlobalName</span></span></span><span class="hljs-class">) { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">kill</span></span></span><span class="hljs-class"> @</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">i</span></span></span><span class="hljs-class">%</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">GlobalName</span></span></span><span class="hljs-class"> } } </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Quit</span></span></span><span class="hljs-class"> $$$</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">OK</span></span></span><span class="hljs-class"> } ... }</span></span></code> </pre> <br><p>  We note in the fields that in Cach√©, globals are, in general, global :), and will not be cleared automatically upon completion of the processes that created them.  Unlike, for example, <a href="">PPG (process-private globals)</a> .  But sometimes it is still desirable that our intermediate channels created for interaction between the stages of the MapReduce pipeline are deleted upon completion of the subroutine that created them.  Therefore, the "auto-cleaning" mode was added (class parameter #AUTOCLEANUP) in which the global, whose name is stored in the GlobalName property, is deleted when the object is closed (at the time of the% OnClose call). </p><br><p>  Note that we force one required parameter in the% New method (in% OnNew, generate $$$ ThrowOnError if the name in Initval is not defined).  The class constructor expects to get the name of the global with which it will work as a data transport. </p><br><pre> <code class="hljs haskell"><span class="hljs-type"><span class="hljs-type">Class</span></span> <span class="hljs-type"><span class="hljs-type">MR</span></span>.<span class="hljs-type"><span class="hljs-type">Emitter</span></span>.<span class="hljs-type"><span class="hljs-type">Ordered</span></span> <span class="hljs-type"><span class="hljs-type">Extends</span></span> <span class="hljs-type"><span class="hljs-type">MR</span></span>.<span class="hljs-type"><span class="hljs-type">Base</span></span>.<span class="hljs-type"><span class="hljs-type">Emitter</span></span> { /// ... <span class="hljs-type"><span class="hljs-type">Method</span></span> <span class="hljs-type"><span class="hljs-type">IsAtEnd</span></span>() <span class="hljs-type"><span class="hljs-type">As</span></span> %<span class="hljs-type"><span class="hljs-type">Boolean</span></span> { quit ($<span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">data</span></span></span><span class="hljs-class">(@</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">i</span></span></span><span class="hljs-class">%</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">GlobalName</span></span></span><span class="hljs-class">)\10)=0 } /// emit $listbuild(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">key</span></span></span><span class="hljs-class">,</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">value</span></span></span><span class="hljs-class">) </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Method</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Emit</span></span></span><span class="hljs-class">(</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">EmitList</span></span></span><span class="hljs-class">... </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">As</span></span></span><span class="hljs-class"> %</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">String</span></span></span><span class="hljs-class">) { #</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">dim</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">list</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">As</span></span></span><span class="hljs-class"> %</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">String</span></span></span><span class="hljs-class"> = "" </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">for</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">i</span></span></span><span class="hljs-class">=1:1:$</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">get</span></span></span><span class="hljs-class">(</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">EmitList</span></span></span><span class="hljs-class">) { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">set</span></span></span><span class="hljs-class"> $</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">li</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">list</span></span></span><span class="hljs-class">,</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">i</span></span></span><span class="hljs-class">) = $</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">get</span></span></span><span class="hljs-class">(</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">EmitList(i)</span></span></span><span class="hljs-class">) } #dim name </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">As</span></span></span><span class="hljs-class"> %</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">String</span></span></span><span class="hljs-class"> = ..</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">GlobalName</span></span></span><span class="hljs-class"> set @name@($</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">seq</span></span></span><span class="hljs-class">(@</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">name</span></span></span><span class="hljs-class">)) = list } /// returns emitted $lb(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">key</span></span></span><span class="hljs-class">,</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">value</span></span></span><span class="hljs-class">) </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Method</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">GetNext</span></span></span><span class="hljs-class">() </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">As</span></span></span><span class="hljs-class"> %</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">String</span></span></span><span class="hljs-class"> { #</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">dim</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">value</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">As</span></span></span><span class="hljs-class"> %</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">String</span></span></span><span class="hljs-class"> #</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">dim</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">index</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">As</span></span></span><span class="hljs-class"> %</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">String</span></span></span><span class="hljs-class"> = $</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">order</span></span></span><span class="hljs-class">(@</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">i</span></span></span><span class="hljs-class">%</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">GlobalName</span></span></span><span class="hljs-class">@(""), 1, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">value</span></span></span><span class="hljs-class">) </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">if</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">index</span></span></span><span class="hljs-class"> '= "" { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">kill</span></span></span><span class="hljs-class"> @</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">i</span></span></span><span class="hljs-class">%</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">GlobalName</span></span></span><span class="hljs-class">@(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">index</span></span></span><span class="hljs-class">) </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">quit</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">value</span></span></span><span class="hljs-class"> } else { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">kill</span></span></span><span class="hljs-class"> @</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">i</span></span></span><span class="hljs-class">%</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">GlobalName</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">quit</span></span></span><span class="hljs-class"> "" } } </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Method</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Dump</span></span></span><span class="hljs-class">() { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">zwrite</span></span></span><span class="hljs-class"> @</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">i</span></span></span><span class="hljs-class">%</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">GlobalName</span></span></span><span class="hljs-class"> } }</span></span></code> </pre> <br><p>  Hopefully, you still remember that our Emitter is a descendant of the Iterator?  Therefore, it needs to implement a couple of iterator functions - IsAtEnd and GetNext. </p><br><ul><li><p>  IsAtEnd is simple: if our service global does not contain data (ie, <a href="">$ data (.. GlobalName)</a> does not return 10 or 11, which means that there are more data nodes in the subtree), then we have reached the end of the data stream; </p><br></li><li>  Emit creates a data node at the end of the current list.  Making a pair (or a tuple, with arity more than 2x) as an element of <a href="">$ (listbuild (...))</a> [listbuild]. </li></ul><br><p>  As is well known, and as <a href="https://habrahabr.ru/company/intersystems/blog/263793/">Sasha Koblov</a> wrote well <a href="https://habrahabr.ru/company/intersystems/blog/263793/">, $ SEQUENCE</a> can be used in almost all the places where <a href="">$ INCREMENT was used</a> , while providing the best speeds when working in multiprocessor or multi-server mode (via ECP).  Due to fewer collisions when accessing a single global node.  Therefore, in the code above, we use <em>$ sequence</em> to highlight the index of the next element of the ordered list. </p><br><ul><li>  On the other side of the algorithm, in the receiver, GetNext (pull) items from the collection using the simple <a href="">$ ORDER (@ i% GlobalName ("))"</a> .  The item with the resulting index will be removed from the list after processing. </li></ul><br><blockquote>  <em>Please note that this option of removing an item from the list / global is <a href="https://community.intersystems.com/post/cach%25C3%25A9-mapreduce-basic-interfaces-mapreduce-implementation-part-ii">not very compatible with parallel mode</a> , and it would be necessary to add locks or change the data structure.</em>  <em>But since</em>  <em>for the next series, we will have only one Reducer, for the whole set of Mappers, then we will postpone the solution of this problem for the future when we begin a multi-server implementation.</em> <br><br>  Note that the data structure implemented by MR.Emitter.Ordered essentially implements the classic FIFO collection ("FirstIn - FirstOut").  We put a new item at the end of the list and pull it out of the head of the list. </blockquote><br><h3 id="specialnyy-sluchay-emitter-s-avtoagregaciey">  Special case: emitter with auto-aggregation </h3><br><p>  If you look at the data that we send in between the stages of the pipeline in the example word-count (ok, not now, but when we show you this implementation), then you quickly realize that: </p><br><ul><li><p>  In fact, we are not interested in the order in which we "emit" the pairs &lt;key, value&gt;.  Moreover, the underlying btree * repository always keeps the list of keys sorted for quick retrieval, eliminating the need to sort on the wizard, as it would have done in a classic implementation; </p><br></li><li>  And in our cases, when we write the &lt;key, 1&gt; pair on the Mapper side, we assume in Reducer their simple aggregation into a sum of units.  Those.  in the case of Cach√© ObjectScript, we would rely on using <a href="">$ INCREMENT</a> . </li></ul><br><blockquote>  <em>So why send such a large traffic of unnecessary data, if we can aggregate them even at the time of sending?</em> </blockquote><p>  This is exactly how MR.Emitter.Sorted, which is the successor of MR.Emitter.Ordered (shown above), works: </p><br><pre> <code class="hljs smalltalk">/// <span class="hljs-type"><span class="hljs-type">Emitter</span></span> which sorts by keys all emitted pairs or tuples (key, value(s)) <span class="hljs-type"><span class="hljs-type">Class</span></span> <span class="hljs-type"><span class="hljs-type">MR</span></span>.<span class="hljs-type"><span class="hljs-type">Emitter</span></span>.<span class="hljs-type"><span class="hljs-type">Sorted</span></span> <span class="hljs-type"><span class="hljs-type">Extends</span></span> <span class="hljs-type"><span class="hljs-type">MR</span></span>.<span class="hljs-type"><span class="hljs-type">Emitter</span></span>.<span class="hljs-type"><span class="hljs-type">Ordered</span></span> { <span class="hljs-type"><span class="hljs-type">Property</span></span> <span class="hljs-type"><span class="hljs-type">AutoIncrement</span></span> <span class="hljs-type"><span class="hljs-type">As</span></span> %<span class="hljs-type"><span class="hljs-type">Boolean</span></span> [ <span class="hljs-type"><span class="hljs-type">InitialExpression</span></span> = <span class="hljs-number"><span class="hljs-number">1</span></span> ]; /// emit <span class="hljs-string"><span class="hljs-string">$l</span></span>istbuild(key,value) <span class="hljs-type"><span class="hljs-type">Method</span></span> <span class="hljs-type"><span class="hljs-type">Emit</span></span>(<span class="hljs-type"><span class="hljs-type">EmitList</span></span>... <span class="hljs-type"><span class="hljs-type">As</span></span> %<span class="hljs-type"><span class="hljs-type">String</span></span>) { <span class="hljs-symbol"><span class="hljs-symbol">#dim</span></span> name <span class="hljs-type"><span class="hljs-type">As</span></span> %<span class="hljs-type"><span class="hljs-type">String</span></span> = ..<span class="hljs-type"><span class="hljs-type">GlobalName</span></span> <span class="hljs-symbol"><span class="hljs-symbol">#dim</span></span> key <span class="hljs-type"><span class="hljs-type">As</span></span> %<span class="hljs-type"><span class="hljs-type">String</span></span> <span class="hljs-symbol"><span class="hljs-symbol">#dim</span></span> value <span class="hljs-type"><span class="hljs-type">As</span></span> %<span class="hljs-type"><span class="hljs-type">String</span></span> if <span class="hljs-string"><span class="hljs-string">$g</span></span>et(<span class="hljs-type"><span class="hljs-type">EmitList</span></span>)=<span class="hljs-number"><span class="hljs-number">1</span></span> { // special case - only key name given, no value set key = <span class="hljs-string"><span class="hljs-string">$g</span></span>et(<span class="hljs-type"><span class="hljs-type">EmitList</span></span>(<span class="hljs-number"><span class="hljs-number">1</span></span>)) quit:key=<span class="hljs-comment"><span class="hljs-comment">""</span></span> if ..<span class="hljs-type"><span class="hljs-type">AutoIncrement</span></span> { <span class="hljs-symbol"><span class="hljs-symbol">#dim</span></span> dummyX <span class="hljs-type"><span class="hljs-type">As</span></span> %<span class="hljs-type"><span class="hljs-type">Integer</span></span> = <span class="hljs-string"><span class="hljs-string">$i</span></span>ncrement(@name@(key)) ; <span class="hljs-string"><span class="hljs-string">$s</span></span>eq is non-deterministic } else { set @name@(key) = <span class="hljs-number"><span class="hljs-number">1</span></span> } } else { set value = <span class="hljs-string"><span class="hljs-string">$g</span></span>et(<span class="hljs-type"><span class="hljs-type">EmitList</span></span>(<span class="hljs-type"><span class="hljs-type">EmitList</span></span>)) set <span class="hljs-type"><span class="hljs-type">EmitList</span></span> = <span class="hljs-type"><span class="hljs-type">EmitList</span></span> - <span class="hljs-number"><span class="hljs-number">1</span></span> for i=<span class="hljs-number"><span class="hljs-number">1</span></span>:<span class="hljs-number"><span class="hljs-number">1</span></span>:<span class="hljs-string"><span class="hljs-string">$g</span></span>et(<span class="hljs-type"><span class="hljs-type">EmitList</span></span>) { <span class="hljs-symbol"><span class="hljs-symbol">#dim</span></span> index <span class="hljs-type"><span class="hljs-type">As</span></span> %<span class="hljs-type"><span class="hljs-type">String</span></span> = <span class="hljs-string"><span class="hljs-string">$g</span></span>et(<span class="hljs-type"><span class="hljs-type">EmitList</span></span>(i)) quit:index=<span class="hljs-comment"><span class="hljs-comment">""</span></span> set name = <span class="hljs-string"><span class="hljs-string">$n</span></span>ame(@name@(index)) } if ..<span class="hljs-type"><span class="hljs-type">AutoIncrement</span></span> { <span class="hljs-symbol"><span class="hljs-symbol">#dim</span></span> dummyY <span class="hljs-type"><span class="hljs-type">As</span></span> %<span class="hljs-type"><span class="hljs-type">Integer</span></span> = <span class="hljs-string"><span class="hljs-string">$i</span></span>ncrement(@name,value) } else { set @name = value } } } /// ... }</code> </pre> <br><p>  For the simplest case, issuing the &lt;key, 1&gt; pair or, when the value is omitted, and has one key &lt;key&gt; we implemented local optimization, when in the auto increment mode (AutoIncrement = 1), we immediately increment the corresponding counter for the key when we call it.  If autoincrement is not enabled, then we simply (re) define the key node to 1, fixing the fact of key transfer. </p><br><p>  For a more general case, with two elements, key-value pairs &lt;key, value&gt; or even with a large number of &lt;key, key2, key3, ... keyn, value&gt; elements (a tuple of any arity), we again implemented 2 modes of operation: </p><br><ul><li><p>  with <em>autoincrement,</em> we immediately sum the value of the corresponding node addressed by the key (s) with the transmitted value; </p><br></li><li>  and <em>without auto</em> - <em>increment</em> - we assign the transmitted value to the corresponding node addressed by this key list. </li></ul><br><p>  Note that we are passing a tuple by means of an array accumulating a variable number of arguments.  All elements of this array except the last, will go as addresses of <a href="">sub-indices</a> .  The last element of the tuple will be considered a value. </p><br><blockquote>  <em>Such an unusual extension of a key-value pair in tuples of any capacity, to our knowledge, is atypical or may be unique.</em>  <em>We do not need to work with a strict key-value repository or bigtable repository, and we can easily work with multidimensional keys in the transmitted elements ("because we can"), which can greatly facilitate some implementations of algorithms that require additional data dimensionality, which greatly improves code readability and ease of understanding.</em>  <em>In theory...</em> </blockquote><p>  Note that we did not redefine IsAtEnd and it inherited the implementation from MR.Emitter.Ordered, so it will still return a non-zero value at the end of the data in the intermediate storage sub-nodes. </p><br><p>  But we need to redefine GetNext, since  we no longer try to remember the order of the data sent and the format of its internal storage has changed: </p><br><pre> <code class="hljs ruby">Class MR.Emitter.Sorted Extends MR.Emitter.Ordered { <span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">/ ... /</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span> returns emitted $lb(key,value) Method GetNext() As %String { <span class="hljs-comment"><span class="hljs-comment">#dim name As %String = ..GlobalName #dim value As %String #dim ref As %String = $query(</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@name</span></span></span><span class="hljs-comment">,1,value) if ref'="" { zkill </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@ref</span></span></span><span class="hljs-comment"> #dim i As %Integer #dim refLen As %Integer = $qlength(ref) #dim baseLen As %Integer = $qlength(name) #dim listbuild = "" for i=baseLen+1:1:refLen { set $li(listbuild,i-baseLen)=$qs(ref,i) } set $li(listbuild,*+1)=value quit listbuild } quit "" } }</span></span></code> </pre><br><p>  At the exit of GetNext (), we expect a <a href="">$ LISTBUILD &lt;&gt;</a> list, but inside the repository the data of pairs / tuples are scattered across the nodes of the hierarchical repository.  The <a href="">$ QUERY</a> function allows you to bypass nodes with data (pairs / tuples values) in an array for subsequent repacking in the $ LISTBUILD format, indexes from the array are sequentially added to the next list item (by assigning an element through the <a href="">$ LIST</a> function. The value of the storage node itself the key-value pair or the last element of the tuple will be added to the end of the generated list using the same $ LIST function (listbuild, * + 1). In this case, * + 1 will indicate the number of the list item following the current end. </p><br><blockquote>  <em>At this unexpected place, we interrupt our story about MapReduce in Cach√©.</em>  <em>In the second part of this narration, we showed the basic interfaces of the infrastructure, which will be used later in the implementation of concrete examples.</em>  <em>Already in the next series we will put it all together and implement the classic WordCount example, but already in ObjectScript.</em>  <em>Do not go far!</em> </blockquote></div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <p>Source: <a href="https://habr.com/ru/post/310196/">https://habr.com/ru/post/310196/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../310180/index.html">What is such a Data? Or again about MapReduce</a></li>
<li><a href="../310182/index.html">The problem of dissonance between the narrative and the gameplay</a></li>
<li><a href="../310186/index.html">Responsive Font Size</a></li>
<li><a href="../310188/index.html">Registration is now open for Russia's first international Testathon</a></li>
<li><a href="../310192/index.html">Another way to get around PornHub lock</a></li>
<li><a href="../310198/index.html">8 signs of infantilism in business</a></li>
<li><a href="../310200/index.html">We implement Brotli with the help of Nginx - we save bytes almost for free</a></li>
<li><a href="../310202/index.html">Installing your SSL certificates on the D-Link DNS-320L file storage</a></li>
<li><a href="../310204/index.html">New plugin from Stepik.org for IntelliJ IDEA</a></li>
<li><a href="../310206/index.html">How I spent the holidays on my first application</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>