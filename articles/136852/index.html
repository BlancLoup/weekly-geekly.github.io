<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>PostgreSQL: Unique keys for a distributed database. Practice</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="In the wake of the article "Unique key in a distributed database . " 

 We have a base that we want to share. In the ideal case, I want to make a mast...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>PostgreSQL: Unique keys for a distributed database. Practice</h1><div class="post__text post__text-html js-mediator-article">  In the wake of the article <a href="http://habrahabr.ru/blogs/webdev/135364/">"Unique key in a distributed database</a> . <a href="http://habrahabr.ru/blogs/webdev/135364/">"</a> <br><br>  We have a base that we want to share.  In the ideal case, I want to make a master-master.  One of the most difficult moments is ensuring the uniqueness of the keys on all servers.  And it is good if the base was originally designed with regard to scaling ... Again, this is something from the domain of the ideal that occurs, let's say, not often. <br><br>  So, we have a base that needs to be prepared for master-master synchronization - we will make all the keys in our database unique within the project. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      The mentioned article considered several options, but we will focus on one suggested <a href="http://instagram-engineering.tumblr.com/post/10853187575/sharding-ids-at-instagram">Instagram</a> <br><a name="habracut"></a><br><h4>  Step 1 - Translation of all keys in <i>bigint</i> </h4><br>  This implies that all our primary keys are called id, and accordingly the fields that refer to these keys are named like this: order_id, client_id, table_id ... <br><br>  Create a function that converts the <i>integer</i> field to <i>bigint</i> <br><pre><code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">DROP</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FUNCTION</span></span> <span class="hljs-keyword"><span class="hljs-keyword">IF</span></span> <span class="hljs-keyword"><span class="hljs-keyword">EXISTS</span></span> <span class="hljs-string"><span class="hljs-string">"field_int2big"</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">field</span></span> <span class="hljs-built_in"><span class="hljs-built_in">text</span></span>, tablename <span class="hljs-built_in"><span class="hljs-built_in">text</span></span>, table_schema <span class="hljs-built_in"><span class="hljs-built_in">text</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">OR</span></span> <span class="hljs-keyword"><span class="hljs-keyword">REPLACE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FUNCTION</span></span> <span class="hljs-string"><span class="hljs-string">"field_int2big"</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">field</span></span> <span class="hljs-built_in"><span class="hljs-built_in">text</span></span>, tablename <span class="hljs-built_in"><span class="hljs-built_in">text</span></span>, table_schema <span class="hljs-built_in"><span class="hljs-built_in">text</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">RETURNS</span></span> <span class="hljs-built_in"><span class="hljs-built_in">bigint</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> $<span class="hljs-keyword"><span class="hljs-keyword">body</span></span>$ <span class="hljs-keyword"><span class="hljs-keyword">DECLARE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BEGIN</span></span> <span class="hljs-keyword"><span class="hljs-keyword">EXECUTE</span></span> <span class="hljs-string"><span class="hljs-string">'ALTER TABLE '</span></span>|| table_schema || <span class="hljs-string"><span class="hljs-string">'."'</span></span>|| tablename || <span class="hljs-string"><span class="hljs-string">'" ALTER COLUMN "'</span></span>|| <span class="hljs-keyword"><span class="hljs-keyword">field</span></span> || <span class="hljs-string"><span class="hljs-string">'" TYPE bigint;'</span></span> ; return 1; <span class="hljs-keyword"><span class="hljs-keyword">END</span></span>; $body$ LANGUAGE 'plpgsql';</code> </pre> <br><br>  Then we select all <i>integer</i> fields and convert them: <br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">select</span></span> *, field_int2big(column_name, table_name, table_schema) <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">select</span></span> table_catalog, table_schema, table_name, column_name, data_type <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> information_schema.columns <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> table_schema <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> (<span class="hljs-string"><span class="hljs-string">'public'</span></span>, <span class="hljs-string"><span class="hljs-string">'myscheme'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> data_type <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> (<span class="hljs-string"><span class="hljs-string">'integer'</span></span>, <span class="hljs-string"><span class="hljs-string">'oid'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">position</span></span>(<span class="hljs-string"><span class="hljs-string">'id'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> column_name)&gt;<span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">OR</span></span> column_name <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> (<span class="hljs-string"><span class="hljs-string">'key'</span></span>, <span class="hljs-string"><span class="hljs-string">'myfield'</span></span>)) <span class="hljs-keyword"><span class="hljs-keyword">order</span></span> <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> table_catalog, table_schema, table_name, column_name <span class="hljs-keyword"><span class="hljs-keyword">limit</span></span> <span class="hljs-number"><span class="hljs-number">10</span></span> <span class="hljs-keyword"><span class="hljs-keyword">offset</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>) c</code> </pre><br>  A few things to look out for: <br><ol><li>  You can / should add your schemes: <i>table_schema in ('public', 'myscheme')</i> </li><li>  You can also add your own fields named not ‚Äústandard‚Äù: <i>column_name in ('key', 'myfield')</i> </li><li>  Pay attention to <i>limit 10</i> for large bases of tables. You need to reduce it up to 1 - changing the type takes time and is not small </li><li>  The query must be run several times, each time it will find the remaining non-translated fields. </li></ol><br><br><h4>  Step 2 - Translation of functional indexes in which there is a direct type indication </h4><br>  In general, if this is not done, it will bring problems in the future, they are extremely difficult to detect: it gives an error that is not visible in the executable query. <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">DROP</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FUNCTION</span></span> <span class="hljs-keyword"><span class="hljs-keyword">IF</span></span> <span class="hljs-keyword"><span class="hljs-keyword">EXISTS</span></span> <span class="hljs-string"><span class="hljs-string">"index_int2big"</span></span> (idx <span class="hljs-built_in"><span class="hljs-built_in">text</span></span>, declare_idx <span class="hljs-built_in"><span class="hljs-built_in">text</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">OR</span></span> <span class="hljs-keyword"><span class="hljs-keyword">REPLACE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FUNCTION</span></span> <span class="hljs-string"><span class="hljs-string">"index_int2big"</span></span> (idx <span class="hljs-built_in"><span class="hljs-built_in">text</span></span>, declare_idx <span class="hljs-built_in"><span class="hljs-built_in">text</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">RETURNS</span></span> <span class="hljs-built_in"><span class="hljs-built_in">text</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> $<span class="hljs-keyword"><span class="hljs-keyword">body</span></span>$ <span class="hljs-keyword"><span class="hljs-keyword">DECLARE</span></span> new_idx <span class="hljs-built_in"><span class="hljs-built_in">text</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">BEGIN</span></span> <span class="hljs-keyword"><span class="hljs-keyword">EXECUTE</span></span> <span class="hljs-string"><span class="hljs-string">'DROP INDEX IF EXISTS '</span></span> || idx; <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">replace</span></span>(declare_idx, <span class="hljs-string"><span class="hljs-string">'integer'</span></span>, <span class="hljs-string"><span class="hljs-string">'bigint'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">INTO</span></span> new_idx; <span class="hljs-keyword"><span class="hljs-keyword">EXECUTE</span></span> new_idx ; return new_idx; <span class="hljs-keyword"><span class="hljs-keyword">END</span></span>; $body$ LANGUAGE 'plpgsql'; <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> *, index_int2big(indname, inddef) <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> n.nspname <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> table_schema, c.relname <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> table_name, c2.relname <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> indname, i.indisprimary, i.indisunique, i.indisclustered, pg_catalog.pg_get_indexdef(i.indexrelid, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-literal"><span class="hljs-literal">true</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> inddef <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> pg_catalog.pg_class c, pg_catalog.pg_class c2, pg_catalog.pg_index i, pg_namespace n <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> n.oid=c.relnamespace <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> c.oid = i.indrelid <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> i.indexrelid = c2.oid <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> n.nspname <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> (<span class="hljs-string"><span class="hljs-string">'bucardo'</span></span>, <span class="hljs-string"><span class="hljs-string">'public'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> <span class="hljs-keyword"><span class="hljs-keyword">position</span></span>(<span class="hljs-string"><span class="hljs-string">'integer'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> pg_catalog.pg_get_indexdef(i.indexrelid, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-literal"><span class="hljs-literal">true</span></span>))&gt;<span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">limit</span></span> <span class="hljs-number"><span class="hljs-number">10</span></span> <span class="hljs-keyword"><span class="hljs-keyword">offset</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>) c</code> </pre><br>  You may notice that I check in the bucardo scheme.  If you already have synchronization based on this technology, then this step becomes extremely important.  See also note from last step. <br><br><h4>  Step 3 - Creating New Sequences for All Key Fields </h4><br>  In the proposed Instagram version uses a unique number for each scheme / server. <br>  those.  it is necessary to have in each scheme its own function with its unique number. <br>  I slightly changed the function and generate a unique key by the server IP. <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">OR</span></span> <span class="hljs-keyword"><span class="hljs-keyword">REPLACE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FUNCTION</span></span> inet2num(inet) <span class="hljs-keyword"><span class="hljs-keyword">RETURNS</span></span> <span class="hljs-built_in"><span class="hljs-built_in">numeric</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> $$ <span class="hljs-keyword"><span class="hljs-keyword">DECLARE</span></span> a <span class="hljs-built_in"><span class="hljs-built_in">text</span></span>[] := string_to_array(host($<span class="hljs-number"><span class="hljs-number">1</span></span>), <span class="hljs-string"><span class="hljs-string">'.'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">BEGIN</span></span> <span class="hljs-keyword"><span class="hljs-keyword">RETURN</span></span> a[<span class="hljs-number"><span class="hljs-number">1</span></span>]::<span class="hljs-built_in"><span class="hljs-built_in">numeric</span></span> * <span class="hljs-number"><span class="hljs-number">16777216</span></span> + a[<span class="hljs-number"><span class="hljs-number">2</span></span>]::<span class="hljs-built_in"><span class="hljs-built_in">numeric</span></span> * <span class="hljs-number"><span class="hljs-number">65536</span></span> + a[<span class="hljs-number"><span class="hljs-number">3</span></span>]::<span class="hljs-built_in"><span class="hljs-built_in">numeric</span></span> * <span class="hljs-number"><span class="hljs-number">256</span></span> + a[<span class="hljs-number"><span class="hljs-number">4</span></span>]::<span class="hljs-built_in"><span class="hljs-built_in">numeric</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">END</span></span>; $$ LANGUAGE plpgsql IMMUTABLE STRICT; <span class="hljs-keyword"><span class="hljs-keyword">DROP</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FUNCTION</span></span> <span class="hljs-keyword"><span class="hljs-keyword">IF</span></span> <span class="hljs-keyword"><span class="hljs-keyword">EXISTS</span></span> next_id(tbl <span class="hljs-built_in"><span class="hljs-built_in">text</span></span>, tableschema <span class="hljs-built_in"><span class="hljs-built_in">text</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">OR</span></span> <span class="hljs-keyword"><span class="hljs-keyword">REPLACE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FUNCTION</span></span> next_id(tbl <span class="hljs-built_in"><span class="hljs-built_in">text</span></span>, tableschema <span class="hljs-built_in"><span class="hljs-built_in">text</span></span> = <span class="hljs-string"><span class="hljs-string">'public'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">returns</span></span> <span class="hljs-built_in"><span class="hljs-built_in">bigint</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> $$ <span class="hljs-keyword"><span class="hljs-keyword">DECLARE</span></span> our_epoch <span class="hljs-built_in"><span class="hljs-built_in">bigint</span></span> := <span class="hljs-number"><span class="hljs-number">1314220021721</span></span>; seq_id bigint; now_millis bigint; shard_id bigint; result bigint; <span class="hljs-keyword"><span class="hljs-keyword">BEGIN</span></span> <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">nextval</span></span>(tableschema||<span class="hljs-string"><span class="hljs-string">'."'</span></span> || tbl || <span class="hljs-string"><span class="hljs-string">'_id_seq"'</span></span>) % <span class="hljs-number"><span class="hljs-number">1024</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INTO</span></span> seq_id; <span class="hljs-comment"><span class="hljs-comment">/* select substring(regexp_replace(md5(current_database()||inet_server_addr()||version()), '[^\\\d]+', '', 'g')::text from 1 for 6)::int into shard_id;*/</span></span> <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> inet2num(inet_server_addr()) <span class="hljs-keyword"><span class="hljs-keyword">into</span></span> shard_id; <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FLOOR</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">EXTRACT</span></span>(EPOCH <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> clock_timestamp()) * <span class="hljs-number"><span class="hljs-number">1000</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">INTO</span></span> now_millis; result := (now_millis - our_epoch) &lt;&lt; 23; result := result | (shard_id &lt;&lt; 10); result := result | (seq_id); RETURN result; <span class="hljs-keyword"><span class="hljs-keyword">END</span></span>; $$ LANGUAGE PLPGSQL;</code> </pre><br><br>  Now we have to call it on all our identifiers: <br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">DROP</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FUNCTION</span></span> <span class="hljs-keyword"><span class="hljs-keyword">IF</span></span> <span class="hljs-keyword"><span class="hljs-keyword">EXISTS</span></span> <span class="hljs-string"><span class="hljs-string">"reset_nextid"</span></span> (tablename <span class="hljs-built_in"><span class="hljs-built_in">text</span></span>, tableschema <span class="hljs-built_in"><span class="hljs-built_in">text</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">OR</span></span> <span class="hljs-keyword"><span class="hljs-keyword">REPLACE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FUNCTION</span></span> <span class="hljs-string"><span class="hljs-string">"reset_nextid"</span></span> (tablename <span class="hljs-built_in"><span class="hljs-built_in">text</span></span>, tableschema <span class="hljs-built_in"><span class="hljs-built_in">text</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">RETURNS</span></span> <span class="hljs-built_in"><span class="hljs-built_in">bigint</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> $<span class="hljs-keyword"><span class="hljs-keyword">body</span></span>$ <span class="hljs-keyword"><span class="hljs-keyword">DECLARE</span></span> id_type <span class="hljs-built_in"><span class="hljs-built_in">text</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">BEGIN</span></span> <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> data_type <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> information_schema.columns c <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> <span class="hljs-string"><span class="hljs-string">"table_schema"</span></span>=tableschema <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> <span class="hljs-string"><span class="hljs-string">"table_name"</span></span>=tablename <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> column_name=<span class="hljs-string"><span class="hljs-string">'id'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INTO</span></span> id_type; IF id_type &lt;&gt; 'bigint' THEN <span class="hljs-keyword"><span class="hljs-keyword">EXECUTE</span></span> <span class="hljs-string"><span class="hljs-string">'ALTER TABLE '</span></span>|| tableschema || <span class="hljs-string"><span class="hljs-string">'."'</span></span>|| tablename || <span class="hljs-string"><span class="hljs-string">'" ALTER COLUMN id TYPE bigint;'</span></span> ; <span class="hljs-keyword"><span class="hljs-keyword">END</span></span> <span class="hljs-keyword"><span class="hljs-keyword">IF</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">EXECUTE</span></span> <span class="hljs-string"><span class="hljs-string">'ALTER TABLE '</span></span>|| tableschema || <span class="hljs-string"><span class="hljs-string">'."'</span></span>|| tablename || <span class="hljs-string"><span class="hljs-string">'" ALTER COLUMN id SET DEFAULT next_id('''</span></span>|| tablename || <span class="hljs-string"><span class="hljs-string">''', '''</span></span>|| tableschema || <span class="hljs-string"><span class="hljs-string">''');'</span></span>; return next_id(tablename, tableschema); <span class="hljs-keyword"><span class="hljs-keyword">END</span></span>; $body$ LANGUAGE 'plpgsql'; <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> t.*, reset_nextid(table_name, table_schema) <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> ( <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> t.table_schema, t.table_name, sequence_name, c.column_name <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> information_schema.sequences s <span class="hljs-keyword"><span class="hljs-keyword">left</span></span> <span class="hljs-keyword"><span class="hljs-keyword">join</span></span> information_schema.tables t <span class="hljs-keyword"><span class="hljs-keyword">on</span></span> split_part(sequence_name, <span class="hljs-string"><span class="hljs-string">'_id_seq'</span></span>,<span class="hljs-number"><span class="hljs-number">1</span></span>)=table_name <span class="hljs-keyword"><span class="hljs-keyword">left</span></span> <span class="hljs-keyword"><span class="hljs-keyword">join</span></span> information_schema.columns c <span class="hljs-keyword"><span class="hljs-keyword">on</span></span> (t.table_schema=c.table_schema <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> t.table_name=c.table_name <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> c.column_name=<span class="hljs-string"><span class="hljs-string">'id'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> c.column_name <span class="hljs-keyword"><span class="hljs-keyword">is</span></span> <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span> <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> <span class="hljs-keyword"><span class="hljs-keyword">position</span></span>(<span class="hljs-string"><span class="hljs-string">'next_id'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> c.column_default)&lt;&gt;<span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> s.sequence_schema=t.table_schema <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> t.table_schema <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> (<span class="hljs-string"><span class="hljs-string">'public'</span></span>, <span class="hljs-string"><span class="hljs-string">'acc'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">order</span></span> <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> t.table_schema, t.table_name <span class="hljs-keyword"><span class="hljs-keyword">limit</span></span> <span class="hljs-number"><span class="hljs-number">50</span></span> <span class="hljs-keyword"><span class="hljs-keyword">offset</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> ) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> t</code> </pre><br><br>  Because  we have already changed the type of identifier to bigint - the request should work quickly. <br><br>  We have completed the training on this, our base is working and is ready to work in parallel. <br><br><h6>  Bonus </h6><br>  If something went wrong with next_id, you can return to the standard sequences: <br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">OR</span></span> <span class="hljs-keyword"><span class="hljs-keyword">REPLACE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FUNCTION</span></span> <span class="hljs-string"><span class="hljs-string">"restore_nextval"</span></span> (tablename <span class="hljs-built_in"><span class="hljs-built_in">text</span></span>, tableschema <span class="hljs-built_in"><span class="hljs-built_in">text</span></span> = <span class="hljs-string"><span class="hljs-string">'public'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">RETURNS</span></span> <span class="hljs-built_in"><span class="hljs-built_in">bigint</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> $<span class="hljs-keyword"><span class="hljs-keyword">body</span></span>$ <span class="hljs-keyword"><span class="hljs-keyword">DECLARE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BEGIN</span></span> <span class="hljs-keyword"><span class="hljs-keyword">EXECUTE</span></span> <span class="hljs-string"><span class="hljs-string">'ALTER TABLE '</span></span>|| tableschema || <span class="hljs-string"><span class="hljs-string">'."'</span></span>|| tablename || <span class="hljs-string"><span class="hljs-string">'" ALTER COLUMN id SET DEFAULT nextval('''</span></span>|| tablename || <span class="hljs-string"><span class="hljs-string">'_id_seq''::regclass);'</span></span>; return nextval((tableschema || '."'|| tablename || '_id_seq"')::regclass); <span class="hljs-keyword"><span class="hljs-keyword">END</span></span>; $body$ LANGUAGE 'plpgsql'; <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> t.*, restore_nextval(table_name, table_schema) <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> ( <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> t.table_schema, t.table_name, sequence_name, c.column_name <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> information_schema.sequences s <span class="hljs-keyword"><span class="hljs-keyword">left</span></span> <span class="hljs-keyword"><span class="hljs-keyword">join</span></span> information_schema.tables t <span class="hljs-keyword"><span class="hljs-keyword">on</span></span> split_part(sequence_name, <span class="hljs-string"><span class="hljs-string">'_id_seq'</span></span>,<span class="hljs-number"><span class="hljs-number">1</span></span>)=table_name <span class="hljs-keyword"><span class="hljs-keyword">left</span></span> <span class="hljs-keyword"><span class="hljs-keyword">join</span></span> information_schema.columns c <span class="hljs-keyword"><span class="hljs-keyword">on</span></span> (t.table_schema=c.table_schema <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> t.table_name=c.table_name <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> c.column_name=<span class="hljs-string"><span class="hljs-string">'id'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> c.column_name <span class="hljs-keyword"><span class="hljs-keyword">is</span></span> <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span> <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> <span class="hljs-keyword"><span class="hljs-keyword">position</span></span>(<span class="hljs-string"><span class="hljs-string">'next_id'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> c.column_default)&gt;<span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> s.sequence_schema=t.table_schema <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> t.table_schema <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> (<span class="hljs-string"><span class="hljs-string">'public'</span></span>, <span class="hljs-string"><span class="hljs-string">'acc'</span></span>)</code> </pre><br><br>  Thank.  I hope someone was helpful. <br><br>  PS Do not try to do it on a 32 bit server.  Update server first.  And the application server too. </div><p>Source: <a href="https://habr.com/ru/post/136852/">https://habr.com/ru/post/136852/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../136847/index.html">What is the "git push problem: non fast forward"</a></li>
<li><a href="../136848/index.html">Where Apple iCloud Stores Your Files</a></li>
<li><a href="../136849/index.html">Small life hacking with clipboard editing</a></li>
<li><a href="../136850/index.html">Welcome to our office</a></li>
<li><a href="../136851/index.html">Root on Lenovo ThinkPad Tablet</a></li>
<li><a href="../136853/index.html">Restore defocused and blurred images</a></li>
<li><a href="../136855/index.html">API maps from 2GIS: review</a></li>
<li><a href="../136858/index.html">Japanese operator shows ads in the alert zone on their Android phones</a></li>
<li><a href="../136859/index.html">Anonymous will launch their MegaUpload</a></li>
<li><a href="../136860/index.html">Open letter to JS leaders regarding semicolons</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>