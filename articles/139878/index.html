<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>We write a simple web terminal emulator for PHP</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="I think a lot of people thought about making their terminal emulator in PHP, and usually stopped at solutions like the following: 


<?php echo '<form...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>We write a simple web terminal emulator for PHP</h1><div class="post__text post__text-html js-mediator-article">  I think a lot of people thought about making their terminal emulator in PHP, and usually stopped at solutions like the following: <br><pre><code class="php hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?php</span></span> <span class="hljs-keyword"><span class="hljs-keyword">echo</span></span> <span class="hljs-string"><span class="hljs-string">'&lt;form&gt;&lt;input name="cmd" /&gt;&lt;/form&gt;'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">isset</span></span>($_GET[<span class="hljs-string"><span class="hljs-string">'cmd'</span></span>])) system($_GET[<span class="hljs-string"><span class="hljs-string">'cmd'</span></span>]);</code> </pre> <br>  Of course, such a solution causes a whole set of problems, the most insignificant of which is that the errors on the screen do not fall.  There are much more significant things, for example, starting vi simply ‚Äúhangs up‚Äù the execution of the command and you have to open a new console and write <code>killall vi</code> .  And what certainly can‚Äôt be done is to execute ssh or sudo commands that require reading the password directly from the terminal.  I will try to show a way with which you can eliminate most of the problems described above. <br><a name="habracut"></a><br><h4>  Writing a plain terminal emulator in PHP </h4><br>  For our terminal emulator you will need: <br><ul><li>  PHP <b>5.2+</b> (with a file - PHP 4.3+) </li><li>  Working system () and proc_open () functions </li><li>  Working <b>flush ()</b> function ( <a href="http://habrahabr.ru/blogs/php/139878/"><b>flush () for nginx</b></a> ) </li><li>  term.js and utils.js <a href="http://bellard.org/jslinux/">from the <b>JSLinux</b> project</a> </li><li>  Linux, Mac OS X on the server side (I didn‚Äôt check it on BSD, it may need some work) </li></ul><br>  Perhaps, having seen the link to JSLinux, you have already begun to guess what we are going to do;). <br><br><h4>  The main idea of ‚Äã‚Äãimplementation </h4><br>  The PHP documentation says that proc_open () is intended for two-way communication with processes, so we will open bash interactively using this function and will continue to work with it.  Unfortunately, there is no support for pseudo terminals in PHP out of the box, so we will write the implementation of the required layer in C. <br><br>  Any protection, as well as checks for errors and correct terminal completion in this example are <b>not supposed (!)</b> , You will have to think about it yourself;). 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h4>  <b>File shell.php</b> </h4><br><br><h5>  Getting user input </h5><br>  We must somehow receive input from the user, for example, through a FIFO file: <br><br><pre> <code class="php hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?php</span></span> $temp_fifo_file = <span class="hljs-string"><span class="hljs-string">'/tmp/dolphin-pipe-'</span></span>.uniqid(<span class="hljs-string"><span class="hljs-string">'dolph'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!posix_mkfifo($temp_fifo_file, <span class="hljs-number"><span class="hljs-number">0600</span></span>)) { <span class="hljs-keyword"><span class="hljs-keyword">echo</span></span> <span class="hljs-string"><span class="hljs-string">"Fatal error: Cannot create fifo file: something wrong with the system.\n"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">exit</span></span>(<span class="hljs-number"><span class="hljs-number">1</span></span>); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">deleteTempFifo</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ unlink($GLOBALS[<span class="hljs-string"><span class="hljs-string">'temp_fifo'</span></span>]); } register_shutdown_function(<span class="hljs-string"><span class="hljs-string">'deleteTempFifo'</span></span>); $cmdfp = fopen($temp_fifo_file, <span class="hljs-string"><span class="hljs-string">'r+'</span></span>); stream_set_blocking($cmdfp, <span class="hljs-number"><span class="hljs-number">0</span></span>);</code> </pre><br><h5>  Setting environment variables for the terminal </h5><br>  JSLinux works in vt100 emulation mode, we will also do the same :) <br><br><pre> <code class="php hljs">putenv(<span class="hljs-string"><span class="hljs-string">'TERM=vt100'</span></span>); $cols = <span class="hljs-number"><span class="hljs-number">80</span></span>; <span class="hljs-comment"><span class="hljs-comment">//    ,  - $rows = 24;</span></span></code> </pre><br><h5>  Command to run bash </h5><br>  Basically, we can just run " <code>bash -i</code> ", and this will work (even " <code>sh -i</code> " will work), but even better, if we can work through a pseudo-terminal, the programs will behave more "naturally" in this case .  At the same time, we can use our bashrc, in which we will configure a color invitation :). <br><br><pre> <code class="php hljs">chdir(dirname(<span class="hljs-keyword"><span class="hljs-keyword">__FILE__</span></span>)); $cmd = <span class="hljs-string"><span class="hljs-string">"bash --rcfile ./bashrc -i 2&gt;&amp;1"</span></span>; <span class="hljs-comment"><span class="hljs-comment">//         (pt.c,   ) //    ,       if (!file_exists('pt')) { system('cc -D__'.strtoupper(trim(`uname`)).'__ -o pt pt.c -lutil 2&gt;&amp;1', $retval); if ($retval) echo('&lt;b&gt;Warning:&lt;/b&gt; Cannot compile pseudotty helper'); } clearstatcache(); if (file_exists('pt')) $cmd = "./pt $rows $cols $cmd"; $pp = proc_open($cmd, array(array('pipe','r'), array('pipe', 'w')), $pipes); stream_set_blocking($pipes[0], 0); stream_set_blocking($pipes[1], 0); </span><span class="hljs-meta"><span class="hljs-comment"><span class="hljs-meta">?&gt;</span></span></span></span></code> </pre><br><h5>  Sending commands from javascript </h5><br>  We will do one HTTP request per character (or more characters if the server ‚Äúdoes not have time‚Äù).  Yes, this may be an unjustified waste of resources in this case, and you can do everything through web sockets, but in terms of implementation, my scheme is much simpler :). <br><br><pre> <code class="html hljs xml"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">html</span></span></span><span class="hljs-tag">&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">head</span></span></span><span class="hljs-tag">&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">title</span></span></span><span class="hljs-tag">&gt;</span></span>Terminal<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">title</span></span></span><span class="hljs-tag">&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">head</span></span></span><span class="hljs-tag">&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">body</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag">&gt;</span></span><span class="actionscript"><span class="actionscript"> </span><span class="hljs-keyword"><span class="actionscript"><span class="hljs-keyword">var</span></span></span><span class="actionscript"> pipeName = &lt;?=json_encode($temp_fifo_file)?&gt;, pending_str = </span><span class="hljs-string"><span class="actionscript"><span class="hljs-string">''</span></span></span><span class="actionscript">, processing = </span><span class="hljs-literal"><span class="actionscript"><span class="hljs-literal">false</span></span></span><span class="actionscript">; </span><span class="hljs-keyword"><span class="actionscript"><span class="hljs-keyword">var</span></span></span><span class="actionscript"> sendCmdInterv = setInterval(</span><span class="hljs-function"><span class="hljs-keyword"><span class="actionscript"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span></span><span class="hljs-params"><span class="actionscript"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span><span class="actionscript"><span class="hljs-function"> </span></span></span><span class="actionscript">{ </span><span class="hljs-keyword"><span class="actionscript"><span class="hljs-keyword">if</span></span></span><span class="actionscript"> (processing) </span><span class="hljs-keyword"><span class="actionscript"><span class="hljs-keyword">return</span></span></span><span class="actionscript">; </span><span class="hljs-keyword"><span class="actionscript"><span class="hljs-keyword">if</span></span></span><span class="actionscript"> (pending_str.length) { processing = </span><span class="hljs-literal"><span class="actionscript"><span class="hljs-literal">true</span></span></span><span class="actionscript">; </span><span class="hljs-keyword"><span class="actionscript"><span class="hljs-keyword">var</span></span></span><span class="actionscript"> previous_str = pending_str; pending_str = </span><span class="hljs-string"><span class="actionscript"><span class="hljs-string">''</span></span></span><span class="actionscript">; </span><span class="hljs-keyword"><span class="actionscript"><span class="hljs-keyword">var</span></span></span><span class="actionscript"> http = </span><span class="hljs-keyword"><span class="actionscript"><span class="hljs-keyword">new</span></span></span><span class="actionscript"> XMLHttpRequest(); http.open(</span><span class="hljs-string"><span class="actionscript"><span class="hljs-string">"GET"</span></span></span><span class="actionscript">, </span><span class="hljs-string"><span class="actionscript"><span class="hljs-string">"send-cmd.php?pipe="</span></span></span><span class="actionscript"> + pipeName + </span><span class="hljs-string"><span class="actionscript"><span class="hljs-string">"&amp;cmd="</span></span></span><span class="actionscript"> + encodeURIComponent(previous_str), </span><span class="hljs-literal"><span class="actionscript"><span class="hljs-literal">true</span></span></span><span class="actionscript">); http.onreadystatechange = </span><span class="hljs-function"><span class="hljs-keyword"><span class="actionscript"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span></span><span class="hljs-params"><span class="actionscript"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span><span class="actionscript"><span class="hljs-function"> </span></span></span><span class="actionscript">{ </span><span class="hljs-keyword"><span class="actionscript"><span class="hljs-keyword">if</span></span></span><span class="actionscript"> (http.readyState == </span><span class="hljs-number"><span class="actionscript"><span class="hljs-number">4</span></span></span><span class="actionscript"> &amp;&amp; http.status == </span><span class="hljs-number"><span class="actionscript"><span class="hljs-number">200</span></span></span><span class="actionscript">) { processing = </span><span class="hljs-literal"><span class="actionscript"><span class="hljs-literal">false</span></span></span><span class="actionscript">; pending_str = </span><span class="hljs-string"><span class="actionscript"><span class="hljs-string">''</span></span></span><span class="actionscript">; } </span><span class="hljs-keyword"><span class="actionscript"><span class="hljs-keyword">else</span></span></span><span class="actionscript"> { pending_str = previous_str + pending_str; } }; http.send(</span><span class="hljs-literal"><span class="actionscript"><span class="hljs-literal">null</span></span></span><span class="actionscript">); } }, </span><span class="hljs-number"><span class="actionscript"><span class="hljs-number">16</span></span></span><span class="actionscript">); </span><span class="hljs-function"><span class="hljs-keyword"><span class="actionscript"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span></span><span class="actionscript"><span class="hljs-function"> </span></span><span class="hljs-title"><span class="actionscript"><span class="hljs-function"><span class="hljs-title">send_cmd</span></span></span></span><span class="hljs-params"><span class="actionscript"><span class="hljs-function"><span class="hljs-params">(val)</span></span></span></span><span class="actionscript"><span class="hljs-function"> </span></span></span><span class="actionscript">{ pending_str += val; } </span></span><span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre><br><br><h5>  Javascript terminal emulator </h5><br>  There are a lot of different useful parts in JSLinux, in this case it's a terminal emulator.  The author forbids the distribution and modification of the term.js file without his knowledge, so in this example we will simply refer to its library :) and use it as is. <br><br><pre> <code class="html hljs xml"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">style</span></span></span><span class="hljs-tag">&gt;</span></span><span class="css"><span class="css"> </span><span class="hljs-selector-class"><span class="css"><span class="hljs-selector-class">.term</span></span></span><span class="css"> { </span><span class="hljs-attribute"><span class="css"><span class="hljs-attribute">font-family</span></span></span><span class="css">: monaco,courier,fixed,monospace,swiss,sans-serif; </span><span class="hljs-attribute"><span class="css"><span class="hljs-attribute">font-size</span></span></span><span class="css">: </span><span class="hljs-number"><span class="css"><span class="hljs-number">13px</span></span></span><span class="css">; </span><span class="hljs-attribute"><span class="css"><span class="hljs-attribute">line-height</span></span></span><span class="css">: </span><span class="hljs-number"><span class="css"><span class="hljs-number">16px</span></span></span><span class="css">; </span><span class="hljs-attribute"><span class="css"><span class="hljs-attribute">color</span></span></span><span class="css">: </span><span class="hljs-number"><span class="css"><span class="hljs-number">#f0f0f0</span></span></span><span class="css">; </span><span class="hljs-attribute"><span class="css"><span class="hljs-attribute">background</span></span></span><span class="css">: </span><span class="hljs-number"><span class="css"><span class="hljs-number">#000000</span></span></span><span class="css">; } </span><span class="hljs-selector-tag"><span class="css"><span class="hljs-selector-tag">tr</span></span></span><span class="css"> { </span><span class="hljs-attribute"><span class="css"><span class="hljs-attribute">height</span></span></span><span class="css">: </span><span class="hljs-number"><span class="css"><span class="hljs-number">16px</span></span></span><span class="css">; } </span><span class="hljs-selector-class"><span class="css"><span class="hljs-selector-class">.termReverse</span></span></span><span class="css"> { </span><span class="hljs-attribute"><span class="css"><span class="hljs-attribute">color</span></span></span><span class="css">: </span><span class="hljs-number"><span class="css"><span class="hljs-number">#000000</span></span></span><span class="css">; </span><span class="hljs-attribute"><span class="css"><span class="hljs-attribute">background</span></span></span><span class="css">: </span><span class="hljs-number"><span class="css"><span class="hljs-number">#00ff00</span></span></span><span class="css">; } </span></span><span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">style</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">src</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"http://bellard.org/jslinux/utils.js"</span></span></span><span class="hljs-tag">&gt;</span></span><span class="undefined"></span><span class="hljs-tag"><span class="undefined"></span><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">src</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"http://bellard.org/jslinux/term.js"</span></span></span><span class="hljs-tag">&gt;</span></span><span class="undefined"></span><span class="hljs-tag"><span class="undefined"></span><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag">&gt;</span></span><span class="javascript"><span class="hljs-keyword"><span class="javascript"><span class="hljs-keyword">var</span></span></span><span class="javascript"> term = </span><span class="hljs-keyword"><span class="javascript"><span class="hljs-keyword">new</span></span></span><span class="javascript"> Term(</span><span class="xml"><span class="php"><span class="hljs-meta"><span class="javascript"><span class="xml"><span class="php"><span class="hljs-meta">&lt;?</span></span></span></span></span><span class="javascript"><span class="xml"><span class="php">=$cols</span></span></span><span class="hljs-meta"><span class="javascript"><span class="xml"><span class="php"><span class="hljs-meta">?&gt;</span></span></span></span></span></span><span class="javascript"><span class="xml">, </span></span><span class="php"><span class="hljs-meta"><span class="javascript"><span class="xml"><span class="php"><span class="hljs-meta">&lt;?</span></span></span></span></span><span class="javascript"><span class="xml"><span class="php">=$rows</span></span></span><span class="hljs-meta"><span class="javascript"><span class="xml"><span class="php"><span class="hljs-meta">?&gt;</span></span></span></span></span></span><span class="javascript"><span class="xml">, send_cmd); term.open();</span></span></span></span><span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre><br><h5>  Reading user input and executing commands </h5><br>  We read the user input from our FIFO file, the output of our team from the corresponding pipe, all in non-blocking mode, for simplicity.  Also, as a small crutch, replace "\ n" with "\ r \ n", since in fact, term.js handles the output of the serial port driver, and not the "raw" output of the program;). <br><br><pre> <code class="php hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?php</span></span> <span class="hljs-keyword"><span class="hljs-keyword">echo</span></span> <span class="hljs-string"><span class="hljs-string">"&lt;!-- "</span></span>.str_repeat(<span class="hljs-string"><span class="hljs-string">'-'</span></span>, <span class="hljs-number"><span class="hljs-number">4096</span></span>).<span class="hljs-string"><span class="hljs-string">" --&gt;\n"</span></span>; flush(); <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (!feof($pipes[<span class="hljs-number"><span class="hljs-number">1</span></span>])) { $ln = fgets($pipes[<span class="hljs-number"><span class="hljs-number">1</span></span>], <span class="hljs-number"><span class="hljs-number">4096</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ($ln !== <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>) { $ln = str_replace(<span class="hljs-string"><span class="hljs-string">"\n"</span></span>, <span class="hljs-string"><span class="hljs-string">"\r\n"</span></span>, $ln); <span class="hljs-keyword"><span class="hljs-keyword">echo</span></span> <span class="hljs-string"><span class="hljs-string">'&lt;script&gt;term.write('</span></span>.json_encode($ln).<span class="hljs-string"><span class="hljs-string">');&lt;/script&gt;'</span></span>; flush(); <span class="hljs-keyword"><span class="hljs-keyword">continue</span></span>; } $inp_ln = fgets($cmdfp, <span class="hljs-number"><span class="hljs-number">4096</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ($inp_ln !== <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>) { <span class="hljs-comment"><span class="hljs-comment">// ensure that command is fully written by setting blocking to 1 stream_set_blocking($pipes[0], 1); fwrite($pipes[0], $inp_ln); stream_set_blocking($pipes[0], 0); } usleep(20000); } proc_close($pp); </span><span class="hljs-meta"><span class="hljs-comment"><span class="hljs-meta">?&gt;</span></span></span></span></code> </pre><br><h5>  We clear reception of commands after an exit </h5><br>  After the process is completed (for example, a person pressed Ctrl + D or entered ‚Äúexit‚Äù), you need to stop sending user input to the server, because there is no one to accept it anyway :). <br><pre> <code class="html hljs xml"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag">&gt;</span></span><span class="undefined"><span class="undefined">clearInterval(sendCmdInterv);</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">body</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">html</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre><br><br><h4>  <b>File send-cmd.php</b> </h4><br>  The file to which we send commands is called send-cmd.php and consists of what (yes, no checks of input parameters :)): <br><br><pre> <code class="php hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?php</span></span> $fp = fopen($_GET[<span class="hljs-string"><span class="hljs-string">'pipe'</span></span>], <span class="hljs-string"><span class="hljs-string">'r+'</span></span>); fwrite($fp, $_GET[<span class="hljs-string"><span class="hljs-string">'cmd'</span></span>]); fclose($fp);</code> </pre><br><br><h4>  <b>Bashrc file</b> </h4><br>  Here is what bashrc I suggest to use: <br><br><pre> <code class="bash hljs"><span class="hljs-built_in"><span class="hljs-built_in">export</span></span> PS1=<span class="hljs-string"><span class="hljs-string">'\[\033[01;33m\]\u\[\033[00m\]:\[\033[01;34m\]\w\[\033[00m\]\$ '</span></span> <span class="hljs-built_in"><span class="hljs-built_in">export</span></span> PS2=<span class="hljs-string"><span class="hljs-string">'&gt; '</span></span> <span class="hljs-built_in"><span class="hljs-built_in">export</span></span> PS4=<span class="hljs-string"><span class="hljs-string">'+ '</span></span> <span class="hljs-built_in"><span class="hljs-built_in">export</span></span> LANG=en_US.UTF-8 <span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> Welcome to simple terminal emulator<span class="hljs-string"><span class="hljs-string">'!'</span></span> <span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> Scroll up and down using Ctrl-Up, Ctrl-Down, Ctrl-PageUp and Ctrl-PageDown. <span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> Output handling is based on JSLinux term.js library. Enjoy<span class="hljs-string"><span class="hljs-string">'!'</span></span></code> </pre><br><br><h4>  <b>Pt.c file</b> </h4><br>  Utilities for working with pseudo-terminal already exist, for example, there is a good expect library that does almost what we need.  Nevertheless, it seemed to me interesting to write my own utility, which will simply set the required terminal sizes and output everything to stdout and accept input to stdin: <br><br><pre> <code class="hljs lua">#include &lt;unistd.h&gt; #include &lt;sys/<span class="hljs-built_in"><span class="hljs-built_in">select</span></span>.h&gt; #include &lt;stdio.h&gt; #ifdef __LINUX__ #include &lt;pty.h&gt; #<span class="hljs-keyword"><span class="hljs-keyword">else</span></span> #include &lt;util.h&gt; #endif static void set_fds(fd_set *reads, int pttyno) { FD_ZERO(reads); FD_SET(<span class="hljs-number"><span class="hljs-number">0</span></span>, reads); FD_SET(pttyno, reads); } int main(int argc, <span class="hljs-built_in"><span class="hljs-built_in">char</span></span> *argv[]) { <span class="hljs-built_in"><span class="hljs-built_in">char</span></span> buf[<span class="hljs-number"><span class="hljs-number">1024</span></span>]; int pttyno, n = <span class="hljs-number"><span class="hljs-number">0</span></span>; int pid; struct winsize winsz; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (argc &lt; <span class="hljs-number"><span class="hljs-number">3</span></span>) { fprintf(<span class="hljs-built_in"><span class="hljs-built_in">stderr</span></span>, <span class="hljs-string"><span class="hljs-string">"Usage: %s &lt;rows&gt; &lt;cols&gt; &lt;cmd&gt; [args]\n"</span></span>, argv[<span class="hljs-number"><span class="hljs-number">0</span></span>]); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span>; } winsz.ws_row = atoi(argv[<span class="hljs-number"><span class="hljs-number">1</span></span>]); winsz.ws_col = atoi(argv[<span class="hljs-number"><span class="hljs-number">2</span></span>]); winsz.ws_xpixel = winsz.ws_col * <span class="hljs-number"><span class="hljs-number">14</span></span>; winsz.ws_ypixel = winsz.ws_row * <span class="hljs-number"><span class="hljs-number">14</span></span>; pid = forkpty(&amp;pttyno, NULL, NULL, &amp;winsz); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (pid &lt; <span class="hljs-number"><span class="hljs-number">0</span></span>) { perror(<span class="hljs-string"><span class="hljs-string">"Cannot forkpty"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (pid == <span class="hljs-number"><span class="hljs-number">0</span></span>) { execvp(argv[<span class="hljs-number"><span class="hljs-number">3</span></span>], argv + <span class="hljs-number"><span class="hljs-number">3</span></span>); perror(<span class="hljs-string"><span class="hljs-string">"Cannot exec bash"</span></span>); } fd_set reads; set_fds(&amp;reads, pttyno); <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (<span class="hljs-built_in"><span class="hljs-built_in">select</span></span>(pttyno + <span class="hljs-number"><span class="hljs-number">1</span></span>, &amp;reads, NULL, NULL, NULL)) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (FD_ISSET(<span class="hljs-number"><span class="hljs-number">0</span></span>, &amp;reads)) { n = <span class="hljs-built_in"><span class="hljs-built_in">read</span></span>(<span class="hljs-number"><span class="hljs-number">0</span></span>, buf, sizeof buf); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (n == <span class="hljs-number"><span class="hljs-number">0</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (n &lt; <span class="hljs-number"><span class="hljs-number">0</span></span>) { perror(<span class="hljs-string"><span class="hljs-string">"Could not read from stdin"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span>; } <span class="hljs-built_in"><span class="hljs-built_in">write</span></span>(pttyno, buf, n); } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (FD_ISSET(pttyno, &amp;reads)) { n = <span class="hljs-built_in"><span class="hljs-built_in">read</span></span>(pttyno, buf, sizeof buf); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (n == <span class="hljs-number"><span class="hljs-number">0</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (n &lt; <span class="hljs-number"><span class="hljs-number">0</span></span>) { perror(<span class="hljs-string"><span class="hljs-string">"Cannot read from ptty"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span>; } <span class="hljs-built_in"><span class="hljs-built_in">write</span></span>(<span class="hljs-number"><span class="hljs-number">1</span></span>, buf, n); } set_fds(&amp;reads, pttyno); } int statloc; wait(&amp;statloc); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>; }</code> </pre><br><br><h4>  Demonstration of work </h4><br>  Unfortunately, I can‚Äôt give you a link to a working demo, since I don‚Äôt have a server that I don‚Äôt feel sorry for;).  However, I recorded a short video that shows how it works: <br><br><iframe width="420" height="315" src="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://www.youtube.com/embed/pWJjW1NWAzg%3Ffeature%3Doembed&amp;xid=25657,15700022,15700186,15700191,15700253,15700256,15700259&amp;usg=ALkJrhjKgt9cydHyFSuYYOV-EWK7JtSkUA" frameborder="0" allowfullscreen=""></iframe><br><br><h4>  Together </h4><br>  In theory, all source codes should be in this article.  If you are lazy, I put the <a href="http://narod.ru/disk/43560153001.fe8b550192c63edd88c470af1f473da2/simple-term.zip.html">archive with the appropriate files</a> on the people. <br><br>  <b>UPD:</b> <br>  If the pt.c program does not compile for FreeBSD, add the following header files to the beginning of the file (and <code>#include &lt;util.h&gt;</code> remove): <br><pre> <code class="hljs objectivec"><span class="hljs-meta"><span class="hljs-meta">#include </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt;sys/types.h&gt;</span></span></span><span class="hljs-meta"> #include </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt;sys/ioctl.h&gt;</span></span></span><span class="hljs-meta"> #include </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt;termios.h&gt;</span></span></span><span class="hljs-meta"> #include </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt;libutil.h&gt;</span></span></span></span></code> </pre></div><p>Source: <a href="https://habr.com/ru/post/139878/">https://habr.com/ru/post/139878/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../139871/index.html">Photo gallery on Django using Google Picasa as a hosting</a></li>
<li><a href="../139873/index.html">Tele2 and Radio Research Institutes begin two-week LTE testing in Omsk</a></li>
<li><a href="../139874/index.html">My migration experience from VMware Server to ESXi</a></li>
<li><a href="../139875/index.html">Solving the problem of lack of layout in codeigniter</a></li>
<li><a href="../139877/index.html">Microsoft is developing a universal voice translator</a></li>
<li><a href="../139879/index.html">Jokes for mobile: afraid or not?</a></li>
<li><a href="../139881/index.html">Twitter bought a Posterous blogging platform</a></li>
<li><a href="../139883/index.html">Appeal to the developers of iPad applications for children</a></li>
<li><a href="../139884/index.html">Updating the ‚ÄúScanning Errors‚Äù section in Google Webmaster</a></li>
<li><a href="../139885/index.html">Cheap and fast</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>