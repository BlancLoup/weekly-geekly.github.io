<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>PHP demons</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Memo to a novice exorcist. 

 Before I start: I know what phpDaemon and System_Daemon are. I read articles on this topic, and on Habr√© too. 

 So, sup...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>PHP demons</h1><div class="post__text post__text-html js-mediator-article">  <i>Memo to a novice exorcist.</i> <br><br>  Before I start: I know what phpDaemon and System_Daemon are.  I read articles on this topic, and on Habr√© too. <br><br>  So, suppose that you have already decided that you need a demon.  What should he be able to? <br><ul><li>  Run from the console and get rid of it </li><li>  All information to write to the logs, do not display anything in the console </li><li>  Be able to produce child processes and control them </li><li>  Complete the task </li><li>  Shut down correctly </li></ul><br><h4>  Unbound from the console </h4><br><pre><code class="php hljs"><span class="hljs-comment"><span class="hljs-comment">//    //    pcntl_fork()    :    $child_pid = pcntl_fork(); if ($child_pid) { //   ,   ,  exit(); } //    . posix_setsid(); //      ,     </span></span></code> </pre> <br><a name="habracut"></a><br>  The <i>pcntl_fork ()</i> function creates a child process and returns its id.  However, the <i>$ child_pid</i> variable does not fall into the child process (more precisely, it will be equal to 0), respectively, only the parent process will pass the test.  It will end, and the child process will continue executing the code. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      In general, we have already created the demon, but it will still output all information (including errors) to the console.  Yes, and completed immediately after execution. <br><br><h4>  Override output </h4><br><pre> <code class="php hljs">$baseDir = dirname(<span class="hljs-keyword"><span class="hljs-keyword">__FILE__</span></span>); ini_set(<span class="hljs-string"><span class="hljs-string">'error_log'</span></span>,$baseDir.<span class="hljs-string"><span class="hljs-string">'/error.log'</span></span>); fclose(STDIN); fclose(STDOUT); fclose(STDERR); $STDIN = fopen(<span class="hljs-string"><span class="hljs-string">'/dev/null'</span></span>, <span class="hljs-string"><span class="hljs-string">'r'</span></span>); $STDOUT = fopen($baseDir.<span class="hljs-string"><span class="hljs-string">'/application.log'</span></span>, <span class="hljs-string"><span class="hljs-string">'ab'</span></span>); $STDERR = fopen($baseDir.<span class="hljs-string"><span class="hljs-string">'/daemon.log'</span></span>, <span class="hljs-string"><span class="hljs-string">'ab'</span></span>);</code> </pre><br>  Here we close the standard output streams and send them to a file.  STDIN just in case open for reading from / dev / null, since  our demon will not read from the console - it is untied from it.  Now the entire output of our daemon will be logged in files. <br><br><h4>  Go! </h4><br><pre> <code class="php hljs"><span class="hljs-keyword"><span class="hljs-keyword">include</span></span> <span class="hljs-string"><span class="hljs-string">'DaemonClass.php'</span></span>; $daemon = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> DaemonClass(); $daemon-&gt;run();</code> </pre><br>  Once we have redefined the output, you can perform the task set by the daemon.  Let's create <i>DaemonClass.php</i> and start writing a class that will do the main work of our demon. <br><br><h4>  DaemonClass.php </h4><br><pre> <code class="php hljs"><span class="hljs-comment"><span class="hljs-comment">//    PHP     declare(ticks=1); class DaemonClass { //     public $maxProcesses = 5; //    TRUE,    protected $stop_server = FALSE; //       protected $currentJobs = array(); public function __construct() { echo "onstructed daemon controller".PHP_EOL; //   SIGTERM  SIGCHLD pcntl_signal(SIGTERM, array($this, "childSignalHandler")); pcntl_signal(SIGCHLD, array($this, "childSignalHandler")); } public function run() { echo "Running daemon controller".PHP_EOL; //  $stop_server    TRUE,    while (!$this-&gt;stop_server) { //       ,    while(count($this-&gt;currentJobs) &gt;= $this-&gt;maxProcesses) { echo "Maximum children allowed, waiting...".PHP_EOL; sleep(1); } $this-&gt;launchJob(); } } }</span></span></code> </pre><br>  We expect signals SIGTERM (completion of work) and SIGCHLD (from child processes).  Run an infinite loop so that the daemon does not end.  We check whether it is possible to create another child process and wait if it is impossible. <br><br><pre> <code class="php hljs"> <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">launchJob</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-comment"><span class="hljs-comment">//    //    pcntl_fork()   //  :    $pid = pcntl_fork(); if ($pid == -1) { //      error_log('Could not launch new job, exiting'); return FALSE; } elseif ($pid) { //      $this-&gt;currentJobs[$pid] = TRUE; } else { //       echo "  ID ".getmypid().PHP_EOL; exit(); } return TRUE; }</span></span></code> </pre><br>  <i>pcntl_fork ()</i> returns -1 in case of an error, $ pid will be available in the parent process, in the child of this variable will not be (more precisely, it will be equal to 0). <br><br><pre> <code class="php hljs"> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">childSignalHandler</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($signo, $pid = null, $status = null)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">switch</span></span>($signo) { <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> SIGTERM: <span class="hljs-comment"><span class="hljs-comment">//        $this-&gt;stop_server = true; break; case SIGCHLD: //       if (!$pid) { $pid = pcntl_waitpid(-1, $status, WNOHANG); } //      while ($pid &gt; 0) { if ($pid &amp;&amp; isset($this-&gt;currentJobs[$pid])) { //      unset($this-&gt;currentJobs[$pid]); } $pid = pcntl_waitpid(-1, $status, WNOHANG); } break; default: //    } }</span></span></code> </pre><br>  SIGTERM is the correct completion signal.  SIGCHLD is a signal to terminate the work of a child process.  When the child process terminates, we remove it from the list of running processes.  Upon receipt of SIGTERM, set a flag - our ‚Äúinfinite loop‚Äù will end when the current task is completed. <br><br>  It remains to prohibit the launch of several copies of the daemon, this is perfectly written in <a href="http://habrahabr.ru/blogs/php/40432/">this article</a> . <br><br>  Thanks for attention. <br><br>  <b>UPD:</b> Habrayuzer <a href="http://habrahabr.ru/users/dlussky/" class="user_link">Dlussky</a> in his <a href="http://habrahabr.ru/blogs/php/134620/">comments</a> suggested that in PHP&gt; = 5.3.0, instead of <i>declare (ticks = 1),</i> use <a href="http://www.php.net/manual/en/function.pcntl-signal-dispatch.php">pcntl_signal_dispatch ()</a> </div><p>Source: <a href="https://habr.com/ru/post/134620/">https://habr.com/ru/post/134620/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../134610/index.html">Siclum supports DOU STARTUP MIXER</a></li>
<li><a href="../134611/index.html">Black cards for "white hats"</a></li>
<li><a href="../134615/index.html">AI on the hoop: 5 useful tricks</a></li>
<li><a href="../134616/index.html">Fractal Synthesis: IFS and L-systems</a></li>
<li><a href="../134618/index.html">TI arranges a Christmas sale of robots</a></li>
<li><a href="../134624/index.html">Nvidia has opened the source code for the CUDA compiler</a></li>
<li><a href="../134625/index.html">A little bit about testing applications and user feedback</a></li>
<li><a href="../134627/index.html">My BlackBerry Development Experience</a></li>
<li><a href="../134628/index.html">Online courses from Stanford University and Berkeley University for 2012</a></li>
<li><a href="../134629/index.html">Experience of moving to SSD: in half a year</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>