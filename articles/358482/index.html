<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Preparing a test environment, or how many test instances you need</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="How many test benches in your project are 5, 10 or more than 10? Offhand, we need stands for each development team, stands for QA for each project, pr...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Preparing a test environment, or how many test instances you need</h1><div class="post__text post__text-html js-mediator-article">  How many test benches in your project are 5, 10 or more than 10?  Offhand, we need stands for each development team, stands for QA for each project, project managers also need stands, and also CI - it‚Äôs difficult to precisely differentiate everything and not cause conflict situations.  In a word, why don't we make a test bench exactly when it is needed?  We need a test stand now - we made it, we don‚Äôt need it - we removed it. <br><br>  This approach was suggested by <strong>Alexander Dubrovin</strong> ( <a href="https://habr.com/users/adbrvn/" class="user_link">adbrvn</a> ) on <a href="http://www.highload.ru/">Highload ++</a> 2017 in his report, which you will find the decoding under the cut. <br><br><img src="https://habrastorage.org/webt/39/kx/db/39kxdbltsjlidqd7mx5sethsp7e.jpeg">
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      <strong>About the speaker:</strong> Alexander Dubrovin works in Superjob.  It is known that the projects of this company are highly loaded.  But today we will not talk about how many users visit the portal, and how much data is stored on the servers, but will touch on other indicators. <br><br>  Looking ahead, we say that, in fact, Superjob do not know how many test benches they have.  But first things first.  Let's start with a little story. <br><a name="habracut"></a><br><h2>  <em>A bit of history</em> <br></h2><br><img src="https://habrastorage.org/webt/kl/ak/13/klak138vhqhsi-f2yahh7teoqr0.jpeg"><br><br>  Imagine a small project S. There is a team of developers in it who need to test their code somewhere.  To organize testing, we will put the test machine, make it look like a production, roll the code there, launch it and the developers will be able to test something there. <br><br>  At some point, the team begins to grow, and requires a staff of testers.  QA-specialists appear, and they also need to be tested somewhere. <br><br>  You can use a simple approach - select a section for testers, roll the same copy there, and now they can test.  Everything is great and good! <br><br><iframe width="560" height="315" src="https://www.youtube.com/embed/XtF15574ij8" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br>  The project continues to grow, and an additional development team appears.  They also need to test somewhere.  The approach is already familiar - we are separating another part of the test server. <br><br>  But in fact, the teams are also growing - one test bench is not enough for them.  They also do more tasks, so testers need a lot of testing. <br><br><img src="https://habrastorage.org/webt/ah/_b/6l/ah_b6ldkygjqqy-1hypped3-hhu.jpeg"><br><br>  At about this stage, you can begin to notice interesting stories.  Suppose there is a tester Vasya, who wants to test some problem.  He chooses a test stand, rolls the code in there and starts testing.  She clicks, clicks and realizes that something is not right, something is not working, and in general the task is not done. <br><br>  In JIRA, tickets begin to fall, developers begin to gather near Vasya with the words: ‚ÄúBut how is that?  Yet done! "And someone finally asks:" And what is your branch on the test rolled out? "Bob looks - not the same.  The branch is quickly corrected, tickets in JIRA are closed, everything is fine.  Vasya continues to test, everything works for him. <br><br>  But at this time, on the other side of the room, developer Vova thinks: ‚ÄúIt's strange, but why isn't it working for me?‚Äù But he quickly realizes that the branch is not the same.  Rolls out the one you need, and Vasya again has problems. <br><br>  In a couple of iterations, they understand that they are simply <strong>testing on one test bench</strong> and interfere with each other.  As a result, <strong>time is wasted</strong> , Vasya and Vova are unhappy. <br><br>  Other story.  The developer, Kolya, knows about Vasiny‚Äôs problems, comes to him in advance and asks which test bench is currently free.  Vasya points free, and all is well.  After a couple of days, they meet again, and Vasya asks Kolya: ‚ÄúWill you return the test stand to us?  You occupied him for an hour, and 2 days have passed. ‚Äù <br><br>  And again the problem is either the developer is looking for another stand, or everyone will be cheerfully waiting until he finishes testing. <br><br>  In fact, the diagram above does not display everything.  There are not enough managers here.  Sometimes managers want to see raw code that has not yet been tested.  Standard approach - we again select a corner of the test server and make more test stands. <br><br>  The very last part of this system is of course CI - he also wants to shoot somewhere, test somewhere. <br><br>  Smoothly developing such a scheme, we get an <strong>uncontrolled change in test benches</strong> .  The scheme is bad because we really do not control such stands - we do not know: <br><br><ul><li>  who is testing on this stand at the moment; <br></li><li>  what is rolled out there; <br></li><li>  we do not know at all whether he is busy or free. <br></li></ul><br>  Moreover, we do not know which test stands are now free, maybe at some time there is a queue. <br><br><h2>  <em>Idea</em> <br></h2><br>  At this point, we thought - what to do?  <strong>Why do we need so many test benches?</strong>  Why don't we make a <strong>test bench exactly when you need it?</strong>  We need a test stand now - we made it, we don‚Äôt need it - we removed it. <br><br>  The next step in this idea is to make a <strong>test stand for each branch of code</strong> . <br><br>  It seems to be a good idea, but there are technical nuances.  We need stands: <br><br><ul><li>  <strong>independent</strong> ; <br></li><li>  very <strong>similar to production</strong> - we want to test closer to the production environment; <br></li><li>  with the ability to <strong>quickly create stands</strong> , because we want, so that as soon as a branch appears, a test stand would immediately appear under it. <br></li></ul><br>  Ideally, we want one button ‚Äú <strong>Make a test stand</strong> ‚Äù. <br><br><h2>  <em>Harsh reality</em> <br></h2><br>  There is still a harsh reality in which we have: <br><br><ul><li>  A big complex project - a huge php monolith with a fairly long history. <br></li><li>  Service in four domain zones.  We simultaneously support the Russian, Ukrainian, Uzbek and Belarusian zones. <br></li><li>  A bunch of subdomains ‚Äî geopdomains and service subdomains ‚Äî such as the API, students.superjob.ru, and so on. <br></li></ul><br>  And all this at some point testers will want to test.  Even if we are not testing it in Ukraine now, tomorrow there will be a task to make a special page for the Ukrainian part - this must also be taken into account. <br><br><h2>  <em>No sooner said than done!</em> <br></h2><br>  <strong>Docker / docker-compose</strong> <br><br>  First, we talked about the fact that test benches should be isolated and as similar as possible.  Nowadays, this allows docker to be implemented.  He will give the opportunity to run containers.  Obviously, <strong>we will not manage with one container</strong> , moreover, we need to run a bunch of similar stacks.  Therefore, <strong>docker-compose is</strong> needed. <br><br>  Great - we will use the docker - it's stylish, fashionable, youth. <br><br>  <strong><s>Sawing monolith</s> allocate services</strong> <br><br>  Docker promotes the microservice approach and here we face a problem because we have a monolith. <br><br><blockquote>  Have you ever tried to estimate how much it costs to cut a monolith on microservices?  Obviously, this figure is measured in person-years. <br></blockquote><br>  At some point we looked at the component scheme of our system and saw that here we have load-balancing, here is the application for php, here is the node.js application.  Why don't we run exactly this as a service.  Let's find what we can run in docker containers. <br><br>  <strong>Configuring the network</strong> <br><br>  Then we need to somehow reach our test bench.  Naturally, we need to pull the 80th port out to the browser so that the browser can open our test bench, but if such booths will be launched within one machine, we need to issue IP. <br><br>  The documentation has a whole huge section on network configuration. <br><br>  Docker can use various types of networks.  In our case a network like macvlan helped a lot.  This is a technology that allows for a single physical network interface to implement a stack of virtual network interfaces.  At the same time, the docker will manage these interfaces on its own: create, add to the machine and receive external IP addresses relative to the host machine. <br><br>  Thus, we can launch a pack of containers, give the front container (balancer) the opportunity to get an external IP address and open the 80th port on it.  We can already knock there using a browser. <br><br>  <strong>Raise DNS and API</strong> <br><br>  We remember that we have domain zones and a lot of subdomains.  Thus, we can turn to the test bench only by the level 2 domain.  There is a huge plus, and a huge minus: <br><br><ul><li>  <strong>Minus</strong> - we obviously have to somehow overlap the real domains in the zone ru, ua, uz, by. <br></li><li>  <strong>Plus</strong> - as a level 2 domain, you can sew directly the specific name of the branch - we make test stands for each code branch. <br></li></ul><br>  Thus, we will get a <strong>clear, clear and clear address</strong> , which will already contain an indication of the code branch. <br><br>  Minus costs really simple.  If we have to overlap domains, we simply add the prefix and thus limit the set of overlapping domains - this can already be tolerated. <br><br>  In our case, we chose the prefix sj.  It turns out, we have to block domains only with the sj prefix - there are obviously few of these. <br><br>  Another part of the DNS is the API.  As already mentioned, it is necessary to raise test benches quickly.  Therefore, we need a DNS server that allows you to quickly add and quickly remove an API record in automatic mode. <br><br>  The solution is <strong>PowerDNS</strong> .  This server allows you to quite quickly and simply tie the API to it and add and remove test benches using scripts. <br><br>  Wonderful!  We raised and configured the DNS, taught our containers to prescribe their IPs into it, but something is missing. <br><br>  <strong>Making SSL-CA</strong> <br><br>  We live in the 21st century.  Obviously, the entire Internet - SSL and <strong>test benches must support SSL</strong> .  Quite a lot of bugs are specific to SSL, and mixed content is only the tip of the iceberg. <br><br>  So, we need a way to quickly get a certificate and quickly apply it on a rising test stand.  Our company already had an <strong>OpenSSL</strong> based certificate authority.  Here we went by a simple method of writing your bike. <br><br>  The bicycle is written in one day and allows you to get certificates generated for a specific domain name using GET requests. <br><br>  It remains the least.  It is necessary to automate it, because we want to do all this with one button. <br><br>  <strong>Automating</strong> <br><br>  For ourselves at the initial stage, we wrote a console script that allows you to simply raise the test bench or remove it. <br><br>  Obviously, testers are not very comfortable.  Therefore, it is possible, for example, to make a special assembly that will assemble a test stand and launch it. <br><br>  But in fact, the coolest step in this plan is to add such a button directly to the JIRA ticket.  Imagine, your tester opens a JIRA ticket, reads a request, presses a button and gets a test bench in a couple of minutes - great? <br><br><h2>  <em>pros</em> <br></h2><br><ul><li>  Initially, we planned this for manual <strong>testing</strong> , so that the tester could run and click on any version of his code, and it worked great. <br></li><li>  The next extra bonus is that we have <strong>demo hosts</strong> .  This is the same, only the project manager, not the tester, enters the JIRA ticket.  He can also see and click the raw code. <br></li><li>  We got a huge plus <strong>for CI</strong> .  When we trained CI in the same way to raise a test bench for a specific version of the code and then delete it, we had the opportunity to run absolutely any tests for any branch.  Even the most complex interface selenium tests I can get rid of for any branch in my project with one click. <br></li></ul><br><h2>  Minuses <br></h2><br>  But there are also disadvantages, I would say, <strong>nuances in the management of stands</strong> .  Need to learn how to manage them. <br><br>  We rolled out the first version of our system to an old weak server and set up the creation of test stands for each new branch.  Of course, somewhere in a day and a half the <strong>server failed</strong> , simply because there are a lot of branches. <br><br>  Then, we stopped creating them automatically, and a button appeared in JIRA, CI learned how to start and stop test benches, collect logs from them. <br><br>  Definitely there is a class of tasks that this system will not allow to solve.  For example, often a pop up problem is the <strong>total time</strong> for all containers.  Some tasks would be convenient to test by shifting the time on the server.  This system, unfortunately, does not allow to solve such problems.  But such tasks can be solved by adding special branches to the code for testing, so that, for example, you can see how the form behaves after 2 weeks. <br><br><h2>  <em>Total</em> <br></h2><br>  At the entrance, we had a test bench system that made us look for a test bench and did not guarantee us that no one would interfere with each other at these test benches. <br><br><blockquote>  <strong>It was</strong> : "Vasya, and what test is free - I need to roll out my task to test it." <br></blockquote><br>  The output turned out to be <strong>one button</strong> , which you can click and get in a couple of minutes a ready-made test bench for a specific version of the code.  Even if several people use this stand, it‚Äôs guaranteed that these people want to watch this particular version of the code. <br><br><blockquote>  <strong>It became</strong> : "I press the button and after a minute and a half I get a new test stand for a specific task." <br></blockquote><br>  Bonus we got all the tests in one click.  As I said, any tests on any branch directly from the CI are selected with one button.  Then the machine will do everything by itself: raise the test stand, fire it, collect logs from it and remove it. <br><br>  Returning to my first question, how many test benches do we need?  I do not know how many test benches we need, because today they need 20, tomorrow - 15, the day after tomorrow 25. <br><br>  But I know for sure that <strong>we have exactly as many test benches as we need here and now</strong> . <br><br><blockquote>  Time flies unnoticed, and quite a bit remains before the <a href="http://ritfest.ru/moscow/2018">RIT ++</a> conference festival, we recall it will take place <strong>on May 28 and 29</strong> in Skolkovo.  Taking this opportunity, we present a small selection of <a href="http://rootconf.ru/moscow-rit/2018">RootConf</a> applications for a wide range of listeners: <br><br><ul><li>  <a href="http://rootconf.ru/moscow-rit/2018/abstracts/3469">Daniel Migalin</a> (Microsoft).  Automatic, reliable and manageable deploy with simple tools. <br></li><li>  <a href="http://rootconf.ru/moscow-rit/2018/abstracts/3479">Alexey Palazhchenko</a> (Percona).  Long-term storage of Prometheus metrics. <br></li><li>  <a href="http://rootconf.ru/moscow-rit/2018/abstracts/3526">Mikhail Kuzmin</a> (JetBrains).  Conveyor delivery of virtual machines. <br></li><li>  <a href="http://rootconf.ru/moscow-rit/2018/abstracts/3465">Nikolai Sivko</a> (okmeter.io).  Tweaking load balancing. <br></li></ul><br>  <a href="https://conf.ontico.ru/conference/join/rit2018.html%3Fpopup%3D3">You</a> can still <a href="https://conf.ontico.ru/conference/join/rit2018.html%3Fpopup%3D3">book</a> tickets, but do not forget, the price is steadily increasing. <br></blockquote></div><p>Source: <a href="https://habr.com/ru/post/358482/">https://habr.com/ru/post/358482/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../358472/index.html">Configure Database Status Monitoring</a></li>
<li><a href="../358474/index.html">Are two spaces better than one? Feedback on new research</a></li>
<li><a href="../358476/index.html">What does the waiter do with the monitor?</a></li>
<li><a href="../358478/index.html">The second wave of Specter-like vulnerabilities, which will take time to fix.</a></li>
<li><a href="../358480/index.html">DevOps Myths</a></li>
<li><a href="../358484/index.html">Roskomnadzor unlocks Alibaba's IP address pool</a></li>
<li><a href="../358486/index.html">The digest of fresh materials from the world of the frontend for the last week ‚Ññ314 (May 7 - 13, 2018)</a></li>
<li><a href="../358488/index.html">How to connect via RDP with Windows, Ubuntu or Debian (Linux), Mac OS, as well as from a phone on Android and iPhone</a></li>
<li><a href="../358490/index.html">PHP Digest 130 (May 1 - 13, 2018)</a></li>
<li><a href="../358492/index.html">Stablecoins: a quick guide</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>