<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>How we sawed the server rendering and what came of it</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hello! Throughout the year, we switch to React and think about how to make our users not wait for client templating, but see the page as quickly as po...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>How we sawed the server rendering and what came of it</h1><div class="post__text post__text-html js-mediator-article"><p>  Hello!  Throughout the year, we switch to React and think about how to make our users not wait for client templating, but see the page as quickly as possible.  To this end, we decided to do server-side rendering (SSR - Server Side Rendering) and optimize SEO, because not all search engines can execute JS, and those that can spend time on execution, and the time crawling each site is limited. </p><br><p><img src="https://habrastorage.org/webt/ok/dw/-_/okdw-_ptimir1qc1vqmd9fcypyk.png"></p><a name="habracut"></a><br><p> Let me remind you that server rendering is the execution of JavaScript code on the server side in order to give the client ready HTML.  This affects user perceived performance, especially on weak machines and with slow internet.  There is no need to wait until it is downloaded, parsed and executed JS.  The browser only needs to render the HTML immediately, without waiting for JSa, the user can already read the content. <br>  This shortens the passive waiting phase.  After the render, the browser will have to go through the finished DOM, check that it matches what was rendered. <br>  on the client, and add event listeners.  This process is called <a href="https://reactjs.org/docs/react-dom.html">hydration</a> .  If during the hydration process there is a discrepancy of content from the server and generated by the browser, we will receive a warning in the console and an extra rerender on the client.  This should not be, it is necessary to ensure that the result of the server and client rendering match.  If they diverge, then this should be treated as a bug, as it negates the advantages of server rendering.  If any element should diverge, you need to add <code>suppressHydrationWarning={true}</code> . </p><br><p>  In addition, there is one nuance: there is no <code>window</code> on the server.  The code that accesses it must be executed in lifecycle methods not called on the server side.  That is, you cannot use <code>window</code> in <a href="https://reactjs.org/docs/react-component.html">UNSAFE_componentWillMount ()</a> or, in the case of hooks, <a href="https://reactjs.org/docs/hooks-reference.html">uselayouteffect</a> . </p><br><p>  In essence, the server rendering process comes down to getting the initialState from the backend, driving it through <code>renderToString()</code> , picking up the finished initialState and HTML at the output, and giving it to the client. </p><br><p>  In hh.ru hikes from client JS are allowed only in the <a href="https://docs.microsoft.com/en-us/dotnet/standard/microservices-architecture/architect-microservice-container-applications/direct-client-to-microservice-communication-versus-the-api-gateway-pattern">api gateway</a> on python.  This is for safety and load balancing.  Python already goes to the necessary backends for the data, prepares them and gives them to the browser.  <a href="https://nodejs.org/en/">Node.js is</a> used only for server rendering.  Accordingly, after preparing the data for python, an additional approach to the node, waiting for the result and sending the response to the client is necessary. </p><br><p>  First you had to choose a server to work with HTTP.  We stopped at <a href="https://koajs.com/">koa</a> .  Like the modern syntax with <code>await</code> .  Modularity is lightweight middleware, which, if necessary, can be installed separately or easily written independently.  By itself, the server is easy and <a href="https://www.fastify.io/benchmarks/">fast</a> .  Yes, and written by koa by the same team of developers that write express, captivates their experience. </p><br><p>  After they learned how to roll out our service, they wrote the simplest code on KOA, which was able to give 200, and poured it on the prod.  It looked like this: </p><br><pre> <code class="plaintext hljs">const Koa = require('koa'); const app = new Koa(); const SERVER_PORT = 9400; app.use(async (ctx) =&gt; { ctx.body = 'Hello World'; }); app.listen(SERVER_PORT);</code> </pre> <br><p>  In hh.ru all services live in <a href="https://www.docker.com/">docker</a> containers.  Before the first release it is necessary to write <a href="https://www.ansible.com/">ansible</a> playbooks, with the help of which the service is rolled out in production environment and on test stands.  Every developer and tester has his own test environment, which is most similar to the prod.  We spent the most time and effort on writing playbooks.  It happened so because two front-enders did this, and this is the first service on the node in hh.ru.  We had to figure out how to switch the service to the development mode, to do it in parallel with the service for which the rendering takes place.  Deliver files to container.  Run a bare server to start the docker container, without waiting for the assembly.  Build and rebuild the server with the service using it.  Determine how much we need RAM. </p><br><p>  In development mode, provided for the possibility of automatic reassembly and subsequent restart of the service when changing the files included in the final build.  The node must be restarted to load the executable code.  Changes and <a href="https://github.com/webpack/webpack">builds are</a> monitored by the <a href="https://github.com/webpack/webpack">webpack</a> .  Webpack is needed to convert ESM to common CommonJS.  For restart, we took a <a href="https://github.com/remy/nodemon">nodemon</a> , which looks after the collected files. </p><br><p>  Next, we taught the routing server.  For correct balancing you need to know which server instances are alive.  To check this, the operational heart beat goes to <code>/status</code> every few seconds and expects to receive 200 in response.  If the server does not respond more than the number of times specified in the config, it is removed from the balance.  This turned out to be a simple task, a couple of lines and the routing is ready: </p><br><pre> <code class="plaintext hljs">export default async function(ctx, next) { if (routeMap[ctx.request.path]) { routeMap[ctx.request.path](ctx); } else { ctx.throw(NOT_FOUND, getStatusText(NOT_FOUND)); } next(); }</code> </pre> <br><p>  And we answer 200 at the right urle: </p><br><pre> <code class="plaintext hljs">export default (ctx) =&gt; { ctx.status = 200; ctx.body = '200'; };</code> </pre> <br><p>  After that, we made a primitive server that gave state to <code>&lt;script&gt;</code> and ready HTML. </p><br><p>  It took control of how the server works.  For this you need to fasten logging and monitoring.  Logs are not written in JSON, but to support the log format of the rest of our services, mainly Java.  <a href="https://github.com/log4js-node/log4js-node">Log4js</a> was chosen for <a href="https://github.com/log4js-node/log4js-node">benchmarks</a> - it is fast, easy to configure and writes in the format we need.  The general format of the logs is necessary to simplify the monitoring support - no need to write extra regulars to parse the logs.  In addition to logs, we also write errors in <a href="https://sentry.io/">sentry</a> .  I will not give the code for the loggers, it is very simple, basically there are settings. </p><br><p>  Then it was necessary to provide for a graceful shutdown - when the server becomes ill, or when the release rolls, the server does not accept more incoming connections, but executes all the requests hanging on it.  For the node there are many ready-made solutions.  You took <a href="http-graceful-shutdown">http-graceful-shutdown</a> , all you had to do was wrap the call to <code>gracefulShutdown(app.listen(SERVER_PORT))</code> </p><br><p>  At this point, received a production-ready solution.  To check how it works, we included server rendering for 5% of users on one page.  We looked at the metrics, realized that we significantly improved the <a href="https://developers.google.com/web/tools/lighthouse/audits/first-meaningful-paint">FMP</a> for mobile phones, for desktops the value has not changed much.  We started testing the performance, found out that one server holds ~ 20 RPS (the javista was very amused by this fact).  Found out the reasons why this is so: </p><br><ul><li><p>  One of the main problems turned out to be that they collected without NODE_ENV = production (they exhibited the ENV we needed for the server build).  In this case, the reactor gives away a non-production assembly, which runs about 30% slower. </p><br></li><li><p>  They raised the version of the node from 8 to 10, got about 20-25% of the performance. </p><br></li><li><p>  What we left at last is launching the node on several cores.  We suspected that it was very difficult, but here, too, everything turned out to be very prosaic.  The node has a built-in mechanism - <a href="https://nodejs.org/api/cluster.html">cluster</a> .  It allows you to run the required number of independent processes, including a master process that throws tasks to them. </p><br></li></ul><br><pre> <code class="plaintext hljs">if (cluster.isMaster) { cluster.on('exit', (worker, exitCode) =&gt; { if (exitCode !== SUCCESS) { cluster.fork(); } }); for (let i = 0; i &lt; serverConfig.cpuCores; i++) { cluster.fork(); } } else { runApp(); }</code> </pre> <br><p>  In this code, the master process is started, the processes are started according to the number of CPUs allocated for the server.  If one of the child processes fails - the exit code is not equal to <code>0</code> (we turned off the server ourselves), the master process restarts it. <br>  And the performance increases by about the number of dedicated CPUs for the server. </p><br><p>  As I wrote above, most of the time was spent writing the original playbooks - about 3 weeks.  It took about 2 weeks to write the entire SSR, and about a month later we slowly brought it to mind.  All this was done by the forces of 2 fronts, without the enterprise experience of node js.  Do not be afraid to do SSR, the main thing - do not forget to specify <code>NODE_ENV=production</code> , nothing complicated about it.  SEO users will thank you. </p></div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <p>Source: <a href="https://habr.com/ru/post/445816/">https://habr.com/ru/post/445816/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../445802/index.html">5 trends of the Internet of Things everyone should know about</a></li>
<li><a href="../445804/index.html">Encapsulation for real samurai, or nuances related to the internal keyword in C #</a></li>
<li><a href="../445806/index.html">How artificial intelligence changes science</a></li>
<li><a href="../445808/index.html">Hated and hounded: the dangerous life of a virus hacker, making powerful enemies</a></li>
<li><a href="../445814/index.html">How the delivery robot changed the culinary habits of American students</a></li>
<li><a href="../445820/index.html">MVCC-3. String Versions</a></li>
<li><a href="../445822/index.html">Why do IOPs? Why Racket?</a></li>
<li><a href="../445824/index.html">Code Generation in Dart. Part 1. Basics</a></li>
<li><a href="../445828/index.html">Solar spectrum in Chinese</a></li>
<li><a href="../445832/index.html">Radiation: an invisible killer and his daughters or a little about radon</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>