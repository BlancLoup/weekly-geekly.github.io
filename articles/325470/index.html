<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>How to understand and make friends with transactions and JPA</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Probably everyone knows about transactions in relational databases, everyone heard about ACID. But nevertheless, there is a difference between knowing...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>How to understand and make friends with transactions and JPA</h1><div class="post__text post__text-html js-mediator-article">  Probably everyone knows about transactions in relational databases, everyone heard about ACID.  But nevertheless, there is a difference between knowing and feeling, I faced it myself when I had to retrain myself in the developer‚Äôs backend.  I think at that moment such an article would have helped me greatly, I hope it will be useful to you too. <br><br>  When developing enterprise applications, they often interact with databases through ORM technology; in the world of Java, the most well-known technology is JPA (Java Persistence API) and its implementations Hibernate and EclipseLink.  JPA allows you to interact with the database in terms of domain objects, provides cache, cache replication in the presence of a cluster in the middle tier. <br><br>  As it usually happens: <br><a name="habracut"></a><br><ol><li>  A REST request to update the document comes to the backend, and a new state in the request body. </li><li>  We are starting a transaction. </li><li>  The backend queries the existing state of the document from the EntityManager, which can subtract it from the database, or it can get it from the cache. </li><li>  Next, we take the object arrived in the request body, look at it, compare it with the state of the object representing the record in the database. </li><li>  Based on this comparison, we make the necessary changes. </li><li>  Commit a transaction. </li><li>  We return the answer to the client. </li></ol><br>  Where is the dog rummaged?  Look, we took the data, most likely from the cache, maybe already rotten, maybe the server is processing the competitive request to change the same document right now, and the data is rotting out exactly at the moment when we make all these comparisons.  Based on these data of doubtful accuracy and the body of the REST request, we make decisions on making changes to the database and commit them.  Then the question arises, what the fuck did we just write to the database? 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      This is where transactions will help us.  The key to understanding them is under what conditions the transaction will not work, or, in other words, when its rollback happens.  And the transaction rollback happens if the changes you make violate the database constraints.  The most important of them are: <br><br><ul><li>  Violation of uniqueness constraints. </li><li>  Violation of referential integrity. </li></ul><br>  And so, if our transaction has passed, then ‚Äúcrap‚Äù, which we commit a little higher, satisfies the foundations.  It remains to configure the constraints so that the data satisfying them is a valid business entity. <br><br>  Here is the most primitive and artificial example: <br><br><pre><code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@Entity</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Document</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-meta"><span class="hljs-meta">@Id</span></span> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> String name; <span class="hljs-meta"><span class="hljs-meta">@Lob</span></span> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> String content; <span class="hljs-comment"><span class="hljs-comment">// getters and setters  }</span></span></code> </pre> <br><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@ApplicationScoped</span></span> <span class="hljs-meta"><span class="hljs-meta">@Transactional</span></span> <span class="hljs-comment"><span class="hljs-comment">//     -      public class DocumentService { @PersistenceContext private EntityManager entityManager; public void createDocument(String name, String content) { //          , //         Document documentEntity = entityManager.find(Document.class, name); if (documentEntity != null) { throw new WebApplicationException(Response.Status.CONFLICT); //  ! } //             documentEntity = new Document(); documentEntity.setName(name); documentEntity.setContent(content); entityManager.persist(documentEntity); } }</span></span></code> </pre><br>  Here, in the case of the creation of a document with the same name or if the data obtained from the porridge turned out to be outdated, a ConstraintViolationException happens at the time of the commit and the backend returns an error to the client 500.  The user will repeat the operation a little later and receive a sensible error message or create a document. <br><br>  In fact, 500 errors are not very desirable, the trick is that they will almost never happen, but if the specific use of your application is such that they happen too often, then you should think about something more sophisticated. <br><br>  Let's try something more complicated.  Suppose we want to be able to protect the document from being deleted.  We get a new table: <br><br><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@Entity</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">DocumentLock</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-meta"><span class="hljs-meta">@Id</span></span> <span class="hljs-meta"><span class="hljs-meta">@GeneratedValue</span></span> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> Long id; <span class="hljs-meta"><span class="hljs-meta">@OneToOne</span></span> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> Document document; <span class="hljs-meta"><span class="hljs-meta">@Basic</span></span> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> String lockedBy; <span class="hljs-comment"><span class="hljs-comment">// getters, setters }</span></span></code> </pre><br>  And we add Document to the class: <br><br><pre> <code class="java hljs"> <span class="hljs-meta"><span class="hljs-meta">@OneToOne</span></span>(mappedBy = <span class="hljs-string"><span class="hljs-string">"document"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> DocumentLock lock;</code> </pre><br>  Now, to protect the document from being deleted, it is enough to create a DocumentLock referring to the document.  Logic deleting document: <br><br><pre> <code class="java hljs"> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">deleteDocument</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(String name)</span></span></span><span class="hljs-function"> </span></span>{ Document documentEntity = entityManager.find(Document.class, name); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (documentEntity == <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> NotFoundException(); } DocumentLock lock = documentEntity.getLock(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (lock != <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> WebApplicationException( <span class="hljs-string"><span class="hljs-string">"Document is locked by "</span></span> + lock.getLockedBy(), Response.Status.BAD_REQUEST); } entityManager.remove(documentEntity); }</code> </pre><br>  Look, we checked that there is no lock, but the cached data used for this is possibly already outdated, and possibly outdated right during the check.  In this case, removing the document from our code will attempt to violate the referential integrity of the data, which means our transaction will not work.  A couple of comments: <br><br><ol><li>  Make sure that cascading deletes is disabled; in case of cascading deletes, deleting a document will delete all records that refer to it.  Those.  having a record of business lock will not hurt anything. </li><li>  In fact, the code above allows you to hang several locks on one document, i.e.  it is required to configure still uniqueness. </li><li>  An example of a purely synthetic, most likely it makes sense to put data about the owner of a business location directly into the document, and not to get a separate table.  And then use the explicit pessimistic lock to check the absence of this business lock when deleting a document. </li></ol><br>  In real-world tasks, referential integrity helps a lot when storing hierarchically organized data: organization staff, directory and file structure.  In this case, for example, if we remove a boss and assign a subordinate to him concurrently in a parallel transaction, referential integrity ensures that only one of these operations is completed and the structure of the organization remains valid (each employee has a manager other than the director).  At the same time, at the beginning of both operations, each of them looked feasible. <br><br>  Summing up: even using outdated and questionable data (which may well be the case when working with the database through JPA) when deciding to make changes to the database, and even if conflicting changes are made competitive, the transaction mechanism will not allow us to do anything that violates the referential integrity will either not match the imposed constraints, all actions combined by this transaction and leading to this dismal result will be canceled in accordance with the principle of atomicity.  Just keep this in mind when modeling the data and carefully arrange the constraints. </div><p>Source: <a href="https://habr.com/ru/post/325470/">https://habr.com/ru/post/325470/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../325458/index.html">Secure access from anywhere in the world using Microsoft DirectAccess and Windows To Go. Part One - Theory</a></li>
<li><a href="../325460/index.html">Product Design Digest March 2017</a></li>
<li><a href="../325462/index.html">The digest of fresh materials from the world of the frontend for the last week ‚Ññ256 (March 27 - April 2, 2017)</a></li>
<li><a href="../325464/index.html">Vector pictures with gradient in Android 5.0</a></li>
<li><a href="../325468/index.html">How not to step on a rake in Go</a></li>
<li><a href="../325472/index.html">Decorating life with gdb PrettyPrinting API</a></li>
<li><a href="../325476/index.html">Flexible release planning for 101 releases (based on Excel)</a></li>
<li><a href="../325478/index.html">Composition or inheritance: how to choose?</a></li>
<li><a href="../325480/index.html">Matreshka.js 2 - tl; dr</a></li>
<li><a href="../325482/index.html">Implementation of pseudo-3D in racing games</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>