<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Our experience in testing LXC (Linux Containers) using the example of Debian Wheezy</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="We at Centos-admin are following the advent of new technologies, testing them and, of course, introducing them. Almost on all servers we use OpenVZ co...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Our experience in testing LXC (Linux Containers) using the example of Debian Wheezy</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/getpro/habr/post_images/ff5/a61/8d7/ff5a618d78a64b73fe015ac686e1724c.png"><br><br>  We at <b>Centos-admin</b> are following the advent of new technologies, testing them and, of course, introducing them.  Almost on all servers we use OpenVZ container virtualization.  In order to expand the set of tools used in the work, we decided to study and test the native Linux LXC virtualization. <br>  Under the cat you will find a small overview of the technology and a brief manual on the use of LXC in Debian Wheezy and our conclusions. <br><a name="habracut"></a><br>  The technology has long been actively developed.  At the moment, the stable version is 0.9, next year a release 1.0 is being prepared, which will be included in Ubuntu 14.04 LTS.  However, currently there is no User Namespace support in the Ubuntu mainstream core, so this article discusses the use of Linux Containers using the example of Debian Wheezy. <br>  Should I start using LXC now?  Let's try to figure it out. <br><br>  <b>LXC (Linux Containers)</b> is nothing else but an operating system level virtualization technology. <br>  Although it is not possible to call LXC virtualization technology to the full, it is rather a technology of isolation and separation of computer resources. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      LXC is a logical continuation of the two previous technologies Vserver and OpenVZ, however, it develops within the framework of the ‚Äúvanilla‚Äù kernel branch starting from version 2.6.29. kernels. <br><br>  <b>What is LXC?</b>  LXC is a set of utilities that allows using the API to use the capabilities of the Linux kernel in creating isolated operating system containers and managing them.  To achieve all this, various features of the Linux kernel allow: <br><ul><li>  Isolation and Resource Restriction (cgroup) </li><li>  Isolating kernel namespaces (ipc, uts, mount, pid, network, user) </li><li>  File System Isolation (Chroot) </li><li>  Apparmor and SELinux profiles </li><li>  Seccomp policies </li></ul><br>  Like any container virtualization technology, LXC will be useful for the needs of web hosting, development, as well as for testing and debugging web projects. <br><br>  <b>Install, configure LXC on Debian 7</b> <br><br>  As mentioned earlier, LXC uses Cgroup, and in order to start working with containers, you need to mount the cgroup file system.  By default, the mount point is / sys / fs / cgroup, but you can mount at an arbitrary point. <br>  Fix fstab, add cgroup: <br><pre><code class="bash hljs">vi /etc/fstab</code> </pre> <br><pre> <code class="bash hljs">... cgroup /sys/fs/cgroup cgroup defaults 0 0 ...</code> </pre><br>  And mount the cgroup virtual file system: <br><pre> <code class="bash hljs">mount /sys/fs/cgroup</code> </pre><br>  For container administration, the lxc toolkit is used. <br>  Install the lxc package, the rest of the system will tighten: <br><pre> <code class="bash hljs">apt-get install lxc</code> </pre><br>  The folder in which the containers will be stored, by default: / var / lib / lxc <br>  After installing the utilities, you need to make sure that the system is fully ready to start working with containers: <br><pre> <code class="bash hljs">lxc-checkconfig</code> </pre><br><pre> <code class="bash hljs">root@lxc-debian:~<span class="hljs-comment"><span class="hljs-comment"># lxc-checkconfig Kernel config /proc/config.gz not found, looking in other places... Found kernel config file /boot/config-3.2.0-4-amd64 --- Namespaces --- Namespaces: enabled Utsname namespace: enabled Ipc namespace: enabled Pid namespace: enabled User namespace: enabled Network namespace: enabled Multiple /dev/pts instances: enabled --- Control groups --- Cgroup: enabled Cgroup clone_children flag: enabled Cgroup device: enabled Cgroup sched: enabled Cgroup cpu account: enabled Cgroup memory controller: enabled Cgroup cpuset: enabled --- Misc --- Veth pair device: enabled Macvlan: enabled Vlan: enabled File capabilities: enabled Note : Before booting a new kernel, you can check its configuration usage : CONFIG=/path/to/config /usr/bin/lxc-checkconfig</span></span></code> </pre><br>  If everything is in order, you can try to create the first container. <br><br>  <b>Container Management</b> <br><br><pre> <code class="bash hljs">lxc-create -n <span class="hljs-built_in"><span class="hljs-built_in">test</span></span> -t debian</code> </pre><br>  where '-n test' is the container name, '-t debian' is the OS template of the container being created. <br><br>  The lxc template itself is a bash script that creates root file system folders, a minimal set of configs files, and also pulls up fresh packages from repositories.  At the same time, after the first launch of the template creation script, the necessary packages are cached on disk.  Of course, the script is easy to customize.  For example, add the installation set of packages you need.  Such an approach to templates, in my humble opinion, is a bit more convenient than in the same OpenVZ. <br>  In Debian, you can find Archlinux, Altlinux, Fedora, Opensuse, Ubuntu-Cloud templates.  If the existing set of templates is not enough, you can try to create the missing template yourself. <br>  By default, a wizard is launched in Debian that will help you create a container by following a few steps.  And everything would be fine, but the Wheezy template is ‚Äú <a href="https://wiki.debian.org/LXC">broken</a> ‚Äù, and I don‚Äôt really want to use Sqeeze.  Therefore, you need to either make your template, or look for a <a href="https://github.com/simonvanderveldt/lxc-debian-wheezy-template">worker</a> on the Internet. <br><br>  Download the new template, for example, for CentOS 6: <br><pre> <code class="bash hljs"><span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> /usr/share/lxc/templates</code> </pre><br><pre> <code class="bash hljs">wget https://gist.github.com/hagix9/3514296/raw/7f6bb4e291fad1dad59a49a5c02f78642bb99a45/lxc-centos</code> </pre><br><pre> <code class="bash hljs">chmod +x lxc-centos</code> </pre><br>  You will also need yum package manager for CentOS. <br><pre> <code class="bash hljs">apt-get install yum</code> </pre><br>  Create a new container using the CentOS template: <br><pre> <code class="bash hljs">lxc-create -n <span class="hljs-built_in"><span class="hljs-built_in">test</span></span> -t centos</code> </pre><br>  Having created the first container, we get an absolutely clean system: there is practically nothing in it, even text editors. <br>  There are two ways to get into the container console: <br>  When you start the container, you will automatically be taken to its console, where you will need to log in, by default in Debian the root password is: root. <br><pre> <code class="bash hljs">lxc-start -n <span class="hljs-built_in"><span class="hljs-built_in">test</span></span></code> </pre><br>  If you are using an alternative template, the password can be overlooked in the template file. <br>  The second option is to connect to an already running container: <br><pre> <code class="bash hljs">lxc-console -n <span class="hljs-built_in"><span class="hljs-built_in">test</span></span></code> </pre><br>  When you first connect to the container, the following notation should appear: <br><pre> <code class="bash hljs">Type &lt;Ctrl+a q&gt; to <span class="hljs-built_in"><span class="hljs-built_in">exit</span></span> the console, &lt;Ctrl+a Ctrl+a&gt; to enter Ctrl+a itself</code> </pre>  - it does not work or does not always work.  Maybe on more recent releases already repaired. <br>  Therefore, you should use screen, or run the container with the -d key and access it via ssh (if the network is already configured). <br>  In the general case, the container will use the network stack of the host machine.  For testing, it will be fine, but not for web projects, so further we will look at how to get an isolated network stack in a container. <br><br>  Container removal is performed by the lxc-destroy utility: <br><pre> <code class="bash hljs">lxc-destroy -n <span class="hljs-built_in"><span class="hljs-built_in">test</span></span></code> </pre><br>  <b>Network configuration</b> <br>  Consider two options: <br>  - We have a server and many ‚Äúwhite‚Äù ip-addresses.  Each container can have its own address and freely communicate with the Internet. <br>  - We have a server and several, or even just one ‚Äúwhite‚Äù ip-address.  In this case, most likely, most of the containers will work for NAT. <br>  In both cases, a network bridge, a DHCP server and iptables come in handy: <br><pre> <code class="bash hljs">apt-get install bridge-utils isc-dhcp-server</code> </pre><br>  Before setting up the container network, we will configure two network bridges ( <a href="https://wiki.debian.org/BridgeNetworkConnections">bridge</a> ) on the host machine.  One for ‚Äúwhite‚Äù addresses, the other for private ‚Äúgray‚Äù addresses. <br>  The network adapter configuration file will look like this: <br><pre> <code class="bash hljs">vi /etc/network/interfaces</code> </pre><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#    auto br0 iface br0 inet static bridge_ports eth0 bridge_fd 0 address 192.168.0.100 netmask 255.255.255.0 gateway 192.168.0.1 dns-nameservers 192.168.0.1 8.8.8.8 #    auto lxcbr0 iface lxcbr0 inet static bridge_ports none bridge_fd 0 address 10.0.0.1 netmask 255.255.255.0</span></span></code> </pre><br>  <b>First option</b> <br>  Let's write the network adapter in the container config. <br>  By default, the folder containing the containers / var / lib / lxc, in it we look for a folder with the name of our container (test), it will contain the config file, and we will edit it. <br>  Add a block with network settings to the end of the file: <br><pre> <code class="bash hljs">vi /var/lib/lxc/<span class="hljs-built_in"><span class="hljs-built_in">test</span></span>/config</code> </pre><br><pre> <code class="bash hljs">... <span class="hljs-comment"><span class="hljs-comment"># networking lxc.utsname = centos #   ( ) lxc.network.type = veth #  -   lxc.network.flags = up #    ( ) lxc.network.link = br0 #      lxc.network.name = eth0 #       lxc.network.veth.pair = veth0 # IP-  lxc.network.ipv4 = 192.168.0.101/24 #    lxc.network.ipv4.gateway = 192.168.0.1 #  (mac)    lxc.network.hwaddr = 00:1E:2D:F7:E3:4F</span></span></code> </pre><br>  Now you can run the container and try to connect via ssh: <br><pre> <code class="bash hljs">lxc-start -n <span class="hljs-built_in"><span class="hljs-built_in">test</span></span> -d &amp;&amp; ssh root@192.168.0.101</code> </pre><br>  <b>Second option</b> <br>  The second option will differ from the first one in that we will use another network bridge and our containers will be able to access the Internet only via NAT. <br>  Let's fix the centos container configuration: <br><pre> <code class="bash hljs">vi /var/lib/lxc/<span class="hljs-built_in"><span class="hljs-built_in">test</span></span>/config</code> </pre><br><pre> <code class="bash hljs">... <span class="hljs-comment"><span class="hljs-comment"># networking lxc.utsname = centos lxc.network.type = veth lxc.network.flags = up lxc.network.link = lxcbr0 lxc.network.name = eth0 lxc.network.veth.pair = veth1 lxc.network.ipv4 = 10.0.0.10/24 lxc.network.ipv4.gateway = 10.0.0.1 lxc.network.hwaddr = 00:1E:2D:F7:E3:4E</span></span></code> </pre><br>  In order for our containers to receive addresses automatically, we will configure the dhcp server: <br><pre> <code class="bash hljs">vi /etc/dhcp/dhcpd.conf</code> </pre><br><pre> <code class="bash hljs">... <span class="hljs-comment"><span class="hljs-comment">#   authoritative; ‚Ä¶ #     subnet 10.0.0.0 netmask 255.255.255.0 { range 10.0.0.10 10.0.0.50; option domain-name-servers 192.168.0.1, 8.8.8.8; option domain-name "somehost.com"; option routers 10.0.0.1; default-lease-time 600; max-lease-time 7200; }</span></span></code> </pre><br>  It is also necessary to indicate on which network interface DHCP will work: <br><pre> <code class="bash hljs">vi /etc/default/isc-dhcp-server</code> </pre><br><pre> <code class="bash hljs">... INTERFACES=<span class="hljs-string"><span class="hljs-string">"lxcbr0"</span></span> ...</code> </pre><br>  You need to allow forwarding of packages on the host machine: <br><pre> <code class="bash hljs">/etc/sysctl.conf</code> </pre><br><pre> <code class="bash hljs">... net.ipv4.ip_forward=1 ...</code> </pre><br><pre> <code class="bash hljs">sysctl -p</code> </pre><br>  To provide access to the Internet from containers, and access to containers from the Internet, you need to configure the firewall using the following iptables rules: <br><pre> <code class="bash hljs">vi /etc/network/iptables.up.rules</code> </pre><br><pre> <code class="bash hljs">*nat :PREROUTING ACCEPT [0:0] :OUTPUT ACCEPT [0:0] :POSTROUTING ACCEPT [0:0] <span class="hljs-comment"><span class="hljs-comment">#       NAT -A POSTROUTING -s 10.0.0.0/24 -o lxbr0 -j MASQUERADE #    ,   SNAT # -A POSTROUTING -s 10.0.0.10/32 -j SNAT --to-source 192.168.0.100 #  SSH   -A PREROUTING -p tcp -m tcp -d 192.168.0.100 --dport 5678 -j DNAT --to-destination 10.0.0.10:22 COMMIT *mangle :PREROUTING ACCEPT [0:0] :INPUT ACCEPT [0:0] :FORWARD ACCEPT [0:0] :OUTPUT ACCEPT [0:0] :POSTROUTING ACCEPT [0:0] COMMIT *filter :FORWARD ACCEPT [0:0] :INPUT DROP [0:0] :OUTPUT ACCEPT [0:0] -A INPUT -m state --state ESTABLISHED,RELATED -j ACCEPT -A INPUT -p tcp -m tcp --dport 22 -j ACCEPT -A INPUT -p tcp -m tcp --dport 5678 -j ACCEPT COMMIT</span></span></code> </pre><br>  Apply the rules: <br><pre> <code class="bash hljs">iptables-restore &lt; /etc/network/iptables.up.rules</code> </pre><br>  We will also make the rules automatically load when the server is loaded: <br><pre> <code class="bash hljs"><span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> ‚Äúpost-up iptables-restore &lt; /etc/network/iptables.up.rules‚Äù &gt;&gt; /etc/network/interfaces</code> </pre><br>  Run the container and check the Internet connection: <br><pre> <code class="bash hljs">lxc-start -n centos -d</code> </pre><br><br>  <b>Backup, Clone, Restore</b> <br>  For backup containers used utility lxc-backup.  You shouldn‚Äôt compare it with vzdump.  The utility uses rsync to copy container files.  In fact, it does nothing except just copying the container files to the next folder.  Practical benefits are questionable.  With the same success, you can use your script to backup files with the same rsync to the right place. <br>  Containers are cloned using the lxc-clone utility, and there is lxc-restore to restore from backup.  These utilities cannot boast a wealth of functionality, but there is a necessary minimum. <br><br>  <b>What is the result?</b> <br>  The technology has come a long way in 39 releases and 1989 commits (as of 11/14/2013) and currently fits some complete form.  It is possible that it is still early to use LXC on virtual hosting in its current form, but the technology is quite suitable for private projects. <br><br>  Utilities for working with containers, perhaps, still need to be improved, and such work is actively underway.  At the same time, at the moment, their functionality is quite enough to complete the work on the implementation and administration of Linux containers. <br><br>  <b>Few digits last</b> <br>  Testing is a topic for a separate post, so I will not go into details, let me just say that the tests were conducted on the same machine, Phoronix Test Suite 3.8 was used for testing (I know too old), the OS in the CentOS 6.4 container / virtual machine.  Everything was done in haste, however, here's what happened: <br><br><div style="text-align:center;"><img src="http://habrastorage.org/storage3/06d/3e0/045/06d3e0045dfaa401e0a86bde2dd1acae.png"></div><br><div style="text-align:center;"><img src="http://habrastorage.org/storage3/580/4ad/623/5804ad62322d786225d69b9e2fbaddb6.png"></div><br>  <b>Useful articles:</b> <br>  <a href="https://wiki.debian.org/LXC">Debian Wiki LXC</a> <br>  <a href="http://sylvain.fankhauser.name/blog/LxcIn30Minutes.html">Setting up LXC containers in 30 minutes</a> <br>  <a href="https://help.ubuntu.com/12.04/serverguide/lxc.html">Ubuntu Server Guide LXC</a> <br>  <a href="http://www.ibm.com/developerworks/ru/library/l-lxc-containers/">LXC: Linux Container Utilities</a> <br>  <a href="http://www.ibm.com/developerworks/ru/library/l-lxc-containers/">Secure Linux Containers Guide</a> </div><p>Source: <a href="https://habr.com/ru/post/202482/">https://habr.com/ru/post/202482/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../202466/index.html">Benefits of C ++ as a first language for learning programming</a></li>
<li><a href="../202468/index.html">vbulletin.com hacked</a></li>
<li><a href="../202474/index.html">Communication on the Internet: earlier and now (part 2)</a></li>
<li><a href="../202476/index.html">Tiny Snake in JavaScript (30 lines of code)</a></li>
<li><a href="../202480/index.html">Writing your Gradle plugin for AnnotatedSql</a></li>
<li><a href="../202484/index.html">WidLib - declarative js framework for building widgets</a></li>
<li><a href="../202486/index.html">Reduction of dimensions in the linear binary classification problem (eg SVM)</a></li>
<li><a href="../202488/index.html">On content filtering in schools. Problems</a></li>
<li><a href="../202490/index.html">How I went to World Usability Day</a></li>
<li><a href="../202496/index.html">2GIS: yesterday, today, tomorrow</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>