<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Alteration of cash registers. Part 1</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Good day everyone. Several years ago, I accidentally got into the hands of an old written-off cash register. It was called "Elves micro-F". Since I'm ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Alteration of cash registers. Part 1</h1><div class="post__text post__text-html js-mediator-article"><p>  Good day everyone.  Several years ago, I accidentally got into the hands of an old written-off cash register.  It was called "Elves micro-F".  Since  I'm interested in electronics and programming, including the construction of various devices on microcontrollers, the device decided to explore.  Having examined it, I saw: </p><br><ul><li>  board with electronic filling and AT89C52 microcontroller in socket </li><li>  display </li><li>  thermal printer </li><li>  battery </li><li>  film keyboard </li><li>  two LEDs </li></ul><a name="habracut"></a><br><p><img src="http://avsrv2.sytes.net/pics/kassa/IMAG0162.jpg" alt="image"><br>  <em>Fig.1 Appearance cashier</em> </p><br><p>  At that time, I already had the experience of creating unpretentious devices from scratch (a clock, a relay controlled from a COM port, etc.).  Understanding the finished device seemed much more difficult.  For a start, I found on the network a description of this device, a schematic, repair documentation.  As it turned out, there are several schemes, they differ quite strongly, although the devices are called almost the same.  But in the end, I found the desired scheme.  He looked at her and realized that in fact the cash register device is not so complicated. </p><br><p>  I needed to figure out: </p><br><ul><li>  how easy it is to program the microcontroller so as not to go back and forth to the programmer, then back to the board </li><li>  how to exchange computer </li><li>  how to work with RAM (and there was a serial AT24C08) </li><li>  how to draw something on display </li><li>  how to get keystrokes </li><li>  and the most important thing!  how to display something meaningful on a thermal printer </li></ul><br><p>  In this article, I will talk about the beginning of my work.  The ultimate goal is to create a thermal printer from an old, withdrawn cash register. </p><br><p>  Part 1 <br>  Start </p><br><p>  At first, I decided to abandon the microcontroller that stood in the board.  First, it was possible to program it only on the programmer, which I haven‚Äôt had for this type of controllers yet.  Secondly, he had little internal flash memory for programs. <br>  Having suffered from a choice, I stopped on the Winbond w78e58b microcontroller.  He was in the same package (plcc44), had 32K of program memory and more internal static memory for storing variables, and most importantly, he allowed himself to be programmed using an in-circuit programmer without removing it from the panel! </p><br><p>  But even here there was a difficulty: to start programming it, a parallel programmer was needed for this type of microcontroller, in order to sew up the bootloader, with which I would later upload my firmware.  Information on how to make such a programmer I found on the Internet, gathered a programmer, stitched bootloader! </p><br><p>  Then there was another problem - this unit did not have a connector for connecting to a PC! </p><br><p><img src="http://avsrv2.sytes.net/pics/kassa/int_plats_big.jpg" alt="image"><br>  <em>Fig.2 Original interface board</em> <em><br></em> <br>  Although, as I read in the manuals, there was such a handkerchief, and there were plugs in the case for the device and a connector on the board, but the pairing did not work out.  At that time, it was on sale nowhere, and it cost the poor people money.  Then I decided to make the interface myself.  I broke one plug out of the case, disassembled the socket from the local network with a RJ45 connector, cut this connector into a piece of board and pasted it into the cash register case with hot melt glue.  As a result, the normal twisted pair was perfectly inserted outside the click!  It remains to connect the connector pins to the microcontroller.  Of course, it is impossible directly, it is necessary through a level converter, for example MAX232.  On a small piece of breadboard placed the microcircuit itself, strapping capacitors, soldered the wiring.  Soldered the cable to connect to the computer from a piece of twisted pair.  On the one hand, the usual RJ45 connector, on the other hand, the DB9 mother for the COM port connector. </p><br><p>  The next task was to find a compiler, free and not very difficult for such purposes.  I got keil microvision.  It was some kind of demo version with a limit on the length of the code.  For my purposes, enough.  The first program was simple: just put something like Hello world on a computer into a terminal program! </p><br><p>  I wrote the program, the complexity was only in the initial initialization of ports and service registers.  But looking for examples online, I quickly coped with this.  Next, I launched the program <br>  8051IspWriter, which fills the firmware.  In order for the microcontroller to enter the firmware download mode, it was necessary to activate the built-in bootloader.  As it turned out, this can be done by closing the controller output to the ground before energizing.  What exactly - found in the datasheet on the microcontroller.  The firmware was flooded, after which I turned off, turned on the cashier and saw my text on the terminal screen!  The system worked! </p><br><p>  Further, I decided to control the cash register a little, or rather to flash the LED.  According to the scheme, I determined which leg of the microcontroller this LED is on, I wrote the simplest flasher and the LED began to flash at the checkout!  The path has already become visible to the final goal! </p><br><p>  Excerpts from source code: </p><br><pre><code class="hljs cs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">main</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">void</span></span></span></span></span><span class="hljs-function">)</span></span> { UCHAR i; <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> c; <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> data <span class="hljs-keyword"><span class="hljs-keyword">value</span></span>; UCHAR bCassaTypeOld; UCHAR iNumSymbolsOld; jmpLDROM=<span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-comment"><span class="hljs-comment">//            P0 |= 0x01; // PPWR = 1 P1 |= 0x20; // PM1 = 1 P1 |= 0x40; // PM2 = 1 P3 &amp;= ~0x40; // SI = 0 P3 &amp;= ~0x20; // CLOCK = 0 P3 |= 0x80; // LATCH = 1 P3 |= 0x10; // STBA = 1 P3 |= 0x08; // STBB = 1 //          initUart(BAUD_RATE_19200); puts("Hello world!"); while(1) ; }</span></span></code> </pre> </div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <p>Source: <a href="https://habr.com/ru/post/424627/">https://habr.com/ru/post/424627/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../424615/index.html">Outputting the curve function for smoothly limiting parameters, signals and not only in Wolfram Mathematica</a></li>
<li><a href="../424619/index.html">Yandex will launch an open top runet site before the end of the year</a></li>
<li><a href="../424621/index.html">Non-carved superheroes. Who and how protects the construction site of Lakhta Center from fires?</a></li>
<li><a href="../424623/index.html">Let's process the sound on Go</a></li>
<li><a href="../424625/index.html">The leak of the source code of web services "Aeroflot"</a></li>
<li><a href="../424629/index.html">How can a startup increase its chances of investing when communicating with an investor?</a></li>
<li><a href="../424633/index.html">How STACKLEAK Improves Linux Kernel Security</a></li>
<li><a href="../424635/index.html">Welcome to Sberbank Data Science Journey 2018 - a race for machine learning algorithms</a></li>
<li><a href="../424637/index.html">Magic barcode</a></li>
<li><a href="../424639/index.html">Google turned 20 years old</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>