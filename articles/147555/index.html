<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Low blood count</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Once it was necessary to conduct an ‚Äúinventory‚Äù, that is, to find out at which computer, which user is sitting. 

 The option to go through workplaces...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Low blood count</h1><div class="post__text post__text-html js-mediator-article">  Once it was necessary to conduct an ‚Äúinventory‚Äù, that is, to find out at which computer, which user is sitting. <br><br>  The option to go through workplaces to see, ask around, was discarded as heretical. <br>  Since all users are set up in Active Directory, just like workstations, the idea was born of tearing out all the necessary information from AD.  Of course, it was possible to contact the domain administrator and ask all the data from him, but we are not looking for easy ways. <br><a name="habracut"></a><br>  So, for the inventory You need: <br><ul><li>  Network computer name. (All computers under Win different versions) </li><li>  Mac address of this computer. (All computers are on the same subnet 255.255.0.0) </li><li>  The name of the user who is assigned to this computer. </li></ul><br><br>  And the most important condition is the extreme unwillingness to install any third-party applications on the computer, to write an application in the "correct" languages, it was also lazy.  Therefore, VBS was chosen for implementation, since it has everything that is needed and nothing needs to be put in addition and the most lightweight environment for it is notepad.exe. <br>  With network names, everything is simple, they are in the directory service.  An example of working with AD from VBS is quite fast.  To get a list of object attributes, a script was written. <br>  comrade Andrew J. Healey <a href="http://halfloaded.com/blog/list-all-user-object-attributes-in-active-directory-schema-whew/">listAllProperties</a> <br>  So get the names of computers turned out such a simple script. <br><pre><code class="vbscript hljs"><span class="hljs-keyword"><span class="hljs-keyword">set</span></span> cn=<span class="hljs-built_in"><span class="hljs-built_in">CreateObject</span></span>(<span class="hljs-string"><span class="hljs-string">"ADODB.Connection"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> cmd=<span class="hljs-built_in"><span class="hljs-built_in">CreateObject</span></span>(<span class="hljs-string"><span class="hljs-string">"ADODB.Command"</span></span>) cn.Provider=<span class="hljs-string"><span class="hljs-string">"ADsDSOObject"</span></span> cn.Open <span class="hljs-string"><span class="hljs-string">"Active Directory Provider"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> cmd.ActiveConnection=cn  SQL    Active directory     <span class="hljs-string"><span class="hljs-string">"Computer"</span></span> cmd.CommandText=<span class="hljs-string"><span class="hljs-string">"SELECT * FROM 'LDAP://DC=***,DC=ru' WHERE objectClass='Computer'"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> objRecordSet=cmd.<span class="hljs-keyword"><span class="hljs-keyword">Execute</span></span> <span class="hljs-keyword"><span class="hljs-keyword">on</span></span> <span class="hljs-keyword"><span class="hljs-keyword">error</span></span> <span class="hljs-keyword"><span class="hljs-keyword">resume</span></span> <span class="hljs-keyword"><span class="hljs-keyword">next</span></span> <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Not</span></span> objRecordSet.Eof <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> objComputer=<span class="hljs-built_in"><span class="hljs-built_in">GetObject</span></span>(objRecordSet(<span class="hljs-string"><span class="hljs-string">"adspath"</span></span>)) <span class="hljs-comment"><span class="hljs-comment">'    ,       '   ,    if(inSTR(1,objComputer.distinguishedName,"OU=Garbage",vbTextCompare) = 0)then wscript.echo objComputer.CN '        end if objRecordSet.MoveNext Loop</span></span></code> </pre> 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Next, you need to get the MAC address of these computers.  Everything is simple, using the standard ‚Äúnbtstat‚Äù utility with the ‚Äú-a‚Äù parameter you can get what you are looking for (there is of course another option with arp -a, but it does not always work). <br><pre> <code class="vbscript hljs"> <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> oShell=Wscript.<span class="hljs-built_in"><span class="hljs-built_in">CreateObject</span></span>(<span class="hljs-string"><span class="hljs-string">"wscript.shell"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> re=<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-built_in"><span class="hljs-built_in">regexp</span></span> <span class="hljs-comment"><span class="hljs-comment">'   MAC  re.Pattern = "[0-9A-F]{2}-[0-9A-F]{2}-[0-9A-F]{2}-[0-9A-F]{2}-[0-9A-F]{2}-[0-9A-F]{2}" '    ComputerNetworkName       AD set oExec=oShell.Exec("nbtstat -a" &amp; ComputerNetworkName) for each obj in re.execute(oExec.StdOut.ReadAll) GetData=obj.value next</span></span></code> </pre> <br>  Now the question arises: "Where sobsno get a list of users registered on this computer?".  By a short googling, many methods were found that boiled down to remote execution of the wmi script.  This path did not suit me, since remote execution of scripts is prohibited in the domain.  And then I remembered that in Windows, by default, 2 registry keys are available for reading on the network, namely ‚ÄúHKEY_USERS‚Äù and ‚ÄúHKEY_LOCAL_MACHINE‚Äù. <br>  This means that you can get the SID for registered users using the ‚Äúreg‚Äù utility and the code that we used to get the MAC address will help us in this, all that needs to be changed in it is the regular template and the command text. <br><pre> <code class="vbscript hljs"> <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> oShell=Wscript.<span class="hljs-built_in"><span class="hljs-built_in">CreateObject</span></span>(<span class="hljs-string"><span class="hljs-string">"wscript.shell"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> re=<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-built_in"><span class="hljs-built_in">regexp</span></span> <span class="hljs-comment"><span class="hljs-comment">'   SID    reg query re.Pattern = "S-\d+-\d+-\d+-\d+-\d+-\d+-\d+" '    ComputerNetworkName       AD set oExec=oShell.Exec("reg query \\" &amp; iComputerNetworkName&amp;"\HKEY_USERS") for each obj in re.execute(oExec.StdOut.ReadAll) GetData=obj.value next</span></span></code> </pre> <br>  Well, we have good sids, but they do not look like full names, at all.  To get a full name again have to contact AD. <br>  Each object in AD has a ‚ÄúobjectSID‚Äù field, which means that you can select information about the user, therefore, you can sit by yourself.  To do this, take the code that we used to get the list of computers, and change the query in the ‚Äúcmd.commandtext‚Äù field in it: <br><br><pre> <code class="vbscript hljs"> <span class="hljs-keyword"><span class="hljs-keyword">dim</span></span> cn,cmd,objRecordSet <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> cn=<span class="hljs-built_in"><span class="hljs-built_in">CreateOBject</span></span>(<span class="hljs-string"><span class="hljs-string">"ADODB.Connection"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> cmd=<span class="hljs-built_in"><span class="hljs-built_in">CreateObject</span></span>(<span class="hljs-string"><span class="hljs-string">"ADODB.Command"</span></span>) cn.Provider=<span class="hljs-string"><span class="hljs-string">"ADsDSOObject"</span></span> cn.Open <span class="hljs-string"><span class="hljs-string">"Active Directory Provider"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> cmd.ActiveConnection=cn <span class="hljs-comment"><span class="hljs-comment">' objSid       . cmd.CommandText="SELECT * FROM 'LDAP://DC=***,DC=ru' where objectClass='User' and objectSid='"&amp; objSid &amp;"' " set objRecordSet=cmd.Execute '      if( not objRecordSet.Eof) then set objUser=GetObject(objRecordSet("adspath")) if(inSTR(1,objUser.distinguishedName,"OU=Garbage",vbTextCompare) = 0)then '    ,      ,   . Wscript.Echo objUser.FirstName &amp;" "&amp; objUser.LastName &amp;" "&amp; objUser.Patronim end if end if</span></span></code> </pre> <br>  Well, that's all the necessary data obtained, and even if they change in the future to get them, it will not be a problem (unless of course the directory service is reorganized).  And most importantly, I did not have to run, the whole enterprise was looking for computers and users. </div><p>Source: <a href="https://habr.com/ru/post/147555/">https://habr.com/ru/post/147555/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../147549/index.html">Geomagnetic positioning as an addition to GPS</a></li>
<li><a href="../147551/index.html">On the bill number 89417-6</a></li>
<li><a href="../147552/index.html">Tons of garbage and a minimum of useful work or scrolling in Idea</a></li>
<li><a href="../147553/index.html">Kickstarter is gradually becoming international - England is the first</a></li>
<li><a href="../147554/index.html">Google close to paying $ 22.5 million fine</a></li>
<li><a href="../147556/index.html">Motorola Atrix HD Smartphone Officially Announced</a></li>
<li><a href="../147557/index.html">Ouya - a new gaming console on Android</a></li>
<li><a href="../147558/index.html">LED paper thickness</a></li>
<li><a href="../147559/index.html">Visualization of links between Wikipedia articles</a></li>
<li><a href="../147560/index.html">How to organize usability testing site?</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>