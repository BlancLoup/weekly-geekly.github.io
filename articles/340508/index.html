<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>How JS works: event loop, asynchrony, and five ways to improve code with async / await</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="[We advise you to read] Other 19 parts of the cycle  Part 1: Overview of the engine, execution time mechanisms, call stack 
 Part 2: About the V8 inte...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>How JS works: event loop, asynchrony, and five ways to improve code with async / await</h1><div class="post__text post__text-html js-mediator-article"><div class="spoiler">  <b class="spoiler_title">[We advise you to read] Other 19 parts of the cycle</b> <div class="spoiler_text">  Part 1: <a href="https://habrahabr.ru/company/ruvds/blog/337042/">Overview of the engine, execution time mechanisms, call stack</a> <br>  Part 2: <a href="https://habrahabr.ru/company/ruvds/blog/337460/">About the V8 internals and code optimization</a> <br>  Part 3: <a href="https://habrahabr.ru/company/ruvds/blog/338150/">Memory management, four types of memory leaks and dealing with them</a> <br>  Part 4: <a href="https://habrahabr.ru/company/ruvds/blog/340508/">Event loop, asynchrony, and five ways to improve code with async / await</a> <br>  Part 5: <a href="https://habrahabr.ru/company/ruvds/blog/342346/">WebSocket and HTTP / 2 + SSE.</a>  <a href="https://habrahabr.ru/company/ruvds/blog/342346/">What to choose?</a> <br>  Part 6: <a href="https://habrahabr.ru/company/ruvds/blog/343568/">Features and Scope of WebAssembly</a> <br>  Part 7: <a href="https://habrahabr.ru/company/ruvds/blog/348424/">Web Workers and Five Use Cases</a> <br>  Part 8: <a href="https://habrahabr.ru/company/ruvds/blog/349858/">Service Workers</a> <br>  Part 9: <a href="https://habrahabr.ru/company/ruvds/blog/350486/">Web push notifications</a> <br>  Part 10: <a href="https://habrahabr.ru/company/ruvds/blog/351256/">Tracking DOM Changes with MutationObserver</a> <br>  Part 11: <a href="https://habrahabr.ru/company/ruvds/blog/351802/">The engines of rendering web pages and tips to optimize their performance</a> <br>  Part 12: <a href="https://habr.com/company/ruvds/blog/354070/">Browser networking subsystem, optimizing its performance and security</a> <br>  Part 12: <a href="https://habr.com/company/ruvds/blog/354070/">Browser networking subsystem, optimizing its performance and security</a> <br>  Part 13: <a href="https://habr.com/company/ruvds/blog/354438/">Animation with CSS and JavaScript</a> <br>  Part 14: <a href="https://habr.com/company/ruvds/blog/415269/">How JS works: abstract syntax trees, parsing and its optimization</a> <br>  Part 15: <a href="https://habr.com/company/ruvds/blog/415377/">How JS Works: Classes and Inheritance, Babil and TypeScript Transformation</a> <br>  Part 16: <a href="https://habr.com/company/ruvds/blog/415505/">How JS Works: Storage Systems</a> <br>  Part 17: <a href="https://habr.com/company/ruvds/blog/415881/">How JS Works: Shadow DOM Technology and Web Components</a> <br>  Part 18: <a href="https://habr.com/company/ruvds/blog/416821/">How JS: WebRTC and P2P Communication Mechanisms Work</a> <br>  Part 19: <a href="https://habr.com/company/ruvds/blog/419831/">How JS Works: Custom Elements</a> </div></div><br>  Here is the fourth part of a series of materials on the internal features of the work of JavaScript.  These materials, on the one hand, are aimed at studying the basic elements of the JS language and ecosystem, on the other hand, they provide recommendations based on the software development practice in <a href="https://www.sessionstack.com/">SessionStack</a> .  A competitive JS application should be fast and reliable.  The creation of such applications is the goal to which, ultimately, anyone who is interested in the mechanisms of JavaScript aims. <br><br> <a href="https://habrahabr.ru/company/ruvds/blog/340508/"><img src="https://habrastorage.org/getpro/habr/post_images/332/824/d1e/332824d1eb324b831f5b28e15f1759ff.jpg" alt="image"></a> <br><a name="habracut"></a><br>  This article can be considered the development of the <a href="https://habrahabr.ru/company/ruvds/blog/337042/">first</a> material.  The limitations of the single-threaded execution model will be discussed here, and we will talk about how to overcome these limitations.  For example - to develop high-quality user interfaces on JS.  As usual, at the end of the material practical recommendations on the use of the considered technologies will be given.  Since the main topic of this article is asynchronous development, there will be five tips for improving code using <code>async / await</code> . <br><br><h2>  <font color="#3AC1EF">Restrictions of single-threaded code execution model</font> </h2><br>  In the first article, we reflected on the following question: ‚ÄúWhat happens when there is a function in the call stack that needs a lot of time to execute?‚Äù.  We continue these reflections. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Imagine a complex image processing algorithm, the implementation of which runs in a browser.  When there is a working function in the call stack, the browser can do nothing more.  It is locked.  This means that the browser cannot display anything on the screen, it cannot execute other code.  The most noticeable consequence of this situation is the ‚Äúbrake‚Äù of the user interface.  The webpage is simply "stuck." <br><br>  In some cases, this may not be such a serious problem.  However, this is not the worst.  As soon as the browser starts to perform too many tasks, it may not react for quite a long time to the user's actions.  Usually in such a situation, browsers take protective measures and give an error message, asking the user whether to close the problem page.  It would be better for the user not to see such messages.  They completely destroy all the efforts of developers to create beautiful and user-friendly interfaces. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/07b/41e/6db/07b41e6db4a590c3b28cc2e6d02c8026.jpg"></div><br>  What if you want a web application to look good and perform complex calculations?  We begin the search for an answer to this question with an analysis of the building blocks of JS applications. <br><br><h2>  <font color="#3AC1EF">Building blocks of JavaScript programs</font> </h2><br>  JavaScript application code can be placed in a single .js file, but it will almost certainly consist of several blocks.  At the same time, only one of these blocks will be executed at a certain moment in time, say - right now.  The rest will be executed later.  The most common blocks of code in JavaScript are functions. <br><br>  Apparently, most new JS developers are not fully aware of the fact that "later" does not necessarily immediately follow "now."  In other words, a task that cannot be performed "now" must be performed asynchronously.  This means that we will not encounter blocking behavior that you, perhaps unconsciously, could expect. <br><br>  Take a look at the following example: <br><br><pre> <code class="hljs pgsql">// ajax(..) -   Ajax- var response = ajax(<span class="hljs-string"><span class="hljs-string">'https://example.com/api'</span></span>); console.log(response); //   response     api</code> </pre> <br>  You may be aware that standard Ajax requests are not executed synchronously.  This means that the <code>ajax(..)</code> function, immediately after its call, cannot return some value that could be assigned to the <code>response</code> variable. <br><br>  A simple mechanism for organizing the "waiting" result returned by an asynchronous function is the use of so-called callback functions, or callbacks: <br><br><pre> <code class="hljs lisp">ajax('https<span class="hljs-symbol"><span class="hljs-symbol">://example</span></span>.com/api', function(<span class="hljs-name"><span class="hljs-name">response</span></span>) {   console.log(<span class="hljs-name"><span class="hljs-name">response</span></span>)<span class="hljs-comment"><span class="hljs-comment">; //   response   api });</span></span></code> </pre> <br>  Here I would like to note that you can execute an Ajax request synchronously.  However, this should not be done.  If you perform a synchronous Ajax request, the user interface of the JS application will be blocked.  The user will not be able to click on the button, enter data in the field, he will not even be able to scroll the page.  Synchronous execution of Ajax requests will not allow the user to interact with the application.  Such an approach, although possible, leads to disastrous consequences. <br><br>  This is how this horror looks, however, please never write anything like this, do not turn the web into a place where it is impossible to work normally: <br><br><pre> <code class="hljs lua">//   ,    jQuery jQuery.ajax({   url: <span class="hljs-string"><span class="hljs-string">'https://api.example.com/endpoint'</span></span>,   success: <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(response)</span></span></span></span> {       //  - .   },   async: <span class="hljs-literal"><span class="hljs-literal">false</span></span> //    - ,      });</code> </pre> <br>  Here we gave examples on Ajax requests, however, any piece of code can be run asynchronously. <br><br>  For example, you can do this using the <code>setTimeout(callback, milliseconds)</code> function.  It allows you to schedule the execution of events (setting a time-out) that should occur after the moment when the function is called.  Consider an example: <br><br><pre> <code class="hljs javascript"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">first</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{   <span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.log(<span class="hljs-string"><span class="hljs-string">'first'</span></span>); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">second</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{   <span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.log(<span class="hljs-string"><span class="hljs-string">'second'</span></span>); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">third</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{   <span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.log(<span class="hljs-string"><span class="hljs-string">'third'</span></span>); } first(); setTimeout(second, <span class="hljs-number"><span class="hljs-number">1000</span></span>); <span class="hljs-comment"><span class="hljs-comment">//   second  1000  third();</span></span></code> </pre> <br>  This is what this code will bring to the console: <br><br><pre> <code class="hljs vbscript">first third <span class="hljs-built_in"><span class="hljs-built_in">second</span></span></code> </pre> <br><h2>  <font color="#3AC1EF">Study of the cycle of events</font> </h2><br>  This may seem strange, but prior to ES6 JavaScript, although it allowed you to make asynchronous calls (like <code>setTimeout</code> described above), it did not contain any built-in asynchronous programming mechanisms.  JS engines were only doing single-threaded execution of certain code fragments, one at a time. <br><br>  To learn more about how JavaScript engines (and, in particular, V8) work, take a look at <a href="https://habrahabr.ru/company/ruvds/blog/337460/">this material</a> . <br><br>  So, who tells the JS engine that he has to execute a certain fragment of the program?  In reality, the engine does not work in isolation - its own code is executed inside some environment, which, for most developers, is either a browser or Node.js.  In fact, these days there are JS engines for various types of devices - from robots to smart light bulbs.  Each such device represents its own version of the environment for the JS-engine. <br><br>  A common characteristic of all such environments is the built-in mechanism, which is called the event loop.  It supports the execution of program fragments, invoking the JS engine for this. <br><br>  This means that the engine can be considered as the runtime environment for any JS code called on demand.  And event planning (that is, JS code execution sessions) is handled by environmental mechanisms external to the engine. <br><br>  So, for example, when your program performs an Ajax request to load some data from the server, you write a command to write this data to the <code>response</code> variable inside the callback, and the JS engine tells the environment: ‚ÄúListen, I'm going to pause the program, but when you finish this network request and get some data, please call this callback. ‚Äù <br><br>  The browser then installs a listener waiting for a response from the network service, and when it has something to return to the program that made the request, it schedules a callback call, adding it to the event loop. <br><br>  Take a look at the following diagram: <br><img src="https://habrastorage.org/getpro/habr/post_images/4d8/4ac/86a/4d84ac86aaa8de45acf34a16ae928191.png"><br>  Details about the heap (memory heap) and the call stack can be found <a href="https://habrahabr.ru/company/ruvds/blog/337042/">here</a> .  And what are the Web API?  In general, these are streams to which we do not have direct access; we can only perform calls to them.  They are built into the browser, where asynchronous actions are performed. <br><br>  If you are developing under Node.js, then similar APIs are implemented using C ++ tools. <br><br>  So what is the event loop? <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/90f/171/c7c/90f171c7cbf3d192fccdfec1efabe31c.png"></div><br>  The event loop solves one main task: it watches the call stack and the callback queue.  If the call stack is empty, the loop takes the first event from the queue and pushes it onto the stack, which causes the event to run. <br><br>  Such an iteration is called a tick of the event loop.  Every event is just a callback. <br><br>  Consider the following example: <br><br><pre> <code class="hljs lua">console.<span class="hljs-built_in"><span class="hljs-built_in">log</span></span>(<span class="hljs-string"><span class="hljs-string">'Hi'</span></span>); setTimeout(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">cb1</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> {   console.<span class="hljs-built_in"><span class="hljs-built_in">log</span></span>(<span class="hljs-string"><span class="hljs-string">'cb1'</span></span>); }, <span class="hljs-number"><span class="hljs-number">5000</span></span>); console.<span class="hljs-built_in"><span class="hljs-built_in">log</span></span>(<span class="hljs-string"><span class="hljs-string">'Bye'</span></span>);</code> </pre> <br>  Let's take a step by step execution of this code and see what happens in the system. <br><br>  1. Nothing happens yet.  The browser console is clean, the call stack is empty. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/534/77c/931/53477c931e41e771397efad07c357130.png"><br>  2. The <code>console.log('Hi')</code> command is added to the call stack. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/0f2/b0a/e2b/0f2b0ae2bb295fa111b4afe4abd83e14.png"><br>  3. The <code>console.log('Hi')</code> command is executed. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/23e/31a/2fa/23e31a2fac1ce200a27dcfeb0e25b124.png"><br>  4. The <code>console.log('Hi')</code> command is removed from the call stack. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/a4f/6b1/154/a4f6b1154446cfa033c281c0b7682d17.png"><br>  5. The <code>setTimeout(function cb1() { ... })</code> command is added to the call stack. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/3ca/2a7/70c/3ca2a770cff4d87e49a0e5179be17014.png"><br>  6. The <code>setTimeout(function cb1() { ... })</code> command is executed.  The browser creates a timer that is part of the Web API.  It will perform a countdown. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/61a/02d/e50/61a02de50fe1f952b2fd61b94d095141.png"><br>  7. The <code>setTimeout(function cb1() { ... })</code> command has completed and is removed from the call stack. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/544/a1b/4bc/544a1b4bcae490cca01355a1804d7d5c.png"><br>  8. The <code>console.log('Bye')</code> command is added to the call stack. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/1ef/24e/046/1ef24e0465756ca67f9994e658ac98ed.png"><br>  9. The <code>console.log('Bye')</code> command is executed. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/32f/ab2/b41/32fab2b41b38c3734b59d75ad5fd4316.png"><br>  10. The command <code>console.log('Bye')</code> is removed from the call stack. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/fc6/de7/c17/fc6de7c17760e6e5f762c2a982bd8257.png"><br>  11. After at least 5000 ms have <code>cb1</code> , the timer ends and puts the cb1 <code>cb1</code> on the callback queue. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/8a8/093/46d/8a809346d5c957dc1cd2ab141bcc8d8b.png"><br>  12. The event loop takes the <code>cb1</code> function from the <code>cb1</code> queue and pushes it onto the call stack. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/b6e/4b3/ad1/b6e4b3ad16216a709bf0c61dc61343b2.png"><br>  13. The <code>cb1</code> function <code>cb1</code> executed and adds <code>console.log('cb1')</code> to the call stack. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/f08/b46/a60/f08b46a60b4063b96184a4411f2194ab.png"><br>  14. The command <code>console.log('cb1')</code> is executed. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/99d/07f/53d/99d07f53d4d5e8338e87d229569748d1.png"><br>  15. The <code>console.log('cb1')</code> command <code>console.log('cb1')</code> is removed from the call stack. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/af0/395/ab5/af0395ab5d5c6bcf7af8ccf7461a707c.png"><br>  16. The function <code>cb1</code> is removed from the call stack. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/c42/7bf/b21/c427bfb217d4e861d6e3849b85be787d.png"><br>  Here, for fixing, the same in animated form. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/5c5/b41/e37/5c5b41e37c793ce1fad4f342257bbede.gif"><br>  It is interesting to note that the ES6 specification defines how the event loop should work, namely, it indicates that it is technically within the responsibility of the JS engine, which is beginning to play a more important role in the JS ecosystem.  The main reason for this is that promises appeared in ES6 and they need a reliable mechanism for scheduling operations in the event loop queue. <br><br><h2>  <font color="#3AC1EF">How setTimeout (...) works</font> </h2><br>  Calling <code>setTimeout(‚Ä¶)</code> does not automatically place a callback in the event loop queue.  This command starts the timer.  When the timer is triggered, the environment puts the callback in the event loop, as a result, during some of the future ticks, this callback will be taken into work and executed.  Take a look at this code snippet: <br><br><pre> <code class="hljs lisp">setTimeout(<span class="hljs-name"><span class="hljs-name">myCallback</span></span>, <span class="hljs-number"><span class="hljs-number">1000</span></span>)<span class="hljs-comment"><span class="hljs-comment">;</span></span></code> </pre> <br>  Running this command does not mean that <code>myCallback</code> will be executed in 1000 ms. It would be more correct to say that in 1000 ms.  <code>myCallback</code> will be added to the queue.  In the queue, however, there may be other events added there earlier, as a result, our callback will have to wait. <br><br>  There are quite a few articles intended for those who are just starting to engage in asynchronous programming in JavaScript.  You can find recommendations for using the <code>setTimeout(callback, 0)</code> command in them.  Now you know how the event loop works and what happens when you call <code>setTimeout</code> .  Given this, it is quite obvious that a call to <code>setTimeout</code> with the second argument equal to 0 simply postpones the callback call until the call stack is cleared. <br><br>  Take a look at the following example: <br><br><pre> <code class="hljs lua">console.<span class="hljs-built_in"><span class="hljs-built_in">log</span></span>(<span class="hljs-string"><span class="hljs-string">'Hi'</span></span>); setTimeout(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> {   console.<span class="hljs-built_in"><span class="hljs-built_in">log</span></span>(<span class="hljs-string"><span class="hljs-string">'callback'</span></span>); }, <span class="hljs-number"><span class="hljs-number">0</span></span>); console.<span class="hljs-built_in"><span class="hljs-built_in">log</span></span>(<span class="hljs-string"><span class="hljs-string">'Bye'</span></span>);</code> </pre> <br>  Although the time for which the timer is set is 0 ms., The following will be displayed in the console: <br><br><pre> <code class="hljs nginx"><span class="hljs-attribute"><span class="hljs-attribute">Hi</span></span> Bye callback</code> </pre> <br><h2>  <font color="#3AC1EF">ES6 tasks</font> </h2><br>  ES6 has a new concept called Job Queue.  This design can be considered a layer located on top of the event loop queue.  It is quite possible that you came across it when you had to deal with the peculiarities of the asynchronous behavior of promises. <br><br>  We will now describe this in a nutshell; as a result, when we talk about asynchronous development using promises, you will understand how asynchronous actions are planned and processed. <br><br>  Imagine this: a job queue is a queue that is attached to the end of each tick in the event loop queue.  Some asynchronous actions that may occur during a tick of an event cycle will not cause a new event to be added to the queue of the event loop, but instead an item (that is, a task) will be added to the end of the current tick's job queue.  This means that by adding commands to the queue that must be executed in the future, you can be sure of the order in which they will be executed. <br><br>  Running a job can add additional jobs to the end of the same queue.  In theory, it is possible that the ‚Äúcyclical‚Äù task (the task that deals with the addition of other tasks) worked endlessly, depleting the program resources necessary for the transition to the next tick of the cycle of events.  Conceptually, this would be like creating an infinite loop like <code>while(true)</code> . <br><br>  Tasks are something like ‚Äúhack‚Äù s <code>etTimeout(callback, 0)</code> , but implemented in such a way that they allow the observance of a sequence of operations that are performed later, but as soon as possible. <br><br><h2>  <font color="#3AC1EF">Callbacks</font> </h2><br>  As you already know, callbacks are the most common means of expressing and performing asynchronous actions in JavaScript programs.  Moreover, a callback is the most fundamental asynchronous language pattern.  Countless JS-applications, even very clever and complex, based solely on callbacks. <br><br>  All this is good, but callbacks are not perfect.  Therefore, many developers are trying to find more successful asynchronous development patterns.  It is impossible, however, to effectively use any abstraction, not understanding how everything works, as they say, under the hood. <br><br>  Below we will look at a couple of such abstractions in detail in order to show why more advanced asynchronous templates, which we will talk about later, are necessary and even recommended for use. <br><br><h2>  <font color="#3AC1EF">Nested callbacks</font> </h2><br>  Take a look at the following code: <br><br><pre> <code class="hljs actionscript">listen(<span class="hljs-string"><span class="hljs-string">'click'</span></span>, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(e)</span></span></span></span>{   setTimeout(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>{       ajax(<span class="hljs-string"><span class="hljs-string">'https://api.example.com/endpoint'</span></span>, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(text)</span></span></span></span>{           <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (text == <span class="hljs-string"><span class="hljs-string">"hello"</span></span>) {       doSomething();   }   <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (text == <span class="hljs-string"><span class="hljs-string">"world"</span></span>) {       doSomethingElse();           }       });   }, <span class="hljs-number"><span class="hljs-number">500</span></span>); });</code> </pre> <br>  Here there is a chain of three functions nested in each other, each of them is a step in a sequence of actions performed asynchronously. <br><br>  This code is often called callback hell.  But the ‚Äúhell‚Äù is not in the fact that the functions are nested, and not in the fact that the code blocks have to be aligned relative to each other.  This is a much deeper problem. <br><br>  Let's sort this code.  First, we wait for the <code>click</code> event, then wait for the timer to trigger, and finally, wait for the arrival of an Ajax response, after which it can all happen again. <br><br>  At first glance it might seem that this code expresses its asynchronous nature quite naturally, in the form of successive steps.  Here is the first step: <br><br><pre> <code class="hljs actionscript">listen(<span class="hljs-string"><span class="hljs-string">'click'</span></span>, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(e)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-comment"><span class="hljs-comment">// .. });</span></span></code> </pre> <br>  Here is the second: <br><br><pre> <code class="hljs actionscript">setTimeout(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>{   <span class="hljs-comment"><span class="hljs-comment">// .. }, 500);</span></span></code> </pre> <br>  Here is the third: <br><br><pre> <code class="hljs lisp">ajax('https<span class="hljs-symbol"><span class="hljs-symbol">://api</span></span>.example.com/endpoint', function (<span class="hljs-name"><span class="hljs-name">text</span></span>){   // .. })<span class="hljs-comment"><span class="hljs-comment">;</span></span></code> </pre> <br>  And finally, this is what happens: <br><br><pre> <code class="hljs pgsql"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-type"><span class="hljs-type">text</span></span> == "hello") {   doSomething(); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-type"><span class="hljs-type">text</span></span> == "world") {   doSomethingElse(); }</code> </pre> <br>  So, a similar approach to writing asynchronous code looks much more natural, right?  There must be a way to write it that way. <br><br><h2>  <font color="#3AC1EF">Promises</font> </h2><br>  Take a look at the following code snippet: <br><br><pre> <code class="hljs javascript"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> x = <span class="hljs-number"><span class="hljs-number">1</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> y = <span class="hljs-number"><span class="hljs-number">2</span></span>; <span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.log(x + y);</code> </pre> <br>  It's all very simple: the values ‚Äã‚Äãof the variables <code>x</code> and <code>y</code> added and displayed in the console.  But what if the value of <code>x</code> or <code>y</code> not available and it has yet to be set?  Let's say we need to get from the server what will be written in <code>x</code> and <code>y</code> , and then use this data in the expression.  Imagine that we have the functions <code>loadX</code> and <code>loadY</code> , which, respectively, load <code>x</code> and <code>y</code> values ‚Äã‚Äãfrom the server.  Then imagine that there is a <code>sum</code> function that adds the <code>x</code> and <code>y</code> values ‚Äã‚Äãas they are loaded. <br><br>  It all may look like this (it‚Äôs scary, right?): <br><br><pre> <code class="hljs lua"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">sum</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(getX, getY, callback)</span></span></span></span> {   var x, y;   getX(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(result)</span></span></span></span> {       x = result;       <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (y !== undefined) {           callback(x + y);       }   });   getY(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(result)</span></span></span></span> {       y = result;       <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (x !== undefined) {           callback(x + y);       }   }); } //    ,   `x` <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">fetchX</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> {   // .. } //    ,    `y` <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">fetchY</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> {   // .. } sum(fetchX, fetchY, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(result)</span></span></span></span> {   console.<span class="hljs-built_in"><span class="hljs-built_in">log</span></span>(result); });</code> </pre> <br>  There is one very important thing.  Namely, in this code we treat <code>x</code> and <code>y</code> as values ‚Äã‚Äãthat will be received in the future, and we describe the operation <code>sum(‚Ä¶)</code> (when called without going into the implementation details) as if it doesn't matter to execute , whether or not the <code>x</code> and <code>y</code> values ‚Äã‚Äãare available at the time of its call. <br><br>  Of course, the rough approach presented here based on callbacks leaves much to be desired.  This is only the first small step towards understanding the advantages, which makes it possible to operate with ‚Äúfuture values‚Äù, without worrying about the specific time of their appearance. <br><br><h2>  <font color="#3AC1EF">Promise value</font> </h2><br>  First, take a look at how you can express the <code>x + y</code> operation using promises: <br><br><pre> <code class="hljs matlab"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">sum</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(xPromise, yPromise)</span></span></span><span class="hljs-function"> { // `</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Promise</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">all</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">([ .. ])</span></span></span><span class="hljs-function">`   , //    ,   //   ,     </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">return</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Promise</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">all</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">([xPromise, yPromise])</span></span></span><span class="hljs-function"> //     ,  //   `</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">X</span></span></span><span class="hljs-function">`  `</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Y</span></span></span><span class="hljs-function">`   . .</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">then</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(function(values)</span></span></span><span class="hljs-function">{ // `</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">values</span></span></span><span class="hljs-function">` -      //   </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">return</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">values</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">[0]</span></span></span><span class="hljs-function"> + </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">values</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">[1]</span></span></span><span class="hljs-function">; } ); } // `</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">fetchX</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function">`  `</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">fetchY</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function">`    //  .     //  **  **. </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">sum</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(fetchX()</span></span></span><span class="hljs-function">, </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">fetchY</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function">) //      //  . //     `</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">then</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(...)</span></span></span><span class="hljs-function">`    //    . .</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">then</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(function(sum)</span></span></span><span class="hljs-function">{   </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">console</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">log</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(sum)</span></span></span><span class="hljs-function">; });</span></span></code> </pre> <br>  In this example, there are two layers of promises. <br><br>  The calls <code>fetchX()</code> and <code>fetchY()</code> are executed directly, and the values ‚Äã‚Äãthey return (promises!) Are passed to <code>sum(...)</code> .  Those values ‚Äã‚Äãthat represent these promises may be ready for further use now or later, but each promise behaves in such a way that the moment of accessibility of values ‚Äã‚Äãis not important in itself.  As a result, we reason about the values ‚Äã‚Äãof <code>x</code> and <code>y</code> without reference to time.  These are future values. <br><br>  The second layer of promises is a promise that creates and returns (using <code>Promise.all([ ... ])</code> ) the <code>sum(‚Ä¶)</code> call <code>sum(‚Ä¶)</code> .  We expect the value that this promise will return, causing <code>then(‚Ä¶)</code> .  When the operation <code>sum(‚Ä¶)</code> completed, our future value of the amount is ready and we can display it on the screen.  We hide the logic of waiting for future <code>x</code> and <code>y</code> values ‚Äã‚Äãinside <code>sum(‚Ä¶)</code> . <br><br>    ,   <code>sum(‚Ä¶)</code>  <code>Promise.all([ ‚Ä¶ ])</code>   (   <code>promiseX</code>  <code>promiseY</code> ).  <code>.then(‚Ä¶)</code>    ,   <code>values[0] + values[1]</code>   ( ,   ).  ,  <code>then(‚Ä¶)</code> ,  ,   ,    <code>sum(‚Ä¶)</code> ,        ,    ,    <code>Promise.all([ ... ])</code> .  ,         <code>then(‚Ä¶)</code> ,      ,  ,  ,    .  ,      <code>.then(‚Ä¶)</code>  . <br><br>     <code>then(‚Ä¶)</code> ,   ,   .   ‚Äî  ,    .  ‚Äî  ,    : <br><br><pre> <code class="hljs lua">sum(fetchX(), fetchY()) .<span class="hljs-keyword"><span class="hljs-keyword">then</span></span>(   //       <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(sum)</span></span></span></span> {       console.<span class="hljs-built_in"><span class="hljs-built_in">log</span></span>( sum );   },   //      <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(err)</span></span></span></span> {  console.<span class="hljs-built_in"><span class="hljs-built_in">error</span></span>( err ); // -    } );</code> </pre> <br>     <code>x</code>  <code>y</code> -   ,        , ,   s <code>um(‚Ä¶)</code> ,  .      ,  <code>then(‚Ä¶)</code> ,    .       . <br><br>     ,   ,   ‚Äî       ,   ,   ,   ,    .  ,   ,   ,         . <br><br>  ,    ,       .       () ,        ,  . <br><br>    ,      : <br><br><pre> <code class="hljs lua"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">delay</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(time)</span></span></span></span> {   <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> new Promise(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(resolve, reject)</span></span></span></span>{       setTimeout(resolve, <span class="hljs-built_in"><span class="hljs-built_in">time</span></span>);   }); } delay(<span class="hljs-number"><span class="hljs-number">1000</span></span>) .<span class="hljs-keyword"><span class="hljs-keyword">then</span></span>(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>{   console.<span class="hljs-built_in"><span class="hljs-built_in">log</span></span>(<span class="hljs-string"><span class="hljs-string">"after 1000ms"</span></span>);   <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> delay(<span class="hljs-number"><span class="hljs-number">2000</span></span>); }) .<span class="hljs-keyword"><span class="hljs-keyword">then</span></span>(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>{   console.<span class="hljs-built_in"><span class="hljs-built_in">log</span></span>(<span class="hljs-string"><span class="hljs-string">"after another 2000ms"</span></span>); }) .<span class="hljs-keyword"><span class="hljs-keyword">then</span></span>(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>{   console.<span class="hljs-built_in"><span class="hljs-built_in">log</span></span>(<span class="hljs-string"><span class="hljs-string">"step 4 (next Job)"</span></span>);   <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> delay(<span class="hljs-number"><span class="hljs-number">5000</span></span>); }) // ...</code> </pre> <br>  <code>delay(2000)</code>  ,     2000 .,             <code>then(‚Ä¶)</code> ,    ,    <code>then(‚Ä¶)</code>    2000 . <br><br>    ,    ,  ,     ,        ,   ,       .     ,    ,       .           .   ,    ,  ,   ,       ,      . <br><br><h2> <font color="#3AC1EF">  ?</font> </h2><br>  ,    ,     ,      <code>Promise</code>  .  ,    ,  ,        . <br><br> ,        <code>new Promise(‚Ä¶)</code> ,  ,  ,    <code>p instanceof Promise</code>  .  However, this is not quite true. <br><br>   ,         ( ,  ),          <code>Promise</code> ,   ,       .  ,          ,     . <br><br>  ,     -      ,   ,    ES6.   ,    ,    ,    ,        . <br><br><h2> <font color="#3AC1EF"> </font> </h2><br>              ,  <code>TypeError</code>  <code>ReferenceError</code> ,         . <br><br>  For example: <br><br><pre> <code class="hljs lua">var p = new Promise(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(resolve, reject)</span></span></span></span>{   foo.bar(); // `foo`  ,   !   resolve(<span class="hljs-number"><span class="hljs-number">374</span></span>);  //      :( }); p.<span class="hljs-keyword"><span class="hljs-keyword">then</span></span>(   <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">fulfilled</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>{       //      :(   },   <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">rejected</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(err)</span></span></span></span>{       // `err`    `TypeError`       //   `foo.bar()`.   } );</code> </pre> <br>   ,   ,        JS- ( ,  <code>then(‚Ä¶)</code> )?        ,  ,    ,   ,  : <br><br><pre> <code class="hljs lua">var p = new Promise( <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(resolve,reject)</span></span></span></span>{ resolve(<span class="hljs-number"><span class="hljs-number">374</span></span>); }); p.<span class="hljs-keyword"><span class="hljs-keyword">then</span></span>(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">fulfilled</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(message)</span></span></span></span>{   foo.bar();   console.<span class="hljs-built_in"><span class="hljs-built_in">log</span></span>(message);   //      },   <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">rejected</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(err)</span></span></span></span>{       //     } );</code> </pre> <br> ,  ,   <code>foo.bar()</code>      ¬´¬ª. ,   .     ,   ,    .  ,   <code>p.then(‚Ä¶)</code>   ,         <code>TypeError</code> . <br><br><h2> <font color="#3AC1EF">  </font> </h2><br>        ,      . <br>    ,   ,         <code>done(‚Ä¶)</code> ,    ,     ¬´¬ª.  <code>done(‚Ä¶)</code>      ,  ,  <code>done(‚Ä¶)</code> , ,      ,   ,   . <br><br>  , ,       ,     :        <code>done(‚Ä¶)</code>       (       ): <br><br><pre> <code class="hljs lua">var p = Promise.resolve(<span class="hljs-number"><span class="hljs-number">374</span></span>); p.<span class="hljs-keyword"><span class="hljs-keyword">then</span></span>(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">fulfilled</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(msg)</span></span></span></span>{   //     ,   //        console.<span class="hljs-built_in"><span class="hljs-built_in">log</span></span>(msg.toLowerCase()); }) .done(null, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> {   //    ,       });</code> </pre> <br><h2> <font color="#3AC1EF"> ES8: async / await</font> </h2><br>  JavaScript ES8   <code>async / await</code> ,     .     ,   <code>async / await</code>    ,        . <br><br>   ,    <code>async</code> .     <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/AsyncFunction">AsyncFunction</a> .      ,   ,   . <br><br>    ,    <code>Promise</code> .     ,     <code>Promise</code> ,          ,  .  ,     <code>async</code> ,  ,      . <br><br> ,     <code>async</code> ,       <code>await</code> ,        ,    .    async- , , ,       . <br><br>  Promise  JavaScript     Future  Java    C#. <br><br>  <code>async / await</code>   ,    . <br>    : <br><br><pre> <code class="hljs lua">//  -   JS- <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getNumber1</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> {   <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> Promise.resolve(<span class="hljs-string"><span class="hljs-string">'374'</span></span>); } //      ,   getNumber1 async <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getNumber2</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> {   <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-number"><span class="hljs-number">374</span></span>; }</code> </pre> <br> ,   ,  ,    : <br><br><pre> <code class="hljs javascript"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">f1</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{   <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-built_in"><span class="hljs-built_in">Promise</span></span>.reject(<span class="hljs-string"><span class="hljs-string">'Some error'</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">async</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">f2</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{   <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-string"><span class="hljs-string">'Some error'</span></span>; }</code> </pre> <br>   <code>await</code>     ,     <code>async</code> .      .       async-,        <code>then</code> : <br><br><pre> <code class="hljs coffeescript">async function loadData() {   <span class="hljs-regexp"><span class="hljs-regexp">//</span></span> `<span class="javascript"><span class="javascript">rp</span></span>`-   request-promise.   var promise1 = rp(<span class="hljs-string"><span class="hljs-string">'https://api.example.com/endpoint1'</span></span>);   var promise2 = rp(<span class="hljs-string"><span class="hljs-string">'https://api.example.com/endpoint2'</span></span>);    <span class="hljs-regexp"><span class="hljs-regexp">//</span></span>         <span class="hljs-regexp"><span class="hljs-regexp">//</span></span>      .   var response1 = <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> promise1;   var response2 = <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> promise2;   <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> response1 + <span class="hljs-string"><span class="hljs-string">' '</span></span> + response2; } <span class="hljs-regexp"><span class="hljs-regexp">//</span></span>       ,     `<span class="javascript"><span class="hljs-keyword"><span class="javascript"><span class="hljs-keyword">async</span></span></span></span>` <span class="hljs-regexp"><span class="hljs-regexp">//</span></span>    `<span class="javascript"><span class="javascript">then</span></span>`    Promise loadData().<span class="hljs-keyword"><span class="hljs-keyword">then</span></span>(<span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> =&gt;</span></span> <span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.log(<span class="hljs-string"><span class="hljs-string">'Done'</span></span>));</code> </pre> <br>       ¬´  ¬ª,          <code>function</code>      .             , ,   ,   ,      .        IIFE (Immediately Invoked Function Expression,    ),      . <br><br>  It looks like this: <br><br><pre> <code class="hljs lua">var loadData = async <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> {   // `rp`-   request-promise.   var promise1 = rp(<span class="hljs-string"><span class="hljs-string">'https://api.example.com/endpoint1'</span></span>);   var promise2 = rp(<span class="hljs-string"><span class="hljs-string">'https://api.example.com/endpoint2'</span></span>);    //         //      .   var response1 = await promise1;   var response2 = await promise2;   <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> response1 + <span class="hljs-string"><span class="hljs-string">' '</span></span> + response2; }</code> </pre> <br>  ,   <code>async / await</code>     . <br><br><img src="https://habrastorage.org/getpro/habr/post_images/bbd/58f/1ae/bbd58f1ae253243e93c4aa7c4d09fae3.png"><br><br>        ,    ,  ‚Äî <a href="https://babeljs.io/docs/plugins/transform-async-to-generator/">Babel</a>  <a href="https://www.typescriptlang.org/docs/handbook/release-notes/typescript-2-3.html">TypeScript</a> . <br><br>       <code>async / await</code>    ,    ,   . <br><br><h2> <font color="#3AC1EF">5      ,   </font> </h2><br><h3> <font color="#3AC1EF">‚ñç </font> </h3><br>   <code>async / await</code>      .  ,  <code>async / await</code> ,      .   ‚Äî   <code>.then()</code> ,      ,    -   ,   ,   . <br><br>   ,    : <br><br><pre> <code class="hljs javascript">/ <span class="hljs-string"><span class="hljs-string">`rp`</span></span>-   request-promise. rp(<span class="hljs-string"><span class="hljs-string">'https://api.example.com/endpoint1'</span></span>).then(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">data</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-comment"><span class="hljs-comment">// ‚Ä¶ });</span></span></code> </pre> <br>    ,    <code>async / await</code> : <br><br><pre> <code class="hljs perl">// <span class="hljs-string"><span class="hljs-string">`rp`</span></span>-   request-promise. var response = await rp(<span class="hljs-string"><span class="hljs-string">'https://api.example.com/endpoint1'</span></span>);</code> </pre> <br><h3> <font color="#3AC1EF">‚ñç </font> </h3><br>  <code>async / await</code>             .  ,       <code>try / catch</code> . <br><br>   ,       .  ,      <code>.catch()</code>    ,   <code>try / catch</code>    : <br><br><pre> <code class="hljs lua"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">loadData</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> {   try { //   .       getJSON().<span class="hljs-keyword"><span class="hljs-keyword">then</span></span>(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(response)</span></span></span></span> {           var parsed = JSON.parse(response);           console.<span class="hljs-built_in"><span class="hljs-built_in">log</span></span>(parsed);       }).catch(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(e)</span></span></span></span> { //              console.<span class="hljs-built_in"><span class="hljs-built_in">log</span></span>(e);       });   } catch(e) {       console.<span class="hljs-built_in"><span class="hljs-built_in">log</span></span>(e);   } }</code> </pre> <br>       <code>async / await</code> : <br><br><pre> <code class="hljs javascript"><span class="hljs-keyword"><span class="hljs-keyword">async</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">loadData</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{   <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> {       <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> data = <span class="hljs-built_in"><span class="hljs-built_in">JSON</span></span>.parse(<span class="hljs-keyword"><span class="hljs-keyword">await</span></span> getJSON());       <span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.log(data);   } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span>(e) {       <span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.log(e);   } }</code> </pre> <br><h3> <font color="#3AC1EF">‚ñç </font> </h3><br>  <code>async / await</code>   ,  .  ‚Äî ,   : <br><br><pre> <code class="hljs lua"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">loadData</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> getJSON()   .<span class="hljs-keyword"><span class="hljs-keyword">then</span></span>(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(response)</span></span></span></span> {     <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (response.needsAnotherRequest) {       <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> makeAnotherRequest(response)         .<span class="hljs-keyword"><span class="hljs-keyword">then</span></span>(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(anotherResponse)</span></span></span></span> {           console.<span class="hljs-built_in"><span class="hljs-built_in">log</span></span>(anotherResponse)           <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> anotherResponse         })     } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> {       console.<span class="hljs-built_in"><span class="hljs-built_in">log</span></span>(response)       <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> response     }   }) }</code> </pre> <br>  ‚Äî   <code>async / await</code> : <br><br><pre> <code class="hljs javascript"><span class="hljs-keyword"><span class="hljs-keyword">async</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">loadData</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> response = <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> getJSON(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (response.needsAnotherRequest) {   <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> anotherResponse = <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> makeAnotherRequest(response);   <span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.log(anotherResponse)   <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> anotherResponse } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> {   <span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.log(response);   <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> response;    } }</code> </pre> <br><h3> <font color="#3AC1EF">‚ñç </font> </h3><br>    <code>async / await</code> ,  ,    ,      ,    .       : <br><br><pre> <code class="hljs lua"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">loadData</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> callAPromise()   .<span class="hljs-keyword"><span class="hljs-keyword">then</span></span>(callback1)   .<span class="hljs-keyword"><span class="hljs-keyword">then</span></span>(callback2)   .<span class="hljs-keyword"><span class="hljs-keyword">then</span></span>(callback3)   .<span class="hljs-keyword"><span class="hljs-keyword">then</span></span>(() =&gt; {     throw new Error(<span class="hljs-string"><span class="hljs-string">"boom"</span></span>);   }) } loadData() .catch(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(e)</span></span></span></span> {   console.<span class="hljs-built_in"><span class="hljs-built_in">log</span></span>(err); // Error: boom at callAPromise.<span class="hljs-keyword"><span class="hljs-keyword">then</span></span>.<span class="hljs-keyword"><span class="hljs-keyword">then</span></span>.<span class="hljs-keyword"><span class="hljs-keyword">then</span></span>.<span class="hljs-keyword"><span class="hljs-keyword">then</span></span> (index.js:<span class="hljs-number"><span class="hljs-number">8</span></span>:<span class="hljs-number"><span class="hljs-number">13</span></span>) });</code> </pre> <br>  ‚Äî   ,    <code>async / await</code> : <br><br><pre> <code class="hljs javascript"><span class="hljs-keyword"><span class="hljs-keyword">async</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">loadData</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> callAPromise1() <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> callAPromise2() <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> callAPromise3() <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> callAPromise4() <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> callAPromise5() <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-built_in"><span class="hljs-built_in">Error</span></span>(<span class="hljs-string"><span class="hljs-string">"boom"</span></span>); } loadData() .catch(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">e</span></span></span><span class="hljs-function">) </span></span>{   <span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.log(err);   <span class="hljs-comment"><span class="hljs-comment">//    // Error: boom at loadData (index.js:7:9) });</span></span></code> </pre> <br><h3> <font color="#3AC1EF">‚ñç</font> </h3><br>    ,   ,     ‚Äî  . ,       <code>.then</code>      ¬´step-over¬ª,      <code>.then</code> ,     ¬´¬ª    .   <code>async / await</code>    ,      <code>await</code> ,   ‚Äî   . <br><br><h2>  <font color="#3AC1EF">Results</font> </h2><br>         ,    . ,  <a href="https://www.sessionstack.com/">SessionStack</a>  ,   -.  ,      DOM,    ,   JavaScript,   ,   ,      . <br><br>      -        .  ,   ,     ,    ,   .      .  ,    ,    ,     . <br><br>    ,                .         JavaScript,  ,    .        , , ,      . <br><br>  Dear readers!      JS-.  , <a href="https://habrahabr.ru/company/ruvds/blog/339414/"></a>      -        . <a href="https://habrahabr.ru/company/ruvds/blog/339770/"></a> ‚Äî     <code>async / await</code> . , ,     ,         .         ( )        a <code>sync / await</code> . </div><p>Source: <a href="https://habr.com/ru/post/340508/">https://habr.com/ru/post/340508/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../340494/index.html">5 reasons why Python is powerful enough for Google</a></li>
<li><a href="../340496/index.html">Burn-out or burnout</a></li>
<li><a href="../340500/index.html">Interview with Mikhail Trutnev (Ultimate Guitar) about business, team and strategy</a></li>
<li><a href="../340502/index.html">Creating a platformer for a virtual console TIC-80</a></li>
<li><a href="../340504/index.html">Issue price - 10 million. Softline Venture Partners accepts applications in the IT business accelerator</a></li>
<li><a href="../340510/index.html">How we created Raiffeisen Online ...</a></li>
<li><a href="../340514/index.html">Testing React-Redux Applications</a></li>
<li><a href="../340516/index.html">Search memory leaks in applications on .NET Core under Linux</a></li>
<li><a href="../340518/index.html">Search for documents in network balloons and file dumps</a></li>
<li><a href="../340520/index.html">Five planning observations</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>