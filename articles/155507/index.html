<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Demonstration of program crashes in the absence of memory barriers</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Jeff Preshing has published an excellent demonstration of how normal C ++ code returns an unpredictable result on multi-core processors with Weakly-Or...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Demonstration of program crashes in the absence of memory barriers</h1><div class="post__text post__text-html js-mediator-article"> Jeff Preshing has published an <a href="http://preshing.com/20121019/this-is-why-they-call-it-a-weakly-ordered-cpu">excellent demonstration of</a> how normal C ++ code returns an unpredictable result on multi-core processors with Weakly-Ordered CPU, that is, on ARM processors.  For example, on the iPhone or some modern Android device. <br><br>  A simple C ++ program with two threads 20.000.000 times adds one to the value protected by the mutex - and each time the output results in a different result, which is less than 20.000.000! <br><br><img src="http://habrastorage.org/storage2/91e/c47/c26/91ec47c26ca6e6b6f1f93e22d154b52d.png">
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      As they say, <a href="http://ridiculousfish.com/blog/posts/barrier.html">our enemy is the CPU</a> . <br><a name="habracut"></a><br>  In his blog, Jeff Preshing has published many articles about lock-free programming, methods of non-blocking thread synchronization.  He also talked a lot about using double-check locking and the need to set memory barriers.  Now Jeff decided that one demonstration is better than a thousand words. <br><br>  <a href="https://github.com/preshing/AcquireRelease">The code of the demo program</a> in which each of the two streams adds 10,000,000 times one to the total value of the <code>sharedValue</code> protected by the mutex. <br><br>  Here's what a homemade mutex looks like: the simplest semaphore that takes the value 1 if it is busy, or 0 if it is free. <br><br><pre> <code class="hljs objectivec"><span class="hljs-keyword"><span class="hljs-keyword">int</span></span> expected = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (flag.compare_exchange_strong(expected, <span class="hljs-number"><span class="hljs-number">1</span></span>, memory_order_acquire)) { <span class="hljs-comment"><span class="hljs-comment">// The lock succeeded }</span></span></code> </pre> <br>  The use of the <code>memory_order_acquire</code> and <code>memory_order_release</code> arguments may seem unnecessary to someone, but it is a necessary guarantee that a pair of threads change the semaphore value in a coordinated way. <br><br><pre> <code class="hljs css"><span class="hljs-selector-tag"><span class="hljs-selector-tag">flag</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.store</span></span>(0, <span class="hljs-selector-tag"><span class="hljs-selector-tag">memory_order_release</span></span>);</code> </pre> <br>  In his program, Jeff deliberately removed the <code>memory_order_acquire</code> and <code>memory_order_release</code> to demonstrate what this might lead to: <br><br><pre> <code class="hljs axapta"><span class="hljs-keyword"><span class="hljs-keyword">void</span></span> IncrementSharedValue10000000Times(RandomDelay&amp; randomDelay) { <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> <span class="hljs-keyword"><span class="hljs-keyword">count</span></span> = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">count</span></span> &lt; <span class="hljs-number"><span class="hljs-number">10000000</span></span>) { randomDelay.doBusyWork(); <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> expected = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (flag.compare_exchange_strong(expected, <span class="hljs-number"><span class="hljs-number">1</span></span>, memory_order_relaxed)) { <span class="hljs-comment"><span class="hljs-comment">// Lock was successful sharedValue++; flag.store(0, memory_order_relaxed); count++; } } }</span></span></code> </pre> <br>  This is what Xcode generates. <br><br><img src="http://habrastorage.org/storage2/63b/9c0/ce3/63b9c0ce3874519626d146ccf23e5891.png"><br><br>  The result of the launch of the program on the iPhone has already been shown. <br><br><img src="http://habrastorage.org/storage2/91e/c47/c26/91ec47c26ca6e6b6f1f93e22d154b52d.png"><br><br>  Why is this happening?  The fact is that processors with a Weakly-Ordered CPU can optimize the request queue, so your instructions will not be executed in the order in which you thought.  For example, the diagram shows how the two threads from the above example on different CPUs use a common mutex to change the value of <code>sharedValue</code> . <br><br><img src="http://habrastorage.org/storage2/09a/f4d/17f/09af4d17f649db0ca9b352a66afe7977.png"><br><br>  Successful attempts to block the mutex and change the value are shown in red, and black strokes are unsuccessful attempts to access a mutex that is blocked by another thread.  The moment when one thread only freed the mutex, and the second is ready to block it, this moment is best suited for reordering the request queue, in terms of the CPU. <br><br>  Why the CPU reorders the request queue is the topic of a separate article.  You need to deal with this by installing memory barriers that separate a pair of adjacent instructions and ensure that they do not change places.  This is what the <code>memory_order_acquire</code> and <code>memory_order_release</code> arguments are for.  We return them to the place. <br><br><pre> <code class="hljs axapta"><span class="hljs-keyword"><span class="hljs-keyword">void</span></span> IncrementSharedValue10000000Times(RandomDelay&amp; randomDelay) { <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> <span class="hljs-keyword"><span class="hljs-keyword">count</span></span> = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">count</span></span> &lt; <span class="hljs-number"><span class="hljs-number">10000000</span></span>) { randomDelay.doBusyWork(); <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> expected = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (flag.compare_exchange_strong(expected, <span class="hljs-number"><span class="hljs-number">1</span></span>, memory_order_acquire)) { <span class="hljs-comment"><span class="hljs-comment">// Lock was successful sharedValue++; flag.store(0, memory_order_release); count++; } } }</span></span></code> </pre> <br>  The compiler in this case inserts <code>dmb ish</code> instructions that act as memory barriers in ARMv7. <br><br><img src="http://habrastorage.org/storage2/4cf/ded/f2c/4cfdedf2c5fda92c1dbd9cf1ba94c9a0.png"><br><br>  And then the mutex is already beginning to perform its work normally and reliably protect the shared value of <code>sharedValue</code> . <br><br><img src="http://habrastorage.org/storage2/b8e/e2c/64c/b8ee2c64c2e13d68982203d98a01f010.png"><br><br>  We are now faced with the massive use of Weakly-Ordered processors.  Previously, they were used only in servers or in high-performance "poppies" of the past, where there were multi-core PowerPCs.  Now multi-core ARM - in every mobile phone.  So this nuance needs to be considered when developing mobile applications. <br><br>  In the ‚Äúspecially buggy‚Äù Preshing code, the probability of an error is 1 in 1000, and in a normal program it will be 1 in 1.000.000, that is, such glitches are extremely difficult to catch during testing.  The program can work perfectly 999.999 times, and the next time it starts it will crash. </div><p>Source: <a href="https://habr.com/ru/post/155507/">https://habr.com/ru/post/155507/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../155495/index.html">By 2015, at least 800 professional standards will be developed in Russia</a></li>
<li><a href="../155497/index.html">Virus Formula or fortune?</a></li>
<li><a href="../155501/index.html">FBI staff passwords are freely available Hackers Army</a></li>
<li><a href="../155503/index.html">Failures of a three-year crowdsourcing project or why I almost stopped believing in myself and people</a></li>
<li><a href="../155505/index.html">Java application debugging with JDI</a></li>
<li><a href="../155509/index.html">Timer Architecture in node.js</a></li>
<li><a href="../155511/index.html">My bike for snippets</a></li>
<li><a href="../155515/index.html">Multimethods in C ++. Library implementation. Introduction to MML</a></li>
<li><a href="../155517/index.html">Linux memory access barriers</a></li>
<li><a href="../155519/index.html">The next era of NASA's Remote Space Network (DSN) lies in the field of X-rays and lasers.</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>