<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>A simple x86 assembly program: Sieve of Eratosthenes</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="opening speech 
 In my profession, I do not encounter low-level programming: I do programming in scripting languages. But since the soul requires dive...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>A simple x86 assembly program: Sieve of Eratosthenes</h1><div class="post__text post__text-html js-mediator-article"><h4>  opening speech </h4><br>  In my profession, I do not encounter low-level programming: I do programming in scripting languages.  But since the soul requires diversity, expanding the horizons of knowledge or simply understanding how the machine works at a low level, I do programming in languages ‚Äã‚Äãother than those with which I make money - this is my hobby. <br><br>  And so, I would like to share the experience of creating a simple program in assembly language for processors of the x86 family, with the analysis of which you can begin your journey into conquering lowlands of abstraction levels. <br><br>  Before writing it, I formulated the following requirements for the future program: <br><ul><li>  My program should not be a program under DOS.  Too many examples focused on it in connection with a simple API.  My program had to <b>run on modern operating systems.</b> </li><li>  The program must <b>use a bunch</b> - get at its disposal a dynamically allocated memory. </li><li>  In order not to be too complicated, the program must <b>work with unsigned integers</b> without the use of hyphens. </li></ul><br>  The task for my program, I chose to search for primes using the <a href="http://ru.wikipedia.org/wiki/%25D0%25A0%25D0%25B5%25D1%2588%25D0%25B5%25D1%2582%25D0%25BE_%25D0%25AD%25D1%2580%25D0%25B0%25D1%2582%25D0%25BE%25D1%2581%25D1%2584%25D0%25B5%25D0%25BD%25D0%25B0">Sieve of Eratosthenes</a> .  As an assembler, I chose <a href="http://www.nasm.us/">nasm</a> . 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      I wrote the code with more emphasis on style and clarity than on its speed.  For example, I did not reset the register using <code>xor eax, eax</code> , but using <code>mov eax, 0</code> due to more appropriate instruction semantics.  I decided that since the program is purely for educational purposes, it is possible to unleash and pursue the style of the code in assembler. <br><br>  So, let's see what happened. <a name="habracut"></a><br><br><h4>  Where to begin? </h4><br>  Perhaps the most difficult thing that you encounter when moving from high-level languages ‚Äã‚Äãto assembler is the organization of memory.  Fortunately, on this topic on Habr√© was already a <a href="http://habrahabr.ru/post/128991/">good article</a> . <br><br>  It also raises the question of how data is exchanged between the internal world of the program and the external environment at such a low level.  Here comes the operating system API.  In DOS, as already mentioned, the interface was fairly simple.  For example, the ‚ÄúHello, world‚Äù program looked like this: <br><br><pre> <code class="hljs pgsql">SECTION .text org <span class="hljs-number"><span class="hljs-number">0x100</span></span> mov ah, <span class="hljs-number"><span class="hljs-number">0x9</span></span> mov dx, hello <span class="hljs-type"><span class="hljs-type">int</span></span> <span class="hljs-number"><span class="hljs-number">0x21</span></span> mov ax, <span class="hljs-number"><span class="hljs-number">0x4c00</span></span> <span class="hljs-type"><span class="hljs-type">int</span></span> <span class="hljs-number"><span class="hljs-number">0x21</span></span> SECTION .data hello: db "Hello, world!", <span class="hljs-number"><span class="hljs-number">0xD</span></span>, <span class="hljs-number"><span class="hljs-number">0xA</span></span>, <span class="hljs-string"><span class="hljs-string">'$'</span></span></code> </pre><br><br>  In Windows, the Win32 API is used for these purposes, respectively, the program should use the methods of the corresponding libraries: <br><br><pre> <code class="hljs pgsql">%<span class="hljs-keyword"><span class="hljs-keyword">include</span></span> "win32n.inc" extern MessageBoxA <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> MessageBoxA user32.dll extern ExitProcess <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> ExitProcess kernel32.dll SECTION code use32 <span class="hljs-keyword"><span class="hljs-keyword">class</span></span>=code ..<span class="hljs-keyword"><span class="hljs-keyword">start</span></span>: push UINT MB_OK push LPCTSTR window_title push LPCTSTR banner push HWND <span class="hljs-keyword"><span class="hljs-keyword">NULL</span></span> <span class="hljs-keyword"><span class="hljs-keyword">call</span></span> [MessageBoxA] push UINT <span class="hljs-keyword"><span class="hljs-keyword">NULL</span></span> <span class="hljs-keyword"><span class="hljs-keyword">call</span></span> [ExitProcess] SECTION data use32 <span class="hljs-keyword"><span class="hljs-keyword">class</span></span>=data banner: db "Hello, world!", <span class="hljs-number"><span class="hljs-number">0xD</span></span>, <span class="hljs-number"><span class="hljs-number">0xA</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span> window_title: db "Hello", <span class="hljs-number"><span class="hljs-number">0</span></span></code> </pre><br><br>  Here, the <a href="http://rs1.szif.hu/~tomcat/win32/">win32n.inc</a> file is <a href="http://rs1.szif.hu/~tomcat/win32/">used</a> , where macros are defined that reduce the code for working with the Win32 API. <br><br>  I decided not to use the OS API directly and chose the way to use functions from the C library.  It also opened up the possibility of compiling a program in Linux (and, most likely, in other operating systems) - not a great achievement, but necessary for this program, but a pleasant achievement. <br><br><h4>  Subroutine call </h4><br>  The need to call subroutines entails several topics for study: organization of subroutines, passing arguments, creating a stack frame, working with local variables. <br><br>  <i>Subroutines</i> are the label on which the code is located.  The routine ends with the <code>ret</code> instruction.  For example, this subroutine in DOS displays the string ‚ÄúHello, world‚Äù to the console: <br><br><pre> <code class="hljs objectivec">print_hello: mov ah, <span class="hljs-number"><span class="hljs-number">0x9</span></span> mov dx, hello <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> <span class="hljs-number"><span class="hljs-number">0x21</span></span> ret</code> </pre><br><br>  To call her, you would use the <code>call</code> instruction: <br><br><pre> <code class="hljs pgsql"><span class="hljs-keyword"><span class="hljs-keyword">call</span></span> print_hello</code> </pre><br><br>  For myself, I decided to <i>pass arguments to</i> subroutines through registers and specify in the comments which registers should have any arguments, but in high-level languages, arguments are passed through the stack.  For example, the <code>printf</code> function from the C library is called like this: <br><br><pre> <code class="hljs pgsql">push hello <span class="hljs-keyword"><span class="hljs-keyword">call</span></span> _printf <span class="hljs-keyword"><span class="hljs-keyword">add</span></span> esp, <span class="hljs-number"><span class="hljs-number">4</span></span></code> </pre><br><br>  Arguments are passed from right to left; the responsibility for clearing the stack lies with the caller. <br><br>  When entering the subroutine, you need to create a <i>new stack frame.</i>  This is done as follows: <br><br><pre> <code class="hljs perl">print_hello: <span class="hljs-keyword"><span class="hljs-keyword">push</span></span> ebp ;       mov ebp, esp ;     </code> </pre><br><br>  Accordingly, before exiting, you need to restore the previous state of the stack: <br><br><pre> <code class="hljs perl"> mov esp, ebp <span class="hljs-keyword"><span class="hljs-keyword">pop</span></span> ebp ret</code> </pre><br><br>  For <i>local variables</i> , the stack is also used, on which, after creating a new frame, the required number of bytes is allocated: <br><br><pre> <code class="hljs perl">print_hello: <span class="hljs-keyword"><span class="hljs-keyword">push</span></span> ebp mov ebp, esp <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">sub</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">esp</span></span></span><span class="hljs-function">, 8 </span></span>;     <span class="hljs-number"><span class="hljs-number">8</span></span> ,   </code> </pre><br><br>  The x86 architecture also provides special instructions with which you can more concisely implement these actions: <br><br><pre> <code class="hljs 1c">print_hello: enter <span class="hljs-number"><span class="hljs-number">8</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span> ; <span class="hljs-keyword"><span class="hljs-keyword"></span></span> ,  <span class="hljs-number"><span class="hljs-number">8</span></span>  <span class="hljs-keyword"><span class="hljs-keyword"></span></span>   leave ;  ret</code> </pre><br><br>  The second parameter of the <code>enter</code> instruction is the nesting level of the subroutine.  It is needed for linking with high-level languages ‚Äã‚Äãthat support this method of organizing subroutines.  In our case, this value can be left zero. <br><br><h4>  Directly the program </h4><br>  The project contains the following files: <br><ul><li>  <code>main.asm</code> - the main file </li><li>  <code>functions.asm</code> - routines, </li><li>  <code>string_constants.asm</code> - definitions of string constants, </li><li>  <code>Makefile</code> - build script </li></ul><br>  Consider the code of the main file: <br><br><div class="spoiler">  <b class="spoiler_title">main.asm</b> <div class="spoiler_text"><pre> <code class="hljs sql">%define SUCCESS 0 %define MIN_MAX_NUMBER 3 %define MAX_MAX_NUMBER 4294967294 global _main extern _printf extern _scanf extern _malloc extern _free SECTION .text _main: enter 0, 0 ;   <span class="hljs-keyword"><span class="hljs-keyword">call</span></span> input_max_number cmp edx, <span class="hljs-keyword"><span class="hljs-keyword">SUCCESS</span></span> jne .custom_exit mov [max_number], eax ;     mov eax, [max_number] <span class="hljs-keyword"><span class="hljs-keyword">call</span></span> allocate_flags_memory cmp edx, <span class="hljs-keyword"><span class="hljs-keyword">SUCCESS</span></span> jne .custom_exit mov [primes_pointer], eax ;   mov eax, [primes_pointer] mov ebx, [max_number] <span class="hljs-keyword"><span class="hljs-keyword">call</span></span> find_primes_with_eratosthenes_sieve ;  mov eax, [primes_pointer] mov ebx, [max_number] <span class="hljs-keyword"><span class="hljs-keyword">call</span></span> print_primes ;     mov eax, [primes_pointer] <span class="hljs-keyword"><span class="hljs-keyword">call</span></span> free_flags_memory ; .success: push str_exit_success <span class="hljs-keyword"><span class="hljs-keyword">call</span></span> _printf jmp .return .custom_exit: push edx <span class="hljs-keyword"><span class="hljs-keyword">call</span></span> _printf .return: mov eax, <span class="hljs-keyword"><span class="hljs-keyword">SUCCESS</span></span> leave ret %<span class="hljs-keyword"><span class="hljs-keyword">include</span></span> <span class="hljs-string"><span class="hljs-string">"functions.asm"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">SECTION</span></span> .data max_number: dd <span class="hljs-number"><span class="hljs-number">0</span></span> primes_pointer: dd <span class="hljs-number"><span class="hljs-number">0</span></span> %<span class="hljs-keyword"><span class="hljs-keyword">include</span></span> <span class="hljs-string"><span class="hljs-string">"string_constants.asm"</span></span></code> </pre><br></div></div><br>  It can be seen that the program is divided into 5 blocks, designed in the form of subroutines: <br><ol><li>  <code>input_max_number</code> - using the console prompts the user for the maximum number to which the search for primes is performed;  to avoid errors, the value is limited by the constants <code>MIN_MAX_NUMBER</code> and <code>MAX_MAX_NUMBER</code> </li><li>  <code>allocate_flags_memory</code> ‚Äî request the OS to allocate memory for an array of number marks (simple / compound) on the heap;  if successful, returns a pointer to the allocated memory through the <code>eax</code> register </li><li>  <code>find_primes_with_eratosthenes_sieve</code> - filter out composite numbers using the classic sieve of Eratosthenes; </li><li>  <code>print_primes</code> - output a list of prime numbers to the console; </li><li>  <code>free_flags_memory</code> - free memory allocated for flags </li></ol><br>  For functions, the following rule was agreed: the value is returned via the <code>eax</code> register, the <code>edx</code> contains the status.  If successful, it contains the value of <code>SUCCESS</code> , that is, <code>0</code> , in case of failure, the address of the string with an error message that will be displayed to the user. <br><br>  The <code>string_constants.asm</code> file contains the definition of string variables whose values, as the file name suggests, are not supposed to be changed.  Only for the sake of these variables an exception was made to the rule ‚Äúnot to use global variables‚Äù.  I never found a more convenient way to deliver string constants to I / O functions - I even thought of writing to the stack just before the function calls, but I decided that this idea was much worse than the idea with global variables. <br><br><div class="spoiler">  <b class="spoiler_title">string_constants.asm</b> <div class="spoiler_text"><pre> <code class="hljs perl">; -,  str_max_number_label: db <span class="hljs-string"><span class="hljs-string">"Max number (&gt;=3): "</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span> str_max_number_input_format: db <span class="hljs-string"><span class="hljs-string">"%u"</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span> str_max_number_output_format: db <span class="hljs-string"><span class="hljs-string">"Using max number %u"</span></span>, <span class="hljs-number"><span class="hljs-number">0xD</span></span>, <span class="hljs-number"><span class="hljs-number">0xA</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span> str_print_primes_label: db <span class="hljs-string"><span class="hljs-string">"Primes:"</span></span>, <span class="hljs-number"><span class="hljs-number">0xD</span></span>, <span class="hljs-number"><span class="hljs-number">0xA</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span> str_prime: db <span class="hljs-string"><span class="hljs-string">"%u"</span></span>, <span class="hljs-number"><span class="hljs-number">0x9</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span> str_cr_lf: db <span class="hljs-number"><span class="hljs-number">0xD</span></span>, <span class="hljs-number"><span class="hljs-number">0xA</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span> ;  str_exit_success: db <span class="hljs-string"><span class="hljs-string">"Success!"</span></span>, <span class="hljs-number"><span class="hljs-number">0xD</span></span>, <span class="hljs-number"><span class="hljs-number">0xA</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span> str_error_max_num_too_little: db <span class="hljs-string"><span class="hljs-string">"Max number is too little!"</span></span>, <span class="hljs-number"><span class="hljs-number">0xD</span></span>, <span class="hljs-number"><span class="hljs-number">0xA</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span> str_error_max_num_too_big: db <span class="hljs-string"><span class="hljs-string">"Max number is too big!"</span></span>, <span class="hljs-number"><span class="hljs-number">0xD</span></span>, <span class="hljs-number"><span class="hljs-number">0xA</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span> str_error_malloc_failed: db <span class="hljs-string"><span class="hljs-string">"Can't allocate memory!"</span></span>, <span class="hljs-number"><span class="hljs-number">0xD</span></span>, <span class="hljs-number"><span class="hljs-number">0xA</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span></code> </pre><br></div></div><br>  The following script is used for the build: <br><br><div class="spoiler">  <b class="spoiler_title">Makefile</b> <div class="spoiler_text"><pre> <code class="bash hljs">ifdef SystemRoot format = win32 rm = del ext = .exe <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> format = elf rm = rm -f ext = endif all: primes.o gcc primes.o -o primes$(ext) $(rm) primes.o primes.o: nasm -f $(format) main.asm -o primes.o</code> </pre><br></div></div><br><br><h4>  Subprograms (functions) </h4><br><h5>  input_max_number </h5><br><div class="spoiler">  <b class="spoiler_title">Subroutine code</b> <div class="spoiler_text"><pre> <code class="hljs css">;    ; : <span class="hljs-selector-tag"><span class="hljs-selector-tag">EAX</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">-</span></span>   <span class="hljs-selector-tag"><span class="hljs-selector-tag">input_max_number</span></span>: ; <span class="hljs-selector-tag"><span class="hljs-selector-tag">-</span></span>, ;4     <span class="hljs-selector-tag"><span class="hljs-selector-tag">enter</span></span> 4, 1 ;  <span class="hljs-selector-tag"><span class="hljs-selector-tag">push</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">str_max_number_label</span></span> ;. <span class="hljs-selector-tag"><span class="hljs-selector-tag">string_constants</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.asm</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">call</span></span> _<span class="hljs-selector-tag"><span class="hljs-selector-tag">printf</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">add</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">esp</span></span>, 4 ; <span class="hljs-selector-tag"><span class="hljs-selector-tag">scanf</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">mov</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">eax</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">ebp</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">sub</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">eax</span></span>, 4 <span class="hljs-selector-tag"><span class="hljs-selector-tag">push</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">eax</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">push</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">str_max_number_input_format</span></span> ;. <span class="hljs-selector-tag"><span class="hljs-selector-tag">string_constants</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.asm</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">call</span></span> _<span class="hljs-selector-tag"><span class="hljs-selector-tag">scanf</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">add</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">esp</span></span>, 8 <span class="hljs-selector-tag"><span class="hljs-selector-tag">mov</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">eax</span></span>, <span class="hljs-selector-attr"><span class="hljs-selector-attr">[ebp-4]</span></span> ; <span class="hljs-selector-tag"><span class="hljs-selector-tag">cmp</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">eax</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">MIN_MAX_NUMBER</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">jb</span></span> <span class="hljs-selector-class"><span class="hljs-selector-class">.number_too_little</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">cmp</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">eax</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">MAX_MAX_NUMBER</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">ja</span></span> <span class="hljs-selector-class"><span class="hljs-selector-class">.number_too_big</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">jmp</span></span> <span class="hljs-selector-class"><span class="hljs-selector-class">.success</span></span> ; <span class="hljs-selector-class"><span class="hljs-selector-class">.number_too_little</span></span>: <span class="hljs-selector-tag"><span class="hljs-selector-tag">mov</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">edx</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">str_error_max_num_too_little</span></span> ;. <span class="hljs-selector-tag"><span class="hljs-selector-tag">string_constants</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.asm</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">jmp</span></span> <span class="hljs-selector-class"><span class="hljs-selector-class">.return</span></span> <span class="hljs-selector-class"><span class="hljs-selector-class">.number_too_big</span></span>: <span class="hljs-selector-tag"><span class="hljs-selector-tag">mov</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">edx</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">str_error_max_num_too_big</span></span> ;. <span class="hljs-selector-tag"><span class="hljs-selector-tag">string_constants</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.asm</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">jmp</span></span> <span class="hljs-selector-class"><span class="hljs-selector-class">.return</span></span> <span class="hljs-selector-class"><span class="hljs-selector-class">.success</span></span>: <span class="hljs-selector-tag"><span class="hljs-selector-tag">push</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">eax</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">push</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">str_max_number_output_format</span></span> ;. <span class="hljs-selector-tag"><span class="hljs-selector-tag">string_constants</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.asm</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">call</span></span> _<span class="hljs-selector-tag"><span class="hljs-selector-tag">printf</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">add</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">esp</span></span>, 4 <span class="hljs-selector-tag"><span class="hljs-selector-tag">pop</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">eax</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">mov</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">edx</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">SUCCESS</span></span> <span class="hljs-selector-class"><span class="hljs-selector-class">.return</span></span>: <span class="hljs-selector-tag"><span class="hljs-selector-tag">leave</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">ret</span></span></code> </pre><br></div></div><br>  The subroutine is designed to enter into the program the maximum number, which will be searched for simple ones.  The key points here are calling the <code>scanf</code> function from the C library: <br><br><pre> <code class="hljs perl"> mov eax, ebp <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">sub</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">eax</span></span></span><span class="hljs-function">, 4 </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">push</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">eax</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">push</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">str_max_number_input_format</span></span></span><span class="hljs-function"> </span></span>;. string_constants.asm call _scanf add esp, <span class="hljs-number"><span class="hljs-number">8</span></span> mov eax, [ebp-<span class="hljs-number"><span class="hljs-number">4</span></span>]</code> </pre><br>  Thus, first, <code>eax</code> records the memory address 4 bytes below the stack base pointer.  This is the memory allocated for the local needs of the subroutine.  A pointer to this memory is passed to the <code>scanf</code> function as a target for writing data entered from the keyboard. <br><br>  After calling the function, the entered value is moved to the <code>eax</code> memory. <br><br><h5>  allocate_flags_memory and free_flags_memory </h5><br><div class="spoiler">  <b class="spoiler_title">Subroutine code</b> <div class="spoiler_text"><pre> <code class="hljs css">;      ; : <span class="hljs-selector-tag"><span class="hljs-selector-tag">EAX</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">-</span></span>   ; : <span class="hljs-selector-tag"><span class="hljs-selector-tag">EAX</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">-</span></span>    <span class="hljs-selector-tag"><span class="hljs-selector-tag">allocate_flags_memory</span></span>: <span class="hljs-selector-tag"><span class="hljs-selector-tag">enter</span></span> 8, 1 ; <span class="hljs-selector-tag"><span class="hljs-selector-tag">EAX</span></span>+1  <span class="hljs-selector-tag"><span class="hljs-selector-tag">inc</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">eax</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">mov</span></span> <span class="hljs-selector-attr"><span class="hljs-selector-attr">[ebp-4]</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">eax</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">push</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">eax</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">call</span></span> _<span class="hljs-selector-tag"><span class="hljs-selector-tag">malloc</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">add</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">esp</span></span>, 4 ; <span class="hljs-selector-tag"><span class="hljs-selector-tag">cmp</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">eax</span></span>, 0 <span class="hljs-selector-tag"><span class="hljs-selector-tag">je</span></span> <span class="hljs-selector-class"><span class="hljs-selector-class">.fail</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">mov</span></span> <span class="hljs-selector-attr"><span class="hljs-selector-attr">[ebp-8]</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">eax</span></span> ; <span class="hljs-selector-tag"><span class="hljs-selector-tag">mov</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">byte</span></span> <span class="hljs-selector-attr"><span class="hljs-selector-attr">[eax]</span></span>, 0 <span class="hljs-selector-tag"><span class="hljs-selector-tag">cld</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">mov</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">edi</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">eax</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">inc</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">edi</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">mov</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">edx</span></span>, <span class="hljs-selector-attr"><span class="hljs-selector-attr">[ebp-4]</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">add</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">edx</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">eax</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">mov</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">al</span></span>, 1 <span class="hljs-selector-class"><span class="hljs-selector-class">.write_true</span></span>: <span class="hljs-selector-tag"><span class="hljs-selector-tag">stosb</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">cmp</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">edi</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">edx</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">jb</span></span> <span class="hljs-selector-class"><span class="hljs-selector-class">.write_true</span></span> ; <span class="hljs-selector-tag"><span class="hljs-selector-tag">mov</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">eax</span></span>, <span class="hljs-selector-attr"><span class="hljs-selector-attr">[ebp-8]</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">jmp</span></span> <span class="hljs-selector-class"><span class="hljs-selector-class">.success</span></span> <span class="hljs-selector-class"><span class="hljs-selector-class">.fail</span></span>: <span class="hljs-selector-tag"><span class="hljs-selector-tag">mov</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">edx</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">str_error_malloc_failed</span></span> ;. <span class="hljs-selector-tag"><span class="hljs-selector-tag">string_constants</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.asm</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">jmp</span></span> <span class="hljs-selector-class"><span class="hljs-selector-class">.return</span></span> <span class="hljs-selector-class"><span class="hljs-selector-class">.success</span></span>: <span class="hljs-selector-tag"><span class="hljs-selector-tag">mov</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">edx</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">SUCCESS</span></span> <span class="hljs-selector-class"><span class="hljs-selector-class">.return</span></span>: <span class="hljs-selector-tag"><span class="hljs-selector-tag">leave</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">ret</span></span> ;      ; : <span class="hljs-selector-tag"><span class="hljs-selector-tag">EAX</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">-</span></span>    <span class="hljs-selector-tag"><span class="hljs-selector-tag">free_flags_memory</span></span>: <span class="hljs-selector-tag"><span class="hljs-selector-tag">enter</span></span> 0, 1 <span class="hljs-selector-tag"><span class="hljs-selector-tag">push</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">eax</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">call</span></span> _<span class="hljs-selector-tag"><span class="hljs-selector-tag">free</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">add</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">esp</span></span>, 4 <span class="hljs-selector-tag"><span class="hljs-selector-tag">leave</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">ret</span></span></code> </pre><br></div></div><br>  The key points of these routines are calls to the <code>malloc</code> and <code>free</code> functions from the C library. <br><br>  In case of success, <code>malloc</code> returns the address of the allocated memory through the <code>eax</code> register, in case of failure, this register contains <code>0</code> .  This is the bottleneck of the program for the maximum number.  32 bits is quite enough to search for primes up to 4,294,967,295, but it will not be possible to allocate so much memory at once. <br><br><h5>  find_primes_with_eratosthenes_sieve </h5><br><div class="spoiler">  <b class="spoiler_title">Subroutine code</b> <div class="spoiler_text"><pre> <code class="hljs pgsql">;       ;: EAX -    , EBX -   find_primes_with_eratosthenes_sieve: enter <span class="hljs-number"><span class="hljs-number">8</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span> mov [ebp<span class="hljs-number"><span class="hljs-number">-4</span></span>], eax <span class="hljs-keyword"><span class="hljs-keyword">add</span></span> eax, ebx inc eax mov [ebp<span class="hljs-number"><span class="hljs-number">-8</span></span>], eax ;   cld mov edx, <span class="hljs-number"><span class="hljs-number">2</span></span> ;p = <span class="hljs-number"><span class="hljs-number">2</span></span> mov ecx, <span class="hljs-number"><span class="hljs-number">2</span></span> ;  = <span class="hljs-number"><span class="hljs-number">2</span></span> .strike_out_cycle: ;x = c*p mov eax, edx push edx mul ecx pop edx cmp eax, ebx jbe .strike_out_number jmp .increase_p .strike_out_number: mov edi, [ebp<span class="hljs-number"><span class="hljs-number">-4</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">add</span></span> edi, eax mov byte [edi], <span class="hljs-number"><span class="hljs-number">0</span></span> inc ecx ;c = c + <span class="hljs-number"><span class="hljs-number">1</span></span> jmp .strike_out_cycle .increase_p: mov esi, [ebp<span class="hljs-number"><span class="hljs-number">-4</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">add</span></span> esi, edx inc esi mov ecx, edx inc ecx .check_current_number: mov eax, ecx mul eax cmp eax, ebx ja .<span class="hljs-keyword"><span class="hljs-keyword">return</span></span> lodsb inc ecx cmp al, <span class="hljs-number"><span class="hljs-number">0</span></span> jne .new_p_found jmp .check_current_number .new_p_found: mov edx, ecx <span class="hljs-type"><span class="hljs-type">dec</span></span> edx mov ecx, <span class="hljs-number"><span class="hljs-number">2</span></span> jmp .strike_out_cycle .<span class="hljs-keyword"><span class="hljs-keyword">return</span></span>: leave ret</code> </pre><br></div></div><br><br>  The subroutine implements the classical algorithm for crossing out compound numbers, the sieve of Eratosthenes, in assembler language x86.  Pleasant because it does not use calls to external functions and does not require error handling :) <br><br><h5>  print_primes </h5><br><div class="spoiler">  <b class="spoiler_title">Subroutine code</b> <div class="spoiler_text"><pre> <code class="hljs css">;    ; : <span class="hljs-selector-tag"><span class="hljs-selector-tag">EAX</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">-</span></span>    , <span class="hljs-selector-tag"><span class="hljs-selector-tag">EBX</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">-</span></span>   <span class="hljs-selector-tag"><span class="hljs-selector-tag">print_primes</span></span>: <span class="hljs-selector-tag"><span class="hljs-selector-tag">enter</span></span> 12, 1 <span class="hljs-selector-tag"><span class="hljs-selector-tag">mov</span></span> <span class="hljs-selector-attr"><span class="hljs-selector-attr">[ebp-4]</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">eax</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">mov</span></span> <span class="hljs-selector-attr"><span class="hljs-selector-attr">[ebp-8]</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">ebx</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">push</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">str_print_primes_label</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">call</span></span> _<span class="hljs-selector-tag"><span class="hljs-selector-tag">printf</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">add</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">esp</span></span>, 4 <span class="hljs-selector-tag"><span class="hljs-selector-tag">cld</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">mov</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">esi</span></span>, <span class="hljs-selector-attr"><span class="hljs-selector-attr">[ebp-4]</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">mov</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">edx</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">esi</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">add</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">edx</span></span>, <span class="hljs-selector-attr"><span class="hljs-selector-attr">[ebp-8]</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">inc</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">edx</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">mov</span></span> <span class="hljs-selector-attr"><span class="hljs-selector-attr">[ebp-12]</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">edx</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">mov</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">ecx</span></span>, 0 <span class="hljs-selector-class"><span class="hljs-selector-class">.print_cycle</span></span>: <span class="hljs-selector-tag"><span class="hljs-selector-tag">lodsb</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">cmp</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">al</span></span>, 0 <span class="hljs-selector-tag"><span class="hljs-selector-tag">jne</span></span> <span class="hljs-selector-class"><span class="hljs-selector-class">.print</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">jmp</span></span> <span class="hljs-selector-class"><span class="hljs-selector-class">.check_finish</span></span> <span class="hljs-selector-class"><span class="hljs-selector-class">.print</span></span>: <span class="hljs-selector-tag"><span class="hljs-selector-tag">push</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">esi</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">push</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">ecx</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">push</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">str_prime</span></span> ;. <span class="hljs-selector-tag"><span class="hljs-selector-tag">string_constants</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.asm</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">call</span></span> _<span class="hljs-selector-tag"><span class="hljs-selector-tag">printf</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">add</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">esp</span></span>, 4 <span class="hljs-selector-tag"><span class="hljs-selector-tag">pop</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">ecx</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">pop</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">esi</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">mov</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">edx</span></span>, <span class="hljs-selector-attr"><span class="hljs-selector-attr">[ebp-12]</span></span> <span class="hljs-selector-class"><span class="hljs-selector-class">.check_finish</span></span>: <span class="hljs-selector-tag"><span class="hljs-selector-tag">inc</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">ecx</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">cmp</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">esi</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">edx</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">jb</span></span> <span class="hljs-selector-class"><span class="hljs-selector-class">.print_cycle</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">push</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">str_cr_lf</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">call</span></span> _<span class="hljs-selector-tag"><span class="hljs-selector-tag">printf</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">add</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">esp</span></span>, 4 <span class="hljs-selector-tag"><span class="hljs-selector-tag">leave</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">ret</span></span></code> </pre><br></div></div><br>  The subroutine outputs prime numbers to the console.  The key point here is to call the <code>printf</code> function from the C library. <br><br><h4>  Conclusion </h4><br>  Well, the program meets all the stated requirements and seems to be easy to understand.  I would like to hope that someone will help her to understand programming at a low level and he will receive from him the same pleasure that I received. <br><br>  Also cite the full <a href="http://narod.ru/disk/65350046001.d8821d8334495907e3f0b3185b4e00dd/primes.zip.html">source code of the program</a> . <br><br>  I can also bring an interesting fact.  Since we were taught from childhood that assembly language programs run faster, I decided to compare the speed of this program with the speed of the C ++ program I wrote once and which looked for simple numbers using <a href="http://ru.wikipedia.org/wiki/%25D0%25A0%25D0%25B5%25D1%2588%25D0%25B5%25D1%2582%25D0%25BE_%25D0%2590%25D1%2582%25D0%25BA%25D0%25B8%25D0%25BD%25D0%25B0">Reshet Atkin</a> .  A C ++ program compiled in Visual Studio with <code>/O2</code> performed a search up to the number 2 <sup>30 in</sup> about 25 seconds on my machine.  The assembler program showed 15 seconds with the Sieve of Eratosthenes. <br><br>  This, of course, is more like a bike than a scientific fact, since there was no serious testing, there was no clarification of the reasons, but it would seem to me like an interesting fact to complete the article. <br><br><h4>  useful links </h4><br><ol><li>  <a href="http://habrahabr.ru/post/131971/">List of resources for learning assembler</a> </li><li>  <a href="http://habrahabr.ru/post/128991/">Memory organization</a> </li><li>  <a href="http://ru.wikipedia.org/wiki/%25D0%25A0%25D0%25B5%25D1%2588%25D0%25B5%25D1%2582%25D0%25BE_%25D0%25AD%25D1%2580%25D0%25B0%25D1%2582%25D0%25BE%25D1%2581%25D1%2584%25D0%25B5%25D0%25BD%25D0%25B0">Sieve of Eratosthenes</a> </li><li>  <a href="http://ru.wikipedia.org/wiki/%25D0%25A0%25D0%25B5%25D1%2588%25D0%25B5%25D1%2582%25D0%25BE_%25D0%2590%25D1%2582%25D0%25BA%25D0%25B8%25D0%25BD%25D0%25B0">Sieve Atkina</a> </li><li>  <a href="http://ru.wikipedia.org/wiki/%25D0%25A1%25D1%2582%25D0%25B5%25D0%25BA">Stack</a> </li><li>  <a href="http://ru.wikipedia.org/wiki/%25D0%25A1%25D1%2582%25D0%25B5%25D0%25BA%25D0%25BE%25D0%25B2%25D1%258B%25D0%25B9_%25D0%25BA%25D0%25B0%25D0%25B4%25D1%2580">Stack frame</a> </li></ol></div><p>Source: <a href="https://habr.com/ru/post/165397/">https://habr.com/ru/post/165397/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../165381/index.html">Jiayu G3 - Chinese Phone with European Quality</a></li>
<li><a href="../165383/index.html">Google opened registration for the second year of advanced search.</a></li>
<li><a href="../165385/index.html">Linux :: two, three, five ... mouse pointers</a></li>
<li><a href="../165389/index.html">What do the CIOs of 2013 expect?</a></li>
<li><a href="../165395/index.html">NeoAxis 3D Game Engine updated to version 1.3</a></li>
<li><a href="../165399/index.html">Influence of glial cells on synaptic communication: rather yes, or rather no?</a></li>
<li><a href="../165401/index.html">We control the laptop fan through DSDT in Linux and not only</a></li>
<li><a href="../165403/index.html">15,000 FPS. Hardcore tricks part 2 - well, a non-standard window</a></li>
<li><a href="../165405/index.html">Explore Mars with NASA</a></li>
<li><a href="../165417/index.html">How to take aura pictures with a webcam</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>