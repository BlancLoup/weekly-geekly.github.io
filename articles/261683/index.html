<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Dino - a new state-sponsored spyware with French roots</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="In this post, we will look at new malware that its creators have named Dino. Dino is a sophisticated backdoor that was developed by Animal Fram, the c...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Dino - a new state-sponsored spyware with French roots</h1><div class="post__text post__text-html js-mediator-article">  In this post, we will look at new malware that its creators have named Dino.  Dino is a sophisticated backdoor that was developed by Animal Fram, the cybergroup behind the creation and distribution of such state-sponsored malware as <a href="http://habrahabr.ru/company/eset/blog/252577/">Casper</a> , <a href="http://www.cyphort.com/evilbunny-malware-instrumented-lua/">Bunny</a> and <a href="http://www.cyphort.com/babar-suspected-nation-state-spyware-spotlight/">Babar</a> .  It contains many interesting features, including those that suggest its development by people who speak French. <br><br><img src="https://habrastorage.org/files/642/2fa/c84/6422fac846ee499c8955433ecff5e48f.jpeg"><br><br>  The name Animal Farm was given to a cyber group that was mentioned by the Canadian Communications Security Establishment (CSE) in a series of slides in a <a href="http://www.spiegel.de/media/media-35683.pdf">presentation</a> on the runaway NSA employee Edward Snowden in March 2014. These slides indicate that French intelligence agencies are involved in this group. ).  After that, anti-virus companies detected several malicious programs that were created by this cyber group. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <a name="habracut"></a>  These malicious programs include: <br><br><ul><li>  Casper, T.N.  implant of the first level, which was documented by <a href="http://habrahabr.ru/company/eset/blog/252577/">ESET</a> . </li><li>  Bunny, is a backdoor written in Lua, it was <a href="http://www.cyphort.com/evilbunny-malware-instrumented-lua/">documented by the</a> researcher Marion Marschalek (Cyphort). </li><li>  Babar, is a malware for cyber espionage, also <a href="http://www.cyphort.com/babar-suspected-nation-state-spyware-spotlight/">documented by</a> Marion Marschalek. </li></ul><br>  The link between these malwares and the involvement of the Animal Farm group has been convincingly <a href="https://blog.gdatasoftware.com/blog/article/babar-espionage-software-finally-found-and-put-under-the-microscope.html">proven</a> by G DATA researcher Paul Rascagn√®res.  Our study focuses on another malicious program behind which this cyber group stands.  She is called Dino. <br><br>  <b>General information</b> <br><br>  The malware file we analyzed was used in 2013 in targeted cyber attacks against Iran.  The original infection vector remained unknown, however, we believe that Dino was installed by another malicious program, since it contains procedures for removing itself from the system and does not contain a similar installation procedure.  Given the set of commands that Dino can receive, we believe that its main purpose is to get files on the infected system and then send them to a remote server (exfiltration). <br><br>  The name of the malware was left by the authors in its body, as was the case with the other malware Casper, which we mentioned above.  Apparently, the name Dino was borrowed from one of the characters in the cartoon "The Flintstones" (The Flintstones).  This malware <a href="https://securelist.com/blog/research/69114/animals-in-the-apt-farm/">was mentioned</a> in a study of the antivirus company Kaspersky Lab. <br><br>  In general, we can say that Dino is a complex backdoor, built on a modular principle.  Among the technical features, we can mention our own file system, which is used to execute commands in a secretive style, as well as a special complex module that runs as a scheduled task (task-scheduling module) and works in the same way as a <i>cron</i> command in UNIX.  The executable file contains many different informational error messages, which leads to the conclusion that the developers of the malware were people with very good knowledge of French. <br><br>  <b>Malware structure</b> <br><br>  The malware was written in C ++ and uses a modular architecture.  The following list of malware modules was extracted from the Dino executable file.  The names of the modules were given by the developers themselves. <br><br><img src="https://habrastorage.org/files/958/9b0/579/9589b0579b2b4c9fbee981721586c05b.png"><br><br>  Dino uses in its work a special data structure called "DataStore".  In particular, all malware modules store their data within this structure, so understanding the format and content of this structure is the key to understanding how malware works in general. <br><br>  The DataStore structure is an associative container (map) that stores associations (matches) between string keys and values ‚Äã‚Äãof 8 different data types.  The implementation of this data structure is based on a hash table.  This means that in order to get the value that is associated with the key, it is necessary to calculate the hash of this key to find the element of the container from which the value will be extracted. <br><br>  A hash is a one-byte value that is calculated using a series of XOR operations on a key.  Each value of the container element is the head of a coherent list that contains key / value pairs.  Below is a malicious code snippet that is responsible for retrieving the value associated with the key. <br><br><img src="https://habrastorage.org/files/aee/30c/26d/aee30c26d1b14fa9a8248c795c75ecaa.png"><br><br>  The DataStore structure can also be stored as a simple continuous array in memory, which begins with a special ‚ÄúDxSx‚Äù signature.  This storage format is used by the PSM module to store the contents of the Dino modules in an encrypted file.  When the PSM module needs to save this structure from memory to a file on disk, it saves it in exactly this format.  After restarting the malware, its code performs the operation of converting this data into an associative container structure.  The key that is used to encrypt the file with the data structure on the disk corresponds to the string "PsmIsANiceM0du1eWith0SugarInside". <br><br>  As we mentioned above, initially the Dino configuration data is stored as a simple array (the so-called serialized DataStore object) of data stored in the archive and located at the end of the malicious program executable file.  During its execution, this data is converted into an associative container and stored in memory within the CORE module.  We were able to get a list of the contents of the configuration data using the ‚Äúconf ‚Äìl CORE‚Äù command, which will be described later.  Below is the extracted configuration information. <br><br><img src="https://habrastorage.org/files/7f0/056/dd0/7f0056dd0b2a49aaa4f7c6e19514a6aa.png"><br><br>  The purpose of some of the keys is understandable by their name, however, some need a more detailed explanation. <br><br><ul><li>  "RecID": Animal Farm Cyber ‚Äã‚ÄãGroup uses this field in the structure to identify the victim.  In the case of the Dino sample we examined, this field contained the value ‚Äú11173-01-PRS‚Äù.  Another malware used by this group, Casper, used the number 13001 as its value, and some Babar samples used the values ‚Äã‚Äã‚Äú12075-01‚Äù and ‚Äú11162-01.‚Äù </li><li>  ComServer: These keys contain the URLs of the managers of the C &amp; C servers as values.  All these addresses were already invalid at the time of our analysis.  As domains for these C &amp; C servers, legitimate websites were used, which is common practice for Animal Farm cybergroups. </li><li>  ‚ÄúVersion‚Äù: the version of the malware, in our case, the field was set to ‚Äú1.2‚Äù, which is also confirmed by the name of the ‚Äúdin12‚Äù directory, the link to which appeared in one of the URLs of the C &amp; C server.  Another directory named ‚Äúd13‚Äù was seen at another Animal Farm C &amp; C server address (see section 3.7 of the Babar <a href="https://drive.google.com/file/d/0B9Mrr-en8FX4dzJqLWhDblhseTA/edit">Report</a> Calling home), which indicates the use of other versions of the Dino in-the-wild malware. </li><li>  ‚ÄúBD_Keys‚Äù and ‚ÄúCC_Keys‚Äù contain cryptographic keys for encrypting the network interaction traffic with the C &amp; C server.  The values ‚Äã‚Äãof these keys begin with the signature "MAGICBOX". </li><li>  The names of the last three keys (see screenshot above) are stored in obfuscated form ("xT0rvwz", "tr4qa589" and "jopcft4T") and contain the parameters used to work with the file system of the malicious program. </li></ul><br>  The following table indicates the commands that attackers can send to the bot.  Each command can have one or more arguments. <br><br><img src="https://habrastorage.org/files/587/a54/85f/587a5485f3ea4af9b70414afe63bf76e.png"><br><br><img src="https://habrastorage.org/files/6dc/29f/f21/6dc29ff213154d989febfbe79d881fc0.png"><br><br>  One of the above commands is of particular interest, this is the "search" command.  It allows malware operators to search for files on a compromised computer.  The search can be quite extended and performed not only by the name mask, but also by other file characteristics.  For example, an operator may request a search for files with a .doc extension that are larger than 10KB and that have been modified in the last three days.  We believe that the main purpose of Dino was precisely the theft of files (exfiltration). <br><br>  When it starts, Dino sequentially executes commands that are stored in the ‚ÄúInitialCommands‚Äù section of the configuration file.  The sample we analyzed contained the following commands. <br><br>  <i>sysinfo</i> <i><br></i>  <i>cominfos</i> <i><br></i>  <i>! ipconfig / all</i> <i><br></i>  <i>! ipconfig / displaydns</i> <i><br></i>  <i>! tracert <a href="http://www.google.com/">www.google.com</a></i> <br><br>  Obviously, these commands are used by operators as an exploration exercise.  Their execution is provided by the CMDEXEC module, and in memory the commands are located inside the CMDEXECQ module.  The result of executing these commands is sent to the C &amp; C server. <br><br>  <b>RamFS: temporary file system</b> <br><br>  The malicious program uses its (custom) file system called ramFS.  It provides a malicious program with a special complex structure for storing file data in memory, with each of the elements of the file system containing the name of the file used by a regular disk file system.  RamFS also supports a set of commands that can be placed in files and then executed.  It should be noted that ramFS is also present in other Animal Farm cybergun malware. <br><br>  The contents of the RamFS are initially stored in encrypted form in the section of the configuration file (the value of the key of the associative container) called "xT0rvwz".  The content decryption key (RC4) is stored as a value in the "tr4qa589" element.  As soon as the file system is decrypted, it will be stored in memory as a coherent list of 512 byte blocks, each of which is encrypted using RC4.  When searching a file in RamFS, the malicious code will decrypt each of these blocks, then process them, and then encrypt them again.  Thus, work with the file system is organized at the proper level of security. <br><br>  Below are some of the high-level features of this file system. <br><br><ul><li>  The name of the files and their contents are in Unicode. </li><li>  File names are limited to 260 characters. </li><li>  After decryption, the malicious code will work with data files in blocks of 540 bytes. </li><li>  FS does not associate any metadata with the file. </li></ul><br>  We could not find any already known file system, the data structures of which would correspond to ramFS, so we believe that this file system is the own development of Animal Farm cybergroup. <br><br>  The following commands can be executed by malware in the context of a file system. <br><br><img src="https://habrastorage.org/files/888/348/1cf/8883481cf1ba4edd978f6cf0c9d875ff.png"><br><br>  In the case of Dino, ramFS serves as a secure storage for a file that contains instructions for removing malware from the system.  The Dino developers call this file an uninstaller (cleaner) and it runs on the system when the bot receives the ‚ÄúkillBD‚Äù command.  The figure below shows the malware code that is responsible for executing the uninstaller file.  The first thing he does is get the file name from the above-mentioned DataStore structure ("a.ini"), why he gets the key to decrypt the contents of the ramFS.  Next, the file system is mounted in memory to extract the uninstaller file from there and execute it.  The specified lines with developers give a clear idea of ‚Äã‚Äãthe actions performed by malicious code. <br><br><img src="https://habrastorage.org/files/7ad/c37/ef6/7adc37ef6a934b17bf2d84129a7e5de7.png"><br><br>  The uninstaller executable file contains the string ‚ÄúINSTALL -A‚Äú wusvcd ‚Äù‚ÄìU‚Äù, which removes malware from the system.  The name ‚Äúwusvcd‚Äù was used when installing Dino on the system.  Therefore, ramFS is used as a secure container for files that will be executed by a malicious program on a user's computer.  Thus, it offers the execution environment required by the operator programs in the user's system, which leaves very few traces. <br><br>  <b>Scheduling tasks</b> <br><br>  The ‚Äúcronadd‚Äù, ‚Äúcronlist‚Äù and ‚Äúcrondel‚Äù commands are used to add, list and delete scheduled tasks of the CRONTAB module.  Tasks are Dino commands that are listed above.  The malicious program uses syntax similar to the <i>cron</i> command to schedule tasks.  In particular, the time for which the task is scheduled to be completed is indicated by the line of the following format ‚Äúminute day day month year week‚Äù.  In addition, this line can be replaced with "@boot" to run the specified command every time the system boots.  Below is an example of the output of the cronlist command after the execution of the wakeup command was scheduled for April 7, 2015 at 15:44. <br><br><img src="https://habrastorage.org/files/2ac/a0b/5bb/2aca0b5bb8ed4f018522490571ce77e2.png"><br><br>  As we can see, each element has its own id, which begins with the value 0xC0.  The purpose of the ‚ÄúLocal‚Äù field remains unclear to us.  The "Count" field indicates the number of times the command is executed, the value "-1" means that the command must be executed once.  The last field ‚ÄúVisibility‚Äù indicates whether the malicious code will report to its C &amp; C server about the success of the command (another possible value is ‚ÄúSilent‚Äù). <br><br>  <b>Origin Dino</b> <br><br>  The amount of executable code, which is common to all the malicious programs of the Animal Farm group, leaves little doubt in answering the question of its origin.  Among those features that are common to these malicious programs are the following. <br><br><ul><li>  At the very beginning of his performance, Dino checks the name of the current process to match the process names of the sandboxes.  The screenshot below shows this check.  Similar checks ("klavme", "myapp", "TESTAPP" and "afyjevmv.exe") are present in the Bunny and other malware samples of the Animal Farm group. <br><img src="https://habrastorage.org/files/2c5/269/034/2c5269034645415188c5bd323a8783df.png"><br></li><li>  To hide various API function calls, Dino uses a method that has been seen in use by other Animal Farm malicious programs: Dino calculates the hash of the function name and uses it to find the address of the function in its table.  The algorithm for calculating the hash in Dino is similar to that used in Casper, it uses a combination of the ROL function for 7 bits, as well as the XOR operation. </li><li>  Dino's own file system, called ramFS, is also used in other Animal Farm malware.  In these samples, it is used to store payload files.  For example, below is the ramFS command, which is used by some NBOT droppers. <br><img src="https://habrastorage.org/files/b54/500/479/b54500479d1d4cc08b63dcb055046568.png"><br></li><li>  Another proof that Dino belongs to the Animal Farm group is the output format of the command to get information about the system.  It is very similar to the output of a similar command from the updated version of the beacon component of the SNOWBALL implant, which is described in the CSE slides mentioned above. </li></ul><br><img src="https://habrastorage.org/files/ec7/56c/49a/ec756c49a2344cc7948eab9d0a3a8c8e.png"><br><img src="https://habrastorage.org/files/7c9/44e/91f/7c944e91f36741faafbc9010a95b38cb.png"><br><br>  The malware has at least two indicators that it was written by developers with a good knowledge of French. <br><br><ul><li>  The executable file of the malware contains a resource with a language code of 1036. The main purpose of this resource is to provide developers with localization of necessary controls (menus, icons, version information) for different countries in several languages.  It should be noted that in the case when the developer of the program does not set this value of the language code manually, the compiler sets it to the value of the code of the developer's OS language.  A value of 1036 <a href="https://msdn.microsoft.com/en-us/library/windows/desktop/dd318693(v%3Dvs.85).aspx">corresponds to</a> French.  We believe that this value is not false, since in some other samples of the Animal Farm cybergroup malware (ex. Casper), the language code was set to English (USA).  It seems that for those samples, Animal Farm developers simply forgot to set the correct language value and fixed it in the case of Dino.  The code 1036 was met not only in the samples of Dino, but also in other malicious programs of the Animal Farm group. </li><li>  The Dino executable is statically linked with the <a href="https://gmplib.org/">GnuMP</a> library, which is used to work with large numbers in cryptographic algorithms.  This code in the Dino samples contains the following local paths.  It can be seen that the name of the path directory uses the French word ‚Äúarithmetique‚Äù, which corresponds to the English word ‚Äúarithmetic‚Äù. </li></ul><br>  <i>.. \ .. \ src \ arithmetique \ mpn \ mul.c</i> <i><br></i>  <i>.. \ .. \ src \ arithmetique \ printf \ doprnt.c</i> <i><br></i>  <i>.. \ .. \ src \ arithmetique \ mpn \ tdiv_qr.c</i> <i><br></i>  <i>.. \ .. \ src \ arithmetique \ mpn \ mul_fft.c</i> <i><br></i>  <i>.. \ .. \ src \ arithmetique \ mpn \ get_str.c</i> <i><br></i> <br>  <b>Conclusion</b> <br><br>  Malware Dino demonstrates the good preparation of authors who used special data structures and their own file system to store configuration data and files.  Like other malware from Animal Farm, Dino is a product of highly professional and experienced developers.  However, the Dino code demonstrates poor knowledge of the authors or simply their lack of interest in the mechanisms that prevent the analysis of malware, which distinguishes it from Casper.  The body of the malware contains many different diagnostic messages by which you can predict the behavior of the program. <br><br><img src="https://habrastorage.org/files/851/32b/4c0/85132b4c0f28457a888f0c065e9a47b0.png"><br><br>  All these messages greatly facilitate the understanding of the internal structure of Dino and the actions it performs.  However, many of them contain typos. <br><br>  As for the victims of Dino, we know little about them.  According to the CSE presentation already mentioned, the victims were located in Iran.  Below is a slide presentation with information about the victims. <br><br><img src="https://habrastorage.org/files/343/bc1/8ca/343bc18ca326484fb7f5f13834137b58.png"><br><br>  <b>Compromise Indicators (IoC)</b> <br><br><img src="https://habrastorage.org/files/0eb/2ca/262/0eb2ca262e204014a466e6f4f175ebe4.png"></div><p>Source: <a href="https://habr.com/ru/post/261683/">https://habr.com/ru/post/261683/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../261673/index.html">How to implement conversion from raster to black and white vector on the site</a></li>
<li><a href="../261675/index.html">Z-monitor - update service</a></li>
<li><a href="../261677/index.html">Hierarchical classification of sites in Python</a></li>
<li><a href="../261679/index.html">Grid for responsive design</a></li>
<li><a href="../261681/index.html">The tale of how "tsifir" did not agree</a></li>
<li><a href="../261687/index.html">Microsoft is preparing a major update for Windows RT</a></li>
<li><a href="../261689/index.html">Compromise microservices</a></li>
<li><a href="../261691/index.html">FLProg - continuation of evolution</a></li>
<li><a href="../261699/index.html">How I compiled the application bundle for MacOS on Linux</a></li>
<li><a href="../261701/index.html">Deploying Nano Server with Windows Assessment and Deployment Kit (ADK) RC for Windows 10</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>