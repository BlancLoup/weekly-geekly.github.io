<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Full text search on App Engine now</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="All of course are looking forward to when the full-text search will appear in the App Engine , but so far it is not even in the roadmap . However, for...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Full text search on App Engine now</h1><div class="post__text post__text-html js-mediator-article"> All of course are looking forward to when the full-text search will appear in the <a href="http://appengine.google.com/">App Engine</a> , but so far it is not even in the <a href="http://code.google.com/appengine/docs/roadmap.html">roadmap</a> .  However, for GAE / Java, full-text search can be done independently now. <br><br><a name="habracut"></a><br><br>  You'd be surprised, but this is <a href="http://lucene.apache.org/">Lucene</a> .  No, no, do not rush to leave in frustration, sighing, "Well, this is how much you have to mess around."  Making Lucene friends with the App Engine datastore is probably not five minutes, but if you are using JDO, then the <a href="http://compass-project.org/">compass-project</a> developers in compass 2.3 (now in beta) have already done this for you. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Compass can turn your JDO objects into indexed documents and return them as search results.  The code of the simplest JDO object with indexing and search, and comments to interesting places in it, see below.  In order for this to compile and work, you need to add several libraries to <code>war/WEB-INF/lib</code> : <code>lucene-core, commons-logging  compass-2.3.0-beta1</code> .  They all live in the distribution kit of the Compass night build, which is buried deep in the jungle of their continuous build system.  At the time of writing, the last successful build lives here: <a href="http://build.compass-project.org/download/CMPTRK-NIGHTLY/artifacts/build-786/Release">http://build.compass-project.org/download/CMPTRK-NIGHTLY/artifacts/build-786/Release</a> .  I admit that I did not check the performance of this particular build. <br><br><blockquote> <code><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="black">@PersistenceCapable(identityType = IdentityType.APPLICATION) <br> @Searchable <font color="#008000">// [1]</font> <br> <font color="#0000ff">public</font> <font color="#0000ff">class</font> GreetingServiceUser { <br> @PrimaryKey <br> @Persistent(valueStrategy = IdGeneratorStrategy.IDENTITY) <br> @SearchableId <br> <font color="#0000ff">private</font> Long id; <font color="#008000">// [2]</font> <br> <br> @Persistent <br> <font color="#0000ff">private</font> <font color="#2B91AF">String</font> name; <br> <br> <font color="#0000ff">public</font> GreetingServiceUser( <font color="#2B91AF">String</font> name) { <br> <font color="#0000ff">this</font> .name = name; <br> } <br> <br> @SearchableProperty <font color="#008000">// [3]</font> <br> <font color="#0000ff">public</font> <font color="#2B91AF">String</font> getName() { <br> <font color="#0000ff">return</font> name; <br> } <br> <br> <font color="#0000ff">private</font> <font color="#0000ff">static</font> final PersistenceManagerFactory factory = <br> JDOHelper.getPersistenceManagerFactory( <font color="#A31515">"transactions-optional"</font> ); <br> <font color="#0000ff">private</font> <font color="#0000ff">static</font> Compass compass; <br> <font color="#0000ff">private</font> <font color="#0000ff">static</font> CompassGps compassGps; <br> <br> <font color="#0000ff">static</font> { <br> <font color="#008000">// [4]</font> <br> compass = <font color="#0000ff">new</font> CompassConfiguration() <br> .setConnection( <font color="#A31515">"gae://index"</font> ) <br> <font color="#008000">// [5]</font> <br> .setSetting(CompassEnvironment.ExecutorManager.EXECUTOR_MANAGER_TYPE, <br> <font color="#A31515">"disabled"</font> ) <br> .addScan( <font color="#A31515">"compass_test"</font> ) <br> .buildCompass(); <br> compassGps = <font color="#0000ff">new</font> SingleCompassGps(compass); <br> Jdo2GpsDevice jdo2GpsDevice = <font color="#0000ff">new</font> Jdo2GpsDevice( <font color="#A31515">"appengine"</font> , factory); <br> <font color="#008000">// [6]</font> <br> jdo2GpsDevice.setMirrorDataChanges( <font color="#0000ff">false</font> ); <br> compassGps.addGpsDevice(jdo2GpsDevice); <br> <font color="#008000">// [7]</font> <br> <font color="#008000">// if (compass.getSearchEngineIndexManager().isLocked()) {</font> <br> <font color="#008000">//   compass.getSearchEngineIndexManager().releaseLocks();</font> <br> <font color="#008000">// }</font> <br> compassGps.start(); <br> } <br> <br> <font color="#0000ff">public</font> <font color="#0000ff">void</font> save() { <br> PersistenceManager pm = factory.getPersistenceManager(); <br> CompassIndexSession indexSession = <font color="#0000ff">null</font> ; <br> <font color="#0000ff">try</font> { <br> pm.makePersistent( <font color="#0000ff">this</font> ); <br> <br> <font color="#008000">// [8]</font> <br> <font color="#008000">// compass.getSearchEngineIndexManager().releaseLocks();</font> <br> <br> <font color="#008000">// [9]</font> <br> indexSession = compass.openIndexSession(); <br> indexSession.save( <font color="#0000ff">this</font> ); <br> indexSession.commit(); <br> } <br> <font color="#0000ff">catch</font> (Throwable e) { <br> e.printStackTrace(); <br> } <br> <font color="#0000ff">finally</font> { <br> pm.close(); <br> <font color="#0000ff">if</font> (indexSession != <font color="#0000ff">null</font> ) { <br> indexSession.close(); <br> } <br> } <br> } <br> <br> <font color="#0000ff">public</font> <font color="#0000ff">static</font> <font color="#2B91AF">List</font> &lt;GreetingServiceUser&gt; search( <font color="#2B91AF">String</font> query) { <br> CompassSearchSession searchSession = compass.openSearchSession(); <br> <br> CompassHits hits = searchSession.find(query); <br> <font color="#2B91AF">List</font> &lt;GreetingServiceUser&gt; results = <br> <font color="#0000ff">new</font> <font color="#2B91AF">ArrayList</font> &lt;GreetingServiceUser&gt;(hits.getLength()); <br> PersistenceManager pm = factory.getPersistenceManager(); <br> <font color="#0000ff">try</font> { <br> <font color="#0000ff">for</font> ( <font color="#0000ff">int</font> i=0; i&lt;hits.length(); i++) { <br> <font color="#008000">// [10]</font> <br> results.add(pm.getObjectById( <br> GreetingServiceUser. <font color="#0000ff">class</font> , <br> Long.valueOf(hits.resource(i).getId()))); <br> } <br> } <br> <font color="#0000ff">catch</font> (JDOObjectNotFoundException e) { <br> e.printStackTrace(); <br> } <br> <font color="#0000ff">finally</font> { <br> pm.close(); <br> } <br> <font color="#0000ff">return</font> results; <br> } <br> } <br></font> <br> <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></code> </blockquote> <br><br>  <b>[1]</b> Annotations mark JDO classes to be indexed ... <br>  <b>[2]</b> ... properties identifying documents, ... <br>  <b>[3]</b> ... and finally properties whose values ‚Äã‚Äãwill be indexed. <br>  <b>[4]</b> When constructing a <code>Compass</code> instance, you specify which packages to scan for such annotations. <br>  <b>[5]</b> This is an App Engine specificity.  Compass generally works in several threads, but you cannot create threads on App Engine, so you need to disable threads. <br>  <b>[6]</b> This is also a small hack relevant for App Engine.  Compass is generally able to update the index automatically when something changes in the persistent data interesting to it.  But when working on App Engine, it may not fit into the allotted 30 seconds.  Calling <code>setMirrorDataChanges(false)</code> will disable automatic updating and you will need to manually update the index.  This is not painful, and as compensation it can be done, for example, in a separate task in the task queue. <br>  <b>[7, 8]</b> App Engine support is still damp, and sometimes Compass seems to forget to remove the index locks.  I have not yet understood the reasons and the correct way of correction, but an explicit request to release the locks helps.  We must, of course, understand that this may not be very safe.  If anyone takes the time to catch the problem and win, let me know. <br>  <b>[9]</b> Actually, the object is indexed manually. <br>  <b>[10]</b> The result of the search is the <code>CompassHits</code> collection.  It is theoretically possible to extract the objects found ( <code>GreetingServiceUser</code> in our case) by the <code>data(int)</code> method, but in my case they were obtained with empty values.  Therefore, I use the Resource object that corresponds to the document, extract the document id from it and look for the corresponding JDO object using JDO / AppEngine. </div><p>Source: <a href="https://habr.com/ru/post/90223/">https://habr.com/ru/post/90223/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../90216/index.html">JetBrains at Sun Tech Days 2010</a></li>
<li><a href="../90217/index.html">Algorithmic complexity of hashset iteration in C #</a></li>
<li><a href="../90219/index.html">Based on MakHost, or Fiord calls to him</a></li>
<li><a href="../90220/index.html">Temporary access to resources located at Makhost's facilities via FTP / SFTP / SSH protocols</a></li>
<li><a href="../90221/index.html">IBM broke the promise of not using its patents against open source developers</a></li>
<li><a href="../90227/index.html">Kobo eReader - Overview</a></li>
<li><a href="../90229/index.html">EeePad DIY</a></li>
<li><a href="../90231/index.html">Richard Feynman: Magnets and Why Questions?</a></li>
<li><a href="../90232/index.html">Manage code dependencies</a></li>
<li><a href="../90236/index.html">Summaries for the lazy</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>