<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Running regular tasks on a cluster or how to make friends with Apache Spark and Oozie</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="It has long been in the air the need to implement the launch of regular Spark tasks through Oozie, but all hands did not reach and finally it happened...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Running regular tasks on a cluster or how to make friends with Apache Spark and Oozie</h1><div class="post__text post__text-html js-mediator-article"><p><img src="https://habrastorage.org/webt/59/cd/51/59cd511673a9c343087598.png"></p><br><p>  It has long been in the air the need to implement the launch of regular Spark tasks through Oozie, but all hands did not reach and finally it happened.  In this article I want to describe the whole process, maybe it will simplify your life. </p><a name="habracut"></a><br><h4 id="soderzhanie">  Content </h4><br><ul><li>  Task </li><li>  Hardware and software installed </li><li>  Writing Spark Tasks </li><li>  Writing workflow.xml </li><li>  Writing coordinator.xml </li><li>  Project posting on hdfs </li><li>  Run regular run </li><li>  Conclusion </li></ul><br><h4 id="zadacha">  Task </h4><br><p>  We have the following structure in hdfs: </p><br><pre><code class="bash hljs">hdfs://hadoop/project-MD2/data hdfs://hadoop/project-MD2/<span class="hljs-built_in"><span class="hljs-built_in">jobs</span></span> hdfs://hadoop/project-MD2/status</code> </pre> <br><p>  The <code>data</code> directory receives <code>data</code> daily and is displayed in directories according to the date.  For example, data for 12/31/2017 will be written in the following way: <code>hdfs://hadoop/project/data/2017/12/31/20171231.csv.gz</code> . </p><br><h5 id="format-vhodnyh-dannyh">  Input Format </h5><br><ul><li>  Line delimiter: ‚Äú\ n‚Äù </li><li>  Column separator: ‚Äú;‚Äù </li><li>  Compression Method: gzip </li><li>  Number of columns: 5 (device_id; lag_A0; lag_A1; flow_1; flow_2) </li><li>  The title in the first line is missing </li><li>  Data for the previous day is guaranteed to be recorded in the appropriate directory in the time interval from 00:00 to 03:00 the next day. </li></ul><br><p>  The <code>jobs</code> directory contains tasks that are directly related to the project.  Our task will also be placed in this directory. <br>  The <code>status</code> directory should store statistics on the number of empty fields (with a null value) for each day in json format.  For example, for the data for 12/31/2017, the file <code>hdfs://hadoop/project-MD2/status/2017/12/31/part-*.json</code> should appear </p><br><h5 id="primet-json-fayla">  Will accept json file: </h5><br><pre> <code class="hljs json">{ <span class="hljs-attr"><span class="hljs-attr">"device_id_count_empty"</span></span> : <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-attr"><span class="hljs-attr">"lag_A0_count_empty"</span></span> : <span class="hljs-number"><span class="hljs-number">10</span></span>, <span class="hljs-attr"><span class="hljs-attr">"lag_A1_count_empty"</span></span> : <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-attr"><span class="hljs-attr">"flow_1_count_empty"</span></span> : <span class="hljs-number"><span class="hljs-number">37</span></span>, <span class="hljs-attr"><span class="hljs-attr">"flow_2_count_empty"</span></span> : <span class="hljs-number"><span class="hljs-number">100</span></span> }</code> </pre> <br><h4 id="oborudovanie-i-ustanovlennoe-po">  Hardware and software installed </h4><br><p>  We have a cluster of 10 machines, each of which has an 8-core processor and 64 GB of RAM.  The total amount of hard drives on all machines is 100 TB.  To run tasks on a cluster, the <code>PROJECTS</code> queue is allocated. </p><br><h5 id="ustanovlennoe-po">  Installed software: </h5><br><ul><li>  Apache Hadoop 2.7.3 (Hortonworks) </li><li>  Apache Spark 2.0.0 </li><li>  Apache Oozie 4.2.0 </li><li>  Scala 2.11.11 </li><li>  Sbt 1.0.2 </li></ul><br><h4 id="napisanie-spark-zadachi">  Writing Spark Tasks </h4><br><p>  Create a project structure, this can be very easily done in any development environment that supports scala or from the console, as shown below: </p><br><pre> <code class="bash hljs">mkdir -p daily-statistic/project <span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> <span class="hljs-string"><span class="hljs-string">"sbt.version = 1.0.2"</span></span> &gt; daily-statistic/project/build.properties <span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> <span class="hljs-string"><span class="hljs-string">""</span></span> &gt; daily-statistic/project/plugins.sbt <span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> <span class="hljs-string"><span class="hljs-string">""</span></span> &gt; daily-statistic/build.sbt mkdir -p daily-statistic/src/main/scala</code> </pre> <br><p>  Great, now let's add a plugin for the assembly, for this we add the following line in the <code>daily-statistic/project/plugins.sbt</code> file: </p><br><pre> <code class="scala hljs">addSbtPlugin(<span class="hljs-string"><span class="hljs-string">"com.eed3si9n"</span></span> % <span class="hljs-string"><span class="hljs-string">"sbt-assembly"</span></span> % <span class="hljs-string"><span class="hljs-string">"0.14.5"</span></span>)</code> </pre> <br><p>  Add a description of the project, dependencies and features of the assembly in the file <code>daily-statistic/build.sbt</code> : </p><br><pre> <code class="scala hljs">name := <span class="hljs-string"><span class="hljs-string">"daily-statistic"</span></span> version := <span class="hljs-string"><span class="hljs-string">"0.1"</span></span> scalaVersion := <span class="hljs-string"><span class="hljs-string">"2.11.11"</span></span> libraryDependencies ++= <span class="hljs-type"><span class="hljs-type">Seq</span></span>( <span class="hljs-string"><span class="hljs-string">"org.apache.spark"</span></span> %% <span class="hljs-string"><span class="hljs-string">"spark-core"</span></span> % <span class="hljs-string"><span class="hljs-string">"2.0.0"</span></span> % <span class="hljs-string"><span class="hljs-string">"provided"</span></span>, <span class="hljs-string"><span class="hljs-string">"org.apache.spark"</span></span> %% <span class="hljs-string"><span class="hljs-string">"spark-sql"</span></span> % <span class="hljs-string"><span class="hljs-string">"2.0.0"</span></span> % <span class="hljs-string"><span class="hljs-string">"provided"</span></span> ) assemblyJarName in assembly := <span class="hljs-string"><span class="hljs-string">s"</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${name.value}</span></span></span><span class="hljs-string">-</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${version.value}</span></span></span><span class="hljs-string">.jar"</span></span></code> </pre> <br><p>  Go to the <code>daily-statistic</code> directory and execute the <code>sbt update</code> command to update the project and pull dependencies from the repository. <br>  Create <code>Statistic.scala</code> in the <code>src/main/scala/ru/daily</code> directory </p><br><h5 id="kod-zadachi">  Task code: </h5><br><pre> <code class="scala hljs"><span class="hljs-keyword"><span class="hljs-keyword">package</span></span> ru.daily <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.apache.spark.sql.<span class="hljs-type"><span class="hljs-type">SparkSession</span></span> <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.apache.spark.sql.<span class="hljs-type"><span class="hljs-type">DataFrame</span></span> <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.apache.spark.sql.functions._ <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">object</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Statistic</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">App</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-comment"><span class="hljs-comment">//  implicit lazy val spark: SparkSession = SparkSession.builder() .appName("daily-statistic") .getOrCreate() import spark.implicits._ val workDir = args(0) val datePart = args(1) val saveDir = args(2) try { val date = read(s"$workDir/$datePart/*.csv.gz") .select( '_c0 as "device_id", '_c1 as "lag_A0", '_c2 as "lag_A1", '_c3 as "flow_1", '_c4 as "flow_2" ) save(s"$saveDir/$datePart", agg(date)) } finally spark.stop() //    def read(path: String)(implicit spark: SparkSession): DataFrame = { val inputFormat = Map("header" -&gt; "false", "sep" -&gt; ";", "compression" -&gt; "gzip") spark.read .options(inputFormat) .csv(path) } //   def agg(data: DataFrame):DataFrame = data .withColumn("device_id_empty", when('device_id.isNull, lit(1)).otherwise(0)) .withColumn("lag_A0_empty", when('lag_A0.isNull, lit(1)).otherwise(0)) .withColumn("lag_A1_empty", when('lag_A1.isNull, lit(1)).otherwise(0)) .withColumn("flow_1_empty", when('flow_1.isNull, lit(1)).otherwise(0)) .withColumn("flow_2_empty", when('flow_2.isNull, lit(1)).otherwise(0)) .agg( sum('device_id_empty) as "device_id_count_empty", sum('lag_A0_empty) as "lag_A0_count_empty", sum('lag_A1_empty) as "lag_A1_count_empty", sum('flow_1_empty) as "flow_1_count_empty", sum('flow_2_empty) as "flow_2_count_empty" ) //   def save(path: String, data: DataFrame): Unit = data.write.json(path) }</span></span></code> </pre> <br><p>  We <code>sbt assembly</code> project with the <code>sbt assembly</code> team from the <code>daily-statistic</code> directory.  After successful completion of the build, a package with the task <code>daily-statistic-0.1.jar</code> will appear in the <code>daily-statistic/target/scala-2.11</code> <code>daily-statistic-0.1.jar</code> . </p><br><h4 id="napisanie-workflowxml">  Writing workflow.xml </h4><br><p>  To run a task through Oozie, you need to describe the launch configuration in the <code>workflow.xml</code> file.  Below is an example for our task: </p><br><pre> <code class="xml hljs"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">workflow-app</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"project-md2-daily-statistic"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">xmlns</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"uri:oozie:workflow:0.5"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">global</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">configuration</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">property</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">name</span></span></span><span class="hljs-tag">&gt;</span></span>oozie.launcher.mapred.job.queue.name<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">name</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">value</span></span></span><span class="hljs-tag">&gt;</span></span>${queue}<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">value</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">property</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">configuration</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">global</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">start</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">to</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"project-md2-daily-statistic"</span></span></span><span class="hljs-tag"> /&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">action</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"project-md2-daily-statistic"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">spark</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">xmlns</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"uri:oozie:spark-action:0.1"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">job-tracker</span></span></span><span class="hljs-tag">&gt;</span></span>${jobTracker}<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">job-tracker</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">name-node</span></span></span><span class="hljs-tag">&gt;</span></span>${nameNode}<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">name-node</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">master</span></span></span><span class="hljs-tag">&gt;</span></span>yarn-client<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">master</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">name</span></span></span><span class="hljs-tag">&gt;</span></span>project-md2-daily-statistic<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">name</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">class</span></span></span><span class="hljs-tag">&gt;</span></span>ru.daily.Statistic<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">class</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">jar</span></span></span><span class="hljs-tag">&gt;</span></span>${nameNode}${jobDir}/lib/daily-statistic-0.1.jar<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">jar</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">spark-opts</span></span></span><span class="hljs-tag">&gt;</span></span> --queue ${queue} --master yarn-client --num-executors 5 --conf spark.executor.cores=8 --conf spark.executor.memory=10g --conf spark.executor.extraJavaOptions=-XX:+UseG1GC --conf spark.yarn.jars=*.jar --conf spark.yarn.queue=${queue} <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">spark-opts</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">arg</span></span></span><span class="hljs-tag">&gt;</span></span>${nameNode}${dataDir}<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">arg</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">arg</span></span></span><span class="hljs-tag">&gt;</span></span>${datePartition}<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">arg</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">arg</span></span></span><span class="hljs-tag">&gt;</span></span>${nameNode}${saveDir}<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">arg</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">spark</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">ok</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">to</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"end"</span></span></span><span class="hljs-tag"> /&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">error</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">to</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"fail"</span></span></span><span class="hljs-tag"> /&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">action</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">kill</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"fail"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">message</span></span></span><span class="hljs-tag">&gt;</span></span>Statistics job failed [${wf:errorMessage(wf:lastErrorNode())}]<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">message</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">kill</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">end</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"end"</span></span></span><span class="hljs-tag"> /&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">workflow-app</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre> <br><p>  In the <code>global</code> block, a queue is established, for the MapReduce task that will find our task and run it. <br>  The <code>action</code> block describes the action, in our case the start of the spark task, and what to do when completed with the <code></code> or <code>ERROR</code> status. <br>  In the <code>spark</code> block, the environment is determined, the task is configured, and arguments are passed.  The configuration of the launch task is described in the <code>spark-opts</code> .  Parameters can be viewed in the <a href="http://spark.apache.org/docs/2.0.0/configuration.html">official documentation.</a> <br>  If the task is completed with the <code>ERROR</code> status, the execution goes to the <code>kill</code> block and a multiple error message is displayed. <br>  Parameters in curly brackets, such as <code>${queue}</code> , we will determine at startup. </p><br><h4 id="napisanie-coordinatorxml">  Writing coordinator.xml </h4><br><p>  To organize a regular launch, we will need more <code>coordinator.xml</code> .  Below is an example for our task: </p><br><pre> <code class="xml hljs"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">coordinator-app</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"project-md2-daily-statistic-coord"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">frequency</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"${frequency}"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">start</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"${startTime}"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">end</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"${endTime}"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">timezone</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"UTC"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">xmlns</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"uri:oozie:coordinator:0.1"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">action</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">workflow</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">app-path</span></span></span><span class="hljs-tag">&gt;</span></span>${workflowPath}<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">app-path</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">configuration</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">property</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">name</span></span></span><span class="hljs-tag">&gt;</span></span>datePartition<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">name</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">value</span></span></span><span class="hljs-tag">&gt;</span></span>${coord:formatTime(coord:dateOffset(coord:nominalTime(), -1, 'DAY'), "yyyy/MM/dd")}<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">value</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">property</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">configuration</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">workflow</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">action</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">coordinator-app</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre> <br><p>  Here, from the interesting, the parameters <code>frequency</code> , <code>start</code> , <code>end</code> , which determine the frequency of execution, the date and time of the start of the task, the date and time of the end of the task, respectively. <br>  The <code>workflow</code> block indicates the path to the directory with the <code>workflow.xml</code> file, which we will specify later on launch. <br>  In the <code>configuration</code> block, the value of the <code>datePartition</code> property is <code>datePartition</code> , which in this case is equal to the current date in the format <code>yyyy/MM/dd</code> minus 1 day. </p><br><h5 id="razmeschenie-proekta-na-hdfs">  Project posting on hdfs </h5><br><p>  As mentioned earlier, we will place our task in the <code>hdfs://hadoop/project-MD2/jobs</code> directory: </p><br><pre> <code class="hljs bash">hdfs://hadoop/project-MD2/<span class="hljs-built_in"><span class="hljs-built_in">jobs</span></span>/daily-statistic/lib/daily-statistic-0.1.jar hdfs://hadoop/project-MD2/<span class="hljs-built_in"><span class="hljs-built_in">jobs</span></span>/daily-statistic/workflow.xml hdfs://hadoop/project-MD2/<span class="hljs-built_in"><span class="hljs-built_in">jobs</span></span>/daily-statistic/coordinator.xml hdfs://hadoop/project-MD2/<span class="hljs-built_in"><span class="hljs-built_in">jobs</span></span>/daily-statistic/sharelib</code> </pre> <br><p>  Here, in principle, everything is clear without comments except for the <code>sharelib</code> directory.  In this directory we put all the libraries that were used in the process of creating the task sew.  In our case, these are all Spark 2.0.0 libraries, which we specified in project dependencies.  Why do you need it?  The fact is that in the project dependencies we specified <code>"provided"</code> .  This says the build system does not need to include dependencies in the project, they will be provided by the launch environment, but the world is not in place, cluster administrators can update the version of Spark.  Our task may be sensitive to this update, so the launch will use a set of libraries from the <code>sharelib</code> directory.  How this is configured will show below. </p><br><h4 id="zapusk-regulyarnogo-vypolneniya">  Run regular run </h4><br><p>  And so everything is ready for the exciting moment of launch.  We will run the task through the console.  At startup, you need to set the values ‚Äã‚Äãof the properties that we used in the <code>xml</code> files.  Let's take these properties into a separate file <code>coord.properties</code> : </p><br><pre> <code class="hljs pgsql">#   nameNode=hdfs://hadoop jobTracker=hadoop.host.ru:<span class="hljs-number"><span class="hljs-number">8032</span></span> #      coordinator.xml oozie.coord.application.path=/project-MD2/jobs/daily-statistic #    (  <span class="hljs-number"><span class="hljs-number">24</span></span> ) frequency=<span class="hljs-number"><span class="hljs-number">1440</span></span> startTime=<span class="hljs-number"><span class="hljs-number">2017</span></span><span class="hljs-number"><span class="hljs-number">-09</span></span><span class="hljs-number"><span class="hljs-number">-01</span></span>T07:<span class="hljs-number"><span class="hljs-number">00</span></span>Z endTime=<span class="hljs-number"><span class="hljs-number">2099</span></span><span class="hljs-number"><span class="hljs-number">-09</span></span><span class="hljs-number"><span class="hljs-number">-01</span></span>T07:<span class="hljs-number"><span class="hljs-number">00</span></span>Z #      workflow.xml workflowPath=/project-MD2/jobs/daily-statistic #  ,      mapreduce.job.<span class="hljs-keyword"><span class="hljs-keyword">user</span></span>.name=username <span class="hljs-keyword"><span class="hljs-keyword">user</span></span>.name=username #        dataDir=/project-MD2/data saveDir=/project-MD2/status jobDir=/project-MD2/jobs/daily-statistic #     queue=PROJECTS #       hdfs   oozie.libpath=/project-MD2/jobs/daily-statistic/sharelib oozie.use.<span class="hljs-keyword"><span class="hljs-keyword">system</span></span>.libpath=<span class="hljs-keyword"><span class="hljs-keyword">false</span></span></code> </pre> <br><p>  Wonderful, rub everything ready.  We start regular execution with the command: </p><br><pre> <code class="bash hljs">oozie job -oozie http://hadoop.host.ru:11000/oozie -config coord.properties -run</code> </pre> <br><p>  After launch, the task job will be displayed in the console.  Using this job_id you can view information on the status of the task: </p><br><pre> <code class="bash hljs">oozie job -info {job_id}</code> </pre> <br><p>  Stop the task: </p><br><pre> <code class="bash hljs">oozie job -<span class="hljs-built_in"><span class="hljs-built_in">kill</span></span> {job_id}</code> </pre> <br><p>  If you do not know the job_id task, you can find it by displaying all the regular tasks for your user: </p><br><pre> <code class="bash hljs">oozie <span class="hljs-built_in"><span class="hljs-built_in">jobs</span></span> -jobtype coordinator -filter user={user_name}</code> </pre> <br><h4 id="zaklyuchenie">  Conclusion </h4><br><p>  It turned out a bit long, but in my opinion better detailed instructions than the quest search on the Internet.  I hope the described experience will be useful for you, thank you for your attention! </p></div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <p>Source: <a href="https://habr.com/ru/post/338952/">https://habr.com/ru/post/338952/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../338942/index.html">Micromaster's degree as a new form of education. Overview of the first pilot program</a></li>
<li><a href="../338944/index.html">Internet where there is none, or Fixed connection based on 3G-LTE</a></li>
<li><a href="../338946/index.html">We write our book again</a></li>
<li><a href="../338948/index.html">Time management for kinesthetics</a></li>
<li><a href="../338950/index.html">Symfony + RabbitMQ Quick start for young</a></li>
<li><a href="../338954/index.html">NetApp ONTAP ‚îÄ we will break it down</a></li>
<li><a href="../338958/index.html">Event digest for HR specialists in the IT field for October 2017</a></li>
<li><a href="../338960/index.html">How I searched (and found!) The bugs in the kickico smartcontract</a></li>
<li><a href="../338966/index.html">Monitoring of engineering infrastructure in the data center. Part 3. Cooling system</a></li>
<li><a href="../338968/index.html">FlashMapper is an alternative to auto-mapper</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>