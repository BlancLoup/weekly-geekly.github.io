<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>vk.com - Saving audio recordings, documents, the contents of the wall</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="I have long noticed that the data on social networks is stored poorly. For example, the repost you made will be empty if the author of the original en...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>vk.com - Saving audio recordings, documents, the contents of the wall</h1><div class="post__text post__text-html js-mediator-article">  I have long noticed that the data on social networks is stored poorly.  For example, the repost you made will be empty if the author of the original entry deletes it.  Recent problems with audio recordings in vk are the last straw, and I decided to save locally all the data that might be of interest <s>in case of a nuclear war</s> .  After searching for ready-made solutions, I did not find anything that would suit me, so a script in Python was written in a few days. <a name="habracut"></a><br><br><h4>  Goals </h4><br>  Save all you can: audio recordings, documents, wall.  From the wall you need to drag off all attachments to posts, and comments with all attachments will not be superfluous either.  It is necessary at least to preserve all the posts with music and comments, where friends sent good tracks <s>or cats</s> .  I‚Äôll say right away that for my purposes there was no readable backup of additional information (likes, record creation time, etc.). <br><br><h4>  For the cause! </h4><br>  The process of creating such an application has already <a href="http://habrahabr.ru/post/143972/">been</a> <a href="http://habrahabr.ru/post/183546/">described</a> <a href="http://habrahabr.ru/post/143972/">many times</a> in Habr√©, so I will not repeat all the details, I will describe the work steps in brief, and I will also say a few words about the problems.  That article was not overloaded with source codes, in the end there will be a link to github. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h5>  Considerations in the development </h5><br><ul><li>  First of all, you need to get yourself an <a href="https://vk.com/editapp%3Fact%3Dcreate">application id</a> .  It is important that the type be <b>standalone</b> , otherwise some vk api methods will not be available. </li><li>  You also need the id of the user, whose data will be saved.  You can find your own <a href="https://vk.com/settings">on the settings page</a> </li><li>  For the application to work, you need user permission, or rather, access token.  There is no direct non-interactive way to get a token, you can parse the authorization page, but it's easier to ask the user to click a button in the browser and copy the url.  The auth () function is responsible for this: <br><pre><code class="python hljs">url = <span class="hljs-string"><span class="hljs-string">"https://oauth.vk.com/oauth/authorize?"</span></span> + \ <span class="hljs-string"><span class="hljs-string">"redirect_uri=https://oauth.vk.com/blank.html&amp;response_type=token&amp;"</span></span> + \ <span class="hljs-string"><span class="hljs-string">"client_id=%s&amp;scope=%s&amp;display=wap"</span></span> % (args.app_id, <span class="hljs-string"><span class="hljs-string">","</span></span>.join(args.access_rights)) print(<span class="hljs-string"><span class="hljs-string">"Please open this url:\n\n\t{}\n"</span></span>.format(url)) raw_url = raw_input(<span class="hljs-string"><span class="hljs-string">"Grant access to your acc and copy resulting URL here: "</span></span>) res = re.search(<span class="hljs-string"><span class="hljs-string">'access_token=([0-9A-Fa-f]+)'</span></span>, raw_url, re.I)</code> </pre> <br></li><li>  Vk api requests have a limit: no more than five per second.  If you contact the server too often, it will respond with an error.  This is quite convenient: by the error code you can understand that the script is working too fast, wait for a while and repeat the request. <br><pre> <code class="hljs python"> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> result[<span class="hljs-string"><span class="hljs-string">u'error'</span></span>][<span class="hljs-string"><span class="hljs-string">u'error_code'</span></span>] == <span class="hljs-number"><span class="hljs-number">6</span></span>: <span class="hljs-comment"><span class="hljs-comment"># too many requests logging.debug("Too many requests per second, sleeping..") sleep(1) continue</span></span></code> </pre><br></li><li>  Periodically, the vk server requires you to solve the captcha, suspecting that the client is a bot.  In general, he correctly suspects.  To save the process is not interrupted, you have to ask the user to click on the link to the picture, solve the captcha and drive the answer.  This is rendered to the function with the straightforward name captcha (): <br><pre> <code class="hljs python"> print(<span class="hljs-string"><span class="hljs-string">"They want you to solve CAPTCHA. Please open this URL, and type here a captcha solution:"</span></span>) print(<span class="hljs-string"><span class="hljs-string">"\n\t{}\n"</span></span>.format(data[<span class="hljs-string"><span class="hljs-string">u'error'</span></span>][<span class="hljs-string"><span class="hljs-string">u'captcha_img'</span></span>])) solution = raw_input(<span class="hljs-string"><span class="hljs-string">"Solution = "</span></span>).strip() <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> data[<span class="hljs-string"><span class="hljs-string">u'error'</span></span>][<span class="hljs-string"><span class="hljs-string">u'captcha_sid'</span></span>], solution</code> </pre><br></li><li>  Links, additional information like the number of likes and server responses in JSON will be written to files, just in case. </li><li>  Text of the song is attached to some audio recordings, which also makes sense to save. </li><li>  File names may be incorrect for the file system, so you have to get rid of some characters.  I did not find a ready-made ‚Äúright‚Äù solution, so I had to invent a mini-bike: <br><pre> <code class="python hljs">result = unicode(re.sub(<span class="hljs-string"><span class="hljs-string">'[^+=\-()$!#%&amp;,.\w\s]'</span></span>, <span class="hljs-string"><span class="hljs-string">'_'</span></span>, name, flags=re.UNICODE).strip())</code> </pre><br></li><li>  Another problem with file names: may coincide, for example in the case of documents.  To do this, add (n) to the file name, where n is the first number that gives a unique file name. <br><pre> <code class="python hljs"> <span class="hljs-comment"><span class="hljs-comment">#file might exist, so add (1) or (2) etc counter = 1 if exists(fname) and isfile(fname): name, ext = splitext(fname) fname = name + " ({})".format(counter) + ext while exists(fname) and isfile(fname): counter += 1 name, ext = splitext(fname) fname = name[:-4] + " ({})".format(counter) + ext</span></span></code> </pre><br></li></ul><br><br><h5>  Continue </h5><br>  The reference code for the api is taken from the <a href="http://habrahabr.ru/post/143972/">article of</a> habrauzer <a href="https://habrahabr.ru/users/dzhioev/" class="user_link">dzhioev</a> , and the handling of the situations described above is added.  To be what to save (in the case of processing the wall), you must first find out the number of posts: <br><pre> <code class="python hljs"> <span class="hljs-comment"><span class="hljs-comment">#determine posts count (response, json_stuff) = call_api("wall.get", [("owner_id", args.id), ("count", 1), ("offset", 0)], args) count = response[0]</span></span></code> </pre><br>  Further we request each post separately and we sort it <br><pre> <code class="python hljs"> <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> x <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> xrange(args.wall_start, args.wall_end): (post, json_stuff) = call_api(<span class="hljs-string"><span class="hljs-string">"wall.get"</span></span>, [(<span class="hljs-string"><span class="hljs-string">"owner_id"</span></span>, args.id), (<span class="hljs-string"><span class="hljs-string">"count"</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>), (<span class="hljs-string"><span class="hljs-string">"offset"</span></span>, x)], args) process_post((<span class="hljs-string"><span class="hljs-string">"wall post"</span></span>, x), post, post_parser, json_stuff)</code> </pre><br>  The result of the request is a set of data in JSON, which are interpreted into standard structures for python using json.loads () from the standard library.  As a result, we have a hash array, in which some fields (key-value) carry the payload, and the rest do not interest us.  In order not to write with our hands what field to use for which method, let us use the power of reflection: we will look for a method whose name matches the key of interest. <br><pre> <code class="python hljs"> <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> k <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> raw_data.keys(): <span class="hljs-keyword"><span class="hljs-keyword">try</span></span>: f = getattr(self, k) keys.append(k) funcs.append(f) <span class="hljs-keyword"><span class="hljs-keyword">except</span></span> AttributeError: logging.warning(<span class="hljs-string"><span class="hljs-string">"Not implemented: {}"</span></span>.format(k)) logging.info(<span class="hljs-string"><span class="hljs-string">"Saving: {} for {}"</span></span>.format(<span class="hljs-string"><span class="hljs-string">', '</span></span>.join(keys), raw_data[<span class="hljs-string"><span class="hljs-string">'id'</span></span>])) <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (f, k) <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> zip(funcs, keys): f(k, raw_data)</code> </pre><br><br><h5>  Parsim </h5><br>  Now you need to deal with the answer fields.  The interesting ones are attachments, text, comments.  Attachments is a list of applications for the post (audio, pictures, documents, notes), you must be able to download each type.  We determine which method to process each attachment in the same way: by the type of attachment, we are looking for a method with a suitable name.  Here is an example of a rocker for audio: <br><pre> <code class="python hljs"> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">dl_audio</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self, data)</span></span></span><span class="hljs-function">:</span></span> aid = data[<span class="hljs-string"><span class="hljs-string">"aid"</span></span>] owner = data[<span class="hljs-string"><span class="hljs-string">"owner_id"</span></span>] request = <span class="hljs-string"><span class="hljs-string">"{}_{}"</span></span>.format(owner, aid) (audio_data, json_stuff) = call_api(<span class="hljs-string"><span class="hljs-string">"audio.getById"</span></span>, [(<span class="hljs-string"><span class="hljs-string">"audios"</span></span>, request), ], self.args) <span class="hljs-keyword"><span class="hljs-keyword">try</span></span>: data = audio_data[<span class="hljs-number"><span class="hljs-number">0</span></span>] name = <span class="hljs-string"><span class="hljs-string">u"{artist} - {title}.mp3"</span></span>.format(**data) self.save_url(data[<span class="hljs-string"><span class="hljs-string">"url"</span></span>], name) <span class="hljs-keyword"><span class="hljs-keyword">except</span></span> IndexError: <span class="hljs-comment"><span class="hljs-comment"># deleted :( logging.warning("Deleted track: {}".format(str(data))) return # store lyrics if any try: lid = data["lyrics_id"] except KeyError: return (lyrics_data, json_stuff) = call_api("audio.getLyrics", [("lyrics_id", lid), ], self.args) text = lyrics_data["text"].encode('utf-8') ...</span></span></code> </pre><br>  Unfortunately, the recordings taken at the request of the copyright holders are no longer available; an empty response is returned for them. <br><br><h4>  But other? </h4><br>  Methods for processing images, text, notes, upload documents and the rest - <a href="https://github.com/Rast1234/vkd">in github</a> .  I can only say that everything is similar to the examples given.  The script also has command line arguments, it makes no sense to describe them in the article.  Examples and other details are <a href="">in the readme</a> . <br><br><h5>  Todo </h5><br>  I did not save the photo albums, because I have nothing important stored there, and the <a href="https://habrahabr.ru/users/kilonet/" class="user_link">kilonet</a> code from <a href="http://habrahabr.ru/post/183546/">his article</a> works well.  The videos and notes are still not saved, it seemed to me not very necessary. <br><br><h6>  Lastly </h6><br>  The code is far from ideal and does not differ in the absence of crutches, but performs the task.  I hope someone will be useful my craft, to save their records / documents / music, or for training. <br><br><h6>  UPD 12/18/2016 </h6><br>  The <a href="https://habrahabr.ru/users/hiwent/" class="user_link">hiwent user</a> says that since 12/16/2016, the vk closed the possibility to use the API for working with audio recordings.  In this regard, the script functionality provided for saving audio recordings does not work.  In this regard, you can try to ‚Äúpretend‚Äù to the native application vk, for example, the android version, or kate mobile.  For them, the ability to work with audio recordings will not disappear, although there may be different methods. </div><p>Source: <a href="https://habr.com/ru/post/184224/">https://habr.com/ru/post/184224/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../184212/index.html">Channel 1 explained why the law on blocking sites is being introduced</a></li>
<li><a href="../184214/index.html">What do people actually do on the Internet?</a></li>
<li><a href="../184218/index.html">How to shoot a year-long TimeLapse video on an Android phone</a></li>
<li><a href="../184220/index.html">PHP 5.5 "Password Hashing API"</a></li>
<li><a href="../184222/index.html">Elixir</a></li>
<li><a href="../184228/index.html">VoIP telephony - how to estimate the real cost of a solution</a></li>
<li><a href="../184232/index.html">Feathers - Starling-based UI framework for mobile and desktop applications</a></li>
<li><a href="../184236/index.html">US Federal Aviation Agency (FAA) will revise the ban on the use of gadgets in aircraft</a></li>
<li><a href="../184238/index.html">Once again about the movie, or together with the water and throw out the child</a></li>
<li><a href="../184240/index.html">‚ÄúNotes of the grumpy‚Äù - thoughts about exhumation, ‚Äúbrand revival‚Äù, and making money on nostalgia in relation to the gaming industry</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>