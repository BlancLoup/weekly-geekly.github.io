<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>How-To: Substitute asynchronous HTML / JS code using JS</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="The main task of the ad network management system is to insert the code of these networks into the code of end-user sites. In general, such systems ca...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>How-To: Substitute asynchronous HTML / JS code using JS</h1><div class="post__text post__text-html js-mediator-article"> <a href="http://habrahabr.ru/company/advertone_ru/blog/219713/"><img src="https://habrastorage.org/getpro/habr/post_images/a1c/71e/b4f/a1c71eb4f93d99d2cf1e6f5df50d86e6.jpg" alt="image"></a> <br><br>  The main task <a href="http://www.advertone.ru/">of the</a> ad network <a href="http://www.advertone.ru/">management system</a> is to insert the code of these networks into the code of end-user sites.  In general, such systems can be used to solve a wide range of tasks - from A / B-testing the effectiveness of ads of various formats, to placing several types of advertising materials on several platforms in parallel or adding additional effects (mainly animation) to them.  Everything is needed to simplify the management of advertising on sites and debug the analytics process, which ultimately results in an increase in revenue from online advertising when selling traffic. <br><br>  At the same time, in the general case, it is practically impossible to describe which code belongs specifically to the advertising system, and which does not, therefore, in today's topic we will consider a more general task - introducing arbitrary HTML / JS code into the site code of the end user. <a name="habracut"></a>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h4>  Task </h4><br>  Suppose that we have a view container and we need to implement loading into it code that is received from the server and contains HTML markup and JS scripts (can be either asynchronous or synchronous). <br><br>  The task is to ensure the efficiency of the solution obtained for n similar containers that simultaneously exist on the same page. <br><br>  Let's explain by example: <br><br><pre><code class="javascript hljs"> : <span class="xml"><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">script</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">id</span></span></span></span><span class="xml"><span class="hljs-tag">=</span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">1</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml"><span class="xml"><span class="xml"> document.write("</span></span><span class="hljs-tag"><span class="xml"><span class="xml"><span class="hljs-tag">&lt;</span></span></span><span class="hljs-name"><span class="xml"><span class="xml"><span class="hljs-tag"><span class="hljs-name">"</span></span></span></span></span><span class="xml"><span class="xml"><span class="hljs-tag"> + "</span></span></span><span class="hljs-attr"><span class="xml"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">script</span></span></span></span></span><span class="xml"><span class="xml"><span class="hljs-tag"> </span></span></span><span class="hljs-attr"><span class="xml"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">id</span></span></span></span></span><span class="xml"><span class="xml"><span class="hljs-tag">=</span></span></span><span class="hljs-string"><span class="xml"><span class="xml"><span class="hljs-tag"><span class="hljs-string">2</span></span></span></span></span><span class="xml"><span class="xml"><span class="hljs-tag">&gt;</span></span></span></span><span class="xml"><span class="xml">" + "document.write(\"</span></span><span class="hljs-tag"><span class="xml"><span class="xml"><span class="hljs-tag">&lt;</span></span></span><span class="hljs-name"><span class="xml"><span class="xml"><span class="hljs-tag"><span class="hljs-name">\"</span></span></span></span></span><span class="xml"><span class="xml"><span class="hljs-tag"> + \"</span></span></span><span class="hljs-attr"><span class="xml"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">div</span></span></span></span></span><span class="xml"><span class="xml"><span class="hljs-tag">&gt;</span></span></span></span><span class="xml"><span class="xml">someresult1</span></span><span class="hljs-tag"><span class="xml"><span class="xml"><span class="hljs-tag">&lt;</span></span></span><span class="hljs-name"><span class="xml"><span class="xml"><span class="hljs-tag"><span class="hljs-name">\"</span></span></span></span></span><span class="xml"><span class="xml"><span class="hljs-tag"> + \"/</span></span></span><span class="hljs-attr"><span class="xml"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">div</span></span></span></span></span><span class="xml"><span class="xml"><span class="hljs-tag">&gt;</span></span></span></span></span></span>\<span class="hljs-string"><span class="hljs-string">");"</span></span> + <span class="hljs-string"><span class="hljs-string">"document.write(\"&lt;\" + \"div&gt;someresult2&lt;\" + \"/div&gt;\");"</span></span> + <span class="hljs-string"><span class="hljs-string">"&lt;"</span></span> + <span class="hljs-string"><span class="hljs-string">"/script&gt;"</span></span>); <span class="hljs-built_in"><span class="hljs-built_in">document</span></span>.write(<span class="hljs-string"><span class="hljs-string">"&lt;"</span></span> + <span class="hljs-string"><span class="hljs-string">"script id=3 src='somescript1.js'&gt;"</span></span> + <span class="hljs-string"><span class="hljs-string">"&lt;"</span></span> + <span class="hljs-string"><span class="hljs-string">"/script&gt;"</span></span>); <span class="hljs-built_in"><span class="hljs-built_in">document</span></span>.write(<span class="hljs-string"><span class="hljs-string">"&lt;"</span></span> + <span class="hljs-string"><span class="hljs-string">"script id=4 src='somescript1.js'&gt;"</span></span> + <span class="hljs-string"><span class="hljs-string">"&lt;"</span></span> + <span class="hljs-string"><span class="hljs-string">"/script&gt;"</span></span>); <span class="hljs-built_in"><span class="hljs-built_in">document</span></span>.write(<span class="hljs-string"><span class="hljs-string">"&lt;"</span></span> + <span class="hljs-string"><span class="hljs-string">"script id=5&gt;"</span></span> + <span class="hljs-string"><span class="hljs-string">"document.write(\"&lt;\" + \"div&gt;someresult3&lt;\" + \"/div&gt;\");"</span></span> + <span class="hljs-string"><span class="hljs-string">"document.write(\"&lt;\" + \"div&gt;someresult4&lt;\" + \"/div&gt;\");"</span></span> + <span class="hljs-string"><span class="hljs-string">"&lt;"</span></span> + <span class="hljs-string"><span class="hljs-string">"/script&gt;"</span></span>); <span class="xml"><span class="undefined"></span><span class="hljs-tag"><span class="xml"><span class="undefined"></span><span class="hljs-tag">&lt;/</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">script</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span></span> somescript1.js: <span class="hljs-built_in"><span class="hljs-built_in">document</span></span>.write(<span class="hljs-string"><span class="hljs-string">"&lt;"</span></span> + <span class="hljs-string"><span class="hljs-string">"div&gt;someresult1.1&lt;"</span></span> + <span class="hljs-string"><span class="hljs-string">"/div&gt;"</span></span>); <span class="hljs-built_in"><span class="hljs-built_in">document</span></span>.write(<span class="hljs-string"><span class="hljs-string">"&lt;"</span></span> + <span class="hljs-string"><span class="hljs-string">"script class='loaded' src='somescript2.js'&gt;"</span></span> + <span class="hljs-string"><span class="hljs-string">"document.write(\"&lt;\" + \"div&gt;someresult1.2&lt;\" + \"/div&gt;\")"</span></span> + <span class="hljs-string"><span class="hljs-string">"&lt;"</span></span> + <span class="hljs-string"><span class="hljs-string">"/script&gt;"</span></span>); somescript2.js: <span class="hljs-built_in"><span class="hljs-built_in">document</span></span>.write(<span class="hljs-string"><span class="hljs-string">"&lt;"</span></span> + <span class="hljs-string"><span class="hljs-string">"div&gt;someresult2.1&lt;"</span></span> + <span class="hljs-string"><span class="hljs-string">"/div&gt;"</span></span>);</code> </pre> <br>  In this case, the scripts <code>somescript1.js</code> and <code>somescript2.js</code> are examples of scripts of the first and second level of nesting, respectively.  In addition, <code>somescript1.js</code> models the behavior of the system if there is also any code in the body of the loaded script. <br><br>  The system that should be developed should load the following code into the container: <br><br><pre> <code class="javascript hljs">&lt;script id=<span class="hljs-string"><span class="hljs-string">"1"</span></span>&gt; <span class="hljs-built_in"><span class="hljs-built_in">document</span></span>.write(<span class="hljs-string"><span class="hljs-string">"&lt;"</span></span> + <span class="hljs-string"><span class="hljs-string">"script id=2&gt;"</span></span> + <span class="hljs-string"><span class="hljs-string">"document.write(\"&lt;\" + \"div&gt;someresult1&lt;\" + \"/div&gt;\");"</span></span> + <span class="hljs-string"><span class="hljs-string">"document.write(\"&lt;\" + \"div&gt;someresult2&lt;\" + \"/div&gt;\");"</span></span> + <span class="hljs-string"><span class="hljs-string">"&lt;"</span></span> + <span class="hljs-string"><span class="hljs-string">"/script&gt;"</span></span>); <span class="hljs-built_in"><span class="hljs-built_in">document</span></span>.write(<span class="hljs-string"><span class="hljs-string">"&lt;"</span></span> + <span class="hljs-string"><span class="hljs-string">"script id=3 src='somescript1.js'&gt;"</span></span> + <span class="hljs-string"><span class="hljs-string">"&lt;"</span></span> + <span class="hljs-string"><span class="hljs-string">"/script&gt;"</span></span>); <span class="hljs-built_in"><span class="hljs-built_in">document</span></span>.write(<span class="hljs-string"><span class="hljs-string">"&lt;"</span></span> + <span class="hljs-string"><span class="hljs-string">"script id=4 src='somescript1.js'&gt;"</span></span> + <span class="hljs-string"><span class="hljs-string">"&lt;"</span></span> + <span class="hljs-string"><span class="hljs-string">"/script&gt;"</span></span>); <span class="hljs-built_in"><span class="hljs-built_in">document</span></span>.write(<span class="hljs-string"><span class="hljs-string">"&lt;"</span></span> + <span class="hljs-string"><span class="hljs-string">"script id=5&gt;"</span></span> + <span class="hljs-string"><span class="hljs-string">"document.write(\"&lt;\" + \"div&gt;someresult3&lt;\" + \"/div&gt;\");"</span></span> + <span class="hljs-string"><span class="hljs-string">"document.write(\"&lt;\" + \"div&gt;someresult4&lt;\" + \"/div&gt;\");"</span></span> + <span class="hljs-string"><span class="hljs-string">"&lt;"</span></span> + <span class="hljs-string"><span class="hljs-string">"/script&gt;"</span></span>); <span class="xml"><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;/</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">script</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span></span> &lt;script id=<span class="hljs-string"><span class="hljs-string">"2"</span></span>&gt; <span class="hljs-built_in"><span class="hljs-built_in">document</span></span>.write(<span class="hljs-string"><span class="hljs-string">"&lt;"</span></span> + <span class="hljs-string"><span class="hljs-string">"div&gt;someresult1&lt;"</span></span> + <span class="hljs-string"><span class="hljs-string">"/div&gt;"</span></span>); <span class="hljs-built_in"><span class="hljs-built_in">document</span></span>.write(<span class="hljs-string"><span class="hljs-string">"&lt;"</span></span> + <span class="hljs-string"><span class="hljs-string">"div&gt;someresult2&lt;"</span></span> + <span class="hljs-string"><span class="hljs-string">"/div&gt;"</span></span>); <span class="xml"><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;/</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">script</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span></span> &lt;div&gt;someresult1&lt;<span class="hljs-regexp"><span class="hljs-regexp">/div&gt; &lt;div&gt;someresult2&lt;/</span></span>div&gt; <span class="xml"><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">script</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">id</span></span></span></span><span class="xml"><span class="hljs-tag">=</span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">"3"</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">src</span></span></span></span><span class="xml"><span class="hljs-tag">=</span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">"somescript1.js"</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="undefined"></span><span class="hljs-tag"><span class="xml"><span class="undefined"></span><span class="hljs-tag">&lt;/</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">script</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span></span> &lt;div&gt;someresult1<span class="hljs-number"><span class="hljs-number">.1</span></span>&lt;<span class="hljs-regexp"><span class="hljs-regexp">/div&gt; &lt;script class="loaded" src="somescript2.js"&gt; document.write("&lt;" + "div&gt;someresult1.2&lt;" + "/</span></span>div&gt;<span class="hljs-string"><span class="hljs-string">") &lt;/script&gt; &lt;div&gt;someresult2.1&lt;/div&gt; &lt;script id="</span></span><span class="hljs-number"><span class="hljs-number">4</span></span><span class="hljs-string"><span class="hljs-string">" src="</span></span>somescript1.js<span class="hljs-string"><span class="hljs-string">"&gt;&lt;/script&gt; &lt;div&gt;someresult1.1&lt;/div&gt; &lt;script class="</span></span>loaded<span class="hljs-string"><span class="hljs-string">" src="</span></span>somescript2.js<span class="hljs-string"><span class="hljs-string">"&gt; document.write("</span></span>&lt;<span class="hljs-string"><span class="hljs-string">" + "</span></span>div&gt;someresult1<span class="hljs-number"><span class="hljs-number">.2</span></span>&lt;<span class="hljs-string"><span class="hljs-string">" + "</span></span>/div&gt;<span class="hljs-string"><span class="hljs-string">") &lt;/script&gt; &lt;div&gt;someresult2.1&lt;/div&gt; &lt;script id="</span></span><span class="hljs-number"><span class="hljs-number">5</span></span><span class="hljs-string"><span class="hljs-string">"&gt; document.write("</span></span>&lt;<span class="hljs-string"><span class="hljs-string">" + "</span></span>div&gt;someresult3&lt;<span class="hljs-string"><span class="hljs-string">" + "</span></span>/div&gt;<span class="hljs-string"><span class="hljs-string">"); document.write("</span></span>&lt;<span class="hljs-string"><span class="hljs-string">" + "</span></span>div&gt;someresult4&lt;<span class="hljs-string"><span class="hljs-string">" + "</span></span>/div&gt;<span class="hljs-string"><span class="hljs-string">"); &lt;/script&gt; &lt;div&gt;someresult3&lt;/div&gt; &lt;div&gt;someresult4&lt;/div&gt;</span></span></code> </pre><br><h4>  Decision </h4><br>  To simplify further explanations, we introduce additional terminology: <br><br><ul><li>  <b>Anonymous script</b> ‚Äî JS script, with or without an empty ‚Äúsrc‚Äù attribute. </li><li>  <b>The download script</b> is a JS script that is loaded from a third-party server and, therefore, has a non-empty attribute ‚Äúsrc‚Äù. </li><li>  <b>Output pointer</b> - indicates the element after which the content generated using <code>document.write</code> should be inserted. </li></ul><br>  Inserting HTML code does not cause any problems, but when inserting JS scripts, a number of pitfalls are found: <br><br><ul><li>  Synchronous scripts may contain document.write, which does not work in asynchronous mode. </li><li>  Scripts can be downloadable, which makes it impossible for us to analyze their text. </li><li>  Downloadable scripts refer only to global objects; accordingly, any settings of the surrounding space can only be global. </li><li>  Scripts can spawn other scripts.  In this case, synchronous scripts can generate other synchronous scripts that retain the ability to use <code>document.write</code> . </li></ul><br>  A rather obvious way out of this is to replace global <code>document.write</code> with a custom function that could work in a similar way. <br><br><pre> <code class="javascript hljs"><span class="hljs-built_in"><span class="hljs-built_in">document</span></span>.write = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">html</span></span></span><span class="hljs-function">)</span></span>{ ‚Ä¶ };</code> </pre><br>  Here, in general, everything is clear, except for one thing: where exactly should our function insert the code that is the result of its work? <br><br>  JavaScript is single-threaded, which means that for anonymous synchronous scripts, the following solution is suggested: when you receive a response from the server, set the global attribute (input pointer) for the container that will be used by the replacement function.  If all scripts are synchronous and anonymous, then they should be substituted in turn, which, if the output pointer is correctly shifted, results in a correct result. <br><br>  As a result, the entire processing cycle of the substituted code is implemented without breaks in the execution flow and does not cause questions. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/e4c/e20/b05/e4ce20b0542dd35f15f648b7907cbad2.jpg" alt="image"><br><br><h4>  Houston, we have problems </h4><br>  Everything is not so easy and simple in the case when we meet the downloadable script.  In such a situation, it seems logical to stop the execution of all other scenarios until the moment of loading and finally executing the current loadable script.  This scheme is guaranteed to work thanks to the onload event, but the speed of this solution is rather small, so you need to find a better way. <br><br>  And there is such a solution, though it works only for browsers of the Interner Explorer family - this is the <code>onreadystatechange</code> event that allows you to create a wrapper for the loading script as a handler that moves the output pointer of our changed document.write to the location of the script before it starts and - if necessary - will restore the original output pointer after the completion of the script.  Unfortunately, it will not be possible to go this way if we deal with any browser other than IE, since nowhere, except for the Microsoft brainchild, there is no support for events that occur after the script is loaded, but before it is executed. <br><br>  Only one way remains - to make so that our function substituting <code>document.write</code> , could define itself, from what script it is called.  And in most modern browsers (IE11, Firefox, Chrome, latest versions of Opera) for downloadable scripts this is possible, albeit with some reservations.  Due to the fact that such scripts are executed in the global namespace, it is impossible to create a copy of the function for each loaded script.  It would seem that this means that you can determine where to insert the result of <code>document.write</code> work only on the basis of the input parameters - the string. <br><br>  This is so only at first glance.  In fact, in all the browsers mentioned above, it is possible to get to the address from which the script that called our replaced <code>document.write</code> was loaded.  This is done through the stack, from which you can get the desired address, and already at this address install the desired script. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/1f9/2cd/883/1f92cd883f46f98ab069e1ce36f4e6aa.jpg" alt="image"><br><br><h4>  Another difficulty </h4><br>  It seems that everything is fine - we have found an excellent solution to the problem, but again difficulties arise.  First of all, in the event that we have several identical scripts, then it is necessary to somehow ensure their sequential execution in a previously known order.  The second point is that if the script contains several document.write calls, then you still need to somehow guarantee the correctness of the results of each of them, because in the standard case, each function will write data right after its own script, and not after the last element created previous <code>document.write</code> from script. <br><br>  It turns out that, among other things, after the function is triggered, you must also add a link to the last element created from this script. <br><br><h4>  Final stage </h4><br>  There is one more possible variant of the development of events - the presence of anonymous and downloadable scripts in one piece of code.  Since under normal conditions, without any substitutions, <code>document.write</code> can be used only in a synchronous stream, in order for the executable code to produce the same result as for a regular sequential execution, we need to ensure that all the scripts are loaded and triggered in turn. <br><br>  For anonymous scripts, this obviously turns out by itself, and for loaded scripts, you will have to interrupt the flow of our <code>document.write</code> substitution at the moment of loading wait and restore it with the onload event. <br><br>  Consider an example from the beginning of the topic to get an understanding of the sequence of actions. <br><br>  As a means of inserting the code, it is logical to use your own substitute <code>document.write</code> , since by this point you already know where to insert the results.  Thus, we obtain the following order of execution: <br><br><ol><li>  The inserted script calls document.write to create a script 2 that will create the first two test divs. </li><li>  Script 2 calls document.write to create someresult1 and someresult2. </li><li>  Script 2 execution ends, control is returned to the original document.write.  At the same time, due to the fact that the substitution is global, the output pointer looks at the created someresult2.  Thus script 1 continues to create elements.  Now script 3 is created and, since it is loaded, the execution of document.write is interrupted until the onload of script 3 is triggered. Previously document.write checks all other scripts for the presence of the same loading path and marks them. </li><li>  Script 3 is loaded, it calls document.write, from which one of the methods we described (depending on the browser) detects the document.write output pointer.  In IE, the output pointer is substituted when the code is loaded before it is executed;  in modern browsers - using the stack directly at the time of calling document.write;  for others, knowledge of the point of exit is ensured by the predictability of the execution order of the scripts (blocking).  Document.write inserts someresult1.1 and marks script 3 for an output pointer. </li><li>  Script 3 calls document.write, which defines the script that called it and, following the mark made by the previous call, shifts the output pointer, then creates the loaded script and someresult1.2.  Execution is interrupted before loading and triggering the loaded script. </li><li>  The loaded script is loaded and calls document.write, which defines an output pointer and creates someresult2.1. </li><li>  The onload script of the loaded script fires, returning control to the processing code of the document.write script 3, which, in turn, terminates and triggers the onload event of script 3, which returns control to script 1. </li><li>  Script 1 creates script 4, due to the global nature of document.write, at the moment of returning control, the output pointer gets better, taking into account the operations performed by the document.write function.  Thus, script 4 appears at the end of an already created piece of code.  Execution of document.write is interrupted with a preliminary indication that the script 3 that has not yet been created is being executed. </li><li>  For script 4, the entire procedure is repeated, as already described for script 3 (paragraphs 4‚Äì8). </li><li>  Control is returned to script 1, which creates script 5. </li><li>  Script 5 calls document.write to create someresult3 and someresult4. </li><li>  Control is returned to script 1. </li><li>  Script 1 is completed. </li></ol><br>  With a quick glance from the side, it seems that there is nothing difficult in the described sequence, but remember that the execution thread was interrupted 6 times: <br><br><ul><li>  On the download of scripts 3 and 4 (obviously, instant, but formally, this is also a gap, and something can break into it). </li><li>  Inside the scripts 3 and 4 (although in the example there is no gap between them, it may well be, because this is a downloadable script, the structure of which is generally unknown). </li><li>  Two loaded script loads, and the second, although formal, leaves a gap in execution. </li></ul><br>  And the main trick is precisely that at every moment when calling document.write, the correct output pointer is used. <br><br><h4>  Conclusion </h4><br>  Now consider the final add-in, designed for the simultaneous insertion of <code>n</code> codes.  In principle, the considered algorithm has no obvious contraindications to multithreading - one should only make a reservation that the structures that store scripts chains and current output pointers for various containers should be their own.  So, we substitute <code>document.write</code> is not just a function, but a dispatcher, which prepares the context and only after that it will call our analogue <code>document.write</code> . <br><br>  Accordingly, the choice can be offered two implementation schemes: either our analog <code>document.write</code> should be an object, and we use a dispatcher that controls <code>n</code> instances of such objects, or we store an array of <code>n</code> contexts, and our dispatcher simply sets a pointer to the current context for this analogue of <code>document.write</code> . <br><br>  Thus, if we assume that there are two containers into which we are trying to install the example code, the order of execution will be almost the same - except that the second container will wedge in at the points of discontinuity, causing a change of context or work object.  For example, after step 3 for the first container, steps 1 and 2 of the second container will follow.  In step 3, the algorithm should detect that the script with exactly the same src is already being loaded, and abort, waiting for its execution.  The first container is executed up to step 5 inclusive, after which it returns control to the waiting second container, which continues to be executed from step 3. <br><br>  Subsequently, either the first or the second container continues execution to the next break point (depending on which of them finishes the execution earlier).  Further sequence has already been reviewed and does not carry anything new. <br><br>  That's all for today!  Thank you all for your attention, we will be happy to answer questions in the comments. </div><p>Source: <a href="https://habr.com/ru/post/219713/">https://habr.com/ru/post/219713/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../219699/index.html">Corridor testing: we get fast feedback on layouts</a></li>
<li><a href="../219705/index.html">The first book about 3D printing in Russian, ‚ÄúAffordable 3D printing for science, education and sustainable development‚Äù (Low-cost 3D Printing for Science, Education and Sustainable Development) is ready!</a></li>
<li><a href="../219707/index.html">More than three are not going to: Blogging will need to register</a></li>
<li><a href="../219709/index.html">What is a venture and how it works</a></li>
<li><a href="../219711/index.html">Google introduced the new application "Camera"</a></li>
<li><a href="../219715/index.html">Durov sold the share of VK due to friction with the FSB</a></li>
<li><a href="../219717/index.html">Artificial blood will be made in plants.</a></li>
<li><a href="../219721/index.html">Bayes</a></li>
<li><a href="../219723/index.html">We drive beskollektorny engines, gentlemen</a></li>
<li><a href="../219729/index.html">Introduced the first prototype of a modular smartphone from Google.</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>