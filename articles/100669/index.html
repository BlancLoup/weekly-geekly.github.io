<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>WebSocket & ASP.NET</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="In this topic, I want to tell you how to organize a WebSocket connection between a browser that supports WebSocket and an ASP.NET application. 
 The a...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>WebSocket & ASP.NET</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/storage/habraeffect/a9/f2/a9f2393931e3949bd08d650c2161441d.png" align="left" alt="html5">  In this topic, I want to tell you how to organize a WebSocket connection between a browser that supports WebSocket and an ASP.NET application. <br>  The article describes how to make a connection and send a message to a connected client.  Also, at the end of the article, there is a link to the source code of the working application. <br><br>  The article and the application are just an example of how this all works, and how ASP.NET and WebSockets can be linked, and are unlikely to claim implementation guidance in their current form, but it demonstrates well the basics and can be improved. <br><a name="habracut"></a><br><br>  Why do we need WebSockets and what are their advantages, I think I don‚Äôt need to tell.  Personally, I think that they are very lacking in order to make full-fledged client-side applications in JavaScript without <a href="http://ru.wikipedia.org/wiki/Comet_%2528%25D0%25BF%25D1%2580%25D0%25BE%25D0%25B3%25D1%2580%25D0%25B0%25D0%25BC%25D0%25BC%25D0%25B8%25D1%2580%25D0%25BE%25D0%25B2%25D0%25B0%25D0%25BD%25D0%25B8%25D0%25B5%2529">Comet</a> tricks (excellent article <a href="http://habrahabr.ru/blogs/net/82015/">here</a> ) or periodic requests. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      But specifically, this technology seriously interested me when looking for a solution to a small ‚Äúproblem‚Äù of working with Comet in the Chrome browser. <br><br>  When organizing using Comet technology, some browsers, such as Chrome, behave in such a way that it seems as though the page is constantly loading, the same Chrome writes ‚Äúwaiting for a request‚Äù and the cursor always remains in a waiting state. <br><img src="https://habrastorage.org/storage/habraeffect/6b/bc/6bbc14431ad2a82a2fc8ec724d84049d.png" alt="Chrome Cursor with Comet"><br><br>  This is of course unpleasant. <br>  And simply, why use a workaround when there is a more suitable technology for this and an opportunity to study it. <br><br>  So the connection itself.  On the client side (JavaScript), the browser provides a special WebSocket class. <br>  Here is a description of it <a href="http://dev.w3.org/html5/websockets/">from here.</a> <br><img src="https://habrastorage.org/storage/habraeffect/24/fe/24fe759dc9596a6e708c4fa56476b0bb.png" alt="image"><br><br>  Using it, we open a connection to the server and subscribe to the necessary events, as well as send messages to the server after the connection. <br><br><blockquote><code><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="black"><font color="#0000ff">var</font> sock; <br> <font color="#0000ff">function</font> connectToServer() { <br> <font color="#0000ff">try</font> { <br> sock = <font color="#0000ff">new</font> WebSocket( <font color="#A31515">"ws://localhost:8181/websock"</font> ); <br> sock.onopen = sockOpen; <br> sock.onerror = sockError; <br> sock.onclose = sockClosed; <br> sock.onmessage = sockMessage; <br> } <font color="#0000ff">catch</font> (e) { <br> log( <font color="#A31515">"error:"</font> + e); <br> } <br> }</font> <br> <br> <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></code> </blockquote> <br><br>  As can be seen from the code above, our server will wait for connections at localhost: 8181. <br>  In this example, all functions subscribers simply display information in a text field, and we do not send anything to the server.  After connecting, it is quite simple to do this, but in this example it will only complicate things a little. <br><br>  So server.  Since the ASP.NET application / website only works when processing requests, and we need to constantly wait for connections, we need to start a separate thread.  Let's do this in Global.asax.  The stream and server will be dealt with by our special classic. <br><blockquote> <code><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="black"><font color="#0000ff">void</font> Application_Start( <font color="#0000ff">object</font> sender, <font color="#2B91AF">EventArgs</font> e) <br> { <br> WebSocks.WebSockServer.Start(); <br> } <br> <br> <font color="#0000ff">void</font> Application_End( <font color="#0000ff">object</font> sender, <font color="#2B91AF">EventArgs</font> e) <br> { <br> WebSocks.WebSockServer.End(); <br> }</font> <br> <br> <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></code> </blockquote> <br><br>  In the Start function, we simply start the Thread, which will wait for the connection, and in the End we clean up after ourselves.  All this can be viewed in more detail in the source code, which I will give at the end of the article. <br><br>  So, then the code of the main function itself, but first I will briefly tell you what will happen, what would be easier to navigate. <br><ul><li>  New customer will join (for the time being we serve one by one) </li><li>  We are taking client handshake </li><li>  We send our Handshake.  After that, the connection can be considered established. </li><li>  We send the line Hello World! Where do without it :) </li></ul>  Here is the code itself. <br><blockquote> <code><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="black"><font color="#0000ff">public</font> <font color="#0000ff">static</font> <font color="#0000ff">void</font> Listen()&lt;br&gt;    {&lt;br&gt; <font color="#008000">// </font> &lt;br&gt;      Listener = <font color="#0000ff">new</font> TcpListener(IPAddress.Loopback, PortNumber);&lt;br&gt;      Listener.Start();&lt;br&gt;&lt;br&gt; <font color="#0000ff">while</font> ( <font color="#0000ff">true</font> )&lt;br&gt;      {&lt;br&gt; <font color="#008000">// </font> &lt;br&gt; <font color="#0000ff">using</font> (Socket client = Listener.AcceptSocket())       &lt;br&gt; <font color="#0000ff">using</font> (NetworkStream stream = <font color="#0000ff">new</font> NetworkStream(client))  &lt;br&gt; <font color="#0000ff">using</font> (StreamReader reader = <font color="#0000ff">new</font> StreamReader(stream))   &lt;br&gt; <font color="#0000ff">using</font> (StreamWriter writer = <font color="#0000ff">new</font> StreamWriter(stream))   &lt;br&gt;        {&lt;br&gt;&lt;br&gt; <font color="#0000ff">string</font> clientHandshake = <font color="#2B91AF">String</font> .Empty; &lt;br&gt; <font color="#0000ff">string</font> currentRead = <font color="#0000ff">null</font> ;       &lt;br&gt; <font color="#0000ff">string</font> clientOrigin = <font color="#A31515">""</font> ;        &lt;br&gt;&lt;br&gt; <font color="#0000ff">while</font> (currentRead != <font color="#A31515">""</font> )&lt;br&gt;          {&lt;br&gt; <font color="#008000">//  handshake  </font> &lt;br&gt;            currentRead = reader.ReadLine();&lt;br&gt;            clientHandshake += currentRead + Environment.NewLine;&lt;br&gt;&lt;br&gt; <font color="#008000">//       </font> &lt;br&gt; <font color="#0000ff">if</font> (currentRead.StartsWith( <font color="#A31515">"Origin"</font> ))&lt;br&gt;            {&lt;br&gt; <font color="#008000">//  </font> &lt;br&gt; <font color="#0000ff">int</font> valueStartIndex = currentRead.IndexOf( <font color="#A31515">':'</font> ) + 1;&lt;br&gt;              clientOrigin = currentRead.Substring(valueStartIndex, currentRead.Length - valueStartIndex);&lt;br&gt;            }&lt;br&gt;          }&lt;br&gt;&lt;br&gt; <font color="#008000">//       (Handshake)</font> &lt;br&gt;          writer.WriteLine( <font color="#A31515">"HTTP/1.1 101 Web Socket Protocol Handshake"</font> );&lt;br&gt;          writer.WriteLine( <font color="#A31515">"Upgrade: WebSocket"</font> );&lt;br&gt;          writer.WriteLine( <font color="#A31515">"Connection: Upgrade"</font> );&lt;br&gt;&lt;br&gt; <font color="#008000">//     Origin    .</font> &lt;br&gt; <font color="#008000">//  " ",  ,  </font> &lt;br&gt; <font color="#008000">//  ,     .</font> &lt;br&gt;          writer.WriteLine( <font color="#2B91AF">String</font> .Format( <font color="#A31515">"WebSocket-Origin: {0}"</font> , clientOrigin));&lt;br&gt;          writer.WriteLine( <font color="#A31515">"WebSocket-Location: ws://localhost:8181/websock"</font> );&lt;br&gt;          writer.WriteLine( <font color="#A31515">""</font> );&lt;br&gt;          writer.Flush();&lt;br&gt;&lt;br&gt; <font color="#008000">// /  .</font> &lt;br&gt;          Thread.Sleep(100);&lt;br&gt;          &lt;br&gt; <font color="#008000">//      </font> &lt;br&gt; <font color="#0000ff">byte</font> [] first = <font color="#0000ff">new</font> <font color="#0000ff">byte</font> [] { 0x00 };&lt;br&gt; <font color="#0000ff">byte</font> [] last = <font color="#0000ff">new</font> <font color="#0000ff">byte</font> [] { 0xFF };&lt;br&gt;          &lt;br&gt; <font color="#008000">//   ( )</font> &lt;br&gt;          client.Send(first);&lt;br&gt;&lt;br&gt; <font color="#008000">//     Hello World</font> &lt;br&gt;          client.Send( <font color="#2B91AF">Encoding</font> .UTF8.GetBytes( <font color="#A31515">"Hello world!"</font> ));&lt;br&gt;&lt;br&gt; <font color="#008000">//   ( )</font> &lt;br&gt;          client.Send(last);&lt;br&gt;        }&lt;br&gt;      }&lt;br&gt;    }</font> &lt;br&gt;&lt;br&gt; <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></code> </blockquote> <br><br>  And here are the promised sources. <br>  <a href="">dl.dropbox.com/u/3945288/WebSocketsArticle.zip</a> <br><br>  This is the simplest example, it has flaws, such as the lack of multithreading in processing clients.  And also, it still has to be improved, for example, to provide access to a user session. <br><br>  I would be glad if the article is liked and helps someone, I will try to develop the topic and write more. <br><br>  <b>UPD: In the comments, we noticed that the implementation for the previous edition is 75, the current 76, in which security was added.</b>  <b>I will try to make a version that will work with both editions, but apparently, not anymore today.</b> <b><br></b>  <b>For those who asked to share the groundwork, I poured everything <a href="http://wsaspnet.codeplex.com/">here</a> .</b>  <b>In theory, everything should work but does not work :), where it is a joint but the brain does not notice it anymore.</b> <br><br>  <b>UPD2: As promised, <a href="">here is a</a> version that supports both versions 75 and 76.</b> </div><p>Source: <a href="https://habr.com/ru/post/100669/">https://habr.com/ru/post/100669/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../100661/index.html">How to make legal homebrew at the moment</a></li>
<li><a href="../100663/index.html">Microsoft is going to oppose the deal Yahoo! and google</a></li>
<li><a href="../100664/index.html">Metaplugin for GIMP'a G'MIC</a></li>
<li><a href="../100666/index.html">Solar sailboat successfully passes the test in space</a></li>
<li><a href="../100668/index.html">Data Support: Internet Explorer URL</a></li>
<li><a href="../100671/index.html">Chicken appeared before eggs</a></li>
<li><a href="../100673/index.html">The number of tweets exceeded the 20 billion bar</a></li>
<li><a href="../100674/index.html">A language for describing grammars. Lada language subset</a></li>
<li><a href="../100675/index.html">Basic concepts adopted in the Lada language</a></li>
<li><a href="../100676/index.html">Mirc 7.1 released</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>