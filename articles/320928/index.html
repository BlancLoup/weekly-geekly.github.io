<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Pure Python Architecture: A Walkthrough. Part 5</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Content 

- Part 1 
- Part 2 
- Part 3 
- Part 4 
- Part 5 

 REST layer (part 1) 


 Git tag: Step12 



 The final stage of our adventure has come i...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Pure Python Architecture: A Walkthrough. Part 5</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/files/cdc/20d/22d/cdc20d22dcfa407ca7961b270d93cf78.png"><br><div class="spoiler">  <b class="spoiler_title">Content</b> <div class="spoiler_text"><ul><li>  <a href="https://habrahabr.ru/post/319126/">Part 1</a> </li><li>  <a href="https://habrahabr.ru/post/319202/">Part 2</a> </li><li>  <a href="https://habrahabr.ru/post/319898/">Part 3</a> </li><li>  <a href="https://habrahabr.ru/post/320662/">Part 4</a> </li><li>  <em>Part 5</em> </li></ul><br></div></div><br><h3>  REST layer (part 1) </h3><br><p>  <b>Git tag:</b> <a href="http://github.com/lgiordani/rentomatic/tree/step12">Step12</a> <br></p><br><p>  The final stage of our adventure has come in search of pure architecture.  We created domain models, serializers, scripts, and storage.  But while there is no interface that sticks together all together: it receives call parameters from the user, initializes the script with the repository, executes the script, which gets the domain models from the repository, and converts them into a standard format.  This layer can be represented using a variety of interfaces and technologies.  For example, using the command line interface (CLI): retrieve parameters using command line keys and return the result as text on the console.  But the same basic system can also be used for a web page that receives call parameters from a set of widgets, performs the steps described above, and parses the returned data in JSON format to display the result on the same page. <br></p><br><p>  Regardless of the technology chosen, to interact with the user, collect input data and provide output results, we need to interact with the newly created pure architecture.  Therefore, now we will create a layer to bring out the API for working with HTTP.  This will be implemented with the help of a server that provides a set of HTTP addresses (API endpoints), when accessing which some data is returned.  This layer is usually called the REST layer, because, as a rule, the semantics of addresses is similar to the REST recommendations. </p><a name="habracut"></a><br><p>  Flask is a lightweight web server with a modular structure that provides only the parts needed by the user.  In particular, we will not use any database / ORM, since we already have our own implemented storage layer. <br><br>  I note that usually this layer together with the storage layer is implemented as a separate package, but in the framework of this lesson I placed them together. <br></p><br><p> Update the dependency file.  The <code><font color="#900">prod.txt</font></code> file must contain the Flask module. <br></p><br><pre> <code class="python hljs">Flask</code> </pre><br><p>  The <code><font color="#900">dev.txt</font></code> file contains the <a href="https://flask-script.readthedocs.io/en/latest/">Flask-Script</a> extension. </p><br><pre> <code class="python hljs">-r test.txt pip wheel flake8 Sphinx Flask-Script</code> </pre><br><p>  And in the <code><font color="#900">test.txt</font></code> file we <code><font color="#900">test.txt</font></code> add the pytest extension to work with Flask (more on this later) </p><br><pre> <code class="python hljs">-r prod.txt pytest tox coverage pytest-cov pytest-flask</code> </pre><br><p>  After these changes, be sure to run <code><font color="#900">pip install -r requirenments/dev.txt</font></code> to install the new packages into the virtual environment. <br></p><br><p>  Setting up a Flask application is simple, but includes many features.  Since this is not a Flask tutorial, I‚Äôll take a quick look at these steps.  However, I will provide links to Flask documentation for each feature. </p><br><p>  I usually define individual configurations for my test, development, and production environments.  Since the Flask application can be configured using a regular Python object ( <a href="http://flask.pocoo.org/docs/0.12/api/">documentation</a> ), I create a file <code><font color="#900">rentomatic/settings.py</font></code> to accommodate these objects. </p><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> os <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Config</span></span></span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">(object)</span></span></span><span class="hljs-class">:</span></span> <span class="hljs-string"><span class="hljs-string">"""Base configuration."""</span></span> APP_DIR = os.path.abspath(os.path.dirname(__file__)) <span class="hljs-comment"><span class="hljs-comment"># This directory PROJECT_ROOT = os.path.abspath(os.path.join(APP_DIR, os.pardir)) class ProdConfig(Config): """Production configuration.""" ENV = 'prod' DEBUG = False class DevConfig(Config): """Development configuration.""" ENV = 'dev' DEBUG = True class TestConfig(Config): "" " ". "" ENV = 'test' TESTING = True DEBUG = True</span></span></code> </pre><br><p>  To learn more about Flask configuration options, see <a href="http://flask.pocoo.org/docs/0.12/config/">this page</a> .  Now we need a function that initializes the Flask application ( <a href="http://flask.pocoo.org/docs/0.12/patterns/appfactories/">documentation</a> ), sets it up and registers the drawings ( <a href="http://flask.pocoo.org/docs/0.12/blueprints/">documentation</a> ).  The <code><font color="#900">rentomatic/app.py</font></code> contains the following code: </p><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">from</span></span> flask <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> Flask <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> rentomatic.rest <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> storageroom <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> rentomatic.settings <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> DevConfig <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">create_app</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(config_object=DevConfig)</span></span></span><span class="hljs-function">:</span></span> app = Flask(__name__) app.config.from_object(config_object) app.register_blueprint(storageroom.blueprint) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> app</code> </pre><br><p>  Application endpoints should return a Flask <code><font color="#900">Response</font></code> object with current results and HTTP status.  The content of the response, in this case, is the JSON serialization of the script response. </p><br><p>  We'll start writing tests step by step so that you can understand well what will happen at the REST endpoint.  The basic structure of the test is as follows. </p><br><pre> <code class="python hljs">[SOME PREPARATION] [CALL THE API ENDPOINT] [CHECK RESPONSE DATA] [CHECK RESPONDSE STATUS CODE] [CHECK RESPONSE MIMETYPE]</code> </pre><br><p>  Therefore, our first test - <code><font color="#900">tests/rest/test_get_storagerooms_list.py</font></code> consists of the following parts </p><br><pre> <code class="python hljs"><span class="hljs-meta"><span class="hljs-meta">@mock.patch('rentomatic.use_cases.storageroom_use_cases.StorageRoomListUseCase') def test_get(mock_use_case, client): mock_use_case().execute.return_value = res.ResponseSuccess (storagerooms)</span></span></code> </pre><br><p>  Since here we are not testing the script itself, we can lock it up.  We force the script to return an instance of <code><font color="#900">ResponseSuccess</font></code> containing a list of domain models (which we have not yet defined). </p><br><br><div class="spoiler">  <b class="spoiler_title">Note</b>  <b class="spoiler_title">translator</b> <div class="spoiler_text">  Unfortunately, this code does not work for me (python 2.7).  Object StorageRoomListUseCase not mokatsya.  By virtue of my weak knowledge of the mock module, I decided this moment to direct monkey patching without using a decorator: <br><pre> <code class="python hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">test_get</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(client, monkeypatch)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">monkey_execute</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self, rqst)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> res.ResponseSuccess(storagerooms) monkeypatch.setattr(StorageRoomListUseCase, <span class="hljs-string"><span class="hljs-string">'execute'</span></span>, monkey_execute)</code> </pre><br>  If someone knows the reason why the original code does not work, please report it. <br></div></div><br><pre> <code class="python hljs"> http_response = client.get(<span class="hljs-string"><span class="hljs-string">'/storagerooms'</span></span>)</code> </pre><br><p>  This is the current API call.  We set the end point at <code><font color="#900">/storagerooms</font></code> . <code><font color="#900">/storagerooms</font></code> attention to using the <code><font color="#900">client</font></code> fixture provided by pytest-Flask. </p><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">assert</span></span> json.loads(http_response.data.decode(<span class="hljs-string"><span class="hljs-string">'UTF-8'</span></span>)) == [storageroom1_dict] <span class="hljs-keyword"><span class="hljs-keyword">assert</span></span> http_response.status_code == <span class="hljs-number"><span class="hljs-number">200</span></span> <span class="hljs-keyword"><span class="hljs-keyword">assert</span></span> http_response.mimetype == <span class="hljs-string"><span class="hljs-string">'application/json'</span></span></code> </pre><br><p>  These are the three checks mentioned above.  The second and third are fairly simple, while the first needs an explanation.  We want to compare <code><font color="#900">http_response.data</font></code> with <code><font color="#900">[storageroom1_dict]</font></code> , which is a list of Python dictionaries containing <code><font color="#900">storageroom1_domain_model</font></code> object <code><font color="#900">storageroom1_domain_model</font></code> .  Flask <code><font color="#900">Response</font></code> objects contain a binary representation of the data, so we first decode the bytes using UTF-8, and then convert them to a Python object.  It is much more convenient to compare Python objects, since pytest may have problems with dictionaries, due to the lack of order of keys.  But if you compare the lines, then there will be no such difficulties. </p><br><p>  The final test file with the test of the domain model and its dictionary: </p><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> json <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> unittest <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> mock <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> rentomatic.domain.storageroom <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> StorageRoom <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> rentomatic.shared <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> response_object <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> res storageroom1_dict = { <span class="hljs-string"><span class="hljs-string">'code'</span></span>: <span class="hljs-string"><span class="hljs-string">'3251a5bd-86be-428d-8ae9-6e51a8048c33'</span></span>, <span class="hljs-string"><span class="hljs-string">'size'</span></span>: <span class="hljs-number"><span class="hljs-number">200</span></span>, <span class="hljs-string"><span class="hljs-string">'price'</span></span>: <span class="hljs-number"><span class="hljs-number">10</span></span>, <span class="hljs-string"><span class="hljs-string">'longitude'</span></span>: <span class="hljs-number"><span class="hljs-number">-0.09998975</span></span>, <span class="hljs-string"><span class="hljs-string">'latitude'</span></span>: <span class="hljs-number"><span class="hljs-number">51.75436293</span></span> } storageroom1_domain_model = StorageRoom.from_dict(storageroom1_dict) storagerooms = [storageroom1_domain_model] @mock.patch(<span class="hljs-string"><span class="hljs-string">'rentomatic.use_cases.storageroom_use_cases.StorageRoomListUseCase'</span></span>) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">test_get</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(mock_use_case, client)</span></span></span><span class="hljs-function">:</span></span> mock_use_case().execute.return_value = res.ResponseSuccess(storagerooms) http_response = client.get(<span class="hljs-string"><span class="hljs-string">'/storagerooms'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">assert</span></span> json.loads(http_response.data.decode(<span class="hljs-string"><span class="hljs-string">'UTF-8'</span></span>)) == [storageroom1_dict] <span class="hljs-keyword"><span class="hljs-keyword">assert</span></span> http_response.status_code == <span class="hljs-number"><span class="hljs-number">200</span></span> <span class="hljs-keyword"><span class="hljs-keyword">assert</span></span> http_response.mimetype == <span class="hljs-string"><span class="hljs-string">'application/json'</span></span></code> </pre><br><p>  It's time to write the end point, where we finally see the work of all parts of the architecture. </p><br><p>  The minimum Flask endpoint can be placed at <code><font color="#900">rentomatic/rest/storageroom.py</font></code> </p><br><pre> <code class="python hljs">blueprint = Blueprint(<span class="hljs-string"><span class="hljs-string">'storageroom'</span></span>, __name__) @blueprint.route(<span class="hljs-string"><span class="hljs-string">'/storagerooms'</span></span>, methods=[<span class="hljs-string"><span class="hljs-string">'GET'</span></span>]) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">storageroom</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function">:</span></span> [LOGIC] <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> Response([JSON DATA], mimetype=<span class="hljs-string"><span class="hljs-string">'application/json'</span></span>, status=[STATUS])</code> </pre><br><p>  The first thing we create is a <code><font color="#900">StorageRoomListRequestObject</font></code> .  At this time, you can ignore the optional query string parameters and use an empty dictionary. </p><br><pre> <code class="python hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">storageroom</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function">:</span></span> request_object = ro.StorageRoomListRequestObject. from_dict ({})</code> </pre><br><p>  As you can see, I create an object from an empty dictionary, so query string parameters are not taken into account.  The second thing to do is initialize the repository. </p><br><pre> <code class="python hljs"> repo = mr.MemRepo ()</code> </pre><br><p>  The third is the initialization of the script endpoint </p><br><pre> <code class="python hljs">use_case = uc.StorageRoomListUseCase(repo)</code> </pre><br><p>  Finally, we execute the script by passing the request object </p><br><pre> <code class="python hljs">response = use_case.execute(request_object)</code> </pre><br><p>  But this response is not yet an HTTP response.  We must explicitly build it.  The HTTP response will contain a JSON representation of the <code><font color="#900">response.value</font></code> attribute. </p><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">return</span></span> Response(json.dumps(response.value, cls=ser.StorageRoomEncoder), mimetype=<span class="hljs-string"><span class="hljs-string">'application/json'</span></span>, status=<span class="hljs-number"><span class="hljs-number">200</span></span>)</code> </pre><br><p>  Note that this function is not yet complete, as it always returns a successful response (code 200).  But this is enough to pass the written tests.  The whole file looks like this: </p><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> json <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> flask <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> Blueprint, Response <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> rentomatic.use_cases <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> request_objects <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> req <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> rentomatic.repository <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> memrepo <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> mr <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> rentomatic.use_cases <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> storageroom_use_cases <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> uc <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> rentomatic.serializers <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> storageroom_serializer <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> ser blueprint = Blueprint(<span class="hljs-string"><span class="hljs-string">'storageroom'</span></span>, __name__) @blueprint.route(<span class="hljs-string"><span class="hljs-string">'/storagerooms'</span></span>, methods=[<span class="hljs-string"><span class="hljs-string">'GET'</span></span>]) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">storageroom</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function">:</span></span> request_object = req.StorageRoomListRequestObject.from_dict({}) repo = mr.MemRepo() use_case = uc.StorageRoomListUseCase(repo) response = use_case.execute(request_object) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> Response(json.dumps(response.value, cls=ser.StorageRoomEncoder), mimetype=<span class="hljs-string"><span class="hljs-string">'application/json'</span></span>, status=<span class="hljs-number"><span class="hljs-number">200</span></span>)</code> </pre><br><p>  This code demonstrates how clean architecture works.  True, the written function is not yet complete, since it does not take into account the parameters of string queries and cases with errors. </p><br><h3>  Server in action </h3><br><p>  <b>Git tag:</b> <a href="http://github.com/lgiordani/rentomatic/tree/step13">Step13</a> <br></p><br><p>  Before adding the missing parts of the end point, let's look at the server in work and see our project in action. </p><br><p>  In order to see the results when accessing the endpoint, we must fill the repository with test data.  Obviously, we have to do this because of the inconstancy of the storage we use.  The actual storage will wrap the persistent data source, and this test data will no longer be needed.  We define them to initialize the repository: </p><br><pre> <code class="python hljs">storageroom1 = { <span class="hljs-string"><span class="hljs-string">'code'</span></span>: <span class="hljs-string"><span class="hljs-string">'f853578c-fc0f-4e65-81b8-566c5dffa35a'</span></span>, <span class="hljs-string"><span class="hljs-string">'size'</span></span>: <span class="hljs-number"><span class="hljs-number">215</span></span>, <span class="hljs-string"><span class="hljs-string">'price'</span></span>: <span class="hljs-number"><span class="hljs-number">39</span></span>, <span class="hljs-string"><span class="hljs-string">'longitude'</span></span>: <span class="hljs-string"><span class="hljs-string">'-0.09998975'</span></span>, <span class="hljs-string"><span class="hljs-string">'latitude'</span></span>: <span class="hljs-string"><span class="hljs-string">'51.75436293'</span></span>, } storageroom2 = { <span class="hljs-string"><span class="hljs-string">'code'</span></span>: <span class="hljs-string"><span class="hljs-string">'fe2c3195-aeff-487a-a08f-e0bdc0ec6e9a'</span></span>, <span class="hljs-string"><span class="hljs-string">'size'</span></span>: <span class="hljs-number"><span class="hljs-number">405</span></span>, <span class="hljs-string"><span class="hljs-string">'price'</span></span>: <span class="hljs-number"><span class="hljs-number">66</span></span>, <span class="hljs-string"><span class="hljs-string">'longitude'</span></span>: <span class="hljs-string"><span class="hljs-string">'0.18228006'</span></span>, <span class="hljs-string"><span class="hljs-string">'latitude'</span></span>: <span class="hljs-string"><span class="hljs-string">'51.74640997'</span></span>, } storageroom3 = { <span class="hljs-string"><span class="hljs-string">'code'</span></span>: <span class="hljs-string"><span class="hljs-string">'913694c6-435a-4366-ba0d-da5334a611b2'</span></span>, <span class="hljs-string"><span class="hljs-string">'size'</span></span>: <span class="hljs-number"><span class="hljs-number">56</span></span>, <span class="hljs-string"><span class="hljs-string">'price'</span></span>: <span class="hljs-number"><span class="hljs-number">60</span></span>, <span class="hljs-string"><span class="hljs-string">'longitude'</span></span>: <span class="hljs-string"><span class="hljs-string">'0.27891577'</span></span>, <span class="hljs-string"><span class="hljs-string">'latitude'</span></span>: <span class="hljs-string"><span class="hljs-string">'51.45994069'</span></span>, }</code> </pre><br><p>  And we transfer them to our storage. </p><br><pre> <code class="python hljs">repo = mr.MemRepo ([storageroom1, storageroom2, storageroom3])</code> </pre><br><p>  Now we can run Flask through the <code><font color="#900">manage.py</font></code> file and check the published URLs: </p><br><pre> <code class="bash hljs">$ python manage.py urls Rule Endpoint ------------------------------------------------ /static/&lt;path:filename&gt; static /storagerooms storageroom.storageroom</code> </pre><br><p>  And start the development server </p><br><pre> <code class="bash hljs">$ python manage.py server</code> </pre><br><p>  If you open a browser and go to http: <a href="http://127.0.0.1:5000/storagerooms">//127.0.0.1.1000000/storagerooms</a> , you will see the result of the call API.  I recommend installing the browser formatting extension so that the answer is readable.  If you're using Chrome, try the <a href="https://github.com/callumlocke/json-formatter">JSON Formatter</a> . </p><br><h3>  REST layer (part 2) </h3><br><p>  <b>Git tag:</b> <a href="http://github.com/lgiordani/rentomatic/tree/step14">Step14</a> <br></p><br><p>  Let's look at two unimplemented cases at the end point.  First, I will enter a test that checks the correctness of processing the parameters of the query string by the end point </p><br><pre> <code class="python hljs"><span class="hljs-meta"><span class="hljs-meta">@mock.patch('rentomatic.use_cases.storageroom_use_cases.StorageRoomListUseCase') def test_get_failed_response(mock_use_case, client): mock_use_case().execute.return_value = res.ResponseFailure.build_system_error('test message') http_response = client.get('/storagerooms') assert json.loads(http_response.data.decode('UTF-8')) == {'type': 'SYSTEM_ERROR', 'message': 'test message'} assert http_response.status_code == 500 assert http_response.mimetype == 'application/json'</span></span></code> </pre><br><p>  Now we check that the script returns an error response, and we also see that the HTTP response contains an error code.  To pass the test, we must correlate the domain response codes with HTTP response codes. </p><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">from</span></span> rentomatic.shared <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> response_object <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> res STATUS_CODES = { res.ResponseSuccess.SUCCESS: <span class="hljs-number"><span class="hljs-number">200</span></span>, res.ResponseFailure.RESOURCE_ERROR: <span class="hljs-number"><span class="hljs-number">404</span></span>, res.ResponseFailure.PARAMETERS_ERROR: <span class="hljs-number"><span class="hljs-number">400</span></span>, res.ResponseFailure.SYSTEM_ERROR: <span class="hljs-number"><span class="hljs-number">500</span></span> }</code> </pre><br><p>  Then we need to create a Flask response with the correct code. </p><br><pre> <code class="python hljs"> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> Response(json.dumps(response.value, cls=ser.StorageRoomEncoder), mimetype=<span class="hljs-string"><span class="hljs-string">'application/json'</span></span>, status=STATUS_CODES[response.type])</code> </pre><br><p>  The second and last test is a little more difficult.  As before, we lock the script, but this time we also patch <code><font color="#900">StorageRoomListRequestObject</font></code> .  We need to know that the request object is initialized with the correct parameters from the command line.  So, we move step by step: </p><br><pre> <code class="python hljs"><span class="hljs-meta"><span class="hljs-meta">@mock.patch('rentomatic.use_cases.storageroom_use_cases.StorageRoomListUseCase') def test_request_object_initialisation_and_use_with_filters(mock_use_case, client): mock_use_case().execute.return_value = res.ResponseSuccess([])</span></span></code> </pre><br><p>  Here, as before, the patch of the script class ensures that the instance of the <code><font color="#900">ResponseSuccess</font></code> object is returned by precedent. </p><br><pre> <code class="python hljs"> internal_request_object = mock.Mock()</code> </pre><br><p>  The request object will be created inside the <code><font color="#900">StorageRoomListRequestObject.from_dict</font></code> , and we want the function to return the initialized here mock object. </p><br><pre> <code class="python hljs">request_object_class = <span class="hljs-string"><span class="hljs-string">'rentomatic.use_cases.request_objects.StorageRoomListRequestObject'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">with</span></span> mock.patch(request_object_class) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> mock_request_object: mock_request_object.from_dict.return_value = internal_request_object client.get(<span class="hljs-string"><span class="hljs-string">'/storagerooms?filter_param1=value1&amp;filter_param2=value2'</span></span>)</code> </pre><br><p>  We patch <code><font color="#900">StorageRoomListRequestObject</font></code> and assign a pre-known result to the <code><font color="#900">from_dict()</font></code> method.  Then we access the endpoint with some parameters of the query string.  The following happens: the <code><font color="#900">from_dict()</font></code> method of the request is called with filter parameters, and the <code><font color="#900">execute()</font></code> method of the script instance is called with <code><font color="#900">internal_request_object</font></code> . </p><br><pre> <code class="python hljs">mock_request_object.from_dict.assert_called_with( {<span class="hljs-string"><span class="hljs-string">'filters'</span></span>: {<span class="hljs-string"><span class="hljs-string">'param1'</span></span>: <span class="hljs-string"><span class="hljs-string">'value1'</span></span>, <span class="hljs-string"><span class="hljs-string">'param2'</span></span>: <span class="hljs-string"><span class="hljs-string">'value2'</span></span>}} ) mock_use_case().execute.assert_called_with(internal_request_object)</code> </pre><br><p>  The endpoint function must be changed to reflect this new behavior and make the test valid.  The final code of the new Flask-method <code><font color="#900">storageroom()</font></code> as follows </p><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> json <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> flask <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> Blueprint, request, Response <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> rentomatic.use_cases <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> request_objects <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> req <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> rentomatic.shared <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> response_object <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> res <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> rentomatic.repository <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> memrepo <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> mr <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> rentomatic.use_cases <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> storageroom_use_cases <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> uc <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> rentomatic.serializers <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> storageroom_serializer <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> ser blueprint = Blueprint(<span class="hljs-string"><span class="hljs-string">'storageroom'</span></span>, __name__) STATUS_CODES = { res.ResponseSuccess.SUCCESS: <span class="hljs-number"><span class="hljs-number">200</span></span>, res.ResponseFailure.RESOURCE_ERROR: <span class="hljs-number"><span class="hljs-number">404</span></span>, res.ResponseFailure.PARAMETERS_ERROR: <span class="hljs-number"><span class="hljs-number">400</span></span>, res.ResponseFailure.SYSTEM_ERROR: <span class="hljs-number"><span class="hljs-number">500</span></span> } storageroom1 = { <span class="hljs-string"><span class="hljs-string">'code'</span></span>: <span class="hljs-string"><span class="hljs-string">'f853578c-fc0f-4e65-81b8-566c5dffa35a'</span></span>, <span class="hljs-string"><span class="hljs-string">'size'</span></span>: <span class="hljs-number"><span class="hljs-number">215</span></span>, <span class="hljs-string"><span class="hljs-string">'price'</span></span>: <span class="hljs-number"><span class="hljs-number">39</span></span>, <span class="hljs-string"><span class="hljs-string">'longitude'</span></span>: <span class="hljs-string"><span class="hljs-string">'-0.09998975'</span></span>, <span class="hljs-string"><span class="hljs-string">'latitude'</span></span>: <span class="hljs-string"><span class="hljs-string">'51.75436293'</span></span>, } storageroom2 = { <span class="hljs-string"><span class="hljs-string">'code'</span></span>: <span class="hljs-string"><span class="hljs-string">'fe2c3195-aeff-487a-a08f-e0bdc0ec6e9a'</span></span>, <span class="hljs-string"><span class="hljs-string">'size'</span></span>: <span class="hljs-number"><span class="hljs-number">405</span></span>, <span class="hljs-string"><span class="hljs-string">'price'</span></span>: <span class="hljs-number"><span class="hljs-number">66</span></span>, <span class="hljs-string"><span class="hljs-string">'longitude'</span></span>: <span class="hljs-string"><span class="hljs-string">'0.18228006'</span></span>, <span class="hljs-string"><span class="hljs-string">'latitude'</span></span>: <span class="hljs-string"><span class="hljs-string">'51.74640997'</span></span>, } storageroom3 = { <span class="hljs-string"><span class="hljs-string">'code'</span></span>: <span class="hljs-string"><span class="hljs-string">'913694c6-435a-4366-ba0d-da5334a611b2'</span></span>, <span class="hljs-string"><span class="hljs-string">'size'</span></span>: <span class="hljs-number"><span class="hljs-number">56</span></span>, <span class="hljs-string"><span class="hljs-string">'price'</span></span>: <span class="hljs-number"><span class="hljs-number">60</span></span>, <span class="hljs-string"><span class="hljs-string">'longitude'</span></span>: <span class="hljs-string"><span class="hljs-string">'0.27891577'</span></span>, <span class="hljs-string"><span class="hljs-string">'latitude'</span></span>: <span class="hljs-string"><span class="hljs-string">'51.45994069'</span></span>, } @blueprint.route(<span class="hljs-string"><span class="hljs-string">'/storagerooms'</span></span>, methods=[<span class="hljs-string"><span class="hljs-string">'GET'</span></span>]) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">storageroom</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function">:</span></span> qrystr_params = { <span class="hljs-string"><span class="hljs-string">'filters'</span></span>: {}, } <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> arg, values <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> request.args.items(): <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> arg.startswith(<span class="hljs-string"><span class="hljs-string">'filter_'</span></span>): qrystr_params[<span class="hljs-string"><span class="hljs-string">'filters'</span></span>][arg.replace(<span class="hljs-string"><span class="hljs-string">'filter_'</span></span>, <span class="hljs-string"><span class="hljs-string">''</span></span>)] = values request_object = req.StorageRoomListRequestObject.from_dict(qrystr_params) repo = mr.MemRepo([storageroom1, storageroom2, storageroom3]) use_case = uc.StorageRoomListUseCase(repo) response = use_case.execute(request_object) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> Response(json.dumps(response.value, cls=ser.StorageRoomEncoder), mimetype=<span class="hljs-string"><span class="hljs-string">'application/json'</span></span>, status=STATUS_CODES[response.type])</code> </pre><br><p>  Note that we retrieve the parameters from the query string of the global request Flask object.  After the query string parameters appear in the dictionary, you only need to create a query object from it. </p><br><h3>  Conclusion </h3><br><p>  Well that's all!  Some tests in the REST layer are missing, but, as I said, this is only a working implementation to demonstrate pure architecture, and not a fully developed project.  I think you should try to add some changes yourself, such as: </p><br><ul><li>  another endpoint, for example, access to a single resource ( <code><font color="#900">/storagerooms/&lt;code&gt;</font></code> ) </li><li>  real storage connected to a real database (alternatively, <a href="https://sqlite.org/">SQLite</a> ) </li><li>  implementation of a new query string parameter, for example, the distance from a given point on the map (I recommend using <a href="https://github.com/geopy/geopy">geopy</a> to simply calculate the distance) </li></ul><br><p>  While developing your code, always try to follow the TDD approach.  Testability is one of the main features of a clean architecture, it is very important to write tests, do not ignore them. </p><br><p>  Regardless of whether you decide to use pure architecture or not, I hope that this post will help you get a fresh look at software architecture, as happened to me when I first learned about the concepts presented here. </p></div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <p>Source: <a href="https://habr.com/ru/post/320928/">https://habr.com/ru/post/320928/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../320918/index.html">Configure Let's Encrypt on Microsoft Azure</a></li>
<li><a href="../320920/index.html">Another look at the development of applications for smart TV</a></li>
<li><a href="../320922/index.html">Target as an antidepressant</a></li>
<li><a href="../320924/index.html">PushAll Auth - user authentication and feedback</a></li>
<li><a href="../320926/index.html">Create anamorphic distortion in Unity</a></li>
<li><a href="../320930/index.html">In the US, are going to turn off the server with 24 years uptime</a></li>
<li><a href="../320932/index.html">Report and materials of the conference MageConf 2016</a></li>
<li><a href="../320934/index.html">Simple greylisting in opensmtpd</a></li>
<li><a href="../320936/index.html">Infrastructure simple electronic signature. Part 4: Practical aspects of implementation</a></li>
<li><a href="../320938/index.html">Site protection against hacker attacks - Nemesida Web Application Firewall</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>