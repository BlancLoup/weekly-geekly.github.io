<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Round-robin default gateway breaks source routing for OpenVPN server</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="On Linux (Debian 8) router, source routing is configured using iproute2. Both FORWARD and INPUT \ OUTPUT packets are correctly routed. After enabling ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Round-robin default gateway breaks source routing for OpenVPN server</h1><div class="post__text post__text-html js-mediator-article"> <a href="https://habrahabr.ru/post/277393/"><img src="https://habrastorage.org/files/d62/2c3/b66/d622c3b662184e1e9b930eb9ef360785.jpg"></a> <br><br>  On Linux (Debian 8) router, source routing is configured using iproute2.  Both FORWARD and INPUT \ OUTPUT packets are correctly routed.  After enabling the round-robin default gateway, problems began to arise when connecting OpenVPN clients.  Case is quite rare, so I decided to share this solution with the community in the form of this note. <br><a name="habracut"></a><br>  Round-robin default gateway is enabled with the following command: <br><pre><code class="bash hljs">ip route add default scope global nexthop via <span class="hljs-variable"><span class="hljs-variable">$GW1</span></span> dev <span class="hljs-variable"><span class="hljs-variable">$IF1</span></span> weight 1 nexthop via <span class="hljs-variable"><span class="hljs-variable">$GW2</span></span> dev <span class="hljs-variable"><span class="hljs-variable">$IF2</span></span> weight 1 nexthop via <span class="hljs-variable"><span class="hljs-variable">$GW3</span></span> dev <span class="hljs-variable"><span class="hljs-variable">$IF3</span></span> weight 1</code> </pre> <br>  In reality, with routing, everything is a bit more complicated, but these particulars do not greatly influence the final output, so they can be omitted.  As you can see, three gateways with the same weight are used alternately.  OpenVPN server listens to all interfaces and works on the UDP protocol.  In theory, it should work with these settings, but the clients stopped connecting to this server.  Although the same SSH continued to work when connected via any of the interfaces.  It can be assumed that the reason is in the UDP protocol, but checking on the DNS server showed that the responses to the UDP requests are returned from the necessary interfaces.  Thus, when you enable the Round-robin gateway, source routing broke only for OpenVPN and the reason should be looked for in it. <br><br>  When connecting, before starting a handshake, a login with a password is requested, and the authorization is successful, no further connection is made, the client's failed connection log does not say anything useful: <br><pre> <code class="bash hljs">TLS Error: TLS key negotiation failed to occur within 60 seconds (check your network connectivity) TLS Error: TLS handshake failed SIGUSR1[soft,tls-error] received, process restarting MANAGEMENT: &gt;STATE:1451454269,RECONNECTING,tls-error Restart pause, 2 second(s)</code> </pre><br>  Interestingly, some clients (in fact, met only one) something interesting flew in the logs.  When connected to the first interface $ IP1, the log produced the following: <br><pre> <code class="bash hljs">Incoming packet rejected from [AF_INET]<span class="hljs-variable"><span class="hljs-variable">$IP1</span></span>:1194[2], expected peer address: [AF_INET]<span class="hljs-variable"><span class="hljs-variable">$IP2</span></span>:1194 (allow this incoming <span class="hljs-built_in"><span class="hljs-built_in">source</span></span> address/port by removing --remote or adding --<span class="hljs-built_in"><span class="hljs-built_in">float</span></span>) Incoming packet rejected from [AF_INET]<span class="hljs-variable"><span class="hljs-variable">$IP1</span></span>:1194[2], expected peer address: [AF_INET]<span class="hljs-variable"><span class="hljs-variable">$IP3</span></span>:1194 (allow this incoming <span class="hljs-built_in"><span class="hljs-built_in">source</span></span> address/port by removing --remote or adding --<span class="hljs-built_in"><span class="hljs-built_in">float</span></span>)</code> </pre><br>  And so in a circle.  Moreover, if the client replaces the IP address of the server with $ IP2, the response packets will come from $ IP1 and $ IP3, but not from $ IP2.  Those.  no matter what IP client connects, the <b>answer never comes from the same address</b> .  Quite a strange behavior.  I repeat, at the same time, routing from the source through other connections is working properly. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      In the process of troubleshooting, it turned out that when the protocol is changed to TCP, the connection is successful and the reason for this must be found in the implementation of the work on UDP.  After that, there was also a solution - the Multihome parameter on the server side of OpenVPN.  Man openvpn of the multihome parameter: <br><br><blockquote>  --multihome <br>  Configure a multi-homed UDP server.  This is where you can use the IP address (eg, multiple interfaces, or secondary IP addresses) <br>  specific address only.  This is the case for the UDP reply packets.  This is not supported on all <br>  it is not enabled by default. <br>  Note: this option is only relevant for UDP servers. <br>  Note 2: If you have an IPv4 + IPv4 address, i.e. <br>  IPv4-mapped case (some distributions have ported this to earlier kernel versions, though). </blockquote><br>  Now it is clear, the reason is in the principle of the OpenVPN server operation using the UDP protocol.  The multihome option adds additional processing to udp packets that guarantee the sending of response packets from the address to which the request came.  Specifically, what happens can be said after studying the sources of OpenVPN.  Thus, when configuring the round-robin default gateway, for OpenVPN to work correctly, you must either use the TCP protocol or add the multihome parameter when using UDP. </div><p>Source: <a href="https://habr.com/ru/post/277393/">https://habr.com/ru/post/277393/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../277381/index.html">The first reports of PHDays VI: how to break transport maps, set up hacker mousetraps and sell vulnerabilities for $ 100,000</a></li>
<li><a href="../277383/index.html">The glibc library‚Äôs critical vulnerability allows remote code execution</a></li>
<li><a href="../277385/index.html">Microsoft Operations Management Suite - Overview. Part number 1</a></li>
<li><a href="../277389/index.html">The book "Eternity. In search of the ultimate theory of time "</a></li>
<li><a href="../277391/index.html">HPE SPM Portfolio Innovations: Service Manager 9.4, SmartAnalytics, and Propel</a></li>
<li><a href="../277395/index.html">Axure 7 for beginners in 100 minutes</a></li>
<li><a href="../277397/index.html">Introducing the Intel RealSense Driver for Linux & OS X</a></li>
<li><a href="../277399/index.html">My rules for a good interface design</a></li>
<li><a href="../277401/index.html">Storage for 100 thousand or how to save on expensive projects</a></li>
<li><a href="../277403/index.html">In-depth training in the garage - Return smiles</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>