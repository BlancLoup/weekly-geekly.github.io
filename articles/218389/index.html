<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Hybrid applications in Qt using D3.js as an example</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="D3 is a powerful JavaScript library for visualizing data. In my opinion, this is just a paradise for a web developer, seemingly inaccessible to a Qt p...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Hybrid applications in Qt using D3.js as an example</h1><div class="post__text post__text-html js-mediator-article">  D3 is a <a href="https://github.com/mbostock/d3/wiki/Gallery">powerful JavaScript library</a> for visualizing data.  In my opinion, this is just a paradise for a web developer, seemingly inaccessible to a Qt programmer.  But the flexibility of the Qt framework allows you to integrate a web-frontend into a thick client using the <a href="http://qt-project.org/doc/qt-4.8/qtwebkit-bridge.html">Qt Web Bridge</a> mechanism.  Such applications are called hybrid ( <a href="http://www.slideshare.net/YnonPerek/hybrid-apps-with-qt">Qt Hybrid Apps</a> ). <br><br>  For JavaScript programmers, the good news is that their solutions can be easily integrated into Desktop applications, which could potentially increase the target audience of users of the libraries being developed (in any case, this is true for the world of Qt applications). <br><br>  The screenshot below shows the <a href="http://www.redotheweb.com/DependencyWheel/">Dependency Wheel</a> widget (Circle of Dependencies), which is drawn with the help of D3.js and the data and display is managed with the help of Qt.  When a pointer is located above the corresponding arc, its interrelationships are ‚Äúhighlighted‚Äù, and the rest become semi-significant.  This widget can be used to visualize various kinds of dependencies (for example, libraries). 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Unlike the original JS solution, the diagram dynamically changes the size to fit the widget, and the data is set on the Qt side, rather than by loading a JSON file. <br><br>  The article is more focused on Qt-programmers, but it can also be interesting for JS programmers. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/files/f3c/6e2/260/f3c6e22608634419ae174af844a1566e.png"></div><br><a name="habracut"></a><br><h4>  The idea of ‚Äã‚Äãhybrid applications </h4><br>  The starting point of the idea of ‚Äã‚Äãhybrid applications is a number of limitations inherent in native applications: <br><ul><li>  additional costs for the implementation and maintenance of client parts of the system; </li><li>  writing a unique user interface is sometimes a non-trivial task; </li><li>  inability to reuse existing web application APIs. </li></ul><br>  Hybrid applications solve these problems due to the fact that: <br><ul><li>  deployment is done as in web applications; </li><li>  complex interfaces are created using web technologies (HTML, CSS, SVG, Canvas); </li><li>  reuse existing web application APIs </li></ul><br>  The hybrid application architecture suggests that <br><ul><li>  Qt-application acts as a browser; </li><li>  user interaction and application logic is programmed in JavaScript; </li><li>  additional functionality is implemented in C ++ in the Qt-part of the application. </li></ul><br>  Thus, hybrid applications implement the idea of ‚Äã‚Äãa thin client. <br>  One example of hybrid applications in Qt is <a href="http://qt-project.org/doc/qt-4.8/webkit-imageanalyzer.html">WebKit Image Analyzer</a> . <br><br>  In the example considered in the article, only part of the hybrid application approach will be used: component mapping due to JavaScript.  In this case, all the necessary JS files will be located in the resources, as in the classic StandAlone application (standalone and does not require an intranet / Internet connection to work). <br><br><h4>  Project structure </h4><br>  The general structure of the project files is shown in the figure: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/files/2d4/46b/d5b/2d446bd5b3ee45bd9821b304d8dc98cd.png"></div><br><br>  The base directory contains: <br><ul><li>  d3viewer.h and d3viewer.cpp - the definition and implementation of the base viewer class <i>D3Viewer</i> , inherited from <i>QWidget</i> and encapsulating the interaction with <i>QWebView</i> . </li><li>  d3webpage.h and d3webpage.cpp - the definition and implementation of <i>D3WebPage</i> - a <i>QWebPage</i> successor (to support error messages and debug information in <i>QWebPage :: javaScriptConsoleMessage</i> ). </li></ul><br>  In the charts / pie directory: <br><ul><li>  dependencywheelwidget.h and dependencywheelwidget.cpp - definition and implementation of the base viewer class, inherited from <i>QWidget</i> and encapsulating interaction with <i>QWebView</i> . </li></ul><br>  The resources directory is divided into two: js and html.  The html contains the page that will be loaded in the widget and contains all the Qt interaction code, js contains the js files necessary for the DependencyWheel to work: common for D3 is d3.min.js and example-specific is d3.dependencyWheel. js. <br><br><h4>  Class diagram </h4><br>  In order to reduce the volume of the article using VisualParadigm, a simple diagram was created: it omits the attributes and methods of classes that are not directly related to the described technology.  Details of the implementation can be found in the source code, link to which is located at the end of the article. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/files/48a/c88/0c9/48ac880c985146e99240bbf934d1c158.png"></div><br><br><h4>  Qt &lt;-&gt; JS Interaction </h4><br>  In hybrid applications, a special object is embedded in JavaScript, the method call of which is processed on the Qt side: <br><br><pre><code class="hljs pgsql"><span class="hljs-type"><span class="hljs-type">void</span></span> D3Viewer::addContextObject(const QString &amp;<span class="hljs-type"><span class="hljs-type">name</span></span>, QObject *<span class="hljs-keyword"><span class="hljs-keyword">object</span></span>) { frame()-&gt;addToJavaScriptWindowObject( <span class="hljs-type"><span class="hljs-type">name</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">object</span></span> ); //frame() - QWebFrame }</code> </pre> <br>  This method is called in the D3Viewer-derived classes in the constructor before loading the page: <br><br><pre> <code class="hljs kotlin">addContextObject(<span class="hljs-string"><span class="hljs-string">"api"</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>);</code> </pre><br>  Further, the interaction of Qt with JS is possible through four mechanisms: <br><ol><li>  By referring to the properties of the object. <br>  for this you need to define a property in the object, which is a context object in JS ("api"): <br><br><pre> <code class="hljs pgsql"><span class="hljs-built_in"><span class="hljs-built_in">public</span></span>: Q_PROPERTY(<span class="hljs-type"><span class="hljs-type">float</span></span> padding <span class="hljs-keyword"><span class="hljs-keyword">READ</span></span> padding <span class="hljs-keyword"><span class="hljs-keyword">WRITE</span></span> setPadding) <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> slots: <span class="hljs-type"><span class="hljs-type">float</span></span> padding(); //getter <span class="hljs-type"><span class="hljs-type">void</span></span> setPadding(const <span class="hljs-type"><span class="hljs-type">float</span></span> padding); //setter</code> </pre><br>  After that, you can access these properties from JS: <br><br><pre> <code class="javascript hljs"> <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> chart = d3.chart.dependencyWheel() .width(api.width) .height(api.height) .margin(api.margin) .padding(api.padding);</code> </pre><br></li><li>  Signal processing Qt in JS, for this in JS, you must connect the appropriate handler function to the signal. <br><br><pre> <code class="javascript hljs">api.update.connect(redraw);</code> </pre><br></li><li>  Calling Qt slots in JS, for example, when processing a click on an element: <br><br><pre> <code class="javascript hljs"> g.append(<span class="hljs-string"><span class="hljs-string">"svg:path"</span></span>) .style(<span class="hljs-string"><span class="hljs-string">"fill"</span></span>, fill) .style(<span class="hljs-string"><span class="hljs-string">"stroke"</span></span>, fill) .attr(<span class="hljs-string"><span class="hljs-string">"d"</span></span>, arc) .on(<span class="hljs-string"><span class="hljs-string">"mouseover"</span></span>, fade(<span class="hljs-number"><span class="hljs-number">0.1</span></span>)) .on(<span class="hljs-string"><span class="hljs-string">"mouseout"</span></span>, fade(<span class="hljs-number"><span class="hljs-number">1</span></span>)) .on(<span class="hljs-string"><span class="hljs-string">'click'</span></span>, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">d</span></span></span><span class="hljs-function">) </span></span>{ api.itemClicked(packageNames[d.index]) } ); <span class="hljs-comment"><span class="hljs-comment">//  </span></span></code> </pre><br></li><li>  By calling other Qt methods in JS, for this method declaration must be preceded by the Q_INVOKABLE macro. <br><br><pre> <code class="hljs cs"><span class="hljs-function"><span class="hljs-function">Q_INVOKABLE </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">thisMethodIsInvokableInJavaScript</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span>;</code> </pre><br></li><li>  Direct execution of the JS code. <br><br><pre> <code class="hljs php">void D3Viewer::evaluateScript(<span class="hljs-keyword"><span class="hljs-keyword">const</span></span> QString &amp;script) { frame()-&gt;evaluateJavaScript(script); }</code> </pre></li></ol><br>  In the example, methods 4 and 5 are not used. <br><br><h4>  Debugging JavaScript in a hybrid application </h4><br>  To debug a JS application (like a DOM overview, view network activity, downloadable resources, etc.), you need to set the following property in the D3Viewer designer: <br><br><pre> <code class="hljs smalltalk"><span class="hljs-symbol"><span class="hljs-symbol">#ifdef</span></span> <span class="hljs-type"><span class="hljs-type">QT_DEBUG</span></span> //           page()-&gt;settings()-&gt;setAttribute(<span class="hljs-type"><span class="hljs-type">QWebSettings</span></span>::<span class="hljs-type"><span class="hljs-type">DeveloperExtrasEnabled</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>); <span class="hljs-symbol"><span class="hljs-symbol">#endif</span></span></code> </pre><br>  Then at run time, the context menu item ‚ÄúInspect‚Äù will be available in the context menu (right-click on QWebView). <br><br><div style="text-align:center;"><img src="https://habrastorage.org/files/69e/42e/33d/69e42e33d635489bbc9da3a8b5360338.png"></div><br><br>  Having chosen which window of Web-inspector is displayed. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/files/c0f/484/671/c0f4846716804298b3dbc20250b94b6f.png"></div><br><br>  In this window, on the Scripts tab, you can enable debugging. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/files/76c/b46/625/76cb46625d26428383ff81a8926f87b8.png"></div><br><br>  Setting a breakpoint is done by clicking on the corresponding line number on the left. <br>  PS In Qt 4.8.6 I never managed to intercept breakpoint.  In 5.3.0 everything is working properly. <br><br><h4>  disadvantages </h4><br>  Any solution has both advantages and disadvantages.  And in this case, D3.js will have to pay its price for the ‚Äúprettiness‚Äù. <br><ul><li>  Additional overhead (primarily memory). <br>  Besides the fact that QWebView ‚Äúpulls‚Äù webkit behind us, creating a new ‚Äúhybrid‚Äù widget, we are re-creating a rather heavyweight QWebView object.  This is not so true if the entire UI is loaded in one QWebView (as suggested in the original idea of ‚Äã‚Äãhybrid applications). <br></li><li>  The risk of the impossibility of reverse reuse in the web after modifying JS.  You can modify JavaScript code to fit Qt so that it becomes unusable in a web application.  Therefore, it is desirable to isolate all calls to the Qt-object api in one place - for example, in the script section of the html file, which in this case will be different for the web and Qt applications, and the JS code in the included files will be the same. </li><li>  WebKit bugs in Qt 4.8.6 <br>  In D3, tree structures are actively used, the description of which is in JSON files.  On the Qt side, the same JSON object is formed by a combination of QVariantMap / QVariantList, which are summarized in QVariant.  Despite the fact that the structure of such objects is identical, in Qt 4.8.6 there are still differences, since such an object is not perceived directly and you have to re-recreate the JSON object in memory on the JS side.  In Qt 5.3.0, such a crutch can be not used - everything works directly. <br><br><pre> <code class="javascript hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">recreateJsonObject</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">obj</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> jsonObj = {}; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span>(key <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> obj) { jsonObj[key] = obj[key]; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> dependencies = []; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">var</span></span> i = <span class="hljs-number"><span class="hljs-number">0</span></span> ; i &lt; obj[key].length ; i++ ) { dependencies.push(obj[key][i]); } jsonObj[key] = dependencies; } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> jsonObj; }</code> </pre><br><br>  Even in Qt 4.8.6, after a 15‚Äì20 second widget resize, the application stops working normally and a heap of JS error messages pops out.  In Qt 5.3.0, everything works as expected, which again suggests that the problem lies in the implementation of WebKit itself (although I may be mistaken).  However, the issues of allocating and freeing memory on the JS side remain relevant. <br></li></ul><br><h4>  Source </h4><br>  The source code of the sample is available <a href="">here</a> . <br>  The example was built and run under Qt 4.8.6 and 5.3.0. </div><p>Source: <a href="https://habr.com/ru/post/218389/">https://habr.com/ru/post/218389/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../218375/index.html">Basis: B1</a></li>
<li><a href="../218379/index.html">Festo developers have created a kangaroo robot (video)</a></li>
<li><a href="../218381/index.html">Useful materials for mobile developer # 47 (March 31-April 6)</a></li>
<li><a href="../218385/index.html">Expansion and layout of directives</a></li>
<li><a href="../218387/index.html">Another do-it-yourself NAS, part 3: the adventures of XXX in the old tower</a></li>
<li><a href="../218391/index.html">3000 mAh Battery Cover for Sony Xperia Z1 Review</a></li>
<li><a href="../218393/index.html">Open Interfaces: Future Business Strategy</a></li>
<li><a href="../218395/index.html">Systems such as DoubleClick can identify up to 90% of users.</a></li>
<li><a href="../218397/index.html">Debug asynchronous javascript using Chrome DevTools</a></li>
<li><a href="../218399/index.html">Python-digest # 21. News, interesting projects, articles and interviews [March 30, 2014 - April 6, 2014]</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>