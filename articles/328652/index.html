<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Create jpeg from nowhere</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Here is an interesting demonstration of the possibilities of afl ; I was really surprised that it works! 



$ mkdir in_dir $ echo 'hello' >in_dir/hel...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Create jpeg from nowhere</h1><div class="post__text post__text-html js-mediator-article">  Here is an interesting demonstration of the possibilities of <a href="http://code.google.com/p/american-fuzzy-lop">afl</a> ;  I was really surprised that it works! <br><br><pre><code class="hljs ruby">$ mkdir in_dir $ echo <span class="hljs-string"><span class="hljs-string">'hello'</span></span> &gt;in_dir/hello $ ./afl-fuzz -i in_dir -o out_dir ./jpeg-<span class="hljs-number"><span class="hljs-number">9</span></span>a/djpeg</code> </pre> <br>  In essence, I created a text file with only the word "hello" and asked the fuzzer to output a stream to a program that expects a JPEG image at the input ( <i>djpeg</i> is a simple utility that comes with the popular <i><a href="http://www.ijg.org/">IJG jpeg</a></i> graphic library; <i><a href="http://libjpeg-turbo.virtualgl.org/">libjpeg-turbo</a></i> should also come up) .  Of course, my input does not look like a valid image, so the utility quickly rejects them: <br><br><pre> <code class="hljs delphi">$ ./djpeg <span class="hljs-string"><span class="hljs-string">'../out_dir/queue/id:000000,orig:hello'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Not</span></span> a JPEG <span class="hljs-keyword"><span class="hljs-keyword">file</span></span>: starts <span class="hljs-keyword"><span class="hljs-keyword">with</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>x68 <span class="hljs-number"><span class="hljs-number">0</span></span>x65</code> </pre> <a name="habracut"></a><br>  Usually such fuzzing would be completely meaningless: essentially, there is no chance that a traditional format-independent fuzzer can ever turn the word "hello" into a valid JPEG image.  The probability that dozens of random settings will line up one after another is astronomically small. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Fortunately, <i>afl-fuzz</i> can use for its own purposes simple tools at the assembly level ‚Äî and within a millisecond or so he notices that although setting the first byte to <i>0xff</i> does not change the outwardly observed output, you can run a slightly different internal path in the test application .  With this information, he decides to use this test case as a basis for future fuzzing rounds: <br><br><pre> <code class="hljs delphi">$ ./djpeg <span class="hljs-string"><span class="hljs-string">'../out_dir/queue/id:000001,src:000000,op:int8,pos:0,val:-1,+cov'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Not</span></span> a JPEG <span class="hljs-keyword"><span class="hljs-keyword">file</span></span>: starts <span class="hljs-keyword"><span class="hljs-keyword">with</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>xff <span class="hljs-number"><span class="hljs-number">0</span></span>x65</code> </pre> <br>  Processing then the test case of the second generation, fuzzer almost immediately notices that setting the second byte to <i>0xd8</i> does something even more interesting: <br><br><pre> <code class="hljs pgsql">$ ./djpeg <span class="hljs-string"><span class="hljs-string">'../out_dir/queue/id:000004,src:000001,op:havoc,rep:16,+cov'</span></span> Premature <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-keyword"><span class="hljs-keyword">of</span></span> JPEG file JPEG datastream contains <span class="hljs-keyword"><span class="hljs-keyword">no</span></span> image</code> </pre> <br>  Here, Fazzer managed to synthesize a valid file header ‚Äî and really understood its significance.  Using such a rendition as the basis for the next fuzzing round, he quickly begins to sink deeper and deeper into the core.  After several hundred generations and several hundred million <i>execve ()</i> calls, he finds more and more control structures that are needed for a valid JPEG file ‚Äî SOFs, Huffman tables, quantization tables, SOS markers, and so on: <br><br><pre> <code class="hljs 1c">$ ./djpeg '../out_dir/queue/id:<span class="hljs-number"><span class="hljs-number">000008</span></span>,src:<span class="hljs-number"><span class="hljs-number">000004</span></span>,op:havoc,rep:2,+cov' Invalid JPEG file structure: two SOI markers ... $ ./djpeg '../out_dir/queue/id:<span class="hljs-number"><span class="hljs-number">001005</span></span>,src:<span class="hljs-number"><span class="hljs-number">000262</span></span>+<span class="hljs-number"><span class="hljs-number">000979</span></span>,op:splice,rep:2' Quantization table <span class="hljs-number"><span class="hljs-number">0</span></span>x0e was not defined ... $ ./djpeg '../out_dir/queue/id:<span class="hljs-number"><span class="hljs-number">001282</span></span>,src:<span class="hljs-number"><span class="hljs-number">001005</span></span>+<span class="hljs-number"><span class="hljs-number">001270</span></span>,op:splice,rep:2,+cov' &gt;.tmp; ls -l .tmp -rw-r--r-- <span class="hljs-number"><span class="hljs-number">1</span></span> lcamtuf lcamtuf <span class="hljs-number"><span class="hljs-number">7069</span></span> Nov <span class="hljs-number"><span class="hljs-number">7</span></span> <span class="hljs-number"><span class="hljs-number">09</span></span>:<span class="hljs-number"><span class="hljs-number">29</span></span> .tmp</code> </pre> <br>  The first picture, obtained after six hours of fuzzing on an 8-core system, looks quite modest: it is a pure gray rectangle 3 pixels high and 748 pixels wide.  But from the moment of its opening, fuzzer begins to use this picture as a basis - and quickly produces a wide range of more interesting pictures for each new path of execution: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/295/d9c/cdb/295d9ccdbcef6a6dab38a1021ea75eff.jpg"><br><br>  Of course, the synthesis of a complete image from nowhere is an exceptional case, and hardly useful in practice.  But for more prosaic purposes, fuzzers are suitable for load testing any function in a target program.  Equipped with a snap, evolutionary fuzzing using less well-known functions (for example, JPEG with progressive or arithmetic coding, black and white JPEG) can be used as an alternative to the gigantic high-quality package of various test cases that begin fuzzing. <br><br>  A remarkable feature of the <i>libjpeg</i> case is that it works without any special preparation: there is nothing special in the "hello" line, the fuzzer knows nothing about parsing images, it is not intended and not configured to work specifically with this library.  There are not even any command line keys to activate.  You can <i>play afl-fuzz</i> on many other types of parsers with the same results: with <i>bash,</i> it will <a href="http://lcamtuf.blogspot.com/2014/10/bash-bug-how-we-finally-cracked.html">write valid scripts</a> ;  with <i>giflib to</i> produce gifs;  with <i>fileutils to</i> produce ELF files and set flags, create binaries for Atari 68xxx, boot sectors x86 and UTF-8 with BOM.  In almost all cases, the impact of tooling on performance is also minimal. <br><br>  Of course, not everything is so smooth.  In essence, <i>afl-fuzz</i> remains a program for brute force.  This makes it simple, fast and reliable, but also means that certain types of atomized checks in a large search space can become an insurmountable obstacle to a fuzzer.  Here is a good example: <br><br><pre> <code class="hljs lisp">if (<span class="hljs-name"><span class="hljs-name">strcmp</span></span>(<span class="hljs-name"><span class="hljs-name">header</span></span>.magic_password, <span class="hljs-string"><span class="hljs-string">"h4ck3d by p1gZ"</span></span>)) goto terminate_now<span class="hljs-comment"><span class="hljs-comment">;</span></span></code> </pre> <br>  In practice, this means that <i>afl-fuzz is</i> unlikely to be able to ‚Äúinvent‚Äù from scratch PNG files or non-trivial HTML documents ‚Äî and it needs a better starting point than just ‚Äúhello‚Äù.  In order to invariably work with code constructions as in the above example, the universal fuzzer needs to understand the work of the target binaries at a completely different level.  Scientists have made some progress in this regard, but we still have years to wait for the emergence of frameworks that are able to quickly, simply and reliably work with diverse and complex code bases. <br><br>  <font color="gray">Several people asked me about the symbolic performance and other things influenced by <i>afl-fuzz</i> ;</font>  <font color="gray">I have collected some notes in <a href="http://lcamtuf.coredump.cx/afl_demo/long_story.txt">this document</a> .</font> </div><p>Source: <a href="https://habr.com/ru/post/328652/">https://habr.com/ru/post/328652/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../328638/index.html">Creating a minimal ASP.NET Core web application with support for npm, Webpack and TypeScript in Visual Studio 2017</a></li>
<li><a href="../328642/index.html">Unobvious things at the start of development for Android under Windows 7</a></li>
<li><a href="../328644/index.html">Startup is dead, long live the startup</a></li>
<li><a href="../328646/index.html">Offline promotion of the personnel monitoring system: personal experience</a></li>
<li><a href="../328648/index.html">Automating SSH access to Kubernetes nodes using Fabric and CoreOS integration</a></li>
<li><a href="../328654/index.html">How does the buyer work</a></li>
<li><a href="../328658/index.html">How to protect yourself from the attack of the encryption virus ‚ÄúWannaCry‚Äù</a></li>
<li><a href="../328660/index.html">The clash of cultures. How is the intranet developing in Russia?</a></li>
<li><a href="../328666/index.html">Five different: how I chose CRM for my service</a></li>
<li><a href="../328668/index.html">Neural networks, genetic algorithms, etc. ... Myths and reality. Version II</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>