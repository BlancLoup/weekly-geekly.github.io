<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>How to find a place on earth and not get to the Yandex counter</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="... this story began a long time ago in a far-away country of Cracovia, whose inhabitants blithely lived their lives and did not know ... 

 But I mys...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>How to find a place on earth and not get to the Yandex counter</h1><div class="post__text post__text-html js-mediator-article">  ... this story began a long time ago in a far-away country of Cracovia, whose inhabitants blithely lived their lives and did not know ... <br><br>  But I myself am a local, and today I will tell you a terrible story about what prevented sleep (for me personally) for many years.  And these are not taxes (everything is fine with them), this is <a href="https://tech.yandex.ru/maps/geocoder/">Yandex.Maps geocoder</a> ! <br><blockquote>  A geocoder is one of the HTTP services of Yandex.Map that receives a textual representation of the address in the request and returns the objects found on its basis in the response.  Or vice versa: receiving coordinates and responding with the address. </blockquote><br>  It is the geocoder that will tell you where the wonderful country of Cracovia is on the map.  And it is he who will be the main character of this story, the outset of which was described in a completely different book - in the ancient folio <a href="https://legal.yandex.ru/maps_api/">Yandex.Maps API User Agreement</a> .  Legend has it that there is a limit on the number of requests to the geocoding function.  The maximum allowed to do per day is <u>no more than 25,000 requests</u> to HTTP and JS geocoder per day.  Or oatmeal, sir. <br><br>  And just the other day this rule has turned from ordinary words into a threat to the performance of the site.  The <a href="">API Maps Club published a</a> message about mass bans of various services that exceed limits. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
     <a href="http://habrahabr.ru/company/yandex/blog/263863/"><img src="https://habrastorage.org/files/aca/777/a45/aca777a4532b4808a7b3d39ef0203b2a.jpg"></a> <br><br>  What to do?  For clarity, we will get a piano out of the bushes - 8 years ago, the project <a href="http://esosedi.ru/">‚ÄúeCity‚Äù was</a> lit up on Habr√© - ‚ÄúMap of interesting places‚Äù.  All these years I continue to work on it. <br><a name="habracut"></a><br>  Some of the places that users drew on the map had only coordinates on the map - for them it was necessary to find out the address.  Other places found in various sources, on the contrary, only the address was known.  So, it was necessary to translate it into coordinates for display on the map. <br><br>  Moreover, the translation of coordinates to the address and back had to be repeated regularly! <br><blockquote>  According to the rules of using the service, the response of the geocoder cannot be saved to the database forever, but it can be cached for up to 30 days.  The point is not that Yandex does not want to share data, just the quality of data and coverage is constantly changing, but for me, as the creator of the service, it was important that the latest information was available to the user.  By the way, Krakow still does not find it. </blockquote><br>  In addition, tens of thousands of people visited the e-Neighborhood website every day who searched for places, which again led to the use of a geocoder. <br><br>  In fact, everything could not be so bad if it were not for laziness and faith in the MIRACLE!  See: <br><br><pre><code class="javascript hljs">ymaps.geocode(<span class="hljs-string"><span class="hljs-string">'  .12'</span></span>).then(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">res</span></span></span><span class="hljs-function">)</span></span>{myMap.geoObjects.add(res.geoObjects);}); <span class="hljs-comment"><span class="hljs-comment">//  ymaps.geoQuery(ymaps.geocode('')).addToMap(myMap);</span></span></code> </pre> <br>  As a result of a simple operation, one or more points will appear on the map and exactly in the right place.  Isn't it a miracle? <br><br>  Blinded by the ease of use of the JS geocoder, many developers programmed their ‚Äúcartographic solutions‚Äù this way.  Displaying ATMs, post offices, your points of sale, or any other ‚Äúorganizations‚Äù associated with an address is really easier if you only work with addresses. <br><br>  The texts will be swallowed up by the API, somewhere in the depths they will magically digest - and the labels will appear on the map in the right places.  I will even tell you more - many people do not see the difference between assigning a location to a label with numerical coordinates or a legal address. <br><br>  The trouble is that you have to pay for all the magic!  And still it is necessary to go to the handle and to rise on the counter.  And if you have one page, there are 10 tags on it, and 2,500 people per day - it means you have rested against the limit. <br><blockquote>  Previously, when crossing the border of 25,000 requests per day, a letter could come from a manager from Yandex explaining what you are doing wrong.  Now come the evil robot with plusmetom - and all. </blockquote><br>  That is what prevented me from sleeping the last few days.  One of the parts of the "e-Neighbors" is the materialization of KLADR (cities, streets, addresses) - <a href="http://postindex.esosedi.ru/">postindex.esosedi.ru</a> .  This database is ‚Äúabout addresses‚Äù and, of course, it is described by addresses (text) and often does not contain coordinates.  Even now, many of the villages of our large Motherland are not geocoded (remember about Cracovia).  So the coordinates are secondary. <br><br>  Each time you visit a page of a city or street, a map is shown.  At the same time, a request is sent to translate a known address (Timur Frunze, 11k2) into coordinates.  By the way, geocoding is not instantaneous, and if you have a lot of points, it can slow down the loading of the map. <br><br>  Everything would be fine, but 40,000 post offices, 211,000 settlements, a million streets, 55,000 visitors yesterday ... That's enough for two daily limits with a tail.  But for many years, this is exactly what worked.  Why all? <br><br><img src="https://habrastorage.org/files/266/27a/6fe/26627a6feaf148708a50c287d84f249c.jpg" width="540" height="540"><br><br>  We will not wait for the evil robot - we will solve the problem.  Fortunately, there is a solution, and not one, but two. <br><br><h3>  The first solution is the right one. </h3><br>  Modify the backend so that it is where to save the coordinates.  And that means making a normal admin panel, planting a girl who, based on a visual inspection of the ‚Äúanswer‚Äù of the geocoder, will display the TTL data, move the icons, reaching the centimeter mark placement accuracy ... <br><br>  Pros: high-tech, reliable, beautiful girl in the office. <br>  Minuses: a backend is required, a database is required, it is not entirely clear what to do with a user search;  it is not quite understood how the wife will react. <br><br><h3>  The second solution is cheap and angry. </h3><br>  Make your search!  Such that something in itself retains (ie, a caching proxy), is out of the box, to cope with the same simultaneous requests, and so on. <br><br>  In general, the idea is very simple: go to some kind of your own pen, check the status of the cache there and, if you don‚Äôt have the necessary data, send a request to the HTTP geocoder Yandex.Maps. <br><br>  For many large projects, the right decision will be to write something of your own.  Maybe even deploy your geocoder completely, for example, based on OSM. <br><br>  But I know from experience that for the majority the most profitable option is to take something ready with github.  By tradition, I give a link to the <a href="https://github.com/dimik/geocode-tool">geocode-tool</a> solution to the problem from <a href="https://habrahabr.ru/users/dimik/" class="user_link">dimik</a> .  Dima once worked Yandex. Maps and can not stop. <br><br>  In the general case, the geocode-tool is the server part (‚Äúpen‚Äù), a web-interface with statistics, and a <a href="">module for Yandex.Maps</a> . <br><br>  Minuses: it is required to launch one more service on the server, besides on the node.  There will be no girl in the office. <br>  Pros: All work has been reduced to a turnip jump and adding a couple of lines on the client (well, almost). <br><br><blockquote>  If you have a map with at least a location map, and geocoding is used (check), and it also seems to you that it runs frequently, connect a proxy server to yourself.  If you have an address transformation on every page, use the server geocoder or set the coordinates directly. </blockquote><br>  1000 people who will visit 10 pages of an abstract store, where on each page there is a location map, 2 points (addresses) on each page - these are already 20,000 requests, which is dangerously close to the limit.  Suddenly, one day you decide to buy ads, and the site will be visited by a few more people? <br><br>  How did this end with us, on the ‚Äúe-Neighbor‚Äù: <br><ul><li>  Connecting the local cache made it possible to speed up the page by an average of 150ms - access to the geocoder under the conditions of mass upload of pictures and other advertising is not a quick matter. <br>  When generating the page code, the geocoder's cache twitches at the beginning, bypassing the original service, and only if there is no answer is the function call added to the client.  PS: there is again a <a href="https://github.com/dimik/node-multi-geocoder">server version of</a> this case on github. </li><li>  Finally, statistics appeared on the requests! </li><li>  After the appearance of the administrative division ( <a href="http://habrahabr.ru/post/253515/">article on Habr√©</a> ) and the normal cache of the geocoder, it became possible after the fact to check the correctness of the work of both. </li></ul><br>  That is - do not forget that the geocoder is not an artificial mind - it can produce garbage. <br><br><img src="https://habrastorage.org/files/22a/334/813/22a334813f20468eba309e427481f827.jpg" width="540" height="540"><br><br><blockquote>  As is well known in the south of Moscow, there are four ( <a href="http://www.esosedi.ru/onmap/s_svitino/3670890/index.html">1</a> , <a href="http://ru.esosedi.org/RU/KLU/1000185011/svitino/">2</a> , <a href="http://www.esosedi.ru/onmap/svitino/3711742/index.html">3</a> , <a href="http://www.esosedi.ru/onmap/svitino/9586330/index.html">4</a> ) Svitino and all are approximately in one place, but two of them are in Moscow, one in the Moscow region, and one more in Kaluga. <br></blockquote><br>  A geocoder is a simple mechanism for searching the database, which means it can give a little bit of the wrong object that you want.  For example, because there is actually no searchable (remember Cracovia). <br><br>  It's more fun than it seems.  But!  I!  Finally!  I can sleep well.  What I advise you. <br><br>  Good geo-sharing. <br><br>  PS: In fact, I work on ‚ÄúeCity‚Äù in my spare time.  And the main work is in Yandex.Maps.  And I warned you. <br><br>  PPS: All pictures from <a href="https://instagram.com/fevrony/">fevrony</a> . </div><p>Source: <a href="https://habr.com/ru/post/263863/">https://habr.com/ru/post/263863/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../263849/index.html">Sphinx distribute. Accelerate the search</a></li>
<li><a href="../263853/index.html">Magic of tensor algebra: Part 15 - Motion of a non-free solid</a></li>
<li><a href="../263855/index.html">Operation Potao: Malware Analysis for cyber espionage, part 1</a></li>
<li><a href="../263859/index.html">Automating the ip-network using the tools at hand (Python)</a></li>
<li><a href="../263861/index.html">Alarm, ahtung, attention, whistle all the server</a></li>
<li><a href="../263865/index.html">5G radio interface</a></li>
<li><a href="../263869/index.html">Twisted architecture</a></li>
<li><a href="../263871/index.html">When the program falls only on Wednesdays</a></li>
<li><a href="../263873/index.html">Five ways to optimize code for Android 5.0 Lollipop</a></li>
<li><a href="../263875/index.html">How I gathered the skeleton of the bot to order a taxi in Telegram</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>