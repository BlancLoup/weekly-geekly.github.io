<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Python 3 library for connecting to the ESIA - esia-connector</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="It all started when the Ministry of Communications and Mass Media allowed the public service portal to identify and authenticate users on non-governme...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Python 3 library for connecting to the ESIA - esia-connector</h1><div class="post__text post__text-html js-mediator-article">  It all started when the Ministry of Communications and Mass Media allowed the public service portal to identify and authenticate users on non-governmental websites.  This is implemented using the ESIA service (Unified Identification and Authentication System - <a href="https://esia.gosuslugi.ru/">esia.gosuslugi.ru</a> ).  The customer of our project was among the first 5 participants who submitted applications for integration with ESIA, which expressed for us the task of supporting this integration. <br><br>  In the free access, we did not find an open free solution suitable for our technology stack, so after developing, with the blessing of the customer, we decided to share our own (BSD license). <br><br>  So, we present you the esia-connector project, written in Python 3, using the openssl utility, tested in work only on Debian-based systems. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Package: <a href="https://pypi.python.org/pypi/esia-connector/">pypi.python.org/pypi/esia-connector</a> <br>  Project: <a href="https://github.com/eigenmethod/esia-connector">github.com/eigenmethod/esia-connector</a> <br><a name="habracut"></a><br><br>  What is ESIA, what opportunities it provides will not tell, only about the possibilities of the current implementation of our library. <br>  esia-connector allows you to: <br><ul><li>  authenticate to the ESIA, get a token in return (which can then be used to identify the user), check it; </li><li>  obtain personal data of the user: full name, identity data of documents (passport, driver's license), contact details (phone numbers, email address), TIN, SNILS, addresses (residence and registration). </li></ul><br><br><h2>  Using </h2><br>  In order to connect to the ESIA using the library you need to have on hand: <br><ol><li>  A certificate issued or self-signed in the format described in the methodological recommendations, downloaded to the test and combat ESIA server. <br><div class="spoiler">  <b class="spoiler_title">Excerpt from the guidelines</b> <div class="spoiler_text">  Issue the key container and the key certificate of the qualified electronic signature for the connected information system (must contain the OGRN LE, being the operator of the information system).  It also supports working with the key container and the unqualified electronic signature key certificate in the X.509 version 3 format. In this case, it is possible to independently generate a key container and a self-signed certificate for your system using the keytool utility from the Java Development Kit.  A certificate is required to identify an IC when interacting with an ESIA.  ESIA supports RSA electronic signature generation algorithms with a key length of 2048 bits and the SHA-256 cryptographic hashing algorithm, as well as the GOST R 34.10-2001 electronic signature algorithm and the GOST R 34.11-94 cryptographic hashing algorithm. <br></div></div></li><li>  Issued by the support service ESIA company account on the combat and test servers.  This must then be specified when creating the EsiaSettings object instead of the ‚ÄúYOUR_SYSTEM_ID‚Äù string. </li><li>  User accounts on test and combat ESIA servers for debugging and testing. </li><li>  Public keys ESIA (test and combat) to verify the received token.  In open access, these keys are not, tech support sends them by email upon request. </li></ol><br><br>  To run a test case (the minimum Flask web application is available in the library repository) you need <br>  The certificate previously uploaded to the ESIA server is placed in the file ‚Äúesia-connector / examples / res / test.crt‚Äù.  In the same directory, place your private key under the name ‚Äútest.key‚Äù, and place the above mentioned public key under the name ‚Äúesia_pub.key‚Äù. <br>  Then run the Flask application, from the examples directory: <br><pre><code class="python hljs">python flask_app.py</code> </pre> <br><br>  On the main page, we will see a well-formed link for accessing the ESIA, when clicking on it, the ESIA server will process the data in a GET request, ask the user for the username and password for the ESIA, then after a successful introduction, ask for permission to access our application to the ESIA and, in in the case of issuing a permit, redirect to the page specified in the test example, where we, with the token already received, will make a couple more requests to receive personal data of the user on whose behalf we make the request, and display this data on the same page  . <br><br><div class="spoiler">  <b class="spoiler_title">Esia-connector usage example</b> <div class="spoiler_text"><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> os <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> flask <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> Flask, request <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> esia_connector.client <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> EsiaSettings, EsiaAuth <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">get_test_file</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(name)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> os.path.join(os.path.dirname(__file__), <span class="hljs-string"><span class="hljs-string">'res'</span></span>, name) TEST_SETTINGS = EsiaSettings(esia_client_id=<span class="hljs-string"><span class="hljs-string">'YOUR SYSTEM ID'</span></span>, redirect_uri=<span class="hljs-string"><span class="hljs-string">'http://localhost:5000/info'</span></span>, certificate_file=get_test_file(<span class="hljs-string"><span class="hljs-string">'test.crt'</span></span>), private_key_file=get_test_file(<span class="hljs-string"><span class="hljs-string">'test.key'</span></span>), esia_token_check_key=get_test_file(<span class="hljs-string"><span class="hljs-string">'esia_pub.key'</span></span>), esia_service_url=<span class="hljs-string"><span class="hljs-string">'https://esia-portal1.test.gosuslugi.ru'</span></span>, esia_scope=<span class="hljs-string"><span class="hljs-string">'openid http://esia.gosuslugi.ru/usr_inf'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">assert</span></span> TEST_SETTINGS.esia_client_id != <span class="hljs-string"><span class="hljs-string">'YOUR SYSTEM ID'</span></span>, <span class="hljs-string"><span class="hljs-string">"Please specify real system id!"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">assert</span></span> os.path.exists(TEST_SETTINGS.certificate_file), <span class="hljs-string"><span class="hljs-string">"Please place your certificate in res/test.crt !"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">assert</span></span> os.path.exists(TEST_SETTINGS.private_key_file), <span class="hljs-string"><span class="hljs-string">"Please place your private key in res/test.key!"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">assert</span></span> os.path.exists(TEST_SETTINGS.esia_token_check_key), <span class="hljs-string"><span class="hljs-string">"Please place ESIA public key in res/esia_pub.key !"</span></span> app = Flask(__name__) esia_auth = EsiaAuth(TEST_SETTINGS) @app.route(<span class="hljs-string"><span class="hljs-string">"/"</span></span>) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">hello</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function">:</span></span> url = esia_auth.get_auth_url() <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">'Start here: &lt;a href="{0}"&gt;{0}&lt;/a&gt;'</span></span>.format(url) @app.route(<span class="hljs-string"><span class="hljs-string">"/info"</span></span>) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">process</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function">:</span></span> code = request.args.get(<span class="hljs-string"><span class="hljs-string">'code'</span></span>) state = request.args.get(<span class="hljs-string"><span class="hljs-string">'state'</span></span>) esia_connector = esia_auth.complete_authorization(code, state) inf = esia_connector.get_person_main_info() <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">"%s"</span></span> % inf <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> __name__ == <span class="hljs-string"><span class="hljs-string">"__main__"</span></span>: app.run()</code> </pre><br></div></div><br><br><h2>  Implementation </h2><br>  The library device is trivial, does not require comments, after writing it became clear that it would be possible to design and better that the user of the library was required to perform fewer actions with its interface. <br>  It is worth noting that the openssl utility is used for signing, therefore there is an extra operation to create a temporary file. <br>  We are satisfied with the current implementation, but it would be better to use pyopenssl. <br><br>  We have no plans for the development of the library until there are requirements in the project, and they are not in the near future. <br>  If you use esia-connector in your projects and add / correct something along the way - PR-ones, we will be happy to include. <br><br>  What could be done: <br><ol><li>  Reorganize the library interface for ease of use. </li><li>  Replace the use of openssl with pyopenssl. </li><li>  Develop functionality for obtaining other data from the ESIA. </li><li>  Support an alternative data exchange protocol implemented in the ESIA (SAML). </li><li>  Implement wrappers for popular frameworks, for example: Django, Flask, possibly as part of individual projects. </li></ol><br><br><h2>  Links </h2><br><ol><li>  Guidelines for the use of ESIA: <a href="http://minsvyaz.ru/ru/documents/4243/">minsvyaz.ru/ru/documents/4243</a> </li><li>  Regulations for information interaction: <a href="http://www.minsvyaz.ru/ru/documents/4244/">www.minsvyaz.ru/ru/documents/4244</a> </li><li>  News about the possibility of integration with ESIA: <a href="http://www.kommersant.ru/doc/2832483">www.kommersant.ru/doc/2832483</a> </li><li>  Open PHP implementation: <a href="https://github.com/fr05t1k/esia">github.com/fr05t1k/esia</a> </li></ol></div><p>Source: <a href="https://habr.com/ru/post/271827/">https://habr.com/ru/post/271827/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../271815/index.html">Today‚Äôs world is amd64, armv7 and aarch64. Everything else is dead, Jim</a></li>
<li><a href="../271817/index.html">"Black Friday" or "Buy Nothing Day"? Your choice? Do not buy dedicated servers in the Netherlands at a 30% discount in addition?</a></li>
<li><a href="../271819/index.html">State management and efficient rendering in React applications</a></li>
<li><a href="../271823/index.html">Network monitoring: how we make sure that large companies have all the nodes</a></li>
<li><a href="../271825/index.html">In 600,000 Arris modems, they found a backdoor in a backdoor</a></li>
<li><a href="../271829/index.html">How we wrote ourselves anew, or how to lose the source code and not give it to mind</a></li>
<li><a href="../27183/index.html">Idiots in my internets.</a></li>
<li><a href="../271831/index.html">Extortion programs on smart TV? You can prepare, they go</a></li>
<li><a href="../271833/index.html">CyberMonday starts at BlackFriday</a></li>
<li><a href="../271835/index.html">We program 1C on Ruby</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>