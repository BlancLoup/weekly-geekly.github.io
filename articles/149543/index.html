<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>An example of the practical use of copulas</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="In the previous article I explained the theoretical rationale for copulas. Since I myself was a student, I know that the best explanation of the theor...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>An example of the practical use of copulas</h1><div class="post__text post__text-html js-mediator-article">  In the previous <a href="http://habrahabr.ru/post/145751/">article</a> I explained the theoretical rationale for copulas.  Since I myself was a student, I know that the best explanation of the theoretical apparatus can serve as an example of its practical application.  Therefore, in this article I will try to show how copulas are used to model the interdependencies of several random variables. <br><img src="https://habrastorage.org/storage2/bfd/fd8/fb9/bfdfd8fb9c381ad55f1002c808d6731e.jpg"><br><a name="habracut"></a><br><h3>  Again a bit of theory </h3><br>  As already mentioned, many copulas can reflect the dependence of not only two, but several quantities at once.  This, of course, is good, but standard copulas imply some symmetry, that is, all pairwise dependencies will have the same pattern.  Agree, this is not always true.  To overcome this problem, an interesting and quite obvious (how much torment is hidden behind this word in mathematical analysis) was proposed - we break the joint copula into a set of two-dimensional copulas.  We know that for n variables we will have <img src="https://habrastorage.org/storage2/878/7cb/9c5/8787cb9c52521c6b290dc2cc794559ad.gif">  pairwise interconnections.  That is, we have to determine exactly how many pairwise copulas.  We show that the joint distribution density of 4 values ‚Äã‚Äãcan be expressed as follows: <br><br><img src="https://habrastorage.org/storage2/d9d/a23/8ed/d9da238ed8160b5a5937677216eccc57.png"><br><div class="spoiler">  <b class="spoiler_title">slight evidence</b> <div class="spoiler_text">  To begin with, we recall that the distribution density of several quantities can be expressed as follows: <br><br><img src="https://habrastorage.org/storage2/f03/599/d36/f03599d36d3d691b4ee770fc55eda7c5.gif">
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Also from the definition of a copula, we know that: <br><br><img src="https://habrastorage.org/storage2/bac/5e1/ffc/bac5e1ffc30b590ad4e8e804d76cd030.gif"><br><br>  which in turn can be expressed as follows: <br><br><img src="https://habrastorage.org/storage2/b47/a82/68d/b47a8268d79d64efd57af03cd07ed5c2.gif"><br><br>  For the two-dimensional case, it will look like this: <br><br><img src="https://habrastorage.org/storage2/005/f15/a10/005f15a1067b59747cea899c2804c14c.gif"><br><br>  And combining this with the very first formula, we get: <br><br><img src="https://habrastorage.org/storage2/02f/d65/a3c/02fd65a3caeb04da8f497f22b689a01c.gif"><br><br>  You can extend this example to the three-dimensional case: <br><br><img src="https://habrastorage.org/storage2/1d3/448/bad/1d3448badd8b3dcc99ca3b8ad57eb392.gif"><br><br>  and combining with the previous formula, we get: <br><br><img src="https://habrastorage.org/storage2/6fd/74a/7b2/6fd74a7b2a7204f5f9e93ed233a99ec6.gif"><br><br>  Thus, we see that all elements from the first equation can be represented as a product of paired copulas and marginal density. <br></div></div><br>  There are several ways to represent a partition, and the one mentioned above is called the canonical vine (I sincerely apologize, but I did not find an established translation of the ‚Äúcanonical vine‚Äù in the mathematical context, so I will use direct translation).  Graphically, the last equation can be represented as follows: <br><br><img src="https://habrastorage.org/storage2/964/26d/252/96426d25276edb6125dc7ce4b7e8dd5b.png"><br><br>  Three trees describe the partition of a 4-dimensional copula.  In the leftmost tree, the circles are marginal distributions, the arrows are two-dimensional copulas.  Our task, as a person responsible for modeling, is to set all the "arrows", that is, to identify pairwise copulas and their parameters. <br><br>  Now look at the formula of the D-shaped vine: <br><br><img src="https://habrastorage.org/storage2/167/b04/6c5/167b046c580d0e31b1e903c8b5932750.png"><br><br>  and its graphical representation <br><br><img src="https://habrastorage.org/storage2/78e/656/5fc/78e6565fca7154b29d02583410f16f73.png"><br><br>  In fact, canonical and D-vines differ only in the order of determining pairwise dependencies.  One may wonder - ‚Äúhow will I choose the order?‚Äù Or equivalent ‚Äúand which vine should I choose?‚Äù I have an answer to this: in practice, they start with couples that show the greatest interconnection.  The latter is determined by <a href="http://en.wikipedia.org/wiki/Kendall_tau_rank_correlation_coefficient">Kendall‚Äôs tau</a> .  Do not worry - everything will become clearer later when I show a direct practical example. <br><br>  Once you have decided on the order of the definition of copulas, you need to understand which copulas to use for defining relationships (Gauss, Student, Gumbel, or some other).  In principle, there is no exact scientific method.  Someone is looking at the pairwise graphs of the distribution of the ‚Äúarchived‚Äù values ‚Äã‚Äãand determine a copula by eye.  Someone uses Chi-graphics ( <a href="http://cofe.uni-konstanz.de/Papers/dp04_03.pdf">it says how to use them</a> ).  A question of skill and an extensive field for research. <br><br>  After we have decided which copulas to use in pairing, we need to determine their parameters.  This is done by a numerical maximum likelihood method (numerical MLE) using the following algorithms: <br><br><div class="spoiler">  <b class="spoiler_title">Pseudocode for estimating the parameters of canonical vines</b> <div class="spoiler_text"><pre><code class="matlab hljs">Log-likelihood=<span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> <span class="hljs-built_in"><span class="hljs-built_in">i</span></span> = <span class="hljs-number"><span class="hljs-number">1</span></span>:n v(<span class="hljs-number"><span class="hljs-number">0</span></span>,<span class="hljs-built_in"><span class="hljs-built_in">i</span></span>) = x(<span class="hljs-built_in"><span class="hljs-built_in">i</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> <span class="hljs-built_in"><span class="hljs-built_in">j</span></span> = <span class="hljs-number"><span class="hljs-number">1</span></span>:n<span class="hljs-number"><span class="hljs-number">-1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> <span class="hljs-built_in"><span class="hljs-built_in">i</span></span> = <span class="hljs-number"><span class="hljs-number">1</span></span>:nj Log-likelihood = Log-likelihood + L(v(<span class="hljs-built_in"><span class="hljs-built_in">j</span></span><span class="hljs-number"><span class="hljs-number">-1</span></span>,<span class="hljs-number"><span class="hljs-number">1</span></span>), v(<span class="hljs-built_in"><span class="hljs-built_in">j</span></span><span class="hljs-number"><span class="hljs-number">-1</span></span>,<span class="hljs-built_in"><span class="hljs-built_in">i</span></span>+<span class="hljs-number"><span class="hljs-number">1</span></span>), param(<span class="hljs-built_in"><span class="hljs-built_in">j</span></span>,<span class="hljs-built_in"><span class="hljs-built_in">i</span></span>)); <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> <span class="hljs-built_in"><span class="hljs-built_in">j</span></span> == n then <span class="hljs-keyword"><span class="hljs-keyword">break</span></span> <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> <span class="hljs-built_in"><span class="hljs-built_in">i</span></span> = <span class="hljs-number"><span class="hljs-number">1</span></span>:nj v(<span class="hljs-built_in"><span class="hljs-built_in">j</span></span>,<span class="hljs-built_in"><span class="hljs-built_in">i</span></span>) = h(v(<span class="hljs-built_in"><span class="hljs-built_in">j</span></span><span class="hljs-number"><span class="hljs-number">-1</span></span>,<span class="hljs-built_in"><span class="hljs-built_in">i</span></span>+<span class="hljs-number"><span class="hljs-number">1</span></span>), v(<span class="hljs-built_in"><span class="hljs-built_in">j</span></span><span class="hljs-number"><span class="hljs-number">-1</span></span>,<span class="hljs-number"><span class="hljs-number">1</span></span>), param(<span class="hljs-built_in"><span class="hljs-built_in">j</span></span>,<span class="hljs-built_in"><span class="hljs-built_in">i</span></span>)); <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-keyword"><span class="hljs-keyword">for</span></span></code> </pre> <br></div></div><br><div class="spoiler">  <b class="spoiler_title">Pseudocode for estimating the parameters of the D-vine</b> <div class="spoiler_text"><pre> <code class="matlab hljs">Log-likelihood=<span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> <span class="hljs-built_in"><span class="hljs-built_in">i</span></span> = <span class="hljs-number"><span class="hljs-number">1</span></span>:n v(<span class="hljs-number"><span class="hljs-number">0</span></span>,<span class="hljs-built_in"><span class="hljs-built_in">i</span></span>) = x(<span class="hljs-built_in"><span class="hljs-built_in">i</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> <span class="hljs-built_in"><span class="hljs-built_in">j</span></span> = <span class="hljs-number"><span class="hljs-number">1</span></span>:n<span class="hljs-number"><span class="hljs-number">-1</span></span> Log-likelihood = Log-likelihood + L(v(<span class="hljs-number"><span class="hljs-number">0</span></span>,<span class="hljs-built_in"><span class="hljs-built_in">i</span></span>),v(<span class="hljs-number"><span class="hljs-number">0</span></span>,<span class="hljs-built_in"><span class="hljs-built_in">i</span></span>+<span class="hljs-number"><span class="hljs-number">1</span></span>), param(<span class="hljs-number"><span class="hljs-number">1</span></span>,<span class="hljs-built_in"><span class="hljs-built_in">i</span></span>)); <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> v(<span class="hljs-number"><span class="hljs-number">1</span></span>,<span class="hljs-number"><span class="hljs-number">1</span></span>) = h(v(<span class="hljs-number"><span class="hljs-number">0</span></span>,<span class="hljs-number"><span class="hljs-number">1</span></span>),v(<span class="hljs-number"><span class="hljs-number">0</span></span>,<span class="hljs-number"><span class="hljs-number">2</span></span>), param(<span class="hljs-number"><span class="hljs-number">1</span></span>,<span class="hljs-number"><span class="hljs-number">1</span></span>)) <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> k = <span class="hljs-number"><span class="hljs-number">1</span></span>:n<span class="hljs-number"><span class="hljs-number">-3</span></span> v(<span class="hljs-number"><span class="hljs-number">1</span></span>,<span class="hljs-number"><span class="hljs-number">2</span></span>k) = h(v(<span class="hljs-number"><span class="hljs-number">0</span></span>,k+<span class="hljs-number"><span class="hljs-number">2</span></span>), v(<span class="hljs-number"><span class="hljs-number">0</span></span>,k+<span class="hljs-number"><span class="hljs-number">1</span></span>), param(<span class="hljs-number"><span class="hljs-number">1</span></span>,k+<span class="hljs-number"><span class="hljs-number">1</span></span>)); v(<span class="hljs-number"><span class="hljs-number">1</span></span>,<span class="hljs-number"><span class="hljs-number">2</span></span>k+<span class="hljs-number"><span class="hljs-number">1</span></span>) = h(v(<span class="hljs-number"><span class="hljs-number">0</span></span>,k+<span class="hljs-number"><span class="hljs-number">1</span></span>), v(<span class="hljs-number"><span class="hljs-number">0</span></span>,k+<span class="hljs-number"><span class="hljs-number">2</span></span>), param(<span class="hljs-number"><span class="hljs-number">1</span></span>,k+<span class="hljs-number"><span class="hljs-number">1</span></span>)); <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> v(<span class="hljs-number"><span class="hljs-number">1</span></span>,<span class="hljs-number"><span class="hljs-number">2</span></span>n<span class="hljs-number"><span class="hljs-number">-4</span></span>) = h(v(<span class="hljs-number"><span class="hljs-number">0</span></span>,n), v(<span class="hljs-number"><span class="hljs-number">0</span></span>,n<span class="hljs-number"><span class="hljs-number">-1</span></span>), param(<span class="hljs-number"><span class="hljs-number">1</span></span>,n<span class="hljs-number"><span class="hljs-number">-1</span></span>)); <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> <span class="hljs-built_in"><span class="hljs-built_in">j</span></span> = <span class="hljs-number"><span class="hljs-number">2</span></span>:n<span class="hljs-number"><span class="hljs-number">-1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> <span class="hljs-built_in"><span class="hljs-built_in">i</span></span> = <span class="hljs-number"><span class="hljs-number">1</span></span>:nj Log-likelihood = Log-likelihood + L(v(<span class="hljs-built_in"><span class="hljs-built_in">j</span></span><span class="hljs-number"><span class="hljs-number">-1</span></span>,<span class="hljs-number"><span class="hljs-number">2</span></span><span class="hljs-built_in"><span class="hljs-built_in">i</span></span><span class="hljs-number"><span class="hljs-number">-1</span></span>),v(<span class="hljs-built_in"><span class="hljs-built_in">j</span></span><span class="hljs-number"><span class="hljs-number">-1</span></span>,<span class="hljs-number"><span class="hljs-number">2</span></span><span class="hljs-built_in"><span class="hljs-built_in">i</span></span>), param(<span class="hljs-built_in"><span class="hljs-built_in">j</span></span>,<span class="hljs-built_in"><span class="hljs-built_in">i</span></span>)); <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> <span class="hljs-built_in"><span class="hljs-built_in">j</span></span> == n<span class="hljs-number"><span class="hljs-number">-1</span></span> then <span class="hljs-keyword"><span class="hljs-keyword">break</span></span> <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> v(<span class="hljs-built_in"><span class="hljs-built_in">j</span></span>,<span class="hljs-built_in"><span class="hljs-built_in">i</span></span>) = h(v(<span class="hljs-built_in"><span class="hljs-built_in">j</span></span><span class="hljs-number"><span class="hljs-number">-1</span></span>,<span class="hljs-number"><span class="hljs-number">1</span></span>), v(<span class="hljs-built_in"><span class="hljs-built_in">j</span></span><span class="hljs-number"><span class="hljs-number">-1</span></span>,<span class="hljs-number"><span class="hljs-number">2</span></span>), param(<span class="hljs-built_in"><span class="hljs-built_in">j</span></span>,<span class="hljs-number"><span class="hljs-number">1</span></span>)); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> n &gt; <span class="hljs-number"><span class="hljs-number">4</span></span> then <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> <span class="hljs-built_in"><span class="hljs-built_in">i</span></span> = <span class="hljs-number"><span class="hljs-number">1</span></span>:nj<span class="hljs-number"><span class="hljs-number">-2</span></span> v(<span class="hljs-built_in"><span class="hljs-built_in">j</span></span>,<span class="hljs-number"><span class="hljs-number">2</span></span><span class="hljs-built_in"><span class="hljs-built_in">i</span></span>) = h(v(<span class="hljs-built_in"><span class="hljs-built_in">j</span></span><span class="hljs-number"><span class="hljs-number">-1</span></span>,<span class="hljs-number"><span class="hljs-number">2</span></span><span class="hljs-built_in"><span class="hljs-built_in">i</span></span>+<span class="hljs-number"><span class="hljs-number">2</span></span>),v(<span class="hljs-built_in"><span class="hljs-built_in">j</span></span><span class="hljs-number"><span class="hljs-number">-1</span></span>,<span class="hljs-number"><span class="hljs-number">2</span></span><span class="hljs-built_in"><span class="hljs-built_in">i</span></span>+<span class="hljs-number"><span class="hljs-number">1</span></span>),param(<span class="hljs-built_in"><span class="hljs-built_in">j</span></span>,<span class="hljs-built_in"><span class="hljs-built_in">i</span></span>+<span class="hljs-number"><span class="hljs-number">1</span></span>)); v(<span class="hljs-built_in"><span class="hljs-built_in">j</span></span>,<span class="hljs-number"><span class="hljs-number">2</span></span><span class="hljs-built_in"><span class="hljs-built_in">i</span></span>+<span class="hljs-number"><span class="hljs-number">1</span></span>) = h(v(<span class="hljs-built_in"><span class="hljs-built_in">j</span></span><span class="hljs-number"><span class="hljs-number">-1</span></span>,<span class="hljs-number"><span class="hljs-number">2</span></span><span class="hljs-built_in"><span class="hljs-built_in">i</span></span>+<span class="hljs-number"><span class="hljs-number">1</span></span>),v(<span class="hljs-built_in"><span class="hljs-built_in">j</span></span><span class="hljs-number"><span class="hljs-number">-1</span></span>,<span class="hljs-number"><span class="hljs-number">2</span></span><span class="hljs-built_in"><span class="hljs-built_in">i</span></span>+<span class="hljs-number"><span class="hljs-number">2</span></span>),param(<span class="hljs-built_in"><span class="hljs-built_in">j</span></span>,<span class="hljs-built_in"><span class="hljs-built_in">i</span></span>+<span class="hljs-number"><span class="hljs-number">1</span></span>)); <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> v(<span class="hljs-built_in"><span class="hljs-built_in">j</span></span>,<span class="hljs-number"><span class="hljs-number">2</span></span>n<span class="hljs-number"><span class="hljs-number">-2</span></span><span class="hljs-built_in"><span class="hljs-built_in">j</span></span><span class="hljs-number"><span class="hljs-number">-2</span></span>) = h(v(<span class="hljs-built_in"><span class="hljs-built_in">j</span></span><span class="hljs-number"><span class="hljs-number">-1</span></span>,<span class="hljs-number"><span class="hljs-number">2</span></span>n<span class="hljs-number"><span class="hljs-number">-2</span></span><span class="hljs-built_in"><span class="hljs-built_in">j</span></span>),v(<span class="hljs-built_in"><span class="hljs-built_in">j</span></span><span class="hljs-number"><span class="hljs-number">-1</span></span>,<span class="hljs-number"><span class="hljs-number">2</span></span>n<span class="hljs-number"><span class="hljs-number">-2</span></span><span class="hljs-built_in"><span class="hljs-built_in">j</span></span><span class="hljs-number"><span class="hljs-number">-1</span></span>),param(<span class="hljs-built_in"><span class="hljs-built_in">j</span></span>,nj)) <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-keyword"><span class="hljs-keyword">for</span></span></code> </pre><br></div></div><br>  These are algorithms for calculating the log-likelihood function, which, as is well known, must be maximized.  This is a task for various optimization packages.  It requires a small explanation of the variables used in the "code": <br><br>  x is a set of ‚Äúarchived‚Äù data of size T by n, where x is limited on the interval (0,1). <br>  v - matrix of size T on n-1 on n-1, where intermediate data will be loaded. <br>  param - paired copula parameters, which we are looking for, maximizing the Log-likelihood. <br>  L (x, v, param) = <img src="https://habrastorage.org/storage2/cd4/509/646/cd450964654b41b51b6e21362ee0d5f2.png"><br>  h (x, v, param) = <img src="https://habrastorage.org/storage2/176/859/a09/176859a099ffd109d612e1cf6cc02821.png"><br>  Fans of spoiling the paper with their calculations may not open the next spoiler, where I introduced the h-functions of the main copulas. <br><div class="spoiler">  <b class="spoiler_title">h-functions</b> <div class="spoiler_text"><img src="https://habrastorage.org/storage2/018/631/571/01863157133482f676141b9f7cbd3187.png"><br><br><img src="https://habrastorage.org/storage2/cca/1ab/aad/cca1abaad2c2ba51ce62e16ae4e085ad.png"><br><br><img src="https://habrastorage.org/storage2/614/88b/5d5/61488b5d5142f998337e01e3577fa2ae.png"><br><br><img src="https://habrastorage.org/storage2/605/552/019/6055520194555dedf6bb1d736951e8fe.png"><br></div></div><br>  After we have found the parameters of our copulas, which maximize the logarithm likelihood function, we can proceed to the generation of random variables that have the same structure of interrelations as our initial data.  For this, there are also algorithms: <br><div class="spoiler">  <b class="spoiler_title">Pseudocode for generating data on canonical vines</b> <div class="spoiler_text"><pre> <code class="matlab hljs">w = <span class="hljs-built_in"><span class="hljs-built_in">rand</span></span>(n,<span class="hljs-number"><span class="hljs-number">1</span></span>); <span class="hljs-comment"><span class="hljs-comment">%  n    x(1) = v(1,1) = w(1); for i = 2:n v(i,1) = w(i); for k = i-1:1 v(i,1) = h_inv(v(i,1), v(k,k), param(k,ik)); %  ,     . end for x(i) = v(i,1); if i = n then break end if for j = 1:i-1 v(i,j+1) = h(v(i,j), v(j,j), param(j,ij)); end for end for</span></span></code> </pre><br></div></div><br><div class="spoiler">  <b class="spoiler_title">Pseudocode to generate D-Vine data</b> <div class="spoiler_text"><pre> <code class="matlab hljs">w = <span class="hljs-built_in"><span class="hljs-built_in">rand</span></span>(n,<span class="hljs-number"><span class="hljs-number">1</span></span>); <span class="hljs-comment"><span class="hljs-comment">%  n    x(1) = v(1,1) = w(1); x(2) = v(2,1) = h_inv(w(2), v(1,1), param(1,1)); v(2,2) = h(v(1,1), v(2,1), param(1,1)); for i = 3:n v(i,1) = w(i); for k = i-1:2 v(i,1) = h_inv(v(i,1), v(i-1,2k-2), param(k,ik)); end for v(i,1) = h_inv(v(i,1), v(i-1,1), param(k,i-1)); x(i) = v(i,1); if i == n break end if v(i,2) = h(v(i-1,1), v(i,1), param(1,i-1)); v(i,3) = h(v(i,1), v(i-1,1), param(1,i-1)); if i&gt;3 for j = 2:i-2 v(i,2j) = h(v(i-1,2j-2), v(i,2j-1), param(j,ij)); v(i,2j+1) = h(v(i,2j-1), v(i-1,2j-2), param(j,ij)); end for end if v(i,2i-2) = h(v(i-1,2i-4), v(i,2i-3), param(i-1,1)); end for</span></span></code> </pre><br></div></div><br>  You use the parameters that you obtained using the model estimation algorithms and generate n variables.  You run this algorithm T times and get a matrix T by n, the data in which have the same pattern of interrelations as the original data.  The only innovation compared with the previous algorithms is the inverse h-function (h_inv), which is the inverse function of the conditional distribution on the first variable. <br><br>  Again, let me save you from lengthy calculations: <br><div class="spoiler">  <b class="spoiler_title">inverse h-functions</b> <div class="spoiler_text"><img src="https://habrastorage.org/storage2/fbc/2c3/92f/fbc2c392fbf9c9bfd4f0116ce6e6fb91.png"><br><br><img src="https://habrastorage.org/storage2/8a7/e3e/34e/8a7e3e34e2dc30abf30ba06712bf604e.png"><br><br><img src="https://habrastorage.org/storage2/d0d/fe1/e36/d0dfe1e363a6fffa19623e2e46577e04.png"><br></div></div><br>  That's basically it.  And now the promised ... <br><br><h3>  Practical example </h3><br>  1. For example, I decided to play a small bank clerk, who was told to count the daily VaR in his portfolio.  In the courtyard on January 1, 2012 and in my portfolio shares of 4 companies are in equal shares: 3M (MMM), Exxon Mobil (XOM), Ford Motors (F) and Toyota Motors (TM).  Having played for the good i-tishniki, trying to get them to download price history from our server for the last 6 years, I realized that they had no time (January 1 outside, who generally works ???) and unloaded this information from Yaha's server.  I took the price history by day for the period from January 3, 2005 to December 31, 2011.  The result was a matrix of 1763 by 4. <br><img src="https://habrastorage.org/storage2/48f/1c9/f50/48f1c9f50686c3f6f71bfd49819a6aac.png"><br><br>  2. Found logs: <img src="https://habrastorage.org/storage2/fe6/8c8/fb3/fe68c8fb30ee75625fc3553db36e5b24.png">  and built their pairwise distribution. <br><img src="https://habrastorage.org/storage2/1f5/4eb/5ed/1f54eb5ed0f4d234332bcc5c44c79b25.png"><br>  Well, to present the big picture. <br><br>  3. Then I remembered the lectures on finance and how they hammered us - ‚Äúguys, then the retrins are normally distributed - nonsense;  in real life it's not like that. ‚Äù  I wondered if I should use the assumption that the retrins are distributed along the NIG (Normal Inverse Gaussian).  Studies show that this distribution fits well with empirical data.  But I need to come up with a model for calculating VaR, and then test it on historical data.  Any model that does not take into account the clustering of the second moment will show poor results.  Then the idea came - I will use GARCH (1,1).  The model well captures 3 and 4 moments of distribution, plus takes into account the volatility of the second moment.  So, I decided that my retrins follow the following law <img src="https://habrastorage.org/storage2/8c5/96c/2cb/8c596c2cb06a286bed86b34c07394a6a.png">  .  Here c is the historical average, z is a standard normally distributed random variable, and sigma follows its own law: <img src="https://habrastorage.org/storage2/38c/57d/260/38c57d260598d39ab05ed6054a3d8df9.png">  . <br><br>  4. So, now we need to take into account the interdependence of these four stocks.  For a start, I used empirical copulas and plotted pairwise dependencies of ‚Äúarchived‚Äù observations: <br><img src="https://habrastorage.org/storage2/5f1/d62/811/5f1d62811c46fb466dd24f4749978e49.png"><br>  Considering that today is January 1, and I am a lazy little beast, I decided that all the patterns here are similar to Student‚Äôs copula, but in order to better convey interdependencies, I decided not to use the 4-dimensional copula, but to break it all into six 2-dimensional copulas. <br><br>  5. In order to break into pair copulas, you need to choose the order of presentation - canonical or D-vine.  For this, I counted tau kendall to determine the level of interdependence: <br><img src="https://habrastorage.org/storage2/ce0/0c3/30e/ce00c330e7106e2d2725a53e3d3e55cf.png"><br>  It is easy to see that MMM has the strongest ties with all other companies.  This predetermines our choice of the vine - canonical.  Why?  Press PageUp a couple of times and look at its graphic display.  In the first tree, all arrows emanate from the same node - it is our situation when one company has the strongest ties.  If Kendall's high tau in the last table were on different lines and different columns, we would choose D-vine. <br><br>  6. So, we have determined the order of presentation and all the necessary pairwise copulas - we can proceed to the evaluation of parameters.  Applying the above algorithm for estimating the parameters of the canonical vine, I found all the necessary parameters. <br><br>  7. Here I will explain a little how this all happened in the context of backtesting.  In order to check how much my model believes VaR is plausible, I would like to see how she coped in the past.  For this, I gave her a small head start - 500 days and, starting from 501 days, I considered my risk metrics for the next day.  Having copula parameters on my hands, I generated 10,000 quadruples of uniformly distributed values, received four quadrants of standard normally distributed quantities (noise) from them and substituted the formula of 3 points from this example into the calculation formula.  There I also inserted a sigma forecast for the GARCH (1,1) model using data from previous days (this was done using a combination of matlabovskih functions ugarch and ugarchpred) and historical averages.  Having thus received 10,000 quadruples of stocks, I received 10,000 retrans of my portfolio, taking the arithmetic mean of the stocks of stocks. <img src="https://habrastorage.org/storage2/b81/5fa/24b/b815fa24b7d3de036acf8c6528dde9e3.png">  (since we have equal shares and logs, we have the right to do so).  Then sort and select the 50th, 100th, and 500th values ‚Äã‚Äãfor the 99.5%, 99%, and 95% thresholds, respectively.  Having calculated the risk of the metrics for the remaining 1263 days, I received a beautiful graph and statistics of the level breakouts. <br><br><img src="https://habrastorage.org/storage2/fc1/e7e/39b/fc1e7e39ba81380f8dd8a5117ad71b76.png"><br><br><img src="https://habrastorage.org/storage2/ede/9b5/be8/ede9b5be8cb2242ef42809a506df9e51.png"><br><br><div class="spoiler">  <b class="spoiler_title">How to calculate p-value for VaR breakdown statistics</b> <div class="spoiler_text">  In 1995, Comrade Kupich proposed a formula for calculating the reliability of the VaR calculation model: <br><img src="https://habrastorage.org/storage2/3e2/1c9/0f7/3e21c90f7c7751f4517c94632cb73df3.png"><br>  Here x is the number of breakdowns by model, T is the number of tests (we have = 1263), p is the expected share of breakdowns (in our case, 0.5%, 1% and 5%). <br>  By the null hypothesis, this statistic has a <a href="http://ru.wikipedia.org/wiki/%25D0%25A0%25D0%25B0%25D1%2581%25D0%25BF%25D1%2580%25D0%25B5%25D0%25B4%25D0%25B5%25D0%25BB%25D0%25B5%25D0%25BD%25D0%25B8%25D0%25B5_%25D1%2585%25D0%25B8-%25D0%25BA%25D0%25B2%25D0%25B0%25D0%25B4%25D1%2580%25D0%25B0%25D1%2582">chi-square distribution</a> with one degree of freedom.  Finding statistics, it is easy to count its p-value. <br></div></div><br>  In principle, there is still room for growth in accuracy.  But if we take as a benchmark model without taking into account interdependencies in general, then there are generally joints: <br><br><img src="https://habrastorage.org/storage2/ffb/9cb/c32/ffb9cbc32a6159adcd5746dc65807e34.png"><br><br><img src="https://habrastorage.org/storage2/afb/c44/0f4/afbc440f4d78031c0b08867da43cec12.png"><br><br>  For honesty, you need to show how the model behaved if we used correlations and generated noises to calculate retterns from a multidimensional normal distribution: <br><img src="https://habrastorage.org/storage2/152/8ec/514/1528ec5145156d729f0136c5750f4078.png"><br><br><img src="https://habrastorage.org/storage2/921/794/84d/92179484de555e49f59928c1e5e306a1.png"><br><br>  As you can see, for VaR 95% this model is even better than ours.  But the farther, the worse - as already mentioned, the normal distribution does not seize the tails. <br><br>  In general, copulas can be used, but this must be done wisely.  They provide more opportunities to take into account interdependencies, but, as with any exact model, you need to be careful here - you have the opportunity to miss the assumptions and get results worse than from the standard model. <br><br>  PS Not once I noticed a stupid language behind me, so I will be glad if you point me to such moments in the text.  I tried to express my thoughts as clearly as possible, but I do not always succeed. </div><p>Source: <a href="https://habr.com/ru/post/149543/">https://habr.com/ru/post/149543/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../149534/index.html">Opinion MTS on the abolition of domestic roaming</a></li>
<li><a href="../149537/index.html">Spy glasses do it yourself</a></li>
<li><a href="../149539/index.html">Hard prioritization, or the first 5 steps to an excellent application for Windows 8. Navigation</a></li>
<li><a href="../149540/index.html">Restoring a netbook to factory settings</a></li>
<li><a href="../149542/index.html">About time accounting in software development projects</a></li>
<li><a href="../149545/index.html">Deploy cron to Windows</a></li>
<li><a href="../149546/index.html">C # and AutoCAD. Some work practices</a></li>
<li><a href="../149547/index.html">Sberbank allocated 1.6 million rubles for prizes to mobile application developers</a></li>
<li><a href="../149548/index.html">‚ÄúSimple Business‚Äù Version 1.7. - A simple agent becomes even more convenient for managing your business.</a></li>
<li><a href="../149551/index.html">Scaling and development features for SQL Database</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>