<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Search for application performance issues with NodeJs (with examples)</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Because of the single-threaded Node.js architecture, it is important to be alert to the high performance of your application and to avoid bottlenecks ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Search for application performance issues with NodeJs (with examples)</h1><div class="post__text post__text-html js-mediator-article"><p>  Because of the single-threaded Node.js architecture, it is important to be alert to the high performance of your application and to avoid bottlenecks in the code that can lead to subsidence in performance and take away valuable CPU resources from the server application. <br>  This article will discuss how to monitor the CPU load of a nodejs application, detect resource-intensive code areas, and solve possible problems with a 100% CPU core load. </p><a name="habracut"></a><br><img src="https://hsto.org/files/d73/188/3c6/d731883c64dd45baa761c17a53f42759.png" alt="image"><br><h2>  1. CPU profiling of the application.  Instruments </h2><br><p>  Fortunately, the developers have handy tools for detecting and visualizing the hot spots of the CPU load. </p><br><h3>  Chrome DevTools Inspector </h3><br><p> First of all, this is a profiler built into <b>Chrome DevTools</b> that will communicate with the NodeJs application via WebSocket (standard port <code>9229</code> ). </p><br><p>  Run the nodejs application with the - <b>inspect</b> flag </p><br><p>  (the default port will be the standard port <code>9229</code> , which can be changed via <code>--inspect=&lt;&gt;</code> ). </p><br><p>  If the NodeJs server is in the docker container, you need to run the node with <code>--inspect=0.0.0.0:9229</code> and open the port in the <code>Dockerfile</code> or <code>docker-compose.yml</code> </p><br><p>  Open your browser <b>chrome: // inspect</b> <br></p><br><img src="https://raw.githubusercontent.com/ukrbublik/nodejs-debug-notes/master/resources/0-a-inspector.png" alt="image"><br><br>  Find your application in <code>‚ÄúRemote Target‚Äù</code> and click <code>‚Äúinspect‚Äù</code> . <br><p>  An inspector window will open, similar to the standard ‚Äúbrowser‚Äù Chrome DevTools. <br>  We are interested in the <code>‚ÄúProfiler‚Äù</code> tab, in which you can record a CPU profile at any time the application is running: <br></p><br><img src="https://raw.githubusercontent.com/ukrbublik/nodejs-debug-notes/master/resources/0-b-profiler.png" alt="image"><br><br>  After the recording, the collected information will be presented in a convenient tabular-tree form with an indication of the working hours of each function in ms and% of the total recording time (see below). <br><p>  Take for experiments a simple application (you can clone <a href="https://github.com/ukrbublik/nodejs-debug-notes/tree/master/0-profiling">from here</a> ) that exploits a bottleneck in either the <a href="https://www.npmjs.com/package/cycle">cycle</a> (used in another popular lib <a href="">winston v2.x</a> ) to emulate a JS code with a high CPU load. </p><br><p>  We will compare the work of the original cycle and my <a href="">revised version</a> . </p><br><p>  Install the application, run through <code>npm run inspect</code> .  Open the inspector, start recording the CPU profile.  In the opened page <code>http://localhost:5001/</code> click <code>"Run CPU intensive task"</code> , after completion (alert with the text ‚Äúok‚Äù) complete the recording of the CPU profile.  As a result, you can see a picture that indicates the most voracious <code>runOrigDecycle()</code> in this case, <code>runOrigDecycle()</code> and <code>runFixedDecycle()</code> , compare their%): <br></p><br><img src="https://raw.githubusercontent.com/ukrbublik/nodejs-debug-notes/master/resources/0-c-cpu-profile-tree-2.png" alt="image">
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h3>  NodeJs Profiler </h3><br><p>  Another option is to use the profiler built into NodeJs to create CPU performance reports.  Unlike the inspector, it will show data for the entire time the application is running. </p><br><p>  Run the nodejs application with the <b>--prof</b> flag </p><br><p>  In the application folder, a file of the form <code>isolate-0xXXXXXXX-v8.log</code> will be created, in which data about ‚Äúticks‚Äù will be written. </p><br><p>  The data in this file is inconvenient for analysis, but from it you can generate a human-readable report using the command <br> <code>node --prof-process &lt; isolate-*-v8.log&gt;</code> </p> <br><p>  An example of such a report for a test application is higher <a href="https://raw.githubusercontent.com/ukrbublik/nodejs-debug-notes/master/resources/0-d-prof-report.txt">here</a> <br>  (To generate it yourself, run <code>npm run prof</code> ) </p><br><p>  There are also some npm packages for profiling - <a href="https://github.com/node-inspector/v8-profiler">v8-profiler</a> <a href="https://github.com/node-inspector/v8-profiler"><br></a>  that provides a JS interface to the profiler API V8, as well as a node-inspector (deprecated after the release of the profiler built into Chrome DevTools-based). </p><br><h2>  2. Solving the problem of a blocking JS code without an inspector </h2><br><p>  Suppose it so happened that an infinite loop crept into the code or another error leading to a complete blocking of the execution of the JS code on the server.  In this case, a single NodeJs thread will be blocked, the server will stop responding, and the CPU core load will reach 100%.  If the inspector is not started yet, then launching it will not help you to catch the guilty piece of code. </p><br><p>  In this case, <a href="https://www.gnu.org/software/gdb/">gdb</a> debugger can help. </p><br><p>  For docker you need to use <br> <code>--cap-add=SYS_PTRACE</code> <br>  and install packages <br> <code>apt-get install libc6-dbg libc-dbg gdb valgrind</code> <br>  So, you need to connect to the nodejs process (knowing its pid): <br> <code>sudo gdb -p &lt;pid&gt;</code> </p> <br><p>  After connecting, enter the commands: </p><br><pre> <code class="bash hljs">b v8::internal::Runtime_StackGuard p <span class="hljs-string"><span class="hljs-string">'v8::Isolate::GetCurrent'</span></span>() p <span class="hljs-string"><span class="hljs-string">'v8::Isolate::TerminateExecution'</span></span>(<span class="hljs-variable"><span class="hljs-variable">$1</span></span>) c p <span class="hljs-string"><span class="hljs-string">'v8::internal::Runtime_DebugTrace'</span></span>(0, 0, (void *)(<span class="hljs-variable"><span class="hljs-variable">$1</span></span>)) quit</code> </pre> <br><p>  I will not go into the details of what each team is doing, I can only say that it uses some internal functions of the <a href="https://github.com/v8/v8">V8 engine</a> . </p><br><p>  As a result, the execution of the current blocking JS code in the current ‚Äútick‚Äù will be stopped, the application will continue its work (if you use Express, the server will be able to process incoming requests further), and the trace trace will be output to the standard output stream of the NodeJs application. </p><br><p>  It is <a href="https://github.com/ukrbublik/nodejs-debug-notes/blob/master/resources/1-gdb-stack-trace.txt">quite long</a> , but you can find useful information in it - the call stack of JS functions. </p><br><p>  Find lines of this type: </p><br><pre> <code class="bash hljs">--------- sourcecode --------- <span class="hljs-keyword"><span class="hljs-keyword">function</span></span> <span class="hljs-function"><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">infLoopFunc</span></span></span></span>() {\x0a //this will lock server\x0a <span class="hljs-keyword"><span class="hljs-keyword">while</span></span>(1) {;}\x0a} -----------------------------------------</code> </pre> <br><p>  They should help identify the ‚Äúguilty‚Äù code. </p><br><p>  For convenience, I wrote a script to automate this process with recording the call stack in a separate log file: <a href="">loop-terminator.sh</a> </p><br><p>  See also the <a href="https://github.com/ukrbublik/nodejs-debug-notes/tree/master/1-break-inf-loop">sample application</a> with its intuitive use. </p><br><h2>  3. Update NodeJs (and npm packages) </h2><br><p>  Sometimes you are not to blame :) </p><br><p>  I stumbled upon a funny bug in nodejs &lt;v8.5.0 (checked at 8.4.0, 8.3.0), which, under certain circumstances, causes a 100% load on 1 of the CPU core. <br>  The code for a simple application to repeat this bug <a href="https://github.com/ukrbublik/nodejs-debug-notes/tree/master/2-ws-bug">is here</a> . </p><br><p>  The idea is that the application starts the WebSocket server (on <a href="https://socket.io/">socket-io</a> ) and starts one child process via <code>child_process.fork()</code> .  The following sequence of actions is guaranteed to cause 100% load on 1 CPU core: </p><br><ol><li>  Client connects to WS-North </li><li>  The child process is terminated and re-created. </li><li>  Client disconnects from WS </li></ol><br><p>  Moreover, the application is still working, Express server responds to requests. <br>  Probably, the bug is in <code>libuv</code> , and not in the node itself.  I did not find the true reason for this bug and the commit it correcting in changelog.  Easy ‚Äúgoogle‚Äù led to similar bugs in older versions: </p><br><p>  <a href="https://github.com/joyent/libuv/issues/1099">https://github.com/joyent/libuv/issues/1099</a> <br>  <a href="https://github.com/nodejs/node-v0.x-archive/issues/6271">https://github.com/nodejs/node-v0.x-archive/issues/6271</a> </p><br><p>  The solution is simple - update the node to v8.5.0 +. </p><br><h2>  4. Use child processes </h2><br><p>  If there is a resource-intensive code in your server application, which loads the CPU considerably, making it a separate child process can be a good solution.  For example, it may be server rendering of a React application. </p><br><p>  Create a separate NodeJs application and start it from the main one through <a href="https://nodejs.org/api/child_process.html"><code>child_process.fork()</code></a> .  For communication between processes, use the <code>IPC</code> channel.  Developing a messaging system between processes is fairly easy, because <code>ChildProcess</code> is a descendant of <code>EventEmitter</code> . <br>  But remember that creating too many child NodeJs processes is not recommended. </p><br><p>  Speaking of performance, another equally important metric is RAM consumption.  There are tools and techniques for finding memory leaks, but this is a topic for a separate article. </p></div><p>Source: <a href="https://habr.com/ru/post/344672/">https://habr.com/ru/post/344672/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../344660/index.html">We start containers in Azure</a></li>
<li><a href="../344664/index.html">Artificial intelligence transforms information security, but do not wait for instant change.</a></li>
<li><a href="../344666/index.html">Russian peasant cryptography</a></li>
<li><a href="../344668/index.html">How to be a team leader if you work with people from different food teams</a></li>
<li><a href="../344670/index.html">The story of how P and X game "shared"</a></li>
<li><a href="../344674/index.html">Trading strategy for trading co-integrated stock pairs</a></li>
<li><a href="../344676/index.html">One + One - Blockchain Charity Marketplace</a></li>
<li><a href="../344678/index.html">Japanese poetry in the service of learning English: an application for memorizing the pronunciation of words</a></li>
<li><a href="../344680/index.html">5-minute guide to esoteric programming languages: try to classify them</a></li>
<li><a href="../344682/index.html">Error on the site ... What to do?</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>