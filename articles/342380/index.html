<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Load testing, process automation history</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hi, Habr! I work as a system administrator, combining this business with the organization and conduct of load testing for various projects (both gamin...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Load testing, process automation history</h1><div class="post__text post__text-html js-mediator-article">  Hi, Habr!  I work as a system administrator, combining this business with the organization and conduct of load testing for various projects (both gaming and not so).  It just so happened that only one person is engaged in the load (this is me). <br><br>  In my company, several studios are working at the same time and in order to maintain the quality of each game project each of these studios need to carry out load testing independently of each other, and this has led to the fact that it has become necessary to automate this business to the maximum and minimize manual participation. <br><br>  The process of load testing in my mind is divided into several stages: <br><img src="https://habrastorage.org/webt/qb/wh/-r/qbwh-rktwr7c5uc8ibs5cs--kao.png"><br><a name="habracut"></a><br>  The first three stages are simply an analysis of the system and the development of scripts.  Then begins the most boring and long iterative stage, namely: the testing itself and the analysis of the results, as a result of which, depending on the results, we turn to the most interesting - <b>tuning</b> . 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      But the tuning stage takes a few minutes, but waiting for the results a few hours.  Next you need to collect and analyze the results, which quite recently required a lot of manual work, from which, in fact, I had to get rid of, in order to reduce the whole process to more interesting things: the development of scripts and tuning. <br><br><h2>  Initial data </h2><br>  As a tool for load testing, we (of course) use <a href="http://jmeter.apache.org/">Apache Jmeter</a> . <br><br>  Innogames projects use various protocols that can be easily emulated using this product (of course, often using additional proprietary plugins): http, websockets, protobuf, protobuf + STOMP, and even udp.  Also, thanks to a good load distribution system, we can easily emulate the required number of VUs (virtual users) and traffic.  For example, on one project, it was necessary to raise 65k VUs and make 3000 requests / s. <br><br>  Naturally, like all fashionable offices, we began to run tests using Jenkins CI.  But the problem with the analysis of the results, and most importantly the <b>comparison of the results with the results of previous tests</b> was very relevant.  As well as the problem of online monitoring: tests, of course, run in console mode, we have only console output from jmeter, but I want graphs. <br><br>  At first, as a solution, the <a href="https://wiki.jenkins.io/display/JENKINS/Performance%2BPlugin">Performance plugin for jenkins</a> worked well.  But with the growing number of tests on each project and the emergence of really large files for analysis (a 3-hour test with 3000 requests / s produces a CSG file of 4Gb +), this plugin started working hours and falling into OOM along with Jenkins. <br><br>  The number of projects, data, interested persons grew, it was necessary to do something. <br><br><h2>  Initial decision </h2><br>  The search for the <s>meaning of life of</s> any ready-made solution has not given any result.  Until I came across one article where the author described how using python and <b>pandas</b> (a <a href="http://pandas.pydata.org/">library for data analysis</a> ) analyzed the csv files from Jmeter and plotted graphs.  After reading this and realizing that pandas can easily work with gigabyte files and aggregate the data from them, I wrote a simple script that generated HTML reports with test results and published them in jenkins using the <a href="https://wiki.jenkins.io/display/JENKINS/HTML%2BPublisher%2BPlugin">HTML Publisher plugin</a> . <br><br>  Here is the link to <a href="https://github.com/v0devil/jmeter_jenkins_report_generator">this script</a> , do not look there. <br><br>  At the time this solved the problem.  But it was a very bad decision, with a bunch of loadable images and Java scripts that read local CSV files and built tags. <br><br>  At some time, the reports also began to load for a long time (several minutes), this infuriated everyone and some suggested considering the option of working with one of the well-known SaaS load testing providers, whose service is based on generating load using the free Jmeter, but They sell this business for a lot of money, offering a convenient environment for running tests and analyzing results.  I do not really like these services, although they do a lot for the same Jmeter (for example, BlazeMeter). <br><br>  I must say, I did not understand how they were going to emulate non-standard protocols and raise a large number of VUs, but I liked the <b><i>idea of</i></b> their convenient environment for load testing with all these graphs and reports, as well as the fact that many people can use it at the same time. <br><br>  Keeping pandas in mind, I decided to try to come up with a solution. <br><br><h2>  Decision </h2><br>  Finally, we come to the main topic.  During a considerable time of trial and error, as well as the study of Django, HTML, java-scripts and others, the following solution was born, which I called <b>Innogames Load Testing Center</b> (hereinafter <b>LTC</b> ). <br><br>  You can download and participate in the development of the project (there is a lot to do there) from the official git-hub of the company: <a href="https://github.com/innogames/JMeter-Control-Center">Jmeter Load Testing Center</a> . <br><br>  This is a Django web application and uses Postgres to store data.  For the analysis of data files, the above-mentioned pandas module is used. <br><br>  It consists of the following main components (in the Django language - applications): <br><br><ul><li>  <b>Dashboard</b> is a front page with general information about the latest running tests. </li><li>  <b>Analyzer</b> - here you can build reports and analyze test results. </li><li>  <b>Online</b> - allows you to monitor the tests online </li><li>  <b>Controller</b> - here you can configure and run tests (during development) </li><li>  <b>Administrator</b> - to configure different parameters / variables. </li></ul><br>  At the moment, Jenkins is still here, the Controller application is still in development.  But soon it will be possible to replace Jenkins. <br><br>  Thus, if a user named Hans wants to run a test, he opens Jenkins selects a project and presses a start: <br><br><img src="https://habrastorage.org/webt/g4/uu/mr/g4uumr7xtcbf63zubxj9gx4t5i4.png"><br><br>  After this, Jenkins runs the main instance of Jmeter on the main server (let's call it <b>admin.loadtest</b> , Jenkins and LTC itself are there), as well as Jmeter-servers on one or more remote virtual machines in the required amount (more on that later) and the actual testing process. <br><br>  During the test, a CSV file with JMeter results, as well as another CSV file with monitoring data of remote hosts is created and updated in the $ WORKSPACE folder of the project. <br>  Next, Hans can open LTC and watch the test pass online.  (At this time, the application will parse the above-mentioned CSV files and put them in temporary tables into the database, from which Online draws the charts: <br><br><img src="https://habrastorage.org/webt/m8/6o/is/m86oisz8ihtfda-fczggtbfs_wm.png"><br><br>  Or, this same Hans can wait until the end of the test, when at the end a special script collects all the data into the database and can be used in the Analyzer for analysis and comparison with other results: <br><br><img src="https://habrastorage.org/webt/7k/en/if/7kenifbzerbqqmyzfdsgrecwuw0.png"><br><br>  The last problem remains: there are several projects, projects require different powers for carrying the load (read, they emulate different numbers of VUs), users can run them at the same time, but they may not.  How to distribute the existing 10 virtual machines-generators at all.  You can assign each project for certain generators (at the beginning it was), you can make a schedule or use a blocking plugin for Jenkins, or you can make something clever interesting.  About this below. <br><br><h2>  Common device </h2><br>  As I said, the backend is written on the Django framework.  In developing the frontend, I used all the standard libraries: jquery and bootstrap.  As charts, I needed a solution that easily draws data obtained in JSON format.  Not bad cope with this <a href="http://c3js.org/">c3.js.</a> <br><br>  Tables in the database usually contain a pair of keys and one field with the JSONField () data type.  JSONField is used because later you can easily add new metrics to this table without changing its structure. <br><br>  Thus, a typical model that stores data on response times, the number of errors and other things during one test looks very simple: <br><br><pre><code class="python hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">TestData</span></span></span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">(models.Model)</span></span></span><span class="hljs-class">:</span></span> test = models.ForeignKey(Test) data = JSONField() <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Meta</span></span></span><span class="hljs-class">:</span></span> db_table = <span class="hljs-string"><span class="hljs-string">'test_data'</span></span></code> </pre> <br>  The data in the data field itself is, respectively, JSONs that store information aggregated in one minute: <br><br><img src="https://habrastorage.org/webt/ve/x5/t-/vex5t-ivk3kkgngwkl3zbu6mydg.png"><br><br>  To retrieve data from this table, there is one endpoint in the urls.py file, which calls the function that processes this data and returns conveniently readable JSON: <br>  Endpoint: <br><br><pre> <code class="python hljs">url(<span class="hljs-string"><span class="hljs-string">r'^test/(?P&lt;test_id&gt;\d+)/rtot/$'</span></span>, views.test_rtot),</code> </pre> <br>  Function: <br><br><pre> <code class="python hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">test_rtot</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(request, test_id)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-comment"><span class="hljs-comment">#  timestamp   min_timestamp = TestData.objects. \ filter(test_id=test_id). \ values("test_id").\ aggregate(min_timestamp=Min( RawSQL("((data-&gt;&gt;%s)::timestamp)", ('timestamp',))))['min_timestamp'] #    ,    min_timestamp,     ,   timestamp,   JSON  . d = TestData.objects. \ filter(test_id=test_id). \ annotate(timestamp=(RawSQL("((data-&gt;&gt;%s)::timestamp)", ('timestamp',)) - min_timestamp)). \ annotate(average=RawSQL("((data-&gt;&gt;%s)::numeric)", ('avg',))). \ annotate(median=RawSQL("((data-&gt;&gt;%s)::numeric)", ('median',))). \ annotate(rps=(RawSQL("((data-&gt;&gt;%s)::numeric)", ('count',))) / 60). \ values('timestamp', "average", "median", "rps"). \ order_by('timestamp') data = json.loads( json.dumps(list(d), indent=4, sort_keys=True, default=str)) return JsonResponse(data, safe=False)</span></span></code> </pre> <br>  On the frontend, we have a c3.js graph that refers to this endpoint: <br><br><pre> <code class="javascript hljs"> <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> test_rtot_graph = c3.generate({ <span class="hljs-attr"><span class="hljs-attr">data</span></span>: { <span class="hljs-attr"><span class="hljs-attr">url</span></span>: <span class="hljs-string"><span class="hljs-string">'/analyzer/test/'</span></span> + test_id_1 + <span class="hljs-string"><span class="hljs-string">'/rtot/'</span></span>, <span class="hljs-attr"><span class="hljs-attr">mimeType</span></span>: <span class="hljs-string"><span class="hljs-string">'json'</span></span>, <span class="hljs-attr"><span class="hljs-attr">type</span></span>: <span class="hljs-string"><span class="hljs-string">'line'</span></span>, <span class="hljs-attr"><span class="hljs-attr">keys</span></span>: { <span class="hljs-attr"><span class="hljs-attr">x</span></span>: <span class="hljs-string"><span class="hljs-string">'timestamp'</span></span>, <span class="hljs-attr"><span class="hljs-attr">value</span></span>: [<span class="hljs-string"><span class="hljs-string">'average'</span></span>, <span class="hljs-string"><span class="hljs-string">'median'</span></span>, <span class="hljs-string"><span class="hljs-string">'rps'</span></span>], }, <span class="hljs-attr"><span class="hljs-attr">xFormat</span></span>: <span class="hljs-string"><span class="hljs-string">'%H:%M:%S'</span></span>, <span class="hljs-attr"><span class="hljs-attr">axes</span></span>: { <span class="hljs-attr"><span class="hljs-attr">rps</span></span>: <span class="hljs-string"><span class="hljs-string">'y2'</span></span> }, }, <span class="hljs-attr"><span class="hljs-attr">zoom</span></span>: { <span class="hljs-attr"><span class="hljs-attr">enabled</span></span>: <span class="hljs-literal"><span class="hljs-literal">true</span></span> }, <span class="hljs-attr"><span class="hljs-attr">axis</span></span>: { <span class="hljs-attr"><span class="hljs-attr">x</span></span>: { <span class="hljs-attr"><span class="hljs-attr">type</span></span>: <span class="hljs-string"><span class="hljs-string">'timeseries'</span></span>, <span class="hljs-attr"><span class="hljs-attr">tick</span></span>: { <span class="hljs-attr"><span class="hljs-attr">format</span></span>: <span class="hljs-string"><span class="hljs-string">'%H:%M:%S'</span></span> } }, <span class="hljs-attr"><span class="hljs-attr">y</span></span>: { <span class="hljs-attr"><span class="hljs-attr">padding</span></span>: { <span class="hljs-attr"><span class="hljs-attr">top</span></span>: <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-attr"><span class="hljs-attr">bottom</span></span>: <span class="hljs-number"><span class="hljs-number">0</span></span> }, <span class="hljs-attr"><span class="hljs-attr">label</span></span>: <span class="hljs-string"><span class="hljs-string">'response times (ms)'</span></span>, }, <span class="hljs-attr"><span class="hljs-attr">y2</span></span>: { <span class="hljs-attr"><span class="hljs-attr">min</span></span>: <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-attr"><span class="hljs-attr">show</span></span>: <span class="hljs-literal"><span class="hljs-literal">true</span></span>, <span class="hljs-attr"><span class="hljs-attr">padding</span></span>: { <span class="hljs-attr"><span class="hljs-attr">top</span></span>: <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-attr"><span class="hljs-attr">bottom</span></span>: <span class="hljs-number"><span class="hljs-number">0</span></span> }, <span class="hljs-attr"><span class="hljs-attr">label</span></span>: <span class="hljs-string"><span class="hljs-string">'Requests/s'</span></span>, } }, <span class="hljs-attr"><span class="hljs-attr">bindto</span></span>: <span class="hljs-string"><span class="hljs-string">'#test_rtot_graph'</span></span> });</code> </pre> <br>  As a result, we have this: <br><br><img src="https://habrastorage.org/webt/pr/c9/go/prc9go_ixl97utgsvua7gdpvfyg.png"><br><br>  Actually, the entire application consists of graphs that draw data from the corresponding endpoints on the back end. <br><br>  You can see from the source codes how the whole system works for analyzing tests, then I want to tell you the process of launching a load test in Innogames (and this part is relevant only for our company). <br><br><h2>  Fire! </h2><br><h3>  Load testing environment </h3><br>  As I said, the entire load testing environment consists of one main server, admin.loadtest, and several generatorN.loadtest servers. <br><br>  <b>admin.loadtest</b> is the Debian Linux 9 virtualka, 16 cores / 16 gigs, it runs Jenkins, LTC and other additional unimportant software. <br><br>  <b>The generatorN.loadtest</b> is a bare debian Linux 8 virtual machine, with Java 8 installed. The power is different, but let's say 32 core / 32 gig. <br><br>  On admin.loadtest, Jmeter (the latest version with the most basic plugins) is installed in the <b>/ var / lib / apache-jmeter</b> folder as a pre-built deb distribution. <br><br><h3>  Git </h3><br>  The test plan for each project is in a separate project on our GitLab inside InnoGames, respectively, the developers or QA from each team can make their own corrections.  And each project is configured to work with Git: <br><br><img src="https://habrastorage.org/webt/ie/oj/dk/ieojdk4pqet_ng4npi3sw50glfg.png"><br><br>  Each project consists of: <br><br>  <i>./jmeter_ext_libs/src/</i> <i><br></i>  <i>./test-plan.jmx</i> <i><br></i>  <i>./prepareAccouts.sh</i> <br><br><ul><li>  jmeter_ext_libs - a folder with the source codes of additional plug-ins that are built using Gradle and put in / var / lib / apache-jmeter / lib / ext before each test. </li><li>  test-plan.jmx - test plan </li><li>  * .sh - additional scripts for the preparation of user accounts and other things. </li></ul><br><h3>  Test-plan </h3><br>  Each test plan as a thread group uses the <b>Stepping Thread Group</b> with three variables: thread_count, ramp_up, duration: <br><br><img src="https://habrastorage.org/webt/g0/d4/c0/g0d4c0_i3mwnsmfpiy8yn_s32fc.png"><br><br>  Values ‚Äã‚Äãfor these variables come from Jenkins when you run the test, but first you need to appropriately declare them in the main element of the test plan in the User Defined Variables, like all other parameterized variables.  One of the important ones, let's call it pool - a sequential number is sent to it for each running Jmeter-server in order to subsequently delimit the used data pools (for example, user logins): <br><br><img src="https://habrastorage.org/webt/-x/zo/je/-xzojeaea8opvef4t74ygzdql1q.png"><br><br>  where in $ {__ P (THREAD_COUNT, 1)}: THREAD_COUNT is the name of the variable that comes from Jenkins, 1 is the default value if it does not. <br><br>  Also in each test plan there is a <b>SimpleDataWriter</b> which writes the results of the execution of samplers in a CSV file.  It has the following options activated: <br><br><pre> <code class="xml hljs"> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">time</span></span></span><span class="hljs-tag">&gt;</span></span>true<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">time</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">latency</span></span></span><span class="hljs-tag">&gt;</span></span>true<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">latency</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">timestamp</span></span></span><span class="hljs-tag">&gt;</span></span>true<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">timestamp</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">success</span></span></span><span class="hljs-tag">&gt;</span></span>true<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">success</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">label</span></span></span><span class="hljs-tag">&gt;</span></span>true<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">label</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">code</span></span></span><span class="hljs-tag">&gt;</span></span>true<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">code</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">fieldNames</span></span></span><span class="hljs-tag">&gt;</span></span>true<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">fieldNames</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">bytes</span></span></span><span class="hljs-tag">&gt;</span></span>true<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">bytes</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">threadCounts</span></span></span><span class="hljs-tag">&gt;</span></span> true<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">threadCounts</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre> <br><h3>  Jenkins </h3><br>  Before running the test, each user can set some parameters that are passed to the above-mentioned variables of the Jmeter test plan: <br><br><img src="https://habrastorage.org/webt/cv/4q/zb/cv4qzbxpktyi6ecessvw9eqfv4o.png"><br><br><h4>  Test run </h4><br>  Now for the scripts.  First of all, in the pre-build script we prepare the Jmeter distribution: <br><br><ul><li>  Create a temporary folder like / tmp / jmeter-xvgenq / </li><li>  Copy the main distribution from / var / lib / apache-jmeter / </li><li>  We collect additional plugins from the jmeter_ext_libs folder (if any). </li><li>  Copy the collected * .jar to / tmp / jmeter-xvgenq / </li><li>  The finished temporary distribution Jmeter further we extend to load generators. </li></ul><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#!/bin/bash export PATH=$PATH:/opt/gradle/gradle-4.2.1/bin echo "JMeter home: $JMETER_HOME" JMETER_INDEX=$(cat /dev/urandom | tr -dc 'a-zA-Z0-9' | fold -w 8 | head -n 1) #    JMETER_DIR="/tmp/jmeter-$JMETER_INDEX" echo "JMeter directory: $JMETER_DIR" echo $JMETER_DIR &gt; "/tmp/jmeter_dir$JOB_NAME" mkdir $JMETER_DIR cp -rp $JMETER_HOME* $JMETER_DIR if [ -d "$WORKSPACE/jmeter_ext_libs" ]; then echo "Building additional JMeter lib" cd "$WORKSPACE/jmeter_ext_libs" gradle jar cp ./build/libs/* $JMETER_DIR/lib/ext/ ls $JMETER_DIR/lib/ext/ fi cd $WORKSPACE</span></span></code> </pre> <br>  Next, we return to the last task: we have 10 virtual machines designed to generate load (we also don‚Äôt know if tests from other projects are running) and based on the required total number of emulated threads THREAD_COUNT, you need to run a certain number of Jmeter servers on these virtual machines sufficient to emulate the required load. <br><br>  In our script, this is done using three lines in the Jenkins bash script, which, of course, leads to more serious things the LTC scripts: <br><br><pre> <code class="bash hljs">REMOTE_HOSTS_DATA=`python /var/lib/jltc/manage.py shell -c <span class="hljs-string"><span class="hljs-string">"import controller.views as views; print(views.prepare_load_generators('"</span></span><span class="hljs-variable"><span class="hljs-variable">$JOB_NAME</span></span><span class="hljs-string"><span class="hljs-string">"','"</span></span><span class="hljs-variable"><span class="hljs-variable">$WORKSPACE</span></span><span class="hljs-string"><span class="hljs-string">"','"</span></span><span class="hljs-variable"><span class="hljs-variable">$JMETER_DIR</span></span><span class="hljs-string"><span class="hljs-string">"', '</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$THREAD_COUNT</span></span></span><span class="hljs-string">', '</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$duration</span></span></span><span class="hljs-string">'));"</span></span>` THREADS_PER_HOST=`python -c <span class="hljs-string"><span class="hljs-string">'import json,sys;data=dict('</span></span><span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$REMOTE_HOSTS_DATA</span></span></span><span class="hljs-string">"</span></span><span class="hljs-string"><span class="hljs-string">');print data["threads_per_host"]'</span></span>` REMOTE_HOSTS_STRING=`python -c <span class="hljs-string"><span class="hljs-string">'import json,sys;data=dict('</span></span><span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$REMOTE_HOSTS_DATA</span></span></span><span class="hljs-string">"</span></span><span class="hljs-string"><span class="hljs-string">');print data["remote_hosts_string"]'</span></span>`</code> </pre><br>  So, in the first line: <br><br>  Call the <b>prepare_load_generators</b> function and pass the project name to it, the path to the project workspace directory, the path to the Jmeter temporary distribution (/ tmp / jmeter-xvgenq /) created above, the test duration and, most importantly, the desired total number of emulated threads $ THREAD_COUNT. <br><br>  What happens next you can see in the repository, if in general: <br><br><ul><li>  Based on the given thread_count, the required number of Jmeter-servers - X. is calculated using the formulas invented by me. </li><li>  Next, based on the current load and available memory on the generatorN.loadtest machines on each of these machines, the n-th number of Jmeter-servers is started until their total number is equal to X. </li><li>  For each of the selected generatorN.loadtest, rsync loads that temporary distribution of Jmeter: </li><li>  On each generator, the n-th number of Jmeter-servers is started (obtained in the previous step), we transfer the sequential number pool to each running process, to distribute the data pools (as I wrote earlier): </li><li>  All data about running Jmeter-instances are stored in the database, after the test, all of them will be destroyed on the basis of this data. </li><li>  At the end, the function returns a JSON of the form: </li></ul><br><pre> <code class="hljs objectivec"> { ‚Äúremote_hosts_string‚Äù: ‚Äúgenerator1.loadtest:<span class="hljs-number"><span class="hljs-number">10000</span></span>,generator2.loadtest:<span class="hljs-number"><span class="hljs-number">10000</span></span>, generator2.loadtest:<span class="hljs-number"><span class="hljs-number">10001</span></span>‚Äù, <span class="hljs-string"><span class="hljs-string">"threads_per_host"</span></span>: <span class="hljs-number"><span class="hljs-number">100</span></span> }</code> </pre> <br>  Actually at the moment all Jmeter-servers are running and waiting for the test itself to connect to and start.  Thus, next in the second and third lines we take values ‚Äã‚Äãfrom this JSON and send to the main instance Jmeter, the initial value of THREAD_COUNT is shared between remote jmeter-servers and each has threads_per_host (note that we pass the received value of threads_per_host to THREAD_COUNT) : <br><br><pre> <code class="bash hljs">java -jar -server <span class="hljs-variable"><span class="hljs-variable">$JAVA_ARGS</span></span> <span class="hljs-variable"><span class="hljs-variable">$JMETER_DIR</span></span>/bin/ApacheJmeter.jar -n -t <span class="hljs-variable"><span class="hljs-variable">$WORKSPACE</span></span>/<span class="hljs-built_in"><span class="hljs-built_in">test</span></span>-plan.jmx -R <span class="hljs-variable"><span class="hljs-variable">$REMOTE_HOSTS_STRING</span></span> -GTHREAD_COUNT=<span class="hljs-variable"><span class="hljs-variable">$threads_per_host</span></span> -GDURATION=<span class="hljs-variable"><span class="hljs-variable">$DURATION</span></span> -GRAMPUP=<span class="hljs-variable"><span class="hljs-variable">$RAMPUP</span></span></code> </pre> <br>  where $ JMETER_DIR is the folder with the Jmeter time distribution (/ tmp / jmeter-xvgenq /). <br><br>  For running remote Jmeter-servers, there is its own model.  We save data about what test is running, on which virtual machine, port, id of this process and so on.  All this is necessary to further stop the test, when these same jmeter-servers must be destroyed: <br><br><pre> <code class="python hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">JmeterInstance</span></span></span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">(models.Model)</span></span></span><span class="hljs-class">:</span></span> test_running = models.ForeignKey(TestRunning, on_delete=models.CASCADE) load_generator = models.ForeignKey(LoadGenerator) pid = models.IntegerField(default=<span class="hljs-number"><span class="hljs-number">0</span></span>) port = models.IntegerField(default=<span class="hljs-number"><span class="hljs-number">0</span></span>) jmeter_dir = models.CharField(max_length=<span class="hljs-number"><span class="hljs-number">300</span></span>, default=<span class="hljs-string"><span class="hljs-string">""</span></span>) project = models.ForeignKey(Project, on_delete=models.CASCADE) threads_number = models.IntegerField(default=<span class="hljs-number"><span class="hljs-number">0</span></span>) <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Meta</span></span></span><span class="hljs-class">:</span></span> db_table = <span class="hljs-string"><span class="hljs-string">'jmeter_instance'</span></span></code> </pre><br>  Also on the front page we have special beautiful plates with information about running tests and the status of load generators: <br><br><img src="https://habrastorage.org/webt/48/vc/tw/48vctw63wuo70exizcfib4nkwku.png"><br><br><h4>  Stop the test </h4><br>  After the test, you must destroy all running Jmeter-servers, remove temporary Jmeter-distributions and collect the results. <br><br>  In the post-build script, add: <br><br><pre> <code class="bash hljs">JMETER_DIR=$(cat /tmp/jmeter_dir<span class="hljs-variable"><span class="hljs-variable">$JOB_NAME</span></span>) <span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> <span class="hljs-string"><span class="hljs-string">"Removing Jmeter dir from admin: </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$JMETER_DIR</span></span></span><span class="hljs-string">"</span></span> rm -rf <span class="hljs-variable"><span class="hljs-variable">$JMETER_DIR</span></span> python /var/lib/jltc/manage.py shell -c <span class="hljs-string"><span class="hljs-string">"import controller.views as views; print(views.stop_test_for_project('"</span></span><span class="hljs-variable"><span class="hljs-variable">$JOB_NAME</span></span><span class="hljs-string"><span class="hljs-string">"'))"</span></span></code> </pre> <br>  At the beginning, we remove the temporary distr from the main server, then call the <b>stop_test_for_project</b> function, passing the project name to it.  The function passes through a special table in the database, which stores information about running Jmeter instances and stops them. <br><br>  And the very last step, the collection of results can be done in two ways, run the script: <br><br><pre> <code class="bash hljs">python /var/lib/jltc/datagenerator_linux.py</code> </pre> <br>  Or locally call a web service: <br><br><pre> <code class="bash hljs">curl --data <span class="hljs-string"><span class="hljs-string">"results_dir=</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$JENKINS_HOME</span></span></span><span class="hljs-string">/jobs/</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$JOB_NAME</span></span></span><span class="hljs-string">/builds/</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$BUILD_NUMBER</span></span></span><span class="hljs-string">/"</span></span> http://localhost:8888/controller/parse_results</code> </pre> <br>  At the moment I use the script, it goes over all the jobs in the jenkis folder and compares it with what is in the database, while maintaining consistency. <br><br><h4>  Additionally </h4><br>  In LTC, I built a couple of kronos jobs that collect information about virtual machines and jmeter instances running every N minutes, for example, collecting S0U, S1U, EU and OU for the jmeter server process and then dividing the sum of these metrics by the number of threads running on it - I get the average size of memory consumed by one thread.  The metric is rather strange, and maybe stupid, but it helps to roughly calculate the necessary memory size for the java-process required to emulate a certain number of threads. <br><br><h2>  Conclusion </h2><br>  By itself, many use the built-in reporting system Jmeter, which also does not stand still and is constantly evolving.  If someone needs to store data and compare results between different tests, he can use services like BlazeMeter. <br><br>  In my realities, these services will be quite expensive, and we also have enough capacity to generate load, so I tried to create an ‚Äúinsider‚Äù solution. <br><br>  It already knows a lot, but it‚Äôs far from perfect and it‚Äôs not a matter of opinion.  So now I am in the hope that there are still people with similar problems. <br><br>  Thank you all and good luck. </div><p>Source: <a href="https://habr.com/ru/post/342380/">https://habr.com/ru/post/342380/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../342364/index.html">Digital Transformation: Blockchain in a bank</a></li>
<li><a href="../342366/index.html">Preparing data for analysis correctly</a></li>
<li><a href="../342368/index.html">Introduce the complexity filter questions on the toaster</a></li>
<li><a href="../342370/index.html">Swift is not needed?</a></li>
<li><a href="../342374/index.html">Typical problems of IT start-ups that hinder rapid development, and how to avoid them</a></li>
<li><a href="../342382/index.html">Raiffeisen-Online Short-Lynch</a></li>
<li><a href="../342384/index.html">Kotlin Night Moscow in Avito on November 25</a></li>
<li><a href="../342386/index.html">Build your Security Operation Center of 5 items</a></li>
<li><a href="../342388/index.html">Colorize a black and white photo using a neural network of 100 lines of code</a></li>
<li><a href="../342390/index.html">Russia vs Germany. Inside about the processes of those. support, quality service and Russian hackers</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>