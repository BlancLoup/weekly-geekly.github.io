<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Manage unmanaged and critical monitoring</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="In a strange monastery with its charter do not go. At the next job, my tasks include the creation and subsequent support of workflow on the Alfresco p...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Manage unmanaged and critical monitoring</h1><div class="post__text post__text-html js-mediator-article">  In a strange monastery with its charter do not go.  At the next job, my tasks include the creation and subsequent support of workflow on the Alfresco platform, along with the maintenance of other systems.  Institution with the prescribed rules, well-established customs and practices.  There are no many usual IT things in the infrastructure, but everything works reliably and suits everyone.  As a person with intelligence and the beginnings of education, I will not try to break other people's traditions and globally change anything.  Considering over 500 workplaces, I‚Äôll note some are not always near and the criticality of the created service for the organization, I will do some things in my own way.  These include monitoring and orchestration. <br><a name="habracut"></a><br>  Most of the jobs are located in the building on the 6th floor.  There are remote jobs.  The park is administered by different employees, some places belong to other organizations and may not have an employee responsible for IT at all.  Global network and security in the area of ‚Äã‚Äãresponsibility of specially trained people.  DHCP, DNS, AD if there is something not everywhere.  ITIL / ITSM is just import letters.  Operating systems WindowsXP, WindowsVista, Windows7.  Workplaces can migrate to different parts of the building or outside it with the obligatory change of IP address.  Users work on computers usually with administrator rights, therefore they can change everything, including% COMPUTERNAME%.  It is desirable not to allow the change of the latter.  Used for shared printers. <br><br><h4>  Baseline and Objectives </h4><br>  The goals of the project in monitoring are checking for the availability of web applications, taking parameters with plotting java &amp; postgresql &amp; OS, notifying with rss, sms and voice calls in critical cases. <br><br>  The main purpose of the orchestration is to eliminate communication with over 500 users.  Have the ability to quickly change the parameters of the mass, install software packages, certificates and ‚Äúsoft policies - like GPO‚Äù. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Taking into account the strategic priorities of the state, focus on full import substitution, the workplace users may have MSWSphere or ROSA at their workplaces tomorrow, respectively configuration management and monitoring tools are better to have cross-platform open source, web-based management and zero cost of implementation &amp; ownership. <br><br><h4>  Dynamic DNS </h4><br>  IP addresses are maintained according to the rule: 10. Building.  When changing the location of the workplace, changing the IP address.  Manually changed  DHCP is not, therefore option 82 is not applicable.  In the inventory numbers of the system blocks can be duplicates.  The only thing that is relatively consistent is the MAC address.  To him and make a binding.  Let us define the template for the name of the workplace as PC- {mac-separator}.  If there are several network connections on the computer, we will assume that Ethernet will be the first, immediately after the installation of the operating system.  We will use its address as a constant for% COMPUTERNAME%. <br><br>  To work with certificates, you must have the FQDN (Fully Qualified Domain Name) name, and from the conditions it follows that there is no DNS.  A convenient solution in this situation is dynamic DNS, it is convenient for matching% COMPUTERNAME% with an IP address and, accordingly, determining the current location of the workplace, if there is a need for personal communication with the user. <br><br>  The first solution, to dynamically update the DNS zones of the client, was the Nsupdate utility from the Bind package for Windows, but in this case the clients had a common key and therefore could change not only their records in the zone.  A safer solution seemed to be when the client sends an HTTP request, and the server makes changes according to its rules.  The way of storing zones in this variant is obvious - this is a SQL database.  By default, the PowerDNS server is configured to serve requests from the database.  It is used in many large projects and seems to be very stable.  We will use it. <br><br><div class="spoiler">  <b class="spoiler_title">How to install on Ubuntu</b> <div class="spoiler_text">  Install PowerDNS: <br>  <i>$ sudo apt-get install -y pdns-server pdns-backend-mysql</i> <br><br>  We test PowerDNS: <br>  Verify that PowerDNS is running: <br>  <i>$ sudo netstat -tap |</i>  <i>grep pdns</i> <br>  Must issue: <br>  <i>roto @ salt: ~ # netstat -tap |</i>  <i>grep pdns</i> <br><br><pre><code class="bash hljs">tcp 0 0 *:domain *:* LISTEN 891/pdns_server-ins</code> </pre> <br>  Verify that PowerDNS responds: <br>  <i>$ sudo dig <a href="https://habrahabr.ru/users/127/" class="user_link">127</a> .0.0.1</i> <br>  Must issue: <br>  <i>roto @ salt: ~ # dig <a href="https://habrahabr.ru/users/127/" class="user_link">127</a> .0.0.1</i> <br><pre> <code class="bash hljs">; &lt;&lt;&gt;&gt; DiG 9.9.5-3ubuntu0.1-Ubuntu &lt;&lt;&gt;&gt; @127.0.0.1 ; (1 server found) ;; global options: +cmd ;; Got answer: ;; -&gt;&gt;HEADER&lt;&lt;- opcode: QUERY, status: NOERROR, id: 21529 ;; flags: qr rd; QUERY: 1, ANSWER: 0, AUTHORITY: 0, ADDITIONAL: 1 ;; WARNING: recursion requested but not available ;; OPT PSEUDOSECTION: ; EDNS: version: 0, flags:; udp: 2800 ;; QUESTION SECTION: ;. IN NS ;; Query time: 1 msec ;; SERVER: 127.0.0.1<span class="hljs-comment"><span class="hljs-comment">#53(127.0.0.1) ;; WHEN: Fri Feb 13 11:29:05 KRAT 2015 ;; MSG SIZE rcvd: 239</span></span></code> </pre><br></div></div><br><br>  For comfortable control of zones, many different interfaces to PowerDNS are written.  We approved the work <a href="https://code.google.com/p/powerdns-webinterface">powerdns-webinterface</a> <br><div class="spoiler">  <b class="spoiler_title">What it looks like</b> <div class="spoiler_text"><img src="https://habrastorage.org/files/c44/d5d/be8/c44d5dbe87424a60b5df2b70a443668f.png"><br></div></div><br><div class="spoiler">  <b class="spoiler_title">How to install on Ubuntu</b> <div class="spoiler_text">  Install LAMP and the required module: <br>  <i>$ sudo apt-get install gettext</i> <br><br>  Download the panel scripts: <br>  <i>$ cd / tmp</i> <i><br></i>  <i>$ wget <a href="">powerdns-webinterface.googlecode.com/files/powerdns-webinterface-1.5.3.tar.gz</a></i> <i><br></i>  <i>$ tar xvfz webinterface-1.5.3.tar.gz</i> <i><br></i>  <i>$ sudo mv webinterface-1.5.3 / var / www / powerdns</i> <br><br>  Allow writing to the working folder: <br>  <i>$ sudo chown -R www-data: www-data / var / www / powerdns / tmp / templates_c</i> <br><br>  We perform database import: <br>  <i>$ sudo mysql -u user-name -p pdns db &lt;/ path-to / install.sql</i> <br><br>  Rule configs / db.php on the correct connection details to the pdns db database <br><br>  We go to the browser at the link http: // &lt;IP_or_name.our.server&gt; / powerdns with the admin name / password admin: admin and change the password. <br></div></div><br><br><h4>  Configuration Management Tools for Windows PC Automation </h4><br><br>  Initially, inventory systems were considered for centralized software distribution.  Existing proven solutions <a href="http://www.ocsinventory-ng.org/">ocsinventory-ng</a> and <a href="http://www.mandriva.com/en/products-services/pulse2">Mandriva Pulse</a> have in their functionality the ability to install packages.  Both include the ability to integrate with such an element ITIL / ITSM as the Service Desk (in particular <a href="http://www.glpi-project.org/">GLPI</a> ) conveniently, but not in the current situation.  Changing the Windows registry settings and warming certificates is presented in no other way than by making installation packages.  And these packages, the user with administrator privileges can remove from the machine.  Based on this, I began to consider configuration management systems. <br><br>  Puppet is considered the most common.  It has many modules and user interfaces.  Changes in configuration files (manifests) for clients, the latter receive them when they next access the main server, or through a request from the server for immediate execution using the push function. <br>  There are modules for working with Windows systems.  Support for WindowsXP systems was discontinued after puppet-3.1.1.msi, and the current puppet-3.7.3.msi could not be started.  tied to calling system functions.  In the older versions there are no `facts` like` <i>system32`</i> and the manifests need to describe different scenarios depending on the operating system.  This all complicates the use of the system and it was decided to abandon in favor of other tools. <br>  SaltStack is similar to Puppet in that it uses the push method to communicate with clients (minion).  MINION does not open any ports, but connects itself to the server and waits for commands from it, thus increasing the security of the service.  If Puppet has manifests for describing configurations, SaltStack introduces the notion of `state`.  Changes made on the wizard will be made on all minions.  It is worth noting that the execution of the state `s is initiated from the wizard, and not by the clients themselves as implemented in Puppet.  To maintain the current status in case of a long shutdown of minion, a parameter has been added to its configuration file: <br>  startup_states: 'highstate' (C: \ salt \ conf \ minion) <br>  States are configuration files in the YAML format with the sls extension. <br><div class="spoiler">  <b class="spoiler_title">What it looks like</b> <div class="spoiler_text"><img src="https://habrastorage.org/files/276/597/032/2765970326eb4ecc9e8ad79b7d046352.png" alt="sls tree"><br></div></div><br>  Reading the state `s begins with the file <i>top.sls</i> , unless otherwise specified.  It contains a list of <i>.sls</i> files for specific groups. <br><pre> <code class="bash hljs">roto@salt:/etc/salt/files<span class="hljs-comment"><span class="hljs-comment"># cat top.sls base: # '*': #     Windows 'all_pc': - match: nodegroup - gr_inventory - gr_7z - gr_chrome - gr_libreoffice - gr_klitecodec - gr_essentials #  'gr_garant': - match: nodegroup - gr_garant # + 'gr_consultant': - match: nodegroup - gr_consultant</span></span></code> </pre><br><br>  Groups are defined in the master configuration file (/ etc / salt / master) and allow you to set them quite flexibly.  Read more in the <a href="http://docs.saltstack.com/en/latest/topics/targeting/compound.html">documentation.</a> <br>  In the examples from the documentation, groups are defined by variables.  For dynamic types of passwords to databases, tokens, hashes, these are `props '(pillar) and static` kernels' (grain).  In addition, variables can be used in the description of the state `s and the command line salt. <br>  <i>roto @ salt: / etc / salt / files # salt ‚ÄìG 'cpuarch: AMD64' test.ping</i> <br><br>  As an example, the listing of antivirus `` state of Microsoft from Microsoft: <br><pre> <code class="bash hljs">roto@salt:/etc/salt/files<span class="hljs-comment"><span class="hljs-comment"># cat gr_essentials.sls {% if grains['cpuarch'] == 'AMD64' %} w64_essentials: pkg: - installed {% elif grains['osrelease'] == '7' %} w32_essentials: pkg: - installed {% elif grains['osrelease'] == 'XP' %} w32xp_essentials: pkg: - installed {% endif %}</span></span></code> </pre><br>  <sub>* there are no other x64 systems in the park, except for Windows7</sub> <br><br>  Software packages are installed from the repository specified in the master configuration file (/ etc / salt / master).  Description of the package in the file init.sls, its listing: <br><pre> <code class="bash hljs">roto@salt:/etc/salt/files/win/repo/w32xp_essentials<span class="hljs-comment"><span class="hljs-comment"># cat init.sls w32xp_essentials: 4.4.304.0: installer: 'salt://win/repo/w32xp_essentials/mseinstall.exe' full_name: Microsoft Security Essentials locale: ru_RU reboot: False install_flags: '/q /s /runwgacheck ' uninstaller: '%ProgramFiles(x86)%\Microsoft Security Client\Setup.exe' uninstall_flags: ' /U /S'</span></span></code> </pre><br><br>  Salt master has a built-in file server and can send any files to minion ªam.  TCP Ports: <br><ul><li>  4505 # for management </li><li>  4506 # for file transfer </li></ul><br><br>  For SaltStack there are web-interfaces SaltPad and Halite.  The first one could not be started, and with the second one you can view the system message log, the status of minions, and also send them commands. <br><div class="spoiler">  <b class="spoiler_title">What it looks like</b> <div class="spoiler_text"><img src="https://habrastorage.org/files/6e8/e25/d68/6e8e25d684f34af885dbec5cd97c73e2.png"><br></div></div><br><br>  During the tests, it proved to be an extremely unreliable, incomplete solution, noticeably inferior to the user interfaces of other systems, in particular Puppet-Dashboard. <br><div class="spoiler">  <b class="spoiler_title">What it looks like</b> <div class="spoiler_text"><img src="https://habrastorage.org/files/9f7/6fc/5f2/9f76fc5f228349c69b9c004aad422aba.png"><br></div></div><br><br>  In order to avoid problems installed SHELLINABOX. <br><div class="spoiler">  <b class="spoiler_title">What it looks like</b> <div class="spoiler_text"><img src="https://habrastorage.org/files/6c4/0d3/696/6c40d3696db34109a0588758fb9ab515.png" alt="SHELLINABOX"><br></div></div><br><div class="spoiler">  <b class="spoiler_title">How to install on Ubuntu</b> <div class="spoiler_text">  Install Shell In A Box for ssh access via any html5 browser: <br>  <i>$ sudo apt-get install openssl shellinabox</i> <br>  Rule default configs: <br>  <i>$ sudo vi / etc / default / shellinabox</i> <br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># TCP  shellinboxd'    SHELLINABOX_PORT=443 # IP    SSH  SHELLINABOX_ARGS="--o-beep -s /:SSH:localhost --localhost-only"</span></span></code> </pre><br>  Restart service: <br>  <i>$ sudo service shellinabox restart</i> <br>  Check port: <br>  <i>$ sudo netstat -nap |</i>  <i>grep shellinabox</i> <br>  Open in html 5 compatible browser https: // &lt;IP_or_name.our.server&gt;.  We use. <br></div></div><br><br>  The final installation script is as follows: <br><div class="spoiler">  <b class="spoiler_title">install.cmd</b> <div class="spoiler_text"><pre> <code class="dos hljs">@<span class="hljs-built_in"><span class="hljs-built_in">Echo</span></span> Off <span class="hljs-built_in"><span class="hljs-built_in">rem</span></span> /************************************* <span class="hljs-built_in"><span class="hljs-built_in">rem</span></span> * Install <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> SaltStack * <span class="hljs-built_in"><span class="hljs-built_in">rem</span></span> *-----------------------------------* <span class="hljs-built_in"><span class="hljs-built_in">rem</span></span> * (c) <span class="hljs-number"><span class="hljs-number">2015</span></span> by Aleksey Ovchinnikov * <span class="hljs-built_in"><span class="hljs-built_in">rem</span></span> * License: GPL * <span class="hljs-built_in"><span class="hljs-built_in">rem</span></span> * Feel free to customize on your * <span class="hljs-built_in"><span class="hljs-built_in">rem</span></span> * needs as long this copyright * <span class="hljs-built_in"><span class="hljs-built_in">rem</span></span> * remains intact * <span class="hljs-built_in"><span class="hljs-built_in">rem</span></span> *************************************/ <span class="hljs-built_in"><span class="hljs-built_in">SetLocal</span></span> EnableExtensions <span class="hljs-built_in"><span class="hljs-built_in">rem</span></span> /// ,      <span class="hljs-built_in"><span class="hljs-built_in">AT</span></span> &gt; <span class="hljs-built_in"><span class="hljs-built_in">NUL</span></span> <span class="hljs-keyword"><span class="hljs-keyword">If</span></span> <span class="hljs-variable"><span class="hljs-variable">%ERRORLEVEL%</span></span> <span class="hljs-keyword"><span class="hljs-keyword">EQU</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> ( <span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> Please use "Run as Administrator"! <span class="hljs-built_in"><span class="hljs-built_in">pause</span></span> <span class="hljs-keyword"><span class="hljs-keyword">exit</span></span> /b ) <span class="hljs-built_in"><span class="hljs-built_in">rem</span></span> ///  mac   <span class="hljs-variable"><span class="hljs-variable">%SYSTEMROOT%</span></span>\System32\getmac.exe /NH /FO csv &gt; <span class="hljs-variable"><span class="hljs-variable">%TEMP%</span></span>\all_mac.tmp <span class="hljs-built_in"><span class="hljs-built_in">type</span></span> <span class="hljs-variable"><span class="hljs-variable">%TEMP%</span></span>\all_mac.tmp | <span class="hljs-built_in"><span class="hljs-built_in">findstr</span></span> /r /c:"-" &gt; <span class="hljs-variable"><span class="hljs-variable">%TEMP%</span></span>\all_mac.txt <span class="hljs-built_in"><span class="hljs-built_in">del</span></span> <span class="hljs-variable"><span class="hljs-variable">%TEMP%</span></span>\all_mac.tmp <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> /f "usebackq delims=" <span class="hljs-variable"><span class="hljs-variable">%%i</span></span> <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> (`<span class="hljs-built_in"><span class="hljs-built_in">find</span></span> /n /v "" <span class="hljs-variable"><span class="hljs-variable">%TEMP%</span></span>\all_mac.txt ^| <span class="hljs-built_in"><span class="hljs-built_in">find</span></span> "[<span class="hljs-number"><span class="hljs-number">1</span></span>]"`) <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> ( <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> mac=<span class="hljs-variable"><span class="hljs-variable">%%i</span></span> ) <span class="hljs-keyword"><span class="hljs-keyword">For</span></span> /f "delims=, tokens=<span class="hljs-number"><span class="hljs-number">1</span></span>" <span class="hljs-variable"><span class="hljs-variable">%%i</span></span> <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> ("<span class="hljs-variable"><span class="hljs-variable">%mac%</span></span>") <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> ( <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> mac=<span class="hljs-variable"><span class="hljs-variable">%%i</span></span> ) <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> mac=<span class="hljs-variable"><span class="hljs-variable">%mac:~4,17%</span></span> <span class="hljs-keyword"><span class="hljs-keyword">For</span></span> /f "delims=^- tokens=*" <span class="hljs-variable"><span class="hljs-variable">%%i</span></span> <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> ("<span class="hljs-variable"><span class="hljs-variable">%mac%</span></span>") <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> ( <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> mac=<span class="hljs-variable"><span class="hljs-variable">%%i</span></span> ) <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> mac=<span class="hljs-variable"><span class="hljs-variable">%mac:-=%</span></span> <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> mac=<span class="hljs-variable"><span class="hljs-variable">%mac:~0,12%</span></span> <span class="hljs-built_in"><span class="hljs-built_in">rem</span></span> ///    <span class="hljs-keyword"><span class="hljs-keyword">If</span></span> <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> "<span class="hljs-variable"><span class="hljs-variable">%ComputerName%</span></span>"=="PC-<span class="hljs-variable"><span class="hljs-variable">%mac%</span></span>" ( <span class="hljs-built_in"><span class="hljs-built_in">rem</span></span> wmic.exe /interactive:off ComputerSystem Where "name = '<span class="hljs-variable"><span class="hljs-variable">%computername%</span></span>'" <span class="hljs-keyword"><span class="hljs-keyword">call</span></span> <span class="hljs-built_in"><span class="hljs-built_in">rename</span></span> Name='PC-<span class="hljs-variable"><span class="hljs-variable">%mac%</span></span>' <span class="hljs-built_in"><span class="hljs-built_in">rem</span></span> wmic os where Primary='TRUE' reboot REG ADD HKLM\SYSTEM\ControlSet001\Control\ComputerName\ComputerName /v ComputerName /t REG_SZ /d "PC-<span class="hljs-variable"><span class="hljs-variable">%mac%</span></span>" /f REG ADD HKLM\SYSTEM\CurrentControlSet\Control\ComputerName\ComputerName /v ComputerName /t REG_SZ /d "PC-<span class="hljs-variable"><span class="hljs-variable">%mac%</span></span>" /f REG ADD HKLM\SYSTEM\CurrentControlSet\Services\Tcpip\Parameters /v "NV Hostname" /t REG_SZ /d "PC-<span class="hljs-variable"><span class="hljs-variable">%mac%</span></span>" /f REG ADD HKLM\SYSTEM\ControlSet001\Services\Tcpip\Parameters /v "NV Hostname" /t REG_SZ /d "PC-<span class="hljs-variable"><span class="hljs-variable">%mac%</span></span>" /f shutdown -t <span class="hljs-number"><span class="hljs-number">0</span></span> -r -f <span class="hljs-keyword"><span class="hljs-keyword">exit</span></span> /b ) <span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> ...get NAME ^&gt; <span class="hljs-variable"><span class="hljs-variable">%ComputerName%</span></span> <span class="hljs-built_in"><span class="hljs-built_in">rem</span></span> ///  IP  <span class="hljs-keyword"><span class="hljs-keyword">FOR</span></span> /F "usebackq tokens=<span class="hljs-number"><span class="hljs-number">2</span></span> delims=[]" <span class="hljs-variable"><span class="hljs-variable">%%i</span></span> <span class="hljs-keyword"><span class="hljs-keyword">IN</span></span> (`<span class="hljs-built_in"><span class="hljs-built_in">ping</span></span> <span class="hljs-variable"><span class="hljs-variable">%Computername%</span></span> -n <span class="hljs-number"><span class="hljs-number">1</span></span> -<span class="hljs-number"><span class="hljs-number">4</span></span>`) <span class="hljs-keyword"><span class="hljs-keyword">DO</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> "<span class="hljs-variable"><span class="hljs-variable">%%i</span></span>"=="" <span class="hljs-built_in"><span class="hljs-built_in">Set</span></span> ip=<span class="hljs-variable"><span class="hljs-variable">%%i</span></span> <span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> ...get IP ^&gt; <span class="hljs-variable"><span class="hljs-variable">%ip%</span></span> <span class="hljs-built_in"><span class="hljs-built_in">rem</span></span> ///    <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> key=HKLM\SOFTWARE\Microsoft\Windows NT\CurrentVersion <span class="hljs-keyword"><span class="hljs-keyword">For</span></span> /F "delims=" <span class="hljs-variable"><span class="hljs-variable">%%a</span></span> <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> ('reg query "<span class="hljs-variable"><span class="hljs-variable">%key%</span></span>" /v "ProductName" ^| <span class="hljs-built_in"><span class="hljs-built_in">find</span></span> /i "ProductName"') <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> ( <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> OSName=<span class="hljs-variable"><span class="hljs-variable">%%a</span></span> ) <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> OSName=<span class="hljs-variable"><span class="hljs-variable">%OSName:ProductName=%</span></span> <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> OSName=<span class="hljs-variable"><span class="hljs-variable">%OSName:REG_SZ=%</span></span> <span class="hljs-keyword"><span class="hljs-keyword">For</span></span> /F "tokens=* delims= " <span class="hljs-variable"><span class="hljs-variable">%%a</span></span> <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> ("<span class="hljs-variable"><span class="hljs-variable">%OSName%</span></span>") <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> ( <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> OSName=<span class="hljs-variable"><span class="hljs-variable">%%a</span></span> ) <span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> ...get OS ^&gt; <span class="hljs-variable"><span class="hljs-variable">%OSName%</span></span> <span class="hljs-built_in"><span class="hljs-built_in">rem</span></span> ///    <span class="hljs-built_in"><span class="hljs-built_in">Set</span></span> xOS=x64 <span class="hljs-keyword"><span class="hljs-keyword">If</span></span> "<span class="hljs-variable"><span class="hljs-variable">%PROCESSOR_ARCHITECTURE%</span></span>"=="x86" <span class="hljs-keyword"><span class="hljs-keyword">If</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Not</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Defined</span></span> PROCESSOR_ARCHITEW6432 <span class="hljs-built_in"><span class="hljs-built_in">Set</span></span> xOS=x86 <span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> ...get <span class="hljs-built_in"><span class="hljs-built_in">TYPE</span></span> ^&gt; <span class="hljs-variable"><span class="hljs-variable">%xOS%</span></span> <span class="hljs-built_in"><span class="hljs-built_in">rem</span></span> ///     DNS <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> data=<span class="hljs-variable"><span class="hljs-variable">%ip%</span></span>:<span class="hljs-variable"><span class="hljs-variable">%COMPUTERNAME%</span></span>:<span class="hljs-variable"><span class="hljs-variable">%COMPUTERNAME%</span></span>_<span class="hljs-variable"><span class="hljs-variable">%OSName%</span></span>_<span class="hljs-variable"><span class="hljs-variable">%xOS%</span></span> <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> data=%data: =_% <span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> ...add DNS ^&gt; c:\saltstack\curl.exe -s http://salt../dns/update.php?data=<span class="hljs-variable"><span class="hljs-variable">%data%</span></span>" <span class="hljs-built_in"><span class="hljs-built_in">rem</span></span> ///  SaltStack   Windows <span class="hljs-keyword"><span class="hljs-keyword">If</span></span> <span class="hljs-variable"><span class="hljs-variable">%xOS%</span></span>==x86 (c:\saltstack\Salt-Minion-<span class="hljs-number"><span class="hljs-number">3</span></span>.<span class="hljs-number"><span class="hljs-number">1</span></span>.<span class="hljs-number"><span class="hljs-number">5</span></span>-win32-Setup.exe /S /master=salt.. /minion-name=<span class="hljs-variable"><span class="hljs-variable">%COMPUTERNAME%</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">Else</span></span> (c:\saltstack\Salt-Minion-<span class="hljs-number"><span class="hljs-number">3</span></span>.<span class="hljs-number"><span class="hljs-number">1</span></span>.<span class="hljs-number"><span class="hljs-number">5</span></span>-AMD64-Setup.exe /S /master=salt.. /minion-name=<span class="hljs-variable"><span class="hljs-variable">%COMPUTERNAME%</span></span>) <span class="hljs-built_in"><span class="hljs-built_in">rem</span></span> ///        <span class="hljs-built_in"><span class="hljs-built_in">echo</span></span>.startup_states: 'highstate' &gt;&gt;"C:\salt\conf\minion" <span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> ...auto state ^&gt; Done! <span class="hljs-built_in"><span class="hljs-built_in">attrib</span></span> +H +S c:\salt <span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> ...hide folder ^&gt; Done! <span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> c:\ <span class="hljs-built_in"><span class="hljs-built_in">rmdir</span></span> /s /qc:\saltstack</code> </pre><br></div></div><br><br><h4>  Zabbix monitoring system </h4><br>  There are <a href="https://ru.wikipedia.org/wiki/%25D0%25A1%25D1%2580%25D0%25B0%25D0%25B2%25D0%25BD%25D0%25B5%25D0%25BD%25D0%25B8%25D0%25B5_%25D1%2581%25D0%25B8%25D1%2581%25D1%2582%25D0%25B5%25D0%25BC_%25D0%25BC%25D0%25BE%25D0%25BD%25D0%25B8%25D1%2582%25D0%25BE%25D1%2580%25D0%25B8%25D0%25BD%25D0%25B3%25D0%25B0_%25D1%2581%25D0%25B5%25D1%2582%25D0%25B8">many</a> monitoring systems.  I know Zabbix for a long time, I chose it. <br><br><div class="spoiler">  <b class="spoiler_title">What it looks like</b> <div class="spoiler_text"><img src="https://habrastorage.org/files/5e1/007/52c/5e100752c8a84c28b8f086605939b6d6.png"><br></div></div><br><br><div class="spoiler">  <b class="spoiler_title">How to install on Ubuntu</b> <div class="spoiler_text">  Install the necessary packages: <br>  <i>$ sudo apt-get install zabbix-server-mysql zabbix-frontend-php ca-certificates-java libslf4j-java jarwrapper libandroid-json-org-java liblogback-java</i> <br><br>  In the server configuration file <i>/etc/zabbix/zabbix_server.conf we</i> set up a connection to the database: <br>  <i>$ sudo mcedit /etc/zabbix/zabbix_server.conf</i> <br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">### Option: DBHost # Database host name. # If set to localhost, socket is used for MySQL. # If set to empty string, socket is used for PostgreSQL. # # Mandatory: no # Default: # DBHost=localhost ### Option: DBName # Database name. # For SQLite3 path to database file must be provided. DBUser and DBPassword are ignored. # Sample SQLite3 DBName: # DBName=/var/lib/zabbix/zabbix.sqlite3 # # Mandatory: yes # Default: # DBName= DBName=zabbix ### Option: DBUser # Database user. Ignored for SQLite. # # Mandatory: no # Default: # DBUser= DBUser=zabbix ### Option: DBPassword # Database password. Ignored for SQLite. # Comment this line if no password is used. # # Mandatory: no # Default: # DBPassword= DBPassword=zabbix</span></span></code> </pre><br>  We are preparing a database: <br>  <i>mysql ‚Äìuuser-name ‚Äìp</i> <i><br></i>  <i>mysql&gt; create database zabbix character set utf8 collate utf8_unicode_ci;</i> <i><br></i>  <i>mysql&gt; grant all privileges on zabbix. * to zabbix @ localhost identified by 'zabbix';</i> <i><br></i>  <i>mysql&gt; exit;</i> <br><br>  Load the structure and values ‚Äã‚Äãinto the database: <br>  <i>$ sudo cd / usr / share / zabbix-server-mysql</i> <i><br></i>  <i>$ sudo gunzip * .gz</i> <i><br></i>  <i>$ sudo mysql -uuser-name zabbix -p &lt;schema.sql</i> <i><br></i>  <i>$ sudo mysql -uuser-name zabbix -p &lt;images.sql</i> <i><br></i>  <i>$ sudo mysql -uuser-name zabbix -p &lt;data.sql</i> <i><br></i> <br><br>  Restart zabbix: <br>  <i>$ sudo service zabbix-server star</i> t <br><br>  And we check that everything is without errors: <br>  <i>$ tail -n 100 /var/log/zabbix-server/zabbix_server.log</i> <br><br>  Copy the required file: <br>  <i>$ sudo cp /usr/share/doc/zabbix-frontend-php/examples/apache.conf /etc/apache2/conf-available/zabbix.conf</i> <br><br>  Configure php parameters for the web interface: <br>  <i>$ sudo mcedit /etc/apache2/conf-available/zabbix.conf</i> <br><pre> <code class="bash hljs">php_value max_execution_time 300 php_value memory_limit 128M php_value post_max_size 16M php_value upload_max_filesize 2M php_value max_input_time 300 php_value date.timezone Asia/Krasnoyarsk</code> </pre><br><br>  Add the zabbix web interface configuration file to apache: <br>  <i>$ sudo a2enconf zabbix.conf</i> <br><br>  And restart the web server: <br>  <i>$ sudo service apache2 reload</i> <br><br>  Open your <a href="http://xn--web-5cdjeub1hcg4f/zabbix">zwebserver / zabbix URL</a> and complete all steps: <br><img src="https://habrastorage.org/files/759/e5a/b01/759e5ab01d4c4b2baf5d185198682411.png"><br><img src="https://habrastorage.org/files/556/be3/807/556be3807d5449c98d20272135db293d.png"><br><img src="https://habrastorage.org/files/1b3/2c0/1de/1b32c01de0d84d4e82a96d1f5811e5ed.png"><br><br>  At the last step you will be asked to enter: <br><img src="https://habrastorage.org/files/ee5/d98/c30/ee5d98c308514ae39ab8f59ca37f6965.png"><br><br>  Default login / password: Admin / zabbix.  Change password after login. <br></div></div><br><br><h4>  JMX monitoring </h4><br>  Starting from version 2.0, native support for monitoring JMX has been added to zabbix.  The interaction takes place through the JMX application management API through a daemon, called Zabbix Java gateway.  It is written in Java. <br><div class="spoiler">  <b class="spoiler_title">How to install on Ubuntu</b> <div class="spoiler_text">  Install the necessary packages: <br>  <i>$ sudo apt-get install --no-install-recommends zabbix-java-gateway</i> <br><br>  In the server configuration file /etc/zabbix/zabbix_java_gateway.conf, we configure the connections and launch options for the Java gateway: <br>  <i>$ sudo mcedit /etc/zabbix/zabbix_java_gateway.conf</i> <br><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#   Java-gateway JavaGateway=127.0.0.1 #   Java Gateway JavaGatewayPort=10052 #  Java Gateway ,     StartJavaPollers=5</span></span></code> </pre><br><br>  In the server configuration file /etc/zabbix/zabbix_server.conf, we configure the connection to the Java gateway: <br>  <i>$ sudo mcedit /etc/zabbix/zabbix_server.conf</i> <br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">### Option: JavaGateway #&lt;-----&gt;IP address (or hostname) of Zabbix Java gateway. #&lt;-----&gt;Only required if Java pollers are started. # # Mandatory: no # Default: # JavaGateway= JavaGateway=127.0.0.1 ### Option: JavaGatewayPort #&lt;-----&gt;Port that Zabbix Java gateway listens on. # # Mandatory: no # Range: 1024-32767 # Default: # JavaGatewayPort=10052 JavaGatewayPort=10052 ### Option: StartJavaPollers #&lt;-----&gt;Number of pre-forked instances of Java pollers. # # Mandatory: no # Range: 0-1000 # Default: # StartJavaPollers=0 StartJavaPollers=5</span></span></code> </pre><br><br>  Allow launch: <br>  <i>$ sudo mcedit / etc / default / zabbix-server</i> <br><pre> <code class="bash hljs">START=yes</code> </pre><br><br>  We start the service: <br>  <i>$ sudo service zabbix-java-gateway restart</i> <br><br>  The next setting is made on the machine where the monitoring will be performed.  Add to the application server startup script or the container of the servlets: <br><pre> <code class="bash hljs">-Djava.rmi.server.hostname=192.168.3.14 \ -Dcom.sun.management.jmxremote \ -Dcom.sun.management.jmxremote.port=12345 \ -Dcom.sun.management.jmxremote.authenticate=<span class="hljs-literal"><span class="hljs-literal">false</span></span> \ -Dcom.sun.management.jmxremote.ssl=<span class="hljs-literal"><span class="hljs-literal">false</span></span> \</code> </pre><br>  Disable access to this port to everyone except the IP addresses of the zabbix server and the admin machine using a firewall. <br><br>  From the admin machine, launch JConsole from jdk and connect to the machine where it will be monitored. <br><div class="spoiler">  <b class="spoiler_title">What it looks like</b> <div class="spoiler_text"><img src="https://habrastorage.org/files/0ec/79d/7b8/0ec79d7b8843475d8de1e4f45977122f.png"><br></div></div><br><br>  If the connection is successful, you need to go to the zabbix web interface and configure the parameters for monitoring.  Go to Settings&gt; Network nodes, click Create network node and enter the necessary values. <br><div class="spoiler">  <b class="spoiler_title">What it looks like</b> <div class="spoiler_text"><img src="https://habrastorage.org/files/1c2/6bf/6bc/1c26bf6bcab34f248a69dc6507b56ef1.png"><br></div></div><br><br>  After some time, the data will appear and you can build a graph. <br><div class="spoiler">  <b class="spoiler_title">What it looks like</b> <div class="spoiler_text"><img src="https://habrastorage.org/files/f55/837/44c/f5583744ce68424baa9ee2f9953c7cc1.png"><br></div></div><br></div></div><br><br><h4>  PostgreSQL Monitoring </h4><br>  According to the PostgreSQL <a href="https://wiki.postgresql.org/wiki/Monitoring">wiki</a> , monitoring solutions are written quite a bit.  I settled on <a href="http://cavaliercoder.github.io/libzbxpgsql/">libzbxpgsql</a> (Lib-Zabbix-PostgreSQL).  This is an originally compiled module written in C for a zabbix agent and an xml template for a server.  The advantage over scripts is obvious, this is one process and no external dependencies. <br><div class="spoiler">  <b class="spoiler_title">How to install on Ubuntu</b> <div class="spoiler_text">  It is proposed to compile the module yourself, the binary package is only in rpm.  And take it. <br><br>  Install the necessary packages on the machine with the database that we will monitor: <br>  <i>$ sudo apt-get install alien zabbix-agent</i> <br><br>  Download the module: <br>  <i>$ sudo wget <a href="">downloads.sourceforge.net/project/libzbxpgsl/rpms/libzbxpgsql-0.1.1-1.el7.centos.x86_64.rpm</a></i> <br><br>  Convert to <i>deb</i> package: <br>  <i>$ sudo alien libzbxpgsql-0.1.1-1.el7.centos.x86_64.rpm</i> <br><br>  Install the package: <br>  <i>$ sudo dpkg -i libzbxpgsql_0.1.1-2_amd64.deb</i> <br><br>  In the agent configuration file /etc/zabbix/zabbix_agentd.conf, we configure server connections and options: <br>  <i>$ sudo mcedit /etc/zabbix/zabbix_agentd.conf</i> <br><pre> <code class="bash hljs">Server= ServerActive=: Hostname=doc..</code> </pre><br><br>  And restart the agent: <br>  <i>$ sudo service zabbix-agent restart</i> <br><br>  Save the <a href="">template_postgresql_server.xml</a> <br>  Open the zabbix web interface and go to Settings&gt; Templates, click Import Configuration.  Import our xml file. <br><br>  Configure settings for this host.  Add the required templates and Template PostgreSQL Server.  In the Macros tab, enter the parameters of the connection to the database that will be monitored. <br><div class="spoiler">  <b class="spoiler_title">What it looks like</b> <div class="spoiler_text"><img src="https://habrastorage.org/files/9a4/696/b2d/9a4696b2d35c455781f2aa11c0f9291e.png"><br></div></div><br><br>  After some time, the data will appear and you can build a graph. <br><div class="spoiler">  <b class="spoiler_title">What it looks like</b> <div class="spoiler_text"><img src="https://habrastorage.org/files/a73/aa2/3ab/a73aa23abf9f4432ab7bd429e680f7a6.png"><br></div></div><br></div></div><br><br>  This article is written as documentation for my current employer.  Comments, comments and indications of inaccuracies are welcome. </div><p>Source: <a href="https://habr.com/ru/post/250487/">https://habr.com/ru/post/250487/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../250471/index.html">We invite to the competition "Cognitive Vehicle Detection Benchmark"</a></li>
<li><a href="../250473/index.html">Facebook launched a social network for information security professionals</a></li>
<li><a href="../250475/index.html">OSEDUCONF-2015, the tenth conference ‚ÄúFree Software in Higher Education‚Äù - videotapes and overview</a></li>
<li><a href="../250481/index.html">JavaScript Garden: Objects</a></li>
<li><a href="../250485/index.html">Productive fault tolerant geographically distributed cluster operating in Active-Active scheme on IBM zEnterprise EC 12 mainframe</a></li>
<li><a href="../250489/index.html">Effective code review: 9 tips from a reformed skeptic</a></li>
<li><a href="../250491/index.html">Reduce the number of errors using the Code Review checklist</a></li>
<li><a href="../250493/index.html">Containerize it! What Fuel is and what it uses for Docker</a></li>
<li><a href="../250495/index.html">Security links for email newsletters</a></li>
<li><a href="../250497/index.html">[Moscow, 02.19.2015] Dmitry Lenev - Lock Managers in MySQL</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>