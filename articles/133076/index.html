<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Beginners about channel width control in Linux</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Some time ago I was asked to set up a simplest traffic balancing at a remote branch office. They work, poor fellows, via ADSL, and sending large e-mai...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Beginners about channel width control in Linux</h1><div class="post__text post__text-html js-mediator-article">  Some time ago I was asked to set up a simplest traffic balancing at a remote branch office.  They work, poor fellows, via ADSL, and sending large e-mails (scans of documents) clogs the entire return channel, which leads to problems in working with office online programs via VPN. <br>  They use Linux (Fedora) as a gateway.  Before that, I saw a couple of times how such balancing is configured via ipfw on FreeBSD, and since I know the iptables mechanism quite well, I did not expect any special problems.  But when I searched the Internet, I was unpleasantly surprised that iptables was not at all an assistant for me.  And knowledge of the order of passing packages through its tables and rules will hardly come in handy to me.  You need to learn tc from the iproute2 package. <br><br>  Unexpectedly, I spent two days in order to more or less understand how to balance traffic with iproute2.  First came across the HTB article that wasn't the best for a newbie ( <a href="http://luxik.cdi.cz/~devik/qos/htb/manual/userg.htm">here</a> ).  Various examples from the Internet also sometimes introduced into a stupor, as they often did not contain a description of specific options or the meaning of their use.  That's why I tried to collect the knowledge I received in one article, and most importantly, to describe everything at a level accessible to beginners. <br><a name="habracut"></a><br>  At once I will make a reservation, we will only cut the traffic coming from the network interface.  Incoming, too, can be adjusted, but it requires additional tricks. <br><br><h4>  Classless disciplines </h4><br>  So, in Linux, a <b>discipline (qdisc)</b> is assigned to each network interface for managing traffic.  It is from the disciplines that the whole traffic management system is built.  But you should not be afraid, in fact, discipline is just an algorithm for processing a queue of network packets. <br>  Several disciplines can be involved on one interface, and the so-called <b>root discipline (root qdisc)</b> is attached directly to the interface.  In addition, each interface has its own root discipline. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h5>  prio_fast </h5><br>  By default, after booting the system, root qdisc sets the algorithm for processing packages of type <b>pfifo_fast</b> . <br><br><img src="https://habrastorage.org/getpro/habr/post_images/d33/21d/0c3/d3321d0c39b1901afc24d21e2a788f0d.png" alt="image"><br><br>  Checking: <br><br>  <i># tc qdisc</i> <i><br><br></i>  <i>qdisc pfifo_fast 0: dev eth0 root bands 3 priomap 1 2 2 2 1 2 0 0 1 1 1 1 1 1 1 1</i> <br><br>  <b>pfifo_fast</b> is the usual ‚ÄúFirst Input - First Output‚Äù algorithm, but with some traffic prioritization.  This type of discipline contains within itself three FIFO queues with different priority of packet processing.  Packages are laid out on the basis of the ToS (Type of Service) flag in each IP packet.  The packet hit in FIFO0 has the highest priority to processing, in FIFO2 - the smallest.  The ToS itself requires a separate conversation, so I suggest limiting myself to the fact that the operating system itself knows which ToS to assign to the sent IP packet.  For example, in the telnet and ping packets, ToS will have different values. <br><br>  <b>0:</b> - handle the root discipline. <br>  The descriptors must be of the <b>following major number: the lower number</b> , but for the disciplines the junior number must always be 0, and therefore it can be omitted. <br><br>  The <b>priomap</b> parameter <b>1 2 2 2 1 2 0 0 1 1 1 1 1 1 1 1 1</b> just sets the bitwise match of the ToS field to each internal queue (band).  For example, with ToS = 4, the packet is processed in queue 1, with ToS = 7 in queue 0. <br><br>  In a number of sources indicated that the parameters of the discipline pfifo_fast can not be changed, we believe. <br><br><h5>  TBF </h5><br>  Now consider how you can limit the rate of total outgoing traffic.  To do this, we assign the root discipline of the interface discipline type <b>TBF (Token Bucket Filter)</b> . <br><br>  <i># tc qdisc add dev eth0 root tbf rate 180kbit latency 20ms buffer 1540</i> <br><br>  <b>rate 180kbit</b> - sets the threshold for the transfer rate on the interface. <br><br>  <b>latency 20ms</b> - sets the maximum time for a data packet to wait for a token. <br><br>  <b>buffer 1540</b> - set the size of the token buffer in bytes.  In the examples they write that for a 10Mbit / s constraint, a buffer of 10Kbytes is enough.  The main thing is not to make it too small, more can be.  Approximate calculation formula: rate_in_Bytes / 100. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/ffc/479/5d5/ffc4795d5de66078623e621e3a600d6a.png" alt="image"><br><br>  Discipline TBF for their work uses the mechanism of tokens.  Tokens are generated by the system at a constant speed and are placed in a buffer (bucket).  For each token that came out of the buffer, an IP packet leaves the interface. <br>  If the transfer rates of packets and generation of tokens coincide, the data transfer process goes without delay. <br>  If the packet transfer rate is less than the speed of tokens, the latter begin to accumulate in the buffer and then can be used for short-term data transmission at a speed above the threshold. <br>  If the packet transfer rate is higher, there will be a lack of tokens.  Data packets await new tokens for a while, and then begin to be discarded. <br><br>  The two disciplines described refer to the so-called classless (classless) disciplines.  They have a number of functional limitations: they are connected only to the interface (or to the boundary class), plus they cannot use packet filters.  And, accordingly, my task of balancing e-mail traffic cannot be solved with their help. <br>  By the way, the full set of classless disciplines is somewhat broader: pfifo, bfifo, sqf (ensures the same speed of packets received from different streams), esqf, etc. <br><br><h4>  Class disciplines </h4><br>  If disciplines can be represented as sections of water pipes, then classes are connectors (fittings).  It can be a simple fitting adapter, or it can be a cunning fitting splitter with a dozen taps. <br><br>  As a parent of a class, either a discipline or another class can act. <br>  Subclasses can join a class (joining several fittings). <br><br>  A class that does not have child classes is called a <b>leaf (leaf class)</b> .  Here, data packets, having run through our ‚Äúwater supply system‚Äù leave the traffic management system and are sent by the network interface.  By default, any regional class has an attached fifo discipline, and it is this group that determines the packet transmission order for this class.  But the beauty is that we can change this discipline to any other. <br>  In the case of adding a child class, this discipline is deleted. <br><br><h5>  prio </h5><br>  Let us return to the postal traffic balancing problem and consider the <b>prio</b> class discipline. <br>  It is very similar to the already described pfifo_fast.  But this discipline is special in that when it is assigned, three classes are automatically created (the number can be changed with the parameter bands). <br><br>  Replace the root discipline interface prio. <br><br>  <i># tc qdisc add dev eth0 root handle 1: prio</i> <br><br>  <b>handle 1:</b> - set the handle to the root qdisc.  In class disciplines, it is then indicated when the classes are connected. <br><br>  Check the discipline: <br><br>  <i># tc qdisc</i> <i><br><br></i>  <i>qdisc prio 1: dev eth0 bands 3 priomap 1 2 2 2 1 2 0 0 1 1 1 1 1 1 1 1</i> <br><br>  Checking classes: <br><br>  <i># tc -d -s class show dev eth0</i> <i><br><br></i>  <i>class prio 1: 1 parent 1:</i> <i><br></i>  <i>Sent 734914 bytes 7875 pkt (dropped 0, overlimits 0 requeues 0)</i> <i><br></i>  <i>backlog 0b 0p requeues 0</i> <i><br></i>  <i>class prio 1: 2 parent 1:</i> <i><br></i>  <i>Sent 1555058583 bytes 8280199 pkt (dropped 124919, overlimits 26443 requeues 0)</i> <i><br></i>  <i>backlog 0b 0p requeues 0</i> <i><br></i>  <i>class prio 1: 3 parent 1:</i> <i><br></i>  <i>Sent 57934378 bytes 802213 pkt (dropped 70976, overlimits 284608 requeues 0)</i> <i><br></i>  <i>backlog 0b 0p requeues 0</i> <br><br>  We see three classes with identifiers 1: 1, 1: 2 and 1: 3 connected to the parent discipline 1: of the prio type (classes are required to have a common identifier ID with their parent). <br>  Ie, the root qdisc ‚Äúpipe‚Äù, which separates the data streams in the same way as pfifo_fast does, we planted a tee.  Being guided by ToS, high-priority traffic falls into class 1: 1, normal traffic falls into class 1: 2, and absolutely garbage comes to class 1: 3. <br><br>  Suppose the reverse ADSL channel provides a speed of 90Kbytes / s.  We divide it into 20K bytes / c for mail and 70K bytes / c for everything else. <br><br>  Traffic from the 1: 1 class will not specifically limit.  Its packets will always be able to occupy at least the full width of the channel due to the high priority of ToS, but the traffic volume in this class will be negligible compared to the other two classes.  Therefore, we do not reserve a separate lane for it. <br><br>  Standard traffic usually falls into the 1: 2 class.  We connect to the second output of the class-tee pipe-discipline at 70Kbyte / c: <br><br>  <i># tc qdisc add dev eth0 parent 1: 2 handle 10: tfb rate 70kbps buffer 1500 latency 50ms</i> <br><br>  To the third pin of the tee, we connect the pipe discipline to 20Kbyte / c: <br><br>  <i># tc qdisc add dev eth0 parent 1: 3 handle 20: tfb rate 20kbps buffer 1500 latency 50ms</i> <br><br>  All three of these classes are marginal. <br><br>  And now it remains only to send mail traffic not to class 1: 2, as happened earlier, but to class 1: 3.  This is done using class discipline filters. <br><br>  <i># tc filter add dev eth0 parent 1: protocol ip prio 1 u32 match ip dport 25 0xffff flowid 1: 3</i> <br><br>  <b>parent 1:</b> - the filter can be attached only to the discipline and is called from it.  Based on the filter response, the discipline decides in which class the packet processing will continue. <br><br>  <b>protocol ip</b> - determine the type of network protocol <br><br>  <b>prio 1</b> - the parameter for a long time introduced me into confusion, as it is used in classes and filters, plus this is the name of the discipline.  Here, prio sets the filter priority, the filters with the lower prio are used first. <br><br>  <b>u32</b> - the so-called traffic classifier, which can perform packet selection for any of its grounds: by sender / recipient ip-address, source / destination port, protocol type.  These conditions, in fact, are listed below. <br><br>  <b>match ip dport 25 0xffff</b> - sets the filter to trigger when sending packets to port 25. 0xffff is the bitmask for the port number. <br><br>  <b>flowid 1: 3</b> - we specify in which class the packets are transmitted when this filter is triggered. <br><br>  Done roughly, but the task will perform. <br><br>  We look at the packet passing statistics: <br><br>  <i># tc -s -d qdisq show dev eth0</i> <i><br></i>  <i># tc -s -d class show dev eth0</i> <i><br></i>  <i># tc -s -d filter show dev eth0</i> <br><br>  Quickly remove all classes, filters and return the interface qdisc root to its original state by using the command: <br><br>  <i># tc qdisc del dev eth0 root</i> <br><br><h5>  HTB </h5><br>  On the other hand, our return channel is already too thin to reserve 20K bytes / c only for sending email.  Therefore, it is better to use the class discipline HTB (Hierarchical Token Bucket).  It allows borrowing bandwidth from parent classes of children. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/62c/d16/8b1/62cd168b198c5495d7375c167dd583e0.png" alt="image"><br><br>  <i># tc qdics add dev eth0 root handle 1: htb default 20</i> <br><br>  <b>default 20</b> - set the <b>default</b> class.  It will process packages that are not in other classes of discipline htb.  If you do not specify it, then ‚Äúdefault 0‚Äù will be assigned and all unclassified (non-filtered) traffic will be sent at the interface speed. <br><br>  <i># tc class add dev eth0 parent 1: classid 1: 1 htb rate 90kbps ceil 90kbps</i> <br><br>  Attach a class with a 1: 1 identifier to root qdisc.  Thus, we limit the speed on the interface to 90Kbyte / s. <br><br>  <b>classid 1: 1</b> is a class identifier. <br><br>  <b>rate 90kbps</b> - set the lower bandwidth threshold for the class. <br><br>  <b>ceil 90kbps</b> - set the upper bandwidth threshold for the class. <br><br>  <i># tc class add dev eth0 parent 1: 1 classid 1:10 htb rate 20kbps ceil 70kbps</i> <br><br>  create a 1:10 class, a child of a 1: 1 class.  Then the outgoing mail traffic will be sent to it by the filter. <br><br>  <b>rate 20kbps</b> - set a guaranteed lower bandwidth threshold for the class. <br><br>  <b>ceil 70kbps</b> - set the upper bandwidth threshold for the class.  If the parent class has a free bandwidth (the presence of ‚Äúextra‚Äù tokens), class 1:10 will be able to temporarily increase the data transfer rate, up to the specified limit of 70 Kb / s. <br><br>  <i># tc class add dev eth0 parent 1: 1 classid 1:20 htb rate 70kbps ceil 90kbps</i> <br><br>  Create a default class.  All other traffic will fall into it.  Similarly, with the rate and ceil parameters, we set the bandwidth expansion in the absence of mail traffic. <br><br>  <i># tc filter add dev eth0 parent 1: protocol ip prio 1 u32 match ip dport 25 0xffff flowid 1:10</i> <br><br>  filter based on u32, directing packets outgoing to port 25 in class 1:10. <br><br>  By the way, the documentation states that in fact in HTB traffic shaping occurs only in the regional classes, in our case 1:10 and 1:20.  Specifying bandwidth limiting parameters in the rest of the HTB classes is only necessary for the functioning of the inter-class borrowing system. <br><br>  When adding a class, it is also possible to specify the <b>prio</b> parameter.  It sets the class priority (0 - max. Priority).  Classes with lower priority are not processed while there is data in higher priority classes. <br><br>  Sources: <br>  <a href="http://lartc.org/howto/index.html">Linux Advanced Routing &amp; Traffic Control HOWTO</a> <br>  <a href="http://www.linux-ip.net/articles/Traffic-Control-HOWTO/index.html">Traffic Control HOWTO</a> <br>  <a href="http://pc-inform.ru/articles/Povest_o_Linux_i_upravlenii_trafikom.html">A Tale of Linux and Traffic Management</a> </div><p>Source: <a href="https://habr.com/ru/post/133076/">https://habr.com/ru/post/133076/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../13307/index.html">Blu-ray is twice as popular as HD DVD</a></li>
<li><a href="../133072/index.html">Strange $ _FILES or ‚Äúthe problem of using array syntax in fields of type file‚Äù</a></li>
<li><a href="../133073/index.html">COMPETITION! (for developers)</a></li>
<li><a href="../133074/index.html">JavaScript for dummies. Everything you wanted to know about the functions but were afraid to ask</a></li>
<li><a href="../133075/index.html">Incompatibility of the Sony Ericsson Xperia X10 and some Beeline towers</a></li>
<li><a href="../133077/index.html">Vertical scrolling of Mac OS X Lion style page content</a></li>
<li><a href="../133079/index.html">Another grumble about Yandex Market</a></li>
<li><a href="../13308/index.html">Festive menu - in Yandex. Bar</a></li>
<li><a href="../133080/index.html">An economic BitCoin tasting sauce or what BitCoin and Lady Gaga have in common?</a></li>
<li><a href="../133081/index.html">LG GT540: Increase partition size / data due to / system</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>