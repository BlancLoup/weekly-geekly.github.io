<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Saving related models in Yii</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="I recently wrote a component in which I implemented saving related records (CActiveRecord) and I would like to share this code. 

 I noticed that repe...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Saving related models in Yii</h1><div class="post__text post__text-html js-mediator-article">  I recently wrote a component in which I implemented saving related records (CActiveRecord) and I would like to share this code. <br><br>  I noticed that repeating code is often written, for example, when you need to save data about a client with all his contacts, something like this is written (at least, I wrote this): <br><pre><code class="php hljs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ($client-&gt;save()) { <span class="hljs-keyword"><span class="hljs-keyword">foreach</span></span> ($contacts <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> $contact) { $contact-&gt;clientId = $client-&gt;primaryKey; $contact-&gt;save(); } }</code> </pre> <br>  Of course, this code is accompanied by validation and error handling, and can also be enclosed in a transaction.  What I would like to do is make a universal code for storing differently related models. <br><a name="habracut"></a><br>  For example, it is necessary to save such data from the form: a new customer who has 1 address and many contact persons;  at the same time, the client is associated with the order and invoice being created (invoice);  and the order in turn is associated with the invoice.  As a result, all these models can be saved as follows: <br><pre> <code class="php hljs"> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">actionCreate</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ $order = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Order; $address = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Address; $user = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> User; $contacts = <span class="hljs-keyword"><span class="hljs-keyword">array</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Contact); $invoice = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Invoice; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">isset</span></span>($_POST[<span class="hljs-string"><span class="hljs-string">'Submit'</span></span>])) { $user-&gt;saveWith($address, $_POST[<span class="hljs-string"><span class="hljs-string">'Address'</span></span>], <span class="hljs-string"><span class="hljs-string">'addressId'</span></span>); $user-&gt;saveWith($contacts, $_POST[<span class="hljs-string"><span class="hljs-string">'Contact'</span></span>], <span class="hljs-string"><span class="hljs-string">'userId'</span></span>); $order-&gt;saveWith($user, $_POST[<span class="hljs-string"><span class="hljs-string">'User'</span></span>], <span class="hljs-string"><span class="hljs-string">'userId'</span></span>); $invoice-&gt;saveWith($order, $_POST[<span class="hljs-string"><span class="hljs-string">'Order'</span></span>], <span class="hljs-string"><span class="hljs-string">'orderId'</span></span>); $invoice-&gt;saveWith($user, $_POST[<span class="hljs-string"><span class="hljs-string">'User'</span></span>], <span class="hljs-string"><span class="hljs-string">'userId'</span></span>); $invoice-&gt;attributes = $_POST[<span class="hljs-string"><span class="hljs-string">'Invoice'</span></span>]; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ($invoice-&gt;relationalSave()) { <span class="hljs-keyword"><span class="hljs-keyword">echo</span></span> <span class="hljs-string"><span class="hljs-string">'Saved'</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">echo</span></span> <span class="hljs-string"><span class="hljs-string">'Not saved'</span></span>; } } <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;render(<span class="hljs-string"><span class="hljs-string">'create'</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">array</span></span>(<span class="hljs-string"><span class="hljs-string">'order'</span></span> =&gt; $order, <span class="hljs-string"><span class="hljs-string">'user'</span></span> =&gt; $user, <span class="hljs-string"><span class="hljs-string">'invoice'</span></span> =&gt; $invoice, <span class="hljs-string"><span class="hljs-string">'address'</span></span> =&gt; $address, <span class="hljs-string"><span class="hljs-string">'contacts'</span></span> =&gt; $contacts)); }</code> </pre><br><br>  As you can see, the main model is the account, with it the client (user) and the order are saved.  Together with the order, the client is also saved, and with the client a list of contacts and address. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      This preservation is based on the fact that when we save one model together with the main one, we must save the primary key value of the associated model in the foreign key field in the main model, and therefore the third parameter in this case will be the foreign key name in the main model.  In the case when we save an array of related models, we assume that the third parameter is the name of the foreign key in the associated model. <br><br>  The second parameter will be the data for one model or an array of data, these data will be written into the model using the mass attribute assignment: <br><pre> <code class="php hljs">$model-&gt;attributes = $_POST[<span class="hljs-string"><span class="hljs-string">'Model'</span></span>];</code> </pre><br>  The only limitation for the second parameter is the need to match the array of models to the data array, that is, array indices must start at 0 and have no gaps.  Perhaps, thinking I can get around this limitation.  For example, you can see if there is a primary key of the model in the input data and load it from the database - in this case, you will not need to preload the models and monitor the compliance. <br><br>  There is also a fourth parameter, optional, which serves to validate the entire array of related models.  For example, we need to check that the amount of payments related to the account is equal to the amount of the account.  To do this, create a validation class that contains the validate ($ models) method, which accepts a list of models and returns true or false if the validation was successful or did not pass, respectively.  This method will be called for an array of related models before storing them. <br><br>  You can look at the component that is implemented as CActiveRecordBehavior on <a href="http://www.yiiframework.com/extension/saverbehavior/">Yii extensions</a> <br><br>  Your opinions and other solutions to the problem in the comments will be interesting. </div><p>Source: <a href="https://habr.com/ru/post/118910/">https://habr.com/ru/post/118910/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../118901/index.html">The need for a long rest: another trap when planning time</a></li>
<li><a href="../118902/index.html">Standard_Test_Treating_Long_Title</a></li>
<li><a href="../118903/index.html">How to study correctly?</a></li>
<li><a href="../118905/index.html">Facebook's main mobile developer left the company</a></li>
<li><a href="../118906/index.html">From Ubuntu to Fedora - we land on foreign land (good, bad and ugly)</a></li>
<li><a href="../118912/index.html">We put clouds in one basket</a></li>
<li><a href="../118913/index.html">What is wrong with Microsoft Student Partners (MSP)?</a></li>
<li><a href="../118915/index.html">New look at online Magic 8 Ball</a></li>
<li><a href="../118916/index.html">Google is experimenting with the design of the search results page</a></li>
<li><a href="../118917/index.html">The advantages of a non-blocking algorithm are not only and not so much in performance.</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>