<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Measurement collection system using a weather station</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="It would seem that everyone who masters arduino, first of all designs or repeats an instrument for measuring temperature and (or) other environmental ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Measurement collection system using a weather station</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/files/66e/8f0/855/66e8f0855bf44374a6289dd19fe6c724.png" alt="image" align="left">  It would seem that everyone who masters arduino, first of all designs or repeats an instrument for measuring temperature and (or) other environmental parameters.  Only the majority of such structures, unfortunately, are of little use in the household - as a workout will fit, but there is no benefit.  Let's try to fix this flaw.  In the article I will talk about the creation of a complex for measuring and storing any data using the example of collecting readings from sensors for temperature, air humidity and atmospheric pressure.  I will begin with the requirements for the device and the description of the exchange protocol, I will end with a web-service for receiving data from the database.  Detailed calculations and walkthroughs will not be, but there will be a little theory and a lot of code. <br><br clear="left"><a name="habracut"></a><br>  This story began one day when the wire of the remote sensor of the home weather station was bitten by one of the pets.  I repaired the wire, but after that incident the device began to periodically show a lie.  There is a lack of analog measurement, when a small impact is enough to completely distort the data.  This case and pushed me to make their own similar complex. <br><br>  After thinking about the problem, we got the following specification: <br><br><ol><li>  Sensors must be digital, with acceptable accuracy.  Temperature - DS1820, humidity - DHT22, air pressure - BMP085.  The choice of sensors was due to their presence ‚Äúin the bins‚Äù.  By the way, the temperature measurement function is in all these three types, but we will use the DS1820, since they can be switched on in parallel. </li><li>  These sensors should be connected on the fly, i.e.  do not require operator intervention. </li><li>  The controller to which the sensors must be connected must be accessible.  My choice fell on the Arduino, because it is inexpensive and has a minimum level of entry. </li><li>  The controller must be connected to the computer via the serial port.  We will use a USB2Serial adapter as a common and inexpensive solution. </li><li>  Since the controller may be located at some distance from the computer, and there may be several controllers on one port, the protocol of the exchange must provide protection against data corruption and the possibility of addressing devices. </li><li>  The complex must store in the database the history of all measurements.  My choice is SQLite. </li><li>  All programs for working with the controller must be portable.  work equally on different platforms without major improvements.  My choice is Python 2.7. </li></ol><br><h2>  Description of the exchange protocol between the computer and the controller </h2><br>  Since the data exchange with the controller will be asynchronous, with packets of a previously unknown length, the <a href="https://ru.wikipedia.org/wiki/SLIP">SLIP</a> was taken as the basis of the channel protocol.  This is a protocol in which data is transmitted using SLIP frames.  The borders of the SLIP frame is the END (0xC0) flag.  If the frame contains byte 0xC0, it is replaced by the escape sequence 0xDB, 0xDC, and if the byte is encountered ESC (0xDB), it is replaced by the sequence (0xDB, 0xDD).  The inverse transform is symmetric. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      In SLIP frames, we will wrap messages with a pre-calculated checksum. <br><br>  To calculate the checksum, the CRC16 algorithm with the polynomial 0xA001 (modbus) was applied: <br><br><ol><li>  The 16-bit register (CRC) is loaded 0xFFFF. </li><li>  The first byte of the message is added by EXCLUSIVE OR with the contents of the CRC register.  The result is placed in the CRC register. </li><li>  The CRC register is shifted to the right by 1 bit, the most significant bit is filled with 0. </li><li>  (If the low-order bit is 1): The content of the CRC is added to the EXCLUSIVE OR with the polynomial number 0xA001. </li><li>  Steps 3 and 4 are repeated eight times. </li><li>  Steps 2-5 are repeated for all subsequent bytes of the package. </li><li>  The final content of the CRC register is the checksum. </li></ol><br>  The CRC is added to the end of the message in the format of the low byte first, then the high byte. <br><br><h2>  Application Exchange Protocol </h2><br><h3>  The format of the request to the device </h3><br>  instrument_address (1 byte) class (1 byte) [method (1 byte)] [data (N byte)] <h3>  Device response format: </h3>  instrument_address (1 byte) data (N bytes) <br><h3>  class 0 (PING) </h3><br>  returns 0x55 0xAA 0x55 0xAA <br><h3>  class 1 (INFO) </h3><br><h4>  methods </h4><br>  <b>0</b> - request for the number of temperature sensors <br>  returns: (unsigned char) number <br>  <b>1</b> - request readings and serial numbers from temperature sensors <br>  returns: ((float) temperature (8 bytes) sernum) * number of sensors <br>  <b>2</b> - request readings from the pressure sensor <br>  returns: (int32_t) pressure (char) sernum <br>  <b>3</b> - request readings from the humidity sensor <br>  returns: (float) moisture (byte) sernum <br>  <i>There are only two classes, but the reader, if he wishes, will be able, in an image and likeness, to expand the protocol with the required parameters.</i> <br><br><h3>  Example </h3><br><h4>  Request </h4><br>  Device Address - 00 <br>  Class - 00 (PING) <br>  Checksum - 01 B0 <br>  Final package - C0 00 00 B0 01 C0 <br><h4>  Answer </h4><br>  Device response - C0 00 55 AA 55 AA C3 AA C0 <br>  Device Address - 00 <br>  Checksum - AA C3 <br>  Message - 55 AA 55 AA (PING response) <br><br><h3>  Device layout </h3><br><img src="https://habrastorage.org/files/151/2c5/87a/1512c587ada547ee8abdc5b21e4491a9.png"><br><br><h3>  Photo layout </h3><br><img src="https://habrastorage.org/files/453/4d2/856/4534d2856b0944e7ba04d6d17ec53736.png"><br><br>  Here is a photo of the intermediate version with the support of the screen from Nokia (the code is in the repository by the link at the end of the article). <br><br><h3>  Photos of the finished product </h3><br><img src="https://habrastorage.org/files/ab3/f06/909/ab3f0690921649e7b6348a55873d03d3.png"><br><br><img src="https://habrastorage.org/files/b30/686/ef0/b30686ef06d0464fa5022e197e19aa45.png"><br><br><h2>  Source: </h2><br><div class="spoiler">  <b class="spoiler_title">Sketch for Arduino</b> <div class="spoiler_text"><pre><code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt;DallasTemperature.h&gt; #include &lt;Adafruit_BMP085.h&gt; #include &lt;OneWire.h&gt; #include &lt;DHT.h&gt; #define ONE_WIRE_BUS 10 #define TEMPERATURE_PRECISION 9 #define DHTPIN 2 #define DHTTYPE DHT22 OneWire oneWire(ONE_WIRE_BUS); DallasTemperature sensors(&amp;oneWire); Adafruit_BMP085 bmp; const unsigned char MAXNUMBERS = 10; DeviceAddress addresses[MAXNUMBERS]; unsigned char numbers; DHT dht(DHTPIN, DHTTYPE); char readbuf[50]; char writebuf[130]; char tmpbuf[50]; int msglen = 0; const int bufLength = 8; const char SLIP_END = '\xC0'; const char SLIP_ESC = '\xDB'; const char SLIP_ESC_END = '\xDC'; const char SLIP_ESC_ESC = '\xDD'; const char CS_PING = '\x00'; const char CS_INFO = '\x01'; const char LOC_ADR = '\x00'; int transferData(char *buf, unsigned char cnt) { Serial.print(SLIP_END); for (int i = 0; i &lt; cnt; i++) { switch (buf[i]) { case SLIP_END: Serial.print(SLIP_ESC); Serial.print(SLIP_ESC_END); break; case SLIP_ESC: Serial.print(SLIP_ESC); Serial.print(SLIP_ESC_ESC); break; default: Serial.print(buf[i]); break; } } Serial.print(SLIP_END); } unsigned short getCRC(char *buf, unsigned char cnt) { unsigned short temp, temp2, flag; temp = 0xFFFF; for (int i = 0; i &lt; cnt; i++) { temp ^= (unsigned char) buf[i]; for (int j = 1; j &lt;= 8; j++) { flag = temp &amp; 0x0001; temp &gt;&gt;= 1; if (flag) temp ^= 0xA001; } } temp2 = temp &gt;&gt; 8; temp = (temp &lt;&lt; 8) | temp2; temp &amp;= 0xFFFF; return temp; } int addCRC(char *buf, unsigned char cnt) { unsigned short crc = getCRC(buf, cnt); memcpy(&amp;buf[cnt], &amp;crc, 2); return cnt + 2; } void setup() { Serial.begin(9600); bmp.begin(); sensors.begin(); dht.begin(); } void loop() { float humidity = dht.readHumidity(); int32_t pressure = (int32_t)(bmp.readPressure() / 133.3224); numbers = 0; for (int i = 0; i &lt; MAXNUMBERS; i++) { if (!sensors.getAddress(addresses[i], i)) break; numbers++; } for (unsigned char i = 0; i &lt; numbers; i++) { sensors.setResolution(addresses[i], TEMPERATURE_PRECISION); } sensors.requestTemperatures(); if (msglen) { unsigned short msgcrc; memcpy(&amp;msgcrc, &amp;readbuf[msglen-2], 2); unsigned short crc = getCRC(readbuf, msglen-2); if (crc == msgcrc) { char adr = readbuf[0]; char cs = readbuf[1]; char mtd = readbuf[2]; int len; unsigned char n; float temp; if (adr == LOC_ADR) { switch (cs) { case CS_PING: writebuf[0] = LOC_ADR; writebuf[1] = '\x55'; writebuf[2] = '\xAA'; writebuf[3] = '\x55'; writebuf[4] = '\xAA'; len = addCRC(writebuf, 5); delay(100); transferData(writebuf, len); break; case CS_INFO: switch (mtd) { case 0: writebuf[0] = LOC_ADR; writebuf[1] = numbers; len = addCRC(writebuf, 2); delay(100); transferData(writebuf, len); break; case 1: writebuf[0] = LOC_ADR; writebuf[1] = numbers; for (int i=0; i &lt; numbers; i++) { temp = sensors.getTempC(addresses[i]); memcpy(&amp;writebuf[i*12+2], &amp;temp, 4); memcpy(&amp;writebuf[i*12+6], &amp;addresses[i], 8); } len = addCRC(writebuf, numbers*12+2); delay(100); transferData(writebuf, len); break; case 2: writebuf[0] = LOC_ADR; memcpy(&amp;writebuf[1], &amp;pressure, 4); writebuf[5] = 0; len = addCRC(writebuf, 6); delay(100); transferData(writebuf, len); break; case 3: writebuf[0] = LOC_ADR; memcpy(&amp;writebuf[1], &amp;humidity, 4); writebuf[5] = 0; len = addCRC(writebuf, 6); delay(100); transferData(writebuf, len); break; } break; } } } msglen = 0; } } void serialEvent() { msglen = readCommand(readbuf); } int readCommand(char *buf) { int i = 0; bool escaped = false; char c = (char) Serial.read(); if (c == SLIP_END) { bool beginflag = true; while (beginflag) { char c1 = (char) Serial.read(); switch (c1) { case SLIP_END: return i; break; case SLIP_ESC: escaped = true; break; case SLIP_ESC_END: if (escaped) { buf[i] = SLIP_END; escaped = false; } else buf[i] = c1; i++; break; case SLIP_ESC_ESC: if (escaped) { buf[i] = SLIP_ESC; escaped = false; } else buf[i] = c1; i++; break; default: if (escaped) { return 0; } else buf[i] = c1; i++; break; } } } return i; }</span></span></span></span></code> </pre> <br></div></div><br><div class="spoiler">  <b class="spoiler_title">Class slip.py</b> <div class="spoiler_text"><pre> <code class="python hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">SlipConv</span></span></span><span class="hljs-class">:</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">__init__</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self)</span></span></span><span class="hljs-function">:</span></span> self.started = <span class="hljs-keyword"><span class="hljs-keyword">False</span></span> self.escaped = <span class="hljs-keyword"><span class="hljs-keyword">False</span></span> self.packet = <span class="hljs-string"><span class="hljs-string">''</span></span> self.SLIP_END = <span class="hljs-string"><span class="hljs-string">'\xc0'</span></span> self.SLIP_ESC = <span class="hljs-string"><span class="hljs-string">'\xdb'</span></span> self.SLIP_ESC_END = <span class="hljs-string"><span class="hljs-string">'\xdc'</span></span> self.SLIP_ESC_ESC = <span class="hljs-string"><span class="hljs-string">'\xdd'</span></span> self.serialComm = <span class="hljs-keyword"><span class="hljs-keyword">None</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">__getcrc</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self, buf)</span></span></span><span class="hljs-function">:</span></span> temp = <span class="hljs-number"><span class="hljs-number">0xffff</span></span> <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> c <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> buf: i = ord(c) temp ^= i j = <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> j &lt;= <span class="hljs-number"><span class="hljs-number">8</span></span>: flag = temp &amp; <span class="hljs-number"><span class="hljs-number">0x0001</span></span> temp &gt;&gt;= <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> flag &gt; <span class="hljs-number"><span class="hljs-number">0</span></span>: temp ^= <span class="hljs-number"><span class="hljs-number">0xa001</span></span> j += <span class="hljs-number"><span class="hljs-number">1</span></span> temp2 = temp &gt;&gt; <span class="hljs-number"><span class="hljs-number">8</span></span> temp = (temp &lt;&lt; <span class="hljs-number"><span class="hljs-number">8</span></span>) | temp2 temp &amp;= <span class="hljs-number"><span class="hljs-number">0xffff</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> temp <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">addcrc</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self, packet)</span></span></span><span class="hljs-function">:</span></span> crc = self.__getcrc(packet) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> packet + chr(crc &amp; <span class="hljs-number"><span class="hljs-number">0xff</span></span>) + chr(crc &gt;&gt; <span class="hljs-number"><span class="hljs-number">8</span></span>) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">checkcrc</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self, packet)</span></span></span><span class="hljs-function">:</span></span> tmpcrc = self.__getcrc(self.getmsgpart(packet)) msgcrc = self.getcrcpart(packet) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> (chr(tmpcrc &amp; <span class="hljs-number"><span class="hljs-number">0xff</span></span>) + chr(tmpcrc &gt;&gt; <span class="hljs-number"><span class="hljs-number">8</span></span>)) == msgcrc <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getcrcpart</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self, packet)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> packet[len(packet)<span class="hljs-number"><span class="hljs-number">-2</span></span>:len(packet)] <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getmsgpart</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self, packet)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> packet[<span class="hljs-number"><span class="hljs-number">0</span></span>:len(packet)<span class="hljs-number"><span class="hljs-number">-2</span></span>] <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">unslip</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self, stream)</span></span></span><span class="hljs-function">:</span></span> packetlist = <span class="hljs-string"><span class="hljs-string">''</span></span> <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> char <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> stream: <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> char == self.SLIP_END: <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> self.started: packetlist += self.packet <span class="hljs-keyword"><span class="hljs-keyword">else</span></span>: self.started = <span class="hljs-keyword"><span class="hljs-keyword">True</span></span> self.packet = <span class="hljs-string"><span class="hljs-string">''</span></span> <span class="hljs-keyword"><span class="hljs-keyword">elif</span></span> char == self.SLIP_ESC: self.escaped = <span class="hljs-keyword"><span class="hljs-keyword">True</span></span> <span class="hljs-keyword"><span class="hljs-keyword">elif</span></span> char == self.SLIP_ESC_END: <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> self.escaped: self.packet += self.SLIP_END self.escaped = <span class="hljs-keyword"><span class="hljs-keyword">False</span></span> <span class="hljs-keyword"><span class="hljs-keyword">else</span></span>: self.packet += char <span class="hljs-keyword"><span class="hljs-keyword">elif</span></span> char == self.SLIP_ESC_ESC: <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> self.escaped: self.packet += self.SLIP_ESC self.escaped = <span class="hljs-keyword"><span class="hljs-keyword">False</span></span> <span class="hljs-keyword"><span class="hljs-keyword">else</span></span>: self.packet += char <span class="hljs-keyword"><span class="hljs-keyword">else</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> self.escaped: self.packet = <span class="hljs-string"><span class="hljs-string">''</span></span> self.escaped = <span class="hljs-keyword"><span class="hljs-keyword">False</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">''</span></span> <span class="hljs-keyword"><span class="hljs-keyword">else</span></span>: self.packet += char self.started = <span class="hljs-keyword"><span class="hljs-keyword">True</span></span> self.started = <span class="hljs-keyword"><span class="hljs-keyword">False</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> packetlist <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">slip</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self, packet)</span></span></span><span class="hljs-function">:</span></span> encoded = self.SLIP_END <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> char <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> packet: <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> char == self.SLIP_END: encoded += self.SLIP_ESC + self.SLIP_ESC_END <span class="hljs-keyword"><span class="hljs-keyword">elif</span></span> char == self.SLIP_ESC: encoded += self.SLIP_ESC + self.SLIP_ESC_ESC <span class="hljs-keyword"><span class="hljs-keyword">else</span></span>: encoded += char encoded += self.SLIP_END <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> encoded</code> </pre><br></div></div><br><div class="spoiler">  <b class="spoiler_title">Class protocol.py</b> <div class="spoiler_text"><pre> <code class="python hljs"><span class="hljs-comment"><span class="hljs-comment"># - *- coding: utf- 8 - *- import sys import serial import time import math from slip import SlipConv import struct class Protocol: def __init__(self, port, baudrate, logon): self.log = logon self.slipC = SlipConv() self.SLIP_END = '\xc0' self.ser = serial.Serial() self.ser.port = port self.ser.baudrate = baudrate self.ser.timeout = 5 try: self.ser.open() except serial.SerialException as e: print ('Oops! IO Error. Check ' + port + ' at ' + str(baudrate) + '.') sys.exit(1) if self.log: print ('Opened ' + port + ' at ' + str(baudrate) + '.') time.sleep(2) def printPacket(self, packet): print ' '.join("%X" % ord(c) if ord(c) &gt; 0x0f else '0' + "%X" % ord(c) for c in packet) def sendCommand(self, packet): crcPack = self.slipC.addcrc(packet) out = self.slipC.slip(crcPack) self.ser.write(out) if self.log: print ('Sent ' + str(len(out)) + ' bytes: '), self.printPacket(out) def receiveAnswer(self): packet = '' char = '' firsttime = time.time() while (time.time() - firsttime) &lt; self.ser.timeout: char = self.ser.read(1) if char == self.SLIP_END: break if char != self.SLIP_END: print 'Timeout error!!! Check the connections' sys.exit(1) packet += char beginflag = True while beginflag: c = self.ser.read(1) packet += c if c == self.SLIP_END: beginflag = False if self.log: print ('Received ' + str(len(packet)) + ' bytes: '), self.printPacket(packet) unsliped = self.slipC.unslip(packet) if self.slipC.checkcrc(unsliped): if self.log: print ('CRC - OK') return self.slipC.getmsgpart(unsliped) else: if self.log: print ('BAD CRC,'), print 'received ', self.printPacket(packet) return '' def ping(self, adr): if self.log: print ('Ping adr=' + str(adr)) self.sendCommand(chr(adr) + chr(0)) if self.receiveAnswer() == ((chr(0) + chr(0x55) + chr(0xAA) + chr(0x55) + chr(0xAA))): if self.log: print ('Ping to adr=' + str(adr) + ' - OK') return True else: return False def getTemp(self, adr): if self.log: print ('Get a temperature from sensors.') self.sendCommand(chr(adr) + chr(1) + chr(1)) res = self.receiveAnswer() num = ord(res[1]) values = [] for i in range(0, num): temp, = struct.unpack('&lt;f', res[i*12+2:i*12+6]) sernum = res[i*12+6:i*12+14] values.append((temp, sernum)) if self.log: print 'It has ' + str(num) + ' temperature sensors:' print ("%.1f" % temp + 'C on the sensor with the serial number'), self.printPacket(sernum) return values def getPressure(self, adr): if self.log: print ('Get the atmospheric pressure.') self.sendCommand(chr(adr) + chr(1) + chr(2)) res = self.receiveAnswer() pressure, = struct.unpack('&lt;i', res[1:5]) sernum = res[5] if self.log: if 10 &lt; pressure &lt; 1000: print (str(pressure) + ' mmHg on the sensor with the serial number'), self.printPacket(sernum) else: print 'The pressure sensor doesn\'t exist' return pressure, sernum def getHumidity(self, adr): if self.log: print ('Get a humidity.') self.sendCommand(chr(adr) + chr(1) + chr(3)) res = self.receiveAnswer() humidity, = struct.unpack('&lt;f', res[1:5]) sernum = res[5] if self.log: if math.isnan(humidity): print 'The humidity sensor doesn\'t exist' else: print (str(humidity) + '% on the sensor with the serial number'), self.printPacket(sernum) return humidity, sernum def close(self): self.ser.close()</span></span></code> </pre><br></div></div><br><h4>  A bit about the host computer </h4>  Absolutely any computer with installed Python 2.7 and SQLite can be used as a host.  To work you need to install the library <a href="https://pypi.python.org/pypi/pyserial">pyserial</a> . <br>  The choice fell on the already quite old Asus WL-500gp router. <br>  I installed <a href="https://openwrt.org/">OpenWrt</a> on it, mounted USB-flash, installed Python, SQLite and libraries. <br><h4>  A test script can be used to check the device‚Äôs performance. </h4><br><div class="spoiler">  <b class="spoiler_title">Tst.py script</b> <div class="spoiler_text"><pre> <code class="python hljs"><span class="hljs-comment"><span class="hljs-comment">#!/usr/bin/python import math from protocol import Protocol deviceAddress = 0 serialPort = '/dev/ttyUSB0' baudRate = 9600 logEnabled = True device = Protocol(serialPort, baudRate, logEnabled) if device.ping(deviceAddress): pressure, sernumP = device.getPressure(deviceAddress) if 10 &lt; pressure &lt; 1000: print ('Pressure - ' + str(pressure) + ' mmHg') humidity, sernumH = device.getHumidity(deviceAddress) if not math.isnan(humidity): print ('Humidity - ' + str(humidity) + '%') values = device.getTemp(deviceAddress) i = 1 for (temperature, sn) in values: print ('T' + str(i) + ' - ' + "%.1f" % temperature + ' C, sensor'), device.printPacket(sn) i += 1 device.close()</span></span></code> </pre><br></div></div><br>  If everything works fine, the output will be something like this: <br><pre> <code class="bash hljs">Opened /dev/ttyUSB0 at 9600. Ping adr=0 Sent 6 bytes:  C0 00 00 B0 01 C0 Received 9 bytes:  C0 00 55 AA 55 AA C3 AA C0 CRC - OK Ping to adr=0 - OK Get the atmospheric pressure. Sent 7 bytes:  C0 00 01 02 91 F1 C0 Received 10 bytes:  C0 00 EB 02 00 00 00 B4 25 C0 CRC - OK 747 mmHg on the sensor with the serial number 00 Pressure - 747 mmHg Get a humidity. Sent 7 bytes:  C0 00 01 03 51 30 C0 Received 10 bytes:  C0 00 9A 99 33 42 00 34 B6 C0 CRC - OK 44.9000015259% on the sensor with the serial number 00 Humidity - 44.9000015259% Get a temperature from sensors. Sent 7 bytes:  C0 00 01 01 90 B1 C0 Received 19 bytes:  C0 00 01 00 80 BD 41 10 60 3B 4F 00 08 00 DB DC 21 1B C0 CRC - OK It has 1 temperature sensors: 23.7C on the sensor with the serial number 10 60 3B 4F 00 08 00 C0 T1 - 23.7 C, sensor 10 60 3B 4F 00 08 00 C0</code> </pre><br><h4>  Now you need to save the measurement results in the database. </h4>  We create the following structure: <br><img src="https://habrastorage.org/files/8d5/7f4/932/8d57f4932972403cba0a0c88f6f83efc.png"><br>  The base contains three main tables - sensortypes, sensors and metering (types, sensors, measurements) and one allrecords view (flat measurement table). <br>  The hourlyrecords and dailyrecords tables contain hourly and daily average data. <br>  In the dbversion table, the database version. <br><blockquote>  Immediately make a reservation - I did not use any built-in SQLite features that go beyond the limits of SQL-92, which appeared in recent versions, since I had 3.8.2 SQLite and had no reason to update it.  But there is a plus, this code can be used from any database with minimal changes. </blockquote><br>  A small class was written to work with the database: <br><div class="spoiler">  <b class="spoiler_title">Class dbhelper.py</b> <div class="spoiler_text"><pre> <code class="python hljs"><span class="hljs-comment"><span class="hljs-comment"># - *- coding: utf- 8 - *- import sqlite3 import time from datetime import datetime class DBHelper: dbconnect = None cursor = None version = 1 def __init__(self, fileName): self.dbconnect = sqlite3.connect(fileName) self.dbconnect.text_factory = str self.cursor = self.dbconnect.cursor() self.cursor.execute('CREATE TABLE IF NOT EXISTS dbversion' + '(_id INTEGER PRIMARY KEY AUTOINCREMENT NOT NULL,' + 'time INTEGER NOT NULL,' + 'version INTEGER NOT NULL)') self.cursor.execute('SELECT version FROM dbversion') if len(self.cursor.fetchall()) == 0: self.cursor.execute('INSERT INTO dbversion (time, version) VALUES (?,?)', (int(time.time()), self.version)) self.cursor.execute('CREATE TABLE IF NOT EXISTS sensortypes' + '(_id INTEGER PRIMARY KEY AUTOINCREMENT NOT NULL,' + 'type TEXT,' + 'valuename TEXT)') self.cursor.execute('SELECT type FROM sensortypes') if len(self.cursor.fetchall()) == 0: self.cursor.execute('INSERT INTO sensortypes (type, valuename) VALUES (?,?)', ('', '. ')) self.cursor.execute('INSERT INTO sensortypes (type, valuename) VALUES (?,?)', ('', ' . .')) self.cursor.execute('INSERT INTO sensortypes (type, valuename) VALUES (?,?)', ('', '%')) self.cursor.execute('CREATE TABLE IF NOT EXISTS sensors' + '(_id INTEGER PRIMARY KEY AUTOINCREMENT NOT NULL,' + 'type INTEGER NOT NULL,' + 'sernum TEXT,' + 'description TEXT NOT NULL,' + 'place TEXT NOT NULL,' + 'FOREIGN KEY (type) REFERENCES sensortypes(_id))') self.cursor.execute('CREATE TABLE IF NOT EXISTS metering' + '(_id INTEGER PRIMARY KEY AUTOINCREMENT NOT NULL,' + 'time INTEGER NOT NULL,' + 'value REAL NOT NULL,' + 'sensorid INTEGER NOT NULL,' + 'FOREIGN KEY (sensorid) REFERENCES sensors(_id))') self.cursor.execute('CREATE TABLE IF NOT EXISTS hourlyrecords' + '(time INTEGER PRIMARY KEY NOT NULL)') self.cursor.execute('CREATE TABLE IF NOT EXISTS dailyrecords' + '(time INTEGER PRIMARY KEY NOT NULL)') self.cursor.execute('CREATE UNIQUE INDEX IF NOT EXISTS "avgday" on dailyrecords (time ASC)') self.cursor.execute('CREATE UNIQUE INDEX IF NOT EXISTS "avghour" on hourlyrecords (time ASC)') self.cursor.execute('CREATE UNIQUE INDEX IF NOT EXISTS "mid" on metering (_id ASC)') self.cursor.execute('CREATE INDEX IF NOT EXISTS "time" on metering (time ASC)') self.cursor.execute('CREATE UNIQUE INDEX IF NOT EXISTS "sid" on sensors (_id ASC)') self.cursor.execute('CREATE UNIQUE INDEX IF NOT EXISTS "stid" on sensortypes (_id ASC)') def updateAvgTables(self): self.cursor.execute('SELECT MAX(_id) FROM sensors') number = self.cursor.fetchone()[0] self.cursor.execute('SELECT * FROM hourlyrecords ORDER BY ROWID ASC LIMIT 1') columnnamelist = [tuple[0] for tuple in self.cursor.description] if number &gt; (len(columnnamelist)-1): for i in range(len(columnnamelist), number+1): self.cursor.execute('ALTER TABLE hourlyrecords ADD COLUMN v%s REAL' % str(i)) self.cursor.execute('ALTER TABLE dailyrecords ADD COLUMN v%s REAL' % str(i)) self.cursor.execute('SELECT MIN(time) FROM metering') minrealtime = self.cursor.fetchone()[0] if minrealtime is not None: self.cursor.execute('SELECT MAX(time) FROM metering') maxrealtime = self.cursor.fetchone()[0] self.cursor.execute('SELECT MAX(time) FROM hourlyrecords') maxhourlyavgtime = self.cursor.fetchone()[0] self.cursor.execute('SELECT MAX(time) FROM dailyrecords') maxdailyavgtime = self.cursor.fetchone()[0] firsthourtime = 3600 firstdaytime = 86400 if maxhourlyavgtime is None: maxhourlyavgtime = minrealtime firsthourtime = 0 if maxdailyavgtime is None: maxdailyavgtime = minrealtime firstdaytime = 0 begintimestamp = datetime.fromtimestamp(float(maxhourlyavgtime)) endtimestamp = datetime.fromtimestamp(float(maxrealtime)) firstedge = datetime(begintimestamp.year, begintimestamp.month, begintimestamp.day, begintimestamp.hour) secondedge = datetime(endtimestamp.year, endtimestamp.month, endtimestamp.day, endtimestamp.hour) begin = int(time.mktime(firstedge.timetuple())) + firsthourtime end = int(time.mktime(secondedge.timetuple()))-1 for i in range(begin, end, 3600): self.cursor.execute('SELECT AVG(time) FROM metering WHERE time &gt;= %s AND time &lt;= %s' % (str(i), str(i+3599))) if self.cursor.fetchone()[0] is None: continue insert = 'INSERT INTO hourlyrecords (time' select = 'SELECT CAST(AVG(time) AS INTEGER)' for v in range(1, number+1): insert += ', v%s' % str(v) select += ', AVG(CASE WHEN sensorid=%s THEN value ELSE NULL END)' % str(v) insert += ') ' select += ' FROM metering WHERE time &gt;= %s AND time &lt;= %s' % (str(i), str(i+3599)) self.cursor.execute(insert + select) begintimestamp = datetime.fromtimestamp(float(maxdailyavgtime)) endtimestamp = datetime.fromtimestamp(float(maxrealtime)) firstedge = datetime(begintimestamp.year, begintimestamp.month, begintimestamp.day) secondedge = datetime(endtimestamp.year, endtimestamp.month, endtimestamp.day) begin = int(time.mktime(firstedge.timetuple())) + firstdaytime end = int(time.mktime(secondedge.timetuple()))-1 for i in range(begin, end, 86400): self.cursor.execute('SELECT AVG(time) FROM metering WHERE time &gt;= %s AND time &lt;= %s' % (str(i), str(i+85399))) if self.cursor.fetchone()[0] is None: continue insert = 'INSERT INTO dailyrecords (time' select = 'SELECT CAST(AVG(time) AS INTEGER)' for v in range(1, number+1): insert += ', v%s' % str(v) select += ', AVG(CASE WHEN sensorid=%s THEN value ELSE NULL END)' % str(v) insert += ') ' select += ' FROM metering WHERE time &gt;= %s AND time &lt;= %s' % (str(i), str(i+85399)) query = insert + select self.cursor.execute(query) def __makeDict(self, raw): res = {'time': raw[0]} for i in range(2, len(raw)+1): res[str(i-1)] = raw[i - 1] return res def getSensorId(self, sensorType, sernum): self.cursor.execute('SELECT _id FROM sensors WHERE sernum=? AND type=?', (sernum, sensorType)) selres = self.cursor.fetchall() if len(selres) &gt; 0: sensorId = selres[0][0] else: self.cursor.execute('INSERT INTO sensors (type, sernum, description, place) VALUES (?,?,?,?)', (sensorType, sernum, '', '')) self.cursor.execute('SELECT _id FROM sensors WHERE sernum=? AND type=?', (sernum, sensorType)) sensorId = self.cursor.fetchone()[0] return sensorId def storeValue(self, time, value, sensorId): self.cursor.execute('INSERT INTO metering (time, value, sensorid) VALUES (?,?,?)', (int(time), value, sensorId)) def getLast(self): self.cursor.execute('SELECT MAX(_id) FROM sensors') number = self.cursor.fetchone()[0] query = 'SELECT time' for i in range(1, number+1): query += ', (SELECT value FROM metering WHERE sensorid=%s AND time=m.time)' % str(i) query += ' FROM metering m WHERE time=(SELECT MAX(time) FROM metering) GROUP BY time' self.cursor.execute(query) return [self.__makeDict(self.cursor.fetchone()), ] def getInterval(self, minTime = None, maxTime = None): self.cursor.execute('SELECT MAX(_id) FROM sensors') number = self.cursor.fetchone()[0] query = 'SELECT time' for i in range(1, number+1): query += ', (SELECT value FROM metering WHERE sensorid=%s AND time=m.time)' % str(i) if minTime is not None and maxTime is not None: query += ' FROM metering m WHERE (time &gt;= ? AND time &lt;= ?) GROUP BY time' self.cursor.execute(query, (minTime, maxTime)) else: query += ' FROM metering m GROUP BY time ORDER BY time' self.cursor.execute(query) return [self.__makeDict(raw) for raw in self.cursor.fetchall()] def updateAllRecordsView(self): self.cursor.execute('SELECT MAX(_id) FROM sensors') number = self.cursor.fetchone()[0] self.cursor.execute('DROP VIEW IF EXISTS allrecords') query = 'CREATE VIEW allrecords AS SELECT time time' for i in range(1, number+1): query += ', max(CASE WHEN sensorid=%s THEN value ELSE NULL END) v%s' % (str(i), str(i)) query += ' FROM metering GROUP BY time ORDER BY time' self.cursor.execute(query) return def getAll(self): return self.getInterval() def getSensors(self): self.cursor.execute('SELECT s._id, st.type, s.sernum, s.description, s.place, st.valuename FROM sensors s, sensortypes st WHERE s.type=st._id ORDER BY s._id') res = [] for raw in self.cursor.fetchall(): res.append({'id': raw[0], 'type': raw[1], 'sernum': ' '.join("%X" % ord(c) if ord(c) &gt; 0x0f else '0' + "%X" % ord(c) for c in raw[2]), 'description': raw[3], 'place': raw[4], 'valuename': raw[5]}) return res def updateSensor(self, sensorid, description, place): self.cursor.execute('UPDATE sensors SET description = ?, place = ? WHERE _id = ?', (description, place, sensorid)) def getDBVersion(self): self.cursor.execute('SELECT version FROM dbversion WHERE _id=(SELECT MAX(_id) FROM dbversion)') return self.cursor.fetchone()[0] def close(self): self.dbconnect.commit()</span></span></code> </pre><br></div></div><br><h4>  The next step is to combine the poll of sensors with saving in the database </h4><br><div class="spoiler">  <b class="spoiler_title">Getweather.py poll script</b> <div class="spoiler_text"><pre> <code class="python hljs"><span class="hljs-comment"><span class="hljs-comment">#!/usr/bin/python # - *- coding: utf- 8 - *- import math from protocol import Protocol import sys import time import os from dbhelper import DBHelper deviceAddress = 0 serialPort = '/dev/ttyUSB0' baudRate = 9600 logEnabled = True dbFileName = 'weatherstation.db' # modulePath = os.path.abspath('/home/weather') + '/' # dbFileName = modulePath + 'weatherstation.db' termSensorType = 1 pressureSensorType = 2 humiditySensorType = 3 if len(sys.argv) == 3: serialPort = sys.argv[1] baudRate = sys.argv[2] deviceAddress = sys.argv[3] logEnabled = sys.argv[4] elif len(sys.argv) == 1: print ('Command line: getweather.py serial_port serial_speed') print ('Trying with serial_port = ' + serialPort + ' and serial_speed = ' + str(baudRate)) else: print ('Command line: getweather.py serial_port serial_speed') sys.exit(1) currenttime = time.time() db = DBHelper(dbFileName) device = Protocol(serialPort, baudRate, logEnabled) if device.ping(deviceAddress): pressure, sernumP = device.getPressure(deviceAddress) if 10 &lt; pressure &lt; 1000: print ('Pressure - ' + str(pressure) + ' mmHg') pressureSensorId = db.getSensorId(pressureSensorType, sernumP) db.storeValue(currenttime, pressure, pressureSensorId) humidity, sernumH = device.getHumidity(deviceAddress) if not math.isnan(humidity): print ('Humidity - ' + str(humidity) + '%') humiditySensorID = db.getSensorId(humiditySensorType, sernumH) db.storeValue(currenttime, humidity, humiditySensorID) values = device.getTemp(deviceAddress) i = 1 for (temperature, sn) in values: print ('T' + str(i) + ' - ' + "%.1f" % temperature + ' C, sensor'), device.printPacket(sn) i += 1 termSensorId = db.getSensorId(termSensorType, sn) db.storeValue(currenttime, temperature, termSensorId) device.close() db.updateAvgTables() db.updateAllRecordsView() db.close()</span></span></code> </pre><br></div></div><br>  Next, copy the files to our host computer, add a task to the scheduler to run getweater.py every 5 minutes, and leave our device to collect statistics. <br><br>  Now you need to get this data somehow.  Develop API: <br><br>  <b>/ws.py</b> will return the html page with the last entry from the database. <br>  <b>/ws.py?mtd=last</b> - the last entry in the database in json-string format. <br>  <b>/ws.py?mtd=intervalmin=XXmax=YY</b> - the range of records between the dates min and max in the format of a json string. <br>  <b>/ws.py?mtd=all</b> - all entries in json string format. <br>  <b>/ws.py?mtd=version</b> - database version in json-string format. <br>  <b>/sensors.py</b> - html-page with a list of sensors. <br><br>  To do this, we write a simple web-service and editor of sensors. <br><br><div class="spoiler">  <b class="spoiler_title">Ws.py script</b> <div class="spoiler_text"><pre> <code class="python hljs"><span class="hljs-comment"><span class="hljs-comment">#!/usr/bin/python # - *- coding: utf- 8 - *- import sys import os import json import cgi import time modulePath = os.path.dirname(__file__) + '/../../' # modulePath = os.path.abspath('/home/weather') + '/' sys.path.append(modulePath) from dbhelper import DBHelper method = 'mtd' version = 'version' minThr = 'min' maxThr = 'max' dbFileName = modulePath + 'weatherstation.db' # dbFileName = modulePath + 'genweather.db' db = DBHelper(dbFileName) def makeJSON(records): return json.JSONEncoder().encode({'sensors': db.getSensors(), 'records': records}) args = cgi.FieldStorage() if len(args) == 0: sensors = db.getSensors() records = db.getLast() print 'Content-Type: text/html; charset=utf-8' print defaulthtml = """ &lt;title&gt;&lt;/title&gt; &lt;h1&gt;&lt;/h1&gt; &lt;hr&gt;""" defaulthtml += '&lt;P&gt;' + time.strftime("%d.%m.%Y %H:%M", time.localtime(records[0]['time'])) + '&lt;/P&gt;' defaulthtml += '&lt;table border=0&gt;' for i in range(1, len(sensors) + 1): if records[0][str(i)] is not None: defaulthtml += '&lt;tr&gt;' defaulthtml += '&lt;td&gt;' + str(sensors[i - 1]['id']) + '&lt;/td&gt;' defaulthtml += '&lt;td&gt;' + sensors[i - 1]['type'] + '&lt;/td&gt;' defaulthtml += '&lt;td&gt;' + sensors[i - 1]['description'] + '&lt;/td&gt;' defaulthtml += '&lt;td&gt;' + sensors[i - 1]['place'] + '&lt;/td&gt;' defaulthtml += '&lt;td&gt;' + "%.1f" % records[0][str(i)] + '&lt;/td&gt;' defaulthtml += '&lt;td&gt;' + sensors[i - 1]['valuename'] + '&lt;/td&gt;' defaulthtml += '&lt;/tr&gt;' defaulthtml += '&lt;p&gt;&lt;a href="sensors.py"&gt;&lt;/a&gt;&lt;/p&gt;' print defaulthtml elif method in args: if args[method].value == 'last': print "Content-type: application/json" print print (makeJSON(db.getLast())) elif args[method].value == 'all': print "Content-type: application/json" print print (makeJSON(db.getAll())) elif args[method].value == 'interval': if minThr in args: if maxThr in args: print "Content-type: application/json" print print (makeJSON(db.getInterval(args[minThr].value, args[maxThr].value))) elif args[method].value == version: print "Content-type: application/json" print print (json.JSONEncoder().encode({version: db.getDBVersion()})) db.close()</span></span></code> </pre><br></div></div><br><div class="spoiler">  <b class="spoiler_title">Script sensors.py</b> <div class="spoiler_text"><pre> <code class="python hljs"><span class="hljs-comment"><span class="hljs-comment">#!/usr/bin/python # - *- coding: utf- 8 - *- import sys import os import cgi modulePath = os.path.dirname(__file__) + '/../../' # modulePath = os.path.abspath('/home/weather') + '/' sys.path.append(modulePath) from dbhelper import DBHelper method = 'mtd' sensorNumber = 'sensornumber' dbFileName = modulePath + 'weatherstation.db' db = DBHelper(dbFileName) args = cgi.FieldStorage() if len(args) == 0: sensors = db.getSensors() print 'Content-Type: text/html; charset=utf-8' print sensorshtml = """ &lt;title&gt;&lt;/title&gt; &lt;h1&gt;&lt;/h1&gt; &lt;hr&gt; &lt;table border=0&gt; &lt;tr&gt; &lt;td&gt; ‚Ññ &lt;/td&gt; &lt;td&gt;&lt;/td&gt; &lt;td&gt; s/n &lt;/td&gt; &lt;td&gt;&lt;/td&gt; &lt;td&gt; &lt;/td&gt; &lt;td&gt;. &lt;/td&gt; &lt;/tr&gt;""" url = 'sensors.py?mtd=sensor&amp;' for s in sensors: sensorshtml += '&lt;tr&gt;' sensorshtml += '&lt;td&gt;' + '&lt;a href="' + url + sensorNumber + '=' + str(s['id']) + '"&gt;' + str(s['id']) + '&lt;/a&gt;&lt;/td&gt;' sensorshtml += '&lt;td&gt;' + '&lt;a href="' + url + sensorNumber + '=' + str(s['id']) + '"&gt;' + s['type'] + '&lt;/a&gt;&lt;/td&gt;' sensorshtml += '&lt;td&gt;' + '&lt;a href="' + url + sensorNumber + '=' + str(s['id']) + '"&gt;' + s['sernum'] + '&lt;/a&gt;&lt;/td&gt;' sensorshtml += '&lt;td&gt;' + '&lt;a href="' + url + sensorNumber + '=' + str(s['id']) + '"&gt;' + s['description'] + '&lt;/a&gt;&lt;/td&gt;' sensorshtml += '&lt;td&gt;' + '&lt;a href="' + url + sensorNumber + '=' + str(s['id']) + '"&gt;' + s['place'] + '&lt;/a&gt;&lt;/td&gt;' sensorshtml += '&lt;td&gt;' + '&lt;a href="' + url + sensorNumber + '=' + str(s['id']) + '"&gt;' + s['valuename'] + '&lt;/a&gt;&lt;/td&gt;' sensorshtml += '&lt;/tr&gt;' print sensorshtml elif method in args: if args[method].value == 'sensor': if sensorNumber in args: numstr = args[sensorNumber].value if numstr.isdigit(): num = int(numstr) - 1 sensors = db.getSensors() if 0 &lt;= num &lt;= len(sensors): sensor = sensors[num] sensorshtml = """&lt;!DOCTYPE html&gt; &lt;html lang="en"&gt; &lt;head&gt; &lt;meta charset="UTF-8"&gt; &lt;title&gt;&lt;/title&gt; &lt;/head&gt; &lt;body&gt; &lt;H1&gt; &lt;/H1&gt; &lt;hr&gt; &lt;form method=POST action="sensors.py"&gt; &lt;B&gt; ‚Ññ %s&lt;/B&gt; &lt;input type=text name=id value="%s" hidden&gt; &lt;B&gt;&lt;/B&gt; &lt;input type=text name=type value="%s" disabled&gt; &lt;B&gt; s/n &lt;/B&gt; &lt;input type=text name=sernum value="%s" disabled&gt; &lt;B&gt;&lt;/B&gt; &lt;input type=text name=description value="%s"&gt; &lt;B&gt; &lt;/B&gt; &lt;input type=text name=place value="%s"&gt; &lt;B&gt;. &lt;/B&gt; &lt;input type=text name=valuename value="%s" disabled&gt; &lt;input type=submit name="save" value=""&gt; &lt;/form&gt; &lt;/body&gt; &lt;/html&gt;""" % (sensor['id'], sensor['id'], sensor['type'], sensor['sernum'], sensor['description'], sensor['place'], sensor['valuename']) print 'Content-Type: text/html; charset=utf-8' print print sensorshtml elif 'save' in args: description = cgi.escape(args['description'].value) if 'description' in args else '' place = cgi.escape(args['place'].value) if 'place' in args else '' sensorid = int(args['id'].value) print 'Content-Type: text/html; charset=utf-8' print db.updateSensor(sensorid, description, place) savehtml = """&lt;!DOCTYPE html&gt; &lt;html lang="en"&gt; &lt;head&gt; &lt;meta charset="UTF-8"&gt; &lt;meta http-equiv="refresh" content="1;url=sensors.py"&gt; &lt;title&gt;&lt;/title&gt; &lt;/head&gt;""" print savehtml db.close()</span></span></code> </pre><br></div></div><br>  These two scripts need to be placed in the cgi-bin directory of the web server (in my case, this is / www / cgi-bin), make them executable and give permissions to execute: <br><br><pre> <code class="bash hljs">chmod -R 755 /www/cgi-bin chmod -R +x /www/cgi-bin</code> </pre><br>  For those who do not wish to allocate a separate computer for weather data collection and (or) do not want to install a full-fledged web server on their only one, I can recommend this script: <br><br><div class="spoiler">  <b class="spoiler_title">Webserver.py script</b> <div class="spoiler_text"><pre> <code class="python hljs"><span class="hljs-comment"><span class="hljs-comment">#!/usr/bin/python # - *- coding: utf- 8 - *- import BaseHTTPServer import CGIHTTPServer import cgitb cgitb.enable() server = BaseHTTPServer.HTTPServer handler = CGIHTTPServer.CGIHTTPRequestHandler server_address = ("", 8000) handler.cgi_directories = ["/cgi-bin"] httpd = server(server_address, handler) httpd.serve_forever()</span></span></code> </pre><br></div></div><br>  By running it on the command line, you will get a web server that allows you to debug cgi-scripts and simple pages.  As a result, the following should turn out: <br><br><img src="https://habrastorage.org/files/910/f2d/07e/910f2d07ec864162967997a89da102a1.png"><br><br><img src="https://habrastorage.org/files/b7e/8e4/461/b7e8e4461f0941f390db53dd30e0ffe4.png"><br><br><img src="https://habrastorage.org/files/066/50c/1dc/06650c1dcb7341afbdc0cacd11fd0b81.png"><br><br>  All code is available on <a href="https://github.com/ndrwk/weatherstation">github</a> . <br><br><h3>  Conclusion </h3><br>  I described the problem of collecting weather data as an example of how to build a system for fixing any measurable processes ‚Äî how to build an exchange protocol, how to protect data from distortion during transmission, and how to store it in a database.  The reader, if desired, will be able to adapt this project to fit their needs. <br><br>  You can write a separate article on how to use this data later, for example, how to make a remote control from an old abandoned Android tablet to display the observation diary. <br><br>  Thank you for your attention, I hope it was interesting. </div><p>Source: <a href="https://habr.com/ru/post/302164/">https://habr.com/ru/post/302164/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../302154/index.html">Basics of Elm Development (Beginner's Toolkit Guide)</a></li>
<li><a href="../302156/index.html">Why are we glad that we did not get to themeforest</a></li>
<li><a href="../302158/index.html">War of Delays: Why is low delay so important?</a></li>
<li><a href="../302160/index.html">Why PostgreSQL is better than other open source SQL databases. Part 2</a></li>
<li><a href="../302162/index.html">How to help the forces of good fight spam or DMARC on your server</a></li>
<li><a href="../302168/index.html">Pivoting or port forwarding</a></li>
<li><a href="../302170/index.html">Stack Trace in C ++ or cycling, level ‚ÄúBydlokod‚Äù</a></li>
<li><a href="../302172/index.html">Hosting provider RUVDS joins ISIC student discount program partners</a></li>
<li><a href="../302174/index.html">Cloud computing economics</a></li>
<li><a href="../302176/index.html">FileChangesWatcher</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>