<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Making Your Time Machine for Linux</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="After intensive use of the time machine on poppies and a couple of situations when it really came in handy (there were options when I had to install a...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Making Your Time Machine for Linux</h1><div class="post__text post__text-html js-mediator-article">  After intensive use of the time machine on poppies and a couple of situations when it really came in handy (there were options when I had to install a system from backups and a warrant when I had to roll back after problems), a thought arose that there is actually no such convenient system on Linux.  After researching the question and interviewing familiar Linux users, it turned out that: <br>  1. You can make such a system in just a few minutes on your knees. <br>  2. strange, but somehow no one actually knows that it can be raised so quickly. <br>  3. our Linux time machine will be with mahjong and geisha. <br><a name="habracut"></a><br><br>  There was just an unnecessary appletv of the first generation from which it was decided to make a small server on hardeded linux to collect logs and all sorts of auxiliary purposes.  After installing hardened gentoo, the question arose of how to back it up so that the entire disk and immediately - so that you can roll out the backup to a new disk or a completely new appletv (if you find such a course of course), or selectively restore remote or lost files just referring to a specific date. <br><br>  How does the time machine work?  Quite simply, the first image of the system is simply copied as files with all the attributes in Backups.backupdb / hostname / YYYY-MM-dd-hhmmss, + a Latest link is made to indicate the last image.  And already at the second cast, the following happens: the file dates are compared and if the file has not changed, instead of a new copy of the file, a hardlink is made to the file from the previous cast.  Then, if there are no file changes, then the entire new cast will completely refer to the previous one.  Nuggets will differ only in new / modified / deleted files.  As a result, you can simply remove any cast (directory type YYYY-MM-dd-hhmmss) and nothing breaks.  The closest association is a smart pointer in c ++ for example: when the last link to the file disappears (from all the snapshots) it will be deleted from the disks. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      A very convenient system from the point of view of viewing previous files, their restoration, deleting old backups, etc.  Until the restoration of the entire system from the cast. <br><br>  After researching all the backup systems I know for Linux, they were discarded as a bit of something not really necessary.  But there was the simplest solution with rsync in one line. <br><br>  rsync has a wonderful option --link-dest which makes all the above described logic compared to previous casts and hardlink creation.  The -x option excludes all mounted file systems like / proc / sys / dev, and so on.  --delete will delete files that will be lost. <br><br>  The whole time machine will be one script like: <br><br>  #! / bin / sh <br>  date = `date" +% Y-% m-% d-% H% M% S "` <br>  Src = / <br>  DST = / mnt / backup-hdd / Backups.backupdb / atv <br><br>  rsync -ax \ <br>  --delete \ <br>  --link-dest = .. / Latest \ <br>  $ Src $ dst / processing- $ date \ <br>  &amp;&amp; cd $ DST \ <br>  &amp;&amp; mv Processing- $ date $ date \ <br>  &amp;&amp; rm -f Latest \ <br>  &amp;&amp; ln -s $ date Latest <br><br>  Copy the script in /etc/cron.hourly and voila we have backups as in the time machine. <br>  If our system crashes, we can boot from the flash drive, format the partition, and run the same rsync in the opposite direction, then reboot or chroot and the system is working again. <br><br>  We‚Äôll also put in /etc/cron.daily a simple script that will delete hourly impressions of the previous days, leaving only 24 for the last day, then delete daily impressions for previous months, etc. - like in apple time machine, just choose your sequence. <br><br>  We want to upload backups over the network to the backup server?  Also please.  We do auto authorization with ssh keys and slightly change the script: <br><br>  #! / bin / sh <br>  date = `date" +% Y-% m-% d-% H% M% S "` <br>  Src = / <br>  DST = / mnt / backup-server-hdd / Backups.backupdb / atv <br><br>  rsync -axz \ <br>  --delete \ <br>  --link-dest = .. / Latest \ <br>  $ Src backup-user@company.com: $ DST / Processing- $ date \ <br>  &amp;&amp; ssh backup-user@company.com \ <br>  "Cd $ DST \ <br>  &amp;&amp; mv Processing- $ date $ date \ <br>  &amp;&amp; rm -f Latest ¬ª <br>  &amp;&amp; ln -s $ date Latest " <br><br>  We are testing, the 3GB system on the appletv was compared to the last image on the server in five minutes - the remote server is not on the local network, the connection was about 1.5MB / s.  We added "-z" for compression.  Not bad, but if it will grow you can do not hourly but with a large range.  It is necessary to indicate that rsync over the network does not seem to transfer the ‚Äúowner: group‚Äù files - since it will use the backup-user @ ... user - you can simply dump all file attributes into a text file and put it into backup. <br><br>  Now what is not Mac users <br>  1. Flexible configuration with cron. <br>  2. The option --exclude = PATTERN / - exclude-from = FILE allows you to specify much more flexible rules for exclusion than simply specifying folders.  For example, I am very unhappy that the time machine backs up all * .o files on my poppy - the project compilation is easily scattered over a couple of gigabytes of obj files, and I don‚Äôt want to exclude project folders from the backup. <br>  3. It is easy to add extra logic to create database locks if needed <br>  4. It is also easy to make, in addition to the impression, still corresponding to the impression of only those files that have changed - it is easy to monitor later which files were changed.  Since hardlink is not a lot of space. <br>  5. Now add what you want, you still have Linux in your hands;) <br><br>  Update: Probably add a list of backup system requirements that I had in my head when I looked at the available packages / systems: <br>  1. Ease of use (rsync: just one command) <br>  2. Accessibility (perhaps find rsync on any livecd) <br>  3. Dependencies (if you crashed a disk, did you boot from livecd, then now you need to put packages with their dependencies somewhere?) <br>  4. The absence of a config file or their minimum (or is it now necessary to first search for a config in the backup?) </div><p>Source: <a href="https://habr.com/ru/post/149059/">https://habr.com/ru/post/149059/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../149052/index.html">Google‚Äôs billing system has received new features</a></li>
<li><a href="../149054/index.html">Cuts Technet Subscriptions</a></li>
<li><a href="../149055/index.html">What kind of power does a ‚Äústrong AI‚Äù need?</a></li>
<li><a href="../149056/index.html">Partial application and currying in C ++</a></li>
<li><a href="../149057/index.html">Dark Eclipse Juno?</a></li>
<li><a href="../149060/index.html">AngularJS - a framework for dynamic web applications from Google</a></li>
<li><a href="../149061/index.html">How to stop regularly repairing computers to neighbors and acquaintances of their friends, but do not pass for ignorance</a></li>
<li><a href="../149062/index.html">The idea of ‚Äã‚Äãorganizing a distributed network infrastructure of mixed type for the publication of electronic educational resources</a></li>
<li><a href="../149063/index.html">Custom jUnit processing of tests in TeamCity</a></li>
<li><a href="../149066/index.html">Parameterized queries and django orm performance</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>