<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Video from a surveillance camera on the site for free and without SMS</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="There is a need to show video from the camera on the site online. There were several options (I will add options from comments, if there are any): 


...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Video from a surveillance camera on the site for free and without SMS</h1><div class="post__text post__text-html js-mediator-article">  There is a need to show video from the camera on the site online.  There were several options (I will add options from comments, if there are any): <br><br><ul><li>  Give access to the camera.  Just do not give access to the camera for security reasons.  The camera will fall under a very small load. </li><li>  Commercial service.  We give them access to the camera and money, they link us to post on the site.  They also solve the problem of camera compatibility and user browsers, channel performance and availability. </li><li>  In their capacities.  Something is put between the user and the camera that is responsible for browser compatibility, performance and accessibility.  We solve problems ourselves. </li></ul><br>  This option will be considered below.  Since  " <i>flash died</i> " or " <i>flash is about to die,</i> " the option of placing a flash player on the site was not considered.  The thorny way of finding solutions on the Internet did not lead to a ready-made solution.  I had to invent a bicycle. <br><br>  More inventions under the cut. <br><a name="habracut"></a><br><h2>  Description of the bike received in more detail: </h2><br><ul><li>  Surveillance camera gives stream via <a href="https://ru.wikipedia.org/wiki/RTSP">rtsp</a> protocol. </li><li>  <a href="https://ffmpeg.org/">ffmpeg</a> takes a video stream from the camera and creates a video for display via the <a href="http://htmlbook.ru/html/video">html5 standard video</a> tag. </li><li>  <a href="http://nginx/">nginx</a> gives the created files to users </li><li>  video on the page is shown using <a href="https://ru.wikipedia.org/wiki/HLS">hls</a> , or rather this <a href="https://github.com/dailymotion/hls.js/tree/master">implementation</a> </li></ul><br><h3>  More about settings </h3><br>  On each stream from the camera, you need to run <a href="https://ffmpeg.org/">ffmpeg</a> to convert <a href="https://ru.wikipedia.org/wiki/RTSP">rtsp</a> to files that <a href="https://ru.wikipedia.org/wiki/HLS">hls</a> will understand. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h4>  ffmpeg and stream with sound </h4><br><pre><code class="bash hljs">/usr/bin/ffmpeg \ -i rtsp://&lt;     ONVIF Device Manager&gt; \ -ar 44100 \ -acodec aac -ac 1 -strict -2 -crf 18 \ -c:v copy -preset ultrafast \ -flags -global_header \ -fflags flush_packets -tune zerolatency \ -hls_time 1 -hls_list_size 3 -hls_wrap 4 -hls_flags delete_segments -start_number 0 \ /tmp/www/index1.m3u8</code> </pre> <div class="spoiler">  <b class="spoiler_title">ffmpeg at start writes 25 fps with FullHD</b> <div class="spoiler_text"><pre> <code class="bash hljs">Guessed Channel Layout <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> Input Stream <span class="hljs-comment"><span class="hljs-comment">#0.1 : mono Input #0, rtsp, from 'rtsp://192.168.XX:554/user=admin_password=tlJwpbo6_channel=1_stream=0.sdp?': Metadata: title : RTSP Session Duration: N/A, start: 0.000000, bitrate: N/A Stream #0:0: Video: h264 (Baseline), yuv420p, 1920x1080, 25 fps, 9 tbr, 90k tbn, 50 tbc Stream #0:1: Audio: pcm_alaw, 8000 Hz, 1 channels, s16, 64 kb/s Output #0, hls, to '/tmp/www/index1.m3u8': Metadata: title : RTSP Session encoder : Lavf56.25.101 Stream #0:0: Video: h264, yuv420p, 1920x1080, q=2-31, 25 fps, 9 tbr, 90k tbn, 25 tbc Stream #0:1: Audio: aac, 44100 Hz, mono, fltp, 128 kb/s Metadata: encoder : Lavc56.26.100 aac Stream mapping: Stream #0:0 -&gt; #0:0 (copy) Stream #0:1 -&gt; #0:1 (pcm_alaw (native) -&gt; aac (native))</span></span></code> </pre>  The video is simply copied, the audio had to be recoded otherwise silence. <br>  Noname camera. </div></div><h4>  How does it work: </h4><br>  We take a stream, without transcoding we create files and a list for playback in the folder <i>/ tmp / www /</i> . <br><br><h4>  nginx </h4><br>  We shorten the standard for the <a href="https://www.debian.org/index.ru.html">debian</a> package file <i>default</i> to, for example, this: <br><br><div class="spoiler">  <b class="spoiler_title">/ etc / nginx / sites-enabled / default</b> <div class="spoiler_text"><pre> <code class="bash hljs">server { listen 80 default_server; listen [::]:80 default_server; access_log off; error_log /dev/null; root /tmp/www; index index.html; server_name _; location / { <span class="hljs-comment"><span class="hljs-comment"># First attempt to serve request as file, then # as directory, then fall back to displaying a 404. try_files $uri $uri/ =404; } }</span></span></code> </pre> </div></div><br>  Sample video page: <br><br><div class="spoiler">  <b class="spoiler_title">/tmp/www/index.html</b> <div class="spoiler_text"><pre> <code class="bash hljs">&lt;!DOCTYPE html&gt; &lt;html&gt; &lt;head&gt; &lt;title&gt;&lt;/title&gt; &lt;/head&gt; &lt;body&gt; &lt;script src=<span class="hljs-string"><span class="hljs-string">"https://cdn.jsdelivr.net/hls.js/latest/hls.min.js"</span></span>&gt;&lt;/script&gt; &lt;video id=<span class="hljs-string"><span class="hljs-string">"video"</span></span>&gt;&lt;/video&gt; &lt;script&gt; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(Hls.isSupported()) { var video = document.getElementById(<span class="hljs-string"><span class="hljs-string">'video'</span></span>); var hls = new Hls(); hls.loadSource(<span class="hljs-string"><span class="hljs-string">'/index1.m3u8'</span></span>); hls.attachMedia(video); hls.on(Hls.Events.MANIFEST_PARSED,<span class="hljs-function"><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">function</span></span></span></span>() { video.play(); }); } &lt;/script&gt;</code> </pre></div></div><br>  The script should be placed locally, it has no external dependencies.  <a href="https://github.com/dailymotion/hls.js/tree/master">Read more about hls settings</a> . <br><br><h4>  How does it work: </h4><br>  hls connects to the page and plays files from the index1.m3u8 list.  List and files are updated ffmpeg. <br><br><h4>  What happened: </h4><br><ul><li>  Works; </li><li>  The biggest load is created by ffmpeg, on an Atom processor three years ago; <ul><li>  Camera resolution Full HD without sound - 1%; </li><li>  Full HD camera resolution with sound - 5%; </li></ul><br></li><li>  The number of nginx processes - look at the load and the available channel.  The load on the processor could not be seen - not very much to just return small files. </li><li>  A server with ffmpeg and nginx can be placed anywhere, not necessarily on hosting or in the location of cameras; </li><li>  The lag of the stream depends on the number of files in the list and the size (in seconds) of the file.  For example, a delay of 10 seconds does not really affect the viewing of the construction of a high-rise building; </li><li>  Video files are best placed on tmpfs, they are small and often overwritten; </li><li>  All service should be placed in a container.  All packages are standard for <code>FROM debian:jessie</code> ; </li><li>  According to the results of operation, ffmpeg sometimes falls, you need to monitor it and restart if it fell. <br><br><div class="spoiler">  <b class="spoiler_title">The top output from the container:</b> <div class="spoiler_text"><pre> <code class="bash hljs">top - 11:05:20 up 6 days, 12:15, 0 users, load average: 1.29, 1.09, 1.03 Tasks: 17 total, 1 running, 16 sleeping, 0 stopped, 0 zombie %Cpu(s): 38.8 us, 1.0 sy, 0.0 ni, 59.6 id, 0.0 wa, 0.0 hi, 0.5 si, 0.0 st KiB Mem: 16359132 total, 16027988 used, 331144 free, 782968 buffers KiB Swap: 6369276 total, 3776 used, 6365500 free. 12784916 cached Mem PID USER PR NI VIRT RES SHR S %CPU %MEM TIME+ COMMAND 281 root 20 0 341040 29192 19632 S 4.7 0.2 10:08.39 ffmpeg 16 root 20 0 315888 27944 18984 S 1.0 0.2 2:50.95 ffmpeg 9 root 20 0 46916 15128 6408 S 0.3 0.1 0:58.04 supervisord</code> </pre> </div></div></li><li>  You can watch on desktops and mobile devices with modern browsers; </li><li>  In the foreseeable future will not require intervention. </li></ul><br><h4>  References: </h4><br>  ¬ª <a href="https://github.com/dailymotion/hls.js/tree/master">Hls implementation</a> <br>  ¬ª <a href="http://dailymotion.github.io/hls.js/demo/">Work demo hls</a> <br>  ¬ª <a href="https://ffmpeg.org/">Ffmpeg</a> <br>  ¬ª <a href="https://nginx.org/ru/">Nginx</a> <br>  ¬ª <a href="https://blog.erchov.ru/2017/01/%25D0%25B2%25D0%25B8%25D0%25B4%25D0%25B5%25D0%25BE-%25D1%2581-%25D0%25BA%25D0%25B0%25D0%25BC%25D0%25B5%25D1%2580%25D1%258B-%25D0%25BD%25D0%25B0%25D0%25B1%25D0%25BB%25D1%258E%25D0%25B4%25D0%25B5%25D0%25BD%25D0%25B8%25D1%258F-%25D0%25BD%25D0%25B0-%25D1%2581%25D0%25B0%25D0%25B9%25D1%2582%25D0%25B5-%25D0%25B1%25D0%25B5%25D1%2581/">Updated and expanded text of the article on my blog</a> </div><p>Source: <a href="https://habr.com/ru/post/401107/">https://habr.com/ru/post/401107/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../401095/index.html">What to give you, my dear man?</a></li>
<li><a href="../401097/index.html">Meet the new Spectrum</a></li>
<li><a href="../401101/index.html">The deleted files began to return to the Dropbox folders. Bug fixed</a></li>
<li><a href="../401103/index.html">The first computer of our era. Apple Macintosh History</a></li>
<li><a href="../401105/index.html">Chronometer for space pioneers</a></li>
<li><a href="../401109/index.html">Unexpected meeting. Chapter 5</a></li>
<li><a href="../401111/index.html">15 key components of modern production</a></li>
<li><a href="../401113/index.html">The game Resident Evil 7 with the vaunted protection Denuvo hacked in 5 days</a></li>
<li><a href="../401115/index.html">Friday Digest: Introducing Acoustics and Audio Brands</a></li>
<li><a href="../401117/index.html">Genetics have grown a 4-week-old pig embryo with the beginnings of human organs</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>