<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Home current measurement</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="There is a whole class of devices called Ethernet Relay that allow you to remotely control the connected load through the network. Most of them are qu...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Home current measurement</h1><div class="post__text post__text-html js-mediator-article">  There is a whole class of devices called Ethernet Relay that allow you to remotely control the connected load through the network.  Most of them are quite expensive - closer to $ 100, and deliberately inferior in price and flexibility in setting up a bundle of, say, Raspberry Pi + <a href="http://www.piface.org.uk/products/piface_digital/">PiFace</a> .  And what if the task is not only to turn on and off the load, but also to measure the current flowing?  This requires the actual sensor (on the shunt or Hall effect) and the ADC (the Raspberry Pi does not contain an integrated ADC).  As a sensor, you can take an inexpensive ACS712, and as an ADC, for example, <a href="http://www.abelectronics.co.uk/products/3/Raspberry-Pi/17/ADC-Pi-V2---Raspberry-Pi-Analogue-to-Digital-converter">ADC-Pi</a> . <br><br>  I didn‚Äôt like ADC-Pi for two reasons: <br><ul><li>  at the frequency of measurements that is required to determine the AC power in the network, this ADC gives a very large error (most likely I did not completely understand the registers) </li><li>  Using this ADC in conjunction with Raspberry Pi for Linux is difficult to ensure the necessary stability of the measurement period.  Installing and configuring RTOS Linux only for this task seemed to me too complex, especially since there is a simpler and proven solution: <a href="http://www.arduino.cc/">Arduino</a> </li></ul><br>  All Arduino already has an ADC (8-bit, but this is quite enough), sketches for Arduino are executed with the necessary stability, there are various options for communicating with Raspberry Pi, the simplest of which is a USB cable.  And of course, an attractive price. <br><a name="habracut"></a><br>  A bunch that I used is shown in the picture. <br><img src="https://habrastorage.org/getpro/habr/post_images/911/820/af3/911820af34739f784e26d4f08d9f0298.png"><br>  Measuring the current is a simple task, if not for one ‚Äúbut‚Äù: the physical sensors are ‚Äúnoisy‚Äù.  The figure shows an example of the actual and calculated current values ‚Äã‚Äãfor my circuit with 512 consecutive measurements. <br><img src="https://habrastorage.org/getpro/habr/post_images/854/0b2/13f/8540b213f36e606fc8f9c65b7318522a.png"><br><br>  Thus, the task of measuring alternating current is to calculate the amplitude of a sinusoid from a set of actual measurements containing a significant proportion of errors. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h5>  Attempt number one </h5><br><br>  Formula AC (who forgot - see <a href="http://ru.wikipedia.org/wiki/%25D0%259F%25D0%25B5%25D1%2580%25D0%25B5%25D0%25BC%25D0%25B5%25D0%25BD%25D0%25BD%25D1%258B%25D0%25B9_%25D1%2582%25D0%25BE%25D0%25BA">wiki</a> ) <br><br>  i = Im sin (œât +) <br><br>  Where: <br><br>  Im is the maximum current value <br>  œâ - angular frequency <br>  t - time (sequence number) changes <br>  œà - the initial phase of the current <br><br>  You can try to find the necessary parameters using analytical tools.  And here we are in for a pleasant surprise: last fall (2013), the Wolfram company released a version of its wonderful <a href="http://www.wolfram.com/raspberry-pi/">Mathematica</a> package <a href="http://www.wolfram.com/raspberry-pi/">for the Raspberry Pi</a> .  Free (for home use).  And we can apply it to analyze the data read from the sensor. <br><br>  An example of calling a billing package in Raspberry Pi: <br><br> <code>pi@raspi ~ $ wolfram -script calc_current.wl datafile=/tmp/data.csv</code> <br> <br>  The calc_current.wl script itself is below with comments: <br><br>  Read data from the file passed as parameter.  The file contains lines of the form &lt;measurement number&gt;, &lt;value&gt;. <br><br> <code>data=Import[$CommandLine[[4]]]</code> <br> <br>  When the data is read, you can do a Fourier analysis (Fast Fourier Transform) in order to determine, approximately, the number of sinusoid cycles on the available sample.  The dependence of the current strength on time is non-linear, and the approximate angular velocity calculated from the FFT and transmitted as the initial value will dramatically increase the chances of finding the correct sinusoid parameters. <br><br> <code>fourier=Take[Abs[Fourier[data[[All,2]]]],{2,256}]</code> <br> <br>  If the maximum FFT value is not much different from the average for the sample, we can conclude that there is no pronounced sinusoid, all indicators are ‚Äúnoise‚Äù, and the real current is zero. <br><br> <code>topcycle=Ordering[fourier,-1]</code> <br> <code>avg=Mean[fourier]</code> <br> <code>top=fourier[[topcycle[[1]]]]</code> <br> <code>If[top &lt; 10 * avg, Print["No AC"]; Exit[]]</code> <br> <br>  If a pronounced sinusoid is found, you can try to find the parameters of the function using the most pronounced cycle to calculate the initial value of the angular velocity. <br><br> <code>nlm=NonlinearModelFit[data, a Sin[bx + c]+d, {a,{b, 2 Pi * topcycle[[1]] / 512}, c, d},x]</code> <br> <br>  Knowing the physical characteristics of the ADC (dimension 1024, base voltage 5V) and the sensor (in my version 0.185V / A), one can calculate the effective amperage: <br><br> <code>imax=Abs[nlm["BestFitParameters"][[1]][[2]]] / (1024 / 5 * 0.185)</code> <br> <code>Print["Imax=", imax]</code> <br> <code>iefc=imax / Sqrt[2]</code> <br> <code>Print["Iefc=", iefc]</code> <br> <code>Print["Power=", iefc * 230]</code> <br> <br>  The proposed method works in most cases.  The number of measurements, when NonlinearModelFit could not correctly pick up the parameters of the sine wave, was about 5 percent.  However, each measurement requires a lot of time - I have an average of 5 seconds - to launch the wolfram application.  Therefore‚Ä¶ <br><br><h5>  Attempt number two </h5><br><br>  Since the frequency of the alternating current in the network is stable and amounts (in Russia) to 50 Hz, the angular velocity can be calculated in advance and, instead of nonlinear regression, a linear regression can be obtained.  Indeed, <br><br><img src="//habrastorage.org/files/286/8d6/aed/2868d6aed1514b1e9f5b0094cdd55d7f.png"><br><br>  or <br><br><img src="//habrastorage.org/files/d3a/9fd/1c5/d3a9fd1c59ad4c798f04702ddcb6ec33.png"><br><br>  Differentiating with X and Y, we obtain a system of linear equations: <br><br><img src="//habrastorage.org/files/00f/3b4/d2b/00f3b4d2b17e48cf81901ff81fcd67e4.png"><br><br>  Solving the system according to Cramer, we obtain the values ‚Äã‚Äãof the coefficients: <br><br><img src="//habrastorage.org/files/114/ee1/c84/114ee1c844ef40c2a6f8b78786b1746b.png"><br><br>  Then, according to the Pythagorean theorem, the maximum current value will be: <br><br><img src="//habrastorage.org/files/a6c/be6/a1b/a6cbe6a1b4474a8f8bb4c960947d3852.png"><br><br>  The Arduino sketch that implements this algorithm can be found on <a href="">Github</a> .  The method provides good measurement accuracy: for the circuit in the figure, the measured current value was stably 0.13A, which corresponds to a consumption of 29.9 W at a voltage of 230V.  The nominal value of the light bulb, which served as a load, is 30 watts. <br><br>  By the way, for Arduino there are also shields with relays and all the functionality of control and load monitoring can be implemented on this platform.  Raspberry Pi in this case will be used only for organizing a convenient user interface, for example, via a web server and as a sheduler. <br><habracut></habracut></div><p>Source: <a href="https://habr.com/ru/post/212459/">https://habr.com/ru/post/212459/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../212449/index.html">Connecting a Wacom Pro pen tablet to Linux or how bash helps artists</a></li>
<li><a href="../212451/index.html">Fake Debian developers require free access to Valve games</a></li>
<li><a href="../212453/index.html">Netapp - Reality vs. Marketing</a></li>
<li><a href="../212455/index.html">MtGox problems and spambo-smith</a></li>
<li><a href="../212457/index.html">Analogue cmd from Python for Groovy</a></li>
<li><a href="../212461/index.html">UPS for router</a></li>
<li><a href="../212465/index.html">Difficulties when starting SMS service</a></li>
<li><a href="../212469/index.html">What happens to the Chinese ‚ÄúYuytu?</a></li>
<li><a href="../212473/index.html">Increasing Conversion - A Headache for Online Stores</a></li>
<li><a href="../212477/index.html">There is no access to the largest VOIP-operators in Belarus</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>