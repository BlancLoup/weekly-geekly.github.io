<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Home / Wired Internet with 3g Backup Channel</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="I decided to write, because basically there are articles on the reservation of the main 3g channel to another, and 3g as a backup for the wired Intern...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Home / Wired Internet with 3g Backup Channel</h1><div class="post__text post__text-html js-mediator-article">  I decided to write, because basically there are articles on the reservation of the main 3g channel to another, and 3g as a backup for the wired Internet - for some reason it is difficult to find. <br><br>  The task was to organize for people the reservation of Internet access with automatic channel switching. <br><br>  Having dug up the Internet, devices with support for 3g "whistles" were found.  The choice was from <b>Zyxel Keenetic</b> , <b>drytek</b> and <b>TP-Link</b> (but they worked all their life with Asus and D-Link for objective reasons and their own statistics).  From the experience of solving "all sorts of" tasks, the choice fell on <b>TP-Link</b> .  It was easy to choose, <b>Open WRT</b> is friendly with all <b>TP-Link</b> (s).  The same requirements for <b>3g</b> connection.  Provided me a <b>Huawei E367</b> from the megaphone. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      The box came into my hands.  (I will not describe it, there are many descriptions, immediately to the point).  Pleasant buns from TP-Link always pleased.  In the "field" he has never tested.  Work has always been done with more stable routers.  But Open WRT in this matter - outweighed all doubts.  And as it turned out - not in vain, but more on that later. <br><br>  Basic firmware, basic setup, Wan preffered, run, test.  Emulation "network cable is not connected" works with a bang.  In both directions, the channel is switched as it should.  But we know that ‚Äúfalls‚Äù happen not only on the ‚Äúroof‚Äù, but also further.  Someone dug something, touched the cable, broke it.  The switch is alive, the link on the cable is alive, the router "thinks" that everything is ok.  It does not suit us. <br><br>  <b>Task:</b> <br>  1) TP-LINK TL-MR3420 V2 <br>  2) 3G Internet Megaphone Huawei E367 <br>  3) Provider with settings over Static IP and wire with RJ-45 <br><a name="habracut"></a><br>  Immediately make a reservation that the article is not for beginners, you should be aware of all that you are doing. <br><br>  Having searched the firmware - we did not find the one we needed.  Yes, and the firmware turns off 3g if it is not used, so the transition to 3g takes quite a long time until it turns on, while it identifies the ‚Äúwhistle‚Äù, while it is connected, it takes somewhere a minute and a half at best. <br><br>  So open wrt.  TP-Link updated the hardware, there is no official firmware, but somewhere <b>from January 13, 2013 there are many positive reviews about using this router on the OpenWRT firmware.</b>  We swing, we try, it was got.  (how to sew Open WRT can be found on the Internet). <br><br>  Next, setting the steps <br><br>  <u><b>Stage 1.</b></u> Web muzzle. <br>  Go <a href="http://192.168.1.1/">192.168.1.1</a> <br>  root <br><br><img src="https://habrastorage.org/getpro/habr/post_images/f41/7fc/1d2/f417fc1d2b1878d1a7867279fe80e6a1.png"><br><br>  <b>Step 1.</b> <br>  Setting up the provider - Static IP, everything is intuitive, it worked immediately.  IP, Mask, Gateway, 2 DNS.  Advanced Settings - Use gateway metric set 20, no need to ask why, do not answer.  It is necessary) Anything other than 0. <br>  Firewall Settings leave in wan <br><br>  <b>Step 2.</b> <br>  Setting 3g. <br>  UMTS / GPRS / EV-DO <br>  / dev / ttyUSB0 <br>  UMTS / GPRS <br>  APN: internet <br>  username: megafon <br>  password: megafon <br>  Advanced Settings - Use gateway metric set 10. <br>  Firewall Settings create zone wan_3g <br><br><img src="https://habrastorage.org/getpro/habr/post_images/bae/71c/43b/bae71c43b7beceea68f41f134c8f24e2.png"><br><br>  <b>Step 3.</b> <br>  Lan setting <br>  We do as you like. <br><br>  All interfaces must be enabled when the router boots (Bring up on boot) <br><br>  <b>Step 4.</b> <br>  Network - Firewall <br>  Editing lan, Inter-Zone Forwarding add both wan and wan_3g. <br>  This will save us from a headache with a firewall (I am not friends with iptables) <br>  For the wan_3g zone, copy the checkmarks from the wan zone. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/800/5ea/9ea/8005ea9ea68e50af448933e819b57ba3.png"><br><br>  <b>Step 5.</b> <br>  System - Scheduled Tasks <br>  * / 1 * * * * / etc / config / rezerv / t5t&gt; / dev / null <br><br><img src="https://habrastorage.org/getpro/habr/post_images/b69/70c/460/b6970c460d1220627b3230561fb478e8.png"><br><br>  This is our communication check script, run once a minute. <br>  About files - below, first webmord. <br><br>  <b>Step 6.</b> <br>  Hostnames <br>  Since the Internet is home, or we may need our other hosts, we add what we need. <br>  The step is important.  For the test, we chose <a href="http://www.ru/">www.ru</a> , we will ping it <br>  We create the host alltimeallivehost.lan and take the IP from <a href="http://www.ru/">www.ru</a> -194.87.0.50. <br>  alltimeallivehost.lan - will participate in the check. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/3aa/2d5/40a/3aa2d540a4530471bb9ecc8432a50fba.png"><br><br>  With the muzzle seems to be everything. <br><br>  <u><b>Stage 2</b></u> SSH <br>  we take putty, we go 192.168.1.1 <br><pre><code class="bash hljs">root@OpenWrt:~<span class="hljs-comment"><span class="hljs-comment"># cd /etc/config/ root@OpenWrt:/etc/config# mkdir rezerv root@OpenWrt:/etc/config# cd ./rezerv</span></span></code> </pre> <br><br>  create files: <br><pre> <code class="bash hljs">root@OpenWrt:/etc/config/rezerv<span class="hljs-comment"><span class="hljs-comment"># cat &gt; _</span></span></code> </pre><br>  Copy the text <br>  press Ctrl + Z <br>  File created. <br>  My folder looks like this: <br><pre> <code class="bash hljs">root@OpenWrt:/etc/config/rezerv<span class="hljs-comment"><span class="hljs-comment"># ls -l -rwxrwxrwx 1 root root 190 Feb 19 20:49 3g_on -rwxrwxrwx 1 root root 186 Feb 19 21:14 t5t -rwxrwxrwx 1 root root 1136 Feb 20 13:44 test_sh -rw-r--r-- 1 root root 0 Feb 20 13:44 wan -rwxrwxrwx 1 root root 100 Feb 20 12:13 wan_on</span></span></code> </pre><br>  3g_on, wan_on, t5t, test_sh - executable files <br>  done like this: <br><pre> <code class="bash hljs">root@OpenWrt:/etc/config/rezerv<span class="hljs-comment"><span class="hljs-comment"># chmod 777 </span></span></code> </pre><br><br>  Now the algorithm and files. <br>  wan_on - enables wan interface. <br>  3g_on - enables 3g interface. <br>  test_sh - the main algorithm of work <br>  t5t - call test_sh 5 times.  (it was mentioned above in cron, System - Scheduled Tasks) <br><br>  t5t: <br><pre> <code class="bash hljs">/etc/config/rezerv/test_sh; sleep 8; /etc/config/rezerv/test_sh; sleep 8; /etc/config/rezerv/test_sh; sleep 8; /etc/config/rezerv/test_sh; sleep 8; /etc/config/rezerv/test_sh; sleep 8;</code> </pre><br>  2 seconds to check, sleep 8 seconds, a total of 50 seconds.  Everything is transparent. <br><br>  wan_on: <br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#wan /sbin/ifconfig 3g-3g down #ifconfig eth0 up /sbin/route add default gw 10.112.28.253 metric 0</span></span></code> </pre><br>  The file omits one interface and raises the second, but!  We need eth0 to be constantly alive in order to understand whether the main channel has risen or not.  By this we do not raise it.  (line for commented).  Further it will be clear why. <br><br>  3g_on: <br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#3g - vklu4aem 3g /sbin/ifconfig eth0 down /sbin/ifconfig 3g-3g up /sbin/route add default gw 10.64.64.64 metric 0 /sbin/ifconfig eth0 up /sbin/route add default gw 10.112.28.253 metric 20</span></span></code> </pre><br>  Turning off eth0, when disconnected, all the routes of the interface are reset, raise 3g, prescribe a route for 3g, raises eth0.  Here eth0 prescribes the default route with metric 20 (see Stage 1, webmord), and we have 2 default routes with different metrics. <br>  Well, we finish the route, since it is still lost somewhere. <br><br>  wan - the flag file, says that we have wired internet at the moment. <br><br>  The last file is the main script: <br><pre> <code class="bash hljs">test_sh root@OpenWrt:/etc/config/rezerv<span class="hljs-comment"><span class="hljs-comment"># cat test_sh #!/bin/sh #blok1 DIR=/etc/config/rezerv/ #DIR=/home/calc/rezerv/ ROUTE=/sbin/route GREP=/bin/grep RM=/bin/rm TOUCH=/bin/touch #blok2 #tested address www.ru #WWW_RU=194.87.0.50 WWW_RU=alltimeallivehost.lan #blok3 #flags F3G=3g FWAN=wan FCUR=$FWAN #blok4 #on ON_3G=3g_on ON_WAN=wan_on ON_DEF=$ON_WAN #blok5 #def routines R_WAN=10.112.28.253 R_3G=10.64.64.64 R_CUR=$R_WAN #blok6 #proverka flagov if [ ! -f $DIR$F3G ]; then if [ ! -f $DIR$FWAN ]; then echo "no one file exist, use default iface" echo $DIR$ON_DEF else R_CUR=$R_WAN FCUR=$FWAN fi else R_CUR=$R_3G FCUR=$F3G fi #blok7 #proverka tekushego marshruta if [ "$ROUTE | $GREP default | $GREP $R_CUR | wc -l" != "0" ]; then echo "$FCUR route exist" else echo "add $FCUR route" $ROUTE add default gw $R_CUR metric 0 fi #blok8 #toggle if not work ##PING www.ru if ping -w3 -c2 -I eth0 $WWW_RU &gt; /dev/null 2&gt;&amp;1; then echo "MAIN working"; if [ -f $DIR$F3G ]; then echo "3g used, wan_on" $DIR$ON_WAN $RM $DIR$F3G $TOUCH $DIR$FWAN fi else echo "MAIN not working"; #if [ -f $DIR$FWAN ]; then echo "wan used, 3g_on" $DIR$ON_3G $RM $DIR$FWAN $TOUCH $DIR$F3G #fi fi</span></span></code> </pre><br><br>  <b>Block 1</b> <br>  According to the experience of working with different Linux environment variables disappear somewhere, well, sometimes, that's why everything is hard. <br><br>  <b>Block 2</b> <br>  alltimeallivehost.lan - registered in the face to the hosts. <br><br>  <b>Block 3</b> <br>  Files - flags. <br>  If the file is, then this interface is used. <br><br>  <b>Block 4</b> <br>  Interface Enable Scripts <br><br>  <b>Block 5</b> <br>  Routes, for some reason there were problems with them, so once every 10 seconds we will check the availability of these routes and add them if necessary. <br><br>  <b>Block 6</b> <br>  Checks for the presence of flags in general, if not, then turn on the default interface (wan, wired).  We also look at which interface is currently being used. <br><br>  <b>Block 7</b> <br>  We check the presence of the default route for the used connection, if there is none, then we add the route. <br><br>  <b>Block 8</b> <br>  The main test of the interface. <br>  If pint our host through eth0, then we check which interface is on, if 3g, turn on wan, if wan, or what we don‚Äôt do. <br>  If it does not ping, and the wan interface is used, then we enable the 3g interface. <br><br>  The main logic is ready. <br><br>  Now hammer the last nails. <br><br><pre> <code class="bash hljs">root@OpenWrt:/etc/config/rezerv<span class="hljs-comment"><span class="hljs-comment"># cat /etc/rc.local # Put your custom commands here that should be executed once # the system init finished. By default this file does nothing. echo $((10*1024*1024)) &gt; /sys/block/zram0/disksize mkswap /dev/zram0 swapon /dev/zram0 #udalaem flagi rm /etc/config/rezerv/wan rm /erc/config/rezerv/3g exit 0</span></span></code> </pre><br>  Those.  When loading the router, we delete our flags. <br><br>  in / etc / dnsmasq.conf append a line <br><pre> <code class="bash hljs">dhcp-option=lan,6,10.112.1.1,10.112.2.1,8.8.8.8</code> </pre><br>  so that we would immediately get the required dns on the computer interface.  I did not solve the problems with DNS, it turned out to be easier and faster.  Affected by a lack of knowledge. <br><br>  We must not forget to enable the dnsmasq service and cron, you can do it via the Web. <br><br>  Result of work: <br><pre> <code class="bash hljs">C:\Users\calc&gt;ipconfig /all Ethernet adapter    : DNS-  . . . . . : lan . . . . . . . . . . . . . : Atheros AR8161/8165 PCI-E Gigabit Etherne t Controller (NDIS 6.20)  . . . . . . . . . : 10-BF-48-22-58-64 DHCP . . . . . . . . . . . :   . . . . . . :   IPv6-  . . . : fe80::d1de:d8aa:f5c4:667b%13() IPv4-. . . . . . . . . . . . : 192.168.1.112()   . . . . . . . . . . : 255.255.255.0  . . . . . . . . . . : 20  2013 . 12:11:43   . . . . . . . . . . : 21  2013 . 0:36:25  . . . . . . . . . : 192.168.1.1 DHCP-. . . . . . . . . . . : 192.168.1.1 IAID DHCPv6 . . . . . . . . . . . : 353419080 DUID  DHCPv6 . . . . . . . : 00-01-00-01-17-6E-9B-C2-10-BF-48-22-58-64 DNS-. . . . . . . . . . . : 10.112.1.1 10.112.2.1 8.8.8.8 NetBios  TCP/IP. . . . . . . . : </code> </pre><br><br>  Scheme: Internet - provider zone - switch - router - laptop <br>  We break the connection before the switch: <br><pre> <code class="bash hljs">C:\Users\calc&gt;ping www.ru -t    www.ru [194.87.0.50]  32  :   194.87.0.50:  =32 =2 TTL=57   194.87.0.50:  =32 =2 TTL=57   194.87.0.50:  =32 =2 TTL=57 <span class="hljs-comment"><span class="hljs-comment">#      .     .     .     .     .     .     .   194.87.0.50:  =32 =1946 TTL=47   194.87.0.50:  =32 =78 TTL=47   194.87.0.50:  =32 =56 TTL=47   194.87.0.50:  =32 =55 TTL=47   194.87.0.50:  =32 =64 TTL=47   194.87.0.50:  =32 =53 TTL=47   194.87.0.50:  =32 =52 TTL=47   194.87.0.50:  =32 =61 TTL=47   194.87.0.50:  =32 =60 TTL=47   194.87.0.50:  =32 =59 TTL=47   194.87.0.50:  =32 =57 TTL=47   194.87.0.50:  =32 =57 TTL=47   194.87.0.50:  =32 =55 TTL=47   194.87.0.50:  =32 =54 TTL=47 #         194.87.0.50:  =32 =62 TTL=47   194.87.0.50:  =32 =61 TTL=47   194.87.0.50:  =32 =60 TTL=47   194.87.0.50:  =32 =59 TTL=47   194.87.0.50:  =32 =58 TTL=47 #  wan   194.87.0.50:  =32 =2 TTL=57   194.87.0.50:  =32 =2 TTL=57   194.87.0.50:  =32 =2 TTL=57  Ping  194.87.0.50: :  = 32,  = 25,  = 7 (21% )   -  :  = 2,  = 1946 ,  = 120  Control-C ^C C:\Users\calc&gt;</span></span></code> </pre><br><br>  The device costs 1200 rubles. <br>  The host checks alltimeallivehost.lan, if necessary, changes in the web muzzle. <br>  That's all I wanted to say. <br><br>  UPDATED 06/17/2014 Perezal pictures </div><p>Source: <a href="https://habr.com/ru/post/170169/">https://habr.com/ru/post/170169/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../170159/index.html">In the United States will introduce a new way to combat piracy</a></li>
<li><a href="../170161/index.html">Cross-platform mobile game and stick in the wheel from Android</a></li>
<li><a href="../170163/index.html">Console VIM in Windows</a></li>
<li><a href="../170165/index.html">NASA announced a competition for the best iPad-application for astronauts</a></li>
<li><a href="../170167/index.html">On the way to creating a secure (web) resource. Part 3 - office, staff</a></li>
<li><a href="../170171/index.html">Curiosity prepared to explore a new portion of Mars</a></li>
<li><a href="../170173/index.html">Sony introduced the PlayStation 4</a></li>
<li><a href="../170175/index.html">Results of PlayStation Meeting 2013</a></li>
<li><a href="../170179/index.html">Google is working on a Chromebook with a touch screen.</a></li>
<li><a href="../170187/index.html">7 things a developer needs to know about SQL Server</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>