<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Telegram bot for complex quests</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="‚ÄúWhat is the advantage?‚Äù - you ask, well, the whole thing is that you can build logic in it from about the following expressions: 

 - The user in ste...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Telegram bot for complex quests</h1><div class="post__text post__text-html js-mediator-article">  ‚ÄúWhat is the advantage?‚Äù - you ask, well, the whole thing is that you can build logic in it from about the following expressions: <br><br>  <i>- The user in step N?</i> <i><br></i>  <i>- Does the message contain an image and a smiley?</i> <i><br></i>  <i>- The text fits the regular expression ‚ÄúI am [a-zA-Z] +‚Äù?</i> <i><br></i>  <i>- Time to receive earlier / later specified?</i> <i><br></i>  <i>- Was it a press on the keyboard / a regular message / inline button?</i> <br><br>  Most of these rules may be dependent on each other, but more on that later. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      First, what I want to tell you: <br><br><ol><li>  <a href="https://habr.com/ru/post/347592/">About the idea of ‚Äã‚Äãthe project</a> - why I did it, what are the analogues, but why I do not like them. </li><li>  <a href="https://habr.com/ru/post/347592/">Architectural solutions</a> , what difficulties arose, how they were solved. </li><li>  <a href="https://habr.com/ru/post/347592/">What happened in the end and whether it was worth</a> <a href="https://habr.com/ru/post/347592/">further development</a> . </li></ol><a name="habracut"></a><br><a name="purpose"></a><h3>  Objective of the project </h3><br>  It was at the end of November, I understood that the new year was coming and I needed to give presents. <br>  The idea with Telegram Bot, as a search card, seemed extremely simple and, in due course, interesting.  The only thing that needed to be done was to take and google.  What I actually did.  The main message of the request is a platform for creating quests, or just a chat bot with additional logic written in python (preferably Django Framework) <br>  Most of the reviewed applications either had hardened data, or were a kind of quiz.  Neither the one nor the other. <br><br>  Interesting options seemed: <a href="https://github.com/jlmadurga/django-telegram-bot">Django Telegram Bot</a> , <a href="https://github.com/jlmadurga/permabots">PermaBot</a> . <br><br>  There is no point in lingering on the first repository for a long time, since the description clearly states ‚ÄúTry Permabots: more stable django app for bots.‚Äù.  Therefore we choose the second. <br>  It is worth noting that this platform is made quite qualitatively, although without compliance with pep8 (not a stone in the garden, but this is the de facto standard :)), however, with comments, tests, and most importantly REST API documentation. <br><br>  In the presence of all these advantages, significant shortcomings were found: <br><br><ul><li>  old version of the telegram API (version 4.2.0 vs. 9.0.0, last commit June 2016) </li><li>  complete lack of support for the media (here my idea with images was covered with a copper basin) </li><li>  some missing features (delayed sending of notifications with the settings of a possible answer, flexible setting of the chat keyboard). </li></ul><br>  As a result, the project was launched with the following stack: <br><br>  Web framework - Django, for asynchronous tasks - Celery, message broker - <br>  Redis, database - SQLite.  In the future, it is possible to move to Postgres / MySQL, but for the time being it is pointless to drag this whole machine with you. <br><br>  What is worth noting, for the development and launch of the project, you need an external https address to which the web hooks will fly.  To do this, you can use tunneling to a public domain via <a href="https://ngrok.com/2">Ngrok</a> or <a href="https://localtunnel.github.io/www/">LocalTunnel</a> . <br><br>  I used localtunnel locally and on the server in conjunction with nginx and let's encrypt certificates. <br><br><a name="architecture"></a><h3>  Architecture </h3><br>  Entities: <br><br>  <b>Bot</b> - contains general information and token (analog telegram.Bot in the <a href="https://python-telegram-bot.readthedocs.io/en/stable/telegram.bot.html">office. Documentation</a> ) <br>  <b>Quest</b> - quest model, everything is simple: name, description, bot.  rendered to a separate entity for a logical distinction <br>  <b>Step</b> - possible transition states.  if the flag is is_init = True, then it will be selected as the initial one when the quest is initialized <br>  <b>Handler</b> - acts as a dispatcher, has a logical expression that can be executed or not, depending on this, takes the user to a certain step and sends the corresponding answers (represented by the Response model) <br>  <b>Condition</b> - contains possible rules for a specific field. <br>  <b>Update</b> - an object that arrives with a web hook and contains all the information. <br>  <b>CallbackQuery</b> is used for inline messages, there is no such opportunity to send (the main focus was on the basic keyboard), but the expansion options were taken into account. <br>  <b>Reponse</b> - stores information about the message text, keyboard, its behavior (hide, delete, set by default, show default) <br>  <b>Message</b> - received message object (telegram.Message) <br>  <b>Chat</b> - stores chat information (telegram.Chat) <br>  <b>Photo</b> - a model that stores information about the image (telegram.PhotoSize) <br>  <b>Event</b> - is responsible for sending messages to a specific chat, and has the ability to simultaneously set the status (step) of the user.  all additional data (text, keyboard, settings for it) is taken from the specified Reponse model <br>  <b>User</b> - the user model inherited from contrib.auth.models.AbstractUser with indication of device_uid, step and some additional fields <br><br>  The full UML diagram can be viewed in draw.io, <a href="https://github.com/pm-str/QuestBot">db-diagram.xml</a> file <br><br>  It seems to me that one of the curious aspects is how the decision is made on the choice of a particular handler. <br><br><img src="https://pp.userapi.com/c840629/v840629717/4a736/ZtVjzcZrF2k.jpg" alt="image"><br><br>  In the ‚ÄúMathematics expression‚Äù field, a logical expression can be defined in two ways.  The first is the one specified in the example, in this case the conditions for this handler will be substituted in the order of their addition, in the second variant you can specify the id of the conditions. <br><br>  Then parsing is performed.  It goes through two stages, first a conversion is made to a Boolean mapping, where 1 and 0 are the truth of a particular condition, and then the grammar is parsed using the pyparsing library. <br><br>  Another difficulty that had to face - the choice and indication of the keyboard.  It was decided to make one by default and the other to provide in response.  Thus, it is possible to set a default for the entire chat, which may look something like this [[‚ÄúAsk a Question‚Äù], [‚ÄúAsk a Tip‚Äù]]] <br><br><img src="https://pp.userapi.com/c840629/v840629717/4a75e/NzluycQQAAQ.jpg" alt="image"><br><br>  You can also see that the telegram api allows you to hide the current keyboard when you press a button or delete it completely (in this case, the default is sent). <br><br>  One more thing related to the keyboard is an attempt to find out what it was, either a regular message written by the user or a click on a button.  What is it for? <br>  Suppose at some step we decided to request a text response from the user and at the same time the standard keyboard with the ‚ÄúChange task‚Äù button is displayed there.  Although Handlers contain optional Step on success and Step on error fields, it is much easier to organize the logic by limiting the type of action to which they react.  For this, the Chat model also contains information about the current keyboard, which determines whether it is pressed or another type of event.  This is useful when you need to know what's going on in a particular chat. <br><br>  In addition, from the features that seemed necessary - this is the function redirect message.  In each handler, you can specify who should redirect the message when rendering a verdict of truth.  It comes in handy when you need to trace specific moments (the same question to the administrator) or the passage of some stages by the user. <br><br><a name="theworth"></a><h3>  Is it worth it? </h3><br>  Definitely.  Testing took a couple of evenings, after which I set up and run it on the server.  The quest consisted of 10+ states and included a choice of answer options, a story telling (the essence was in the search for keywords), a task on a map of the area, a photo of the year, and some more. <br><br>  Perhaps the reaction of the person for whom I did it, paid for the evenings before the test week, which I spent. <br><br><a name="future"></a><h3>  Perspectives </h3><br>  At the moment, a working version is ready, which takes place in a docker-container in a couple of minutes, but for full development, tests, a thoughtful environment and some other settings are needed.  If the <a href="https://github.com/pm-str/QuestBot">project</a> seems interesting to someone, then with a desire to continue support / development, the implementation of the frontend is questionable, but possible (on emberJS or vueJS). <br><br>  Thank you for attention! <br><br>  I will be glad to hear questions, suggestions, criticism </div><p>Source: <a href="https://habr.com/ru/post/347592/">https://habr.com/ru/post/347592/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../347582/index.html">Personal experience: how we transferred the infrastructure from one data center to the US to another</a></li>
<li><a href="../347584/index.html">Disable triggers in ZABBIX on schedule</a></li>
<li><a href="../347586/index.html">How I made AI to identify fake news with an accuracy of 95% and almost went crazy</a></li>
<li><a href="../347588/index.html">Tough and flexible IT skills: everything is more and less serious than I would like to think</a></li>
<li><a href="../347590/index.html">Open science school hackathon DeepHack.Babel</a></li>
<li><a href="../347594/index.html">Beautiful Chromium and gnarled memset</a></li>
<li><a href="../347596/index.html">The evolution of x86 architecture system calls</a></li>
<li><a href="../347598/index.html">Legal aspects of domain space</a></li>
<li><a href="../347600/index.html">Friday format: ‚Äúlanguage development‚Äù - research that combines IT and linguistics</a></li>
<li><a href="../347604/index.html">File system steganography</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>