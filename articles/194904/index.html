<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Realization of the ability to download directories by site users</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="There is a small closed site on which music is laid out with albums and users of the site have the opportunity to listen to these albums straight from...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Realization of the ability to download directories by site users</h1><div class="post__text post__text-html js-mediator-article">  There is a small closed site on which music is laid out with albums and users of the site have the opportunity to listen to these albums straight from the browser.  On the server, the albums are stored in the form of directories, inside which the musical compositions themselves are stored, which at the request of the player are given to nginx. <br>  Everything was fine until the users wanted to download their favorite albums entirely to their computers. <br><br>  Under a cat I will tell as we implemented it. <br><a name="habracut"></a><br>  The first decision that comes to mind is to create an archive of each album and give it to the user. <br>  The main reason for which we abandoned this option: we have a lot of music and the creation of an archive for each album means that the amount of disk space needs to be multiplied by two - as long as we cannot afford it. <br><br>  It seemed to us that it would be ideal to form an archive of the album on request and on the fly.  If during the creation of the archive to disable compression, then the overhead should be small, well, and the costs themselves are not particularly critical for us - at the moment we have a large supply of processor time and RAM, as opposed to permanent storage. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      The search for a module for <i>nginx</i> , or any other ready-made solutions, did not give any result - we will implement it ourselves - the task is not difficult. <br><br>  For archiving, we will use the standard <i>zip</i> program, without compression, and we will not write data to the file, but send it directly to <i>stdout</i> .  For such a goal it would be more logical to use <i>tar</i> , but we have ordinary users and for many it will be a mystery what to do with the tar or tar.gz archive. <br><br>  Now we need to somehow transmit the compressed data to nginx, which will give it to the user. <br>  For these purposes, a simple cgi script was written on the shell: <br><pre><code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#!/bin/bash #  ,              homeDir="/storage/media/audio" #       ,     downloadDir=$(echo $QUERY_STRING | sed -f urldecode.sed) #     pushd "$homeDir" &gt; /dev/null #   ,     -      zip       if [ -d $downloadDir ] &amp;&amp; [ ! -z $downloadDir ] &amp;&amp; [[ "$downloadDir" != *\/* ]] &amp;&amp; [[ "$downloadDir" != *\\* ]] then echo "Content-Type: application/octet-stream" echo "Content-Disposition: attachment; filename=$downloadDir.zip" echo "" /usr/bin/zip -r -0 - "$downloadDir" else echo "Status: 404 Not Found" echo "Content-Type: text/html" echo "" echo "&lt;h1&gt;404 File not found!&lt;/h1&gt;" fi #     popd &gt; /dev/null</span></span></code> </pre> <br><br>  The script is simple, I think it would be unnecessary to comment further on it. <br><br>  Since the directory name comes url-encoded, we decode it, for this we use <i>sed</i> and a small script for it, we take the script <a href="">here</a> and put it next to our cgi-script. <br><br>  Everyone knows that nginx supports <i>FastCGI</i> and does not support <i>CGI</i> , so that our script still works, we will use <a href="http://wiki.nginx.org/Fcgiwrap">Fcgiwrap</a> . <br><br>  We put: <br><pre> <code class="bash hljs">apt-get install fcgiwrap</code> </pre> <br><br>  And configure: <br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># support for cgi scripts (require fcgiwrap) location ~ \.cgi$ { gzip off; try_files $uri =404; # pass scripts to fcgiwrap fastcgi_pass unix:/var/run/fcgiwrap.socket; #    include /etc/nginx/fastcgi_params; fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name; fastcgi_ignore_client_abort off; }</span></span></code> </pre><br><br>  Restart nginx and you can use: <i>/download.cgi?</i>  <i>download_name</i> </div><p>Source: <a href="https://habr.com/ru/post/194904/">https://habr.com/ru/post/194904/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../194886/index.html">Eaglecam: video of the flight of the eagle "first hand"</a></li>
<li><a href="../194890/index.html">RepRap: 3D printers that print 3D printers. Another successful project</a></li>
<li><a href="../194894/index.html">The company BlackBerry received a buyout offer for 4.7 billion dollars</a></li>
<li><a href="../194896/index.html">Google Constitute - Comparison of 160 World Constitutions</a></li>
<li><a href="../194898/index.html">Brute force Facebook username</a></li>
<li><a href="../194906/index.html">Migrating a running Ubuntu system to encrypted drives</a></li>
<li><a href="../194908/index.html">EPC Gen2 RFID Systems</a></li>
<li><a href="../194912/index.html">Intel¬Æ Parallel Studio XE 2013 Service Pack 1 - what's new?</a></li>
<li><a href="../194914/index.html">Intellectual Internet Spider Architecture</a></li>
<li><a href="../194916/index.html">Information security in Australia, and why pentest there is no longer a cake</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>