<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>We authorize resources in the REST service</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="In the ASP.NET world, there are powerful and flexible authorization mechanisms. For example, ASP.NET Core 2.0 provides the developer with the ability ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>We authorize resources in the REST service</h1><div class="post__text post__text-html js-mediator-article">  In the ASP.NET world, there are powerful and flexible authorization mechanisms.  For example, ASP.NET Core 2.0 provides the developer with the ability to use <a href="https://docs.microsoft.com/en-us/dotnet/api/microsoft.aspnetcore.authorization.authorizationpolicy%3Fview%3Daspnetcore-2.0">authorization policies</a> , <a href="https://docs.microsoft.com/en-us/dotnet/api/microsoft.aspnetcore.authorization.authorizationhandler-2%3Fview%3Daspnetcore-2.0">handlers</a> , etc. <br><br>  But how to implement the GET method, which returns a list of resources?  And if this method also has to return not all the resources, but only the specified page?  Each user should see only those resources to which he has access.  You can get a full list from the database each time and then filter it based on the rights of the current user, but this will be too inefficient - the amount of resources can be very large.  It is preferable to resolve issues of authorization and pagination at the database query level. <br><br>  This article describes an approach to solving authorization problems in a REST service based on ASP.NET Web API 2 using the Entity Framework. <br><a name="habracut"></a><br><h4>  Task </h4><br>  Suppose we are developing a website that allows you to host various resources, such as text documents.  We have a REST service that performs CRUD operations on these documents.  The task of authentication, that is, determining the authenticity of the user, has already been solved.  Users in our system may have different roles.  We assume that we have two types of users: administrators and ordinary users. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Now we are faced with the task of authorization - giving the user rights to perform certain actions on documents.  We want each user who posted a document to then dynamically control the access of other users to this document. <br><br><h4>  Getting started </h4><br>  So, users are divided into two types: administrators and regular users.  Administrators have maximum rights to access to any document, ordinary users have maximum rights to their documents and the rights granted to others.  We assume that there are three powers: read, write (change) and delete a document: <b>Read</b> , <b>Write</b> and <b>Delete</b> .  Each subsequent authority includes the previous one, i.e.  <b>Write</b> includes <b>Read</b> , and <b>Delete</b> includes <b>Write</b> and <b>Read</b> . <br><br>  First of all, we need to add a new table to the database for storing permissions. <br><br><img src="https://habrastorage.org/webt/op/vf/hq/opvfhq9plq_ylwspd_ls6w4fgtw.png"><br><br>  Here, the <b>ObjectId</b> is the resource identifier, <b>ObjectType</b> is the type of the resource, <b>UserId</b> is the Id of the user, and finally <b>Permission</b> is the credentials. <br><br>  Add the necessary definitions: <br><br><pre><code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">enum</span></span> ObjectType { <span class="hljs-comment"><span class="hljs-comment">// May grow in the future Document } public enum Permission { None = 0, Read = 1, Write = 2, Delete = 3 } public enum Role { Administrator, User }</span></span></code> </pre> <br>  When adding a new resource, an entry with maximum permissions for the user who created the resource should appear in the <b>Permissions</b> table.  The easiest way to do this is with a DB trigger.  We assume that we have the columns <b>Id</b> (document ID) and <b>CreatedBy</b> (ID of the user who created the document) in the <b>Documents</b> table.  Add a new trigger to the <b>Documents</b> table: <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TRIGGER</span></span> [dbo].[TR_Documents_Insert] <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> [dbo].[Documents] <span class="hljs-keyword"><span class="hljs-keyword">FOR</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INSERT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BEGIN</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INSERT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INTO</span></span> Permissions(ObjectId, ObjectType, UserId, Permission) <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> inserted.Id, <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-comment"><span class="hljs-comment">-- ObjectType.Document inserted.CreatedBy, 3 -- Permission.Delete FROM inserted END</span></span></code> </pre><br>  Thus, we will automatically have the <b>Delete</b> authority for the creator of the document. <br><br>  You can also add a trigger to delete: <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TRIGGER</span></span> [dbo].[TR_Documents_Delete] <span class="hljs-keyword"><span class="hljs-keyword">on</span></span> [dbo].[Documents] <span class="hljs-keyword"><span class="hljs-keyword">FOR</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DELETE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BEGIN</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DELETE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> Permissions <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> ObjectId <span class="hljs-keyword"><span class="hljs-keyword">IN</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ID</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> deleted) <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> ObjectType = <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">END</span></span></code> </pre><br>  At first glance, it seems that it is redundant to store administrator rights in the database, since the administrator already has full rights to any document.  What happens if you remove admin privileges in the client-side rights editor?  - for the administrator, nothing will change.  There is a temptation to process administrator rights in a special way, say, not to add an entry to the database or not to show its rights in the editor. <br><br>  Nevertheless, it is better to use the general approach.  What happens if the administrator suddenly ceases to be an administrator and goes into the category of regular users? <br><br><h4>  Model </h4><br>  We use the Entity Framework.  Classes and data model interfaces look like this: <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">Document</span></span> { [DatabaseGenerated(DatabaseGeneratedOption.Identity)] <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">long</span></span> Id { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> CreatedBy { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> Source { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">UserPermission</span></span> { [Key] [Column(Order = <span class="hljs-number"><span class="hljs-number">1</span></span>)] <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">long</span></span> ObjectId { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } [Key] [Column(Order = <span class="hljs-number"><span class="hljs-number">2</span></span>)] <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">byte</span></span> ObjectType { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } [Key] [Column(Order = <span class="hljs-number"><span class="hljs-number">3</span></span>)] <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> UserId { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">byte</span></span> Permission { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">interface</span></span> <span class="hljs-title"><span class="hljs-title">IModel</span></span> { IQueryable&lt;Document&gt; Documents { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; } IQueryable&lt;UserPermission&gt; Permissions { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; } } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">MyDbContext</span></span> : <span class="hljs-title"><span class="hljs-title">DbContext</span></span>, <span class="hljs-title"><span class="hljs-title">IModel</span></span> { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">MyDbContext</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">MyDbContext</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> connectString</span></span></span><span class="hljs-function">) : </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">base</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">connectString</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">if</span></span></span><span class="hljs-meta"> DEBUG Database.Log = x =&gt; Trace.WriteLine(x); #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">endif</span></span></span><span class="hljs-meta"> } public DbSet&lt;Document&gt; Documents { get; set; } public DbSet&lt;UserPermission&gt; Permissions { get; set; } #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">region</span></span></span><span class="hljs-meta"> Explicit IModel interface implementations IQueryable&lt;Document&gt; IModel.Documents =&gt; Documents; IQueryable&lt;UserPermission&gt; IModel.Permissions =&gt; Permissions; #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">endregion</span></span></span><span class="hljs-meta"> }</span></span></code> </pre><br>  Introducing the <b>IModel</b> interface can be useful for unit testing if we need test data: <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">internal</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">DbContextStub</span></span> : <span class="hljs-title"><span class="hljs-title">IModel</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> List&lt;Document&gt; Documents { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; } = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> List&lt;Document&gt;(); <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> List&lt;UserPermission&gt; Permissions { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; } = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> List&lt;UserPermission&gt;(); <span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">region</span></span></span><span class="hljs-meta"> Explicit Interface Implementations IQueryable&lt;Document&gt; IModel.Documents =&gt; Documents.AsQueryable(); IQueryable&lt;UserPermission&gt; IModel.Permissions =&gt; Permissions.AsQueryable(); #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">endregion</span></span></span><span class="hljs-meta"> }</span></span></code> </pre><br>  Notice also the body of the <b>MyDbContext</b> constructor.  The <i>Database.Log = x =&gt; Trace.WriteLine (x) line</i> allows you to see real SQL queries in the Visual Studio Output window when debugging. <br><br><h4>  Authorization Classes </h4><br>  Create the IAccessor interface: <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">interface</span></span> <span class="hljs-title"><span class="hljs-title">IAccessor</span></span> { IQueryable&lt;T&gt; GetQuery&lt;T&gt;() <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> T : <span class="hljs-keyword"><span class="hljs-keyword">class</span></span>, <span class="hljs-title"><span class="hljs-title">IAuthorizedObject</span></span>; Permission GetPermission&lt;T&gt;(<span class="hljs-keyword"><span class="hljs-keyword">long</span></span> objectId) <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> T : <span class="hljs-keyword"><span class="hljs-keyword">class</span></span>, <span class="hljs-title"><span class="hljs-title">IAuthorizedObject</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">bool</span></span> HasPermission&lt;T&gt;(<span class="hljs-keyword"><span class="hljs-keyword">long</span></span> objectId, Permission permission) <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> T : <span class="hljs-keyword"><span class="hljs-keyword">class</span></span>, <span class="hljs-title"><span class="hljs-title">IAuthorizedObject</span></span>; }</code> </pre><br>  The <b>GetQuery</b> method will return the <b>IQueriable</b> interface for selecting resources, in our case, documents available for reading to the current user.  The <b>GetPermission</b> method will return the current user's authority to the specified resource.  The <b>HasPermission</b> method has <b>been</b> added for convenience.  It answers the question whether the current user has the specified right to the specified resource. <br><br>  The <b>IAuthorizedObject</b> interface defines the resource that we are going to authorize.  This interface is very simple and contains only a resource Id: <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">interface</span></span> <span class="hljs-title"><span class="hljs-title">IAuthorizedObject</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">long</span></span> Id { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; } }</code> </pre><br>  The <b>Document</b> class will need to inherit from the <b>IAuthorizedObject</b> interface: <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">Document</span></span> : <span class="hljs-title"><span class="hljs-title">IAuthorizedObject</span></span></code> </pre><br>  It's time to implement specific implementations of the <b>IAccessor</b> interface.  We will have two implementations: <b>Administrator</b> and <b>User</b> .  First, add the base class <b>UserBase</b> : <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">abstract</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">UserBase</span></span> : <span class="hljs-title"><span class="hljs-title">IAccessor</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> <span class="hljs-keyword"><span class="hljs-keyword">readonly</span></span> IModel Model; <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> <span class="hljs-keyword"><span class="hljs-keyword">readonly</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> Id; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">readonly</span></span> Dictionary&lt;Type, IQueryable&gt; _typeToQuery = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Dictionary&lt;Type, IQueryable&gt;(); <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">readonly</span></span> Dictionary&lt;Type, ObjectType&gt; _typeToEnum = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Dictionary&lt;Type, ObjectType&gt;(); <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">protected</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">UserBase</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">IModel model, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> userId</span></span></span><span class="hljs-function">)</span></span> { Model = model; Id = userId; AppendAuthorizedObject(Auth.ObjectType.Document, Model.Documents); <span class="hljs-comment"><span class="hljs-comment">// Append new authorized objects here... } private void AppendAuthorizedObject&lt;T&gt;(ObjectType type, IQueryable&lt;T&gt; source) where T : class, IAuthorizedObject { _typeToQuery.Add(typeof(T), source); _typeToEnum.Add(typeof(T), type); } protected IQueryable&lt;T&gt; Query&lt;T&gt;() where T : class, IAuthorizedObject { IQueryable query; if (!_typeToQuery.TryGetValue(typeof(T), out query)) throw new InvalidOperationException( $"Unsupported object type {typeof(T)}"); return query as IQueryable&lt;T&gt;; } protected byte ObjectType&lt;T&gt;() where T : class, IAuthorizedObject { ObjectType type; if (!_typeToEnum.TryGetValue(typeof(T), out type)) throw new InvalidOperationException( $"Unsupported object type {typeof(T)}"); return (byte)type; } protected Permission GetPermission&lt;T&gt;(int userId, long objectId) where T : class, IAuthorizedObject { var entities = Query&lt;T&gt;(); var objectType = ObjectType&lt;T&gt;(); var query = from obj in entities from p in Model.Permissions where p.ObjectType == objectType &amp;&amp; p.ObjectId == objectId &amp;&amp; obj.Id == p.ObjectId &amp;&amp; p.UserId == userId select p.Permission; return (Permission) query.FirstOrDefault(); } public abstract IQueryable&lt;T&gt; GetQuery&lt;T&gt;() where T : class, IAuthorizedObject; public abstract Permission GetPermission&lt;T&gt;(long objectId) where T : class, IAuthorizedObject; public abstract bool HasPermission&lt;T&gt;(long objectId, Permission permission) where T : class, IAuthorizedObject; }</span></span></code> </pre><br>  <b>UserBase</b> will be useful to us when implementing the classes <b>Administrator</b> and <b>User</b> .  In the constructor, he initializes his members in order to be able to implement generic methods.  The <b>Query</b> method returns a dataset from a context DB for a given type, <b>ObjectType</b> returns a native enumeration value by type, and <b>GetPermission</b> returns an authority for a given user ID and an object for a generic type. <br><br>  Now we can start creating the <b>Administrator</b> and <b>User</b> classes.  As for the administrator, everything is simple, because the administrator has full rights to all documents: <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">Administrator</span></span> : <span class="hljs-title"><span class="hljs-title">UserBase</span></span> { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Administrator</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">IModel model, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> userId</span></span></span><span class="hljs-function">) : </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">base</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">model, userId</span></span></span><span class="hljs-function">)</span></span> { } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">override</span></span> IQueryable&lt;T&gt; GetQuery&lt;T&gt;() { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> Query&lt;T&gt;(); } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">override</span></span> <span class="hljs-keyword"><span class="hljs-keyword">bool</span></span> HasPermission&lt;T&gt;(<span class="hljs-keyword"><span class="hljs-keyword">long</span></span> objectId, Permission permission) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> permission != Permission.None; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">override</span></span> Permission GetPermission&lt;T&gt;(<span class="hljs-keyword"><span class="hljs-keyword">long</span></span> objectId) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> Permission.Delete; } }</code> </pre><br>  With the <b>User</b> class, everything is much more interesting: the <b>GetQuery</b> method should return only those documents to which the user has access.  Therefore, we must take into account the authority of this user.  We implement this in a single query to the database, i.e.  let's do something, because of what, in fact, everything was started. <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">User</span></span> : <span class="hljs-title"><span class="hljs-title">UserBase</span></span> { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">User</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">IModel model, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> userId</span></span></span><span class="hljs-function">) : </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">base</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">model, userId</span></span></span><span class="hljs-function">)</span></span> { } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">override</span></span> IQueryable&lt;T&gt; GetQuery&lt;T&gt;() { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> entities = Query&lt;T&gt;(); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> objectType = ObjectType&lt;T&gt;(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> obj <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> entities <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> p <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> Model.Permissions <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> p.ObjectType == objectType &amp;&amp; p.UserId == Id &amp;&amp; obj.Id == p.ObjectId <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> obj; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">override</span></span> <span class="hljs-keyword"><span class="hljs-keyword">bool</span></span> HasPermission&lt;T&gt;(<span class="hljs-keyword"><span class="hljs-keyword">long</span></span> objectId, Permission permission) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> permission == Permission.None ? GetPermission&lt;T&gt;(objectId) == Permission.None : GetPermission&lt;T&gt;(objectId) &gt;= permission; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">override</span></span> Permission GetPermission&lt;T&gt;(<span class="hljs-keyword"><span class="hljs-keyword">long</span></span> objectId) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> GetPermission&lt;T&gt;(Id, objectId); } }</code> </pre><br>  It is clear that in this way you can easily introduce new user roles.  Suppose we need to add an ‚Äúadvanced user‚Äú that has the right to read all documents created by other users.  It is clear that to implement the corresponding class is a simple task. <br><br>  I will give an example of this class: <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">AdvancedUser</span></span> : <span class="hljs-title"><span class="hljs-title">UserBase</span></span> { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">AdvancedUser</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">IModel model, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> userId</span></span></span><span class="hljs-function">) : </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">base</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">model, userId</span></span></span><span class="hljs-function">)</span></span> { } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">override</span></span> IQueryable&lt;T&gt; GetQuery&lt;T&gt;() { <span class="hljs-comment"><span class="hljs-comment">// Advanced user can see all resources return Query&lt;T&gt;(); } public override bool HasPermission&lt;T&gt;(long objectId, Permission permission) { if (permission == Permission.None) return false; return GetPermission&lt;T&gt;(objectId) &gt;= permission; } public override Permission GetPermission&lt;T&gt;(long objectId) { // Return own permission if exists or Permission.Read return Max(GetPermission&lt;T&gt;(Id, objectId), Permission.Read); } private static Permission Max(Permission perm1, Permission perm2) { return (Permission) Math.Max((int) perm1, (int) perm2); } }</span></span></code> </pre><br>  Finally, you need a class to create specific implementations of the <b>IAccessor</b> interface.  It will look like this: <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">Factory</span></span> { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> IAccessor </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">CreateAccessor</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">IPrincipal principal, IModel model</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>( IsAdministrator(principal)) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Administrator(model, GetUserId(principal)); <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> User(model, GetUserId(principal)); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">bool</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">IsAdministrator</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">IPrincipal principal</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> principal.IsInRole(<span class="hljs-string"><span class="hljs-string">"SYSTEM_ADMINISTRATE"</span></span>); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GetUserId</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">IPrincipal principal</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> id = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-comment"><span class="hljs-comment">// </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">TODO:</span></span></span><span class="hljs-comment"> Obtain user id from Thread.CurrentPrincipal here... return id; } }</span></span></code> </pre><br><h4>  DocumentController </h4><br>  Now that we have all the necessary infrastructure, we can easily implement a document controller: <br><br><pre> <code class="cs hljs">[<span class="hljs-meta"><span class="hljs-meta">RoutePrefix(</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"documents"</span></span></span><span class="hljs-meta">)</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">DocumentsController</span></span> : <span class="hljs-title"><span class="hljs-title">ApiController</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">readonly</span></span> MyDbContext _db = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> MyDbContext(); <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> IAccessor Accessor =&gt; Factory.CreateAccessor(Thread.CurrentPrincipal, _db); [HttpGet] [Route(<span class="hljs-string"><span class="hljs-string">""</span></span>, Name = <span class="hljs-string"><span class="hljs-string">"GetDocuments"</span></span>)] [ResponseType(<span class="hljs-keyword"><span class="hljs-keyword">typeof</span></span>(IQueryable&lt;Document&gt;))] <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> IHttpActionResult </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GetDocuments</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> query = Accessor.GetQuery&lt;Document&gt;(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> Ok(query); } [HttpGet] [Route(<span class="hljs-string"><span class="hljs-string">"{id:long}"</span></span>, Name = <span class="hljs-string"><span class="hljs-string">"GetDocumentById"</span></span>)] [ResponseType(<span class="hljs-keyword"><span class="hljs-keyword">typeof</span></span>(Document))] <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> IHttpActionResult </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GetDocumentById</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">long</span></span></span></span><span class="hljs-function"><span class="hljs-params"> id</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!Accessor.HasPermission&lt;Document&gt;(id, Permission.Read)) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> NotFound(); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> document = _db.Documents.FirstOrDefault(e =&gt; e.Id == id); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (document == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> NotFound(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> Ok(document); } [HttpPost] [Route(<span class="hljs-string"><span class="hljs-string">""</span></span>, Name = <span class="hljs-string"><span class="hljs-string">"CreateDocument"</span></span>)] [ResponseType(<span class="hljs-keyword"><span class="hljs-keyword">typeof</span></span>(Document))] <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> IHttpActionResult </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">CreateDocument</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">Document document</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!ModelState.IsValid) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> BadRequest(ModelState); _db.Documents.Add(document); _db.SaveChanges(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> CreatedAtRoute(<span class="hljs-string"><span class="hljs-string">"CreateDocument"</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> { id = document.Id }, document); } [HttpDelete] [Route(<span class="hljs-string"><span class="hljs-string">"{id:long}"</span></span>, Name = <span class="hljs-string"><span class="hljs-string">"DeleteDocument"</span></span>)] [ResponseType(<span class="hljs-keyword"><span class="hljs-keyword">typeof</span></span>(Document))] <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> IHttpActionResult </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">DeleteDocument</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">long</span></span></span></span><span class="hljs-function"><span class="hljs-params"> id</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (Accessor.HasPermission&lt;Document&gt;(id, Permission.Delete)) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> NotFound(); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> document = _db.Documents.FirstOrDefault(e =&gt; e.Id == id); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (document == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> NotFound(); _db.Documents.Remove(document); _db.SaveChanges(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> Ok(document); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">protected</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">override</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Dispose</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">bool</span></span></span></span><span class="hljs-function"><span class="hljs-params"> disposing</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (disposing) _db.Dispose(); <span class="hljs-keyword"><span class="hljs-keyword">base</span></span>.Dispose(disposing); } }</code> </pre><br><h4>  DocumentPermissionController </h4><br>  Next, we need to add a controller for CRUD rights operations for a specific document.  There is nothing special about it, except that each method will have to take into account the current user's rights on this document. <br><br>  If we assume that we have a <b>DocumentPermissionService</b> class that takes over operations on permissions and unloads the controller, then the code will look like this: <br><br><pre> <code class="cs hljs">[<span class="hljs-meta"><span class="hljs-meta">RoutePrefix(</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"documents"</span></span></span><span class="hljs-meta">)</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">DocumentPermissionsController</span></span> : <span class="hljs-title"><span class="hljs-title">ApiController</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">readonly</span></span> MyDbContext _db = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> MyDbContext(); <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">readonly</span></span> DocumentPermissionService _service = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> DocumentPermissionService(); <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> IAccessor Accessor =&gt; Factory.CreateAccessor(Thread.CurrentPrincipal, _db); [HttpGet] [Route(<span class="hljs-string"><span class="hljs-string">"{id:long}/permissions"</span></span>, Name = <span class="hljs-string"><span class="hljs-string">"GetPermissions"</span></span>)] [ResponseType(<span class="hljs-keyword"><span class="hljs-keyword">typeof</span></span>(IQueryable&lt;UserPermission&gt;))] <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> IHttpActionResult </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GetPermissions</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">long</span></span></span></span><span class="hljs-function"><span class="hljs-params"> id</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!Accessor.HasPermission&lt;Document&gt;(id, Permission.Write)) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> NotFound(); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> permissions = _service.GetPermissions(id); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> Ok(permissions); } [HttpPatch] [Route(<span class="hljs-string"><span class="hljs-string">"{id:long}/permissions"</span></span>, Name = <span class="hljs-string"><span class="hljs-string">"SetPermissions"</span></span>)] <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> HttpResponseMessage </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">SetPermissions</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">long</span></span></span></span><span class="hljs-function"><span class="hljs-params"> id, IList&lt;PermissionDto&gt; permissions</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!Accessor.HasPermission&lt;Document&gt;(id, Permission.Write)) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> Request.CreateResponse(HttpStatusCode.NotFound); <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> err; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> validationCode = _service.ValidatePermissions(permissions, <span class="hljs-keyword"><span class="hljs-keyword">out</span></span> err); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (validationCode != HttpStatusCode.OK) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> Request.CreateResponse(validationCode, err); _service.SetPermissions(id, permissions); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> Request.CreateResponse(HttpStatusCode.OK); } [Route(<span class="hljs-string"><span class="hljs-string">"{id:long}/permissions/{userId:int}"</span></span>, Name = <span class="hljs-string"><span class="hljs-string">"DeletePermission"</span></span>)] [HttpDelete] <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> IHttpActionResult </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">DeletePermission</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">long</span></span></span></span><span class="hljs-function"><span class="hljs-params"> id, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> userId</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!Accessor.HasPermission&lt;Document&gt;(id, Permission.Write)) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> NotFound(); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> isDeleted = _service.DeletePermission(id, userId); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> isDeleted ? (IHttpActionResult) Ok() : NotFound(); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">protected</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">override</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Dispose</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">bool</span></span></span></span><span class="hljs-function"><span class="hljs-params"> disposing</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (disposing) _db.Dispose(); <span class="hljs-keyword"><span class="hljs-keyword">base</span></span>.Dispose(disposing); } }</code> </pre><br>  Note that the <b>GetPermissions</b> method requires the <b>Write</b> permission.  At first glance it seems that a user who has the right to read a document should be able to obtain all the permissions for this document.  However, it is not.  In accordance with the <a href="https://ru.wikipedia.org/wiki/%25D0%259F%25D1%2580%25D0%25B8%25D0%25BD%25D1%2586%25D0%25B8%25D0%25BF_%25D0%25BC%25D0%25B8%25D0%25BD%25D0%25B8%25D0%25BC%25D0%25B0%25D0%25BB%25D1%258C%25D0%25BD%25D1%258B%25D1%2585_%25D0%25BF%25D1%2580%25D0%25B8%25D0%25B2%25D0%25B8%25D0%25BB%25D0%25B5%25D0%25B3%25D0%25B8%25D0%25B9">principle of minimum privileges,</a> we should not give the user privileges that are not necessary for him.  The user with the <b>Read</b> authority does not have the ability to change the user rights to the document, respectively, he does not need data on the existing rights. <br><br><h4>  Extensibility </h4><br>  Everything is changing.  We may have new requirements and business rules.  How adaptive is our approach to changing requirements?  Let's try to imagine what might change in the future. <br><br>  The first thing that comes to mind is the addition of new types of resources.  Everything looks good here: if we add a new entity to the DB model, say, <b>Image</b> , we just need to add the new value of the <b>ObjectType enum</b> and one line of code to the constructor of the <b>UserBase</b> class: <br><br><pre> <code class="cs hljs"> AppendAuthorizedObject(ObjectType.Image, Model.Image);</code> </pre><br>  Slightly more complicated with users.  Suppose we need to add the ability to group users and assign permissions to groups.  Will we be able to make changes to the project relatively painlessly? <br><br>  The first thing to do is add a new column, <b>AccountType,</b> to the <b>Permissions</b> table.  It would be nice to also rename <b>UserId</b> to <b>AccountId</b> , since now this column will store either the user Id or group Id depending on the <b>AccountType</b> value. <br><br>  We'll have to change the <b>GetQuery</b> methods in the <b>IAccessor</b> interface <b>implementations</b> .  Now it will be necessary to take into account the belonging of the user to the group and check the authority of the group in addition to the authority of the user himself. <br><br>  But in general, such a change in functionality does not look critical. </div><p>Source: <a href="https://habr.com/ru/post/342000/">https://habr.com/ru/post/342000/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../341988/index.html">Model-Update-View pattern and dependent types</a></li>
<li><a href="../341990/index.html">How Badoo is gaining developers</a></li>
<li><a href="../341992/index.html">Optimization of securities portfolio using Python</a></li>
<li><a href="../341996/index.html">Installing SSL certificate on Zimbra</a></li>
<li><a href="../341998/index.html">Board game design</a></li>
<li><a href="../342002/index.html">A little story about the `yes` command in Unix</a></li>
<li><a href="../342004/index.html">Tatiana Puchkova, AlfaStrakhovanie: ‚ÄúI personally promise to pay attention to every startup‚Äù</a></li>
<li><a href="../342006/index.html">‚ÄúI myself do not believe in advertising and use AdBlock‚Äù: an interview with the founder of Smashing Magazine</a></li>
<li><a href="../342008/index.html">Mars IS expands the functionality of the operational analysis platform SPLUNK</a></li>
<li><a href="../342010/index.html">Russian-speaking crowdfunding got a new service similar to the American Patreon.com</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>