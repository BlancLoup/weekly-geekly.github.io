<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Learning correctly benchmark 2: how the compiler hits the back</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="To get suitable benchmark figures is half the battle, but the second half is to interpret them correctly, learn something new, and be able to apply. T...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Learning correctly benchmark 2: how the compiler hits the back</h1><div class="post__text post__text-html js-mediator-article"> To get suitable benchmark figures is half the battle, but the second half is to interpret them correctly, learn something new, and be able to apply.  The 100x differences between the default and normal build surprised, decided to dig deeper.  According to the results I got to know what is going on in the debug;  looked for differences between 2005 and 2008 studio (did not find);  figured out how to speed up the debug build 3 times in a couple of minutes (set the block against a backstab);  the ‚Äútake and run‚Äù method got results that differ from the author's by 3.5 times (hellish x64 power in action!);  and, for laughter, he measured the bad, unsuitable disbelief against the good (the bad turned out to be up to 100 times faster).  Details under the cut. <br><a name="habracut"></a><br>  I will start with references to sorsy, otherwise it‚Äôs hard to search.  <a href="http://habrahabr.ru/blogs/cpp/113661/">The initial post</a> , <a href="">their test code</a> , <a href="http://pastie.org/1569130">my test code</a> . <br><br>  Having eliminated the jitter, I returned to the original question: the brakes, more than 100 times, very slowly, from where they come from.  Someone else's test is good, but his familiar, wrote, launched.  It was lazy to create a project, to compile from a comstroke much faster. <br><br> <code>cl2005 /O2 /EHsc 1.cpp <br> std it++ res=49995000, 28.5 msec <br> std ++it res=49995000, 28.6 msec <br> my res=49995000, 19.0 msec <br> <br> cl2005 /EHsc 1.cpp <br> std it++ res=49995000, 534.2 msec <br> std ++it res=49995000, 437.6 msec <br> my res=49995000, 69.9 msec <br></code> 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Oops.  The results, however, differ: those guys are 30 times slower, I have only 10. For those guys, the post-increment slows down 3 times, I have about 20%.  What am I doing wrong?  Is it really so fierce difference between the compiler and the banned library?  Well, we put in 2008, check it out. <br><br> <code>cl2008 /O2 /EHsc 1.cpp <br> std it++ res=49995000, 64.3 msec <br> std ++it res=49995000, 63.4 msec <br> my res=49995000, 19.0 msec <br> <br> cl2008 /EHsc 1.cpp <br> std it++ res=49995000, 732.1 msec <br> std ++it res=49995000, 678.8 msec <br> my res=49995000, 70.0 msec <br></code> <br><br>  Md  There really are differences, only in the opposite direction: the release build of VS 2005 however was three times faster.  The improvements are obvious;  Apparently, SCL in studio number 2008 has become three times more secure, tk.  with _SECURE_SCL 0, the speed is the same.  (Looking ahead, most other tests are also almost the same.) What else am I doing wrong?  The compiler is now the same, std :: vector seems to be the same, the output is unequivocal: I compile incorrectly.  In sense, keys of the compiler disperse.  We look into the solution, there is quite a spreading comstar. <br><br> <code>/Od /D "WIN32" /D "_DEBUG" /D "_CONSOLE" /D "_UNICODE" /D "UNICODE" /Gm /EHsc /RTC1 /MDd /Fo"Debug\\" /Fd"Debug\vc90.pdb" /W3 /nologo /c /ZI /TP /errorReport:prompt <br></code> <br><br>  Revolutionary instinct and brute force fails to unload unimportant keys, and leave important ones.  There are three important keys: a) / MDd, b) / RTC1, c) / ZI.  The results look like this. <br><br> <code>cl2008 /Od /EHsc /MDd 1.cpp <br> std it++ res=49995000, 6026.1 msec <br> std ++it res=49995000, 1953.9 msec <br> my res=49995000, 66.5 msec <br> <br> cl2008 /Od /EHsc /MDd /RTC1 1.cpp <br> std it++ res=49995000, 7572.0 msec <br> std ++it res=49995000, 2385.3 msec <br> my res=49995000, 101.8 msec <br> <br> cl2008 /Od /EHsc /MDd /RTC1 /ZI 1.cpp <br> std it++ res=49995000, 18722.0 msec <br> std ++it res=49995000, 7131.8 msec <br> my res=49995000, 511.9 msec <br></code> <br><br>  Here, now everything is just like that of people: and the crawling of the vector slows down like a padla, and the post-increment began to slow down.  Nishtyak!  You can figure out what's wrong.  For a couple of minutes reading cl /?  It turns out three simple understandable things (one per key), which are still new (see well forgotten old ones) and therefore are amazing. <br><br>  / MDd authenticated the debug library (which does not matter) and automatically included / D _DEBUG (which is important).  From this, SCL included an additional package of checks inside itself, in addition to those included in _SECURE_SCL, which successfully slowed down the postincrement 8 times, and the increment 3 times. <br><br>  / RTC1 includes stack collapse checks and uninitialized variables.  If you step into the dizasm debugger, you can see that there are five calls of different functions in the internal loop (++,! =, * And two destructors).  Every challenge needs to be checked: what if he takes and how he breaks the stack!  To do this, a little less than 256 bytes of marker good are thrown onto the stack for each (each) call of one or another STL overloaded operator.  Bye-bye, another 20% is no longer the top performance itself. <br><br>  / ZI, however, beats everyone and takes the bank home.  This is Edit and Continue.  It is probably convenient to fix and restart the program on the fly (I myself don‚Äôt know, I don‚Äôt use it).  For convenience, you have to pay and the price is 3 more brakes. <br><br>  Total in debug post-increment slows down the epic 291 times (!!!) compared with the release.  What immediately raises the question: why do I have as many as 291 times, and those guys have only 95 ?!  I collect the original test, wait for the end is not enough patience, reduce the Count 10 times, multiply the time in my head by 10. It turns out that <br><br> <code>it++, x86, release: 1.00 <br> ++it, x86, release: 1.00 <br> it++, x86, debug: 275.7 <br> ++it, x86, debug: 101.9 <br> <br> it++, x64, release: 0.87779 <br> ++it, x64, release: 0.87753 <br> it++, x64, debug: 83.2849 <br> ++it, x64, debug: 27.1557 <br></code> <br><br>  Judging by the numbers, in the release from my x86 they took income tax of 13%, and in the debug they robbed them in general, leaving only cowards, socks and slippers.  Fading insulting, but nothing.  Anyway, XP will not give up, for me the seven is difficult, too aero transparent, plus a second waiting service pack. <br><br>  According to the results, it is clear who is to blame for the hellish brakes of the debug build.  2 with a little time eats _SECURE_SCL, 5 times off optimization, from 3 times (++ it) to 8 times (it ++) guzzle checks under _DEBUG, 1.2 times sprinkles / RTC, and ends up with a final chord 3 times / ZI, total 2 * 5 * 8 * 1.2 * 3 = 288, chicken by grain, all code in ... checks, tormozischa in 300 (three hundred) times.  Chicken hands, of course, eat.  Of the eternal three, now only one question remains: what to do? <br><br>  In general, you can do a lot of things, but for a long time.  However, in 2 minutes you can do 2 useful things.  When you make a volitional decision not to use Edit and Continue (if it works on your project at all) and generate the usual Soviet PDB, it starts to work 3 times faster if not all 5 times.  Bo2x, / RTC checks disable, of course, uncool.  But!  Reading MSDN reveals an interesting runtime_checks pragma.  Those.  you can turn off these point checks for particularly frequent functions in the project, or there for the whole STL.  We arrange the external section include two lines, enjoy. <br><br> <code>#pragma runtime_checks("",off) <br> ... <br> #pragma runtime_checks("",restore) <br></code> <br><br>  We get back our honest 6 seconds instead of 18 seconds using it ++, 2 seconds instead of 7 seconds with ++ it.  The conclusion about the need to use ++ it is convincingly confirmed.  Debazh build accelerated about 3 times.  Profit!  We try to apply what we know to the original test, it turns out similarly.  At least on the good old x86. <br><br> <code>vanilla <br> it++, x86, debug: 275.7 <br> ++it, x86, debug: 101.9 <br> <br> #pragma runtime_checks, /Zi instead of /ZI <br> it++, x86, debug: 102.2 <br> ++it, x86, debug: 30.0 <br></code> <br><br>  A bad, crooked, unprofitable and primitive non-vector, who can‚Äôt do anything at all, shows his honest 0.066 sec, those in debug.  90 times faster than the it ++ option, or 30 times the ++ it option.  About 100 times at the beginning of the post, I <s>lied</s> rounded.  He has only one check: the correctness of the index upon access (which, however, covers approximately 99% of the checks needed from the vector);  focus with pre- and post-increments are absent along with iterators.  This means nothing.  The author does not hint at anything.  The benchmark is clearly synthetic.  The vector was written in just 3 minutes and the corresponding functionality, those.  compared to STL does not exist.  The speed of the debug build is not necessarily important;  an extra check may be important;  speed of development is important to all and always;  the truth will always be prompted by the profiler. <br><br>  Remember about _SECURE_SCL, about _DEBUG, about compiler keys, about #pragma runtime_checks.  The effect, mneee, is stunning.  (Personally, I was 300 times killed by the results. And the difference from 3 to 5 times because of / ZI instead of / Zi then ate the corpse. "I knew about it, but I did not guess.") <br><br>  The correct benchmarks for you.  And quick debugging. </div><p>Source: <a href="https://habr.com/ru/post/113879/">https://habr.com/ru/post/113879/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../113873/index.html">Among the mail attachments of the company HBGary was the decompiled code Stuxnet</a></li>
<li><a href="../113874/index.html">Internet + Firefox => offline dictionaries are no longer needed</a></li>
<li><a href="../113875/index.html">London Stock Exchange finally launched trading on the Linux platform</a></li>
<li><a href="../113876/index.html">China: how to order production or delivery</a></li>
<li><a href="../113877/index.html">Transparent and verifiable choices</a></li>
<li><a href="../113882/index.html">Nokia and Microsoft: Why?</a></li>
<li><a href="../113883/index.html">Google App Engine Caching</a></li>
<li><a href="../113884/index.html">What do you think will be with Yota in the near future?</a></li>
<li><a href="../113885/index.html">2 abandoned projects</a></li>
<li><a href="../113886/index.html">Arkady Moreinis, Glavstart: "I work with startups, but do not sell coffee boxes"</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>