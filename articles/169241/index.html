<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Storing sessions in Redis and sharing them in PHP and Tomcat</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Actually the task is very specific, but this work may still be useful to someone. The question of the feasibility of sharing Apache and Tomcat I propo...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Storing sessions in Redis and sharing them in PHP and Tomcat</h1><div class="post__text post__text-html js-mediator-article">  Actually the task is very specific, but this work may still be useful to someone.  The question of the feasibility of sharing Apache and Tomcat I propose to leave behind the discussion.  The task was set at work as a given.  It is required to provide storage of sessions in Redis for PHP and Tomcat and so that these sessions were common between them.  A long googling did not result.  Both for PHP and for Tomcat there are means of storing sessions in Redis, but the storage format is different.  All 3 projects found for Tomcat serialize sessions on Redis using a binary format to serialize Java objects.  Also PHP and Tomcat have different identifiers for the session cookie (PHPSESSID and JSESSID, respectively). <br><a name="habracut"></a><br>  Actually, these problems I had to solve.  If possible, I wanted to do everything in my mind: without inventing my own API for working with sessions;  not inventing the own generation function of a unique and random ID for the session (in such things it‚Äôs easy to mess up, making the whole project vulnerable);  by writing a minimum of code duplicating the functionality already invented by others. <br>  With PHP everything turned out to be extremely simple.  There is a wonderful <a href="https://github.com/TheDeveloper/redis-session-php">project</a> that, while saving a session, serializes its attributes in JSON.  In addition, PHP allows you to change the name of the cookie used on the client using the <a href="http://se.php.net/manual/en/function.session-name.php">session-name</a> function.  So it turned out that almost nothing happened with PHP. <br>  Tomcat is more complicated.  Among the found 3 projects that provide the ability to store sessions in Redis, there was not one able to save the session into anything other than the binary object serialization format in Java, which is somewhat difficult to read using PHP (and even if not, then sure is a bad practice). <br>  However, <a href="https://github.com/jcoleman/tomcat-redis-session-manager">the Tomcat Redis Session Manager project</a> allows you to use your own object serialization implementations, which allows you to solve the problem of storing a session in Redis in JSON format. <br><h5>  To code </h5><br><h6>  Php </h6><br>  So the session creation code in PHP looks like this: <br><pre><code class="php hljs"><span class="hljs-comment"><span class="hljs-comment">#  , ,        #  ,     require('redis-session-php/redis-session.php'); #  ,       # Redis.   , . .  tomcat-redis-session-manager # ,      define('REDIS_SESSION_PREFIX', ''); #  Tomcat      ,    PHP session_name('JSESSIONID'); #    RedisSession::start();</span></span></code> </pre> <br>  The script works like this: <br><img src="https://habrastorage.org/storage2/ddf/557/8d7/ddf5578d7fe68169d2e1ab0901e58d1c.png"><br>  As a result, the record with the key - the session id and the session data serialized in JSON will fall into Redis. <br><img src="https://habrastorage.org/storage2/3bc/1bb/048/3bc1bb04871912c1b16a68f112f4df8e.png"><br>  Java is a bit more complicated. <br><h6>  Java </h6><br>  First you need to install Redis Session Manager.  The installation process is described in detail on the official website of the project.  We register in context.xml: <br><pre> <code class="xml hljs"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Valve</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">className</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"com.radiadesign.catalina.session.RedisSessionHandlerValve"</span></span></span><span class="hljs-tag"> /&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Manager</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">className</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"com.radiadesign.catalina.session.RedisSessionManager"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">serializationStrategyClass</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"com.radiadesign.catalina.session.JSONSerializer"</span></span></span><span class="hljs-tag">/&gt;</span></span></code> </pre><br>  Here I do not prescribe the parameters that I have with the default parameters (for example, the server is localhost), besides, the serializationStrategyClass parameter is added, which sets the path to my own implementation of the session serialization class (the code will be lower). <br>  Download tomcat-redis-session-manager-1.2-tomcat-6.jar to your Tomcat's lib folder. <br>  The serialization class looks like this: <br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">package</span></span> com.radiadesign.catalina.session; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> javax.servlet.http.HttpSession; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> java.io.IOException; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> java.util.HashMap; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> java.util.Enumeration; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> java.util.Map; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> java.io.ByteArrayOutputStream; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> java.io.BufferedInputStream; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> java.io.ByteArrayInputStream; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> java.util.Iterator; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> com.google.gson.Gson; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> com.google.gson.reflect.TypeToken; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> java.lang.reflect.Type; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">JSONSerializer</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Serializer</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> ClassLoader loader; <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">setClassLoader</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(ClassLoader loader)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.loader = loader; } <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">byte</span></span>[] serializeFrom(HttpSession session) <span class="hljs-keyword"><span class="hljs-keyword">throws</span></span> IOException { <span class="hljs-comment"><span class="hljs-comment">// create map to put data here HashMap&lt;String,Object&gt; sessionData = new HashMap&lt;String,Object&gt;(); // put every attribute of session in newly created map for (Enumeration keys = session.getAttributeNames(); keys.hasMoreElements();){ String k = (String) keys.nextElement(); sessionData.put(k, session.getAttribute(k)); } // write it to byte array Gson gson = new Gson(); return gson.toJson(sessionData).getBytes(); } @Override public HttpSession deserializeInto(byte[] data, HttpSession session) throws IOException, ClassNotFoundException { RedisSession redisSession = (RedisSession) session; redisSession.setValid(true); // place data to map Gson gson = new Gson(); Type mapType = new TypeToken&lt;HashMap&lt;String,Object&gt;&gt;(){}.getType(); HashMap&lt;String,Object&gt; sessionData = gson.fromJson(new String(data), mapType); // place attributes to session object for (Map.Entry&lt;String, Object&gt; entry : sessionData.entrySet()) redisSession.setAttribute(entry.getKey(), entry.getValue()); // return filled session*/ return redisSession; } }</span></span></code> </pre><br>  Here, the <a href="http://code.google.com/p/google-gson/">Json</a> library is used for serialization in JSON, so if you don‚Äôt have it, install it. <br>  Compile the class in Jar and put it in the lib folder of your copy of Tomcat.  An example of my compilation team: <br><pre> <code class="bash hljs">javac -cp /usr/share/tomcat6/lib/servlet-api.jar:/usr/share/tomcat6/lib/catalina.jar:/usr/share/tomcat6/lib/tomcat-redis-session-manager-1.2-tomcat-6.jar:/usr/share/tomcat6/lib/gson-2.2.2.jar com/radiadesign/catalina/session/JSONSerializer.java jar cf jsonserializer.0.1.jar com</code> </pre><br>  Of course, the path to the libraries may differ on your machine.  If you‚Äôre too lazy to compile it yourself, get a ready-made Jar from my <a href="">Dropbox</a> . <br>  Everything.  After that, you can create sessions in the usual way, everything works completely transparent.  If you have completed these steps for Tomcat and are creating sessions in PHP using the code above, then you have common sessions between Tomcat and PHP. <br>  Just in case, I give an example of creating a session in Tomcat: <br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> java.io.*; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> javax.servlet.http.*; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> javax.servlet.*; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">HelloServlet</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">HttpServlet</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">doGet</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(HttpServletRequest req, HttpServletResponse res)</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">throws</span></span></span><span class="hljs-function"> ServletException, IOException </span></span>{ PrintWriter out = res.getWriter(); HttpSession session = req.getSession(); out.println(<span class="hljs-string"><span class="hljs-string">"ID: "</span></span> + session.getId()); session.setAttribute(<span class="hljs-string"><span class="hljs-string">"Name"</span></span>, <span class="hljs-string"><span class="hljs-string">"kapitoka"</span></span>); out.println(<span class="hljs-string"><span class="hljs-string">"Set done"</span></span>); out.println(<span class="hljs-string"><span class="hljs-string">"Get result: "</span></span> + session.getAttribute(<span class="hljs-string"><span class="hljs-string">"Name"</span></span>)); out.close(); } }</code> </pre><br>  As you can see, no specific actions are required, a completely ordinary session creation code. <br>  Result of the Java example: <br><img src="https://habrastorage.org/storage2/39f/5a3/074/39f5a3074968f13b26f55c478a4d2921.png"></div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <p>Source: <a href="https://habr.com/ru/post/169241/">https://habr.com/ru/post/169241/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../169223/index.html">Technical support for dummies: happiness in one click</a></li>
<li><a href="../169231/index.html">Access to PasswordBox in MVVM environment</a></li>
<li><a href="../169233/index.html">Bitrix + Bitcoin. Part 2. The choice of processing</a></li>
<li><a href="../169237/index.html">Threats of January 2013 and our recommendations on Conficker</a></li>
<li><a href="../169239/index.html">300 million users and transition to WebKit</a></li>
<li><a href="../169243/index.html">Moving from CMD to PowerShell: a guide to commands and cmdlets for administering AD</a></li>
<li><a href="../169245/index.html">How I decide tickets</a></li>
<li><a href="../169249/index.html">A mini-game with head position tracking or how I met headtrackr.js</a></li>
<li><a href="../169251/index.html">Diskless booting using PXE and iSCSI using Ubuntu as an example</a></li>
<li><a href="../169253/index.html">Moving from Flash to Edge - comparing the two platforms for creating animation</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>