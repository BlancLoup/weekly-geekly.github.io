<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Yandex post office: how we made a service analyzing the results of mailings in realtime</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Yandex has a service for bona fide letter mailers - the Post Office . (For unscrupulous, we have Antispam and the "Unsubscribe" button in the Mail.) W...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Yandex post office: how we made a service analyzing the results of mailings in realtime</h1><div class="post__text post__text-html js-mediator-article">  Yandex has a service for bona fide letter mailers - the <a href="https://postoffice.yandex.ru/">Post Office</a> .  (For unscrupulous, we have <a href="http://company.yandex.ru/technologies/antispam/">Antispam</a> and <a href="http://habrahabr.ru/company/yandex/blog/217699/">the "Unsubscribe" button</a> in the Mail.) With it, they can understand how many of their letters Yandex.Mail users delete, how much time they read, how much they read.  My name is Anton Kholodkov, and I was developing the server part of this system.  In this post I will talk about how we developed it and what difficulties we encountered. <br><br> <a href="http://habrahabr.ru/company/yandex/blog/240181/"><img src="https://habrastorage.org/files/206/13a/2e7/20613a2e7a434a4abcc9a567a4b13982.jpg"></a> <br><br>  For the sender, the Post Office interface is completely transparent.  It is enough to register your domain or email in the system.  The service collects and analyzes data on a variety of parameters: name and domain of the sender, time, sign of spam / not spam, read / not read.  Also implemented is aggregation over a list-id field ‚Äî a special header for identifying mailings.  We have several data sources. <br><a name="habracut"></a><br>  First, the metabase delivery system.  It generates events that the letter entered the system.  Secondly, the web-based mail interface, where the user changes the state of the letter: reads it, marks it as spam or deletes it.  All these actions should get into the repository. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      When saving and modifying information there are no strict time requirements.  Recording may be added or changed for quite some time.  At this point, the statistics will reflect the previous state of the system.  With large amounts of data it is imperceptible to the user.  One or two of his actions, which have not yet been put in the base, will not be able to change the statistics to any great significance. <br><br>  In the web interface, the response speed is very important - inhibitions look ugly.  In addition, it is important not to allow "jumps" of values ‚Äã‚Äãwhen updating the browser window.  This situation occurs when data is extracted from one head, then from another. <br><br>  I want to say a few words about choosing a platform.  We immediately realized that not every solution will cope with the data flow that we have.  Initially there were three candidates: <a href="http://www.mongodb.org/">MongoDB</a> , <a href="http://www.postgresql.org/">Postgres</a> , our own bundle of <a href="http://habrahabr.ru/company/yandex/blog/219617/">Lucene + Zookeeper</a> .  We refused the first two due to insufficient performance.  Especially big problems were when inserting large amounts of data.  As a result, we decided to use the experience of our colleagues and used the Lucene + Zookeeper bundle - the same bundle is used by Yandex.Mail Search. <br><br>  The standard of communication between components within the system has become JSON.  Java and Javascript have convenient tools for working with it.  In C ++, use yajl and boost :: property_tree.  All components implement the REST API. <br><br>  The data in the system is stored in Apache Lucene.  As you know, Lucene is a library developed by the Apache Foundation for full-text search.  It allows you to store and retrieve any pre-indexed data.  We turned it into a server: we taught us how to store data, add it to an index, and compress it.  With the help of http request you can search, add, modify.  There are various types of aggregation. <br><br>  For each status change record to be processed in all cluster heads, use Zookeeper, another Apache Fondation product.  We have finalized it and added the ability to use as a queue. <br><br>  A special daemon is written to extract and analyze data from Lucene.  It focuses all the logic of work.  Web interface calls are turned into http requests to Lucene.  Immediately implemented the logic of data aggregation, sorting and other processing that are needed to display data in the web interface. <br><br><img src="https://habrastorage.org/files/dfd/05b/8fa/dfd05b8faa9d425fa4638e25da657881.jpg"><br><br>  When users perform actions in the web interface, information about these actions is saved through Zookeeper in Lucene.  Each action ‚Äî for example, pressing the ‚ÄúSpam‚Äù button ‚Äî changes the state of the system, and you need to carefully modify all the data it affects.  This is the most difficult part of the system, we rewrote and debugged it the longest. <br><br>  The first attempt to solve the problem was, as they say, "head on."  We wanted to put Lucene status records on the fly.  Aggregate data was assumed in real time when retrieved.  This solution worked fine on a small number of records.  Summing hundreds of records took microseconds.  Everything looked great.  Problems began with a large number of records.  For example, thousands of already processed seconds.  Tens of thousands - tens of seconds.  It annoyed users and us.  It was necessary to look for ways to speed up data output. <br><br>  In this case, the aggregation of ordinary users with tens, hundreds and thousands of letters per day was not a problem.  The problem was the individual mailers who sent out hundreds of thousands of letters in a very short time.  It was impossible to calculate real-time data for them. <br><br>  The solution was found after analyzing requests from the web interface.  There were few kinds of queries, and they all boiled down to summing up the data or finding the average of a series of data.  We added aggregation records to the database and began to modify them when adding or changing letter status records.  For example, a letter arrived - they added one to the total counter.  The user deleted the letter - they took one from the total counter and added one to the deleted ones.  The user has marked the letter with spam - they have added one to the counter of "spam letters".  The number of records that need to be processed to fulfill the request has decreased, and this greatly accelerated the aggregation.  Zookeeper makes it easy to ensure data integrity.  Changing aggregate records takes time, but we can afford a small data lag. <br><br>  What was the result?  Now there are four cars on the system at Lucene, three at Zookeeper.  Input data comes from 10 machines and is issued on six frontend machines.  Per second, the system processes 4,500 modification requests and 1,100 read requests.  Storage capacity today is 3.2 terabytes. <br><br>  The storage system on Lucene + Zookeeper has proven itself very stable.  You can disable the node on the fly on Lucene, you can add a node.  Zookeeper keeps history and rolls the necessary number of events on the new machine.  After a while we will get a head with relevant information.  One machine in the cluster is allocated for storing data backups. <br><br>  Despite the short development time, the system turned out to be reliable and fast.  The architecture makes it easy to scale - both vertically and horizontally - and add new data analysis capabilities.  Which we will add for you soon. </div><p>Source: <a href="https://habr.com/ru/post/240181/">https://habr.com/ru/post/240181/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../240161/index.html">Activate multisite support in a Wordpress installation on a VPS from Infobox in 5 minutes</a></li>
<li><a href="../240165/index.html">Introduction of modern DECT communication</a></li>
<li><a href="../240169/index.html">How I patch Zabbix</a></li>
<li><a href="../240177/index.html">Ten trends that change modern data centers</a></li>
<li><a href="../240179/index.html">We invite you to the seminar "Practice of choosing solutions to protect against zero-day threats and targeted attacks"</a></li>
<li><a href="../240183/index.html">Small Hello World for a small microcontroller - at 24 bytes (and someone else's decision at 12 bytes)</a></li>
<li><a href="../240185/index.html">Empowering Tween Animations in NGUI</a></li>
<li><a href="../240187/index.html">Official Symfony Best Practices Guide</a></li>
<li><a href="../240193/index.html">Where to find an incentive, or how we went to the Microsoft hackathon</a></li>
<li><a href="../240195/index.html">Geek competition: how we did it (part 1)</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>