<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Statistical analysis in PostgreSQL using PL / R</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Friends, at the last day's PG Day'15 Russia conference, one of our speakers, Joseph Conway, presented interesting material on the use of the PL / R ex...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Statistical analysis in PostgreSQL using PL / R</h1><div class="post__text post__text-html js-mediator-article">  <i>Friends, at the last <a href="http://pgday.ru/ru/2015">day's PG Day'15 Russia</a> conference, one of our speakers, Joseph Conway, presented interesting material on the use of the PL / R extension created and maintained for more than ten years, which allows using the language for statistical analysis of R inside everyone's favorite Database.</i>  <i>I would like to offer you a follow-up article based on the materials presented <a href="http://pgday.ru/ru/2015/papers/25">in the Joe report</a> .</i>  <i>The goal of this publication is to introduce you to the capabilities of the PL / R language.</i>  <i>I hope you find the information presented here useful for you.</i> <br><br><img src="https://habrastorage.org/files/d7f/c27/2b9/d7fc272b9c95473abe52ffef4143dc2f.png" alt="image"><br><br>  Recent Big Data trends have been encouraging convergence of analytics and data, while PL / R has unobtrusively provided this service for 12 years now!  If suddenly you do not know, PL / R is an extension for PostgreSQL that allows you to use R, a language for mathematical calculations, directly from PostgreSQL in order to easily and easily get expanded analytics.  Expansion is available and actively improved since 2003.  It works with all supported versions of PostgreSQL and with all the latest versions of R. Thousands of people around the world have already appreciated its convenience and efficiency.  Let us see what PL / R is, discuss the advantages and disadvantages of such an approach to data analysis and consider several examples for clarity. <br><a name="habracut"></a><br>  To begin with, we will define the basic concepts.  R is a programming language for statistical data processing and graphics, as well as a free open-source computing environment.  And PostgreSQL is a powerful free object-relational database management system that has been actively developed for more than 25 years and has earned an excellent reputation for its reliability, as well as data correctness and integrity.  And finally, PL / R.  As mentioned above, this is a procedural R language handler for PostgreSQL, which allows writing SQL functions on R. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      So what are the benefits of PL / R?  First, PL / R contributes to the development of human knowledge and skills, since mathematics, statistics, databases and the web are different specializations, but all of them will have to be mastered in one way or another to work with PL / R.  Secondly, this extension encourages the improvement of hardware, since you will need a server that can withstand the analysis of large data sets.  Third, processing efficiency will increase, since you no longer have to transfer large data sets across the entire network, and throughput will increase.  Fourth, you can be sure that the analysis will be carried out consistently.  Fifth, PL / R makes the system of any complexity understandable and supported.  And finally, thanks to the rich functionality and a huge PL / R ecosystem, it expands the possibilities of R. <br><br>  But, of course, there are downsides.  The PostgreSQL user will most likely feel that PL / R is slower, especially on simple tasks.  And for the R programmer, the debugging process becomes more complicated and the analysis becomes less flexible.  In addition, both will have to learn a new language. <br><br>  Something like this is the standard function in R: <br><br><pre><code class="hljs actionscript">func_name &lt;- <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(myarg1 [,myarg2</span></span><span class="hljs-rest_arg"><span class="hljs-function"><span class="hljs-params"><span class="hljs-rest_arg">...]) { function</span></span></span></span><span class="hljs-function"><span class="hljs-params"> body referencing myarg1 [, myarg2 </span></span><span class="hljs-rest_arg"><span class="hljs-function"><span class="hljs-params"><span class="hljs-rest_arg">...] }</span></span></span></span></span></span></code> </pre> <br>  Creating functions in PL / R is slightly different, but similar to other PLs in PostgreSQL: <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">OR</span></span> <span class="hljs-keyword"><span class="hljs-keyword">REPLACE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FUNCTION</span></span> func_name(arg-type1 [, arg-type2 ...]) <span class="hljs-keyword"><span class="hljs-keyword">RETURNS</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>-<span class="hljs-keyword"><span class="hljs-keyword">type</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> $$ <span class="hljs-keyword"><span class="hljs-keyword">function</span></span> <span class="hljs-keyword"><span class="hljs-keyword">body</span></span> <span class="hljs-keyword"><span class="hljs-keyword">referencing</span></span> arg1 [, arg2 ...] $$ <span class="hljs-keyword"><span class="hljs-keyword">LANGUAGE</span></span> <span class="hljs-string"><span class="hljs-string">'plr'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">OR</span></span> <span class="hljs-keyword"><span class="hljs-keyword">REPLACE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FUNCTION</span></span> func_name(myarg1 arg-type1 [, myarg2 arg-type2 ...]) <span class="hljs-keyword"><span class="hljs-keyword">RETURNS</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>-<span class="hljs-keyword"><span class="hljs-keyword">type</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> $$ <span class="hljs-keyword"><span class="hljs-keyword">function</span></span> <span class="hljs-keyword"><span class="hljs-keyword">body</span></span> <span class="hljs-keyword"><span class="hljs-keyword">referencing</span></span> myarg1 [, myarg2 ...] $$ <span class="hljs-keyword"><span class="hljs-keyword">LANGUAGE</span></span> <span class="hljs-string"><span class="hljs-string">'plr'</span></span>;</code> </pre><br>  Let's give an example: <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> EXTENSION plr; <span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">OR</span></span> <span class="hljs-keyword"><span class="hljs-keyword">REPLACE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FUNCTION</span></span> test_dtup(<span class="hljs-keyword"><span class="hljs-keyword">OUT</span></span> f1 <span class="hljs-built_in"><span class="hljs-built_in">text</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">OUT</span></span> f2 <span class="hljs-built_in"><span class="hljs-built_in">int</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">RETURNS</span></span> SETOF <span class="hljs-built_in"><span class="hljs-built_in">record</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> $$ data.frame(letters[<span class="hljs-number"><span class="hljs-number">1</span></span>:<span class="hljs-number"><span class="hljs-number">3</span></span>],<span class="hljs-number"><span class="hljs-number">1</span></span>:<span class="hljs-number"><span class="hljs-number">3</span></span>) $$ <span class="hljs-keyword"><span class="hljs-keyword">LANGUAGE</span></span> <span class="hljs-string"><span class="hljs-string">'plr'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> test_dtup(); f1 | f2 <span class="hljs-comment"><span class="hljs-comment">----+---- a | 1 b | 2 c | 3 (3 rows)</span></span></code> </pre><br>  It is difficult to list everything that can be done with the help of PL / R, but let's look in detail at some important properties, such as: <br><br><ul><li>  PostgreSQL compatibility; </li><li>  custom SQL aggregates; </li><li>  window functions; </li><li>  translation of the object R to bytea (binary strings). </li></ul><br>  Due to PostgreSQL compatibility, we can create prototypes using R, and then move to PL / R for execution in production.  Also undoubted advantage is that all queries are executed in the current database.  The driver and connection settings are ignored, so dbDriver, dbConnect, dbDisconnect and dbUnloadDriver do not require extra effort: <br><br><pre> <code class="hljs pgsql">dbDriver(<span class="hljs-type"><span class="hljs-type">character</span></span> dvr_name) dbConnect(DBIDriver drv, <span class="hljs-type"><span class="hljs-type">character</span></span> <span class="hljs-keyword"><span class="hljs-keyword">user</span></span>, <span class="hljs-type"><span class="hljs-type">character</span></span> <span class="hljs-keyword"><span class="hljs-keyword">password</span></span>, <span class="hljs-type"><span class="hljs-type">character</span></span> host, <span class="hljs-type"><span class="hljs-type">character</span></span> dbname, <span class="hljs-type"><span class="hljs-type">character</span></span> port, <span class="hljs-type"><span class="hljs-type">character</span></span> tty, <span class="hljs-type"><span class="hljs-type">character</span></span> <span class="hljs-keyword"><span class="hljs-keyword">options</span></span>) dbSendQuery(DBIConnection conn, <span class="hljs-type"><span class="hljs-type">character</span></span> <span class="hljs-keyword"><span class="hljs-keyword">sql</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">fetch</span></span>(DBIResult rs, <span class="hljs-type"><span class="hljs-type">integer</span></span> num_rows) dbClearResult (DBIResult rs) dbGetQuery(DBIConnection conn, <span class="hljs-type"><span class="hljs-type">character</span></span> <span class="hljs-keyword"><span class="hljs-keyword">sql</span></span>) dbReadTable(DBIConnection conn, <span class="hljs-type"><span class="hljs-type">character</span></span> <span class="hljs-type"><span class="hljs-type">name</span></span>) dbDisconnect(DBIConnection conn) dbUnloadDriver(DBIDriver drv)</code> </pre><br>  Let's give a couple of examples for clarity.  Suppose we need to contact PostgreSQL from R to solve the famous traveling salesman problem, which we will look at in detail later: <br><br><pre> <code class="hljs matlab">tsp_tour_length&lt;-<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> { </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">require</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(TSP)</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">require</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(fields)</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">require</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(RPostgreSQL)</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">drv</span></span></span><span class="hljs-function"> &lt;- </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">dbDriver</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">("PostgreSQL")</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">conn</span></span></span><span class="hljs-function"> &lt;- </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">dbConnect</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(drv, user="postgres", dbname="plr", host="localhost")</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">sql</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">str</span></span></span><span class="hljs-function"> &lt;- "</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">select</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">id</span></span></span><span class="hljs-function">, </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">st_x</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(location)</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">as</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">x</span></span></span><span class="hljs-function">, </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">st_y</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(location)</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">as</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">y</span></span></span><span class="hljs-function">, </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">location</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">from</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">stands</span></span></span><span class="hljs-function">" </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">waypts</span></span></span><span class="hljs-function"> &lt;- </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">dbGetQuery</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(conn, sql.str)</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">dist</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">matrix</span></span></span><span class="hljs-function"> &lt;- </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">rdist</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">earth</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(waypts[,2:3], R=3949.0)</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">rtsp</span></span></span><span class="hljs-function"> &lt;- </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">TSP</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(dist.matrix)</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">soln</span></span></span><span class="hljs-function"> &lt;- </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">solve_TSP</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(rtsp)</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">dbDisconnect</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(conn)</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">dbUnloadDriver</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(drv)</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">return</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(attributes(soln)</span></span></span><span class="hljs-function">$</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">tour_length</span></span></span><span class="hljs-function">) }</span></span></code> </pre><br>  This is the same function in PL / R: <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">OR</span></span> <span class="hljs-keyword"><span class="hljs-keyword">REPLACE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FUNCTION</span></span> tsp_tour_length() <span class="hljs-keyword"><span class="hljs-keyword">RETURNS</span></span> float8 <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> $$ require(TSP) require(<span class="hljs-keyword"><span class="hljs-keyword">fields</span></span>) require(RPostgreSQL) drv &lt;- dbDriver(<span class="hljs-string"><span class="hljs-string">"PostgreSQL"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">conn</span></span> &lt;- dbConnect(drv, <span class="hljs-keyword"><span class="hljs-keyword">user</span></span>=<span class="hljs-string"><span class="hljs-string">"postgres"</span></span>, dbname=<span class="hljs-string"><span class="hljs-string">"plr"</span></span>, host=<span class="hljs-string"><span class="hljs-string">"localhost"</span></span>) sql.str &lt;- <span class="hljs-string"><span class="hljs-string">"select id, st_x(location) as x, st_y(location) as y, location from stands"</span></span> waypts &lt;- dbGetQuery(<span class="hljs-keyword"><span class="hljs-keyword">conn</span></span>, sql.str) dist.matrix &lt;- rdist.earth(waypts[,<span class="hljs-number"><span class="hljs-number">2</span></span>:<span class="hljs-number"><span class="hljs-number">3</span></span>], R=<span class="hljs-number"><span class="hljs-number">3949.0</span></span>) rtsp &lt;- TSP(dist.matrix) soln &lt;- solve_TSP(rtsp) dbDisconnect(<span class="hljs-keyword"><span class="hljs-keyword">conn</span></span>) dbUnloadDriver(drv) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">attributes</span></span>(soln)$tour_length) $$ <span class="hljs-keyword"><span class="hljs-keyword">LANGUAGE</span></span> <span class="hljs-string"><span class="hljs-string">'plr'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">STRICT</span></span>;</code> </pre><br>  This is what R finally brings us: <br><br><pre> <code class="hljs css"><span class="hljs-selector-tag"><span class="hljs-selector-tag">tsp_tour_length</span></span>() <span class="hljs-selector-attr"><span class="hljs-selector-attr">[1]</span></span> 2804<span class="hljs-selector-class"><span class="hljs-selector-class">.581</span></span></code> </pre><br>  And the same function in PL / R: <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> tsp_tour_length(); tsp_tour_length <span class="hljs-comment"><span class="hljs-comment">------------------ 2804.58129355858 (1 row)</span></span></code> </pre><br>  As you can see, the result is the same. <br><br>  Now let's talk about aggregates.  One of the most useful features of PostgreSQL is the ability to write your own aggregate functions.  Aggregates in PostgreSQL can be expanded using SQL commands.  In this case, the state transition function and, sometimes, the final function (final function) are indicated.  The initial condition of the transition function can also be specified.  And these benefits you can enjoy working with PL / R. <br><br>  Let us give an example of the function PL / R implementing a new unit.  Until recently, it was impossible to do this from PostgreSQL, GROUPING SETS functionality appeared only in version 9.5, while PL / R allows it to be done in any version of PG.  I will create an aggregate function based on the real data of one production company and call it quartile: <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">OR</span></span> <span class="hljs-keyword"><span class="hljs-keyword">REPLACE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FUNCTION</span></span> r_quartile(ANYARRAY) <span class="hljs-keyword"><span class="hljs-keyword">RETURNS</span></span> ANYARRAY <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> $$ quantile(arg1, probs = seq(<span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-number"><span class="hljs-number">0.25</span></span>), <span class="hljs-keyword"><span class="hljs-keyword">names</span></span> = <span class="hljs-literal"><span class="hljs-literal">FALSE</span></span>) $$ <span class="hljs-keyword"><span class="hljs-keyword">LANGUAGE</span></span> <span class="hljs-string"><span class="hljs-string">'plr'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AGGREGATE</span></span> quartile (ANYELEMENT) ( sfunc = array_append, stype = ANYARRAY, finalfunc = r_quantile, initcond = <span class="hljs-string"><span class="hljs-string">'{}'</span></span> ); <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> workstation, quartile(id_val) <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> sample_numeric_data <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> ia_id = <span class="hljs-string"><span class="hljs-string">'G121XB8A'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">GROUP</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BY</span></span> workstation; workstation | quantile <span class="hljs-comment"><span class="hljs-comment">-------------+--------------------------------- 1055 | {4.19,5.02,5.21,5.5,6.89} 1051 | {3.89,4.66,4.825,5.2675,5.47} 1068 | {4.33,5.2625,5.455,5.5275,6.01} 1070 | {4.51,5.1975,5.485,5.7575,6.41} (4 rows)</span></span></code> </pre><br>  R allows you to display data in the form of nice graphs.  In this case, the box diagram was used: <br><img src="https://habrastorage.org/files/7f5/5e2/c93/7f55e2c93811481fb9841bdfc8442e63.png"><br>  The schedule shows that one of the production stations is less productive than the others, and measures need to be taken to fix this. <br><br>  We should also dwell on the <a href="http://www.postgresql.org/docs/9.5/static/tutorial-window.html">window functions</a> .  They are available in PostgreSQL, starting with version 8.4, and are great for statistical analysis.  Window functions are similar to aggregate ones, but, unlike them, they do not group rows, but allow calculations to be performed in rowsets associated with the current row, having access not only to the current row of the query result.  In other words, your data is divided into sections, and there is a window that slides through these sections and gives the result for each group of data: <br><br><img src="https://habrastorage.org/files/667/7e9/17a/6677e917a7ee48bdbcb181ca70a3e247.png"><br>  Few PostgreSQL procedural languages ‚Äã‚Äãsupport windowing functions, but they are quite useful in PL / R.  Let us give an example: we will create a table of random data that simulates income and stock prices. <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> test_data ( fyear <span class="hljs-built_in"><span class="hljs-built_in">integer</span></span>, firm float8, eps float8 ); <span class="hljs-keyword"><span class="hljs-keyword">INSERT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INTO</span></span> test_data <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> (bf + <span class="hljs-number"><span class="hljs-number">1</span></span>) % <span class="hljs-number"><span class="hljs-number">10</span></span> + <span class="hljs-number"><span class="hljs-number">2000</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> fyear, <span class="hljs-keyword"><span class="hljs-keyword">floor</span></span>((b.f+<span class="hljs-number"><span class="hljs-number">1</span></span>)/<span class="hljs-number"><span class="hljs-number">10</span></span>) + <span class="hljs-number"><span class="hljs-number">50</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> firm, f::float8/<span class="hljs-number"><span class="hljs-number">100</span></span> + random()/<span class="hljs-number"><span class="hljs-number">10</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> eps <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> generate_series(<span class="hljs-number"><span class="hljs-number">-500</span></span>,<span class="hljs-number"><span class="hljs-number">499</span></span>,<span class="hljs-number"><span class="hljs-number">1</span></span>) b(f); <span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">OR</span></span> <span class="hljs-keyword"><span class="hljs-keyword">REPLACE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FUNCTION</span></span> r_regr_slope(float8, float8) <span class="hljs-keyword"><span class="hljs-keyword">RETURNS</span></span> float8 <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> $<span class="hljs-keyword"><span class="hljs-keyword">BODY</span></span>$ slope &lt;- NA y &lt;- farg1 x &lt;- farg2 <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (fnumrows==<span class="hljs-number"><span class="hljs-number">9</span></span>) try (slope &lt;- lm(y ~ x)$coefficients[<span class="hljs-number"><span class="hljs-number">2</span></span>]) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>(slope) $<span class="hljs-keyword"><span class="hljs-keyword">BODY</span></span>$ <span class="hljs-keyword"><span class="hljs-keyword">LANGUAGE</span></span> plr WINDOW;</code> </pre><br>  And we will write a function in order to find out whether it is possible to predict revenues this year, based on last year‚Äôs figures, using a simple regression method. <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> *, r_regr_slope(eps, lag_eps) <span class="hljs-keyword"><span class="hljs-keyword">OVER</span></span> w <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> slope_R <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> ( <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> firm <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> f, fyear <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> fyr, eps, lag(eps) <span class="hljs-keyword"><span class="hljs-keyword">OVER</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">PARTITION</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BY</span></span> firm <span class="hljs-keyword"><span class="hljs-keyword">ORDER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BY</span></span> firm, fyear) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> lag_eps <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> test_data ) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> a <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> eps <span class="hljs-keyword"><span class="hljs-keyword">IS</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> WINDOW w <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">PARTITION</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BY</span></span> firm <span class="hljs-keyword"><span class="hljs-keyword">ORDER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BY</span></span> firm, fyear <span class="hljs-keyword"><span class="hljs-keyword">ROWS</span></span> <span class="hljs-number"><span class="hljs-number">8</span></span> <span class="hljs-keyword"><span class="hljs-keyword">PRECEDING</span></span>); f | fyr | eps | lag_eps | slope_r <span class="hljs-comment"><span class="hljs-comment">---+------+-------------------+-------------------+------------------- 1 | 1991 | -4.99563754182309 | | 1 | 1992 | -4.96425441872329 | -4.99563754182309 | 1 | 1993 | -4.96906093481928 | -4.96425441872329 | 1 | 1994 | -4.92376988714561 | -4.96906093481928 | 1 | 1995 | -4.95884547665715 | -4.92376988714561 | 1 | 1996 | -4.93236254784279 | -4.95884547665715 | 1 | 1997 | -4.90775520844385 | -4.93236254784279 | 1 | 1998 | -4.92082695348188 | -4.90775520844385 | 1 | 1999 | -4.84991340579465 | -4.92082695348188 | 0.691850614092383 1 | 2000 | -4.86000917562284 | -4.84991340579465 | 0.700526929134053</span></span></code> </pre><br>  As you can see, the function considered the dependence of income on indicators of previous years. <br><br>  The last thing worth talking about in detail is the mechanisms for returning R objects and the ways to store them. <br><br>  Let's give an example with stock data.  To do this, take the Hi-Low-Close data from Yahoo for any ‚Äúticker‚Äù (stock ticker).  Construct a graph with Bollinger lines and volume.  We will need additional R packages that can be obtained from R with the following command: <br><br><pre> <code class="hljs cs">install.packages(c(<span class="hljs-string"><span class="hljs-string">'xts'</span></span>,<span class="hljs-string"><span class="hljs-string">'Defaults'</span></span>,<span class="hljs-string"><span class="hljs-string">'quantmod'</span></span>,<span class="hljs-string"><span class="hljs-string">'cairoDevice'</span></span>,<span class="hljs-string"><span class="hljs-string">'RGtk2'</span></span>))</code> </pre><br>  Now we make a query: <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">OR</span></span> <span class="hljs-keyword"><span class="hljs-keyword">REPLACE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FUNCTION</span></span> plot_stock_data(sym <span class="hljs-built_in"><span class="hljs-built_in">text</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">RETURNS</span></span> bytea <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> $$ <span class="hljs-keyword"><span class="hljs-keyword">library</span></span>(quantmod) <span class="hljs-keyword"><span class="hljs-keyword">library</span></span>(cairoDevice) <span class="hljs-keyword"><span class="hljs-keyword">library</span></span>(RGtk2) pixmap &lt;- gdkPixmapNew(w=<span class="hljs-number"><span class="hljs-number">500</span></span>, h=<span class="hljs-number"><span class="hljs-number">500</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">depth</span></span>=<span class="hljs-number"><span class="hljs-number">24</span></span>) asCairoDevice(pixmap) getSymbols(c(sym)) chartSeries(<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(sym), <span class="hljs-keyword"><span class="hljs-keyword">name</span></span>=sym, theme=<span class="hljs-string"><span class="hljs-string">"white"</span></span>, TA=<span class="hljs-string"><span class="hljs-string">"addVo();addBBands();addCCI()"</span></span>) plot_pixbuf &lt;- gdkPixbufGetFromDrawable(<span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, pixmap, pixmap$getColormap(),<span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">500</span></span>, <span class="hljs-number"><span class="hljs-number">500</span></span>) buffer &lt;- gdkPixbufSaveToBufferv(plot_pixbuf, <span class="hljs-string"><span class="hljs-string">"jpeg"</span></span>, <span class="hljs-built_in"><span class="hljs-built_in">character</span></span>(<span class="hljs-number"><span class="hljs-number">0</span></span>), <span class="hljs-built_in"><span class="hljs-built_in">character</span></span>(<span class="hljs-number"><span class="hljs-number">0</span></span>))$buffer <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>(buffer) $$ <span class="hljs-keyword"><span class="hljs-keyword">LANGUAGE</span></span> plr;</code> </pre><br>  A typical server will require a screen buffer to create a graph: <br><br><pre> <code class="hljs objectivec">Xvfb :<span class="hljs-number"><span class="hljs-number">1</span></span> -screen <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">1024</span></span>x768x24 <span class="hljs-keyword"><span class="hljs-keyword">export</span></span> DISPLAY=:<span class="hljs-number"><span class="hljs-number">1.0</span></span></code> </pre><br>  Now call the PHP function for the CYMI ticker: <br><br><pre> <code class="php hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?php</span></span> $dbconn = pg_connect(<span class="hljs-string"><span class="hljs-string">"..."</span></span>); $rs = pg_query($dbconn, <span class="hljs-string"><span class="hljs-string">"select plr_get_raw(plot_stock_data('CYMI'))"</span></span>); $hexpic = pg_fetch_array($rs); $cleandata = pg_unescape_bytea($hexpic[<span class="hljs-number"><span class="hljs-number">0</span></span>]); header(<span class="hljs-string"><span class="hljs-string">"Content-Type: image/png"</span></span>); header(<span class="hljs-string"><span class="hljs-string">"Last-Modified: "</span></span> . date(<span class="hljs-string"><span class="hljs-string">"r"</span></span>, filectime($_SERVER[<span class="hljs-string"><span class="hljs-string">'SCRIPT_FILENAME'</span></span>]))); header(<span class="hljs-string"><span class="hljs-string">"Content-Length: "</span></span> . strlen($cleandata)); <span class="hljs-keyword"><span class="hljs-keyword">echo</span></span> $cleandata; <span class="hljs-meta"><span class="hljs-meta">?&gt;</span></span></code> </pre><br>  And here is the schedule we get at the output: <br><br><img src="https://habrastorage.org/files/395/6f2/fbb/3956f2fbb34146be9512e3d488a74a8a.png"><br>  Agree, it is surprising that we can write a dozen lines on PL / R and less than a dozen lines in PHP, and eventually get such a detailed visual display and analysis of our data. <br><br>  To consolidate information, consider more complex examples.  I think many are familiar with Benford's law, or the law of the first digit, which describes the probability of the appearance of a certain first significant digit in the distributions of values ‚Äã‚Äãtaken from real life.  But some do not know about its existence and themselves distribute the data as they need, instead of applying the law. <br><br>  Benford's law can be used to identify potential fraud: it can be used to construct an approximate geometric sequence based on several initial values, and then compare it with real data and find inconsistencies.  This method can be applied to sales schedules, census data, cost reports, etc. <br><br>  Let's look at an example with data from the California Energy Optimization Program.  To begin with, we will create and fill in a table with data on investment in the project (data are available at <a href="http://open-emv.com/data">http://open-emv.com/data</a> ): <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> open_emv_cost(<span class="hljs-keyword"><span class="hljs-keyword">value</span></span> float8, district <span class="hljs-built_in"><span class="hljs-built_in">int</span></span>); COPY open_emv_cost FROM 'open-emv.cost.csv' <span class="hljs-keyword"><span class="hljs-keyword">WITH</span></span> delimiter <span class="hljs-string"><span class="hljs-string">','</span></span>;</code> </pre><br>  Now we write the function of Benford's law: <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TYPE</span></span> benford_t <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> ( actual_mean float8, n <span class="hljs-built_in"><span class="hljs-built_in">int</span></span>, expected_mean float8, distorion float8, z float8 ); <span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">OR</span></span> <span class="hljs-keyword"><span class="hljs-keyword">REPLACE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FUNCTION</span></span> benford(numarr float8[]) <span class="hljs-keyword"><span class="hljs-keyword">RETURNS</span></span> benford_t <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> $$ xcoll &lt;- <span class="hljs-keyword"><span class="hljs-keyword">function</span></span>(x) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> ((<span class="hljs-number"><span class="hljs-number">10</span></span> * x) / (<span class="hljs-number"><span class="hljs-number">10</span></span> ^ (trunc(<span class="hljs-keyword"><span class="hljs-keyword">log10</span></span>(x))))) } numarr &lt;- numarr[numarr &gt;= <span class="hljs-number"><span class="hljs-number">10</span></span>] numarr &lt;- xcoll(numarr) actual_mean &lt;- mean(numarr) n &lt;- <span class="hljs-keyword"><span class="hljs-keyword">length</span></span>(numarr) expected_mean &lt;- (<span class="hljs-number"><span class="hljs-number">90</span></span> / (n * (<span class="hljs-number"><span class="hljs-number">10</span></span> ^ (<span class="hljs-number"><span class="hljs-number">1</span></span>/n) - <span class="hljs-number"><span class="hljs-number">1</span></span>))) distorion &lt;- ((actual_mean - expected_mean) / expected_mean) z &lt;- (distorion / sd(numarr)) retval &lt;- data.frame(actual_mean,n,expected_mean,distorion,z) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>(retval) $$ <span class="hljs-keyword"><span class="hljs-keyword">LANGUAGE</span></span> plr;</code> </pre><br>  And run the comparison: <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> benford(<span class="hljs-built_in"><span class="hljs-built_in">array</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">value</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> open_emv_cost)); -[ RECORD 1 ]-+<span class="hljs-comment"><span class="hljs-comment">---------------------- actual_mean | 38.1936561918275 n | 240 expected_mean | 38.8993031865999 distorion | -0.0181403505195804 z | -0.000984036908080443</span></span></code> </pre><br>  It seems that real data are projected, so there are no signs of fraud in this case. <br><br>  Let's return to the traveling salesman problem.  This is one of the most well-known tasks of combinatorial optimization, which consists in finding the most profitable route that passes at least once through the specified cities, with subsequent return to the source city.  Under the conditions of the task, the criteria for the profitability of the route (the shortest, cheapest, aggregate criterion, and so on) and the corresponding matrices of distances, cost, and the like are indicated.  As a rule, it is indicated that the route should pass through each city only once.  Let's consider this option. <br><br>  To begin, create and fill a table with all the cities that you need to visit: <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> stands ( <span class="hljs-keyword"><span class="hljs-keyword">id</span></span> <span class="hljs-built_in"><span class="hljs-built_in">serial</span></span> primary <span class="hljs-keyword"><span class="hljs-keyword">key</span></span>, strata <span class="hljs-built_in"><span class="hljs-built_in">integer</span></span> <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span>, initage <span class="hljs-built_in"><span class="hljs-built_in">integer</span></span> ); <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> AddGeometryColumn(<span class="hljs-string"><span class="hljs-string">''</span></span>,<span class="hljs-string"><span class="hljs-string">'stands'</span></span>,<span class="hljs-string"><span class="hljs-string">'boundary'</span></span>,<span class="hljs-string"><span class="hljs-string">'4326'</span></span>,<span class="hljs-string"><span class="hljs-string">'MULTIPOLYGON'</span></span>,<span class="hljs-number"><span class="hljs-number">2</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INDEX</span></span> <span class="hljs-string"><span class="hljs-string">"stands_boundary_gist"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> <span class="hljs-string"><span class="hljs-string">"stands"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">USING</span></span> gist (<span class="hljs-string"><span class="hljs-string">"boundary"</span></span> gist_geometry_ops); <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> AddGeometryColumn(<span class="hljs-string"><span class="hljs-string">''</span></span>,<span class="hljs-string"><span class="hljs-string">'stands'</span></span>,<span class="hljs-string"><span class="hljs-string">'location'</span></span>,<span class="hljs-string"><span class="hljs-string">'4326'</span></span>,<span class="hljs-string"><span class="hljs-string">'POINT'</span></span>,<span class="hljs-number"><span class="hljs-number">2</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INDEX</span></span> <span class="hljs-string"><span class="hljs-string">"stands_location_gist"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> <span class="hljs-string"><span class="hljs-string">"stands"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">USING</span></span> gist (<span class="hljs-string"><span class="hljs-string">"location"</span></span> gist_geometry_ops); <span class="hljs-keyword"><span class="hljs-keyword">INSERT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INTO</span></span> stands (<span class="hljs-keyword"><span class="hljs-keyword">id</span></span>,strata,initage,boundary,location) <span class="hljs-keyword"><span class="hljs-keyword">VALUES</span></span> ( <span class="hljs-number"><span class="hljs-number">1</span></span>,<span class="hljs-number"><span class="hljs-number">1</span></span>,<span class="hljs-number"><span class="hljs-number">1</span></span>, GeometryFromText( <span class="hljs-string"><span class="hljs-string">'MULTIPOLYGON(((59.250000 65.000000,55.000000 65.000000,55.000000 51.750000, 60.735294 53.470588, 62.875000 57.750000, 59.250000 65.000000 )))'</span></span>, <span class="hljs-number"><span class="hljs-number">4326</span></span> ), GeometryFromText(<span class="hljs-string"><span class="hljs-string">'POINT( 61.000000 59.000000 )'</span></span>, <span class="hljs-number"><span class="hljs-number">4326</span></span>) ), ( <span class="hljs-number"><span class="hljs-number">2</span></span>,<span class="hljs-number"><span class="hljs-number">2</span></span>,<span class="hljs-number"><span class="hljs-number">1</span></span>, GeometryFromText( <span class="hljs-string"><span class="hljs-string">'MULTIPOLYGON(((67.000000 65.000000,59.250000 65.000000,62.875000 57.750000, 67.000000 60.500000, 67.000000 65.000000 )))'</span></span>, <span class="hljs-number"><span class="hljs-number">4326</span></span> ), GeometryFromText(<span class="hljs-string"><span class="hljs-string">'POINT( 63.000000 60.000000 )'</span></span>, <span class="hljs-number"><span class="hljs-number">4326</span></span> ) ), ( <span class="hljs-number"><span class="hljs-number">3</span></span>,<span class="hljs-number"><span class="hljs-number">3</span></span>,<span class="hljs-number"><span class="hljs-number">1</span></span>, GeometryFromText( <span class="hljs-string"><span class="hljs-string">'MULTIPOLYGON(((67.045455 52.681818,60.735294 53.470588,55.000000 51.750000, 55.000000 45.000000, 65.125000 45.000000, 67.045455 52.681818 )))'</span></span>, <span class="hljs-number"><span class="hljs-number">4326</span></span> ), GeometryFromText(<span class="hljs-string"><span class="hljs-string">'POINT( 64.000000 49.000000 )'</span></span>, <span class="hljs-number"><span class="hljs-number">4326</span></span> ) ) ;</code> </pre><br>  To get the result, I have to write a couple of auxiliary requests.  The first will create a route that I want to get at the output: <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">INSERT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INTO</span></span> stands (<span class="hljs-keyword"><span class="hljs-keyword">id</span></span>,strata,initage,boundary,location) <span class="hljs-keyword"><span class="hljs-keyword">VALUES</span></span> ( <span class="hljs-number"><span class="hljs-number">4</span></span>,<span class="hljs-number"><span class="hljs-number">4</span></span>,<span class="hljs-number"><span class="hljs-number">1</span></span>, GeometryFromText( <span class="hljs-string"><span class="hljs-string">'MULTIPOLYGON(((71.500000 53.500000,70.357143 53.785714,67.045455 52.681818, 65.125000 45.000000, 71.500000 45.000000, 71.500000 53.500000 )))'</span></span>, <span class="hljs-number"><span class="hljs-number">4326</span></span> ), GeometryFromText(<span class="hljs-string"><span class="hljs-string">'POINT( 68.000000 48.000000 )'</span></span>, <span class="hljs-number"><span class="hljs-number">4326</span></span>) ), ( <span class="hljs-number"><span class="hljs-number">5</span></span>,<span class="hljs-number"><span class="hljs-number">5</span></span>,<span class="hljs-number"><span class="hljs-number">1</span></span>, GeometryFromText( <span class="hljs-string"><span class="hljs-string">'MULTIPOLYGON(((69.750000 65.000000,67.000000 65.000000,67.000000 60.500000, 70.357143 53.785714, 71.500000 53.500000, 74.928571 54.642857, 69.750000 65.000000 )))'</span></span>, <span class="hljs-number"><span class="hljs-number">4326</span></span> ), GeometryFromText(<span class="hljs-string"><span class="hljs-string">'POINT( 71.000000 60.000000 )'</span></span>, <span class="hljs-number"><span class="hljs-number">4326</span></span>) ), ( <span class="hljs-number"><span class="hljs-number">6</span></span>,<span class="hljs-number"><span class="hljs-number">6</span></span>,<span class="hljs-number"><span class="hljs-number">1</span></span>, GeometryFromText( <span class="hljs-string"><span class="hljs-string">'MULTIPOLYGON(((80.000000 65.000000,69.750000 65.000000,74.928571 54.642857, 80.000000 55.423077, 80.000000 65.000000 )))'</span></span>, <span class="hljs-number"><span class="hljs-number">4326</span></span> ), GeometryFromText(<span class="hljs-string"><span class="hljs-string">'POINT( 73.000000 61.000000 )'</span></span>, <span class="hljs-number"><span class="hljs-number">4326</span></span>) ), ( <span class="hljs-number"><span class="hljs-number">7</span></span>,<span class="hljs-number"><span class="hljs-number">7</span></span>,<span class="hljs-number"><span class="hljs-number">1</span></span>, GeometryFromText( <span class="hljs-string"><span class="hljs-string">'MULTIPOLYGON(((80.000000 55.423077,74.928571 54.642857,71.500000 53.500000, 71.500000 45.000000, 80.000000 45.000000, 80.000000 55.423077 )))'</span></span>, <span class="hljs-number"><span class="hljs-number">4326</span></span> ), GeometryFromText(<span class="hljs-string"><span class="hljs-string">'POINT( 75.000000 48.000000 )'</span></span>, <span class="hljs-number"><span class="hljs-number">4326</span></span>) ), ( <span class="hljs-number"><span class="hljs-number">8</span></span>,<span class="hljs-number"><span class="hljs-number">8</span></span>,<span class="hljs-number"><span class="hljs-number">1</span></span>, GeometryFromText( <span class="hljs-string"><span class="hljs-string">'MULTIPOLYGON(((67.000000 60.500000,62.875000 57.750000,60.735294 53.470588, 67.045455 52.681818, 70.357143 53.785714, 67.000000 60.500000 )))'</span></span>, <span class="hljs-number"><span class="hljs-number">4326</span></span> ), GeometryFromText(<span class="hljs-string"><span class="hljs-string">'POINT( 65.000000 57.000000 )'</span></span>, <span class="hljs-number"><span class="hljs-number">4326</span></span>) ) ;</code> </pre><br>  And the second is the data that I enter into the plr_modules, and the type of the resulting data: <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">DROP</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">IF</span></span> <span class="hljs-keyword"><span class="hljs-keyword">EXISTS</span></span> <span class="hljs-keyword"><span class="hljs-keyword">events</span></span> <span class="hljs-keyword"><span class="hljs-keyword">CASCADE</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">events</span></span> ( seqid <span class="hljs-built_in"><span class="hljs-built_in">int</span></span> <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span> primary <span class="hljs-keyword"><span class="hljs-keyword">key</span></span>, <span class="hljs-comment"><span class="hljs-comment">-- visit sequence # plotid int, -- original plot id bearing real, -- bearing to next waypoint distance real, -- distance to next waypoint velocity real, -- velocity of travel, in nm/hr traveltime real, -- travel time to next event loitertime real, -- how long to hang out totaltraveldist real, -- cummulative distance totaltraveltime real -- cummulaative time ); SELECT AddGeometryColumn('','events','location','4326','POINT',2); CREATE INDEX "events_location_gist" ON "events" USING gist ("location" gist_geometry_ops); CREATE TABLE plr_modules ( modseq int4 primary key, modsrc text );</span></span></code> </pre><br>  Create the main function PL / R: <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">OR</span></span> <span class="hljs-keyword"><span class="hljs-keyword">REPLACE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FUNCTION</span></span> solve_tsp(makemap <span class="hljs-built_in"><span class="hljs-built_in">bool</span></span>, mapname <span class="hljs-built_in"><span class="hljs-built_in">text</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">RETURNS</span></span> SETOF <span class="hljs-keyword"><span class="hljs-keyword">events</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> $$ require(TSP) require(<span class="hljs-keyword"><span class="hljs-keyword">fields</span></span>) sql.str &lt;- <span class="hljs-string"><span class="hljs-string">"select id, st_x(location) as x, st_y(location) as y, location from stands;"</span></span> waypts &lt;- pg.spi.exec(sql.str) dist.matrix &lt;- rdist.earth(waypts[,<span class="hljs-number"><span class="hljs-number">2</span></span>:<span class="hljs-number"><span class="hljs-number">3</span></span>], R=<span class="hljs-number"><span class="hljs-number">3949.0</span></span>) rtsp &lt;- TSP(dist.matrix) soln &lt;- solve_TSP(rtsp) tour &lt;- as.vector(soln) pg.thrownotice( paste(<span class="hljs-string"><span class="hljs-string">"tour.dist="</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">attributes</span></span>(soln)$tour_length)) route &lt;- make.route(tour, waypts, dist.matrix) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (makemap) { make.map(tour, waypts, mapname) } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>(route) $$ <span class="hljs-keyword"><span class="hljs-keyword">LANGUAGE</span></span> <span class="hljs-string"><span class="hljs-string">'plr'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">STRICT</span></span>;</code> </pre><br>  Now we need to set the function make.route (): <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">INSERT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INTO</span></span> plr_modules <span class="hljs-keyword"><span class="hljs-keyword">VALUES</span></span> ( <span class="hljs-number"><span class="hljs-number">0</span></span>, $$ make.route &lt;-<span class="hljs-keyword"><span class="hljs-keyword">function</span></span>(tour, waypts, dist.matrix) { velocity &lt;- <span class="hljs-number"><span class="hljs-number">500.0</span></span> starts &lt;- tour[<span class="hljs-number"><span class="hljs-number">1</span></span>:(<span class="hljs-keyword"><span class="hljs-keyword">length</span></span>(tour))<span class="hljs-number"><span class="hljs-number">-1</span></span>] stops &lt;- tour[<span class="hljs-number"><span class="hljs-number">2</span></span>:(<span class="hljs-keyword"><span class="hljs-keyword">length</span></span>(tour))] dist.vect &lt;- diag( as.matrix( dist.matrix )[starts,stops] ) last.leg &lt;- as.matrix( dist.matrix )[tour[<span class="hljs-keyword"><span class="hljs-keyword">length</span></span>(tour)],tour[<span class="hljs-number"><span class="hljs-number">1</span></span>]] dist.vect &lt;- c(dist.vect, last.leg ) delta.x &lt;- diff( waypts[tour,]$x ) delta.y &lt;- diff( waypts[tour,]$y ) bearings &lt;- <span class="hljs-keyword"><span class="hljs-keyword">atan</span></span>( delta.x/delta.y ) * <span class="hljs-number"><span class="hljs-number">180</span></span> / <span class="hljs-keyword"><span class="hljs-keyword">pi</span></span> bearings &lt;- c(bearings,<span class="hljs-number"><span class="hljs-number">0</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">for</span></span>( i <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span>:(<span class="hljs-keyword"><span class="hljs-keyword">length</span></span>(tour)<span class="hljs-number"><span class="hljs-number">-1</span></span>) ) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>( delta.x[i] &gt; <span class="hljs-number"><span class="hljs-number">0.0</span></span> &amp;&amp; delta.y[i] &gt; <span class="hljs-number"><span class="hljs-number">0.0</span></span> ) bearings[i] &lt;- bearings[i] <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>( delta.x[i] &gt; <span class="hljs-number"><span class="hljs-number">0.0</span></span> &amp;&amp; delta.y[i] &lt; <span class="hljs-number"><span class="hljs-number">0.0</span></span> ) bearings[i] &lt;- <span class="hljs-number"><span class="hljs-number">180.0</span></span> + bearings[i] <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>( delta.x[i] &lt; <span class="hljs-number"><span class="hljs-number">0.0</span></span> &amp;&amp; delta.y[i] &gt; <span class="hljs-number"><span class="hljs-number">0.0</span></span> ) bearings[i] &lt;- <span class="hljs-number"><span class="hljs-number">360.0</span></span> + bearings[i] <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>( delta.x[i] &lt; <span class="hljs-number"><span class="hljs-number">0.0</span></span> &amp;&amp; delta.y[i] &lt; <span class="hljs-number"><span class="hljs-number">0.0</span></span> ) bearings[i] &lt;- <span class="hljs-number"><span class="hljs-number">180</span></span> + bearings[i] } route &lt;- data.frame(seq=<span class="hljs-number"><span class="hljs-number">1</span></span>:<span class="hljs-keyword"><span class="hljs-keyword">length</span></span>(tour), ptid=tour, bearing=bearings, dist.vect=dist.vect, velocity=velocity, travel.time=dist.vect/velocity, loiter.time=<span class="hljs-number"><span class="hljs-number">0.5</span></span>) route$total.travel.dist &lt;- cumsum(route$dist.vect) route$total.travel.time &lt;- cumsum(route$travel.time+route$loiter.time) route$location &lt;- waypts[tour,]$location <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>(route)}$$ );</code> </pre><br>  And the function make.map (): <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">INSERT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INTO</span></span> plr_modules <span class="hljs-keyword"><span class="hljs-keyword">VALUES</span></span> ( <span class="hljs-number"><span class="hljs-number">1</span></span>, $$make.map &lt;-<span class="hljs-keyword"><span class="hljs-keyword">function</span></span>(tour, waypts, mapname) { require(maps) jpeg(<span class="hljs-keyword"><span class="hljs-keyword">file</span></span>=mapname, width = <span class="hljs-number"><span class="hljs-number">480</span></span>, height = <span class="hljs-number"><span class="hljs-number">480</span></span>, pointsize = <span class="hljs-number"><span class="hljs-number">10</span></span>, quality = <span class="hljs-number"><span class="hljs-number">75</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">map</span></span>(<span class="hljs-string"><span class="hljs-string">'world2'</span></span>, xlim = c(<span class="hljs-number"><span class="hljs-number">20</span></span>, <span class="hljs-number"><span class="hljs-number">120</span></span>), ylim=c(<span class="hljs-number"><span class="hljs-number">20</span></span>,<span class="hljs-number"><span class="hljs-number">80</span></span>) ) map.axes() grid() arrows( waypts[tour[<span class="hljs-number"><span class="hljs-number">1</span></span>:(<span class="hljs-keyword"><span class="hljs-keyword">length</span></span>(tour)<span class="hljs-number"><span class="hljs-number">-1</span></span>)],]$x, waypts[tour[<span class="hljs-number"><span class="hljs-number">1</span></span>:(<span class="hljs-keyword"><span class="hljs-keyword">length</span></span>(tour)<span class="hljs-number"><span class="hljs-number">-1</span></span>)],]$y, waypts[tour[<span class="hljs-number"><span class="hljs-number">2</span></span>:(<span class="hljs-keyword"><span class="hljs-keyword">length</span></span>(tour))],]$x, waypts[tour[<span class="hljs-number"><span class="hljs-number">2</span></span>:(<span class="hljs-keyword"><span class="hljs-keyword">length</span></span>(tour))],]$y, angle=<span class="hljs-number"><span class="hljs-number">10</span></span>, lwd=<span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">length</span></span>=<span class="hljs-number"><span class="hljs-number">.15</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">col</span></span>=<span class="hljs-string"><span class="hljs-string">"red"</span></span> ) points( waypts$x, waypts$y, pch=<span class="hljs-number"><span class="hljs-number">3</span></span>, cex=<span class="hljs-number"><span class="hljs-number">2</span></span> ) points( waypts$x, waypts$y, pch=<span class="hljs-number"><span class="hljs-number">20</span></span>, cex=<span class="hljs-number"><span class="hljs-number">0.8</span></span> ) <span class="hljs-built_in"><span class="hljs-built_in">text</span></span>( waypts$x+<span class="hljs-number"><span class="hljs-number">2</span></span>, waypts$y+<span class="hljs-number"><span class="hljs-number">2</span></span>, as.character( waypts$<span class="hljs-keyword"><span class="hljs-keyword">id</span></span> ), cex=<span class="hljs-number"><span class="hljs-number">0.8</span></span> ) title( <span class="hljs-string"><span class="hljs-string">"TSP soln using PL/R"</span></span> ) dev.off() }$$ );</code> </pre><br>  We start the function of receiving TSP tags: <br><br><pre> <code class="sql hljs"><span class="hljs-comment"><span class="hljs-comment">-- only needed if INSERT INTO plr_modules was in same session SELECT reload_plr_modules(); SELECT seqid, plotid, bearing, distance, velocity, traveltime, loitertime, totaltraveldist FROM solve_tsp(true, 'tsp.jpg'); NOTICE: tour.dist= 2804.58129355858 seqid | plotid | bearing | distance | velocity | traveltime | loitertime | totaltraveldist -------+--------+---------+----------+----------+------------+------------+----------------- 1 | 8 | 131.987 | 747.219 | 500 | 1.49444 | 0.5 | 747.219 2 | 7 | -90 | 322.719 | 500 | 0.645437 | 0.5 | 1069.94 3 | 4 | 284.036 | 195.219 | 500 | 0.390438 | 0.5 | 1265.16 4 | 3 | 343.301 | 699.683 | 500 | 1.39937 | 0.5 | 1964.84 5 | 1 | 63.4349 | 98.2015 | 500 | 0.196403 | 0.5 | 2063.04 6 | 2 | 84.2894 | 345.957 | 500 | 0.691915 | 0.5 | 2409 7 | 6 | 243.435 | 96.7281 | 500 | 0.193456 | 0.5 | 2505.73 8 | 5 | 0 | 298.855 | 500 | 0.59771 | 0.5 | 2804.58 (8 rows)</span></span></code> </pre><br>  Advanced view: <br><br><pre> <code class="sql hljs">\x <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> solve_tsp(<span class="hljs-literal"><span class="hljs-literal">true</span></span>, <span class="hljs-string"><span class="hljs-string">'tsp.jpg'</span></span>); NOTICE: tour.dist= 2804.58129355858 -[ RECORD 1 ]<span class="hljs-comment"><span class="hljs-comment">---+--------------------------------------------------- seqid | 1 plotid | 3 bearing | 104.036 distance | 195.219 velocity | 500 traveltime | 0.390438 loitertime | 0.5 totaltraveldist | 195.219 totaltraveltime | 0.890438 location | 0101000020E610000000000000000050400000000000804840 -[ RECORD 2 ]---+--------------------------------------------------- [...]</span></span></code> </pre><br>  Thus, we have obtained the order in which these cities are worth visiting, the distance between them, etc.  In addition, we have a visual solution to the traveling salesman problem: <br><br><img src="https://habrastorage.org/files/148/056/434/148056434d144c3ca2d26155cfe8a2b7.png"><br>  Consider another example, this time with seismic data. <br><br>  When an earthquake occurs, it usually lasts 15-20 seconds, and seismologists collect data on the intensity of its vibrations.  That is, we have time series (timeseries) of data in a waveform data format.  Data is stored as an array of floating-point numbers (floats) recorded during a seismic event with a constant sampling rate.  They are available from online sources in separate files for each activity.  Each file contains about 16,000 items. <br><br>  Load 1000 seismic activities using PL / pgSQL: <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">DROP</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">IF</span></span> <span class="hljs-keyword"><span class="hljs-keyword">EXISTS</span></span> test_ts; <span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> test_ts ( dataid <span class="hljs-built_in"><span class="hljs-built_in">bigint</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> PRIMARY <span class="hljs-keyword"><span class="hljs-keyword">KEY</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">data</span></span> <span class="hljs-keyword"><span class="hljs-keyword">double</span></span> <span class="hljs-keyword"><span class="hljs-keyword">precision</span></span>[] ); <span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">OR</span></span> <span class="hljs-keyword"><span class="hljs-keyword">REPLACE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FUNCTION</span></span> load_test(<span class="hljs-built_in"><span class="hljs-built_in">int</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">RETURNS</span></span> <span class="hljs-built_in"><span class="hljs-built_in">text</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> $$ <span class="hljs-keyword"><span class="hljs-keyword">DECLARE</span></span> i <span class="hljs-built_in"><span class="hljs-built_in">int</span></span>; arr text; sql text; <span class="hljs-keyword"><span class="hljs-keyword">BEGIN</span></span> arr := pg_read_file(<span class="hljs-string"><span class="hljs-string">'array-data.csv'</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">500000</span></span>); FOR i IN 1..$1 LOOP sql := $i$<span class="hljs-keyword"><span class="hljs-keyword">INSERT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INTO</span></span> test_ts(dataid,<span class="hljs-keyword"><span class="hljs-keyword">data</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">VALUES</span></span> ($i$ || i || $i$,<span class="hljs-string"><span class="hljs-string">'{$i$ || arr || $i$}'</span></span>)$i$; <span class="hljs-keyword"><span class="hljs-keyword">EXECUTE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">sql</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">END</span></span> <span class="hljs-keyword"><span class="hljs-keyword">LOOP</span></span>; RETURN 'OK'; <span class="hljs-keyword"><span class="hljs-keyword">END</span></span>; $$ LANGUAGE plpgsql; <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> load_test(<span class="hljs-number"><span class="hljs-number">1000</span></span>); load_test <span class="hljs-comment"><span class="hljs-comment">----------- OK (1 row) Time: 37336.539 ms</span></span></code> </pre><br>  This can be done in a different way, with the help of R, and it will take two times less time - the rare case when using PL / R speeds up, rather than slows down the process: <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">DROP</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">IF</span></span> <span class="hljs-keyword"><span class="hljs-keyword">EXISTS</span></span> test_ts_obj; <span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> test_ts_obj ( dataid <span class="hljs-built_in"><span class="hljs-built_in">serial</span></span> PRIMARY <span class="hljs-keyword"><span class="hljs-keyword">KEY</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">data</span></span> bytea ); <span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">OR</span></span> <span class="hljs-keyword"><span class="hljs-keyword">REPLACE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FUNCTION</span></span> make_r_object(fname <span class="hljs-built_in"><span class="hljs-built_in">text</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">RETURNS</span></span> bytea <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> $$ myvar&lt;-<span class="hljs-keyword"><span class="hljs-keyword">scan</span></span>(fname,sep=<span class="hljs-string"><span class="hljs-string">","</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>(myvar); $$ LANGUAGE 'plr' IMMUTABLE; <span class="hljs-keyword"><span class="hljs-keyword">INSERT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INTO</span></span> test_ts_obj (<span class="hljs-keyword"><span class="hljs-keyword">data</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> make_r_object(<span class="hljs-string"><span class="hljs-string">'array-data.csv'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> generate_series(<span class="hljs-number"><span class="hljs-number">1</span></span>,<span class="hljs-number"><span class="hljs-number">1000</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">INSERT</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">1000</span></span> <span class="hljs-built_in"><span class="hljs-built_in">Time</span></span>: <span class="hljs-number"><span class="hljs-number">12166.137</span></span> ms</code> </pre><br>  Create an oscillogram: <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">OR</span></span> <span class="hljs-keyword"><span class="hljs-keyword">REPLACE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FUNCTION</span></span> plot_ts(ts <span class="hljs-keyword"><span class="hljs-keyword">double</span></span> <span class="hljs-keyword"><span class="hljs-keyword">precision</span></span>[]) <span class="hljs-keyword"><span class="hljs-keyword">RETURNS</span></span> bytea <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> $$ <span class="hljs-keyword"><span class="hljs-keyword">library</span></span>(quantmod) <span class="hljs-keyword"><span class="hljs-keyword">library</span></span>(cairoDevice) <span class="hljs-keyword"><span class="hljs-keyword">library</span></span>(RGtk2) pixmap &lt;- gdkPixmapNew(w=<span class="hljs-number"><span class="hljs-number">500</span></span>, h=<span class="hljs-number"><span class="hljs-number">500</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">depth</span></span>=<span class="hljs-number"><span class="hljs-number">24</span></span>) asCairoDevice(pixmap) plot(ts,<span class="hljs-keyword"><span class="hljs-keyword">type</span></span>=<span class="hljs-string"><span class="hljs-string">"l"</span></span>) plot_pixbuf &lt;- gdkPixbufGetFromDrawable( <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, pixmap, pixmap$getColormap(), <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">500</span></span>, <span class="hljs-number"><span class="hljs-number">500</span></span> ) buffer &lt;- gdkPixbufSaveToBufferv( plot_pixbuf, <span class="hljs-string"><span class="hljs-string">"jpeg"</span></span>, <span class="hljs-built_in"><span class="hljs-built_in">character</span></span>(<span class="hljs-number"><span class="hljs-number">0</span></span>), <span class="hljs-built_in"><span class="hljs-built_in">character</span></span>(<span class="hljs-number"><span class="hljs-number">0</span></span>) )$buffer <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>(buffer) $$ <span class="hljs-keyword"><span class="hljs-keyword">LANGUAGE</span></span> <span class="hljs-string"><span class="hljs-string">'plr'</span></span> IMMUTABLE; <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> plr_get_raw(plot_ts(<span class="hljs-keyword"><span class="hljs-keyword">data</span></span>)) <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> test_ts <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> dataid = <span class="hljs-number"><span class="hljs-number">42</span></span>;</code> </pre><br>  We get just such a picture for a specific earthquake: <br><br><img src="https://habrastorage.org/files/836/d3b/a76/836d3ba769cd44d0b3501405c3e2f640.png"><br>  Now it needs to be analyzed to, for example, find out how best to design buildings in an area with similar seismic activity.  You probably remember from school physics course such a thing as "resonant frequency".  Just in case, let me remind you that this is such an oscillation frequency at which the amplitude of oscillations increases sharply.  This frequency is determined by the properties of the system.  That is, in an area with seismic activity, you need to design buildings in such a way that their resonant frequency does not coincide with the frequency of earthquakes.  This can be done with R: <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">OR</span></span> <span class="hljs-keyword"><span class="hljs-keyword">REPLACE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FUNCTION</span></span> plot_fftps(ts bytea) <span class="hljs-keyword"><span class="hljs-keyword">RETURNS</span></span> bytea <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> $$ <span class="hljs-keyword"><span class="hljs-keyword">library</span></span>(quantmod) <span class="hljs-keyword"><span class="hljs-keyword">library</span></span>(cairoDevice) <span class="hljs-keyword"><span class="hljs-keyword">library</span></span>(RGtk2) fourier&lt;-fft(ts) magnitude&lt;-<span class="hljs-keyword"><span class="hljs-keyword">Mod</span></span>(fourier) y2 &lt;- magnitude[<span class="hljs-number"><span class="hljs-number">1</span></span>:(<span class="hljs-keyword"><span class="hljs-keyword">length</span></span>(magnitude)/<span class="hljs-number"><span class="hljs-number">10</span></span>)] x2 &lt;- <span class="hljs-number"><span class="hljs-number">1</span></span>:<span class="hljs-keyword"><span class="hljs-keyword">length</span></span>(y2)/<span class="hljs-keyword"><span class="hljs-keyword">length</span></span>(magnitude) mydf &lt;- data.frame(x2,y2) pixmap &lt;- gdkPixmapNew(w=<span class="hljs-number"><span class="hljs-number">500</span></span>, h=<span class="hljs-number"><span class="hljs-number">500</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">depth</span></span>=<span class="hljs-number"><span class="hljs-number">24</span></span>) asCairoDevice(pixmap) plot(mydf,<span class="hljs-keyword"><span class="hljs-keyword">type</span></span>=<span class="hljs-string"><span class="hljs-string">"l"</span></span>) plot_pixbuf &lt;- gdkPixbufGetFromDrawable( <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, pixmap, pixmap$getColormap(), <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">500</span></span>, <span class="hljs-number"><span class="hljs-number">500</span></span> ) buffer &lt;- gdkPixbufSaveToBufferv( plot_pixbuf, <span class="hljs-string"><span class="hljs-string">"jpeg"</span></span>, <span class="hljs-built_in"><span class="hljs-built_in">character</span></span>(<span class="hljs-number"><span class="hljs-number">0</span></span>), <span class="hljs-built_in"><span class="hljs-built_in">character</span></span>(<span class="hljs-number"><span class="hljs-number">0</span></span>) )$buffer <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>(buffer) $$ <span class="hljs-keyword"><span class="hljs-keyword">LANGUAGE</span></span> <span class="hljs-string"><span class="hljs-string">'plr'</span></span> IMMUTABLE; <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> plr_get_raw(plot_fftps(<span class="hljs-keyword"><span class="hljs-keyword">data</span></span>)) <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> test_ts_obj <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> dataid = <span class="hljs-number"><span class="hljs-number">42</span></span>;</code> </pre><br>  And this is how the final result looks like, showing the frequency of vibrations and their amplitude: <br><br><img src="https://habrastorage.org/files/690/c50/fcf/690c50fcf3dc42598d3ca0efbc0b643d.png"><br>  Having such a schedule before his eyes, an architect can make calculations and design a structure that does not collapse at the very first impetus. <br><br>  As you can see, PL / R has many uses, as it allows you to link advanced analytics to databases and at the same time use the functionality of R and PostgreSQL with all their advantages.  I hope this article will be useful to you, and you will find the use of such an effective and multifunctional tool. <br><br>  <i>We also invite you to familiarize yourself with the source materials on the basis of which this article was prepared: a <a href="http://pgday.ru/files/papers/25/pgday2015.joe.conway.plr.pdf">presentation</a> and a <a href="https://youtu.be/83MC6dBDpkM%3Flist%3DPL83V-7VhzqkpQbw7hn6b32OmxK8SRKoHU">video</a> from the performance of Joe Conway at PG Day'15 Russia.</i>  <i>If the topic of PL / R seems interesting to you, be sure to share your thoughts and ideas.</i>  <i>Who knows, maybe we will organize a report on this topic at the upcoming PG Day'16 in July.</i>  <i>As usual, we are waiting for your comments.</i> </div><p>Source: <a href="https://habr.com/ru/post/275487/">https://habr.com/ru/post/275487/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../275477/index.html">Javapocalypse in a single system</a></li>
<li><a href="../275479/index.html">Advanced Yandex (and Google) search using the installed script or in the interface</a></li>
<li><a href="../275481/index.html">Cloud Experience: How We Translated the KPI Suite to the Azure Platform</a></li>
<li><a href="../275483/index.html">The first game for iOS and the first difficulties. How not to give up and bring it to release</a></li>
<li><a href="../275485/index.html">How to add a library to the project?</a></li>
<li><a href="../275489/index.html">The story of one progress bar</a></li>
<li><a href="../275491/index.html">VIPER or what everyone is talking about, but no one talks</a></li>
<li><a href="../275493/index.html">Interface design under Microsoft Lync or system visualization from scratch</a></li>
<li><a href="../275495/index.html">3D at school: who, what and how should be taught?</a></li>
<li><a href="../275497/index.html">Objects in PHP 7</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>