<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Our experience with Kubernetes in small projects (review and video report)</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="On June 6, at the RootConf 2017 conference, which was held as part of the Russian Internet Technologies Festival (RIT ++ 2017), a report titled ‚ÄúOur E...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Our experience with Kubernetes in small projects (review and video report)</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/web/9b5/68b/09a/9b568b09a4644feca3d6906eaf61ae51.jpg" alt="Dmitry Stolyarov (Fant) with a report on Kubernetes at RootConf, RIT ++ 2017"><br><br>  On June 6, at the <a href="http://rootconf.ru/2017/">RootConf 2017</a> conference, which was held as part of the Russian Internet Technologies Festival (RIT ++ 2017), a report titled ‚ÄúOur Experience with Kubernetes in Small Projects‚Äù was presented in the section ‚ÄúContinuous Deployment and Deploy‚Äù.  It described the device, the principles of operation and the main features of Kubernetes, as well as our practice of using this system in small projects. <br><br>  By tradition, we are pleased to present a <a href="https://www.youtube.com/watch%3Fv%3DCgCLPYJRxbU%26t%3D8s%26list%3DPL1mJ-PkCYnmB9vljnjxCMP3dlxQY3Dfcq%26index%3D3"><b>video with the report</b></a> (about an hour, <b>much more</b> informative <b>than the</b> article) and the main squeeze in text form. <a name="habracut"></a>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h2>  Prehistory </h2><br>  Modern infrastructure (for web applications) has come a long way of evolving from a backend from a DBMS on one server to a significant increase in services used, their separation across virtual machines / servers, switching to cloud solutions with load balancing and horizontal scalability ... and to microservices. <br><br>  With the operation of modern, <b>microservice</b> , infrastructure, there are a <b>number of difficulties</b> caused by the architecture itself and the number of its components.  We distinguish the following from them: <br><br><ol><li>  collecting logs; </li><li>  metrics collection; </li><li>  supervision (check the status of services and restart them in case of problems); </li><li>  service discovery (automatic discovery of services); </li><li>  Automation of updating configurations of infrastructure components (when adding / deleting new service entities); </li><li>  scaling; </li><li>  CI / CD (Continuous Integration and Continuous Delivery); </li><li>  vendor lock-in (this is about dependence on the chosen ‚Äúsolution provider‚Äù: the cloud provider, bare metal ...). </li></ol><br>  As it is easy to guess from the title of the report, the Kubernetes system appeared as an answer to these needs. <br><br><h2>  Kubernetes Basics </h2><br>  <b>The Kubernetes architecture</b> as a whole looks like a master (maybe not one) and many nodes (up to 5000), each of which has: <br><br><ul><li>  Docker, </li><li>  kubelet (run by docker), </li><li>  kube-proxy (manages iptables). </li></ul><br>  On master are: <br><br><ul><li>  API server </li><li>  <a href="https://habrahabr.ru/company/flant/blog/329224/">etcd</a> database </li><li>  scheduler (decides on which node to run the container on) </li><li>  controller-manager (responsible for fault tolerance). </li></ul><br>  In addition to all this, there is a kubectl management utility and configurations described in YAML (declarative DSL) format. <br><br><img src="https://habrastorage.org/web/1f1/33f/e99/1f133fe997b34487927b9a5d38e19287.gif"><br><br>  In terms of use, Kubernetes offers a cloud that combines all these master and nodes and allows you to run the "building blocks" of the infrastructure.  These primitives, including, include: <br><br><ul><li>  <b>container</b> - image + command launched in it; </li><li>  <b>under</b> <i>(Pod; literally translated as ‚Äúpod‚Äù)</i> - a set of containers (maybe one) with a common network, one IP-address and other common characteristics (common data stores, labels);  <b>note:</b> it is the platforms (rather than individual containers) that allow you to run Kubernetes; </li><li>  <b>Label and selector</b> <i>(Label, Selector)</i> - a set of arbitrary key-values ‚Äã‚Äãassigned to the subs and other Kubernetes primitives; </li><li>  <b>ReplicaSet</b> - a set of pods, the number of which is automatically maintained (when the number of pods in the configuration changes, when any pods / nodes fall), which makes scaling very simple; </li><li>  <b>Deploy</b> - ReplicaSet + history of old versions ReplicaSet + update process between versions (used to solve problems of continuous integration - deployment); </li><li>  <b>Service</b> <i>(</i> DNS) name + virtual IP + selector + load balancer (for scattering requests by subkey matching the selector); </li><li>  <b>task</b> <i>(Job)</i> - under and the logic of the success of performing the flow (used for migrations); </li><li>  <b>cron-task</b> <i>(CronJob)</i> - Job and schedule in crontab format; </li><li>  <b>volume</b> <i>(Volume)</i> - connection of data storage (to store, ReplicaSet or Deployment) with indication of size, access type (ReadWrite Once, ReadOnly Many, ReadWrite Many), storage type (19 methods of implementation are supported: iron, software, cloud); </li><li>  <b>StatefulSet</b> - a lot of pods like ReplicaSet, but with tightly defined names / hosts, so that these pods can always communicate with each other over them (for ReplicaSet, names are randomly generated each time) and have separate volumes (not one at all, as in the case of ReplicaSet) ; </li><li>  <b>Ingress</b> is a service that is accessible to users from outside and scatters all requests for services according to the rules (depending on the host name and / or URLs). </li></ul><br>  Examples of the description of the presentation and ReplicaSet in YAML format: <br><br><pre><code class="plaintext hljs">apiVersion: v1 kind: Pod metadata: name: manual-bash spec: containers: - name: bash image: ubuntu:16.04 command: bash args: [-c, "while true; do sleep 1; date; done"]</code> </pre> <br><pre> <code class="plaintext hljs">apiVersion: extensions/v1beta1 kind: ReplicaSet metadata: name: backend spec: replicas: 3 selector: matchLabels: tier: backend template: metadata: labels: tier: backend spec: containers: - name: fpm image: myregistry.local/backend:0.15.7 command: php-fpm</code> </pre> <br>  These primitives respond to all of the above calls with a few exceptions: automating configuration updates does not solve the problem of building Docker images, ordering new servers and installing nodes on them, while in CI / CD there is still a need for preparatory work (installing CI, describing assembly rules Docker images, rolling out YAML configurations in Kubernetes). <br><br><h2>  Our experience: architecture and CI / CD </h2><br>  By small projects we mean small (up to 50 knots, up to 1500 pods) and medium ones (up to 500 knots, up to 15000 pods).  We make the <b>smallest projects</b> on bare metal with three hypervisors, which look like this: <br><br><img src="https://habrastorage.org/web/2db/84e/85f/2db84e85f77a499382bf8702ba5d1fef.png"><br><br>  The Ingress controller is <code>kube-front-X</code> on three virtual machines ( <code>kube-front-X</code> ): <br><br><img src="https://habrastorage.org/web/bd5/4fd/00b/bd54fd00b3e346b6bf77bfe108bf6fa8.png"><br>  <i>(Instead of the Pacemaker specified in the diagram, there may be VRRP, ucarp or another technology - it depends on the specific data center.)</i> <br><br>  How the <b>Continuous Delivery Chain</b> Looks: <br><br><img src="https://habrastorage.org/web/468/037/f17/468037f1707d47f2a4c57a4e635f5a3c.png"><br><br>  Explanations: <br><br><ul><li>  For continuous integration we use GitLab (in the coming weeks we will publish an article with details on the practice of its use).  <b>Updated (July 11, 2017)</b> : its first part is published as ‚Äú <a href="https://habrahabr.ru/company/flant/blog/332712/">GitLab CI for continuous integration and delivery in production.</a>  <a href="https://habrahabr.ru/company/flant/blog/332712/">Part 1: our pipeline</a> . </li><li>  In Kubernetes we set up environments for each circuit (production, staging, testing, etc. - their number depends on the specific project).  In this case, different contours can be serviced by different clusters of Kubernetes (on different hardware and in different clouds), and in GitLab it is configured to be deployed to them. </li><li>  In Git we put the Dockerfile (or rather, we use <a href="https://habrahabr.ru/company/flant/blog/324274/">dapp</a> for this) and the .kube directory with the YAML configurations. </li><li>  With a commit ( <b>build</b> stage), we create an image of the Docker, which is sent to the Docker Registry. </li><li>  Next ( <b>test</b> stage) we take this Docker image and run tests on it. </li><li>  With the release (release stage) of the YAML configuration from the .kube directory, we give it to the kubectl utility, which sends them to Kubernetes, after which the Docker images are downloaded and run in the infrastructure deployed in the configuration from YAML.  (We used to use <a href="https://github.com/kubernetes/helm">Helm</a> for this, but now we finish our <a href="https://github.com/flant/dapp">dapp</a> tool.) </li><li>  Thus, Kubernetes is fully responsible for the last stage ( <b>operate</b> ). </li></ul><br><img src="https://habrastorage.org/web/010/a84/79b/010a8479b0e443dc9d89c721480b3781.gif"><br><br>  In the case of <b>small projects, the</b> infrastructure looks like a container cloud (its implementation is secondary ‚Äî it depends on hardware and needs) with configured storage (Ceph, AWS, GCE ...) and the Ingress controller, and (in addition to this cloud) additional virtual machines may be available to start services that we do not put inside Kubernetes: <br><br><img src="https://habrastorage.org/web/dc1/632/9bf/dc16329bfb7248e5abb63600f94418b5.png"><br><br><h2>  Conclusion </h2><br>  From our point of view, Kubernetes has matured in order to use it in projects of any size.  Moreover, this system provides an excellent opportunity from the very beginning to make a project very simple, reliable, with fault tolerance and horizontal scaling.  The main underwater stone is the human factor: for a small team it is difficult to find a specialist who will solve all the necessary tasks (requires extensive technological knowledge), or he will be too expensive (and soon he will become bored). <br><br><h2>  Video and slides </h2><br>  <b>Video from the performance (about an hour) <a href="https://www.youtube.com/watch%3Fv%3DCgCLPYJRxbU%26t%3D8s%26list%3DPL1mJ-PkCYnmB9vljnjxCMP3dlxQY3Dfcq%26index%3D3">published on YouTube</a></b> . <br><br>  Presentation of the report: <br><br><iframe width="560" height="315" src="https://www.youtube.com/embed/https://translate" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br><br><h2>  Continuation </h2><br>  Having received the first feedback on this report, we decided to prepare a special <b>cycle of introductory articles on Kubernetes</b> , focused on developers and telling in more detail about the structure of this system.  Let's start in the coming weeks - stay tuned to our blog! <br><br><h2>  PS </h2><br>  Read also in our blog about CI / CD and not only: <br><br><ul><li>  " <a href="https://habrahabr.ru/company/flant/blog/341760/">Infrastructure with Kubernetes as an affordable service</a> "; </li><li>  ‚Äú <a href="https://habrahabr.ru/company/flant/blog/324274/">We assemble Docker images for CI / CD quickly and conveniently along with dapp</a> ‚Äù <i>(Dmitry Stolyarov; November 8, 2016 on HighLoad ++)</i> ; </li><li>  ‚Äú <a href="https://habrahabr.ru/company/flant/blog/322686/">Practices of Continuous Delivery with Docker</a> ‚Äù <i>(Dmitry Stolyarov; May 31, 2016 at RootConf)</i> . </li></ul></div><p>Source: <a href="https://habr.com/ru/post/331188/">https://habr.com/ru/post/331188/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../331178/index.html">How to keep 20 thousand VPN clients on servers for $ 5</a></li>
<li><a href="../331180/index.html">Cloud security: reality or myth?</a></li>
<li><a href="../331182/index.html">The first selection of materials on the digitalization of insurance</a></li>
<li><a href="../331184/index.html">Entertaining layout with viewing area units</a></li>
<li><a href="../331186/index.html">Artem Gavrichenkov's report on TLS scaling</a></li>
<li><a href="../331192/index.html">Introduction to the A * algorithm</a></li>
<li><a href="../331194/index.html">Competence does not have gender: on gender balance and the trend of development of female coding</a></li>
<li><a href="../331196/index.html">Self-sufficient controllers on Xamarin.Forms: "Re-use the code to the maximum!". Part 2</a></li>
<li><a href="../331200/index.html">Augmented Reality for state leaders</a></li>
<li><a href="../331202/index.html">Build a Linux kernel module without accurate header files</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>