<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Writing a system of invitations (invitations) for your Meteor application</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hey. 

 Today I will try to tell you how to write a simple, but quite working email invitation system for your Meteor application. 

 Why this may be ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Writing a system of invitations (invitations) for your Meteor application</h1><div class="post__text post__text-html js-mediator-article">  Hey. <br><br>  Today I will try to tell you how to write a simple, but quite working email invitation system for your Meteor application. <br><br>  Why this may be needed?  For example, if you are developing an application in which several people have to work in the same group on a project.  This could be, for example, a training schedule that can edit several people or a product catalog of the company's online store. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      The network already has one manual in English and CoffeScript, but the approach described there seemed inconvenient to me and I decided to implement my own system of invites for my project, and then share it with habrazhiteli. <br><br>  So, our example will be able to: <br>  1) Display the invitations interface including the list of existing invitations and the form for sending a new one; <br>  2) Save all invitations to the database; <br>  3) Follow the status of invitations; <br>  4) Send invitations to email; <br>  5) Follow user roles; <br>  6) Activate the invitation of new users; <br>  7) Use a bunch of third-party modules. <br><br>  <b>Attention: The</b> example will be considered on the basis of a live project, so just copying and pasting it to yourself will probably not work ... <br><a name="habracut"></a><br>  What do we need?  First, you will need to install the following packages: <br><pre><code class="javascript hljs">accounts-base -     accounts-google -      accounts-password -    / accounts-ui -   alanning:roles -    aldeed:autoform -   aldeed:collection2 -       email -    iron:router -    mizzao:bootboxjs -     random -      </code> </pre> <br>  In addition, the example interface is written using <a href="http://fezvrasta.github.io/bootstrap-material-design/">Material Design for Bootstrap</a> , which will also need to be integrated into your project.  Let's get started <br><br><h4>  First approach </h4><br>  First of all, we will describe a few simple constants that will be responsible for the status of invitations and will be needed in the future. <br><br>  <b>Lib / constants.js file</b> <br><pre> <code class="javascript hljs"><span class="hljs-comment"><span class="hljs-comment">//       INVITE_CREATED = 0; //   Email       -    INVITE_EMAILED = 1; //      INVITE_COMPLETED = 2;</span></span></code> </pre><br>  Also, we will need to create a couple of helper functions. <br><br>  <b>Lib / helpers.js file</b> <br><pre> <code class="javascript hljs"><span class="hljs-comment"><span class="hljs-comment">//    ,       if (Meteor.isClient) { //   .      ,      Template.registerHelper('userCompany', function () { var company = Company.findOne({userId: Meteor.userId()}); if (company == undefined) { if (Meteor.userId() != null) { var user = Meteor.users.findOne({_id: Meteor.userId()}, {fields: {'companyId': 1}}); company = Company.findOne({_id: user.companyId}); } } return company; }); //     Email        Template.registerHelper('validateEmail', function (email) { var re = /\S+@\S+\.\S+/; return re.test(email); }); }</span></span></code> </pre><br>  Suppose we have applications in which we need to jointly edit data (what kind of).  To do this, when creating the first user, we create a certain company card (or groups, to whom it is convenient) and provide him with an interface at the invitation of other users. <br><br><h4>  Data structure and server logic </h4><br>  We describe the data schema for our entities.  For this we will use the features of Simple Schema and the aldeed: collection2 package. <br><br>  First we describe the data scheme of the company.  For example, it will include the name of the company, a brief description, the id of the user who created the company, the date the record was created and the date it was last updated. <br><br>  Please note that in the description of the scheme we can specify such values ‚Äã‚Äãas: <br><ul><li>  type - conditional field type used in the future when generating a form </li><li>  min, max - the minimum and maximum number of characters </li><li>  autoValue - automatic values ‚Äã‚Äãfor the field </li><li>  denyInsert, denyUpdate - a ban on writing to the field when inserting / updating a record </li><li>  optional - the default field is required, but we can fix it </li></ul><br>  <b>Lib / collections / company.js file</b> <br><pre> <code class="php hljs">Company = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Mongo.Collection(<span class="hljs-string"><span class="hljs-string">'company'</span></span>); <span class="hljs-comment"><span class="hljs-comment">//  if (Meteor.isServer) { Meteor.methods({ //  .        registerAdminUser: function(companyId, userId) { check(companyId, String); check(userId, String); Roles.addUsersToRoles(Meteor.userId(), ["CompanyAdmin"]); } }); } //SimpleSchema.debug = true; // Company.attachSchema(new SimpleSchema({ //  title: { type: String, label: "", min: 3, max: 200 }, //  description: { type: String, label: " ", min: 20, max: 1000, autoform: { rows: 5 } }, //id   .         . userId: { type: String, autoValue: function() { if (this.isInsert) { return Meteor.userId(); } else { this.unset(); } }, label: "", //denyInsert: true, denyUpdate: true, optional: true }, // .   createdAt: { type: Date, autoValue: function() { if (this.isInsert) { return new Date; } else if (this.isUpsert) { return {$setOnInsert: new Date}; } else { this.unset(); } }, denyUpdate: true, optional: true }, //  .   updatedAt: { type: Date, autoValue: function() { if (this.isUpdate) { return new Date(); } }, denyInsert: true, optional: true }, }));</span></span></code> </pre><br>  In the same way we will describe the scheme for our invites.  Our collection file will contain three server methods - for sending a new invitation, deleting an existing one and activating the invitation by the user.  The collection will contain the email of the invitee, the activation code, the status of the invitation, the field of communication with the user who activated the invitation, the connection with the sending user, and the date of creation / update of the invitation.  Moreover, the last value in the field ‚ÄúDate of update‚Äù will be equal to the date and time of activation of the invitation, and the field ‚ÄúDate of creation‚Äù - the date and time of its sending. <br><br>  <b>Lib / collections / invite.js file</b> <br><pre> <code class="javascript hljs">Invite = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Mongo.Collection(<span class="hljs-string"><span class="hljs-string">'invite'</span></span>); <span class="hljs-comment"><span class="hljs-comment">//SimpleSchema.debug = true; //  if (Meteor.isServer) { Meteor.methods({ //    email invationSender: function (email) { check(this.userId, String); check(email, String); // .       Email var token = Random.hexString(10); //        . var company = Company.findOne({userId: this.userId}); var companyName = company.title; //        //   -  ,     var inviteId = Invite.insert({email:email,token:token,status:INVITE_CREATED}); //     ,       this.unblock(); //       //    ,       Email.send({ to: email, from: 'info@forsk.ru', subject: '   '+companyName+'       Kellot.ru', html: '!   Kellot.Ru   '+Meteor.user().profile.name+'   ' + '        "'+companyName+'". ' + '&lt;br/&gt;&lt;br/&gt;   : '+token+ '&lt;br/&gt;&lt;br/&gt;   ,     ' + '&lt;a href="http://p.kellot.ru/company/invite/'+token+'"&gt;http://p.kellot.ru/company/invite/'+token+'&lt;/a&gt; ' + '    .     .'+ '&lt;br/&gt;&lt;br/&gt; ,        Kellot.Ru' }); //    ""  "" Invite.update({_id:inviteId}, {$set: {status: INVITE_EMAILED}}, {}, function(error, count) { console.log('update error', error, count); }); return true; }, //       deleteInvite: function(inviteId) { check(inviteId, String); var invite = Invite.findOne({_id: inviteId}); //     ""    . //   ,         if (invite.status != INVITE_COMPLETED) { Invite.remove({_id: inviteId}); return true; } else { return false; } }, //    activateInviteToken: function (activationToken, userId) { check(this.userId, String); check(activationToken, String); check(userId, String); //   -  ,    var user = Meteor.users.findOne({_id:userId}); var invite = Invite.findOne({token:activationToken}); var company = Company.findOne({_id:invite.companyId}); //    -    if (invite.status == INVITE_COMPLETED) { return false; } //         Meteor.users.update({_id:userId}, { $set: {companyId: company._id } }); //         Invite.update({_id:invite._id}, { $set: {invitedUserId: userId, status: 2 } }); //     Roles.addUsersToRoles(Meteor.userId(), ["CompanyMember"]); return true; } }); } // Invite.attachSchema(new SimpleSchema({ //Email   ,      email: { type: String, label: "  / Email", min: 3, max: 30 }, //    .   token: { type: String, label: " ", min: 10, max: 10 }, //  status: { type: Number, label: " " }, //    invitedUserId: { type: String, label: "  ", optional: true }, //   ? creator: { type: String, label: "", autoValue: function() { if (this.isInsert) { return Meteor.userId(); } else { this.unset(); } }, denyUpdate: true, optional: true }, //    companyId: { type: String, autoValue: function() { if (this.isInsert) { return Company.findOne({userId:Meteor.userId()})._id; } else { this.unset(); } }, label: "", denyUpdate: true, optional: true }, //  createdAt: { type: Date, autoValue: function() { if (this.isInsert) { return new Date; } else if (this.isUpsert) { return {$setOnInsert: new Date}; } else { this.unset(); } }, denyUpdate: true, optional: true }, // . //      updatedAt: { type: Date, autoValue: function() { if (this.isUpdate) { return new Date(); } }, denyInsert: true, optional: true } }));</span></span></code> </pre><br>  That's basically all we need on the server.  As you can see, the logic is simple as twice two: the user creates a company (group).  automatically becomes its owner and sends invitations to other users.  If he changed his mind to send the invitation, while the recipient did not apply it - the admin has the right to delete it and then the recipient will fail.  If the invitation is active and the recipient follows the link in the letter, then he can immediately activate the invitation by simply clicking on the ‚ÄúRegister‚Äù button.  But for this to work, we need to teach the router something ... <br><br>  Immediately it is worth noting that you don‚Äôt need to bother to set up sending emails correctly.  Meteor out of the box is configured to use <a href="http://www.mailgun.com/">Mailgun</a> , which allows you to send up to 200 emails per day or up to 10,000 emails per month.  But nothing prevents you from setting it up to work with your own or third-party mail server.  To do this, when you start the application, you just need to define the environment variable MAIL_URL. <br><br>  Something like this: ‚ÄúMAIL_URL‚Äù: ‚Äúsmtp: // user: password@domain.ru: 587 /‚Äù.  After that, the sending of letters will occur through authorization on the server you specified. <br><br>  <b>Important!</b>  Be vigilant if you use meteor-up to deploy your application and store mup.json file in your project, which describes environment variables, then do not put your code in open repositories on github or anywhere else.  Otherwise, your mail can be read by all and sundry. <br><br><h4>  Router and publications </h4><br>  Iron Router will perform the task of processing the link for which the newcomer is transferred from the letter, and will also invoke the server method of inviting activation based on two conditions: <br><ol><li>  Is the current user tied to one of the companies; </li><li>  Is there an activation code in the current session? </li></ol><br>  <b>Lib / router.js file</b> <br><pre> <code class="javascript hljs">Router.map(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ ... <span class="hljs-comment"><span class="hljs-comment">//          this.route('activateInviteToCompany', { trackPageView: true, path: '/company/invite/:activationToken', waitOn: function () { //   ,    ,    Meteor.subscribe("inviteToken", Router.current().params.activationToken); Meteor.subscribe('companyToken', Router.current().params.activationToken); return Meteor.subscribe('userToken', Router.current().params.activationToken); } }); ... Router.onBeforeAction(function (pause) { Alerts.removeSeen(); //          if (Meteor.userId() == null) { if (pause.url != '/index' &amp;&amp; pause.url != '/' &amp;&amp; pause.url != '/reviews' &amp;&amp; pause.url != '/company/invite/'+Router.current().params.activationToken) { Router.go('index'); } } //   ,        , //          //          , //           if (Meteor.isClient &amp;&amp; Meteor.userId() != null) { //        ... if (UI._globalHelpers.userCompany() == undefined &amp;&amp; (pause.url != '/firstLogin' &amp;&amp; pause.url != '/company/register' )) { //...      , ... if (Session.get('activationToken') != undefined) { //       var activationToken = Session.get('activationToken'); Session.set('activationToken', undefined); //     var invite = Invite.findOne({ token: activationToken }); //     Meteor.call('activateInviteToken', activationToken, Meteor.userId(), function (error, result) { //  if (error) { //    ... console.log(error); bootbox.alert("   . ,    ! : " + error.reason); } else { //          ! Meteor.subscribe('company'); Meteor.subscribe('invite'); bootbox.alert("  !"); } }); } else { //        -    // (   ) Router.go('firstLoginForm'); } } } this.next(); }); });</span></span></code> </pre><br>  As can be seen from the code, if the user follows the link '/ company / invite / &lt;activation code&gt;', then the activateInviteToCompany template will be automatically presented to him, and the client will receive information about the invitation itself, the company and the user who invited the new participant.  We will need this data later. <br><br>  In the onBeforeAction function, we perform several actions. <br><br>  Firstly, for non-authorized users, we only allow to go to the main page to read about the functions of the application, view the feedback page and go to the invite activation page.  In other cases, we always send him to the main page, wherever he tries to go. <br><br>  Secondly, if the user is still authorized, then we check its assignment to one of the existing companies - as an administrator or member.  If this check is successful, let the user go on. <br><br>  Thirdly, if the user is still not assigned to any company, we are looking for the invitation activation code in the session.  If there is one, we activate the user.  If not, send it to a special page and suggest creating a new company. <br><br>  It's pretty simple.  But nowhere is visible saving invitation code in the session.  How so?  We will talk about this a little later. <br><br>  Remaining publications.  Judging by the code in the router on the client, we will need information about the invitation, the company and the user who sent the invitation.  In the next section it becomes clear why. <br><br>  To do this, add the following code in the publication file: <br>  <b>File server / publications.js</b> <br><pre> <code class="javascript hljs"><span class="hljs-comment"><span class="hljs-comment">//      function getCompanyByInviteToken(tokenId) { var invite = Invite.findOne({ token: tokenId }); var company = Company.findOne({ _id: invite.companyId }); //console.log('getCompanyByInviteToken', tokenId, invite.companyId, company._id); return company; } ... Meteor.publish('inviteToken', function (tokenId) { check(tokenId, Match.Any); return Invite.find({ token: tokenId }); }); Meteor.publish('companyToken', function (tokenId) { check(tokenId, Match.Any); var company = getCompanyByInviteToken(tokenId); return Company.find({_id:company._id}); }); Meteor.publish('userToken', function (tokenId) { check(tokenId, Match.Any); var company = getCompanyByInviteToken(tokenId); return Meteor.users.find({ _id: company.userId }, {fields: {'services':0, 'roles':0, createdAt:0}}); });</span></span></code> </pre><br>  So, as shown above, we can not transfer the minimum necessary information to the client.  It would not even have been possible to transfer all the fields to the client, but only selected ones, but I also think that this is unnecessary. <br><br><h4>  Interface </h4><br>  All our logic is nothing without an interface.  The whole interface will consist of several templates: <br><ul><li>  inviteList - a panel with a list of invitations and a form for sending a new invitation; </li><li>  inviteSend and inviteSend - an invitation form with an automatically generated set of fields (we have only one); </li><li>  activateInviteToCompany - several options for displaying information to the invited user about the invitation activated by this user. </li></ul><br>  <b>File client / views / invite / invite.html</b> <br><pre> <code class="javascript hljs">&lt;template name=<span class="hljs-string"><span class="hljs-string">"inviteList"</span></span>&gt; <span class="xml"><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">div</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span></span><span class="xml"><span class="hljs-tag">=</span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">"panel panel-success"</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">style</span></span></span></span><span class="xml"><span class="hljs-tag">=</span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">"float: left; margin-right: 20px;"</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml"> </span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">div</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span></span><span class="xml"><span class="hljs-tag">=</span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">"panel-heading"</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml"> </span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">h3</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span></span><span class="xml"><span class="hljs-tag">=</span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">"panel-title"</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml">  !</span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;/</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">h3</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml"> </span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;/</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">div</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml"> </span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">div</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span></span><span class="xml"><span class="hljs-tag">=</span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">"panel-body"</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml"> {{#if invitedUsers.count}} </span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">div</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span></span><span class="xml"><span class="hljs-tag">=</span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">"list-group"</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml"> {{#each invitedUsers}} </span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">div</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span></span><span class="xml"><span class="hljs-tag">=</span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">"list-group-item"</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml"> </span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">div</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span></span><span class="xml"><span class="hljs-tag">=</span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">"row-content"</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml"> </span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">div</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span></span><span class="xml"><span class="hljs-tag">=</span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">"least-content"</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml">{{inviteTextStatus}} {{#if isInRole 'CompanyAdmin'}} {{#if inviteIsComplete}} {{else}} </span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">a</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span></span><span class="xml"><span class="hljs-tag">=</span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">"deleteInviteBtn"</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">data-id</span></span></span></span><span class="xml"><span class="hljs-tag">=</span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">"{{_id}}"</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">href</span></span></span></span><span class="xml"><span class="hljs-tag">=</span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">"#"</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml">x</span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;/</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">a</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml"> {{/if}} {{/if}} </span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;/</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">div</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml"> </span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">p</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span></span><span class="xml"><span class="hljs-tag">=</span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">"list-group-item-text"</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml">{{email}}</span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;/</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">p</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml"> </span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;/</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">div</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml"> </span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;/</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">div</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml"> </span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">div</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span></span><span class="xml"><span class="hljs-tag">=</span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">"list-group-separator"</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;/</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">div</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml"> {{/each}} </span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;/</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">div</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml"> {{else}}      ! {{/if}} </span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;/</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">div</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml"> {{#if isInRole 'CompanyAdmin'}} </span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">div</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span></span><span class="xml"><span class="hljs-tag">=</span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">"panel-footer"</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml"> {{&gt; inviteSend}} </span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;/</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">div</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml"> {{/if}} </span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;/</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">div</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span></span> &lt;<span class="hljs-regexp"><span class="hljs-regexp">/template&gt; &lt;template name="inviteSend"&gt; {{#autoForm collection="Invite" id="inviteSend" type="insert"}} {{&gt; inviteFieldset}} &lt;button id="sendInviteBtn" class="btn btn-primary" style="width:100%"&gt;&lt;/</span></span>button&gt; {{/autoForm}} &lt;<span class="hljs-regexp"><span class="hljs-regexp">/template&gt; &lt;template name="inviteFieldset"&gt; &lt;fieldset&gt; {{&gt; afQuickField name='email'}} &lt;/</span></span>fieldset&gt; <span class="xml"><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;/</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">template</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span></span> &lt;template name=<span class="hljs-string"><span class="hljs-string">"activateInviteToCompany"</span></span>&gt; {{#<span class="hljs-keyword"><span class="hljs-keyword">if</span></span> currentUser}} .            . {{ <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> }} {{#<span class="hljs-keyword"><span class="hljs-keyword">if</span></span> inviteIsActivated}} ,  &lt;b&gt;{{userActivationCode}}&lt;<span class="hljs-regexp"><span class="hljs-regexp">/b&gt;  .      . {{ else }} ! &lt;br/</span></span>&gt;<span class="xml"><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">br</span></span></span></span><span class="xml"><span class="hljs-tag">/&gt;</span></span></span></span>   ,        -    &lt;b&gt;{{companyNameByInviteCode}}&lt;<span class="hljs-regexp"><span class="hljs-regexp">/b&gt;   &lt;b&gt;{{companyUserNameByInviteCode}}&lt;/</span></span>b&gt;. &lt;br/&gt;<span class="xml"><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">br</span></span></span></span><span class="xml"><span class="hljs-tag">/&gt;</span></span></span></span>       &lt;b&gt;{{userActivationCode}}&lt;<span class="hljs-regexp"><span class="hljs-regexp">/b&gt;      !&lt;br/</span></span>&gt;<span class="xml"><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">br</span></span></span></span><span class="xml"><span class="hljs-tag">/&gt;</span></span></span></span> ,     <span class="hljs-string"><span class="hljs-string">" / "</span></span>    ,                &lt;b&gt;{{companyNameByInviteCode}}&lt;<span class="hljs-regexp"><span class="hljs-regexp">/b&gt;! {{/i</span></span>f}} {{/<span class="hljs-keyword"><span class="hljs-keyword">if</span></span>}} &lt;<span class="hljs-regexp"><span class="hljs-regexp">/template&gt;</span></span></code> </pre><br>  This is how it is. <br><br>  The inviteList template displays for us the inviteSend sending form and a list of invitations available to the company.  Based on the user's role and the status of the invitation, the form for sending the invitation and the Delete button are displayed or hidden. <br><br>  The activateInviteToCompany template also, based on the status of the invitation (sent / activated) and the state of the user (authorized / unauthorized), displays either an activation invitation or information about the impossibility of using the invitation for one of the reasons. <br><br>  Moreover, the page inviting the user of the activateInviteToCompany template contains detailed information for the user, who, why, and where he invites.  This is very important, since the user referred by link from the letter is not a fact that he wants to accept the invitation is not clear from whom in an incomprehensible service. <br><br>  This is what our invitation widget looks like: <br><img src="https://habrastorage.org/files/b34/a68/6ee/b34a686ee5f24f05be63d88563e3ae98.png"><br><br>  And so, the user invitation page: <br><img src="https://habrastorage.org/files/b3e/35e/0d8/b3e35e0d8cf34fe0a4e1dfd632a3bd42.png"><br><br><h4>  Client-side logic </h4><br>  Fuh ... The third hour of writing the article ... <br><br>  Left a little.  It's time for us to finally hang the logic on our interface and tie all the parts of the system together.  For this, <br><br>  <b>File client / views / invite / invite.js</b> <br><pre> <code class="javascript hljs">Template.inviteSend.events({ <span class="hljs-string"><span class="hljs-string">'click #sendInviteBtn'</span></span>: <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-comment"><span class="hljs-comment">//      Email var email = $('#inviteSend [name=email]').val(); $('#sendInviteBtn').attr("disabled", true); //    Email   var existsInvite = Invite.findOne({email:email}); if ( existsInvite == undefined ) { //      -  Email   if (UI._globalHelpers.validateEmail( email )) { // Email   -       Meteor.call('invationSender', email, function (error, result) { if (error) { //-   .   $('#inviteSend [name=email]').val(""); $('#sendInviteBtn').removeAttr("disabled"); bootbox.alert("   .     ! : " + error.reason); } else { // .  ,    $('#inviteSend [name=email]').val(""); $('#sendInviteBtn').removeAttr("disabled"); Meteor.subscribe('invite', Meteor.userId()); bootbox.alert("     " + email); } }); } else { // Email    -    $('#inviteSend [name=email]').val(""); $('#sendInviteBtn').removeAttr("disabled"); bootbox.alert("Email    email@example.ru!"); } } else { //    Email   -    . $('#inviteSend [name=email]').val(""); $('#sendInviteBtn').removeAttr("disabled"); bootbox.alert("  Email     !"); } } }); Template.inviteList.events({ //      'click .deleteInviteBtn': function () { //            Meteor.call('deleteInvite', this._id, function (error, result) { if (error) { bootbox.alert("   .     ! : " + error.reason); } else { bootbox.alert(" !"); } }); } }); //        Template.inviteList.helpers({ //   invitedUsers: function () { return Invite.find(); }, //        inviteTextStatus: function() { var textStatus = '-'; switch(this.status) { case INVITE_CREATED: textStatus = ''; break; case INVITE_EMAILED: textStatus = ''; break; case INVITE_COMPLETED: textStatus = ''; break; } return textStatus; }, //   inviteIsComplete: function () { if (this.status == INVITE_COMPLETED) { return true; } else { return false; } }, //   inviteIsEmailed: function () { if (this.status == INVITE_EMAILED) { return true; } else { return false; } }, //   inviteIsCreated: function () { if (this.status == INVITE_CREATED) { return true; } else { return false; } } }); if (Meteor.isClient) { //             Template.activateInviteToCompany.rendered = function () { Session.set('activationToken', Router.current().params.activationToken); }; //   Template.activateInviteToCompany.helpers({ //        companyNameByInviteCode: function () { var invite = Invite.findOne({token:Router.current().params.activationToken}); var company = Company.findOne({_id:invite.companyId}); return company.title; }, //        companyUserNameByInviteCode: function () { var invite = Invite.findOne({token:Router.current().params.activationToken}); var company = Company.findOne({_id:invite.companyId}); var user = Meteor.users.findOne({_id:company.userId}); return user.profile.name; }, //      userActivationCode: function () { return Router.current().params.activationToken; }, //      //      inviteIsActivated: function () { var userInviteCode = Router.current().params.activationToken; var invite = Invite.findOne({token: userInviteCode}); if (invite.status == INVITE_COMPLETED) { return true; } else { return false; } } }); }</span></span></code> </pre><br>         .   ‚Ä¶ <br><br>        ¬´ ¬ª  ¬´ ¬ª. <br>    ¬´ ¬ª   email    ,       ,      . <br><br>    ¬´ ¬ª      .    . <br><br>           ,    . <br><br>            . <br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The most interesting piece of this code is the definition of </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Template.activateInviteToCompany.rendered</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">It is this code that is responsible for saving in the session a variable with an activation code.</font></font><br><br><h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Outcome and live demo </font></font></h4><br>     ,           ,         ,       ,     ,    Reformal      ‚Äî      ¬´ / ¬ª,    ,         ()     . <br><br>        ,    , ,          . <br><br>  That's all. ,   ,    ? <br><br>        <a href="http://p.kellot.ru/">p.kellot.ru</a> <br>        ,          .            ‚Äî      <a href="http://p.kellot.ru/reviews">Reformal</a> . </div><p>Source: <a href="https://habr.com/ru/post/257113/">https://habr.com/ru/post/257113/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../257101/index.html">Cyclomatic complexity: CSS logic</a></li>
<li><a href="../257105/index.html">Deploying Oracle Database 12c DBMS on Windows Server to InfoboxCloud Cloud</a></li>
<li><a href="../257107/index.html">Software renderer - 2: rasterization and attribute interpolation</a></li>
<li><a href="../257109/index.html">Attackers use Linux / Mumblehard to compromise servers, part 1</a></li>
<li><a href="../257111/index.html">Effective work with text or how I reinvent the wheel.</a></li>
<li><a href="../257115/index.html">Simple control of arduino via the Internet</a></li>
<li><a href="../257117/index.html">Lab penetration testing "Test lab v.7" is open</a></li>
<li><a href="../257119/index.html">Lectures of the Technosphere. Semester 2 Modern methods and tools for building information retrieval systems</a></li>
<li><a href="../257121/index.html">Image and video analysis. Image segmentation</a></li>
<li><a href="../257123/index.html">Develop a simple game in the game maker. Episode 1</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>