<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>How to determine which files on the disk correspond to PostgreSQL tables</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Sometimes you need to determine which file on the disk corresponds to the table. You have a path full of numbers such as base / 16499/19401 and you wa...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>How to determine which files on the disk correspond to PostgreSQL tables</h1><div class="post__text post__text-html js-mediator-article">  Sometimes you need to determine which file on the disk corresponds to the table.  You have a path full of numbers such as <b><i>base / 16499/19401</i></b> and you want to understand it.  You can look at the error message that mentions the file name, for example: <br><br><pre><code class="sql hljs">ERROR: could not read block 11857 of relation base/16396/3720450: read only 0 of 8192 bytes</code> </pre> <a name="habracut"></a><br><h5>  <b>Looking for a relationship path</b> </h5><br>  You can see the path to the table using: <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> pg_relation_filepath(<span class="hljs-string"><span class="hljs-string">'tablename'</span></span>);</code> </pre><br>  but what about the reverse process, getting the name of the object from the path to it?  There is a <b>pg_filenode_relation</b> function that seems appropriate for this ... but in order to use it, you must be connected to the specific database to which this file belongs, which means knowing this connection. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h5>  <b>The structure of the path to the file</b> </h5><br>  Here's how to determine the path to the tables and databases in the modern version of PostgreSQL.  (Older versions use a different format that you can read about <a href="http://blog.endpoint.com/2012/02/postgres-block-error-xyz.html">here</a> ). <br><br>  There are 3 main path options: <br><br><ul><li>  For files in the default tablespace, <i>base / database_oid / filenode id for the relation</i> </li><li>  For files from other tablespaces: <i>pg_tblspc / tablespace_oid / tablespace_version_subdir / database_oid / filenode id relations</i> </li><li>  For general relationships: <i>global / filenode relationship id</i> </li></ul><br><br>  Common relationships will be discussed at the end.  For the first two options, which are the most common, which you will most often encounter, the last part of the path is identical, the oid base and the oid relationship. <br><br>  Please note that I used the wording " <i>filenode id relations</i> " and not " <i>oid relations</i> ".  This is due to the fact that PostgreSQL has <i>a relfilenode map</i> in the file called <b>pg_relfilenode.map</b> for each database / table space.  The names of the table files do not necessarily coincide with their oids from <b>pg_class</b> , and they may change after running <b>VACUUM FULL, TRUNCATE,</b> and others.  For example: <br><br><pre> <code class="sql hljs">test=&gt; <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> pg_relation_filepath(<span class="hljs-string"><span class="hljs-string">'a'</span></span>); pg_relation_filepath <span class="hljs-comment"><span class="hljs-comment">---------------------- base/16385/101565 (1 row) test=&gt; VACUUM FULL a; VACUUM test=&gt; select pg_relation_filepath('a'); pg_relation_filepath ---------------------- base/16385/101577 (1 row)</span></span></code> </pre><br>  So.  How to turn this path back into a relationship name? <br><br><h5>  <b>Database id's and filenode ids relationships</b> </h5><br>  Suppose you got an error from the beginning of this article.  It can be divided into several parts: <br><br><ul><li>  base: in the default tablespace </li><li>  16396: in the database with oid 16396 </li><li>  3720450 filenode id for a table with oid 3720450 </li></ul><br>  then consider what each of them means. <br><br><h5>  <b>Oid database definition</b> </h5><br>  First, you need to connect to any database in this PostgreSQl process and run: <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">select</span></span> datname <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> pg_database <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> <span class="hljs-keyword"><span class="hljs-keyword">oid</span></span> = <span class="hljs-number"><span class="hljs-number">16396</span></span></code> </pre><br>  (or any other oid base that you have).  This will return the name of the database. <br><br>  After that, you need to connect to this database. <br><br><h5>  <b>Inverse transformation of relfilenodes on 9.4 version</b> </h5><br>  If you are using version 9.4, or more recent, then the following part is simple for you: <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> pg_filenode_relation(<span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">3720450</span></span>);</code> </pre><br>  (0 means ‚Äúdefault tablespace‚Äù) <br><br>  This function performs the inverse transformation of relfilenode for you.  Thus, it will simply show you the name of the table.  It will not be shown a link to any schema if the received table name belongs to the current <b>search_path</b> ;  You can use <i><b>SET search_path = '';</b></i>  before executing the function, in order to specify the path up to the scheme. <br><br>  You must be connected to the <i>correct</i> database, or the wrong answer will be received, or no answer at all. <br><br><h5>  <b>Reverse conversion relfilenodes on version 9.3</b> </h5><br>  If you are using version 9.3, or older, you need to connect to the database in which the table is located and execute the following query to <b>pg_class</b> : <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">select</span></span> n.nspname <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> tableschema, c.relname <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> tablename <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> pg_class c <span class="hljs-keyword"><span class="hljs-keyword">inner</span></span> <span class="hljs-keyword"><span class="hljs-keyword">join</span></span> pg_namespace n <span class="hljs-keyword"><span class="hljs-keyword">on</span></span> (c.relnamespace = n.oid) <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> c.relfilenode = <span class="hljs-number"><span class="hljs-number">3720450</span></span>;</code> </pre><br>  (or any other obtained table relfilenode id). <br><br>  This will tell you which table this error belongs to. <br><br><h5>  <b>No results?</b> </h5><br>  Well, it usually helps. <br><br>  <b>Relfilenode</b> can also be null, which in turn means that the file is located via <b>pg_relfilenode.map</b> .  This is a typical scenario for general and some system directories, their indexes, TOAST tables, etc.  For example, it can be <b>pg_database</b> , <b>pg_class</b> and <b>pg_proc</b> . <br><br><h5>  <b>What about the circuit?</b> </h5><br>  Did you notice that the schema (namespace) does not appear in the path? <br><br>  In the PostgreSQL schema, it is the only namespace within the database.  They have no influence on where tables are physically stored on disk. <br><br><h5>  <b>Other tablespace paths</b> </h5><br>  The recent incident I encountered was the following error: <br><br><pre> <code class="sql hljs">ERROR: could not <span class="hljs-keyword"><span class="hljs-keyword">truncate</span></span> <span class="hljs-keyword"><span class="hljs-keyword">file</span></span> <span class="hljs-string"><span class="hljs-string">"pg_tblspc / 16709 / PG_9.3_201306121 / 16499/19401"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> <span class="hljs-number"><span class="hljs-number">8</span></span> blocks: Permission denied</code> </pre><br>  This is not the default tablespace, since the path starts with pg_tblspc. <br><br>  The process of finding the table is actually the same.  You can ignore the <i><b>pg_tblspc / nnn / PG_n.n_nnnnnn /</b></i> part and focus directly on the <i><b>database_oid / relation_oid</b></i> , as described above for cases with a default table space.  For this it is worth understanding what the path means. <br><br>  Thus, the error text is divided into the following parts: <br><br><ul><li>  pg_tblspc: this is not the default tablespace </li><li>  16709: this is a tablespace with an oid of 16709 </li><li>  PG_9.3_201306121: PostgreSQL 9.3 is used with the directory version 201306121. </li><li>  16499: database with oid 16499 </li><li>  19401 table with relfilenode id 19401 </li></ul><br>  We have already discussed the part about database oid and tabular relfilenode id.  They do not differ from the tablespace, they just start in a different place. <br><br>  So what about the part with the tablespace? <br><br>  <b><i>pg_tblspc</i></b> is a directory in the PostgreSQL data directory that contains <i>symbolic links</i> to all table space locations (or NTFS, connection points for them).  Each symbolic link is named after the oid of the tablespace.  This is how PostgreSQL finds table spaces.  SQL commands to tablespaces operate on these links. <br><br>  Oid refers to the <i><b>pg_tablespace</b></i> entry for the tablespace, as seen from: <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">select</span></span> spcname <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> pg_tablespace <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> <span class="hljs-keyword"><span class="hljs-keyword">oid</span></span> = <span class="hljs-number"><span class="hljs-number">16709</span></span>;</code> </pre><br>  Inside the tablespace directory, there is another directory named after the PostgreSQL version.  It is static for this version and the only use for this is the multiple access of several PostgreSQL processes to a single tablespace, for example, during pg_upgrade.  As a rule, there is only one entry. <br><br>  In general, the structure is the same as for the base / paths - first the database oid, then the oid relationship. <br><br><h5>  <b>Global (common) tables</b> </h5><br>  There is a third category of errors, in case you observe it, then you are definitely in trouble.  PostgreSQL has shared directories ‚Äî tables that have the same content in each database.  They live in a special tablespace with relfilenode id 16709. <br><br>  Paths to them begin with <b>global</b> instead of <b>base</b> and they lack a component with a database oid. <br><br>  Shared directories are not marked relfilenode in <b>pg_class</b> .  That is, you cannot see, for example, <b>pg_database</b> from <b>pg_class</b> .  <b>pg_filenode_relation</b> returns null, regardless of whether to call it with the default table space oid, or with the global table space 1664 oid. <br><br>  Figuring this out is a topic for a subsequent article with disassembled links. <br><br>  Of course, if you experience problems with shared directories, you will most likely not be able to launch the database in principle. <br><br><h5>  <b>Dealing with damage</b> </h5><br>  Database damage should not happen.  But it can happen anyway.  These can be problems with hardware, kernel bugs, or file systems, SSDs that lie about making reliable disk tides, buggy storage networks, and of course the bugs of PostgreSQL itself.  If you suspect damage to the database, before doing anything, read and follow the advice <a href="https://wiki.postgresql.org/wiki/Corruption">on the damage wiki page</a> . <br><br><h5>  <b>Insides</b> </h5><br>  To see how this all works, run the relpathbackend macro in src / include / common / relpath.h.  It calls the GetRelationPath in src / common / relpath.c. <br><br>  The manual describes the structure of the database on disk.  <a href="http://www.postgresql.org/docs/current/static/storage-file-layout.html">Link</a> </div><p>Source: <a href="https://habr.com/ru/post/275125/">https://habr.com/ru/post/275125/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../275113/index.html">Revolution R has been renamed to Microsoft R and is available for free to developers and students.</a></li>
<li><a href="../275115/index.html">Veeam Availability Suite v9: ‚Äúinfinitely‚Äù scalable backup repository</a></li>
<li><a href="../275119/index.html">Juniper routing instances</a></li>
<li><a href="../275121/index.html">Alternative options for installing the Vivaldi browser in Linux</a></li>
<li><a href="../275123/index.html">Simple removal of the "tricked" protection kraftway credo vv18</a></li>
<li><a href="../275129/index.html">Five reasons not to use your employees for translation and localization</a></li>
<li><a href="../275131/index.html">Image Generator invites v. 2.0</a></li>
<li><a href="../275133/index.html">The unit accepting DASH will be shown at a Bitcoin conference</a></li>
<li><a href="../275135/index.html">Why am I writing C games (yes, C)</a></li>
<li><a href="../275137/index.html">Serious CVE-2016-0777 vulnerability detected in OpenSSH client</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>