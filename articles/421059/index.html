<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Accelerating sites with the help of "early tips"</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Sites are still loading too slowly. At the most critical moment of the boot process, the feed is often almost completely idle. The new technology prop...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Accelerating sites with the help of "early tips"</h1><div class="post__text post__text-html js-mediator-article">  Sites are still loading too slowly.  At the most critical moment of the boot process, the feed is often almost completely idle.  The new technology proposed by the engineer FastI's Kazuho Oku will help to better use this critical first couple of seconds. <br><br>  Have you ever downloaded a website on your phone - and looked at a page without text for 10 seconds?  No one likes to sit and stare at a blank screen while some unusual font loads.  Therefore, it makes sense to transfer the loading of such important things to the earliest possible time.  Preload <a href="https://developer.mozilla.org/en-US/docs/Web/HTML/Preloading_content">Link rel = preload</a> had to partially solve the problem.  The first thing the browser does is to parse the HTTP headers, so this is the perfect place to point to the preloading of a resource that will definitely be needed later. <br><a name="habracut"></a><br><h1>  Internet is slow by default. </h1><br>  Let's see what happens if you don't use preloading.  The browser can start downloading resources only after it has discovered that it needs them.  This happens most quickly for resources that are in HTML at the time of the initial parsing of the document (for example, <code>&lt;script&gt;</code> , <code>&lt;link rel=stylesheet&gt;</code> and <code>&lt;img&gt;</code> ). <br><br>  Slower downloads resources that are found after building the render tree (this is where the page slows down because of the font loading, because to understand this, you first need to load the style sheet, parse it, build the CSS object model, and then render tree). 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Resources that are added to the document using JavaScript loaders that are triggered by events like <code>DOMContentLoaded</code> .  If you put it all together, we get a non-optimized and rather meaningless waterfall.  Much of the time the channel is idle, and resources are loaded either earlier than necessary, or too late: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/e8a/cb5/705/e8acb5705ec028771d0426c9e16b8635.png"><br><br><h1>  Link rel = preload helps a lot </h1><br>  In the past few years, the situation has improved thanks to <a href="https://developer.mozilla.org/en-US/docs/Web/HTML/Preloading_content">Link rel = preload</a> .  For example: <br><br><pre> <code class="hljs ruby"><span class="hljs-symbol"><span class="hljs-symbol">Link:</span></span> &lt;<span class="hljs-regexp"><span class="hljs-regexp">/resources/fonts</span></span><span class="hljs-regexp"><span class="hljs-regexp">/myfont.woff&gt;; rel=preload; as=font; crossorigin Link: &lt;/resources</span></span><span class="hljs-regexp"><span class="hljs-regexp">/css/something</span></span>.css&gt;; rel=preload; as=style <span class="hljs-symbol"><span class="hljs-symbol">Link:</span></span> &lt;<span class="hljs-regexp"><span class="hljs-regexp">/resources/js</span></span><span class="hljs-regexp"><span class="hljs-regexp">/main.js&gt;; rel=preload; as=script</span></span></code> </pre> <br>  Thanks to these directives, the browser can start downloading resources immediately after receiving the headers and before starting the analysis of the HTML body: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/54c/fe2/727/54cfe2727bf9fdbb286acf29c173885b.png"><br><br>  This is a significant improvement, especially for large pages and critical resources that would otherwise be discovered late.  Especially for fonts, but anything can become a critical resource, for example, a data file needed to load a JavaScript application. <br><br>  However, we can do more.  After all, the browser does not do anything between when it finishes sending the request and when it receives the first bytes of the response (a large green fragment on the initial request is higher). <br><br><h1>  We engage the time "server reflection" with the help of "early tips" </h1><br>  On the other hand, the server is really busy.  It generates a response and determines whether it is successful or not.  After accessing the database, API calls, authentication, etc.  the server may decide that the correct answer is a 404 error. <br><br>  Sometimes server thinking time is shorter than network latency.  Sometimes much more.  But it is important to understand that they do not overlap.  While the server is thinking, we are not sending data to the client. <br><br>  But it is interesting that before generating the answer you already know some styles and fonts that need to be loaded to display the page.  After all, error pages usually use the same corporate identity and design as regular pages.  It would be great to send these headers <code>Link: rel=preload</code> <b>even before the server</b> .  It is for this purpose that the <a href="httpbis-early-hints-05">Early Hints</a> standard ‚Äú <a href="httpbis-early-hints-05">Early Hints</a> ‚Äù is conceived, specified in <a href="httpwg.org/specs/rfc8297.html">RFC8297</a> from the HTTP Working Group <a href="httpwg.org/specs/rfc8297.html">sponsored</a> by my colleague Kazuho Oku from Fastly.  Appreciate the magic of <i>several status lines in one answer</i> : <br><br><pre> <code class="hljs pgsql">HTTP/<span class="hljs-number"><span class="hljs-number">1.1</span></span> <span class="hljs-number"><span class="hljs-number">103</span></span> Early Hints Link: &lt;<span class="hljs-keyword"><span class="hljs-keyword">some</span></span>-font-face.woff2&gt;; rel="preload"; <span class="hljs-keyword"><span class="hljs-keyword">as</span></span>="font"; crossorigin Link: &lt;main-styles.css&gt;; rel="preload"; <span class="hljs-keyword"><span class="hljs-keyword">as</span></span>="style" HTTP/<span class="hljs-number"><span class="hljs-number">1.1</span></span> <span class="hljs-number"><span class="hljs-number">404</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Not</span></span> <span class="hljs-built_in"><span class="hljs-built_in">Found</span></span> <span class="hljs-type"><span class="hljs-type">Date</span></span>: Fri, <span class="hljs-number"><span class="hljs-number">26</span></span> May <span class="hljs-number"><span class="hljs-number">2017</span></span> <span class="hljs-number"><span class="hljs-number">10</span></span>:<span class="hljs-number"><span class="hljs-number">02</span></span>:<span class="hljs-number"><span class="hljs-number">11</span></span> GMT Content-Length: <span class="hljs-number"><span class="hljs-number">1234</span></span> Content-<span class="hljs-keyword"><span class="hljs-keyword">Type</span></span>: <span class="hljs-type"><span class="hljs-type">text</span></span>/html; charset=utf<span class="hljs-number"><span class="hljs-number">-8</span></span> Link: &lt;<span class="hljs-keyword"><span class="hljs-keyword">some</span></span>-font-face.woff2&gt;; rel="preload"; <span class="hljs-keyword"><span class="hljs-keyword">as</span></span>="font"; crossorigin Link: &lt;main-styles.css&gt;; rel="preload"; <span class="hljs-keyword"><span class="hljs-keyword">as</span></span>="style"</code> </pre> <br>  The server can record the first, so-called <a href="https://developer.mozilla.org/en-US/docs/Web/HTTP/Status">‚Äúinformational‚Äù response code</a> , as soon as it receives the request, and issue it to the network.  Then it will determine the real reaction and its generation.  Meanwhile, in the browser you can start preloading much earlier: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/d9b/8ca/1cb/d9b8ca1cbb8fd4753bd037893ea92d1b.png"><br><br>  Of course, this will require certain changes in browsers, servers and CDN, and some browser developers have expressed reservations about the difficulties of implementation.  Therefore, it is still unclear when these headers can be put into operation.  You can track progress in public trackers for <a href="https://bugs.chromium.org/p/chromium/issues/detail%3Fid%3D671310">Chrome</a> and <a href="https://bugzilla.mozilla.org/show_bug.cgi%3Fid%3D1407355">Firefox</a> . <br><br>  We expect that ultimately you will be able to give Early Hints headlines directly from Fastly, while still sending requests in the standard way.  We have not yet decided how to expose the interface through the VCL, so please let us know if you have any suggestions for this! <br><br><h1>  But what about HTTP / 2 Server Push? </h1><br>  With HTTP / 2 comes a new technology called Server Push, which seems to solve the same problem as Link rel = preload in the Early Hints answer.  Although it really works (and you can even quickly generate <a href="http2-server-push">custom pushy from the edge servers</a> in Fastly), but there is a significant difference in several points: <br><br><ul><li>  The server does not know about the availability of the resource at the client, so it often pushes it unnecessarily.  Due to network buffering and latency, the client usually cannot cancel sending before receiving all the content.  (Although there is a possible solution to this problem, in the form of the proposed <a href="httpbis-cache-digest-04">Cache Digest</a> header, on which Kazuho works with Yoav Weiss from Akamai). </li><li>  Running resources are bound to a connection, so it is easy to start a resource that the client does not use, as it tries to get it through another connection.  Clients may need to use a different connection because the resource is in a different source with a different TLS certificate or because it is retrieved in a different <a href="https://developer.mozilla.org/en-US/docs/Web/API/Request/credentials">credential mode</a> . </li><li>  H2 Push is <a href="https://jakearchibald.com/2017/h2-push-tougher-than-i-thought/">not very consistently implemented</a> in different browsers.  Therefore, it is difficult to predict whether it will work or not in your particular case. </li></ul><br>  One way or another, Early Hints and Server Push offer different tradeoffs.  Early Hints tips provide more efficient use of the network in exchange for additional packet exchange.  If you assume a low network latency and a long time to think about the server, then Early Hints is the right solution. <br><br>  However, this is not always the case.  Let's be optimistic and imagine that humans will soon settle on Mars.  They will view the web pages with a delay of 20-45 minutes for each packet exchange, so the additional exchange is extremely painful, and the server time is insignificant compared to it.  Server Push wins easily here.  But if we ever browse the web from Mars, we‚Äôll rather download some kind of data package, something like the <a href="https://github.com/WICG/webpackage">web packages</a> now offered and <a href="http-origin-signed-responses-02.html">signed exchanges</a> . <br><br><h1>  Extra Bonus: Accelerated Minimizing Request </h1><br>  Although Early Hints is supposed to be used primarily in the browser, there is an interesting potential benefit for the CDN.  When Fastly receives many requests for the same resource, we usually send only one of them to the source, and the rest are put in the waiting queue.  This process is known as <a href="https://docs.fastly.com/guides/performance-tuning/request-collapsing.html">request collapsing</a> .  If the response from the source includes <code>Cache-Control: private</code> , then you should remove all requests from the queue and send them to the source separately, because we cannot use one answer to satisfy several requests. <br><br>  We cannot make a decision until we receive a response to the first request, but if Early Hints support, if the server issues an Early Hints response with the Cache-Control header, then we know much earlier that the queue cannot be minimized into one request, but instead immediately send to the source all requests from the queue. <br><br><h1>  Order less critical content with priority prompts </h1><br>  Early prompts are a great way to access some of the most valuable objects in the queue (waterfall): when the network is idle, the user is waiting, there is only one request on the way, and there is nothing on the screen.  But as soon as HTML is loaded and the page is analyzed, the number of resources that need to be loaded increases dramatically.  Now it is important not to load resources as quickly as possible, but to load them in the correct order.  <a href="https://docs.google.com/document/d/1bCDuq9H1ih9iNjgzyAL0gpwNFiEP4TZS-YLRp_RuMlc/edit">Browsers use a strikingly complex array of heuristics</a> to independently determine the boot priority, but if you want to override them, in the future this can be done with the help of <a href="https://github.com/WICG/priority-hints">Priority Hints</a> : <br><br><pre> <code class="hljs xml"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">src</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"main.js"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">async</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">importance</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"high"</span></span></span><span class="hljs-tag">&gt;</span></span><span class="undefined"></span><span class="hljs-tag"><span class="undefined"></span><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">src</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"non-critical-1.js"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">async</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">importance</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"low"</span></span></span><span class="hljs-tag">&gt;</span></span><span class="undefined"></span><span class="hljs-tag"><span class="undefined"></span><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre> <br>  With this new attribute of importance, developers can control the order of loading resources in the event of competition for the network.  Perhaps, low priority resources can be deferred until the processor and the network are released, or depending on the type of device. <br><br><h1>  Can it be used? </h1><br>  Neither the early prompts nor the priority prompts have yet become the standard.  Recently H2O, the HTTP / 2 server used and supported by Fastly, has begun to use Early Hints (see PR <a href="https://github.com/h2o/h2o/pull/1727">1727</a> and <a href="https://github.com/h2o/h2o/pull/1767">1767</a> ), and there is an <a href="https://www.chromestatus.com/feature/5273474901737472">intention to implement Priority Hints in Chrome</a> , as well as active tracking of 1xx responses.  At the same time, there is no harm in starting to send Early Hints right now - and if you want to get ahead of the trend, go ahead! </div><p>Source: <a href="https://habr.com/ru/post/421059/">https://habr.com/ru/post/421059/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../421047/index.html">Analogs in the "Nomenclature". Another way to save wisely. Part 1</a></li>
<li><a href="../421049/index.html">Designing application screens: from planning to design layout</a></li>
<li><a href="../421051/index.html">How I launched my first SaaS project by being employed all day</a></li>
<li><a href="../421055/index.html">Custom web development: how to scale on an ever-growing project</a></li>
<li><a href="../421057/index.html">How to collect cars for passenger trains</a></li>
<li><a href="../421061/index.html">PostgreSQL: how and why swells wal</a></li>
<li><a href="../421063/index.html">New books on children's programming on Scratch</a></li>
<li><a href="../421065/index.html">As I taught AI to play Tetris for NES. Part 2: AI</a></li>
<li><a href="../421067/index.html">How we developed the AR-application for the review of historical places</a></li>
<li><a href="../421069/index.html">Backpack Bobby Urban: the inner world under lock and key</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>