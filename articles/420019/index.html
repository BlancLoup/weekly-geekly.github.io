<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Client-server interaction in a new mobile PvP-shooter and game server device: problems and solutions</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="In previous articles of the cycle (all links at the end of the article) on the development of a new fast paced shooter, we examined the mechanisms of ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Client-server interaction in a new mobile PvP-shooter and game server device: problems and solutions</h1><div class="post__text post__text-html js-mediator-article">  In previous articles of the cycle (all links at the end of the article) on the development of a new fast paced shooter, we examined the mechanisms of the basic architecture of game logic based on ECS, and the specifics of working with the shooter on the client, in particular, the implementation <a href="https://habr.com/company/pixonic/blog/415959/">of the player‚Äôs prediction system for local</a> responsiveness .  This time we will dwell more on the issues of client-server interaction in the conditions of poorly connected mobile networks and ways to improve the quality of the game for the end user.  Also briefly describe the architecture of the game server. <br><br><img src="https://habrastorage.org/webt/py/lp/8q/pylp8q_ki2el3odmsmd_h5ppqh0.jpeg"><br><a name="habracut"></a><br><br>  During the development of a new synchronous PvP for mobile devices, we encountered typical problems for the genre: 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <ol><li>  The quality of the connection of mobile clients leaves much to be desired.  This is a relatively high average ping in the region of 200-250 ms, and an unstable distribution of ping over time, taking into account the change of access points (although, contrary to popular opinion, the percentage of packet loss in 3G + mobile networks is rather low - about 1%). </li><li>  Existing technical solutions are monstrous frameworks that drive developers into a rigid framework. </li></ol><br>  We made the first prototype on UNet, even if it imposed restrictions on scalability, control over the network component and added dependence on the capricious mix of master clients.  Then they switched to samopisny netcode over the <a href="https://www.photonengine.com/en/onpremise">Photon Server</a> , but more on that later. <br><br>  Consider the mechanisms for organizing the interaction between customers in synchronous PvP games.  The most popular of them are: <br><br><ul><li>  <b>P2P or peer-to-peer</b> .  The whole logic of the match is hosted on one of the clients and does not require practically any traffic costs from us.  But the space for cheaters and the high demands on the host of the match client, as well as restrictions on NAT did not allow us to take this solution for a mobile game. </li><li>  <b>Client-server</b> .  A dedicated server, on the contrary, allows you to fully control everything that happens in a match (farewell, cheaters), and its performance - to count some things specific to our project.  Also, many large hosting providers have their own subnet structure, which provides the minimum latency for the end user. </li></ul><br>  It was decided to write an authoritarian server. <br><br><img src="https://habrastorage.org/webt/x4/a4/ku/x4a4kunfi3lnbjqeghpddh-hsz8.jpeg"><br>  <i>Network interaction with peer-to-peer (left) and client-server (right)</i> <br><br><h3>  Data transfer between client and server </h3><br>  We use <b>Photon Server</b> - this allowed us to quickly deploy the necessary infrastructure for the project based on the scheme already worked out over the years (in War Robots we use it). <br><br>  Photon Server for us is exclusively a transport solution, without high-level constructions that are strongly tied to a specific game engine.  Which gives some advantage, as the data transfer library can be replaced at any time. <br><br>  The game server is a multi-threaded application in the Photon container.  For each match, a separate stream is created that encapsulates the entire logic of the work and prevents the influence of one match on another.  All server connections are controlled by Photon, and the data that comes from clients is added to a queue, which is then disassembled by ECS. <br><br><img src="https://habrastorage.org/webt/j-/ws/wm/j-wswmt08qutnwc1jha0dgazkfo.jpeg"><br>  <i>The general scheme of streams of matches in the container Photon Server</i> <br><br>  Each match consists of several stages: <br><br><ol><li>  The game client queues up in the so-called matchmaking service.  As soon as it gathers the required number of players that meet certain conditions, he reports this to the game server using gRPC.  At the same time, all the data needed to create the game are transferred. <br><br><img src="https://habrastorage.org/webt/e_/rq/qp/e_rqqp5kiwrz-mxwbtkeuqptfpy.jpeg"><br>  <i>The general scheme for creating a match</i> </li><li>  On the game server, the initialization of the match begins.  All match parameters are processed and prepared, including card data, as well as all client data received from the match creation service.  Processing and preparing data implies that we parse all the necessary data and write it into a special subset of entities, which we call RuleBook.  It stores match statistics (which do not change during its course) and will be transferred to all clients during connection and authorization on the game server once or upon reconnection after losing the connection.  Static data of a match includes the configuration of the card (the representation of the card by the components of ECS, connecting them with the physics engine), customer data (nicknames, a set of weapons that they have and do not change during the battle, etc.). </li><li>  Start the match.  The <a href="https://habr.com/company/pixonic/blog/413729/">ECS systems</a> that make up the game on the server begin to work.  All systems are ticking 30 frames per second. </li><li>  Each frame is the reading and unpacking of player inputs or copying, if the players did not send their input within a certain interval. </li><li>  Then, in the same frame, the input is processed in the ECS system, namely: a change in the player‚Äôs state;  the world he influences by his input;  and the status of other players. </li><li>  At the end of the frame, the resulting world state for the player is packed and sent over the network. </li><li>  At the end of the match, the results are sent to customers and to microservice processing awards for the battle using gRPC, as well as match analyst. </li><li>  After the stream flow is cleared, the flow closes. </li></ol><br><img src="https://habrastorage.org/webt/02/8i/jl/028ijlnhor-evm6llkmfbiguf3s.jpeg"><br>  <i>Sequence of actions on the server within one frame</i> <br><br>  From the client‚Äôs side, the process of connecting to a match is as follows: <br><br><ol><li>  First, a request is made for queuing to the match creation service via websocket with serialization through protobuf. </li><li>  When creating a match, this service tells the client the address of the game server and sends an additional payload needed by the client before the match.  Now the client is ready to begin the authorization process on the game server. </li><li>  The client creates a UDP socket and starts sending a connection request to the game server along with some identification data.  The server is already waiting for this client.  When connected, he sends him all the necessary data to start the game and the primary display of the world.  These include: RuleBook (a list of static data for a match), as well as a StringIntMap (the data used in the gameplay strings that will be identified by integers during the match).  This is necessary to save traffic, because  transferring rows each frame creates a significant load on the network.  For example, all player names, class names, weapon identifiers, accounts, and the like are all recorded in StringIntMap, where they are encoded with simple integer data. </li></ol><br>  When a player directly affects other users (does damage, applies effects, etc.) - the server searches the state history to compare the game world actually seen by the client at a particular simulation tick with what was happening on the server to others gaming entities. <br><br>  For example, you shoot at your client.  For you, this happens instantly, but the client has already ‚Äúrun away‚Äù for some time in comparison with the surrounding world, which he displays.  Therefore, due to the local prediction of the player's behavior, the server needs to understand where and in what condition the opponents were at the moment of the shot (perhaps they were already dead or, conversely, invulnerable).  The server checks all the factors and makes its verdict on the damage done. <br><br><img src="https://habrastorage.org/webt/os/fb/hh/osfbhh4iwrw6gk2hvtpqp8co2sw.jpeg"><br>  <i>Scheme of the request to create a match, connect to the game server and authorization</i> <br><br><h3>  Serialization and deserialization, packing and unpacking of the first byte of a match </h3><br>  We have self-written binary serialization of data, and we use UDP for data transfer. <br><br>  UDP is the most obvious option for quickly sending messages between the client and the server, where it is usually more important to display the data as soon as possible than to display it in principle.  Lost packages make adjustments, but problems are solved for each case individually, but because  Since data is constantly coming from the client to the server and back, then we can introduce the concept of a connection between the client and the server. <br><br>  To create an optimal and convenient code based on the declarative description of the structure of our ECS, we use code generation.  When creating components for them, serialization and deserialization rules are also generated.  The serialization is based on a custom binary packer, which allows you to package data in the most economical way.  The set of bytes obtained during its operation is not the most optimal, but allows you to create a stream from which you can read some packet data without the need for its complete deserialization. <br><br>  The data transfer limit of 1500 bytes (also known as MTU) is, in fact, the maximum packet size that can be transmitted over Ethernet.  This property can be configured on every network hop and is often even below 1500 bytes.  What happens if you send a packet of more than 1500 bytes?  Package fragmentation begins.  Those.  Each packet will be forcibly divided into several fragments, which will be separately sent from one interface to another.  They can be sent by completely different routes and the time to receive such packets may increase significantly before the network layer issues a glued packet to your application. <br><br>  In the case of Photon, the library forcibly begins to send such packets in reliable UDP mode.  Those.  Photon will wait for each packet fragment, and also send the missing fragments if they are lost during the transfer.  But such work of the network part is unacceptable in games where minimum network delay is necessary.  Therefore, it is recommended to reduce the size of forwarded packets to a minimum and not exceed the recommended 1500 bytes (in our game, the size of one complete world state does not exceed 1000 bytes; the size of a packet with delta compression is 200 bytes). <br><br>  Each packet from the server has a short header that contains several bytes describing the type of packet.  The client first unpacks this set of bytes and determines which package we are dealing with.  We strongly rely on authorization for this property of our deserialization mechanism: in order not to exceed the recommended packet size of 1500 bytes, we break the RuleBook and StringIntMap package into several steps;  and in order to understand exactly what we got from the server - the rules of the game or the state itself - we use the package header. <br><br>  When developing a new project features the size of the package is steadily increasing.  When we encountered this problem, it was decided to write our own delta compression system, as well as contextual clipping of unnecessary data to the client. <br><br><h3>  Context sensitive network traffic optimization.  Delta compression </h3><br>  The contextual data cutting is written manually on the basis of what data the client needs to correctly display the world and correct the local prediction of its own data.  Then a delta compression is applied to the remaining data. <br><br>  Our game every tick produces a new state of the world that needs to be packaged and handed over to customers.  Usually delta compression is to first send a full state with all the necessary data to the client, and then send only the changes to this data.  This can be represented as: <br><br>  <i>deltaGameState = newGameState - prevGameState</i> <br><br>  But for each client, different data is sent and the loss of just one packet can lead to the need to send the full state of the world. <br><br>  Forwarding the full state of the world is a fairly expensive task for the network.  Therefore, we modified the approach and send the difference between the current processed state of the world and the one that was received by the client.  For this, the client in his batch with the input also sends the tick number, which is a unique identifier of the game state, which he has already received.  Now the server knows on the basis of which state it is necessary to build a delta compression.  The client usually does not have time to send the server the number of the tick that he has before the server prepares the next frame with the data.  Therefore, on the client there is a history of the server states of the world, to which the deltaGameState patch generated by the server is applied. <br><br><img src="https://habrastorage.org/webt/ji/uo/ka/jiuokasgdo-wgmgmzbmchlb1gvm.jpeg"><br>  <i>Illustration of the frequency of client-server interaction in the project</i> <br><br>  Let us dwell on what the client sends.  In classic shooters, this package is called ClientCmd and contains information about the player‚Äôs keystrokes and the time the team was created.  Inside the packet with the input, we send much more data: <br><br><pre><code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">sealed</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">InputSample</span></span> { <span class="hljs-comment"><span class="hljs-comment">//  ,        public uint WorldTick; // ,      ,     public uint PlayerSimulationTick; //   .  (idle, , ) public MovementMagnitude MovementMagnitude; //  ,   public float MovementAngle; //    public AimMagnitude AimMagnitude; //    public float AimAngle; //   ,       public uint ShotTarget; //    ,        public float AimMagnitudeCompressed; }</span></span></code> </pre> <br><br>  There are some interesting points.  First, the client informs the server in which tick he sees all the objects of the game world around him that he is unable to predict (WorldTick).  It may seem that the client is able to ‚Äústop‚Äù time for the world, and he himself can run and shoot everyone because of a local prediction.  This is not true.  We trust only a limited set of values ‚Äã‚Äãfrom the client and do not allow him to shoot back in time for more than 1 second.  Also, the WorldTick field is used as an acknowledgment packet, on the basis of which delta compression is built. <br><br>  In the package you can find floating-point numbers.  Typically, these values ‚Äã‚Äãare often used to take readings from a player's joystick, but are not very well transmitted over the network, as they have a lot of bounce and are usually too accurate.  We quantize such numbers and package using a binary packer so that they do not exceed an integer value that can fit into several bits depending on its size.  Thus, the packing of the input from the joystick aiming is broken: <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (Math.Abs(s.AimMagnitudeCompressed) &lt; <span class="hljs-keyword"><span class="hljs-keyword">float</span></span>.Epsilon) { packer.PackByte(<span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { packer.PackByte(<span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">float</span></span> min = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">float</span></span> max = <span class="hljs-number"><span class="hljs-number">1</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">float</span></span> step = <span class="hljs-number"><span class="hljs-number">0.001f</span></span>; <span class="hljs-comment"><span class="hljs-comment">//     1000    , //          //     packer.PackUInt32((uint)((s.AimMagnitudeCompressed - min)/step), CalcFloatRangeBits(min, max, step)); }</span></span></code> </pre> <br><br>  Another interesting feature when sending input is that some commands can be sent several times.  Very often we are asked what to do if a person pressed an ultimatum, and the package with its input was lost?  We just send this input several times.  This is similar to the work of guaranteed delivery, but more flexible and faster.  Since  the size of the input packet is very small, we can pack several adjacent player inputs into the resulting packet.  At the moment, the window size, which determines their number is equal to five. <br><br><img src="https://habrastorage.org/webt/gi/08/0g/gi080gxlym3kf7n801ah19gjeq8.jpeg"><br>  <i>Input packets generated by the client in each tick and sent to the server</i> <br><br>  Transmission of this kind of data is the fastest and most reliable for solving our problems without using reliable UDP.  We assume that the probability of losing so many packets in a row is very low and is an indicator of a serious degradation of the quality of the network as a whole.  If this happens, the server simply copies the last input received from the player and applies it, hoping that it remains unchanged. <br><br>  If the client understands that he has not received packets over the network for a very long time, then the process of reconnection to the server is started.  For its part, the server keeps track of the input queue from the player. <br><br><h3>  Instead of conclusion and reference </h3><br>  There are many other systems on the game server that are responsible for detecting, debugging and editing ‚Äúprofitable‚Äù matches, updating the configuration by game designers without restarting, logging and tracking servers.  We also want to write more about this, but separately. <br><br>  First of all, when developing a network game on mobile platforms, you should pay attention to the correctness of your client's work with high pings (about 200 ms), slightly more frequent data loss, as well as with the size of the data sent.  And you need to clearly fit into the packet limit of 1500 bytes to avoid fragmentation and traffic delays. <br><br>  Useful links: <br><br><ul><li>  <a href="https://gafferongames.com/post/udp_vs_tcp/">https://gafferongames.com/post/udp_vs_tcp/</a> is a great article for choosing between TCP and UDP for online games. </li><li>  <a href="https://api.unrealengine.com/udk/Three/NetworkingOverview.html">https://api.unrealengine.com/udk/Three/NetworkingOverview.html</a> - description of the server model in the Unreal Engine. </li><li>  <a href="http://ieeexplore.ieee.org/document/5360721">http://ieeexplore.ieee.org/document/5360721</a> - study the network quality of mobile connections. </li><li>  <a href="http://ithare.com/mmog-rtt-input-lag-and-how-to-mitigate-them/">http://ithare.com/mmog-rtt-input-lag-and-how-to-mitigate-them/</a> - networking in fast paced games. </li></ul><br>  Previous articles on the project: <br><br><ol><li>  <a href="https://habr.com/company/pixonic/blog/359008/">"As we swung at the mobile fast paced shooter: technologies and approaches</a> . <a href="https://habr.com/company/pixonic/blog/359008/">"</a> </li><li>  <a href="https://habr.com/company/pixonic/blog/413729/">"How and why we wrote our ECS</a> . <a href="https://habr.com/company/pixonic/blog/413729/">"</a> </li><li>  <a href="https://habr.com/company/pixonic/blog/415959/">"As we wrote the network code of mobile PvP shooter: player synchronization on the client</a> . <a href="https://habr.com/company/pixonic/blog/415959/">"</a> </li></ol></div><p>Source: <a href="https://habr.com/ru/post/420019/">https://habr.com/ru/post/420019/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../420009/index.html">Subtleties of product design</a></li>
<li><a href="../420011/index.html">How to choose a 3D printer: a guide for beginners</a></li>
<li><a href="../420013/index.html">Search by MAC address on Juniper switches</a></li>
<li><a href="../420015/index.html">How to measure the speed of the Internet channel and stop looking like a fool in the eyes of your provider</a></li>
<li><a href="../420017/index.html">The art of picking someone else's passwords</a></li>
<li><a href="../420021/index.html">Why do you need Splunk? IoT and industrial data</a></li>
<li><a href="../420023/index.html">State saving in android applications</a></li>
<li><a href="../420025/index.html">Smart farm. What will it be?</a></li>
<li><a href="../420029/index.html">As we in 1C: Enterprise, we solve systems of algebraic equations</a></li>
<li><a href="../420031/index.html">Drawing with Render Targets in the Unreal Engine</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>