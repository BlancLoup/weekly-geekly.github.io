<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>The course of the young fighter PostgreSQL</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="I want to share useful techniques for working with PostgreSQL (other DBMS have similar functionality, but may have a different syntax). 

 I will try ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>The course of the young fighter PostgreSQL</h1><div class="post__text post__text-html js-mediator-article"> <a href="https://habrahabr.ru/post/340460/"><img src="https://habrastorage.org/webt/59/ea/6d/59ea6defd5c6d032615478.png"></a> <br><br>  I want to share useful techniques for working with PostgreSQL (other DBMS have similar functionality, but may have a different syntax). <br><br>  I will try to cover a variety of topics and techniques that will help when working with data, trying not to delve into the detailed description of a particular functionality.  I liked such articles when I was studying on my own.  It's time <s>to pay tribute to free Internet self-education and</s> write your own article. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      This material will be useful to those who have fully mastered the basic skills of SQL and want to learn further.  I advise you to perform and experiment with examples in <b>pgAdmin</b> 'e, I made all the SQL queries executable without deploying any dumps. <br><br>  Go! <br><a name="habracut"></a><br><h3>  1. Using temporary tables </h3><br>  When solving complex problems, it is difficult to place a solution in one request (although many try to do so).  In such cases, it is convenient to place any intermediate data in a temporary table for later use. <br><br>  Such tables are created as normal, but with the keyword <b>TEMP</b> , and are automatically deleted after the session. <br><br>  The <b>ON COMMIT DROP</b> key automatically deletes the table (and all objects associated with it) when a transaction is completed. <br><br>  <b>Example:</b> <br><pre><code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">ROLLBACK</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">BEGIN</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> TEMP <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> my_fist_temp_table <span class="hljs-comment"><span class="hljs-comment">--      ON COMMIT DROP --      AS SELECT 1 AS id, CAST ('- ' AS TEXT) AS val; ------------    : ------------------ --  ,  .      ALTER TABLE my_fist_temp_table ADD COLUMN is_deleted BOOLEAN NOT NULL DEFAULT FALSE; --  ,    ,       ,       CREATE UNIQUE INDEX ON my_fist_temp_table (lower(val)) WHERE is_deleted = FALSE; --    /,    --      (   )   VAL,     --    UPDATE my_fist_temp_table SET id=id+3; -- /   SELECT * FROM my_fist_temp_table; --COMMIT;</span></span></code> </pre> <br><br><h3>  2. Frequently Used Abbreviated Postgres Syntax </h3><br><ul><li>  Data type conversion. </li></ul><br>  Expression: <br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">CAST</span></span> (<span class="hljs-string"><span class="hljs-string">'365'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> <span class="hljs-built_in"><span class="hljs-built_in">INT</span></span>);</code> </pre> <br>  can be written less cumbersome: <br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> <span class="hljs-string"><span class="hljs-string">'365'</span></span>::<span class="hljs-built_in"><span class="hljs-built_in">INT</span></span>;</code> </pre> <br><ul><li>  Abbreviated construction entry <b>(I) LIKE '% text%'</b> </li></ul><br>  <b>LIKE</b> perceives <u>patterned expressions</u> .  Details <a href="https://www.postgresql.org/docs/9.6/static/functions-matching.html">in the manual</a> <br>  <b>LIKE</b> operator can be replaced by <b>~~</b> (two tildes) <br>  <b>ILIKE</b> operator can be replaced by <b>~~ *</b> (two tildes with an asterisk) <br><br>  <u>Regular expressions</u> search (syntax different from LIKE) <br>  <b>~</b> (one tilde) operator accepts regular expressions <br>  <b>~ *</b> operator (one tilde and asterisk) case-insensitive version <b>~</b> <br><br>  I will give an example of searching in different ways strings that contain the word <i>text</i> <br><table><tbody><tr><th>  Short syntax </th><th>  Description </th><th>  Analog (I) LIKE </th></tr><tr><td>  ~ 'text' <br>  or <br>  ~~ '% text%' </td><td>  Checks if the expression is case sensitive </td><td>  LIKE '% text%' </td></tr><tr><td>  ~ * 'text' <br>  ~~ * '% text%' </td><td>  Checks if the expression is case-insensitive. </td><td>  ILIKE '% text%' </td></tr><tr><td>  ! ~ 'text' <br>  ! ~~ '% text%' </td><td>  Checks case inconsistency </td><td>  NOT LIKE '% text%' </td></tr><tr><td>  ! ~ * 'text' <br>  ! ~~ * '% text%' </td><td>  Checks case-insensitive expression </td><td>  NOT ILIKE '% text%' </td></tr></tbody></table><br><h3>  3. Common table expressions (CTE).  WITH construction </h3><br>  Very convenient design, allows you to put the result of the query in a temporary table and immediately use it. <br><br>  Examples will be primitive to capture the essence. <br><br>  a) Simple <i>SELECT</i> <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">WITH</span></span> cte_table_name <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> ( <span class="hljs-comment"><span class="hljs-comment">--      SELECT schemaname, tablename --    FROM pg_catalog.pg_tables --  ,      ORDER BY 1,2 ) SELECT * FROM cte_table_name; --    --       </span></span></code> </pre> <br>  In this way, you can 'wrap up' any queries (even <i>UPDATE, DELETE</i> and <i>INSERT</i> , this will be discussed below) and use their results in the future. <br><br>  b) You can create multiple tables by listing them as described below. <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">WITH</span></span> table_1 (<span class="hljs-keyword"><span class="hljs-keyword">col</span></span>,b) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span>,<span class="hljs-number"><span class="hljs-number">1</span></span>), <span class="hljs-comment"><span class="hljs-comment">--   table_2 (col,c) AS (SELECT 2,2) --   --,table_3 (cool,yah) AS (SELECT 2,2 from table_2) --   ,       SELECT * FROM table_1 FULL JOIN table_2 USING (col);</span></span></code> </pre> <br>  c) You can even embed the above construction into another (or more) WITH <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">WITH</span></span> super_with (<span class="hljs-keyword"><span class="hljs-keyword">col</span></span>,b,c) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> ( <span class="hljs-comment"><span class="hljs-comment">/*          */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">WITH</span></span> table_1 (<span class="hljs-keyword"><span class="hljs-keyword">col</span></span>,b) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span>,<span class="hljs-number"><span class="hljs-number">1</span></span>), table_2 (<span class="hljs-keyword"><span class="hljs-keyword">col</span></span>,c) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> <span class="hljs-number"><span class="hljs-number">2</span></span>,<span class="hljs-number"><span class="hljs-number">2</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> table_1 <span class="hljs-keyword"><span class="hljs-keyword">FULL</span></span> <span class="hljs-keyword"><span class="hljs-keyword">JOIN</span></span> table_2 <span class="hljs-keyword"><span class="hljs-keyword">USING</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">col</span></span>)<span class="hljs-comment"><span class="hljs-comment">--    ) SELECT col, b*20, c*30 FROM super_with;</span></span></code> </pre> <br>  In terms of performance, it should be said that you should not put data in the <i>WITH</i> section that will be largely filtered by subsequent external conditions (outside the brackets of the query), because the optimizer will not be able to build an effective query.  The most convenient way to put in <i>CTE</i> results that need to be addressed several times. <br><br><h3>  4. Function array_agg (MyColumn). </h3><br>  Values ‚Äã‚Äãare stored in a relational database separately (attributes for one object can be presented in several lines).  To transfer data to any application, it is often necessary to collect data in a single row (cell) or array. <br>  In PostgreSQL, the <b>array_agg ()</b> function exists for this purpose; it allows you to collect data from the entire column into an array (if sampling from one column). <br>  When using <b>GROUP BY</b> , the data of any column relative to each group will be included in the array. <br><br>  Immediately describe another function and move on to an example. <br>  <b>array_to_string (array [], ';')</b> allows you to convert an array into a string: the first parameter is an array, the second is a convenient separator in single quotes (apostrophes).  As a separator you can use <br><div class="spoiler">  <b class="spoiler_title">special characters</b> <div class="spoiler_text">  Tab <b>\ t</b> - for example, will allow to insert values ‚Äã‚Äãinto columns when inserting a cell into EXCEL (use this: <b>array_to_string (array [], E '\ t')</b> ) <br>  Line feed <b>\ n</b> - decomposes the array values ‚Äã‚Äãin rows in one cell (use this: <b>array_to_string (array [], E '\ n')</b> - I will explain below why) </div></div><br>  <b>Example:</b> <br><pre> <code class="sql hljs"><span class="hljs-comment"><span class="hljs-comment">--        WITH my_table (ID, year, any_val) AS ( VALUES (1, 2017,56) ,(2, 2017,67) ,(3, 2017,12) ,(4, 2017,30) ,(5, 2020,8) ,(6, 2030,17) ,(7, 2030,50) ) SELECT year ,array_agg(any_val) --   (  )   ,array_agg(any_val ORDER BY any_val) AS sort_array_agg --     ( 9+  Postgres) ,array_to_string(array_agg(any_val),';') --     ,ARRAY['This', 'is', 'my' , 'array'] AS my_simple_array --    FROM my_table GROUP BY year; --     </span></span></code> </pre> <br>  Will give the result: <br><img src="https://habrastorage.org/web/f1d/fc4/cfe/f1dfc4cfe64e4bd2949046082acf890a.png"><br><br>  Perform the reverse action.  We expand the array into strings using the <b>UNNEST</b> function, and at the same time demonstrate the <i><b>SELECT</b> columns <b>INTO</b> table_name</i> .  I'll put it in the spoiler so that the article doesn't swell too much. <br><div class="spoiler">  <b class="spoiler_title">UNNEST request</b> <div class="spoiler_text"><pre> <code class="sql hljs"><span class="hljs-comment"><span class="hljs-comment">-- 1   --       tst_unnest_for_del,    SELECT INTO --      ,          ,      . --   ,       production  - ,     DROP TABLE IF EXISTS tst_unnest_for_del; /* IF EXISTS   ,       */ WITH my_table (ID, year, any_val) AS ( VALUES (1, 2017,56) ,(2, 2017,67) ,(3, 2017,12) ,(4, 2017,30) ,(5, 2020,8) ,(6, 2030,17) ,(7, 2030,50) ) SELECT year ,array_agg(id) AS arr_id --  (id)      ,array_agg(any_val) AS arr_any_val --  (any_val)      INTO tst_unnest_for_del -- !!         FROM my_table GROUP BY year; --2   Unnest SELECT unnest(arr_id) unnest_id --   id ,year ,unnest(arr_any_val) unnest_any_val --   any_val FROM tst_unnest_for_del ORDER BY 1 --    id,        </span></span></code> </pre> <br>  Result: <br><img src="https://habrastorage.org/web/63a/ca9/1b7/63aca91b7b0748bfa6e462e44424047a.png"><br></div></div><br><h3>  5. Keyword RETURNIG * </h3>  specified after <i>INSERT, UPDATE</i> or <i>DELETE</i> requests allows you to see the lines affected by the modification (usually the server reports only the number of modified lines). <br>  It is convenient in conjunction with <i>BEGIN to</i> look at what exactly the request will affect, in case of uncertainty as a result or to send any <i>id</i> to the next step. <br><br>  <b>Example:</b> <br><pre> <code class="sql hljs"><span class="hljs-comment"><span class="hljs-comment">--1 DROP TABLE IF EXISTS for_del_tmp; /* IF EXISTS   ,       */ CREATE TABLE for_del_tmp --   AS --      SELECT generate_series(1,1000) AS id, --  1000   random() AS values; --    --2 DELETE FROM for_del_tmp WHERE id &gt; 500 RETURNING *; /*     , RETURNING * -     test,        SELECT (. RETURNING id,name)*/</span></span></code> </pre> <br>  Can be used in conjunction with <i>CTE</i> , organizing a <s>crazy</s> example. <br><br><div class="spoiler">  <b class="spoiler_title">PS</b> <div class="spoiler_text">  I was very confused, I'm afraid that it was difficult, but I tried to comment on everything. <br></div></div><br><pre> <code class="sql hljs"><span class="hljs-comment"><span class="hljs-comment">--1 DROP TABLE IF EXISTS for_del_tmp; /* IF EXISTS   ,       */ CREATE TABLE for_del_tmp --   AS --      SELECT generate_series(1,1000) AS id, --  1000   ((random()*1000)::INTEGER)::text as values; /*   . PS   Postgre 9.2 Random()     ,   1000,    ,    INTEGER     ,    , .. ,       TEXT*/ --2 DELETE FROM for_del_tmp WHERE id &gt; 500 RETURNING *; --     ,      --3 WITH deleted_id (id) AS ( DELETE FROM for_del_tmp WHERE id &gt; 25 RETURNING id --    ,  id   CTE "deleted_id" ) INSERT INTO for_del_tmp --  INSERT SELECT id, '   ' || now()::TIME || '    ,  ' || timeofday()::TIMESTAMP /*     ,      (   ,   ,    )*/ FROM deleted_id --     "for_del_tmp"    RETURNING *; --     --    ,         . --4 SELECT * FROM for_del_tmp; -- ,    </span></span></code> </pre> <br>  Thus, the data will be deleted, and the deleted values ‚Äã‚Äãwill be passed to the next stage.  It all depends on your imagination and goals.  Before using complex constructions, be sure to read the documentation of your version of the DBMS!  (when parallel combination INSERT, UPDATE or DELETE there are subtleties) <br><br><h3>  6. Save query result to file </h3><br>  The <b>COPY</b> team has many different parameters and assignments, I will describe the simplest application for familiarization. <br><pre> <code class="sql hljs">COPY ( <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> pg_stat_activity <span class="hljs-comment"><span class="hljs-comment">/*  .  :      */</span></span> <span class="hljs-comment"><span class="hljs-comment">--) TO 'C:/TEMP/my_proc_tst.csv' --     .   Windows ) TO '/tmp/my_proc_tst.csv' --     .   LINUX --) TO STDOUT --       pgAdmin WITH CSV HEADER --  .      </span></span></code> </pre> <br><h3>  7. Run a query on another database </h3><br>  Not so long ago I found out that it is possible to address a request to another database, for this purpose there is a dblink function ( <a href="https://www.postgresql.org/docs/current/static/dblink.html">all details in the manual</a> ) <br><br>  Example: <br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> dblink( <span class="hljs-string"><span class="hljs-string">'host=localhost user=postgres dbname=postgres'</span></span>, <span class="hljs-comment"><span class="hljs-comment">/* host  user   ,      */</span></span> <span class="hljs-string"><span class="hljs-string">'SELECT '' : '' || current_database()'</span></span> <span class="hljs-comment"><span class="hljs-comment">/*     .  ,     ,        (         ). */</span></span> ) <span class="hljs-keyword"><span class="hljs-keyword">RETURNS</span></span> (col_name <span class="hljs-built_in"><span class="hljs-built_in">TEXT</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">UNION</span></span> ALL <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> <span class="hljs-string"><span class="hljs-string">' : '</span></span> || current_database();</code> </pre> <br><img src="https://habrastorage.org/webt/59/e7/a4/59e7a411bc6fb531552380.png"><br><br>  If an error occurs: <blockquote>  "ERROR: function dblink (unknown, unknown) does not exist" </blockquote>  You must install the extension with the following command: <br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> EXTENSION dblink;</code> </pre> <br><h3>  8. Function similarity </h3><br>  The function of determining the similarity of one value to another. <br><br>  Used to compare text data that was similar, but not equal to each other (there were typos).  Saved a lot of time and nerves, minimizing manual binding. <br>  <b>similarity (a, b)</b> gives a fractional number from 0 to 1, the closer to 1, the more accurate the match. <br>  Let's move on to an example.  With the help of <i>WITH we</i> organize a temporary table with fictional data (and specially distorted to demonstrate the function), and we will compare each line with our text.  In the example below, we will look for what looks more like <u>Romashka LLC</u> (we substitute the function in the second parameter). <br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">WITH</span></span> company (<span class="hljs-keyword"><span class="hljs-keyword">id</span></span>,c_name) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> ( <span class="hljs-keyword"><span class="hljs-keyword">VALUES</span></span> (<span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-string"><span class="hljs-string">' '</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">UNION</span></span> ALL <span class="hljs-comment"><span class="hljs-comment">/* PS UNION ALL  ,  UNION, ..      ,        */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">VALUES</span></span> (<span class="hljs-number"><span class="hljs-number">2</span></span>, <span class="hljs-string"><span class="hljs-string">' ""'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">UNION</span></span> ALL <span class="hljs-keyword"><span class="hljs-keyword">VALUES</span></span> (<span class="hljs-number"><span class="hljs-number">3</span></span>, <span class="hljs-string"><span class="hljs-string">' '</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">UNION</span></span> ALL <span class="hljs-keyword"><span class="hljs-keyword">VALUES</span></span> (<span class="hljs-number"><span class="hljs-number">4</span></span>, <span class="hljs-string"><span class="hljs-string">' ""'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">UNION</span></span> ALL <span class="hljs-keyword"><span class="hljs-keyword">VALUES</span></span> (<span class="hljs-number"><span class="hljs-number">5</span></span>, <span class="hljs-string"><span class="hljs-string">' '</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">UNION</span></span> ALL <span class="hljs-keyword"><span class="hljs-keyword">VALUES</span></span> (<span class="hljs-number"><span class="hljs-number">6</span></span>, <span class="hljs-string"><span class="hljs-string">'  '</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">UNION</span></span> ALL <span class="hljs-keyword"><span class="hljs-keyword">VALUES</span></span> (<span class="hljs-number"><span class="hljs-number">7</span></span>, <span class="hljs-string"><span class="hljs-string">'   '</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">UNION</span></span> ALL <span class="hljs-keyword"><span class="hljs-keyword">VALUES</span></span> (<span class="hljs-number"><span class="hljs-number">8</span></span>, <span class="hljs-string"><span class="hljs-string">'ZAO '</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">UNION</span></span> ALL <span class="hljs-keyword"><span class="hljs-keyword">VALUES</span></span> (<span class="hljs-number"><span class="hljs-number">9</span></span>, <span class="hljs-string"><span class="hljs-string">'   ?'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">UNION</span></span> ALL <span class="hljs-keyword"><span class="hljs-keyword">VALUES</span></span> (<span class="hljs-number"><span class="hljs-number">10</span></span>, <span class="hljs-string"><span class="hljs-string">' 33'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">UNION</span></span> ALL <span class="hljs-keyword"><span class="hljs-keyword">VALUES</span></span> (<span class="hljs-number"><span class="hljs-number">11</span></span>, <span class="hljs-string"><span class="hljs-string">' ""'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">UNION</span></span> ALL <span class="hljs-keyword"><span class="hljs-keyword">VALUES</span></span> (<span class="hljs-number"><span class="hljs-number">12</span></span>, <span class="hljs-string"><span class="hljs-string">' " "'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">UNION</span></span> ALL <span class="hljs-keyword"><span class="hljs-keyword">VALUES</span></span> (<span class="hljs-number"><span class="hljs-number">13</span></span>, <span class="hljs-string"><span class="hljs-string">' " "'</span></span>) ) <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> *, similarity(c_name, <span class="hljs-string"><span class="hljs-string">' ""'</span></span>) ,<span class="hljs-keyword"><span class="hljs-keyword">dense_rank</span></span>() <span class="hljs-keyword"><span class="hljs-keyword">OVER</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">ORDER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BY</span></span> similarity(c_name, <span class="hljs-string"><span class="hljs-string">' ""'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">DESC</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> <span class="hljs-string"><span class="hljs-string">" "</span></span> <span class="hljs-comment"><span class="hljs-comment">--  ,      FROM company WHERE similarity(c_name, ' ""') &gt;0.25 --   0  1,    1,    ORDER BY similarity DESC;</span></span></code> </pre> <br>  We get the following result: <br><img src="https://habrastorage.org/web/bfd/f0d/b3e/bfdf0db3e492440ea898baf4ac24cbf6.png"><br><br>  If an error occurs <blockquote>  "ERROR: function similarity (unknown, unknown) does not exist" </blockquote>  You must install the extension with the following command: <br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> EXTENSION pg_trgm;</code> </pre> <br><div class="spoiler">  <b class="spoiler_title">The example is more complicated</b> <div class="spoiler_text"><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">WITH</span></span> company (<span class="hljs-keyword"><span class="hljs-keyword">id</span></span>,c_name) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> ( <span class="hljs-comment"><span class="hljs-comment">--     VALUES (1, ' ') ,(2, ' ""') ,(3, ' ') ,(4, ' ""') ,(5, ' ') ,(6, '  ') ,(7, '   ') ,(8, 'ZAO ') ,(9, '   ?') ,(10, ' 33') ,(11, ' ""') ,(12, ' " "') ,(14, ' " "') ,(13, '   ') ), compare (id, need) AS --     (VALUES (100500, ' ""') ,(9999, ' "  "') ) SELECT c1.id, c1.c_name, '  ' || c2.need, similarity(c1.c_name, c2.need) ,dense_rank() OVER (PARTITION BY c2.need ORDER BY similarity(c1.c_name, c2.need) DESC) AS " " --  ,      FROM company c1 CROSS JOIN compare c2 WHERE similarity(c_name, c2.need) &gt;0.25 --   0  1,    1,    ORDER BY similarity DESC;</span></span></code> </pre> <br>  We get the following result: <br><img src="https://habrastorage.org/web/316/3be/cbe/3163becbe1394a6c823bdf038fafafea.png"></div></div><br>  Sort by <i>similarity desc</i> .  The first results see the most similar lines (1 ‚Äî complete similarity). <br><br>  It is not necessary to display the value of <i>similarity</i> in a <i>SELECT</i> , you can simply use it in the WHERE similarity condition (c_name, 'Romashka LLC')&gt; 0.7 <br>  and set the parameter that suits us. <br><br>  PS I would be grateful if you tell me what else there are ways to compare text data.  I tried to remove everything except letters / numbers with regular expressions, and compare them by equality, but this option does not work if there are typos. <br><br><h3>  9. Window OVER () functions (PARTITION BY __ ORDER BY __) </h3><br>  Almost describing this very powerful tool in his draft, I discovered <s>(with sadness and joy)</s> that a similar quality article on this topic already exists.  I see no reason to duplicate information, so I recommend that you definitely read this article (link - <a href="https://habrahabr.ru/post/268983/">habrahabr.ru/post/268983/</a> , I bow to the author) to those who still do not know how to use window SQL functions. <br><br><h3>  10. A multiple template for LIKE </h3><br>  Task.  You need to filter the list of users whose names should match certain patterns. <br><br>  As always, I will provide the simplest example: <br><pre> <code class="sql hljs"><span class="hljs-comment"><span class="hljs-comment">--     CREATE TEMP TABLE users_tst (id, u_name) AS (VALUES (1::INT, NULL::VARCHAR(50)) ,(2, ' .') ,(3, ' .') ,(4, ' .') ,(5, ' .') ,(6, ' .') ,(7, ' .') ,(8, ' .') ,(9, ' .') );</span></span></code> </pre> <br>  We have a request that performs its function, but becomes cumbersome with a large number of filters. <br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> users_tst <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> u_name <span class="hljs-keyword"><span class="hljs-keyword">LIKE</span></span> <span class="hljs-string"><span class="hljs-string">'%'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">OR</span></span> u_name <span class="hljs-keyword"><span class="hljs-keyword">LIKE</span></span> <span class="hljs-string"><span class="hljs-string">'%%'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">OR</span></span> u_name <span class="hljs-keyword"><span class="hljs-keyword">LIKE</span></span> <span class="hljs-string"><span class="hljs-string">' .'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">OR</span></span> u_name <span class="hljs-keyword"><span class="hljs-keyword">LIKE</span></span> <span class="hljs-string"><span class="hljs-string">'%'</span></span> <span class="hljs-comment"><span class="hljs-comment">--  ..</span></span></code> </pre> <br>  Demonstrate how to make it more compact: <br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> users_tst <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> u_name <span class="hljs-keyword"><span class="hljs-keyword">LIKE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ANY</span></span> (<span class="hljs-built_in"><span class="hljs-built_in">ARRAY</span></span>[<span class="hljs-string"><span class="hljs-string">'%'</span></span>, <span class="hljs-string"><span class="hljs-string">'%%'</span></span>, <span class="hljs-string"><span class="hljs-string">' .'</span></span>, <span class="hljs-string"><span class="hljs-string">'%'</span></span>])</code> </pre> <br>  You can do interesting tricks using a similar approach. <br>  Write in the comments if you have any thoughts on how to rewrite the original query. <br><br><h3>  11. Several useful features </h3><br>  <i>NULLIF (a, b)</i> <br>  There are situations when a certain value must be treated as NULL. <br>  For example, zero-length strings ('' - empty strings) or zero (0). <br>  You can write CASE, but more concisely use the function NULLIF, which has 2 parameters, with equality of which returns NULL, otherwise displays the original value. <br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">id</span></span> ,param ,<span class="hljs-keyword"><span class="hljs-keyword">CASE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">WHEN</span></span> param = <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">THEN</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ELSE</span></span> param <span class="hljs-keyword"><span class="hljs-keyword">END</span></span> <span class="hljs-comment"><span class="hljs-comment">--   CASE ,NULLIF(param,0) --   NULLIF ,val FROM( VALUES( 1, 0, '    0' ) ) AS tst (id,param,val);</span></span></code> </pre> <br>  <i>COALESCE</i> selects the first non-NULL value. <br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">COALESCE</span></span>(<span class="hljs-literal"><span class="hljs-literal">NULL</span></span>,<span class="hljs-literal"><span class="hljs-literal">NULL</span></span>,<span class="hljs-number"><span class="hljs-number">-20</span></span>,<span class="hljs-number"><span class="hljs-number">1</span></span>,<span class="hljs-literal"><span class="hljs-literal">NULL</span></span>,<span class="hljs-number"><span class="hljs-number">-7</span></span>); <span class="hljs-comment"><span class="hljs-comment">-- -20</span></span></code> </pre> <br>  <i>GREATEST</i> selects the highest value listed. <br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">GREATEST</span></span>(<span class="hljs-number"><span class="hljs-number">2</span></span>,<span class="hljs-number"><span class="hljs-number">1</span></span>,<span class="hljs-literal"><span class="hljs-literal">NULL</span></span>,<span class="hljs-number"><span class="hljs-number">5</span></span>,<span class="hljs-number"><span class="hljs-number">7</span></span>,<span class="hljs-number"><span class="hljs-number">4</span></span>,<span class="hljs-number"><span class="hljs-number">-9</span></span>); <span class="hljs-comment"><span class="hljs-comment">-- 7</span></span></code> </pre> <br>  <i>LEAST</i> selects the lowest value listed. <br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">LEAST</span></span>(<span class="hljs-number"><span class="hljs-number">2</span></span>,<span class="hljs-number"><span class="hljs-number">1</span></span>,<span class="hljs-literal"><span class="hljs-literal">NULL</span></span>,<span class="hljs-number"><span class="hljs-number">5</span></span>,<span class="hljs-number"><span class="hljs-number">7</span></span>,<span class="hljs-number"><span class="hljs-number">4</span></span>,<span class="hljs-number"><span class="hljs-number">-9</span></span>); <span class="hljs-comment"><span class="hljs-comment">--  -9</span></span></code> </pre> <br>  <i>PG_TYPEOF</i> indicates the data type of the column. <br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> pg_typeof(<span class="hljs-keyword"><span class="hljs-keyword">id</span></span>), pg_typeof(arr), pg_typeof(<span class="hljs-literal"><span class="hljs-literal">NULL</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">VALUES</span></span> (<span class="hljs-string"><span class="hljs-string">'1'</span></span>::<span class="hljs-built_in"><span class="hljs-built_in">SMALLINT</span></span>, <span class="hljs-built_in"><span class="hljs-built_in">array</span></span>[<span class="hljs-number"><span class="hljs-number">1</span></span>,<span class="hljs-number"><span class="hljs-number">2</span></span>,<span class="hljs-string"><span class="hljs-string">'3'</span></span>,<span class="hljs-number"><span class="hljs-number">3.5</span></span>])) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> x(<span class="hljs-keyword"><span class="hljs-keyword">id</span></span>,arr); <span class="hljs-comment"><span class="hljs-comment">--  smallint, numeric[]  unknown </span></span></code> </pre> <br>  <i>PG_CANCEL_BACKEND</i> stop unwanted processes in the database <br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> pid, <span class="hljs-keyword"><span class="hljs-keyword">query</span></span>, * <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> pg_stat_activity <span class="hljs-comment"><span class="hljs-comment">--    .    postgres  PID  PROCPID WHERE state &lt;&gt; 'idle' and pid &lt;&gt; pg_backend_pid(); --         SELECT pg_terminate_backend(PID); /*   PID     ,     ,      ,      */ SELECT pg_cancel_backend(PID); /*   PID     .    , -  KILL -9  LINUX */</span></span></code> </pre><br>  More in the <a href="https://www.postgresql.org/docs/9.6/static/functions-admin.html">manual</a> <br><div class="spoiler">  <b class="spoiler_title">PS</b> <div class="spoiler_text"><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> pg_cancel_backend(pid) <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> pg_stat_activity <span class="hljs-comment"><span class="hljs-comment">--      WHERE state &lt;&gt; 'idle' and pid &lt;&gt; pg_backend_pid();</span></span></code> </pre> <br>  Attention!  Do not kill the hung process through the KILL-9 console or task manager. <br>  This can lead to the collapse of the database, data loss and long automatic database recovery. </div></div><br><br><h3>  12. Escaping characters </h3><br>  I'll start with the basics. <br>  In SQL, string values ‚Äã‚Äãare framed with an apostrophe (single quote). <br>  Numeric values ‚Äã‚Äãcan not be framed with apostrophes, and to separate the fractional part, you must use a point, because  comma will be interpreted as a delimiter <br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> <span class="hljs-string"><span class="hljs-string">' '</span></span>, <span class="hljs-number"><span class="hljs-number">365</span></span>, <span class="hljs-number"><span class="hljs-number">567.6</span></span>, <span class="hljs-number"><span class="hljs-number">567</span></span>,<span class="hljs-number"><span class="hljs-number">6</span></span></code> </pre> <br>  result: <br><img src="https://habrastorage.org/webt/59/e7/ad/59e7adb52b493968737658.png"><br><br>  All is well, until it is required to display the apostrophe sign itself <b>.</b> <br>  For this there are two shielding methods (known to me) <br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-string"><span class="hljs-string">' ''     '''' '</span></span> <span class="hljs-comment"><span class="hljs-comment">--    '' UNION ALL SELECT 2, E' \'     \'\' ' --   , ,   E    ,   \    </span></span></code> </pre> <br>  The result is the same: <br><img src="https://habrastorage.org/webt/59/e7/b6/59e7b61fcb105595751388.png"><br><br>  In <i>PostgreSQL,</i> there is a more convenient way to use data, without escaping characters.  You can use almost any character in the line framed with two dollar signs <b>$$</b> . <br><br>  Example: <br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">select</span></span> $$  <span class="hljs-string"><span class="hljs-string">''</span></span>     <span class="hljs-string"><span class="hljs-string">',    E'</span></span>\<span class="hljs-string"><span class="hljs-string">' $$</span></span></code> </pre> <br>  I get the data in its original form: <br><img src="https://habrastorage.org/webt/59/e7/ba/59e7ba4f1387c200244354.png"><br><br>  If this is not enough, and inside you need to use two dollar symbols in a row <b>$$</b> , then Postgres allows you to set your own "limiter".  It is only between two dollars to write your own text, for example: <br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">select</span></span> $uniq_tAg$   <span class="hljs-string"><span class="hljs-string">''</span></span>     <span class="hljs-string"><span class="hljs-string">',    E'</span></span>\<span class="hljs-string"><span class="hljs-string">',   $$  $any_text$ $uniq_tAg$</span></span></code> </pre> <br>  We will see our text: <br><img src="https://habrastorage.org/webt/59/e7/bf/59e7bfaa35a92182219362.png"><br><br>  For myself, this method was discovered not so long ago, when I began to study the writing of functions. <br><br><h3>  Conclusion </h3><br>  I hope this material will help learn a lot of new beginners and "srednichkam."  I myself am not a developer, and I can only call myself a SQL buff, so it‚Äôs up to you how to use the described techniques. <br><br>  I wish you success in learning SQL.  I am waiting for comments and thank you for reading! <br>  <b>UPD</b> .  <a href="https://habr.com/post/423097/">There was a sequel</a> </div><p>Source: <a href="https://habr.com/ru/post/340460/">https://habr.com/ru/post/340460/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../340446/index.html">OpenShift.IO: all-in-one development platform and CI / CD</a></li>
<li><a href="../340448/index.html">Arduino brain: pulse position sensor</a></li>
<li><a href="../340454/index.html">Start of the competition MERC-2017 from the Neurodata Lab</a></li>
<li><a href="../340456/index.html">Empowered pull requests</a></li>
<li><a href="../340458/index.html">How to check if the pointer value is in the specified memory area</a></li>
<li><a href="../340462/index.html">SoundCloud Sound Quality Study</a></li>
<li><a href="../340464/index.html">SALI is your ~ programming language</a></li>
<li><a href="../340466/index.html">How to calculate (user city) by IP</a></li>
<li><a href="../340474/index.html">How was DevFest Siberia 2017</a></li>
<li><a href="../340476/index.html">User Convenience in Virtual Reality Solutions - VRMonkey Tips</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>