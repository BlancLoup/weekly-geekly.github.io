<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Implementing mp3 filter for 7-Zip archiver</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="For a long time my only archiver is the 7-Zip program. I like its compression ratio and speed, so I use it almost everywhere: to compress software dis...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Implementing mp3 filter for 7-Zip archiver</h1><div class="post__text post__text-html js-mediator-article">  For a long time my only archiver is the 7-Zip program.  I like its compression ratio and speed, so I use it almost everywhere: to compress software distributions, to archive collections of pictures, as well as to store music releases.  I download music from online non-commercial labels, where it most often comes in the form of an archive (zip or rar) containing compositions and cover art.  After downloading, the archives are clamped by the 7-Zip program and stored in this form on the hard disk.  To listen to music, the archives do not need to be unpacked, since modern players can play music directly from them (in particular, I use Foobar2000).  And although the total amount of memory occupied by all the archives is still far from the capacity of the hard drive, I began to be occupied with the idea of ‚Äã‚Äãimproving the compression ratio of mp3 files.  As one teacher said, a task is an unsatisfied feeling of anxiety;  and it was exactly the feeling that I experienced.  I did not want to invent my recoder, so it was decided to try to write a filter that removes any redundant information. <br><br><a name="habracut"></a><br><h3>  Analysis of the conditions of the problem </h3><br>  By mp3, we will mean MPEG-1/2 / 2.5 Layer 3. Let's see what an mp3 file is. <br>  So, an mp3 file consists of a set of frames, and the frames can be connected with each other, that is, to decode one frame, you may need to look into another.  There may be tags in the file, both before and after the audio data.  Each frame stores 1152 samples (for stereo mode) and has a duration of 26 ms.  The frame size depends on the bit rate and sample rate used, and is calculated using the following formula: <br><br><img src="https://habrastorage.org/getpro/geektimes/post_images/6a4/7c3/3c4/6a47c33c4a961f5c7338a962985fa422.jpg"><br>  Padding is a special flag in the frame header indicating that the frame is supplemented with one byte. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      The frame consists of a header, a verification code (optional), information necessary for decoding samples (we will call this information ‚Äúside info‚Äù, since I could not come up with an acceptable Russian translation of this phrase), the actual samples themselves, and no additional data direct relationship to the coded samples: <br><br><img src="https://habrastorage.org/getpro/geektimes/post_images/1d7/cf8/309/1d7cf830924f0b4577263e83ef5ad647.jpg"><br><br>  The header, 32 bits in size, has the following structure: <br><table><tbody><tr><th>  Title </th><th>  Field length </th><th>  Purpose </th></tr><tr><td>  Sync word </td><td>  eleven </td><td>  Used to search for a title.  All 11 bits are set to ‚Äú1‚Äù </td></tr><tr><td>  MPEG version </td><td>  2 </td><td></td></tr><tr><td>  Layer index </td><td>  2 </td><td></td></tr><tr><td>  Protection bit </td><td>  one </td><td>  If not set, then CRC is present in the frame. </td></tr><tr><td>  Bit rate index </td><td>  four </td><td></td></tr><tr><td>  Sample Rate Index </td><td>  2 </td><td></td></tr><tr><td>  Padding bit </td><td>  one </td><td>  The same flag signaling that the frame is supplemented with one byte. </td></tr><tr><td>  Private bit </td><td>  one </td><td>  Carries any specific information. </td></tr><tr><td>  Channel coding mode </td><td>  2 </td><td>  Can be mono, stereo, joint stereo, dual channel </td></tr><tr><td>  Mode extension </td><td>  2 </td><td>  Used in the joint stereo channel coding mode </td></tr><tr><td>  Copyright bit </td><td>  one </td><td>  If this bit is set, it means that copying a file is illegal </td></tr><tr><td>  Original bit </td><td>  one </td><td>  If this bit is set, it means that the file is on its original media. </td></tr><tr><td>  Emphasis </td><td>  2 </td><td>  Tells the decoder that additional audio processing is required. </td></tr></tbody></table><br><br>  In practice, some header fields are not used and / or remain the same throughout the mp3 file.  For example, MPEG version, layer index, private bit, copy bit, original bit, etc.  If the file was created using a constant bit rate (CBR), then the bitrate index field does not change. <br>  The first thought is that it is not necessary to store all the fields of the frame header, but only those that change throughout the file.  Remaining fields that do not change can be saved only once.  Walking through the headings of all frames, you can collect statistics and identify the fields that are actually used. <br><br>  Immediately after the title can be located the verification code CRC.  It is a 16-bit integer, calculated using the CRC16 algorithm for the last 16 bits of the frame header and for all side info bytes. <br>  The second thought is that since we know how to calculate the verification code, then it can not be stored.  Of course, just like that, we don‚Äôt have the right to take the CRC out of the frame and throw it out.  First you need to make sure that it represents the correct value, because an error could creep into the verification code itself or the bytes by which it is calculated. <br><br>  I will not dwell on the anatomy of side info.  Side info is a fairly complex structure with many fields that vary in each frame.  Rotate the same trick with the side info fields, as with the frame header fields will not work. <br><br>  The side info is followed by audio data compressed by the Huffman code.  In fact, this is not quite the case, since Huffman codes alternate with scale factors (scale factors), but for simplicity, we assume that audio data is located after side info and to the end of the frame. <br><br>  Between frames there can be any other data, if only among these data there were no signature of the frame header (Sync word). <br><br><h3>  Algorithm </h3><br>  After studying the source code of 7-Zip, I came across the implementation of the BCJ2 filter, designed to improve the compression of executable files (* .exe, * .dll).  A distinctive feature of this filter is that it has one input and four outputs.  Each encoder has its own encoder.  Thus, it turns out that the input file is divided into 4 streams and each stream is compressed by its own separate encoder. <br><br>  I liked the idea of ‚Äã‚Äãseveral outputs and decided to apply it in my filter: <br>  - pack frame header fields in one thread in accordance with the first thought <br>  - side info packaging in the second stream <br>  - and, finally, pack the rest of the information into the third thread: tags and Huffman codes <br><br>  The first two streams are compressed using the LZMA algorithm with the settings used inside 7-Zip to compress the archive headers, and the third stream is compressed by the algorithm selected by users in the Add to Archive window. <br><br>  The encoder works like this: all frames of the file are iterated.  The frame is divided into three parts: side info is sent to the side info stream, Huffman codes are sent to the main output stream, and header fields are stored in the buffer.  If there is a CRC in the frame and it turns out to be true, then it is skipped, otherwise its value is overwritten into the stream of headers so that when unpacking it can be restored. <br>  Sync word (11 bits) of each header is simply thrown away.  The values ‚Äã‚Äãof the fields that did not change during the file are written to the header stream only once, while the changing fields are written sequentially one after the other. <br><br>  The decoder mirrors the encoder: first, all headers are restored, then the restoration of each frame begins.  It is calculated or restored from the first CRC stream, followed by side info and the rest of the frame. <br><br><h3>  Implementation and practical results </h3><br>  The implementation does not constitute anything particularly complicated and therefore I don‚Äôt see the point here.  Sources are laid out <a href="https://github.com/Duny/mp3coder">on githaba</a> .  I will only note that the support for such filters (with one input and several outputs) in 7-Zip is not transparent enough and I had to climb inside 7-Zip, not without soap, in particular, into the 7zUpdate.cpp file.  Yes, by the way, the source code for the development of the filter was 7-Zip 9.20. <br>  The compiled dll is on the same <a href="">github</a> .  It needs to replace 7z.dll in the folder where you have 7-Zip installed. <br><br>  Testing was carried out on a sample of 1351 files with a total volume of 16755839778 bytes (15.605 GB), on a computer with Windows XP operating system, Intel Core 2 6700 processor (2.66 GHz) and three gigs of RAM.  Each file was individually compressed into the archive and unpacked.  First without using a filter, then with a filter.  Everywhere compression level Ultra was used. <br><br><table><tbody><tr><th></th><th>  Without a filter </th><th>  With filter </th></tr><tr><td>  Total amount of compressed data </td><td>  16300442691 bytes (15.181 GB) </td><td>  16064243440 bytes (14.961 GB) </td></tr><tr><td>  Total time spent on packaging </td><td>  12181.09 seconds </td><td>  11273.47 sec </td></tr><tr><td>  Total time spent unpacking </td><td>  3215.44 sec </td><td>  2744.76 seconds </td></tr></tbody></table><br><br>  Filter allowed to save: <br>  - 236199251 bytes (~ 225 MB) of memory on the hard disk <br>  - 908 seconds (~ 15 minutes) on the package <br>  - 407 seconds (~ 8 minutes) unpacking <br><br>  As you can see, the packing speed increased by 8%, and the unpacking speed by as much as 15%. <br><br><h3>  Conclusion </h3><br>  The filter improved the compression ratio of mp3 files by 1.5%.  You can‚Äôt call this result outstanding, but also bad, because the filter works with compressed data. <br>  That's all.  Thanks for attention. </div><p>Source: <a href="https://habr.com/ru/post/125336/">https://habr.com/ru/post/125336/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../125323/index.html">Unemployment in Silicon Valley vs. rest of America or is grass really greener on the other side?</a></li>
<li><a href="../125325/index.html">YouTube Hangouts Live on Google+ Hangouts</a></li>
<li><a href="../125326/index.html">Nintendo has sales problems with Nintendo 3DS</a></li>
<li><a href="../125327/index.html">How much did you score on testyourvocab.com? (The statistics is interesting for users of Habr).</a></li>
<li><a href="../125334/index.html">Soros Foundation encourages grant recipients to use Creative Commons</a></li>
<li><a href="../125337/index.html">2GIS runs an API with data on 1,000,000 organizations and the opportunity to earn</a></li>
<li><a href="../125338/index.html">Audit "Black box"</a></li>
<li><a href="../125340/index.html">Overview of php-frontend of Zabbix monitoring system</a></li>
<li><a href="../125341/index.html">New PHP documentation translation tool: edit.php.net</a></li>
<li><a href="../125342/index.html">Which text formatting option is most convenient for you (in forums, social networks, blogs, etc.)</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>