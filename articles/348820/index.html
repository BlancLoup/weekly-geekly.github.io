<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Game development under NES in C. Chapters 7-10. Work with the joystick. Sprite collisions</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Gently moving to writing a game. This part describes how to work with joysticks and sprite collisions. 


 <<< previous next >>> 


  
 A source 
 Use...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Game development under NES in C. Chapters 7-10. Work with the joystick. Sprite collisions</h1><div class="post__text post__text-html js-mediator-article"><p>  Gently moving to writing a game.  This part describes how to work with joysticks and sprite collisions. </p><br><p>  <a href="https://habrahabr.ru/post/348212/">&lt;&lt;&lt; previous</a> <a href="https://habrahabr.ru/post/349376/">next &gt;&gt;&gt;</a> </p><br><p> <a href="https://habrahabr.ru/post/348820/"><img src="https://habrastorage.org/getpro/habr/post_images/b9d/aa4/d4d/b9daa4d4d1e3e0be3297624cd35adf0d.png" alt="image"></a> <br>  <a href="https://qfox.nl/weblog/232">A source</a> </p><br><h4 id="polzovatelskiy-vvod">  User input </h4><br><p>  Working with joysticks is pretty simple.  Pressing the buttons of the first joystick is read at $ 4016, and the second - $ 4017.  It is enough to read once per frame, immediately after updating the PPU and setting the scroll. </p><a name="habracut"></a><br><p>  I always bring two variables to each joystick: for the buttons pressed now and for pressing in the last frame.  To get the buttons pressed, you need to write down $ 4016 first 1 and then 0. Then read 8 values ‚Äã‚Äãfrom there - these will be the values ‚Äã‚Äãcorresponding to the button presses on the joystick.  They will exit in order A, B, Select, Start, Up, Down, Left, Right.  They are convenient to keep the bit shift and logical operations. </p><br><p>  It is also convenient to define bit masks for buttons.  This will allow receiving events with fast and visual bitwise operations. </p><br><div class="spoiler">  <b class="spoiler_title">Defaults for buttons</b> <div class="spoiler_text"><pre><code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> RIGHT 0x01 #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> LEFT 0x02 #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> DOWN 0x04 #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> UP 0x08 #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> START 0x10 #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> SELECT 0x20 #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> B_BUTTON 0x40 #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> A_BUTTON 0x80</span></span></code> </pre> </div></div><br><p>  Use the meta-list from the last lesson and move it around the screen.  This piece was much more convenient to write in Assembler, there is no need to delve into it. </p><br><p>  To call an assembler function from C code, we need its prototype.  Linker will bring them together at his compilation stage. </p><br><p> <code>void Get_Input(void);</code> </p> <br><p>  It is not necessary to declare a function as void, it is more for uniformity of code.  I strongly recommend using __fastcall__, because in this case the last (or only) argument will be passed through registers A and X - this is faster than through the stack.  The 8-bit argument is passed through the register A, 16-bit - in the A / X pair, 32-bit - A / X / sreg, where sreg is the 16-bit variable in the zero memory page.  Details are described in <a href="http://wiki.cc65.org/doku.php%3Fid%3Dcc65:parameter_passing_and_calling_conventions">the compiler documentation</a> . </p><br><p>  But back to Get_Input ().  If we call this function once after each frame, then it will assemble and bring all the keystrokes into a convenient format. </p><br><p>  Now you can move the little man around the screen with the joystick.  All assembly code is moved to the file asm4c.s.  Build scripts are also corrected.  And the joystick event handler is in a separate function: </p><br><div class="spoiler">  <b class="spoiler_title">Push handler code</b> <div class="spoiler_text"><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">move_logic</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">void</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ((joypad1 &amp; RIGHT) != <span class="hljs-number"><span class="hljs-number">0</span></span>){ state = Going_Right; ++X1; } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ((joypad1 &amp; LEFT) != <span class="hljs-number"><span class="hljs-number">0</span></span>){ state = Going_Left; --X1; } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ((joypad1 &amp; DOWN) != <span class="hljs-number"><span class="hljs-number">0</span></span>){ state = Going_Down; ++Y1; } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ((joypad1 &amp; UP) != <span class="hljs-number"><span class="hljs-number">0</span></span>){ state = Going_Up; --Y1; } }</code> </pre> </div></div><br><p>  Source: <br>  <a href="">Dropbox</a> <br>  <a href="https://github.com/BubaVV/nesdoug">Github</a> </p><br><h4 id="kollizii-spraytov">  Sprite collisions </h4><br><p>  The easiest way to detect the collision of two sprites.  Here we will consider the metasprite with the size of 16x16 points.  In principle, this can be considered a standard for most NES games. </p><br><p>  Collision detection is implemented by comparing the coordinates of the edges of objects.  It turns out a bunch of fairly obvious comparisons.  It is convenient to determine the positions of the sprites through the coordinate of the upper left corner, and then calculate the borders.  It looks like this: </p><br><div class="spoiler">  <b class="spoiler_title">Sprites collision detection</b> <div class="spoiler_text"><pre> <code class="cpp hljs">A_left_side_X = A_X + <span class="hljs-number"><span class="hljs-number">3</span></span>; <span class="hljs-comment"><span class="hljs-comment">//   -      A_right_side_X = A_X + 12; //   A_top_Y = A_Y; //  A_bottom_Y = A_Y + 15; //  //    if (A_left_side_X &lt;= B_right_side_X &amp;&amp; A_right_side_X &gt;= B_left_side_X &amp;&amp; A_top_Y &lt;= B_bottom_Y &amp;&amp; A_bottom_Y &gt;= B_top_Y){ //    }</span></span></code> </pre> </div></div><br><p>  Left indent is needed for correct processing of a blank edge. </p><br><p><img src="https://habrastorage.org/getpro/habr/post_images/0e0/0ec/2ec/0e00ec2ec66bd1de0509e7e7675a2367.png" alt="image"></p><br><p>  But integer overflow will give us a nasty surprise.  If the sprite leaves on the right edge of the screen, to the A_X = 250 area, then A_X + 12 = 6, and this is obviously wrong.  We need to check the edges and assign the value 255 in case of overflow. This is not ideal, but it works well.  It is possible to add a 16-bit variable under the coordinate, but inefficiently - the check code on collisions is performed for many sprites every frame, and the 6502 processor is not strong in such large numbers.  Or you can forcefully limit the approach of the sprites to the edges. </p><br><pre> <code class="cpp hljs"> A_left_side_X = A_X + <span class="hljs-number"><span class="hljs-number">3</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (A_left_side_X &lt; A_X) A_left_side_X = <span class="hljs-number"><span class="hljs-number">255</span></span>; <span class="hljs-comment"><span class="hljs-comment">//       </span></span></code> </pre> <br><p>  In the following example, object B will move by itself with the code from the previous chapter, and A will be controlled by a joystick.  Each time you touch them, the counter will increase by 1. The check will take place once per frame.  We will store the counter as an integer variable for each digit of the counter and do manual transfers. </p><br><div class="spoiler">  <b class="spoiler_title">Collision counter</b> <div class="spoiler_text"><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (score5 &gt; <span class="hljs-number"><span class="hljs-number">9</span></span>){ ++score4; score5 = <span class="hljs-number"><span class="hljs-number">0</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (score4 &gt; <span class="hljs-number"><span class="hljs-number">9</span></span>){ ++score3; score4 = <span class="hljs-number"><span class="hljs-number">0</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (score3 &gt; <span class="hljs-number"><span class="hljs-number">9</span></span>){ ++score2; score3 = <span class="hljs-number"><span class="hljs-number">0</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (score2 &gt; <span class="hljs-number"><span class="hljs-number">9</span></span>){ ++score1; score2 = <span class="hljs-number"><span class="hljs-number">0</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (score1 &gt; <span class="hljs-number"><span class="hljs-number">9</span></span>){ <span class="hljs-comment"><span class="hljs-comment">//     score1 = 0; score2 = 0; score3 = 0; score4 = 0; score5 = 0; }</span></span></code> </pre> </div></div><br><p>  Each time the counter is updated, a flag is set, according to which the counter is redrawn in the next frame.  We can change sprites only during the V-blank period.  This event is caught through the NMI handler. </p><br><div class="spoiler">  <b class="spoiler_title">Counter rendering</b> <div class="spoiler_text"><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">PPU_Update</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">void</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> </span></span>{ PPU_ADDRESS = <span class="hljs-number"><span class="hljs-number">0x20</span></span>; PPU_ADDRESS = <span class="hljs-number"><span class="hljs-number">0x8c</span></span>; PPU_DATA = score1+<span class="hljs-number"><span class="hljs-number">1</span></span>; <span class="hljs-comment"><span class="hljs-comment">//   ,  - "0",  - "1",    PPU_DATA = score2+1; //          PPU_DATA = score3+1; PPU_DATA = score4+1; PPU_DATA = score5+1; }</span></span></code> </pre> </div></div><br><p><img src="https://habrastorage.org/getpro/habr/post_images/4e0/bff/813/4e0bff8130d98e26010edd37da99e179.png" alt="image"></p><br><p>  <a href="">Dropbox</a> <br>  <a href="https://github.com/BubaVV/nesdoug">Github</a> </p><br><h4 id="otrisovka-fona-celikom">  Entire background drawing </h4><br><p>  Now we can show sprites - in the period of V-blank or forcibly turning off the screen.  V-blank is only enough for 2 rows of tiles, and in the second case, you need to skip a couple of frames for a full redraw - the screen will fill with the default background. </p><br><p>  The second option is simpler and requires less code.  It is very convenient to draw backgrounds in the NES Screen Tool, and it supports saving name tables with RLE compression.  They are unpacked by a simple decoder in Assembler.  We will not go into details, but take the ready-made code. </p><br><p>  We will change the background when you click Start on the joystick.  Also, make sure that with a long press of the button, the drawing is done only once - otherwise several launches of the render may overlap, which is oh. </p><br><p>  The logic is something like this: </p><br><ol><li>  Read joystick registers every frame </li><li>  If Start is pressed in this frame, and for the frame before it was not pressed ... </li><li>  Set the screen blanking flag </li><li>  In the nearest V-blank screen extinguish </li><li>  Render everything you need </li><li>  In the next V-blank turn on the screen </li></ol><br><div class="spoiler">  <b class="spoiler_title">Drawing the entire screen background</b> <div class="spoiler_text"><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Draw_Background</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">void</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> </span></span>{ All_Off(); PPU_ADDRESS = <span class="hljs-number"><span class="hljs-number">0x20</span></span>; <span class="hljs-comment"><span class="hljs-comment">//  $2000 =    #0 PPU_ADDRESS = 0x00; UnRLE(All_Backgrounds[which_BGD]); //   Wait_Vblank(); //   ,    V-blank All_On(); ++which_BGD; if (which_BGD == 4) //    which_BGD = 0; } const unsigned char * const All_Backgrounds[]={n1,n2,n3,n4}; //    </span></span></code> </pre> </div></div><br><p><img src="https://habrastorage.org/getpro/habr/post_images/372/394/8ed/3723948ed05af8d07cccadca3f1151b5.png" alt="image"></p><br><p>  Code: <br>  <a href="">Dropbox</a> <br>  <a href="https://github.com/BubaVV/nesdoug">Github</a> </p><br><h4 id="kollizii-s-fonom">  Background collisions </h4><br><p>  Slightly more difficult to track collisions of sprites with the background.  We will accept by default that we use 16x16 square metatayles, and sprites of the same size.  Most games use this scheme.  The sprite will move to one of the four sides at 1 pixel per frame, and each frame will check for collisions. </p><br><p>  Usually, the sprite moves first, checks for contact, and this touch is processed.  We will distribute it in two coordinates - first we will shift and check horizontally, and then vertically. </p><br><p>  Reading from PPU is a pain.  It is necessary to calculate the address of the current name table, and request it from PPU during V-blank, so that there is enough time to work the game logic and update sprites.  We will not do that. </p><br><p>  We need to store the map of background metatails in one RAM page.  The same map can be used to quickly calculate collisions, if there are only two types of tiles - we make the zero passable for the character, and the first is not.  If you need more types of tiles, then the table of terrain should be stored separately.  In principle, the cards can be stored in the ROM cartridge. </p><br><p>  A collision map can be conveniently created in the Tiled editor.  Metatails (all two) are drawn in the NES Screen Tool and transferred to Tiled through a cropped up to 256x256.  He can export to .csv - one per background.  This file had to be slightly corrected - to add the title of the constant </p><br><div class="spoiler">  <b class="spoiler_title">The map is ready for import.</b> <div class="spoiler_text"><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">unsigned</span></span> <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> c2[]={ <span class="hljs-number"><span class="hljs-number">0</span></span>,<span class="hljs-number"><span class="hljs-number">0</span></span>,<span class="hljs-number"><span class="hljs-number">0</span></span>,<span class="hljs-number"><span class="hljs-number">0</span></span>,<span class="hljs-number"><span class="hljs-number">0</span></span>,<span class="hljs-number"><span class="hljs-number">0</span></span>,<span class="hljs-number"><span class="hljs-number">0</span></span>,<span class="hljs-number"><span class="hljs-number">0</span></span>,<span class="hljs-number"><span class="hljs-number">0</span></span>,<span class="hljs-number"><span class="hljs-number">0</span></span>,<span class="hljs-number"><span class="hljs-number">0</span></span>,<span class="hljs-number"><span class="hljs-number">0</span></span>,<span class="hljs-number"><span class="hljs-number">0</span></span>,<span class="hljs-number"><span class="hljs-number">0</span></span>,<span class="hljs-number"><span class="hljs-number">0</span></span>,<span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>,<span class="hljs-number"><span class="hljs-number">0</span></span>,<span class="hljs-number"><span class="hljs-number">0</span></span>,<span class="hljs-number"><span class="hljs-number">0</span></span>,<span class="hljs-number"><span class="hljs-number">0</span></span>,<span class="hljs-number"><span class="hljs-number">0</span></span>,<span class="hljs-number"><span class="hljs-number">0</span></span>,<span class="hljs-number"><span class="hljs-number">0</span></span>,<span class="hljs-number"><span class="hljs-number">0</span></span>,<span class="hljs-number"><span class="hljs-number">0</span></span>,<span class="hljs-number"><span class="hljs-number">0</span></span>,<span class="hljs-number"><span class="hljs-number">0</span></span>,<span class="hljs-number"><span class="hljs-number">0</span></span>,<span class="hljs-number"><span class="hljs-number">0</span></span>,<span class="hljs-number"><span class="hljs-number">0</span></span>,<span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>,<span class="hljs-number"><span class="hljs-number">0</span></span>,<span class="hljs-number"><span class="hljs-number">0</span></span>,<span class="hljs-number"><span class="hljs-number">0</span></span>,<span class="hljs-number"><span class="hljs-number">0</span></span>,<span class="hljs-number"><span class="hljs-number">0</span></span>,<span class="hljs-number"><span class="hljs-number">0</span></span>,<span class="hljs-number"><span class="hljs-number">0</span></span>,<span class="hljs-number"><span class="hljs-number">0</span></span>,<span class="hljs-number"><span class="hljs-number">0</span></span>,<span class="hljs-number"><span class="hljs-number">0</span></span>,<span class="hljs-number"><span class="hljs-number">0</span></span>,<span class="hljs-number"><span class="hljs-number">0</span></span>,<span class="hljs-number"><span class="hljs-number">0</span></span>,<span class="hljs-number"><span class="hljs-number">0</span></span>,<span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>,<span class="hljs-number"><span class="hljs-number">0</span></span>,<span class="hljs-number"><span class="hljs-number">0</span></span>,<span class="hljs-number"><span class="hljs-number">0</span></span>,<span class="hljs-number"><span class="hljs-number">0</span></span>,<span class="hljs-number"><span class="hljs-number">1</span></span>,<span class="hljs-number"><span class="hljs-number">0</span></span>,<span class="hljs-number"><span class="hljs-number">0</span></span>,<span class="hljs-number"><span class="hljs-number">1</span></span>,<span class="hljs-number"><span class="hljs-number">0</span></span>,<span class="hljs-number"><span class="hljs-number">0</span></span>,<span class="hljs-number"><span class="hljs-number">0</span></span>,<span class="hljs-number"><span class="hljs-number">0</span></span>,<span class="hljs-number"><span class="hljs-number">0</span></span>,<span class="hljs-number"><span class="hljs-number">0</span></span>,<span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>,<span class="hljs-number"><span class="hljs-number">0</span></span>,<span class="hljs-number"><span class="hljs-number">0</span></span>,<span class="hljs-number"><span class="hljs-number">0</span></span>,<span class="hljs-number"><span class="hljs-number">0</span></span>,<span class="hljs-number"><span class="hljs-number">1</span></span>,<span class="hljs-number"><span class="hljs-number">0</span></span>,<span class="hljs-number"><span class="hljs-number">0</span></span>,<span class="hljs-number"><span class="hljs-number">1</span></span>,<span class="hljs-number"><span class="hljs-number">0</span></span>,<span class="hljs-number"><span class="hljs-number">0</span></span>,<span class="hljs-number"><span class="hljs-number">0</span></span>,<span class="hljs-number"><span class="hljs-number">0</span></span>,<span class="hljs-number"><span class="hljs-number">0</span></span>,<span class="hljs-number"><span class="hljs-number">0</span></span>,<span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>,<span class="hljs-number"><span class="hljs-number">0</span></span>,<span class="hljs-number"><span class="hljs-number">0</span></span>,<span class="hljs-number"><span class="hljs-number">0</span></span>,<span class="hljs-number"><span class="hljs-number">0</span></span>,<span class="hljs-number"><span class="hljs-number">1</span></span>,<span class="hljs-number"><span class="hljs-number">0</span></span>,<span class="hljs-number"><span class="hljs-number">0</span></span>,<span class="hljs-number"><span class="hljs-number">1</span></span>,<span class="hljs-number"><span class="hljs-number">0</span></span>,<span class="hljs-number"><span class="hljs-number">0</span></span>,<span class="hljs-number"><span class="hljs-number">0</span></span>,<span class="hljs-number"><span class="hljs-number">0</span></span>,<span class="hljs-number"><span class="hljs-number">0</span></span>,<span class="hljs-number"><span class="hljs-number">0</span></span>,<span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>,<span class="hljs-number"><span class="hljs-number">0</span></span>,<span class="hljs-number"><span class="hljs-number">0</span></span>,<span class="hljs-number"><span class="hljs-number">0</span></span>,<span class="hljs-number"><span class="hljs-number">0</span></span>,<span class="hljs-number"><span class="hljs-number">0</span></span>,<span class="hljs-number"><span class="hljs-number">0</span></span>,<span class="hljs-number"><span class="hljs-number">0</span></span>,<span class="hljs-number"><span class="hljs-number">0</span></span>,<span class="hljs-number"><span class="hljs-number">0</span></span>,<span class="hljs-number"><span class="hljs-number">0</span></span>,<span class="hljs-number"><span class="hljs-number">0</span></span>,<span class="hljs-number"><span class="hljs-number">0</span></span>,<span class="hljs-number"><span class="hljs-number">0</span></span>,<span class="hljs-number"><span class="hljs-number">0</span></span>,<span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>,<span class="hljs-number"><span class="hljs-number">0</span></span>,<span class="hljs-number"><span class="hljs-number">0</span></span>,<span class="hljs-number"><span class="hljs-number">1</span></span>,<span class="hljs-number"><span class="hljs-number">0</span></span>,<span class="hljs-number"><span class="hljs-number">0</span></span>,<span class="hljs-number"><span class="hljs-number">0</span></span>,<span class="hljs-number"><span class="hljs-number">0</span></span>,<span class="hljs-number"><span class="hljs-number">0</span></span>,<span class="hljs-number"><span class="hljs-number">0</span></span>,<span class="hljs-number"><span class="hljs-number">1</span></span>,<span class="hljs-number"><span class="hljs-number">0</span></span>,<span class="hljs-number"><span class="hljs-number">0</span></span>,<span class="hljs-number"><span class="hljs-number">0</span></span>,<span class="hljs-number"><span class="hljs-number">0</span></span>,<span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>,<span class="hljs-number"><span class="hljs-number">0</span></span>,<span class="hljs-number"><span class="hljs-number">0</span></span>,<span class="hljs-number"><span class="hljs-number">0</span></span>,<span class="hljs-number"><span class="hljs-number">1</span></span>,<span class="hljs-number"><span class="hljs-number">0</span></span>,<span class="hljs-number"><span class="hljs-number">0</span></span>,<span class="hljs-number"><span class="hljs-number">0</span></span>,<span class="hljs-number"><span class="hljs-number">0</span></span>,<span class="hljs-number"><span class="hljs-number">1</span></span>,<span class="hljs-number"><span class="hljs-number">0</span></span>,<span class="hljs-number"><span class="hljs-number">0</span></span>,<span class="hljs-number"><span class="hljs-number">0</span></span>,<span class="hljs-number"><span class="hljs-number">0</span></span>,<span class="hljs-number"><span class="hljs-number">0</span></span>,<span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>,<span class="hljs-number"><span class="hljs-number">0</span></span>,<span class="hljs-number"><span class="hljs-number">0</span></span>,<span class="hljs-number"><span class="hljs-number">0</span></span>,<span class="hljs-number"><span class="hljs-number">0</span></span>,<span class="hljs-number"><span class="hljs-number">1</span></span>,<span class="hljs-number"><span class="hljs-number">1</span></span>,<span class="hljs-number"><span class="hljs-number">1</span></span>,<span class="hljs-number"><span class="hljs-number">1</span></span>,<span class="hljs-number"><span class="hljs-number">0</span></span>,<span class="hljs-number"><span class="hljs-number">0</span></span>,<span class="hljs-number"><span class="hljs-number">0</span></span>,<span class="hljs-number"><span class="hljs-number">0</span></span>,<span class="hljs-number"><span class="hljs-number">0</span></span>,<span class="hljs-number"><span class="hljs-number">0</span></span>,<span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>,<span class="hljs-number"><span class="hljs-number">0</span></span>,<span class="hljs-number"><span class="hljs-number">0</span></span>,<span class="hljs-number"><span class="hljs-number">0</span></span>,<span class="hljs-number"><span class="hljs-number">0</span></span>,<span class="hljs-number"><span class="hljs-number">0</span></span>,<span class="hljs-number"><span class="hljs-number">0</span></span>,<span class="hljs-number"><span class="hljs-number">0</span></span>,<span class="hljs-number"><span class="hljs-number">0</span></span>,<span class="hljs-number"><span class="hljs-number">0</span></span>,<span class="hljs-number"><span class="hljs-number">0</span></span>,<span class="hljs-number"><span class="hljs-number">0</span></span>,<span class="hljs-number"><span class="hljs-number">0</span></span>,<span class="hljs-number"><span class="hljs-number">0</span></span>,<span class="hljs-number"><span class="hljs-number">0</span></span>,<span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>,<span class="hljs-number"><span class="hljs-number">0</span></span>,<span class="hljs-number"><span class="hljs-number">0</span></span>,<span class="hljs-number"><span class="hljs-number">0</span></span>,<span class="hljs-number"><span class="hljs-number">0</span></span>,<span class="hljs-number"><span class="hljs-number">0</span></span>,<span class="hljs-number"><span class="hljs-number">0</span></span>,<span class="hljs-number"><span class="hljs-number">0</span></span>,<span class="hljs-number"><span class="hljs-number">0</span></span>,<span class="hljs-number"><span class="hljs-number">0</span></span>,<span class="hljs-number"><span class="hljs-number">0</span></span>,<span class="hljs-number"><span class="hljs-number">0</span></span>,<span class="hljs-number"><span class="hljs-number">0</span></span>,<span class="hljs-number"><span class="hljs-number">0</span></span>,<span class="hljs-number"><span class="hljs-number">0</span></span>,<span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>,<span class="hljs-number"><span class="hljs-number">0</span></span>,<span class="hljs-number"><span class="hljs-number">0</span></span>,<span class="hljs-number"><span class="hljs-number">0</span></span>,<span class="hljs-number"><span class="hljs-number">0</span></span>,<span class="hljs-number"><span class="hljs-number">0</span></span>,<span class="hljs-number"><span class="hljs-number">0</span></span>,<span class="hljs-number"><span class="hljs-number">0</span></span>,<span class="hljs-number"><span class="hljs-number">0</span></span>,<span class="hljs-number"><span class="hljs-number">0</span></span>,<span class="hljs-number"><span class="hljs-number">0</span></span>,<span class="hljs-number"><span class="hljs-number">0</span></span>,<span class="hljs-number"><span class="hljs-number">0</span></span>,<span class="hljs-number"><span class="hljs-number">0</span></span>,<span class="hljs-number"><span class="hljs-number">0</span></span>,<span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>,<span class="hljs-number"><span class="hljs-number">0</span></span>,<span class="hljs-number"><span class="hljs-number">0</span></span>,<span class="hljs-number"><span class="hljs-number">0</span></span>,<span class="hljs-number"><span class="hljs-number">0</span></span>,<span class="hljs-number"><span class="hljs-number">0</span></span>,<span class="hljs-number"><span class="hljs-number">0</span></span>,<span class="hljs-number"><span class="hljs-number">0</span></span>,<span class="hljs-number"><span class="hljs-number">0</span></span>,<span class="hljs-number"><span class="hljs-number">0</span></span>,<span class="hljs-number"><span class="hljs-number">0</span></span>,<span class="hljs-number"><span class="hljs-number">0</span></span>,<span class="hljs-number"><span class="hljs-number">0</span></span>,<span class="hljs-number"><span class="hljs-number">0</span></span>,<span class="hljs-number"><span class="hljs-number">0</span></span>,<span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>,<span class="hljs-number"><span class="hljs-number">0</span></span>,<span class="hljs-number"><span class="hljs-number">0</span></span>,<span class="hljs-number"><span class="hljs-number">0</span></span>,<span class="hljs-number"><span class="hljs-number">0</span></span>,<span class="hljs-number"><span class="hljs-number">0</span></span>,<span class="hljs-number"><span class="hljs-number">0</span></span>,<span class="hljs-number"><span class="hljs-number">0</span></span>,<span class="hljs-number"><span class="hljs-number">0</span></span>,<span class="hljs-number"><span class="hljs-number">0</span></span>,<span class="hljs-number"><span class="hljs-number">0</span></span>,<span class="hljs-number"><span class="hljs-number">0</span></span>,<span class="hljs-number"><span class="hljs-number">0</span></span>,<span class="hljs-number"><span class="hljs-number">0</span></span>,<span class="hljs-number"><span class="hljs-number">0</span></span>,<span class="hljs-number"><span class="hljs-number">0</span></span> };</code> </pre> </div></div><br><p>  Now you can import it into C code and refer to the pointer to the array. </p><br><p>  The Start button handler will draw the next background and load the collision map into RAM at $ 300- $ 3FF.  To do this, I had to tweak the config - add a MAP segment at $ 300 and $ 100.  The code simply prescribes an empty array in this segment. </p><br><pre> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">pragma</span></span></span><span class="hljs-meta"> bss-name(push, ‚ÄúMAP‚Äù) unsigned char C_MAP[256];</span></span></code> </pre> <br><p>  The exact address is also convenient for debugging in FCEUX - you can enter the debugger in the running game and see what and how. </p><br><p>  And this is how the collision map is loaded from ROM to RAM: </p><br><pre> <code class="cpp hljs">p_C_MAP = All_Collision_Maps[which_BGD]; <span class="hljs-comment"><span class="hljs-comment">//      ROM for (index = 0;index &lt; 240; ++index){ C_MAP[index] = p_C_MAP[index]; //   RAM }</span></span></code> </pre> <br><p>  But after some time I rewrote it with memcpy - copying by bytes takes 42,688 processor cycles, which is 9 times longer than memcpy. </p><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">void</span></span> __<span class="hljs-function"><span class="hljs-function">fastcall__ </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">memcpy</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">void</span></span></span></span><span class="hljs-function"><span class="hljs-params">* dest, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">void</span></span></span></span><span class="hljs-function"><span class="hljs-params">* src, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> count)</span></span></span></span>; p_C_MAP = All_Collision_Maps[which_BGD]; <span class="hljs-comment"><span class="hljs-comment">//     memcpy (C_MAP, p_C_MAP, 240);</span></span></code> </pre> <br><p>  But that's not all.  The third approach to the projectile was with the Assembler - it came out 4% faster.  I think that while it is not worth it.  Although it is possible that in the big game these processor clock cycles will not be enough, and you will have to squeeze everything out of the console. </p><br><p>  The logic of checking for collisions with the background is something like </p><br><ol><li>  Move the sprite horizontally </li><li>  We consider its left and right edge - there are transparent stripes along the edges, they should be taken into account </li><li>  If we moved to the right, then we check if the right upper or lower corner of the sprite has fallen into the forbidden tile. </li><li>  If left, then vice versa. </li></ol><br><div class="spoiler">  <b class="spoiler_title">Checking right edge collisions with background</b> <div class="spoiler_text"><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ((joypad1 &amp; RIGHT) != <span class="hljs-number"><span class="hljs-number">0</span></span>){ <span class="hljs-comment"><span class="hljs-comment">//   corner = ((X1_Right_Side &amp; 0xf0) &gt;&gt; 4) + (Y1_Top &amp; 0xf0); //        if (C_MAP[corner] &gt; 0) X1 = (X1 &amp; 0xf0) + 3; //   -   //   corner = ((X1_Right_Side &amp; 0xf0) &gt;&gt; 4) + (Y1_Bottom &amp; 0xf0); if (C_MAP[corner] &gt; 0) X1 = (X1 &amp; 0xf0) + 3; //   -   }</span></span></code> </pre> </div></div><br><p>  +3 you need to compensate for the 3-pixel transparent edges of the sprite. </p><br><p>  Verification of collisions vertically is done similarly.  Apparently, the code will not work if the sprite moves faster than 1 point / frame. </p><br><p>  We must remember that the sprite is always drawn at 1 point lower than expected.  An amendment can be made before updating the vertical coordinate in OAM.  In platformers, this is usually sufficient.  Games with a view from the top may look strange - the character will fall into the texture a bit. </p><br><p>  Source.  Three implementations of copying the map are spaced apart in different projects - so much clearer. <br>  <a href="">lesson8.zip - cycle</a> <br>  <a href="">lesson8B.zip - memcpy</a> <br>  <a href="">lesson8C.zip - Assembler</a> <br>  <a href="https://github.com/BubaVV/nesdoug">Github</a> </p></div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <p>Source: <a href="https://habr.com/ru/post/348820/">https://habr.com/ru/post/348820/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../348804/index.html">How I promoted my game for free through YouTube</a></li>
<li><a href="../348808/index.html">What's inside of HR? (Anatomy will not)</a></li>
<li><a href="../348810/index.html">We will help developers: advantages and disadvantages of loud, we will provide 1000 cloud servers in the Netherlands and the USA for free</a></li>
<li><a href="../348812/index.html">How not to become an honest mailer</a></li>
<li><a href="../348818/index.html">Amazing Angular</a></li>
<li><a href="../348822/index.html">Mining in blockchain networks: how it works</a></li>
<li><a href="../348824/index.html">Google Chrome will start tagging all http pages as ‚Äúnot protected‚Äù with the release of Chrome 68 in July 2018</a></li>
<li><a href="../348828/index.html">Prototyping is easy how to assemble a puzzle. Multicomponent System Design in Figma</a></li>
<li><a href="../348830/index.html">Evolution of War: Total War II Series AI (Part 2)</a></li>
<li><a href="../348832/index.html">Service control panel. Part 3. Reconnaissance</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>