<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Accident Alert Info Panel Project (Part 1)</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Instead of intro 
 The history of the project creation could not have started if it were not for one unpretentious ‚ÄúBut‚Äù - there is equipment in the d...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Accident Alert Info Panel Project (Part 1)</h1><div class="post__text post__text-html js-mediator-article"><h4>  Instead of intro </h4><br>  The history of the project creation could not have started if it were not for one unpretentious ‚ÄúBut‚Äù - there is equipment in the department that should work smoothly, 24/7/365 (around the clock, seven days a week, always) - in fact, they are hardware stations optical multiplexers, SDH equipment) and SIP telephony servers (as well as the Call Center, but the operators themselves tell us about this, they were very well trained to respond to the slightest failures). <br>  The equipment itself is located in the server room, remote from the office, and quite noisy (50-80db inside is the norm, you even have to talk in raised tones, because otherwise the interlocutor is just not heard at half a meter). <br>  In case of any equipment failures, it is necessary to eliminate them quickly (failures can occur both from our side and from the connected operators, as well as for independent reasons, for example, breakage of optics, overload on the line, other data loss), due to than you need to constantly do for performance indicators. <br>  Measures are taken, but earlier this happened with some delay due to the lack of control. <br>  Visual monitoring of the equipment is possible (indication of warnings and accidents of the pre-mortem), but this requires being close to the equipment, which is not always possible. <br><br>  Interested please under the cat.  (Caution, traffic ~ 10-15MB photo) <br><a name="habracut"></a><br><h4>  Content </h4><br>  <a href="http://habrahabr.ru/post/218859/">Part 2</a> <br><br>  For those who are not interested in the background, you can safely <a href="https://habr.com/ru/post/210418/">skip it</a> , and go to the main idea of ‚Äã‚Äãthe post. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h4>  Preamble </h4><br>  Thus, to monitor the condition of the equipment, a monitor was required.  A normal monitor does not fit in view of the complexity of visual control, as well as the absence of meaning in it.  It is much easier to see if the red light is on, than to look for which indicators have turned red on the monitor somewhere, which are already red (the unconnected conclusions of the optical converters display rather unpleasant crash indicators), and so on. <br><br>  The first option was a complex of them: <br><ul><li>  Virtual Server (ubuntu 11.04, 512MB RAM, NoGUI). </li><li>  Scripts on the same server (written in Perl). </li><li>  Alarm devices such as "Flashing". </li></ul><br><br>  Hardware characteristics of the current (working) notification device: <br>  ATMega48 + <a href="http://www.plgn.ru/catalog/233/373/">Arlan 9000</a> + LED strip (1 sektor) 12V + IRLML2402 as a key. <br>  The device operates in byte mode on a USART, sends the same byte backward, and checks for what exactly came. <br>  If ‚Äú1‚Äù - allows the timer interrupt to work (it works about once per second, flips a pin that controls the MOSTFET key). <br>  If "0" - prohibits his work. <br>  In both cases, after exiting the interrupt, the MCU continues to wait for bytes from the USART. <br>  Powered by 12V with the simplest stabilizer KR142EN5A (5V output, which is more than enough to power the MCU and the low-voltage IRF-key). <br><br>  In the server part, everything is even simpler.  CRON runs every minute a script (not even a script, but rather a cycle for launching the script itself and a waiting pause), so that the interpreter runs every 10 seconds.  There are few devices, so you can solve this problem in the forehead. <br>  The script sequentially checks the states of the device by SNMP requests, remembering the state.  If at least somewhere the status of an accident is returned, the symbol ‚Äú1‚Äù is transmitted to the actuator.  If everything is good everywhere, then ‚Äú0‚Äù is transmitted. <br>  Everything works, but not to say that it is convenient - it is not known WHAT feels bad. <br><br>  [/ Prehistory] <br><a name="Main"></a><h6>  Now the main part. </h6><br>  Currently, the development of a more comprehensive network device alerts (although the same will work in conjunction with a virtual server and more advanced scripts). <br>  The finished material will be posted in the relevant topic. <br>  The current source code does not differ in beauty, because in the framework of the preliminary article will not be laid out. <br><br>  The essence of the device: <br>  <b>MCU</b> : <a href="http://www.atmel.com/images/doc8059.pdf">ATMega1284p</a> (chose what was available, literally on hand), quartz at 18.432MHz / RAM: 16kB, Flash: 128kB, EEPROM: 4kB, USART /; <br>  <b>Ethernet module</b> : ENC28J60;  / Library sources and description of working with the module <a href="http://we.easyelectronics.ru/electro-and-pc/podklyuchenie-mikrokontrollera-k-lokalnoy-seti-rabotaem-s-enc28j60.html">here</a> / <br>  <b>Indication</b> : 20 modules 8x8 LED DOT Matrix (purchased on E-Bay); <br>  <b>Sound</b> : Piezo, DAC 8bit R-2R on resistors, sampling frequency will be ~ 22kHz, Single-tone signals; <br>  <b>Additional periphery</b> : DS12B20 thermometers; <br>  <b>Power</b> : \ Currently questionable, because I do not want extra wires to the device, and there is a desire to assemble it according to the POE scheme, but the finished module will not withstand 48V, therefore, probably, 12V PSU will be used as the POE adapter \ <br>  As an internal power source, and a stabilizer, the Step-Down DC-DC Converter module on the LM2596 (from the same E-Bay) is used; <br>  Debugging: UART in RS232 mode (at a speed of 115200), turns on only when the MCU starts, if there is potential on the specified MCU pin, otherwise it is not turned on and almost does not consume system resources; <br><br>  <b>Design</b> <br>  The device will be constructively an info-panel (to resemble those in buses), but smaller in size (the original one could not find - it does not google what is presented in our buses, but it resembles a running line). <br><div class="spoiler">  <b class="spoiler_title">Similar information panel in the bus</b> <div class="spoiler_text">  <a href="http://elis2005.ru/selelis.htm">The manufacturer of</a> these panels, as well as the panel itself: <br><img src="https://habrastorage.org/getpro/habr/post_images/297/623/2c3/2976232c3acc07709d055de2895d3d95.jpg"></div></div><br>  The finished device will have a size of the visible area of ‚Äã‚Äã20x400mm (1 line for 20 modules), may later become two-line, or increase the font (most likely the first). <br>  Work is planned on the Ethernet (fully independent). <br>  The organization of work on the Ethernet network occurs through the ENC28J60 module ( <i>special thanks to the user easyelexnronix, <a href="http://we.easyelectronics.ru/profile/Lifelover/">Lifelover</a> for the module driver, as well as examples of working with it</i> ). <br>  The possibility of sound alerts is planned (the presence and necessity of a sound signal is controlled by the server), as well as the ability to play streaming sound (decoding will also occur on the server side; the problem with playback and low processing power, as well as the complete lack of DMA, is solved by ring buffer);  text display - dynamic. <br><br>  So, in order: <br>  <b>Core</b> <br>  From the MCU is required multitasking, and at the same time a hard real time (for sound), because an attempt was made to use FreeRTOS, but after calculating the overhead costs, this idea was abandoned.  Playing sound (relatively) of high quality requires data processing at a frequency of 22 kHz (so as not to suffer from resampling sound), switching tasks in this mode will require a significant portion of the MCU resources.  With the standard system interrupt frequency (100..1000Hz), PCM sound without DMA cannot be played. <br><br>  <b>Sound</b> <br>  Sound processing occurs when the timer is interrupted.  The same interruption, in the absence of data in the sound buffer, will independently disconnect itself. <br>  A single-tone beeper will be connected to the outputs of the PWM-generator, which does not exclude the possibility of only one piezo emitter for alerts. <br><div class="spoiler">  <b class="spoiler_title">Audio interrupt handler</b> <div class="spoiler_text"><pre><code class="hljs dos">ISR (TIMER3_COMPA_vect) { #ifdef STREAM_SOUND cli(); // Disable interrupts <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (plaing_now) // <span class="hljs-keyword"><span class="hljs-keyword">If</span></span> now plaing.. { snd_R++; // Increase read position, bytes_remain--; // and decrease bytes remain count <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(snd_R &gt;= MAX_SND_BUFFER-<span class="hljs-number"><span class="hljs-number">1</span></span>) // Then <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ReadPos reaches EndOfBuffer { snd_R = <span class="hljs-number"><span class="hljs-number">0</span></span>; // Reset it. }; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(bytes_remain &lt;= <span class="hljs-number"><span class="hljs-number">0</span></span>) // And <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> it's NO bytes remains.. { plaing_now = <span class="hljs-number"><span class="hljs-number">0</span></span>; // Stop plaing DAC_PORT = <span class="hljs-number"><span class="hljs-number">0</span></span>; // And <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> DAC to ZERO. }; DAC_PORT = snd_buffer[snd_R]; // <span class="hljs-built_in"><span class="hljs-built_in">Set</span></span> DAC Value to Buffer[Read]; }; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!plaing_now) { // <span class="hljs-keyword"><span class="hljs-keyword">If</span></span> interrupt triggered, but <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> plaing now.. TCCR0B &amp;= (<span class="hljs-number"><span class="hljs-number">0</span></span>xF8); // Disabling timer. TCNT0 = <span class="hljs-number"><span class="hljs-number">0</span></span>; // And Reset timer's value. }; sei(); // Enable interrupts. #endif };</code> </pre>  Interrupting the timer causes the handler to move the buffer pointer one step forward, check if it has moved beyond the end of the buffer, if yes - return to the beginning, subtract 1 from the remaining bytes in the buffer, if 0 - stop playback, disable the timer and output the same 0 per DAC port; otherwise, output bytes from the buffer to the port. </div></div><br><br>  <b>Indicator</b> <br>  The implementation of the indicator is planned on shift registers with latches 74HC595 (column drivers + row driver) + IRLML2402 as a row driver (buffer). <br>  Registers are used as column drivers, since  their current load allows to power the whole line (8 points) at the same time. <br>  These lines will be gradually pushed through the registers horizontally, starting from the "right" edge, so as not to bother with the additional frame buffer, and the entire image is output line by line. <br>  At the same time, the registers have a common data bus, but separate clocking buses (+1 to the saved MCU pins). <br>  Dynamic indication at a frequency of 125Hz should not be perceived by the eye as flickering (meaning the total frequency of regeneration), the switching frequency of the lines is 1kHz (a timer counting milliseconds is used). <br>  Due to the presence of latches in the registers, it will be possible to completely avoid flickering when switching lines (I will add a small pause of several cycles after switching the registers to the Z-state, snapping new data and switching to the operating mode). <br><br>  <b>Power supply</b> <br>  As already stated, the power will be supplied from the outside to the ENC28J60 module, since  its design allows you to remove the voltage from 3 and 4 pairs of cable (they are not closed to the case and not connected to anything).  Then this voltage will flow to the DC-DC converter and drop to 5V. <br>  At the moment there is a question of voltage levels: <br>  The core must be powered from 4.5-5V, because  otherwise, it is not guaranteed to work at a frequency above 12MHz (valid for 3.3V), but the network interface must be powered from 3.3V, otherwise the chip gets very hot, and there is a danger of its failure.  There is only one converter available, therefore, a necessary Low Drop 5V -&gt; 3.3V to a current of up to 250mA is necessary, again, preferably a pulse with high efficiency.  In stock, unfortunately, no. <br><br>  <b>upd:</b> I am already advised to assemble the converter on the placer elements and power everything from normal POE without any restrictions in 12V.  That's just in this circuit I was not very lucky.  <s>If something began to work, then sometimes it burned pretty effectively.</s> <br><br>  It is likely that RTC support will be added to the final project ( <a href="http://www.emesystems.com/pdfs/parts/DS1307.pdf">DS1307</a> ).  Including, I will try to describe the work with NTP (it will be ugly, but I will describe the basic functionality). <br>  For one thing, I will recall / learn the principles of data processing at different levels of OSI. <br><br>  Currently available: <br><ul><li>  Partially compiled library (network appears, it remains to finish checking for the presence of the link and data handlers ... everything ... a lot ..) </li><li>  Ethernet module ENC28J60 </li><li>  Step-Down DC-DC Converter (LM2596) </li><li>  Indicators (disassembled) (20 pcs) </li><li>  The ATMega1284p MCU on the debug board (it looks pretty sloppy, but it‚Äôs shared for yourself). </li><li>  Piezo emitter </li><li>  Thermometer DS18B20, rewritten library from scratch.  The basic minimum of functions: ‚ÄúRead byte‚Äù, ‚ÄúStart conversion‚Äù, ‚ÄúRead Scratchpad‚Äù. </li><li>  RTC DS1307 </li></ul><br>  The thermometer library will be rewritten to optimize and eliminate delays in the operation of the MCU during conversion.  At the moment, temperature conversion causes the MCU to freeze for ~ 750ms, which creates a very unpleasant pause when working with the network, as well as sound. <br><br><div class="spoiler">  <b class="spoiler_title">Little photo</b> <div class="spoiler_text">  ENC28J60: <br><img src="https://habrastorage.org/getpro/habr/post_images/046/10a/c40/04610ac40cc866daf3f9a95a92e0ad8a.jpg"><br>  Step-Down DC-DC Converter (LM2596): <br><img src="https://habrastorage.org/getpro/habr/post_images/b27/487/70c/b2748770c1025b576e7dbdb76841bc7c.jpg"><br>  The modules themselves: <br><img src="https://habrastorage.org/getpro/habr/post_images/3b5/0dd/bcd/3b50ddbcd656a8652f6296c48f6ffa77.jpg"><br>  Module assembly + rear pinout and partially visible adapter circuit. <br><img src="https://habrastorage.org/getpro/habr/post_images/096/0c7/1cf/0960c71cf2ec4076e5fba9a4215d467b.jpg"><br>  Link to the LED modules themselves (not the store), as well as an example of managing them <a href="http://microsin.ru/content/view/1182/44/">here</a> . <br><br>  Debug board + module in it.  Shines MUCH brighter than the photo.  Powered by 5V without limiting resistors.  In vain, in vain, in vain ... but it works!  The second column is powered through a pull-up resistor, which holds 1-Wire for DS18B20 (to the left): <br><img src="https://habrastorage.org/getpro/habr/post_images/481/dfa/374/481dfa3745a36c32e18de55881821edb.jpg"></div></div><br><br>  What is not: <br><ul><li>  Added libraries </li><li>  DMA and very sorry. </li><li>  Sign generator.  (Dopilivaetsya) </li><li>  Adapters for LED modules (the module pinout is just awful, and for the panel it will be more convenient to assemble them when there are a row on one side and columns on the other. </li></ul><br><br>  / Order adapters turned out to be commercially unprofitable.  The price at the factory was broken in the amount of 4000 (excluding VAT) for 40 pieces.  With VAT we get almost 5k wooden.  We'll have to hone the skills of working with a mini-drill and LUT. / <br><br>  The matrix of characters is planned 6x8, without font optimizations. <br><pre> <code class="hljs objectivec"><span class="hljs-comment"><span class="hljs-comment">//A { 0b00000000, 0b00100000, 0b01010000, 0b01010000, 0b10001000, 0b11111000, 0b10001000, 0b00000000, }</span></span></code> </pre><br>  Moreover, only 6 high bits will be displayed on the indicator, the remaining 2 will be skipped. <br>  No pseudographics yet. <br>  Output pictures from the "network" is probably also.  But to describe the graphics buffer for a short time, you can make animations directly from the server. <br><br>  There was an idea to buy a Raspberry PI and write a script on top of it ... but it is not sporty.  There, the ARM-11, 512MB RAM, Linux ... yes there you can raise the monitoring server itself! .. but the real time in any * nix system is soft, and a hard time is required to display the display. <br>  Of course, it was possible to make RPI + any simpler ATMega48 type controller (yes, it is also available), with the exchange via SPI / UART and peripherals on top of the controller itself, but this is not sporty either. <br>  The goal of the project was to set up for itself ‚ÄúTo meet the small budget and assemble a notification device,‚Äù because this is how it is done.  Almost healthy sports interest. <br><br>  To be continued. </div><p>Source: <a href="https://habr.com/ru/post/210418/">https://habr.com/ru/post/210418/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../210406/index.html">Lexand Capella: a smartphone with Full HD-screen and support for two SIM-cards for 9,600 rubles ($ 280)</a></li>
<li><a href="../210408/index.html">Forgotten zoom</a></li>
<li><a href="../210410/index.html">Implement an L2TP / IPsec VPN server using standard Windows 7/8 tools for connecting Windows / iOS / Android systems to an internal network</a></li>
<li><a href="../210412/index.html">The legacy of Konrad Zuse: Architecture Z1 and Z3 [Translation]</a></li>
<li><a href="../210416/index.html">Clear cookies</a></li>
<li><a href="../210420/index.html">We write monitoring the availability of tickets for Russian Railways</a></li>
<li><a href="../210422/index.html">We try Audio API on an example of writing a visualizer</a></li>
<li><a href="../210424/index.html">Post preparation for printing</a></li>
<li><a href="../210426/index.html">Convenient switching wifi in access point mode</a></li>
<li><a href="../210428/index.html">MassTransit. Rabbit Rabbit Server based messaging bus (MSMQ) for .Net</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>