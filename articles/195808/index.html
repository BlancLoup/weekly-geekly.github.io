<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>We configure the HTTPS server on nginx</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Why am I writing this? 
 Recently, due to a bunch of factors (NSA, DPI with advertising and others), I started to wake up paranoia and I thought to co...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>We configure the HTTPS server on nginx</h1><div class="post__text post__text-html js-mediator-article"><h2>  Why am I writing this? </h2><br>  Recently, due to a bunch of factors (NSA, <a href="http://habrahabr.ru/post/190938/">DPI with advertising</a> and others), I started to wake up paranoia and I thought to completely translate my small site to https.  On Habr√© there were <a href="http://habrahabr.ru/post/188042/">several</a> <a href="http://habrahabr.ru/post/191954/">articles</a> with technical details of SSL / TLS, however, looking for information on the https-web server settings found the traditional division of articles - either this article "Do like this", which simply gives the settings without any explanations and use cases, or these are large theoretical articles where various schemes of use are discussed, but without practically applicable ready-made options.  On Habr√© there was <a href="http://habrahabr.ru/post/173125/">an article</a> about setting up, but it does not contain information about DH-coding, and some parameters are not described.  I thought that it would be worthwhile to organize the information found in the form of an article that would be useful for those who would like to deploy https on their server, but not get too deep into the SSL jungle. <br><br>  The narration will be conducted taking into account the fact that the web server is nginx (and in one place there will be a parameter for php-fpm). <br><a name="habracut"></a><br><h2>  Certificate </h2><br>  I already had a certificate from StartSSL.  About him already <a href="http://habrahabr.ru/post/127643/">wrote</a> on Habr√©, so I will not linger on this step.  I can only say that during the first two or three days, browsers checking the certificate on the server can swear at it (this happened to me with Opera 12 and Firefox), apparently StartCom doesn‚Äôt update the valid certificate caches so often.  About the installation will be discussed below. <br><br><h2>  About customization options </h2><br>  Nginx out of the box in the new versions offers practically relevant, but still requiring polishing parameters, however, the actual parameters appeared in the standard config not so long ago, so in some cases the standard example HTTPS server in the config will not be relevant. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      In general, there are two currently relevant configuration options - with and without Forward Secrecy.  When setting up, the difference is only in the set of encodings (ssl_ciphers directive), however, it is worth considering what you want from https. <br><br>  You can read about Forward Secrecy <a href="http://habrahabr.ru/post/188042/">here</a> .  In a nutshell, the bottom line is that for the currently current RC4 algorithm, session keys are generated based on the server's private key.  Thus, if the private key is compromised, it will be possible to decrypt all sessions (if they were recorded).  In the case of the use of DH encodings, each session has its own set of keys, which the session does not depend on the private key.  However, in this case, much more CPU time is spent on the handshake, which increases the load and time of opening the page. <br><br>  It is worth thinking about why you need https specifically on your site.  With a large number of visitors, the use of DH encryption algorithms can significantly increase the load (which in any case will increase during the transition to HTTPS), in some cases it will be necessary to increase the tariff for VDS, etc.  In most cases, RC4 is enough, but many want everything to be ‚Äúon the upper class,‚Äù so why not do it if resources allow? <br><br><h2>  Nginx configuration </h2><br>  As a result of the configuration, I have formed approximately such a config, I will explain the essence of the parameters below. <br><br>  In the http section you need to add: <br><pre><code class="nginx hljs"><span class="hljs-attribute"><span class="hljs-attribute">ssl_session_cache</span></span> shared:SSL:<span class="hljs-number"><span class="hljs-number">10m</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">ssl_session_timeout</span></span> <span class="hljs-number"><span class="hljs-number">5m</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">ssl_prefer_server_ciphers</span></span> <span class="hljs-literal"><span class="hljs-literal">on</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">ssl_stapling</span></span> <span class="hljs-literal"><span class="hljs-literal">on</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">resolver</span></span> <span class="hljs-number"><span class="hljs-number">8.8.8.8</span></span>;</code> </pre> <br><br>  The server section will look like this: <br><pre> <code class="nginx hljs"><span class="hljs-section"><span class="hljs-section">server</span></span> { <span class="hljs-attribute"><span class="hljs-attribute">listen</span></span> <span class="hljs-number"><span class="hljs-number">443</span></span> ssl; <span class="hljs-attribute"><span class="hljs-attribute">server_name</span></span> www.site.ru; ....... <span class="hljs-attribute"><span class="hljs-attribute">keepalive_timeout</span></span> <span class="hljs-number"><span class="hljs-number">60</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">ssl_certificate</span></span> certificate_bundled.crt; <span class="hljs-attribute"><span class="hljs-attribute">ssl_certificate_key</span></span> privatekey.key; <span class="hljs-attribute"><span class="hljs-attribute">ssl_protocols</span></span> TLSv1 TLSv1.<span class="hljs-number"><span class="hljs-number">1</span></span> TLSv1.<span class="hljs-number"><span class="hljs-number">2</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">ssl_ciphers</span></span> <span class="hljs-string"><span class="hljs-string">"HIGH:!RC4:!aNULL:!MD5:!kEDH"</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">add_header</span></span> Strict-Transport-Security <span class="hljs-string"><span class="hljs-string">'max-age=604800'</span></span>; ....... <span class="hljs-attribute"><span class="hljs-attribute">location</span></span> <span class="hljs-regexp"><span class="hljs-regexp">~ \.php$</span></span> { ....... <span class="hljs-attribute"><span class="hljs-attribute">fastcgi_param</span></span> HTTPS <span class="hljs-literal"><span class="hljs-literal">on</span></span>; <span class="hljs-comment"><span class="hljs-comment">#  php-fpm ....... } }</span></span></code> </pre> <br><br>  This example does not use DH algorithms, i.e.  No Forward Secrecy.  Of the improvements, you can omit support for SSLv3 (removing it from ssl_ciphers), so IE 6 and lower will no longer be supported, because it does not support TLS, and also increase the STS time, but more on that below. <br>  Without SSLv3, this setting gives a score of 100-95-100-90 <a href="https://www.ssllabs.com/ssltest/index.html">in the SSL test</a> . <br><br><h3>  Go through the parameters </h3><br>  <b>ssl_session_cache shared: SSL: 10m;</b> <b><br></b>  <b>ssl_session_timeout 5m;</b> <br>  ‚ÄúSpecifies the type and size of caches for storing session parameters.‚Äù (Nginx.org) The cache is necessary to enable the reuse of session keys, so old keys will be used when establishing a new connection, i.e.  Handheld will not be re-produced.  Especially important when using the DHE encoding (for example, in Opera 12 browser), since the page load time with all elements increases greatly when there is no cache, and DHE also uses more resources and time (relative to EECDH and RC4).  The shared parameter sets the total for all workflows nginx cache, 10m - cache size (10 MB, with 1 MB ~ 4000 sessions, so with these settings you can store up to 40 thousand sessions), 5m - session timeout in cache (5 minutes) . <br><br>  <b>ssl_prefer_server_ciphers on;</b> <br>  "Indicates that when using the SSLv3 and TLS protocols, server ciphers have higher priority than client ones." (Nginx.org) - client ciphers (CBC) are vulnerable to certain types of attacks. <br><br>  <b>ssl_stapling on;</b> <br>  Allows the server to attach OCSP responses, thereby reducing the time to load pages from users.  Here we mean answers about the validity of the certificate (when checking for revocation).  From the point of view of the user's security, it does not matter who sends the answers ‚Äî the web server or the CA server ‚Äî after all, the answer is in any case signed and the validity of the answer can also be checked, and the answer includes its validity period. <br>  For this function to work, you need to specify the DNS server, which is done by the resolver directive. <br><br>  <b>keepalive_timeout</b> - I think the description does not need, you should not turn off or set too small to reduce the load due to re-establishing the connection. <br><br>  <b>ssl_certificate</b> and <b>ssl_certificate_key</b> point to the certificate file and the private key file for it.  Since I am using the certificate from StartSSL as an example, I will admit a small comment on StartSSL instructions for installing a certificate ‚Äî you don‚Äôt need to add the Root CA certificate to the generic certificate file, since it does not make sense and only increases, though not by much, the size of the transmitted data.  It is enough to have a personal certificate and a certificate of an intermediate certification authority in the file.  The finished certificate file for nginx (for StartSSL for the network certificate) can be obtained with the following command: <br><pre> <code class="hljs css"><span class="hljs-selector-tag"><span class="hljs-selector-tag">cat</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">certificate</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.crt</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">sub</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.class1</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.server</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.ca</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.pem</span></span> &gt; <span class="hljs-selector-tag"><span class="hljs-selector-tag">certificate_bundled</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.crt</span></span></code> </pre> <br>  Where your certificate is certificate.crt, and intermediate certificate is <a href="">www.startssl.com/certs/sub.class1.server.ca.pem</a> <br><br>  <b>add_header Strict-Transport-Security 'max-age = 604800';</b> <br>  Strict-Transport-Secutiry - a title that indicates to the browser that the site is accessible only by https.  This prevents the possibility of switching back to the http version for a subsequent attack via an unencrypted connection.  By the way, this parameter is still convenient because if the page has a ‚Äúforgotten‚Äù connection of a resource (image / script / style / ...) from the same site via http, the browser itself will go to the https version and will not swear to partially unencrypted compound.  Of course, this will not work for external resources.  Time is a week.  Many recommend putting 1 year, but if you decide in the future to stop using https this may cause problems for some users.  The time is updated each time this header is transmitted, i.e.  every time you visit the site. <br><br>  <b>ssl_protocols TLSv1 TLSv1.1 TLSv1.2;</b> <br>  Specifies the supported protocols.  SSLv2 and v3 have critical vulnerabilities. <br><br>  <b>ssl_ciphers "HIGH:! RC4:! aNULL:! MD5:! kEDH";</b> <br>  Specifies the ciphers used.  Actually by changing the set of ciphers and configured Forward Secrecy.  It differs from the standard set offered by nginx only by the parameter! KEDH, <br><br><h2>  Forward secrecy </h2><br>  To enable Forward Secrecy, for example, you can use the following cipher suite: <br><pre> <code class="hljs nginx"><span class="hljs-attribute"><span class="hljs-attribute">ssl_ciphers</span></span> <span class="hljs-string"><span class="hljs-string">"EECDH+ECDSA+AESGCM EECDH+aRSA+AESGCM EECDH+ECDSA+SHA384 EECDH+ECDSA+SHA256 EECDH+aRSA+SHA384 EECDH+aRSA+SHA256 EECDH+aRSA+RC4 EECDH EDH+aRSA !RC4 !aNULL !eNULL !LOW !3DES !MD5 !EXP !PSK !SRP !DSS"</span></span>;</code> </pre> <br><br>  In addition, you must configure the OpenSSL cipher priority: <br><pre> <code class="hljs nginx"><span class="hljs-attribute"><span class="hljs-attribute">openssl</span></span> ciphers -V <span class="hljs-string"><span class="hljs-string">'EECDH+ECDSA+AESGCM EECDH+aRSA+AESGCM EECDH+ECDSA+SHA256 EECDH+aRSA+SHA256 EECDH+aRSA+RC4 EDH+aRSA EECDH !RC4 !aNULL !eNULL !LOW !3DES !MD5 !EXP !PSK !SRP !DSS'</span></span></code> </pre> <br>  In this embodiment, it is not prohibited to use RC4 to maintain compatibility with some browsers, however <a href="https://community.qualys.com/blogs/securitylabs/2013/03/19/rc4-in-tls-is-broken-now-what">, vulnerabilities were discovered</a> not so long ago <a href="https://community.qualys.com/blogs/securitylabs/2013/03/19/rc4-in-tls-is-broken-now-what">in it</a> , although it is practically difficult to implement. <br><br>  To enhance encryption, you can increase the durability of DH ciphers by creating a DH cipher parameters file (creating the file will take some time!), Say 4096 bits long: <br><pre> <code class="hljs objectivec">openssl dhparam -<span class="hljs-keyword"><span class="hljs-keyword">out</span></span> dh4096.pem <span class="hljs-number"><span class="hljs-number">4096</span></span></code> </pre> <br>  And adding a directive to the nginx config <br><pre> <code class="hljs nginx"><span class="hljs-attribute"><span class="hljs-attribute">ssl_dhparam</span></span> dh4096.pem;</code> </pre> <br>  This can be done for say for web-based server / services management interfaces, but the handshake will take even longer, so you should not do it on a regular website. <br><br><h3>  About CDN-services </h3><br>  In discussing the <a href="https://community.qualys.com/blogs/securitylabs/2013/08/05/configuring-apache-nginx-and-openssl-for-forward-secrecy">instructions for setting up</a> Forward Secrecy, it was noted that at least CDN Amazon CloudFront does not support sharing with your server in DH encodings, and RC4 is also not that good.  It is possible that not everything is perfect with other CDNs either, but I personally have not yet come across them, so I can‚Äôt say anything. <br><br><h3>  useful links </h3><br>  <a href="https://www.ssllabs.com/ssltest/index.html">Testing https webserver settings</a> <br>  <a href="https://community.qualys.com/blogs/securitylabs/2013/08/05/configuring-apache-nginx-and-openssl-for-forward-secrecy">Apache and nginx settings for Forward Secrecy</a> </div><p>Source: <a href="https://habr.com/ru/post/195808/">https://habr.com/ru/post/195808/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../195798/index.html">About choosing hard drives for servers</a></li>
<li><a href="../195800/index.html">Synchronization of the web developer workspace</a></li>
<li><a href="../195802/index.html">Strategy for promoting a new site. When will the top 10 and search traffic?</a></li>
<li><a href="../195804/index.html">Automatic lap and time counting system for RC cars</a></li>
<li><a href="../195806/index.html">Generator utf-8 json on php with unicode 6 support</a></li>
<li><a href="../195810/index.html">Repairing a car with a 3D printer</a></li>
<li><a href="../195812/index.html">Derby.js deploy on Amazon EC2</a></li>
<li><a href="../195814/index.html">Timers in .Net</a></li>
<li><a href="../195816/index.html">Javascript function argument schema or C-style prototypes without heavyweight frameworks</a></li>
<li><a href="../195818/index.html">Go: multithreading</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>