<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Experience using Object Change Notification in Oracle</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Recently I had to work with an interesting thing and I decided to share this with the readers of Habrakhabr. I want to talk about the experience of us...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Experience using Object Change Notification in Oracle</h1><div class="post__text post__text-html js-mediator-article">  Recently I had to work with an interesting thing and I decided to share this with the readers of Habrakhabr.  I want to talk about the experience of using Object Change Notification in Oracle.  How to find out if the data has changed without making a request. <br><a name="habracut"></a><br><h3>  So why do we need Object Change Notification (OCN) </h3><br>  We needed to watch for changes in the database.  The solution that first came to mind was simple - updating data for a given time interval (for example, once a minute).  The disadvantages of this approach are obvious - the data could not change over the selected period and then we simply load the server and the data transfer channel (the data we observe is quite voluminous).  Either the data will change at the beginning of the time interval and we will not know about it until time runs out (this is not so critical, but the first one is quite likely).  Given the fact that there could be quite a few clients, the first minus is really serious.  Fortunately, we have found that Oracle offers a better solution to this problem, starting with version 10g. <br><br><h3>  How does OCN work </h3><br>  OCN can work both exclusively on the server side of the database and inform the client application via a special interface that the data it has observed has changed. <br><br>  Detailed information on how it works inside is easily googled;  I thought that it is not necessary to inflate the article with information, which is already in abundance, so I will tell only briefly. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <div style="text-align:center;"><img src="https://habrastorage.org/files/ee9/676/ffc/ee9676ffc4e349aebd89695ade3ce2c9.gif"></div><br><br>  At the beginning, it is necessary to allow the use of request registrations on the server and allow the use of parallel notifications.  Then, the user logs the alert.  When registering, a request is indicated that must be observed, for example: <pre><code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">select</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> TESTUSER.TESTTABLE;</code> </pre>  After the data in the result set is changed, oracle will notify the client about it (either send a special packet on the registered ip, or execute the registered stored procedure).  Support for this mechanism is built into Database Provider for .NET and Java.  Since we wrote our application on .NET, I‚Äôm going to speak further in its context (although, I think, most things do not depend on this, as the most interesting things are going on on the server). <br><br><h3>  Where without sample code </h3><br>  Let's go in order: <br><ul><li>  Allow the user to register continuous notifications; <pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">GRANT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">CHANGE</span></span> NOTIFICATION <span class="hljs-keyword"><span class="hljs-keyword">TO</span></span> TESTUSER;</code> </pre> </li><li>  Set the value of the variable ‚ÄúJOB_QUEUE_PROCESSES‚Äù to a value greater than 0 (by default it is already greater than 0, but suddenly something broke on the default on your server); <pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">ALTER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">SYSTEM</span></span> <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> <span class="hljs-string"><span class="hljs-string">"JOB_QUEUE_PROCESSES"</span></span>=<span class="hljs-number"><span class="hljs-number">4</span></span>;</code> </pre> </li><li>  Create a project, add a link to the library Oracle.ManagedDataAccess.dll (can be downloaded from the Oracle website along with the ODP.NET package with ODAC, or pick it up via NuGet); </li><li>  Then you can just try. </li></ul><br><div class="spoiler">  <b class="spoiler_title">Big code example</b> <div class="spoiler_text"><pre> <code class="hljs pgsql"><span class="hljs-keyword"><span class="hljs-keyword">using</span></span> <span class="hljs-keyword"><span class="hljs-keyword">System</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> <span class="hljs-keyword"><span class="hljs-keyword">System</span></span>.Threading; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> <span class="hljs-keyword"><span class="hljs-keyword">System</span></span>.Data; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> Oracle.ManagedDataAccess.Client; namespace ChangeNotificationSample { <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> ChangeNotificationSample { <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> static <span class="hljs-type"><span class="hljs-type">bool</span></span> IsNotified; <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> static <span class="hljs-type"><span class="hljs-type">void</span></span> Main(string[] args) { const string constr = "Data Source=(DESCRIPTION=(ADDRESS_LIST=(ADDRESS=(PROTOCOL=TCP)(HOST=myHost)(PORT=myPort)))(CONNECT_DATA=(SERVER=DEDICATED)(SERVICE_NAME=myServiceName))); Validate Connection = true; Connection Timeout=180;User Id=TESTUSER;Password=myPass"; OracleConnection con = <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>; try { con = <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> OracleConnection(constr); OracleCommand cmd = <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> OracleCommand("select * from TESTUSER.TESTTABLE", con); con.<span class="hljs-keyword"><span class="hljs-keyword">Open</span></span>(); //      . OracleDependency.Port = <span class="hljs-number"><span class="hljs-number">1005</span></span>; // OracleDependency var dep = <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> OracleDependency(cmd); //,       //  ,        cmd.Notification.IsNotifiedOnce = <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>; //  ,    cmd.Notification.Timeout = <span class="hljs-number"><span class="hljs-number">300</span></span>; //   "- " dep.OnChange += OnMyNotificaton; //,    ,     cmd.ExecuteNonQuery(); } catch (<span class="hljs-keyword"><span class="hljs-keyword">Exception</span></span> e) { Console.WriteLine(e.Message); } finally { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (con != <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) { con.<span class="hljs-keyword"><span class="hljs-keyword">Close</span></span>(); con.Dispose(); } } //    ,      <span class="hljs-number"><span class="hljs-number">10</span></span>    <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (IsNotified == <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>) { Thread.Sleep(<span class="hljs-number"><span class="hljs-number">100</span></span>); } Console.ReadLine(); } private static <span class="hljs-type"><span class="hljs-type">void</span></span> OnMyNotificaton(<span class="hljs-keyword"><span class="hljs-keyword">object</span></span> sender, OracleNotificationEventArgs eventArgs) { Console.WriteLine("Notification Received"); DataTable changeDetails = eventArgs.Details; Console.WriteLine("Data has changed in {0}", changeDetails.<span class="hljs-keyword"><span class="hljs-keyword">Rows</span></span>[<span class="hljs-number"><span class="hljs-number">0</span></span>]["ResourceName"]); IsNotified = <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>; } } }</code> </pre></div></div><br>  I almost completely took the example from the documentation, only added it with a couple of important points in my opinion and reduced it a little.  After the code is written, compiled, and the program is running, you can go and do something like: <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">insert</span></span> <span class="hljs-keyword"><span class="hljs-keyword">into</span></span> testuser.testtable (col1, col2) <span class="hljs-keyword"><span class="hljs-keyword">values</span></span> (<span class="hljs-number"><span class="hljs-number">1</span></span>,<span class="hljs-number"><span class="hljs-number">1</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">commit</span></span>;</code> </pre> <br>  When done, we should see this: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/files/7dd/065/b44/7dd065b4486a45a887ac16fb631fe980.png"></div><br><br>  Hooray, everything works!  More detailed information can be taken, for example, in the <a href="http://docs.oracle.com/cd/B19306_01/appdev.102/b14251/adfns_dcn.htm">documentation</a> .  It is better to go straight to what is usually not indicated in the documentation - the difficulties encountered. <br><br><h3>  Minuses </h3><br>  For our case, there were not so many disadvantages that they outweighed the advantages of this approach, and some of them are difficult to call minuses, as nuances.  However, it seems to me that the enemy must be known in person. <br><br>  First of all, we tried to run it on our own and everything worked fine here.  And, as is usually the case, nothing worked for the customer.  Or rather, it didn't even take off.  To figure out what the matter was, it turned out to be a rather non-trivial task.  After you start a registration, you can see it by performing a special request: <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">select</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> USER_CHANGE_NOTIFICATION_REGS;</code> </pre> <br>  So, we saw this registration immediately after creation, but at the moment when the alert was supposed to work, the registration record simply disappeared.  In the logs, unfortunately, we could not find anything that would explain this behavior.  I had to take a chance and without looking to blame the firewall for everything.  Fortunately, we guessed it.  Therefore, my first recommendation is to remember to check the firewall and specify the port when registering notifications. <br><br>  Not all registration requests are supported.  It must be remembered that it may not be possible to read the data in one request and hang a notification on it.  If there are many joines in the request, it is better to mentally prepare yourself for having to write a similar, but simple request.  In addition, if you register an alert for a query with join-e, in fact, it will register as many alerts as there are tables in the query (each for its own table), which may waste resources. <br><br>  By default, registrations are created without a timeout.  That is, as it were, forever.  As a rule, such registration is not needed by anyone, because the time of the application is usually limited.  Such registration is very difficult then to pick out from the base, especially if there are a lot of them.  The correct way, apparently, would be to delete the registration when you finish working with it (if you do it in the same connection, and there is a link to the OracleDependency instance, this is easy to do, just call the RemoveRegistration method on the instance of OracleDependency class).  However, it seems to me that this method is only suitable for ideal worlds in which your applications never fall, communication channels never break and resources are always released.  Otherwise, ultimately, we will have the same thing as without deletion, however, the consequences will begin to manifest later (just when we go into production).  We solved the problem in this way - we began to always specify a timeout during registration.  And a few seconds before its expiration, delete the old registration and create a new one (to minimize the time of no registration).  The solution, of course, is not the most ideal, but in principle we are satisfied.  If you have any ideas on how to do better, I will be very happy to rewrite this piece of code. <br><br>  In order for the alerts to work faster within one application, we have divided into separate classes the logic for working with the database, the logic for notifying our objects of data change events, and the logic for managing both.  Thanks to this, we were able to use one common notification mechanism and send notifications inside the application manually, without going outside (in oracle).  For a user who works within his session and should see instantly the result of his actions, everything works well. <br><br><h3>  thank </h3><br>  That read my article to this place.  I would be very happy with any feedback, from the criticism of my code and methods of presentation of the material and ending with the emotions you experienced in the process of exploring this technology.  If you tell me about your experience with OCN, I will also be very happy and will be able to add some more material to my piggy bank. <br><br>  Thank you in advance. </div><p>Source: <a href="https://habr.com/ru/post/260407/">https://habr.com/ru/post/260407/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../260389/index.html">"Ajar data" / Notes on the traces of the open data board on June 15</a></li>
<li><a href="../260391/index.html">Blend4Web vs Unity. Battle of the Internet</a></li>
<li><a href="../260393/index.html">DDoS attack bypassing Qrator. How to protect yourself?</a></li>
<li><a href="../260397/index.html">SQA Days-17: with the best memories - to the next conference</a></li>
<li><a href="../260403/index.html">The main thing is to sit shoe. How 3D-technology helps to choose shoes by foot</a></li>
<li><a href="../260409/index.html">Sale of books at a discount of 50% and 30%</a></li>
<li><a href="../260411/index.html">Transformice story: indie game with 60 million users</a></li>
<li><a href="../260413/index.html">Instructions: Setting up the Gateway PD (AltLinux SPT 6.0 + VipNet Coordinator)</a></li>
<li><a href="../260415/index.html">Tale of how we supported the domestic manufacturer</a></li>
<li><a href="../260417/index.html">Compile and decompile try-with-resources</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>