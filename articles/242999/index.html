<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Postgres. Sample N random entries</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="When working on one project, it became necessary to write some sort of test system. The task was formulated like this: 



- among N records in the da...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Postgres. Sample N random entries</h1><div class="post__text post__text-html js-mediator-article">  When working on one project, it became necessary to write some sort of test system.  The task was formulated like this: <br><br><ul><li>  among N records in the database, it is necessary to select m (3-5) random rows in a series of k samples (mostly k = 2). </li></ul><br>  And now the same thing with human language: from the table you need two times to choose 3-5 random entries.  There should be no duplicates and sampling should occur randomly. <br><br>  The first thing that comes to mind: 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <pre><code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> data_set <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">id</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">IN</span></span> (<span class="hljs-number"><span class="hljs-number">1</span></span>,<span class="hljs-number"><span class="hljs-number">2</span></span>,<span class="hljs-number"><span class="hljs-number">3</span></span>,<span class="hljs-number"><span class="hljs-number">4</span></span>, <span class="hljs-number"><span class="hljs-number">5</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">ORDER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BY</span></span> random() <span class="hljs-keyword"><span class="hljs-keyword">LIMIT</span></span> <span class="hljs-number"><span class="hljs-number">5</span></span>;</code> </pre> <br>  And it will even work.  That's just the price of such a decision ... <br><a name="habracut"></a><br>  Therefore, we had to use the <a href="https://google.com/">"higher mind"</a> , which gave a <a href="http://postgresql.1045698.n5.nabble.com/Performance-of-ORDER-BY-RANDOM-to-select-random-rows-td5766760.html">hint of a solution</a> . <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">WITH</span></span> <span class="hljs-keyword"><span class="hljs-keyword">RECURSIVE</span></span> r <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> ( <span class="hljs-keyword"><span class="hljs-keyword">WITH</span></span> b <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">min</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">id</span></span>), <span class="hljs-keyword"><span class="hljs-keyword">max</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">id</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> table1) ( <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">id</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">min</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">max</span></span>, <span class="hljs-built_in"><span class="hljs-built_in">array</span></span>[]::<span class="hljs-built_in"><span class="hljs-built_in">integer</span></span>[] <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> a, <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> n <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> table1, b <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">id</span></span> &gt; <span class="hljs-keyword"><span class="hljs-keyword">min</span></span> + (<span class="hljs-keyword"><span class="hljs-keyword">max</span></span> - <span class="hljs-keyword"><span class="hljs-keyword">min</span></span>) * random() <span class="hljs-keyword"><span class="hljs-keyword">LIMIT</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> ) <span class="hljs-keyword"><span class="hljs-keyword">UNION</span></span> ALL ( <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> t.id, <span class="hljs-keyword"><span class="hljs-keyword">min</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">max</span></span>, a || t.id, rn + <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> n <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> table1 <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> t, r <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> t.id &gt; <span class="hljs-keyword"><span class="hljs-keyword">min</span></span> + (<span class="hljs-keyword"><span class="hljs-keyword">max</span></span> - <span class="hljs-keyword"><span class="hljs-keyword">min</span></span>) * random() <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> t.id &lt;&gt; all(a) <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> rn + <span class="hljs-number"><span class="hljs-number">1</span></span> &lt; <span class="hljs-number"><span class="hljs-number">10</span></span> <span class="hljs-keyword"><span class="hljs-keyword">LIMIT</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> ) ) <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> t.id <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> table1 <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> t, r <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> r.id = t.id;</code> </pre><br>  That's just the solution is ... "slightly" incomprehensible.  And to drag incomprehensible decisions into the project is somehow reluctant.  Therefore, it was decided to go by a <a href="https://google.com/">proven path</a> , where we managed to find an explanation of the essence of <a href="http://habrahabr.ru/post/73700/">recursive queries</a> . <br><br>  What.  The logic in general has become more or less understandable: n times we select one line at a time with a random offset from the minimum ID value (primary key).  Thus, the query affects a maximum of N rows instead of brute forceing the table contents. <br><br>  But "it was smooth on paper."  When trying to use it "as is" (adjusted for table / field names), "surprises" surfaced: <br><br><ol><li>  The array in line 4 is created empty.  Because of this, duplicates may appear in the final sample.  Let's say a query in lines 4-7 returns id == 5.  After that, it executes the request in the <b>UNION</b> block (lines 9-15) and at some stage returns the same id == 5, since the previous id value did not fall into the array ‚Äú <b>a</b> ‚Äù and the test in line 13 ‚Äút.id &lt;&gt; all (a) "was successful; </li><li>  The number of values ‚Äã‚Äãat the ‚Äúoutput‚Äù was no more than indicated (p. 14).  But less than this - easily.  Even if this quantity was guaranteed in the table.  Sometimes an empty sample was returned (the number of values ‚Äã‚Äãis ‚Äú0‚Äù). </li></ol><br>  It turned out to be relatively easy to cope with the first ‚Äúfeature‚Äù - it was enough just to change the line with array initialization.  Like that: <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">id</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">min</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">max</span></span>, <span class="hljs-built_in"><span class="hljs-built_in">array</span></span>[]::<span class="hljs-built_in"><span class="hljs-built_in">integer</span></span>[] || <span class="hljs-keyword"><span class="hljs-keyword">id</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> a, <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> n</code> </pre><br>  But the second point forced poraskinut brains.  The catch came to light in the very heart of the algorithm ‚Äî selection of a record from a range.  Indeed, a recursive query tries to select a line for which the condition would be met: <br><br><pre> <code class="sql hljs">id &gt; min + (max - min) * random()</code> </pre><br>  But in the case when <b>random ()</b> returns ‚Äú1‚Äù, this condition transforms into: <br><br><pre> <code class="sql hljs">id &gt; max</code> </pre><br>  Naturally, in this case, the query will not find anything and stop working.  And if this happens at the first pass of the request, the ‚Äúoutput‚Äù will be empty.  Even if the database obviously contains the necessary records. <br><br>  The first impulse was to slightly change the condition and bring it to something like this: <br><br><pre> <code class="sql hljs">id &gt;= min + (max - min) * random()</code> </pre><br>  This, so to speak, solution allowed to get at least one line at the exit.  But it did not guarantee the receipt of a specified number of rows as a result.  I had to think further. <br><br>  After much deliberation, many attempts, and liters of <a href="http://ru.wikipedia.org/wiki/%25D0%259A%25D0%25BE%25D1%2584%25D0%25B5">stimulator</a> came to light <br>  such an option: <br><br><div class="spoiler">  <b class="spoiler_title">request code</b> <div class="spoiler_text"><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">WITH</span></span> <span class="hljs-keyword"><span class="hljs-keyword">RECURSIVE</span></span> r <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> ( <span class="hljs-keyword"><span class="hljs-keyword">WITH</span></span> b <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> ( <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">min</span></span>(t.id), ( <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> t.id <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> table1 <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> t <span class="hljs-keyword"><span class="hljs-keyword">ORDER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BY</span></span> t.id <span class="hljs-keyword"><span class="hljs-keyword">DESC</span></span> <span class="hljs-keyword"><span class="hljs-keyword">LIMIT</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">OFFSET</span></span> <span class="hljs-number"><span class="hljs-number">9</span></span> ) <span class="hljs-keyword"><span class="hljs-keyword">max</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> table1 <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> t ) ( <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">id</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">min</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">max</span></span>, <span class="hljs-built_in"><span class="hljs-built_in">array</span></span>[]::<span class="hljs-built_in"><span class="hljs-built_in">integer</span></span>[] || <span class="hljs-keyword"><span class="hljs-keyword">id</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> a, <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> n <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> table1 <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> t, b <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">id</span></span> &gt;= <span class="hljs-keyword"><span class="hljs-keyword">min</span></span> + ((<span class="hljs-keyword"><span class="hljs-keyword">max</span></span> - <span class="hljs-keyword"><span class="hljs-keyword">min</span></span>) * random())::<span class="hljs-built_in"><span class="hljs-built_in">int</span></span> <span class="hljs-keyword"><span class="hljs-keyword">LIMIT</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> ) <span class="hljs-keyword"><span class="hljs-keyword">UNION</span></span> ALL ( <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> t.id, <span class="hljs-keyword"><span class="hljs-keyword">min</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">max</span></span>, a || t.id, rn + <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> n <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> {<span class="hljs-keyword"><span class="hljs-keyword">table</span></span>} <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> t, r <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> t.id &gt;= <span class="hljs-keyword"><span class="hljs-keyword">min</span></span> + ((<span class="hljs-keyword"><span class="hljs-keyword">max</span></span> - <span class="hljs-keyword"><span class="hljs-keyword">min</span></span>) * random())::<span class="hljs-built_in"><span class="hljs-built_in">int</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> t.id &lt;&gt; all(a) <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> rn + <span class="hljs-number"><span class="hljs-number">1</span></span> &lt; <span class="hljs-number"><span class="hljs-number">10</span></span> <span class="hljs-keyword"><span class="hljs-keyword">LIMIT</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> ) ) <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> t.* <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> table1 <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> t, r <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> r.id = t.id</code> </pre></div></div><br>  All the salt in lines 5-11.  Those.  in order to ensure that the ‚Äúoutput‚Äù will have N elements, it is necessary to proceed from the worst possible scenario.  In this case - that random N returns 1 times in a row. Therefore, you need to know / have N-1 values ‚Äã‚Äãbefore max.  How to achieve this in the request?  As an option - to sort all the records by ID in descending order and produce an offset "down" by N rows.  And since ‚Äú&gt; =‚Äù is used in lines 19 and 25, the offset can be indicated as one less (N-1). <br><br>  That's good - the main difficulties have been resolved and the "little things" remain: the query in its current form is of little use.  After all, it is necessary to make a sample taking into account certain conditions.  In the simplest case, exclude the IDs of the records selected in the previous step from the selection.  In addition, one cannot exclude the possibility of using any additional conditions imposed on the rows in the table (is_active = true, is_deleted = false, ...).  After some reflection, it becomes clear that the conditions will have to be put in all essential parts of the query (almost all subqueries).  Approximately as in the following template: <br><br><div class="spoiler">  <b class="spoiler_title">template code</b> <div class="spoiler_text"><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">WITH</span></span> <span class="hljs-keyword"><span class="hljs-keyword">RECURSIVE</span></span> r <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> ( <span class="hljs-keyword"><span class="hljs-keyword">WITH</span></span> b <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> ( <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">min</span></span>(t.{pk}), ( <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> t.{pk} <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> {<span class="hljs-keyword"><span class="hljs-keyword">table</span></span>} <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> t <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> {<span class="hljs-keyword"><span class="hljs-keyword">exclude</span></span>} t.is_active <span class="hljs-keyword"><span class="hljs-keyword">ORDER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BY</span></span> t.{pk} <span class="hljs-keyword"><span class="hljs-keyword">DESC</span></span> <span class="hljs-keyword"><span class="hljs-keyword">LIMIT</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">OFFSET</span></span> {<span class="hljs-keyword"><span class="hljs-keyword">limit</span></span>} - <span class="hljs-number"><span class="hljs-number">1</span></span> ) <span class="hljs-keyword"><span class="hljs-keyword">max</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> {<span class="hljs-keyword"><span class="hljs-keyword">table</span></span>} <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> t <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> {<span class="hljs-keyword"><span class="hljs-keyword">exclude</span></span>} t.is_active ) ( <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> t.{pk}, <span class="hljs-keyword"><span class="hljs-keyword">min</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">max</span></span>, <span class="hljs-built_in"><span class="hljs-built_in">array</span></span>[]::<span class="hljs-built_in"><span class="hljs-built_in">integer</span></span>[] || t.{pk} <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> a, <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> n <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> {<span class="hljs-keyword"><span class="hljs-keyword">table</span></span>} <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> t, b <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> t.{pk} &gt;= <span class="hljs-keyword"><span class="hljs-keyword">min</span></span> + ((<span class="hljs-keyword"><span class="hljs-keyword">max</span></span> - <span class="hljs-keyword"><span class="hljs-keyword">min</span></span>) * random())::<span class="hljs-built_in"><span class="hljs-built_in">int</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> {<span class="hljs-keyword"><span class="hljs-keyword">exclude</span></span>} t.is_active <span class="hljs-keyword"><span class="hljs-keyword">LIMIT</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> ) <span class="hljs-keyword"><span class="hljs-keyword">UNION</span></span> ALL ( <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> t.{pk}, <span class="hljs-keyword"><span class="hljs-keyword">min</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">max</span></span>, a || t.{pk}, rn + <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> n <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> {<span class="hljs-keyword"><span class="hljs-keyword">table</span></span>} <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> t, r <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> t.{pk} &gt;= <span class="hljs-keyword"><span class="hljs-keyword">min</span></span> + ((<span class="hljs-keyword"><span class="hljs-keyword">max</span></span> - <span class="hljs-keyword"><span class="hljs-keyword">min</span></span>) * random())::<span class="hljs-built_in"><span class="hljs-built_in">int</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> t.{pk} &lt;&gt; all(a) <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> rn + <span class="hljs-number"><span class="hljs-number">1</span></span> &lt; {<span class="hljs-keyword"><span class="hljs-keyword">limit</span></span>} <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> {<span class="hljs-keyword"><span class="hljs-keyword">exclude</span></span>} t.is_active <span class="hljs-keyword"><span class="hljs-keyword">LIMIT</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> ) ) <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> {<span class="hljs-keyword"><span class="hljs-keyword">fields</span></span>} <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> {<span class="hljs-keyword"><span class="hljs-keyword">table</span></span>} <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> t, r <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> r.{pk} = t.{pk}</code> </pre><br></div></div><br>  Here in curly brackets are the named parameters to be replaced: <br><br><ul><li>  <b>{table}</b> - the name of the table; </li><li>  <b>{pk}</b> - PrimaryKey-field name; </li><li>  <b>{fields}</b> - list of fields for selection (you can also specify "*"); </li><li>  <b>{exclude}</b> - condition (set of conditions) for excluding records from the selection.  For example, "t.id NOT IN (1,2,3,4)"; </li><li>  <b>{limit}</b> - the number of records in the final sample </li></ul><br><br>  And, finally, the last one on the list, but not least, is the question ‚Äúis it worth the candle‚Äù?  What is the "profit" from this brain structure?  We will check. <br><br>  To begin, create a table in which the experiments will be conducted. <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">DROP</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">IF</span></span> <span class="hljs-keyword"><span class="hljs-keyword">EXISTS</span></span> ttbl; <span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">IF</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">EXISTS</span></span> ttbl ( <span class="hljs-keyword"><span class="hljs-keyword">id</span></span> <span class="hljs-built_in"><span class="hljs-built_in">serial</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, is_active <span class="hljs-built_in"><span class="hljs-built_in">BOOL</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DEFAULT</span></span> <span class="hljs-literal"><span class="hljs-literal">true</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">CONSTRAINT</span></span> ttbl_pkey PRIMARY <span class="hljs-keyword"><span class="hljs-keyword">KEY</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">id</span></span>) ) <span class="hljs-keyword"><span class="hljs-keyword">WITH</span></span> (OIDS=<span class="hljs-literal"><span class="hljs-literal">FALSE</span></span>);</code> </pre><br>  Now fill it with data.  In this case, it is necessary that the id values ‚Äã‚Äãdo not go sequentially, but have ‚Äúholes‚Äù.  Those.  not "1, 2, 3, 4, 5 ..." but at least "1, 4, 5, 8 ....".  To do this, we sketch a simple script. <br><div class="spoiler">  <b class="spoiler_title">script code</b> <div class="spoiler_text"><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> random <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> psycopg2 DB_TABLE = <span class="hljs-string"><span class="hljs-string">'ttbl'</span></span> PK_NAME = <span class="hljs-string"><span class="hljs-string">'id'</span></span> DATABASES = { <span class="hljs-string"><span class="hljs-string">'NAME'</span></span>: <span class="hljs-string"><span class="hljs-string">'test_db'</span></span>, <span class="hljs-string"><span class="hljs-string">'USER'</span></span>: <span class="hljs-string"><span class="hljs-string">'user_test'</span></span>, <span class="hljs-string"><span class="hljs-string">'PASSWORD'</span></span>: <span class="hljs-string"><span class="hljs-string">'R#Q9Jw*ZEKWOhBX+EP|3/xGkQn3'</span></span>, <span class="hljs-string"><span class="hljs-string">'HOST'</span></span>: <span class="hljs-string"><span class="hljs-string">'localhost'</span></span>, <span class="hljs-string"><span class="hljs-string">'PORT'</span></span>: <span class="hljs-string"><span class="hljs-string">''</span></span>, } TOTAL = <span class="hljs-number"><span class="hljs-number">10000000</span></span> current = <span class="hljs-number"><span class="hljs-number">0</span></span> step = <span class="hljs-number"><span class="hljs-number">10000</span></span> dev = <span class="hljs-number"><span class="hljs-number">8</span></span> <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> current &lt;= TOTAL: data = set() <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> x <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> range(current, current+step, <span class="hljs-number"><span class="hljs-number">10</span></span>): data.add(x + int(random.random() * dev)) x = cur.execute( <span class="hljs-string"><span class="hljs-string">"INSERT INTO {t_table} VALUES {t_items};"</span></span>.format( t_table=DB_TABLE, t_items=<span class="hljs-string"><span class="hljs-string">'('</span></span> + <span class="hljs-string"><span class="hljs-string">'), ('</span></span>.join(map(str, data)) + <span class="hljs-string"><span class="hljs-string">')'</span></span> ) ) current += step print(x, current) cur.execute(<span class="hljs-string"><span class="hljs-string">'COMMIT;'</span></span>)</code> </pre><br></div></div><br>  As can be seen from the code - each request inserts hundreds of records.  Values ‚Äã‚Äãchange in increments of about ‚Äú10‚Äù.  Approximately, because  each of the values ‚Äã‚Äãmay deviate by a random value in the range of 0-dev.  Those.  for two consecutive values ‚Äã‚Äãof x "340" and "350", any values ‚Äã‚Äãfrom the range 340-348 and 350-358 (342, 347, 340 ...; 351, 355, 358 ...) can be inserted into the table. <br><br>  Total in the table turned <br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">select</span></span> <span class="hljs-keyword"><span class="hljs-keyword">count</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">id</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> ttbl;</code> </pre><br>  1001,000 records <br><br>  Pretty decent amount.  Let's try to make a sample.  It is clear that a single sample is not an indicator.  Therefore, we produce a series of consecutive launches.  For definiteness - a series of 5 launches of requests of each type.  The results are tabulated and we calculate the average. <br><br>  First simple query <br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">select</span></span> t.* <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> ttbl t <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> t.id <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> (<span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-number"><span class="hljs-number">3</span></span>, <span class="hljs-number"><span class="hljs-number">10</span></span>, <span class="hljs-number"><span class="hljs-number">89</span></span>, <span class="hljs-number"><span class="hljs-number">99</span></span>, <span class="hljs-number"><span class="hljs-number">22</span></span>, <span class="hljs-number"><span class="hljs-number">24</span></span>, <span class="hljs-number"><span class="hljs-number">25</span></span>, <span class="hljs-number"><span class="hljs-number">28</span></span>, <span class="hljs-number"><span class="hljs-number">30</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> t.is_active <span class="hljs-keyword"><span class="hljs-keyword">order</span></span> <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> random() <span class="hljs-keyword"><span class="hljs-keyword">limit</span></span> <span class="hljs-number"><span class="hljs-number">5</span></span>;</code> </pre><br>  Results: <br><table><tbody><tr><th>  Item number </th><th>  time ms </th></tr><tr><td>  one </td><td>  697 </td></tr><tr><td>  2 </td><td>  605 </td></tr><tr><td>  3 </td><td>  624 </td></tr><tr><td>  four </td><td>  593 </td></tr><tr><td>  five </td><td>  611 </td></tr></tbody></table><br>  As you can see, the average query execution time is about <a href="https://habr.com/ru/post/242999/">*</a> 600ms. <br><br>  And now - "monster." <br><div class="spoiler">  <b class="spoiler_title">watch monster</b> <div class="spoiler_text"><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">WITH</span></span> <span class="hljs-keyword"><span class="hljs-keyword">RECURSIVE</span></span> r <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> ( <span class="hljs-keyword"><span class="hljs-keyword">WITH</span></span> b <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> ( <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">min</span></span>(t.id), ( <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> t.id <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> ttbl <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> t <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> t.id <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">IN</span></span> (<span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-number"><span class="hljs-number">3</span></span>, <span class="hljs-number"><span class="hljs-number">10</span></span>, <span class="hljs-number"><span class="hljs-number">89</span></span>, <span class="hljs-number"><span class="hljs-number">99</span></span>, <span class="hljs-number"><span class="hljs-number">22</span></span>, <span class="hljs-number"><span class="hljs-number">24</span></span>, <span class="hljs-number"><span class="hljs-number">25</span></span>, <span class="hljs-number"><span class="hljs-number">28</span></span>, <span class="hljs-number"><span class="hljs-number">30</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> t.is_active <span class="hljs-keyword"><span class="hljs-keyword">ORDER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BY</span></span> t.id <span class="hljs-keyword"><span class="hljs-keyword">DESC</span></span> <span class="hljs-keyword"><span class="hljs-keyword">LIMIT</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">OFFSET</span></span> <span class="hljs-number"><span class="hljs-number">5</span></span> - <span class="hljs-number"><span class="hljs-number">1</span></span> ) <span class="hljs-keyword"><span class="hljs-keyword">max</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> ttbl <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> t <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> t.id <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">IN</span></span> (<span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-number"><span class="hljs-number">3</span></span>, <span class="hljs-number"><span class="hljs-number">10</span></span>, <span class="hljs-number"><span class="hljs-number">89</span></span>, <span class="hljs-number"><span class="hljs-number">99</span></span>, <span class="hljs-number"><span class="hljs-number">22</span></span>, <span class="hljs-number"><span class="hljs-number">24</span></span>, <span class="hljs-number"><span class="hljs-number">25</span></span>, <span class="hljs-number"><span class="hljs-number">28</span></span>, <span class="hljs-number"><span class="hljs-number">30</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> t.is_active ) ( <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">id</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">min</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">max</span></span>, <span class="hljs-built_in"><span class="hljs-built_in">array</span></span>[]::<span class="hljs-built_in"><span class="hljs-built_in">integer</span></span>[] || <span class="hljs-keyword"><span class="hljs-keyword">id</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> a, <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> n <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> ttbl <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> t, b <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">id</span></span> &gt;= <span class="hljs-keyword"><span class="hljs-keyword">min</span></span> + ((<span class="hljs-keyword"><span class="hljs-keyword">max</span></span> - <span class="hljs-keyword"><span class="hljs-keyword">min</span></span>) * random())::<span class="hljs-built_in"><span class="hljs-built_in">int</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> t.id <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">IN</span></span> (<span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-number"><span class="hljs-number">3</span></span>, <span class="hljs-number"><span class="hljs-number">10</span></span>, <span class="hljs-number"><span class="hljs-number">89</span></span>, <span class="hljs-number"><span class="hljs-number">99</span></span>, <span class="hljs-number"><span class="hljs-number">22</span></span>, <span class="hljs-number"><span class="hljs-number">24</span></span>, <span class="hljs-number"><span class="hljs-number">25</span></span>, <span class="hljs-number"><span class="hljs-number">28</span></span>, <span class="hljs-number"><span class="hljs-number">30</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> t.is_active <span class="hljs-keyword"><span class="hljs-keyword">LIMIT</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> ) <span class="hljs-keyword"><span class="hljs-keyword">UNION</span></span> ALL ( <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> t.id, <span class="hljs-keyword"><span class="hljs-keyword">min</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">max</span></span>, a || t.id, rn + <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> n <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> ttbl <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> t, r <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> t.id &gt; <span class="hljs-keyword"><span class="hljs-keyword">min</span></span> + ((<span class="hljs-keyword"><span class="hljs-keyword">max</span></span> - <span class="hljs-keyword"><span class="hljs-keyword">min</span></span>) * random())::<span class="hljs-built_in"><span class="hljs-built_in">int</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> t.id &lt;&gt; all( a ) <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> rn + <span class="hljs-number"><span class="hljs-number">1</span></span> &lt; <span class="hljs-number"><span class="hljs-number">5</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> t.id <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">IN</span></span> (<span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-number"><span class="hljs-number">3</span></span>, <span class="hljs-number"><span class="hljs-number">10</span></span>, <span class="hljs-number"><span class="hljs-number">89</span></span>, <span class="hljs-number"><span class="hljs-number">99</span></span>, <span class="hljs-number"><span class="hljs-number">22</span></span>, <span class="hljs-number"><span class="hljs-number">24</span></span>, <span class="hljs-number"><span class="hljs-number">25</span></span>, <span class="hljs-number"><span class="hljs-number">28</span></span>, <span class="hljs-number"><span class="hljs-number">30</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> t.is_active <span class="hljs-keyword"><span class="hljs-keyword">LIMIT</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> ) ) <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> t.* <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> ttbl <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> t, r <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> r.id = t.id</code> </pre><br></div></div><br>  Results: <br><table><tbody><tr><th>  Item number </th><th>  time ms </th></tr><tr><td>  one </td><td>  15 </td></tr><tr><td>  2 </td><td>  17 </td></tr><tr><td>  3 </td><td>  eight </td></tr><tr><td>  four </td><td>  12 </td></tr><tr><td>  five </td><td>  12 </td></tr></tbody></table><br>  Average time about <a href="https://habr.com/ru/post/242999/">*</a> 15ms. <br><br>  Total difference is about one and a half order (40-50 times).  It was worth it. <br><br>  Requests were checked including.  and with a cold start (after restarting the machine / daemon).  And although the execution time in absolute terms changed, but the ratio remained constant (as far as possible).  Those.  A recursive query was always a few dozen times faster than a head-on solution. <br><br><h3>  Notes </h3><br><a name="note1"></a>  * About, because  the exact value of the role does not play due to deviations caused by the Postgres cache, the influence of the operating system, hardware, other software, etc. </div><p>Source: <a href="https://habr.com/ru/post/242999/">https://habr.com/ru/post/242999/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../242989/index.html">Run GWT Super Dev Mode for remote server</a></li>
<li><a href="../242991/index.html">High Frequency Trading Neighborhood - Part I</a></li>
<li><a href="../242993/index.html">Probabilistic programming - the key to artificial intelligence?</a></li>
<li><a href="../242995/index.html">Efficient Landing Page design or how not to remove ‚ÄúBad Cinema‚Äù</a></li>
<li><a href="../242997/index.html">Critical vulnerability in Microsoft SChannel</a></li>
<li><a href="../243001/index.html">Memo: How startups provide data protection in the cloud</a></li>
<li><a href="../243005/index.html">Monospaced fonts with programmer ligatures</a></li>
<li><a href="../243007/index.html">How a non-programmer created his mobile app</a></li>
<li><a href="../243009/index.html">Developer vulnerability in Raindrop.io</a></li>
<li><a href="../243011/index.html">Software renderer - 1: materiel</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>