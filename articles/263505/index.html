<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>We display data from Serial in Chrome Application</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hello, Habr! 

 I want to share the experience of creating a small application for Google Chrome, which interacts with the serial port. 

 Brief backg...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>We display data from Serial in Chrome Application</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/files/c1d/358/148/c1d358148f8e4d81889459e942c483d4.png" align="right"><br><br>  Hello, Habr! <br><br>  I want to share the experience of creating a small application for Google Chrome, which interacts with the serial port. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Brief background.  Many times I wanted the computer and the Arduino connected to it to work as a single system in which the microcontroller would be an intermediary for communicating with sensors and actuators, and the computer would be a large convenient console. <br><br>  In order for this to happen, you need to either sit on the console terminal on a computer or write some small GUI's.  Even the most primitive GUI's requires some disproportionate effort to create.  You need to select a framework, implement a bunch of side GUI logic, compile for various platforms, deal with dependencies, package .exe, check for Mac and Vendian, etc. <br><br>  It has long been heard that the API for Google Chrome applications gives access to Serial.  I wanted to try and at the same time master the creation of Chrome applications as such.  The result was a <a href="https://chrome.google.com/webstore/detail/serial-projector/kbkjgbkmphnikcpkcodjbifkblmgidia">Serial Projector</a> - a replacement for the regular Serial Monitor for the Arduino IDE. <br><br>  The essence is simple to disgrace: the application on the whole screen displays the last text string that came through the serial port.  This allows, for example, to display the readings of the device large and nude.  It may be useful for all exhibitions, presentations, installations. <br><br>  Details of the source code and a demonstration of work - under the cut. <br><a name="habracut"></a><br><img src="https://habrastorage.org/files/428/6b1/496/4286b149618b4fbfa91b91726b7653cb.jpg"><br><br><h2>  How the application works </h2><br>  Let's take a look at the Serial Projector.  All source is <a href="https://github.com/amperka/serial-projector">on GitHub</a> . <br><br>  So, what is the app for Google Chrome?  By and large this is just a dynamic web page.  Exactly the same as if you did it for your site.  It is possible and necessary to use all the same JavaScript, CSS, HTML5, to connect third-party libraries and gadgets.  I used jQuery, Backbone.js, Underscore.js.  The difference is that such a page may use an additional ‚Äúinsecure‚Äù API for working with the user's computer.  In particular, there is an <a href="https://developer.chrome.com/apps/serial">API for reading and writing the serial port</a> . <br><br>  And such an application can be easily published in the Chrome Web Store, and your users can install it. <br><br>  Just as it happens on mobiles, when installing, the application will ask for confirmation that you trust it to access this or that unsafe API.  Their list is specified in the application description file manifest.json: <br><br><pre><code class="javascript hljs"><span class="hljs-comment"><span class="hljs-comment">//... "permissions": [ "serial", "fullscreen" ] //...</span></span></code> </pre> <br><h3>  Serial port operation </h3><br>  The most interesting is in the file connection.js.  Below is the class model for interacting with a serial connection.  You should not read thoughtfully from top to bottom to understand everything.  I will give comments below. <br><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> RETRY_CONNECT_MS = <span class="hljs-number"><span class="hljs-number">1000</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> Connection = Backbone.Model.extend({ <span class="hljs-attr"><span class="hljs-attr">defaults</span></span>: { <span class="hljs-attr"><span class="hljs-attr">connectionId</span></span>: <span class="hljs-literal"><span class="hljs-literal">null</span></span>, <span class="hljs-attr"><span class="hljs-attr">path</span></span>: <span class="hljs-literal"><span class="hljs-literal">null</span></span>, <span class="hljs-attr"><span class="hljs-attr">bitrate</span></span>: <span class="hljs-number"><span class="hljs-number">9600</span></span>, <span class="hljs-attr"><span class="hljs-attr">autoConnect</span></span>: <span class="hljs-literal"><span class="hljs-literal">undefined</span></span>, <span class="hljs-attr"><span class="hljs-attr">ports</span></span>: [], <span class="hljs-attr"><span class="hljs-attr">buffer</span></span>: <span class="hljs-literal"><span class="hljs-literal">null</span></span>, <span class="hljs-attr"><span class="hljs-attr">text</span></span>: <span class="hljs-string"><span class="hljs-string">'...'</span></span>, <span class="hljs-attr"><span class="hljs-attr">error</span></span>: <span class="hljs-string"><span class="hljs-string">''</span></span>, }, <span class="hljs-attr"><span class="hljs-attr">initialize</span></span>: <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ chrome.serial.onReceive.addListener(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>._onReceive.bind(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>)); chrome.serial.onReceiveError.addListener(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>._onReceiveError.bind(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>)); }, <span class="hljs-attr"><span class="hljs-attr">enumeratePorts</span></span>: <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> self = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>; chrome.serial.getDevices(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">ports</span></span></span><span class="hljs-function">) </span></span>{ self.set(<span class="hljs-string"><span class="hljs-string">'ports'</span></span>, ports); self._checkPath(); }); }, <span class="hljs-attr"><span class="hljs-attr">hasPorts</span></span>: <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.get(<span class="hljs-string"><span class="hljs-string">'ports'</span></span>).length &gt; <span class="hljs-number"><span class="hljs-number">0</span></span>; }, <span class="hljs-attr"><span class="hljs-attr">autoConnect</span></span>: <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">enable</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.set(<span class="hljs-string"><span class="hljs-string">'autoConnect'</span></span>, enable); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (enable) { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>._tryConnect(); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>._disconnect(); } }, <span class="hljs-attr"><span class="hljs-attr">_tryConnect</span></span>: <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.get(<span class="hljs-string"><span class="hljs-string">'autoConnect'</span></span>)) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> path = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.get(<span class="hljs-string"><span class="hljs-string">'path'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> bitrate = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.get(<span class="hljs-string"><span class="hljs-string">'bitrate'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (path) { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> self = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>; chrome.serial.connect(path, {<span class="hljs-attr"><span class="hljs-attr">bitrate</span></span>: bitrate}, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">connectionInfo</span></span></span><span class="hljs-function">) </span></span>{ self.set(<span class="hljs-string"><span class="hljs-string">'buffer'</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-built_in"><span class="hljs-built_in">Uint8Array</span></span>(<span class="hljs-number"><span class="hljs-number">0</span></span>)); self.set(<span class="hljs-string"><span class="hljs-string">'connectionId'</span></span>, connectionInfo.connectionId); }); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.enumeratePorts(); setTimeout(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>._tryConnect.bind(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>), RETRY_CONNECT_MS); } }, <span class="hljs-attr"><span class="hljs-attr">_disconnect</span></span>: <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> cid = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.get(<span class="hljs-string"><span class="hljs-string">'connectionId'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!cid) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> self = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>; chrome.serial.disconnect(cid, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ self.set(<span class="hljs-string"><span class="hljs-string">'connectionId'</span></span>, <span class="hljs-literal"><span class="hljs-literal">null</span></span>); self.enumeratePorts(); }); }, <span class="hljs-attr"><span class="hljs-attr">_checkPath</span></span>: <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> path = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.get(<span class="hljs-string"><span class="hljs-string">'path'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> ports = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.get(<span class="hljs-string"><span class="hljs-string">'ports'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (ports.length == <span class="hljs-number"><span class="hljs-number">0</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.set(<span class="hljs-string"><span class="hljs-string">'path'</span></span>, <span class="hljs-literal"><span class="hljs-literal">null</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">var</span></span> i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; ports.length; ++i) { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> port = ports[i]; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (port.path == path) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>; } } <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.set(<span class="hljs-string"><span class="hljs-string">'path'</span></span>, ports[<span class="hljs-number"><span class="hljs-number">0</span></span>].path); }, <span class="hljs-attr"><span class="hljs-attr">_onReceive</span></span>: <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">receiveInfo</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> data = receiveInfo.data; data = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-built_in"><span class="hljs-built_in">Uint8Array</span></span>(data); <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.set(<span class="hljs-string"><span class="hljs-string">'buffer'</span></span>, catBuffers(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.get(<span class="hljs-string"><span class="hljs-string">'buffer'</span></span>), data)); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> lbr = findLineBreak(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.get(<span class="hljs-string"><span class="hljs-string">'buffer'</span></span>)); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (lbr !== <span class="hljs-literal"><span class="hljs-literal">undefined</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> txt = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.get(<span class="hljs-string"><span class="hljs-string">'buffer'</span></span>).slice(<span class="hljs-number"><span class="hljs-number">0</span></span>, lbr); <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.set(<span class="hljs-string"><span class="hljs-string">'buffer'</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.get(<span class="hljs-string"><span class="hljs-string">'buffer'</span></span>).slice(lbr + <span class="hljs-number"><span class="hljs-number">1</span></span>)); <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.set(<span class="hljs-string"><span class="hljs-string">'text'</span></span>, uintToString(txt)); } }, <span class="hljs-attr"><span class="hljs-attr">_onReceiveError</span></span>: <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">info</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>._disconnect(); <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.set(<span class="hljs-string"><span class="hljs-string">'error'</span></span>, info.error); <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.enumeratePorts(); } });</code> </pre><br>  Direct interaction with the Serial API can be seen in three places.  Firstly, in the class constructor: <br><br><pre> <code class="javascript hljs"> initialize: <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ chrome.serial.onReceive.addListener(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>._onReceive.bind(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>)); chrome.serial.onReceiveError.addListener(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>._onReceiveError.bind(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>)); }</code> </pre><br>  Here we set the traditional JS event handlers.  Upon successful receipt of the data portion, we will call the _onReceive method, and on any error _onReceiveError.  Connections are established, but there is no connection yet.  First you need to find out which Serial ports on the user's computer are currently being seen by Chrome: <br><br><pre> <code class="javascript hljs"> enumeratePorts: <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> self = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>; chrome.serial.getDevices(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">ports</span></span></span><span class="hljs-function">) </span></span>{ self.set(<span class="hljs-string"><span class="hljs-string">'ports'</span></span>, ports); self._checkPath(); }); },</code> </pre><br>  After polling the OS, the function passed as a parameter will be called with an array of found ports.  Each item is a dictionary containing the system path to the port, a human-readable name, a USB VID &amp; PID piece of hardware. <br><br>  With the system path in hand, you can finally connect: <br><br><pre> <code class="javascript hljs"> chrome.serial.connect(path, {<span class="hljs-attr"><span class="hljs-attr">bitrate</span></span>: bitrate}, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">connectionInfo</span></span></span><span class="hljs-function">) </span></span>{ self.set(<span class="hljs-string"><span class="hljs-string">'buffer'</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-built_in"><span class="hljs-built_in">Uint8Array</span></span>(<span class="hljs-number"><span class="hljs-number">0</span></span>)); self.set(<span class="hljs-string"><span class="hljs-string">'connectionId'</span></span>, connectionInfo.connectionId); });</code> </pre><br>  After the connection is established, again, the provided callback with the connection parameters will be invoked.  In particular, with connectionId, which is needed for most port operations. <br><br>  Now consider the process of obtaining and parsing data.  All of it fits in one class method: <br><br><pre> <code class="javascript hljs"> _onReceive: <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">receiveInfo</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> data = receiveInfo.data; data = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-built_in"><span class="hljs-built_in">Uint8Array</span></span>(data); <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.set(<span class="hljs-string"><span class="hljs-string">'buffer'</span></span>, catBuffers(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.get(<span class="hljs-string"><span class="hljs-string">'buffer'</span></span>), data)); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> lbr = findLineBreak(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.get(<span class="hljs-string"><span class="hljs-string">'buffer'</span></span>)); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (lbr !== <span class="hljs-literal"><span class="hljs-literal">undefined</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> txt = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.get(<span class="hljs-string"><span class="hljs-string">'buffer'</span></span>).slice(<span class="hljs-number"><span class="hljs-number">0</span></span>, lbr); <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.set(<span class="hljs-string"><span class="hljs-string">'buffer'</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.get(<span class="hljs-string"><span class="hljs-string">'buffer'</span></span>).slice(lbr + <span class="hljs-number"><span class="hljs-number">1</span></span>)); <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.set(<span class="hljs-string"><span class="hljs-string">'text'</span></span>, uintToString(txt)); } },</code> </pre><br>  Each time you receive a chunk of data, Chrome will call this function and send information about the received packet to it.  The data itself is transmitted in the data field.  It is of type ArrayBuffer, with which practically nothing can be done directly.  This is not a string, this is not an array, this is just a briquette of bytes "as is". <br><br>  In order to parse the briquette, you need to create a <i>projection of the</i> ArrayBuffer that knows how to interpret the raw data.  In the case of the Arduino, the compiler is AVR GCC, the source code is written to UTF-8, and therefore the data that is sent to the regular Serial.println is transmitted in the form of UTF-8 strings. <br><br>  Then everything is trivial: <br><ul><li>  We receive a portion of data </li><li>  We translate into an array of bytes through the projection. </li><li>  Glue to what is already in memory </li><li>  Looking for the character code of the line break </li><li>  If found - we cut the buffer on "before" and "after".  ‚ÄúBefore‚Äù we translate into a string and print it on the screen, ‚Äúafter‚Äù we leave it in memory </li><li>  Repeat forever </li></ul><br><h3>  A pair of helpers </h3><br>  To my surprise, projections, including our Uint8Array, began to support slice'ing only in recent versions of Chrome.  For compatibility with older versions, the method can be implemented independently: <br><br><pre> <code class="javascript hljs"><span class="hljs-built_in"><span class="hljs-built_in">Uint8Array</span></span>.prototype.slice = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">begin, end</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">typeof</span></span> begin === <span class="hljs-string"><span class="hljs-string">'undefined'</span></span>) { begin = <span class="hljs-number"><span class="hljs-number">0</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">typeof</span></span> end === <span class="hljs-string"><span class="hljs-string">'undefined'</span></span>) { end = <span class="hljs-built_in"><span class="hljs-built_in">Math</span></span>.max(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.length, begin); } <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> result = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-built_in"><span class="hljs-built_in">Uint8Array</span></span>(end - begin); <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">var</span></span> i = begin; i &lt; end; ++i) { result[i - begin] = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>[i]; } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> result; }</code> </pre><br>  There were also no functions for gluing arrays and turning them into regular lines in the box, therefore: <br><br><pre> <code class="javascript hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">catBuffers</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">a, b</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> result = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-built_in"><span class="hljs-built_in">Uint8Array</span></span>(a.length + b.length); result.set(a); result.set(b, a.length); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> result; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">uintToString</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">uintArray</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> encodedString = <span class="hljs-built_in"><span class="hljs-built_in">String</span></span>.fromCharCode.apply(<span class="hljs-literal"><span class="hljs-literal">null</span></span>, uintArray), decodedString = <span class="hljs-built_in"><span class="hljs-built_in">decodeURIComponent</span></span>(<span class="hljs-built_in"><span class="hljs-built_in">escape</span></span>(encodedString)); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> decodedString; }</code> </pre><br>  I will not give you the code for interacting with the HTML content of the page here, because it is extremely prosaic: a couple of triples of jQuery event handlers and Backbone models. <br><br><h2>  Total </h2><br>  So, if you need to quickly concoct a console for your hardware project and not worry about cross-platform, creating an installer and delivering updates and fixes, Chrome Applications is a smart choice. <br><br>  I hope the article showed you the big picture and you now have something to push off from.  And what finally happened with us, you can watch in the next video on our <a href="http://www.youtube.com/user/AmperkaRu">YouTube channel</a> : <br><br><iframe width="560" height="315" src="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://www.youtube.com/embed/JpcsKiafKZ8%3Ffeature%3Doembed&amp;xid=17259,15700019,15700186,15700191,15700248,15700253&amp;usg=ALkJrhis7LkZ8z8DbmyYHGOFD1lUliLMAQ" frameborder="0" allowfullscreen=""></iframe></div><p>Source: <a href="https://habr.com/ru/post/263505/">https://habr.com/ru/post/263505/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../263491/index.html">Analyzing large amounts of data with Apache Spark</a></li>
<li><a href="../263493/index.html">Implementation of the Hough Transform algorithm (Hough Transform) (+ work visualization)</a></li>
<li><a href="../263495/index.html">Digest of useful materials for iOS developers</a></li>
<li><a href="../263497/index.html">Intel lectures and training on software engineering. August, Moscow</a></li>
<li><a href="../263503/index.html">Blow from the past: DIPS-attack RIPv1, or the old routers are dangerous</a></li>
<li><a href="../263507/index.html">Python meetup - 2 years</a></li>
<li><a href="../263509/index.html">Developer Path, Part 3: The Game Creation History</a></li>
<li><a href="../263511/index.html">Improving Fody MethodDecoratorEx for asynchronous methods</a></li>
<li><a href="../263513/index.html">Continuous Success and why this should not be forgotten when developing a project (using the example of Drupal)</a></li>
<li><a href="../263515/index.html">Parsing a function from the standard library D</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>