<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Calculate bugs in the calculator Windows</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Recently, Microsoft has opened the source code of the calculator. This application is included in all versions of the Windows operating system. The so...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Calculate bugs in the calculator Windows</h1><div class="post__text post__text-html js-mediator-article"><div style="text-align:center;"><img src="https://habrastorage.org/webt/6f/da/q8/6fdaq8pfgpkoynkt0qwqvljuj7e.png"></div><br>  Recently, Microsoft has opened the source code of the calculator.  This application is included in all versions of the Windows operating system.  The source code of various Microsoft projects has often opened in recent years, but the news about the calculator on the very first day leaked even to non-technological media.  Well, this is a popular, but very small C ++ program, however, static code analysis using PVS-Studio revealed suspicious places in the code. <br><a name="habracut"></a><br><h2>  Introduction </h2><br>  Windows calculator is probably familiar to every user of this operating system and does not require any special presentation.  Now, any user can explore the source code of the calculator on <a href="https://github.com/Microsoft/calculator">GitHub</a> and suggest improvements. <br><br>  The public, for example, has already attracted the attention of such a function: <br><br><pre><code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">void</span></span> TraceLogger::LogInvalidInputPasted(....) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!GetTraceLoggingProviderEnabled()) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>; LoggingFields fields{}; fields.AddString(<span class="hljs-string"><span class="hljs-string">L"Mode"</span></span>, NavCategory::GetFriendlyName(mode)-&gt;Data()); fields.AddString(<span class="hljs-string"><span class="hljs-string">L"Reason"</span></span>, reason); fields.AddString(<span class="hljs-string"><span class="hljs-string">L"PastedExpression"</span></span>, pastedExpression); fields.AddString(<span class="hljs-string"><span class="hljs-string">L"ProgrammerNumberBase"</span></span>, GetProgrammerType(...).c_str()); fields.AddString(<span class="hljs-string"><span class="hljs-string">L"BitLengthType"</span></span>, GetProgrammerType(bitLengthType).c_str()); LogTelemetryEvent(EVENT_NAME_INVALID_INPUT_PASTED, fields); }</code> </pre> <br>  which logs text from the clipboard and possibly sends it to Microsoft servers.  But this note is not about that.  Although suspicious code examples will be many. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      We checked the source code of the calculator with the <a href="https://www.viva64.com/ru/pvs-studio/">PVS-Studio</a> static analyzer.  Since  the code is written in non-standard C ++, many regular readers of the analyzer blog doubted the possibility of analysis, but this turned out to be possible.  C ++ / CLI and C ++ / CX are supported by the analyzer.  Some diagnostics gave false warnings because of this, but nothing critical happened that would prevent using this tool. <br><br>  Perhaps you missed the news about other features of PVS-Studio, so I want to remind you that in addition to projects in C and C ++, you can analyze the code in C # and Java. <br><br><h2>  About incorrect string comparison </h2><br>  <a href="https://www.viva64.com/ru/w/v547/">V547</a> Expression 'm_resolvedName == L "en-US"' is always false.  To compare strings you should use wcscmp () function.  Calculator LocalizationSettings.h 180 <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">wchar_t</span></span> m_resolvedName[LOCALE_NAME_MAX_LENGTH]; Platform::String^ GetEnglishValueFromLocalizedDigits(....) <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (m_resolvedName == <span class="hljs-string"><span class="hljs-string">L"en-US"</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> ref <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Platform::String(localizedString.c_str()); } .... }</code> </pre> <br>  I look through the analyzer reports, sorting them by ascending diagnostic numbers and a warning to this code was the very first in the list and very successful. <br><br>  The fact is that the lines are incorrectly compared.  It was a comparison of pointers instead of string values.  Pointers are always unequal and therefore the condition is always false.  To correctly compare strings, it is recommended to use, for example, the <i>wcscmp ()</i> function. <br><br><h2>  Memory leak in native code </h2><br>  <a href="https://www.viva64.com/ru/w/v773/">V773</a> The function of the 'temp' pointer.  A memory leak is possible.  CalcViewModel StandardCalculatorViewModel.cpp 529 <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">void</span></span> StandardCalculatorViewModel::HandleUpdatedOperandData(Command cmdenum) { .... <span class="hljs-keyword"><span class="hljs-keyword">wchar_t</span></span>* temp = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-keyword"><span class="hljs-keyword">wchar_t</span></span>[<span class="hljs-number"><span class="hljs-number">100</span></span>]; .... <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (commandIndex == <span class="hljs-number"><span class="hljs-number">0</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">delete</span></span> [] temp; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>; } .... length = m_selectedExpressionLastData-&gt;Length() + <span class="hljs-number"><span class="hljs-number">1</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (length &gt; <span class="hljs-number"><span class="hljs-number">50</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>; } .... String^ updatedData = ref <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> String(temp); UpdateOperand(m_tokenPosition, updatedData); displayExpressionToken-&gt;Token = updatedData; IsOperandUpdatedUsingViewModel = <span class="hljs-literal"><span class="hljs-literal">true</span></span>; displayExpressionToken-&gt;CommandIndex = commandIndex; }</code> </pre> <br>  We see a pointer temp, referring to an array of 100 elements, under which the dynamic memory is allocated.  Unfortunately, the memory is released in just one place of the function; in all other places there is a memory leak.  It is not very big, but it is still a mistake for C ++ code. <br><br><h2>  Elusive exception </h2><br>  <a href="https://www.viva64.com/ru/w/v702/">V702</a> Classes should be kept from std :: exception (and alike) as 'public'.  CalcManager CalcException.h 4 <br><br><pre> <code class="cpp hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">CalcException</span></span></span><span class="hljs-class"> :</span></span> <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::exception { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span>: CalcException(HRESULT hr) { m_hr = hr; } <span class="hljs-function"><span class="hljs-function">HRESULT </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GetException</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> m_hr; } <span class="hljs-keyword"><span class="hljs-keyword">private</span></span>: HRESULT m_hr; };</code> </pre> <br>  The analyzer detected a class inherited from the class std :: exception through the private modifier (the default modifier if nothing is specified).  The problem with this code is that when you try to catch the general exception std :: exception, an exception of type CalcException will be skipped.  This behavior occurs because private inheritance eliminates implicit type conversion. <br><br><h2>  Missed day </h2><br>  <a href="https://www.viva64.com/ru/w/v719/">V719</a> The switch statement of the DateUnit enum: Day.  CalcViewModel DateCalculator.cpp 279 <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">enum</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> _</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Enum_is_bitflag_</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">DateUnit</span></span></span><span class="hljs-class"> {</span></span> Year = <span class="hljs-number"><span class="hljs-number">0x01</span></span>, Month = <span class="hljs-number"><span class="hljs-number">0x02</span></span>, Week = <span class="hljs-number"><span class="hljs-number">0x04</span></span>, Day = <span class="hljs-number"><span class="hljs-number">0x08</span></span> }; Windows::Globalization::Calendar^ m_calendar; DateTime DateCalculationEngine::AdjustCalendarDate(Windows::Foundation::DateTime date, DateUnit dateUnit, <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> difference) { m_calendar-&gt;SetDateTime(date); <span class="hljs-keyword"><span class="hljs-keyword">switch</span></span> (dateUnit) { <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> DateUnit::Year: { .... m_calendar-&gt;AddYears(difference); m_calendar-&gt;ChangeCalendarSystem(currentCalendarSystem); <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> DateUnit::Month: m_calendar-&gt;AddMonths(difference); <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> DateUnit::Week: m_calendar-&gt;AddWeeks(difference); <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> m_calendar-&gt;GetDateTime(); }</code> </pre> <br>  Suspiciously, the switch does not consider the case with <i>DateUnit :: Day</i> .  Because of this, the calendar value ( <i>m_calendar</i> variable) does not add the value associated with the day, although the <i>AddDays ()</i> method is <i>present</i> in the calendar. <br><br>  A few more suspicious places with a different listing: <br><br><ul><li>  V719 The switch statement doesn‚Äôt cover all values ‚Äã‚Äãof the 'eANGLE_TYPE' enum: ANGLE_RAD.  CalcManager trans.cpp 109 </li><li>  V719 The switch statement doesn‚Äôt cover all values ‚Äã‚Äãof the 'eANGLE_TYPE' enum: ANGLE_RAD.  CalcManager trans.cpp 204 </li><li>  V719 The switch statement doesn‚Äôt cover all values ‚Äã‚Äãof the 'eANGLE_TYPE' enum: ANGLE_RAD.  CalcManager trans.cpp 276 </li></ul><br><h2>  Suspicious comparison of real numbers </h2><br>  <a href="https://www.viva64.com/ru/w/v550/">V550</a> An odd precise comparison: ratio == threshold.  It is probably better to use: fabs (A - B) &lt;Epsilon.  Calculator AspectRatioTrigger.cpp 80 <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">void</span></span> AspectRatioTrigger::UpdateIsActive(Size sourceSize) { <span class="hljs-keyword"><span class="hljs-keyword">double</span></span> numerator, denominator; .... <span class="hljs-keyword"><span class="hljs-keyword">bool</span></span> isActive = <span class="hljs-literal"><span class="hljs-literal">false</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (denominator &gt; <span class="hljs-number"><span class="hljs-number">0</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">double</span></span> ratio = numerator / denominator; <span class="hljs-keyword"><span class="hljs-keyword">double</span></span> threshold = <span class="hljs-built_in"><span class="hljs-built_in">abs</span></span>(Threshold); isActive = ((ratio &gt; threshold) || (ActiveIfEqual &amp;&amp; (ratio == threshold))); } SetActive(isActive); }</code> </pre> <br>  The analyzer pointed to the suspicious expression <i>ratio == threshold</i> .  These double variables and an accurate comparison of such variables with a simple equality operator is hardly possible.  Moreover, the value of the <i>ratio</i> variable is obtained after the division operation. <br><br>  This is a very strange code for the Calculator application.  Therefore, I attach the entire list of warnings of this type: <br><br><ul><li>  V550 An odd precise comparison.  It is probably better to use: fabs (A - B) &lt;Epsilon.  CalcManager UnitConverter.cpp 752 </li><li>  V550 An odd precise comparison: stod (roundedString)! = 0.0.  It is probably better to use: fabs (A - B)&gt; Epsilon.  CalcManager UnitConverter.cpp 778 </li><li>  V550 An odd precise comparison.  It is probably better to use: fabs (A - B) &lt;Epsilon.  CalcManager UnitConverter.cpp 790 </li><li>  V550 An odd precise comparison: stod (roundedString)! = 0.0.  It is probably better to use: fabs (A - B)&gt; Epsilon.  CalcManager UnitConverter.cpp 820 </li><li>  V550 An odd precise comparison: conversionTable [m_toType] .ratio == 1.0.  It is probably better to use: fabs (A - B) &lt;Epsilon.  CalcManager UnitConverter.cpp 980 </li><li>  V550 An odd precise comparison: conversionTable [m_toType] .offset == 0.0.  It is probably better to use: fabs (A - B) &lt;Epsilon.  CalcManager UnitConverter.cpp 980 </li><li>  V550 An odd precise comparison: returnValue! = 0. This is a better precision: fabs (A - B)&gt; Epsilon.  CalcManager UnitConverter.cpp 1000 </li><li>  V550 An odd precise comparison: sizeToUse! = 0.0.  It is probably better to use: fabs (A - B)&gt; Epsilon.  CalcViewModel LocalizationService.cpp 270 </li><li>  V550 An odd precise comparison: sizeToUse! = 0.0.  It is probably better to use: fabs (A - B)&gt; Epsilon.  CalcViewModel LocalizationService.cpp 289 </li><li>  V550 An odd precise comparison: sizeToUse! = 0.0.  It is probably better to use: fabs (A - B)&gt; Epsilon.  CalcViewModel LocalizationService.cpp 308 </li><li>  V550 An odd precise comparison: sizeToUse! = 0.0.  It is probably better to use: fabs (A - B)&gt; Epsilon.  CalcViewModel LocalizationService.cpp 327 </li><li>  V550 An odd precise comparison: stod (stringToLocalize) == 0. This is a better way to compare accuracy: fabs (A - B) &lt;Epsilon.  CalcViewModel UnitConverterViewModel.cpp 388 </li></ul><br><h2>  Suspicious sequence of functions </h2><br>  <a href="https://www.viva64.com/ru/w/v1020/">V1020</a> The function exited without calling the 'TraceLogger :: GetInstance (). LogNewWindowCreationEnd' function.  Check lines: 396, 375. Calculator App.xaml.cpp 396 <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">void</span></span> App::OnAppLaunch(IActivatedEventArgs^ args, String^ argument) { .... <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!m_preLaunched) { <span class="hljs-keyword"><span class="hljs-keyword">auto</span></span> newCoreAppView = CoreApplication::CreateNewView(); newCoreAppView-&gt;Dispatcher-&gt;RunAsync(....([....]() { TraceLogger::GetInstance().LogNewWindowCreationBegin(....); <span class="hljs-comment"><span class="hljs-comment">// &lt;= Begin .... TraceLogger::GetInstance().LogNewWindowCreationEnd(....); // &lt;= End })); } else { TraceLogger::GetInstance().LogNewWindowCreationBegin(....); // &lt;= Begin ActivationViewSwitcher^ activationViewSwitcher; auto activateEventArgs = dynamic_cast&lt;IViewSwitcherProvider^&gt;(args); if (activateEventArgs != nullptr) { activationViewSwitcher = activateEventArgs-&gt;ViewSwitcher; } if (activationViewSwitcher != nullptr) { activationViewSwitcher-&gt;ShowAsStandaloneAsync(....); TraceLogger::GetInstance().LogNewWindowCreationEnd(....); // &lt;= End TraceLogger::GetInstance().LogPrelaunchedAppActivatedByUser(); } else { TraceLogger::GetInstance().LogError(L"Null_ActivationViewSwitcher"); } } m_preLaunched = false; .... }</span></span></code> </pre> <br>  Diagnostics V1020 analyzes blocks of code and heuristically tries to find branches of code in which the function call is forgotten. <br><br>  In the above code snippet, the analyzer found a code block with a call to the <i>LogNewWindowCreationBegin</i> and <i>LogNewWindowCreationEnd functions</i> .  Below, he found a similar block of code in which the <i>LogNewWindowCreationEnd</i> function <i>is</i> called only under certain conditions, which is suspicious. <br><br><h2>  Unreliable tests </h2><br>  <a href="https://www.viva64.com/ru/w/v621/">V621</a> Consider inspecting the 'for' operator.  It is possible that you will not be executed at all.  CalculatorUnitTests UnitConverterViewModelUnitTests.cpp 500 <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">enum</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">NumbersAndOperatorsEnum</span></span></span><span class="hljs-class"> {</span></span> .... Add = (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>) CM::Command::CommandADD, <span class="hljs-comment"><span class="hljs-comment">// 93 .... None = (int) CM::Command::CommandNULL, // 0 .... }; TEST_METHOD(TestButtonCommandFiresModelCommands) { .... for (NumbersAndOperatorsEnum button = NumbersAndOperatorsEnum::Add; button &lt;= NumbersAndOperatorsEnum::None; button++) { if (button == NumbersAndOperatorsEnum::Decimal || button == NumbersAndOperatorsEnum::Negate || button == NumbersAndOperatorsEnum::Backspace) { continue; } vm.ButtonPressed-&gt;Execute(button); VERIFY_ARE_EQUAL(++callCount, mock-&gt;m_sendCommandCallCount); VERIFY_IS_TRUE(UCM::Command::None == mock-&gt;m_lastCommand); } .... }</span></span></code> </pre> <br>  The analyzer detected a for loop in which no iteration is performed, and therefore no tests are executed.  The initial value of the loop counter <i>button</i> (93) immediately exceeds the final (0). <br><br>  <a href="https://www.viva64.com/ru/w/v760/">V760</a> Two identical blocks of text were found.  The second block begins from line 688. CalculatorUnitTests UnitConverterViewModelUnitTests.cpp 683 <br><br><pre> <code class="cpp hljs">TEST_METHOD(TestSwitchAndReselectCurrentlyActiveValueDoesNothing) { <span class="hljs-built_in"><span class="hljs-built_in">shared_ptr</span></span>&lt;UnitConverterMock&gt; mock = make_shared&lt;UnitConverterMock&gt;(); VM::<span class="hljs-function"><span class="hljs-function">UnitConverterViewModel </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">vm</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(mock)</span></span></span></span>; <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> WCHAR * vFrom = <span class="hljs-string"><span class="hljs-string">L"1"</span></span>, *vTo = <span class="hljs-string"><span class="hljs-string">L"234"</span></span>; vm.UpdateDisplay(vFrom, vTo); vm.Value2Active = <span class="hljs-literal"><span class="hljs-literal">true</span></span>; <span class="hljs-comment"><span class="hljs-comment">// Establish base condition VERIFY_ARE_EQUAL((UINT)1, mock-&gt;m_switchActiveCallCount); VERIFY_ARE_EQUAL((UINT)1, mock-&gt;m_sendCommandCallCount); VERIFY_ARE_EQUAL((UINT)1, mock-&gt;m_setCurUnitTypesCallCount); vm.Value2Active = true; VERIFY_ARE_EQUAL((UINT)1, mock-&gt;m_switchActiveCallCount); VERIFY_ARE_EQUAL((UINT)1, mock-&gt;m_sendCommandCallCount); VERIFY_ARE_EQUAL((UINT)1, mock-&gt;m_setCurUnitTypesCallCount); }</span></span></code> </pre> <br>  Another test with a suspicious code.  The analyzer detected identical code fragments running one after the other.  Perhaps the code was written by copying these fragments, but the programmer forgot to change part of the code. <br><br>  <a href="https://www.viva64.com/ru/w/v601/">V601</a> The ' <a href="https://www.viva64.com/ru/w/v601/">fake</a> ' value is an implicitly cast to the integer type.  Inspect the second argument.  CalculatorUnitTests CalcInputTest.cpp 352 <br><br><pre> <code class="cpp hljs">Rational CalcInput::ToRational(<span class="hljs-keyword"><span class="hljs-keyword">uint32_t</span></span> radix, <span class="hljs-keyword"><span class="hljs-keyword">int32_t</span></span> precision) { .... } TEST_METHOD(ToRational) { .... <span class="hljs-keyword"><span class="hljs-keyword">auto</span></span> rat = m_calcInput.ToRational(<span class="hljs-number"><span class="hljs-number">10</span></span>, <span class="hljs-literal"><span class="hljs-literal">false</span></span>); .... }</code> </pre> <br>  The Boolean value <i>false is</i> passed to the <i>ToRational</i> function, although the parameter is of type <i>int32_t</i> and is called <i>precision</i> . <br><br>  I decided to track the value used in the code.  Then it is passed to the <i>StringToRat</i> function: <br><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-function">PRAT </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">StringToRat</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(...., </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int32_t</span></span></span></span><span class="hljs-function"><span class="hljs-params"> precision)</span></span></span><span class="hljs-function"> </span></span>{ .... }</code> </pre> <br>  and then in <i>StringToNumber</i> : <br><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-function">PNUMBER </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">StringToNumber</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(...., </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int32_t</span></span></span></span><span class="hljs-function"><span class="hljs-params"> precision)</span></span></span><span class="hljs-function"> </span></span>{ .... stripzeroesnum(pnumret, precision); .... }</code> </pre> <br>  And here is the body of the desired function: <br><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">bool</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">stripzeroesnum</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(_Inout_ PNUMBER pnum, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">long</span></span></span></span><span class="hljs-function"><span class="hljs-params"> starting)</span></span></span><span class="hljs-function"> </span></span>{ MANTTYPE *pmant; <span class="hljs-keyword"><span class="hljs-keyword">long</span></span> cdigits; <span class="hljs-keyword"><span class="hljs-keyword">bool</span></span> fstrip = <span class="hljs-literal"><span class="hljs-literal">false</span></span>; pmant=pnum-&gt;mant; cdigits=pnum-&gt;cdigit; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ( cdigits &gt; starting ) <span class="hljs-comment"><span class="hljs-comment">// &lt;= { pmant += cdigits - starting; cdigits = starting; } .... }</span></span></code> </pre> <br>  Here we see that the <i>precision</i> variable is called <i>starting</i> and participates in the expression <i>cdigits&gt; starting</i> , which is very strange, because the value <i>false</i> was originally passed there. <br><br><h2>  Redundancy </h2><br>  <a href="https://www.viva64.com/ru/w/v560/">V560</a> A part of the conditional expression is always true: NumbersAndOperatorsEnum :: None! = Op.  CalcViewModel UnitConverterViewModel.cpp 991 <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">void</span></span> UnitConverterViewModel::OnPaste(String^ stringToPaste, ViewMode mode) { .... NumbersAndOperatorsEnum op = MapCharacterToButtonId(*it, canSendNegate); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (NumbersAndOperatorsEnum::None != op) <span class="hljs-comment"><span class="hljs-comment">// &lt;= { .... if (NumbersAndOperatorsEnum::None != op &amp;&amp; // &lt;= NumbersAndOperatorsEnum::Negate != op) { .... } .... } .... }</span></span></code> </pre> <br>  The variable <i>op</i> has already been compared with the value of <i>NumbersAndOperatorsEnum :: None</i> and duplicate checks can be removed. <br><br>  <a href="https://www.viva64.com/ru/w/v728/">V728 Anonymous</a> check can be simplified.  The '(A &amp;&amp; B) ||  (! A &amp;&amp;! B) 'expression is equivalent to the' bool (A) == bool (B) 'expression.  Calculator Calculator.xaml.cpp 239 <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">void</span></span> Calculator::AnimateCalculator(<span class="hljs-keyword"><span class="hljs-keyword">bool</span></span> resultAnimate) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (App::IsAnimationEnabled()) { m_doAnimate = <span class="hljs-literal"><span class="hljs-literal">true</span></span>; m_resultAnimate = resultAnimate; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (((m_isLastAnimatedInScientific &amp;&amp; IsScientific) || (!m_isLastAnimatedInScientific &amp;&amp; !IsScientific)) &amp;&amp; ((m_isLastAnimatedInProgrammer &amp;&amp; IsProgrammer) || (!m_isLastAnimatedInProgrammer &amp;&amp; !IsProgrammer))) { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>-&gt;OnStoryboardCompleted(<span class="hljs-literal"><span class="hljs-literal">nullptr</span></span>, <span class="hljs-literal"><span class="hljs-literal">nullptr</span></span>); } } }</code> </pre> <br>  This giant conditional expression originally had a width of 218 characters, but I broke it up into several lines to demonstrate a warning.  And you can rewrite the code to such a short and most importantly readable version: <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ( m_isLastAnimatedInScientific == IsScientific &amp;&amp; m_isLastAnimatedInProgrammer == IsProgrammer) { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>-&gt;OnStoryboardCompleted(<span class="hljs-literal"><span class="hljs-literal">nullptr</span></span>, <span class="hljs-literal"><span class="hljs-literal">nullptr</span></span>); }</code> </pre> <br>  <a href="https://www.viva64.com/ru/w/v524/">V524</a> It is odd that the body of ConvertBack function is fully equivalent.  Calculator BooleanNegationConverter.cpp 24 <br><br><pre> <code class="cpp hljs">Object^ BooleanNegationConverter::Convert(....) { (<span class="hljs-keyword"><span class="hljs-keyword">void</span></span>) targetType; <span class="hljs-comment"><span class="hljs-comment">// Unused parameter (void) parameter; // Unused parameter (void) language; // Unused parameter auto boxedBool = dynamic_cast&lt;Box&lt;bool&gt;^&gt;(value); auto boolValue = (boxedBool != nullptr &amp;&amp; boxedBool-&gt;Value); return !boolValue; } Object^ BooleanNegationConverter::ConvertBack(....) { (void) targetType; // Unused parameter (void) parameter; // Unused parameter (void) language; // Unused parameter auto boxedBool = dynamic_cast&lt;Box&lt;bool&gt;^&gt;(value); auto boolValue = (boxedBool != nullptr &amp;&amp; boxedBool-&gt;Value); return !boolValue; }</span></span></code> </pre> <br>  The analyzer detected two functions that are implemented in the same way.  The names of the functions <i>Convert ()</i> and <i>ConvertBack ()</i> suggest that they should perform different actions, but the developers know better. <br><br><h2>  Conclusion </h2><br>  Probably, every open project from Microsoft gave us the opportunity to show the importance of applying the methodology of static analysis.  Even on such small projects as a calculator.  In such large companies as Microsoft, Google, Amazon and others, there are many talented programmers, but they are the same people who make mistakes in the code.  The use of static code analysis tools is one of the good ways to improve the quality of programs in any development teams. <br><br>  Check your ‚ÄúCalculator‚Äù by downloading <a href="https://www.viva64.com/ru/pvs-studio-download/">PVS-Studio</a> and trying it on your project :-) </div><p>Source: <a href="https://habr.com/ru/post/443100/">https://habr.com/ru/post/443100/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../443082/index.html">Why when learning one language you should not look at others</a></li>
<li><a href="../443084/index.html">Facebook refuses to transfer servers to countries with violation of freedom of speech and introduces end-to-end encryption</a></li>
<li><a href="../443092/index.html">The new ultrasound sensor will allow you to ‚Äúlisten‚Äù to the bacteria - how it works</a></li>
<li><a href="../443094/index.html">Setting up from scratch CUPS print server with and without domain authorization on a network with different operating systems</a></li>
<li><a href="../443098/index.html">The data on the disk will be recorded using magnets and lasers.</a></li>
<li><a href="../443102/index.html">Behavior change as a product: why does Marie Kondo raise a $ 40M round with Sequoia Capital?</a></li>
<li><a href="../443104/index.html">We calculate symbolic expressions with fuzzy triangular numbers in python</a></li>
<li><a href="../443106/index.html">Announced USB4: what's known about the standard</a></li>
<li><a href="../443110/index.html">Set up a Kubernetes HA cluster on bare metal with GlusterFS & MetalLB. Part 2/3</a></li>
<li><a href="../443112/index.html">Are you sure you can trust your VPN?</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>