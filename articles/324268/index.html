<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Juniper: composite-next-hop</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="In the article on EVPN, I mentioned the need to include composite-next-hop for EVPN, after which at least 10 people asked me the same question - what ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Juniper: composite-next-hop</h1><div class="post__text post__text-html js-mediator-article"><div style="text-align:center;"><img src="https://habrastorage.org/files/f41/169/b15/f41169b1567a4e718b0d228c4bbed344.jpg" alt="image alt"></div><br>  In the article on EVPN, I mentioned the need to include composite-next-hop for EVPN, after which at least 10 people asked me the same question - what exactly is composite-next-hop.  And I suppose that composite-next-hop for many is a mysterious technology, which makes it possible to drastically reduce the number of next-hops.  This topic is very well covered in the ‚ÄúMPLS in SDN era‚Äù book, and I will briefly describe how this works based on the article from this book. <a name="habracut"></a><br><br>  I think that all engineers dealing with routers know that there is a routing information base (RIB) and FIB (forwarding information base).  RIB is compiled on the basis of information obtained from dynamic routing protocols, as well as on the basis of static routes and connected interfaces.  Each protocol, whether bgp or isis, installs routes into its database from which the best routes based on protocol preference (administrative distance in terms of tsisko) are already installed into the routing table (RIB) and, very importantly, it is from RIB that routes are announced further .  Here, for example, an entry in the rib route to the prefix 10.0.0.0/24: <br><br><pre><code class="javascript hljs">bormoglotx@RZN-PE2&gt; show route table VRF1.inet<span class="hljs-number"><span class="hljs-number">.0</span></span> <span class="hljs-number"><span class="hljs-number">10.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span>/<span class="hljs-number"><span class="hljs-number">24</span></span> VRF1.inet<span class="hljs-number"><span class="hljs-number">.0</span></span>: <span class="hljs-number"><span class="hljs-number">8</span></span> destinations, <span class="hljs-number"><span class="hljs-number">13</span></span> routes (<span class="hljs-number"><span class="hljs-number">8</span></span> active, <span class="hljs-number"><span class="hljs-number">0</span></span> holddown, <span class="hljs-number"><span class="hljs-number">0</span></span> hidden) + = Active Route, - = Last Active, * = Both <span class="hljs-number"><span class="hljs-number">10.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span>/<span class="hljs-number"><span class="hljs-number">24</span></span> *[BGP/<span class="hljs-number"><span class="hljs-number">170</span></span>] <span class="hljs-number"><span class="hljs-number">15</span></span>:<span class="hljs-number"><span class="hljs-number">42</span></span>:<span class="hljs-number"><span class="hljs-number">58</span></span>, localpref <span class="hljs-number"><span class="hljs-number">100</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-number"><span class="hljs-number">62.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.64</span></span> AS path: I, validation-state: unverified to <span class="hljs-number"><span class="hljs-number">10.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span> via ae0<span class="hljs-number"><span class="hljs-number">.1</span></span>, Push <span class="hljs-number"><span class="hljs-number">16</span></span> &gt; to <span class="hljs-number"><span class="hljs-number">10.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.6</span></span> via ae1<span class="hljs-number"><span class="hljs-number">.0</span></span>, Push <span class="hljs-number"><span class="hljs-number">16</span></span>, Push <span class="hljs-number"><span class="hljs-number">299888</span></span>(top) [BGP/<span class="hljs-number"><span class="hljs-number">170</span></span>] <span class="hljs-number"><span class="hljs-number">15</span></span>:<span class="hljs-number"><span class="hljs-number">42</span></span>:<span class="hljs-number"><span class="hljs-number">58</span></span>, localpref <span class="hljs-number"><span class="hljs-number">100</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-number"><span class="hljs-number">62.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.65</span></span> AS path: I, validation-state: unverified to <span class="hljs-number"><span class="hljs-number">10.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span> via ae0<span class="hljs-number"><span class="hljs-number">.1</span></span>, Push <span class="hljs-number"><span class="hljs-number">16</span></span> &gt; to <span class="hljs-number"><span class="hljs-number">10.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.6</span></span> via ae1<span class="hljs-number"><span class="hljs-number">.0</span></span>, Push <span class="hljs-number"><span class="hljs-number">16</span></span>, Push <span class="hljs-number"><span class="hljs-number">299888</span></span>(top)</code> </pre> <br>  The RIB provides us with complete information on each route, such as: the protocol that installed the route, the route metrics, the presence of equivalent paths, the community, etc., as well as the reasons for the current inactivity of the route.  But the RIB is purely a control plane, and it is not convenient to use this table for forwarding to the router.  Therefore, based on the RIB, the router (to be more precise, this is what the RE does) forms the FIB and sends it to all the PFEs.  In FIB, there is no longer redundant information about protocols and metrics - all you need to know about PFE is the prefix itself, next-hop, through which this prefix is ‚Äã‚Äãavailable, as well as the labels that need to be hung when sending a packet: 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <pre> <code class="javascript hljs">bormoglotx@RZN-PE2&gt; show route forwarding-table vpn VRF1 destination <span class="hljs-number"><span class="hljs-number">10.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span>/<span class="hljs-number"><span class="hljs-number">24</span></span> Routing table: VRF1.inet Internet: Destination Type RtRef Next hop Type Index NhRef Netif <span class="hljs-number"><span class="hljs-number">10.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span>/<span class="hljs-number"><span class="hljs-number">24</span></span> user <span class="hljs-number"><span class="hljs-number">0</span></span> indr <span class="hljs-number"><span class="hljs-number">1048576</span></span> <span class="hljs-number"><span class="hljs-number">4</span></span> ulst <span class="hljs-number"><span class="hljs-number">1048575</span></span> <span class="hljs-number"><span class="hljs-number">2</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>:<span class="hljs-number"><span class="hljs-number">5</span></span>:<span class="hljs-number"><span class="hljs-number">86</span></span>:<span class="hljs-number"><span class="hljs-number">71</span></span>:<span class="hljs-number"><span class="hljs-number">49</span></span>:c0 Push <span class="hljs-number"><span class="hljs-number">16</span></span> <span class="hljs-number"><span class="hljs-number">572</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> ae0<span class="hljs-number"><span class="hljs-number">.1</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>:<span class="hljs-number"><span class="hljs-number">5</span></span>:<span class="hljs-number"><span class="hljs-number">86</span></span>:<span class="hljs-number"><span class="hljs-number">71</span></span>:<span class="hljs-number"><span class="hljs-number">9</span></span>d:c1 Push <span class="hljs-number"><span class="hljs-number">16</span></span>, Push <span class="hljs-number"><span class="hljs-number">299888</span></span>(top) <span class="hljs-number"><span class="hljs-number">583</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> ae1<span class="hljs-number"><span class="hljs-number">.0</span></span></code> </pre> <br>  Note: Usually only one route will go to the FIB, but we use ECMP balancing and RE sends two routes to the PFE if there is an equivalent route. <br><br>  Today we will talk about next-hop.  On Juniper equipment there are several types of next-hops: <br><br><pre> <code class="javascript hljs">VMX(RZN-PE2 vty)# show nhdb summary detail Type Count --------- --------- Discard <span class="hljs-number"><span class="hljs-number">18</span></span> Reject <span class="hljs-number"><span class="hljs-number">17</span></span> Unicast <span class="hljs-number"><span class="hljs-number">47</span></span> Unilist <span class="hljs-number"><span class="hljs-number">4</span></span> Indexed <span class="hljs-number"><span class="hljs-number">0</span></span> Indirect <span class="hljs-number"><span class="hljs-number">4</span></span> Hold <span class="hljs-number"><span class="hljs-number">0</span></span> Resolve <span class="hljs-number"><span class="hljs-number">5</span></span> Local <span class="hljs-number"><span class="hljs-number">20</span></span> Recv <span class="hljs-number"><span class="hljs-number">17</span></span> Multi-RT <span class="hljs-number"><span class="hljs-number">0</span></span> Bcast <span class="hljs-number"><span class="hljs-number">9</span></span> Mcast <span class="hljs-number"><span class="hljs-number">11</span></span> Mgroup <span class="hljs-number"><span class="hljs-number">3</span></span> mdiscard <span class="hljs-number"><span class="hljs-number">11</span></span> Table <span class="hljs-number"><span class="hljs-number">17</span></span> Deny <span class="hljs-number"><span class="hljs-number">0</span></span> Aggreg. <span class="hljs-number"><span class="hljs-number">18</span></span> Crypto <span class="hljs-number"><span class="hljs-number">0</span></span> Iflist <span class="hljs-number"><span class="hljs-number">0</span></span> Sample <span class="hljs-number"><span class="hljs-number">0</span></span> Flood <span class="hljs-number"><span class="hljs-number">0</span></span> Service <span class="hljs-number"><span class="hljs-number">0</span></span> Multirtc <span class="hljs-number"><span class="hljs-number">0</span></span> Compst <span class="hljs-number"><span class="hljs-number">7</span></span> DmxResolv <span class="hljs-number"><span class="hljs-number">0</span></span> DmxIFL <span class="hljs-number"><span class="hljs-number">0</span></span> DmxtIFL <span class="hljs-number"><span class="hljs-number">0</span></span> LITAP <span class="hljs-number"><span class="hljs-number">0</span></span> Limd <span class="hljs-number"><span class="hljs-number">0</span></span> LI <span class="hljs-number"><span class="hljs-number">0</span></span> RNH_LE <span class="hljs-number"><span class="hljs-number">0</span></span> VCFI <span class="hljs-number"><span class="hljs-number">0</span></span> VCMF <span class="hljs-number"><span class="hljs-number">0</span></span></code> </pre> <br>  Many of them are intuitive, some of the above you will not find in your practice.  We will focus on some of the above and begin with a simple direct next-hop, which in terms of Juniper is called unicast. <br><br>  <b>Unicast next-hop.</b> <br><br><pre> <code class="javascript hljs"> <span class="hljs-number"><span class="hljs-number">604</span></span>(Unicast, IPv4-&gt;MPLS, <span class="hljs-attr"><span class="hljs-attr">ifl</span></span>:<span class="hljs-number"><span class="hljs-number">340</span></span>:ge<span class="hljs-number"><span class="hljs-number">-0</span></span>/<span class="hljs-number"><span class="hljs-number">0</span></span>/<span class="hljs-number"><span class="hljs-number">2.0</span></span>, pfe-id:<span class="hljs-number"><span class="hljs-number">0</span></span>) &lt;&lt;<span class="xml"><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;&lt;&lt;&lt; </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">605</span></span></span></span><span class="xml"><span class="hljs-tag">(</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">Unicast</span></span></span></span><span class="xml"><span class="hljs-tag">, </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">IPv4-</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml">MPLS, ifl:341:ge-0/0/3.0, pfe-id:0) </span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;&lt;&lt;&lt;&lt;&lt; </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">606</span></span></span></span><span class="xml"><span class="hljs-tag">(</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">Unicast</span></span></span></span><span class="xml"><span class="hljs-tag">, </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">IPv4-</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml">MPLS, ifl:342:ge-0/0/4.0, pfe-id:0) </span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;&lt;&lt;&lt;&lt;&lt;</span></span></span></span></code> </pre> <br>  The simplest kind of next-hop is straight next-hop.  It points straight to the physical interface through which the prefix is ‚Äã‚Äãaccessible.  If this next-hop type were the only one, then for each prefix a separate next-hop would be created and no matter in which routing table this prefix is ‚Äã‚Äãlocated - in vrf or grt.  Yes, it is very simple and understandable, but not everything that the engineer understands at first glance is good.  Let us give an example: if we have 100 vrfs, each of which has 100 prefixes, we will get 10,000 physical next-hops (this is only for vrf-prefixes).  Add more routes protocols isis, ldp, rsvp, and so on. <br><br><blockquote>  Note: for simplicity of reasoning and simpler understanding, we will assume that we have no equivalent paths and aggregation interfaces.  On the hierarchy of next-hop-s in the presence of these, we will talk a little later. </blockquote><br>  As a result, the next-hop limit can be reached very quickly.  But this is not the main problem - now the glands withstand more than 1M IPv4 prefixes in the FIB.  The fact is that if one of the interfaces crashes and recalculates the routes, the router will have to overwrite all the next hops that are currently installed in the forwarding table (in our case, all 10,000).  Yes, igp routes will be overwritten quickly - there are not so many of them, but with vpnv4 / l2vpn / evpn there are usually several dozen (sometimes hundreds) of routes.  Naturally, rewriting such a number of next-hops will take some time and you may lose some traffic.  And this we have not yet taken into account the possibility of having an FW on the box, which now has 645K routes. <br><br>  The most interesting thing about using direct next-hop is that even if all these 10,000 prefixes arrive from the same PE (i.e., have the same protocol next-hop), you will still have to update all 10,000 next-hops  But if you think logically, then in fact in this situation, we will have only 100 unique next-hops (subject to the distribution of service labels per-vrf), which differ only in the service label - the transport label and the outgoing interface will be exactly the same.  Now you will not find next-hop direct for prefixes in vrf (on Junos anyway) - to be more precise, you cannot even include next-hop direct for L3VPN and other services on cards with a TRIO chipset not supported  But it won't work out at all either - unicast next-hop points straight to the interface to which the packet should be sent and when using the hierarchical next-hop (which we will talk about later), the last level of hierarchy will be exactly unicast next-hop.  Well, how else?  It should be mentioned that in addition to the outgoing interface, this kind of next-hop also includes a label stack and encapsulation, but more on that later. <br><br>  It looks like unicast next-hop for the route received by isis, like this: <br><br><pre> <code class="javascript hljs">bormoglotx@RZN-PE2&gt; show route forwarding-table destination <span class="hljs-number"><span class="hljs-number">10.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.2</span></span>/<span class="hljs-number"><span class="hljs-number">31</span></span> table <span class="hljs-keyword"><span class="hljs-keyword">default</span></span> Routing table: <span class="hljs-keyword"><span class="hljs-keyword">default</span></span>.inet Internet: Destination Type RtRef Next hop Type Index NhRef Netif <span class="hljs-number"><span class="hljs-number">10.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.2</span></span>/<span class="hljs-number"><span class="hljs-number">31</span></span> user <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">10.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.6</span></span> ucst <span class="hljs-number"><span class="hljs-number">693</span></span> <span class="hljs-number"><span class="hljs-number">19</span></span> ae1<span class="hljs-number"><span class="hljs-number">.0</span></span> bormoglotx@RZN-PE2&gt; show route forwarding-table destination <span class="hljs-number"><span class="hljs-number">10.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.2</span></span>/<span class="hljs-number"><span class="hljs-number">31</span></span> table <span class="hljs-keyword"><span class="hljs-keyword">default</span></span> extensive Routing table: <span class="hljs-keyword"><span class="hljs-keyword">default</span></span>.inet [Index <span class="hljs-number"><span class="hljs-number">0</span></span>] Internet: Destination: <span class="hljs-number"><span class="hljs-number">10.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.2</span></span>/<span class="hljs-number"><span class="hljs-number">31</span></span> Route type: user Route reference: <span class="hljs-number"><span class="hljs-number">0</span></span> Route interface-index: <span class="hljs-number"><span class="hljs-number">0</span></span> Multicast RPF nh index: <span class="hljs-number"><span class="hljs-number">0</span></span> Flags: sent to PFE, rt nh decoupled Nexthop: <span class="hljs-number"><span class="hljs-number">10.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.6</span></span> Next-hop type: unicast Index: <span class="hljs-number"><span class="hljs-number">693</span></span> Reference: <span class="hljs-number"><span class="hljs-number">19</span></span> Next-hop interface: ae1<span class="hljs-number"><span class="hljs-number">.0</span></span></code> </pre> <br>  <b>Aggregate next-hop</b> <br><br><pre> <code class="javascript hljs"> <span class="hljs-number"><span class="hljs-number">584</span></span>(Aggreg., IPv4, <span class="hljs-attr"><span class="hljs-attr">ifl</span></span>:<span class="hljs-number"><span class="hljs-number">326</span></span>:ae0<span class="hljs-number"><span class="hljs-number">.1</span></span>, pfe-id:<span class="hljs-number"><span class="hljs-number">0</span></span>) &lt;&lt;<span class="xml"><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;&lt;&lt;&lt;&lt;&lt; </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">585</span></span></span></span><span class="xml"><span class="hljs-tag">(</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">Unicast</span></span></span></span><span class="xml"><span class="hljs-tag">, </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">IPv4</span></span></span></span><span class="xml"><span class="hljs-tag">, </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">ifl:337:ge-0</span></span></span></span><span class="xml"><span class="hljs-tag">/</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">0</span></span></span></span><span class="xml"><span class="hljs-tag">/</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">0.1</span></span></span></span><span class="xml"><span class="hljs-tag">, </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">pfe-id:0</span></span></span></span><span class="xml"><span class="hljs-tag">) </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">586</span></span></span></span><span class="xml"><span class="hljs-tag">(</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">Unicast</span></span></span></span><span class="xml"><span class="hljs-tag">, </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">IPv4</span></span></span></span><span class="xml"><span class="hljs-tag">, </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">ifl:339:ge-0</span></span></span></span><span class="xml"><span class="hljs-tag">/</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">0</span></span></span></span><span class="xml"><span class="hljs-tag">/</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">1.1</span></span></span></span><span class="xml"><span class="hljs-tag">, </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">pfe-id:0</span></span></span></span><span class="xml"><span class="hljs-tag">) </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">603</span></span></span></span><span class="xml"><span class="hljs-tag">(</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">Aggreg.</span></span></span></span><span class="xml"><span class="hljs-tag">, </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">IPv4-</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml">MPLS, ifl:327:ae1.0, pfe-id:0) </span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;&lt;&lt;&lt;&lt;&lt;&lt; </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">604</span></span></span></span><span class="xml"><span class="hljs-tag">(</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">Unicast</span></span></span></span><span class="xml"><span class="hljs-tag">, </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">IPv4-</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml">MPLS, ifl:340:ge-0/0/2.0, pfe-id:0) 605(Unicast, IPv4-&gt;MPLS, ifl:341:ge-0/0/3.0, pfe-id:0) 606(Unicast, IPv4-&gt;MPLS, ifl:342:ge-0/0/4.0, pfe-id:0)</span></span></code> </pre> <br>  It's all very simple - I think you can guess that this hierarchy appears when we have the prefix visible through the aggregation interface.  Aggregation next-hop is essentially a sheet of real next-hop (physical interfaces) that are included in the aggregate.  If you use aggregates, then the number of next-hops increases in proportion to the number of links in the aggregate.  In the output above, you see two Aggregate next-hops, each of which in turn points to the physical next-hops that are included in these aggregates. <br><br>  <b>Unilist-next-hop</b> <br><br><pre> <code class="javascript hljs"> <span class="hljs-number"><span class="hljs-number">1048574</span></span>(Unilist, IPv4, <span class="hljs-attr"><span class="hljs-attr">ifl</span></span>:<span class="hljs-number"><span class="hljs-number">0</span></span>:-, pfe-id:<span class="hljs-number"><span class="hljs-number">0</span></span>) &lt;&lt;<span class="xml"><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;&lt;&lt;&lt;&lt;&lt; </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">584</span></span></span></span><span class="xml"><span class="hljs-tag">(</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">Aggreg.</span></span></span></span><span class="xml"><span class="hljs-tag">, </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">IPv4</span></span></span></span><span class="xml"><span class="hljs-tag">, </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">ifl:326:ae0.1</span></span></span></span><span class="xml"><span class="hljs-tag">, </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">pfe-id:0</span></span></span></span><span class="xml"><span class="hljs-tag">) </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">585</span></span></span></span><span class="xml"><span class="hljs-tag">(</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">Unicast</span></span></span></span><span class="xml"><span class="hljs-tag">, </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">IPv4</span></span></span></span><span class="xml"><span class="hljs-tag">, </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">ifl:337:ge-0</span></span></span></span><span class="xml"><span class="hljs-tag">/</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">0</span></span></span></span><span class="xml"><span class="hljs-tag">/</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">0.1</span></span></span></span><span class="xml"><span class="hljs-tag">, </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">pfe-id:0</span></span></span></span><span class="xml"><span class="hljs-tag">) </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">586</span></span></span></span><span class="xml"><span class="hljs-tag">(</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">Unicast</span></span></span></span><span class="xml"><span class="hljs-tag">, </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">IPv4</span></span></span></span><span class="xml"><span class="hljs-tag">, </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">ifl:339:ge-0</span></span></span></span><span class="xml"><span class="hljs-tag">/</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">0</span></span></span></span><span class="xml"><span class="hljs-tag">/</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">1.1</span></span></span></span><span class="xml"><span class="hljs-tag">, </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">pfe-id:0</span></span></span></span><span class="xml"><span class="hljs-tag">) </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">603</span></span></span></span><span class="xml"><span class="hljs-tag">(</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">Aggreg.</span></span></span></span><span class="xml"><span class="hljs-tag">, </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">IPv4-</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml">MPLS, ifl:327:ae1.0, pfe-id:0) 604(Unicast, IPv4-&gt;MPLS, ifl:340:ge-0/0/2.0, pfe-id:0) 605(Unicast, IPv4-&gt;MPLS, ifl:341:ge-0/0/3.0, pfe-id:0) 606(Unicast, IPv4-&gt;MPLS, ifl:342:ge-0/0/4.0, pfe-id:0)</span></span></code> </pre> <br>  Actually, this is also a very simple hierarchy and is somewhat similar to the aggregate.  It appears only when we have equivalent paths and, in essence, is simply a listing of all equivalent paths.  In our case, we have two equivalent paths and both through aggregates. <br><blockquote>  Note: in our case, the stars converged so that the unicast id (585, 586) go in order after Aggregate id (584) (in terms of numbers, and not in the order of hierarchy), but this is not always the case. </blockquote><br>  All the listed next-hops do not help to reduce the number of physical next-hops, but on the contrary increase their number.  The next two types of next-hop are designed to optimize FIB and reduce the number of unicast next-hops. <br><br>  <b>Indirect next-hop.</b> <br><br><pre> <code class="javascript hljs"> <span class="hljs-number"><span class="hljs-number">1048577</span></span>(Indirect, IPv4, <span class="hljs-attr"><span class="hljs-attr">ifl</span></span>:<span class="hljs-number"><span class="hljs-number">327</span></span>:ae1<span class="hljs-number"><span class="hljs-number">.0</span></span>, pfe-id:<span class="hljs-number"><span class="hljs-number">0</span></span>, i-ifl:<span class="hljs-number"><span class="hljs-number">0</span></span>:-) &lt;&lt;<span class="xml"><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;&lt;&lt;&lt; </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">1048574</span></span></span></span><span class="xml"><span class="hljs-tag">(</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">Unilist</span></span></span></span><span class="xml"><span class="hljs-tag">, </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">IPv4</span></span></span></span><span class="xml"><span class="hljs-tag">, </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">ifl:0:-</span></span></span></span><span class="xml"><span class="hljs-tag">, </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">pfe-id:0</span></span></span></span><span class="xml"><span class="hljs-tag">) </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">584</span></span></span></span><span class="xml"><span class="hljs-tag">(</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">Aggreg.</span></span></span></span><span class="xml"><span class="hljs-tag">, </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">IPv4</span></span></span></span><span class="xml"><span class="hljs-tag">, </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">ifl:326:ae0.1</span></span></span></span><span class="xml"><span class="hljs-tag">, </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">pfe-id:0</span></span></span></span><span class="xml"><span class="hljs-tag">) </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">585</span></span></span></span><span class="xml"><span class="hljs-tag">(</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">Unicast</span></span></span></span><span class="xml"><span class="hljs-tag">, </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">IPv4</span></span></span></span><span class="xml"><span class="hljs-tag">, </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">ifl:337:ge-0</span></span></span></span><span class="xml"><span class="hljs-tag">/</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">0</span></span></span></span><span class="xml"><span class="hljs-tag">/</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">0.1</span></span></span></span><span class="xml"><span class="hljs-tag">, </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">pfe-id:0</span></span></span></span><span class="xml"><span class="hljs-tag">) </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">586</span></span></span></span><span class="xml"><span class="hljs-tag">(</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">Unicast</span></span></span></span><span class="xml"><span class="hljs-tag">, </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">IPv4</span></span></span></span><span class="xml"><span class="hljs-tag">, </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">ifl:339:ge-0</span></span></span></span><span class="xml"><span class="hljs-tag">/</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">0</span></span></span></span><span class="xml"><span class="hljs-tag">/</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">1.1</span></span></span></span><span class="xml"><span class="hljs-tag">, </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">pfe-id:0</span></span></span></span><span class="xml"><span class="hljs-tag">) </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">603</span></span></span></span><span class="xml"><span class="hljs-tag">(</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">Aggreg.</span></span></span></span><span class="xml"><span class="hljs-tag">, </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">IPv4-</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml">MPLS, ifl:327:ae1.0, pfe-id:0) 604(Unicast, IPv4-&gt;MPLS, ifl:340:ge-0/0/2.0, pfe-id:0) 605(Unicast, IPv4-&gt;MPLS, ifl:341:ge-0/0/3.0, pfe-id:0) 606(Unicast, IPv4-&gt;MPLS, ifl:342:ge-0/0/4.0, pfe-id:0)</span></span></code> </pre> <br>  Literally, the word indirect translates as indirect.  This type of next-hop is used to reduce the number of physical next-hops.  Nevertheless, 10,000 next-hops, which we obtained by simple computation when considering unicast next-hop, are somehow too much.  Now read our next-hop again.  We have 100 vrfs in which 100 prefixes each (prefixes are generated per-vrf) and announced with the same PE.  It turns out that all of these prefixes in such a scenario will have the same protocol-next-hop (loopback remote PE) and the outgoing interface (well, as a result, the same transport label).  The difference will only be in the service tag.  But since we generate tags per-vrf, we will have 100 tags in total.  As a result, we get that 10,000 direct next-hops can be aggregated into 100 next-hops, which will have exactly the same stack of labels. <br><br>  The concept of indirect next-hop allows for all prefixes that are reachable through the same protocol next-hop to use the same indirect-next-hop.  I would like to draw the reader‚Äôs attention to the fact that aggregation occurs via protocol next-hop, since there may not be a service tag at all (for example, routes to the Internet), but its presence has a great influence on indirect-next-hop. <br><br>  Alas, the main problem with indirect-hop is that it refers to unicast-next-hop, which indicates the full stack of tags, including the service tag: <br><br><pre> <code class="javascript hljs">bormoglotx@RZN-PE2&gt;show route forwarding-table table VRF1 destination <span class="hljs-number"><span class="hljs-number">10.2</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span>/<span class="hljs-number"><span class="hljs-number">24</span></span> extensive Routing table: VRF1.inet [Index <span class="hljs-number"><span class="hljs-number">9</span></span>] Internet: Destination: <span class="hljs-number"><span class="hljs-number">10.2</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span>/<span class="hljs-number"><span class="hljs-number">24</span></span> Route type: user Route reference: <span class="hljs-number"><span class="hljs-number">0</span></span> Route interface-index: <span class="hljs-number"><span class="hljs-number">0</span></span> Multicast RPF nh index: <span class="hljs-number"><span class="hljs-number">0</span></span> Flags: sent to PFE Next-hop type: indirect Index: <span class="hljs-number"><span class="hljs-number">1048587</span></span> Reference: <span class="hljs-number"><span class="hljs-number">2</span></span> Nexthop: <span class="hljs-number"><span class="hljs-number">10.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.6</span></span> Next-hop type: Push <span class="hljs-number"><span class="hljs-number">24008</span></span>, Push <span class="hljs-number"><span class="hljs-number">299920</span></span>(top) Index: <span class="hljs-number"><span class="hljs-number">706</span></span> Reference: <span class="hljs-number"><span class="hljs-number">2</span></span> Load Balance Label: None Next-hop interface: ae1<span class="hljs-number"><span class="hljs-number">.0</span></span></code> </pre> <br>  This line describes the full stack of tags: <br><br><pre> <code class="javascript hljs"> Next-hop type: Push <span class="hljs-number"><span class="hljs-number">24008</span></span>, Push <span class="hljs-number"><span class="hljs-number">299920</span></span>(top) Index: <span class="hljs-number"><span class="hljs-number">706</span></span> Reference: <span class="hljs-number"><span class="hljs-number">2</span></span></code> </pre> <br>  As you can see, the 24008 label is a service label and is included on the stack at the last level of the next-hop hierarchy.  Based on this, it is impossible for several indirect-next-hops to point to the same physical one - the service tag is different for everyone.  In addition, for example, L2CKT and VPLS use different encapsulations.  Therefore, under certain conditions described above, indirect-next-hop may not give any profit. <br><br>  It‚Äôs not hard to guess that if we use the per-prefix label distribution (for some unknown reason, this label distribution method is used by default on Cisco and Huawei), then indirect-next-hop doesn‚Äôt help us much, as we now have there will be a separate service tag for each prefix.  As a result, we cannot combine several prefixes into one next-hop, since they are attainable through the same next-hop protocol, but have a different service label, which in the worst-case scenario for us leads to the appearance of 10,000 next-hops, though not direct but indirect.  It turned out as in the proverb- ‚Äúhorseradish radish is not sweeter‚Äù ... Plus, everything else, all L2CKT, even if they are named on the same pair of PE-nis, will have different labels (and there‚Äôs nothing you can do about it - generate one label on several L2CKT-s does not work).  How the developers defeated this problem will be described later. <br><br>  Of course, in real conditions indirect-next-hop allows us to significantly reduce the number of next-hops (as few people do not use the vrf-table-label or the distribution of per-vrf tags).  Moreover, on Juniper MX, indirect-net-hop is enabled by default and this feature cannot be disabled.  In addition, if you have FW on the router, then these prefixes will not have a service tag at all (if you have not stuck the FW in vrf of course) and for all prefixes the same inirect-next-hop will be on the Internet. <br><br>  But there is no limit to perfection and we want an even more scalable solution.  Besides, I repeat, but L2CKT-you will always have different service tags, and therefore different indirect next-hops.  The solution that fixes this problem is called chained-composite-next-hop (in Juniper terms, Cisco is a little different). <br><br>  <b>Chained-composite-next-hop</b> <br><br><pre> <code class="javascript hljs"><span class="hljs-number"><span class="hljs-number">607</span></span>(Compst, IPv4-&gt;MPLS, <span class="hljs-attr"><span class="hljs-attr">ifl</span></span>:<span class="hljs-number"><span class="hljs-number">0</span></span>:-, pfe-id:<span class="hljs-number"><span class="hljs-number">0</span></span>, comp-fn:Chain) &lt;&lt;<span class="xml"><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;&lt;&lt;&lt;&lt; </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">1048577</span></span></span></span><span class="xml"><span class="hljs-tag">(</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">Indirect</span></span></span></span><span class="xml"><span class="hljs-tag">, </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">IPv4</span></span></span></span><span class="xml"><span class="hljs-tag">, </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">ifl:327:ae1.0</span></span></span></span><span class="xml"><span class="hljs-tag">, </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">pfe-id:0</span></span></span></span><span class="xml"><span class="hljs-tag">, </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">i-ifl:0:-</span></span></span></span><span class="xml"><span class="hljs-tag">) </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">1048574</span></span></span></span><span class="xml"><span class="hljs-tag">(</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">Unilist</span></span></span></span><span class="xml"><span class="hljs-tag">, </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">IPv4</span></span></span></span><span class="xml"><span class="hljs-tag">, </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">ifl:0:-</span></span></span></span><span class="xml"><span class="hljs-tag">, </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">pfe-id:0</span></span></span></span><span class="xml"><span class="hljs-tag">) </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">584</span></span></span></span><span class="xml"><span class="hljs-tag">(</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">Aggreg.</span></span></span></span><span class="xml"><span class="hljs-tag">, </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">IPv4</span></span></span></span><span class="xml"><span class="hljs-tag">, </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">ifl:326:ae0.1</span></span></span></span><span class="xml"><span class="hljs-tag">, </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">pfe-id:0</span></span></span></span><span class="xml"><span class="hljs-tag">) </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">585</span></span></span></span><span class="xml"><span class="hljs-tag">(</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">Unicast</span></span></span></span><span class="xml"><span class="hljs-tag">, </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">IPv4</span></span></span></span><span class="xml"><span class="hljs-tag">, </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">ifl:337:ge-0</span></span></span></span><span class="xml"><span class="hljs-tag">/</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">0</span></span></span></span><span class="xml"><span class="hljs-tag">/</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">0.1</span></span></span></span><span class="xml"><span class="hljs-tag">, </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">pfe-id:0</span></span></span></span><span class="xml"><span class="hljs-tag">) </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">586</span></span></span></span><span class="xml"><span class="hljs-tag">(</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">Unicast</span></span></span></span><span class="xml"><span class="hljs-tag">, </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">IPv4</span></span></span></span><span class="xml"><span class="hljs-tag">, </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">ifl:339:ge-0</span></span></span></span><span class="xml"><span class="hljs-tag">/</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">0</span></span></span></span><span class="xml"><span class="hljs-tag">/</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">1.1</span></span></span></span><span class="xml"><span class="hljs-tag">, </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">pfe-id:0</span></span></span></span><span class="xml"><span class="hljs-tag">) </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">603</span></span></span></span><span class="xml"><span class="hljs-tag">(</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">Aggreg.</span></span></span></span><span class="xml"><span class="hljs-tag">, </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">IPv4-</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml">MPLS, ifl:327:ae1.0, pfe-id:0) 604(Unicast, IPv4-&gt;MPLS, ifl:340:ge-0/0/2.0, pfe-id:0) 605(Unicast, IPv4-&gt;MPLS, ifl:341:ge-0/0/3.0, pfe-id:0) 606(Unicast, IPv4-&gt;MPLS, ifl:342:ge-0/0/4.0, pfe-id:0)</span></span></code> </pre> <br>  As we found out indirect-next-hop is a matryoshka from next-hop.  Exactly the same matryoshka and chained-composite-next-hop, but now we have another level in the hierarchy.  How else can you combine prefixes into groups and associate them with the same next-hop?  What else does all L3VPN or all L2CKTs have in common?  True - this is a family of addresses.  At the very top of the next-hop hierarchy there is a composite next-hop, which combines routes by a service tag, but unlike indirect-next-hop, composite next-hop refers to this tag.  That is, the service tag is now indicated not at the latest level of the hierarchy - uniast, but at the first level of the hierarchy.  This allows us to overcome the problem that we identified when discussing indirect-next-hop.  For example, look at the entry in the FIB for the same prefix 10.2.0.0/24, but with the composite-next-hop enabled: <br><br><pre> <code class="javascript hljs">bormoglotx@RZN-PE2&gt; show route forwarding-table table VRF1 destination <span class="hljs-number"><span class="hljs-number">10.2</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span>/<span class="hljs-number"><span class="hljs-number">24</span></span> extensive Routing table: VRF1.inet [Index <span class="hljs-number"><span class="hljs-number">9</span></span>] Internet: Destination: <span class="hljs-number"><span class="hljs-number">10.2</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span>/<span class="hljs-number"><span class="hljs-number">24</span></span> Route type: user Route reference: <span class="hljs-number"><span class="hljs-number">0</span></span> Route interface-index: <span class="hljs-number"><span class="hljs-number">0</span></span> Multicast RPF nh index: <span class="hljs-number"><span class="hljs-number">0</span></span> Flags: sent to PFE Nexthop: Next-hop type: composite Index: <span class="hljs-number"><span class="hljs-number">608</span></span> Reference: <span class="hljs-number"><span class="hljs-number">2</span></span> Load Balance Label: Push <span class="hljs-number"><span class="hljs-number">24008</span></span>, None Next-hop type: indirect Index: <span class="hljs-number"><span class="hljs-number">1048578</span></span> Reference: <span class="hljs-number"><span class="hljs-number">3</span></span> Nexthop: <span class="hljs-number"><span class="hljs-number">10.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.6</span></span> Next-hop type: Push <span class="hljs-number"><span class="hljs-number">299920</span></span> Index: <span class="hljs-number"><span class="hljs-number">664</span></span> Reference: <span class="hljs-number"><span class="hljs-number">3</span></span> Load Balance Label: None Next-hop interface: ae1<span class="hljs-number"><span class="hljs-number">.0</span></span></code> </pre> <br>  The line Load Balance Label contains the service label. <br><br><pre> <code class="javascript hljs">Load Balance Label: Push <span class="hljs-number"><span class="hljs-number">24008</span></span>, None</code> </pre> <br>  By the method of banal erudition, we can come to the following conclusion: how many service marks we will have, just as there will be composite next-hops.  At the next level of the hierarchy is indirect next-hop, though not the one we discussed earlier.  When using composite next-hop, the indirect-next-hop prerogative is that it aggregates by address family and protocol-next-hop.  That is, as you understand, for all vpnv4 prefixes that have the same protocol next-hop there will be the same indirect-next-hop.  Well, then indirect-next-hop will indicate to the real next-hop (as a rule, either in unilist or aggregate).  The most important thing is that now several indirect-next-hops can point to the same unilist next-hop, since now the unilist next-hop does not indicate the full stack of tags, but only the transport label, but how you understand, to the same PE-ki there will be the same transport label. <br><br>  Now let's return to the case we are considering with 100 vrfs.  In the worst scenario, using indirect-next-hop, we received 10,000 indirect next-hops and, as a result, as many real next-hops.  Now let's see what composite-next-hop will give us.  First comes the composite next-hop hierarchy, and provided that the labels are generated per-prefix, we will get 10,000 different service labels, which means the same number of composite-next-hops.  But, unlike the previous case, the composite next-hop will not refer to the real next-hop, but to indirect-next-hop, which aggregates the vpnv4 assignment prefixes by address family and protocol next-hop.  And this very sharply reduces the number of real next-hops.  In our scenario, there is only one address family - vpnv4 and one protocol-net-hop, which means that all 10,000 composite-next-hops will refer to one single indirect next-hop, and he, in turn, will point to one real next-hop!  That is, we ended up with just one real next-hop! <br><br>  I can say from my own practice that the inclusion of composite-next-hop for ingress lsp makes it possible to reduce the total number of next-hop by 5-8 times (for example, the ral index, a decrease from 1.1M next-hop (before this function) to 170K (after its inclusion), that is, a reduction of 6.5 times - agree, a good indicator). <br><br><blockquote>  Note: when you turn on composite-next-hop, you will not see a stack of tags in the forwarding table, as it is specified in two hierarchies and is displayed only with extensive outputs, for example: <br><br>  <i>Indirect-next-hop:</i> <br><br><pre> <code class="javascript hljs">bormoglotx@RZN-PE2&gt; show route forwarding-table table VRF1 destination <span class="hljs-number"><span class="hljs-number">10.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span>/<span class="hljs-number"><span class="hljs-number">24</span></span> Routing table: VRF1.inet Internet: Destination Type RtRef Next hop Type Index NhRef Netif <span class="hljs-number"><span class="hljs-number">10.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span>/<span class="hljs-number"><span class="hljs-number">24</span></span> user <span class="hljs-number"><span class="hljs-number">0</span></span> indr <span class="hljs-number"><span class="hljs-number">1048578</span></span> <span class="hljs-number"><span class="hljs-number">4</span></span> ulst <span class="hljs-number"><span class="hljs-number">1048577</span></span> <span class="hljs-number"><span class="hljs-number">2</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>:<span class="hljs-number"><span class="hljs-number">5</span></span>:<span class="hljs-number"><span class="hljs-number">86</span></span>:<span class="hljs-number"><span class="hljs-number">71</span></span>:<span class="hljs-number"><span class="hljs-number">49</span></span>:c0 Push <span class="hljs-number"><span class="hljs-number">16</span></span> <span class="hljs-number"><span class="hljs-number">699</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> ae0<span class="hljs-number"><span class="hljs-number">.1</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>:<span class="hljs-number"><span class="hljs-number">5</span></span>:<span class="hljs-number"><span class="hljs-number">86</span></span>:<span class="hljs-number"><span class="hljs-number">71</span></span>:<span class="hljs-number"><span class="hljs-number">9</span></span>d:c1 Push <span class="hljs-number"><span class="hljs-number">16</span></span>, Push <span class="hljs-number"><span class="hljs-number">299888</span></span>(top) <span class="hljs-number"><span class="hljs-number">702</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> ae1<span class="hljs-number"><span class="hljs-number">.0</span></span></code> </pre> <br>  <i>Composite-next-hop:</i> <br><br><pre> <code class="javascript hljs">bormoglotx@RZN-PE2&gt; show route forwarding-table table VRF1 destination <span class="hljs-number"><span class="hljs-number">10.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span>/<span class="hljs-number"><span class="hljs-number">24</span></span> Routing table: VRF1.inet Internet: Destination Type RtRef Next hop Type Index NhRef Netif <span class="hljs-number"><span class="hljs-number">10.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span>/<span class="hljs-number"><span class="hljs-number">24</span></span> user <span class="hljs-number"><span class="hljs-number">0</span></span> comp <span class="hljs-number"><span class="hljs-number">608</span></span> <span class="hljs-number"><span class="hljs-number">2</span></span></code> </pre> </blockquote><br><blockquote>  Note: if the Juniper MX chassis includes DPC cards (except for service ones), then you cannot turn on composite-next-hop, as indicated by this message on the Juniper website: <br><br>  On the MX Series 3D Universal Edge Routes, the chained composite next hops are disabled by default.  It is up to you to be able to use the chassis. <br><br>  It doesn‚Äôt say right away what cannot be turned on, but it may come as a surprise to someone, but DPC cards do not support the work in the enhanced-ip mode: <br><br>  Only Multiservices DPCs (MS-DPCs) and MS-MPCs are powered on with enhanced network services options.  No other DPCs function with the enhanced network services mode options. </blockquote><br>  But do not think that a composite next-hop is needed exclusively on PE routers, although it is useful mainly for them (just for P-like, as a rule, there are not so many routes).  Composite-next-hop can be enabled for ingress lsp (on PE) and for transite lsp (on P).  In addition, maybe you will have steroidal PE-ki, which will play the role of P-marshutchers (well, or your network design does not provide FREE CORE at all), or your core (P-level) will receive routes to other autonomous systems (Option C) not through the redistribution of BGP-LU routes in igp on boarders, but through a BGP-Labeled uneled session with reflectors. <br><br>  If for ingress lsp we can enable composite-next-hop only for services such as L3VPN, L2VPN, EVPN, as well as BGP-LU: <br><br><pre> <code class="javascript hljs"> evpn Create composite-chained nexthops <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> ingress EVPN LSPs fec129-vpws Create composite-chained nexthops <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> ingress fec129-vpws LSPs l2ckt Create composite-chained nexthops <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> ingress l2ckt LSPs l2vpn Create composite-chained nexthops <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> ingress l2vpn LSPs l3vpn Create composite-chained nexthops <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> ingress l3vpn LSPs labeled-bgp Create composite-chained nexthops <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> ingress labeled-bgp LSPs</code> </pre> <br>  So for transit devices, there are available composite next-hop options for LDP, RSVP and even static lsp: <br><br><pre> <code class="javascript hljs"> l2vpn Create composite-chained nexthops <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> transit l2vpn LSPs l3vpn Create composite-chained nexthops <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> transit l3vpn LSPs labeled-bgp Create composite-chained nexthops <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> transit labeled BGP routes ldp Create composite-chained nexthops <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> LDP LSPs ldp-p2mp Create composite-chained nexthops <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> LDP P2MP LSPs rsvp Create composite-chained nexthops <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> RSVP LSPs rsvp-p2mp Create composite-chained nexthops <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> RSVP p2mp LSPs <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> Create composite-chained nexthops <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> LSPs</code> </pre> <br>  This allows you to significantly reduce the number of next-hops for transit lsp.  For example, in my lab there are only 5 devices - that is, the mpls.0 table on the P-ke looks to put it mildly small: <br><br><pre> <code class="javascript hljs">bormoglotx@RZN-P2&gt; show route table mpls<span class="hljs-number"><span class="hljs-number">.0</span></span> | find ^<span class="hljs-number"><span class="hljs-number">2</span></span>[<span class="hljs-number"><span class="hljs-number">0</span></span><span class="hljs-number"><span class="hljs-number">-9</span></span>]+ <span class="hljs-number"><span class="hljs-number">299872</span></span> *[LDP/<span class="hljs-number"><span class="hljs-number">9</span></span>] <span class="hljs-number"><span class="hljs-number">1</span></span>w1d <span class="hljs-number"><span class="hljs-number">12</span></span>:<span class="hljs-number"><span class="hljs-number">59</span></span>:<span class="hljs-number"><span class="hljs-number">13</span></span>, metric <span class="hljs-number"><span class="hljs-number">1</span></span> &gt; to <span class="hljs-number"><span class="hljs-number">10.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.5</span></span> via ae0<span class="hljs-number"><span class="hljs-number">.0</span></span>, Pop <span class="hljs-number"><span class="hljs-number">299872</span></span>(S=<span class="hljs-number"><span class="hljs-number">0</span></span>) *[LDP/<span class="hljs-number"><span class="hljs-number">9</span></span>] <span class="hljs-number"><span class="hljs-number">1</span></span>w1d <span class="hljs-number"><span class="hljs-number">12</span></span>:<span class="hljs-number"><span class="hljs-number">59</span></span>:<span class="hljs-number"><span class="hljs-number">13</span></span>, metric <span class="hljs-number"><span class="hljs-number">1</span></span> &gt; to <span class="hljs-number"><span class="hljs-number">10.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.5</span></span> via ae0<span class="hljs-number"><span class="hljs-number">.0</span></span>, Pop <span class="hljs-number"><span class="hljs-number">299888</span></span> *[LDP/<span class="hljs-number"><span class="hljs-number">9</span></span>] <span class="hljs-number"><span class="hljs-number">1</span></span>w1d <span class="hljs-number"><span class="hljs-number">12</span></span>:<span class="hljs-number"><span class="hljs-number">58</span></span>:<span class="hljs-number"><span class="hljs-number">30</span></span>, metric <span class="hljs-number"><span class="hljs-number">1</span></span> &gt; to <span class="hljs-number"><span class="hljs-number">10.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.5</span></span> via ae0<span class="hljs-number"><span class="hljs-number">.0</span></span>, Swap <span class="hljs-number"><span class="hljs-number">299792</span></span> <span class="hljs-number"><span class="hljs-number">299904</span></span> *[LDP/<span class="hljs-number"><span class="hljs-number">9</span></span>] <span class="hljs-number"><span class="hljs-number">1</span></span>w1d <span class="hljs-number"><span class="hljs-number">12</span></span>:<span class="hljs-number"><span class="hljs-number">55</span></span>:<span class="hljs-number"><span class="hljs-number">57</span></span>, metric <span class="hljs-number"><span class="hljs-number">1</span></span> &gt; to <span class="hljs-number"><span class="hljs-number">10.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.7</span></span> via ae1<span class="hljs-number"><span class="hljs-number">.0</span></span>, Pop <span class="hljs-number"><span class="hljs-number">299904</span></span>(S=<span class="hljs-number"><span class="hljs-number">0</span></span>) *[LDP/<span class="hljs-number"><span class="hljs-number">9</span></span>] <span class="hljs-number"><span class="hljs-number">1</span></span>w1d <span class="hljs-number"><span class="hljs-number">12</span></span>:<span class="hljs-number"><span class="hljs-number">55</span></span>:<span class="hljs-number"><span class="hljs-number">57</span></span>, metric <span class="hljs-number"><span class="hljs-number">1</span></span> &gt; to <span class="hljs-number"><span class="hljs-number">10.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.7</span></span> via ae1<span class="hljs-number"><span class="hljs-number">.0</span></span>, Pop <span class="hljs-number"><span class="hljs-number">299920</span></span> *[LDP/<span class="hljs-number"><span class="hljs-number">9</span></span>] <span class="hljs-number"><span class="hljs-number">1</span></span>w1d <span class="hljs-number"><span class="hljs-number">12</span></span>:<span class="hljs-number"><span class="hljs-number">47</span></span>:<span class="hljs-number"><span class="hljs-number">06</span></span>, metric <span class="hljs-number"><span class="hljs-number">1</span></span> &gt; to <span class="hljs-number"><span class="hljs-number">10.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.5</span></span> via ae0<span class="hljs-number"><span class="hljs-number">.0</span></span>, Swap <span class="hljs-number"><span class="hljs-number">299824</span></span></code> </pre> <br>  But the effect of the inclusion of composite-next-hop for LDP will already be visible even in such a small laboratory.  Here is the total number of net-hops before including composite-next-hop: <br><br><pre> <code class="javascript hljs">VMX(RZN-P2 vty)# show nhdb summary Total number <span class="hljs-keyword"><span class="hljs-keyword">of</span></span> NH = <span class="hljs-number"><span class="hljs-number">116</span></span> VMX(RZN-P2 vty)# show nhdb summary detail Type Count --------- --------- Discard <span class="hljs-number"><span class="hljs-number">12</span></span> Reject <span class="hljs-number"><span class="hljs-number">11</span></span> Unicast <span class="hljs-number"><span class="hljs-number">32</span></span> &lt;&lt;<span class="xml"><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt; </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">Unilist</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">0</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">Indexed</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">0</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">Indirect</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">0</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">Hold</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">0</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">Resolve</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">2</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">Local</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">13</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">Recv</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">8</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">Multi-RT</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">0</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">Bcast</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">4</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">Mcast</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">7</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">Mgroup</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">1</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">mdiscard</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">7</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">Table</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">11</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">Deny</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">0</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">Aggreg.</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">8</span></span></span></span><span class="xml"><span class="hljs-tag"> &lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt; </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">Crypto</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">0</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">Iflist</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">0</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">Sample</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">0</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">Flood</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">0</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">Service</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">0</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">Multirtc</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">0</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">Compst</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">0</span></span></span></span><span class="xml"><span class="hljs-tag"> &lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt; </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">DmxResolv</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">0</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">DmxIFL</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">0</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">DmxtIFL</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">0</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">LITAP</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">0</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">Limd</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">0</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">LI</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">0</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">RNH_LE</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">0</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">VCFI</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">0</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">VCMF</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">0</span></span></span></span></span></span></code> </pre> <br>  Now turn on the chained-composite-next-hop for ldp and check the result: <br><br><pre> <code class="javascript hljs">bormoglotx@RZN-P2&gt; show configuration routing-options router-id <span class="hljs-number"><span class="hljs-number">62.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.65</span></span>; autonomous-system <span class="hljs-number"><span class="hljs-number">6262</span></span>; forwarding-table { chained-composite-next-hop { transit { ldp; } }</code> </pre> <br>  In the routing table, everything is the same, although the routes have been updated, as can be seen from their lifetime (this should be taken into account when composite-next-hop is enabled on transit devices): <br><br><pre> <code class="javascript hljs">bormoglotx@RZN-P2&gt; show route table mpls<span class="hljs-number"><span class="hljs-number">.0</span></span> | find ^<span class="hljs-number"><span class="hljs-number">2</span></span>[<span class="hljs-number"><span class="hljs-number">0</span></span><span class="hljs-number"><span class="hljs-number">-9</span></span>]+ <span class="hljs-number"><span class="hljs-number">299872</span></span> *[LDP/<span class="hljs-number"><span class="hljs-number">9</span></span>] <span class="hljs-number"><span class="hljs-number">00</span></span>:<span class="hljs-number"><span class="hljs-number">00</span></span>:<span class="hljs-number"><span class="hljs-number">57</span></span>, metric <span class="hljs-number"><span class="hljs-number">1</span></span> &gt; to <span class="hljs-number"><span class="hljs-number">10.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.5</span></span> via ae0<span class="hljs-number"><span class="hljs-number">.0</span></span>, Pop <span class="hljs-number"><span class="hljs-number">299872</span></span>(S=<span class="hljs-number"><span class="hljs-number">0</span></span>) *[LDP/<span class="hljs-number"><span class="hljs-number">9</span></span>] <span class="hljs-number"><span class="hljs-number">00</span></span>:<span class="hljs-number"><span class="hljs-number">00</span></span>:<span class="hljs-number"><span class="hljs-number">57</span></span>, metric <span class="hljs-number"><span class="hljs-number">1</span></span> &gt; to <span class="hljs-number"><span class="hljs-number">10.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.5</span></span> via ae0<span class="hljs-number"><span class="hljs-number">.0</span></span>, Pop <span class="hljs-number"><span class="hljs-number">299888</span></span> *[LDP/<span class="hljs-number"><span class="hljs-number">9</span></span>] <span class="hljs-number"><span class="hljs-number">00</span></span>:<span class="hljs-number"><span class="hljs-number">00</span></span>:<span class="hljs-number"><span class="hljs-number">57</span></span>, metric <span class="hljs-number"><span class="hljs-number">1</span></span> &gt; to <span class="hljs-number"><span class="hljs-number">10.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.5</span></span> via ae0<span class="hljs-number"><span class="hljs-number">.0</span></span>, Swap <span class="hljs-number"><span class="hljs-number">299792</span></span> <span class="hljs-number"><span class="hljs-number">299904</span></span> *[LDP/<span class="hljs-number"><span class="hljs-number">9</span></span>] <span class="hljs-number"><span class="hljs-number">00</span></span>:<span class="hljs-number"><span class="hljs-number">00</span></span>:<span class="hljs-number"><span class="hljs-number">57</span></span>, metric <span class="hljs-number"><span class="hljs-number">1</span></span> &gt; to <span class="hljs-number"><span class="hljs-number">10.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.7</span></span> via ae1<span class="hljs-number"><span class="hljs-number">.0</span></span>, Pop <span class="hljs-number"><span class="hljs-number">299904</span></span>(S=<span class="hljs-number"><span class="hljs-number">0</span></span>) *[LDP/<span class="hljs-number"><span class="hljs-number">9</span></span>] <span class="hljs-number"><span class="hljs-number">00</span></span>:<span class="hljs-number"><span class="hljs-number">00</span></span>:<span class="hljs-number"><span class="hljs-number">57</span></span>, metric <span class="hljs-number"><span class="hljs-number">1</span></span> &gt; to <span class="hljs-number"><span class="hljs-number">10.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.7</span></span> via ae1<span class="hljs-number"><span class="hljs-number">.0</span></span>, Pop <span class="hljs-number"><span class="hljs-number">299920</span></span> *[LDP/<span class="hljs-number"><span class="hljs-number">9</span></span>] <span class="hljs-number"><span class="hljs-number">00</span></span>:<span class="hljs-number"><span class="hljs-number">00</span></span>:<span class="hljs-number"><span class="hljs-number">57</span></span>, metric <span class="hljs-number"><span class="hljs-number">1</span></span> &gt; to <span class="hljs-number"><span class="hljs-number">10.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.5</span></span> via ae0<span class="hljs-number"><span class="hljs-number">.0</span></span>, Swap <span class="hljs-number"><span class="hljs-number">299824</span></span></code> </pre> <br>  And now let's check the total number of routes in the FIB: <br><br><pre> <code class="javascript hljs">VMX(RZN-P2 vty)# show nhdb summary Total number <span class="hljs-keyword"><span class="hljs-keyword">of</span></span> NH = <span class="hljs-number"><span class="hljs-number">94</span></span> VMX(RZN-P2 vty)# show nhdb summary detail Type Count --------- --------- Discard <span class="hljs-number"><span class="hljs-number">12</span></span> Reject <span class="hljs-number"><span class="hljs-number">11</span></span> Unicast <span class="hljs-number"><span class="hljs-number">10</span></span> &lt;&lt;<span class="xml"><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt; </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">Unilist</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">0</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">Indexed</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">0</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">Indirect</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">0</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">Hold</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">0</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">Resolve</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">2</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">Local</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">13</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">Recv</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">8</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">Multi-RT</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">0</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">Bcast</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">4</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">Mcast</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">7</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">Mgroup</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">1</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">mdiscard</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">7</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">Table</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">11</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">Deny</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">0</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">Aggreg.</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">2</span></span></span></span><span class="xml"><span class="hljs-tag"> &lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt; </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">Crypto</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">0</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">Iflist</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">0</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">Sample</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">0</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">Flood</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">0</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">Service</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">0</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">Multirtc</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">0</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">Compst</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">6</span></span></span></span><span class="xml"><span class="hljs-tag"> &lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt; </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">DmxResolv</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">0</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">DmxIFL</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">0</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">DmxtIFL</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">0</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">LITAP</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">0</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">Limd</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">0</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">LI</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">0</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">RNH_LE</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">0</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">VCFI</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">0</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">VCMF</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">0</span></span></span></span></span></span></code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Since we had several transit tags, then each one had its own unicast next-hop and JunOS didn‚Äôt worry much that we had only two interfaces to which we can send transit traffic and in the end it turned out that we have 8 aggregation next- hop-s, which naturally led to an increase and unicast next-hop-s. After the inclusion of composite-next-hop, instead of generating its own next-hop for each label, the composite-next-hop already refers to the existing two aggregation next-hop. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">I would like to add that when you turn on the composite-next-hop for the ingress LSP, all BGP sessions will jerk, when you turn on the composite-next-hop for the transit LSP, the sessions will not jerk (even if BGP-LU is turned on), but all mpls tags will be reset. and re-installed in the forwarding table.</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">In conclusion, I would like to visually compare indirect-next-hop and composite-next-hop in pictures. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Three L3VPNs were launched in the laboratory, and with PE3 prefixes (10.2.0.0/24 and 10.3.0.0/24) are advertised with the label per-prefix, and with PE1 - per-vrf: </font></font><br><br><img src="https://habrastorage.org/files/877/9f5/c3e/8779f5c3ef604cb09d72d5bac6bb9913.jpg"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">and three L2CKT - two to PE1 and one to PE3 : </font></font><br><br><img src="https://habrastorage.org/files/44d/0da/c53/44d0dac53d5e44b09fc4c55de0744420.jpg"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">In addition, the scheme is assembled on aggregation interfaces, and there are equivalent paths to PE1. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">This illustration shows the ‚Äútree‚Äù of next-hops when using indirect-next-hop:</font></font><br><br><img src="https://habrastorage.org/files/f8c/004/b54/f8c004b5489c4a9d9c945d1efdba1b45.png"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">For the prefixes 10.0.0.0/24, 10.0.1.0/24, 10.0.2.0/24 - we have one serial tag, as well as for the prefixes 20.0.0.0/24, 20.0.1.0/24, 20.0.2.0/24 - also one service tag - they are all advertised with PE1. As you can see, these prefixes are accessible through the same indirect-next-hop. But 10.2.0.0/24 and 10.3.0.0/24 have different labels (labels for them are generated per-prefix), which means they have different indirect-next-hops. Well, I think everything is clear with L2CKT - everyone has different service tags and indirect-next-hops. As a result, we have 29 unicast next-hops. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Now the same thing, but with the included composite-next-hop:</font></font><br><br><img src="https://habrastorage.org/files/dae/c12/ad3/daec12ad3b19445691201cfeb9c84fae.png"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Here the next-hop is less. </font><font style="vertical-align: inherit;">Prefixes that have the same service label are accessible through the same composite-next-hop. </font><font style="vertical-align: inherit;">As you remember, the service label is specified in the composite-next-hop hierarchy. </font><font style="vertical-align: inherit;">Further, all composite-next-hops are referred to in indirect next-hops. </font><font style="vertical-align: inherit;">In the diagram above, we have two protocol-next-hop (PE1 and PE3) and two services L3VPN and L2CKT. </font><font style="vertical-align: inherit;">The result is that we have 4 indirect next-hop: </font></font><br><br> <i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">L3VPN, PE1 </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">L3VPN, PE2 </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">L2CKT LDP, PE1 </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">L2CKT LDP, PE2</font></font></i> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> And since now at the level of the unicast next-hop hierarchy we only have a transport tag, now indirect next- Hops can refer to the same unicast-next-hop. </font><font style="vertical-align: inherit;">As a result, the number of unicast-next-hops from 29 was reduced to 8.</font></font><br><br>  Thanks for attention. </div><p>Source: <a href="https://habr.com/ru/post/324268/">https://habr.com/ru/post/324268/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../324258/index.html">How the dislike for the code helped me to ‚Äúpump over‚Äù designer skills</a></li>
<li><a href="../324260/index.html">Creating Web Applications with Scala.js and React - Part 1</a></li>
<li><a href="../324262/index.html">Interview IT specialists. On ‚Äúyou‚Äù or on ‚Äúyou‚Äù?</a></li>
<li><a href="../324264/index.html">Get the list of PostgreSQL statements</a></li>
<li><a href="../324266/index.html">On the market, a man sold a cow (optimally)</a></li>
<li><a href="../324272/index.html">Using the Entity Framework Core code-first with SQLite DBMS when developing WinForms-applications in VisualStudio 2015</a></li>
<li><a href="../324274/index.html">We build Docker images for CI / CD quickly and conveniently along with dapp (review and video)</a></li>
<li><a href="../324276/index.html">Iptables: a little about the action of REDIRECT, its limitations and scope</a></li>
<li><a href="../324280/index.html">How to create music for video games</a></li>
<li><a href="../324284/index.html">Resizing images based on content</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>