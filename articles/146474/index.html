<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>RichFaces 3.0, File Shaping and Uploading, jQuery and Crutches</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Greetings, dear reader! In this article I wanted to state one problem that I encountered while developing, as well as a way to solve it. The solution ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>RichFaces 3.0, File Shaping and Uploading, jQuery and Crutches</h1><div class="post__text post__text-html js-mediator-article"><img width="400" height="300" src="https://habrastorage.org/getpro/habr/post_images/5a1/8ff/8bd/5a18ff8bdfc34bfb2b8121954e119c70.jpg" align="left"><br><br>  Greetings, dear reader!  In this article I wanted to state one problem that I encountered while developing, as well as a way to solve it.  The solution is certainly not the most perfect, but it has a place to be.  If you don‚Äôt like something, or you know the solution better, please don‚Äôt beat me with big cucumbers, since I‚Äôm still small and green.  Beat small with comments and teachings. <br><br>  The task is as follows: we have a system in which there is a page on which some reporting is displayed.  There you need to implement the formation of an Excel file and upload it to the user. <br><a name="habracut"></a><br>  The page has the following approximate structure, which is displayed in the upper figure. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      And the peculiarity is that the table is very large, and you need to upload many records to Excel. <br>  And when you click on the line displays the panel to edit the record. <br>  Code forming file: <br><pre><code class="java hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">generatePatientsExcel</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">try</span></span>{ log.info(<span class="hljs-string"><span class="hljs-string">"Generating patients excel"</span></span>); FacesContext facesContext = FacesContext.getCurrentInstance(); ExternalContext externalContext = facesContext.getExternalContext(); HttpServletResponse response = (HttpServletResponse) externalContext.getResponse(); <span class="hljs-comment"><span class="hljs-comment">//Create excel file Workbook wb = new HSSFWorkbook(); // // // // // // Header response.setHeader("Content-disposition", "attachment; filename=1.xls"); response.setHeader("Cache-Control", "must-revalidate, post-check=0, pre-check=0"); response.setCharacterEncoding("UTF-8"); response.setContentType("application/vnd.ms-excel"); //Send Response ServletOutputStream responseOutputStream = response.getOutputStream(); wb.write(responseOutputStream); responseOutputStream.flush(); responseOutputStream.close(); facesContext.responseComplete(); log.info("Generating patients excel comlplete"); } catch (Exception ex) { ex.printStackTrace(); } }</span></span></code> </pre> <br><h4>  Well, actually the problem </h4><br>  The problem is that when uploading a file, its formation takes some time, and if at this moment you click on a line, you will get: <br><pre> <code class="java hljs">org.jboss.seam.ConcurrentRequestTimeoutException: Concurrent call to conversation</code> </pre><br><br>  To avoid this, it is necessary to hang on onclick before generating the JavaScript file a function that displays the Loader.  And after the action, hide it, too, with a javascript function hung on oncomplete.  It seems simple, is not it? <br><h4>  Underwater rocks </h4><br>  Since we generate the file dynamically, we do not save it to disk, which could have made the task easier by not returning the HttpServletResponse, in which the file, but by clicking on the link where the file is saved on disk.  But this, in turn, will be the server disk space, so dynamic file generation is what we need. <br><br>  The hitch is that the h: commandButton button does not have oncomplete.  In general, all the ‚Äúh:‚Äù elements do not have this event.  Thinking a little bit: ‚ÄúIn general, why do we need this h: commandButton?  After all, we have a magic a4j: commandButton. " <br><br>  Implementing a file upload via a4j: commandButton, it looks like this: <br><br><pre> <code class="hljs xml"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">a4j:commandButton</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">onclick</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"showLoader();"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">image</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"exportExcel.png"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">action</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"#{importToExcelBean.getExcelFile()}"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">oncomplete</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"hideLoader();"</span></span></span><span class="hljs-tag">/&gt;</span></span></code> </pre> <br><br>  And everything seems to be fine, but it is only at first glance.  Since a4j: commandButton unloads HttpServletResponse into the current page. <br><br>  The user uploads the file in Excel format, and a page opens with it.  "Disorder" - the user said, punching the keyboard, swearing.  And disappointed in our system for life. <br><br>  You can try to hang a4j: support on h: commandButton, which will display a loader on onsubmit, form a file during the action, and hide a loader on oncomplete.  But the problem is that a4j: support cannot return HttpServletResponse from the server.  He does this too in the page.  Since all a4j elements return HttpServletResponse to the page. <br><br>  Bad luck turns out.  What to do, no one knows, the Internet is silent, users are crying, and you yourself sit as ukakalsya.  But such a simple event, but it is so lacking. <br><br><h4>  Solution, Crutches and jQuery <br></h4><br>  The decision occurred to a colleague.  It's pretty simple. <br><ol><li>  We divide the file generation procedure into two: generation and return of the request. </li><li>  Create a4j: commandButton, which is responsible for generating the file without returning it, displaying the loader and hiding it. <br><br><pre> <code class="hljs xml"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">a4j:commandButton</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">onclick</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"showLoader();"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">image</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"exportExcel.png"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">action</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"#{importToExcelBean.generateExcel()}"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">oncomplete</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"hideLoader()"</span></span></span><span class="hljs-tag">/&gt;</span></span></code> </pre> </li><li>  Create a hidden h: commandButton that returns the file, and also assign an id to it for later retrieval. <br><br><pre> <code class="hljs objectivec">&lt;h:commandButton <span class="hljs-keyword"><span class="hljs-keyword">id</span></span>=<span class="hljs-string"><span class="hljs-string">"exelFileButton"</span></span> style=<span class="hljs-string"><span class="hljs-string">" visibility: hidden;"</span></span> action=<span class="hljs-string"><span class="hljs-string">"#{importToExcelBean.returnResponse()}"</span></span> /&gt;</code> </pre> </li><li>  Create a JavaScript function that, with jQuery, finds the hidden h: commandButton by id and presses it. <br><br><pre> <code class="javascript hljs">&lt;script type=<span class="hljs-string"><span class="hljs-string">"text/javascript"</span></span> &gt; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">clickButtonGetExelFile</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span>{jQuery(<span class="hljs-string"><span class="hljs-string">"#exelFileButton"</span></span>).click();} &lt;<span class="hljs-regexp"><span class="hljs-regexp">/script&gt;</span></span></code> </pre> <br></li><li>  We hang our JavaScript function after hiding the loader. <br><br><pre> <code class="hljs xml"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">a4j:commandButton</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">onclick</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"showLoader();"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">image</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"exportExcel.png"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">action</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"#{importToExcelBean.generatePatientsExcel()}"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">oncomplete</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"hideLoader();clickButtonGetExelFile();"</span></span></span><span class="hljs-tag">/&gt;</span></span></code> </pre> <br><br></li></ol><br>  Done, the user receives the file in the form in which it should receive.  Critical situation resolved. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/b7d/543/989/b7d543989d9281699c1b1d54aaa47020.png" alt="image"></div><p>Source: <a href="https://habr.com/ru/post/146474/">https://habr.com/ru/post/146474/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../146468/index.html">Android users do not know anything about their smartphones?</a></li>
<li><a href="../146469/index.html">Copying Amazon S3 Objects and Baskets to Windows Azure Storage</a></li>
<li><a href="../146471/index.html">Function call through a tuple</a></li>
<li><a href="../146472/index.html">Online consumer lending service - debriefing 9 months later</a></li>
<li><a href="../146473/index.html">Separation of configurations in Yii by adult</a></li>
<li><a href="../146475/index.html">xNet - C # library for working with the Web</a></li>
<li><a href="../146476/index.html">Runet Today, June 25, 2012. Experts of the issue: Sergey Fage, Maxim Kazak</a></li>
<li><a href="../146478/index.html">How designers and developers can play cohesively (and keep running with scissors)</a></li>
<li><a href="../146480/index.html">Launch Ubuntu x86 + Wine for Android x86 (chroot + VNC)</a></li>
<li><a href="../146481/index.html">Modern servers on Intel Xeon E5-2600 on the example of ETegro Hyperion RS230 G4</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>