<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>How to deliver e-mail notifications to clients in the conditions of impossibility to register a reverse DNS zone</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Proof of concept 
 From such a title it is quite difficult to understand, ‚Äúbut who needs it at all?‚Äù, And therefore, for a start, a brief preface. 

 ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>How to deliver e-mail notifications to clients in the conditions of impossibility to register a reverse DNS zone</h1><div class="post__text post__text-html js-mediator-article"><h4>  Proof of concept </h4><br>  From such a title it is quite difficult to understand, ‚Äúbut who needs it at all?‚Äù, And therefore, for a start, a brief preface. <br><br>  It's no secret that Internet providers are very aggressive looking at small businesses.  The terms of service for individuals and legal entities are about the same, but the price varies considerably.  The situation of the monopoly has been corrected to some extent with the advent of standards such as LTE and 4G, but the conditions of service still remain very far from humanity.  So, this article is dedicated to those who, for some reason or other, are forced to interact with a provider that provides an external IP address, but does not allow editing the corresponding reverse DNS records. <br><br>  Surely, many people know that as a requirement for mail servers, in addition to DKIM records and other checks, there is also a mandatory reverse DNS record.  Otherwise, the letters will either not reach at all, or they will fall into the ‚ÄúSpam‚Äù folder.  With the above facts further we will understand. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h4>  main idea </h4><br>  What options remain?  First, these are transparent SMTP proxying services.  But in this case, the client will receive letters from a third-party domain, which, quite naturally, may cause the client‚Äôs distrust of your resource.  Secondly, it is magic.  In the direction of the latter, and we will think. <br><br>  The idea is to get rid of your IP like an initial relay.  This will help us with Gmail Hosted.  The procedure for setting up your domain to use Gmail Hosted is quite simple and well documented.  For all the details here: <a href="http://www.google.com/enterprise/apps/business/">Google Apps for Business</a> . <br><br>  After setting up your domain to work with the services of Gmail Hosted and registering the corresponding mailbox to communicate with clients (suppose it is noreply@yourdomain.com), I really want to notify your customers about events from the code of your resource.  But if in such a configuration try to use the account noreply@yourdomain.com as a relay, then we get the same thing that we‚Äôve left.  Hiring an employee who would log into the web interface and send alerts is unwise. <br><a name="habracut"></a><br><h4>  Lot of code </h4><br>  In my example, I use OS FreeBSD, so ‚Äúas is‚Äù this example can only be used in it. <br><br>  There is a great console browser elinks, which can do a lot of things, but not JavaScript.  No matter how the documentation assures you of the opposite, this is not the case, elinks interprets JavaScript only as a language for scripting user actions.  But, anyway, this should not stop us, because  Gmail still maintains compatibility with browsers that lack JavaScript interpreter support. <br><br>  How it will work: <br><br><ul><li>  Interception of php built-in mail () function </li><li>  Output of the mail () function arguments to the external environment </li><li>  Running elinks, logging in to Gmail </li><li>  Go to the letter creation page, fill in the corresponding letter fields </li><li>  Sending the form with the subsequent sending of the letter </li></ul><br><br>  At once I will make a reservation that the mechanisms used by me do not pretend to elegance, the task before me was to make the mandrel take place and not the process optimization under high load. <br><br>  We will need: <br><br><ul><li>  PHP in conjunction with any HTTP server </li><li>  APD plugin for PHP (to intercept the basic mail function ()) </li><li>  Python with the pyexpect module (for dialogue with the elinks process) </li><li>  Directly, elinks themselves with support for Lua scripting </li><li>  The sudo package to give the elinks process the right to create the necessary sockets for it </li></ul><br><br>  If there is a need to describe the installation process of all necessary, write in the comments, but I take the liberty to assume that those who have attended to such a problem are already familiar with the process of installing and configuring applications. <br><br><h4>  Take the bull by the horns </h4><br><h5>  Interception of mail () built-in php function, output of mail () function arguments to external execution environment </h5><br>  To any constantly included area of ‚Äã‚Äãthe page of your project, we add the following code: <br><br><pre><code class="php hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">my_mail</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($args)</span></span></span><span class="hljs-function"> </span></span>{ $result = $args[<span class="hljs-number"><span class="hljs-number">0</span></span>] . <span class="hljs-string"><span class="hljs-string">"\n"</span></span>; $result .= $args[<span class="hljs-number"><span class="hljs-number">1</span></span>] . <span class="hljs-string"><span class="hljs-string">"\n"</span></span>; $result .= $args[<span class="hljs-number"><span class="hljs-number">2</span></span>]; $file = <span class="hljs-string"><span class="hljs-string">'/tmp/msg.exchange'</span></span>; $current = $result . <span class="hljs-string"><span class="hljs-string">"\n"</span></span>; file_put_contents($file, $current); fclose($file); exec(<span class="hljs-string"><span class="hljs-string">'/usr/local/bin/sudo /bin/csh /root/exec.sh &gt; /dev/null &amp;'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span>; } override_function(<span class="hljs-string"><span class="hljs-string">'mail'</span></span>, <span class="hljs-string"><span class="hljs-string">''</span></span>, <span class="hljs-string"><span class="hljs-string">'my_mail(func_get_args());'</span></span>);</code> </pre> <br><br>  Here, the mail () function arguments such as ‚ÄúTo‚Äù, ‚ÄúSubject‚Äù, ‚ÄúBody‚Äù are saved to the file ‚Äú/tmp/msg.exchange‚Äù stored in memory.  Next, the main body of the script is called with the redirection of the stdout stream to the null device so that the page loads immediately, without waiting for the script to finish. <br><br>  Immediately it is worth noting the assignment of rights in the file "/ usr / local / etc / sudoers": <br><pre> <code class="bash hljs">Defaults:www !requiretty www ALL=(ALL) NOPASSWD: /usr/<span class="hljs-built_in"><span class="hljs-built_in">local</span></span>/bin/elinks, /usr/<span class="hljs-built_in"><span class="hljs-built_in">local</span></span>/bin/python, /usr/bin/su, /bin/csh</code> </pre><br><br>  Attention!  the string ‚ÄúDefaults: www! requiretty‚Äù is necessary, because if it does not exist, you will receive an error in the log of your web server stating that it is impossible to start the application in headless mode without selecting a separate tty device. <br><br><h5>  Running elinks, logging in to Gmail </h5><br>  For the elinks to work correctly with the Russian language, you will need a little tweaking: <br><pre> <code class="bash hljs">mkdir ~/.elinks <span class="hljs-built_in"><span class="hljs-built_in">printf</span></span> <span class="hljs-string"><span class="hljs-string">'set terminal.xterm.charset = "koi8-r"\nset ui.language = "Russian"\nset document.browse.search.regex = 0'</span></span> &gt;&gt; ~/.elinks/elinks.conf</code> </pre><br><br>  As such, authorization at each launch we will not need.  Elinks will cope with it.  It‚Äôs enough to log in once on the page ‚Äúelinks <a href="https://mail.google.com/mail/u/0/">mail.google.com/mail/u/0</a> \? Ui = html \ &amp; zy = c‚Äù, and then this data will be used in all subsequent sessions. <br><br>  Further, since we already have a call to the sh script, I will give its code: <br><br>  /root/exec.sh <br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#!/bin/sh su -l setenv LANG ru_RU.KOI8-R /usr/local/bin/python /root/headless.py</span></span></code> </pre><br>  The indirect call of the python script is associated with some features of the work of mechanisms for changing rights and features of the work of encodings in headless mode. <br><br><h5>  Go to the letter creation page, fill in the appropriate letter fields, send the form and then send the letter </h5><br>  The last items are combined, because the logic of the script does not allow to distinguish them in this way.  For a better understanding of the mechanism, I will have to first provide the code associated with filling out the submission form, and only then bring the browser call script and its management. <br><br><h6>  Filling in the appropriate letter fields </h6><br>  Scripting user-defined functions is a very convenient mechanism in elinks.  It allows you to perform certain macros in response to the occurrence of certain events.  In particular, the pre_format_html_hook event occurs when the browser has already loaded the contents of the page, but before interpreting it from the HTML view to the form in which we will see it.  But, as stated in the Lua documentation for the elinks scripting part, not all Lua mechanisms work correctly within the framework of the Lua &lt;-&gt; elinks interaction.  For example, when attempting to call Lua's built-in file reading functions, both executable files behave in an unpredictable way, so you have to bypass this restriction by using the specially written function pipe_read, which is essentially a simple receiver of the stdout stream from executing any binary elf code .  It is also worth noting a moment with encodings: in fact, nothing complicated, but working with the received HTML lines is in the encoding in which they came, because the search strings will look completely unreadable. <br><br>  All user scripts are located in the ~ / .elinks folder and are named hooks.lang, where lang is the name of the scripting language.  In my case, this is ~ / .elinks / hooks.lua, the contents of which are listed below: <br>  /root/.elinks/hooks.lua <br><pre> <code class="lua hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">pre_format_html_hook</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(url, html)</span></span></span></span> toaddress = pipe_read(<span class="hljs-string"><span class="hljs-string">"head -n 1 /tmp/msg.exchange"</span></span>) nstr = pipe_read(<span class="hljs-string"><span class="hljs-string">"cat /tmp/msg.exchange | tail -n+2 | /usr/local/bin/iconv -f windows-1251 -t koi8-r | /usr/local/bin/iconv -f koi8-r -t utf-8"</span></span>) theme = pipe_read(<span class="hljs-string"><span class="hljs-string">"head -n 2 /tmp/msg.exchange | tail -n+2 | /usr/local/bin/iconv -f windows-1251 -t koi8-r | /usr/local/bin/iconv -f koi8-r -t utf-8"</span></span>) html1 = <span class="hljs-built_in"><span class="hljs-built_in">string</span></span>.<span class="hljs-built_in"><span class="hljs-built_in">gsub</span></span> (html, <span class="hljs-string"><span class="hljs-string">'aria%-labelledby=l%-to&gt;'</span></span>, <span class="hljs-string"><span class="hljs-string">'aria%-labelledby=l%-to&gt;'</span></span> .. toaddress) html1 = <span class="hljs-built_in"><span class="hljs-built_in">string</span></span>.<span class="hljs-built_in"><span class="hljs-built_in">gsub</span></span> (html1, <span class="hljs-string"><span class="hljs-string">'input name=subject value=""'</span></span>, <span class="hljs-string"><span class="hljs-string">'input name=subject value="'</span></span> .. theme .. <span class="hljs-string"><span class="hljs-string">'"'</span></span>) html1 = <span class="hljs-built_in"><span class="hljs-built_in">string</span></span>.<span class="hljs-built_in"><span class="hljs-built_in">gsub</span></span> (html1, <span class="hljs-string"><span class="hljs-string">'aria%-label="‚ïí‚ï£‚ï©‚ï¨ ¬©‚ï¶‚îÇ‚ñÑ‚ï™‚ïü"&gt;'</span></span>, <span class="hljs-string"><span class="hljs-string">'aria%-label="‚ïí‚ï£‚ï©‚ï¨ ¬©‚ï¶‚îÇ‚ñÑ‚ï™‚ïü"&gt;'</span></span> .. nstr) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> html1 <span class="hljs-keyword"><span class="hljs-keyword">end</span></span></code> </pre><br><br>  Total, on each page containing the necessary field names, there will be an autocomplete such.  You can easily verify this by running elinks, and going to the send mail page. <br><br><h6>  Go to the letter creation page, send the form and then send the letter </h6><br>  This stage was perhaps the most difficult.  Having tried all the tools in trying to send special characters to the already spawned process, such as Enter and pressing the right key, I came across a wonderful python library called pyexpect.  With her everything instantly became very simple and clear.  Just give the code: <br>  /root/headless.py <br><pre> <code class="python hljs"><span class="hljs-comment"><span class="hljs-comment">#!/usr/bin/python # -*- coding: koi8-r -*- from pexpect import spawn import time import datetime import base64 import pickle ''' fd = open('/tmp/msg.exchange', 'r+') with fd as f: lines = f.read().splitlines() theme = lines[1] theme = theme.replace("=?windows-1251?B?", "") theme = theme.replace("?=", "") lines[1] = base64.b64decode(theme) fd = open('/tmp/msg.exchange', 'r+') fd.truncate() for item in lines: fd.write("%s\n" % item) fd.close() ''' #KEY_UP = '\x1b[A' #KEY_DOWN = '\x1b[B' #KEY_RIGHT = '\x1b[C' #KEY_LEFT = '\x1b[D' #KEY_ESCAPE = '\x1b' #KEY_BACKSPACE = '\x7f' child = spawn('/usr/local/bin/elinks https://mail.google.com/mail/u/0/?ui=html&amp;zy=c') #child.logfile = open('/tmp/elinks.log', 'r+') print 'waiting for gmail.com to load' child.expect('ORGNAME') time.sleep(0.5) child.sendline('/') print 'search of "new message" string has been reached' child.sendline('') print 'the enter key after searching "new message" button has been emulated' child.expect('') print 'weve got "send" string back from server' child.sendline('/') print 'search of "send" string has been reached' child.sendline('') print 'emulated enter key for submitting completed form' child.sendline('') print 'emulated enter key for accepting dialog' child.expect('') print 'got signal about sucssefull message sending' #child.interact() time.sleep(2) child.sendline('q') print 'sent quit key emulation' child.sendline('') print 'accepted quit with enter key'</span></span></code> </pre><br><br>  Here I deliberately left a lot of interesting commented lines.  A multi-line comment is a code specific to the Bitrix engine.  The fact is that the bitrix with its system of mail templates automatically encodes a string with the subject of the letter in base64 encoding.  In this piece of code, decoding from base64 to plain text occurs, followed by writing back to the exchange file.  KEY_UP, KEY_DOWN, etc. are special character codes for the corresponding keys, up, down, etc. The string "child.logfile = open ('/ tmp / elinks.log', 'r +')" is very, very useful for debugging a script in headless mode.  The string ‚Äúchild.interact ()‚Äù is useful when debugging a script in the normal execution mode from the console. <br><br>  To use this ‚Äúas is‚Äù script, replace ORGNAME with the name of your organization as it appears in the Gmail header. <br><br>  Regarding the limitations of this method, yes, they are not small.  First is the speed.  It takes a considerable amount of time and computing resources to send each letter.  No way to send beautifully formatted HTML emails.  Scripts need some work to send applications. <br><br>  But there are a lot of advantages, for example, this method can be used even if you have a dynamic IP address that works, say, in conjunction with No-IP.  But perhaps the main advantage of this method is a complete imitation of manual input to the Gmail web interface, and as a result, spam filtering will work exclusively with the text of the letter, and those with the formal signs of the sender.  In my case, the letters sent by this method come not just to the inbox, but to the inbox marked as important. <br><br>  Thank you for your attention, comrades Habrovca, successful deliveries to you. </div><p>Source: <a href="https://habr.com/ru/post/232261/">https://habr.com/ru/post/232261/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../232251/index.html">Second hdd instead of dvd drive in laptop</a></li>
<li><a href="../232253/index.html">Verified by electronics</a></li>
<li><a href="../232255/index.html">A multiplying tool based on the Slonimsky theorem</a></li>
<li><a href="../232257/index.html">Accelerated web / mobile application development</a></li>
<li><a href="../232259/index.html">Online store. How to avoid elementary mistakes at the beginning and make life easier in the future</a></li>
<li><a href="../232265/index.html">Frequency management and overclocking of AMD Radeon notebook video cards in Windows</a></li>
<li><a href="../232267/index.html">ExifTool - Swiss Photo Meta Knife</a></li>
<li><a href="../232269/index.html">Conflict management or the first competence of the Dark Lord</a></li>
<li><a href="../232271/index.html">Pluralism of opinions through a fake IP address</a></li>
<li><a href="../232273/index.html">10 alternatives to the Google Play app store</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>