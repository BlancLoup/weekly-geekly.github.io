<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Static site optimization: tenfold acceleration</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Dzhonluka De Caro, the author of the material, the translation of which we are publishing today, once found himself on a trip abroad and wanted to sho...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Static site optimization: tenfold acceleration</h1><div class="post__text post__text-html js-mediator-article"> Dzhonluka De Caro, the author of the material, the translation of which we are publishing today, once found himself on a trip abroad and wanted to show a friend his personal page on the Internet.  I must say that it was a regular static site, but in the course of the demonstration it turned out that everything works more slowly than one would expect. <br><br> <a href="https://habrahabr.ru/company/ruvds/blog/352030/"><img src="https://habrastorage.org/getpro/habr/post_images/035/b52/25e/035b5225ee23f2aed62beaf2be7de8a8.jpg" alt="image"></a> <br><br>  The site did not use any dynamic mechanisms - there was a bit of animation, it was created using responsive design methods, but the content of the resource almost always remained unchanged.  The author of the article says that what he saw, having quickly analyzed the situation, literally horrified him.  Events <code>DOMContentLoaded</code> had to wait about 4 seconds, the full page load took 6.8 seconds.  During the download, 20 requests were executed, the total amount of transferred data was about a megabyte.  But we are talking about a static site.  Then Dzhonluka realized that he had previously considered his site incredibly fast just because he was used to a low-latency Gigabit Internet connection, using which, from Los Angeles, he worked with a server located in San Francisco.  Now he was in Italy and used the 8 Mbit / s Internet connection.  And it completely changed the picture of what is happening. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      In this article, Jonluca De Caro will talk about how he managed to speed up his static website tenfold. <br><a name="habracut"></a><br><h2>  <font color="#3AC1EF">Overview</font> </h2><br>  This is how the site looked, in terms of the number of requests needed to generate it, the load time and the amount of downloaded data, when it became clear that it had to be optimized. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/466/38c/836/46638c83625867d91ef066ac6f8f6c2a.png"></div><br>  <i><font color="#999999">Non-optimized site data</font></i> <br><br>  When I saw all this, I first took up the optimization of my site.  Up to this point, if it was necessary to add a library to the site or something else, I would just take and load what I needed, using the <code>src="‚Ä¶"</code> construct.  I absolutely did not pay attention to performance, did not think about anything that could affect it, including caching, embedding code, lazy loading. <br><br>  Then I began to look for people who were confronted with something similar.  Unfortunately, publications on the optimization of static sites are quickly becoming obsolete.  For example, the recommendations dated 2010-2011 are devoted to the use of libraries, and some of them made assumptions regarding the fact that libraries are not used in the development of the site at all.  Analyzing these materials, I also faced the fact that some of them simply repeat the same sets of rules over and over again. <br><br>  However, I still found two excellent sources of information: the <a href="https://hpbn.co/">High Performance Browser Networking</a> resource and the <a href="https://danluu.com/octopress-speedup/">Dan Luu</a> publication.  Although I didn‚Äôt go as far as optimizing as Dan did, by sorting out the contents of the site and its formatting tools, I was able to speed up the loading of my page about ten times.  Now, <code>DOMContentLoaded</code> had to wait for about a fifth of a second, and the full page load required 388 ms (I must say that these results cannot be called absolutely accurate, since they were affected by the lazy download, which will be discussed below). <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/ea8/790/85f/ea879085fa150bd5b81b92a1351a1c9b.png"></div><br>  <i><font color="#999999">Optimization results</font></i> <br><br>  Now let's talk about how to achieve such results. <br><br><h2>  <font color="#3AC1EF">Site analysis</font> </h2><br>  The first step in the optimization process was profiling the site.  I wanted to understand what exactly requires the most time, and how best to parallelize the execution of tasks.  I, for profiling the site, used various tools and checked how the site is loaded from different places of the Earth.  Here is a list of resources that I used: <br><br><ul><li>  <a href="https://tools.pingdom.com/">https://tools.pingdom.com</a> <br></li><li>  <a href="http://www.webpagetest.org/">http://www.webpagetest.org/</a> <br></li><li>  <a href="https://tools.keycdn.com/speed">https://tools.keycdn.com/speed</a> <br></li><li>  <a href="https://developers.google.com/web/tools/lighthouse/">https://developers.google.com/web/tools/lighthouse/</a> <br></li><li>  <a href="https://developers.google.com/speed/pagespeed/insights/">https://developers.google.com/speed/pagespeed/insights/</a> <br></li><li>  <a href="https://webspeedtest.cloudinary.com/">https://webspeedtest.cloudinary.com/</a> <br></li></ul><br>  Some of these resources made recommendations for improving the site.  However, when it takes several dozens of requests to form a static site, you can do a lot of things - from gif-tricks from the 90s to getting rid of unused resources (I downloaded 6 fonts, for example, although I only used of them). <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/2bd/7a9/2c9/2bd7a92c912a4e9cae8b5b9d78ba67f9.png"></div><br>  <i><font color="#999999">The timeline for a site very similar to mine.</font></i>  <i><font color="#999999">I didn‚Äôt take a screenshot in time for my site, but what‚Äôs shown here looks almost like what I saw several months ago when analyzing my site</font></i> <br><br>  I wanted to optimize everything that I can influence - from the content of the site and the speed of the scripts to the settings of the web server (Nginx in my case) and DNS. <br><br><h2>  <font color="#3AC1EF">Optimization</font> </h2><br><h3>  <font color="#3AC1EF">‚ñçMinification and pooling of resources</font> </h3><br>  The first thing I noticed was that the page performs many requests for loading CSS and JS files (it did not use persistent HTTP connections), which lead to various resources, some of which were handled via HTTPS.  All of this meant that by the time the data was loaded, the time it took to go through multiple requests to content delivery networks or to regular servers was added and to receive answers from them.  However, some JS files requested loading of other files, which led to the situation of lock cascades shown in the figure above. <br><br>  In order to combine everything you need into one JS-file, I used the <a href="https://webpack.js.org/">webpack</a> .  Every time I made some changes to the content of the page, the webpack automatically minified and collected all the dependencies into one file.  Here is the content of my <code>webpack.config.js</code> file: <br><br><pre> <code class="hljs javascript"><span class="hljs-keyword"><span class="hljs-keyword">const</span></span> UglifyJsPlugin = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'uglifyjs-webpack-plugin'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> ZopfliPlugin = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">"zopfli-webpack-plugin"</span></span>); <span class="hljs-built_in"><span class="hljs-built_in">module</span></span>.exports = { <span class="hljs-attr"><span class="hljs-attr">entry</span></span>: <span class="hljs-string"><span class="hljs-string">'./js/app.js'</span></span>, <span class="hljs-attr"><span class="hljs-attr">mode</span></span>: <span class="hljs-string"><span class="hljs-string">'production'</span></span>, <span class="hljs-attr"><span class="hljs-attr">output</span></span>: {   <span class="hljs-attr"><span class="hljs-attr">path</span></span>: __dirname + <span class="hljs-string"><span class="hljs-string">'/dist'</span></span>,   <span class="hljs-attr"><span class="hljs-attr">filename</span></span>: <span class="hljs-string"><span class="hljs-string">'bundle.js'</span></span> }, <span class="hljs-attr"><span class="hljs-attr">module</span></span>: {   <span class="hljs-attr"><span class="hljs-attr">rules</span></span>: [{     <span class="hljs-attr"><span class="hljs-attr">test</span></span>: <span class="hljs-regexp"><span class="hljs-regexp">/\.css$/</span></span>,     <span class="hljs-attr"><span class="hljs-attr">loaders</span></span>: [<span class="hljs-string"><span class="hljs-string">'style-loader'</span></span>, <span class="hljs-string"><span class="hljs-string">'css-loader'</span></span>]   }, {     <span class="hljs-attr"><span class="hljs-attr">test</span></span>: <span class="hljs-regexp"><span class="hljs-regexp">/(fonts|images)/</span></span>,     <span class="hljs-attr"><span class="hljs-attr">loaders</span></span>: [<span class="hljs-string"><span class="hljs-string">'url-loader'</span></span>]   }] }, <span class="hljs-attr"><span class="hljs-attr">plugins</span></span>: [<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> UglifyJsPlugin({   <span class="hljs-attr"><span class="hljs-attr">test</span></span>: <span class="hljs-regexp"><span class="hljs-regexp">/\.js($|\?)/i</span></span> }), <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ZopfliPlugin({   <span class="hljs-attr"><span class="hljs-attr">asset</span></span>: <span class="hljs-string"><span class="hljs-string">"[path].gz[query]"</span></span>,   <span class="hljs-attr"><span class="hljs-attr">algorithm</span></span>: <span class="hljs-string"><span class="hljs-string">"zopfli"</span></span>,   <span class="hljs-attr"><span class="hljs-attr">test</span></span>: <span class="hljs-regexp"><span class="hljs-regexp">/\.(js|html)$/</span></span>,   <span class="hljs-attr"><span class="hljs-attr">threshold</span></span>: <span class="hljs-number"><span class="hljs-number">10240</span></span>,   <span class="hljs-attr"><span class="hljs-attr">minRatio</span></span>: <span class="hljs-number"><span class="hljs-number">0.8</span></span> })] };</code> </pre> <br>  I experimented with various options, in the end I got one file <code>bundle.js</code> , blocking the download of which is performed in the <code>&lt;head&gt;</code> section of my site.  The size of this file was 829 KB.  This included everything except images (fonts, CSS, all libraries and dependencies, as well as my JS code).  Most of this volume, 724 of 829 KB, was in font-awesome fonts. <br><br>  Next, I worked with the Font Awesome library and removed everything from there, except for the three icons I used: <code>fa-github</code> , <code>fa-envelope</code> , and <code>fa-code</code> .  In order to extract only the icons I need from the library, I used the <a href="http://fontello.com/">fontello</a> service.  As a result, I managed to reduce the size of the downloaded file to just 94 Kb. <br><br>  The way the site is designed does not allow it to be displayed correctly if the browser processes only HTML and CSS, so I did not try to deal with the blocking download of the <code>bundle.js</code> file.  Download time was approximately 118 ms, which was more than an order of magnitude better than before. <br><br>  This approach revealed several additional useful properties.  So, I no longer had to contact third-party servers or content delivery networks, as a result, when my page was loaded into a browser, the system was exempt from the following tasks: <br><br><ul><li>  Perform DNS queries to third-party resources. </li><li>  Perform HTTP connection setup procedures. </li><li>  Perform a full load of required data. </li></ul><br>  While the use of CDN and distributed caching may make sense for large-scale web projects, my small static site does not benefit from the use of CDN resources.  Rejecting them, at the cost of some efforts on my part, made it possible to save an additional amount of about a hundred milliseconds, which, in my opinion, justifies these efforts. <br><br><h3>  <font color="#3AC1EF">‚ñç Image Compression</font> </h3><br>  Continuing the analysis of the site, I discovered that my 8-megabyte portrait was loaded onto the page, which was displayed in a size that was 10% in width and height from its original size.  This is not just a lack of optimization.  Such things demonstrate the developer‚Äôs almost complete indifference to the use of the bandwidth of the user's Internet channel. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/128/a79/110/128a79110915daa7658043a697577d4f.png"></div><br>  <i><font color="#999999">Photo optimization</font></i> <br><br>  I compressed all images used on the site using <a href="https://webspeedtest.cloudinary.com/">https://webspeedtest.cloudinary.com/</a> .  There I was advised to use the <a href="https://developers.google.com/speed/webp/">webp</a> format, but I wanted my page to be compatible with as many browsers as possible, so I settled on the jpeg format.  You can customize everything so that webp images are used only in browsers that support this format, but I strove for maximum simplicity and decided that the benefits from the additional level of abstraction associated with images are not worth the effort spent on achieving these benefits. <br><br><h3>  <font color="#3AC1EF">‚ñç Improving the web server: HTTP2, TLS and something else</font> </h3><br>  Starting to optimize the server, I immediately switched to HTTPS.  At the very beginning, I used the usual Nginx on port 80, which simply served the files from <code>/var/www/html</code> .  Here is the code of my source file <code>nginx.conf</code> . <br><br><pre> <code class="hljs pgsql"><span class="hljs-keyword"><span class="hljs-keyword">server</span></span>{   <span class="hljs-keyword"><span class="hljs-keyword">listen</span></span> <span class="hljs-number"><span class="hljs-number">80</span></span>;   server_name jonlu.ca www.jonlu.ca;   root /var/www/html;   <span class="hljs-keyword"><span class="hljs-keyword">index</span></span> <span class="hljs-keyword"><span class="hljs-keyword">index</span></span>.html <span class="hljs-keyword"><span class="hljs-keyword">index</span></span>.htm;   <span class="hljs-keyword"><span class="hljs-keyword">location</span></span> ~ /.git/ {         deny <span class="hljs-keyword"><span class="hljs-keyword">all</span></span>;   }   <span class="hljs-keyword"><span class="hljs-keyword">location</span></span> ~ / {       allow <span class="hljs-keyword"><span class="hljs-keyword">all</span></span>;   } }</code> </pre> <br>  So, I started by configuring HTTPS and redirecting all HTTP requests to HTTPS.  I received a TLS certificate from <a href="https://letsencrypt.org/">Let's Encrypt</a> (this wonderful organization, moreover, recently began to sign wildcard certificates).  Here is the updated <code>nginx.conf</code> . <br><br><pre> <code class="hljs nginx"><span class="hljs-section"><span class="hljs-section">server</span></span> {   <span class="hljs-attribute"><span class="hljs-attribute">listen</span></span> <span class="hljs-number"><span class="hljs-number">443</span></span> ssl http2;   <span class="hljs-attribute"><span class="hljs-attribute">listen</span></span> [::]:<span class="hljs-number"><span class="hljs-number">443</span></span> ssl http2;   <span class="hljs-attribute"><span class="hljs-attribute">server_name</span></span> jonlu.ca www.jonlu.ca;   <span class="hljs-attribute"><span class="hljs-attribute">root</span></span> /var/www/html;   <span class="hljs-attribute"><span class="hljs-attribute">index</span></span> index.html index.htm;   <span class="hljs-attribute"><span class="hljs-attribute">location</span></span> <span class="hljs-regexp"><span class="hljs-regexp">~ /.git</span></span> {       <span class="hljs-attribute"><span class="hljs-attribute">deny</span></span> all;   }     <span class="hljs-attribute"><span class="hljs-attribute">location</span></span> / {       <span class="hljs-attribute"><span class="hljs-attribute">allow</span></span> all;   }   <span class="hljs-attribute"><span class="hljs-attribute">ssl_certificate</span></span> /etc/letsencrypt/live/jonlu.ca/fullchain.pem; <span class="hljs-comment"><span class="hljs-comment"># managed by Certbot   ssl_certificate_key /etc/letsencrypt/live/jonlu.ca/privkey.pem; # managed by Certbot }</span></span></code> </pre> <br>  By adding the <code>http2</code> directive, Nginx was able to use the most useful features of the latest HTTP features.  Please note that in order to use HTTP2 (previously called SPDY), you need to use HTTPS.  Details about this can be found <a href="http2/">here</a> .  In addition, using constructions like <code>http2_push images/Headshot.jpg;</code>  You can use the HTTP2 push directives. <br><br>  Please note that using gzip and TLS increases the risk of <a href="https://en.wikipedia.org/wiki/BREACH">BREACH</a> attacks on a web resource.  In my case, since we are talking about a static site, the risk of such an attack is very low, so I calmly use compression. <br><br><h3>  <font color="#3AC1EF">‚ñçUsing caching and compression directives</font> </h3><br>  What else can be done using only Nginx?  The first thing that comes to mind is the use of caching and compression directives. <br><br>  Previously, my server gave clients plain, uncompressed HTML.  Using a single line <code>gzip: on;</code>  I was able to reduce the size of the transmitted data from 16000 bytes to 8000, and this means reducing their volume by 50%. <br><br>  In fact, this indicator can be further improved if we use the <code>Nginx gzip_static: on;</code> directive <code>Nginx gzip_static: on;</code>  That will allow the system to focus on the use of precompressed versions of files  This is consistent with the above configuration webpack, in particular, in order to organize the preliminary compression of all files during the assembly, you can use <a href="https://github.com/webpack-contrib/zopfli-webpack-plugin">ZopfliPlugin</a> .  This saves computational resources and allows you to maximize compression without losing speed. <br><br>  In addition, my site changes quite rarely, so I wanted to ensure that its resources would be cached for as long as possible.  This would lead to the fact that, visiting my site several times, the user would not need to re-download all the materials (in particular, <code>bundle.js</code> ). <br><br>  This is what server configuration ( <code>nginx.conf</code> ) I finally came to. <br><br><pre> <code class="hljs pgsql">worker_processes auto; pid /run/nginx.pid; worker_rlimit_nofile <span class="hljs-number"><span class="hljs-number">30000</span></span>; events {   worker_connections <span class="hljs-number"><span class="hljs-number">65535</span></span>;   multi_accept <span class="hljs-keyword"><span class="hljs-keyword">on</span></span>;   use epoll; } http {   ##   # Basic Settings   ##   sendfile <span class="hljs-keyword"><span class="hljs-keyword">on</span></span>;   tcp_nopush <span class="hljs-keyword"><span class="hljs-keyword">on</span></span>;   tcp_nodelay <span class="hljs-keyword"><span class="hljs-keyword">on</span></span>;   keepalive_timeout <span class="hljs-number"><span class="hljs-number">65</span></span>;   types_hash_max_size <span class="hljs-number"><span class="hljs-number">2048</span></span>;   # Turn <span class="hljs-keyword"><span class="hljs-keyword">of</span></span> <span class="hljs-keyword"><span class="hljs-keyword">server</span></span> tokens specifying nginx <span class="hljs-keyword"><span class="hljs-keyword">version</span></span>   server_tokens <span class="hljs-keyword"><span class="hljs-keyword">off</span></span>;   open_file_cache max=<span class="hljs-number"><span class="hljs-number">200000</span></span> inactive=<span class="hljs-number"><span class="hljs-number">20</span></span>s;   open_file_cache_valid <span class="hljs-number"><span class="hljs-number">30</span></span>s;   open_file_cache_min_uses <span class="hljs-number"><span class="hljs-number">2</span></span>;   open_file_cache_errors <span class="hljs-keyword"><span class="hljs-keyword">on</span></span>;   <span class="hljs-keyword"><span class="hljs-keyword">include</span></span> /etc/nginx/mime.<span class="hljs-keyword"><span class="hljs-keyword">types</span></span>;   default_type application/octet-stream;   add_header Referrer-<span class="hljs-keyword"><span class="hljs-keyword">Policy</span></span> "no-referrer";   ##   # SSL Settings   ##   ssl_protocols TLSv1 TLSv1<span class="hljs-number"><span class="hljs-number">.1</span></span> TLSv1<span class="hljs-number"><span class="hljs-number">.2</span></span>;   ssl_prefer_server_ciphers <span class="hljs-keyword"><span class="hljs-keyword">on</span></span>;   ssl_dhparam /<span class="hljs-keyword"><span class="hljs-keyword">location</span></span>/<span class="hljs-keyword"><span class="hljs-keyword">to</span></span>/dhparam.pem;   ssl_ciphers <span class="hljs-string"><span class="hljs-string">'ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-AES256-GCM-SHA384:DHE-RSA-AES128-GCM-SHA256:DHE-DSS-AES128-GCM-SHA256:kEDH+AESGCM:ECDHE-RSA-AES128-SHA256:ECDHE-ECDSA-AES128-SHA256:ECDHE-RSA-AES128-SHA:ECDHE-ECDSA-AES128-SHA:ECDHE-RSA-AES256-SHA384:ECDHE-ECDSA-AES256-SHA384:ECDHE-RSA-AES256-SHA:ECDHE-ECDSA-AES256-SHA:DHE-RSA-AES128-SHA256:DHE-RSA-AES128-SHA:DHE-DSS-AES128-SHA256:DHE-RSA-AES256-SHA256:DHE-DSS-AES256-SHA:DHE-RSA-AES256-SHA:AES128-GCM-SHA256:AES256-GCM-SHA384:AES128-SHA256:AES256-SHA256:AES128-SHA:AES256-SHA:AES:CAMELLIA:!aNULL:!eNULL:!EXPORT:!DES:!RC4:!MD5:!PSK:!aECDH:!EDH-DSS-DES-CBC3-SHA:!EDH-RSA-DES-CBC3-SHA:!KRB5-DES-CBC3-SHA'</span></span>;   ssl_session_timeout <span class="hljs-number"><span class="hljs-number">1</span></span>d;   ssl_session_cache shared:SSL:<span class="hljs-number"><span class="hljs-number">50</span></span>m;   ssl_stapling <span class="hljs-keyword"><span class="hljs-keyword">on</span></span>;   ssl_stapling_verify <span class="hljs-keyword"><span class="hljs-keyword">on</span></span>;   add_header <span class="hljs-keyword"><span class="hljs-keyword">Strict</span></span>-Transport-<span class="hljs-keyword"><span class="hljs-keyword">Security</span></span> <span class="hljs-string"><span class="hljs-string">'max-age=31536000; includeSubDomains; preload'</span></span>;   ssl_certificate /<span class="hljs-keyword"><span class="hljs-keyword">location</span></span>/<span class="hljs-keyword"><span class="hljs-keyword">to</span></span>/fullchain.pem;   ssl_certificate_key /<span class="hljs-keyword"><span class="hljs-keyword">location</span></span>/<span class="hljs-keyword"><span class="hljs-keyword">to</span></span>/privkey.pem;   ##   # Logging Settings   ##   access_log /var/<span class="hljs-keyword"><span class="hljs-keyword">log</span></span>/nginx/<span class="hljs-keyword"><span class="hljs-keyword">access</span></span>.<span class="hljs-keyword"><span class="hljs-keyword">log</span></span>;   error_log /var/<span class="hljs-keyword"><span class="hljs-keyword">log</span></span>/nginx/error.<span class="hljs-keyword"><span class="hljs-keyword">log</span></span>;   ##   # Gzip Settings   ##   gzip <span class="hljs-keyword"><span class="hljs-keyword">on</span></span>;   gzip_disable "msie6";   gzip_vary <span class="hljs-keyword"><span class="hljs-keyword">on</span></span>;   gzip_proxied <span class="hljs-keyword"><span class="hljs-keyword">any</span></span>;   gzip_comp_level <span class="hljs-number"><span class="hljs-number">6</span></span>;   gzip_buffers <span class="hljs-number"><span class="hljs-number">16</span></span> <span class="hljs-number"><span class="hljs-number">8</span></span>k;   gzip_http_version <span class="hljs-number"><span class="hljs-number">1.1</span></span>;   gzip_types <span class="hljs-type"><span class="hljs-type">text</span></span>/plain <span class="hljs-type"><span class="hljs-type">text</span></span>/css application/<span class="hljs-type"><span class="hljs-type">json</span></span> application/javascript <span class="hljs-type"><span class="hljs-type">text</span></span>/<span class="hljs-type"><span class="hljs-type">xml</span></span> application/<span class="hljs-type"><span class="hljs-type">xml</span></span> application/<span class="hljs-type"><span class="hljs-type">xml</span></span>+rss <span class="hljs-type"><span class="hljs-type">text</span></span>/javascript application/vnd.ms-fontobject application/x-font-ttf font/opentype image/svg+<span class="hljs-type"><span class="hljs-type">xml</span></span> image/x-icon;   gzip_min_length <span class="hljs-number"><span class="hljs-number">256</span></span>;   ##   # Virtual Host Configs   ##   <span class="hljs-keyword"><span class="hljs-keyword">include</span></span> /etc/nginx/conf.d<span class="hljs-comment"><span class="hljs-comment">/*.conf;   include /etc/nginx/sites-enabled/*; }</span></span></code> </pre> <br>  Please note that all previous improvements regarding TCP settings, gzip directives and caching are not affected here.  If you want to know about all this details - take a look at <a href="https://www.nginx.com/blog/tuning-nginx/">this material</a> on setting up Nginx. <br><br>  But the server configuration block from my <code>nginx.conf</code> . <br><br><pre> <code class="hljs pgsql"><span class="hljs-keyword"><span class="hljs-keyword">server</span></span> {   <span class="hljs-keyword"><span class="hljs-keyword">listen</span></span> <span class="hljs-number"><span class="hljs-number">443</span></span> ssl http2;   server_name jonlu.ca www.jonlu.ca;   root /var/www/html;   <span class="hljs-keyword"><span class="hljs-keyword">index</span></span> <span class="hljs-keyword"><span class="hljs-keyword">index</span></span>.html <span class="hljs-keyword"><span class="hljs-keyword">index</span></span>.htm;   <span class="hljs-keyword"><span class="hljs-keyword">location</span></span> ~ /.git/ {       deny <span class="hljs-keyword"><span class="hljs-keyword">all</span></span>;   }   <span class="hljs-keyword"><span class="hljs-keyword">location</span></span> ~* /(images|js|css|fonts|assets|dist) {       gzip_static <span class="hljs-keyword"><span class="hljs-keyword">on</span></span>; # Tells nginx <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> look <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> compressed versions <span class="hljs-keyword"><span class="hljs-keyword">of</span></span> <span class="hljs-keyword"><span class="hljs-keyword">all</span></span> requested files first       expires <span class="hljs-number"><span class="hljs-number">15</span></span>d; # <span class="hljs-number"><span class="hljs-number">15</span></span> day expiration <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> <span class="hljs-keyword"><span class="hljs-keyword">all</span></span> static assets   } }</code> </pre> <br><h3>  <font color="#3AC1EF">‚ñçLazy loading</font> </h3><br>  And finally, I made a small change in the site, which could significantly improve the situation.  On the page there are 5 images that can be seen only by clicking on the thumbnails corresponding to them.  These images were loaded while loading the rest of the site content (the reason for this is that the paths to them were in the tags <code>&lt;img align="center" src="‚Ä¶"&gt;</code> ). <br><br>  I wrote a small script to modify the corresponding attribute of each element with the <code>lazyload</code> class.  As a result, these images are now loaded only by clicking on the corresponding thumbnails.  Here is the <code>lazyload.js</code> file: <br><br><pre> <code class="hljs lua">$(document).ready(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> {   $(<span class="hljs-string"><span class="hljs-string">"#about"</span></span>).click(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> {       $(<span class="hljs-string"><span class="hljs-string">'#about &gt; .lazyload'</span></span>).each(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> {           //  src   img   data-src           $(this).attr(<span class="hljs-string"><span class="hljs-string">'src'</span></span>, $(this).attr(<span class="hljs-string"><span class="hljs-string">'data-src'</span></span>));       });   });   $(<span class="hljs-string"><span class="hljs-string">"#articles"</span></span>).click(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> {       $(<span class="hljs-string"><span class="hljs-string">'#articles &gt; .lazyload'</span></span>).each(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> {           //  src   img   data-src           $(this).attr(<span class="hljs-string"><span class="hljs-string">'src'</span></span>, $(this).attr(<span class="hljs-string"><span class="hljs-string">'data-src'</span></span>));       });   }); });</code> </pre> <br>  This script accesses the <code>&lt;img&gt;</code> elements, setting <code>&lt;img src="‚Ä¶"&gt;</code> based on <code>&lt;img data-src="‚Ä¶"&gt;</code> , which allows you to load images when they are needed, and not during the loading of basic site materials. <br><br><h2>  <font color="#3AC1EF">Further improvements</font> </h2><br>  I have in mind a few more improvements that can increase page loading speed.  Perhaps the most interesting of them are using a service worker to intercept network requests, which will allow the site to work even without an internet connection, and caching data using CDN, which will allow users located far from my server in San Francisco to save time, necessary to appeal to him.  These are valuable ideas, but they are not particularly important in my case, since this is a small static site that plays the role of an online resume. <br><br><h2>  <font color="#3AC1EF">Results</font> </h2><br>  The above optimization allowed us to reduce the load time of my page from 8 seconds to about 350 milliseconds when it was first accessed, and, on subsequent accesses, to an incredible 200 milliseconds.  As you can see, it took not so much time and effort to achieve such improvements.  And, by the way, for those who are interested in optimizing websites, I recommend reading <a href="https://hpbn.co/">this</a> . <br><br>  <b>Dear readers!</b>  How do you optimize your sites? <br><br><div style="text-align:center;"> <a href="https://ruvds.com/ru-rub/"><img src="https://habrastorage.org/files/1ba/550/d25/1ba550d25e8846ce8805de564da6aa63.png"></a> </div></div><p>Source: <a href="https://habr.com/ru/post/352030/">https://habr.com/ru/post/352030/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../352016/index.html">Transparency and trust</a></li>
<li><a href="../352020/index.html">Work with notifications about events of IOT objects and GPS trackers</a></li>
<li><a href="../352022/index.html">Hacking Team is back in business: ESET has discovered new spyware samples of the company</a></li>
<li><a href="../352024/index.html">3CX v15.5 Update 4 Beta - speech recognition through Microsoft Speech and updated Call Flow Designer</a></li>
<li><a href="../352028/index.html">IT asset management: how myths affect projects</a></li>
<li><a href="../352032/index.html">Interview with designer Alexander Burt about work and life in Brussels</a></li>
<li><a href="../352034/index.html">How we model the subject area in second-order predicates and do not notice this</a></li>
<li><a href="../352036/index.html">Presented by Jenkins X for CI / CD cloud applications at Kubernetes</a></li>
<li><a href="../352038/index.html">How we won the mess with iron and became bureaucrats from scratch</a></li>
<li><a href="../352040/index.html">Seminar ‚ÄúHow does ERP live in the cloud? Experience, scripts, rakes ", March 29, St. Petersburg</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>