<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>On the possibilities of antiviruses. Part 1</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Today the market for antivirus products is as varied as ever. What new technologies do not offer us antivirus companies; opportunities for proactive p...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>On the possibilities of antiviruses. Part 1</h1><div class="post__text post__text-html js-mediator-article">  Today the market for antivirus products is as varied as ever.  What new technologies do not offer us antivirus companies;  opportunities for proactive protection, code emulation, heuristic analysis, cloud technologies, etc.  etc.  are present in the description of almost every self-respecting antivirus.  But how effective these advertised technologies are is a big question.  Let's try to figure it out. <br><a name="habracut"></a><br>  One of the main functions of the anti-virus is to protect the user's computer from previously unknown threats, 0-day viruses, so to speak.  We will evaluate this functionality of antivirus today in practice.  To do this, we will check our test programs with antivirus scanners, and we will use Virus Total as usual.  At the same time, it should immediately be noted that with such testing, various HIPS technologies and the like will not be evaluated in any way, which allow the malicious functionality of the file to be determined on the fly by analyzing its behavior.  That is, our test will be identical to a simple file checking antivirus product.  Let's start. <br><br>  We will test classic malware - the banal Trojan-Downloader.  It is assumed that any software product that calls itself an antivirus, should easily recognize the threat.  Our first test program is as follows: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/44a/c22/57e/44ac2257e3f7240cee3c707f56594d43.png" alt="image"></div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      We load the wonderful program on Virus Total and the following picture opens before us: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/3ed/4e8/7d6/3ed4e87d6ed7285b25872cfd5560b531.png" alt="image"></div><br><br>  Our first test is recognized by only 18 of 43 anti-virus programs. Quite unexpectedly.  Such well-known antiviruses as Avast, Comodo, Nod32, Panda and Symantec immediately surrendered.  How did they manage to avoid such a primitive virus?  Isn't it time for us to demand moral compensation from such ‚Äúantiviruses‚Äù? <br><br>  Go ahead, check whether antiviruses can cope with such a popular technique as the use of structural exceptions.  The second test will look something like this: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/c45/f6b/7d3/c45f6b7d3f2e0f92b8b6990ebadfd663.png" alt="image"></div><br><br>  Here we create our own exception handler, then perform an invalid operation, as a result of which control must be transferred to our handler.  Can our experimental antiviruses cope with this: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/792/921/013/792921013128882d648a49107ec611aa.png" alt="image"></div><br><br>  The sample was recognized by 19 of 43 antiviruses. It is not known why, but SUPERAntiSpyware woke up and gave an unknown alarm.  The rest of the results have not changed.  Maybe antiviruses are not able to properly handle structural exceptions, but simply swear at the suspicious lines used by the program?  Check this and encrypt the data section: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/02a/e74/648/02ae746480f06276783f4b3600c40e65.png" alt="image"></div><br><br>  And now let's see what has changed: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/2b4/578/6bf/2b45786bffa1ee7765f7994aa422898c.png" alt="image"></div><br><br>  Again, the same 18 out of 43 alarms, but now McAfee dropped out of action, and SUPERAntiSpyware again gives an unknown what alarm.  Well, it's time to come up with something more complicated.  We will use something that the antivirus hardly guesses.  My choice fell on the CPUID command, with which you can get the name of the processor.  This is done easily: <br><br> <code>mov edi, offset szName <br> mov eax, 080000002h <br> BYTE 0fh, 0a2h; CPUID <br> mov [edi], eax <br> add edi, 4 <br> mov [edi], ebx <br> add edi, 4 <br> mov [edi], ecx <br> add edi, 4 <br> mov [edi], edx <br> add edi, 4 <br> mov eax, 080000003h <br> BYTE 0fh, 0a2h; CPUID <br> mov [edi], eax <br> add edi, 4 <br> mov [edi], ebx <br> add edi, 4 <br> mov [edi], ecx <br> add edi, 4 <br> mov [edi], edx <br> add edi, 4 <br> mov eax, 080000004h <br> BYTE 0fh, 0a2h; CPUID <br> mov [edi], eax <br> add edi, 4 <br> mov [edi], ebx <br> add edi, 4 <br> mov [edi], ecx <br> add edi, 4 <br> mov [edi], edx <br></code> <br>  After executing this code in the variable szName will be the name of the processor.  How can we use it?  And what if, based on the result obtained, we additionally encrypt a data section?  The only thing we need to achieve in this case is to keep the possibility of running the program on different processors.  It is easy to see that usually in the name of the processor in the first place is the name of the company producing it.  Will it notice the antivirus - that is the question))) Let's write a simple function: <br><br> <code>unsigned int ParseName(char *str) <br> { <br> char *p=str; <br> while(*p==' ') p++; <br> unsigned int hash=p[0]*34+p[1]*344+p[2]*1152+p[3]*44233+p[4]*234321; <br> if(hash==29948155) <br> { <br> return p[0]+p[1]*0x100+p[2]*0x10000+p[3]*0x1000000; <br> } <br> return 0x75273451; <br> } <br></code> <br>  Everything is simple here: first we skip the spaces, then we calculate something like a hash from the first word, and if the hash matches the standard, we calculate the key for the decryption based on this first word.  It remains only to compile the function by any compiler and insert its assembly code into the program.  Since I have an Intel processor on my computer, I calculated the hash from the word Intel.  So our fourth test will not work on all processors.  And how to fix it and not leave AMD offended, I think you yourself will guess.  As a result, we get about the following: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/565/dad/a8f/565dada8f3bd1f6f1ac15445e51c7967.png" alt="image"></div><br><br>  Download the file and see the result: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/086/324/2ec/0863242ec66d1a90a6b7483d3b931b3b.png" alt="image"></div><br><br>  Only 5 of 43 antivirus coped with the task.  Moreover, SUPERAntiSpyware found the virus here clearly by mistake))) Well, and what will happen if we also encrypt the program code?  For example, create a window, find out what text it contains, and then decrypt the program code based on the information received.  It may look like this: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/2f8/dd8/4bf/2f8dd84bf0c3bd84f322efd6a5866680.png" alt="image"></div><br><br>  Sending the file: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/714/abe/c74/714abec7406b6a2365c1cb08ebeeb998.png" alt="image"></div><br><br>  Now 6 of 43 anti-viruses have responded. However, 4 of them could not determine the type of malware.  This fact indicates that the antiviruses simply did not cope with the task - they could not decipher the body of the virus and gave the alarm only because the file was packed.  In general, this is morally wrong: there is nothing wrong with the packaging of executable files.  It is not our fault that the antivirus program cannot work correctly with packed files.  Conclusion number one - always check your software after packaging in order to avoid unpleasant incidents.  Conclusion number two - only two antiviruses really coped with our latest test: Kaspersky and Microsoft.  What is the reason - is unknown.  Maybe with the fact that they managed to bring some kind of signature into the database?  Or their signatures can break through XOR encryption?  I think that you can put a fat point on this place, especially as Kaspersky is my favorite antivirus, and I have no complaints about Microsoft products (... well ... until Windows 8 came out). <br><br>  Global conclusion: today proactive technologies are still far from perfect and they are not very difficult to deceive. <br><br>  PS The article has not examined HIPS technology, which is able to determine the malicious functionality of a file on the fly, by analyzing its behavior.  Therefore, not everything is as bad as it seems - if you, having checked the file with an antivirus and did not find anything, launch it for execution, then the antivirus will most likely give you a warning.  But this topic is a completely different story. </div><p>Source: <a href="https://habr.com/ru/post/136232/">https://habr.com/ru/post/136232/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../136224/index.html">We build a tracked Bluetooth robot with a camera. Part 3</a></li>
<li><a href="../136225/index.html">About two-dimensional packaging: offline algorithms</a></li>
<li><a href="../136227/index.html">Multi-criteria selection of alternatives using fuzzy inference rules. Implementation in Java. Part 3/3: Example</a></li>
<li><a href="../136228/index.html">JQuery plugin for sorting tables: TableSorter.js. How to achieve pagination?</a></li>
<li><a href="../136230/index.html">Unified API on PHP for all cloud push services</a></li>
<li><a href="../136234/index.html">An inside view: the world around us</a></li>
<li><a href="../136236/index.html">(#KatawaShoujo) Visual novel ‚ÄúKatawa Shoujo‚Äù as a bright event in the world of free culture and charity</a></li>
<li><a href="../136237/index.html">Neural network against DDoS'a</a></li>
<li><a href="../136238/index.html">Gorgeous Stickers with CSS3</a></li>
<li><a href="../136239/index.html">Fredo & Pid'jin and SOPA</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>