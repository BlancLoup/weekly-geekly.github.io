<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Technical support 3CX responds: seizure of SIP-traffic on the PBX server</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="In this article we will talk about the basics of capturing and analyzing SIP-traffic generated by the 3CX PBX. The article is addressed to novice syst...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Technical support 3CX responds: seizure of SIP-traffic on the PBX server</h1><div class="post__text post__text-html js-mediator-article">  In this article we will talk about the basics of capturing and analyzing SIP-traffic generated by the 3CX PBX.  The article is addressed to novice system administrators or regular users, whose duties include telephony service.  For in-depth study of the topic, we recommend you to take the <a href="https://www.3cx.ru/3cxacademy/advanced/basic-troubleshooting/">Advanced 3CX Training Course</a> . <br><br>  3CX V16 allows you to capture SIP traffic directly through the server‚Äôs web interface and save it in standard Wireshark PCAP format.  You can attach a capture file when contacting technical support or download for independent analysis. <a name="habracut"></a><br><br>  If 3CX runs on Windows, you must install Wireshark yourself on the 3CX server.  Otherwise, the following message will appear when attempting to capture. <br><img src="https://habrastorage.org/getpro/habr/post_images/170/ed9/40b/170ed940b2159d489164e56fd1ed5d61.png">
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      On Linux systems, the tcpdump utility is installed automatically when installing or updating 3CX. <br><br><h2>  Traffic capture </h2><br>  To start the capture, go to the interface section Home&gt; SIP Events and select the interface on which you want to capture.  You can also capture traffic on all interfaces at the same time, except for IPv6 tunneling interfaces. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/3be/f3b/1b7/3bef3b1b7e78206b60788a3f593a07bc.png"><br><br>  In 3CX for Linux, you can capture traffic for a local host (lo).  This capture is used to analyze SIP client connections using <a href="https://www.3cx.ru/docs/3cx-tunnel-session-border-controller/">3CX Tunnel and Session Border Controller</a> technology. <br><br>  The Traffic Capture button launches Wireshark on Windows or tcpdump on Linux.  At this point, you need to quickly reproduce the problem, because  Capture loads the processor and takes up enough disk space. <br><img src="https://habrastorage.org/getpro/habr/post_images/1c3/b4e/dba/1c3b4edba3ec938ba5eec5b7d13667a1.png"><br><br>  Pay attention to the following call options: <br><br><ul><li>  The number from which they called, the other numbers / participants of the call also called. <br></li><li>  The exact time of the problem on the clock server 3CX. <br></li><li>  The route of the call. <br></li></ul><br>  Try not to click anywhere else in the interface, except for the ‚ÄúStop‚Äù button.  Also, do not follow other links in this browser window.  Otherwise, traffic capture will continue in the background and will cause additional load on the server. <br><br><h2>  Getting the capture file </h2><br>  The Stop button stops capturing and saves the capture file.  You can download the file to your computer for analysis in the Wireshark utility or generate a special <a href="https://www.3cx.ru/support/">technical support</a> file that will include this capture and other debug information.  Once downloaded or included in a technical support package, the capture file is automatically deleted from the 3CX server for security reasons. <br><br>  On the server, the 3CX file is located in the following location: <br><br><ul><li>  Windows: C: \ ProgramData \ 3CX \ Instance1 \ Data \ Logs \ dump.pcap <br></li><li>  Linux: /var/lib/3cxpbx/Instance/Data/Logs/dump.pcap <br></li></ul><br>  To avoid increased server load or packet loss during capture, the capture period is limited to 2 million packets.  After that, the seizure automatically stops.  If you need a longer capture, use the separate Wireshark utility, as described below. <br><br><h2>  Traffic capture utility Wireshark </h2><br>  If you are interested in a deeper analysis of network traffic, capture it manually.  Download Wireshark Utility for your OS <a href="http://www.wireshark.org/download.html">from here</a> .  After installing the utility on the 3CX server, go to Capture&gt; Interfaces.  All OS network interfaces will be shown here.  Interface IP addresses can be shown in IPv6 standard.  To see the IPv4 address, click on the IPv6 address. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/aa8/011/f70/aa8011f7006210f391cf07fea10dcdc9.png"><br><br>  Select the interface to capture and click the Options button.  Uncheck Capture Traffic in promiscuous mode and leave the other settings unchanged. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/14b/dc7/fbf/14bdc7fbfad0be3a6785e578c989f01c.png"><br><br>  Now you should reproduce the problem.  When the problem is reproduced, stop the capture (menu Capture&gt; Stop).  You can select SIP messages in the menu Telephony&gt; SIP Flows. <br><br><h2>  Traffic Analysis Basics - SIP INVITE Message </h2><br>  Consider the main fields of the SIP INVITE message that is sent to establish a VoIP call, i.e.  is the starting point for analysis.  Usually SIP INVITE includes from 4 to 6 fields with information that is used by SIP end devices (phones, gateways) and telecom operators.  Understanding the contents of the INVITE and the messages that follow it often helps determine the source of the problem.  In addition, knowledge of the INVITE fields helps in connecting SIP operators to 3CX or combining 3CX with other SIP PBXs. <br><br>  In an INVITE message, users (or SIP devices) are identified by a URI.  Typically, the SIP URI is the user's phone number + SIP server address.  A SIP URI is very similar to an e-mail address and is written as sip: x @ y: Port. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/d9f/81a/c5a/d9f81ac5a0cc88303b7ea2178bf3212d.png"><br><br><h3>  Request-Line-URI: </h3><br>  Request-Line-URI - the field contains the call recipient.  It contains the same information as the To field, but without the display name of the user (Display Name). <br><br><h3>  Via: </h3><br>  Via ‚Äî each SIP server (proxy) through which an INVITE request passes, adds its IP address and port to which the message was received at the top of the Via list.  Then the message is passed on along the way.  When the final recipient responds to the INVITE request, all transit nodes ‚Äúlook through‚Äù the Via header and return the message to the sender along the same route.  In this case, the transit SIP proxy removes its data from the header. <br><br><h3>  From: </h3><br>  From - the header indicates the initiator of the request from the point of view of the SIP server.  The header is formed in the same way as the e-mail address (user @ domain, where user is the extension number of the 3CX user, and domain is the local IP address or the SIP domain of the 3CX server).  Like the To header, the From header contains the URI and, optionally, the display name of the user Display Name.  From the From header you can understand exactly how this SIP request should be processed. <br><br>  The SIP RFC 3261 standard provides that if the display name of the Display Name is not transmitted, the IP phone or VoIP gateway (UAC) should use the Display Name "Anonymous", for example, From: "Anonymous" &lt;sip: 10000@10.172.0.2&gt;. <br><br><h3>  To: </h3><br>  To - this header indicates the recipient of the request.  This can be either the final recipient of the call or an intermediate.  Typically, the header contains a SIP URI, but other schemes are possible (see RFC 2806 [9]).  However, the SIP URI must be supported in all implementations of the SIP protocol, regardless of the manufacturer of the equipment.  The To header may also contain a display name Display Name, for example, To: "First Name Last Name" &lt;sip: 101@10.172.0.2&gt;). <br><br>  Typically, the To field contains a SIP URI indicating the first (next) SIP proxy that will handle the request.  This does not have to be the final recipient of the request. <br><br><h3>  Contact: </h3><br>  Contact - the header contains the SIP URI, by which you can contact the sender of the INVITE request.  This is a required header that should contain only one SIP URI.  It is part of two-way communication corresponding to the original SIP INVITE request.  It is very important that the Contact header contains correct information (including an IP address) that the sender of the request is waiting for a response to.  URI Contact is also used in further communications, after the establishment of a communication session. <br><br><h3>  Allow: </h3><br>  Allow - the field contains a list of parameters (SIP-methods), separated by a comma.  They describe which SIP capabilities this particular sender (device) supports.  Complete list of methods: ACK, BYE, CANCEL, INFO, INVITE, NOTIFY, OPTIONS, PRACK, REFER, REGISTER, SUBSCRIBE, UPDATE.  More SIP methods are described <a href="https://www.3cx.com/blog/voip-howto/sip-messages/">here</a> . </div><p>Source: <a href="https://habr.com/ru/post/455381/">https://habr.com/ru/post/455381/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../45537/index.html">About Fallout 3, modifications and additions</a></li>
<li><a href="../455371/index.html">Stable current source from 5 ŒºA to 20 mA</a></li>
<li><a href="../455373/index.html">How to adjust the law of Spring to make it lifting for small providers? Cancel it</a></li>
<li><a href="../455377/index.html">IoT architecture</a></li>
<li><a href="../455379/index.html">(Static) Selection of optimal containers in C ++ programs</a></li>
<li><a href="../455383/index.html">How to start programming a newbie for free</a></li>
<li><a href="../455387/index.html">Understanding Machine Learning in the Elastic Stack (aka Elasticsearch, aka ELK)</a></li>
<li><a href="../455389/index.html">Haxe 4: What's new?</a></li>
<li><a href="../45539/index.html">The Japanese have released a browser with three engines</a></li>
<li><a href="../455391/index.html">RISC-V: RocketChip in unnatural habitat</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>