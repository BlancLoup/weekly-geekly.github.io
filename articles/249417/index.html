<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Breeze Server - we delimit access to objects using attributes</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="In the last article, Breeze.js + Entity Framework + Angular.js = convenient work with database entities directly from the browser, we looked at creati...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Breeze Server - we delimit access to objects using attributes</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/files/592/5dc/aaa/5925dcaaa61740d1b83189500f944b8a.png" align="left"><br>  In the last article, <a href="http://habrahabr.ru/post/246441/">Breeze.js + Entity Framework + Angular.js = convenient work with database entities directly from the browser,</a> we looked at creating a simplest application, where we took samples and stored data in the database directly from javascript in the browser.  Of course, the first readers to have questions about security.  Therefore, today we will look at how to organize access control.  To do this, we will slightly modify our application from the previous article so that it would be possible with the help of attributes to distribute certain access rights to add, delete, modify and view data to certain users or roles. <br><a name="habracut"></a><br>  Unfortunately, there are no built-in tools for this in the library.  And here, the developers offer us two ways. <br><br><h4>  The first way </h4><br>  Absolutely all changes in our application were saved using the SaveChanges method of a single DbController controller.  And, if we do not need flexible access control, but we just need to allow someone to save data, or deny it, then the easiest way out is simply to hang the <a href="http.authorizeattribute(v%3Dvs.118).aspx">Authorize</a> attribute on SaveChanges, and then WebApi will take care of giving / denying access to data change.  This option is very straightforward and absolutely not flexible, all or nothing, and, as a rule, in real projects this is always not enough. <br><br><h4>  Path Two </h4><br>  The SaveChanges method accepts one JObject parameter, it contains in one package all the data that needs to be saved.  Then we pass it EFContextProvider to the SaveChanges method, and he already parses the object with the data and saves the changes to the database.  It has the virtual method BeforeSaveEntity, which is called each time before saving the entity, and we will use it. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Since the article on security, I consider it necessary, just in case, to mention that the <u><b>code from the article serves solely the purpose of showing some ways by which security mechanisms can be implemented and only for this purpose, in order not to complicate the project, a rather bad programming style is used, therefore using pieces This code in real projects is absolutely unacceptable.</b></u> <br><br>  Perhaps, let's go straight to the practice, and, as we go, let's analyze what and how.  Let's start from the place where we stopped in the <a href="http://habrahabr.ru/post/246441/">last article</a> , for this you can download the project <a href="http://1drv.ms/1DPZruW">at this link</a> .  After downloading the project you need to build, so that NuGet will restore all the packages that I removed from the project to reduce the size, and you can proceed. <br><br>  First you need to implement authentication.  Let's make the simplest cookie-based authentication, for this we install the NuGet <a href="">Microsoft ASP.NET Identity Owin package</a> , <a href="">Microsoft ASP.NET Web API 2.2 OWIN</a> and <a href="">Microsoft.Owin.Host.SystemWeb</a> , since last time we didn‚Äôt use OWIN in the application, then we will create OWIN Startup class Startup.cs, and in it we register the standard route for WebApi controllers, set the authentication type to DefaultAuthenticationTypes.ApplicationCookie and use CamelCasePropertyNamesContractResolver to force WebApi to give us data to camelCase. <br><pre><code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">using</span></span> System; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> System.Threading.Tasks; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> Microsoft.Owin; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> Owin; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> System.Web.Http; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> Newtonsoft.Json.Serialization; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> Microsoft.Owin.Security.Cookies; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> Microsoft.AspNet.Identity; [assembly: OwinStartup(<span class="hljs-keyword"><span class="hljs-keyword">typeof</span></span>(BreezeJsDemo.App_Start.Startup))] <span class="hljs-keyword"><span class="hljs-keyword">namespace</span></span> <span class="hljs-title"><span class="hljs-title">BreezeJsDemo.App_Start</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">Startup</span></span> { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Configuration</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">IAppBuilder app</span></span></span><span class="hljs-function">)</span></span> { HttpConfiguration config = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> HttpConfiguration(); config.MapHttpAttributeRoutes(); config.Routes.MapHttpRoute( name: <span class="hljs-string"><span class="hljs-string">"DefaultApi"</span></span>, routeTemplate: <span class="hljs-string"><span class="hljs-string">"api/{controller}/{id}"</span></span>, defaults: <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> { id = RouteParameter.Optional } ); app.UseCookieAuthentication(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> CookieAuthenticationOptions { AuthenticationType = DefaultAuthenticationTypes.ApplicationCookie }); config.Formatters.JsonFormatter.SerializerSettings.ContractResolver = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> CamelCasePropertyNamesContractResolver(); app.UseWebApi(config); } } }</code> </pre> <br>  Now we will create the LoginController.cs controller. <br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">using</span></span> System; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> System.Collections.Generic; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> System.Linq; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> System.Web; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> System.Web.Http; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> Microsoft.Owin; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> Microsoft.Owin.Security; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> System.Security.Claims; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> Microsoft.AspNet.Identity; <span class="hljs-keyword"><span class="hljs-keyword">namespace</span></span> <span class="hljs-title"><span class="hljs-title">BreezeJsDemo.Controllers</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">LoginController</span></span> : <span class="hljs-title"><span class="hljs-title">ApiController</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">LoginViewModel</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> user { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> role { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> IHttpActionResult </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Post</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">LoginViewModel login</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> authenticationManager = HttpContext.Current.GetOwinContext().Authentication; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (authenticationManager.User.Identity.IsAuthenticated) { authenticationManager.SignOut(DefaultAuthenticationTypes.ApplicationCookie); } <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> claims = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Claim[] { <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Claim( ClaimTypes.Name, login.user), <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Claim( ClaimTypes.Role, login.role) }; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> identity = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ClaimsIdentity(claims, DefaultAuthenticationTypes.ApplicationCookie); authenticationManager.SignIn(identity); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> Ok(); } } }</code> </pre><br>  Here we use the Post method to take the username and role name, create a ClaimsIdentity based on them, and log in.  In order not to complicate the example, we will not do neither checks, nor passwords, nor user bases, so to say: <br>  <i>-We are all gentlemen here, all believe in each other's words.</i> <br><br>  Now add the appropriate fields to the interface.  First of all, you need to change a little /app/shoppingList/shoppingList.controller.js.  We need the $ http service, so add it depending <br><pre> <code class="javascript hljs">... ShoppingListController.$inject = [<span class="hljs-string"><span class="hljs-string">'$scope'</span></span>, <span class="hljs-string"><span class="hljs-string">'$http'</span></span>, <span class="hljs-string"><span class="hljs-string">'breeze'</span></span>]; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ShoppingListController</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">$scope, $http, breeze</span></span></span><span class="hljs-function">) </span></span>{ ...</code> </pre><br>  And the login () function <br><pre> <code class="javascript hljs">... vm.login = login; ... function login() { $http.post(<span class="hljs-string"><span class="hljs-string">'api/login'</span></span>, { <span class="hljs-attr"><span class="hljs-attr">user</span></span>: vm.user, <span class="hljs-attr"><span class="hljs-attr">role</span></span>: vm.role }); } ...</code> </pre><br>  Add username and role input fields to the /app/shoppingList/shoppingList.html markup, for example, up in the navbar <br><pre> <code class="html hljs xml"> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">nav</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"navbar navbar-default"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">ul</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"navbar-nav nav"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">li</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">ng-if</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"vm.hasChanges()"</span></span></span><span class="hljs-tag">&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">a</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">ng-click</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"vm.saveChanges()"</span></span></span><span class="hljs-tag">&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">span</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"glyphicon glyphicon-thumbs-up"</span></span></span><span class="hljs-tag">&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">span</span></span></span><span class="hljs-tag">&gt;</span></span>  <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">a</span></span></span><span class="hljs-tag">&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">li</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">li</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">ng-if</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"vm.hasChanges()"</span></span></span><span class="hljs-tag">&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">a</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">ng-click</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"vm.rejectChanges()"</span></span></span><span class="hljs-tag">&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">span</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"glyphicon glyphicon-thumbs-down"</span></span></span><span class="hljs-tag">&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">span</span></span></span><span class="hljs-tag">&gt;</span></span>  <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">a</span></span></span><span class="hljs-tag">&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">li</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">li</span></span></span><span class="hljs-tag">&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">a</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">ng-click</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"vm.refreshData()"</span></span></span><span class="hljs-tag">&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">span</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"glyphicon glyphicon-refresh"</span></span></span><span class="hljs-tag">&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">span</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">a</span></span></span><span class="hljs-tag">&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">li</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">ul</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">form</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"navbar-form navbar-right"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"form-group"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">input</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">ng-model</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"vm.user"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"form-control"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">placeholder</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">" "</span></span></span><span class="hljs-tag"> /&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">input</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">ng-model</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"vm.role"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"form-control"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">placeholder</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">""</span></span></span><span class="hljs-tag"> /&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">button</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">ng-click</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"vm.login()"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"btn btn-link"</span></span></span><span class="hljs-tag">&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">span</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"glyphicon glyphicon-user"</span></span></span><span class="hljs-tag">&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">span</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">button</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">form</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">nav</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre><br>  Now, when we can introduce ourselves to our application whoever we want, let's move on to the access attributes.  Suppose we will distribute access rights using the following attributes: CanAddAttribute (gives the right to add a new record to the database), CanDeleteAttribute (delete right) and CanEditAttribute (right to change), and if you hang CanEditAttribute on the class properties, the user can change their values, and if you hang it on a class - the user will be able to change all its properties without exceptions.  Of course, in a real project such a scheme would be extremely inconvenient and unviable, but to explain the idea of ‚Äã‚Äãthis set would be quite enough. <br><pre> <code class="cs hljs"> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">HasRightsAttribute</span></span>: <span class="hljs-title"><span class="hljs-title">Attribute</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> String User { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> String Role { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } } [AttributeUsage(AttributeTargets.Class, AllowMultiple=<span class="hljs-literal"><span class="hljs-literal">true</span></span>)] <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">CanAddAttribute</span></span>: <span class="hljs-title"><span class="hljs-title">HasRightsAttribute</span></span> { } [AttributeUsage(AttributeTargets.Class, AllowMultiple = <span class="hljs-literal"><span class="hljs-literal">true</span></span>)] <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">CanDeleteAttribute</span></span> : <span class="hljs-title"><span class="hljs-title">HasRightsAttribute</span></span> { } [AttributeUsage(AttributeTargets.Class | AttributeTargets.Property, AllowMultiple = <span class="hljs-literal"><span class="hljs-literal">true</span></span>)] <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">CanEditAttribute</span></span>: <span class="hljs-title"><span class="hljs-title">HasRightsAttribute</span></span> { }</code> </pre><br>  We distribute these attributes to our models, for example <br><pre> <code class="cs hljs"> [<span class="hljs-meta"><span class="hljs-meta">CanEdit(User = </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"User"</span></span></span><span class="hljs-meta">)</span></span>] [CanAdd(Role = <span class="hljs-string"><span class="hljs-string">"Role"</span></span>)] [CanDelete(Role = <span class="hljs-string"><span class="hljs-string">"Role2"</span></span>)] <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">ListItem</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> Id { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> String Name { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } [CanEdit(User = <span class="hljs-string"><span class="hljs-string">"User2"</span></span>, Role = <span class="hljs-string"><span class="hljs-string">"Role2"</span></span>)] <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> Boolean IsBought { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> CategoryId { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> Category Category { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } }</code> </pre><br>  And this is what it will mean: <br><ul><li>  Role users have the right to add ListItem objects to the database. </li><li>  users with the role of "Role2" can delete them </li><li>  a user named ‚ÄúUser‚Äù can change the values ‚Äã‚Äãof any of his fields </li><li>  users with the role of "Role2" can change the value of the IsBought field </li><li>  users named "User2" can change the value of the IsBought field </li></ul><br>  And add something like this to the Category class. <br><pre> <code class="cs hljs"> [<span class="hljs-meta"><span class="hljs-meta">CanEdit( User = </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"User"</span></span></span><span class="hljs-meta">)</span></span>] [CanAdd( Role = <span class="hljs-string"><span class="hljs-string">"Role"</span></span>)] <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">Category</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> Id { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> String Name { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> List&lt;ListItem&gt; ListItems { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } }</code> </pre><br>  Now let's work on the main one, create a class SecureEFContextProvider - the successor of the EFContextProvider, which will implement access control <br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">using</span></span> Breeze.ContextProvider; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> Breeze.ContextProvider.EF6; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> BreezeJsDemo.Classes.Attributes; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> System; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> System.Collections.Generic; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> System.Linq; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> System.Web; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> System.Reflection; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> System.Web.Http; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> System.Net; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> System.Security.Claims; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> System.Data.Entity.Infrastructure; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> System.Data.Entity.Core.Objects; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> BreezeJsDemo.Model; <span class="hljs-keyword"><span class="hljs-keyword">namespace</span></span> <span class="hljs-title"><span class="hljs-title">BreezeJsDemo.Classes</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">SecureEFContextProvider</span></span>&lt;<span class="hljs-title"><span class="hljs-title">T</span></span>&gt; : <span class="hljs-title"><span class="hljs-title">EFContextProvider</span></span>&lt;<span class="hljs-title"><span class="hljs-title">T</span></span>&gt; <span class="hljs-title"><span class="hljs-title">where</span></span> <span class="hljs-title"><span class="hljs-title">T</span></span> : <span class="hljs-title"><span class="hljs-title">class</span></span>, <span class="hljs-title"><span class="hljs-title">new</span></span>() { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">protected</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">override</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">bool</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">BeforeSaveEntity</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">EntityInfo entityInfo</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> user = HttpContext.Current.GetOwinContext().Authentication.User; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (user.Identity.IsAuthenticated) { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> userName = user.FindFirst(ClaimTypes.Name).Value; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> role = user.FindFirst(ClaimTypes.Role).Value; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> entityType = entityInfo.Entity.GetType(); <span class="hljs-keyword"><span class="hljs-keyword">switch</span></span> (entityInfo.EntityState) { <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> EntityState.Added: <span class="hljs-comment"><span class="hljs-comment">//    CanAddAttribute      if (entityType.GetCustomAttributes&lt;CanAddAttribute&gt;().Any(x =&gt; x.Role == role || x.User == userName)) { return true; } break; case EntityState.Deleted: //    CanDeleteAttribute      if (entityType.GetCustomAttributes&lt;CanDeleteAttribute&gt;().Any(x =&gt; x.Role == role || x.User == userName)) { return true; } break; case EntityState.Modified: //    CanEditAttribute      if (entityType.GetCustomAttributes&lt;CanEditAttribute&gt;().Any(x =&gt; x.Role == role || x.User == userName)) { return true; } //    if (entityInfo.OriginalValuesMap.All(x =&gt; entityType .GetProperty(x.Key) //  CanEditAttribute      .GetCustomAttributes&lt;CanEditAttribute&gt;().Any(y =&gt; y.Role == role || y.User == userName))) { return true; } break; } } //   throw new HttpResponseException(HttpStatusCode.Forbidden); } } }</span></span></code> </pre><br>  In this class, we overloaded the BeforeSaveEntity method, EFContextProvider calls it before saving each entity.  This place is provided by developers specifically to check what we are going to change, to validate changes or change some data before storing, for example, the date of the last change of the object.  If the method returns false - the entity will not be saved, if an exception is thrown in the method, the entire batch of changes will be saved and the exception will be returned to the client.  The base version of the method simply always returns true, so instead of calling it, you can write return true. <br><br>  You can also overload the protected Dictionary &lt;Type, List&gt; BeforeSaveEntities (Dictionary &lt;Type, List&gt; saveMap) method, the entire save package immediately gets into it, you should also return the Dictionary &lt;Type, List&gt;, this will be the new save package. <br><br>  These methods take as input objects of type EntityInfo, which contains data about the entity you want to save and the type of operation you want to perform, consider some of its properties. <br><br><ul><li>  ContextProvider ContextProvider - link to ContextProvider </li><li>  Object Entity - directly saved entity itself as a .NET object, with property values ‚Äã‚Äãthat came from the client in the package </li><li>  EntityState EntityState - object status (Added, Modified, Deleted) </li><li>  Dictionary &lt;String, Object&gt; OriginalValuesMap - the original property values, before saving.  The breeze will change in the database the values ‚Äã‚Äãof only those fields whose names are the keys of this dictionary, while not touching the rest of the entry.  And this is the data that came from the client in the package of changes, that is, <u>this data cannot be trusted</u> .  The breeze itself does not pay attention to the values ‚Äã‚Äãof the properties that are stored there (with the exception of the fields that are used for concurrency check), it is only important to have a key with the name of the variable field in the dictionary.  That is, if you, for example, want to change the EditDate property on the server side, which is not changed on the client, you will first need to change its value in Entity, and then add the ‚ÄúEditDate‚Äù key in OriginalValuesMap with any value, for example, null .  And vice versa, if you do not want to change the value of any field that the client wanted to change - you need to delete the corresponding key from the OriginalValuesMap. </li><li>  bool ForceUpdate - if set to true - the breeze will update the values ‚Äã‚Äãof all fields of the entity, in spite of the contents of the OriginalValuesMap, defaults to false </li><li>  Dictionary &lt;String, Object&gt; UnmappedValuesMap - values ‚Äã‚Äãof other properties of the entity that came with the save package in json, but not included in your model. </li></ul><br>  First of all, in the method, we check if the user has passed authentication (user.Identity.IsAuthenticated), and if not, we prohibit saving.  Next, we check the status of the entity and look for the corresponding attribute for the user name or its role, if there is one, we allow saving.  If the status is EntityState.Modified and the user does not have rights to change the entire object, we look at the changed properties in OriginalValuesMap and look for the necessary attribute of the property, if there is no such property, we prohibit saving. <br><br>  Considering that each entity falls into this method before being saved, it is also possible to implement the distinction not at the field level, but at the level of individual records.  For example, to prevent User from deleting an entry with identifier 1. It is also possible, for example, instead of attributes, to store all access rights somewhere in the database so that you can change them in runtime. <br><br>  Next, in DbController you need to replace EFContextProvider with our SecureEFContextProvider. <br><pre> <code class="cs hljs">... <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> SecureEFContextProvider&lt;ShoppingListDbContext&gt; _contextProvider = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> SecureEFContextProvider&lt;ShoppingListDbContext&gt;(); ...</code> </pre><br>  Now the preservation of each entity under our control.  But if now try to make any changes - the user will think that everything went well, because we did not handle the error while saving.  Let's make some small changes to the saveChanges method. <br><pre> <code class="javascript hljs"> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">saveChanges</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ manager.saveChanges().then(<span class="hljs-literal"><span class="hljs-literal">null</span></span>, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">error</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (error.status === <span class="hljs-number"><span class="hljs-number">403</span></span>) { manager.rejectChanges(); alert(<span class="hljs-string"><span class="hljs-string">"   "</span></span>); } }); }</code> </pre><br>  Now, if the server returns 403, the changes that did not succeed will be rolled back, and the user will see the message. <br><br>  With preservation sorted out.  Now let's talk about access to read certain data.  The most logical and reliable method, of course, is to create a DTO for each entity you want to work with, make connections between them, then create a special DbContext for them, just to generate client metadata using EFContextProvider.  In DbController make appropriate methods for each DTO.  In general, everything is exactly the same as in our application, but in the BeforeSaveEntity method, it accepts DTO and already works with the real context and real entities, and then returns false from the method so that the DTO context does not try to save.  In this case, the BeforeSaveEntities method is better, because the entire save package immediately gets into it, and, accordingly, you can save all changes at once in one sitting, then you need to return the empty Dictionary &lt;Type, List&gt; from the method so that the DTO context does not began to save anything. <br><br>  With this approach, the client will not get any extra data, plus we do not disclose the scheme of our database.  But, naturally, the amount of work on creating DTO and additional processing of their preservation also increases.  Of course, it is difficult to scare someone with this, but why don't we even dream up a little more ... <br><br>  First, we write the attribute, which will distribute the rights to read entities and properties <br><pre> <code class="cs hljs"> [<span class="hljs-meta"><span class="hljs-meta">AttributeUsage(AttributeTargets.Class | AttributeTargets.Property, AllowMultiple = true)</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">CanReadAttribute</span></span>: <span class="hljs-title"><span class="hljs-title">HasRightsAttribute</span></span> { }</code> </pre><br>  Distribute attributes to classes <br><pre> <code class="cs hljs"> [<span class="hljs-meta"><span class="hljs-meta">CanEdit(User = </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"User"</span></span></span><span class="hljs-meta">)</span></span>] [CanAdd(Role = <span class="hljs-string"><span class="hljs-string">"Role"</span></span>)] [CanDelete(Role = <span class="hljs-string"><span class="hljs-string">"Role2"</span></span>)] [CanRead(User = <span class="hljs-string"><span class="hljs-string">"User"</span></span>, Role = <span class="hljs-string"><span class="hljs-string">"Role"</span></span>)] <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">ListItem</span></span> { [CanRead(Role = <span class="hljs-string"><span class="hljs-string">"Role2"</span></span>, User = <span class="hljs-string"><span class="hljs-string">"User2"</span></span>)] <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> Id { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> String Name { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } [CanEdit(User = <span class="hljs-string"><span class="hljs-string">"User2"</span></span>, Role = <span class="hljs-string"><span class="hljs-string">"Role2"</span></span>)] [CanRead(Role=<span class="hljs-string"><span class="hljs-string">"Role2"</span></span>, User=<span class="hljs-string"><span class="hljs-string">"User2"</span></span>)] <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> Boolean IsBought { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } [CanRead(Role = <span class="hljs-string"><span class="hljs-string">"Role2"</span></span>, User = <span class="hljs-string"><span class="hljs-string">"User2"</span></span>)] <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> CategoryId { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> Category Category { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } }</code> </pre><br><pre> <code class="cs hljs"> [<span class="hljs-meta"><span class="hljs-meta">CanEdit(User = </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"User"</span></span></span><span class="hljs-meta">)</span></span>] [CanAdd(Role = <span class="hljs-string"><span class="hljs-string">"Role"</span></span>)] [CanRead(User=<span class="hljs-string"><span class="hljs-string">"User"</span></span>, Role=<span class="hljs-string"><span class="hljs-string">"Role"</span></span>)] [CanRead(Role = <span class="hljs-string"><span class="hljs-string">"Role2"</span></span>, User = <span class="hljs-string"><span class="hljs-string">"User2"</span></span>)] <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">Category</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> Id { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> String Name { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> List&lt;ListItem&gt; ListItems { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } }</code> </pre><br>  The principle is the same if there is an attribute on the class - the user has the right to view all the properties, if not - then only those on which there is an attribute.  We will hide data in the ObjectContext ObjectMaterialized event, for this we will slightly supplement the class SecureEFContextProvider <br><pre> <code class="cs hljs"> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">SecureEFContextProvider</span></span>&lt;<span class="hljs-title"><span class="hljs-title">T</span></span>&gt; : <span class="hljs-title"><span class="hljs-title">EFContextProvider</span></span>&lt;<span class="hljs-title"><span class="hljs-title">T</span></span>&gt; <span class="hljs-title"><span class="hljs-title">where</span></span> <span class="hljs-title"><span class="hljs-title">T</span></span> : <span class="hljs-title"><span class="hljs-title">class</span></span>, <span class="hljs-title"><span class="hljs-title">new</span></span>() { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">SecureEFContextProvider</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { ObjectContext.ObjectMaterialized += ObjectContext_ObjectMaterialized; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ObjectContext_ObjectMaterialized</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">object</span></span></span></span><span class="hljs-function"><span class="hljs-params"> sender, ObjectMaterializedEventArgs e</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> user = HttpContext.Current.GetOwinContext().Authentication.User; String userName = <span class="hljs-literal"><span class="hljs-literal">null</span></span>; String role = <span class="hljs-literal"><span class="hljs-literal">null</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (user.Identity.IsAuthenticated) { userName = user.FindFirst(ClaimTypes.Name).Value; role = user.FindFirst(ClaimTypes.Role).Value; } <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> entityType = e.Entity.GetType(); <span class="hljs-comment"><span class="hljs-comment">//    CanReadAttribute      -      if (entityType.GetCustomAttributes&lt;CanReadAttribute&gt;().Any(x =&gt; x.Role == role || x.User == userName)) { return; } //  ,       var _forbiddenProperties = e.Entity.GetType().GetProperties() .Where(x =&gt; !x.GetCustomAttributes&lt;CanReadAttribute&gt;() .Any(y =&gt; y.Role == role || y.User == userName)); foreach (var property in _forbiddenProperties) { //       property.SetValue(e.Entity, null); } }</span></span></code> </pre><br>  Here we simply set the value of null to all properties that the user does not have access to.  Now, if you run the project, you can see that an unauthorized user does not even have the right to read object keys, User User or the Role role has rights to view all properties, but User2 and Role2 cannot see the list item names.  This is what we wanted.  But I want to note, despite the fact that the user does not have access to the data directly in some properties of objects, the complete data model schema is completely known on the client. <br><br>  Here, perhaps, and all that I wanted to talk about today.  Just note that the user will be very discouraged, not knowing which fields he can edit and which ones will not, and User2 will be shocked that the list items have empty names.  Therefore, next time we will consider working with metadata in the breeze and give our user visual clues about what rights he has in the application.  The finished project can be downloaded from the <a href="https://1drv.ms/u/s!AsrtdLXc2hes6hhtxL3j-3Z9LVY-">link</a> . <br><br>  PS While writing an article I decided to write a library that will implement this access control using the attributes / fluent interface.  If you have any ideas, tips and suggestions for functionality or implementation - you are welcome in the comments.  How something more decent will be ready - I will post it on GitHub, in NuGet, and write here a tutorial. </div><p>Source: <a href="https://habr.com/ru/post/249417/">https://habr.com/ru/post/249417/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../249407/index.html">Browser Vivaldi - the latest news and announcements</a></li>
<li><a href="../249409/index.html">Reverse engineering of Parktronic protocol. Dance of little bits</a></li>
<li><a href="../249411/index.html">The digest of interesting materials for the mobile developer # 88 (January 26 - February 1)</a></li>
<li><a href="../249413/index.html">Non-von Neumann computer based on combinatorial logic</a></li>
<li><a href="../249415/index.html">Overview of the most interesting materials on data analysis and machine learning ‚Ññ33 (January 26 - February 1, 2015)</a></li>
<li><a href="../249419/index.html">Methods for modifying machine code: "selection" vs. "Genetic Engineering"</a></li>
<li><a href="../249421/index.html">Robot on RaspberryPi, Arduino and RaspiCam + OpenCV. Part 1 Review</a></li>
<li><a href="../249423/index.html">Find typos in ** kwargs</a></li>
<li><a href="../249425/index.html">Pundle - bundler for python</a></li>
<li><a href="../249427/index.html">New invariant of a natural number. Theorem and proof</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>