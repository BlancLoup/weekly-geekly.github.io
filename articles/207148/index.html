<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>PostgreSQL New Year Check</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="The year ends, and I haven‚Äôt written notes about checking open projects for a long time. I have been repeatedly offered to check the PostgreSQL Databa...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>PostgreSQL New Year Check</h1><div class="post__text post__text-html js-mediator-article"><img align="left" src="https://habrastorage.org/getpro/habr/post_images/6b9/9e8/fa1/6b99e8fa145a43207e157decdd497359.png" alt="PVS-Studio, PostgreSQL"><br>  The year ends, and I haven‚Äôt written notes about checking open projects for a long time.  I have been repeatedly offered to check the PostgreSQL Database Management System project.  This is what I do.  Unfortunately, an ambitious and interesting article will not work.  I noticed only a few sample errors.  So this time it turned out quite a small article. <br><br><a name="habracut"></a><br><br>  PostgreSQL is a free object-relational database management system (DBMS).  PostgreSQL is based on SQL and supports many of the features of the SQL: 2003 standard (ISO / IEC 9075).  More information about the project can be read on the <a href="http://www.viva64.com/go.php%3Furl%3D1337">Wikipedia</a> website and on the <a href="http://www.viva64.com/go.php%3Furl%3D1336">project</a> website itself. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h2>  1. Typos when using the memcmp () function </h2><br><pre><code class="cpp hljs"><span class="hljs-function"><span class="hljs-function">Datum </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">pg_stat_get_activity</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(PG_FUNCTION_ARGS)</span></span></span><span class="hljs-function"> </span></span>{ .... <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-built_in"><span class="hljs-built_in">memcmp</span></span>(&amp;(beentry-&gt;st_clientaddr), &amp;zero_clientaddr, <span class="hljs-keyword"><span class="hljs-keyword">sizeof</span></span>(zero_clientaddr) == <span class="hljs-number"><span class="hljs-number">0</span></span>)) .... }</code> </pre> <br>  PVS-Studio <a href="http://www.viva64.com/ru/d/0115/">warning</a> : <a href="http://www.viva64.com/ru/d/0115/">V526</a> The 'memcmp' function returns 0 if the corresponding buffers are equal.  Consider examining the condition for mistakes.  postgres pgstatfuncs.c 712 <br><br>  Also on this line is a warning <a href="http://www.viva64.com/ru/d/0175/">V575</a> .  By the way, if two or more diagnostic messages are issued for the same program line, this is a reason to check it very, very carefully.  Very often, one mistake makes the code suspicious "from different points of view." <br><br>  If you look closely at the code, you can see that one closing bracket is not in its place.  As a result, the third actual function argument is the expression sizeof (zero_clientaddr) == 0. <br><br>  Identical errors can be seen in adjacent functions.  Apparently the error multiplied by copying the code. <br><br>  Other problem areas: <ul><li>  pgstatfuncs.c 976 </li><li>  pgstatfuncs.c 1023 </li></ul><br><h2>  2. Number in octal number system </h2><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">RestoreArchive</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Archive *AHX)</span></span></span><span class="hljs-function"> </span></span>{ .... AHX-&gt;minRemoteVersion = <span class="hljs-number"><span class="hljs-number">070100</span></span>; AHX-&gt;maxRemoteVersion = <span class="hljs-number"><span class="hljs-number">999999</span></span>; .... }</code> </pre> <br>  The warning issued by PVS-Studio: <a href="http://www.viva64.com/ru/d/0125/">V536</a> Be advised that the utilized form is.  Oct: 070100, Dec: 28736. pg_dump pg_backup_archiver.c 301 <br><br>  If you look at the code located nearby, then we can conclude that the programmer did not plan to use the number written in the octal number system at all.  For example, there is this line: <br><pre> <code class="cpp hljs">fout-&gt;minRemoteVersion = <span class="hljs-number"><span class="hljs-number">70000</span></span>;</code> </pre> <br>  Most likely, zero was added for beauty.  But because of this zero, the number ‚Äú070100‚Äù is written in the octal number system and is equal to 28736. <br><br><h2>  3. Classic.  Errors of work with type SOCKET </h2><br>  In the Windows operating system, the SOCKET type is the unsigned type.  About this, many do not know or forget.  As a result, the same mistake can be seen in different projects.  This error was not overtaken by the PostgreSQL project. <br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">typedef</span></span> UINT_PTR SOCKET; <span class="hljs-keyword"><span class="hljs-keyword">typedef</span></span> SOCKET pgsocket; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ident_inet</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(hbaPort *port)</span></span></span><span class="hljs-function"> </span></span>{ .... pgsocket sock_fd; .... sock_fd = socket(ident_serv-&gt;ai_family, ident_serv-&gt;ai_socktype, ident_serv-&gt;ai_protocol); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (sock_fd &lt; <span class="hljs-number"><span class="hljs-number">0</span></span>) { .... }</code> </pre> <br>  Warning given by PVS-Studio: <a href="http://www.viva64.com/ru/d/0137/">V547</a> Expression 'sock_fd &lt;0' is always false.  Unsigned type value is never &lt;0. postgres auth.c 1668 <br><br>  Check (sock_fd &lt;0) does not make sense.  An unsigned variable cannot be less than zero.  The code that handles the situation when it fails to open a socket will never get control. <br><br>  There are some more mistakes identical to this: <ul><li>  auth.c 1748 </li><li>  auth.c 2567 </li><li>  pqcomm.c 395 </li><li>  pqcomm.c 633 </li><li>  postmaster.c 2168 </li></ul><br><h2>  4. Error erasing private data </h2><br>  Found a lot of typical errors associated with mashing the memory containing private data.  This error is perhaps more common than problems with the SOCKET type. <br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">char</span></span></span><span class="hljs-function"> * </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">px_crypt_md5</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">char</span></span></span></span><span class="hljs-function"><span class="hljs-params"> *pw, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">char</span></span></span></span><span class="hljs-function"><span class="hljs-params"> *salt, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">char</span></span></span></span><span class="hljs-function"><span class="hljs-params"> *passwd, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">unsigned</span></span></span></span><span class="hljs-function"><span class="hljs-params"> dstlen)</span></span></span><span class="hljs-function"> </span></span>{ .... <span class="hljs-keyword"><span class="hljs-keyword">unsigned</span></span> <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> final[MD5_SIZE]; .... <span class="hljs-comment"><span class="hljs-comment">/* Don't leave anything around in vm they could use. */</span></span> <span class="hljs-built_in"><span class="hljs-built_in">memset</span></span>(final, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">sizeof</span></span> final); .... }</code> </pre> <br>  The warning issued by PVS-Studio: <a href="http://www.viva64.com/ru/d/0208/">V597</a> The compiler could delete the memset function call, which is used to flush the final buffer.  The RtlSecureZeroMemory () function should be used to erase the private data.  pgcrypto crypt-md5.c 157 <br><br>  The comment emphasizes that you need to wipe a certain area of ‚Äã‚Äãmemory.  However, this will not happen.  The compiler will throw a call to the memset () function.  Why this happens and how to deal with it can be found in the description of the diagnostic rule. <br><br>  There are a lot of places where the data will not be erased: <ul><li>  fortuna.c 294 </li><li>  fortuna.c 344 </li><li>  fortuna.c 381 </li><li>  internal.c 671 </li><li>  pgp-encrypt.c 131 </li><li>  pgp-encrypt.c 493 </li><li>  pgp-encrypt.c 555 </li><li>  pgp-decrypt.c 283 </li><li>  pgp-decrypt.c 398 </li><li>  pgp-decrypt.c 399 </li><li>  pgp-decrypt.c 496 </li><li>  pgp-decrypt.c 706 </li><li>  pgp-decrypt.c 795 </li><li>  pgp-pgsql.c 90 </li><li>  pgp-pgsql.c 132 </li><li>  px-crypt.c 161 </li><li>  pgp-pubkey.c 153 </li><li>  pgp-pubkey.c 294 </li><li>  pgp-pubkey.c 295 </li></ul><br><br>  <b>Every such place is a potential vulnerability!</b>  Data that has not been erased may unexpectedly be written to disk or sent over the network.  An article on this topic: <a href="http://www.viva64.com/ru/k/0041/">Overwrite memory - why?</a> <br><br><h2>  5. Undefined behavior </h2><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">char</span></span></span><span class="hljs-function"> * </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">inet_cidr_ntop_ipv6</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> u_char *src, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> bits, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">char</span></span></span></span><span class="hljs-function"><span class="hljs-params"> *dst, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">size_t</span></span></span></span><span class="hljs-function"><span class="hljs-params"> size)</span></span></span><span class="hljs-function"> </span></span>{ .... m = ~<span class="hljs-number"><span class="hljs-number">0</span></span> &lt;&lt; (<span class="hljs-number"><span class="hljs-number">8</span></span> - b); .... }</code> </pre> <br>  Alert issued by PVS-Studio: <a href="http://www.viva64.com/ru/d/0225/">V610</a> Undefined behavior.  Check the shift operator '&lt;&lt;.  The left operand '~ 0' is negative.  postgres inet_cidr_ntop.c 206 <br><br>  You can not move negative numbers.  This leads to undefined behavior.  More: " <a href="http://www.viva64.com/ru/b/0142/">Without knowing the ford, do not climb into the water - part three</a> ." <br><br>  Other dangerous shifts: <ul><li>  network.c 1435 </li><li>  signal.c 118 </li><li>  signal.c 125 </li><li>  varbit.c 1508 </li><li>  varbit.c 1588 </li></ul><br><h2>  6. Typo </h2><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">AddNewRelationTuple</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(....)</span></span></span><span class="hljs-function"> </span></span>{ .... new_rel_reltup-&gt;relfrozenxid = InvalidTransactionId; new_rel_reltup-&gt;relfrozenxid = InvalidMultiXactId; .... }</code> </pre> <br>  The warning issued by PVS-Studio: <a href="http://www.viva64.com/ru/d/0108/">V519</a> The 'new_rel_reltup-&gt; relfrozenxid' variable is assigned values ‚Äã‚Äãtwice successively.  Perhaps this is a mistake.  Check lines: 912, 913. postgres heap.c 913 <br><br>  One variable is assigned two different values.  It seems to be a typo.  Perhaps in the second line, the value should be assigned to the variable 'new_rel_reltup-&gt; relminmxid' <br><br><h2>  Conclusion </h2><br>  If any of the PostgreSQL project developers are interested in the PVS-Studio analyzer, we are ready to provide them with a registration key for the time being.  Please write them to us in support. <br><br>  And I wish you a happy New Year! </div><p>Source: <a href="https://habr.com/ru/post/207148/">https://habr.com/ru/post/207148/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../207136/index.html">Holiday geeky: with ARM and TFT LCD</a></li>
<li><a href="../207138/index.html">School bell on Raspberry Pi with remote control</a></li>
<li><a href="../207140/index.html">Capturing and shooting a demo video of an iOS application with improvised and not so much means - ways and solutions</a></li>
<li><a href="../207144/index.html">Silent Domain Authorization at GlassFish</a></li>
<li><a href="../207146/index.html">10,000,000 repositories</a></li>
<li><a href="../207152/index.html">Holiday greetings!</a></li>
<li><a href="../207154/index.html">MINIX X7 - Rockchip RK3188 high-quality media player</a></li>
<li><a href="../207156/index.html">How we integrate the SaaS solution with the customer‚Äôs accounting system</a></li>
<li><a href="../207160/index.html">Time Series Analysis with Python</a></li>
<li><a href="../207162/index.html">IPv6 addresses in Beeline mobile network: test in Voronezh</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>