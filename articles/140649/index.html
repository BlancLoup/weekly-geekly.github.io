<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Monitor file system changes</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="In search of a ready-made bike for solving the problem of monitoring changes in a file system with linux + freebsd support, I came across a nice pytho...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Monitor file system changes</h1><div class="post__text post__text-html js-mediator-article">  In search of a ready-made bike for solving the problem of monitoring changes in a file system with linux + freebsd support, I came across a nice python watchdog ( <a href="https://github.com/gorakhargosh/watchdog">github</a> , <a href="http://packages.python.org/watchdog/">packages.python.org</a> ).  Which besides interesting to me, the OS also supports MacOS (has its own specifics) and Windows. <br>  Those who are interested in this question and who will not be deterred by the author‚Äôs Indian origin, please <a name="habracut"></a>  . <br><br><h4>  Installation </h4><br>  You can take the finished version of the PIP: <br>  $ pip install watchdog <br>  <i>The PIP itself is installed as a python-pip package, devel / py-pip port, etc.</i> <br>  Or collect from source through setup.py. <br><br>  In sufficient detail, everything is written in the <a href="http://packages.python.org/watchdog/installation.html">original manual</a> .  True, there is a description of version 0.5.4, and now 0.6.0 is relevant.  However, the whole difference is in editing copyrights and replacing the indentation of 4 spaces with an indent of 2. ‚ÄúGoogle code style‚Äù :) 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      In general, there are quite a few features of the assembly on the versions of the python itself and on the target platform.  They are all described in the link above, but if necessary, I will add to the article in brief in Russian. <br><br>  <i>In addition, it is possible to assemble a module on an incompatible OS, but then a fallback implementation will appear, making ‚Äúsnapshots‚Äù of the file system structure with subsequent comparisons.</i>  <i>Perhaps, someone did this for solving a similar problem :)</i> <br><br>  I myself tried to build under ubuntu 11.4 and freebsd-8.2 RELEASE, there were no problems with the assembly and operation. <br><br><h4>  Basic example </h4><br>  Suppose that we are interested in changes in a certain path / path / to / smth, associated with the creation, deletion and renaming of files and directories. <br><br>  We connect: <br><pre><code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">from</span></span> watchdog.observers <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> Observer <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> watchdog.events <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> FileSystemEventHandler</code> </pre> <br>  The Observer class is selected in /observers/__init__.py based on the capabilities of your OS, so there is no need to decide for yourself what to choose. <br>  The FileSystemEventHandler class is the base class of the change event handler.  He knows little, but we will teach his descendant: <br><pre> <code class="python hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Handler</span></span></span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">(FileSystemEventHandler)</span></span></span><span class="hljs-class">:</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">on_created</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self, event)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">print</span></span> event <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">on_deleted</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self, event)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">print</span></span> event <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">on_moved</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self, event)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">print</span></span> event</code> </pre><br>  <i>The full list of methods can be seen in FileSystemEventHandler.dispatch itself: on_modified, on_moved, on_created, on_deleted.</i> <br><br>  Run this all: <br><pre> <code class="python hljs">observer = Observer() observer.schedule(Handler(), path=<span class="hljs-string"><span class="hljs-string">'/path/to/smth'</span></span>, recursive=<span class="hljs-keyword"><span class="hljs-keyword">True</span></span>) observer.start()</code> </pre><br><br>  Observer is a relatively distant descendant of threading.Thread, respectively, after the start () call, we get the background thread that keeps track of changes.  So if the script ends immediately, then we will not get anything sensible.  The implementation of the expectations depends primarily on the use of the module in a real project, now you can just make a crutch: <br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">try</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> <span class="hljs-keyword"><span class="hljs-keyword">True</span></span>: time.sleep(<span class="hljs-number"><span class="hljs-number">0.1</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">except</span></span> KeyboardInterrupt: observer.stop() observer.join()</code> </pre><br>  We are waiting for the events of the FS changes until the arrival of Ctrl + C (SIGINT), after which we tell our thread to finish and wait for it to perform. <br><br>  Run the script, go our way and: <br><pre> <code class="hljs vala"><span class="hljs-meta"><span class="hljs-meta"># mkdir foo # touch bar # mv bar baz # cd foo/ # mkdir foz # mv ../baz ./quz # cp ./quz ../hw # cd .. # rm -r ./foo # rm -f ./*</span></span></code> </pre><br><br>  At the exit of the script we have: <br><pre> <code class="python hljs">&lt;DirCreatedEvent: src_path=/path/to/smth/foo&gt; &lt;FileCreatedEvent: src_path=/path/to/smth/bar&gt; &lt;FileMovedEvent: src_path=/path/to/smth/bar, dest_path=/path/to/smth/baz&gt; &lt;DirCreatedEvent: src_path=/path/to/smth/foo/foz&gt; &lt;FileMovedEvent: src_path=/path/to/smth/baz, dest_path=/path/to/smth/foo/quz&gt; &lt;FileCreatedEvent: src_path=/path/to/smth/hw&gt; &lt;FileDeletedEvent: src_path=/path/to/smth/foo/quz&gt; &lt;DirDeletedEvent: src_path=/path/to/smth/foo/foz&gt; &lt;DirDeletedEvent: src_path=/path/to/smth/foo&gt; &lt;FileDeletedEvent: src_path=/path/to/smth/hw&gt;</code> </pre><br>  The <a href="http://packages.python.org/watchdog/api.html">descendants of FileSystemEvent</a> listed in watchdog / events.py come to methods of our class Handler in the event field. <br>  Everyone has the properties src_path, is_directory, event_type ("created", "deleted", etc.).  For the moved event, the dest_path property is added. <br><br><h4>  Well, if you don't want anything else ... Is there anything else? </h4><br>  <a href="http://packages.python.org/watchdog/api.html">Descendants of</a> FileSystemEventHandler remain with us for a snack: <br><ul><li>  <a href="http://packages.python.org/watchdog/api.html">PatternMatchingEventHandler</a> </li><li>  RegexMatchingEventHandler </li><li>  <a href="http://packages.python.org/watchdog/api.html">LoggingEventHandler</a> </li></ul><br><br>  PatternMatchingEventHandler can be used to receive events only for those FS nodes whose names match the mask with the rules: <br><ul><li>  * any characters </li><li>  ?  any single character </li><li>  [seq] any single character specified </li><li>  [! seq] any single character NOT NOT specified </li></ul><br>  The task of the rules is performed when creating: <br><pre> <code class="python hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Handler</span></span></span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">(PatternMatchingEventHandler)</span></span></span><span class="hljs-class">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">pass</span></span> event_handler = Handler( patterns = [<span class="hljs-string"><span class="hljs-string">'*.py*'</span></span>], ignore_patterns = [<span class="hljs-string"><span class="hljs-string">'cache/*'</span></span>], ignore_directories = <span class="hljs-keyword"><span class="hljs-keyword">True</span></span>, case_sensitive = <span class="hljs-keyword"><span class="hljs-keyword">False</span></span> ) observer = Observer() observer.schedule(event_handler, path=<span class="hljs-string"><span class="hljs-string">'/home/LOGS/'</span></span>, recursive=<span class="hljs-keyword"><span class="hljs-keyword">True</span></span>)</code> </pre><br><br>  RegexMatchingEventHandler does the same, but with explicit instructions of regexp expressions in the constructor: <br><pre> <code class="python hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Handler</span></span></span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">(RegexMatchingEventHandler)</span></span></span><span class="hljs-class">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">pass</span></span> event_handler = Handler( regexes = [<span class="hljs-string"><span class="hljs-string">'\.py.?'</span></span>], ignore_regexes = [<span class="hljs-string"><span class="hljs-string">'cache/.*'</span></span>], ignore_directories = <span class="hljs-keyword"><span class="hljs-keyword">True</span></span>, case_sensitive = <span class="hljs-keyword"><span class="hljs-keyword">False</span></span> )</code> </pre><br><br>  The PatternMatchingEventHandler inside itself eventually translates patterns into regulars, so it has to work more slowly due to the presence of such an overhead. <br><br>  Finally, LoggingEventHandler logs everything to log via logging.info (). <br><br>  - That's all.  Maybe someone will come in handy. <br><br>  PS <br>  When tracking a directory in which (and its children) contain non-ascii-named folders / files, an exceptions.UnicodeEncodeError exception occurs in watchdog depths.  In Linux (inotify) it occurs in <a href="https://github.com/gorakhargosh/watchdog/issues/104">watchdog.observers.inotify.Inotify._add_watch</a> . <br>  The reason is reading the content in ascii encoding. <br>  To correct the situation, you can patch the method: <br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">from</span></span> watchdog.observers.inotify <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> Inotify _save = Inotify._add_watch Inotify._add_watch = <span class="hljs-keyword"><span class="hljs-keyword">lambda</span></span> self, path, mask: _save(self, path.encode(<span class="hljs-string"><span class="hljs-string">'utf-8'</span></span>), mask)</code> </pre><br><br>  Here is an example of the original string, and its repr () before and after processing encode (): <br><pre> <code class="python hljs">/home/atercattus/.wine/drive_c/users/Public/  <span class="hljs-string"><span class="hljs-string">u'/home/atercattus/.wine/drive_c/users/Public/\u0420\u0430\u0431\u043e\u0447\u0438\u0439 \u0441\u0442\u043e\u043b'</span></span> <span class="hljs-string"><span class="hljs-string">'/home/atercattus/.wine/drive_c/users/Public/\xd0\xa0\xd0\xb0\xd0\xb1\xd0\xbe\xd1\x87\xd0\xb8\xd0\xb9 \xd1\x81\xd1\x82\xd0\xbe\xd0\xbb'</span></span></code> </pre></div><p>Source: <a href="https://habr.com/ru/post/140649/">https://habr.com/ru/post/140649/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../140641/index.html">Part number 5. Biochemistry on folding. One fundamental problem</a></li>
<li><a href="../140643/index.html">Installation of userscripts in Opera in general cases and for secure pages (https)</a></li>
<li><a href="../140644/index.html">Using mental maps for teaching with the example of Cisco CCNA Exploration</a></li>
<li><a href="../140645/index.html">Asterisk + FreePBX + 7937G</a></li>
<li><a href="../140647/index.html">XBMC 11 released</a></li>
<li><a href="../140651/index.html">Old news as the main traffic generator</a></li>
<li><a href="../140655/index.html">Android application architecture. Part II - architectural styles and patterns</a></li>
<li><a href="../140656/index.html">Why am I back at Microsoft?</a></li>
<li><a href="../140657/index.html">Ultra-fast camera allows you to look around the corner</a></li>
<li><a href="../140658/index.html">Integration of DBUnit and Spring TestContext Framework</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>