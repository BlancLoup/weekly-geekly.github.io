<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>LJ in DB (Groovy script)</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="In continuation of the theme of small scripts on groovy - one more. 
 Previous: Gmail Big Letters , Addition Exercise (LATEX) 

 The new script shows ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>LJ in DB (Groovy script)</h1><div class="post__text post__text-html js-mediator-article">  In continuation of the theme of small scripts on groovy - one more. <br>  Previous: Gmail <a href="http://habrahabr.ru/blogs/google/110738/">Big Letters</a> , Addition <a href="http://habrahabr.ru/blogs/development/108431/">Exercise</a> (LATEX) <br><br>  The new script shows the basics of working with XML and database in Groovy.  As a task, we will choose to save our cozy ZhZhki from XML to the database. <br>  Why do this?  - SQL will tell us everything about our (or someone else's) LJ - topics, comments, tags - how much fantasy enough to collect statistics <br><br>  First we need to download LiveJournal in XML. <br>  This will make someone else's utility - <a href="http://hewgill.com/ljdump/">ljdump</a> <br>  You will have to install Python, open IDLE (Python GUI), load the utility there and run.  She will ask everything herself. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      After its run, you will have a directory with files LXXX - posts and CXXX - comments. <br><br>  And on these XML and we will run my script. <br>  In this form, it uses pure Java, embedded Hypersonic database (HSQLDB), but you can connect to any, of course.  Just make sure the JDBC driver is in your classpath. <br><br>  Parsing and working with this type of database is only suitable for scripts and small programs.  In the enterprise, no one will load all the XML into memory (and will use SAX), and no one will send SQL directly (and there will be a Connection Pool, prepared statement, batch, some Hibernate). <br><br><a name="habracut"></a>  The fact that we parsim looks like this: <br><br><pre><code class="xml hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?xml version="1.0"?&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">event</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">itemid</span></span></span><span class="hljs-tag">&gt;</span></span>1<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">itemid</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">eventtime</span></span></span><span class="hljs-tag">&gt;</span></span>2006-04-09 16:52:00<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">eventtime</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">url</span></span></span><span class="hljs-tag">&gt;</span></span>http://my-ljnick.livejournal.com/460.html<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">url</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">event_timestamp</span></span></span><span class="hljs-tag">&gt;</span></span>1144601520<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">event_timestamp</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">reply_count</span></span></span><span class="hljs-tag">&gt;</span></span>3<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">reply_count</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">props</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">commentalter</span></span></span><span class="hljs-tag">&gt;</span></span>1148051408<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">commentalter</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">props</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">subject</span></span></span><span class="hljs-tag">&gt;</span></span>  <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">subject</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">event</span></span></span><span class="hljs-tag">&gt;</span></span>      <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">event</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">anum</span></span></span><span class="hljs-tag">&gt;</span></span>204<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">anum</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">event</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre> <br><br>  Here is the script: <br><br><pre> <code class="hljs pgsql"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> groovy.<span class="hljs-keyword"><span class="hljs-keyword">sql</span></span>.<span class="hljs-keyword"><span class="hljs-keyword">Sql</span></span> <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> java.<span class="hljs-keyword"><span class="hljs-keyword">sql</span></span>.Timestamp def <span class="hljs-keyword"><span class="hljs-keyword">sql</span></span> = <span class="hljs-keyword"><span class="hljs-keyword">Sql</span></span>.newInstance("jdbc:hsqldb:file:lj", "sa", "", "org.hsqldb.jdbcDriver") // <span class="hljs-keyword"><span class="hljs-keyword">delete</span></span> <span class="hljs-keyword"><span class="hljs-keyword">table</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> previously created try { <span class="hljs-keyword"><span class="hljs-keyword">sql</span></span>.<span class="hljs-keyword"><span class="hljs-keyword">execute</span></span>("drop table POST")} catch (<span class="hljs-keyword"><span class="hljs-keyword">Exception</span></span> e) {} try { <span class="hljs-keyword"><span class="hljs-keyword">sql</span></span>.<span class="hljs-keyword"><span class="hljs-keyword">execute</span></span>("drop table COMMENT")} catch (<span class="hljs-keyword"><span class="hljs-keyword">Exception</span></span> e) {} // <span class="hljs-keyword"><span class="hljs-keyword">create</span></span> <span class="hljs-keyword"><span class="hljs-keyword">table</span></span> <span class="hljs-keyword"><span class="hljs-keyword">sql</span></span>.<span class="hljs-keyword"><span class="hljs-keyword">execute</span></span>(<span class="hljs-string"><span class="hljs-string">'''create table POST ( id integer not null primary key, url varchar(100), subject varchar(100), text varchar(10000), postdate timestamp )'''</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">sql</span></span>.<span class="hljs-keyword"><span class="hljs-keyword">execute</span></span>(<span class="hljs-string"><span class="hljs-string">'''create table COMMENT ( id integer not null primary key, postid integer, user varchar(100), subject varchar(100), text varchar(10000), commentdate timestamp, parentcomment integer )'''</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">sql</span></span>.<span class="hljs-keyword"><span class="hljs-keyword">execute</span></span>(<span class="hljs-string"><span class="hljs-string">''' alter table COMMENT add constraint c_postid foreign key (postid) references POST (id) '''</span></span>) def dir = "D:\\development\\ljdump-1.5.1\\my_lj\\" List&lt;File&gt; files = <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> File(dir).listFiles().findAll { it.name.startsWith("L") } files.<span class="hljs-keyword"><span class="hljs-keyword">each</span></span> { <span class="hljs-type"><span class="hljs-type">record</span></span> -&gt; def event = <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> XmlSlurper().parse(<span class="hljs-type"><span class="hljs-type">record</span></span>) <span class="hljs-type"><span class="hljs-type">int</span></span> id = <span class="hljs-type"><span class="hljs-type">Integer</span></span>.parseInt(event.itemid.text()) <span class="hljs-type"><span class="hljs-type">Date</span></span> d = <span class="hljs-type"><span class="hljs-type">Date</span></span>.parse("yyy-MM-dd HH:mm:ss", event.eventtime.text()) //<span class="hljs-keyword"><span class="hljs-keyword">No</span></span> <span class="hljs-type"><span class="hljs-type">time</span></span> <span class="hljs-type"><span class="hljs-type">zone</span></span> java.<span class="hljs-keyword"><span class="hljs-keyword">sql</span></span>.Timestamp sqlDate = <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> java.<span class="hljs-keyword"><span class="hljs-keyword">sql</span></span>.Timestamp(d.time) String url = event.url.text() String subject = event.subject.text() String <span class="hljs-type"><span class="hljs-type">text</span></span> = event.event.text() <span class="hljs-keyword"><span class="hljs-keyword">sql</span></span>.<span class="hljs-keyword"><span class="hljs-keyword">execute</span></span>("insert into post (id,url,subject, text, postdate) values ($id, $url, $subject,$text,$sqlDate )") File commentsFile = <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> File(dir + <span class="hljs-type"><span class="hljs-type">record</span></span>.name.replace(<span class="hljs-string"><span class="hljs-string">'L'</span></span>, <span class="hljs-string"><span class="hljs-string">'C'</span></span>)); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (commentsFile.<span class="hljs-keyword"><span class="hljs-keyword">exists</span></span>()) { def comments = <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> XmlSlurper().parse(commentsFile).<span class="hljs-keyword"><span class="hljs-keyword">comment</span></span> comments.<span class="hljs-keyword"><span class="hljs-keyword">each</span></span>() { <span class="hljs-keyword"><span class="hljs-keyword">comment</span></span> -&gt; String state = <span class="hljs-keyword"><span class="hljs-keyword">comment</span></span>.state.text() <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!"D".equals(state)) { // <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> deleted <span class="hljs-type"><span class="hljs-type">int</span></span> commentid = <span class="hljs-type"><span class="hljs-type">Integer</span></span>.parseInt(<span class="hljs-keyword"><span class="hljs-keyword">comment</span></span>.id.text()) String <span class="hljs-keyword"><span class="hljs-keyword">user</span></span> = <span class="hljs-keyword"><span class="hljs-keyword">comment</span></span>.<span class="hljs-keyword"><span class="hljs-keyword">user</span></span>.text() String parentIdStr = <span class="hljs-keyword"><span class="hljs-keyword">comment</span></span>.parentid.text() <span class="hljs-type"><span class="hljs-type">int</span></span> parentid = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!parentIdStr.isEmpty()) <span class="hljs-type"><span class="hljs-type">Integer</span></span>.parseInt(parentIdStr) <span class="hljs-type"><span class="hljs-type">Date</span></span> commentDate = <span class="hljs-type"><span class="hljs-type">Date</span></span>.parse("yyy-MM-dd HH:mm:ss", <span class="hljs-keyword"><span class="hljs-keyword">comment</span></span>.date.text().replace(<span class="hljs-string"><span class="hljs-string">'T'</span></span>,<span class="hljs-string"><span class="hljs-string">' '</span></span>)) <span class="hljs-type"><span class="hljs-type">Timestamp</span></span> sqlCommentTime = <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> <span class="hljs-type"><span class="hljs-type">Timestamp</span></span>(commentDate.time) String commentsubject = <span class="hljs-keyword"><span class="hljs-keyword">comment</span></span>.subject.text(); String body = <span class="hljs-keyword"><span class="hljs-keyword">comment</span></span>.body.text() <span class="hljs-keyword"><span class="hljs-keyword">sql</span></span>.<span class="hljs-keyword"><span class="hljs-keyword">execute</span></span>("insert into comment (id,user,subject,text,commentdate,parentcomment, postid) values ($commentid,$user, $commentsubject, $body, $sqlCommentTime, $parentid, $id)") } } } } <span class="hljs-keyword"><span class="hljs-keyword">sql</span></span>.<span class="hljs-keyword"><span class="hljs-keyword">close</span></span>();</code> </pre><br><br>  Of course, it can be improved: <br>  1. Save the author of the post (It is important if you parse the community) <br>  2. Make it get the file directory and database URL as an argument <br><br>  You can improve the scheme: <br>  1. Save tags <br>  2. Keep authors in a separate table <br>  3. Add indexes <br><br>  You can add the <a href="http://habrahabr.ru/users/grab/" class="user_link">Grab</a> directive so that you do not need to add drivers to the classpath (I was trying to, I did not succeed :() <br><br>  Now let's see how this database can be used. <br>  Make a list of my posts with more than 50 comments: <br><pre> <code class="hljs pgsql">@Grab(<span class="hljs-string"><span class="hljs-string">'hsqldb:hsqldb:1.8.0.7'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> groovy.<span class="hljs-keyword"><span class="hljs-keyword">sql</span></span>.<span class="hljs-keyword"><span class="hljs-keyword">Sql</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Sql</span></span> <span class="hljs-keyword"><span class="hljs-keyword">sql</span></span> = <span class="hljs-keyword"><span class="hljs-keyword">Sql</span></span>.newInstance("jdbc:hsqldb:file:lj", "sa", "", "org.hsqldb.jdbcDriver") <span class="hljs-keyword"><span class="hljs-keyword">sql</span></span>.eachRow("select subject, url, (select count (*) from comment where postid = mypost.id) as numcom from POST as mypost order by numcom desc") { <span class="hljs-keyword"><span class="hljs-keyword">row</span></span> -&gt; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">row</span></span>.numcom&gt;<span class="hljs-number"><span class="hljs-number">50</span></span>) println <span class="hljs-keyword"><span class="hljs-keyword">row</span></span>}</code> </pre><br><br>  That's all. <br>  I hope someone will be useful. <br></div><p>Source: <a href="https://habr.com/ru/post/113941/">https://habr.com/ru/post/113941/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../113933/index.html">qFlow: SED vs Online document management</a></li>
<li><a href="../113934/index.html">Hard disk and risk factor</a></li>
<li><a href="../113937/index.html">SudoGlove Glove: Fingertip Control</a></li>
<li><a href="../113939/index.html">Developer Preview 1 ExtJs 4 released</a></li>
<li><a href="../113940/index.html">Cyber ‚Äã‚ÄãElegans Project</a></li>
<li><a href="../113942/index.html">Microsoft‚Äôs response to Mozilla‚Äôs IE9 opinion</a></li>
<li><a href="../113944/index.html">Blog is a convenient platform for finding interesting bloggers.</a></li>
<li><a href="../113945/index.html">Caching in the Spring Framework 3.1</a></li>
<li><a href="../113948/index.html">XCP repository moved to github</a></li>
<li><a href="../113949/index.html">Sony's first warning</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>