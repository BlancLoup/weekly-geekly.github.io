<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Urho3D: Post Effects</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="We continue to understand the graphics subsystem Urho3D. This time, let's talk about the effects of post-processing. The set of the engine includes ma...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Urho3D: Post Effects</h1><div class="post__text post__text-html js-mediator-article">  We continue to understand the graphics subsystem Urho3D.  This time, let's talk about the effects of post-processing.  The set of the engine includes many ready-made effects, and one of them (Bloom), we even used in the <a href="https://habrahabr.ru/post/281903/">last article</a> .  But no engine can satisfy all the needs of any developer, so it will be useful to learn how to create your own effects.  As an example, I decided to choose the effect of showing a character through the walls, which is often used in strategies and RPGs. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/5b8/576/a90/5b8576a904a06b19829a67f51921a1bf.png" alt="image"></div><br><a name="habracut"></a><br><h2>  Idea </h2><br>  In simple words, the post-effect is a rectangular polygon covering the entire screen.  And our task is to paint this polygon. <br><br><div class="spoiler">  <b class="spoiler_title">Note.</b> <div class="spoiler_text">  At once I will make a reservation that I did not set myself the goal to realize the effect by the most optimal method.  First of all, I wanted to show how to do this using postprocessing in the simplest and most understandable way possible.  But if you know a more elegant approach to implement this effect, be sure to share it in the comments :) <br></div></div><br>  So, we need: 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <ol><li>  Render the scene. </li><li>  Get the mask of the invisible part of the character. </li><li>  Paint the mask in any color and apply it to the render scene. </li></ol><br>  To get the mask of the invisible part you can: <br><br><ol><li>  Re-render the character with the depth test turned on, using a simple shader that outputs a white pixel (we obtain in this way a black and white texture of the visible part of the character). </li><li>  Re-render the character using the same shader, but already ignoring the depth buffer (we thus obtain the black and white mask of the entire character). </li><li>  If in some place the <u>full mask is</u> white, and the <u>mask of the visible part is</u> black, then this is the desired invisible part of the character. </li></ol><br>  Total we need to get and combine three textures: <br><br><img src="https://habrastorage.org/files/803/f87/380/803f87380b7c47c4bef5a222a1ffd906.gif"><br><br><h2>  Implementation </h2><br>  The finished demo <a href="https://github.com/1vanK/Urho3DHabrahabr06">is here</a> (OpenGL).  To start, use START_DEMO.bat.  The standard resources of the engine are located in the Data and CoreData folders, and all new / modified files are placed in MyData.  Well, traditionally <a href="">used version of the engine</a> .  And now in more detail :) <br><br><h2>  RenderPass Download </h2><br>  <a href="https://habrahabr.ru/post/281903/">Previously,</a> we considered renderpas as a way to specify the order of passes in materials (section ‚ÄúRendering Process‚Äù).  But renderpasses also perform <a href="https://urho3d.github.io/documentation/HEAD/_render_paths.html">other functions</a> . <br><br>  Standard renderpasses are in the <a href="https://github.com/1vanK/Urho3DHabrahabr06/tree/master/CoreData/RenderPaths">CoreData / RenderPaths folder</a> .  The default is <a href="">Forward.xml</a> .  Renderpas can be changed in different ways: <br><br><ul><li>  Call the Renderer :: SetDefaultRenderPath () function <b>before</b> creating the viewport.  In this case, subsequent created viewports will use the specified renderpas.  This method is <a href="">used</a> in the demo. </li><li>  Specify the renderer in the engine parameters (using <a href="https://urho3d.github.io/documentation/HEAD/_running.html">command line parameters</a> when launching the application or through engineParameters_ in the program text).  At the same time, the same Renderer :: SetDefaultRenderPath () function is called. </li><li>  Use the Viewport :: SetRenderPath () function <b>after</b> creating a viewport. </li><li>  In the editor, the renderer can be specified in the View&gt; Editor Settings window. </li></ul><br>  Renderpasses can be not only downloaded from files, but also dynamically changed during the operation of the application.  For example, when you apply any post-effect from the Data / PostProcess folder, nothing else happens, as <b>adding</b> commands to the current renderpas.  In other words, you can simply copy the contents of some file (or files) from <a href="https://github.com/urho3d/Urho3D/tree/master/bin/Data/PostProcess">Data / PostProcess</a> to the end of some file from <a href="https://github.com/1vanK/Urho3DHabrahabr06/tree/master/CoreData/RenderPaths">CoreData / RenderPaths</a> . <br><br>  <a href="">https://github.com/1vanK/Urho3DHabrahabr06/blob/master/MyData/Scripts/Main.as</a> <br><pre><code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Start</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ ... renderer.SetDefaultRenderPath(cache.GetResource(<span class="hljs-string"><span class="hljs-string">"XMLFile"</span></span>, <span class="hljs-string"><span class="hljs-string">"RenderPaths/MyForward.xml"</span></span>)); Viewport@ viewport = Viewport(scene_, cameraNode.GetComponent(<span class="hljs-string"><span class="hljs-string">"Camera"</span></span>)); viewport.renderPath.Append(cache.GetResource(<span class="hljs-string"><span class="hljs-string">"XMLFile"</span></span>, <span class="hljs-string"><span class="hljs-string">"PostProcess/FXAA3.xml"</span></span>)); renderer.viewports[<span class="hljs-number"><span class="hljs-number">0</span></span>] = viewport; }</code> </pre> <br>  Here, the download of the render interface <a href="">MyForward.xml</a> (which is based on <a href="">Forward.xml</a> ) takes place, and then the full-screen anti-aliasing effect <a href="">FXAA3.xml is</a> added to it. <br><br><h2>  Renderdergety </h2><br>  Renderpasos consist of rendertargets and commands. <br><br>  Renderertets are, roughly speaking, textures that can be passed to commands as input, or vice versa, commands can output the result of their work to them. <br><br>  <a href="">https://github.com/1vanK/Urho3DHabrahabr06/blob/master/MyData/RenderPaths/MyForward.xml</a> <br><pre> <code class="xml hljs"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">renderpath</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">rendertarget</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"visiblemask"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">tag</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"WallHack"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">sizedivisor</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"1 1"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">format</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"a"</span></span></span><span class="hljs-tag"> /&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">rendertarget</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"fullmask"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">tag</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"WallHack"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">sizedivisor</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"1 1"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">format</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"a"</span></span></span><span class="hljs-tag"> /&gt;</span></span> ... <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">renderpath</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre><br>  Here two renderargues are declared for masks (visiblemask is the mask of the visible part of the character and fullmask is the mask of the whole character). <br><br>  The <b>name</b> parameter defines the name of the renderarget by which it can be accessed. <br><br>  The <b>tag</b> parameter allows you to define renderargets and commands in some group that can be dynamically turned on and off in the game using the RenderPath :: SetEnabled () and RenderPath :: ToggleEnabled () functions.  Please note that all <a href="https://github.com/urho3d/Urho3D/tree/master/bin/Data/PostProcess">standard post effects</a> have their own tag.  Thus, you can, for example, turn on the screen blur only when you open the menu.  Well, in our demo by pressing the spacebar, the scanning effect is switched. <br><br>  <a href="">https://github.com/1vanK/Urho3DHabrahabr06/blob/master/MyData/Scripts/Main.as</a> <br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">HandleUpdate</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(StringHash eventType, VariantMap&amp; eventData)</span></span></span><span class="hljs-function"> </span></span>{ ... <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (input.keyPress[KEY_SPACE]) renderer.viewports[<span class="hljs-number"><span class="hljs-number">0</span></span>].renderPath.ToggleEnabled(<span class="hljs-string"><span class="hljs-string">"WallHack"</span></span>); ... }</code> </pre><br>  The parameter <b>size</b> allows <b>you</b> to create renderarget with a size different from the size of the viewport.  In our demo, the size of the masks is identical to the size of the window (since the viewport occupies the entire game window).  But here, for example, in the post-effect <a href="">Bloom.xml, the</a> size of the renderarget is 4 times smaller than the size of the viewport for performance purposes (high resolution is not required for the superimposed glow). <br><br>  The <b>format</b> parameter defines, in fact, the format of the renderarget.  The most commonly used formats are ‚Äúrgb‚Äù and ‚Äúrgba‚Äù, but in our case one channel is enough to store masks, so the single-channel format ‚Äúa‚Äù is used.  There is a nuance.  In OpenGL 2, the ‚Äúa‚Äù format corresponds to GL_ALPHA (which means you need to work with the alpha channel), and in OpenGL 3 - GL_R8 (you need to work with the red channel).  We will come back to this when considering shaders. <br><br>  Please note that renderargets do not have to be declared at the beginning of the file.  They can be anywhere, even at the end of the file.  It is guaranteed that all renderargets will be created before executing commands. <br><br>  And immediately about the first team, which we need - <b>clear</b> . <br><br>  <a href="">https://github.com/1vanK/Urho3DHabrahabr06/blob/master/MyData/RenderPaths/MyForward.xml</a> <br><pre> <code class="xml hljs"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">renderpath</span></span></span><span class="hljs-tag">&gt;</span></span> ... <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">command</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">type</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"clear"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">tag</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"WallHack"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">color</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"0 0 0 0"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">output</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"visiblemask"</span></span></span><span class="hljs-tag"> /&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">command</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">type</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"clear"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">tag</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"WallHack"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">color</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"0 0 0 0"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">output</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"fullmask"</span></span></span><span class="hljs-tag"> /&gt;</span></span> ... <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">renderpath</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre><br>  Everything is simple here - renderargety is painted in black.  Since on each frame the white mask of the character is drawn in a new position, then, if you forget to clear it, you will get a white loop. <br><br>  If the <b>output</b> parameter is absent, the viewport is cleared.  Sometimes you may want to intentionally omit the cleaning, for example if you need a <a href="http://urho3d.prophpbb.com/topic756.html">transparent viewport background</a> . <br><br><h2>  Scenepass command </h2><br>  These are the same render passes that were mentioned in the <a href="https://habrahabr.ru/post/281903/">last article</a> . <br><br>  <a href="">https://github.com/1vanK/Urho3DHabrahabr06/blob/master/MyData/RenderPaths/MyForward.xml</a> <br><pre> <code class="xml hljs"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">renderpath</span></span></span><span class="hljs-tag">&gt;</span></span> ... <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">command</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">type</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"scenepass"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">tag</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"WallHack"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">pass</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"visiblemask"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">output</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"visiblemask"</span></span></span><span class="hljs-tag"> /&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">command</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">type</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"scenepass"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">tag</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"WallHack"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">pass</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"fullmask"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">output</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"fullmask"</span></span></span><span class="hljs-tag"> /&gt;</span></span> ... <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">renderpath</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre><br>  Two passes are added here.  In order for the passages to be completed, they must also be available in the technique that our character's <a href="">material</a> uses: <br><br>  <a href="">https://github.com/1vanK/Urho3DHabrahabr06/blob/master/MyData/Techniques/DiffNormalWallHack.xml</a> <br><pre> <code class="xml hljs"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">technique</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">...</span></span></span><span class="hljs-tag">&gt;</span></span> ... <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">pass</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"visiblemask"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">vs</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"Mask"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">ps</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"Mask"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">depthwrite</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"false"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">depthtest</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"equal"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">psexcludes</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"PACKEDNORMAL"</span></span></span><span class="hljs-tag"> /&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">pass</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"fullmask"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">vs</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"Mask"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">ps</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"Mask"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">depthwrite</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"false"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">depthtest</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"always"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">psexcludes</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"PACKEDNORMAL"</span></span></span><span class="hljs-tag"> /&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">technique</span></span></span></span></code> </pre><br>  Let me remind you that the declaration of passes in the renderpas determines the <b>order of</b> these passes, and the passes in the technique determine the specific <b>shaders</b> to be used.  In this case, this is the minimum possible <a href="">Mask</a> shader that outputs a white pixel. <br><br>  By the time passes, the visiblemask and fullmask depth buffer is already filled.  We do not need to write anything there, but only to use it.  Therefore, in both passes, the <b>depthwrite</b> parameter <b>is</b> set to <i>false</i> .  However, the <b>depthtest</b> parameter <b>is</b> different.  If <i>depthtest = ‚Äúalways‚Äù, the</i> depth buffer is ignored, and the full character mask is drawn.  If <i>depthtest = ‚Äúequal‚Äù</i> , the depth test will be passed only when the value in the Z-buffer matches the depth of the output geometry, that is, when the same geometry is rendered again. <br><br><h2>  Quad team </h2><br>  It is this command that displays a rectangular polygon covering the screen, designed to implement post-effects (the so-called screen quad). <br><br>  <a href="">https://github.com/1vanK/Urho3DHabrahabr06/blob/master/MyData/RenderPaths/MyForward.xml</a> <br><pre> <code class="xml hljs"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">renderpath</span></span></span><span class="hljs-tag">&gt;</span></span> ... <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">command</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">type</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"quad"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">tag</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"WallHack"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">vs</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"WallHack"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">ps</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"WallHack"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">output</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"viewport"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">texture</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">unit</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"diffuse"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"viewport"</span></span></span><span class="hljs-tag"> /&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">texture</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">unit</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"normal"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"fullmask"</span></span></span><span class="hljs-tag"> /&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">texture</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">unit</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"specular"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"visiblemask"</span></span></span><span class="hljs-tag"> /&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">command</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">renderpath</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre><br>  Here, to draw a quad, the WallHack shader is used, and 3 textures are transferred to the input of this shader (viewport - rendered scene, fullmask - full character mask and visiblemask - mask of the visible part of the character).  Do not be confused with the names of texture units (diffuse, normal and specular).  You are free to transmit anything through them and use them as you like in your shaders. <br><br>  The <a href="">WallHack</a> shader <a href="">is</a> very simple. <br><br>  1) We get the color of the rendered scene texel (I remind you that we rendered the render scene through the texture unit diffuse) in the <a href="">renderpas</a> : <br><br>  <a href="">https://github.com/1vanK/Urho3DHabrahabr06/blob/master/MyData/Shaders/GLSL/WallHack.glsl</a> <br><pre> <code class="hljs cs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">PS</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { vec3 viewport = texture2D(sDiffMap, vTexCoord).rgb; ... }</code> </pre><br>  2) We get both masks: <br><br>  <a href="">https://github.com/1vanK/Urho3DHabrahabr06/blob/master/MyData/Shaders/GLSL/WallHack.glsl</a> <br><pre> <code class="hljs vala"><span class="hljs-keyword"><span class="hljs-keyword">void</span></span> PS() { ... #ifdef GL3 <span class="hljs-keyword"><span class="hljs-keyword">float</span></span> fullmask = texture2D(sNormalMap, vTexCoord).r; <span class="hljs-keyword"><span class="hljs-keyword">float</span></span> visiblemask = texture2D(sSpecMap, vTexCoord).r; #<span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">float</span></span> fullmask = texture2D(sNormalMap, vTexCoord).a; <span class="hljs-keyword"><span class="hljs-keyword">float</span></span> visiblemask = texture2D(sSpecMap, vTexCoord).a; #endif ... }</code> </pre><br>  Returning to the nuance mentioned above, we see that, depending on the version of OpenGL, we use different channels when working with a single-channel texture. <br><br><div class="spoiler">  <b class="spoiler_title">Source / Urho3D / Graphics / OpenGL / OGLGraphics.cpp</b> <div class="spoiler_text"><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">unsigned</span></span> Graphics::GetAlphaFormat() { <span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">ifndef</span></span></span><span class="hljs-meta"> GL_ES_VERSION_2_0 </span><span class="hljs-comment"><span class="hljs-meta"><span class="hljs-comment">// Alpha format is deprecated on OpenGL 3+ if (gl3Support) return GL_R8; #endif return GL_ALPHA; }</span></span></span></span></code> </pre></div></div><br>  If your hardware supports OpenGL 3, then this version is used by default.  For testing purposes, you can force the engine to use OpenGL 2 using the command line parameter "-gl2". <br><br>  3) And finally, all three textures are combined: <br><br>  <a href="">https://github.com/1vanK/Urho3DHabrahabr06/blob/master/MyData/Shaders/GLSL/WallHack.glsl</a> <br><pre> <code class="hljs cs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">PS</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { ... <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (fullmask == <span class="hljs-number"><span class="hljs-number">0.0</span></span> || visiblemask &gt; <span class="hljs-number"><span class="hljs-number">0.0</span></span>) gl_FragColor = vec4(viewport, <span class="hljs-number"><span class="hljs-number">1.0</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> gl_FragColor = vec4(<span class="hljs-number"><span class="hljs-number">1.0</span></span>, <span class="hljs-number"><span class="hljs-number">0.0</span></span>, <span class="hljs-number"><span class="hljs-number">0.0</span></span>, <span class="hljs-number"><span class="hljs-number">1.0</span></span>); }</code> </pre><br>  If in this place the <b>full mask is</b> black (that is, the fragment does not belong to the character), then we display the texel from the rendered scene.  Otherwise, if the <b>visible mask is</b> not black (that is, the fragment belongs to the visible part of the character), then we also output the rendered scene (the visible part of the character in all its glory, with normal maps and so on).  Otherwise, the third and last option remains - the fragment belongs to the invisible part of the character.  Here it is, and draw in red. <br><br><h2>  Output intermediate textures </h2><br>  Sometimes for debugging purposes, you may want to display intermediate renderargets on the screen.  For this it is convenient to use the standard shader <a href="">CopyFramebuffer</a> .  Just add to the end of the renderpas: <br><br><pre> <code class="xml hljs"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">renderpath</span></span></span><span class="hljs-tag">&gt;</span></span> ... <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">command</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">type</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"quad"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">vs</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"CopyFramebuffer"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">ps</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"CopyFramebuffer"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">output</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"viewport"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">texture</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">unit</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"diffuse"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"  "</span></span></span><span class="hljs-tag"> /&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">command</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">renderpath</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre><br>  This shader expects you to transfer the desired texture in the ‚Äúrgb (a)‚Äù format via the texture unit diffuse.  It is not suitable for outputting our single-channel mask.  Therefore, I slightly modified this shader so that it <a href="">expects</a> a ‚Äúa‚Äù format texture at the input (see the <a href="">ShowATexture.glsl</a> shader).  It was with his help that screenshots for the article were made. <br><br><pre> <code class="xml hljs"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">renderpath</span></span></span><span class="hljs-tag">&gt;</span></span> ... <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">command</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">type</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"quad"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">vs</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"ShowATexture"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">ps</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"ShowATexture"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">output</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"viewport"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">texture</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">unit</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"diffuse"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"fullmask"</span></span></span><span class="hljs-tag"> /&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">command</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">renderpath</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre><br><h2>  More examples </h2><br>  <a href="https://github.com/1vanK/Urho3DMotionBlur">Blur when turning the camera (Motion Blur):</a> <br><br><img src="https://habrastorage.org/getpro/habr/post_images/a82/6c6/42c/a826c642cbf97b283b9f357f29ebdc68.gif" alt="image"><br><br>  <a href="https://github.com/1vanK/Urho3DOutlineSelectionExample">Stroke in both Left 4 Dead and Dota 2</a> : <br><br><img src="https://habrastorage.org/getpro/habr/post_images/9c3/0c6/a78/9c30c6a78ad7ba568c7f371ee9b6ce14.jpg" alt="image"><br><br>  <a href="https://github.com/1vanK/Urho3DModelsDissolving">Dissolving objects as in Doom 3</a> : <br><br><iframe width="560" height="315" src="https://www.youtube.com/embed/SmR_Xa-_Cgs" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br>  <a href="https://github.com/1vanK/Urho3DSoftParticles">Soft Particles</a> , <a href="https://github.com/1vanK/Urho3DDeepWater">an improved water shader</a> , <a href="http://urho3d.prophpbb.com/topic669.html">SSAO</a> , and more, see the <a href="http://urho3d.prophpbb.com/">official forum</a> . </div><p>Source: <a href="https://habr.com/ru/post/301092/">https://habr.com/ru/post/301092/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../301078/index.html">City hackathon 2GIS in Moscow</a></li>
<li><a href="../301080/index.html">Microsoft has released the second service pack for Windows 7</a></li>
<li><a href="../301082/index.html">Development of the Kinetic Novels: costs, income, statistics, tips, post factum conclusions</a></li>
<li><a href="../301084/index.html">The evolution of neural networks for image recognition in Google: GoogLeNet</a></li>
<li><a href="../301086/index.html">Google turns its data centers into works of art.</a></li>
<li><a href="../301094/index.html">Deterministic number factorization method based on mod 6 and mod 4</a></li>
<li><a href="../301096/index.html">Recognize faces in the photo using Python and OpenCV</a></li>
<li><a href="../301098/index.html">ACM ICPC Live Webcast: How it works</a></li>
<li><a href="../301100/index.html">How successful people cope with procrastination</a></li>
<li><a href="../301102/index.html">Methods for determining whether a point belongs to a polygon</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>