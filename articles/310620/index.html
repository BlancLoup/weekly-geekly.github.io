<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Comparison of analytical in-memory databases</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="In the last two months of summer, Tinkoff Bank has a new topic in the management of data warehousing (Data Warehouse, DWH) for kitchen disputes. 

 Al...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Comparison of analytical in-memory databases</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/files/23b/3e0/c67/23b3e0c67e854d80897df58487b59be4.jpg" align="left">  In the last two months of summer, Tinkoff Bank has a new topic in the management of data warehousing (Data Warehouse, DWH) for kitchen disputes. <br><br>  All this time we have been conducting large-scale testing of several in-memory DBMSs.  Any conversation with the administrators of DWH at this time could begin with the phrase "Well, who is in the lead?", And not miscalculated.  In response, people received a long and very emotional tirade about the difficulties of testing, the intricacies of communicating with hitherto unknown vendors and the shortcomings of individual subjects. <br><br>  Details, results and a kind of conclusions from testing - under the cut. <br><a name="habracut"></a><br>  The purpose of testing is to look at a fast analytical in-memory database that meets our requirements and assess the complexity of its integration with other data warehouse systems. <br>  We also included two DBMS in testing, which are not positioned as an in-memory solution.  We expected that the caching mechanisms in them, provided that the data volume was roughly equivalent to the RAM size of the servers, would allow these DBMS to approach the performance in comparison with the classical in-memory solutions. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h4>  Description of use case </h4><br>  It is assumed that the DBMS selected as a result of testing will work as a front-end storage database for a selective data set (2-4 TB, but the data volume may grow over time): accept requests from the BI system (SAP BusinessObjects) and part ad-hoc requests from some users.  Queries, in 90% of cases, are SELECTs with from 1 to 10 join-s according to the conditions of equality and, sometimes, the conditions for the occurrence of dates in the interval. <br><br>  We need such queries to work much faster than they are now working in the main database of the repository - Greenplum. <br><br>  It is also important that the number of simultaneous requests being executed does not greatly influence the execution time of each request ‚Äî it should be approximately constant. <br>  In our opinion, the target database should have the following functionality: <br><br><ul><li>  horizontal scalability; </li><li>  the ability to perform local join-s - use the "correct" distribution key in the tables </li><li>  column data storage; </li><li>  ability to work with a cache and a large amount of available memory. </li></ul><br>  Downloading data to the target system is assumed from the main storage database - Greenplum, and therefore it is also important for us to have a way to quickly and reliably deliver data (preferably incrementally) from Greenplum to the target database. <br><br>  The ability to integrate with SAP BO is also important.  Fortunately, almost everything that has a stable ODBC driver for Windows works well with this system. <br><br>  From small but weighty requirements, one can distinguish window functions, redundancy (the ability to store multiple copies of data on different nodes), simplicity of further cluster expansion, parallel data loading. <br><br><h4>  Test bench </h4><br>  Two physical servers were allocated for each database: <br><br><ul><li>  16 physical cores (32 with HT) </li><li>  128 GB OP </li><li>  3.9 TB of disk space (RAID 5 of 8 disks) </li><li>  Servers are connected by a 10 Gbps network. </li><li>  The OS for each database was selected based on the recommendations for installing the database itself.  The same applies to the settings of the OS, kernel and other things. </li></ul><br><h4>  Testing Criteria </h4><br><ul><li>  The speed of the test queries </li><li>  Ability to integrate with SAP BO </li><li>  Have a quick and suitable way to import data </li><li>  Stable ODBC driver </li><li>  If the product is not distributed freely, it was possible to contact the representatives of the manufacturer‚Äôs company in adequate time and obtain the installation (distribution kit) of the database required for testing. </li></ul><br><h4>  DB, included in testing </h4><br>  <a href="https://pivotal.io/big-data/pivotal-greenplum">Greenplum</a> <br><img src="https://habrastorage.org/files/f2c/dd3/6fb/f2cdd36fb96243f486500a63a257957e.jpeg"><br>  Old, kind, well familiar to us Greenplum.  About him we have a separate <a href="https://habrahabr.ru/company/tcsbank/blog/267733/">article</a> . <br>  Strictly speaking, Greenplum is not an in-memory database, but it has been experimentally proven that due to the properties of XFS, on which it stores data, it behaves as such under certain conditions. <br><br>  So, for example, when reading, if the amount of memory is sufficient, and also if the data requested by the request is already in memory (cached), the disks for receiving data will not be affected at all - all data from Greenplum will be taken from memory.  It should be understood that this mode of operation is not peculiar to the Greenplum, and therefore specialized in-memory DB should (in theory) cope with such a task better. <br><br>  For testing, Greenplum was installed by default, without mirrors (primary segments only).  All settings are default, tables are compressed zlib. <br><br>  <a href="https://clickhouse.yandex/">Yandex Clickhouse</a> <br><img src="https://habrastorage.org/files/b40/5d8/7fa/b405d87fad7745e8975d736564545f32.jpg"><br><br>  Column DBMS for analytics and real-time reports from a famous search giant. <br>  The DBMS is installed according <a href="https://github.com/yandex/ClickHouse/blob/master/doc/administration/tips.txt">to the manufacturer's recommendations</a> , the engine for local tables, MergeTree, on top of the local tables were created Distributed tables, which participated in the queries. <br><br>  <a href="http://go.sap.com/product/technology-platform/hana.html">SAP HANA</a> <br><img src="https://habrastorage.org/files/1c1/348/756/1c1348756331418e8f1f54ae3534b5d0.gif"><br>  HANA (High performance ANalytics Appliance) is positioned as a universal tool for analytical and transactional load.  Able to store data in a column.  There are necessary for the product base Disaster recovery, mirroring and replication.  HANA allows you to flexibly configure partitions (shards) for tables: both in hash and in range of values. <br><br>  In the presence of multi-level partitioning, at different levels, you can use different types of partitions.  Up to 2 billion records can be written in one partition. <br><br><img src="https://habrastorage.org/files/84c/8b5/e5c/84c8b5e5cef841398befd25572873ee0.jpg"><br>  <i>Solution architecture based on SAP HANA</i> <br><br>  One of the interesting features of this DBMS is the common setting ‚Äúunload priority‚Äù - the priority of unloading from memory, from 1 to 10. It allows you to flexibly manage memory resources and access speeds to tables: if the table is rarely used, then it is set to the lowest priority.  In this case, the table will rarely be loaded into memory and will be one of the first to be unloaded when there is a shortage of resources. <br><br>  <a href="http://www.exasol.com/en/">Exasol</a> <br><img src="https://habrastorage.org/files/099/f15/03c/099f1503cd9e475c9998b807fdb904fc.gif"><br>  The product in Russia is almost unknown, dark horse.  Of the large companies, only Badoo (of which there is <a href="https://habrahabr.ru/company/badoo/blog/271753/">an article</a> on Habr√©) work with this DBMS and a couple of non-IT companies whose name is known - the full list is on the official website. <br><br>  Vendor promises enchanting fast analytics, the stability of the stone in the forest and the ease of administration at the level of the coffee grinder. <br><br>  Exasol runs on its OS - ExaOS (its own GNU / Linux distribution based on CentOS / RHEL).  Installing a DBMS is at least unusual, since it is not installing a separate piece of software on a ready OS, but installing the OS on a separate licensed machine (virtual in our case) from the downloaded image and minimal configuration (partitioning of drives, network interfaces, allow PxE boot) for workers nod. <br><br><img src="https://habrastorage.org/files/f24/1d1/dd5/f241d1dd569541619d561fa8e6730345.PNG"><br>  <i>Exasol Simplified Architecture</i> <br><br>  The beauty of this system is that, since it is not necessary to install anything on the nodes (OS, kernel parameters, and other joys), adding a new node to the cluster happens very quickly.  From the moment the server is installed and connected (bare-metal, without OS), you can enter the node into the cluster in less than half an hour.  All base management is done via a web console.  It is not overloaded with functionality, but it cannot be called a trimmed one. <br><br>  The data is stored in memory by collation and compressed well (the compression settings could not be detected). <br><br>  If, when processing a request, you need more data than there is RAM, the base will start to use swap (spill) on the disks.  The request will not fall (hello to Hana and memSQL), it will just work slower. <br><br>  Exasol automatically creates and removes indexes.  If you make a query for the first time and the DBMS decides that the query will work faster with the index, then the index will be created during the query processing.  And if this index of 30 days was not needed by anyone, then the base itself will remove it. <br>  <s>That's what a smart little horse.</s> <br><br>  <a href="http://www.memsql.com/">Memsql</a> <br><img src="https://habrastorage.org/files/cec/01b/a52/cec01ba52e52469b8ca9f9f7e7d7fdc0.gif"><br>  In-memory DBMS based on mySQL.  Cluster, there are analytic functions.  By default, it stores data line by line. <br><br>  To make stonework storage, you need to add a special index when creating the table: <br><pre><code class="sql hljs">KEY `keyname` (`fieldaname`) USING CLUSTERED COLUMNSTORE</code> </pre> <br>  In this case, rowstore data is always stored in memory, but columnstore data, in case of low memory, can be automatically flushed to disk. <br><br>  Distribution key is called SHARD KEY.  An automatic btree index is created for each field in the shard key. <br><br>  The basic version is completely free, with no restrictions on the amount of data and RAM.  In the paid version there are high availability, online backups and restorers, replication between data centers and user rights management. <br><br><img src="https://habrastorage.org/files/703/813/54f/70381354fcfd44d593179e8081ffcc88.jpg"><br>  <i>Simplified Memsql Architecture</i> <br><br>  <a href="http://impala.apache.org/">Impala</a> <br><img src="https://habrastorage.org/files/5c1/7af/4ca/5c17af4ca17b463194a65df44496d088.gif"><br>  The Cloudera product, an SQL engine developed in C ++, is part of the Apache Hadoop ecosystem.  Works with data stored in HDFS and HBase.  As a metadata repository uses HiveMetastore, which is part of the database Hive.  Unlike Hive, does not use MapReduce.  Supports caching of frequently used data blocks. <br>  Positioned as a DBMS for processing analytical queries that require a quick response.  Able to work with basic BI-tools.  Full ANSI SQL support, window functions present. <br><br>  Impala is available as a package and a package in the Cloudera repository.  During testing, the distribution kit was used: Cloudera CDH 5.8.0.  For installation, the minimum set of services was chosen for Impala operation: Zookeeper, HDFS, Yarn, Hive.  Most of the settings were used by default.  For Impala, a total of 160 GB of memory was allocated from both servers.  To control the utilization of server resources by containers, cgroups were used. <br><br>  All the optimizations recommended in the <a href="http://www.cloudera.com/documentation/enterprise/latest/topics/impala_performance.html">article</a> were performed, namely: <br><br>  - Parquet was chosen as the format for storing tables in HDFS; <br>  - optimized data types, where it could be done; <br>  - preliminary statistics were collected for each table (compute stats); <br>  - data of all tables were recorded in the HDFS cache (alter table ... set cached in ...); <br>  - optimized joines (as far as possible). <br><br>  At the initial planning stage, testing and determining the DBMS for the participation of Impala was discarded because we already worked with it several years ago and at that time it did not look production-ready.  Once again, we were persuaded by our industry colleagues to look in the direction of "Antelope", convincing that over time it has become much prettier and has learned how to work with memory correctly. <br><br><div class="spoiler">  <b class="spoiler_title">More information about Impala</b> <div class="spoiler_text">  Composition: <br>  Impala Daemon is a basic service that serves to accept, process, coordinate, distribute across a cluster and execute a query.  Supports ODBC and JDBC interfaces.  It also has a CLI interface and an interface for working with Hue (Web UI for analyzing data in Hadoop).  It is executed as a daemon on each of the cluster workers. <br><br>  Impala Statestore - used to check the status of Impala Daemon instances running in a cluster.  If Impala Daemon fails on any worker, then the State store notifies instances on the other workers so that requests to the instance that has gone offline are not transmitted.  As a rule, works on the master node of the cluster, is not required. <br><br>  Impala Catalog Server - this service is used to receive and aggregate metadata from HiveMetastore, HDFS Namenode, HBase as a structure supported by Impala Daemon.  This service is also used to store metadata used exclusively by Impala itself, such as, for example, user-defined functions.  As a rule, works on the master node of the cluster. <br><br><img src="https://habrastorage.org/files/5b4/ecb/c8c/5b4ecbc8c12648abb64467558aaf6076.png"><br></div></div><br>  <a href="https://docs.google.com/spreadsheets/d/139W_3Jcr27E3n_wSko1KcVawpxDXcKE3Z8vUzbTJPsQ/edit%3Fusp%3Dsharing">Some important for us characteristics of all databases, collected in one table on Google Docs</a> <br><br><div class="spoiler">  <b class="spoiler_title">For the brave - the same table in the Habr format (cautiously, the Habr redesign made the more or less wide tables unreadable)</b> <div class="spoiler_text"><table><tbody><tr><td colspan="1" rowspan="1"></td><td colspan="1" rowspan="1">  <b>Greenplum</b> </td><td colspan="1" rowspan="1">  <b>Exasol</b> </td><td colspan="1" rowspan="1">  <b>Clickhouse</b> </td><td colspan="1" rowspan="1">  <b>Memsql</b> </td><td colspan="1" rowspan="1">  <b>SAP Hana</b> </td><td colspan="1" rowspan="1">  <b>Impala</b> </td></tr><tr><td colspan="1" rowspan="1">  <b>Vendor</b> </td><td colspan="1" rowspan="1">  EMC </td><td colspan="1" rowspan="1">  Exasol </td><td colspan="1" rowspan="1">  Yandex </td><td colspan="1" rowspan="1">  Memsql </td><td colspan="1" rowspan="1">  SAP </td><td colspan="1" rowspan="1">  Apache / Cloudera </td></tr><tr><td colspan="1" rowspan="1">  <b>Used in</b> <b>version</b> </td><td colspan="1" rowspan="1">  4.3.8.1 </td><td colspan="1" rowspan="1">  5.0.15 </td><td colspan="1" rowspan="1">  1.1.53988 </td><td colspan="1" rowspan="1">  5.1.0 </td><td colspan="1" rowspan="1">  1.00.121.00.1466466057 </td><td colspan="1" rowspan="1">  2.6.0 </td></tr><tr><td colspan="1" rowspan="1">  <b>Master nodes</b> </td><td colspan="1" rowspan="1">  Master segment.  Reserved. <br></td><td colspan="1" rowspan="1">  The entry point is any node.  There is a license-node, reserved. </td><td colspan="1" rowspan="1">  Entry point - any node </td><td colspan="1" rowspan="1">  Entry point - any node </td><td colspan="1" rowspan="1">  There is a master node.  Reserved. </td><td colspan="1" rowspan="1">  The entry point is any node.  However, you need a Hive metastore server. </td></tr><tr><td colspan="1" rowspan="1">  <b>OS</b> <b>used</b> </td><td colspan="1" rowspan="1">  RHEL 6.7 </td><td colspan="1" rowspan="1">  EXA OS (proprietary) </td><td colspan="1" rowspan="1">  Ubuntu 04/14/4 </td><td colspan="1" rowspan="1">  RHEL 6.7 </td><td colspan="1" rowspan="1">  RHEL 6.7 </td><td colspan="1" rowspan="1">  RHEL 6.7 </td></tr><tr><td colspan="1" rowspan="1">  <b>Possible iron</b> </td><td colspan="1" rowspan="1">  Any </td><td colspan="1" rowspan="1">  Anyone with PXE Boot support </td><td colspan="1" rowspan="1">  Any </td><td colspan="1" rowspan="1">  Any </td><td colspan="1" rowspan="1">  Only from SAP list </td><td colspan="1" rowspan="1">  Any </td></tr><tr><td colspan="1" rowspan="1">  <b>Import from Greenplum</b> </td><td colspan="1" rowspan="1">  External http tablesPipes </td><td colspan="1" rowspan="1">  External http tablesJDBC import </td><td colspan="1" rowspan="1">  External http tables </td><td colspan="1" rowspan="1">  CSV from SPARK local server </td><td colspan="1" rowspan="1">  CSV from local server </td><td colspan="1" rowspan="1">  External GPHDFS tables </td></tr><tr><td colspan="1" rowspan="1">  <b>Integration with SAP BO</b> <b>(source for universes)</b> </td><td colspan="1" rowspan="1">  Yes, ODBC </td><td colspan="1" rowspan="1">  Yes, ODBC </td><td colspan="1" rowspan="1">  No data </td><td colspan="1" rowspan="1">  No data </td><td colspan="1" rowspan="1">  Yes </td><td colspan="1" rowspan="1">  Yes, ODBCSIMBA </td></tr><tr><td colspan="1" rowspan="1">  <b>SAS integration</b> </td><td colspan="1" rowspan="1">  Yes, SAS ACCESS </td><td colspan="1" rowspan="1">  Yes, ODBC </td><td colspan="1" rowspan="1">  No data </td><td colspan="1" rowspan="1">  No data </td><td colspan="1" rowspan="1">  No data </td><td colspan="1" rowspan="1">  Yes, SAS ACCESS </td></tr><tr><td colspan="1" rowspan="1">  <b>Window functions</b> </td><td colspan="1" rowspan="1">  there is </td><td colspan="1" rowspan="1">  there is </td><td colspan="1" rowspan="1">  Not </td><td colspan="1" rowspan="1">  there is </td><td colspan="1" rowspan="1">  there is </td><td colspan="1" rowspan="1">  there is </td></tr><tr><td colspan="1" rowspan="1">  <b>Distribution by node</b> </td><td colspan="1" rowspan="1">  Across the field / fields </td><td colspan="1" rowspan="1">  Across the field / fields </td><td colspan="1" rowspan="1">  Across the field / fields </td><td colspan="1" rowspan="1">  Across the field / fields </td><td colspan="1" rowspan="1">  Across the field / fieldShards spread manually on the nodes </td><td colspan="1" rowspan="1">  Randomly </td></tr><tr><td colspan="1" rowspan="1">  <b>Column storage</b> </td><td colspan="1" rowspan="1">  there is </td><td colspan="1" rowspan="1">  there is </td><td colspan="1" rowspan="1">  there is </td><td colspan="1" rowspan="1">  There is a diskNo in memory </td><td colspan="1" rowspan="1">  there is </td><td colspan="1" rowspan="1">  There is (parquet) </td></tr><tr><td colspan="1" rowspan="1">  <b>When there is insufficient memory</b> <b>when executing the request</b> </td><td colspan="1" rowspan="1">  The data is split to disk </td><td colspan="1" rowspan="1">  The data is split to disk </td><td colspan="1" rowspan="1">  Request falls </td><td colspan="1" rowspan="1">  Request falls </td><td colspan="1" rowspan="1">  Request falls </td><td colspan="1" rowspan="1">  The data is split to disk </td></tr><tr><td colspan="1" rowspan="1">  <b>fault tolerance</b> </td><td colspan="1" rowspan="1">  Yes, the mechanism of mirrors </td><td colspan="1" rowspan="1">  Yes, the mechanism of mirrors </td><td colspan="1" rowspan="1">  Yes, at the table level </td><td colspan="1" rowspan="1">  there is </td><td colspan="1" rowspan="1">  there is </td><td colspan="1" rowspan="1">  Yes, by HDFS </td></tr><tr><td colspan="1" rowspan="1">  <b>Mode of distribution</b> </td><td colspan="1" rowspan="1">  Open source, APACHE-2 </td><td colspan="1" rowspan="1">  Closed code, paid </td><td colspan="1" rowspan="1">  Open source, APACHE-2 </td><td colspan="1" rowspan="1">  Closed code, free </td><td colspan="1" rowspan="1">  Closed code, paid </td><td colspan="1" rowspan="1">  Open source, APACHE-2 </td></tr></tbody></table><br></div></div><br><h4>  Test results </h4><br><div class="spoiler">  <b class="spoiler_title">Description and text of test queries used in testing</b> <div class="spoiler_text"><img src="https://habrastorage.org/files/a36/7d5/a06/a367d5a062a44514ac7a5d14fc660269.png"><br><br>  Queries with d_financial_account_not_additive were selected for testing.  d_financial_account_not_additive is a view with data for each account for each day.  View is made on the basis of three tables in order to optimize disk space, and, accordingly, read from disk.  For testing, a part of the data on the first million accounts from the beginning of 2015 was selected.  This is a little over 522 million lines.  To not_additive, we attach the data on the accounts (financial_account) and on applications (financial_account_application and application_calling_channel).  In Greenplum (for example), distribution tables for segments are set for tables: for accounts, this is account_rk, for applications - financial_application_rk.  In queries, joins between the main tables occur in equality, so we can expect hash join, without a nested loop, when we need to compare line by line a large number of rows from different tables. <br><br>  The total amount of data was about 200 GB in uncompressed form (we expect that all this volume with a small margin fits into memory). <br>  Number of rows in used tables: <br><br><table><tbody><tr><td>  <b>Table</b> </td><td>  <b>Number of lines</b> </td></tr><tr><td>  d_financial_account_date </td><td>  522726636 </td></tr><tr><td>  d_financial_account_data_bal </td><td>  229255701 </td></tr><tr><td>  financial_account_application </td><td>  52118559 </td></tr><tr><td>  application_calling_channel </td><td>  28158924 </td></tr><tr><td>  d_financial_account_data_scd </td><td>  3494716 </td></tr><tr><td>  financial_account </td><td>  2930425 </td></tr><tr><td>  currency_rates </td><td>  3948 </td></tr><tr><td>  dds_calendar_date </td><td>  731 </td></tr><tr><td>  loyalty_program_types </td><td>  35 </td></tr><tr><td>  financial_institution </td><td>  five </td></tr></tbody></table><br><div class="spoiler">  <b class="spoiler_title">Request N1</b> <div class="spoiler_text"><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> date_trunc(<span class="hljs-string"><span class="hljs-string">'year'</span></span>, d_financial_account_not_additive.business_dt) || <span class="hljs-string"><span class="hljs-string">'-'</span></span> || date_trunc(<span class="hljs-string"><span class="hljs-string">'month'</span></span>,d_financial_account_not_additive.business_dt) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> yymm, d_financial_account_not_additive.business_dt, financial_account.financial_account_subtype_cd, <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-keyword"><span class="hljs-keyword">when</span></span> d_financial_account_not_additive.ofn_balance_amt &lt;<span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">end</span></span>, loyalty_program_by_day.loyalty_program_type_nm, financial_account.currency_cd, <span class="hljs-keyword"><span class="hljs-keyword">sum</span></span>(d_financial_account_not_additive.balance_amt*Table__14.rate), <span class="hljs-keyword"><span class="hljs-keyword">sum</span></span>(d_financial_account_not_additive.balance_amt) <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> prod_emart.loyalty_program_types loyalty_program_by_day <span class="hljs-keyword"><span class="hljs-keyword">RIGHT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">OUTER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">JOIN</span></span> prod_emart.d_financial_account_not_additive d_financial_account_not_additive <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> (d_financial_account_not_additive.loyalty_program_type_rk=loyalty_program_by_day.loyalty_program_type_rk <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> loyalty_program_by_day.valid_to_dttm &gt; <span class="hljs-keyword"><span class="hljs-keyword">now</span></span>()) <span class="hljs-keyword"><span class="hljs-keyword">INNER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">JOIN</span></span> prod_emart.financial_account financial_account <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> (financial_account.account_rk=d_financial_account_not_additive.account_rk) <span class="hljs-keyword"><span class="hljs-keyword">INNER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">JOIN</span></span> ( <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> r.currency_from_cd, r.currency_to_cd, r.rate, r.rate_dt <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> prod_emart.currency_rates r <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> ( r.currency_to_cd=<span class="hljs-string"><span class="hljs-string">'RUR'</span></span> ) <span class="hljs-keyword"><span class="hljs-keyword">union</span></span> all <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> <span class="hljs-string"><span class="hljs-string">'RUB'</span></span>, <span class="hljs-string"><span class="hljs-string">'RUR'</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>, d.calendar_dt <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> prod_emart.dds_calendar_date d ) Table__14 <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> (Table__14.currency_from_cd=financial_account.currency_cd) <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> ( Table__14.rate_dt=d_financial_account_not_additive.business_dt ) <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> ( d_financial_account_not_additive.business_dt &gt;= <span class="hljs-keyword"><span class="hljs-keyword">to_date</span></span>(( <span class="hljs-number"><span class="hljs-number">2016</span></span> - <span class="hljs-number"><span class="hljs-number">2</span></span>)::<span class="hljs-built_in"><span class="hljs-built_in">character</span></span> <span class="hljs-built_in"><span class="hljs-built_in">varying</span></span> ||<span class="hljs-string"><span class="hljs-string">'-01-01'</span></span>, <span class="hljs-string"><span class="hljs-string">'YYYY-MM-DD'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> d_financial_account_not_additive.business_dt &lt;= (<span class="hljs-keyword"><span class="hljs-keyword">current_date</span></span><span class="hljs-number"><span class="hljs-number">-1</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> financial_account.financial_account_subtype_cd <span class="hljs-keyword"><span class="hljs-keyword">IN</span></span> ( <span class="hljs-string"><span class="hljs-string">'DEP'</span></span>,<span class="hljs-string"><span class="hljs-string">'SAV'</span></span>,<span class="hljs-string"><span class="hljs-string">'SVN'</span></span>,<span class="hljs-string"><span class="hljs-string">'LEG'</span></span>,<span class="hljs-string"><span class="hljs-string">'CUR'</span></span> ) ) <span class="hljs-keyword"><span class="hljs-keyword">GROUP</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BY</span></span> date_trunc(<span class="hljs-string"><span class="hljs-string">'year'</span></span>, d_financial_account_not_additive.business_dt) || <span class="hljs-string"><span class="hljs-string">'-'</span></span> || date_trunc(<span class="hljs-string"><span class="hljs-string">'month'</span></span>,d_financial_account_not_additive.business_dt), d_financial_account_not_additive.business_dt, financial_account.financial_account_subtype_cd, <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-keyword"><span class="hljs-keyword">when</span></span> d_financial_account_not_additive.ofn_balance_amt &lt;<span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">end</span></span>, loyalty_program_by_day.loyalty_program_type_nm, financial_account.currency_cd</code> </pre></div></div><br><div class="spoiler">  <b class="spoiler_title">Request N2</b> <div class="spoiler_text"><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">select</span></span> <span class="hljs-keyword"><span class="hljs-keyword">count</span></span>(*) <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> date_trunc(<span class="hljs-string"><span class="hljs-string">'year'</span></span>, d_financial_account_not_additive.business_dt) || <span class="hljs-string"><span class="hljs-string">'-'</span></span> || date_trunc(<span class="hljs-string"><span class="hljs-string">'month'</span></span>,d_financial_account_not_additive.business_dt) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> yymm, d_financial_account_not_additive.business_dt, financial_account.financial_account_subtype_cd, loyalty_program_by_day.loyalty_program_type_nm, application_calling_channel.appl_channel, <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-keyword"><span class="hljs-keyword">when</span></span> ( financial_account_application.application_product_type )=<span class="hljs-string"><span class="hljs-string">'010222'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> <span class="hljs-string"><span class="hljs-string">'Y'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-string"><span class="hljs-string">'N'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> , <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-keyword"><span class="hljs-keyword">when</span></span> ( financial_account_application.application_product_type )=<span class="hljs-string"><span class="hljs-string">'020202'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> <span class="hljs-string"><span class="hljs-string">'Y'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-string"><span class="hljs-string">'N'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">end</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-keyword"><span class="hljs-keyword">when</span></span> financial_account.parent_account_rk <span class="hljs-keyword"><span class="hljs-keyword">is</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span> <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> <span class="hljs-string"><span class="hljs-string">'N'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-string"><span class="hljs-string">'Y'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">end</span></span>, prod_emart.financial_institution.financial_institution_nm, <span class="hljs-keyword"><span class="hljs-keyword">sum</span></span>(d_financial_account_not_additive.principal_balance_amt), <span class="hljs-keyword"><span class="hljs-keyword">sum</span></span>(d_financial_account_not_additive.interest_balance_amt), <span class="hljs-keyword"><span class="hljs-keyword">sum</span></span>(d_financial_account_not_additive.f2g_balance_amt), <span class="hljs-keyword"><span class="hljs-keyword">sum</span></span>(d_financial_account_not_additive.f2n_balance_amt), <span class="hljs-keyword"><span class="hljs-keyword">sum</span></span>(d_financial_account_not_additive.overdue_fee_balance_amt), <span class="hljs-keyword"><span class="hljs-keyword">sum</span></span>(d_financial_account_not_additive.pastdue_gvt_balance_amt), <span class="hljs-keyword"><span class="hljs-keyword">sum</span></span>(d_financial_account_not_additive.annual_fee_balance_amt), <span class="hljs-keyword"><span class="hljs-keyword">sum</span></span>(d_financial_account_not_additive.sim_kke_balance_amt) <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> prod_emart.loyalty_program_types loyalty_program_by_day <span class="hljs-keyword"><span class="hljs-keyword">RIGHT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">OUTER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">JOIN</span></span> prod_emart.d_financial_account_not_additive d_financial_account_not_additive <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> (d_financial_account_not_additive.loyalty_program_type_rk=loyalty_program_by_day.loyalty_program_type_rk <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> loyalty_program_by_day.valid_to_dttm &gt; <span class="hljs-keyword"><span class="hljs-keyword">now</span></span>()) <span class="hljs-keyword"><span class="hljs-keyword">INNER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">JOIN</span></span> prod_emart.financial_account financial_account <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> (financial_account.account_rk=d_financial_account_not_additive.account_rk) <span class="hljs-keyword"><span class="hljs-keyword">LEFT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">OUTER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">JOIN</span></span> prod_emart.financial_account_application <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> financial_account.financial_application_rk=financial_account_application.financial_application_rk <span class="hljs-keyword"><span class="hljs-keyword">LEFT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">OUTER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">JOIN</span></span> prod_emart.application_calling_channel <span class="hljs-keyword"><span class="hljs-keyword">on</span></span> financial_account.financial_application_rk=application_calling_channel.financial_application_rk <span class="hljs-keyword"><span class="hljs-keyword">LEFT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">OUTER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">JOIN</span></span> prod_emart.financial_account parent_account <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> (financial_account.parent_account_rk=parent_account.account_rk) <span class="hljs-keyword"><span class="hljs-keyword">LEFT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">OUTER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">JOIN</span></span> prod_emart.financial_institution <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> (financial_account.financial_institution=financial_institution.financial_institution) <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> ( d_financial_account_not_additive.business_dt &gt;= <span class="hljs-keyword"><span class="hljs-keyword">to_date</span></span>(<span class="hljs-string"><span class="hljs-string">'2014-01-01'</span></span>, <span class="hljs-string"><span class="hljs-string">'YYYY-MM-DD'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> d_financial_account_not_additive.business_dt &lt;= (<span class="hljs-keyword"><span class="hljs-keyword">current_date</span></span><span class="hljs-number"><span class="hljs-number">-1</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> ( financial_account.financial_account_subtype_cd <span class="hljs-keyword"><span class="hljs-keyword">IN</span></span> ( <span class="hljs-string"><span class="hljs-string">'CCR'</span></span>,<span class="hljs-string"><span class="hljs-string">'INS'</span></span>,<span class="hljs-string"><span class="hljs-string">'CLN'</span></span>,<span class="hljs-string"><span class="hljs-string">'VKR'</span></span>,<span class="hljs-string"><span class="hljs-string">'EIC'</span></span> ) <span class="hljs-keyword"><span class="hljs-keyword">OR</span></span> ( financial_account.financial_account_subtype_cd <span class="hljs-keyword"><span class="hljs-keyword">IN</span></span> ( <span class="hljs-string"><span class="hljs-string">'PHX'</span></span> ) <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> ( parent_account.financial_account_subtype_cd <span class="hljs-keyword"><span class="hljs-keyword">Is</span></span> <span class="hljs-literal"><span class="hljs-literal">Null</span></span> <span class="hljs-keyword"><span class="hljs-keyword">OR</span></span> parent_account.financial_account_subtype_cd <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">IN</span></span> ( <span class="hljs-string"><span class="hljs-string">'IFS'</span></span> ) ) ) ) ) <span class="hljs-keyword"><span class="hljs-keyword">GROUP</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BY</span></span> date_trunc(<span class="hljs-string"><span class="hljs-string">'year'</span></span>, d_financial_account_not_additive.business_dt) || <span class="hljs-string"><span class="hljs-string">'-'</span></span> || date_trunc(<span class="hljs-string"><span class="hljs-string">'month'</span></span>,d_financial_account_not_additive.business_dt), d_financial_account_not_additive.business_dt, financial_account.financial_account_subtype_cd, loyalty_program_by_day.loyalty_program_type_nm, application_calling_channel.appl_channel, <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-keyword"><span class="hljs-keyword">when</span></span> ( financial_account_application.application_product_type )=<span class="hljs-string"><span class="hljs-string">'010222'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> <span class="hljs-string"><span class="hljs-string">'Y'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-string"><span class="hljs-string">'N'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> , <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-keyword"><span class="hljs-keyword">when</span></span> ( financial_account_application.application_product_type )=<span class="hljs-string"><span class="hljs-string">'020202'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> <span class="hljs-string"><span class="hljs-string">'Y'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-string"><span class="hljs-string">'N'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">end</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-keyword"><span class="hljs-keyword">when</span></span> financial_account.parent_account_rk <span class="hljs-keyword"><span class="hljs-keyword">is</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span> <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> <span class="hljs-string"><span class="hljs-string">'N'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-string"><span class="hljs-string">'Y'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">end</span></span>, financial_institution.financial_institution_nm) sq</code> </pre></div></div><br><div class="spoiler">  <b class="spoiler_title">Request N3</b> <div class="spoiler_text"><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> date_trunc(<span class="hljs-string"><span class="hljs-string">'year'</span></span>, d_financial_account_not_additive.business_dt) || <span class="hljs-string"><span class="hljs-string">'-'</span></span> || date_trunc(<span class="hljs-string"><span class="hljs-string">'month'</span></span>,d_financial_account_not_additive.business_dt) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> yymm, d_financial_account_not_additive.business_dt, financial_account.financial_account_subtype_cd, <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-keyword"><span class="hljs-keyword">when</span></span> ( prod_emart.financial_account_application.application_product_type )=<span class="hljs-string"><span class="hljs-string">'010222'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> <span class="hljs-string"><span class="hljs-string">'Y'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-string"><span class="hljs-string">'N'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> , d_financial_account_not_additive.risk_status_cd, <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-keyword"><span class="hljs-keyword">when</span></span> financial_account.utilization_dt&lt;=d_financial_account_not_additive.business_dt <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">end</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-keyword"><span class="hljs-keyword">when</span></span> ( d_financial_account_not_additive.current_limit_amt) &gt; <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">end</span></span>, prod_emart.financial_institution.financial_institution_nm, <span class="hljs-comment"><span class="hljs-comment">--sum(d_financial_account_not_additive.credit_balance_amt), sum(d_financial_account_not_additive.principal_balance_amt), sum(d_financial_account_not_additive.current_limit_amt), count(d_financial_account_not_additive.account_rk), sum(case when d_financial_account_not_additive.current_limit_amt &gt; 0 then d_financial_account_not_additive.principal_balance_amt / d_financial_account_not_additive.current_limit_amt end) FROM prod_emart.d_financial_account_not_additive INNER JOIN prod_emart.financial_account financial_account ON (financial_account.account_rk=d_financial_account_not_additive.account_rk) LEFT OUTER JOIN prod_emart.financial_account_application on financial_account.financial_application_rk=prod_emart.financial_account_application.financial_application_rk LEFT OUTER JOIN prod_emart.financial_institution ON (financial_account.financial_institution=prod_emart.financial_institution.financial_institution) WHERE ( d_financial_account_not_additive.business_dt &gt;= to_date(( 2016 - 2)::character varying ||'-01-01', 'YYYY-MM-DD') AND d_financial_account_not_additive.business_dt &lt;= (current_date-1) AND financial_account.financial_account_subtype_cd IN ( 'CCR','CLN','VKR','INS','EIC' ) AND case when financial_account.close_dt&lt;=d_financial_account_not_additive.business_dt then 1 else 0 end IN ( 0 ) ) GROUP BY date_trunc('year', d_financial_account_not_additive.business_dt) || '-' || date_trunc('month',d_financial_account_not_additive.business_dt), d_financial_account_not_additive.business_dt, financial_account.financial_account_subtype_cd, case when ( prod_emart.financial_account_application.application_product_type )='010222' then 'Y' else 'N' end , d_financial_account_not_additive.risk_status_cd, case when financial_account.utilization_dt&lt;=d_financial_account_not_additive.business_dt then 1 else 0 end, case when ( d_financial_account_not_additive.current_limit_amt) &gt; 0 then 1 else 0 end, prod_emart.financial_institution.financial_institution_nm</span></span></code> </pre></div></div><br><div class="spoiler">  <b class="spoiler_title">T1 Request</b> <div class="spoiler_text"><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">count</span></span>(*) <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> ( <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> prod_emart.d_financial_account_data_bal ) ALL <span class="hljs-keyword"><span class="hljs-keyword">INNER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">JOIN</span></span> ( <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> prod_emart.d_financial_account_date ) <span class="hljs-keyword"><span class="hljs-keyword">USING</span></span> account_rk, valid_from_dt</code> </pre><br></div></div><br><div class="spoiler">  <b class="spoiler_title">T2 Request</b> <div class="spoiler_text"><pre> <code class="sql hljs"> <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">count</span></span>(*) <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> prod_emart.d_financial_account_data_bal a <span class="hljs-keyword"><span class="hljs-keyword">JOIN</span></span> prod_emart.d_financial_account_date b <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> a.account_rk = b.account_rk <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> a.valid_from_dt = b.valid_from_dt <span class="hljs-keyword"><span class="hljs-keyword">LEFT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">JOIN</span></span> prod_emart.d_financial_account_data_scd sc <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> a.account_rk = sc.account_rk <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> b.scd_valid_from_dt = sc.scd_valid_from_dt;</code> </pre><br></div></div><br><div class="spoiler">  <b class="spoiler_title">D1 (Cartesian product of one column)</b> <div class="spoiler_text"><pre> <code class="sql hljs"><span class="hljs-comment"><span class="hljs-comment">--   - 291 157 926 408  select count(*) from (SELECT * FROM WRK.D_FINANCIAL_ACCOUNT_DATE) t1 INNER JOIN (SELECT * FROM WRK.D_FINANCIAL_ACCOUNT_DATE) t2 on t1.account_rk = t2.account_rk;</span></span></code> </pre></div></div><br><div class="spoiler">  <b class="spoiler_title">D2 (Cartesian product of several columns)</b> <div class="spoiler_text"><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">select</span></span> <span class="hljs-keyword"><span class="hljs-keyword">count</span></span>(*) ,<span class="hljs-keyword"><span class="hljs-keyword">sum</span></span>(t1.last_day_of_month_flg - t2.last_day_of_month_flg) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> sum_flg ,<span class="hljs-keyword"><span class="hljs-keyword">sum</span></span>(t1.business_dt - t2.valid_from_dt) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> b1v2 ,<span class="hljs-keyword"><span class="hljs-keyword">sum</span></span>(t1.valid_from_dt - <span class="hljs-keyword"><span class="hljs-keyword">coalesce</span></span>(t2.scd_valid_from_dt,<span class="hljs-keyword"><span class="hljs-keyword">current_date</span></span>)) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> v1s2 ,<span class="hljs-keyword"><span class="hljs-keyword">sum</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">coalesce</span></span>(t1.scd_valid_from_dt,<span class="hljs-keyword"><span class="hljs-keyword">current_date</span></span>) - t1.business_dt) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> s1b2 <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> prod_emart.D_FINANCIAL_ACCOUNT_DATE t1 <span class="hljs-keyword"><span class="hljs-keyword">INNER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">JOIN</span></span> prod_emart.D_FINANCIAL_ACCOUNT_DATE t2 <span class="hljs-keyword"><span class="hljs-keyword">on</span></span> t1.account_rk = t2.account_rk;</code> </pre><br></div></div></div></div><br>  Results are in seconds. <br><table><tbody><tr><td colspan="1" rowspan="1">  <strong>Request</strong> <br></td><td colspan="1" rowspan="1">  <strong>Greenplum</strong> <br></td><td colspan="1" rowspan="1">  <strong>Exasol</strong> <br></td><td colspan="1" rowspan="1">  <strong>Clickhouse</strong> <br></td><td colspan="1" rowspan="1">  <strong>Memsql</strong> <br></td><td colspan="1" rowspan="1">  <strong>SAP Hana</strong> <br></td><td colspan="1" rowspan="1">  <strong>Impala</strong> <br></td></tr><tr><td colspan="1" rowspan="1">  <strong>N1</strong> <br></td><td colspan="1" rowspan="1">  14 <br></td><td colspan="1" rowspan="1">  &lt;1 <br></td><td colspan="1" rowspan="1">  - <br></td><td colspan="1" rowspan="1">  108 <br></td><td colspan="1" rowspan="1">  6 <br></td><td colspan="1" rowspan="1">  78 <br></td></tr><tr><td colspan="1" rowspan="1">  <strong>N2</strong> <br></td><td colspan="1" rowspan="1">  131 <br></td><td colspan="1" rowspan="1">  eleven <br></td><td colspan="1" rowspan="1">  - <br></td><td colspan="1" rowspan="1">  - <br></td><td colspan="1" rowspan="1">  127 <br></td><td colspan="1" rowspan="1">  Error <br></td></tr><tr><td colspan="1" rowspan="1">  <strong>N3</strong> <br></td><td colspan="1" rowspan="1">  67 <br></td><td colspan="1" rowspan="1">  85 <br></td><td colspan="1" rowspan="1">  - <br></td><td colspan="1" rowspan="1">  - <br></td><td colspan="1" rowspan="1">  122 <br></td><td colspan="1" rowspan="1">  733 <br></td></tr><tr><td colspan="1" rowspan="1">  <strong>T1</strong> <br></td><td colspan="1" rowspan="1">  14 <br></td><td colspan="1" rowspan="1">  1.8 <br></td><td colspan="1" rowspan="1">  64 <br></td><td colspan="1" rowspan="1">  70 <br></td><td colspan="1" rowspan="1">  20 <br></td><td colspan="1" rowspan="1">  100 <br></td></tr><tr><td colspan="1" rowspan="1">  <strong>T2</strong> <br></td><td colspan="1" rowspan="1">  17 <br></td><td colspan="1" rowspan="1">  4.2 <br></td><td colspan="1" rowspan="1">  86 <br></td><td colspan="1" rowspan="1">  105 <br></td><td colspan="1" rowspan="1">  20 <br></td><td colspan="1" rowspan="1">  127 <br></td></tr><tr><td colspan="1" rowspan="1">  <strong>D1</strong> <br></td><td colspan="1" rowspan="1">  1393 <br></td><td colspan="1" rowspan="1">  284 <br></td><td colspan="1" rowspan="1">  - <br></td><td colspan="1" rowspan="1">  45 <br></td><td colspan="1" rowspan="1">  1500 <br></td><td colspan="1" rowspan="1">  - <br></td></tr><tr><td colspan="1" rowspan="1">  <strong>D2</strong> <br></td><td colspan="1" rowspan="1">  &gt; 7200 <br></td><td colspan="1" rowspan="1">  1200 <br></td><td colspan="1" rowspan="1">  - <br></td><td colspan="1" rowspan="1">  &gt; 7200 <br></td><td colspan="1" rowspan="1">  Error <br></td><td colspan="1" rowspan="1">  - <br></td></tr></tbody></table><br><h4>  Identified nuances in the database </h4><br><h5>  Yandex Clickhouse </h5><br>  During testing, it turned out that this database is not suitable for our tasks - joins are represented only nominally in it.  For example: <br><ul><li>  only JOIN is supported with the subquery as the right side; </li><li>  conditions in join-e are not thrown inside the subquery; </li><li>  distributed join-s are performed inefficiently. </li></ul><br>  It turned out to be almost impossible to rewrite the "heavy" queries (N1-N3) on the Clickhouse syntax.  It also saddens the memory limit - the result of any of the subqueries in any query should fit into memory on one (!) Server from the cluster. <br><br>  Despite the fact that this database was unsuitable for BI tasks, according to test results, it found application in a repository in another project. <br><br>  Separately, I would like to highlight the very detailed and user-friendly documentation available on the official website (unfortunately, so far it does not cover all aspects of using the database), as well as to thank Yandex developers for the prompt answers to our questions during testing. <br><br><h5>  SAP HANA </h5><br>  The main part of setting up servers and query optimization was made by colleagues from one consulting company, which are representatives of SAP in Russia.  Without them, we would not be able to look at the base and evaluate its advantages: as experience has shown, experience with HANA requires experience. <br><br>  HANA showed itself very interestingly when counting the number of rows for the join itself on the table itself: <br><br><img src="https://habrastorage.org/files/086/054/93d/08605493ddc141bb9f1dd79b506f839d.png"><br>  <i>EXPLAIN query with join table with itself at HANA</i> <br><br>  The optimizer calculates the result using statistics without even joining.  Not a bad trick, but if in a where to add a condition that is always True, for example ‚Äú1 = 1‚Äù, the trick will not work and we will get 25 minutes, almost as many as in Greenplum. <br><br>  At the current time, HANA does not know how to place intermediate results of queries on disk during the execution of a query.  Therefore, if there is not enough memory, the session ends and the user is left without results. <br><br>  As it turned out during the testing process, even if the data of the two tables participating in the join-e are distributed among the nodes of the cluster correctly, the join in fact is executed only on one node of the cluster.  Before executing the request, data from the entire cluster is simply poured into one node, and the join-a is already there.  For the time allotted for testing, this logic could not be overcome and the join could not be executed locally. <br><br>  By the way, the manufacturer recommends, if possible, to use the single-mode configuration of the database, which is confirmed by the results of our testing - making the configuration of two machines work optimally many times more difficult than from one. <br><br><h5>  Exasol </h5><br>  The main impression of working with the base is very fast and surprisingly stable, right out of the box.  Almost all of our tests show an advantage in speed compared to other DBMS.  However, unlike many other DBMSs, this is a black box - you cannot even connect to the ssh node and run iotop, htop, and so on. <br>  The lack of control of their own servers, of course, forces to strain.  Although in fairness it should be noted that all the necessary data on the operation of the base and the load on iron is in the system view inside the base. <br><br>  There are JDBC, ODBC drivers, excellent support for ANSI SQL and some specific features of Oracle (select 1 from dual, as an example).  JDBC-drivers for connecting to external databases (Oracle, PostgreSQL, MySQL and others) are already built into the database, which is very convenient for loading data. <br><br>  EXASOL allows you to see the plan only completed requests.  This is due to the fact that the plan is created on the fly during execution due to the analysis of intermediate results.  The lack of a classic explain does not interfere with the work, but is more familiar with it. <br><br>  Fast, comfortable, stable, does not require long tuning - set and forget.  In general, some kind of all correct.  But the black box is alarming. <br><br>  Separately, I would like to note the adequacy of support, which promptly answered absolutely all of our questions. <br><br><h5>  Memsql </h5><br>  Put simply and quickly.  Admin is beautiful, but not very clever.  Examples: you can add nodes to the cluster, but you cannot / remove / unclear from the admin panel;  You can see the current and completed requests, but no details about them can be seen. <br><br><img src="https://habrastorage.org/files/926/088/2cc/9260882ccd364c74a92c5982a9cd272f.png"><br>  <i>You can tweet the number of records per second in the admins memsql</i> <br><br>  When working, MemSQL loves to load processors, there were almost no memory overflow errors. <br><br>  MemSQL, before joining two tables, does repartitioning (redistributing data across nodes) using the join join key. <br><br>  In our case, we can store the data_bal table and date with a complex shard key (account_rk, valid_from_dt), for the scd table, the sharding key will be (account_rk, scd_valid_from_dt).  In this case, the connection between data_bal and date will occur quickly, then when the query is executed, the data will be redistributed to account_rk and scd_valid_from_dt, and in the next step, by account_rk to connect to the financial_account table.  As support says, repartitioning is a very time consuming operation. <br><br>  Thus, our requests were heavy for the database due to the large number of diverse join-s.  In Greenplum, joins between the listed tables occur locally, and, accordingly, faster, without redistribution over the nodes, the so-called Redistribute Motion. <br><br>  In general, MemSQL seems to be an excellent database for migrating from MySQL and not the most complicated analytics. <br><br><h5>  Impala </h5><br>  The installation of the Cloudera cluster, which includes Impala, is fairly simple and well documented. <br><br>  However, it is worth noting that the performance of Impala relative to other databases did not differ - for example, a query that counted count (*) in d_financial_account_not_additive, worked in Impala for 3.5 minutes, which is significantly more than that of rivals whose results are tens of seconds and less. <br><br>  We also conducted an interesting experiment: as was written earlier, in view d_financial_account_not_additive there are two join-a.  In each of them, the account_rk is connected with the integer data type, and also along the date data type fields.  Impala does not have date data type, so we used timestamp.  For the sake of interest, a timestamp was replaced with a bigint in which the unix timestamp was stored.  The result of the query immediately improved for a minute.  In the next step, the data from the account_rk and the date fields, this is valid_from_dt and scd_valid_from_dt, were combined to provide a join for only one field.  This was done in an uncomplicated way: <br><br><pre> <code class="sql hljs">account_valid_from = account_rk * 100000 + cast(unix_timestamp(valid_from_dt)/86400 as int)</code> </pre> <br>  Join one field gave us about half a minute more gain, but in any case it is several times more than other DBMS. <br><br>  Basic queries worked several times longer.  N2 request fell due to lack of memory, so there are no results for it. <br><br>     Impala       hash-,            . <br><br><h4>  Instead of conclusion </h4><br>           ¬´      -  -,    ‚Äî <s>   </s>  -  -,    ¬ª,   . ,    -          ETL  BI,  - ‚Äî     . <br><br>   ,    ,    ,         BI-. <br><br>      ,  : <br><br> ‚Äî   <br> ‚Äî   (aka 4etvegr) <br> ‚Äî   <br> ‚Äî   (aka kapustor) <br><br> ,     ,    Virtua Hamster (      Sega 32). </div><p>Source: <a href="https://habr.com/ru/post/310620/">https://habr.com/ru/post/310620/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../310608/index.html">Why is it profitable to create a payment business in Europe</a></li>
<li><a href="../310612/index.html">Finding out how to increase WiFi coverage</a></li>
<li><a href="../310614/index.html">IL2CPP: method calls</a></li>
<li><a href="../310616/index.html">Data Leaks in Health: The New Plague</a></li>
<li><a href="../310618/index.html">Masking Bitmaps on Android</a></li>
<li><a href="../310622/index.html">Using Google Cloud Speech API v2 in Asterisk to recognize Russian speech</a></li>
<li><a href="../310626/index.html">Little about energy technology and IT</a></li>
<li><a href="../310628/index.html">"Friday and the sea knee-deep": 5 skills that do not require talent</a></li>
<li><a href="../310630/index.html">"To moderate appetites": Several ways to improve the energy efficiency of data centers</a></li>
<li><a href="../310632/index.html">IaaS Digest: 25 Materials on Technology and Business Transformation</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>