<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Arch Linux: Samba root partition</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Greetings, friends! 
 Today I will not tell you why I love Arch Linux, you will see for yourself. 

 Task 
 - install Arch Linux so that the root part...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Arch Linux: Samba root partition</h1><div class="post__text post__text-html js-mediator-article">  Greetings, friends! <br>  Today I will not tell you why I love Arch Linux, you will see for yourself. <br><br><h4>  Task </h4><br>  - install Arch Linux so that the root partition is mounted over the network from a Samba server <br><br><h4>  Decision </h4><br>  To solve this problem, we need: <br>  - installed Arch Linux (or LiveCD) <br>  - mkinitcpio-mount-hook from AUR (http://aur.archlinux.org/packages.php?ID=40372) <br>  - a couple more small hooks: mount.cifs and mount.loop <br>  - extra / devtools (contains mkarchroot) <br>  - core / mkinitcpio-nfs-utils (this package contains utilities and scripts to get the IP address) <br>  - collecting script <br><a name="habracut"></a><br>  1. And I will start with the last one. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      <b>build.sh</b> <br><pre><code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#!/bin/bash -e chroot_path=/tmp/chroot # Install base and some needed packages mkarchroot -f $chroot_path base mkinitcpio-nfs-utils # This adds cifs and loop modules to the initcpio image cp mount.cifs mount.loop -t $chroot_path/lib/initcpio/install # Add mount hook (http://aur.archlinux.org/packages.php?ID=40372) wget "http://people.oh14.de/andrej/mkinitcpio-mount-hook/mkinitcpio-mount-hook-0.3-stickbuild.tar.xz" -O - | tar -xJ --wildcards -C /tmp mkinitcpio-mount-hook-0.3/initcpio/*/mount cp -r /tmp/mkinitcpio-mount-hook-0.3/initcpio/* -t $chroot_path/lib/initcpio # Remove hard drives support and keep only needed hooks (added: net, mount, mount.cifs, mount.loop) sudo sed -i 's/^HOOKS=".*"/HOOKS="base udev net filesystems mount mount.cifs mount.loop"/' $chroot_path/etc/mkinitcpio.conf # Keep only one initcpio image (we don't need fallback) sed -i "s/^PRESETS=.*/PRESETS=('default')/" $chroot_path/etc/mkinitcpio.d/kernel26.preset # Adapt network configuration for network-based root sed -i 's/^DHCPCD_ARGS="-q"$/DHCPCD_ARGS="-q -p"/' $chroot_path/etc/conf.d/dhcpcd sed -i 's/^interface=$/interface=eth0/' $chroot_path/etc/rc.conf sed -i 's/^NETWORK_PERSIST="no"$/NETWORK_PERSIST="yes"/' $chroot_path/etc/rc.conf # Rebuild initcpio image mkarchroot -r "mkinitcpio -p kernel26" $chroot_path</span></span></code> </pre> <br><br>  With the first command, we create a chroot environment and install packages from the base group, mkinitcpio-nfs-utils into it, and here you can add any other packages as desired.  The second command adds support for cifs and loop devices in initrcpio.  The third command extends the ability to mount the root partition.  The fourth disables support for physical hard drives from initcpio and connects our hooks for cifs, loop and extended mount.  The fifth command disables the fallback initcpio image, we do not need it, because  we do not use autodetection when building.  The sixth team sets up a new system so that the network, upon shutdown, does not turn off prematurely.  And the last command reassembles initcpio, already with network support, cifs, loop, extended mount and no support for local hard drives. <br><br>  2. The following two files include the modules needed for cifs (samba) and loop (mounting the disk image) in initcpio. <br><br>  <b>mount.cifs</b> <br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># vim:set ft=sh: install () { MODULES="cifs hmac md4 md5" BINARIES="" FILES="" SCRIPT="" } help () { cat &lt;&lt;HELPEOF This hook helps to mount cifs. HELPEOF }</span></span></code> </pre><br><br>  <b>mount.loop</b> <br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># vim:set ft=sh: install () { MODULES="loop" BINARIES="" FILES="" SCRIPT="" } help () { cat &lt;&lt;HELPEOF This hook helps to mount loop images. HELPEOF }</span></span></code> </pre><br><br>  This is enough to build chroot and initcpio, but we need to put the chroot into a disk image.  This is necessary in order not to puzzle over the support of acl, symlinks and hardlinks on the Samba server.  Plus, the disk image is also in the fact that as a server we can use not only Linux, but also Windows. <br><br>  3. Create a 1Gb file, format it, for example, under ext4 and mount it in / tmp / chroot: <br><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#!/bin/bash -e dd if=/dev/null of=/tmp/arch.img bs=1M seek=1024 mkfs.ext4 -F /tmp/arch.img mkdir /tmp/chroot mount /tmp/arch.img /tmp/chroot</span></span></code> </pre><br><br>  4. Now you can run build.sh.  After the script has completed, we need to copy the files / tmp / chroot / boot / vmlinuz26 and /tmp/chroot/boot/kernel26.img (they are still useful to us) and unmount the image. <br><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#!/bin/bash -e cp /tmp/chroot/boot/{vmlinuz26,kernel26.img} /tmp umount /tmp/arch.img</span></span></code> </pre><br><br>  5. Is that all?  Yes that's all.  Well, almost everything.  Now it remains to find out how to load all this.  For this you need: <br>  1) take our /tmp/arch.img and place it on some Samba server; <br>  2) decide on the boot method (CD-ROM, PXE, Grub, or whatever you think of yourself); <br>  3) copy / tmp / chroot / boot / vmlinuz26 and /tmp/chroot/boot/kernel26.img to where you will boot from. <br><br>  <b>Boot Parameters</b> : <br> <code># grub <br> kernel /boot/vmlinuz26 ip=::::::dhcp mounts=cifs,root cifs_dev=//SERVER_IP/share cifs_target=/cifs cifs_type=cifs cifs_opts=username=guest root_dev=/cifs/arch.img root_type=ext4 <br> initrd /boot/kernel26.img <br> <br> # isolinux/pxelinux <br> kernel vmlinuz26 <br> append initrd=kernel26.img ip=::::::dhcp mounts=cifs,root cifs_dev=//SERVER_IP/share cifs_target=/cifs cifs_type=cifs cifs_opts=username=guest root_dev=/cifs/arch.img root_type=ext4 <br></code> <br><br>  <b>Note</b> : Pay attention to the parameter for username = guest.  If you do not want the directory to be accessible to everyone, then instead of username = guest you can specify a specific account and password. <br><br><h4>  Result </h4><br>  We got a system that is loaded as follows: <br>  1) vmlinuz26 is launched locally with kernel26.img (these files can be on a hard disk, on a CD, on a tftp server); <br>  2) the network directory is mounted // SERVER_IP / share in the directory / cifs; <br>  3) /cifs/arch.img is mounted as the root partition and the system continues to boot. <br><br>  Approximately in the same way you can place an image on nfs.  The experiment was also carried out with aufs, when the image file is mounted read-only, and the changes are written in tmpfs, but unfortunately, support for aufs is excluded in the current kernel. </div><p>Source: <a href="https://habr.com/ru/post/122708/">https://habr.com/ru/post/122708/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../122700/index.html">Documentation according to GOST 34 * is just</a></li>
<li><a href="../122702/index.html">Impressions from Rysyov's training in sales organization and marketing</a></li>
<li><a href="../122704/index.html">Five reasons why domains become less important</a></li>
<li><a href="../122705/index.html">Deep immersion in positioning</a></li>
<li><a href="../122706/index.html">Internet users actions in 60 seconds in the world</a></li>
<li><a href="../122710/index.html">Zend_Soap_AutoDiscover and eAccelerator</a></li>
<li><a href="../122711/index.html">Educational program for pseudo-random generators</a></li>
<li><a href="../122712/index.html">Dividers (separators) for the Chrome bookmarks bar</a></li>
<li><a href="../122714/index.html">Debian 6.0 Update: Debian 6.0.2 Released</a></li>
<li><a href="../122716/index.html">ZTD: Zen Tudu - an ultra-simple productivity system</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>