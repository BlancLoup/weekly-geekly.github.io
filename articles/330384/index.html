<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>A few words about "our" microcontroller</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="The article will discuss the domestic MK company Milandr 1886VEU, there will be quite a bit of code and a lot of whining. 

 This MC is built on the P...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>A few words about "our" microcontroller</h1><div class="post__text post__text-html js-mediator-article"><div style="text-align:center;"><img src="https://habrastorage.org/web/6a2/493/1e4/6a24931e49b24cc49beb5ef1c04a86e2.jpg"></div><br>  The article will discuss the domestic MK company Milandr 1886VEU, there will be quite a bit of code and a lot of whining. <br><br>  This MC is built on the PIC17 core, which is noticeable when developing - since I already have a solid code base for the PIC, it was a bit easier for me to start.  Also under this MC you can purchase a debug board - I will write a few words about it too. <br><br>  I will tell you what problems I encountered while developing the firmware, what I liked and what did not.  Everything written is my personal subjective opinion, therefore, I will immediately make a reservation, perhaps problems will be described that are not problems at all, but even very specific features that could have been avoided if I had a lot of development experience. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      So let's go. <br><a name="habracut"></a><br>  The first thing that anyone who wants to use in their developments MK from Milandra will face in 2017 will be the difficulties with the purchase.  Without even mentioning the price, you will most likely need at least some legal entity for this.  At least, when I called them in the marketing department and found out about the purchase as an individual, they made it clear to me that in this case it would be easier for me to find some supplier (prices that are even higher).  In general, with marketing everything is sad.  On the other hand, they have already updated the site, maybe they will reach their marketing policy somehow. <br><br><h3>  Clumsy documentation </h3><br>  Despite the fact that 1886VE5U was released at least five years ago, the ‚Äúchildhood diseases‚Äù have not gone away.  When reading technical documentation, it creates the feeling that they were doing it hastily.  No, the critical information is there, in principle, present, except that it is rather strangely structured.  There are occasional typos in the text, and, in my opinion, the structure of the document itself does not shine with consistency.  As a result, when developing, instead of studying a single document, periodically you have to rush between several open windows or look for the currently needed fragments in the main datasheet, which can be located in the document far enough from each other, even if they belong to a single chip unit. <br><br>  For example, it is strange that the manual for the firmware of the chip is in a separate document.  It may be convenient in some cases, but why not make a separate chapter or annex to the main datasheet? <br><br>  By way of illustration I will give one example.  To calculate the speed of the CAN interface, we are offered to use several formulas. <br><br>  When calculating it turns out that the final formula, in fact, will have five parameters ( <code>BRP, PRSEG, SEG1, SEG2, Fosc</code> ).  The formula itself and the dependence of the parameters on the values ‚Äã‚Äãof the bits in the registers are separated by fifteen pages.  As a result, it is easier to make a screen with a table of register values ‚Äã‚Äãand open it in the paint while you are working with the formula. <br><br>  In general, even the approach with formulas is still izwart.  A clear formula is, of course, fine, but each time recounting values ‚Äã‚Äãin the mind or on a piece of paper is something else fun.  For example, I finally wrote down the formula in Mathcad and counted it in it. <br><br>  Question to the compilers of the documentation - actually, what was the problem to add just a couple of pages with tables containing basic values ‚Äã‚Äãfor several values ‚Äã‚Äãof the parameters?  There is no need to go far for an example - even in the PIC documentation there are such tables, for example, in the sections on setting the UART speed. <br><br>  By the way, I would like to separately note an interesting point, perhaps, it will be useful for someone for the future.  I do not consider myself to be a CAN interface expert, it is quite possible that this is true for any CAN device, and not only in this particular case.  It is also possible that this feature is inherited from the PIC17, although I could not immediately find the PIC17 with the CAN interface. <br><br>  In general, if we have two devices on the 1886BVEU, one of which works at 16 MHz (a debugging board, for example), and the second at 10 MHz (our piece of hardware), then we will most likely connect them at a low speed, and it is not a fact.  And that's why. <br><br>  Firstly, the maximum speed (for a piece of hardware operating at 10 MHz) with all the dividers turned off is limited to 390.6 kbit / s. <br><br>  Secondly, at 10 MHz, the change resolution is such that, for example, standard 250, 125 or 100 kbit / s cannot be obtained.  According to calculations, the closest is obtained, for example, 104.2 kbit / s ( <code>BRP=1, PRSEG=1, SEG1=5, SEG2=5</code> ).  In general, an error of a few% will somehow be present.  I already wrote above - for the present I am not dofig special in this protocol, it is possible that it will work with such an error at low speeds - in the end, this bus has a very large margin on the reliability of data transfer. <br><br>  As a result, it turned out to be faster to change the 16 MHz resonator on its board.  Anyway, I didn‚Äôt have the opportunity to check the work at low speeds, and why - I‚Äôll tell you in the next paragraph. <br><br><h3>  The inability to edit the source code of the firmware for the debug board </h3><br>  In general, the whole "demo program" for working with a debugging board on a PC (it is called, for some reason, <i>Eval12.exe</i> ) is quite poor.  From the settings there are literally only the parameters of the COM port, through which you will be connected with the board, that's all.  Well, that is, everything.  CAN speed cannot be changed through it.  It is also impossible to change the parameters of the MC installed in the debug board, although this is very helpful. <br><br>  When I ran into the difference in CAN physical speeds and calculated all the possible variants using the formula, I realized that for debugging I would have to change the code of the debug board, because I can set the speed of the CAN module in the current version only in the source code when compiling. <br><br>  Next, I took the source from the folder Demo_CAN, which was on the disk with the debug card, hoping to just recompile them, setting the necessary BRP, PRSEG, SEG1, SEG2.  When trying to compile this project, the IDE produced an excellent error: <br><br> <code>" .       ."</code> <br> <br>  I didn‚Äôt understand the protection mechzyms - it‚Äôs obvious that you can use some pieces of code from the demo program and write your own, but the fact that I can‚Äôt edit the demo program‚Äôs code for the debugging board so much personally surprises me the same absurd. <br><br><h3>  Mess in header files </h3><br>  I took the folder " <i>komplekt_1886BE5 \ Demo programs</i> " from the disk that came with the debug card. <br><br>  There were separate folders with source codes of examples of working with CAN and LIN. <br>  At the same time, the following header was included in main.c of these sources: <br><br> <code>#include &lt;mil1886BE5_1.h&gt;</code> <br> <br>  Actually, in those examples where it was included, this header was in the examples folder. <br><br>  Further, following the advice of technical support (taking this opportunity, I want to thank these worthy citizens for their patience and professionalism - they helped me solve a couple of stupid questions) I downloaded IDE (Dev-C ++ some ancient version) and compiler (CC7A) from the site of Milandra. <br><br>  What was my surprise when the IDE refused to compile my source with the above header.  Then it turned out that with the compiler under my chip there is a header - <i>1886VE5.h</i> <br><br>  To use pieces of code from the source code of the demo board, we had to spend more time replacing the names of the registers with the values ‚Äã‚Äãfrom the new header.  After that, I managed to collect my program with parts from the demo examples, which worked as I expected it to. <br><br>  Probably the examples for the test samples somehow got on the disk, decide whether it is normal or not.  In technical support for this question in general, only they were surprised - they say I should not have these header files at all. <br><br>  In general, the problem is not critical, but the sediment, as they say, remains. <br><br><h3>  The environment, the compiler and them, ahem ... features </h3><br>  As a medium and compiler for the 1886BE5U, Milander suggests that we use the IDE1886 (based on Dev-C ++) bundle and CC7A.  In general, I can‚Äôt say anything particularly bad about the environment - it works fine with the programmer, the debugger also seems to debug well, except that the syntax highlighting is sad, of course.  Surely there are some plug-ins or something else, but by default it‚Äôs almost a Vindus notepad - it highlights the keys, inclusions and some keywords, the editor‚Äôs bonuses end there. <br><br>  From the small shoals of UX - my experience was not enough to figure out how I can add the register I need into the observables.  By the name of the variable and address (as described in the manual), the IDE does not add them for some reason.  It is strange that the IDE itself cannot display all the registers available for monitoring. <br><br>  One more thing, of course, rather speaks of my little developer experience, but what was my surprise when, after a few hours of tinkering with the debugger and trying to figure out why, the compiler-generated code works so strangely in the documentation that the <code>int</code> type By default, this compiler has a size of 8 bits, not 16, as is customary in the same XC8 for the PIC. <br><br>  Therefore, I say banality, but still - carefully study the documentation before developing =) <br><br>  The next feature of the compiler generally put me in a stupor for a while.  It is quite possible, here I will once again demonstrate my low competence - it may be that this compiler is just tuned to some old C standard of the year of the 90th, when this was the norm, but I just don‚Äôt know it, or something something like that.  In general, in order not to be unfounded, I will give a little code, I hope the community will judge. <br><br>  The compiler is completely incapable of digesting such a simple construction: <br><br><pre> <code class="hljs nginx"><span class="hljs-attribute"><span class="hljs-attribute">TXSTA1</span></span> = ((CSRC &amp; 0x01) &lt;&lt; <span class="hljs-number"><span class="hljs-number">7</span></span>) | ((TX9 &amp; 0x01) &lt;&lt; <span class="hljs-number"><span class="hljs-number">6</span></span>) |((TXEN &amp; 0x01) &lt;&lt; <span class="hljs-number"><span class="hljs-number">5</span></span>) |((SYNC &amp; 0x01) &lt;&lt; <span class="hljs-number"><span class="hljs-number">4</span></span>);</code> </pre><br>  To this he simply gives out the sacramental: <code>"Unable to generate code."</code> <br><br>  In order for him to understand what I want from him, I have to paint it with a banal and volume code: <br><br><pre> <code class="hljs nginx"><span class="hljs-attribute"><span class="hljs-attribute">temp0</span></span> = ((CSRC &amp; 0x01) &lt;&lt; <span class="hljs-number"><span class="hljs-number">7</span></span>); <span class="hljs-attribute"><span class="hljs-attribute">temp1</span></span> = ((TX9 &amp; 0x01) &lt;&lt; <span class="hljs-number"><span class="hljs-number">6</span></span>); <span class="hljs-attribute"><span class="hljs-attribute">temp2</span></span> = ((TXEN &amp; 0x01) &lt;&lt; <span class="hljs-number"><span class="hljs-number">5</span></span>); <span class="hljs-attribute"><span class="hljs-attribute">temp3</span></span> = ((SYNC &amp; 0x01) &lt;&lt; <span class="hljs-number"><span class="hljs-number">4</span></span>);</code> </pre><br>  Apparently, he just has a certain level of nesting of brackets, deeper than which he does not even try to parse the code and falls out with an error. <br><br>  No, well, seriously, I understand that the functionality of the compiler seems to be due to its price, but in 2017 one could already teach him how to disassemble it. <br><br><h3>  At last </h3><br>  There is another point, probably related to the architecture of the kernel.  In the description for the 1886B5U on Milandra‚Äôs site, one can find a mention that it is built on the PIC17 core.  I understand that this feature is peculiar to all controllers on the PIC17 core - when an interrupt occurs, they do not save the state of the registers, respectively, this point should be implemented programmatically if necessary.  Frankly speaking, this also struck me - really, it was impossible to implement this in hardware in 1886 BE5U. <br><br>  In general, having tried to write for this MC, I was forced to poke around in the assembler code, to figure out what kind of digits are there in the ‚ÄúRAM‚Äù window during debugging and so on.  It certainly improved my qualifications as a developer, since I began to understand a little better what was inside and how it worked.  However, after the same Microchip (which is often scolded for ‚Äúinsane‚Äù Errata), coding under ‚Äúour‚Äù MK is felt directly like programming under some 386th in DOS.  By the way, about Errata - there is nothing like Errata of this MK at all. <br><br>  I don‚Äôt diminish the dignity of our developers from Milandra - the piece of hardware itself seems to be working right for me, but software support and development environments look as if they are doing everything in a hurry.  Returning to the question raised in the heading - comparing IDE1886 with the same MPLAB is by no means in favor of the first.  The only advantage of IDE1886 is its compactness and the ability to work without installation, but I don‚Äôt think these are critical moments. <br><br>  I really hope that over the next few years, developers will be able to tighten this figure to the level of leading brands. </div><p>Source: <a href="https://habr.com/ru/post/330384/">https://habr.com/ru/post/330384/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../330370/index.html">What is exclusive blockchains?</a></li>
<li><a href="../330372/index.html">Implementing Lean tools in the Service Desk command</a></li>
<li><a href="../330374/index.html">Working with peripherals from JavaScript: from theory to practice</a></li>
<li><a href="../330376/index.html">Smart Integration Plugs</a></li>
<li><a href="../330382/index.html">Huginn: a simple integration platform</a></li>
<li><a href="../330386/index.html">MySQL 8, Postgres NoSQL, Tarantool Vinyl, CockroachDB, ClickHouse, and yet, why did Uber leave Postgresql?</a></li>
<li><a href="../330394/index.html">Notepad ++: code verification five years later</a></li>
<li><a href="../330396/index.html">Integration of telephony with CRM: what to rely on when self-tuning</a></li>
<li><a href="../330398/index.html">Awless is a powerful alternative CLI utility for working with AWS services.</a></li>
<li><a href="../330400/index.html">Typed components in Vue.js, or how to make friends Vue, TypeScript and Webpack</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>