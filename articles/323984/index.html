<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Two DHCP servers on Centos7 with failover, dhcp-relay and dynamic zone update</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Greetings to all habrayuzerov. My first experience of writing articles on Habr√©, so any constructive criticism is welcome. I decided to write only bec...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Two DHCP servers on Centos7 with failover, dhcp-relay and dynamic zone update</h1><div class="post__text post__text-html js-mediator-article">  Greetings to all habrayuzerov.  My first experience of writing articles on Habr√©, so any constructive criticism is welcome.  I decided to write only because I recently faced a task that I could not find a solution to. <br><br>  The essence of the task is that in a large organization a fault-tolerant DHCP server was needed, with dhcp-relay and the ability to quickly synchronize the configuration.  The main point is that in most of the manuals I have found, either the failover option or dhcp-relay is considered, and nowhere both options are considered together and even with the convenient configuration synchronization method.  Suddenly, to whom my article will help a little? <br><a name="habracut"></a><br>  The essence of the problem is as follows: there is a large enterprise, a network of&gt; 1000 computers, a single vlan, 2 domain controllers, there is no dhcp in the network (!).  The previous admins could only do this, but this is a separate story and not for Habr. <br><br>  It is clear that the first task was to upgrade the network, namely segmentation into vlan and implementation of dhcp.  When analyzing the tasks, the following requirements were developed: 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <ul><li>  Fault tolerance - independence of any iron </li><li>  Considering the plans for network segmentation - it is necessary that the server knows which vlan to which addressing to send </li><li>  ‚ÄúReplication‚Äù - considering that it is planned to use dhcp ‚Äúbindings‚Äù by MAC, it is necessary that these ‚Äúbindings‚Äù always work (for example, network printers) </li><li>  Automatic maintenance of reverse DNS zones </li></ul><br>  I will not describe the long reflections and readings of various articles and manuals, I quote the final working solution: <br><br><ul><li>  Two virtual machines on two different hypervisors </li><li>  On machines worth <b>centos7</b> and <b>isc-dhcpd</b> </li><li>  On dhcp configured failover, dynamic update zones and recognition option 82 </li><li>  Option 82 tagged the VLAN from which the request came, give the server the central L3 + switches, on which all VLANs are distributed </li><li>  Since most admins are poorly oriented in linux and vim, we need to automate the process of adding static bindings and the configuration replication mechanism </li></ul><br>  Network layout: <br><br><img src="https://habrastorage.org/files/760/aee/1d1/760aee1d17064d6a99b068388529366a.png" alt="image"><br><br>  We have: <br><br><ul><li>  <b>DC0</b> and <b>DC1</b> with configured DNS servers, 10.1.2.2 and 10.1.2.3 </li><li>  <b>DHCP0</b> and <b>DHCP1</b> , 10.1.2.4 and 10.1.2.14 </li><li>  User VLANs: 10, 11, 20, 21 </li><li>  Domain <b>corp.example.ru</b> </li><li>  Additional DNS zone (for linux servers) - <b>example.lan</b> </li><li>  Routers based on L3 switches with <b>dhcp option 82</b> support.  In all VLANs they have the 1st IP address, connected via OSPF </li></ul><br>  Since some things are quite trivial and are described on the Internet more than once, I will not describe them in detail. <br><br><ol><li>  To begin with, we create all reverse zones for all VLANs in Windows DNS, allow unsafe updates for zones. <br><br></li><li>  Install the minimum centos 7 on virtual machines, install the dhcp package. <br><br></li><li>  We configure DHCP-relay on managed switch interfaces.  At the same time, the string ‚ÄúVLAN10‚Äù, etc. comes as the <b>circuit-id</b> <br><br></li><li>  Editing <b>/etc/dhcp/dhcpd.conf</b> <br><br><pre><code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># DHCP Server Configuration file. # see /usr/share/doc/dhcp*/dhcpd.conf.example # see dhcpd.conf(5) man page # # ddns-update-style interim; #   ddns-domainname "corp.example.ru"; #    update-static-leases on; #    local-address 10.1.2.4; #   #  ,     DHCP-relay if exists agent.circuit-id { log ( info, concat( " Accepted DHCP RELAY request for ", binary-to-ascii (10, 8, ".", leased-address), " Network segment: ", option agent.circuit-id, " DHCP Agent: ", option agent.remote-id)); } # this DHCP server to be declared valid authoritative; #   failover peer "dhcp-failover" { primary; #    address 10.1.2.4; #   port 519; #   peer address 10.1.2.14; #   DHCP peer port 520; #   DHCP #    max-response-delay 30; max-unacked-updates 10; load balance max seconds 3; mclt 1800; split 128; #       DHCP  #     , #    ""    . auto-partner-down 86400; #    @baf28 } #      option domain-name "corp.example.ru"; # DNS- option domain-name-servers 10.1.2.2, 10.1.2.3; #  DNS-.    Windows- option domain-search "example.lan corp.example.ru"; #    default-lease-time 604800; # 7 days max-lease-time 2419200; # 4 weeks # default netmask /24 option subnet-mask 255.255.255.0; # Servers vlan -  DHCP subnet 10.1.2.0 netmask 255.255.255.0 { } #     VLAN' include "/etc/dhcp/dhcpd.d/vlan10.conf"; include "/etc/dhcp/dhcpd.d/vlan11.conf"; include "/etc/dhcp/dhcpd.d/vlan20.conf"; include "/etc/dhcp/dhcpd.d/vlan21.conf";</span></span></code> </pre> <br></li><li>  Now we add a configuration file for each VLAN (using the example of <b>/etc/dhcp/dhcpd.d/vlan10.conf</b> ) <br><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#       zone 10.1.10.in-addr.arpa. { primary 10.1.2.2; secondary 10.1.2.3; } #       DHCP-relay class "VLAN10" { match if option agent.circuit-id = "VLAN10"; } #     subnet 10.1.10.0 netmask 255.255.255.0 { option routers 10.1.10.1; pool { failover peer "dhcp-failover"; #   ,  failover  range 10.1.10.51 10.2.56.254; #  allow members of "VLAN10"; #    } # === Static hosts # Admin host admin { hardware ethernet 01:23:45:67:89:ab; fixed-address 10.1.10.20; } # Admin's printer host admin { hardware ethernet cd:ef:01:23:45:67; fixed-address 10.1.10.21; } #        , #           # Insert automatic text above this }</span></span></code> </pre><br></li><li>  For the second DHCP server we create similar configs, we only fix it in the main file: <br><br><pre> <code class="bash hljs">failover peer <span class="hljs-string"><span class="hljs-string">"dhcp-failover"</span></span> { secondary; <span class="hljs-comment"><span class="hljs-comment">#    address 10.1.2.14; #   port 520; #   peer address 10.1.2.4; #   DHCP peer port 519; #   DHCP #    max-response-delay 30; max-unacked-updates 10; load balance max seconds 3; #       DHCP  #     , #    ""    . auto-partner-down 86400; #    @baf28 }</span></span></code> </pre> </li></ol><br>  We got 2 dhcp servers, if one of them disconnects, its function picks up the second, while both respond to requests from the dhcp relay agent and, based on the line set in dhcp option 82, circuit-id (in our case, the VLAN name) gives each segment his range. <br><br>  To replicate servers, just write a script that synchronizes the files in the "/etc/dhcp/dhcpd.d/" directory and restarts the dhcp-daemon after that.  I will not bring the script myself because of a very ‚Äúcrutch‚Äù code that was written on my knee and very quickly.  It is possible to synchronize configs using a utility like csync2 or rsync. <br><br>  To add static bindings, a separate script was also written, which I am ashamed to bring here for the same reasons.  Anyone can frolic with it himself or add static bindings "handles". <br><br>  The only "but" - when adding a new VLAN, the main configuration file <b>"/etc/dhcp/dhcpd.conf"</b> will have to be <b>controlled by</b> handles, since I could not make <b>include</b> for the whole directory, only for specific files. <br><br>  Perhaps this can be bypassed with a double include: first, in the main file, to an auxiliary file, and in the auxiliary file, to specific VLAN files, and then to synchronize the auxiliary file, but I did not bother. <br><br>  I repeat once again - most of the information I described on the Internet is in bulk, but nowhere have I found how to combine failover, dhcp-relay and make it convenient for synchronization.  Waiting for your comments and suggestions. </div><p>Source: <a href="https://habr.com/ru/post/323984/">https://habr.com/ru/post/323984/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../323974/index.html">Want to know everything about web and mobile development? Ask me how: DevCon School IV</a></li>
<li><a href="../323976/index.html">How to wake up an application in iOS: on schedule and not</a></li>
<li><a href="../323978/index.html">Intel and Google - we are friends "clouds"</a></li>
<li><a href="../323980/index.html">Cloud Digest: 35 materials on information security and data center technology development</a></li>
<li><a href="../323982/index.html">How to extend the functionality of an application hosted on the Mac Store using Apple Script</a></li>
<li><a href="../323986/index.html">Conference Axis Tel Aviv 2017, Israel (day one)</a></li>
<li><a href="../323988/index.html">Conference Axis Tel Aviv 2017, Israel (second day)</a></li>
<li><a href="../323990/index.html">Dealer Mobility Ecosystem: How We Made Friends of Official Dealers With Their Customers</a></li>
<li><a href="../323992/index.html">Frequently used passwords: how not to get caught yourself and protect users</a></li>
<li><a href="../323994/index.html">How much does a cloud office cost</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>