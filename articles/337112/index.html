<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>We broadcast WebRTC, RTSP and RTMP streams to Media Source Extensions via Websocket protocol</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Media Source Extensions 
 Media Source Extensions (hereinafter MSE) is a browser API that allows you to play audio and video through the corresponding...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>We broadcast WebRTC, RTSP and RTMP streams to Media Source Extensions via Websocket protocol</h1><div class="post__text post__text-html js-mediator-article"><div style="text-align:center;"><img src="https://habrastorage.org/web/c17/a31/68d/c17a3168da234e11a202a7b661d39631.jpg"></div><br><h2>  Media Source Extensions </h2><br>  Media Source Extensions (hereinafter MSE) is a browser API that allows you to play audio and video through the corresponding HTML5 tags &lt;audio /&gt; and &lt;video /&gt;. <br><br>  To play a piece of audio or video, you need to feed this chunk to this element through the MSE API.  Based on MSE built HLS-players.  HLS fragments are transmitted to MSE and displayed in the player. <br><br>  Let's take a look at its <a href="https://caniuse.com/">Can I Use</a> for details. <a name="habracut"></a>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <div style="text-align:center;"><img src="https://habrastorage.org/web/ec9/743/624/ec97436243194e87bbef33a04a710160.png"></div><br>  As the table shows, MSE is supported in all recent browsers except iOS Safari and Opera Mini.  In this regard, it is <a href="https://caniuse.com/">very similar</a> to WebRTC, and even bypasses WebRTC for accessibility in Safari and IE.  I must say that Safari 11 already has WebRTC, but it has not yet been released at the time of this writing. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/web/124/655/e3e/124655e3ebf34cdc8ec5d9407dd65409.png"></div><br>  It should be noted that MSE and WebRTC are technologies of different weight categories.  Roughly speaking, MSE is only a player, and WebRTC is both a player and a streamer and calls (low latency real-time streaming). <br><br>  Thus, if you need only a player and no real-time requirements (delays less than 1 second), then MSE is a good choice for playing video streams.  If you need real-time and without plug-ins, then there are no options.  Need to take WebRTC. <br><table><tbody><tr><td><p>  <b>Media Source Extensions</b> </p><br></td><td><p>  <b>Webrtc</b> </p><br></td></tr><tr><td>  Player only </td><td>  Player and Streamer </td></tr><tr><td>  Average delay </td><td>  Realtime (delay less than 1 second) </td></tr></tbody></table><br><h2>  WebRTC to MSE </h2><br>  Suppose WebRTC acts as a tape drive.  This means that the browser or mobile application sends a video stream to the server. <br><br>  The fastest way to pick up a video stream in MSE is to connect to the server using the Websocket protocol and deliver the stream to the browser.  In the player, parse the received stream and transfer it to MSE for playback. <br><br>  Broadcast scheme: <br><br><ol><li>  The browser of the broadcaster sends the stream H.264 + Opus to the WebRTC server </li><li>  WebRTC server distributes stream via Websocket H.264 + AAC protocol </li><li>  The viewer browser opens the stream and gives H.264 and AAC frames to play back in MSE. </li><li>  The player plays audio and video. </li></ol><br>  Thus, when using Media Source Extensions as a player, the video part of the WebRTC stream with the H.264 codec passes to the player without transcoding (proxied), which helps keep CPU utilization low on the server. <br><br>  The Opus audio codec is transcoded into AAC for successful reading in MSE, but audio transcoding is much less resource intensive than video. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/web/b59/cf1/4bd/b59cf14bdef04702ba4f2feccb8f3c4d.jpg"></div><br><br><h2>  Examples </h2><br>  These examples of tape drive and MSE player use Web Call Server 5 as a server that converts a WebRTC video stream for use in Media Source Extensions. <br><br>  As a streamer, we use the <a href="https://wcs5-eu.flashphoner.com/demo2/two-way-streaming">Two Way Streaming web application</a> , which sends a WebRTC video stream to the server. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/web/b16/6b0/ff9/b166b0ff9ec14da5a547d051faa408a4.jpg"></div><br>  As a player, we use a <a href="https://wcs5-eu.flashphoner.com/client2/examples/demo/streaming/player/player.html%3FmediaProvider%3DMSE">test player</a> with support for Websockets and MSE. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/web/d04/98c/eab/d0498ceabb8f45788f822486d2cc0647.jpg"></div><br>  The MSE player code works through a high-level API. <br><br>  Create a div element on the HTML page <br><br><pre><code class="html hljs xml"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">id</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"myMSE"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">style</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"width:640;height:360"</span></span></span><span class="hljs-tag">&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre> <br>  And then call the playback of the video stream. <br><br>  Passing the div to the element with the display parameter and the MSE player will be inserted into this div block. <br><br><pre> <code class="html hljs xml">session.createStream({name:"stream22",display:document.getElementById("myMSE")}).play();</code> </pre> <br>  Similarly, publishing a WebRTC stream from another page works. <br><br>  The stream is assigned the unique name stream22, which will be specified during playback. <br><br><pre> <code class="html hljs xml">session.createStream({name:"stream22",display:document.getElementById("myWebCam")}).publish();</code> </pre><br>  The full code of the tape drive and player can be found on github. <br>  - <a href="https://github.com/flashphoner/flashphoner_client/tree/wcs_api-2.0/examples/demo/streaming/two_way_streaming">streamer</a> <br>  - <a href="https://github.com/flashphoner/flashphoner_client/tree/wcs_api-2.0/examples/demo/streaming/player">player</a> <br><br><h2>  RTSP to MSE </h2><br>  Another case of using MSE over Websockets is to play video from an IP camera or another system that sends a video stream over RTSP. <br><br>  An IP camera, as a rule, natively supports H.264 and AAC codecs, so the codecs completely coincide with those used on MSE.  This helps avoid transcoding, which consumes CPU resources. <br><br>  The broadcast scheme is as follows: <br><br><ol><li>  Browser requests RTSP stream. </li><li>  The server establishes a connection with the camera and requests this stream from the camera via RTSP. </li><li>  The camera sends an RTSP stream.  Streaming begins. </li><li>  The RTSP stream is converted to Websockets on the server side and down to the browser. </li><li>  The browser sends the stream to the MSE player for playback. </li></ol><br><br><div style="text-align:center;"><img src="https://habrastorage.org/web/84e/8ad/59b/84e8ad59be314032927a5992f3f4e0ec.jpg"></div><br>  To work with the RTSP stream, use the same player that we showed above.  Just set the full URL of the RTSP stream instead of the name. <br><div style="text-align:center;"><img src="https://habrastorage.org/web/4a5/181/326/4a5181326eed44d7bea6168c259e576e.jpg"></div><br>  At the time of this writing, we have tested the MSE player in Chrome, Firefox, Safari. <br><br><h2>  RTMP to MSE </h2><br>  RTMP is actually the standard for delivering live content from a user to a CDN. <br><br>  Therefore, you need to make sure that standard RTMP streams with H.264 and AAC codecs play correctly in Media Source Extensions. <br><br>  This can be quickly checked using a wirecast encoder (alternatively, you can use the FMLE, ffmpeg, OBS encoder, and others). <br><br>  1. Open Wirecast and the Output menu.  Set the server address and the name of the RTMP stream as stream44. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/web/585/080/53d/58508053d8334832b3f370c418495fe9.jpg"></div><br>  2. Stream stream to the server. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/web/672/23e/f93/67223ef93d2a484a8ef23f1c9d3dbb27.jpg"></div><br>  3. Play the stream in the MSE-player. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/web/2c4/5e0/9c6/2c45e09c659348c6a80c1ea4b6333a7c.jpg"></div><br><br><h2>  Comparison with other playback technologies </h2><br>  Now let's take a look at MSE in comparison with other video playback technologies in the browser. <br><br>  For comparison, take 4 technologies: <br><br><ul><li>  Webrtc </li><li>  Flash </li><li>  Hls </li><li>  Canvas + Web Audio </li></ul><br><table><tbody><tr><td></td><td><p>  <b>MSE</b> </p><br></td><td><p>  <b>Webrtc</b> </p><br></td><td><p>  <b>Flash</b> </p><br></td><td><p>  <b>Hls</b> </p><br></td><td><p>  <b>Canvas</b> </p><br></td></tr><tr><td>  Chrome, Firefox support </td><td><p>  Yes </p><br></td><td><p>  Yes </p><br></td><td><p>  Yes </p><br></td><td><p>  Yes </p><br></td><td><p>  Yes </p><br></td></tr><tr><td>  IOS Safari support </td><td><p>  Not </p><br></td><td><p>  Not </p><br></td><td><p>  Not </p><br></td><td><p>  Yes </p><br></td><td><p>  Yes </p><br></td></tr><tr><td>  Mac Safari Support </td><td><p>  Yes </p><br></td><td><p>  Not </p><br></td><td><p>  Yes </p><br></td><td><p>  Yes </p><br></td><td><p>  Yes </p><br></td></tr><tr><td>  Delay </td><td><p>  3 </p><br></td><td><p>  0.5 </p><br></td><td><p>  3 </p><br></td><td><p>  20 </p><br></td><td><p>  3 </p><br></td></tr><tr><td>  Full HD resolution </td><td><p>  Yes </p><br></td><td><p>  Yes </p><br></td><td><p>  Yes </p><br></td><td><p>  Yes </p><br></td><td><p>  Not </p><br></td></tr></tbody></table><br><p>  Thus, if you need to play the live stream in a browser with a slight delay, MSE is a good solution, replacing Flash in the latest browsers. </p><br><p>  If the delay is absolutely not important, you should use HLS, as the most universal option. </p><br><p>  If low latency is critical, you need to use a combination of WebRTC, Flash, Canvas, MSE to cover most browsers. </p><br><p>  The delay should be less than 1 second and without plug-ins, use WebRTC. </p><br><br><h2>  Links </h2><br>  <a href="https://wcs5-eu.flashphoner.com/demo2/two-way-streaming">Two Way Streaming</a> - demo webRTC streaming to server <br>  <a href="https://github.com/flashphoner/flashphoner_client/tree/wcs_api-2.0/examples/demo/streaming/two_way_streaming">Source</a> - source code of the WebRTC stream stream <br><br>  <a href="https://wcs5-eu.flashphoner.com/client2/examples/demo/streaming/player/player.html%3FmediaProvider%3DMSE">Player</a> - demo player with support for Media Source Extension <br>  <a href="https://github.com/flashphoner/flashphoner_client/tree/wcs_api-2.0/examples/demo/streaming/player">Source</a> - MSE support source code <br><br>  <a href="https://flashphoner.com/">Web Call Server 5</a> - a server that supports WebRTC and RTSP broadcasts with stream conversion for Media Source Extensions <br><br>  <a href="https://caniuse.com/">Can I Use MSE</a> - browsers that support MSE <br>  <a href="https://caniuse.com/">Can I Use WebRTC</a> - browsers that support WebRTC </div><p>Source: <a href="https://habr.com/ru/post/337112/">https://habr.com/ru/post/337112/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../337100/index.html">Be careful with what you measure - MJIT vs TruffleRuby: 2.1 times slower or 4.2 times faster</a></li>
<li><a href="../337102/index.html">BFQ I / O scheduler better</a></li>
<li><a href="../337106/index.html">Meeting in St. Petersburg "The role of the analyst in making important product decisions"</a></li>
<li><a href="../337108/index.html">Test asynchronous code with PyTest (translation)</a></li>
<li><a href="../337110/index.html">Getting rid of the RecyclerView.Adapter routine with DataBinding</a></li>
<li><a href="../337114/index.html">We embed WebRTC player for live broadcasts from webcams and IP cameras</a></li>
<li><a href="../337116/index.html">Overview of all Chrome DevTools developer tools</a></li>
<li><a href="../337118/index.html">Avito Automation meetup - slides, video, reviews, photos</a></li>
<li><a href="../337120/index.html">Browser browser discord, or Corporate Infrastructure Weekdays</a></li>
<li><a href="../337122/index.html">QIWI Server Party: DevOps beer is not a hindrance</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>