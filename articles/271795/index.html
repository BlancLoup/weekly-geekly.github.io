<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Use TSQL to play Baldu</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Recently, I remembered the wonderful intellectual game " Balda ", which I had met in my school years. 

 The other day I wondered - how difficult woul...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Use TSQL to play Baldu</h1><div class="post__text post__text-html js-mediator-article">  Recently, I remembered the wonderful intellectual game " <a href="https://ru.wikipedia.org/wiki/%25D0%2591%25D0%25B0%25D0%25BB%25D0%25B4%25D0%25B0_(%25D0%25B8%25D0%25B3%25D1%2580%25D0%25B0)">Balda</a> ", which I had met in my school years. <br><br>  The other day I wondered - how difficult would it be to implement the algorithm of this game for a computer opponent? <br><br>  Since I like working with relational data the most and my favorite language is SQL, I decided to combine business with pleasure and try to write this algorithm using only TSQL.  This is my first attempt to write AI using only SQL capabilities. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Archive files can be downloaded from the following link - <a href="">scripts</a> . <br>  All words in the dictionary in uppercase, as well as in it the letters "E" and "E" are considered as one (as "E"). <br><br>  <b>As a result, the following scheme was created:</b> <br><img src="https://habrastorage.org/files/75e/e7b/264/75ee7b2648dd499d81137559c224324f.png"><br><a name="habracut"></a><br>  <b>Description of tables:</b> <br><ul><li>  BaldaCell - Cells (i is the row number, j is the column number) </li><li>  BaldaCellLink - Links cells with other cells </li><li>  BaldaABC - Alphabet (letters used to make words) </li><li>  BaldaField - Used for the current description of the state of the playing field. </li><li>  BaldaFieldWord - Used to memorize words already used. </li><li>  BaldaWord - A dictionary used by a computer to find matching words. </li><li>  BaldaWordIndex - Auxiliary index table used for more optimal query execution </li></ul><br><br>  <b>Script for creating and filling tables:</b> <br><pre><code class="sql hljs"><span class="hljs-comment"><span class="hljs-comment">/* DROP TABLE BaldaWord DROP TABLE BaldaFieldWord DROP TABLE BaldaField DROP TABLE BaldaCellLink DROP TABLE BaldaCell DROP TABLE BaldaABC DROP TABLE BaldaWordIndex */</span></span> <span class="hljs-comment"><span class="hljs-comment">-------------------------------------------------------------------- --   -------------------------------------------------------------------- CREATE TABLE BaldaCell( ID int NOT NULL, i int NOT NULL, j int NOT NULL, CONSTRAINT PK_BaldaCell PRIMARY KEY(ID) ) GO --   DECLARE @MaxW int=5 DECLARE @MaxH int=5 --   ;WITH iCte AS( SELECT 1 i UNION ALL SELECT i+1 FROM iCte WHERE i&lt;@MaxW ), jCte AS( SELECT 1 j UNION ALL SELECT j+1 FROM jCte WHERE j&lt;@MaxH ) INSERT BaldaCell(ID,i,j) SELECT 10000+i*100+j,i,j FROM iCte CROSS JOIN jCte OPTION(MAXRECURSION 0) GO -------------------------------------------------------------------- --    -------------------------------------------------------------------- CREATE TABLE BaldaCellLink( CellID int NOT NULL, LinkCellID int NOT NULL, CONSTRAINT PK_BaldaCellLink PRIMARY KEY(CellID,LinkCellID), CONSTRAINT FK_BaldaCellLink_CellID FOREIGN KEY(CellID) REFERENCES BaldaCell(ID), CONSTRAINT FK_BaldaCellLink_LinkCellID FOREIGN KEY(LinkCellID) REFERENCES BaldaCell(ID) ) GO --   INSERT BaldaCellLink(CellID,LinkCellID) SELECT c.ID,l.ID FROM BaldaCell c JOIN BaldaCell l ON (cj=lj AND ci IN(li-1,l.i+1)) OR (ci=li AND cj IN(lj-1,l.j+1)) GO /* SELECT * FROM BaldaCellLink WHERE CellID=10303 -- 4  SELECT * FROM BaldaCellLink WHERE CellID=10503 -- 3  SELECT * FROM BaldaCellLink WHERE CellID=10105 -- 2  */ -------------------------------------------------------------------- --  -------------------------------------------------------------------- CREATE TABLE BaldaABC( Letter nchar(1) NOT NULL, CONSTRAINT PK_BaldaABC PRIMARY KEY(Letter) ) GO --    INSERT BaldaABC(Letter) VALUES (N''),(N''),(N''),(N''),(N''),(N''),(N''),(N''),(N''),(N''), (N''),(N''),(N''),(N''),(N''),(N''),(N''),(N''),(N''),(N''), (N''),(N''),(N''),(N''),(N''),(N''),(N''),(N''),(N''),(N''), (N''),(N'') GO -------------------------------------------------------------------- --    -------------------------------------------------------------------- CREATE TABLE BaldaField( CellID int NOT NULL, Letter nchar(1) NOT NULL, CONSTRAINT PK_BaldaField PRIMARY KEY(CellID), CONSTRAINT FK_BaldaField_CellID FOREIGN KEY(CellID) REFERENCES BaldaCell(ID), CONSTRAINT FK_BaldaField_Letter FOREIGN KEY(Letter) REFERENCES BaldaABC(Letter) ) GO -------------------------------------------------------------------- --   -------------------------------------------------------------------- CREATE TABLE BaldaFieldWord( Step int NOT NULL, CellID int NOT NULL, Word nvarchar(50) NOT NULL, CONSTRAINT PK_BaldaFieldWord PRIMARY KEY(CellID), CONSTRAINT UK_BaldaFieldWord UNIQUE(Word), CONSTRAINT FK_BaldaFieldWord_CellID FOREIGN KEY(CellID) REFERENCES BaldaField(CellID) ON DELETE CASCADE, ) GO -------------------------------------------------------------------- --  -------------------------------------------------------------------- CREATE TABLE BaldaWord( Word nvarchar(50) NOT NULL, WordLen int NOT NULL, ReverseWord nvarchar(50) NOT NULL, CONSTRAINT PK_Word PRIMARY KEY(Word) ) GO CREATE TABLE #TempWord( Word nvarchar(50) NOT NULL ) --      (ASCII) BULK INSERT #TempWord FROM 'd:\Temp\.txt' WITH ( FIRSTROW = 1, FIELDTERMINATOR = ',', ROWTERMINATOR = '\n', CODEPAGE = 'ACP' ); INSERT BaldaWord(Word,WordLen,ReverseWord) SELECT Word,LEN(Word),REVERSE(Word) FROM #TempWord DROP TABLE #TempWord -------------------------------------------------------------------- --     /  -------------------------------------------------------------------- CREATE TABLE BaldaWordIndex( WordIndex nvarchar(50) NOT NULL, CONSTRAINT PK_BaldaWordIndex PRIMARY KEY(WordIndex) ) GO DECLARE @MaxWordLen int=(SELECT MAX(WordLen) FROM BaldaWord) DECLARE @IndexLen int=2 WHILE @IndexLen&lt;@MaxWordLen BEGIN INSERT BaldaWordIndex(WordIndex) SELECT LEFT(Word,@IndexLen) FROM BaldaWord WHERE LEN(LEFT(Word,@IndexLen))=@IndexLen UNION SELECT LEFT(ReverseWord,@IndexLen) FROM BaldaWord WHERE LEN(LEFT(ReverseWord,@IndexLen))=@IndexLen SET @IndexLen+=1 END GO</span></span></code> </pre> <br><br>  <b>Search algorithm (first version):</b> <br><div class="spoiler">  <b class="spoiler_title">Algorithm text ...</b> <div class="spoiler_text"><pre> <code class="sql hljs"><span class="hljs-comment"><span class="hljs-comment">--   DELETE BaldaField --    INSERT BaldaField(CellID,Letter) VALUES (10301,N''), (10302,N''), (10303,N''), (10304,N''), (10305,N'') --   INSERT BaldaFieldWord(Step,CellID,Word) VALUES(0,10301,N'') /* INSERT BaldaField(CellID,Letter) VALUES (10301,N''), (10302,N''), (10303,N''), (10304,N''), (10305,N'') INSERT BaldaFieldWord(Step,CellID,Word) VALUES(0,10301,N'') */ /* INSERT BaldaField(CellID,Letter) VALUES (10301,N''), (10302,N''), (10303,N''), (10304,N''), (10305,N'') INSERT BaldaFieldWord(Step,CellID,Word) VALUES(0,10301,N'') */ DECLARE @Step int=1 DECLARE @NewCellID int=0 DECLARE @NewLetter nchar(1) DECLARE @Word nvarchar(50) DECLARE @WordLen int WHILE @NewCellID IS NOT NULL BEGIN --    WITH newWordCte AS( SELECT CellID NewCellID, Letter NewLetter, CellID, CAST(Letter AS nvarchar(50)) Word, 1 WordLen, CAST(CellID AS varchar(300)) CellPath FROM ( SELECT l.LinkCellID CellID,abc.Letter FROM BaldaField f --       JOIN BaldaCellLink l ON f.CellID=l.CellID AND l.LinkCellID NOT IN(SELECT CellID FROM BaldaField) --      CROSS JOIN BaldaABC abc ) q UNION ALL SELECT w.NewCellID, w.NewLetter, f.CellID, CAST(w.Word+f.Letter AS nvarchar(50)), w.WordLen+1, CAST(w.CellPath+','+CAST(f.CellID AS varchar(10)) AS varchar(300)) FROM newWordCte w JOIN BaldaCellLink l ON w.CellID=l.CellID JOIN BaldaField f ON f.CellID=l.LinkCellID --    ,    JOIN BaldaWordIndex i ON w.Word+f.Letter=i.WordIndex --  ,    WHERE CHARINDEX(CAST(f.CellID AS varchar(10)),w.CellPath)=0 ) SELECT DISTINCT NewCellID,NewLetter,Word INTO #ResultAll FROM newWordCte WHERE WordLen&gt;1 -- ..       OPTION(MAXRECURSION 0); SELECT TOP 1 WITH TIES --      NewCellID, NewLetter, Word, WordLen INTO #Result FROM ( --  ,     SELECT r.NewCellID,r.NewLetter,w.Word,w.WordLen FROM #ResultAll r JOIN BaldaWord w ON r.Word=w.Word WHERE w.Word NOT IN(SELECT Word FROM BaldaFieldWord) UNION --       SELECT r.NewCellID,r.NewLetter,w.Word,w.WordLen FROM #ResultAll r JOIN BaldaWord w ON r.Word=w.ReverseWord WHERE w.Word NOT IN(SELECT Word FROM BaldaFieldWord) UNION --   ,     SELECT NULL,NULL,NULL,-1 ) q ORDER BY WordLen DESC DROP TABLE #ResultAll --   DECLARE @RowCount int=(SELECT COUNT(*) FROM #Result) SELECT @NewCellID=NewCellID, @NewLetter=NewLetter, @Word=Word, @WordLen=WordLen FROM #Result ORDER BY NewCellID OFFSET CAST(FLOOR(RAND()*@RowCount) AS int) ROWS FETCH NEXT 1 ROWS ONLY DROP TABLE #Result IF @NewCellID IS NOT NULL BEGIN --   INSERT BaldaField(CellID,Letter) VALUES(@NewCellID,@NewLetter) INSERT BaldaFieldWord(Step,CellID,Word) VALUES(@Step,@NewCellID,@Word) SET @Step+=1 END END</span></span></code> </pre><br></div></div><br>  On my computer, this script runs for about 2 seconds. <br><br>  <b>To view the result we use the following 2 queries:</b> <br><pre> <code class="sql hljs"><span class="hljs-comment"><span class="hljs-comment">--   SELECT uw.Step,ci,cj,f.Letter,uw.Word,LEN(uw.Word) WordLen FROM BaldaFieldWord uw JOIN BaldaField f ON uw.CellID=f.CellID JOIN BaldaCell c ON c.ID=f.CellID ORDER BY uw.Step --    SELECT * FROM ( SELECT ci,cj,f.Letter FROM BaldaCell c LEFT JOIN BaldaField f ON c.ID=f.CellID ) q PIVOT(MAX(Letter) FOR j IN([1],[2],[3],[4],[5])) p ORDER BY i</span></span></code> </pre><br>  <b>Result:</b> <br><img src="https://habrastorage.org/files/a92/29c/72e/a9229c72e7764880af638fd173cffe43.png"><br><br>  While preparing the article came up with a more optimal option, which wins in speed almost 2 times (especially noticeable when expanding the size of the field).  In the second variant, the auxiliary table BaldaWordIndex is expanded, due to which we can not use the BaldaWord table. <br><br>  <b>Script to re-create the BaldaWordIndex table:</b> <br><pre> <code class="sql hljs"><span class="hljs-comment"><span class="hljs-comment">-------------------------------------------------------------------- --     /  -  2 -------------------------------------------------------------------- DROP TABLE BaldaWordIndex GO CREATE TABLE BaldaWordIndex( WordIndex nvarchar(50) NOT NULL, IsWord bit NOT NULL, Word nvarchar(50), CONSTRAINT PK_BaldaWordIndex PRIMARY KEY(WordIndex) ) GO DECLARE @MaxWordLen int=(SELECT MAX(WordLen) FROM BaldaWord) DECLARE @IndexLen int=2 WHILE @IndexLen&lt;=@MaxWordLen BEGIN INSERT BaldaWordIndex(WordIndex,IsWord,Word) SELECT WordIndex,MAX(IsWord),MAX(Word) FROM ( SELECT LEFT(Word,@IndexLen) WordIndex,IIF(LEN(Word)=@IndexLen,1,0) IsWord,IIF(LEN(Word)=@IndexLen,Word,NULL) Word FROM BaldaWord WHERE LEN(LEFT(Word,@IndexLen))=@IndexLen UNION SELECT LEFT(ReverseWord,@IndexLen),IIF(LEN(Word)=@IndexLen,1,0),IIF(LEN(Word)=@IndexLen,Word,NULL) FROM BaldaWord WHERE LEN(LEFT(ReverseWord,@IndexLen))=@IndexLen ) q GROUP BY WordIndex SET @IndexLen+=1 END GO /* SELECT COUNT(*) FROM BaldaWordIndex WHERE IsWord=1 SELECT COUNT(*) FROM ( SELECT Word FROM BaldaWord UNION SELECT ReverseWord FROM BaldaWord ) q */</span></span></code> </pre><br><br>  <b>New search algorithm:</b> <br><div class="spoiler">  <b class="spoiler_title">Algorithm text ...</b> <div class="spoiler_text"><pre> <code class="sql hljs"><span class="hljs-comment"><span class="hljs-comment">--   DELETE BaldaField --    INSERT BaldaField(CellID,Letter) VALUES (10301,N''), (10302,N''), (10303,N''), (10304,N''), (10305,N'') --   INSERT BaldaFieldWord(Step,CellID,Word) VALUES(0,10301,N'') DECLARE @Step int=1 DECLARE @NewCellID int=0 DECLARE @NewLetter nchar(1) DECLARE @Word nvarchar(50) DECLARE @WordLen int WHILE @NewCellID IS NOT NULL BEGIN --    WITH newWordCte AS( SELECT CellID NewCellID, Letter NewLetter, CellID, CAST(Letter AS nvarchar(50)) Word, 1 WordLen, CAST(CellID AS varchar(300)) CellPath, CAST(0 AS bit) IsWord, CAST(NULL AS nvarchar(50)) ResWord FROM ( SELECT l.LinkCellID CellID,abc.Letter FROM BaldaField f --       JOIN BaldaCellLink l ON f.CellID=l.CellID AND l.LinkCellID NOT IN(SELECT CellID FROM BaldaField) --      CROSS JOIN BaldaABC abc ) q UNION ALL SELECT w.NewCellID, w.NewLetter, f.CellID, CAST(w.Word+f.Letter AS nvarchar(50)), w.WordLen+1, CAST(w.CellPath+','+CAST(f.CellID AS varchar(10)) AS varchar(300)), i.IsWord, i.Word FROM newWordCte w JOIN BaldaCellLink l ON w.CellID=l.CellID JOIN BaldaField f ON f.CellID=l.LinkCellID --    ,    JOIN BaldaWordIndex i ON w.Word+f.Letter=i.WordIndex --  ,    WHERE CHARINDEX(CAST(f.CellID AS varchar(10)),w.CellPath)=0 ) SELECT TOP 1 WITH TIES --      NewCellID, NewLetter, Word, WordLen INTO #Result FROM ( SELECT DISTINCT NewCellID,NewLetter,ResWord Word,WordLen FROM newWordCte WHERE IsWord=1 --     AND ResWord NOT IN(SELECT Word FROM BaldaFieldWord) ) q ORDER BY WordLen DESC OPTION(MAXRECURSION 0); DECLARE @RowCount int=(SELECT COUNT(*) FROM #Result) SET @NewCellID=NULL IF @RowCount&gt;0 BEGIN --   SELECT @NewCellID=NewCellID, @NewLetter=NewLetter, @Word=Word, @WordLen=WordLen FROM #Result ORDER BY NewCellID OFFSET CAST(FLOOR(RAND()*@RowCount) AS int) ROWS FETCH NEXT 1 ROWS ONLY --   INSERT BaldaField(CellID,Letter) VALUES(@NewCellID,@NewLetter) INSERT BaldaFieldWord(Step,CellID,Word) VALUES(@Step,@NewCellID,@Word) SET @Step+=1 END DROP TABLE #Result END</span></span></code> </pre><br></div></div><br>  The new version of the script on my computer runs in about 1 second. <br><br>  <b>To view the result, use the following 2 queries again:</b> <br><pre> <code class="sql hljs"><span class="hljs-comment"><span class="hljs-comment">--   SELECT uw.Step,ci,cj,f.Letter,uw.Word,LEN(uw.Word) WordLen FROM BaldaFieldWord uw JOIN BaldaField f ON uw.CellID=f.CellID JOIN BaldaCell c ON c.ID=f.CellID ORDER BY uw.Step --    SELECT * FROM ( SELECT ci,cj,f.Letter FROM BaldaCell c LEFT JOIN BaldaField f ON c.ID=f.CellID ) q PIVOT(MAX(Letter) FOR j IN([1],[2],[3],[4],[5])) p ORDER BY i</span></span></code> </pre><br>  <b>Actually, everything.</b> <br><br>  This work was done in a hurry and more of sports interest, to refresh the memory a little, and also to see how optimal and fast the solution will be using SQL. <br><br>  In my opinion, the solution turned out to be quite good and fairly transparent - SQL did a good job with this task.  The main recursive query can be easily rewritten into any other SQL dialect which has support for recursive CTE expressions. <br><br>  Learn SQL - this is a great language for data manipulation. <br><br>  Hope the article was interesting. <br><br>  Good luck and thank you for your attention! <br><br><h2>  Addition to the article (12/01/2015) </h2><br>  All with the first day of winter! <br><br>  Recently playing ‚ÄúBalda‚Äù with my wife on paper, I realized that the algorithm I quoted above looks only for words that contain a new letter at the beginning or end of a word. <br><br>  He hastily completed the old algorithm, now it takes into account the chains containing the new letter in the middle of the word. <br><br>  <b>New, smarter algorithm:</b> <br><pre> <code class="sql hljs"><span class="hljs-comment"><span class="hljs-comment">--   DELETE BaldaField --    INSERT BaldaField(CellID,Letter) VALUES (10301,N''), (10302,N''), (10303,N''), (10304,N''), (10305,N'') --   INSERT BaldaFieldWord(Step,CellID,Word) VALUES(0,10301,N'') DECLARE @Step int=1 DECLARE @NewCellID int=0 DECLARE @NewLetter nchar(1) DECLARE @Word nvarchar(50) DECLARE @WordLen int CREATE TABLE #Sets( SetID nvarchar(20) NOT NULL, CellID int NOT NULL, Letter nchar(1) NOT NULL, IsNewCell int NOT NULL, NewCellID int, NewLetter nchar(1), PRIMARY KEY(SetID,CellID) ) WHILE @NewCellID IS NOT NULL BEGIN --    TRUNCATE TABLE #Sets --     INSERT #Sets(SetID,CellID,Letter,IsNewCell,NewCellID,NewLetter) SELECT res.* FROM ( --  ,         SELECT l.LinkCellID FROM BaldaField f JOIN BaldaCellLink l ON f.CellID=l.CellID AND l.LinkCellID NOT IN(SELECT CellID FROM BaldaField) GROUP BY l.LinkCellID HAVING COUNT(f.CellID)&gt;1 ) q --       CROSS JOIN BaldaABC abc --        +      CROSS APPLY ( SELECT CAST(q.LinkCellID AS nvarchar(10))+abc.Letter SetID,q.LinkCellID CellID,abc.Letter,CAST(1 AS int) IsNewCell,q.LinkCellID NewCellID,abc.Letter NewLetter UNION ALL SELECT CAST(q.LinkCellID AS nvarchar(10))+abc.Letter,f.CellID,f.Letter,0,NULL,NULL FROM BaldaField f ) res; --     /    WITH newWordCte1 AS( SELECT CellID NewCellID, Letter NewLetter, CellID, CAST(Letter AS nvarchar(50)) Word, 1 WordLen, CAST(CellID AS varchar(300)) CellPath, CAST(0 AS bit) IsWord, CAST(NULL AS nvarchar(50)) ResWord FROM ( SELECT q.LinkCellID CellID,abc.Letter FROM ( --  ,        SELECT l.LinkCellID FROM BaldaField f JOIN BaldaCellLink l ON f.CellID=l.CellID AND l.LinkCellID NOT IN(SELECT CellID FROM BaldaField) GROUP BY l.LinkCellID HAVING COUNT(f.CellID)=1 ) q --      CROSS JOIN BaldaABC abc ) q UNION ALL SELECT w.NewCellID, w.NewLetter, f.CellID, CAST(w.Word+f.Letter AS nvarchar(50)), w.WordLen+1, CAST(w.CellPath+','+CAST(f.CellID AS varchar(10)) AS varchar(300)), i.IsWord, i.Word FROM newWordCte1 w JOIN BaldaCellLink l ON w.CellID=l.CellID JOIN BaldaField f ON f.CellID=l.LinkCellID --    ,    JOIN BaldaWordIndex i ON w.Word+f.Letter=i.WordIndex --  ,    WHERE CHARINDEX(CAST(f.CellID AS varchar(10)),w.CellPath)=0 ), --    ,         newWordCte2 AS( SELECT SetID, CellID, CAST(Letter AS nvarchar(50)) Word, 1 WordLen, CAST(CellID AS varchar(300)) CellPath, CAST(0 AS bit) IsWord, CAST(NULL AS nvarchar(50)) ResWord, IsNewCell, NewCellID, NewLetter FROM #Sets --        UNION ALL SELECT w.SetID, f.CellID, CAST(w.Word+f.Letter AS nvarchar(50)), w.WordLen+1, CAST(w.CellPath+','+CAST(f.CellID AS varchar(10)) AS varchar(300)), i.IsWord, i.Word, w.IsNewCell+f.IsNewCell, ISNULL(w.NewCellID,f.NewCellID), ISNULL(w.NewLetter,f.NewLetter) FROM newWordCte2 w JOIN BaldaCellLink l ON w.CellID=l.CellID JOIN #Sets f ON w.SetID=f.SetID AND f.CellID=l.LinkCellID --    ,    JOIN BaldaWordIndex i ON w.Word+f.Letter=i.WordIndex --  ,    WHERE CHARINDEX(CAST(f.CellID AS varchar(10)),w.CellPath)=0 ) SELECT TOP 1 WITH TIES --      NewCellID, NewLetter, Word, WordLen INTO #Result FROM ( SELECT NewCellID,NewLetter,ResWord Word,WordLen FROM newWordCte1 WHERE IsWord=1 --     AND ResWord NOT IN(SELECT Word FROM BaldaFieldWord) UNION SELECT NewCellID,NewLetter,ResWord Word,WordLen FROM newWordCte2 WHERE IsWord=1 --     AND IsNewCell=1 --       AND ResWord NOT IN(SELECT Word FROM BaldaFieldWord) ) q ORDER BY WordLen DESC OPTION(MAXRECURSION 0); DECLARE @RowCount int=(SELECT COUNT(*) FROM #Result) SET @NewCellID=NULL IF @RowCount&gt;0 BEGIN --   SELECT @NewCellID=NewCellID, @NewLetter=NewLetter, @Word=Word, @WordLen=WordLen FROM #Result ORDER BY NewCellID OFFSET CAST(FLOOR(RAND()*@RowCount) AS int) ROWS FETCH NEXT 1 ROWS ONLY --   INSERT BaldaField(CellID,Letter) VALUES(@NewCellID,@NewLetter) INSERT BaldaFieldWord(Step,CellID,Word) VALUES(@Step,@NewCellID,@Word) SET @Step+=1 END DROP TABLE #Result END DROP TABLE #Sets</span></span></code> </pre><br>  This algorithm on my computer completely fills the 5 * 5 field in 10-15 seconds. <br>  The field size of 10 * 10 I filled in about 13 minutes. <br><br>  <b>Check what happened:</b> <br><pre> <code class="sql hljs"><span class="hljs-comment"><span class="hljs-comment">--   SELECT uw.Step,ci,cj,f.Letter,uw.Word,LEN(uw.Word) WordLen FROM BaldaFieldWord uw JOIN BaldaField f ON uw.CellID=f.CellID JOIN BaldaCell c ON c.ID=f.CellID ORDER BY uw.Step --    SELECT * FROM ( SELECT ci,cj,f.Letter FROM BaldaCell c LEFT JOIN BaldaField f ON c.ID=f.CellID ) q PIVOT(MAX(Letter) FOR j IN([1],[2],[3],[4],[5])) p ORDER BY i</span></span></code> </pre><br><img src="https://habrastorage.org/files/145/7b1/bbf/1457b1bbf1f44f6a80997a9a78f184b0.png"><br>  Although the speed and fell, but apparently the quality of the search has increased - there are long words containing a new letter in the middle of the word. <br><br>  Since  The new query is an old query modified in a hurry (it was newWordCte, and there was newWordCte1 + newWordCte2), then, if you wish, I think it will be possible to optimize it well. <br><br>  Archive with new files can also be downloaded from the same link - <a href="">scripts</a> . <br><br>  Thanks again for your attention! </div><p>Source: <a href="https://habr.com/ru/post/271795/">https://habr.com/ru/post/271795/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../271783/index.html">How to make the site work in the form of a Web App (an uninteresting example of a private solution, which is also poorly described)</a></li>
<li><a href="../271785/index.html">Car safety: what lessons can we learn from recalling cars?</a></li>
<li><a href="../271789/index.html">Go Mutex Dancing</a></li>
<li><a href="../271791/index.html">Black Friday 2015</a></li>
<li><a href="../271793/index.html">Black Friday at hosters</a></li>
<li><a href="../271797/index.html">COUNT (*)</a></li>
<li><a href="../271799/index.html">An example of express analysis of the performance of storage using the free service Mitrend</a></li>
<li><a href="../271803/index.html">Google spam confession</a></li>
<li><a href="../271805/index.html">Jira Automation on Groovy</a></li>
<li><a href="../271809/index.html">Investigation of the installation error Visual Studio 2015</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>