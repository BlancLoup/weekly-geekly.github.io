<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Linq-to-Sql: Recognize nullable fields from metadata (or a story about a small bug)</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="So, before us Linq-to-Sql. We are faced with the task of finding out which fields can have null values ‚Äã‚Äãand which are not - solving this problem can,...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Linq-to-Sql: Recognize nullable fields from metadata (or a story about a small bug)</h1><div class="post__text post__text-html js-mediator-article">  So, before us Linq-to-Sql.  We are faced with the task of finding out which fields can have null values ‚Äã‚Äãand which are not - solving this problem can, for example, help in highlighting mandatory fields on a form, or just to validate data before setting them into object properties. <br><a name="habracut"></a>  Step one - create a simple table of the following form: <br> <a href="https://habrastorage.org/getpro/habr/post_images/cf8/448/a0b/cf8448a0b385c367b76d1677a1552d69.png/"><img width="296" height="152" src="https://habrastorage.org/getpro/habr/post_images/cf8/448/a0b/cf8448a0b385c367b76d1677a1552d69.png"></a> <br>  Step two - create a project (for an example, the Console Application will suffice).  We add Model Linq-To-Sql to it, to which we add mapping to the LinqBugTable table, I note that the price of the Nullable property is set to False, it should be so, because this field is not nullable in the database: <br> <a href="http://pics.livejournal.com/outcoldman/pic/0000rxd5/"><img width="320" height="192" src="https://habrastorage.org/getpro/habr/post_images/56e/96d/d58/56e96dd581fb5d91f830b3e1b09abe79.png"></a> <br>  I will not yet show the code for the property price, but I will show for the number: <blockquote><code><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="black">[Column(Storage= <font color="#a31515">"_number"</font> , DbType= <font color="#a31515">"VarChar(50) NOT NULL"</font> , CanBeNull= <font color="#0000ff">false</font> )] <br> <font color="#0000ff">public</font> <font color="#0000ff">string</font> number <br> { <font color="#0000ff">get</font> { .... } <font color="#0000ff">set</font> { .... } }</font> <br> <br> <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></code> </blockquote>  This shows that we can find out from the ColumnAttribute of this property when our field can be null.  Create a partial class for LinqBugTable, which will display the information about its properties: <br><blockquote> <code><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="black"><font color="#0000ff">partial</font> <font color="#0000ff">class</font> LinqBugTable <br> { <br> <font color="#0000ff">public</font> <font color="#0000ff">void</font> WriteNullableInfo() <br> { <br> <font color="#0000ff">foreach</font> (PropertyInfo property <font color="#0000ff">in</font> GetType().GetProperties()) <br> { <br> <font color="#0000ff">foreach</font> (ColumnAttribute columnAttribute <font color="#0000ff">in</font> property.GetCustomAttributes( <font color="#0000ff">typeof</font> (ColumnAttribute), <font color="#0000ff">true</font> )) <br> { <br> <font color="#2b91af">Console</font> .WriteLine( <font color="#a31515">"Property: '{0}', CanBeNull: '{1}'"</font> , property.Name, columnAttribute.CanBeNull); <br> } <br> } <br> } <br> }</font> <br> <br> <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></code> </blockquote>  It seems everything is ready, but the result will be as follows: <br><br>  <em>Property: 'id', CanBeNull: 'True'</em> <em><br></em>  <em>Property: 'price', CanBeNull: 'True'</em> <em><br></em>  <em>Property: 'number', CanBeNull: 'False'</em> <br><br>  As you can see for id and price we return True, although this, of course, is not so.  Now let's look at the description of the price property in the class: <br><blockquote> <code><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="black">[Column(Storage= <font color="#a31515">"_price"</font> , DbType= <font color="#a31515">"Money NOT NULL"</font> )] <br> <font color="#0000ff">public</font> <font color="#0000ff">decimal</font> price <br> { <font color="#0000ff">get</font> { .... } <font color="#0000ff">set</font> { .... } }</font> <br> <br> <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></code> </blockquote>  As you can see, the CanBeNull property of the Column attribute is not set, but, in general, bool variables are set to false, so maybe this is not a problem (I thought at first).  It is good that there is a wonderful <a href="http://www.red-gate.com/products/reflector/">Reflector</a> program with which you can see what happens in the ColumnAttribute code: <br> <a href="http://pics.livejournal.com/outcoldman/pic/0000w688/"><img width="272" height="240" src="https://habrastorage.org/getpro/habr/post_images/fca/909/d89/fca909d8946a4450e8d65c66d67fab70.png"></a> <br>  We see that in the constructor they initialize the field to true.  In general, the ColumnAttribute is still the CanBeNullSet property, which is unfortunately internal, with which it would be possible to know whether the property is set or not. <br>  After thinking about it, I understood the logic: the price property returns the decimal type, which simply cannot be null, and if I set the Nullable = True property in the Model Designer of this field, then it would have the Nullable &lt;decimal&gt; type.  In general, for fields with ValueType types (structures), Linq-To-Sql does not generate a description related to CanBeNull.  Bottom line, we rewrite our method a bit: <br><blockquote> <code><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="black"><font color="#0000ff">public</font> <font color="#0000ff">void</font> WriteNullableInfo() <br> { <br> <font color="#0000ff">foreach</font> (PropertyInfo property <font color="#0000ff">in</font> GetType().GetProperties()) <br> { <br> <font color="#0000ff">foreach</font> (ColumnAttribute columnAttribute <font color="#0000ff">in</font> property.GetCustomAttributes( <font color="#0000ff">typeof</font> (ColumnAttribute), <font color="#0000ff">true</font> )) <br> { <br> <font color="#0000ff">bool</font> canBeNull = (Nullable.GetUnderlyingType(property.PropertyType) != <font color="#0000ff">null</font> ) <br> || (columnAttribute.CanBeNull &amp;&amp; !property.PropertyType.IsValueType); <br> <font color="#2b91af">Console</font> .WriteLine( <font color="#a31515">"Property: '{0}', CanBeNull: '{1}'"</font> , property.Name, canBeNull); <br> } <br> } <br> }</font> <br> <br> <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></code> </blockquote>  Now we check that if we have a property of type Nullable &lt;T&gt;, then we will return True, otherwise we will return the value CanBeNull, taking into account that the field type is not a struct.  Well, we hope that with the property types of ValueType - this is the only trouble that was in this scheme.  ;) <br></div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <p>Source: <a href="https://habr.com/ru/post/58119/">https://habr.com/ru/post/58119/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../58109/index.html">The future is near: Zero S electric supermoto - a motorcycle on electric propulsion</a></li>
<li><a href="../58112/index.html">Gadgets with outstanding appearance</a></li>
<li><a href="../58115/index.html">How to create your opensource project</a></li>
<li><a href="../58117/index.html">Interview with Sergey Belousov</a></li>
<li><a href="../58118/index.html">Installing Google Desktop on 64-bit Vista</a></li>
<li><a href="../58120/index.html">Explay CMS 3.0 alpha</a></li>
<li><a href="../58121/index.html">How to convert ext3 to ext4 file system</a></li>
<li><a href="../58122/index.html">Video from the main gaming office of Belarus - Game Stream</a></li>
<li><a href="../58123/index.html">Billion downloads in the AppStore</a></li>
<li><a href="../58124/index.html">Muris nonpenis arcus *</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>