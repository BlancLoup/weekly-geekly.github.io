<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>We write Skype bot on C # with modular architecture</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="alert ('Hi Habr!'); 

 It‚Äôs been a long time since the thought of making such a tool assistant, which could bring out currency rates and prompt the we...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>We write Skype bot on C # with modular architecture</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/files/f5f/413/15f/f5f41315fd3a4b79920f5d89d29f64b1.png" alt="image" align="left">  alert ('Hi Habr!'); <br><br>  It‚Äôs been a long time since the thought of making such a tool assistant, which could bring out currency rates and prompt the weather and anecdote to hunt, didn‚Äôt make it all up ... well, you know how it happens, right?  In addition, in my endless list with funny ideas that it would be nice to someday realize - there was a ‚Äúbot for Skype 4fun‚Äù item. <br><br>  Hands reached.  It will be about writing a simple modular bot on C # with integration into Skype.  What happened in the end, as well as why you should turn off the system unit from the network before you climb into it with a screwdriver - read under the cut. <br><a name="habracut"></a>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h4>  Foreword </h4><br>  It would seem, where does the system unit and the screwdriver?  Well, then ... One languid evening I dismantled a system engineer in order to lubricate the cooler on the power supply unit (it roared like a beetle).  Smeared, checked that everything turns, turns and pleases the ear.  He began to collect everything in its original state and ... did not bother to disconnect it from the network.  For what fate rewarded me with stars in my eyes, a waste of a certain amount on a new bpshnik and ... the decision to finally write the first article in 4 years for a favorite habr.  Please do not kick much, the <s>Chukchi</s> author is not a writer. <br><br>  For those who are too lazy to read the entire article: all sorts here: <a href="https://github.com/Nigrimmist/HelloBot">https://github.com/Nigrimmist/HelloBot</a> and instructions for <br><div class="spoiler">  <b class="spoiler_title">launch</b> <div class="spoiler_text">  All you need is to compile everything and in \ SkypeBotAdapterConsole \ bin \ Debug there will be a ready-made console that you need to run for testing (you need to register skyp4com library in the system + old Skype).  Further in the article these moments are described in more detail. </div></div><br><br><h4>  Introduction </h4><br>  On the next weekend, a little tired of sawing my brainchild - another Facebook killer, I decided to pick something up for the soul and realize.  The choice fell on the bot for Skype.  I decided to write right away with the foundation for extensibility, so that colleagues could add those bot modules that are needed directly by them. <br>  By the way, I am in the same Skype chat, which in turn consists of friends, acquaintances, and colleagues, and the men's club.  It was created during the time of joint work on one of the projects, and so somehow got accustomed to our contact lists, assuming the role of a male talker.  It was for this chat that I wrote a bot, in order to have a little fun of the people, but to make a small highlight. <br><br><h4>  Set tasks </h4><br>  So.  let's decide what we would like to have in the end: <br><br>  - A separate bot module, the purpose of which is to process messages and return a response. <br>  - Integration with Skype.  A bot should be able to receive chat messages and respond to them if they are addressed to it. <br>  - Ease of writing and connecting "modules" by third-party developers <br>  - Ability to integrate with various clients <br><br><h4>  Case Study </h4><br>  I climbed into these your Internet to look for information about how I could solve the main problem - to interact with Skype.  The first links I threw out on the information that Microsoft had cut the API since December 2013 (this is easy to say, because 99% of the opportunities were ‚Äúreduced‚Äù) and so far it does not plan to develop this direction in any way. <br><br>  Having made a thoughtful face, I for half an hour sketched the code, which every couple of seconds clicked on the chat, copied messages into the buffer and thus interacted with the ui shell.  Looking at this Frankenstein, my heart sank and I squeezed my backspace for a good 10 seconds.  "Yes, it can not be that there was no better solution" - flashed through my head, and my hands reached for the keyboard. <br><br>  There was a thought to tie the old api library to the old skype, but, as you know, Microsoft and here we planted a pink animal, forbidding the use of old versions of Skype.  Having studied a number of articles, I came to the conclusion that there are separate old portable versions that were converted by craftsmen to working condition while preserving the old functionality.  And yes, by launching Skype on a virtual machine, I was convinced that the old api library still works with a slightly older Skype. <br><br><h4>  Implementation </h4><br>  And so, for the implementation of our plans we will need: <br><br>  - Skype4COM.dll is an ActiveX component that provides an API for communicating with Skype <br>  - Interop.SKYPE4COMLib.dll - proxy for interaction with Skype4COM.DLL from .net code <br>  - Launched Skype (for example, version 6.18, tried on 4.2, but there was no chat support yet) <br>  - Kefir and oatmeal cookies <br><br>  The code was written in Visual Studio 2012 under 4.5. NET Framework. <br><br>  Register Skype4COM.DLL in the system.  The easiest way is to create a .bat file and enter there. <br><br><pre><code class="hljs nginx"><span class="hljs-attribute"><span class="hljs-attribute">regsvr32</span></span> Skype4COM.dll</code> </pre> <br>  Put it next to the dll and run the batch file.  We bite a cookie, we wash it down with kefir and we rub our hands, because one tenth of the work is done. <br><br>  Next, we need to somehow check whether it works at all. <br><br><h4>  Interaction with Skype </h4><br>  Create a console application, connect Interop.SKYPE4COMLib.dll and write the following simple code: <br><br><div class="spoiler">  <b class="spoiler_title">Code with comments</b> <div class="spoiler_text"><pre> <code class="hljs pgsql"><span class="hljs-keyword"><span class="hljs-keyword">class</span></span> Program { //   Skype,        private static Skype skype = <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> Skype(); static <span class="hljs-type"><span class="hljs-type">void</span></span> Main(string[] args) { // ,      Task.Run(delegate { try { //    skype.MessageStatus += OnMessageReceived; //   .     ,          . //<span class="hljs-number"><span class="hljs-number">5</span></span>    ( -), <span class="hljs-keyword"><span class="hljs-keyword">true</span></span> -         . skype.Attach(<span class="hljs-number"><span class="hljs-number">5</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>); Console.WriteLine("skype attached"); } catch (<span class="hljs-keyword"><span class="hljs-keyword">Exception</span></span> ex) { //  ,  -   Console.WriteLine("top lvl exception : " + ex.ToString()); } //   <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">true</span></span>) { Thread.Sleep(<span class="hljs-number"><span class="hljs-number">1000</span></span>); } }); //    <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">true</span></span>) { Thread.Sleep(<span class="hljs-number"><span class="hljs-number">1000</span></span>); } } //   private static <span class="hljs-type"><span class="hljs-type">void</span></span> OnMessageReceived(ChatMessage pMessage, TChatMessageStatus status) { // ,       ,     ,    cmsReceived +             <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (status == TChatMessageStatus.cmsReceived) { Console.WriteLine(pMessage.Body); } } }</code> </pre><br></div></div><br>  We start, we ask someone to write to us in Skype - the text of the interlocutor is displayed in the console.  Win.  Reach for another cookie and pour into a mug of yogurt. <br><br><h4>  We write modules </h4><br>  And so, it remains quite a bit.  We need to implement the bot in such a way that connecting additional modules with commands for the bot was easier than lubricating the cooler in the power supply. <br><br>  Create a library project and name it, say HelloBotCommunication.  It will serve as a bridge between the modules and the bot.  We put there three interfaces: <br><br><div class="spoiler">  <b class="spoiler_title">IActionHandler</b> <div class="spoiler_text">  He will be responsible for the message handler classes. <br><pre> <code class="hljs cs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">interface</span></span> <span class="hljs-title"><span class="hljs-title">IActionHandler</span></span> { List &lt;<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>&gt; CallCommandList { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>;} <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> CommandDescription { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">HandleMessage</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> args, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">object</span></span></span></span><span class="hljs-function"><span class="hljs-params"> clientData, Action&lt;</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params">&gt; sendMessageFunc</span></span></span><span class="hljs-function">)</span></span>; }</code> </pre><br>  where <b>CallCommandList</b> is a list of commands for which HandleMessage will be called, <b>CommandDescription is</b> needed to display the description in the! modules command (see below) and <b>HandleMessage</b> - where the module should process incoming parameters ( <i>args</i> ), passing the answer to the sendMessageFunc <i>callback</i> <br></div></div><br><div class="spoiler">  <b class="spoiler_title">IActionHandlerRegister</b> <div class="spoiler_text">  He will be responsible for registering our handlers. <br><pre> <code class="hljs cs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">interface</span></span> <span class="hljs-title"><span class="hljs-title">IActionHandlerRegister</span></span> { <span class="hljs-function"><span class="hljs-function">List&lt;IActionHandler&gt; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GetHandlers</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span>; }</code> </pre><br></div></div><br><div class="spoiler">  <b class="spoiler_title">ISkypeData</b> <div class="spoiler_text">  He will be responsible for additional information about the client, in this case, about Skype, if the handler needs one. <br><pre> <code class="hljs cs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">interface</span></span> <span class="hljs-title"><span class="hljs-title">ISkypeData</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> FromName { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } }</code> </pre><br></div></div><br>  The meaning of all this is this: the developer creates his .dll, connects our library for communication, inherits from IActionHandler and IActionHandlerRegister and implements the functionality he needs without thinking about everything that lies above. <br><br><div class="spoiler">  <b class="spoiler_title">Example</b> <div class="spoiler_text">  An example in the form of the command module "say", which will force the bot to say everything that happens after the command itself. <br><pre> <code class="hljs cs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">Say</span></span> : <span class="hljs-title"><span class="hljs-title">IActionHandler</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> Random r = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Random(); <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> List&lt;<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>&gt; answers = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> List&lt;<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>&gt;() { <span class="hljs-string"><span class="hljs-string">"   "</span></span>, <span class="hljs-string"><span class="hljs-string">" "</span></span>, <span class="hljs-string"><span class="hljs-string">"?"</span></span>, <span class="hljs-string"><span class="hljs-string">"5$"</span></span>, <span class="hljs-string"><span class="hljs-string">", "</span></span>, }; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> List&lt;<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>&gt; CallCommandList { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> List&lt;<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>&gt;() { <span class="hljs-string"><span class="hljs-string">""</span></span>, <span class="hljs-string"><span class="hljs-string">"say"</span></span> }; } } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> CommandDescription { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">@"  "</span></span>; } } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">HandleMessage</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> args, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">object</span></span></span></span><span class="hljs-function"><span class="hljs-params"> clientData, Action&lt;</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params">&gt; sendMessageFunc</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (args.StartsWith(<span class="hljs-string"><span class="hljs-string">"/"</span></span>)) { sendMessageFunc(answers[r.Next(<span class="hljs-number"><span class="hljs-number">0</span></span>,answers.Count<span class="hljs-number"><span class="hljs-number">-1</span></span>)]); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { sendMessageFunc(args); } } }</code> </pre><br></div></div><br><br><h4>  We write the body of the bot </h4><br>  There is a module, there is a library for communication, it remains to write the main hero of the occasion - Monsieur bot, and somehow link it all up.  Yes, it is easy - you will say and run to the kitchen for the second package of kefir.  And you will be right. <br><br>  I called it <b>HelloBot</b> and created a separate library project.  The essence of the class is to find the right .dll with modules and work with them.  This is done through <br><br><pre> <code class="hljs javascript">assembly.GetTypes().Where(<span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">x</span></span></span><span class="hljs-function"> =&gt;</span></span> i.IsAssignableFrom(x)) <span class="hljs-comment"><span class="hljs-comment">//  Activator.CreateInstance(type);</span></span></code> </pre><br><br>  Here I want to warn you a little.  This is, by and large, a solution to the forehead and potentially a security hole.  In an amicable way, you need to create a separate domain and give only the necessary rights when executing other modules, but we are naive people and assume that all the code is checked and the modules are written out of the best of intentions.  (The correct decision is not to write a bicycle, but for example, <a href="http://msdn.microsoft.com/ru-ru/library/dd460648%2528v%3Dvs.110%2529.aspx">MEF</a> ) <br><br>  After registering the creation of an object, we will have at our disposal a command prefix (the default is "!") And a mask for searching for .dll modules.  As well as the <b>HandleMessage</b> method in which all the magic is created. <br>  The magic is to accept the incoming message, some specific data from the client (if any) and a callback to respond.  A list of system commands (‚Äúhelp‚Äù and ‚Äúmodules‚Äù) is also entered, which allow you to see these commands in the first case and the list of all connected modules in the second. <br>  The execution of the module is allocated in a separate thread and is limited in execution time (by default, 60 seconds), after which the thread simply ceases to exist. <br><br><div class="spoiler">  <b class="spoiler_title">HelloBot class</b> <div class="spoiler_text"><pre> <code class="hljs javascript"> public <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">HelloBot</span></span></span><span class="hljs-class"> </span></span>{ private List&lt;IActionHandler&gt; handlers = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> List&lt;IActionHandler&gt;<span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function">; // </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">Tuple</span></span></span><span class="hljs-function">   ,      ,     </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">private</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">IDictionary</span></span></span><span class="hljs-function">&lt;</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">string</span></span></span><span class="hljs-function">, </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">Tuple</span></span></span><span class="hljs-function">&lt;</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">string</span></span></span><span class="hljs-function">, </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">Func</span></span></span><span class="hljs-function">&lt;</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">string</span></span></span><span class="hljs-function">&gt;&gt;&gt; </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">systemCommands</span></span></span><span class="hljs-function">; </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">private</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">string</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">dllMask</span></span></span><span class="hljs-function"> { </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">get</span></span></span><span class="hljs-function">; </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">set</span></span></span><span class="hljs-function">; } </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">private</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">string</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">botCommandPrefix</span></span></span><span class="hljs-function">; </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">private</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">int</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">commandTimeoutSec</span></span></span><span class="hljs-function">; </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">public</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">HelloBot</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">string dllMask = </span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">"*.dll"</span></span></span></span><span class="hljs-function"><span class="hljs-params">, string botCommandPrefix = </span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">"!"</span></span></span></span></span><span class="hljs-function">) { </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">this</span></span></span><span class="hljs-function">.</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">dllMask</span></span></span><span class="hljs-function"> = </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">dllMask</span></span></span><span class="hljs-function">; </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">this</span></span></span><span class="hljs-function">.</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">botCommandPrefix</span></span></span><span class="hljs-function"> = </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">botCommandPrefix</span></span></span><span class="hljs-function">; </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">this</span></span></span><span class="hljs-function">.</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">commandTimeoutSec</span></span></span><span class="hljs-function"> = 60; </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">systemCommands</span></span></span><span class="hljs-function"> = </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">new</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">Dictionary</span></span></span><span class="hljs-function">&lt;</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">string</span></span></span><span class="hljs-function">, </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">Tuple</span></span></span><span class="hljs-function">&lt;</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">string</span></span></span><span class="hljs-function">, </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">Func</span></span></span><span class="hljs-function">&lt;</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">string</span></span></span><span class="hljs-function">&gt;&gt;&gt;</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> { {"</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">help</span></span></span><span class="hljs-function">", </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">new</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">Tuple</span></span></span><span class="hljs-function">&lt;</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">string</span></span></span><span class="hljs-function">, </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">Func</span></span></span><span class="hljs-function">&lt;</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">string</span></span></span><span class="hljs-function">&gt;&gt;(</span><span class="hljs-params"><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">"  "</span></span></span></span><span class="hljs-function"><span class="hljs-params">, GetSystemCommands</span></span></span><span class="hljs-function">)}, {"</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">modules</span></span></span><span class="hljs-function">", </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">new</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">Tuple</span></span></span><span class="hljs-function">&lt;</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">string</span></span></span><span class="hljs-function">, </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">Func</span></span></span><span class="hljs-function">&lt;</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">string</span></span></span><span class="hljs-function">&gt;&gt;(</span><span class="hljs-params"><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">"  "</span></span></span></span><span class="hljs-function"><span class="hljs-params">, GetUserDefinedCommands</span></span></span><span class="hljs-function">)}, }; </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">RegisterModules</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function">; } </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">private</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">void</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">RegisterModules</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> { </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">handlers</span></span></span><span class="hljs-function"> = </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">GetHandlers</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function">; } </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">protected</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">virtual</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">List</span></span></span><span class="hljs-function">&lt;</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">IActionHandler</span></span></span><span class="hljs-function">&gt; </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">GetHandlers</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> { </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">List</span></span></span><span class="hljs-function">&lt;</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">IActionHandler</span></span></span><span class="hljs-function">&gt; </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">toReturn</span></span></span><span class="hljs-function"> = </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">new</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">List</span></span></span><span class="hljs-function">&lt;</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">IActionHandler</span></span></span><span class="hljs-function">&gt;</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function">; </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">var</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">dlls</span></span></span><span class="hljs-function"> = </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">Directory</span></span></span><span class="hljs-function">.</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">GetFiles</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">"."</span></span></span></span><span class="hljs-function"><span class="hljs-params">, dllMask</span></span></span><span class="hljs-function">); </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">var</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">i</span></span></span><span class="hljs-function"> = </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">typeof</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">IActionHandlerRegister</span></span></span><span class="hljs-function">); </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">foreach</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">var</span></span></span></span><span class="hljs-function"><span class="hljs-params"> dll </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">in</span></span></span></span><span class="hljs-function"><span class="hljs-params"> dlls</span></span></span><span class="hljs-function">) { </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">var</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">ass</span></span></span><span class="hljs-function"> = </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">Assembly</span></span></span><span class="hljs-function">.</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">LoadFile</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">Environment.CurrentDirectory + dll</span></span></span><span class="hljs-function">); //</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">get</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">types</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">from</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">assembly</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">var</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">typesInAssembly</span></span></span><span class="hljs-function"> = </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">ass</span></span></span><span class="hljs-function">.</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">GetTypes</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function">.</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">Where</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">x =&gt; i.IsAssignableFrom(x</span></span></span><span class="hljs-function">)).</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">ToList</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function">; </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">foreach</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">Type type </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">in</span></span></span></span><span class="hljs-function"><span class="hljs-params"> typesInAssembly</span></span></span><span class="hljs-function">) { </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">object</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">obj</span></span></span><span class="hljs-function"> = </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">Activator</span></span></span><span class="hljs-function">.</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">CreateInstance</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">type</span></span></span><span class="hljs-function">); </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">var</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">clientHandlers</span></span></span><span class="hljs-function"> = (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(IActionHandlerRegister</span></span></span><span class="hljs-function">)</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">obj</span></span></span><span class="hljs-function">).</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">GetHandlers</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function">; </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">foreach</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">IActionHandler handler </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">in</span></span></span></span><span class="hljs-function"><span class="hljs-params"> clientHandlers</span></span></span><span class="hljs-function">) { </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">if</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">handler.CallCommandList.Any(</span></span></span><span class="hljs-function">)) { </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">toReturn</span></span></span><span class="hljs-function">.</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">Add</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">handler</span></span></span><span class="hljs-function">); } } } } </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">return</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">toReturn</span></span></span><span class="hljs-function">; } </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">public</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">void</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">HandleMessage</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">string incomingMessage, Action&lt;string&gt; answerCallback, object data</span></span></span><span class="hljs-function">) { </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">if</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">incomingMessage.StartsWith(botCommandPrefix</span></span></span><span class="hljs-function">)) { </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">incomingMessage</span></span></span><span class="hljs-function"> = </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">incomingMessage</span></span></span><span class="hljs-function">.</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">Substring</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">botCommandPrefix.Length</span></span></span><span class="hljs-function">); </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">var</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">argsSpl</span></span></span><span class="hljs-function"> = </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">incomingMessage</span></span></span><span class="hljs-function">.</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">Split</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">' '</span></span></span></span></span><span class="hljs-function">); </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">var</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">command</span></span></span><span class="hljs-function"> = </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">argsSpl</span></span></span><span class="hljs-function">[0]; </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">var</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">systemCommandList</span></span></span><span class="hljs-function"> = </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">systemCommands</span></span></span><span class="hljs-function">.</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">Where</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">x =&gt; x.Key.ToLower(</span></span></span><span class="hljs-function">) == </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">command</span></span></span><span class="hljs-function">.</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">ToLower</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function">).</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">ToList</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function">; </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">if</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">systemCommandList.Any(</span></span></span><span class="hljs-function">)) { </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">var</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">systemComand</span></span></span><span class="hljs-function"> = </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">systemCommandList</span></span></span><span class="hljs-function">.</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">First</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function">; </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">answerCallback</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">systemComand.Value.Item2(</span></span></span><span class="hljs-function">)); } </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">else</span></span></span><span class="hljs-function"> { </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">var</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">foundHandlers</span></span></span><span class="hljs-function"> = </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">FindHandler</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">command</span></span></span><span class="hljs-function">); </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">foreach</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">IActionHandler handler </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">in</span></span></span></span><span class="hljs-function"><span class="hljs-params"> foundHandlers</span></span></span><span class="hljs-function">) { </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">string</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">args</span></span></span><span class="hljs-function"> = </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">incomingMessage</span></span></span><span class="hljs-function">.</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">Substring</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(command</span></span></span><span class="hljs-function">).</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">Length</span></span></span><span class="hljs-function">).</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">Trim</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function">; </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">IActionHandler</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">hnd</span></span></span><span class="hljs-function"> = </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">handler</span></span></span><span class="hljs-function">; </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">var</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">cts</span></span></span><span class="hljs-function"> = </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">new</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">CancellationTokenSource</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">TimeSpan.FromSeconds(commandTimeoutSec</span></span></span><span class="hljs-function">)); </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">var</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">token</span></span></span><span class="hljs-function"> = </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">cts</span></span></span><span class="hljs-function">.</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">Token</span></span></span><span class="hljs-function">; </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">Task</span></span></span><span class="hljs-function">.</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">Run</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span></span><span class="hljs-function">) =&gt;</span></span> { using (cts.Token.Register(Thread.CurrentThread.Abort)) { <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { hnd.HandleMessage(args, data, answerCallback); } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (Exception ex) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (OnErrorOccured != <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { OnErrorOccured(ex); } answerCallback(command + <span class="hljs-string"><span class="hljs-string">"    :("</span></span>); } } },token); } } } } public delegate <span class="hljs-keyword"><span class="hljs-keyword">void</span></span> onErrorOccuredDelegate(Exception ex); public event onErrorOccuredDelegate OnErrorOccured; private List&lt;IActionHandler&gt; FindHandler(string command) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> handlers.Where(<span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">x</span></span></span><span class="hljs-function"> =&gt;</span></span> x.CallCommandList.Any(<span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">y</span></span></span><span class="hljs-function">=&gt;</span></span>y.Equals(command, StringComparison.OrdinalIgnoreCase))).ToList(); } private string GetSystemCommands() { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-built_in"><span class="hljs-built_in">String</span></span>.Join(Environment.NewLine, systemCommands.Select(<span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">x</span></span></span><span class="hljs-function"> =&gt;</span></span> <span class="hljs-built_in"><span class="hljs-built_in">String</span></span>.Format(<span class="hljs-string"><span class="hljs-string">"!{0} - {1}"</span></span>, x.Key, x.Value.Item1)).ToList()); } private string GetUserDefinedCommands() { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-built_in"><span class="hljs-built_in">String</span></span>.Join(Environment.NewLine, handlers.Select(<span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">x</span></span></span><span class="hljs-function"> =&gt;</span></span> <span class="hljs-built_in"><span class="hljs-built_in">String</span></span>.Format(<span class="hljs-string"><span class="hljs-string">"{0} - {1}"</span></span>, string.Join(<span class="hljs-string"><span class="hljs-string">" / "</span></span>, x.CallCommandList.Select(<span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">y</span></span></span><span class="hljs-function"> =&gt;</span></span> botCommandPrefix + y)), x.CommandDescription)).ToList()); } }</code> </pre><br></div></div><br><br>  The bot is ready, the final touch remains - to connect it with the console application that processes messages from Skype. <br><br><div class="spoiler">  <b class="spoiler_title">The final version of Program.cs for the console application</b> <div class="spoiler_text">  Comments are exposed only on new sections of the code. <br><pre> <code class="hljs pgsql"><span class="hljs-keyword"><span class="hljs-keyword">class</span></span> Program { private static Skype skype = <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> Skype(); //   private static HelloBot bot; static <span class="hljs-type"><span class="hljs-type">void</span></span> Main(string[] args) { bot = <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> HelloBot(); //   ,    bot.OnErrorOccured += BotOnErrorOccured; Task.Run(delegate { try { skype.MessageStatus += OnMessageReceived; skype.Attach(<span class="hljs-number"><span class="hljs-number">5</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>); Console.WriteLine("skype attached"); } catch (<span class="hljs-keyword"><span class="hljs-keyword">Exception</span></span> ex) { Console.WriteLine("top lvl exception : " + ex.ToString()); } <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">true</span></span>) { Thread.Sleep(<span class="hljs-number"><span class="hljs-number">1000</span></span>); } }); <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">true</span></span>) { Thread.Sleep(<span class="hljs-number"><span class="hljs-number">1000</span></span>); } } static <span class="hljs-type"><span class="hljs-type">void</span></span> BotOnErrorOccured(<span class="hljs-keyword"><span class="hljs-keyword">Exception</span></span> ex) { Console.WriteLine(ex.ToString()); } private static <span class="hljs-type"><span class="hljs-type">void</span></span> OnMessageReceived(ChatMessage pMessage, TChatMessageStatus status) { Console.WriteLine(status + pMessage.Body); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (status == TChatMessageStatus.cmsReceived) { //            SendMessage,   ,    bot.HandleMessage(pMessage.Body, answer =&gt; SendMessage(answer,pMessage.Chat), <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> SkypeData(){FromName = pMessage.FromDisplayName}); } } <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> static <span class="hljs-keyword"><span class="hljs-keyword">object</span></span> _lock = <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> <span class="hljs-keyword"><span class="hljs-keyword">object</span></span>(); private static <span class="hljs-type"><span class="hljs-type">void</span></span> SendMessage(string message, Chat toChat) { //            <span class="hljs-keyword"><span class="hljs-keyword">lock</span></span><span class="hljs-string"><span class="hljs-string">' lock (_lock) { //  ,    . ! toChat.SendMessage(message); } } }</span></span></code> </pre><br></div></div><br><br>  That's all.  A couple of days my colleagues and I wrote a couple of modules.  Examples under the cut. <br><br><div class="spoiler">  <b class="spoiler_title">Written modules</b> <div class="spoiler_text">  ! bash displays a random quote from bash <br>  ! ithap displays random IT history <br>  !  weather shows the current weather in Minsk <br>  ! say says what you want <br>  ! calc performs arithmetic operations (via the NCalc library) <br><div class="spoiler">  <b class="spoiler_title">18+ :)</b> <div class="spoiler_text">  !  Tits takes a random photo from the toggle switch.  Well, what about without them.  By the way, one of the most popular commands in the chat)) <br></div></div><br>  !  the course displays the current rates and through the parameters can detail the output.  Exchange euro to usd and so on. <br>  other. <br></div></div><br><br>  <b>Known Issues</b> <br>  Unfortunately, something in the protocol seems to have changed and the bot does not see the new group chats.  Old for some reason picks up with a bang, but with new problems.  I tried to dig, but did not find a solution.  If someone tells me how to overcome this sore, I will be grateful. <br>  It also sometimes happens that messages are lost and Skype needs ‚Äúwarming up‚Äù, after which it starts up and responds adequately to all subsequent messages. <br><br><h4>  Total </h4><br>  As a result, we have what we have.  The bot does not depend on the client, it supports the system of modules and all the source code of all this stuff is uploaded to the github: <a href="https://github.com/Nigrimmist/HelloBot">https://github.com/Nigrimmist/HelloBot</a> .  If someone has the desire and time - I am waiting for pull-requests of your useful modules :) <br><br>  Bot can poke a stick on skype name: <b>mensclubbot</b> .  Authorization is not required.  The list of modules can be looked through "! Modules".  It is spinning on the hosting, so it works 24h. <br><br>  Thank you for your attention, I hope the first pancake did not go lumpy and the material was useful. </div><p>Source: <a href="https://habr.com/ru/post/238363/">https://habr.com/ru/post/238363/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../238353/index.html">Autotest - lordly business</a></li>
<li><a href="../238355/index.html">Startup Guide, Part 7: Why the Initial Business Plan Is Not So Important</a></li>
<li><a href="../238357/index.html">Astronomers discovered complex carbon compounds for the first time at the sites of star formation.</a></li>
<li><a href="../238359/index.html">New language-independent NLP library</a></li>
<li><a href="../238361/index.html">Startup Guide, Part 8: Hiring, Managing, Promoting and Dismissing Executive Directors</a></li>
<li><a href="../238367/index.html">The benefits of restrictions in the collective blog</a></li>
<li><a href="../238373/index.html">Google changed the developer agreement, leaving the right to remove applications from user devices</a></li>
<li><a href="../238375/index.html">IBM Watson gets closer to business and regular users.</a></li>
<li><a href="../238377/index.html">UDP and C # async / await</a></li>
<li><a href="../238379/index.html">Who is blocking the Chinese firewall?</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>