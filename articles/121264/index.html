<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Security and problems with it in MODx Revolution</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="This topic is dedicated to the security of MODx Revolution as a whole, as well as connectors and contexts separately (Revolution 2.1.0 release). 

 Ba...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Security and problems with it in MODx Revolution</h1><div class="post__text post__text-html js-mediator-article">  This topic is dedicated to the security of MODx Revolution as a whole, as well as connectors and contexts separately (Revolution 2.1.0 release). <br><br>  Background: there was a question to create a serious resource on the MODx Revolution engine.  We did not see any technical problems, but decided to pay more attention to the issues of engine security. <br>  Honestly, I have always considered the security mechanisms in the MODx Revolution very flexible and reliable, but here I received quite a few surprises ... We will try to make them out as much as possible and in more detail. <br><br>  Whoever loves to read the most interesting things right away, start reading with the words ‚ÄúNow let's summarize what the connector needs to work ........‚Äù, since at first we considered not the problem, but the task. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      UDP: in version 2.1.1 fixed.  But knowing how much&gt; 2.1.0 is still raw, I am sure that 99% of Revo in progress are earlier releases. <br><br><a name="habracut"></a><br>  First, we take into account the most common myth with open-source products: "It's easy to download engines, dig it and find holes."  Let's not prove the opposite, but just do one trick: change the file structure.  We rename the main folders of MODx (assets /, connectors /, manager /), and the core / are generally transferred outside the root directory of the site so that there is no undermining through the address bar at all. <br>  The truth is there are a few points with this: <br><ol><li>  There are subtleties of transfer manager / folder.  I do not want to repeat, read <a title="MODx file system" href="http://newpg.ru/documentation/modx/modx-revolution/modx-revolution-fajlovaya-model.html">here.</a> </li><li>  Get ready for some plugins to fly.  This is especially true of the directresize plugin.  In it, firstly, assets / are strictly written, and secondly, the paths to the pictures in the file system are not absolute, but relative, which, in turn, also leads to errors. </li><li>  Never write hard paths in your code, be sure to use the system variables base_path, core_path, etc. </li></ol><br>  Thus, it will protect you at least a little from targeted file system probing (for example, from neighboring accounts on a leaky virtual hosting). <br><br>  Secondly, we decided to make an associated service for privileged users, but not on the basis of the admin panel (that is, not so that they entered the admin panel, there all the security settings were hidden from them, except for the new module for them), but based on the additional context (i.e., on a new subdomain, etc.).  In our case, MODx Revolution is a multi-site platform))). <br>  Here all the fun begins ... <br><br>  So, in order ... <br>  To begin with, we create a new context, create several documents we need in it, prescribe all the necessary settings, bind a new subdomain to the site, in the index file we prescribe the required context for this domain ... We check and work.  Now the most important thing is to deny access to this context to everyone except those who are allowed ... <br><br>  Before continuing, a little about the principles of security: <br><br>  In MODx Revolution, the rule applies to everything: ‚ÄúIf rights are assigned to something, then the principle‚Äú everything that is not allowed, then it is forbidden ‚Äù.  And if nothing is assigned to anyone, then everything is possible for everyone. ‚Äù <br>  I explain: If there is a group of resources to which access is assigned to someone, then all others who are not allowed to go through the forest.  And if you simply created a group of resources for grouping, then everyone has access to them. <br>  It is the same with contests: if access to the context is assigned access for some Security Policy Roles, then all the others go through the forest.  Everything is logical. <br><br>  So, we could create a group of resources to which we would assign access levels, and into which our closed documents would be combined.  But we have refused this simple method, because, firstly, the human factor could take place (for example, someone created a new resource and forgot to add it to the group), and secondly, we wanted to block access to everything context: whether to log in, or go further. <br><br>  So we decided to close access to the context.  I climb, it means, to edit our new context in order to deny access to it ... And then I entered a small stupor ... And how is it, to close access to it?  The context is set to access for the role of a super-user, no one else.  However, everyone has access. <br>  After thinking, I understand that it is logical that they have access to it, this is a public context ... But then why in general there is a mechanism for accessing contexts? <br>  Having gotten better, everything turned out to be simple: it turns out that access to public contexts is not checked for access at all, access is checked only for the context of mgr, because the request handlers are generally different.  This is also a separate article, so I <a title="about accessing contexts MODx Rvolution" href="http://newpg.ru/documentation/modx/modx-revolution/modx-revolution-nastrojki-bezopasnosti.html">am</a> sending to what has already been written: <a title="about accessing contexts MODx Rvolution" href="http://newpg.ru/documentation/modx/modx-revolution/modx-revolution-nastrojki-bezopasnosti.html">about access to contexts MODx Rvolution</a> <br><br>  Good.  We create a new handler for our context that intercepts access to the context.  By the way, here MODx shows itself in all its glory.  It takes literally 30 minutes (taking into account the development of new technologies and 10 lines of code).  If not authorized, display the authorization page.  If it is authorized, but does not have access to the download panel (A custom security policy setting was added specifically for this), then it displays a message about the lack of access.  It turned out just fine: even super-users, if they are not simultaneously in the right group of users and access to the context with a specific Role, do not have access to the panel.  Super))) <br><br>  Everything seems to be cool, but I got to write the necessary connectors.  I create a connector according to the rules, prescribe a code, create a processor.  I fulfill the request ... Empty answer.  This is due to the execution of the file connectors / index.php <br>  There is such code there: <br><blockquote><code><font color="black"><font color="#0000ff">if</font> (defined( <font color="#A31515">'MODX_REQP'</font> ) &amp;&amp; MODX_REQP === <font color="#0000ff">false</font> ) { <br> } <font color="#0000ff">else</font> <font color="#0000ff">if</font> (!$modx-&gt;context-&gt;checkPolicy( <font color="#A31515">'load'</font> )) { <br> <br> @session_write_close(); <br> die(); <br> }</font> <br> <br></code> </blockquote><br><br>  That is, you have 2 options: <br><ol><li>  Register in the define connector ('MODX_REQP', false);  In this case, the check for the right to execute the script is disabled in general.  Stupidly all possible. </li><li>  Assign rights to this context to the right load.  This is more preferable if you want to restrict access to the connector.  There is only one problem in this case: if in the first case, in the event of an error in executing the code, the answer will be given in JSON format, then in case, there will be no answer at all. </li></ol><br>  We went the second way.  But still still not beeping.  A little more.  As a result, we came to the conclusion that it is necessary to have such a line here: $ _SERVER ['HTTP_MODAUTH'] = $ modx-&gt; site_id;  Actually, it is the $ modx-&gt; site_id variable (global $ site_id) that is the reason for writing this article.  But more on that later‚Ä¶ <br><br>  In general, we prescribe it in the connector.  Still not working.  It turns out that you need to set another variable $ _REQUEST ['ctx'] = 'context_id';  And this is a source of headache, because if it is not hard to prescribe, you can send ctx even in GET, at least in a POST request.  This is actually the context key. <br><br>  Now let's summarize what the connector needs and what the global problem is: <br>  For work it is necessary: <br><ol><li>  $ _REQUEST ['ctx'] - context key passed in any way; </li><li>  $ site_id is the key of the site, registered in the MODx config, it is also $ _SERVER ['HTTP_MODAUTH'] </li></ol><br><br>  So, the focus: let's say we use the security policy settings when the connector is executed.  We transfer to it ctx of our context.  All biting.  To whom it is possible to perform, to that it is possible, and to whom it is impossible, that is impossible.  And here we take these, and prescribe a fan of ctx = sdfsdfsdfsdfsdf.  What is happening at the moment?  The sdfsdfsdfsdfsdfsd context is initialized (interesting to know, do you have one?)))).  Here I have no such context.  And what do you think everything is broken?  Nifiga !!!  MODx does not check for contexts.  Moreover, it generally does not check!  He stupidly applies the sdfsdfsdfsdfsdfsd context settings and the sdfsdfsdfsdfsdf context security policies!  And since there are no security policies for the sdfsdfsdfsdfsdf context, then (we recall the rule above), if nothing is forbidden, then everything is possible !!!  That is, the connector is running. <br>  Moreover.  It turns out that in order to gain access to everything and everyone (including in the admin panel, that is, in the context of mgr), you do not need to tyirt a bunch of logins / passwords and other Labuda.  The main thing is to steal the mischievous $ site_id (which is also global!) That is, it can be intercepted in even the most deadly piece of code missed through $ modx or if you have access to config.inc.php). <br>  What do you get by getting $ site_id?  Full access to admin requests to MODx.  Try it yourself on your sites.  If you are not authorized, send a simple GET request connectors / resource / index.php? &amp; HTTP_MODAUTH = {value $ site_id} &amp; ctx = fgdfgdfg &amp; action = getToolbar.  In this case, we substitute the value of the $ site_id variable as the HTTP_MODAUTH variable (but this is not enough, as the mgr context is still initialized), and the ctx lamp variable we force MODx to initialize a non-existent context, that is, to apply the absence of security settings.  And of course, do not forget about the action variable (you can easily debug all these requests using the same firebug by playing around in the admin area of ‚Äã‚Äãyour site, or by downloading the release from the MODx off site).  Everything!  Accessed!  Of course, you will have to rummage to write some interesting requests, but as a result we can easily access the file system through the MODx embedded file manager‚Ä¶ <br><br>  So guys, protect your sites, who have something important :-) <br><br>  By the way, how to do it? <br>  Very simple.  In the file connectors / index.php rewrite the code <br><blockquote> <code><font color="black">$ctx = isset($_REQUEST[ <font color="#A31515">'ctx'</font> ]) &amp;&amp; !empty($_REQUEST[ <font color="#A31515">'ctx'</font> ]) ? $_REQUEST[ <font color="#A31515">'ctx'</font> ] : <font color="#A31515">'mgr'</font> ; <br> $modx-&gt;initialize($ctx);</font> <br> <br></code> </blockquote><br>  on <br><blockquote> <code><font color="black"><font color="#008000">/* initialize the proper context */</font> <br> $ctx = <font color="#A31515">'mgr'</font> ; <br> $modx-&gt;initialize($ctx);</font> <br> <br></code> </blockquote><br>  that is, initialize the mgr context tightly.  This is an example.  Further already look at tasks. </div><p>Source: <a href="https://habr.com/ru/post/121264/">https://habr.com/ru/post/121264/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../121257/index.html">Google has confirmed the acquisition of Admeld</a></li>
<li><a href="../121258/index.html">Snot blistering</a></li>
<li><a href="../121259/index.html">Facebook is preparing for the one hundred billion IPO in early 2012</a></li>
<li><a href="../121260/index.html">Are you still suffering without flash? Express review of Flash browsers for iPhone and iPad</a></li>
<li><a href="../121262/index.html">Traffic Signs Alert in Navigator</a></li>
<li><a href="../121265/index.html">Versioned migration of database structure: main approaches</a></li>
<li><a href="../121266/index.html">Do you have all the moves recorded? Pro GPS Logger</a></li>
<li><a href="../121268/index.html">EP is an easy and fast way to access public services</a></li>
<li><a href="../121270/index.html">Hacker group Lulz Security reached the sites of Bethesda Softworks and the US Senate</a></li>
<li><a href="../121272/index.html">Game section on the 27th Point in Moscow in conjunction with Alawar Entertainment</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>