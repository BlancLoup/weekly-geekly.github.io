<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Its WEB application, with MVC and registry</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="I want to bring a simple and working project template, with which any new to PHP programming can create their own web application and at the same time...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Its WEB application, with MVC and registry</h1><div class="post__text post__text-html js-mediator-article"><div style="text-align:center;"><img src="https://habrastorage.org/files/26b/3b0/95f/26b3b095f17a4493b8b34c52f3b35ad9.jpg"></div><br>  I want to bring a simple and working project template, with which any new to PHP programming can create their own web application and at the same time get involved in the MVC theme. <br><br>  The article is aimed at beginners, i.e.  there is nothing new in it, just a few ideas are collected in a working draft that solves most of the problems. <br><a name="habracut"></a><br>  The project begins with a structure.  Simple and logical structure - the key to <s>success of the</s> project and the fact that someone other than the creator will be able to understand it. <br><br>  In detail, what is MVC, can be found <a href="https://habrahabr.ru/post/181772/">here</a> and <a href="https://habrahabr.ru/post/215605/">here</a> . 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      In short, this is the division of code into Model (logic), Representation and Controller. <br><br><div class="spoiler">  <b class="spoiler_title">Slightly more</b> <div class="spoiler_text">  The controller responds to user actions.  This is a certain manager, he does not know how to create or present a product, but he knows who can create (model) and present (presentation).  The controller does not process the data, the maximum adds the result of several model calls. <br><br>  The model contains the logic and data of the application.  A certain San Sanych, that the controller will order from him, he will get it from the warehouse, if necessary by finishing it with a file.  The model interacts with the database, and processes the result.  It is important to process data in the model; there is an article on this topic <a href="https://habrahabr.ru/post/175465/">https://habrahabr.ru/post/175465/</a> .  In short, when the logic is in models, it is easier to reuse it both within the project and transfer it to others. <br><br>  The presentation is a real seller.  Not too smart and knows only what the controller has trusted.  The task of the presentation is only to provide information.  It includes the layout (templates). <br></div></div><br>  In the MVC architecture, it is important that the components know nothing about each other, and therefore are independent.  If we want to change the appearance of the form on the site, it should affect only the presentation.  If we make changes to the database, then this should apply only to the model. <br><br>  The advantages of such an architecture: it is possible to test the components separately - it is easier to look for bugs, the designer can correct the layout on the site, and the logic can be transferred to another project. <br><br>  I suggest using as a simple application architecture: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/files/a59/9aa/44a/a599aa44a1204304bf06cfe1bef2a136.png"></div><br>  Controllers are separate, models are separate, the presentation is folded into folders (in the base folder there are universal reusable templates, such as pagination).  In the folder s - resources: images, JavaScript and styles. <br><br>  First of all, the rules for the server in htacess: <br><br><pre><code class="apache hljs"><span class="hljs-comment"><span class="hljs-comment"># AddDefaultCharset utf-8 RewriteEngine on RewriteBase / #     RewriteCond %{REQUEST_FILENAME} !-f RewriteCond %{REQUEST_FILENAME} !-d #    /employee/ RewriteRule ^([Az]*)\/$ ?type=page&amp;controller=$1&amp;action=main [L,QSA] #   RewriteRule ^([Az]*)\/([Az]*)\/$ ?type=page&amp;controller=$1&amp;action=$2 [L,QSA] #Ajax RewriteRule ^ajax\/([Az]*)\/([Az]*)\/$ ?type=ajax&amp;controller=$1&amp;action=$2 [L,QSA] ErrorDocument 404 /404.html</span></span></code> </pre> <br>  The application will have a single entry point (that is, all requests to the site, with the exception of files, will be redirected to 1 script) - index.php.  In him: <br><br><pre> <code class="php hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?</span></span> session_start(); <span class="hljs-comment"><span class="hljs-comment">//   $type = $_REQUEST['type']; //   include $_SERVER['DOCUMENT_ROOT']. "/config.php"; //   include $_SERVER['DOCUMENT_ROOT']."/model/functions.php"; //       include $_SERVER['DOCUMENT_ROOT']."/model/db.php"; //  include $_SERVER['DOCUMENT_ROOT']."/model/reestr.php"; //   r::g('Controller_Main')-&gt;setRequest($_REQUEST); if ($type == 'ajax') { r::g('Controller_Main')-&gt;ajax($_REQUEST['controller'], $_REQUEST['action'], $_REQUEST['send']); } else { r::g('Controller_Main')-&gt;page($_REQUEST['controller'], $_REQUEST['action'],$_REQUEST); }</span></span></code> </pre><br>  Our application will have 2 types of requests: pages and ajax requests, both types are processed in the main controller, the corresponding functions. <br><br><div class="spoiler">  <b class="spoiler_title">Config file</b> <div class="spoiler_text">  &lt;? <br>  // MySQl database connection settings <br>  define ("sql_user", "root"); // Login <br>  define ("sql_host", "localhost"); // Server address <br>  define ("sql_pass", ""); // Password <br>  define ("sql_table", "loumvc"); // Database table <br>  define ("title", "Easy MVC"); // Basic title <br></div></div><br>  Classes will be loaded at initialization using the autoloader.  That is, when you initialize the class new Controller_main (), provided that a file with such a class is not connected, 'Controller_main' will be transferred to our function loader, and it will break up the class name by "_" and try to connect the /controller/main.php file .  If it fails, it will redirect the user to 404 page.  Announcement and autoloader connections, we will write in the /model/function.php file, which we manually connected. <br><br><pre> <code class="php hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?php</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">autoload</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($class_name)</span></span></span><span class="hljs-function"> </span></span>{ $class_name = mb_strtolower($class_name); $arPath = explode(<span class="hljs-string"><span class="hljs-string">"_"</span></span>, $class_name); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (file_exists($_SERVER[<span class="hljs-string"><span class="hljs-string">'DOCUMENT_ROOT'</span></span>] . <span class="hljs-string"><span class="hljs-string">"/"</span></span> .implode(<span class="hljs-string"><span class="hljs-string">"/"</span></span>, $arPath) . <span class="hljs-string"><span class="hljs-string">".php"</span></span>)) { <span class="hljs-keyword"><span class="hljs-keyword">include_once</span></span>($_SERVER[<span class="hljs-string"><span class="hljs-string">'DOCUMENT_ROOT'</span></span>] . <span class="hljs-string"><span class="hljs-string">"/"</span></span> .implode(<span class="hljs-string"><span class="hljs-string">"/"</span></span>, $arPath) . <span class="hljs-string"><span class="hljs-string">".php"</span></span>); }<span class="hljs-keyword"><span class="hljs-keyword">else</span></span>{ <span class="hljs-comment"><span class="hljs-comment">//   r::g('Controller_main')-&gt;error404(); die(); } } //     spl_autoload_register('autoload');</span></span></code> </pre><br><div class="spoiler">  <b class="spoiler_title">More in the file are optional, but very useful debug functions</b> <div class="spoiler_text"><pre> <code class="php hljs"><span class="hljs-comment"><span class="hljs-comment">// ,       function pr() { $args = func_get_args(); foreach ($args as $item) { echo "&lt;pre&gt;"; print_r($item); echo "&lt;/pre&gt;"; } } //    function dlog($name,$text){ if(!is_string($text)){ $text = print_r($text,true); } db::insertArr('log',array( 'name'=&gt;$name, 'val'=&gt;$text ),1); }</span></span></code> </pre><br></div></div><br>  To work with a database, a class with static functions.  It can be used anywhere in the program.  (This is done to make it easier to use the logging function; it is not necessary to access the database outside the model.). <br><br><div class="spoiler">  <b class="spoiler_title">Code</b> <div class="spoiler_text"><pre> <code class="php hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">db</span></span></span></span>{ <span class="hljs-comment"><span class="hljs-comment">//   private static $connect = null; //  id private static $lastId = 0; // private static $log = 0; //    static function query($query,$skipLog=0){ if(self::$connect==null){ self::$connect = new mysqli(sql_host, sql_user, sql_pass, sql_table); if(self::$connect-&gt;connect_errno){ die('   '); } } //  , id   ,       self::$lastId = 0; $res = self::$connect-&gt;query($query); $lastId = self::$connect-&gt;insert_id; //  ,   ,   if(!$skipLog &amp;&amp; self::$log){ dlog('query',$query); } self::$lastId = $lastId; return $res; } static function insertArr($table,$arr,$skipLog=0){ $sql = "INSERT INTO `$table` "; //   foreach($arr as $key=&gt;$val){ $val = self::$connect-&gt;mysqli_escape_string($val); } $sql .= "(`".implode("`,`",array_keys($arr))."`) VALUES ('".implode("','",array_values($arr))."')"; self::query($sql,$skipLog); return self::insertId(); } // id    static function insertId(){ return self::$lastId; } static function insert($query){ self::query($query); // id    return self::insertId(); } static function selectCell($query){ $row = self::selectRow($query); if($row){ return reset($row); } } static function selectRow($query){ $res = self::select($query); if($res){ return reset($res); } } static function select($query){ $res = self::query($query); $mas = array(); if($res) { while ($row = $res-&gt;fetch_assoc()){ if($row['ARRAY_KEY']){ $key = $row['ARRAY_KEY']; unset($row['ARRAY_KEY']); $mas[$key]=$row; }else{ $mas[]=$row; } } return $mas; } } static function update($table,$mass,$id){ $sql = "UPDATE `$table` SET "; foreach($mass as $key=&gt;$it){ $it = self::$connect-&gt;mysqli_escape_string($it); $sql .= " $key='$it',"; } $sql = substr($sql, 0,-1); $sql .= " where id = $id"; return self::query($sql); } }</span></span></code> </pre><br></div></div><br>  Instead of a <s>great</s> bike <s>class</s> , you can use a wrapper implementation for a plugin, for example db simple. <br><br><div class="spoiler">  <b class="spoiler_title">Code</b> <div class="spoiler_text"><pre> <code class="php hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">db</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> $connect = <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getConnect</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">self</span></span>::connect == <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>){ <span class="hljs-keyword"><span class="hljs-keyword">require</span></span>($_SERVER[<span class="hljs-string"><span class="hljs-string">'DOCUMENT_ROOT'</span></span>] . <span class="hljs-string"><span class="hljs-string">'/libs/DbSimple/Generic.php'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>::$connect = DbSimple_Generic::connect(<span class="hljs-string"><span class="hljs-string">"mysql://"</span></span> . sql_user . <span class="hljs-string"><span class="hljs-string">":"</span></span> . sql_pass . <span class="hljs-string"><span class="hljs-string">"@"</span></span> . sql_host . <span class="hljs-string"><span class="hljs-string">"/"</span></span> . sql_table); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(!<span class="hljs-keyword"><span class="hljs-keyword">self</span></span>::$connect){ <span class="hljs-keyword"><span class="hljs-keyword">die</span></span>(<span class="hljs-string"><span class="hljs-string">"   "</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>::$connect-&gt;query(<span class="hljs-string"><span class="hljs-string">"SET NAMES UTF8"</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>::$connect; } <span class="hljs-comment"><span class="hljs-comment">//  query static function query() { $res = call_user_func_array(array(self::getConnect(), 'query'), func_get_args()); return $res; } //  select static function select() { $res = call_user_func_array(array(self::getConnect(), 'select'), func_get_args()); return $res; } //      static function __callStatic($name, $arguments) { if(method_exists(self, $name)){ return call_user_func_array(array(self, $name), $arguments); }else{ return call_user_func_array(array(self::getConnect(), $name), func_get_args()); } } }</span></span></code> </pre><br></div></div><br>  The application uses a registry ‚Äî a singleton pattern implementation ‚Äî a loner that stores all instances (initialized class objects) of all models and controllers.  Thanks to him, each class in the project will be initialized only once, and we will easily get access to it.  To do this, refer to the classes as follows: <br><br><pre> <code class="php hljs">r::g(<span class="hljs-string"><span class="hljs-string">" "</span></span>)</code> </pre><br>  Registry implementation: <br><br><pre> <code class="php hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?</span></span> <span class="hljs-comment"><span class="hljs-comment">//     class r { //       protected static $instance = array();//  //   static function g($name){ if(self::$instance[$name]){ return self::$instance[$name]; }else{ //     return self::add($name, new $name() ); } } //     static function add($name,$val){ return self::$instance[$name] = $val; } }</span></span></code> </pre><br>  Each controller will inherit a base one in which we implement the function that outputs a representation. <br><br><pre> <code class="php hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?php</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">controller_base</span></span></span></span>{ <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">view</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($name,$args=null,$isBase=</span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">0</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span></span>{ ob_start(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>($isBase){ $tpl = $_SERVER[<span class="hljs-string"><span class="hljs-string">'DOCUMENT_ROOT'</span></span>]. <span class="hljs-string"><span class="hljs-string">"/view/base/{$name}.php"</span></span>; }<span class="hljs-keyword"><span class="hljs-keyword">else</span></span>{ <span class="hljs-comment"><span class="hljs-comment">//   $class = explode("_",get_class($this)); $tpl = $_SERVER['DOCUMENT_ROOT']. "/view/{$class[1]}/{$name}.php"; } if(file_exists($tpl)){ if($args){ //    ,     extract($args); } include $tpl; }else{ echo "no tpl {$class[1]}/{$name}"; } return ob_get_clean(); }</span></span></code> </pre><br>  Even in the base controller, we implement the registry to store the page title, with the ability to change it from any controller. <br><br><div class="spoiler">  <b class="spoiler_title">Code</b> <div class="spoiler_text"><pre> <code class="php hljs"> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> $title = <span class="hljs-string"><span class="hljs-string">''</span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getTitle</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(!<span class="hljs-keyword"><span class="hljs-keyword">self</span></span>::$title){ <span class="hljs-comment"><span class="hljs-comment">//    return title; } return self::$title; } function setTitle($title){ self::$title = $title; }</span></span></code> </pre><br></div></div><br><div class="spoiler">  <b class="spoiler_title">And saving the query</b> <div class="spoiler_text"><pre> <code class="php hljs"><span class="hljs-comment"><span class="hljs-comment">//      private static $request = null; function setRequest($param){ self::$request = $param; } function getRequest(){ return self::$request; }</span></span></code> </pre><br></div></div><br>  The main controller, all calls will come to him first <br><br><pre> <code class="php hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Controller_main</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Controller_base</span></span></span></span>{ <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">__construct</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;model = r::g(<span class="hljs-string"><span class="hljs-string">'Model_main'</span></span>); }</code> </pre><br>  In it, and in every other controller, we create a link to its model. To handle requests for building a page, we will entrust the page functions: <br><br><pre> <code class="php hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">page</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($controller,$action,$param)</span></span></span></span>{ <span class="hljs-comment"><span class="hljs-comment">//    ( ) if(!$controller){ $controller = 'main'; } //   main if(!$action){ $action = 'main'; } $method_name = "page_".$action; $controller_name = 'Controller_'.$controller; if(method_exists(r::g($controller_name), $method_name)){ //   ob_start(); r::g($controller_name)-&gt;{$method_name}($param); $html = ob_get_clean(); //   echo $this-&gt;view('page',array( 'html' =&gt; $html, 'title' =&gt; $this-&gt;getTitle() )); }else{ //    404 $this-&gt;error404(); } }</span></span></code> </pre><br>  It checks for the existence of the requested method in the requested controller, well, when you try to connect a non-existent controller, 404 will fall out (we arranged this in the class loader). <br><br>  The body of the page is generated by the page_ {action} methods.  So visually you can immediately see which functions are responsible for the generation of the pilgrim, and the methods with the name dropDataBase are protected from outside calls.  An example of such a function: <br><br><pre> <code class="php hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">page_main</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($param)</span></span></span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">echo</span></span> <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;view(<span class="hljs-string"><span class="hljs-string">'main'</span></span>); }</code> </pre><br><div class="spoiler">  <b class="spoiler_title">Code of the main page template</b> <div class="spoiler_text"><pre> <code class="php hljs">&lt;html&gt; &lt;head&gt; &lt;title&gt; <span class="hljs-meta"><span class="hljs-meta">&lt;?</span></span>= $title <span class="hljs-meta"><span class="hljs-meta">?&gt;</span></span> &lt;/title&gt; &lt;meta http-equiv=<span class="hljs-string"><span class="hljs-string">"Content-Type"</span></span> content=<span class="hljs-string"><span class="hljs-string">"text/html; charset=utf-8"</span></span> /&gt; &lt;script src=<span class="hljs-string"><span class="hljs-string">"//ajax.googleapis.com/ajax/libs/jquery/3.1.0/jquery.min.js"</span></span>&gt;&lt;/script&gt; &lt;script src=<span class="hljs-string"><span class="hljs-string">"/s/js/base.js"</span></span>&gt;&lt;/script&gt; &lt;script src=<span class="hljs-string"><span class="hljs-string">"/s/js/main.js"</span></span>&gt;&lt;/script&gt; &lt;script src=<span class="hljs-string"><span class="hljs-string">"/s/js/employee.js"</span></span>&gt;&lt;/script&gt; &lt;link href=<span class="hljs-string"><span class="hljs-string">"/s/css/index.css"</span></span> rel=<span class="hljs-string"><span class="hljs-string">"stylesheet"</span></span>&gt; &lt;/head&gt; &lt;body&gt; &lt;div <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class">="</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">menu</span></span></span><span class="hljs-class">"&gt; &lt;?= $</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">this</span></span></span><span class="hljs-class">-&gt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">widget_menu</span></span></span><span class="hljs-class">() ?&gt; &lt;/</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">div</span></span></span><span class="hljs-class">&gt; &lt;?= $</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">html</span></span></span><span class="hljs-class"> ?&gt; &lt;/</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">body</span></span></span><span class="hljs-class">&gt; &lt;/</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">html</span></span></span><span class="hljs-class">&gt;</span></span></code> </pre><br></div></div><br><div class="spoiler">  <b class="spoiler_title">Menu widget code in the main controller used in the main template</b> <div class="spoiler_text"><pre> <code class="php hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">widget_menu</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>{ <span class="hljs-comment"><span class="hljs-comment">// ,  ,      $request = $this-&gt;getRequest(); //    ,   ,   $menu = $this-&gt;model-&gt;getMenu($request['controller'],$request['action']); //    return $this-&gt;view('menu',[ 'list'=&gt;$menu ]); }</span></span></code> </pre><br></div></div><br>  Ajax requests are handled by the function: <br><br><pre> <code class="php hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ajax</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($controller,$action,$send)</span></span></span></span>{ $method_name = <span class="hljs-string"><span class="hljs-string">"ajax_"</span></span>.$action; $controller_name = <span class="hljs-string"><span class="hljs-string">'Controller_'</span></span>.$controller; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(method_exists(r::g($controller_name), $method_name)){ $res = r::g($controller_name)-&gt;$method_name($send); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>($res){ <span class="hljs-keyword"><span class="hljs-keyword">echo</span></span> <span class="hljs-string"><span class="hljs-string">"&lt;ja&gt;"</span></span> . json_encode($res) . <span class="hljs-string"><span class="hljs-string">"&lt;/ja&gt;"</span></span>; } } }</code> </pre><br>  It works like a page, with a few exceptions: <br><br><ul><li>  Searches for methods with the prefix ajax_ </li><li>  Does not buffer the output, but immediately displays the printed ajax_ {action} method </li><li>  If the ajax_ {action} method returns data, serialize this data and frame it with ja tags, print. </li></ul><br>  The latter is needed if we need to return more and structured data in javascript.  In the method called ajax_ {action}, you just need to return an array, and then the Controller_main-&gt; ajax function will ‚Äúfigure out‚Äù how to transfer the data to the frontend. <br><br>  Tags ja need to easily disassemble the answer on the frontend.  Let's receive separately the text, separately serialized array.  This will save traffic and CPU, so that we will not encode / decode html page.  And still protected from errors, no extra output will not break our front end. <br><br><div class="spoiler">  <b class="spoiler_title">An example from a class of employees, a method that opens a form for creating employees:</b> <div class="spoiler_text"><pre> <code class="php hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ajax_add</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">echo</span></span> <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;widgetAdd(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> [<span class="hljs-string"><span class="hljs-string">'status'</span></span>=&gt;<span class="hljs-number"><span class="hljs-number">1</span></span>]; }</code> </pre><br>  And the page method looks like this: <br><br><pre> <code class="php hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">page_add</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;setTitle(<span class="hljs-string"><span class="hljs-string">' '</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">echo</span></span> <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;view(<span class="hljs-string"><span class="hljs-string">'page_add'</span></span>,[ <span class="hljs-string"><span class="hljs-string">'html'</span></span> =&gt; <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;widgetAdd() ]); }</code> </pre><br>  Widget that is used in both cases: <br><br><pre> <code class="php hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">widgetAdd</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;view(<span class="hljs-string"><span class="hljs-string">'add'</span></span>,[ <span class="hljs-string"><span class="hljs-string">'divisions'</span></span>=&gt;<span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;model-&gt;getDivisions() ]); }</code> </pre><br></div></div><br>  I strongly recommend that you call templates by the name of the function they perform, or the method in which they are used.  And not only templates, but also functions in js. <br><br>  It turns out: in javascript you create the method ‚ÄúaddEmployee‚Äù, it sends a request to ‚Äúajax_addEmployee‚Äù, and the function uses the template ‚ÄúaddEmployee‚Äù.  Then it will be much easier to find them.  Then you want to fix the template, look in js for the name of the function and immediately edit the view, no need to search in the controller. <br><br><h3>  A little bit about the frontend: </h3><br>  The folder with the scripts will look like a folder of controllers: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/files/a59/9aa/44a/a599aa44a1204304bf06cfe1bef2a136.png"></div><br>  Also a basic script that all JS controllers will inherit from. <br><br><pre> <code class="javascript hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">base</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.post = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">method,send,callback</span></span></span><span class="hljs-function">)</span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> controller = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.url ; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> url = <span class="hljs-string"><span class="hljs-string">"/ajax/"</span></span>+controller+<span class="hljs-string"><span class="hljs-string">"/"</span></span>+method+<span class="hljs-string"><span class="hljs-string">"/"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> $.post(url,{ <span class="hljs-attr"><span class="hljs-attr">send</span></span> : send },<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">re</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> res = re.split(<span class="hljs-string"><span class="hljs-string">'&lt;ja&gt;'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (res[<span class="hljs-number"><span class="hljs-number">1</span></span>] != <span class="hljs-literal"><span class="hljs-literal">undefined</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> text = res[<span class="hljs-number"><span class="hljs-number">0</span></span>]; res = res[<span class="hljs-number"><span class="hljs-number">1</span></span>].split(<span class="hljs-string"><span class="hljs-string">'&lt;/ja&gt;'</span></span>); text += res[<span class="hljs-number"><span class="hljs-number">1</span></span>]; re = text; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> mas = $.parseJSON(res[<span class="hljs-number"><span class="hljs-number">0</span></span>]); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> mas = {}; } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">typeof</span></span> (callback) == <span class="hljs-string"><span class="hljs-string">'function'</span></span>) { callback(re, mas) } }) } <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.createPop = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">title, html</span></span></span><span class="hljs-function">) </span></span>{} } }base = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> base();</code> </pre><br><div class="spoiler">  <b class="spoiler_title">The code of the window creating function, a cheap analogue of the fancybox, with methods and buns.</b> <div class="spoiler_text"><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.createPop = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">title, html</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-comment"><span class="hljs-comment">//  ,    jqary var $win = $("&lt;div/&gt;", { class: 'Pop' }); // box c   var $box = $("&lt;div/&gt;", { class: 'winBox' }); //  , var $top = $("&lt;div/&gt;", { class: "winTop" }); //  var $title = $('&lt;div/&gt;', { class: "winTitle", html: title }); //     $top.append($title); //   , -     var $close = $("&lt;div/&gt;", { class: 'winClose', html: "x" }); $top.append($close); //     -    -   $close.on('click', function () { $win.remove(); }); //  $win.close = function () { $win.remove(); } //   null,  ,   if (html == null) { //   ,    html = "&lt;div class='help'&gt;   &lt;/div&gt;"; } //     $box.html(html); //        $win.append($top); $win.append($box); //   ,   $win.update = function (html) { $box.html(html); } //,         if ($('.BoxPop').length == 0) { //  -   $('body').append($('&lt;div/&gt;', { class: 'BoxPop' })); } //     ,     $('.BoxPop').append($win); //      return $win; }</span></span></code> </pre><br></div></div><br>  Actually inheritance and use of ajax: <br><br><pre> <code class="javascript hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">employee</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span>{ <span class="hljs-comment"><span class="hljs-comment">//  this.url = "employee"; //   var self = this; this.add = function(){ var $win = self.createPop(' ',null); self.post('add',{},function(re){ $win.update(re); }) } } employee.prototype = base; employee = new employee();</span></span></code> </pre><br>  And also, in order to protect your project from accessing scripts, in the folder controller, model and.  view it is necessary to put .htacess with the content: <br><br><pre> <code class="apache hljs"><span class="hljs-attribute"><span class="hljs-nomarkup"><span class="hljs-attribute"><span class="hljs-nomarkup">Deny</span></span></span></span> from <span class="hljs-literal"><span class="hljs-literal">all</span></span></code> </pre> <br>  Using this template, you can implement most of the tasks for web applications.  And most importantly, any other programmer who is familiar with MVC can easily understand your project. <br><br>  ‚Üí <a href="https://github.com/apilab-ru/loymvc/tree/master">All source code</a> </div><p>Source: <a href="https://habr.com/ru/post/321982/">https://habr.com/ru/post/321982/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../321970/index.html">How to sell, and not vparivat</a></li>
<li><a href="../321972/index.html">Maintenance of engineering data center systems: what should be in the contract</a></li>
<li><a href="../321974/index.html">The Ministry of Finance explained the procedure for paying VAT when transferring programs over the Internet</a></li>
<li><a href="../321976/index.html">How we moved from widgets and ‚Äúbricks‚Äù to an intuitive layout with the ability to embed html, css and javascript</a></li>
<li><a href="../321978/index.html">With the help of LAMP, I created a SaaS service bringing $ 3,700 a month. My history</a></li>
<li><a href="../321986/index.html">How was the frame rendered in the 1998 Thief game</a></li>
<li><a href="../321992/index.html">DDoS attacks: attack and defense</a></li>
<li><a href="../321996/index.html">Neural Network Based Interview Robot</a></li>
<li><a href="../321998/index.html">Using Tarantool in a .NET project on Windows</a></li>
<li><a href="../322000/index.html">Snake and coconut</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>