<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Migrating data from various types of storage using EMC VPLEX and EMC RecoverPoint technologies</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Migration of data processing centers (hereinafter referred to as the data center) is a non-trivial and time-consuming task, although, if there are bui...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Migrating data from various types of storage using EMC VPLEX and EMC RecoverPoint technologies</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/files/490/f20/98e/490f2098e05341c696a70a1c49d8849b.png"><br><br>  Migration of data processing centers (hereinafter referred to as the data center) is a non-trivial and time-consuming task, although, if there are built and tested processes, it is fairly easily executable.  Last summer I had the opportunity to work on the migration of two data centers, and since I deal mainly with SAN, I‚Äôll talk about how to migrate them. <br><br>  In the source data center, the customer had storage systems from IBM and NetApp, and in the destination, EMC VNX.  The task was to quickly and with minimal downtime migrate all hosts, both physical and virtual, to a new location.  Migrating data and hosts had to be performed with minimizing downtime - a very large company acted as the customer, and every minute was critical.  The optimal solution was the use of technology from EMC - VPLEX and RecoverPoint. <br><a name="habracut"></a><br>  After much deliberation, the following migration pattern was developed: 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      <b>Encapsulation</b> <br><br>  1. The host is shutting down; <br>  2. Zoning switches change from XIVax to VPLEX; <br>  3. The necessary Storage group is created on the VPLEX; <br>  4. The same thing is done on the destinaion side; <br>  5. A pair is created in RecoverPoint; <br>  6. Start asynchronous replication; <br>  7. Host turns on. <br><br>  <b>Migration</b> <br><br>  1. The host is shutting down; <br>  2. Replication stops, direct access to the destination side is enabled; <br>  3. The host is physically transported to the new data center; <br>  4. Host turns on. <br><br>  If everything is done correctly, the host should not even notice that it was transported to another place; all that remains is for the OS to connect the necessary moons. <br><br>  As we can see, the plan is not particularly complicated, however, during its execution, we had to face a lot of pitfalls, such as inconsistent data in the destination data center.  In this article I will try to give detailed instructions on the migration itself, as well as a working procedure that will help avoid our mistakes.  So let's go! <br><br>  I want to note that I am writing this procedure using examples XIV and VNX, but it applies to any systems. <br><br>  <b>Encapsulation</b> <br><br>  Presenting volumes from XIV to VPLX.  We need to connect to XIV, find all the volumes that our migrated host uses, and dump them on the VPLEX.  I think this will not cause difficulties.  Needless to say, you need to have zoning configured so that the XIV can see the VPLEX. <br><br>  We define volumes on the VPLEX.  The CLI is best for this. <br><br><pre><code class="bash hljs"><span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> /clusters/cluster-1/storage-elements/storage-arrays/&lt;IBM-XIV-SerialNumber1&gt; <span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> /clusters/cluster-1/storage-elements/storage-arrays/&lt;IBM-XIV-SerialNumber2&gt; <span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> /clusters/cluster-1/storage-elements/storage-volumes/ claim --storage-volumes VPD83T2:&lt;WWN_Volume&gt; --name &lt;Name_Volume&gt;</code> </pre> <br>  Create virtual volumes on the VPLEX source. <br><br>  Go to the Provision Storage -&gt; Storage array: <br><br><img src="https://habrastorage.org/files/f14/3c5/8b4/f143c58b46c34eab9441b6b50816107c.png"><br><br>  Then, on the ‚ÄúStorage Volumes‚Äù tab, we check that all our moons are presented (are in Claimed status) <br><br><img src="https://habrastorage.org/files/3cb/26a/e1d/3cb26ae1d18645718a2ad87809f8527a.png"><br><br>  Go to "Extents" and click "Create", select all LUNs from our host and add them. <br><br><img src="https://habrastorage.org/files/23d/d5e/837/23dd5e83778c4435841b7dd19a8cb615.png"><br><br>  Go to ‚ÄúDevices‚Äù.  We will need to create a device associated with our Extents.  Click "Create", after which we need to specify the type of device, in our case we need 1: 1 Mapping: <br><br><img src="https://habrastorage.org/files/222/54a/f7a/22254af7a3454d21ae5a9414d83ca5a1.png"><br><br>  Add all Extents created in the previous step, <b>disable</b> automatic creation of virtual volumes: <br><br><img src="https://habrastorage.org/files/2b2/244/3c3/2b22443c366d462e8f8b7066f10596cf.png"><br><br>  Now we need to create virtual volumes, for which we go to the appropriate menu item and click Create from Devices, select all the devices that we created in the previous step. <br><br><img src="https://habrastorage.org/files/853/b14/7fa/853b147fa3b44d738988f524d2fc2e46.png"><br><br>  After adding, please note that our new virtual volumes are still in the status of Unexported: <br><br><img src="https://habrastorage.org/files/8ec/f95/495/8ecf954957e543e2bd79710e3d00ae7f.png"><br><br>  Now let's zoning, as you understand, at the moment all our moons are presented not to the host, but to the VPLEX, and we need to reconfigure the zoning so that the host can see the moon data. We need to do this in both factories.  So: <br><br>  SAN01 <br><br><pre> <code class="bash hljs">alishow | grep &lt;ServerName&gt; zonecreate <span class="hljs-string"><span class="hljs-string">"&lt;ServerName&gt;_VPLEX"</span></span>,<span class="hljs-string"><span class="hljs-string">"&lt;AliasServerName&gt;;VPLEX_1E1_A0_FC00"</span></span> cfgadd <span class="hljs-string"><span class="hljs-string">"CFG_20160128_07h05FR_SCH"</span></span>,<span class="hljs-string"><span class="hljs-string">"&lt;ServerName&gt;_VPLEX_1E1_A0_FC00"</span></span> zonecreate <span class="hljs-string"><span class="hljs-string">"&lt;ServerName&gt;_VPLEX_1E1_B0_FC00"</span></span>,<span class="hljs-string"><span class="hljs-string">"&lt;AliasServerName&gt;;VPLEX_1E1_B0_FC00"</span></span> cfgadd <span class="hljs-string"><span class="hljs-string">"CFG_20160128_07h05FR_SCH "</span></span>,<span class="hljs-string"><span class="hljs-string">"&lt;ServerName&gt;_VPLEX_1E1_B0_FC00"</span></span> cfgsave cfgenable CFG_20160128_07h05FR_SCH cfgactvshow | grep &lt;ServerName&gt;</code> </pre><br>  Do the same for the second factory SAN02. <br><br>  Now we need to create a new host on VPLEX and present it to the moon.  We return to the VPLEX admin panel and go to <b>Initiators</b> .  If zoning is configured correctly, we should see two unregistered initiators: <br><br><img src="https://habrastorage.org/files/ff7/400/c9b/ff7400c9b4a64d548e4a508ea8685f8d.png"><br><br>  Once again, check the WWN and feel free to click Register.  In the next step, we set the name of our new initiator (I usually set the * name of the host_HBA number *), the type of host in our case is default. <br><br><img src="https://habrastorage.org/files/765/6e5/649/7656e564974043c18127870bb8cc0d23.png"><br><br>  We perform the same step for the second initiator.  Everything, our host sees VPLEX now, it remains only to present LUNs to it. <br><br>  Go to the Storage View and click Create, set the name of the Storage View (usually this is the host name), add initiators: <br><br><img src="https://habrastorage.org/files/476/f7f/aba/476f7faba7334e3383b7252303e66028.png"><br><br>  In the next step, we need to associate initiators with free ports on the VPLEX side.  First you need to make sure that all ports are selected: A0-FC00, A0-FC01, B0-FC00, and B0-FC01.  If they are not there, we check once again the correctness of the zoning setup and perform FC rescan on the host. <br><br><img src="https://habrastorage.org/files/b52/047/ca9/b52047ca96fd47bfb80dde89934b0d71.png"><br><br>  In the next step, select all volumes that we have created for our server, then specify the LUN numbers.  Be especially careful with this step: the LUN numbers should match the numbers we had on XIV.  Select Manually enter LUN numbers and assign the numbers accordingly. <br><br><img src="https://habrastorage.org/files/06a/2dd/c97/06a2ddc9790f4ac2b9c7b34e3f07a51a.png"><br><br>  Check everything again and click Close.  After this stage, all previously used disks can be connected back to the host; ideally, the host should not notice that it is now working with Storage via VPLEX.  It should be noted that, although we have added a new link to the chain, there should be no performance problems, latency, of course, can subside slightly, but only slightly.  But, I think this is a topic for a separate article, I conducted research in this area and, if the results are interesting, I will be happy to share them. <br><br>  We have almost completed the setup on the source side, now we will deal with destination.  We begin with the fact that once again we‚Äôll go to XIV and rewrite the exact size of our moons, I recommend to take the size in blocks. <br><br>  Go to VNX, then Storage -&gt; LUNs -&gt; Create LUN. <br><br>  We check the LUN settings, in our case the Storage Pool should be Pool Open, the LUN should be Thin, copy and paste the size and set the name.  There are no requirements for the name, therefore we are guided by the rules adopted in the organization. <br><br><img src="https://habrastorage.org/files/d2f/b45/79c/d2fb4579cd0746a88c0bb755fd44d9f4.png"><br><br>  I assume that your VPLEX is already connected, zoning is configured and the Storage Group on the VNX is created.  Therefore, after creating LUNs, we simply add them to the appropriate VPLEX Storage Group. <br><br>  The next step is to present the LUNs from VNX to VPLEX.  You can, of course, do this manually, but for this purpose I use a small script from EMC.  Download a useful utility from EMC - <a href="https://support.emc.com/downloads/5921_Navisphere-Agents-CLI---Windows">NavisphereCLI</a> and create a simple BAT file: <br><br> <code>REM remplacer FR1 par le nom du premier VNX. <br> <br> REM remplacer FR2 par le nom du deuxieme VNX. <br> <br> REM remplacer 0.0.0.0 IP VNX. <br> <br> REM remplacer 0.0.0.0 IP VNX. <br> <br> REM user/user: service/password <br> <br> rem naviseccli -AddUserSecurity -user sysadmin -password sysadmin -scope 0 <br> <br> del c:\R1.txt <br> <br> del c:\R2.txt <br> <br> "C:\EMC\NavisphereCLI\NaviSECCLI.exe" -h 0.0.0.0 getlun -uid -name &gt; c:\R1.txt <br> <br> "C:\EMC\NavisphereCLI\NaviSECCLI.exe" -h 0.0.0.0 getlun -uid -name &gt; c:\R2.txt <br></code> <br><br>  Of course, in the script, we need to fix the way.  The result of the script will be two files R1 and R2 (as in our case there are two locations). <br><br>  Go back to the VPLEX and map our LUNs.  Go to Provision Storage -&gt; Array Management, select our VNX and click Rediscover Array: <br><br><img src="https://habrastorage.org/files/fd3/2d3/e62/fd32d3e624884a6299b398a33f7eb0cf.png"><br><br>  After this procedure, again, select our VNX and click Claim Storage.  Next, select the item Use a Name Mapping File: <br><br><img src="https://habrastorage.org/files/ad8/532/c3c/ad8532c3c4484fecaeaab7243c6442f0.png"><br><br>  As is probably already clear, then we will need to specify the file that we generated using the script.  Next we need to see all the LUNs that were created on the VNX.  We give them a new name (I recommend giving a name by analogy with the source), and after all these procedures we see that the moons are presented: <br><br><img src="https://habrastorage.org/files/8b8/593/209/8b85932096234ad0b4598f42bb9972a2.png"><br><br>  Now we need to create Extents, Devices, Virtual Volumes and Storage Group.  All this is done by analogy with the source side and is not difficult.  By analogy, zoning and initiators are created.  After all these actions, the distination side is already ready to accept our host, we just have to set up replication. <br><br>  For RecoverPoint to work, you need a volume for logs, the so-called JVOL, create it on both sides and add it to the Storage Group that we created in the previous steps. <br><br>  So replication.  Open RecoverPoint and feel free to go to Protection -&gt; Protect Volumes: <br><br><img src="https://habrastorage.org/files/d10/a06/6ad/d10a066ad87c4dda915cf4ce9d512d2a.png"><br><br>  We are looking for our source VPLEX Consistency group, select the source site in the RPA cluster field and select all LUNs that will be replicated: <br><br><img src="https://habrastorage.org/files/410/22c/3b6/41022c3b68e842ddb2e5a4f524e3b1c4.png"><br><br>  In the next step, choose our JVOL.  Next, we will need to specify the name of the pair (any in accordance with the accepted rules), RPA cluster already select Destination and select Detination volumes: <br><br><img src="https://habrastorage.org/files/6ee/39d/163/6ee39d1636254181958afb61a5067995.png"><br><br>  Next, we need to specify the destination JVOL.  We will be shown a simple picture with our replication, after the appearance of which we press Add a copy. <br><br><img src="https://habrastorage.org/files/44c/208/a77/44c208a772434c199ac7d2ddefa1965b.png"><br><br>  Click on the name of our CG group and see a beautiful interactive synchronization status: <br><br><img src="https://habrastorage.org/files/788/bbb/f92/788bbbf92ab04efeb7db8263b6578f4e.png"><br><br>  We are waiting for the data to crash.  After that we will observe the following status: <br><br><img src="https://habrastorage.org/files/1a0/ebf/885/1a0ebf885f9d4fab8ebc6ce1a3d4f3ff.png"><br><br>  At this stage, we are all ready to physically move the host to a new data center.  But there is a caveat: be sure to turn off the host first, then stop replication. <br><br>  Let's say the host is already on the way, we need to break the pair and enable direct access for the host.  If we did not mess up with zoning, then after switching on the host will not even guess about its new location. <br><br>  We return to RecoverPoint, go through Protection -&gt; Manage Protection, find our CG group and click the Pause Transfer button: <br><br><img src="https://habrastorage.org/files/a37/c5c/9ca/a37c5c9ca0d84c6d9be04732ab87c577.png"><br><br>  Then we run the test with the Test Copy button, select our destination side and click Next select an image <br><br><img src="https://habrastorage.org/files/b41/2d9/beb/b412d9bebcf94d58b7c17f421ee0923b.png"><br><br>  In the next window, we leave everything by default; Warning is answered with YES.  We are waiting for the copy to be tested, and click Enable Direct Access. <br><br><img src="https://habrastorage.org/files/a51/f44/0d3/a51f440d391040f08545b828d15472e7.png"><br><br>  In fact, that's all.  Again, if you don‚Äôt get messed up with the settings of the zoning and initiators, the host should see all its LUNs with consistent data.  If you have any questions and additions to the article, I will be happy to answer them.  All easy migrations! </div><p>Source: <a href="https://habr.com/ru/post/276163/">https://habr.com/ru/post/276163/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../276151/index.html">How-to: Object-Oriented Python Backtesting</a></li>
<li><a href="../276153/index.html">How much did Google pay for the lost google.com domain?</a></li>
<li><a href="../276155/index.html">Symfony2 interceptor of exceptions using services or how to avoid using Event Listener</a></li>
<li><a href="../276157/index.html">Video Surveillance Solutions Need Enterprise Level Strategy</a></li>
<li><a href="../276159/index.html">Real-Time Games and Cross Domain Connection</a></li>
<li><a href="../276165/index.html">C ++ Game State Management</a></li>
<li><a href="../276169/index.html">Report on the fourth UX conference of the Russian school of service design</a></li>
<li><a href="../276171/index.html">Break Windows to fix it: ‚ÄúSeveral attempts were made, but the cause of the problem could not be determined‚Äù</a></li>
<li><a href="../276175/index.html">Automatic installation and configuration of PostgreSQL using Wix #</a></li>
<li><a href="../276179/index.html">WLAN architecture: what to choose?</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>