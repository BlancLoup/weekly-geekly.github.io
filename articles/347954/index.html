<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>How we developed the technology to detect devices nearby</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="This story began with the function ‚ÄúNear‚Äù in one of our mobile apps. We wanted users to quickly create a group chat or add nearby users as friends. We...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>How we developed the technology to detect devices nearby</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/webt/mf/ni/l9/mfnil9g4zby07o1w3teamsaf0j8.jpeg"><br><br>  This story began with the function ‚ÄúNear‚Äù in one of our mobile apps.  We wanted users to quickly create a group chat or add nearby users as friends.  We tried to solve this problem with the help of geolocation, Bluetooth, Wi-Fi and ultrasound, but for each of the methods we found critical in our case flaws. <br><br>  As a result, we came up with a new way.  It is based on the search for a coincidence of ambient noise: if devices hear the same thing, then, most likely, they are nearby. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      In the article we will talk about the principle of its work, and also consider the advantages and disadvantages of other common methods of detecting devices. <br><a name="habracut"></a><br><br><h3>  Interaction between devices nearby </h3><br>  People who are next to each other often want to exchange files, add a new acquaintance as a friend, play a game together, transfer money, share an account, or perform other joint actions.  Such applications will become more convenient if they allow the user to easily interact with people or devices around them. <br><br>  For example, Petrov just met Ivanov and they are trying to ‚Äúmake friends‚Äù on Facebook.  After several unsuccessful attempts to find each other, they are likely to close Facebook, exchange phone numbers and communicate via WhatsApp. <br><br>  By the way, Vkontakte provided this: in their mobile application for iOS and Android there is a function ‚ÄúPeople Nearby‚Äù, which allows you to find other users with the help of geolocation.  I will tell about minuses of this method a bit later. <br><table><tbody><tr><td align="center"><img src="https://habrastorage.org/webt/et/yy/x7/etyyx7ydrxozesnrilwmt-lfrje.gif"></td><td align="center"><img src="https://habrastorage.org/webt/ex/sp/q7/exspq7ipzkykmoefdxlrbjd72ek.gif"></td></tr><tr><td align="center">  Search for a new friend in FB </td><td align="center">  Search for a new friend in VK </td></tr></tbody></table><br>  For the function to be really convenient for the user, it should work: <br><br><ul><li>  On any smartphone </li><li>  Anytime and anywhere.  On the street, in transport, in the office, etc. </li><li>  Cross platform  At least on iOS and Android, and better, in the browser </li><li>  For sure.  Identify devices that are really nearby. </li><li>  Quickly.  Device must be found in less than 10 seconds </li><li>  Simply.  No additional user action. </li></ul><br><h3>  Ambient noise </h3><br>  Wherever you are (in the office, transport, cafe, on the street, meeting or concert) - there is ambient noise everywhere: people's voices, music, engine performance, wheel noise, knocking of keys, and so on. <br><br>  A short sample of natural ambient noise along with the exact time it was recorded is, in most cases, unique to any location on Earth.  The coincidence of ambient noise and time means that the recorders are nearby.  This is the basis on which the technology works. <br><br><img src="https://habrastorage.org/webt/of/os/8p/ofos8pucle32rza2ymwqlzbimi0.png"><br>  <i>Scheme of work</i> <br><br>  Each device captures sound from a microphone in real time and transforms it into a special fingerprint using a <a href="https://en.wikipedia.org/wiki/Perceptual_hashing">perceptual hash function</a> .  A feature of perceptual hash functions is that small differences in the source data are expressed by small differences in the resulting hash. <br><br>  A sound imprint with an exact time stamp is sent to the server.  By comparing it with the fingerprints of other devices made at the same point in time, the server can determine how similar the original sounds are.  If the similarity rate is above a certain threshold, the devices receive each other's identifiers for subsequent interaction. <br><br><img src="https://habrastorage.org/webt/dv/pj/w5/dvpjw5tbo2kcnklxvwstyklodeg.png"><br>  Example and comparison of prints from two different devices <br><br>  It was necessary to make sure that this principle works and is able to find coincidences in the sound recorded by different devices at a distance of several meters, and also that the obviously different sound does not match.  We manually collected hundreds of hours of sound recorded simultaneously on several devices in many different places. <br><br>  Using this data, we went through a lot of generation algorithms and parameters for comparing fingerprints to achieve the best result.  As a result, they achieved that a 6-second imprint allows detecting a device at a distance of up to 5 meters in 96% of cases, and a false-positive result is possible in 0.0039% of cases. <br><br>  We developed libraries for iOS and Android, which hide the entire implementation from the application through a simple API and embed them in their applications. <br><br>  The disadvantage of this approach is that it does not work in absolute silence.  Silence is very similar to any other silence and the algorithm intentionally ignores it in order to eliminate false positives.  It is worth noting that absolute silence is found in real conditions extremely rarely.  It is enough to knock the keys of the keyboard or the sound of steps for the devices to detect each other. <br><br>  Sometimes it looks funny: users silently wait for the detection of seconds 10, after which one of them says something like ‚ÄúIt does not work!‚Äù.  This phrase works like a spell and after a second the devices detect each other. <br><br>  One advantage of this approach is cross-platform.  JS-version of the library, works in Chrome, Safari, Firefox, Edge, including, in their mobile versions. <br><br><h3>  Another way ... </h3><br>  In our application, the function "Near" is one of the key.  We tried to apply various existing methods for its implementation, but we faced critical limitations and problems for us. <br>  Let's take a closer look at alternative ways. <br><br><h3>  Geolocation </h3><br>  This is the most obvious way to solve a problem.  At the moment when the user opens the ‚ÄúNearby‚Äù section, we get his current location and search for the closest users on the server. <br><br>  If you imagine location as the center of a circle, and the error of coordinates in the form of a radius, then 2 users can be represented as follows: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/w-/fr/lf/w-frlfappgguk_9hnjhzx28brqi.png" width="500"></div><br>  <i>If the distance between devices (d) is less than the sum of the errors (r1 + r2), then there is a probability (P) that users are nearby.</i> <br><br>  The search radius must not be less than the coordinate error.  As it turned out, the real coordinates of the smartphone can be beyond the limits of error, for example, in Android this happens in <a href="https://developer.android.com/reference/android/location/Location.html">32% of cases</a> .  So, even being nearby, users can still not ‚Äúsee‚Äù each other. <br><br>  The coordinates obtained using GPS and GLONASS are accurate, but this method often does not work indoors, moreover, it may take up to a minute to search for satellites.  At the same time, the GPS / GLONASS module is not present in all devices (Hi, iPad Wi-Fi!) Or can be disabled at the OS level (Hi, Android!). <br><br>  In fact, even outside the building, on a densely built street, GPS / GLONASS is often mistaken because of the reflection of a signal from buildings and can give an accuracy of less than 100 meters: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/3k/bb/w2/3kbbw2at1r4wxq6wmcdtl40anhk.jpeg" width="600"></div><br>  Therefore, in most cases, it is necessary to use the coordinates obtained by triangulating the signal of the surrounding Wi-Fi networks and cell towers, this method works quickly and energy efficiently, but the accuracy is much lower: 100 - 1500 meters.  In practice, the device often determines the wrong location in the city, and sometimes it can ‚Äúteleport‚Äù to another city. <br><br>  We implemented this method and tested it in Moscow, in about 15% of cases the devices do not find each other due to incorrect coordinates.  Especially often mistakes occur inside the skyscraper Moscow-City, in the subway and ground transportation.  Also, due to low accuracy, ‚Äúextra‚Äù users (not nearby) will often come across. <br><br>  + easy to implement way <br>  - low accuracy <br>  - does not work well in transport (in motion) <br><br><h3>  Bump </h3><br>  The Bump team came up with an original way to increase search accuracy by geolocation.  Users need to bang their smartphones, while the accelerometer records the exact time of contact and sends it along with the coordinates to the server, the algorithm searches for a pair only among devices with the same time of contact.  This simple idea reduces the probability of a false positive result by orders of magnitude, which makes it possible to significantly increase the search radius. <br><br>  But in 2013, Google absorbed them, and in 2014 the project was <a href="http://blog.bu.mp/post/71781606704/all-good-things">closed</a> , despite the fact that the Bump SDK was built into many third-party applications, and the Bump file sharing application received hundreds of millions of downloads.  The further fate of technology is unknown. <br><br>  The main disadvantage of the technology is that only one pair of devices is connected in one ‚ÄúBump‚Äù.  To merge a group of users, you will need to make a lot of ‚ÄúBamps‚Äù. <br><br>  + high accuracy <br>  - it is necessary to push devices together <br>  - paired device detection <br>  - the project is closed <br><br><h3>  Bluetooth, BLE and Wi-Fi </h3><br>  iOS and Android are not strictly friends via Bluetooth.  Data transfer between these platforms is not a trivial task: Apple allows the application to connect only to certified (Made For iPhone) Bluetooth devices. <br><br>  In order for devices to detect each other, the following method is used: iOS simulates any Bluetooth Low Energy peripherals, setting its token as the name of a BLE device.  Android temporarily changes the Bluetooth name of the smartphone to its token and turns on discovery mode.  Now, to discover devices around, Android scans Bluetooth for Android and BLE for iOS devices.  iOS only scans BLE for iOS detection, since  Bluetooth scanning is not possible using a public API.  In order to detect Android, iOS via the cloud receives the identifiers of surrounding Android devices that have discovered its BLE token. <br><br>  In some cases, the surrounding Wi-Fi-networks help to detect that the devices are nearby: the iOS application can get the BSSID of the Wi-Fi access point the user is currently connected to, and the Android BSSID of all visible points.  If a match is found, then users are nearby. <br><br>  Properly implement this method yourself is not so easy, including due to the <a href="https://github.com/iDevicesInc/SweetBlue/wiki/Android-BLE-Issues">many features of the</a> BLE stack of different versions of Android and iOS.  There are libraries that hide the complex implementation ‚Äúunder the hood‚Äù. <br><br>  We tried <a href="https://developers.google.com/nearby/messages/overview">Google Nearby</a> .  Finding a pair of iOS - Android is slow, on average, the search takes 20 seconds, and in some cases lasts up to 40 seconds, this turned out to be the main stopping factor. <br><br>  Another caveat is that Bluetooth is turned off on most smartphones, so iOS users <b>each time</b> they use the function will need to correctly answer the question ‚ÄúAllow an application to use Bluetooth?‚Äù. <br><br>  Also, it is worth remembering that the use of Bluetooth (on Android) greatly affects the consumption of charge.  Google warns that Google Nearby increases energy consumption by <a href="https://developers.google.com/nearby/developer-guidelines">2.5 - 3.5 times</a> . <br><br>  + proof of proximity (guarantee that the devices are nearby) <br>  - slow detection <br>  - high energy consumption <br><br><h3>  Information sharing through sound </h3><br>  All smartphones have a speaker and microphone.  You can encode any identifier into the sound on one device, reproduce it with the help of a speaker, decode it on devices in the radius of hearing and thus unite the devices into a group. <br><br><img src="https://habrastorage.org/webt/tc/hj/7m/tchj7mdgbht-iv7vjgpde8lqzwg.png"><br>  <i>An example of the spectrogram signal Chirp.io</i> <br><br>  In the audible range, the signal is mixed with voice, music, and ambient noise in order to increase the likelihood of correct decoding, you have to play the sound at maximum volume.  The most commonly used is FSK and PSK modulation, generating a sound similar to whistle or noise (depending on data density), which annoys many people ( <a href="">example of sound</a> ).  This method is implemented in the <a href="https://www.chirp.io/">Chirp.io</a> project. <br><br>  - does not work in noisy places <br>  - annoying others <br><br>  You can use a range of 18-20 kHz, it is usually not noisy, and most adults will not hear the annoying sound.  Unfortunately, some smartphones also perceive it badly, the problem of reflection and interference becomes relevant, the range of stable communication decreases to 0.5 - 3 meters.  This method is implemented in Google Nearby and Chirp.io, but is included separately. <br><br>  - works at too short distances <br><br><h3>  Instead of conclusion </h3><br>  We have been testing technology in our own application for over 2 years.  During this time, we have been convinced of its efficiency and convenience in ‚Äúcombat‚Äù conditions.  In a very short time, we want to give any developer the opportunity to quickly embed and use it in his application. <br><br>  I hope the article was informative and useful.  If the topic turns out to be interesting, in the following articles I plan to talk in more detail about the algorithms for creating and comparing the "prints" of the surround sound, as well as the difficulties that we had to face. <br><br>  I am pleased to answer your questions in the comments! </div><p>Source: <a href="https://habr.com/ru/post/347954/">https://habr.com/ru/post/347954/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../347940/index.html">Red Hat absorbs CoreOS</a></li>
<li><a href="../347942/index.html">HR analytics with R</a></li>
<li><a href="../347946/index.html">Vivaldi 1.14 - longitudinally transverse version</a></li>
<li><a href="../347948/index.html">Game Designer. Who is it?</a></li>
<li><a href="../347952/index.html">How to create a truly random and provably secure password</a></li>
<li><a href="../347956/index.html">An article about how we tried to apply modern neural network technologies to find helmets on people's heads</a></li>
<li><a href="../347958/index.html">The story of how not to let me steal credit card numbers and passwords from visitors to your sites</a></li>
<li><a href="../347960/index.html">I am a developer from 9 to 17 (and you can become one)</a></li>
<li><a href="../347962/index.html">Partial wow effects: magic with simple words</a></li>
<li><a href="../347964/index.html">How does blocking access to pages that distribute prohibited content (now the RKN also checks the search engines)</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>