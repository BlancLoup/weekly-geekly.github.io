<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>NetApp FAS and VMware ESXi: Swap</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Continuing the topic of host optimization with VMware ESXi , let's look at how to deal with Swap in the infrastructure of NetApp FAS living on storage...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>NetApp FAS and VMware ESXi: Swap</h1><div class="post__text post__text-html js-mediator-article">  Continuing the topic of <a href="http://habrahabr.ru/post/247833/">host optimization with VMware ESXi</a> , let's look at how to deal with Swap in the infrastructure of NetApp <abbr title="Fabric attached storage">FAS</abbr> living on <abbr title="Storage System">storage</abbr> systems.  Although this article should be helpful and not only to owners of NetApp <abbr title="Fabric attached storage">FAS</abbr> systems. <br><br>  One of the most important features of virtualization is the ability to utilize server equipment more efficiently, which implies <i>Overcommit</i> resources.  If we are talking about <abbr title="Random Access Memory">RAM</abbr> , it means that we can configure each virtual machine with more memory than it actually has on the server.  And then we rely on ESXi to get rid of the fight for resources - it took (such a process is often called reclamation) the wrong memory of one virtual machine and gave it to the one that really needs it.  At that moment when there is not enough memory, the process of swapping memory begins. <br><br>  To begin with, there are two types of swapping that can occur on an ESXi host.  They are very often confused, so let's conditionally call them Type 1 and Type 2. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <img src="https://habrastorage.org/files/8d8/a03/b9a/8d8a03b9adaa4cdf90e596ec1915a2fe.png"><br>  VMware ESXi default data location <br><a name="habracut"></a><br><br><h4>  <a href="https://habr.com/ru/post/247631/">Type 1. VMX swapping (vSwap)</a> </h4><a name="VMX_swapping"></a><br>  This is the easiest type of swaping to describe.  Memory is allocated not only for virtual machines, but also for various components of the host, for example, for a virtual machine monitor (VMM) and virtual devices.  Such memory can be swapped in order to allocate more physical memory to more needed virtual machines.  According to VMware, this feature can free up from 50MB to 10MB of memory for each virtual machine without significant performance degradation. <br><br>  This type of swaping is enabled by default, <abbr title="Virtual machine executable">VMX</abbr> Swap is stored in the folder with the virtual machine as a file with the extension vswp (the location can be changed through the parameter <i>sched.swap.vmxSwapDir</i> ).  <abbr title="Virtual machine executable">VMX</abbr> swapping can be turned off by setting the virtual machine parameter <i>sched.swap.vmxSwapEnabled = FALSE</i> . <br><br><h4>  <a href="https://habr.com/ru/post/247631/">Type 2. Guest OS Swapping</a> </h4><a name="Guest_OS_machine_swapping"></a><br>  A virtual machine "sees" as much as supposedly "physical" memory, how much <abbr title="Random Access Memory">RAM</abbr> is specified in its settings.  From the point of view of the guest <abbr title="Operating system">OS</abbr> , all such allocated memory for it is physical.  In fact, the hypervisor hides behind the virtualization layer, for the guest <abbr title="Operating system">OS</abbr> , what kind of memory is actually used: physical or vSwap.  When the memory ‚Äúinside‚Äù the guest <abbr title="Operating system">OS</abbr> ends, it starts swapping itself.  And here you need not to get confused - this process has nothing to do with host-level swaping ( <abbr title="Virtual machine executable">VMX</abbr> ).  For example, for a virtual machine with 4GB of memory configured, the hypervisor can allocate this memory on the host, both in physical memory and in the host swap ( <abbr title="Virtual machine executable">VMX</abbr> ) - for a virtual machine, this is not important, all 4GB will be used as physical memory simply because that the guest <abbr title="Operating system">OS</abbr> has no idea that its memory is virtualized. <br><br>  When the guest <abbr title="Operating system">OS</abbr> wants to use more than 4GB of memory, it will use its own swapping, Windows uses pagefile.sys, in Linux it is a dedicated Swap partition.  Thus, the swap is saved inside the virtual disk - inside one of the <abbr title="Virtual Machine Disk">VMDK</abbr> files of the virtual machine.  Those.  The pagefile.sys / swap partition is part of a virtual disk virtual machine. <br><br>  And this is what happens when the balun driver is used: when it ‚Äúswells up‚Äù, it clogs all the free (from the guest <abbr title="Operating system">OS</abbr> point of view) memory, and the balun driver makes sure that it actually gets physical, not swapped host memory, and when Such a virtual machine does not have free memory, this forces the guest <abbr title="Operating system">OS</abbr> to start swapping data.  And this is good, since the guest <abbr title="Operating system">OS</abbr> knows better what is swapped to disk and what is not. <br><br><h4>  <a href="https://habr.com/ru/post/247631/">ESXi Host swapping</a> </h4><a name="Host_swapping"></a><br>  When we understand that the ESXi host has a lot of swap, it means that we have a lot of overspending resources, all reclamation and memory saving techniques (ballooning, page sharing and memory compression) do not save - the host simply does not have enough <abbr title="Random Access Memory">RAM</abbr> .  It is considered that the host is in the ‚ÄúHard state‚Äù state (1% ‚Äì2% of the memory is free) or ‚ÄúLow state‚Äù (1% or less).  This state of affairs significantly affects performance, it should be avoided.  Another problem is that when Swapping at the host level has no control over what goes there, unlike the guest <abbr title="Operating system">OS</abbr> swapping (Type 2), the hypervisor does not know which data is more important for the guest <abbr title="Operating system">OS</abbr> , so it is important to install VMware Tools so that the driver works baluning <br><br>  vSwap (Type 1) is saved by default to the .vswp file in the folder with the virtual machine.  NetApp recommends saving vSwap (Type 1) to a dedicated datastore. <br><br><pre><code class="bash hljs">/vmfs/volumes/4b953b81-76b37f94-efef-0010185f132e/vp <span class="hljs-comment"><span class="hljs-comment"># ls -lah |grep swp --rw------ 1 root root 2.0G Jan 11 18:02 vp-c6783a5c.vswp</span></span></code> </pre> <br><br>  Such a file exists only for running virtual machines ‚Äî upon startup, the hypervisor creates this file and deletes it when the virtual machine is turned off.  Pay attention to the size of this file - it is equal to the difference between the configured memory for the virtual machine and the reserve of physical memory for this machine.  This ensures the presence of a given memory space when the virtual machine starts (no matter what memory is used - real physical or vSwap).  The reserve ensures that the virtual machine always receives the necessary space in the physical memory of the host.  And the difference between the reserve and the configured memory of the virtual machine is stored in the vswp file. <br><br>  Below is an example of running a virtual machine with 4GB of memory and a reserve of 2GB.  Remember that vSwap is deleted after shutdown?  And if at this moment the datastore storing this virtual machine is full and there remains free 1.8GB of space, what will happen? <br><img src="https://habrastorage.org/files/2bd/fce/6ca/2bdfce6ca3ce4614b95ed13594fa0327.png"><br><br>  What can you do about it?  Of course, you can free up space on the datastore or place vSwap (Type 1) on another datastore.  By default, it is stored in a folder with a virtual paddle.  If this is a ‚Äústandalone‚Äù host: <i>Configuration&gt; Software&gt; Virtual Machine Swapfile Location</i> .  The location of the vSwap files can also be changed at the settings level of each virtual machine.  Open the virtual machine settings and select the Options tab: <br><img src="https://habrastorage.org/files/87f/81c/f05/87f81cf050074c0881ba5cd3d34f3769.jpg"><br><br>  If this host is part of a cluster, take a look at the cluster settings. <i>Store the swapfile in the datastore specified by the host.</i> <br><img src="https://habrastorage.org/files/df0/b0b/904/df0b0b904ee949ab919e0b5a127e0b15.png"><br><br>  Next, select the datastore where vSwap (Type 1) will be stored. <br><br><h4>  <a href="https://habr.com/ru/post/247631/">Why place a swap on a separate datastor?</a> </h4><a name="why_use_swap_datastore"></a><br><br><img src="https://habrastorage.org/files/fd7/210/5b8/fd72105b801f4ed3baed5d8c6a0e12bb.png"><br>  Swap's recommended layout for NetApp FAS <br><br>  <b>Firstly,</b> it is worth noting that the general rule of VMware says, if possible, to place vSwap (Type 1) in the folder with the virtual machine, since moving to a separate datastore can slow down vMotion.  But in the particular case of VMware + NetApp <abbr title="Fabric attached storage">FAS</abbr> comes another recommendation.  <a href="http://www.netapp.com/us/system/pdf-reader.aspx%3Fm%3Dtr-3749.pdf%26cc%3Dus">NetApp recommends storing vSwap (Type 1) on a separate, dedicated, one for all virtual machines datastore</a> , since in this case, the difference during the migration of vMotion is almost eliminated.  VMware recommends that the space for vSwap (Type 1) be greater than or equal to the difference configured and reserved for the virtual machine memory.  Otherwise, virtual machines may not start.  Example: we have 5 virtual machines with a 4GB memory size and a reservation for each 3GB. <br><br>  The minimum datastore size for vSwap Type 1: <br>  5VM * (4 GB - 3GB) = 5GB <br><br>  If there is no free physical 5VM * 3GB = 15 GB of memory on the host, the machines may not start, displaying an error: <br>  <i>The host does not have sufficient memory resources</i> <br><img src="https://habrastorage.org/files/b5c/e02/50d/b5ce0250df2540d9bce8f8d235769580.png"><br><br>  And at the same time an event log will be created. <br><img src="https://habrastorage.org/files/35e/5d1/657/35e5d1657dbc49e4b06104373a0d3323.png"><br><br>  <b>Secondly,</b> this is performance - placing the swap on a slower datastor, if you are sure that there will almost never be a swap.  Or if the virtual machines will request more memory than there is on the host, and the swapping will be permanent - on a faster datastore. <br><br>  <b>Thirdly,</b> these are snapshots and deduplication at the storage level.  Since netap snapshots do not affect performance, they are the norm of life, they are performed continuously and are part of <a href="http://habrahabr.ru/post/244923/">the NetApp backup paradigm for FAS systems</a> .  Swap is absolutely useless information when backing up and restoring.  If it is used extensively, and snapshots are often removed, snapshots will be ‚Äúcaptured‚Äù and stored, all the time a snapshot lives, this useless information.  And since the swap is constantly changing, and the special flash captures only the new modified data, each new snapshot will store this new modified data from the swap, mercilessly eating the usable space under the useless data on the storage.  There is no reason to dedup the swap, because the data in the swap is not needed during the restoration and will never be read.  In this sense, it is convenient to make swaps to a separate datastore.  NetApp recommends placing the swap on a separate datastore with snapshots turned off and deduplication, so we can further reduce the overhead in snapshots and replication. <br><br>  <a href="http://www.netapp.com/us/system/pdf-reader.aspx%3Fm%3Dtr-3749.pdf%26cc%3Dus">NetApp does not recommend using local disks</a> (pages 76-78, DEC11) on the host for storing vSwap (Type 1) because such a configuration has a negative effect on the speed of the vMotion operation. <br><br><h4>  <a href="https://habr.com/ru/post/247631/">Should I endure Type 2 Swap?</a> </h4><a name="should_we_move_guest_swap"></a><br>  Placing temporary data such as Swap and Pagefile.sys on a dedicated datastor (creating a dedicated virtual disk for this purpose) allows you not to deduplicate or back up this data as well as vSwap (Type 1).  It is very important not to forget to specify this disk as <i>Independent</i> , so that the <abbr title="NetApp Virtual Storage Console">VSC</abbr> agent does not force <abbr title="Fabric attached storage">FAS</abbr> to remove snapshots from the section that stores Swap files (Type 2). <br><img src="https://habrastorage.org/files/2c1/8b9/092/2c18b9092b964c6199d9e4ae3eedaf91.JPG"><br><br>  NetApp doesn‚Äôt have recommendations for Swap Type 2; making this data is an optional design that has its pros and cons: <br><br>  In addition to the rendered vSwap Type 1, swap Type 2 will further reduce the overhead on snapshots and, as a result, increase the throughput for replication.  In <abbr title="Application Consistent Backup">ACB</abbr> for <abbr title="Disaster Recovery">DR</abbr> solutions, the presence of Swap (both types) does not have any meaning, since it is not used at system start.  If we stop storing Swap (Type 2) in snapshots and backups, this should not cause any problems during local recovery, since the restored .vmx config file will contain a link to the <abbr title="Virtual Machine Disk">VMDK</abbr> file that stores the partition with Swap, because it will be be in the same place.  But this will add additional steps when restoring to a remote site, in configurations such as <abbr title="VMware Site Recovery Manager">SRM</abbr> , SnapProtect, and other <abbr title="Disaster Recovery">DR</abbr> solutions. <br><img src="https://habrastorage.org/files/47d/85a/cff/47d85acff5a4470b8d0f36e9cb2c631b.png"><br>  Optional data layout on NetApp FAS <br><br>  So, when restoring a virtual machine without a <abbr title="Virtual Machine Disk">VMDK</abbr> file of the guest <abbr title="Operating system">OS</abbr> that saves the swap, you need to add steps to create a virtual disk, a file system on it and connect it to the virtual machine (or connect an existing <abbr title="Virtual Machine Disk">VMDK</abbr> with the created file system).  <a href="http://media.netapp.com/documents/tr-3671.pdf">Read more TR-3671</a> . <br><br>  <b>I ask to send messages on errors in the text to the <abbr title="Private message">LAN</abbr> .</b> <br>  <b>Notes and additions on the contrary please in the comments</b> </div><p>Source: <a href="https://habr.com/ru/post/247631/">https://habr.com/ru/post/247631/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../247617/index.html">Is life possible without a template engine?</a></li>
<li><a href="../247619/index.html">Programming Philosophy 3 - Chichikov and Programmer</a></li>
<li><a href="../247621/index.html">Heartbleed and his friends in 2015: how an advertising network endangers site visitors</a></li>
<li><a href="../247625/index.html">Practical safety: trends and forecasts-2015</a></li>
<li><a href="../247629/index.html">Get to know Docker containers for a Django developer</a></li>
<li><a href="../247635/index.html">Divide by zero is the norm. Part 1</a></li>
<li><a href="../247637/index.html">Say a word for a test plan</a></li>
<li><a href="../247639/index.html">Arduino, Nokia 5110 LCD module and any image</a></li>
<li><a href="../247641/index.html">‚ÄúI have a cool game idea‚Äù or common mistakes of young game developers</a></li>
<li><a href="../247643/index.html">We study the free application Message Flow Monitoring</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>