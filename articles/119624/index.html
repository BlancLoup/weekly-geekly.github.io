<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Linq To Entities vs. Linq To Objects on the example of grouping</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="LINQ is a convenient, beautiful, but rather insidious abstraction. The most unexpected things usually occur at the junction of any implementation of L...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Linq To Entities vs. Linq To Objects on the example of grouping</h1><div class="post__text post__text-html js-mediator-article">  LINQ is a convenient, beautiful, but rather insidious abstraction.  The most unexpected things usually occur at the junction of any implementation of LINQ and LINQ To Objects.  Today, using one example, I‚Äôll look at how LINQ To Entities (Entity Framework) and LINQ To Objects work together. <br><br><a name="habracut"></a><br><br>  Take the repository method as a basis, which accepts a list of customer identifiers as input and returns a set of orders grouped by these identifiers (the Orders table contains the fields OrderId, OrderDate and CustomerId): <br><pre><code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> IDictionary&lt;<span class="hljs-keyword"><span class="hljs-keyword">long</span></span>, List&lt;Order&gt;&gt; GetOrdersByCustomersIds(IList&lt;<span class="hljs-keyword"><span class="hljs-keyword">long</span></span>&gt; customersIds) { <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">var</span></span> ctx = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> RepositoryContext()) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> ctx.Orders. Where(o =&gt; customersIds.Contains(o.Id)). GroupBy(o =&gt; o.CustomerId). ToDictionary(o =&gt; o.Key, o =&gt; o.ToList()); } }</code> </pre> 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Wait a minute!  How does it work?  After all, when executing a GROUP BY query, we can select only the fields by which the grouping takes place, as well as aggregated values.  The standard solution to this problem is a JOIN of the table data and grouping results.  Like that: <br><pre> <code class="sql hljs"> <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> o1.*, MinTotal <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> Orders <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> o1 <span class="hljs-keyword"><span class="hljs-keyword">INNER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">JOIN</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> o2.CustomerId, <span class="hljs-keyword"><span class="hljs-keyword">Min</span></span>(o2.Total) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> MinTotal <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> Orders o2 <span class="hljs-keyword"><span class="hljs-keyword">GROUP</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BY</span></span> o2.CustomerId) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> o3 <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> o1.CustomerId = o3.CustomerId <span class="hljs-keyword"><span class="hljs-keyword">Where</span></span> o1.CustomerId <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> (<span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-number"><span class="hljs-number">2</span></span>, <span class="hljs-number"><span class="hljs-number">3</span></span>, <span class="hljs-number"><span class="hljs-number">4</span></span>, <span class="hljs-number"><span class="hljs-number">5</span></span>)</code> </pre><br>  Something in this spirit should generate an EF provider.  Let's see this.  I had a MySQL .NET Connector on hand (the official ADO.NET provider for MySQL), so I used it and received the following generated request (transferring a list of identifiers from 1 to 5 to the input): <br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> <span class="hljs-string"><span class="hljs-string">`Project2`</span></span>.<span class="hljs-string"><span class="hljs-string">`C1`</span></span>, <span class="hljs-string"><span class="hljs-string">`Project2`</span></span>.<span class="hljs-string"><span class="hljs-string">`CustomerId`</span></span>, <span class="hljs-string"><span class="hljs-string">`Project2`</span></span>.<span class="hljs-string"><span class="hljs-string">`C2`</span></span>, <span class="hljs-string"><span class="hljs-string">`Project2`</span></span>.<span class="hljs-string"><span class="hljs-string">`CustomerId1`</span></span>, <span class="hljs-string"><span class="hljs-string">`Project2`</span></span>.<span class="hljs-string"><span class="hljs-string">`Id`</span></span>, <span class="hljs-string"><span class="hljs-string">`Project2`</span></span>.<span class="hljs-string"><span class="hljs-string">`OrderDate`</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> <span class="hljs-string"><span class="hljs-string">`Distinct1`</span></span>.<span class="hljs-string"><span class="hljs-string">`CustomerId`</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> <span class="hljs-string"><span class="hljs-string">`C1`</span></span>, <span class="hljs-string"><span class="hljs-string">`Extent2`</span></span>.<span class="hljs-string"><span class="hljs-string">`CustomerId`</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> <span class="hljs-string"><span class="hljs-string">`CustomerId1`</span></span>, <span class="hljs-string"><span class="hljs-string">`Extent2`</span></span>.<span class="hljs-string"><span class="hljs-string">`Id`</span></span>, <span class="hljs-string"><span class="hljs-string">`Extent2`</span></span>.<span class="hljs-string"><span class="hljs-string">`OrderDate`</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">CASE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">WHEN</span></span> (<span class="hljs-string"><span class="hljs-string">`Extent2`</span></span>.<span class="hljs-string"><span class="hljs-string">`CustomerId`</span></span> <span class="hljs-keyword"><span class="hljs-keyword">IS</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">THEN</span></span> (<span class="hljs-literal"><span class="hljs-literal">NULL</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">ELSE</span></span> (<span class="hljs-number"><span class="hljs-number">1</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">END</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> <span class="hljs-string"><span class="hljs-string">`C2`</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DISTINCT</span></span> <span class="hljs-string"><span class="hljs-string">`Extent1`</span></span>.<span class="hljs-string"><span class="hljs-string">`CustomerId`</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> <span class="hljs-string"><span class="hljs-string">`orders`</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> <span class="hljs-string"><span class="hljs-string">`Extent1`</span></span> <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> ((<span class="hljs-number"><span class="hljs-number">1</span></span> = <span class="hljs-string"><span class="hljs-string">`Extent1`</span></span>.<span class="hljs-string"><span class="hljs-string">`Id`</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">OR</span></span> (<span class="hljs-number"><span class="hljs-number">2</span></span> = <span class="hljs-string"><span class="hljs-string">`Extent1`</span></span>.<span class="hljs-string"><span class="hljs-string">`Id`</span></span>)) <span class="hljs-keyword"><span class="hljs-keyword">OR</span></span> (((<span class="hljs-number"><span class="hljs-number">3</span></span> = <span class="hljs-string"><span class="hljs-string">`Extent1`</span></span>.<span class="hljs-string"><span class="hljs-string">`Id`</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">OR</span></span> (<span class="hljs-number"><span class="hljs-number">4</span></span> = <span class="hljs-string"><span class="hljs-string">`Extent1`</span></span>.<span class="hljs-string"><span class="hljs-string">`Id`</span></span>)) <span class="hljs-keyword"><span class="hljs-keyword">OR</span></span> (<span class="hljs-number"><span class="hljs-number">5</span></span> = <span class="hljs-string"><span class="hljs-string">`Extent1`</span></span>.<span class="hljs-string"><span class="hljs-string">`Id`</span></span>))) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> <span class="hljs-string"><span class="hljs-string">`Distinct1`</span></span> <span class="hljs-keyword"><span class="hljs-keyword">LEFT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">OUTER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">JOIN</span></span> <span class="hljs-string"><span class="hljs-string">`orders`</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> <span class="hljs-string"><span class="hljs-string">`Extent2`</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> (((<span class="hljs-number"><span class="hljs-number">1</span></span> = <span class="hljs-string"><span class="hljs-string">`Extent2`</span></span>.<span class="hljs-string"><span class="hljs-string">`Id`</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">OR</span></span> (<span class="hljs-number"><span class="hljs-number">2</span></span> = <span class="hljs-string"><span class="hljs-string">`Extent2`</span></span>.<span class="hljs-string"><span class="hljs-string">`Id`</span></span>)) <span class="hljs-keyword"><span class="hljs-keyword">OR</span></span> (((<span class="hljs-number"><span class="hljs-number">3</span></span> = <span class="hljs-string"><span class="hljs-string">`Extent2`</span></span>.<span class="hljs-string"><span class="hljs-string">`Id`</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">OR</span></span> (<span class="hljs-number"><span class="hljs-number">4</span></span> = <span class="hljs-string"><span class="hljs-string">`Extent2`</span></span>.<span class="hljs-string"><span class="hljs-string">`Id`</span></span>)) <span class="hljs-keyword"><span class="hljs-keyword">OR</span></span> (<span class="hljs-number"><span class="hljs-number">5</span></span> = <span class="hljs-string"><span class="hljs-string">`Extent2`</span></span>.<span class="hljs-string"><span class="hljs-string">`Id`</span></span>))) <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> (<span class="hljs-string"><span class="hljs-string">`Distinct1`</span></span>.<span class="hljs-string"><span class="hljs-string">`CustomerId`</span></span> = <span class="hljs-string"><span class="hljs-string">`Extent2`</span></span>.<span class="hljs-string"><span class="hljs-string">`CustomerId`</span></span>)) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> <span class="hljs-string"><span class="hljs-string">`Project2`</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ORDER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BY</span></span> <span class="hljs-string"><span class="hljs-string">`CustomerId`</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ASC</span></span>, <span class="hljs-string"><span class="hljs-string">`C2`</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ASC</span></span></code> </pre><br>  A bit worse than manual implementation, but on the whole a thought can be traced. <br><br>  Stop!  And why do we use grouping at the database level?  Grouping is justified in the case of using aggregation functions (as in the above manual implementation of the query).  In our case, grouping is only a convenient presentation of the data obtained.  Let's slightly modify the repository method and move the grouping process to the LINQ To Objects level: <br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> IDictionary&lt;<span class="hljs-keyword"><span class="hljs-keyword">long</span></span>, List&lt;Order&gt;&gt; GetOrdersByCustomersIds(IList&lt;<span class="hljs-keyword"><span class="hljs-keyword">long</span></span>&gt; customersIds) { <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">var</span></span> ctx = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> RepositoryContext()) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> ctx.Orders. Where(o =&gt; customersIds.Contains(o.Id)). AsEnumerable(). GroupBy(o =&gt; o.CustomerId). ToDictionary(o =&gt; o.Key, o =&gt; o.ToList()); } }</code> </pre><br>  For the sake of completeness, let's see which request will be generated by the EF provider: <br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> <span class="hljs-string"><span class="hljs-string">`Extent1`</span></span>.<span class="hljs-string"><span class="hljs-string">`CustomerId`</span></span>, <span class="hljs-string"><span class="hljs-string">`Extent1`</span></span>.<span class="hljs-string"><span class="hljs-string">`Id`</span></span>, <span class="hljs-string"><span class="hljs-string">`Extent1`</span></span>.<span class="hljs-string"><span class="hljs-string">`OrderDate`</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> <span class="hljs-string"><span class="hljs-string">`orders`</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> <span class="hljs-string"><span class="hljs-string">`Extent1`</span></span> <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> ((<span class="hljs-number"><span class="hljs-number">1</span></span> = <span class="hljs-string"><span class="hljs-string">`Extent1`</span></span>.<span class="hljs-string"><span class="hljs-string">`Id`</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">OR</span></span> (<span class="hljs-number"><span class="hljs-number">2</span></span> = <span class="hljs-string"><span class="hljs-string">`Extent1`</span></span>.<span class="hljs-string"><span class="hljs-string">`Id`</span></span>)) <span class="hljs-keyword"><span class="hljs-keyword">OR</span></span> (((<span class="hljs-number"><span class="hljs-number">3</span></span> = <span class="hljs-string"><span class="hljs-string">`Extent1`</span></span>.<span class="hljs-string"><span class="hljs-string">`Id`</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">OR</span></span> (<span class="hljs-number"><span class="hljs-number">4</span></span> = <span class="hljs-string"><span class="hljs-string">`Extent1`</span></span>.<span class="hljs-string"><span class="hljs-string">`Id`</span></span>)) <span class="hljs-keyword"><span class="hljs-keyword">OR</span></span> (<span class="hljs-number"><span class="hljs-number">5</span></span> = <span class="hljs-string"><span class="hljs-string">`Extent1`</span></span>.<span class="hljs-string"><span class="hljs-string">`Id`</span></span>))</code> </pre><br>  This query is definitely more efficient than the previous one. <br><br>  That's all.  Nothing special - I just wanted to focus your attention on the cunning of the transition from LINQ To X to LINQ To Objects after you fell into this trap.  Be carefull! <br><br>  PS Despite the fact that I used the MySQL .NET Connector, I absolutely <a href="http://alexidsa.blogspot.com/2011/05/entity-framework-mysql.html">do not recommend</a> using this provider in production: this is not a provider, but a co-centered bunch of bugs that have not been fixed for years. </div><p>Source: <a href="https://habr.com/ru/post/119624/">https://habr.com/ru/post/119624/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../119610/index.html">Electronic signature: "works" or not?</a></li>
<li><a href="../119611/index.html">Limit inbound and outbound traffic to Linux</a></li>
<li><a href="../119612/index.html">Order sata multipliers for a 90 TB file storage in Taiwan</a></li>
<li><a href="../119616/index.html">Attracting an audience to the site using an iPhone application</a></li>
<li><a href="../119619/index.html">3D printers are getting even smaller and cheaper.</a></li>
<li><a href="../119625/index.html">Cord - plug for cable selection</a></li>
<li><a href="../119626/index.html">Ukrainian parliament returns VAT on IT services</a></li>
<li><a href="../119632/index.html">Blackberry Playbook in my hands</a></li>
<li><a href="../119633/index.html">Doodle 4 Google Contest Results</a></li>
<li><a href="../119634/index.html">OpenStreetMap News ‚Ññ5</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>