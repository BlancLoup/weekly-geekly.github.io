<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ASP.NET 5 Middleware or where did my HTTP module go?</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="The new version of ASP.NET 5 is rewritten almost from scratch and includes significant changes from previous versions. One of the biggest changes is t...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>ASP.NET 5 Middleware or where did my HTTP module go?</h1><div class="post__text post__text-html js-mediator-article">  The new version of ASP.NET 5 is rewritten almost from scratch and includes significant changes from previous versions.  One of the biggest changes is the processing pipeline (HTTP Pipeline).  This article describes how these changes affect the design and implementation of components that were previously presented as Http modules. <br><br>  The behavior of HTTP modules used to be similar to the behavior of request filters, up to ASP.NET 5. This is functionality that can be implemented in the request pipeline and describe some task to be performed, for example, to respond to an event in an application.  Modules are used for authentication, global error handling, and logging.  They are also often used to intercept and modify a server response, such as removing spaces or compressing.  They implement the <b>IHttpModule</b> interface, which is defined in the <b>System.Web</b> assembly, which, in turn, is not part of the new ASP.NET. <br><a name="habracut"></a><br>  Basically, the registration of the HttpModule-i in the code is added as an event handler in Global.asax, or an assembly is created for registration in the <i>web.config</i> . <br><br><h3>  What is Middleware? </h3><br>  The definition of ‚ÄúMiddleware‚Äù varies greatly, but in the context of ASP.NET 5, perhaps the most accurate definition is given in the Owin specification: 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      <i>Cross-cutting components that form a pipeline between a server and an application that inspects, routes or modifies a request and response for a specific purpose.</i> <br><br>  Original: <br>  <i>Through the components of a specific purpose</i> <br><br>  Very similar to the description of a traditional HTTP module or handler (handler-a). <br><br>  Access to the request pipeline in an ASP.NET 5 application is provided in the <b>Startup</b> class (Startup.cs file), it is also the entry point to the application itself.  The Startup class includes the <b>Configure</b> method, which takes an <b>IApplicationBuilder</b> as a parameter.  The <b>IApplicationBuilder</b> interface ( <i>app</i> parameter) provides a number of extension-methods by which various components can be connected to the request pipeline.  The main difference between this and the previous implementation of the HTTP pipeline is that the previous approach was based on events, and now it has been replaced by a composite model (components are added one by one).  Also, in the new ASP.NET, the order in which these components are added is important.  In the basic template of the MVC application, there are already some components, and from the comments you can understand their purpose: <br><pre><code class="cs hljs"><span class="hljs-comment"><span class="hljs-comment">// Add static files to the request pipeline. app.UseStaticFiles(); // Add cookie-based authentication to the request pipeline. app.UseIdentity(); // Add MVC to the request pipeline. app.UseMvc(routes =&gt; { routes.MapRoute( name: "default", template: "{controller}/{action}/{id?}", defaults: new { controller = "Home", action = "Index" }); // Uncomment the following line to add a route for porting Web API 2 controllers. // routes.MapWebApiRoute("DefaultApi", "api/{controller}/{id?}"); });</span></span></code> </pre> <br><br>  As we can see, the methods by which Identity, MVC, and static files are added are the IApplicationBuilder extension-methods.  When adding a new middleware handler, which will be described in this article, I will also create an extension method to add it to the pipeline. <br><br><h3>  Middleware example </h3><br>  Our sample middleware handler will do 2 things: measure the processing time of the request, and also add this value to the outgoing HTML and response headers.  This is even the whole 3 things.  In any case, this example will illustrate the 2 most common scenarios that are described in many articles like "How to write your own HTTP module" - changing the server response and adding headers.  Handler Code: <br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">using</span></span> Microsoft.AspNet.Builder; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> Microsoft.AspNet.Http; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> System.Diagnostics; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> System.IO; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> System.Threading.Tasks; <span class="hljs-keyword"><span class="hljs-keyword">namespace</span></span> <span class="hljs-title"><span class="hljs-title">WebApplication1.MiddleWare</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">MyMiddleware</span></span> { RequestDelegate _next; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">MyMiddleware</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">RequestDelegate next</span></span></span><span class="hljs-function">)</span></span> { _next = next; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">async</span></span></span><span class="hljs-function"> Task </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Invoke</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">HttpContext context</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> sw = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Stopwatch(); sw.Start(); <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">var</span></span> memoryStream = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> MemoryStream()) { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> bodyStream = context.Response.Body; context.Response.Body = memoryStream; <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> _next(context); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> isHtml = context.Response.ContentType?.ToLower().Contains(<span class="hljs-string"><span class="hljs-string">"text/html"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (context.Response.StatusCode == <span class="hljs-number"><span class="hljs-number">200</span></span> &amp;&amp; isHtml.GetValueOrDefault()) { { memoryStream.Seek(<span class="hljs-number"><span class="hljs-number">0</span></span>, SeekOrigin.Begin); <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">var</span></span> streamReader = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> StreamReader(memoryStream)) { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> responseBody = <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> streamReader.ReadToEndAsync(); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> newFooter = <span class="hljs-string"><span class="hljs-string">@"&lt;footer&gt;&lt;div id=""process""&gt;Page processed in {0} milliseconds.&lt;/div&gt;"</span></span>; responseBody = responseBody.Replace(<span class="hljs-string"><span class="hljs-string">"&lt;footer&gt;"</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>.Format(newFooter, sw.ElapsedMilliseconds)); context.Response.Headers.Add(<span class="hljs-string"><span class="hljs-string">"X-ElapsedTime"</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">new</span></span>[] { sw.ElapsedMilliseconds.ToString() }); <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">var</span></span> amendedBody = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> MemoryStream()) <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">var</span></span> streamWriter = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> StreamWriter(amendedBody)) { streamWriter.Write(responseBody); amendedBody.Seek(<span class="hljs-number"><span class="hljs-number">0</span></span>, SeekOrigin.Begin); <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> amendedBody.CopyToAsync(bodyStream); } } } } } } } }</code> </pre><br><br>  We have a private field of type <b>RequestDelegate</b> , which stores the delegate that is passed to the constructor.  The type <b>RequestDelegate itself</b> encapsulates the method that the <b>HttpContext</b> accepts and returns <b>Task</b> : <br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">delegate</span></span></span><span class="hljs-function"> Task </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">RequestDelegate</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">HttpContext context</span></span></span><span class="hljs-function">)</span></span>;</code> </pre><br><br>  The <b>HttpContext</b> object <b>is</b> similar to the same from previous versions of ASP.NET in that it provides access to the request, response, etc., but it is a completely different beast and it is much easier. <br><br>  In ASP.NET 5, middleware is an instance of <b>Func &lt;RequestDelegate, RequestDelegate&gt;</b> is the delegate that takes <b>RequestDelegate</b> as a parameter and returns <b>RequestDelegate</b> .  And, as described above, <b>RequestDelegate</b> is a function that returns a function, and this is the principle by which the processing pipeline is built ‚Äî each part of the intermediate layer, chained to another part, is responsible for passing on to the next processing in the chain (if necessary). <br><br>  The Invoke method will be invoked at run time based on the convention.  This is the place where the processing takes place in your part of the middleware, and the place where you give control to the next component in the pipeline if necessary.  It is possible that you do not need to transfer control further, but instead stop execution, for example, if it is an authentication component that determines that the current user does not have the appropriate rights.  Control is passed to the next component by calling <b>await _next (context)</b> .  The code that you place before and will be executed, for example, in our case, we create a stopwatch and start it.  In addition, we have access to the answer, which is implemented as a stream of data.  Then the next component is called, which in turn calls the next one and so on.  Then control is passed back through the component chain and the code that was added after the <b>await _next (context)</b> call is <b>executed</b> .  It is in this block of code in our example that the response body changes to include HTML with elapsed time in the footer of the page.  And then a header with the same value is added. <br><br><h3>  Wedging into conveyor </h3><br>  The next step is to include the component in the processing pipeline.  As described above, this can be done using the extesion method, for example: <br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">namespace</span></span> <span class="hljs-title"><span class="hljs-title">ASPNET5Test.MiddleWare</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">BuilderExtensions</span></span> { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> IApplicationBuilder </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">UseMyMiddleware</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">this</span></span></span></span><span class="hljs-function"><span class="hljs-params"> IApplicationBuilder app</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> app.UseMiddleware&lt;MyMiddleware&gt;(); } } }</code> </pre><br><br>  This is a simple example of a wrapper around the standard UseMiddleware method, which can now be found in <b>Microsoft.AspNet.Builder</b> . <br>  Well, the last step is to call our method in the <b>Startup</b> class. <br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Configure</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">IApplicationBuilder app, IHostingEnvironment env, ILoggerFactory loggerfactory</span></span></span><span class="hljs-function">)</span></span> { app.UseMyMiddleware(); <span class="hljs-comment"><span class="hljs-comment">// ...</span></span></code> </pre><br><br>  When you first start the site takes a lot of time - almost 2 seconds, which can be seen at the bottom of the page: <br><img src="https://habrastorage.org/files/c11/be8/9e2/c11be89e2c2d4126b63c91a5cb77fcde.png"><br><br>  Well, with the help of, for example, Developer Tools in Chrome, you can see the headers: <br><img src="https://habrastorage.org/files/f73/738/6d6/f737386d69ab4206bc0d5253bd9036ae.png"><br><br><h3>  Conclusion </h3><br>  This article introduced the replacement of traditional HTTP modules and showed how to create and implement an instance of such a handler in an application.  This article is based on the ASP.NET 5 Beta 3 version and the concepts that are illustrated here are subject to change. </div><p>Source: <a href="https://habr.com/ru/post/255463/">https://habr.com/ru/post/255463/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../255453/index.html">Microsoft Unveils New Container Technology for Next-Generation Cloud</a></li>
<li><a href="../255455/index.html">Ice cream candy, or how to add some Material to your application</a></li>
<li><a href="../255457/index.html">Lights Out and its unusual uses</a></li>
<li><a href="../255459/index.html">Making the code cleaner: A few words about the managed resources in the Linux kernel for device drivers</a></li>
<li><a href="../255461/index.html">How I did a Torrent-Box on a Raspberry Pi</a></li>
<li><a href="../255465/index.html">This watch writes time ...</a></li>
<li><a href="../255471/index.html">Software Configurable Networks and Network Virtualization: Reality Check</a></li>
<li><a href="../255473/index.html">Interactive tree menu</a></li>
<li><a href="../255475/index.html">As a student, a bug in Yandex.Music found</a></li>
<li><a href="../255477/index.html">Review System for Online Stores - Cackle Reviews</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>