<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>As we multiplayer for NFS MW wrote</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hi, Habr! In my first post I will tell you how we have been writing the unofficial multiplayer for NFS Most Wanted 2005 release for half a year. I‚Äôll ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>As we multiplayer for NFS MW wrote</h1><div class="post__text post__text-html js-mediator-article">  Hi, Habr!  In my first post I will tell you how we have been writing the unofficial multiplayer for NFS Most Wanted 2005 release for half a year.  I‚Äôll say right away that there will be no links, just screenshots, so that they don‚Äôt count it as a banal advertisement.  If it is interesting - ask in the comments.  Go! <br><br><img src="https://habrastorage.org/web/930/eaa/daf/930eaadafaf444f9b03d1088e2138731.png" alt="image"><br><a name="habracut"></a><br>  It all started at the end of 2016, that is, the past, the year, and more precisely in November.  I talked to the developer of trainers MWInside, which, frankly, did not shine with special knowledge.  I said that I would like to learn how to control cars that are different from the player - rivals, police and ordinary traffic machines.  He did not respond to this, because then nobody knew about it.  Let's skip to the end of December when I met Jojez, the man who inspired me for all this, and the ExOpts team that helped me with ideas.  So, I had the addresses of coordinates, speed, tilt and rotation of the player on my hands.  Through some research, I figured out that they are all fields of the same structure, supposedly ISimable, 176 bytes in size, i.e.  adding 176 to all of these addresses gave the same values ‚Äã‚Äãfrom the other car.  It was a discovery that, in fact, opened dozens of ways, but first, until the end of January, I did not write online, but a simple trainer to control a police helicopter.  Once again, skip to the twenty-third of January. <br><br><h1>  Itself, in fact, multiplayer </h1><br>  So, the twenty-third number, morning.  I suggest to my friend, YaNet, to write multiplayer.  He agrees, takes the code from his old projects, and by the twenty-fourth we have a minimal server and client in C #.  Subsequently, it was rewritten in C, but that‚Äôs another story.  On the twenty-fourth, we began to do work with the game.  By the way, we used the NFSScript API to create mods from DennisStanistan.  We forced the client to ask for a random number from the server, and then, after it arrived, they would display it on the screen by means of the game.  It was only the beginning ... 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h1>  Sync players - hell </h1><br>  Soon it was time to do real multiplayer.  It worked quite simply: customers sent their coordinates, the server sent them to the others, those on their side assigned them to the machines.  Nothing interesting, but it was also terribly unstable and bagano: the cars were literally under attack, they were shaking and throwing up.  At the same time, one of the administrators of the site, whose name I will not disclose, in order not to advertise, ArturoPlayerOne, created a fixed topic that says that an open test is being conducted.  Of course, people got into the chat, but because of the really breaking all the bugs, no one could play normally, although they remained interested.  Subsequently, all these bugs, of course, were corrected, but only by completely rewriting the client and server in C.  Synchronization was also fixed, but that's another story ... <br><br>  And this is a piece of code :) <br><br><pre><code class="cpp hljs">mw_write_memory(MW_ADDR_AI_STR_RACE, <span class="hljs-string"><span class="hljs-string">"AIActionNone"</span></span>, <span class="hljs-number"><span class="hljs-number">13</span></span>); <span class="hljs-comment"><span class="hljs-comment">//    ? float hud_scale = 0.97265; //-,   HUD          Xbox 360 mw_write_memory(MW_ADDR_HUD_WIDTH, &amp;hud_scale, 4); // HUD... mw_write_memory(MW_ADDR_HUD_HEIGHT, &amp;hud_scale, 4); uint8_t opcode = 0xC3; //...  .   ,  HUD,   . mw_write_memory((void*)0x604DA0, &amp;opcode, 1); uint8_t widescreen_splash_patch[] = {0x90, 0x90}; mw_write_memory((void*)0x5A3080, widescreen_splash_patch, 1); void* ws_screen_pointer = 0x89F828; mw_write_memory((void*)0x8F3C68, &amp;ws_screen_pointer, 4); mw_write_memory((void*)0x8F3C88, &amp;ws_screen_pointer, 4); mw_write_memory((void*)0x8F3CA4, &amp;ws_screen_pointer, 4); uint8_t force_7_ai_patch1[] = {0xB8, 0x06, 0x00, 0x00, 0x00}; //    :     7 .  ,     ,   ... mw_write_memory((void*)0x5DA122, force_7_ai_patch1, 5); uint8_t force_7_ai_patch2[] = {0xB8, 0xC5, 0x88, 0x3B, 0x9F, 0x50, 0xE8, 0x22, 0x45, 0xFE, 0xFF, 0x83, 0xC4, 0x04, 0x5E, 0xC2, 0x04, 0x00}; //...    . ,   ?     :   [eax]    "character_smart"          .  EAX     ,      , , ,      ,    ,    EAX  /.  ,  ,    . mw_write_memory((void*)0x5FD353, force_7_ai_patch2, 18);</span></span></code> </pre> <br>  Pretty long code, to be honest.  I wrote the comments about fifteen minutes.  Okay, let's go on! <br><br><h1>  What problems have we experienced </h1><br>  There were a lot of them, some are there now, but today we will talk about the three most important ones, from the very end.  Go! <br><br><h3>  Number three: sync </h3><br>  Why even in third place, you ask?  Because especially she did not interfere, IMHO.  Yes, she was terrible, but did not break the gameplay.  How did we fix it? <br>  To be honest, we didn‚Äôt completely fix it to this day, but let me tell you about everything we tried to do. <br><br><ul><li>  <b>Severe Chelyabinsk method</b> : we tried to synchronize all physical parameters and as often as possible.  Ha-ha, nope!  No changes, only everything began to slow down hopelessly.  In the trash. </li><li>  <b>Reducing the size of packages</b> .  The action is not bad, because the client "eats" less traffic, only as a solution to the synchronization problem is meaningless to the bone.  In a landfill. </li><li>  And finally.  <b>separation of coordinates and speeds</b> , really working decision.  Previously, we synchronized everything and always, but now it has changed: speed and rotation are always synchronized, but the coordinates are only every few seconds.  This made the players smooth and beautiful. </li></ul><br><h3>  Number two: devouring the whole compound </h3><br>  Yes, yes, once our client scored the channel, which is closely related to the number one.  On connections worse than the Google data center connection, the client simply <b>did not work</b> , or did not let the rest work.  This was fixed only recently, in version 0.6.  As it turned out, in some unknown way, I wrote code that not only did DoS- (and if there are five players on the players' server, then in general DDoS-) attacking the server, it also killed the connection, sending a byte so a thousand times in millisecond!  I do not know what else can be said about this bug, but it has been fixed, so everything is ok.  Go to the first place! <br><br><h3>  Number one: reruns </h3><br>  Even more precisely, shutdown.  The withdrawal of players from the game simply was not provided.  If a person went to an empty server once, his ID was equal to one.  If he restarts the client, his ID will already be equal to two.  Strange isn't it?  And what if three players chase together, one has a connection, and he comes in again?  Need I say that three players were the maximum?  This terribly enraged me and all the players.  In the end, I rallied and did write off the players.  If there are no packages from the player within two seconds, he is disconnected.  Accidental disconnection is excluded - twice a second, "ping" still comes.  I think that is all. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/8ff/372/dea/8ff372deae64c49b7cac9921cbe2ad77.png" alt="image"><br><br>  <i>Another screenshot</i> <br><br><h1>  Afterword </h1><br>  He will not be.  The only thing - <a href="https://habrahabr.ru/users/grimmaple/" class="user_link">GrimMaple</a> , respond!  I also want to say thanks: <br><br><ul><li>  nlgzrgn for a way to get seven opponents in a race; </li><li>  SpeedyHeart / speedycat / SpeedyChan for help with synchronization; </li><li>  Xanvier and DennisStanistan for the addresses of the functions of the game and for their use; </li><li>  elaymm4 for design, ideas, video, in one word for the ‚Äúface‚Äù of fashion; </li><li>  YaNet (dz3n) for help at first; </li><li>  Numerous players for loyalty to our project.  A glass for you! </li></ul><br>  That's all!  Bye everyone  If, however, they publish, I will be glad and release a sequel, for here I have described only the most important.  See you! <br>  PS I was asked a lot in the comments, so I post the information and links: <br>  The project is called MW-Online. <br>  Gameplay video: <a href="https://youtu.be/LMGLWHeLuJo">https://youtu.be/LMGLWHeLuJo</a> . <br>  Screenshots are in the article, if you want to play, that is, <a href="https://discord.gg/383Q6q5">Discord-server</a> .  Communication is mainly in English, but there is a Russian channel. </div><p>Source: <a href="https://habr.com/ru/post/334744/">https://habr.com/ru/post/334744/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../334734/index.html">WI-FI in the subway: Catch me if you can. Challenges of configuring dynamic networks</a></li>
<li><a href="../334736/index.html">Why correcting spelling, grammar and punctuation errors in a product is very important</a></li>
<li><a href="../334738/index.html">Machine learning: from Iris to Telecom</a></li>
<li><a href="../334740/index.html">We invite you to the –∞–ø Java and Linux - Fight for microseconds ‚Äô</a></li>
<li><a href="../334742/index.html">It's time to recover data. Do you know where they are?</a></li>
<li><a href="../334748/index.html">6 reasons why real estate automation requires breaking stereotypes</a></li>
<li><a href="../334750/index.html">5 easy ways to mess up a font</a></li>
<li><a href="../334752/index.html">Contra, Battledods and Mortal Kombat in one box. The story of how I made a slot machine and put it in the office</a></li>
<li><a href="../334754/index.html">Series of webinars on the SAP Cloud Platform and PaaS Market</a></li>
<li><a href="../334756/index.html">Python Click Generator for Data Engineer</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>