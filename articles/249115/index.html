<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>How we made a mod under the Oculus Rift for World of Tanks</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Prehistory 
 About a year and a half ago, the DK1 fell into the hands of the developers of the Minsk studio Wargaming. A month later, when everyone pl...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>How we made a mod under the Oculus Rift for World of Tanks</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/getpro/habr/post_images/c6c/a29/0b9/c6ca290b9349030c0a00f1481f153343.jpg" alt="image"><br><br><h4>  Prehistory </h4><br>  About a year and a half ago, the DK1 fell into the hands of the developers of the Minsk studio Wargaming.  A month later, when everyone played enough in Team Fortress and Quake in Full 3D, the idea arose to embed something with Oculus in the Tanks themselves.  On the process, results and pitfalls of working with Oculus - read below. <a name="habracut"></a><br><br>  In World of Tanks, we support a certain amount of gaming peripherals, which expands the player's UX (vibroncaps, for example).  However, with the advent of the two billionth Oculus Rift, we decided that it would be time to please not only the players seat, but also give them a new eye candy. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Honestly, no one knew how it should look like, how to help the player.  The task of developing the mod set, as they say, "just for lulz".  Slowly, when the brain refuses to think about the main tasks, we started the integration: we downloaded the Oculus SDK, installed it and started to deal with the source code of the examples. <br><br>  The work began using the first devkit, which was somewhat dangerous for the psyche.  The fact is that the first devkit had very low resolution screens.  Fortunately, quickly enough we got our hands on the HD version, which is more fun to work with. <br><br><h4>  Sdk </h4><br>  We started development with SDK version 0.2.4 for DK1.  Then, when receiving the HD Prototype, the new SDK version was not required.  Therefore, we spent 90% of the time using the SDK version that is rather old, but nonetheless satisfying our needs.  Then, when the work on the Oculus-mod was almost completed, DK2 came to us.  And it turned out that the old SDK is no longer suitable for him.  But is this a problem?  Download the new SDK, already version 0.4.2.  Suddenly it turned out that it was rewritten a little more than completely.  I had to change almost the entire wrapper over the device, make various edits.  But the most interesting thing happened with the rendering.  If before the pixel shader was simple enough, in the new version it was changed and complicated.  And blame the lens.  I don‚Äôt know why such a decision was made, but the side effect of the lenses is terrible chromatic aberrations, decreasing from the edge of the field of view towards the center.  To fix this defect and was rewritten pixel shader.  The solution is at least strange: to degrade the performance of the application due to a strange engineering solution.  But!  Inquisitive mind and resourcefulness will save the galaxy: it turned out that the lenses from DK1 and HD P are also excellent for DK2.  And they have no side effects.  Like this. <br><br><h4>  Initialization </h4><br>  The process of initializing the device itself, getting the context is completely transferred from the example - Ctrl + C Ctrl + V in action.  There are no pitfalls here. <br><br><h4>  Rendering </h4><br>  The stereoscopic image in the device is obtained in the classical way, by drawing the scene from two different angles and providing each of the images to the corresponding eye.  Read more about this <a href="http://en.wikipedia.org/wiki/Stereoscopy">here</a> . <br><br>  In line with this, our original stereoscopic imaging algorithm was as follows: <br><br>  1. Installation of matrices <br><br>  Since for each eye it is necessary to produce a render with a small offset, you first need to modify the original view-matrix.  The required transformation matrices for each eye are provided by the Oculus Rift SDK.  The modification is as follows: <br><br>  ‚Ä¢ Get a matrix of additional transformation. <br>  ‚Ä¢ Transpose it (Oculus Rift uses a different coordinate system). <br>  ‚Ä¢ Multiply the obtained matrix on the left by the original one. <br><br>  2. Render two times with the change of matrix <br><br>  After modifying the view-matrix for the left eye and setting it in the render context, we draw as usual.  After that, we modify the view-matrix once again for the right eye, put it in a render-context and draw again. <br><br>  3. Post-effect lens distortion <br><br>  For a more complete filling of the visual perception zone, Oculus uses lenses that give a side effect in the form of distortion of the geometry of objects.  In order to suppress this effect, an additional post-effect is applied to the final render, distorting the image in the opposite direction. <br><br>  4. Output the final image <br><br>  Finally, the image is formed by combining the renders for both eyes, in which each is drawn on the corresponding half of the screen, and applying the post-effect of distortion to them. <br><br><h4>  Challenges </h4><br>  In the course of development, we quickly discovered that currently there are no clear, 100% working guidelines for OR work in games.  If you run several different games with OR support, then each of them will have different implementations of interfaces and controls in the oculus.  As far as we know, the developers of Oculus Rift do not specifically make strict requirements and rules.  Their idea is that game developers themselves set up experiments.  For this reason, during the development process, we had to redo our integration with Oculus more than once: it would seem that it was ready, but at some points something was not right, something annoying, and as a result, half of the logic had to be discarded. <br><br>  It adds a couple more fun of our features.  Firstly, in World of Tanks, the camera basically hangs over the tank, and turning the head in the oculus in this mode by design does not match your experience from the real world.  You can‚Äôt hang over the equipment you are leading in life (and sometimes it could be so useful ...). <br><br>  In addition, World of Tanks is a PvP game, where you are opposed by <s>29</s> 15 other players in each battle.  As a result, Oculus should not be hard on the combat skills of the user.  This nuance adds additional hassle when developing.  If you digress a little and consider the applicability of the Oculus Rift in multiplayer games in general, then this device will suit not every class of games.  In projects with Quake 3 and Team Fortress 2 dynamics, the oculus can do more harm than good.  In Oculus you seem to look at the world through the eyes of man, but the dynamics of movement in such games is completely different from reality.  As already mentioned, if the game does not use first-person cameras, then there are problems with orientation in space, and in general it is not entirely clear, but what do we do when we look around.  The impression was that, first of all, Oculus Rift is applicable to single player games, where the player‚Äôs immersion is at the forefront, and also management with ‚Äúinconveniences‚Äù is permissible. <br><br><h4>  Common UI Problem </h4><br>  In our game - however, as in most others - almost the entire UI (both in the hangar and in battle) is located on the sides of the screen.  And if you produce output UI without any additional modifications, the following problem occurs.  Due to the design features of the Oculus, only the central part of the image is in scope.  And UI, in turn, does not fall into this part (or partially). <br><br><img src="https://habrastorage.org/getpro/habr/post_images/728/e48/462/728e48462dce30c0514a79a3e1b8bd33.jpg" alt="image"><br><br><img src="https://habrastorage.org/getpro/habr/post_images/d18/c92/732/d18c92732edafb33826da8205333ec16.jpg" alt="image"><br><br>  Here are the ways to solve this problem, we tried. <br><br>  1. Reduce the interface and make it appear in the center of the screen, getting into view.  To do this, it is necessary to produce its output in a separate render target and then apply it during post-processing. <br><br>  This method solves the problem of visibility UI, but dramatically reduces the information content and readability. <br><br>  2. Use the Oculus orientation matrix to position the UI, that is, enable the user to view not only the 3D scene, but also the UI. <br><br>  This method is devoid of the disadvantages of the first: information content and readability are limited only by the resolution of the device.  But it has its drawbacks: to perform the usual actions (viewing the tanks in the carousel; checking the balance of silver, etc.) requires a lot of head movements and - what follows from the previous one - it is difficult to synchronize the movements of the UI and the camera for the 3D scene. <br><br>  3. Combine the previous methods, i.e.  ‚ÄúScaling‚Äù the interface and at the same time giving the opportunity to inspect it.  The main problem is the selection of such a parameter of the scale that would preserve the readability of the text and would allow to get rid of a large number of head movements. <br><br>  At first, we didn‚Äôt do the separation between the interfaces in the hangar and in combat.  Moreover, the use of the Oculus orientation matrix for inspecting the UI was inspired by the combat interface.  Almost the entire visible area was occupied by the 3D scene, and this seemed to be correct, but the inability to find out the number of ‚Äúunits of strength‚Äù of our own tank or the location of allies / opponents on the minimap did not contribute to getting a fan from the bouncy tank rubilov in full 3D.  It was then that we thought about the ‚Äúinspected‚Äù UI: to see, for example, the minimap, we had to turn a little and tilt our head - a completely natural movement for a person who knows the interface of our game.  And here we are faced with a problem that I described: after five minutes of constant rotation of my head in search of a minimap, a tank doll and the number of shells, the neck began to hurt. <br><br>  Evolution, as indicated above, was the use of a hybrid version: now part of the interface was visible from the beginning and only a small ‚Äúrefinement‚Äù of the head was required for a full inspection. <br><br>  It would seem that the problem has been solved, but after watching the guys from our publisher, this option is shallowed. <br><br>  Even despite the naturalness of movements for information, the constant need to rotate the head and then quickly return to its original position to perform active actions was recognized as uncomfortable and hindering the enjoyment of the game.  Since there are no active actions in the hangar, it was decided to leave the hybrid version in it: by that time HD Prototype arrived in time and gave decent text quality with a small UI scale. <br><br>  In the same HD Prototype, due to the increased resolution, more 3D scenes began to fit into the visible area.  We decided to stop the experience with the combat UI and make it static, but customizable, allowing you to change the position and size of its elements directly in runtime. <br><br>  Simultaneously with the solution of these problems, we had to think about another point: some elements of the UI should not be scaled together with others (for example, indicators of the direction of impact, equipment markers, scopes).  I had to make adjustments to the rendering order: some of the interface elements now began to be drawn along with the 3D scene. <br><br><h4>  Camera Management </h4><br>  Oculus is not only an image output device, but also an input device.  The input is the quaternion of orientation (in DK1 and HD P is the matrix) of the device in space.  Therefore, we wanted to use this data not only to position the UI, but also to control the cameras. <br><br><h5>  Hangar </h5><br>  In the hangar, the control circuit of the cameras was made like this: the mouse controls the angle of inclination and the length of the tank "selfie stick".  At the end of this ‚Äústick‚Äù there is a camera, the direction of which can be controlled with the help of Oculus: look around, inspect not only the tank, but also the surrounding space. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/afc/9bc/637/afc9bc6377c3bea0fb41837d9fe3015b.jpg" alt="image"><br><br><h5>  Arcade mode </h5><br>  In the arcade mode, the mouse rotates, as before, rotate the coordinate system from which the aiming takes place, the turns of the head in the oculus occur in this coordinate system. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/735/330/413/735330413add89019ad7395135142699.jpg" alt="image"><br><br><h5>  Sniper mode </h5><br>  Initially, we were working on the opportunity to aim the head.  But they quickly abandoned this approach due to the low accuracy of shooting, the load on the neck and the difficulties in synchronizing the movements of the mouse and head, the speed of turning the head and the turret of the tank. <br><br>  Then they tried to make some kind of Team Fortress aiming system: the camera is controlled by head movements, but there is some space in the center of the visible area in which the sight can only be moved with the mouse for more accurate shooting.  The prototype was not bad, but the difficulties of use remained. <br><br>  Therefore, we decided to dwell on the simplest and most effective option: the camera is controlled by the head and the mouse.  That is, when the head moves, the aiming point does not change - only the direction of the camera.  And when the mouse moves, both the aiming point and the direction of the camera change. <br><br><h5>  Strategic mode </h5><br>  Initially, it was not planned to use Oculus to play the art, so there are no modifications in the strategic mode. <br><br><h5>  Gunner mode </h5><br>  Once, having exhausted ideas, no matter how interesting the Oculus could be as an input device, we discussed the pros and cons of the device and suggested that it would be easier for the player to imagine himself in the virtual 3D world as a virtual person than a virtual tank.  And they decided to highlight the role in the tank, which the player will be interested in trying on: this role was the role of the gunner.  We already had a camera that can be fixed on any node of the tank, so it only remained to adjust the positioning and limit the field of view so that the player could not look inside the tank or through the barrel.  For the test, we chose two tanks - the IC and Tiger I - because of their popularity and the availability of their models in HD at the time of development.  The implementation took only a few days, but in the end the mode turned out to be the most interesting and unusual in terms of gameplay. <br><br>  The name of the regime so far ‚Äúfloats‚Äù: someone calls it ‚Äúthe gunner‚Äôs camera‚Äù, someone ‚Äúthe camera from the commander‚Äôs turret‚Äù.  The main feature of the mode is that the camera in it hangs in the coordinate system of the real turret of the tank, and at the same time head turns are allowed using the Oculus Rift.  At the same time, the entire tank of the player is not hiding, so that you can take a look at the whole bulk of your car.  But in this perspective, the tank is perceived much more impressive than through the camera, a few dozen meters away.  In this case, the question arose, to which point of the tower to mount the camera in this mode.  For the IC and Tiger I, we made a hardcode version: the camera in it is mounted next to the barrel.  Generating points for the remaining hundreds of our tanks in the automatic mode is not easy to implement, and manual processing will take too much time.  For this reason, the ability to manually adjust the camera's position keys is in vogue. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/f84/820/e00/f84820e002acfe0883bc8013e7d4cb2a.jpg" alt="image"><br><br><h4>  findings </h4><br>  Oculus Rift is a very interesting device that adds a lot of new sensations to the games.  However, as is often the case, the creation of a production-ready-integration of such a device is not a matter of a couple of days.  If you decide to build its support into an already existing game (not one that was originally made for VR), then you will need: <br><br>  1. Partial rework of the in-game menu.  Even if you refuse to fully integrate it into virtual space (projecting elements onto game objects, location according to real world coordinates, etc.), the menu display will need to be adjusted. <br><br>  2. Strong, perhaps a radical rework directly gameplay UI.  Oculus Rift has not the largest resolution, and if you just take the HUD out of the game and hang it in front of Oculus, then the interface elements will take up too much space.  In addition, it will not leave the feeling of "flies before my eyes."  So, it is necessary to cut the UI, put something on the eyes, carry something more secondary, and this requires the UI to react to the rotation of the head.  A combat UI projected onto game objects (cabin, helmet, and the like) will potentially take up too few pixels on the screen when drawing, and there will be no informativeness from it. <br><br>  3. The gaming camera architecture must be extensible.  Oculus is not only a device for displaying pictures on its screens, but also a device for inputting the orientation of the head.  Consequently, these data need to somehow be shoved into gaming cameras in a human way.  And if you need the opportunity to look around, then the aiming system in the game should be independent of the orientation of the camera.  In our case, the camera of the gunner, for example, is obtained by the composition of the logic of the sniper and arcade modes.  Also, the separation of the logic of the review and the logic of aiming facilitates the integration of Oculus with already existing control modes, without forcing overriding them. <br><br>  4. And last but equally important: Oculus requires the creation of a control system specific to it.  An implementation in which the movement by the oculus is the same as moving the mouse may well not work (this option, perhaps, immediately falls well only on flight simulators, where the logic of turning the pilot‚Äôs head is still implemented and the view from the cockpit is the main mode review). <br><br>  In short, the advantages of Oculus include: <br>  ‚Ä¢ sufficient openness for cooperation; <br>  ‚Ä¢ SDK development; <br>  ‚Ä¢ PR; <br>  ‚Ä¢ John Carmack (lol). <br><br>  Minuses: <br>  ‚Ä¢ lack of general recommendations for gameplay integration; <br>  ‚Ä¢ oddity with chromatic aberration in 0.4.2; <br>  ‚Ä¢ perception complexity in third-person games (especially if the hero is a tank, not a humanoid); <br>  ‚Ä¢ common problems for all helmets: <br><ul><li>  focusing; </li><li>  screen resolution (even in the HD version (sic!)); </li><li>  discomfort with prolonged use (neck + headache). </li></ul><br>  The mod itself can be <a href="https://yadi.sk/d/UP-_P-kRf9doZ">downloaded from this link</a> . </div><p>Source: <a href="https://habr.com/ru/post/249115/">https://habr.com/ru/post/249115/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../249101/index.html">A brief course of computer graphics: we write a simplified OpenGL do it yourself, article 3.14 of 6</a></li>
<li><a href="../249103/index.html">Curves Beziers de Castelgio. HTML5 Canvas</a></li>
<li><a href="../249105/index.html">How to get convenient access to XAML-resources from Code-Behind</a></li>
<li><a href="../249107/index.html">ReactJS for stupid people</a></li>
<li><a href="../249113/index.html">Categories</a></li>
<li><a href="../249117/index.html">Proxy server for free internet</a></li>
<li><a href="../249119/index.html">Xclaim - ‚Äúnoisy‚Äù * Wi-Fi invasion of small business</a></li>
<li><a href="../249123/index.html">Upgrade from Windows 7 / 8.1 to Windows 10 TP via Windows Update</a></li>
<li><a href="../249127/index.html">Practice "Intel IoT". Galileo Gen2 - Eclipse & libmraa + UPM</a></li>
<li><a href="../249129/index.html">Push non-ASCII to inappropriate locations.</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>