<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>NSProxy, as a way to cut corners</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="As many have read in books, there are initially two root classes in the Objective-C language - NSObject and NSProxy. And if almost everything is based...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>NSProxy, as a way to cut corners</h1><div class="post__text post__text-html js-mediator-article">  As many have read in books, there are initially two root classes in the Objective-C language - NSObject and NSProxy.  And if almost everything is based on the first one and it is impossible not to face it, then the second one is used much less often.  In this small article I will describe the applications of this class that I had to use. <br><a name="habracut"></a><br>  As a first example, let me remind you about such a thing as UIAppearance ‚Äî as far as I know ‚Äî the only use of NSProxy in basic iOS frameworks.  Its task is to pre-configure the group of UIKit objects in one place.  In fact, you describe some set of actions that will be applied to each created object (such as specifying colors, fonts, and others) that satisfy certain conditions (there are currently two conditions: object class and object class containing our object as a subview).  There is a wonderful <a href="http://nshipster.com/uiappearance/">article</a> on the use, capabilities, and side effects of such a tool, so we will no longer dwell on this. <br><br>  To be honest, it is not thick.  For such a proud status as ‚Äúone of two root classes,‚Äù there are too few examples of constructive use.  According to my personal experience and the experience of my familiar developers, this makes the initial understanding of this entity rather difficult and, as a result, it dissuades us from using it.  But it is interesting!  And over time, tasks began to appear, for which the NSProxy is a tremendous convenience tool. <br><br><h3>  Decorating objects </h3><br>  In the implementation of the ‚Äúdecorator‚Äù pattern there is one rather inconvenient aspect - the interface of the decorator itself.  If we have some hierarchy of objects, for example 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <pre><code class="objectivec hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">@interface</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">SomeClass</span></span></span><span class="hljs-class"> : </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">NSObject</span></span></span><span class="hljs-class"> &lt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">SomeClassInterface</span></span></span><span class="hljs-class">&gt; @</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">end</span></span></span><span class="hljs-class"> @</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">interface</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ChildClass</span></span></span><span class="hljs-class"> : </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">SomeClass</span></span></span><span class="hljs-class"> -(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">void</span></span></span><span class="hljs-class">) </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">additionalMethod</span></span></span><span class="hljs-class">; @</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">end</span></span></span><span class="hljs-class"> @</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">interface</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">DecoratorClass</span></span></span><span class="hljs-class"> : </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">NSObject</span></span></span><span class="hljs-class"> &lt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">SomeClassInterface</span></span></span><span class="hljs-class">&gt; ... </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ChildClass</span></span></span><span class="hljs-class"> *</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">instance</span></span></span><span class="hljs-class"> = [</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ChildClass</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">new</span></span></span><span class="hljs-class">]; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">id</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">decoratedInstance</span></span></span><span class="hljs-class"> = [</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">DecoratorClass</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">decoratedInstanceOf</span></span></span><span class="hljs-class">:</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">instance</span></span></span><span class="hljs-class">]</span></span></code> </pre> <br>  That for obvious reasons, decoratedInstance will no longer be able to perform additionalMethod.  And it remains for us to either write categories, or introduce some hooks into the root class, or deal with some other similar indecency.  Now let's see how this can be solved using NSProxy. <br><pre> <code class="objectivec hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">@interface</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">SomeClass</span></span></span><span class="hljs-class"> : </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">NSObject</span></span></span><span class="hljs-class">; -(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">int</span></span></span><span class="hljs-class">) </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">getNumber</span></span></span><span class="hljs-class">; -(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">NSString</span></span></span><span class="hljs-class">*) </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">getString</span></span></span><span class="hljs-class">; @</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">end</span></span></span><span class="hljs-class"> @</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">interface</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">SimpleDecorator</span></span></span><span class="hljs-class"> : </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">NSProxy</span></span></span><span class="hljs-class"> @</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">property</span></span></span><span class="hljs-class"> (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">nonatomic</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">strong</span></span></span><span class="hljs-class">) </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">SomeClass</span></span></span><span class="hljs-class"> *</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">instance</span></span></span><span class="hljs-class">; +(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">instancetype</span></span></span><span class="hljs-class">) </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">decoratedInstanceOf</span></span></span><span class="hljs-class">:(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">SomeClass</span></span></span><span class="hljs-class">*)</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">instance</span></span></span><span class="hljs-class">; @</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">end</span></span></span><span class="hljs-class"> @</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">implementation</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">SimpleDecorator</span></span></span><span class="hljs-class"> -(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">instancetype</span></span></span><span class="hljs-class">) </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">initWithObject</span></span></span><span class="hljs-class">:(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">SomeClass</span></span></span><span class="hljs-class">*)</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">object</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-comment"><span class="hljs-comment">/*   - NSProxy    ,  NSObject.   [super init]  */</span></span> _instance = object; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>; } +(<span class="hljs-keyword"><span class="hljs-keyword">instancetype</span></span>) decoratedInstanceOf:(SomeClass*)instance { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> [[<span class="hljs-keyword"><span class="hljs-keyword">self</span></span> alloc] initWithObject:instance]; } <span class="hljs-comment"><span class="hljs-comment">/*   NSProxy -    ,      ,      .  ,    ,     -    SomeClass    */</span></span> - (<span class="hljs-built_in"><span class="hljs-built_in">NSMethodSignature</span></span> *)methodSignatureForSelector:(SEL)selector { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> [<span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.instance methodSignatureForSelector:selector]; } - (<span class="hljs-keyword"><span class="hljs-keyword">void</span></span>)forwardInvocation:(<span class="hljs-built_in"><span class="hljs-built_in">NSInvocation</span></span> *)invocation { <span class="hljs-comment"><span class="hljs-comment">/*   , , ,       - ,    ,        , ,    getString */</span></span> [invocation invokeWithTarget:<span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.instance]; } <span class="hljs-comment"><span class="hljs-comment">/*   .         NSProxy -       */</span></span> - (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>) getNumber { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> [<span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.instance getNumber] + <span class="hljs-number"><span class="hljs-number">1</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">@end</span></span></code> </pre><br>  And, actually, an example of using this design: <br><pre> <code class="objectivec hljs"> SomeClass *object = [SomeClass new]; object = (SomeClass*)[SimpleDecorator decoratedInstanceOf:object]; <span class="hljs-built_in"><span class="hljs-built_in">NSLog</span></span>(<span class="hljs-string"><span class="hljs-string">@"%d"</span></span>, [object getNumber]); <span class="hljs-built_in"><span class="hljs-built_in">NSLog</span></span>(<span class="hljs-string"><span class="hljs-string">@"%@"</span></span>, [object getString]);</code> </pre><br>  With this approach, on site SomeClass can be any of its heirs and the resulting decorated object will correctly respond to all messages sent to it. <br><br><h3>  Delayed setting </h3><br>  In fact, we will now solve the problem, similar to the one that UIAppearance solves.  When working on a project built on the basis of the architecture proposed by the PureMVC pattern library ( <a href="http://en.wikipedia.org/wiki/PureMVC">en.wikipedia.org/wiki/PureMVC</a> ), we had to repeatedly encounter a situation where, at some point in the code, we initiate a chain of command-actions, which will result in some context-sensitive entity ‚Äî for example, a pop-up window, closing of which triggers the following actions, depending on the context in which the window was called.  Previously, one of two options was used for this: <br>  - Broach.  Through the entire chain of actions, we transmit additional, somehow structured data that we process on the spot where the window was created.  A rather unprofitable and not very beautiful way, especially if some actions involve branching. <br>  - "I know everything".  Since PureMVC makes the main objects, in fact, singletons, and you can reach anyone at any time - you can try to get all the necessary context in the pop-up window command, which is fraught with a significant increase in code connectivity. <br><br>  Using NSProxy, you can achieve a slightly different behavior: Set context-dependent properties to an object BEFORE it was created - in the place where we know these conditions.  Sounds, of course, somewhat absurd, but somehow it works.  We treat the existing NSProxy object as a target object that is not yet available.  NSProxy keeps inside of itself the actions that we have taken and when an object is instantiated - it applies them to it. <br>  Now for some code. <br><br>  First, the class we want to use for deferred configuration: <br><pre> <code class="objectivec hljs"><span class="hljs-comment"><span class="hljs-comment">/*   ,   . */</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">@interface</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Popup</span></span></span><span class="hljs-class"> : </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">NSObject</span></span></span><span class="hljs-class">; /*    ,    ,      */ @</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">property</span></span></span><span class="hljs-class"> (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">nonatomic</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">strong</span></span></span><span class="hljs-class">) </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">NSString</span></span></span><span class="hljs-class">* </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">key</span></span></span><span class="hljs-class">; @</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">property</span></span></span><span class="hljs-class"> (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">nonatomic</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">strong</span></span></span><span class="hljs-class">) </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">NSString</span></span></span><span class="hljs-class">* </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">message</span></span></span><span class="hljs-class">; /*       ,        ,     </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">UIAppearance</span></span></span><span class="hljs-class"> */ +(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">DelayedActionsProxy</span></span></span><span class="hljs-class">*) </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">delayedInitializerForKey</span></span></span><span class="hljs-class">:(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">NSString</span></span></span><span class="hljs-class">*)</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">key</span></span></span><span class="hljs-class">; /*   .      ,      */ -(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">void</span></span></span><span class="hljs-class">) </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">showPopup</span></span></span><span class="hljs-class"> @</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">end</span></span></span><span class="hljs-class"> @</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">implementation</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Popup</span></span></span><span class="hljs-class"> -(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">void</span></span></span><span class="hljs-class">) </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">showPopup</span></span></span><span class="hljs-class"> </span></span>{ [DelayedActionsProxy invokeDelayedInvocationsWithTarget:<span class="hljs-keyword"><span class="hljs-keyword">self</span></span>]; <span class="hljs-comment"><span class="hljs-comment">/*...*/</span></span> } +(DelayedActionsProxy*) delayedInitializerForKey:(<span class="hljs-built_in"><span class="hljs-built_in">NSString</span></span>*)key { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> [DelayedActionsProxy sharedProxyForKey:key fromClass:[<span class="hljs-keyword"><span class="hljs-keyword">self</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span>]]; } <span class="hljs-keyword"><span class="hljs-keyword">@end</span></span></code> </pre><br>  And now, actually, proxy <br><pre> <code class="objectivec hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">@interface</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">DelayedActionsProxy</span></span></span><span class="hljs-class"> : </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">NSProxy</span></span></span><span class="hljs-class"> +(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">void</span></span></span><span class="hljs-class">) </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">invokeDelayedInvocationsWithTarget</span></span></span><span class="hljs-class">:(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Popup</span></span></span><span class="hljs-class">*) </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">target</span></span></span><span class="hljs-class">; +(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">instancetype</span></span></span><span class="hljs-class">) </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">sharedProxyForKey</span></span></span><span class="hljs-class">:(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">NSString</span></span></span><span class="hljs-class">*)</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">key</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">fromClass</span></span></span><span class="hljs-class">:(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Class</span></span></span><span class="hljs-class">)</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">objectClass</span></span></span><span class="hljs-class">; @</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">end</span></span></span><span class="hljs-class"> @</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">interface</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">DelayedActionsProxy</span></span></span><span class="hljs-class">() /*             ,    -      */ @</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">property</span></span></span><span class="hljs-class"> (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">nonatomic</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">strong</span></span></span><span class="hljs-class">) </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">NSString</span></span></span><span class="hljs-class"> *</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">currentKey</span></span></span><span class="hljs-class">; @</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">property</span></span></span><span class="hljs-class"> (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">nonatomic</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">assign</span></span></span><span class="hljs-class">) </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">currentClass</span></span></span><span class="hljs-class">; @</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">property</span></span></span><span class="hljs-class"> (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">nonatomic</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">strong</span></span></span><span class="hljs-class">) </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">NSMutableDictionary</span></span></span><span class="hljs-class"> *</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">delayedInvocations</span></span></span><span class="hljs-class">; @</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">end</span></span></span><span class="hljs-class"> @</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">implementation</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">DelayedActionsProxy</span></span></span><span class="hljs-class"> -(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">instancetype</span></span></span><span class="hljs-class">) </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">init</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.delayedInvocations = [<span class="hljs-built_in"><span class="hljs-built_in">NSMutableDictionary</span></span> new]; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> DelayedActionsProxy *proxy = <span class="hljs-literal"><span class="hljs-literal">nil</span></span>; +(<span class="hljs-keyword"><span class="hljs-keyword">instancetype</span></span>) sharedProxyForKey:(<span class="hljs-built_in"><span class="hljs-built_in">NSString</span></span>*)key fromClass:(Class)objectClass { <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-built_in"><span class="hljs-built_in">dispatch_once_t</span></span> onceToken; <span class="hljs-built_in"><span class="hljs-built_in">dispatch_once</span></span>(&amp;onceToken, ^{ proxy = [[<span class="hljs-keyword"><span class="hljs-keyword">self</span></span> alloc] init]; }); proxy.currentKey = key; proxy.currentClass = objectClass; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> proxy; } <span class="hljs-comment"><span class="hljs-comment">/*      [[Popup delayedInitializerForKey:@"key"] setText:@"someText"],      -     ,     currentKey  currentClass */</span></span> - (<span class="hljs-built_in"><span class="hljs-built_in">NSMethodSignature</span></span> *)methodSignatureForSelector:(SEL)selector { <span class="hljs-comment"><span class="hljs-comment">/*   currentClass   ,   ,     instanceMethodSignature  methodSignature */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> [<span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.currentClass instanceMethodSignatureForSelector:selector]; } - (<span class="hljs-keyword"><span class="hljs-keyword">void</span></span>)forwardInvocation:(<span class="hljs-built_in"><span class="hljs-built_in">NSInvocation</span></span> *)invocation { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!<span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.delayedInvocations[<span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.currentKey]) { <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.delayedInvocations[<span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.currentKey] = [<span class="hljs-built_in"><span class="hljs-built_in">NSMutableArray</span></span> new]; } <span class="hljs-comment"><span class="hljs-comment">/*     ,     */</span></span> [<span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.delayedInvocations[<span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.currentKey] addObject:invocation]; } <span class="hljs-comment"><span class="hljs-comment">/*      */</span></span> +(<span class="hljs-keyword"><span class="hljs-keyword">void</span></span>) invokeDelayedInvocationsWithTarget:(Popup*) target { <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-built_in"><span class="hljs-built_in">NSInvocation</span></span> *invocation <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> proxy.delayedInvocations[proxy.currentKey]) { [invocation invokeWithTarget:target]; } [proxy.delayedInvocations removeObjectForKey:proxy.currentKey]; } <span class="hljs-keyword"><span class="hljs-keyword">@end</span></span></code> </pre><br>  And an example of using <br><pre> <code class="objectivec hljs">[[Popup delayedInitializerForKey:<span class="hljs-string"><span class="hljs-string">@"key"</span></span>] setText:<span class="hljs-string"><span class="hljs-string">@"someText"</span></span>];</code> </pre><br><br><h3>  Facilitate working with UI objects </h3><br>  In multithreaded applications, quite often, due to carelessness and insufficient planning at the initial stage, you can get code that runs in a different thread, but with which passion is how to modify the UI (or database, or something else that is very sensitive to multithreaded access).  The code starts to grow into numerous performSelectorOnMainThread, dispatch_async, or worse - wrappers over NSInvocation, because performSelectorOnMainThread does not allow using more than one parameter.  Why not get a single wrapper for this? <br><br>  Suppose we have some object (for example, an object in the game on Cocos2D) <br><pre> <code class="objectivec hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">@interface</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Entity</span></span></span><span class="hljs-class"> : </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">NSObject</span></span></span><span class="hljs-class">; @</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">property</span></span></span><span class="hljs-class"> (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">nonatomic</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">strong</span></span></span><span class="hljs-class">) </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">CCNode</span></span></span><span class="hljs-class">* </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">node</span></span></span><span class="hljs-class">; @</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">end</span></span></span><span class="hljs-class"> @</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">implementation</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Entity</span></span></span><span class="hljs-class"> -(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">void</span></span></span><span class="hljs-class">)</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">setRepresentation</span></span></span><span class="hljs-class">:(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">CCNode</span></span></span><span class="hljs-class"> *)</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">node</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-comment"><span class="hljs-comment">/* -     ... */</span></span> _node = (CCNode*)[MainThreadProxy node]; } <span class="hljs-keyword"><span class="hljs-keyword">@end</span></span></code> </pre><br>  And the proxy itself <br><pre> <code class="objectivec hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">@interface</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">MainThreadProxy</span></span></span><span class="hljs-class"> : </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">NSProxy</span></span></span><span class="hljs-class"> +(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">instancetype</span></span></span><span class="hljs-class">) </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">proxyWithObject</span></span></span><span class="hljs-class">:(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">id</span></span></span><span class="hljs-class">)</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">object</span></span></span><span class="hljs-class">; /*        ,            ,    */ -(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">void</span></span></span><span class="hljs-class">)</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">performBlock</span></span></span><span class="hljs-class">:(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">void</span></span></span><span class="hljs-class"> (^)(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">id</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">object</span></span></span><span class="hljs-class">))</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">block</span></span></span><span class="hljs-class">; @</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">end</span></span></span><span class="hljs-class"> @</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">interface</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">MainThreadProxy</span></span></span><span class="hljs-class">() @</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">property</span></span></span><span class="hljs-class"> (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">nonatomic</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">strong</span></span></span><span class="hljs-class">) </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">id</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">object</span></span></span><span class="hljs-class">; @</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">end</span></span></span><span class="hljs-class"> @</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">implementation</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">MainThreadProxy</span></span></span><span class="hljs-class"> -(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">instancetype</span></span></span><span class="hljs-class">) </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">initWithObject</span></span></span><span class="hljs-class">:(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">id</span></span></span><span class="hljs-class">)</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">object</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.object = object; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>; } +(<span class="hljs-keyword"><span class="hljs-keyword">instancetype</span></span>) proxyWithObject:(<span class="hljs-keyword"><span class="hljs-keyword">id</span></span>)object { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> [[<span class="hljs-keyword"><span class="hljs-keyword">self</span></span> alloc] initWithObject:object]; } - (<span class="hljs-built_in"><span class="hljs-built_in">NSMethodSignature</span></span> *)methodSignatureForSelector:(SEL)selector { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> [<span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.object methodSignatureForSelector:selector]; } - (<span class="hljs-keyword"><span class="hljs-keyword">void</span></span>)forwardInvocation:(<span class="hljs-built_in"><span class="hljs-built_in">NSInvocation</span></span> *)invocation { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ([<span class="hljs-built_in"><span class="hljs-built_in">NSThread</span></span> isMainThread]) { [invocation invokeWithTarget:<span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.object]; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { [invocation performSelectorOnMainThread:<span class="hljs-keyword"><span class="hljs-keyword">@selector</span></span>(invokeWithTarget:) withObject:<span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.object waitUntilDone:<span class="hljs-literal"><span class="hljs-literal">YES</span></span>]; } } -(<span class="hljs-keyword"><span class="hljs-keyword">void</span></span>)performBlock:(<span class="hljs-keyword"><span class="hljs-keyword">void</span></span> (^)(<span class="hljs-keyword"><span class="hljs-keyword">id</span></span> object))block { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ([<span class="hljs-built_in"><span class="hljs-built_in">NSThread</span></span> isMainThread]) { block(<span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.object); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { <span class="hljs-built_in"><span class="hljs-built_in">dispatch_sync</span></span>(dispatch_get_main_queue(), ^{block(<span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.object);}); } } <span class="hljs-keyword"><span class="hljs-keyword">@end</span></span></code> </pre><br>  An example of use is quite common. <br><pre> <code class="objectivec hljs">[entity.node render];</code> </pre><br>  But we have a guarantee that this can be caused perfectly correctly from any thread. <br><br><h3>  Completion </h3><br>  As ideas for what you can use a proxy, you can still highlight such things as <br>  - Masking a remote object - to work with an object, which is the representation of a service with non-fixed response time (for example, a database on a site, an object on a client that you are connected to via BlueTooth), like a normal object.  Just slow. <br>  - Wrapper in Proxy Timer, so that syntax like is appropriate <br><pre> <code class="objectivec hljs">[[object makeCallWithTimeInterval:<span class="hljs-number"><span class="hljs-number">1.0</span></span>f andRepeatCount:<span class="hljs-number"><span class="hljs-number">2</span></span>] someMethod];</code> </pre><br>  other. <br>  It should be borne in mind that this is, of course, not a panacea.  You should be very careful when working with getters, for example, in the example above, the line <br><pre> <code class="objectivec hljs">[entity.node.effect update];</code> </pre><br>  will not behave correctly.  This, of course, can be fixed, but these fixes also have their price.  I recommend not to forget about it when working with NSProxy. <br><br><h3>  Post Scriptum </h3><br>  In general, you can read about NSProxy even for example <a href="http://borkware.com/rants/agentm/elegant-delegation/">here</a> , or <a href="https://www.mikeash.com/pyblog/friday-qa-2009-03-27-objective-c-message-forwarding.html">here</a> .  NSProxy is deeply used in a tool like OCMock.  Anyway, this is a fairly flexible and convenient tool, suitable for a certain class of tasks - and, at least, it has made sense to become familiar with it. </div><p>Source: <a href="https://habr.com/ru/post/235041/">https://habr.com/ru/post/235041/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../235023/index.html">Intel introduced its first 8-core processor for desktop computers</a></li>
<li><a href="../235031/index.html">Internet Archive will upload over 14 million free historical images to Flickr</a></li>
<li><a href="../235033/index.html">On e-bikes around Russia or in search of outlets outside the Moscow Ring Road</a></li>
<li><a href="../235035/index.html">Support for jQuery events has been added to Firefox Developer Tools.</a></li>
<li><a href="../235037/index.html">A few words about pipelines in FPGA</a></li>
<li><a href="../235047/index.html">Samsung Unveils New Gear S Smart Watch and Gear Circle Headset</a></li>
<li><a href="../235049/index.html">ICANN gave green light to BEL</a></li>
<li><a href="../235055/index.html">Horace Dediu: what it means to be a professional analyst in the field of smartphones</a></li>
<li><a href="../235057/index.html">The beauty of the cosmos or how I read popular science lecture</a></li>
<li><a href="../235061/index.html">Rest in Peace, MSN Messenger</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>