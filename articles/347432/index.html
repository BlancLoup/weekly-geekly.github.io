<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>POS, security and that's it. Parse the vulnerabilities of the popular Retail-system</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hello. Today I would like to talk with you about Point of Sale (hereinafter POS) systems, their architecture and security. Probably, the post-holiday ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>POS, security and that's it. Parse the vulnerabilities of the popular Retail-system</h1><div class="post__text post__text-html js-mediator-article"><p><img src="https://habrastorage.org/webt/yf/x_/gn/yfx_gnmqkwq0drfkb1299b0gum0.png" alt="POS_security"></p><br><p>  Hello.  Today I would like to talk with you about Point of Sale (hereinafter POS) systems, their architecture and security.  Probably, the post-holiday shock from the long lines in the shops has passed, and it's time to see what is behind this veil of social communications.  The study described below was conducted by <a href="https://habrahabr.ru/users/chipik/">@chipik</a> and me. </p><a name="habracut"></a><br><p>  Modern POS systems are a combination of software and hardware solutions that enable payment transactions and facilitate daily business processes.  Speaking about POS, usually refer to cash registers, payment terminals and other customary components of trade stores.  However, the POS architecture is not limited to these elements only.  As for security, it would seem that this topic is not new: since 2012, at almost every BlackHat USA conference there was a report on payment systems ( <a href="https://www.blackhat.com/docs/us-14/materials/us-14-Zaichkowsky-Point-Of-Sale%2520System-Architecture-And-Security.pdf">here</a> , <a href="https://www.blackhat.com/docs/us-14/materials/us-14-Anderson-How_Smartcard-Payment-Systems-Fail.pdf">here</a> , <a href="https://labs.mwrinfosecurity.com/assets/BlogFiles/PinPadPwn-BH2012.pdf">here</a> , <a href="https://www.blackhat.com/docs/us-15/materials/us-15-Fillmore-Crash-Pay-How-To-Own-And-Clone-Contactless-Payment-Devices.pdf">here</a> ).  But all these reports, being very close to the topic under discussion, are still a little bit about something else. </p><br><p>  To make it clearer, let's consider the payment procedure in a regular store: </p><br><p><img src="https://habrastorage.org/webt/4c/w1/di/4cw1dirvwqilaq_sw-fv_tjlxrg.png" alt="Payment"></p><br><p>  First, the buyer spends the card on the reader of the terminal to pay for their purchases.  Credit card details are sent to the terminal, from where they are sent to the POS system.  Next, the POS system contacts the PSP (Payment Service Provider), which, depending on the type of credit card, contacts the bank to complete the transaction authorization procedure.  Just at this moment, the buyer is asked to enter a PIN to confirm the transaction.  If everything went well, the authorization code is returned from the banking network to the PSP and transmitted to the POS system and the terminal.  All the above communications occur within a couple of seconds. </p><br><p>  Research and attacks, which were mentioned at the beginning, are mainly aimed at payment terminals, at customer interaction with them.  Today, another part will be considered - POS-systems through which transaction data passes. </p><br><p>  We have already spoken several times about various business processes, what are they?  Consider, for example, the classic online store.  The store has a manager, most likely there are several of them.  Every morning, the manager needs to open a store, and then POS terminals.  I would like to note that POS-terminals are not the same as payment terminals.  The first image is the payment terminal, and the second is the POS terminal. </p><br><p><img src="https://habrastorage.org/webt/6g/eo/50/6geo50kflirobstr1jjehg0yv40.png" alt="pay_term"><img src="https://habrastorage.org/webt/o2/ey/le/o2eyleptvpfj4phtsi-vrsj992u.png" alt="pos_term"></p><br><p>  During startup, POS terminals synchronize time and receive updated parameters from the store server, including product prices, information on their availability and other service data.  After that, cashiers can log in for their jobs and start work.  Obviously, every action at the checkout is logged. </p><br><p><img src="https://habrastorage.org/webt/hj/_4/fr/hj_4frtz9kkedudij1bqkftdatk.png" alt="day_beg"></p><br><p>  At the end of the day, the manager needs to repeat the procedure in the reverse order: first close the cash registers and then the store.  After this action, no transaction can be carried out until the store opens.  During closing, POS-terminals send their logs to the server.  These are the business processes mentioned above.  It is their POS-systems that make it easier and easier. </p><br><p><img src="https://habrastorage.org/webt/gg/k3/gc/ggk3gc35re1x_x8ker-twq4vjqw.png" alt="day_end"></p><br><p>  There are quite a few solutions on the POS systems market, and they are divided into product groups for small, medium and large organizations. </p><br><p>  For the most part, they have similar architecture.  In this article we will look at the SAP solution in detail: "SAP Point of Sale".  We also investigated the company's Oracle product MICROS, which found similar vulnerabilities closed in January 2018 (CVE-2018-2636). </p><br><p>  You can learn more about SAP at the <a href="https://www.sap.com/">official site</a> .  In a nutshell: SAP is developing large ERP solutions for large companies.  POS-systems as a product appeared at SAP in 2005, when it swallowed up another company - Triversity Transactionware GM, which deals exclusively with POS-solutions. </p><br><h2 id="arhitektura-sap-pos">  SAP POS Architecture </h2><br><p><img src="https://habrastorage.org/webt/py/dv/i0/pydvi056icj96ncx40ngyiv_dbu.png" alt="POS_arc"></p><br><p>  The architecture of this system consists of three parts: Front Office, Back Office and Head office.  The first part includes the client part, i.e.  POS client and Mobile POS Client, which are the POS terminals that cashiers work at.  Front Office is connected to Back Office, where the local store server (Xpress Server), the Database and the solution for the local POS system management (Store manager) are located, using which the manager opens and closes the store and terminals. </p><br><blockquote>  Speaking of a local solution, we mean a specific store, since SAP POS is a product for large organizations, and it was designed for a network of stores with central management.  In other words, in this case, the local solution is the POS system of one of the stores in the network. <br>  The global management of the store network is carried out from the head office, using Store Configurator, which is connected to all store servers. </blockquote><p>  The general review is made, now let's look at how it all works in more detail.  And we will move in the following order: </p><br><p><img src="https://habrastorage.org/webt/hy/d4/v4/hyd4v40culthfjpes0v5bqjwqws.png" alt="Steps"></p><br><h4 id="head-office">  Head office </h4><br><p><img src="https://habrastorage.org/webt/s8/d6/zh/s8d6zhvtxkn3tqg0iezmu9ftuu8.png" alt="Head_back"></p><br><p>  Store Configurator is an application that allows you to configure everything in POS systems.  No, not so, ABSOLUTELY everything, starting with the users and the appearance of the cashier's screen and ending with encryption and other security settings. </p><br><p>  How is all this implemented?  After making changes in Store Configurator, the administrator needs to click "convert", and special files with these parameters will be created on the file system in the "Store Configurator / data / parm /" folder. </p><br><blockquote>  There are a lot of files, as well as parameters, the extensions are also different.  Let's give an example: <br><ul><li>  cnummask.cmk - contains information about the "mask" of the buyer's card number, i.e.  about how many and what numbers will be on the check; </li><li>  rcptlogo.rcp - here is the data on the logo of the company, which is printed on the check; </li><li>  cashier.clg - contains information about users of the POS system (cashiers, managers and others), including personal data (name, birth date, phone number) and authorization data (login, password hash); </li><li>  layout.ui0 - contains information about the appearance of the POS terminal, the location of the keys, the background image, etc. </li></ul><br></blockquote><p>  The content of the files is a textual representation of the parameters specified in Store Configurator.  The image below is the rcptlogo.rcp file. </p><br><p><img src="https://habrastorage.org/webt/rz/ax/ay/rzaxayu_getgjxfaocbrmm5rpiu.png" alt="rcptlogo"></p><br><p> Next, the administrator needs to copy these files to the "/ Xpress Server / parm /" folder of each server of the store.  Among the files created by Store Configurator, there is one "special".  It is called "newparm.trg", and contains only one character "Z".  Xpress Server (store server), every 30 seconds checks the folder "/ parm /" for the presence of this file.  If it finds it, it applies the updated parameters from the downloaded files and deletes the "newparm.trg".  Thus, this file acts as a kind of update trigger. </p><br><h4 id="back-office">  Back office </h4><br><p><img src="https://habrastorage.org/webt/th/sv/v3/thsvv3jbtsioqjxv5xhqfhagsms.png" alt="back"></p><br><p>  Next in line is the Back Office, or rather the communications inside it.  It consists, as mentioned earlier, of Xpress Server, Database and Store Manager.  All these components can be installed on one machine or on different ones.  Store Manager interacts with the base via standard ports and in this case is very similar to Store Configurator with limited functionality and the only difference is that it writes parameter changes to the database directly using stored procedures. </p><br><blockquote>  As part of the study of the system, two amusing procedures were found: ssp_insert_backdoor and ssp_delete_backdoor.  Their main goal is to create a user with the name "back" and a password "door" and elevated privileges.  Of course, this was done only in the event that all users in the POS system forget their authorization data. <br><img src="https://habrastorage.org/webt/nr/hj/ck/nrhjck30bem_bslyz4biy0pyvgs.png" alt="stored_procedures"></blockquote><p>  The interaction of Store Manager and Xpress Server is carried out on port 2202, and it looks more interesting.  Studying the Store Manager functionality, we found the Store Administration section, which provides interesting features: </p><br><ul><li>  firstly, all connected POS terminals are displayed; </li><li>  secondly, they can be opened and closed; </li><li>  thirdly, there is a monitoring function that allows you to track everything that is displayed on the cashier's screen (information about purchases and checks). </li></ul><br><p><img src="https://habrastorage.org/webt/6k/5c/j_/6k5cj_mlpkbx4p36dur4jorcuu0.png" alt="mon_term"></p><br><p>  Having looked at the packages that Store Manager sends to port 2202 Xpress Server (where to without WireShark), we saw plaint-text commands.  "It`s telnet protocol used for monitoring and not critical configuration," we learned from the documentation.  Okay, what if we try to connect to this port from a foreign machine? </p><br><p>  As it turned out, no white list is provided.  By default, this port is open, and there are no recommendations for closing it in the Security Guide.  Naturally, you can restrict access to the ports by third-party means, but we are looking at the security of the POS system, right? </p><br><p>  After connecting to the Xpress Server on port 2202, we are greeted with a welcome message with the POS version of the system.  The "help" command returns a list of available functions: </p><br><pre><code class="hljs pgsql"><span class="hljs-number"><span class="hljs-number">999</span></span> *** XPRESS <span class="hljs-keyword"><span class="hljs-keyword">SERVER</span></span> MOST COMMON COMMAND HELP *** <span class="hljs-number"><span class="hljs-number">999</span></span> MONXPS [<span class="hljs-keyword"><span class="hljs-keyword">ON</span></span>|<span class="hljs-keyword"><span class="hljs-keyword">OFF</span></span>]  <span class="hljs-number"><span class="hljs-number">999</span></span> [SHOWTERM|TERMINAL-STATUS] [<span class="hljs-keyword"><span class="hljs-keyword">ALL</span></span>|Term#]  <span class="hljs-number"><span class="hljs-number">999</span></span> [MONTERM|MONITOR-TERMINAL] [<span class="hljs-keyword"><span class="hljs-keyword">ALL</span></span>|XPS|Term#] [<span class="hljs-keyword"><span class="hljs-keyword">START</span></span>|STOP|<span class="hljs-keyword"><span class="hljs-keyword">ON</span></span>|<span class="hljs-keyword"><span class="hljs-keyword">OFF</span></span>]  <span class="hljs-number"><span class="hljs-number">999</span></span> <span class="hljs-keyword"><span class="hljs-keyword">OPEN</span></span>-TERMINAL [<span class="hljs-keyword"><span class="hljs-keyword">ALL</span></span>|Term#]  <span class="hljs-number"><span class="hljs-number">999</span></span> <span class="hljs-keyword"><span class="hljs-keyword">OPEN</span></span>-STORE [TODAY|NumberOfSecsSinceJan1<span class="hljs-number"><span class="hljs-number">-1970</span></span>]  <span class="hljs-number"><span class="hljs-number">999</span></span> <span class="hljs-keyword"><span class="hljs-keyword">CLOSE</span></span>-TERMINAL [<span class="hljs-keyword"><span class="hljs-keyword">ALL</span></span>|Term#] [FORCE|<span class="hljs-keyword"><span class="hljs-keyword">NO</span></span>-FORCE|<span class="hljs-keyword"><span class="hljs-keyword">ABORT</span></span>]  <span class="hljs-number"><span class="hljs-number">999</span></span> TERMINAL-BALANCE [Term#] [BAL|UNBAL]  <span class="hljs-number"><span class="hljs-number">999</span></span> CASHIER-BALANCE [Cashier#] [<span class="hljs-number"><span class="hljs-number">1</span></span>|<span class="hljs-number"><span class="hljs-number">2</span></span>|<span class="hljs-number"><span class="hljs-number">3</span></span>] [ShortOver Amount] [netTenderTotal] &lt;<span class="hljs-comment"><span class="hljs-comment">-- 1=BALANCED 2=UNBALANCED 3=PREVIOUS BALANCE NOW OUT OF DATE  999 UPDATE-CASHIER [Cashier#]  999 DELETE-CASHIER [Cashier#]  999 END-OF-DAY [FORCE|NO-FORCE|ABORT]  999 STORE-TOTALS [CLOSE-DAY|CLOSE-WEEK|CLOSE-PERIOD|DONE-END-OF-DAY|...]  999 STORE-TOTALS CONSOL-DAY [RTOT|SRTOT|CTOT|SPROD|...]  999 COMMS-RESET [1|2|3] &lt;-- 1=ALL 2=REMOTE 3=MODEMS  999 FLUSH-PLUCACHE  999 TRIGGER-NEWPROMOS  999 SHUTDOWN  999 . &lt;-- Use to repeat previous command</span></span></code> </pre> <br><p>  From the names of these functions is quite clear their purpose.  The absence of any verification allows you to anonymously open and close POS terminals, monitor everything that happens on them (for example, when you buy the contents of the check on the console) or simply turn off the Xpress Server. </p><br><p>  It became very interesting how these functions are implemented in the code, and whether all the commands are displayed in the "help" output.  The process that processes incoming requests is xps.exe.  A little reverse, and was found a list of possible commands.  They turned out to be a little more than 17 ... 74 of them. 74 teams receive and process Xpress Server from port 2202. It would take too long to describe everything, let's focus on the most interesting ones. </p><br><p><img src="https://habrastorage.org/webt/sh/vf/ne/shvfne0ulhdhkz1tzk8o8ma9cd8.png" alt="ida"></p><br><p>  <strong>APM-VALIDATE-PASSWD</strong> - allows you to check the authorization data entered by the user.  This command returns three different codes: 0 - if the password is entered correctly, 1 - if the password is incorrect, 10 - if there is no user with such login.  Obviously, nothing prevents a potential intruder from being in the local network of the store, sorting through all possible combinations of usernames and passwords (a username can consist only of numbers) and obtain data for accessing POS terminals. </p><br><p><img src="https://habrastorage.org/webt/sr/t8/et/srt8etlyfpyxrxgajlj3dm-l36m.png" alt="validate"></p><br><p>  But brute-force is not very cool, so there is another command, <strong>Reset password</strong> , which changes the user's password to a new one.  All you need to know is the login, which can be obtained by brute force.  And one more small clarification.  In this POS system, a login can consist only of numbers, which greatly facilitates a hypothetical search. </p><br><p><img src="https://habrastorage.org/webt/me/af/vf/meafvfex0pbx_boa_idxlct68cw.png" alt="reset"></p><br><p>  The <strong>FILE-FIND</strong> , <strong>FILE-OPEN</strong> and <strong>FILE-READ</strong> commands allow you to find, open and read data on the Xpress Server file system.  You still remember that all this happens without registration and SMS, anonymously?  It is curious that the parameters of the FILE-OPEN command are passed directly to the C ++ fopen () function, and if the mode is specified incorrectly, then the Xpress Server application receives an error and terminates. </p><br><p><img src="https://habrastorage.org/webt/ri/xf/sg/rixfsgu5-ozeubozfixum2ht_t4.png" alt="files"></p><br><p>  We turn to the last part of the review. </p><br><h4 id="front-office">  Front office </h4><br><p><img src="https://habrastorage.org/webt/67/pj/2p/67pj2p17b9ia_airihqn3cq6fjw.png" alt="back_front"></p><br><p>  POS-client, also known as POS-terminal, connects to the server on port 2200. All information, all transactions and all communications take place on this port and only in this direction: the initiator is the client, and the server simply accepts and responds to requests.  If we recall business processes, then everything happens as follows.  At the beginning of the day, when the manager opens the POS terminal, he sends the packet to the server: "Server, I am terminal number 5, I am open, send me new parameters and let's synchronize the date and time."  At the end of the day, when the manager closes the POS terminal, he sends his logs to the server.  And, of course, after each transaction, data about it and about the change in the quantity of goods is also sent to the server.  Looking at the traffic between the POS terminal and the Xpress Server, we found that the packets to receive and download files have a certain structure: </p><br><p><img src="https://habrastorage.org/webt/ic/7w/5d/ic7w5dwizt4ngs2r3kxhhduqsay.png" alt="packet"></p><br><p>  Len is the length of the packet being sent.  Where - the place where we write the data.  What - the place where we get the data.  End - a pair of NULL-bytes.  Type - type of the package, depending on which with the package certain actions will be performed.  Packages can be: </p><br><p><img src="https://habrastorage.org/webt/ym/ev/6p/ymev6phk4v8r3ofcagwrunlt32k.png" alt="packet_types"></p><br><p>  So, for example, in order to receive a file with settings from a server, POS-client sends a packet of type R to port 2200: </p><br><pre> <code class="hljs tex">{R0059}C:<span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">\</span></span></span></span>local_directory<span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">poc</span></span></span></span>.txt,C:<span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">remote</span></span></span></span>_directory<span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">poc</span></span></span></span>.txt,0,0;</code> </pre> <br><p>  In this package: </p><br><ul><li>  R is a type; </li><li>  0059 - data length; </li><li>  C: \ local_directory \ poc.txt - where the file is written to; </li><li>  C: \ remote_directory \ poc.txt - where the file is stored on the server; </li><li>  0,0 - the end of the package. </li></ul><br><p>  In the answer, POS-client receives the contents of the requested file and writes it to itself in a special directory.  When trying to duplicate a package sent by POS-client from another machine, the response also received the contents of a file on the server.  As we see, there are also no checks here: the port 2200 Xpress Server accepts and processes packets from any machine. </p><br><p>  It seemed funny, but you will not go far to read files.  Let's try to build a set of packages to upload your file to the server.  After all, POS-client somehow writes the logs to the server, right? </p><br><p><img src="https://habrastorage.org/webt/qk/f-/uz/qkf-uzgpcph-jehkrm-ulzccvqa.png" alt="attack"></p><br><p>  First, we send a packet of type S. The Where field contains the path on the server where we will write data, the What field is optional, since we do everything manually, but the Size size is very important, in which we specify the size of the next, second packet.  It will be of type F - FILE_DATA and will consist of its size and data (contents) that we want to write to the server.  Well, the third and last C type package is the end of the file.  After that, Xpress Server writes the file to the specified directory and returns a package of type G - GOOD.  Curiously, if you send a packet with the wrong Size field, Xpress Server will delete the file on the server.  Below you can see a POC video of anonymous recording, reading and deleting a file: </p><br><iframe width="560" height="315" src="https://www.youtube.com/embed/OLlJLmCk1oU" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br><p>  Thus, due to the absence of any checks, any person who can connect to this port can read, write and delete files on the server. </p><br><p>  And what of all this can be obtained?  Let's see what can be achieved by combining the above features. </p><br><p>  So, the attacker must have access to the local network of the store.  Usually it is not difficult to get it, because  Peripherals, including scales, are regularly in the halls, and access to them is unlimited. </p><br><div class="spoiler">  <b class="spoiler_title">Some real life photos</b> <div class="spoiler_text"><p><img src="https://habrastorage.org/webt/ow/g0/d3/owg0d3_j1dwgpenjehniluvtvje.png" alt="point1"></p><br><p><img src="https://habrastorage.org/webt/km/xy/cv/kmxycvpd-pun-4w-mvewgkxuwpa.png" alt="point4"></p><br><p><img src="https://habrastorage.org/webt/rr/rc/go/rrrcgoil6kn7_wx39x8mwnstleu.png" alt="point2"></p><br><p><img src="https://habrastorage.org/webt/mv/_c/xi/mv_cxibudprlnci670dntijk2qa.png" alt="point3"></p></div></div><br><p>  Let's summarize our knowledge of the system: </p><br><ol><li>  Store Configurator creates special files with system parameters, copies them to Xpress Server, which applies parameters when it finds the file "newparm.trg". </li><li>  The attacker can write any data to any file in any directory on Xpress Server using port 2200. </li><li>  POS terminals receive updated parameters from the Xpress Server and apply them after opening. </li><li>  An attacker can anonymously disable and enable POS clients using port 2202. </li></ol><br><p>  The combination of these features allows you to change any parameter in the SAP POS system. <br>  Suppose an attacker wants to buy a product, say, for a dollar. </p><br><p><img src="https://habrastorage.org/webt/sa/2h/oo/sa2hoou4tiou_mqutakwbf-yidu.png" alt="attack_2"></p><br><ol><li>  The attacker writes configuration files to the parma folder on the Xpress Server, indicating the new price of the product. </li><li>  The attacker writes the trigger file "newparm.trg" to the Xpress Server folder in the parm folder, activating the update of parameters on the server. </li><li>  The server updates the parameters. </li><li>  Some of them are written to the database. </li><li>  The attacker sends a command to close the terminal. </li><li>  Xpress server closes terminals, terminals send their logs to the server.  The process takes from 10 to 30 seconds. </li><li>  The attacker sends a command to open terminals. </li><li>  Terminals open. </li><li>  Terminals download new parameters from the server and apply them. </li></ol><br><p>  That's all.  But something is still missing, namely, the ability to remotely execute commands on the server.  And she, in general, is. </p><br><p><img src="https://habrastorage.org/webt/be/xw/q_/bexwq_jwcflywgoswv1gsf0jzts.png" alt="rce"></p><br><p>  Every time the Xpress Server updates the settings, i.e.  finds the trigger file "newparm.trg", it searches for and launches two .bat files: XPSPARM.BAT and StopTN.BAT.  And this means only one thing - the attacker can overwrite them and execute the reverse-shell script on itself. </p><br><p><img src="https://habrastorage.org/webt/ps/oo/nr/psoonrlvqyb5chippps0rvpnlv8.png"></p><br><p>  It will look something like this: the attacker replaces the file "XPSPARM.BAT" with his own using port 2200;  writes the file "newparm.trg", thereby causing the parameters to be updated and the "* .bat" file launched. </p><br><h1 id="shifrovanie">  Encryption </h1><br><p>  Yes, SAP POS uses encryption, but by default, out of the box, it is disabled.  If encryption is configured, all important data is transmitted as a ciphertext.  It should be clarified that it is the data that is encrypted, not the communication between the elements of the system.  For example, if you monitor transactions on the terminal with encryption enabled, we will receive in the response ciphertext only instead of the credit card number, the rest of the data will be transmitted in the clear. </p><br><p><img src="https://habrastorage.org/webt/oe/hg/yx/oehgyxdlpku913o6li5b_lw88m8.png" alt="tables"></p><br><p>  This table lists the names of the tables and the fields that must undergo an encryption procedure.  At the same time, there is an additional table "CryptoRegister", which lists the same, but with an indication of the "level" of encryption.  For example, user passwords are stored as hash values ‚Äã‚Äãand have an encryption level of 4, and credit card numbers are encrypted with 3DES and have a level of 3. </p><br><p>  SAP POS uses the TWSecurity tool for storing and generating keys.  When it is launched, a special "container" is created, and access to it is possible only with a password in which the encryption key is stored.  Since 3DES is a symmetric algorithm, the key must be the same on all elements of the system: Front Office, Back office and Head office.  Those.  After creating the container, it must be exported to all parts of the POS system.  Access to the key is carried out only by a token that is registered in the registry.  And everything would be cool, but there is one "BUT". </p><br><p><img src="https://habrastorage.org/webt/em/w8/4b/emw84bouvh-oy95wgbaalywsodq.png" alt="config_key"></p><br><p>  The key (or rather its token), which is used to encrypt data, is set in Store Configurator ... and this means that it is converted, like other parameters, into a special file, and can be changed by the attacker to a blank value to disable encryption in SAP POS. </p><br><h1 id="my-patchili-patchili-i-nakonec-to-zapatchili-ili-chto-delat-v-slozhivsheysya-situacii">  "We patchili, patchili and finally patched!" ... or what to do in this situation </h1><br><p><img src="https://habrastorage.org/webt/rn/i5/na/rni5na1qcdewhetsajrpn2ecbq8.png" alt="final"></p><br><p>  At the moment, the vulnerabilities described in this article are closed.  Yes, not the first time, it turned out almost from the second.  So, the first SAP Note 2476601 was released on July 11, 2017, it had a CVSS 8.1 and was called "Retail Xpress Server".  It was patched access to port 2202 (telnet).  This was done by adding a new parameter "BACKOFFICEIPADDRESS", which defaults to "localhost".  But, at the same time, there was not a single mention of the second vulnerability on port 2200, which worked perfectly and allowed attackers to remotely execute commands, making it possible to ‚Äúbypass‚Äù the fresh July patch, simply by changing this parameter.  Our team reported this flaw to the SAP Product Security Response Team, which released as many as two SAP Note - 2520064 and 2520232, on August 18, 2017.  SAP Note 2520232 removes two stored procedure: "ssp_insert_backdoor" and "ssp_delete_backdoor".  SAP Note 2520064 brought more changes.  This patch added 3DES encryption to almost all the packets exchanged between the various elements of the SAP POS: POS-client, Xpress Server, Store Configurator, Store Manager.  Those.  now, even having the ability to connect to open ports without knowing the key, we have no opportunity to influence the POS system: the server does not understand the unencrypted packets coming to it and simply discards them. <br>  This is a really interesting decision, but it was not without incidents.  Almost immediately after the release of SAP Note, many messages appeared on the forums that Store Manager is not working.  The fact is that SAP has forgotten about Store Manager, or rather, that this component interacts not only with Xpress Server, but also with the database.  When the Store Manager sends an encrypted package to the Database, it returns an error in clear text that the Store Manager cannot decrypt and just crash.  In this regard, the final patch was released, which corrects the error of the previous patch.  Nevertheless, the best solution to protect against possible attacks on your infrastructure is, though not always successful, but regular updates. </p><br><h1 id="true-story">  True story </h1><br><p>  And here is the curious news from the west: Forever 21, a California company, "US fashion retailer", which has been selling clothes all over the world since 1984 (815 stores, 57 countries, USA, Australia, Brazil, China, France, etc. ), December 28, 2017 confirmed the information that part of its POS-systems was coordinated from April 3 to November 18 (!!!).  Experts claim that the attackers had anonymous access to the network of POS systems and used it to install malware to collect information about customers' credit cards (card number, expiration date, owner, authentication code).  It's funny that the encryption of critical data in these systems was disabled (yes, did not work) exactly from April 3 to November 18.  Apparently, encryption is not a big problem not only in SAP systems.  Unfortunately, it was not possible to find exact information about which POS systems were compromised.  If you believe the <a href="https://www.retailtouchpoints.com/features/news-briefs/forever-21-simplifies-pos-with-one-solution-in-16-countries">news</a> , then on June 28, 2017, Forever 21 signed a contract with Toshiba Global Commerce Solutions for the supply of its systems, but by this time the current systems have already been compromised. </p></div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <p>Source: <a href="https://habr.com/ru/post/347432/">https://habr.com/ru/post/347432/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../347422/index.html">Linux-2018: the most promising distributions</a></li>
<li><a href="../347424/index.html">UI, which itself teaches the player control</a></li>
<li><a href="../347426/index.html">We are planning a project for the implementation and improvement of the information system in MS Project - quickly and beautifully</a></li>
<li><a href="../347428/index.html">5 development trends of microservices in 2018</a></li>
<li><a href="../347430/index.html">Anti-virus report for 2017: forget about malware</a></li>
<li><a href="../347434/index.html">AI Tournament for Industrial Air Hockey Robots</a></li>
<li><a href="../347436/index.html">SEO for Google in 2018: well forgotten new</a></li>
<li><a href="../347438/index.html">Face Detection with Movidius Neural Compute Stick</a></li>
<li><a href="../347440/index.html">Salaries of IT Professionals at the End of 2017: My Circle Salary Service Report</a></li>
<li><a href="../347442/index.html">Designing a fire pumping station</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>