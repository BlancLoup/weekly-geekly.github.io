<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Catching online virus activity with Netflow</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="In this topic I will tell you how to establish a simple collection of statistics on anomalous activity in the network in a couple of scripts. 

 Abnor...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Catching online virus activity with Netflow</h1><div class="post__text post__text-html js-mediator-article">  In this topic I will tell you how to establish a simple collection of statistics on anomalous activity in the network in a couple of scripts. <br><br>  Abnormal for us will be at the time of removal of statistics: <br><br>  1. More than 20 outgoing connections on port 25 with 1 IP. <br>  2. More than 100 outgoing connections on port 80 with 1 IP. <br>  3. More than 100 outgoing connections on port 53 with 1 IP. <br>  4. Think of yourself, everything is flexible. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Statistics will be removed from the cache netflow routers.  Whether it will be Cisco or FreeBSD is not important.  I talked about setting up netflow on FreeBSD in my previous articles. <br><a name="habracut"></a><br>  Since we are going to process statistics of outgoing connections, outflow of outgoing traffic from your network is a must in netflow. <br><br>  In cisco, this will be the hanging of the ‚Äúip flow egress‚Äù parameter to the interface from which we want to analyze the outgoing traffic. <br>  About FreeBSD, read <a href="http://habrahabr.ru/blogs/bsdelniki/88022/">Netgraph ipfw and flexible traffic accounting via netflow</a> . <br><br><h3>  Principle of operation </h3><br>  Cisco command <b>"sh ip cache flow"</b> <br><br> <code>7206#sh ip cache flow <br> IP packet size distribution (50885M total packets): <br> 1-32 64 96 128 160 192 224 256 288 320 352 384 416 448 480 <br> .000 .367 .018 .009 .005 .004 .019 .005 .004 .002 .015 .001 .002 .003 .002 <br> <br> 512 544 576 1024 1536 2048 2560 3072 3584 4096 4608 <br> .002 .003 .012 .030 .486 .000 .000 .000 .000 .000 .000 <br> <br> IP Flow Switching Cache, 4456704 bytes <br> 14372 active, 51164 inactive, 1424895745 added <br> 595073185 ager polls, 0 flow alloc failures <br> Active flows timeout in 30 minutes <br> Inactive flows timeout in 15 seconds <br> IP Sub Flow Cache, 1057544 bytes <br> 14372 active, 18396 inactive, 1424881570 added, 1424881570 added to flow <br> 0 alloc failures, 0 force free <br> 2 chunks, 63 chunks added <br> last clearing of statistics never <br> Protocol Total Flows Packets Bytes Packets Active(Sec) Idle(Sec) <br> -------- Flows /Sec /Flow /Pkt /Sec /Flow /Flow <br> TCP-Telnet 2394420 0.5 2 59 1.2 1.6 17.3 <br> TCP-FTP 693781 0.1 12 67 1.9 4.1 7.6 <br> TCP-FTPD 16673 0.0 4116 815 15.9 29.6 10.9 <br> TCP-WWW 705969510 164.3 46 843 7698.6 4.6 11.0 <br> TCP-SMTP 4790885 1.1 16 593 18.5 4.8 8.6 <br> TCP-X 586390 0.1 3 176 0.5 1.0 17.5 <br> TCP-BGP 377369 0.0 3 490 0.3 11.7 17.2 <br> TCP-NNTP 492 0.0 6 270 0.0 4.5 10.8 <br> TCP-Frag 1878 0.0 27 194 0.0 12.3 17.2 <br> TCP-other 283995180 66.1 37 715 2505.0 5.9 12.1 <br> UDP-DNS 42291343 9.8 1 73 10.1 0.0 19.3 <br> UDP-NTP 1781711 0.4 1 76 0.6 7.4 17.9 <br> UDP-TFTP 49776 0.0 5 52 0.0 21.6 17.3 <br> UDP-Frag 293665 0.0 352 106 24.0 15.7 18.1 <br> UDP-other 347985517 81.0 18 618 1503.7 4.4 18.7 <br> ICMP 33442833 7.7 2 80 21.9 5.0 18.4 <br> IGMP 2 0.0 2 28 0.0 0.9 26.5 <br> IPv6INIP 178 0.0 4 68 0.0 13.4 18.1 <br> GRE 60567 0.0 2878 162 40.5 185.4 15.4 <br> IP-other 150016 0.0 89 614 3.1 69.2 17.0 <br> Total: 1424882186 331.7 35 781 11846.6 4.7 13.5 <br> <br> SrcIf SrcIPaddress DstIf DstIPaddress Pr SrcP DstP Pkts <br> Gi0/1 80.75.131.2 Null 123.456.123.14 06 40A0 0050 29 <br> Gi0/1 82.116.35.44 Null 123.456.123.23 06 D52A 0050 5 <br> Gi0/2.105 123.456.789.54 Null 195.151.255.253 06 0050 F9F0 3 <br> Gi0/1 217.172.29.5 Null 123.456.123.33 06 E469 0050 279 <br> Gi0/1 217.172.29.5 Null 123.456.123.43 06 E46B 0050 25 <br> Gi0/1 217.172.29.5 Null 123.456.123.53 06 E46D 0050 51 <br> Gi0/1 82.116.35.44 Null 123.456.123.64 06 D531 0050 5 <br> Gi0/1 217.172.29.5 Null 123.456.123.73 06 E46E 0050 55 <br> Gi0/1 217.172.29.5 Null 123.456.123.13 06 E46F 0050 23 <br> Gi0/1 217.172.29.5 Null 123.456.123.23 06 E464 0050 39 <br> Gi0/2.105 123.456.789.54 Null 67.195.111.40 06 0050 E9FC 5 <br> Gi0/2.105 123.456.789.53 Null 83.167.97.145 06 0050 CF77 7 <br> Gi0/2.105 123.456.789.56 Null 213.180.199.34 11 C479 0035 1 <br> Gi0/2.103 123.456.789.30 Null 123.456.123.56 11 BB7D 0035 1 <br> Gi0/2.105 123.456.789.56 Null 123.456.123.30 11 0035 BB7D 1 <br> <br> [--cut--]   -  [--cut--] <br></code> <br>  here comes such a conclusion, its upper part is not interesting to us, there are general statistics. <br><br>  A similar conclusion, but without general statistics, under FreeBSD is given by the command <b>‚Äúflowctl netflow show‚Äù</b> , where netflow is the name of your ng_netflow node. <br><br> <code>[root@border] /root/&gt; /usr/sbin/flowctl netflow show <br> SrcIf SrcIPaddress DstIf DstIPaddress Pr SrcP DstP Pkts <br> lo0 123.456.161.48 vlan3 212.119.237.214 6 0f93 0050 6 <br> lo0 123.456.153.8 vlan2 154.153.8.109 17 6df4 f45f 20 <br> lo0 123.456.164.126 vlan2 154.164.126.104 17 68eb eb5f 16 <br> lo0 123.456.134.168 vlan2 154.134.168.139 17 8b2c 2c5f 40 <br> lo0 123.456.169.132 vlan2 154.169.132.219 17 db31 315f 28 <br> lo0 123.456.153.13 vlan2 154.153.13.62 17 3e3a 3a5f 28 <br> lo0 123.456.147.214 vlan2 154.147.214.54 17 3658 585f 4 <br> lo0 123.456.161.167 vlan2 154.161.167.102 17 66f5 f55f 4 <br> lo0 123.456.144.147 vlan2 154.144.147.248 17 f88b 8b5f 4 <br> lo0 123.456.162.220 vlan2 154.162.220.42 17 2adc dc5f 27 <br> lo0 123.456.170.119 vlan2 154.170.119.198 17 c60a 0a5f 64 <br> <br> [--cut--]   -  [--cut--] <br></code> <br><br>  In this output, we are interested in the <b>‚ÄúDstP‚Äù</b> column.  This is the port number in Hex. <br>  Port 25 will look like 0019, 80 - 0050, 53 - 0035. <br><br><h3>  Job </h3><br><br>  Analyzing the output of this statistic: <br><br>  We take statistics and allocate port 25: <br>  <b>flowctl netflow show |</b>  <b>grep 0019</b> <br>  We select only the source IP from the second column ‚ÄúSrcIPaddress‚Äù and sort the output. <br>  <b>awk '{print $ 2}' |</b>  <b>sort</b> <br>  We consider unique IP addresses, and display only those that are repeated more than 20 times. <br>  <b>uniq -c |</b>  <b>awk '{if ($ 1&gt; 20) print $ 2}'</b> <br><br>  We get for port 25: <br> <code>[root@border] /root/&gt;flowctl netflow show | grep 0019 | awk '{print $2}' | sort | uniq -c | awk '{ if( $1 &gt; 20 ) print $2 }' <br> 123.456.123.10 <br> 123.456.123.17 <br> 123.456.123.140 <br> 123.456.123.220 <br></code> <br><br>  For port 80: <br> <code>[root@border] /root/&gt;flowctl netflow show | grep 0050 | awk '{print $2}' | sort | uniq -c | awk '{ if( $1 &gt; 100 ) print $2 }' <br> 123.456.123.10 <br> 123.456.123.17 <br> 123.456.123.165 <br></code> <br><br>  For port 53: <br> <code>[root@border] /root/&gt;flowctl netflow show | grep 0035 | awk '{print $2}' | sort | uniq -c | awk '{ if( $1 &gt; 100 ) print $2 }' <br> 123.456.123.17 <br> 123.456.123.19 <br></code> <br><br>  To get this statistics from cisco to the server, rsh is used, and google will tell how to configure it.  In the final command, only the source of statistics will change from ‚Äúflowctl netflow show‚Äù to ‚Äúrsh -l login ip_cisco 'sh ip cache flow'‚Äù <br><br><h3>  Why all this? </h3><br><br>  What to do with these addresses decide for yourself. <br>  For example, I have a crown every 5 minutes, the addresses are added to the database with which the radius server works. <br>  The client is thrown out of the Internet, and with the next authorization, it is blocked completely.  Also, when accessing via port 80, a message about violation of the network regulations due to virus activity on his computer is issued. <br><br>  Thanks for attention.  Net you networks! </div><p>Source: <a href="https://habr.com/ru/post/90489/">https://habr.com/ru/post/90489/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../90481/index.html">Proper REST caching</a></li>
<li><a href="../90483/index.html">What is electronic money for?</a></li>
<li><a href="../90486/index.html">nanoCAD VK 1.0 - water supply and sewage design</a></li>
<li><a href="../90487/index.html">Parallel data import</a></li>
<li><a href="../90488/index.html">Creating a scrollbar of pictures a la iPhoto. Part 1</a></li>
<li><a href="../90491/index.html">You must be a fool to start a company</a></li>
<li><a href="../90493/index.html">Code Like a Pythonista: Idiomatic Python (part2)</a></li>
<li><a href="../90495/index.html">Jump in! Developer camp. Microsoft and the Open Source Community - a course for convergence</a></li>
<li><a href="../90499/index.html">Are you excited about the taskbar, but do you work in Windows XP?</a></li>
<li><a href="../90500/index.html">Timezone on rutracker.org. Opinion habrovchan</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>