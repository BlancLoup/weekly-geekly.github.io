<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Linux kernel module on Swift</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Since Swift compiles to native code, why not try writing a kernel module on it? All interested in please under the cut! 


 Swift is a cross-platform ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Linux kernel module on Swift</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/files/d31/2d9/9cc/d312d99cc3c94e75acba8f35eb48deff.png"><br><br><p>  Since Swift compiles to native code, why not try writing a kernel module on it?  All interested in please under the cut! </p><a name="habracut"></a><br><p>  Swift is a cross-platform programming language that began its history in July 2010 as a personal project of Chris Luttner, father of such famous projects as LLVM and Clang.  In 2013, Swift became an important task for the Apple Development Tools development team.  Version 1.0 was released on September 9, 2014.  On December 3, 2015, the compiler and other tools were published under the Apache 2.0 license.  <a href="https://github.com/apple/swift">Development is conducted on GitHub</a> .  The project is designed to create a fast, secure, concise and modern language. </p><br><p>  Becoming a free software compiler made me interested in them.  One of the first experiments was the creation of the <a href="https://github.com/rzhikharevich/swift-bare-bones">Hellowhold for bare iron on Swift</a> .  However, I was not the first.  Kevin Lange, an employee of Yelp and author of the <a href="https://github.com/klange/toaruos">amateur Unix-like OS Toaru</a> , published <a href="https://github.com/klange/taylor">something similar a</a> few days earlier. </p><br><p>  Not so long ago, I noticed <a href="">rust.ko</a> , an example of a Linux kernel module on Rust, and asked the question "Is it possible to do the same, but on Swift?"  As it turned out, you can! </p><br><h1>  C layer </h1><br><p>  Unfortunately, the Linux kernel code is heavily tied to macros and GCC-specific extensions, so you can't do without C in this case. </p><br><p>  <strong>shim.c</strong> </p><br><pre><code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt;linux/init.h&gt; #include &lt;linux/module.h&gt; MODULE_LICENSE("GPL"); MODULE_AUTHOR("Roman Zhikharevich"); MODULE_DESCRIPTION("a little bit swifty Linux kernel module"); MODULE_VERSION("0.1"); int swift_main(void); static int __init swift_init(void) { return swift_main(); } static void __exit swift_exit(void) {} module_init(swift_init); module_exit(swift_exit);</span></span></span></span></code> </pre> <br><p>  Consider this code in order. </p><br><pre> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt;linux/init.h&gt; #include &lt;linux/module.h&gt;</span></span></span></span></code> </pre> <br><p>  <strong>init.h</strong> contains the <strong>__init</strong> and <strong>__exit macros</strong> , which place the functions in the <em>.init.text</em> and <em>.exit.text sections,</em> respectively.  <strong>module.h is</strong> needed for <strong>module_init</strong> and <strong>module_exit</strong> , indicating initialization and exit functions, as well as for specifying information about the module. </p><br><pre> <code class="cpp hljs">MODULE_LICENSE(<span class="hljs-string"><span class="hljs-string">"GPL"</span></span>); MODULE_AUTHOR(<span class="hljs-string"><span class="hljs-string">"Roman Zhikharevich"</span></span>); MODULE_DESCRIPTION(<span class="hljs-string"><span class="hljs-string">"a little bit swifty Linux kernel module"</span></span>); MODULE_VERSION(<span class="hljs-string"><span class="hljs-string">"0.1"</span></span>);</code> </pre> <br><p>  The information about the module is indicated here.  Here everything speaks for itself. </p><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">swift_main</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">void</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span></span>; <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> __<span class="hljs-function"><span class="hljs-function">init </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">swift_init</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">void</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> swift_main(); } <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">void</span></span> __<span class="hljs-function"><span class="hljs-built_in"><span class="hljs-function"><span class="hljs-built_in">exit</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">swift_exit</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">void</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> </span></span>{}</code> </pre> <br><p>  Specify the signature of the function swift_main, written in Swift, and then call it.  The <strong>swift_exit</strong> function <strong>is</strong> empty, since there is nothing to free. </p><br><pre> <code class="cpp hljs">module_init(swift_init); module_exit(swift_exit);</code> </pre> <br><p>  Specify initialization and exit functions. </p><br><h1><del>  Gag </del>  Swift code </h1><br><pre> <code class="hljs swift">@_silgen_name(<span class="hljs-string"><span class="hljs-string">"swift_main"</span></span>) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">swift_main</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> -&gt; <span class="hljs-type"><span class="hljs-type">Int32</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> msg: <span class="hljs-type"><span class="hljs-type">StaticString</span></span> = <span class="hljs-string"><span class="hljs-string">"\u{1}6Linux + Swift = &lt; &gt;\n"</span></span> <span class="hljs-comment"><span class="hljs-comment">// Emoji        printk(unsafeBitCast(msg.utf8Start, to: UnsafePointer&lt;Int8&gt;!.self)) return 0 }</span></span></code> </pre> <br><p>  Disassemble again in order. </p><br><pre> <code class="hljs kotlin"><span class="hljs-meta"><span class="hljs-meta">@_silgen_name(</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"swift_main"</span></span></span><span class="hljs-meta">)</span></span></code> </pre> <br><p>  The <strong>@_silgen_name</strong> attribute allows <strong>you</strong> to manually set the symbol name.  If this is not done, the name will be "mangled" - <strong>__TF1n10swift_mainFT_Vs5Int32</strong> , that is, it will store information about types - to call this from C is inconvenient. </p><br><pre> <code class="hljs swift"><span class="hljs-keyword"><span class="hljs-keyword">let</span></span> msg: <span class="hljs-type"><span class="hljs-type">StaticString</span></span> = <span class="hljs-string"><span class="hljs-string">"\u{1}6Linux + Swift = &lt; &gt;\n"</span></span> <span class="hljs-comment"><span class="hljs-comment">// Emoji       </span></span></code> </pre> <br><p>  A message is declared here that is of type StaticString and does not require runtime support.  It is worth explaining the fragment <em>"\ u {1} 6"</em> .  The fact is that to transmit the log level of the message to the printk function, you need to use the KERN_INFO macro, but it is not available in Swift.  Fortunately, it has fairly simple content ( <strong>include / linux / kern_levels.h</strong> ): </p><br><pre> <code class="hljs cpp">... <span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> KERN_SOH </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"\001"</span></span></span><span class="hljs-meta"> </span><span class="hljs-comment"><span class="hljs-meta"><span class="hljs-comment">/* ASCII Start Of Header */</span></span></span><span class="hljs-meta"> ... #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> KERN_INFO KERN_SOH </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"6"</span></span></span><span class="hljs-meta"> </span><span class="hljs-comment"><span class="hljs-meta"><span class="hljs-comment">/* informational */</span></span></span><span class="hljs-meta"> ...</span></span></code> </pre> <br><pre> <code class="hljs lisp">printk(<span class="hljs-name"><span class="hljs-name">unsafeBitCast</span></span>(<span class="hljs-name"><span class="hljs-name">msg</span></span>.utf8Start, to: UnsafePointer&lt;Int8&gt;!.self))</code> </pre> <br><p>  Display a message! </p><br><pre> <code class="hljs kotlin"><span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span></code> </pre> <br><p>  "Initialization" of the module was successful! </p><br><h1>  Shake, but do not mix - collect the code </h1><br><p>  I compiled the Swift code under macOS Sierra using scary crutches, and the soda code on Raspberry Pi running <a href="https://voidlinux.eu/">Void Linux</a> .  However, the following is not difficult to adapt for other setups. </p><br><p>  First you need to create conditions for the assembly of the module. </p><br><pre> <code class="hljs ruby">pi $ mkdir -p ~<span class="hljs-regexp"><span class="hljs-regexp">/projects/swift</span></span>.ko pi $ cd ~<span class="hljs-regexp"><span class="hljs-regexp">/projects/swift</span></span>.ko pi $ nano shim.c pi $ nano Makefile</code> </pre> <br><p>  <strong>Makefile</strong> </p><br><pre> <code class="bash hljs">obj-m += swift.o swift-objs := shim.o main.o all: make -C /lib/modules/$(shell uname -r)/build M=$(PWD) modules clean: make -C /lib/modules/$(shell uname -r)/build M=$(PWD) clean</code> </pre> <br><p>  Now the most interesting is Swift. </p><br><pre> <code class="bash hljs">mac $ nano import.h</code> </pre> <br><p>  <strong>import.h</strong> </p><br><pre> <code class="hljs cs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">printk</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">char</span></span></span></span><span class="hljs-function"><span class="hljs-params"> *msg</span></span></span><span class="hljs-function">)</span></span>;</code> </pre> <br><p>  It is important to note that the signature is not entirely correct, but we cannot work with va_list under these conditions, so we have to cheat. </p><br><pre> <code class="bash hljs">mac $ xcrun -sdk iphoneos swiftc -import-objc-header import.h -emit-library -emit-bc -target armv7-apple-ios7 main.swift mac $ xcrun -sdk iphoneos clang -target armv7-none-elf -mfloat-abi=soft -O2 -c main.bc mac $ arm-none-eabi-objcopy --rename-section .text=.init.text main.o</code> </pre> <br><p>  Let me explain what is happening here.  The problem is that the Swift compiler does not know how to generate code for non-standard purposes.  But it can Clang!  The solution is to switch the Swift compiler to the LLVM bitcode generation mode, and then feed it to the Clang.  The last command moves <strong>swift_main</strong> to the <em>.init.text</em> section.  It remains only to send the object file to the Raspberry Pi: </p><br><pre> <code class="bash hljs">mac $ scp main.o pi@pi:~/projects/swift.ko/main.o_shipped</code> </pre> <br><p>  We assemble the module! </p><br><pre> <code class="bash hljs">pi $ make</code> </pre> <br><h1>  Finish line </h1><br><img src="https://habrastorage.org/files/d31/2d9/9cc/d312d99cc3c94e75acba8f35eb48deff.png"><br><br><h1>  Conclusion </h1><br><p>  Of course, from the language here, alas, only the syntax.  To use all the possibilities, you need to make considerable efforts to port Swift runtime to the Linux kernel.  It is also not very clear whether it makes any sense to write such a low-level code in Swift.  <a href="http://harmful.cat-v.org/software/c%2B%2B/linus">Linus Torvalds probably would not approve</a> . </p><br><p>  In any case, happy hacking! </p></div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <p>Source: <a href="https://habr.com/ru/post/305530/">https://habr.com/ru/post/305530/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../305516/index.html">The thorny path of ITSM in Russia</a></li>
<li><a href="../305520/index.html">How artificial restrictions help in work</a></li>
<li><a href="../305524/index.html">Organization of an international gambling company in Curacao</a></li>
<li><a href="../305526/index.html">City AD: schoolchildren and students</a></li>
<li><a href="../305528/index.html">Android development using qt and android studio part two</a></li>
<li><a href="../305532/index.html">Sort warnings of static analyzers by priority when searching for and fixing program errors</a></li>
<li><a href="../305534/index.html">Clojure course materials</a></li>
<li><a href="../305536/index.html">Rust code is included in Firefox 48</a></li>
<li><a href="../305544/index.html">Expansion of functionality Scene View in Unity3D. Interception of events</a></li>
<li><a href="../305546/index.html">Who is aggregated by Meduza?</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>