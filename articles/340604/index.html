<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Your own std :: code_error</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="A couple of words from the translator 
 Continuing to cover the topic of std::system_error in runet, I decided to translate several articles from the ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Your own std :: code_error</h1><div class="post__text post__text-html js-mediator-article"><h2>  A couple of words from the translator </h2><br>  Continuing to cover the topic of <code>std::system_error</code> in runet, I decided to translate several articles from the blog Andrzej Krzemie≈Ñski, which I was advised in the comments to the previous post. <br><br>  Since these articles have sufficient volume, I decided not to merge them into a heap, as last time, but to publish in the original format. <br><br>  I also want to warn you that Andrzej Krzemie≈Ñski has a rather confused style of presentation, which I did not rule.  Nevertheless, I act as a translator, not an editor.  So, perhaps, to understand some of the theses will have to re-read twice. <br><a name="habracut"></a><br><h2>  Introduction </h2><br>  Recently, in my application, I implemented the ‚Äúerror condition classification‚Äù offered by the functional <code>std::error_code</code> .  In this post I want to share my experience. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      C ++ 11 has a rather complicated error condition classification mechanism.  You may have come across such concepts as ‚Äúerror code‚Äù, ‚Äúerror condition‚Äù, ‚Äúerror category‚Äù, but it is difficult to find out how good they are and how to use them is not easy.  The only valuable source of information on this issue on the Internet is a series of articles from Christopher Kohlhoff, the author of the <a href="http://www.boost.org/doc/libs/1_64_0/doc/html/boost_asio.html">Boost.Asio</a> library: <br><br><ul><li>  " <a href="http://blog.think-async.com/2010/04/system-error-support-in-c0x-part-1.html">System error support in C ++ 0x - part 1</a> " </li><li>  " <a href="http://blog.think-async.com/2010/04/system-error-support-in-c0x-part-2.html">System error support in C ++ 0x - part 2</a> " </li><li>  " <a href="http://blog.think-async.com/2010/04/system-error-support-in-c0x-part-3.html">System error support in C ++ 0x - part 3</a> " </li><li>  " <a href="http://blog.think-async.com/2010/04/system-error-support-in-c0x-part-4.html">System error support in C ++ 0x - part 4</a> " </li><li>  " <a href="http://blog.think-async.com/2010/04/system-error-support-in-c0x-part-5.html">System error support in C ++ 0x - part 5</a> " </li></ul><br>  <i>[Translator's note: I previously <a href="https://habrahabr.ru/post/336012/">translated</a> this cycle for Habr]</i> <br><br>  And it was a really good start for me.  But I still think that it would be useful to have several sources of information and several explanations of this topic.  So, let's begin‚Ä¶ <br><br><h2>  Problem </h2><br>  First, why do I need it.  I have a service to search for flights.  You tell me from where and where you want to fly, and I offer you specific flights and prices.  To do this, my service refers to other services: <br><br><ul><li>  to search for a (short) sequence of flights that take you to your destination </li><li>  to check the availability on these flights of places in the requested class of service (economy class, business class) </li></ul><br>  Each of these services may return an error for a number of reasons.  The reasons for refusal ‚Äî different for each service ‚Äî can be listed.  For example, the authors of these two services selected the following listings: <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">enum</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">FlightsErrc</span></span></span><span class="hljs-class"> {</span></span> <span class="hljs-comment"><span class="hljs-comment">//  0 NonexistentLocations = 10, //     DatesInThePast, //      InvertedDates, //    NoFlightsFound = 20, //      ProtocolViolation = 30, // ,  XML ConnectionError, //      ResourceError, //     Timeout, //     }; enum class SeatsErrc { //  0 InvalidRequest = 1, // ,  XML CouldNotConnect, //      InternalError, //     NoResponse, //     NonexistentClass, //     NoSeatAvailable, //    };</span></span></code> </pre> <br>  Here you can notice something.  First, the causes of failure are very similar in any service, but they are assigned different names and different numerical values.  This is due to the fact that the two services were developed independently by two different teams.  It also means that the same numerical value can be related to two completely different conditions, depending on which service reported it. <br><br>  Secondly, as is evident from the names, the reasons for refusals have different sources: <br><br><ul><li>  Environment: internal problem of the service (for example, with resources). </li><li>  Misunderstanding: between two services. </li><li>  User: Providing invalid data in the request. </li><li>  Just bad luck: not really an error, but the answer can not be returned to the user, because, for example, all the places were sold out. </li></ul><br>  Why do I really need these different error codes?  If any of these errors occur, we want to stop processing the current request from the user.  When I cannot offer him a flight, I want to highlight only the following situations: <br><br><ol><li>  You made an illogical query. </li><li>  There are no known flights for your trip. </li><li>  There is some problem with the system that you do not understand, but which prevents us from giving an answer. </li></ol><br>  On the other hand, for the purposes of internal audit or search for bugs, we need more detailed information that will be placed in the logs, for example, which system reported a failure and what actually happened.  It can be encoded in integer.  Any other details, such as the ports to which we tried to connect, or the database we tried to use, will most likely be recorded separately, so the data encoded in the <code>int</code> should be enough. <br><br><h2>  std :: error_code </h2><br>  The standard library <code>std::error_code</code> designed to store exactly this type of information: a number representing the status, and a ‚Äúdomain‚Äù, within which this number is assigned a value.  In other words, <code>std::error_code</code> is a pair: <code>{int, domain}</code> .  This is reflected in its interface: <br><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">inspect</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-built_in"><span class="hljs-function"><span class="hljs-params"><span class="hljs-built_in">std</span></span></span></span><span class="hljs-function"><span class="hljs-params">::error_code ec)</span></span></span><span class="hljs-function"> </span></span>{ ec.value(); <span class="hljs-comment"><span class="hljs-comment">//  ec.category(); //  }</span></span></code> </pre> <br>  But you almost never need to check <code>std::error_code</code> in this way.  As we already said, two things we want to do is to log the state of <code>std::error_code</code> how it was created (without subsequent conversion by higher levels of the application) and use it to answer a specific question, for example: ‚ÄúThis error was caused by the user, provided incorrect data? ". <br><br>  If you are asking yourself why use <code>std::error_code</code> instead of exceptions, let me clarify: these two things are not mutually exclusive.  I want to report bugs in my program through exceptions.  Inside the exception, instead of strings, I want to store <code>std::error_code</code> , which I can easily check. <br>  <code>std::error_code</code> has nothing to do with getting rid of exceptions.  In addition, in my use case, I do not see a good reason to have many different types of exceptions.  I will catch them all in one (or two) places, and I‚Äôll learn about different situations by checking the object <code>std::error_code</code> . <br><br><h2>  Connect your listing </h2><br>  Now we want to adapt <code>std::error_code</code> so that it can store errors from the flight service described above: <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">enum</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">FlightsErrc</span></span></span><span class="hljs-class"> {</span></span> <span class="hljs-comment"><span class="hljs-comment">//  0 NonexistentLocations = 10, //     DatesInThePast, //      InvertedDates, //    NoFlightsFound = 20, //      ProtocolViolation = 30, // ,  XML ConnectionError, //      ResourceError, //     Timeout, //     };</span></span></code> </pre> <br>  We should be able to convert [values] from our <code>enum</code> to <code>std::error_code</code> : <br><br><pre> <code class="cpp hljs"><span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::error_code ec = FlightsErrc::NonexistentLocations;</code> </pre> <br>  But our enumeration must meet one condition: the numeric value 0 should not be an erroneous situation.  0 represents success in any domain (category) of errors.  This fact will be used later when checking the object <code>std::error_code</code> : <br><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">inspect</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-built_in"><span class="hljs-function"><span class="hljs-params"><span class="hljs-built_in">std</span></span></span></span><span class="hljs-function"><span class="hljs-params">::error_code ec)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(ec) <span class="hljs-comment"><span class="hljs-comment">// : 0 != ec.value() handle_failure(ec); else handle_success(); }</span></span></code> </pre> <br>  In this sense, the <a href="http://blog.think-async.com/2010/04/system-error-support-in-c0x-part-4.html">mentioned article</a> incorrectly uses the numerical value 200, indicating success. <br><br>  So this is what we did: we did not start the <code>FlightErrc</code> from 0. This, in turn, means that we can create an enumeration that does not correspond to any of the listed values: <br><br><pre> <code class="cpp hljs">FlightsErrc fe {};</code> </pre> <br>  This is an important characteristic of enums in C ++ (even enumeration classes from C ++ 11): you can create values ‚Äã‚Äãoutside the enumeration range.  It is for this reason that the compilers issue a warning in the <code>switch-statement</code> that ‚Äúnot all control paths return a value,‚Äù even if you have a <code>case</code> label for each enumerated value. <br><br>  Now back to the conversion, <code>std::error_code</code> has a conversion constructor pattern that looks more or less like this: <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">template</span></span>&lt;<span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Errc</span></span></span><span class="hljs-class">&gt; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">requires</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">is_error_code</span></span></span><span class="hljs-class">&lt;Errc&gt;:</span></span>:<span class="hljs-function"><span class="hljs-function">value </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">error_code</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Errc e)</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">noexcept</span></span></span><span class="hljs-function">: error_code</span></span>{make_error_code(e)} {}</code> </pre> <br>  (Of course, I used a still non-existent conceptual syntax, but the idea should be clear: this constructor is available only when <code>std::is_error_code&lt;Errc&gt;::value</code> is evaluated as <code>true</code> .) <br><br>  This constructor is intended for setting up user-connected enumerations to the system.  To connect <code>FlightErrc</code> , we need to make sure that: <br><br><ol><li>  <code>std::is_error_code&lt;Errc&gt;::value</code> returns <code>true</code> . </li><li>  The function <code>make_error_code</code> accepting the <code>FlightsErrc</code> type <code>FlightsErrc</code> defined and accessible via the <a href="https://en.wikipedia.org/wiki/Argument-dependent_name_lookup">ADL</a> . </li></ol><br>  As for the first item, we should specialize the standard template: <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">namespace</span></span> <span class="hljs-built_in"><span class="hljs-built_in">std</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">template</span></span>&lt;&gt; <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">is_error_code_enum</span></span></span><span class="hljs-class">&lt;FlightsErrc&gt;:</span></span> true_type {}; }</code> </pre> <br>  This is one of those situations where declaring something in the <code>std</code> is "legal." <br><br>  As for the second item, we just need to declare the overload of the function <code>make_error_code</code> in the same namespace as <code>FlightsErrc</code> : <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">enum</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">FlightsErrc</span></span></span><span class="hljs-class">;</span></span> <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::<span class="hljs-function"><span class="hljs-function">error_code </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">make_error_code</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(FlightsErrc)</span></span></span></span>;</code> </pre> <br>  And this is all that is needed to be seen by other parts of the program / library and that we must provide in the header file.  The rest is the implementation of the function <code>make_error_code</code> , and we can put it in a separate translation unit (.cpp file). <br><br>  From this point we can assume that <code>FlightsErrc</code> is an <code>error_code</code> : <br><br><pre> <code class="cpp hljs"><span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::error_code ec = FlightsErrc::NoFlightsFound; assert(ec == FlightsErrc::NoFlightsFound); assert(ec != FlightsErrc::InvertedDates);</code> </pre> <br><h2>  Error category declaration </h2><br>  Up to this point, I have said that <code>error_code</code> is a pair: <code>{number, domain}</code> , where the first element uniquely identifies the specific error situation in the domain, and the second uniquely identifies the error domain among all possible error domains that will ever be conceived.  But, given that this domain identifier should be stored in one machine word, how can we guarantee that it will be unique to all libraries currently on the market and those that are still ahead?  We hide the domain ID as an implementation detail.  If we want to use another third-party library with our own enumeration of errors, how can we guarantee that their domain ID will not be equal to ours? <br><br>  The solution chosen for <code>std::error_code</code> is based on the observation that for each global object (or more formally: a namespace object) a unique address is assigned.  Regardless of how many libraries and how many global objects are combined together, each global object has a unique address - this is quite obvious. <br><br>  To take advantage of this, we need to associate with each type that we want to connect to the system <code>error_code</code> , a unique global object, and then use its address as an identifier.  Now the addresses will be used to represent the domain, this is exactly what <code>std::error_code</code> does.  But now, when we store some <code>*</code> , the question arises: what should be <code></code> ?  A rather rational choice: let's use the type that can offer us additional benefits.  So, the type <code>T</code> is <code>std::error_category</code> , and an additional advantage is in its interface: <br><br><pre> <code class="cpp hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">error_category</span></span></span><span class="hljs-class"> {</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span>: <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">virtual</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">const</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">char</span></span></span><span class="hljs-function"> * </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">name</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">const</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">noexcept</span></span></span><span class="hljs-function"> </span></span>= <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">virtual</span></span></span><span class="hljs-function"> </span><span class="hljs-built_in"><span class="hljs-function"><span class="hljs-built_in">string</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">message</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> ev)</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">const</span></span></span><span class="hljs-function"> </span></span>= <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-comment"><span class="hljs-comment">//    ... };</span></span></code> </pre> <br>  I used the name "domain", the standard library uses the name "error category" for the same purpose. <br><br>  It has pure virtual methods that already offer something: we will store pointers to classes inherited <code> std::error_category</code> : for each new enumeration of errors, we need to get a new class inherited from <code> std::error_category</code> .  Typically, having pure virtual methods means selecting objects on the heap, but we will not do such things.  We will create global objects and point to them. <br><br>  There are other virtual methods in <code> std::error_category</code> , which in other cases need to be configured, but we will not have to do this to connect <code>FlightErrc</code> . <br><br>  Now, for each custom error ‚Äúdomain‚Äù represented by a class derived <code> std::error_category</code> , we need to override two methods.  The <code>name</code> method returns the short mnemonic name of the category (domain) of errors.  The <code>message</code> method assigns a text description for each numeric error value in this domain.  To better illustrate this, let's define the error category for our <code>FlightsErrc</code> listing.  Remember that this class should only be visible in one translation unit.  In other files we will simply use the address of its instance. <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">namespace</span></span> { <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">FlightsErrCategory</span></span></span><span class="hljs-class">:</span></span> <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::error_category { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">const</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">char</span></span></span><span class="hljs-function"> * </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">name</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">const</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">noexcept</span></span></span><span class="hljs-function"> override</span></span>; <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::<span class="hljs-function"><span class="hljs-built_in"><span class="hljs-function"><span class="hljs-built_in">string</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">message</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> ev)</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">const</span></span></span><span class="hljs-function"> override</span></span>; }; <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> * FlightsErrCategory::name() <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">noexcept</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">"flights"</span></span>; } <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::<span class="hljs-built_in"><span class="hljs-built_in">string</span></span> FlightsErrCategory::message(<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> ev) <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">switch</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">static_cast</span></span>&lt;FlightsErrc&gt;(ev)) { <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> FlightsErrc::NonexistentLocations: <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">"nonexistent airport name in request"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> FlightsErrc::DatesInThePast: <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">"request for a date from the past"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> FlightsErrc::InvertedDates: <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">"requested flight return date before departure date"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> FlightsErrc::NoFlightsFound: <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">"no filight combination found"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> FlightsErrc::ProtocolViolation: <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">"received malformed request"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> FlightsErrc::ConnectionError: <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">"could not connect to server"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> FlightsErrc::ResourceError: <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">"insufficient resources"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> FlightsErrc::Timeout: <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">"processing timed out"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">default</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">"(unrecognized error)"</span></span>; } } <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> FlightsErrCategory theFlightsErrCategory {}; }</code> </pre> <br>  The <code>name</code> method provides a short text that is used when streaming <code>std::error_code</code> to things like, for example, logs: this can help you determine the cause of the error.  The text does not have to be unique in all enumeration errors: in the worst case, journal entries will be ambiguous. <br><br>  The <code>message</code> method provides a description text for any numeric value that represents an error in our category.  This can be useful when debugging or viewing logs;  but you probably don‚Äôt want to show this text to users without further processing. <br><br>  Usually this method is called indirectly.  Callers may not know that the numeric value is <code>FlightErrc</code> , so we must explicitly bring it back to <code>FlightErrc</code> .  I believe that the example in the <a href="http://blog.think-async.com/2010/04/system-error-support-in-c0x-part-4.html">above article</a> does not compile because of the <code>static_cast</code> skipped.  After casting, there is a risk that we will check a value that does not apply to the enumeration: therefore, we need a <code>default</code> label. <br><br>  Finally, notice that we initialized the global object of our type <code>FlightErrCategory</code> .  This will be the only object of this type in the program.  We will need his address, but we will also use his polymorphic properties. <br><br>  Although the class <code>std::error_category</code> not a literal type, it has a <code>constexpr</code> default constructor.  The implicitly declared default constructor of our <code>FlightErrCategory</code> class inherits this property.  Thus, we ensure that the initialization of our global object is performed during the initialization of constants, as described in <a href="https://akrzemi1.wordpress.com/2012/05/27/constant-initialization/">this</a> article, and therefore does not contain any <a href="https://isocpp.org/wiki/faq/ctors">problems with the order of static initialization</a> . <br><br>  Now the last missing part is the implementation of <code>make_error_code</code> : <br><br><pre> <code class="cpp hljs"><span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::<span class="hljs-function"><span class="hljs-function">error_code </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">make_error_code</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(FlightsErrc e)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> {<span class="hljs-keyword"><span class="hljs-keyword">static_cast</span></span>&lt;<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>&gt;(e), theFlightsErrCategory}; }</code> </pre> <br>  And we are done.  Our <code>FlightsErrc</code> can be used as if it were <code>std::error_code</code> : <br><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">main</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::error_code ec = FlightsErrc::NoFlightsFound; <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::<span class="hljs-built_in"><span class="hljs-built_in">cout</span></span> &lt;&lt; ec &lt;&lt; <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::<span class="hljs-built_in"><span class="hljs-built_in">endl</span></span>; }</code> </pre> <br>  The output of this program will be as follows: <br><br><blockquote>  flights: 20 </blockquote><br>  A full working example illustrating the above can be found <a href="https://akrzemi1.wordpress.com/examples/error_code-example/">here</a> . <br><br>  And that's all for today.  We have not yet considered how to make useful queries on <code>std::error_code</code> objects, but this will be a topic for another article. <br><br><h2>  Thanks </h2><br>  I am grateful to Tomasz Kami≈Ñski for explaining to me the idea behind <code>std::error_code</code> .  In addition to the series of articles from Christopher Kohlhoff, I was also able to learn about the <code>std::error_code</code> from the documentation for the <a href="https://github.com/ned14/outcome">Outcome library</a> from Niall Douglas, <a href="https://ned14.github.io/outcome/tutorial/error_code/">here</a> . </div><p>Source: <a href="https://habr.com/ru/post/340604/">https://habr.com/ru/post/340604/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../340588/index.html">SC and Unity: two boots - a pair</a></li>
<li><a href="../340590/index.html">let's live in peace</a></li>
<li><a href="../340592/index.html">How does mobx work from the inside and compare it with redux</a></li>
<li><a href="../340600/index.html">In search of perfect architecture</a></li>
<li><a href="../340602/index.html">How I stopped selling food on the street and started working in top technology companies</a></li>
<li><a href="../340610/index.html">UI design in games on the example of NieR: Automata</a></li>
<li><a href="../340612/index.html">Classes of matrices and vectors in Delphi</a></li>
<li><a href="../340616/index.html">OSX / Proton backdoor distributed with Trojanized Elmedia Player</a></li>
<li><a href="../340618/index.html">Security Week 42: KRACK WiFi, a hole in Intel processors, 250 Oracle patches</a></li>
<li><a href="../340620/index.html">A bug in finding emails on Mail.Ru</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>