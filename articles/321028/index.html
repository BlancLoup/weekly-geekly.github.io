<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>A script that writes another script and configures routers</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Network equipment manufacturers are slowly moving towards a universal API for setting and collecting indicators: there is NETCONF , OpenConfig , there...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>A script that writes another script and configures routers</h1><div class="post__text post__text-html js-mediator-article"><p><img src="https://habrastorage.org/files/043/80f/c8a/04380fc8a7fd40d6b3f66428ea7b8b7b.jpg" alt="image alt text"></p><br><p>  Network equipment manufacturers are slowly moving towards a universal API for setting and collecting indicators: there is <a href="https://en.wikipedia.org/wiki/NETCONF">NETCONF</a> , <a href="http://www.openconfig.net/">OpenConfig</a> , there is software for importing MIBs, the same setting using SNMP has existed for a long time.  But I will not touch on these high matters, but will simply share a way to automate the configuration of network equipment - in case of mass opening of branches, for example, </p><br><p>  For illustration, I use D-Link DFL-800 in an imaginary central office and MikroTik RB951UI-2HnD on the periphery.  In particular, let's set up an IPsec tunnel between them, since we are talking about a scenario with a new branch office. <a name="habracut"></a></p><br><h1 id="nastroyka-mikrotik">  MikroTik setting </h1><br><p>  The easiest way to configure MikroTik is using a configuration file, which is a script with a set of console commands.  The described configuration principle is also suitable for other routers with a similar parameter setting mechanism. </p><br><p>  First of all, we will get the configuration file of the already configured and working MikroTik, using the <strong>/ export</strong> command.  The file will be almost identical to backup, but it will not contain user names and MAC addresses. </p><br><p>  To apply the configuration file on another router, some parameters need to be changed to unique ones.  For this, the possibilities of a scripting <a href="http://wiki.mikrotik.com/wiki/Manual:Scripting">language</a> built into the firmware will be suitable - in particular, the removal of individual settings into variables.  Here is an example script with a default gateway assignment: </p><br><pre><code class="dos hljs">local Gate "<span class="hljs-number"><span class="hljs-number">10</span></span>.<span class="hljs-number"><span class="hljs-number">1</span></span>.<span class="hljs-number"><span class="hljs-number">3</span></span>.<span class="hljs-number"><span class="hljs-number">1</span></span>" /ip route :<span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ([:len [/ip route <span class="hljs-built_in"><span class="hljs-built_in">find</span></span> distance=<span class="hljs-number"><span class="hljs-number">1</span></span>]] = <span class="hljs-number"><span class="hljs-number">0</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">do</span></span>={add distance=<span class="hljs-number"><span class="hljs-number">1</span></span> gateway=$Gate; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span>={<span class="hljs-built_in"><span class="hljs-built_in">set</span></span> [<span class="hljs-built_in"><span class="hljs-built_in">find</span></span> distance=<span class="hljs-number"><span class="hljs-number">1</span></span>] gateway=$Gate}</code> </pre> <br><p>  Initially, the idea was to create a universal script that can be used without resetting the configuration.  Therefore, the code checks for the presence of a default route, after which it is created from scratch or changes.  But this idea had to be abandoned, because in the latest firmware changes are constantly added to the default configuration.  It is impossible to foresee everything, but with constant updating of the script, the sense of automation is lost. </p><br><p>  It is more convenient to set the individual parameters of the router not in a text file, but in the GUI - then even people unfamiliar with the specifics of the device will manage to configure the router.  What you need for a remote office, which can serve employees of different qualifications. </p><br><p>  I draw the GUI in an AutoIT script.  In this script, I also added the function of recalculating network masks (255.255.255.0 = / 24) and line by line filling in the configuration file.  The development tool itself for solving the problem is not critical - you can use something more familiar to you personally. </p><br><p><img src="https://habrastorage.org/files/9f4/f4b/9d0/9f4f4b9d0f754870bd031afdbe1563e5.jpg" alt="image alt text"></p><br><p>  <em>The resulting configuration interface</em> </p><br><p>  Let us examine in more detail the function that forms the window. </p><br><p>  All the features of the future configurator will require the following libraries, mainly from the AutoIT bundle: </p><br><ul><li><p>  RandomString to generate an IPsec key (not included, by <a href="http://autoit-script.ru/index.php%3Ftopic%3D13795.0">Altlans</a> ); </p><br></li><li><p>  GuiIPAddress for the IP input form; </p><br></li><li><p>  GUIConstantsEx for running GUI; </p><br></li><li>  File to work with the file. </li></ul><br><p>  The principles of working with the graphical interface in AutoIT can be found in the official <a href="https://www.autoitscript.com/autoit3/docs/guiref/GUIRef.htm">documentation</a> , but I will immediately turn to the result: </p><br><pre> <code class="hljs php">$hgui = GUICreate(<span class="hljs-string"><span class="hljs-string">""</span></span> , <span class="hljs-number"><span class="hljs-number">300</span></span>, <span class="hljs-number"><span class="hljs-number">600</span></span>) GUICtrlCreateLabel(<span class="hljs-string"><span class="hljs-string">"   "</span></span>,<span class="hljs-number"><span class="hljs-number">2</span></span>,<span class="hljs-number"><span class="hljs-number">2</span></span>) $iploc1 = _GUICtrlIpAddress_Create($hgui, <span class="hljs-number"><span class="hljs-number">10</span></span>, <span class="hljs-number"><span class="hljs-number">20</span></span>) GUICtrlCreateLabel(<span class="hljs-string"><span class="hljs-string">"  "</span></span>,<span class="hljs-number"><span class="hljs-number">2</span></span>,<span class="hljs-number"><span class="hljs-number">55</span></span>) $iplocnet1 = _GUICtrlIpAddress_Create($hgui, <span class="hljs-number"><span class="hljs-number">10</span></span>, <span class="hljs-number"><span class="hljs-number">75</span></span>) GUICtrlCreateLabel(<span class="hljs-string"><span class="hljs-string">"  "</span></span>,<span class="hljs-number"><span class="hljs-number">2</span></span>,<span class="hljs-number"><span class="hljs-number">115</span></span>) $ipext1 = _GUICtrlIpAddress_Create($hgui, <span class="hljs-number"><span class="hljs-number">10</span></span>, <span class="hljs-number"><span class="hljs-number">135</span></span>) GUICtrlCreateLabel(<span class="hljs-string"><span class="hljs-string">"  "</span></span>,<span class="hljs-number"><span class="hljs-number">2</span></span>,<span class="hljs-number"><span class="hljs-number">170</span></span>) $ipextnet1 = _GUICtrlIpAddress_Create($hgui, <span class="hljs-number"><span class="hljs-number">10</span></span>, <span class="hljs-number"><span class="hljs-number">190</span></span>) GUICtrlCreateLabel(<span class="hljs-string"><span class="hljs-string">" "</span></span>,<span class="hljs-number"><span class="hljs-number">2</span></span>,<span class="hljs-number"><span class="hljs-number">225</span></span>) $ipgate1 = _GUICtrlIpAddress_Create($hgui, <span class="hljs-number"><span class="hljs-number">10</span></span>, <span class="hljs-number"><span class="hljs-number">245</span></span>) GUICtrlCreateLabel(<span class="hljs-string"><span class="hljs-string">" 1"</span></span>,<span class="hljs-number"><span class="hljs-number">2</span></span>,<span class="hljs-number"><span class="hljs-number">280</span></span>) $DNS11 = _GUICtrlIpAddress_Create($hgui, <span class="hljs-number"><span class="hljs-number">10</span></span>, <span class="hljs-number"><span class="hljs-number">300</span></span>) GUICtrlCreateLabel(<span class="hljs-string"><span class="hljs-string">" 2"</span></span>,<span class="hljs-number"><span class="hljs-number">2</span></span>,<span class="hljs-number"><span class="hljs-number">335</span></span>) $DNS21 = _GUICtrlIpAddress_Create($hgui, <span class="hljs-number"><span class="hljs-number">10</span></span>, <span class="hljs-number"><span class="hljs-number">355</span></span>) GUICtrlCreateLabel(<span class="hljs-string"><span class="hljs-string">"   "</span></span>,<span class="hljs-number"><span class="hljs-number">2</span></span>,<span class="hljs-number"><span class="hljs-number">390</span></span>) $secret1 = GUICtrlCreateInput(<span class="hljs-string"><span class="hljs-string">""</span></span>,<span class="hljs-number"><span class="hljs-number">10</span></span>, <span class="hljs-number"><span class="hljs-number">410</span></span>) GUICtrlCreateLabel(<span class="hljs-string"><span class="hljs-string">"     "</span></span>,<span class="hljs-number"><span class="hljs-number">2</span></span>,<span class="hljs-number"><span class="hljs-number">445</span></span>) $ports1 = GUICtrlCreateInput(<span class="hljs-string"><span class="hljs-string">"5000,8000"</span></span>,<span class="hljs-number"><span class="hljs-number">10</span></span>, <span class="hljs-number"><span class="hljs-number">480</span></span>) GUICtrlCreateLabel(<span class="hljs-string"><span class="hljs-string">"   :"</span></span>,<span class="hljs-number"><span class="hljs-number">2</span></span>,<span class="hljs-number"><span class="hljs-number">515</span></span>) $mac1 = GUICtrlCreateInput(<span class="hljs-string"><span class="hljs-string">"00:00:00:00:00:00"</span></span>,<span class="hljs-number"><span class="hljs-number">10</span></span>, <span class="hljs-number"><span class="hljs-number">535</span></span>) $OK_Btn = GUICtrlCreateButton(<span class="hljs-string"><span class="hljs-string">""</span></span>, <span class="hljs-number"><span class="hljs-number">75</span></span>, <span class="hljs-number"><span class="hljs-number">570</span></span>, <span class="hljs-number"><span class="hljs-number">70</span></span>, <span class="hljs-number"><span class="hljs-number">25</span></span>) _GUICtrlIpAddress_Set($iploc1, $iploc8) _GUICtrlIpAddress_Set($ipext1, $ipext8) _GUICtrlIpAddress_Set($iplocnet1, <span class="hljs-string"><span class="hljs-string">"255.255.255.0"</span></span>) _GUICtrlIpAddress_Set($ipextnet1, <span class="hljs-string"><span class="hljs-string">"255.255.255.252"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> $secret8 = <span class="hljs-string"><span class="hljs-string">""</span></span> Then GUICtrlSetData($secret1,_Crypto_GetRandomString(<span class="hljs-number"><span class="hljs-number">12</span></span>,<span class="hljs-number"><span class="hljs-number">7</span></span>)) <span class="hljs-keyword"><span class="hljs-keyword">Else</span></span> GUICtrlSetData($secret1,$secret8) <span class="hljs-keyword"><span class="hljs-keyword">EndIf</span></span> GUISetState(@SW_SHOW) <span class="hljs-keyword"><span class="hljs-keyword">While</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> $msg = GUIGetMsg() Select <span class="hljs-keyword"><span class="hljs-keyword">Case</span></span> $msg = $GUI_EVENT_CLOSE <span class="hljs-keyword"><span class="hljs-keyword">Exit</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Case</span></span> $msg = $OK_Btn ;   <span class="hljs-string"><span class="hljs-string">""</span></span>     $iploc=_GUICtrlIpAddress_Get($iploc1) $iplocnet=_GUICtrlIpAddress_Get($iplocnet1) $DNS1=_GUICtrlIpAddress_Get($DNS11) $DNS2=_GUICtrlIpAddress_Get($DNS21) $ipext=_GUICtrlIpAddress_Get($ipext1) $ipextnet=_GUICtrlIpAddress_Get($ipextnet1) $ipgate=_GUICtrlIpAddress_Get($ipgate1) $secret=GUICtrlRead($secret1) $ports=GUICtrlRead($ports1) $mac=GUICtrlRead($mac1) $iploc2=_GUICtrlIpAddress_GetArray($iploc1) ;      $ipterm1 = $iploc2[<span class="hljs-number"><span class="hljs-number">0</span></span>] &amp; <span class="hljs-string"><span class="hljs-string">"."</span></span> &amp;$iploc2[<span class="hljs-number"><span class="hljs-number">1</span></span>] &amp; <span class="hljs-string"><span class="hljs-string">"."</span></span> &amp;$iploc2[<span class="hljs-number"><span class="hljs-number">2</span></span>] &amp; <span class="hljs-string"><span class="hljs-string">".210"</span></span> $ipterm2 = $iploc2[<span class="hljs-number"><span class="hljs-number">0</span></span>] &amp; <span class="hljs-string"><span class="hljs-string">"."</span></span> &amp;$iploc2[<span class="hljs-number"><span class="hljs-number">1</span></span>] &amp; <span class="hljs-string"><span class="hljs-string">"."</span></span> &amp;$iploc2[<span class="hljs-number"><span class="hljs-number">2</span></span>] &amp; <span class="hljs-string"><span class="hljs-string">".220"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> $iploc = <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">or</span></span> $iplocnet=<span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">or</span></span> $DNS1=<span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">or</span></span> $DNS2=<span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">or</span></span> $ipext=<span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">or</span></span> $ipextnet=<span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">or</span></span> $ipgate=<span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">or</span></span> StringLen($secret)=<span class="hljs-number"><span class="hljs-number">0</span></span> then MsgBox(<span class="hljs-number"><span class="hljs-number">4160</span></span>, <span class="hljs-string"><span class="hljs-string">"Information"</span></span>, <span class="hljs-string"><span class="hljs-string">"  "</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> GUIDelete() ExitLoop <span class="hljs-keyword"><span class="hljs-keyword">EndIf</span></span> EndSelect WEnd</code> </pre><br><p>  Then the logic of the program is as follows: the new text file is line by line filled with the obtained values ‚Äã‚Äãusing FileWriteLine.  The resulting script-config can be transferred to MikroTik. </p><br><div class="spoiler">  <b class="spoiler_title">Full feature listing</b> <div class="spoiler_text"><pre> <code class="hljs kotlin">#include &lt;RandomString.au3&gt; #include &lt;GuiIPAddress.au3&gt; #include &lt;GUIConstantsEx.au3&gt; #include &lt;File.au3&gt; _mikrot() func _mikrot ($iploc8=<span class="hljs-string"><span class="hljs-string">""</span></span>, $secret8=<span class="hljs-string"><span class="hljs-string">""</span></span>, $ipext8=<span class="hljs-string"><span class="hljs-string">""</span></span>) local $file = <span class="hljs-meta"><span class="hljs-meta">@TempDir</span></span> &amp;<span class="hljs-string"><span class="hljs-string">"\script.txt"</span></span> $hgui = GUICreate(<span class="hljs-string"><span class="hljs-string">""</span></span> , <span class="hljs-number"><span class="hljs-number">300</span></span>, <span class="hljs-number"><span class="hljs-number">600</span></span>) GUICtrlCreateLabel(<span class="hljs-string"><span class="hljs-string">"   "</span></span>,<span class="hljs-number"><span class="hljs-number">2</span></span>,<span class="hljs-number"><span class="hljs-number">2</span></span>) $iploc1 = _GUICtrlIpAddress_Create($hgui, <span class="hljs-number"><span class="hljs-number">10</span></span>, <span class="hljs-number"><span class="hljs-number">20</span></span>) GUICtrlCreateLabel(<span class="hljs-string"><span class="hljs-string">"  "</span></span>,<span class="hljs-number"><span class="hljs-number">2</span></span>,<span class="hljs-number"><span class="hljs-number">55</span></span>) $iplocnet1 = _GUICtrlIpAddress_Create($hgui, <span class="hljs-number"><span class="hljs-number">10</span></span>, <span class="hljs-number"><span class="hljs-number">75</span></span>) GUICtrlCreateLabel(<span class="hljs-string"><span class="hljs-string">"  "</span></span>,<span class="hljs-number"><span class="hljs-number">2</span></span>,<span class="hljs-number"><span class="hljs-number">115</span></span>) $ipext1 = _GUICtrlIpAddress_Create($hgui, <span class="hljs-number"><span class="hljs-number">10</span></span>, <span class="hljs-number"><span class="hljs-number">135</span></span>) GUICtrlCreateLabel(<span class="hljs-string"><span class="hljs-string">"  "</span></span>,<span class="hljs-number"><span class="hljs-number">2</span></span>,<span class="hljs-number"><span class="hljs-number">170</span></span>) $ipextnet1 = _GUICtrlIpAddress_Create($hgui, <span class="hljs-number"><span class="hljs-number">10</span></span>, <span class="hljs-number"><span class="hljs-number">190</span></span>) GUICtrlCreateLabel(<span class="hljs-string"><span class="hljs-string">" "</span></span>,<span class="hljs-number"><span class="hljs-number">2</span></span>,<span class="hljs-number"><span class="hljs-number">225</span></span>) $ipgate1 = _GUICtrlIpAddress_Create($hgui, <span class="hljs-number"><span class="hljs-number">10</span></span>, <span class="hljs-number"><span class="hljs-number">245</span></span>) GUICtrlCreateLabel(<span class="hljs-string"><span class="hljs-string">" 1"</span></span>,<span class="hljs-number"><span class="hljs-number">2</span></span>,<span class="hljs-number"><span class="hljs-number">280</span></span>) $DNS11 = _GUICtrlIpAddress_Create($hgui, <span class="hljs-number"><span class="hljs-number">10</span></span>, <span class="hljs-number"><span class="hljs-number">300</span></span>) GUICtrlCreateLabel(<span class="hljs-string"><span class="hljs-string">" 2"</span></span>,<span class="hljs-number"><span class="hljs-number">2</span></span>,<span class="hljs-number"><span class="hljs-number">335</span></span>) $DNS21 = _GUICtrlIpAddress_Create($hgui, <span class="hljs-number"><span class="hljs-number">10</span></span>, <span class="hljs-number"><span class="hljs-number">355</span></span>) GUICtrlCreateLabel(<span class="hljs-string"><span class="hljs-string">"   "</span></span>,<span class="hljs-number"><span class="hljs-number">2</span></span>,<span class="hljs-number"><span class="hljs-number">390</span></span>) $secret1 = GUICtrlCreateInput(<span class="hljs-string"><span class="hljs-string">""</span></span>,<span class="hljs-number"><span class="hljs-number">10</span></span>, <span class="hljs-number"><span class="hljs-number">410</span></span>) GUICtrlCreateLabel(<span class="hljs-string"><span class="hljs-string">"     "</span></span>,<span class="hljs-number"><span class="hljs-number">2</span></span>,<span class="hljs-number"><span class="hljs-number">445</span></span>) $ports1 = GUICtrlCreateInput(<span class="hljs-string"><span class="hljs-string">"5000,8000"</span></span>,<span class="hljs-number"><span class="hljs-number">10</span></span>, <span class="hljs-number"><span class="hljs-number">480</span></span>) GUICtrlCreateLabel(<span class="hljs-string"><span class="hljs-string">"   :"</span></span>,<span class="hljs-number"><span class="hljs-number">2</span></span>,<span class="hljs-number"><span class="hljs-number">515</span></span>) $mac1 = GUICtrlCreateInput(<span class="hljs-string"><span class="hljs-string">"00:00:00:00:00:00"</span></span>,<span class="hljs-number"><span class="hljs-number">10</span></span>, <span class="hljs-number"><span class="hljs-number">535</span></span>) $OK_Btn = GUICtrlCreateButton(<span class="hljs-string"><span class="hljs-string">""</span></span>, <span class="hljs-number"><span class="hljs-number">75</span></span>, <span class="hljs-number"><span class="hljs-number">570</span></span>, <span class="hljs-number"><span class="hljs-number">70</span></span>, <span class="hljs-number"><span class="hljs-number">25</span></span>) _GUICtrlIpAddress_Set($iploc1, $iploc8) _GUICtrlIpAddress_Set($ipext1, $ipext8) _GUICtrlIpAddress_Set($iplocnet1, <span class="hljs-string"><span class="hljs-string">"255.255.255.0"</span></span>) _GUICtrlIpAddress_Set($ipextnet1, <span class="hljs-string"><span class="hljs-string">"255.255.255.252"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> $secret8 = <span class="hljs-string"><span class="hljs-string">""</span></span> Then GUICtrlSetData($secret1,_Crypto_GetRandomString(<span class="hljs-number"><span class="hljs-number">12</span></span>,<span class="hljs-number"><span class="hljs-number">7</span></span>)) Else GUICtrlSetData($secret1,$secret8) EndIf GUISetState(<span class="hljs-meta"><span class="hljs-meta">@SW_SHOW</span></span>) While <span class="hljs-number"><span class="hljs-number">1</span></span> $msg = GUIGetMsg() Select Case $msg = $GUI_EVENT_CLOSE Exit Case $msg = $OK_Btn $iploc=_GUICtrlIpAddress_Get($iploc1) $iplocnet=_GUICtrlIpAddress_Get($iplocnet1) $DNS1=_GUICtrlIpAddress_Get($DNS11) $DNS2=_GUICtrlIpAddress_Get($DNS21) $ipext=_GUICtrlIpAddress_Get($ipext1) $ipextnet=_GUICtrlIpAddress_Get($ipextnet1) $ipgate=_GUICtrlIpAddress_Get($ipgate1) $secret=GUICtrlRead($secret1) $ports=GUICtrlRead($ports1) $mac=GUICtrlRead($mac1) $iploc2=_GUICtrlIpAddress_GetArray($iploc1) ;      $ipterm1 = $iploc2[<span class="hljs-number"><span class="hljs-number">0</span></span>] &amp; <span class="hljs-string"><span class="hljs-string">"."</span></span> &amp;$iploc2[<span class="hljs-number"><span class="hljs-number">1</span></span>] &amp; <span class="hljs-string"><span class="hljs-string">"."</span></span> &amp;$iploc2[<span class="hljs-number"><span class="hljs-number">2</span></span>] &amp; <span class="hljs-string"><span class="hljs-string">".210"</span></span> $ipterm2 = $iploc2[<span class="hljs-number"><span class="hljs-number">0</span></span>] &amp; <span class="hljs-string"><span class="hljs-string">"."</span></span> &amp;$iploc2[<span class="hljs-number"><span class="hljs-number">1</span></span>] &amp; <span class="hljs-string"><span class="hljs-string">"."</span></span> &amp;$iploc2[<span class="hljs-number"><span class="hljs-number">2</span></span>] &amp; <span class="hljs-string"><span class="hljs-string">".220"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> $iploc = <span class="hljs-number"><span class="hljs-number">0</span></span> or $iplocnet=<span class="hljs-number"><span class="hljs-number">0</span></span> or $DNS1=<span class="hljs-number"><span class="hljs-number">0</span></span> or $DNS2=<span class="hljs-number"><span class="hljs-number">0</span></span> or $ipext=<span class="hljs-number"><span class="hljs-number">0</span></span> or $ipextnet=<span class="hljs-number"><span class="hljs-number">0</span></span> or $ipgate=<span class="hljs-number"><span class="hljs-number">0</span></span> or StringLen($secret)=<span class="hljs-number"><span class="hljs-number">0</span></span> then MsgBox(<span class="hljs-number"><span class="hljs-number">4160</span></span>, <span class="hljs-string"><span class="hljs-string">"Information"</span></span>, <span class="hljs-string"><span class="hljs-string">"  "</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> GUIDelete() ExitLoop EndIf EndSelect WEnd $temp1=_Subnet($iploc, $iplocnet) $iplocnet=$temp1[<span class="hljs-number"><span class="hljs-number">1</span></span>]&amp;<span class="hljs-string"><span class="hljs-string">"/"</span></span>&amp;$temp1[<span class="hljs-number"><span class="hljs-number">6</span></span>] $temp1=_Subnet($ipext, $ipextnet) $ipext=$ipext&amp;<span class="hljs-string"><span class="hljs-string">"/"</span></span>&amp;$temp1[<span class="hljs-number"><span class="hljs-number">6</span></span>] If Not _FileCreate($file) Then MsgBox(<span class="hljs-number"><span class="hljs-number">4096</span></span>, <span class="hljs-string"><span class="hljs-string">"Error"</span></span>, <span class="hljs-string"><span class="hljs-string">"   :"</span></span> &amp; <span class="hljs-meta"><span class="hljs-meta">@error</span></span>) EndIf FileOpen ( $file, <span class="hljs-number"><span class="hljs-number">2</span></span>) FileWriteLine ( $file, <span class="hljs-string"><span class="hljs-string">"local locIP "</span></span><span class="hljs-string"><span class="hljs-string">""</span></span>&amp;$iploc&amp;<span class="hljs-string"><span class="hljs-string">""";") FileWriteLine ( </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$file</span></span></span><span class="hljs-string">, "local Net """</span></span>&amp;$iplocnet&amp;<span class="hljs-string"><span class="hljs-string">""";") FileWriteLine ( </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$file</span></span></span><span class="hljs-string">, "local DNS1 """</span></span>&amp; $DNS1 &amp; <span class="hljs-string"><span class="hljs-string">""";") FileWriteLine ( </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$file</span></span></span><span class="hljs-string">, "local DNS2 """</span></span>&amp;$DNS2&amp;<span class="hljs-string"><span class="hljs-string">""";") FileWriteLine ( </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$file</span></span></span><span class="hljs-string">, "local IP """</span></span>&amp;$ipext&amp;<span class="hljs-string"><span class="hljs-string">"""") FileWriteLine ( </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$file</span></span></span><span class="hljs-string">, "local Gate """</span></span>&amp;$ipgate&amp;<span class="hljs-string"><span class="hljs-string">"""") FileWriteLine ( </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$file</span></span></span><span class="hljs-string">, "local MAC """</span></span>&amp;$mac&amp;<span class="hljs-string"><span class="hljs-string">"""") FileWriteLine ( </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$file</span></span></span><span class="hljs-string">, "local secret """</span></span>&amp;$secret&amp;<span class="hljs-string"><span class="hljs-string">"""") FileWriteLine ( </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$file</span></span></span><span class="hljs-string">, "local BankPorts """</span></span>&amp;$ports&amp;<span class="hljs-string"><span class="hljs-string">""" ") FileWriteLine ( </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$file</span></span></span><span class="hljs-string">, "local term1 """</span></span>&amp;$ipterm1&amp;<span class="hljs-string"><span class="hljs-string">"""") FileWriteLine ( </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$file</span></span></span><span class="hljs-string">, "local term2 """</span></span>&amp;$ipterm2&amp;<span class="hljs-string"><span class="hljs-string">""" ") FileWriteLine ( </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$file</span></span></span><span class="hljs-string">, '/interface set ether1 name=ether1-gateway;') FileWriteLine ( </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$file</span></span></span><span class="hljs-string">, '/interface set ether2 name=ether2-master-local;') FileWriteLine ( </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$file</span></span></span><span class="hljs-string">, '/interface set ether3 name=ether3-slave-local;') FileWriteLine ( </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$file</span></span></span><span class="hljs-string">, '/interface set ether4 name=ether4-slave-local;') FileWriteLine ( </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$file</span></span></span><span class="hljs-string">, '/interface set ether5 name=ether5-slave-local;') FileWriteLine ( </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$file</span></span></span><span class="hljs-string">, '/interface ethernet set ether3-slave-local master-port=ether2-master-local;') FileWriteLine ( </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$file</span></span></span><span class="hljs-string">, '/interface ethernet set ether4-slave-local master-port=ether2-master-local;') FileWriteLine ( </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$file</span></span></span><span class="hljs-string">, '/interface ethernet set ether5-slave-local master-port=ether2-master-local;') FileWriteLine ( </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$file</span></span></span><span class="hljs-string">, '/interface bridge add name=bridge-local disabled=no auto-mac=no protocol-mode=rstp;') FileWriteLine ( </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$file</span></span></span><span class="hljs-string">, ':local bMACIsSet 0;') FileWriteLine ( </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$file</span></span></span><span class="hljs-string">, ':foreach k in=[/interface find] do={:local tmpPort [/interface get </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$k</span></span></span><span class="hljs-string"> name];') FileWriteLine ( </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$file</span></span></span><span class="hljs-string">, ':if (</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$bMACIsSet</span></span></span><span class="hljs-string"> = 0) do={:if ([/interface get </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$k</span></span></span><span class="hljs-string"> type] = "ether") do={/interface bridge set "bridge-local" admin-mac=[/interface ethernet get </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$tmpPort</span></span></span><span class="hljs-string"> mac-address];') FileWriteLine ( </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$file</span></span></span><span class="hljs-string">, ':set bMACIsSet 1;}}') FileWriteLine ( </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$file</span></span></span><span class="hljs-string">, ':if (!(</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$tmpPort</span></span></span><span class="hljs-string">~"bridge" || </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$tmpPort</span></span></span><span class="hljs-string">~"ether1" || </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$tmpPort</span></span></span><span class="hljs-string">~"slave")) do={') FileWriteLine ( </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$file</span></span></span><span class="hljs-string">, '/interface bridge port add bridge=bridge-local interface=</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$tmpPort</span></span></span><span class="hljs-string">;}} ') FileWriteLine ( </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$file</span></span></span><span class="hljs-string">, '/interface wireless set [ find name=wlan1 ] band=2ghz-b/g/n channel-width=20/40mhz-Ce country=japan disabled=no distance=indoors mode=ap-bridge ssid=MikroTik wireless-protocol=802.11;') FileWriteLine ( </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$file</span></span></span><span class="hljs-string">, '/interface wireless security-profiles') FileWriteLine ( </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$file</span></span></span><span class="hljs-string">, 'set [ find default=yes ] authentication-types=wpa-psk group-ciphers=tkip \') FileWriteLine ( </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$file</span></span></span><span class="hljs-string">, ' mode=dynamic-keys unicast-ciphers=tkip wpa-pre-shared-key=\') FileWriteLine ( </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$file</span></span></span><span class="hljs-string">, ' MegaWiFiKey wpa2-pre-shared-key=MegaWiFiKey') FileWriteLine ( </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$file</span></span></span><span class="hljs-string">, '/ip ipsec proposal set [ find default=yes ] auth-algorithms=md5 lifetime=1h') FileWriteLine ( </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$file</span></span></span><span class="hljs-string">, '/ip pool') FileWriteLine ( </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$file</span></span></span><span class="hljs-string">, 'add name=default-dhcp ranges=("</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$locIP</span></span></span><span class="hljs-string">". "1". "-". "</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$locIP</span></span></span><span class="hljs-string">". "00");') FileWriteLine ( </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$file</span></span></span><span class="hljs-string">, '/ip dhcp-server add address-pool=default-dhcp disabled=no interface=bridge-local name=default') FileWriteLine ( </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$file</span></span></span><span class="hljs-string">, '/ip dhcp-server network add address=</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$Net</span></span></span><span class="hljs-string"> comment="default configuration" dns-server="</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$locIP</span></span></span><span class="hljs-string">,8.8.8.8" gateway=</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$locIP</span></span></span><span class="hljs-string"> netmask=24') FileWriteLine ( </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$file</span></span></span><span class="hljs-string">, '/ip dns') FileWriteLine ( </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$file</span></span></span><span class="hljs-string">, 'set allow-remote-requests=yes servers=("</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$DNS1</span></span></span><span class="hljs-string">". ",". "</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$DNS2</span></span></span><span class="hljs-string">")') FileWriteLine ( </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$file</span></span></span><span class="hljs-string">, '/ip firewall address-list') FileWriteLine ( </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$file</span></span></span><span class="hljs-string">, ':if ([:len [/ip firewall address-list find list=local]] = 0) do={add address=</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$Net</span></span></span><span class="hljs-string"> list=local;') FileWriteLine ( </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$file</span></span></span><span class="hljs-string">, '} else={set [find list=local] address=</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$Net</span></span></span><span class="hljs-string">;}') FileWriteLine ( </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$file</span></span></span><span class="hljs-string">, ':if ([:len [/ip firewall address-list find list=office]] = 0) do={add address=10.0.0.0/24 list=office;}') ;   FileWriteLine ( </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$file</span></span></span><span class="hljs-string">, ':if ([:len [/ip firewall address-list find list=remote]] = 0) do={add address=1.2.3.4 list=remote comment=office1.domain.ru;') FileWriteLine ( </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$file</span></span></span><span class="hljs-string">, 'add address=1.2.3.5 list=remote comment=office2.domain.ru;') FileWriteLine ( </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$file</span></span></span><span class="hljs-string">, 'add address=10.0.0.0/24 list=remote;}') FileWriteLine ( </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$file</span></span></span><span class="hljs-string">, '/ip address') FileWriteLine ( </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$file</span></span></span><span class="hljs-string">, 'add address="</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$locIP</span></span></span><span class="hljs-string">/24" interface=bridge-local') FileWriteLine ( </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$file</span></span></span><span class="hljs-string">, ':if ([:len [/ip address find interface=ether1-gateway]] = 0) do={add address=</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$IP</span></span></span><span class="hljs-string"> interface=ether1-gateway;') FileWriteLine ( </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$file</span></span></span><span class="hljs-string">, '} else={set [find interface=ether1-gateway] address=</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$IP</span></span></span><span class="hljs-string">;}') FileWriteLine ( </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$file</span></span></span><span class="hljs-string">, '/ip route') FileWriteLine ( </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$file</span></span></span><span class="hljs-string">, ':if ([:len [/ip route find distance=1]] = 0) do={add distance=1 gateway=</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$Gate</span></span></span><span class="hljs-string">;') FileWriteLine ( </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$file</span></span></span><span class="hljs-string">, '} else={set [find distance=1] gateway=</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$Gate</span></span></span><span class="hljs-string">}') FileWriteLine ( </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$file</span></span></span><span class="hljs-string">, ':delay 1000ms;') FileWriteLine ( </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$file</span></span></span><span class="hljs-string">, '/ip ipsec peer') FileWriteLine ( </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$file</span></span></span><span class="hljs-string">, '/ip ipsec proposal set default auth-algorithms=md5 enc-algorithms=3des') FileWriteLine ( </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$file</span></span></span><span class="hljs-string">, ':if ([:len [/ip ipsec peer find lifetime=8h]] = 0) do={add address=1.2.3.4/32 lifetime=8h nat-traversal=yes secret=</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$secret</span></span></span><span class="hljs-string"> enc-algorithm=3des hash-algorithm=md5 comment=office;') FileWriteLine ( </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$file</span></span></span><span class="hljs-string">, '} else={set [/ip ipsec peer find lifetime=8h] address=1.2.3.5/32 nat-traversal=yes secret=</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$secret</span></span></span><span class="hljs-string"> enc-algorithm=3des hash-algorithm=md5 comment=office;}') FileWriteLine ( </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$file</span></span></span><span class="hljs-string">, '/ip ipsec policy') FileWriteLine ( </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$file</span></span></span><span class="hljs-string">, '/ip ipsec proposal set default auth-algorithms=md5 enc-algorithms=3des') FileWriteLine ( </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$file</span></span></span><span class="hljs-string">, ':if ([:len [/ip ipsec policy find dst-address=10.0.0.0/24]] = 0) do={add dst-address=10.0.0.0/24 sa-dst-address=188.93.243.170 sa-src-address=[/ip route get [find gateway=ether1-gateway] pref-src] src-address=</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$Net</span></span></span><span class="hljs-string"> tunnel=yes comment=office proposal=default;') FileWriteLine ( </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$file</span></span></span><span class="hljs-string">, '} else={set [find dst-address=10.0.0.0/24] sa-dst-address=1.2.3.4 sa-src-address =[/ip route get [find gateway=ether1-gateway] pref-src] src-address=</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$Net</span></span></span><span class="hljs-string"> tunnel=yes comment=office;} ') FileWriteLine ( </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$file</span></span></span><span class="hljs-string">, '/ip service') FileWriteLine ( </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$file</span></span></span><span class="hljs-string">, 'set telnet disabled=yes') FileWriteLine ( </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$file</span></span></span><span class="hljs-string">, 'set ftp disabled=yes') FileWriteLine ( </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$file</span></span></span><span class="hljs-string">, 'set www port=80') FileWriteLine ( </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$file</span></span></span><span class="hljs-string">, 'set api disabled=yes') FileWriteLine ( </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$file</span></span></span><span class="hljs-string">, 'set api-ssl disabled=yes') FileWriteLine ( </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$file</span></span></span><span class="hljs-string">, 'set www-ssl disabled=yes') FileWriteLine ( </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$file</span></span></span><span class="hljs-string">, '/system clock manual') FileWriteLine ( </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$file</span></span></span><span class="hljs-string">, 'set time-zone=+03:00') FileWriteLine ( </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$file</span></span></span><span class="hljs-string">, '/system leds') FileWriteLine ( </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$file</span></span></span><span class="hljs-string">, 'set 0 interface=wlan1') FileWriteLine ( </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$file</span></span></span><span class="hljs-string">, '/system ntp client') FileWriteLine ( </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$file</span></span></span><span class="hljs-string">, 'set enabled=yes primary-ntp=61.67.210.241 secondary-ntp=205.171.76.135') FileWriteLine ( </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$file</span></span></span><span class="hljs-string">, '/system script') FileWriteLine ( </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$file</span></span></span><span class="hljs-string">, ':if ([:len [/system script find name=ipsec]] != 0) do={') FileWriteLine ( </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$file</span></span></span><span class="hljs-string">, 'remove ipsec') FileWriteLine ( </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$file</span></span></span><span class="hljs-string">, '}') ;  IPsec   . ; keepalive     ;     FileWriteLine ( </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$file</span></span></span><span class="hljs-string">, 'add name=ipsec policy=reboot,read,write,policy,test,password,sniff,sensitive \') FileWriteLine ( </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$file</span></span></span><span class="hljs-string">, ' source=":local RemoteGw \"  DFL\";\r\') FileWriteLine ( </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$file</span></span></span><span class="hljs-string">, ' \n:local LocalGw [/ip route get [find gateway=\"bridge-local\"] pref-src];\') FileWriteLine ( </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$file</span></span></span><span class="hljs-string">, ' \r\') FileWriteLine ( </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$file</span></span></span><span class="hljs-string">, ' \n:local currentIP [/ip route get [find gateway=\"ether1-gateway\"] pref-s\') FileWriteLine ( </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$file</span></span></span><span class="hljs-string">, ' rc];\r\') FileWriteLine ( </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$file</span></span></span><span class="hljs-string">, ' \n:local Ip1 [:resolve office1.domain.ru];\r\') FileWriteLine ( </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$file</span></span></span><span class="hljs-string">, ' \n:local Ip2 [:resolve office2.domain.ru];\r\') FileWriteLine ( </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$file</span></span></span><span class="hljs-string">, ' \n### Check office IPs ###\r\') FileWriteLine ( </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$file</span></span></span><span class="hljs-string">, ' \n:local Ip [/ip firewall address-list get [find comment=office1.dom\') FileWriteLine ( </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$file</span></span></span><span class="hljs-string">, ' ain.ru] address];\r\') FileWriteLine ( </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$file</span></span></span><span class="hljs-string">, ' \n:if (\</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$Ip</span></span></span><span class="hljs-string">!=\</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$Ip2</span></span></span><span class="hljs-string">) do={\r\') FileWriteLine ( </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$file</span></span></span><span class="hljs-string">, ' \n/ip firewall address-list set [find comment=office1.domain.ru] addr\') FileWriteLine ( </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$file</span></span></span><span class="hljs-string">, ' ess=\</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$Ip2</span></span></span><span class="hljs-string">;\r\') FileWriteLine ( </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$file</span></span></span><span class="hljs-string">, ' \n}\r\') FileWriteLine ( </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$file</span></span></span><span class="hljs-string">, ' \n:set Ip [/ip firewall address-list get [find comment=office2.domain\') FileWriteLine ( </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$file</span></span></span><span class="hljs-string">, ' .ru] address];\r\') FileWriteLine ( </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$file</span></span></span><span class="hljs-string">, ' \n:if (\</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$Ip</span></span></span><span class="hljs-string">!=\</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$Ip1</span></span></span><span class="hljs-string">) do={\r\') FileWriteLine ( </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$file</span></span></span><span class="hljs-string">, ' \n/ip firewall address-list set [find comment=office2.domain.ru] addr\') FileWriteLine ( </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$file</span></span></span><span class="hljs-string">, ' ess=\</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$Ip1</span></span></span><span class="hljs-string">;\r\') FileWriteLine ( </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$file</span></span></span><span class="hljs-string">, ' \n}\r\') FileWriteLine ( </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$file</span></span></span><span class="hljs-string">, ' \n### Check ipsec status ###\r\') FileWriteLine ( </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$file</span></span></span><span class="hljs-string">, ' \n:local Status [/ping \</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$RemoteGw</span></span></span><span class="hljs-string"> count=1 src-address=\</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$LocalGw</span></span></span><span class="hljs-string">];\r\') FileWriteLine ( </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$file</span></span></span><span class="hljs-string">, ' \n### ipsec is down ###\r\') FileWriteLine ( </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$file</span></span></span><span class="hljs-string">, ' \n:if (\</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$Status</span></span></span><span class="hljs-string">=0) do={\r\') FileWriteLine ( </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$file</span></span></span><span class="hljs-string">, ' \n### ping Ip2 and Ip1 ###\r\') FileWriteLine ( </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$file</span></span></span><span class="hljs-string">, ' \n:local StatusIp1 [/ping \</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$Ip1</span></span></span><span class="hljs-string"> count=2 src-address=\</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$currentIP</span></span></span><span class="hljs-string">];\r\') FileWriteLine ( </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$file</span></span></span><span class="hljs-string">, ' \n:local StatusIp2 [/ping \</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$Ip2</span></span></span><span class="hljs-string"> count=2 src-address=\</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$currentIP</span></span></span><span class="hljs-string">];\r\') FileWriteLine ( </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$file</span></span></span><span class="hljs-string">, ' \n:if (\</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$StatusIp1</span></span></span><span class="hljs-string">&gt;0 or \</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$StatusIp2</span></span></span><span class="hljs-string">&gt;0) do={\r\') FileWriteLine ( </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$file</span></span></span><span class="hljs-string">, ' \n:if (\</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$StatusIp1</span></span></span><span class="hljs-string">&gt;0) do={\r\') FileWriteLine ( </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$file</span></span></span><span class="hljs-string">, ' \n### Ping Ip1 ok ###\r\') FileWriteLine ( </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$file</span></span></span><span class="hljs-string">, ' \n/ip ipsec policy set [find sa-dst-address=\</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$Ip2</span></span></span><span class="hljs-string">] sa-dst-address \</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$Ip1</span></span></span><span class="hljs-string">;\r\') FileWriteLine ( </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$file</span></span></span><span class="hljs-string">, ' \n/ip ipsec peer set [find address=\"\</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$Ip2</span></span></span><span class="hljs-string">/32\"] address \"\</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$Ip1</span></span></span><span class="hljs-string">/32\";\r\') FileWriteLine ( </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$file</span></span></span><span class="hljs-string">, ' \n:log info (\"Reset tunnel: Status IP Office1: \</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$StatusIp1</span></span></span><span class="hljs-string">\");\r\') FileWriteLine ( </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$file</span></span></span><span class="hljs-string">, ' \n} else={\r\') FileWriteLine ( </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$file</span></span></span><span class="hljs-string">, ' \n### Ping Ip1 NOT ok ###\r\') FileWriteLine ( </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$file</span></span></span><span class="hljs-string">, ' \n/ip ipsec policy set [find sa-dst-address=\</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$Ip1</span></span></span><span class="hljs-string">] sa-dst-address \</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$Ip2</span></span></span><span class="hljs-string">;\r\') FileWriteLine ( </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$file</span></span></span><span class="hljs-string">, ' \n/ip ipsec peer set [find address=\"\</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$Ip1</span></span></span><span class="hljs-string">/32\"] address \"\</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$Ip2</span></span></span><span class="hljs-string">/32\";\r\') FileWriteLine ( </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$file</span></span></span><span class="hljs-string">, ' \n:log info (\"Reset tunnel: Status IP Office2: \</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$StatusIp2</span></span></span><span class="hljs-string">\");\r\') FileWriteLine ( </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$file</span></span></span><span class="hljs-string">, ' \n}\r\') FileWriteLine ( </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$file</span></span></span><span class="hljs-string">, ' \n/ip ipsec installed-sa flush;\r\') FileWriteLine ( </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$file</span></span></span><span class="hljs-string">, ' \n/ip ipsec remote-peers kill-connections;\r\') FileWriteLine ( </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$file</span></span></span><span class="hljs-string">, ' \n:local Status [/ping \</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$RemoteGw</span></span></span><span class="hljs-string"> count=2 src-address=\</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$LocalGw</span></span></span><span class="hljs-string">];\r\') FileWriteLine ( </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$file</span></span></span><span class="hljs-string">, ' \n:if (\</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$Status</span></span></span><span class="hljs-string">=0) do={\r\') FileWriteLine ( </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$file</span></span></span><span class="hljs-string">, ' \n:log info (\"check for misconfiguration\");\r\') FileWriteLine ( </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$file</span></span></span><span class="hljs-string">, ' \n### Check local IP ###\r\') FileWriteLine ( </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$file</span></span></span><span class="hljs-string">, ' \n:set Ip [/ip ipsec policy get [find comment=office] sa-src-address];\r\') FileWriteLine ( </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$file</span></span></span><span class="hljs-string">, ' \n:if (\</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$Ip</span></span></span><span class="hljs-string">!=\</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$currentIP</span></span></span><span class="hljs-string">) do={\r\') FileWriteLine ( </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$file</span></span></span><span class="hljs-string">, ' \n/ip ipsec policy set [find comment=office] sa-src-address=\</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$currentIP</span></span></span><span class="hljs-string">;\r\') FileWriteLine ( </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$file</span></span></span><span class="hljs-string">, ' \n:log info (\"misconfiguration: policy, local address\");\r\') FileWriteLine ( </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$file</span></span></span><span class="hljs-string">, ' \n}\r\') FileWriteLine ( </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$file</span></span></span><span class="hljs-string">, ' \n### Check remote IP ###\r\') FileWriteLine ( </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$file</span></span></span><span class="hljs-string">, ' \n:set Ip [/ip ipsec policy get [find comment=office] sa-dst-address];\r\') FileWriteLine ( </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$file</span></span></span><span class="hljs-string">, ' \n:if (\</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$Ip</span></span></span><span class="hljs-string">!=\</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$Ip1</span></span></span><span class="hljs-string"> and \</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$Ip</span></span></span><span class="hljs-string">!=\</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$Ip2</span></span></span><span class="hljs-string">) do={\r\') FileWriteLine ( </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$file</span></span></span><span class="hljs-string">, ' \n:if (\</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$StatusIp1</span></span></span><span class="hljs-string">&gt;0) do={\r\') FileWriteLine ( </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$file</span></span></span><span class="hljs-string">, ' \n/ip ipsec policy set [find comment=office] sa-dst-address=\</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$Ip1</span></span></span><span class="hljs-string">;\r\') FileWriteLine ( </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$file</span></span></span><span class="hljs-string">, ' \n} else={/ip ipsec policy set [find comment=office] sa-dst-address=\</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$Ip2</span></span></span><span class="hljs-string">;\') FileWriteLine ( </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$file</span></span></span><span class="hljs-string">, ' }\r\') FileWriteLine ( </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$file</span></span></span><span class="hljs-string">, ' \n:log info (\"misconfiguration: policy, remote address\");\r\') FileWriteLine ( </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$file</span></span></span><span class="hljs-string">, ' \n}\r\') FileWriteLine ( </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$file</span></span></span><span class="hljs-string">, ' \n:set Ip [/ip ipsec peer get [find comment=office] address];\r\') FileWriteLine ( </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$file</span></span></span><span class="hljs-string">, ' \n:if (\</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$Ip</span></span></span><span class="hljs-string">!=\</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$Ip1</span></span></span><span class="hljs-string">.\"/32\" and \</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$Ip</span></span></span><span class="hljs-string">!=\</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$Ip2</span></span></span><span class="hljs-string">.\"/32\") do={\r\') FileWriteLine ( </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$file</span></span></span><span class="hljs-string">, ' \n:if (\</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$StatusIp1</span></span></span><span class="hljs-string">&gt;0) do={\r\') FileWriteLine ( </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$file</span></span></span><span class="hljs-string">, ' \n/ip ipsec peer set [find comment=office] address=\</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$Ip1</span></span></span><span class="hljs-string">;\r\') FileWriteLine ( </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$file</span></span></span><span class="hljs-string">, ' \n} else={/ip ipsec peer set [find comment=office] address=\"\</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$Ip1</span></span></span><span class="hljs-string">/32\";}\r\') FileWriteLine ( </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$file</span></span></span><span class="hljs-string">, ' \n:log info (\"misconfiguration: peer\");\r\') FileWriteLine ( </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$file</span></span></span><span class="hljs-string">, ' \n}\r\') FileWriteLine ( </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$file</span></span></span><span class="hljs-string">, ' \n} else={:log info (\"Ipsec tunnel status: OK\");}\r\') FileWriteLine ( </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$file</span></span></span><span class="hljs-string">, ' \n} else={:log info (\"Ipsec tunnel status: Office is DOWN!\");}\r\') FileWriteLine ( </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$file</span></span></span><span class="hljs-string">, ' \n} else={:log info (\"Ipsec tunnel status: OK\");}"') ; ntp,     FileWriteLine ( </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$file</span></span></span><span class="hljs-string">, ':if ([:len [/system script find name=ntp]] != 0) do={') FileWriteLine ( </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$file</span></span></span><span class="hljs-string">, 'remove ntp') FileWriteLine ( </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$file</span></span></span><span class="hljs-string">, '}') FileWriteLine ( </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$file</span></span></span><span class="hljs-string">, 'add name=ntp policy=\') FileWriteLine ( </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$file</span></span></span><span class="hljs-string">, 'ftp,reboot,read,write,policy,test,password,sniff,sensitive source=":local \') FileWriteLine ( </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$file</span></span></span><span class="hljs-string">, 'ntp1 [:resolve pool.ntp.org];\r\') FileWriteLine ( </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$file</span></span></span><span class="hljs-string">, '\n:local ntp2 [:resolve time.windows.com];\r\') FileWriteLine ( </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$file</span></span></span><span class="hljs-string">, '\n:local Ip [/system ntp client get primary-ntp];\r\') FileWriteLine ( </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$file</span></span></span><span class="hljs-string">, '\n:if (\</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$Ip</span></span></span><span class="hljs-string">!=\</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$ntp1</span></span></span><span class="hljs-string">) do={\r\') FileWriteLine ( </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$file</span></span></span><span class="hljs-string">, '\n/system ntp client set primary-ntp=\</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$ntp1</span></span></span><span class="hljs-string">;\r\') FileWriteLine ( </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$file</span></span></span><span class="hljs-string">, '\n}\r\') FileWriteLine ( </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$file</span></span></span><span class="hljs-string">, '\n:set Ip [/system ntp client get secondary-ntp];\r\') FileWriteLine ( </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$file</span></span></span><span class="hljs-string">, '\n:if (\</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$Ip</span></span></span><span class="hljs-string">!=\</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$ntp2</span></span></span><span class="hljs-string">) do={\r\') FileWriteLine ( </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$file</span></span></span><span class="hljs-string">, '\n/system ntp client set secondary-ntp=\</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$ntp2</span></span></span><span class="hljs-string">;\r\') FileWriteLine ( </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$file</span></span></span><span class="hljs-string">, '\n}"') FileWriteLine ( </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$file</span></span></span><span class="hljs-string">, '/system scheduler') FileWriteLine ( </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$file</span></span></span><span class="hljs-string">, ':if ([:len [/system scheduler find name=ipsec-test]] = 0) do={') FileWriteLine ( </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$file</span></span></span><span class="hljs-string">, 'add interval=3m name=ipsec-test on-event="/system script run ipsec" policy=\') FileWriteLine ( </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$file</span></span></span><span class="hljs-string">, ' reboot,read,write,policy,test,password,sniff,sensitive') FileWriteLine ( </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$file</span></span></span><span class="hljs-string">, ' }') FileWriteLine ( </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$file</span></span></span><span class="hljs-string">, ':if ([:len [/system scheduler find name=ntp]] = 0) do={') FileWriteLine ( </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$file</span></span></span><span class="hljs-string">, 'add interval=1d name=ntp on-event="/system script run ntp" policy=\') FileWriteLine ( </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$file</span></span></span><span class="hljs-string">, ' reboot,read,write,policy,test,password,sniff,sensitive') FileWriteLine ( </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$file</span></span></span><span class="hljs-string">, ' }') FileWriteLine ( </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$file</span></span></span><span class="hljs-string">, '/ip firewall nat') FileWriteLine ( </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$file</span></span></span><span class="hljs-string">, 'add chain=srcnat comment=ipsec dst-address-list=office out-interface=\') FileWriteLine ( </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$file</span></span></span><span class="hljs-string">, ' ether1-gateway src-address-list=local') FileWriteLine ( </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$file</span></span></span><span class="hljs-string">, 'add action=masquerade chain=srcnat comment=bank1 src-address=</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$term1</span></span></span><span class="hljs-string"> dst-port=</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$BankPorts</span></span></span><span class="hljs-string"> out-interface=ether1-gateway protocol=tcp disable=yes') FileWriteLine ( </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$file</span></span></span><span class="hljs-string">, 'add action=masquerade chain=srcnat comment=bank2 src-address=</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$term2</span></span></span><span class="hljs-string"> dst-port=</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$BankPorts</span></span></span><span class="hljs-string"> out-interface=ether1-gateway protocol=tcp disable=yes') FileWriteLine ( </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$file</span></span></span><span class="hljs-string">, 'add action=masquerade chain=srcnat comment="outbound icmp" out-interface=\') FileWriteLine ( </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$file</span></span></span><span class="hljs-string">, ' ether1-gateway protocol=icmp') FileWriteLine ( </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$file</span></span></span><span class="hljs-string">, 'add action=masquerade chain=srcnat comment="default configuration" disabled=\') FileWriteLine ( </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$file</span></span></span><span class="hljs-string">, ' yes out-interface=ether1-gateway') FileWriteLine ( </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$file</span></span></span><span class="hljs-string">, '/ip firewall filter') FileWriteLine ( </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$file</span></span></span><span class="hljs-string">, 'add chain=input comment="remote admin" dst-port=80,22,8291 src-address-list=remote in-interface=\') FileWriteLine ( </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$file</span></span></span><span class="hljs-string">, ' ether1-gateway protocol=tcp') FileWriteLine ( </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$file</span></span></span><span class="hljs-string">, 'add chain=input comment=icmp protocol=icmp') FileWriteLine ( </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$file</span></span></span><span class="hljs-string">, 'add chain=input comment="established, related" connection-state=established') FileWriteLine ( </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$file</span></span></span><span class="hljs-string">, 'add chain=input connection-state=related') FileWriteLine ( </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$file</span></span></span><span class="hljs-string">, 'add action=drop chain=input comment="drop other" in-interface=ether1-gateway') FileWriteLine ( </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$file</span></span></span><span class="hljs-string">, 'add chain=forward comment="established, related" connection-state=established') FileWriteLine ( </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$file</span></span></span><span class="hljs-string">, 'add chain=forward connection-state=related') FileWriteLine ( </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$file</span></span></span><span class="hljs-string">, 'add action=drop chain=forward comment="drop other" connection-state=invalid') FileWriteLine ( </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$file</span></span></span><span class="hljs-string">, '/ip dhcp-server lease') FileWriteLine ( </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$file</span></span></span><span class="hljs-string">, ':if ([:len [/ip dhcp-server lease find address=("</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$locIP</span></span></span><span class="hljs-string">". "1")]]&gt;0) do={') FileWriteLine ( </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$file</span></span></span><span class="hljs-string">, 'set [/ip dhcp-server lease find address=("</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$locIP</span></span></span><span class="hljs-string">". "1")] address=("</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$locIP</span></span></span><span class="hljs-string">". "1") mac-address=</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$MAC</span></span></span><span class="hljs-string">;}') FileWriteLine ( </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$file</span></span></span><span class="hljs-string">, ':if ([:len [/ip dhcp-server lease find address=("</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$locIP</span></span></span><span class="hljs-string">". "1")]] = 0) do={add address=("</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$locIP</span></span></span><span class="hljs-string">". "1") mac-address=</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$MAC</span></span></span><span class="hljs-string">;}') FileWriteLine ( </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$file</span></span></span><span class="hljs-string">, '/user') FileWriteLine ( </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$file</span></span></span><span class="hljs-string">, 'set [find name=admin] password=MegaPassW0rd') fileclose(</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$file</span></span></span><span class="hljs-string">) run("notepad "&amp;</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$file</span></span></span><span class="hljs-string">) EndFunc ;   . Func _Subnet(</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$sIp</span></span></span><span class="hljs-string">, </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$sNetmask</span></span></span><span class="hljs-string">) Dim </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$netmaskbinary</span></span></span><span class="hljs-string"> Dim </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$subnetaddarray</span></span></span><span class="hljs-string">[5] Dim </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$invmaskarray</span></span></span><span class="hljs-string">[5] Dim </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$broadcastaddarray</span></span></span><span class="hljs-string">[5] Dim </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$sSubnetinfo</span></span></span><span class="hljs-string">[7] Dim </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$subnetadd</span></span></span><span class="hljs-string"> Dim </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$invmask</span></span></span><span class="hljs-string"> Dim </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$broadcastadd</span></span></span><span class="hljs-string"> ; Reads IP and Netmask to an array </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$iparray</span></span></span><span class="hljs-string"> = StringSplit(</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$sIp</span></span></span><span class="hljs-string">, ".") </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$netmaskarray</span></span></span><span class="hljs-string"> = StringSplit(</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$sNetmask</span></span></span><span class="hljs-string">, ".") ; Validates IP address For </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$i</span></span></span><span class="hljs-string"> = 1 To 4 If Number(</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$iparray</span></span></span><span class="hljs-string">[</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$i</span></span></span><span class="hljs-string">]) &lt; 0 Or Number(</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$iparray</span></span></span><span class="hljs-string">[</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$i</span></span></span><span class="hljs-string">]) &gt; 255 Then SetError(1) Return (-1) EndIf Next ; Converts netmask into a decimal </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$netmaskdec</span></span></span><span class="hljs-string"> = (</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$netmaskarray</span></span></span><span class="hljs-string">[1] * 16777216) + (</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$netmaskarray</span></span></span><span class="hljs-string">[2] * 65536) + (</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$netmaskarray</span></span></span><span class="hljs-string">[3] * 256) + </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$netmaskarray</span></span></span><span class="hljs-string">[4] ; Converts decimal netmask into binary (ex. 11111111111111111100000000000000) While </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$netmaskdec</span></span></span><span class="hljs-string"> &lt;&gt; 0 </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$binmod</span></span></span><span class="hljs-string"> = Mod(</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$netmaskdec</span></span></span><span class="hljs-string">, 2) </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$netmaskbinary</span></span></span><span class="hljs-string"> = </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$binmod</span></span></span><span class="hljs-string"> &amp; </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$netmaskbinary</span></span></span><span class="hljs-string"> </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$netmaskdec</span></span></span><span class="hljs-string"> = Int(</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$netmaskdec</span></span></span><span class="hljs-string"> / 2) WEnd ; Determines the "slash" value of the netmask </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$maskslash</span></span></span><span class="hljs-string"> = StringInStr(</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$netmaskbinary</span></span></span><span class="hljs-string">, "0", 1) - 1 ; Validates the "slash" value and netmask value If StringInStr(StringRight(</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$netmaskbinary</span></span></span><span class="hljs-string">, 32 - </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$maskslash</span></span></span><span class="hljs-string">), "1") Then If </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$netmaskarray</span></span></span><span class="hljs-string">[4] = "255" Then </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$maskslash</span></span></span><span class="hljs-string"> = 32 Else SetError(1) Return (-1) EndIf EndIf ; Creates arrays conatining subnet address, wilcard, and broadcast addresses For </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$i</span></span></span><span class="hljs-string"> = 1 To </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$iparray</span></span></span><span class="hljs-string">[0] </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$subnetaddarray</span></span></span><span class="hljs-string">[</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$i</span></span></span><span class="hljs-string">] = BitAND(</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$iparray</span></span></span><span class="hljs-string">[</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$i</span></span></span><span class="hljs-string">], </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$netmaskarray</span></span></span><span class="hljs-string">[</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$i</span></span></span><span class="hljs-string">]) </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$invmaskarray</span></span></span><span class="hljs-string">[</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$i</span></span></span><span class="hljs-string">] = BitNOT(</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$netmaskarray</span></span></span><span class="hljs-string">[</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$i</span></span></span><span class="hljs-string">] - 256) </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$broadcastaddarray</span></span></span><span class="hljs-string">[</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$i</span></span></span><span class="hljs-string">] = BitOR(</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$subnetaddarray</span></span></span><span class="hljs-string">[</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$i</span></span></span><span class="hljs-string">], </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$invmaskarray</span></span></span><span class="hljs-string">[</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$i</span></span></span><span class="hljs-string">]) Next ; Creates strings conatining subnet address, wilcard, and broadcast addresses </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$subnetadd</span></span></span><span class="hljs-string"> = </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$subnetaddarray</span></span></span><span class="hljs-string">[1] &amp; "." &amp; </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$subnetaddarray</span></span></span><span class="hljs-string">[2] &amp; "." &amp; </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$subnetaddarray</span></span></span><span class="hljs-string">[3] &amp; "." &amp;</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$subnetaddarray</span></span></span><span class="hljs-string">[4] </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$invmask</span></span></span><span class="hljs-string"> = </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$invmaskarray</span></span></span><span class="hljs-string">[1] &amp; "." &amp; </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$invmaskarray</span></span></span><span class="hljs-string">[2] &amp; "." &amp; </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$invmaskarray</span></span></span><span class="hljs-string">[3] &amp; "." &amp; </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$invmaskarray</span></span></span><span class="hljs-string">[4] </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$broadcastadd</span></span></span><span class="hljs-string"> = </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$broadcastaddarray</span></span></span><span class="hljs-string">[1] &amp; "." &amp; </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$broadcastaddarray</span></span></span><span class="hljs-string">[2] &amp; "." &amp; </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$broadcastaddarray</span></span></span><span class="hljs-string">[3] &amp; "." &amp; </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$broadcastaddarray</span></span></span><span class="hljs-string">[4] If </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$maskslash</span></span></span><span class="hljs-string"> = 32 Then </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$iprange</span></span></span><span class="hljs-string"> = </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$iparray</span></span></span><span class="hljs-string">[1] &amp; "." &amp; </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$iparray</span></span></span><span class="hljs-string">[2] &amp; "." &amp; </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$iparray</span></span></span><span class="hljs-string">[3] &amp; "." &amp; </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$iparray</span></span></span><span class="hljs-string">[4] </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$hosts</span></span></span><span class="hljs-string"> = 1 Else ; Determines the IP range for this subnet </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$iprange</span></span></span><span class="hljs-string"> = </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$subnetaddarray</span></span></span><span class="hljs-string">[1] &amp; "." &amp; </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$subnetaddarray</span></span></span><span class="hljs-string">[2] &amp; "." &amp; </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$subnetaddarray</span></span></span><span class="hljs-string">[3] &amp; "." &amp; </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$subnetaddarray</span></span></span><span class="hljs-string">[4] + 1 &amp; _ "-" &amp; </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$broadcastaddarray</span></span></span><span class="hljs-string">[1] &amp; "." &amp; </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$broadcastaddarray</span></span></span><span class="hljs-string">[2] &amp; "." &amp; </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$broadcastaddarray</span></span></span><span class="hljs-string">[3] &amp; "." &amp; </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$broadcastaddarray</span></span></span><span class="hljs-string">[4] - 1 ; Calculates number of available hosts on this subnet </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$hosts</span></span></span><span class="hljs-string"> = (</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$invmaskarray</span></span></span><span class="hljs-string">[4] + 1) * (</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$invmaskarray</span></span></span><span class="hljs-string">[3] + 1) * (</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$invmaskarray</span></span></span><span class="hljs-string">[2] + 1) * (</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$invmaskarray</span></span></span><span class="hljs-string">[1] + 1) - 2 EndIf </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$sSubnetinfo</span></span></span><span class="hljs-string">[1] = </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$subnetadd</span></span></span><span class="hljs-string"> </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$sSubnetinfo</span></span></span><span class="hljs-string">[2] = </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$broadcastadd</span></span></span><span class="hljs-string"> </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$sSubnetinfo</span></span></span><span class="hljs-string">[3] = </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$invmask</span></span></span><span class="hljs-string"> </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$sSubnetinfo</span></span></span><span class="hljs-string">[4] = </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$iprange</span></span></span><span class="hljs-string"> </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$sSubnetinfo</span></span></span><span class="hljs-string">[5] = </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$hosts</span></span></span><span class="hljs-string"> </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$sSubnetinfo</span></span></span><span class="hljs-string">[6] = </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$maskslash</span></span></span><span class="hljs-string"> Return (</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$sSubnetinfo</span></span></span><span class="hljs-string">) EndFunc Func _SameSub(</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$sIp</span></span></span><span class="hljs-string">, </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$sSubadd</span></span></span><span class="hljs-string">, </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$sBroadadd</span></span></span><span class="hljs-string">) Dim </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$iparray</span></span></span><span class="hljs-string">[5] Dim </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$subaddarray</span></span></span><span class="hljs-string">[5] Dim </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$broadaddarray</span></span></span><span class="hljs-string">[5] </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$iparray</span></span></span><span class="hljs-string"> = StringSplit(</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$sIp</span></span></span><span class="hljs-string">, ".") </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$subaddarray</span></span></span><span class="hljs-string"> = StringSplit(</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$sSubadd</span></span></span><span class="hljs-string">, ".") </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$broadaddarray</span></span></span><span class="hljs-string"> = StringSplit(</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$sBroadadd</span></span></span><span class="hljs-string">, ".") For </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$i</span></span></span><span class="hljs-string"> = 1 To 4 If Number(</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$iparray</span></span></span><span class="hljs-string">[</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$i</span></span></span><span class="hljs-string">]) &lt; 0 Or Number(</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$iparray</span></span></span><span class="hljs-string">[</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$i</span></span></span><span class="hljs-string">]) &gt; 255 Then SetError(1) Return (-1) EndIf If Number(</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$subaddarray</span></span></span><span class="hljs-string">[</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$i</span></span></span><span class="hljs-string">]) &lt; 0 Or Number(</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$subaddarray</span></span></span><span class="hljs-string">[</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$i</span></span></span><span class="hljs-string">]) &gt; 255 Then SetError(1) Return (-2) EndIf If Number(</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$broadaddarray</span></span></span><span class="hljs-string">[</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$i</span></span></span><span class="hljs-string">]) &lt; 0 Or Number(</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$broadaddarray</span></span></span><span class="hljs-string">[</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$i</span></span></span><span class="hljs-string">]) &gt; 255 Then SetError(1) Return (-3) EndIf Next </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$ipint</span></span></span><span class="hljs-string"> = (</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$iparray</span></span></span><span class="hljs-string">[1] * 16777216) + (</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$iparray</span></span></span><span class="hljs-string">[2] * 65536) + (</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$iparray</span></span></span><span class="hljs-string">[3] * 256) + </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$iparray</span></span></span><span class="hljs-string">[4] </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$subaddint</span></span></span><span class="hljs-string"> = (</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$subaddarray</span></span></span><span class="hljs-string">[1] * 16777216) + (</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$subaddarray</span></span></span><span class="hljs-string">[2] * 65536) + (</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$subaddarray</span></span></span><span class="hljs-string">[3] * 256) + </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$subaddarray</span></span></span><span class="hljs-string">[4] </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$broadaddint</span></span></span><span class="hljs-string"> = (</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$broadaddarray</span></span></span><span class="hljs-string">[1] * 16777216) + (</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$broadaddarray</span></span></span><span class="hljs-string">[2] * 65536) + (</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$broadaddarray</span></span></span><span class="hljs-string">[3] * 256) + </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$broadaddarray</span></span></span><span class="hljs-string">[4] If </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$ipint</span></span></span><span class="hljs-string"> &gt; </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$subaddint</span></span></span><span class="hljs-string"> And </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$ipint</span></span></span><span class="hljs-string"> &lt; </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$broadaddint</span></span></span><span class="hljs-string"> Then Return (1) Else Return (0) EndIf EndFunc</span></span></code> </pre></div></div><br><p>  It remains to execute the resulting script on MikroTik after the configuration has been reset, in any convenient way: via the / system script, use the saved file and reset the configuration as shown in the picture: </p><br><p><img src="https://habrastorage.org/files/cec/677/1c5/cec6771c51224a5fa7a517ddda4eb847.jpg" alt="image alt text"></p><br><p>  Now, to set up a new MikroTik, it is enough to launch the program, specify individual settings in the GUI, get the setup script and transfer it to the router.  It remains to bring to mind the configuration of the router in the proposed central office. </p><br><h1 id="nastroyka-d-link-dfl">  Configure D-Link DFL </h1><br><p>  Setting up the DFL is more convenient through the console.  This type of setting is also amenable to automation, for example using the <strong>Plink</strong> tool from the creator of <a href="http://www.chiark.greenend.org.uk/~sgtatham/putty/">Putty</a> . </p><br><p>  The concept of transferring commands to an open console cannot be called ideal, but in the case of D-Link DFL, you can use its own ‚Äúscripts‚Äù.  As an example, consider the function that is used in conjunction with the previously described.  If MikroTik needs to be configured from scratch, then on the DFL it is enough to create an IPsec tunnel and include it in the interface group in order to apply the built-in firewall rules. </p><br><p><img src="https://habrastorage.org/files/1b2/cfb/d8f/1b2cfbd8fc1048288be4f484c65fb745.jpg" alt="image alt text"></p><br><p>  <em>The settings window is much simpler, because in our case DFL does not need to be configured from scratch.</em> </p><br><p>  To access the router via SSH, you will need <strong>Plink</strong> , as well as <strong>Pscp</strong> to transfer files ‚Äî you just need to set the path to the executable files in the script. </p><br><pre> <code class="hljs perl"><span class="hljs-keyword"><span class="hljs-keyword">local</span></span> $_plink_loc = <span class="hljs-string"><span class="hljs-string">"\\server\share\plink.exe"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">local</span></span> $scploc=<span class="hljs-string"><span class="hljs-string">"\\server\share\pscp.exe"</span></span></code> </pre><br><p>  When Plink and Pscp are working, there is a feature: if password authentication is used, then when you first connect or replace equipment, you will be asked to make a print in the registry.  You can bypass the request by passing "Y" to the console window. </p><br><pre> <code class="hljs mel">$_plinkhandle = Run(@comspec &amp; <span class="hljs-string"><span class="hljs-string">" /c "</span></span> &amp; $_plink_loc &amp; <span class="hljs-string"><span class="hljs-string">" -ssh admin@"</span></span> &amp; $_plinkserver &amp;<span class="hljs-string"><span class="hljs-string">" -pw MegaPass"</span></span>,<span class="hljs-string"><span class="hljs-string">""</span></span>,@SW_HIDE,<span class="hljs-number"><span class="hljs-number">7</span></span>) sleep (<span class="hljs-number"><span class="hljs-number">500</span></span>) StdinWrite($_plinkhandle, <span class="hljs-string"><span class="hljs-string">"y"</span></span>&amp; @CR)</code> </pre><br><p>  DFL works with objects at the group level.  Since it is impossible to add an object to a group without listing all its members, I generate a script on the DFL, create a script, take it as a file and change it.     : </p><br><pre> <code class="dos hljs">script -create InterfaceGroup VPNs -name=vpns.sgs</code> </pre><br><p>     SCP.     script.sgs          ,      D-Link  SCP   . </p><br><pre> <code class="dos hljs">script -execute -name=script.sgs</code> </pre><br><p>          </p><br><pre> <code class="dos hljs">script -remove -name=script.sgs</code> </pre><br><div class="spoiler"> <b class="spoiler_title">  </b> <div class="spoiler_text"><pre> <code class="hljs perl">func _dfl($lanip8=<span class="hljs-string"><span class="hljs-string">""</span></span>,$PSK8=<span class="hljs-string"><span class="hljs-string">""</span></span>,$ipext8=<span class="hljs-string"><span class="hljs-string">""</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">local</span></span> $file = @TempDir &amp;<span class="hljs-string"><span class="hljs-string">"\script.sgs"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">local</span></span> $file1 = @TempDir &amp;<span class="hljs-string"><span class="hljs-string">"\script1.sgs"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> FileExists($file) then FileDelete($file) EndIf <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> FileExists($file1) then FileDelete($file1) EndIf ;  .      <span class="hljs-keyword"><span class="hljs-keyword">local</span></span> $_plink_loc = <span class="hljs-string"><span class="hljs-string">"\\server\share\plink.exe"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">local</span></span> $scploc=<span class="hljs-string"><span class="hljs-string">"\\server\share\pscp.exe"</span></span> Local $_plinkserver = <span class="hljs-string"><span class="hljs-string">" DFL"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">local</span></span> $magazname <span class="hljs-keyword"><span class="hljs-keyword">local</span></span> $magaznumber <span class="hljs-keyword"><span class="hljs-keyword">local</span></span> $lanip <span class="hljs-keyword"><span class="hljs-keyword">local</span></span> $ipext <span class="hljs-keyword"><span class="hljs-keyword">local</span></span> $PSK $hgui = GUICreate(<span class="hljs-string"><span class="hljs-string">" DFL"</span></span> , <span class="hljs-number"><span class="hljs-number">300</span></span>, <span class="hljs-number"><span class="hljs-number">270</span></span>) GUICtrlCreateLabel(<span class="hljs-string"><span class="hljs-string">"    "</span></span>,<span class="hljs-number"><span class="hljs-number">2</span></span>,<span class="hljs-number"><span class="hljs-number">2</span></span>) $lanip1 = _GUICtrlIpAddress_Create($hgui, <span class="hljs-number"><span class="hljs-number">10</span></span>, <span class="hljs-number"><span class="hljs-number">20</span></span>) GUICtrlCreateLabel(<span class="hljs-string"><span class="hljs-string">"  "</span></span>,<span class="hljs-number"><span class="hljs-number">2</span></span>,<span class="hljs-number"><span class="hljs-number">45</span></span>) $ipext1 = _GUICtrlIpAddress_Create($hgui, <span class="hljs-number"><span class="hljs-number">10</span></span>, <span class="hljs-number"><span class="hljs-number">65</span></span>) GUICtrlCreateLabel(<span class="hljs-string"><span class="hljs-string">"   "</span></span>,<span class="hljs-number"><span class="hljs-number">2</span></span>,<span class="hljs-number"><span class="hljs-number">90</span></span>) $secret1 = GUICtrlCreateInput(<span class="hljs-string"><span class="hljs-string">""</span></span>,<span class="hljs-number"><span class="hljs-number">10</span></span>, <span class="hljs-number"><span class="hljs-number">110</span></span>) GUICtrlCreateLabel(<span class="hljs-string"><span class="hljs-string">"   "</span></span>,<span class="hljs-number"><span class="hljs-number">2</span></span>,<span class="hljs-number"><span class="hljs-number">130</span></span>) $name1=GUICtrlCreateInput(<span class="hljs-string"><span class="hljs-string">""</span></span>,<span class="hljs-number"><span class="hljs-number">10</span></span>, <span class="hljs-number"><span class="hljs-number">150</span></span>) GUICtrlCreateLabel(<span class="hljs-string"><span class="hljs-string">"   (77  NN88)"</span></span>,<span class="hljs-number"><span class="hljs-number">2</span></span>,<span class="hljs-number"><span class="hljs-number">170</span></span>) $number1=GUICtrlCreateInput(<span class="hljs-string"><span class="hljs-string">""</span></span>,<span class="hljs-number"><span class="hljs-number">10</span></span>, <span class="hljs-number"><span class="hljs-number">190</span></span>) $OK_Btn = GUICtrlCreateButton(<span class="hljs-string"><span class="hljs-string">""</span></span>, <span class="hljs-number"><span class="hljs-number">75</span></span>,<span class="hljs-number"><span class="hljs-number">230</span></span> , <span class="hljs-number"><span class="hljs-number">70</span></span>, <span class="hljs-number"><span class="hljs-number">25</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> $PSK8 = <span class="hljs-string"><span class="hljs-string">""</span></span> Then GUICtrlSetData($secret1,_Crypto_GetRandomString(<span class="hljs-number"><span class="hljs-number">12</span></span>,<span class="hljs-number"><span class="hljs-number">7</span></span>)) Else GUICtrlSetData($secret1,$PSK8) EndIf _GUICtrlIpAddress_Set($ipext1, $ipext8) _GUICtrlIpAddress_Set($lanip1, $lanip8) GUISetState(@SW_SHOW) While <span class="hljs-number"><span class="hljs-number">1</span></span> $msg = GUIGetMsg() Select Case $msg = $GUI_EVENT_CLOSE Exit Case $msg = $OK_Btn $lanip=_GUICtrlIpAddress_Get($lanip1) $ipext=_GUICtrlIpAddress_Get($ipext1) $PSK=GUICtrlRead($secret1) $magazname=GUICtrlRead($name1) $magaznumber=GUICtrlRead($number1) $lanip2=_GUICtrlIpAddress_GetArray($lanip1) ;   <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> $lanip = <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">or</span></span> $ipext=<span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">or</span></span> StringLen($PSK)=<span class="hljs-number"><span class="hljs-number">0</span></span> then MsgBox(<span class="hljs-number"><span class="hljs-number">4160</span></span>, <span class="hljs-string"><span class="hljs-string">"Information"</span></span>, <span class="hljs-string"><span class="hljs-string">"  "</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> StringRegExp($magazname,<span class="hljs-string"><span class="hljs-string">"[0-9a-zA-Z_]"</span></span>) =<span class="hljs-number"><span class="hljs-number">0</span></span> then MsgBox(<span class="hljs-number"><span class="hljs-number">4160</span></span>, <span class="hljs-string"><span class="hljs-string">"Information"</span></span>, <span class="hljs-string"><span class="hljs-string">" !"</span></span>) Else <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> $lanip2[<span class="hljs-number"><span class="hljs-number">3</span></span>]&lt;&gt;<span class="hljs-number"><span class="hljs-number">1</span></span> Then MsgBox(<span class="hljs-number"><span class="hljs-number">4160</span></span>, <span class="hljs-string"><span class="hljs-string">"Information"</span></span>, <span class="hljs-string"><span class="hljs-string">"    .1  !"</span></span>) Else GUIDelete() ExitLoop EndIf EndIf EndIf EndSelect WEnd $_plinkhandle = Run(@comspec &amp; <span class="hljs-string"><span class="hljs-string">" /c "</span></span> &amp; $_plink_loc &amp; <span class="hljs-string"><span class="hljs-string">" -ssh admin@" &amp; $_plinkserver &amp;"</span></span> -pw MegaPass<span class="hljs-string"><span class="hljs-string">","</span></span><span class="hljs-string"><span class="hljs-string">",@SW_HIDE,7) sleep (500) ;DFL  .      . ;        , ... StdinWrite($_plinkhandle, "</span></span><span class="hljs-keyword"><span class="hljs-keyword">y</span></span><span class="hljs-string"><span class="hljs-string">"&amp; @CR) sleep (500) StdinWrite($_plinkhandle, "</span></span>script -remove -name=vpns.sgs <span class="hljs-string"><span class="hljs-string">"&amp; @CR) sleep (500) StdinWrite($_plinkhandle, "</span></span>script -remove -name=script.sgs <span class="hljs-string"><span class="hljs-string">"&amp; @CR) sleep (500) ;      -  . StdinWrite($_plinkhandle, "</span></span>script -create InterfaceGroup VPNs -name=vpns.sgs <span class="hljs-string"><span class="hljs-string">"&amp; @CR) sleep (500) StdinWrite($_plinkhandle, "</span></span>Exit <span class="hljs-string"><span class="hljs-string">" &amp; @CR) sleep (250) ProcessClose("</span></span>plink.exe<span class="hljs-string"><span class="hljs-string">") RunWait(@comspec &amp; "</span></span> /c <span class="hljs-string"><span class="hljs-string">" &amp; $scploc &amp; "</span></span> -pw MegaPass admin@"&amp;$_plinkserver&amp;<span class="hljs-string"><span class="hljs-string">":script/vpns.sgs "</span></span> &amp; $file,<span class="hljs-string"><span class="hljs-string">""</span></span>,@SW_HIDE,<span class="hljs-number"><span class="hljs-number">7</span></span>) $line = FileReadLine($file,<span class="hljs-number"><span class="hljs-number">1</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">local</span></span> $lannet=StringMid($lanip,<span class="hljs-number"><span class="hljs-number">1</span></span>,StringLen($lanip)-<span class="hljs-number"><span class="hljs-number">1</span></span>)&amp;<span class="hljs-string"><span class="hljs-string">"0/24"</span></span> FileOpen ( $file, <span class="hljs-number"><span class="hljs-number">2</span></span>) FileWriteLine ( $file, <span class="hljs-string"><span class="hljs-string">"cc AddressFolder VpnAdresses"</span></span>) FileWriteLine ( $file, <span class="hljs-string"><span class="hljs-string">"add IP4Address Pool"</span></span>&amp;$magaznumber&amp;<span class="hljs-string"><span class="hljs-string">"_"</span></span>&amp;$magazname&amp;<span class="hljs-string"><span class="hljs-string">" Address="</span></span>&amp;$lannet&amp;<span class="hljs-string"><span class="hljs-string">" -silent"</span></span>) FileWriteLine ( $file, <span class="hljs-string"><span class="hljs-string">"add IP4Address Ip"</span></span>&amp;$magaznumber&amp;<span class="hljs-string"><span class="hljs-string">"_"</span></span>&amp;$magazname&amp;<span class="hljs-string"><span class="hljs-string">" Address="</span></span>&amp;$ipext&amp;<span class="hljs-string"><span class="hljs-string">" -silent"</span></span>) FileWriteLine ( $file, <span class="hljs-string"><span class="hljs-string">"add IP4Address Router"</span></span>&amp;$magaznumber&amp;<span class="hljs-string"><span class="hljs-string">"_"</span></span>&amp;$magazname&amp;<span class="hljs-string"><span class="hljs-string">" Address="</span></span>&amp;$lanip&amp;<span class="hljs-string"><span class="hljs-string">" -silent"</span></span>) FileWriteLine ( $file, <span class="hljs-string"><span class="hljs-string">"cc .."</span></span>) FileWriteLine ( $file, <span class="hljs-string"><span class="hljs-string">"add PSK Key_"</span></span>&amp;$magaznumber&amp;<span class="hljs-string"><span class="hljs-string">"_"</span></span>&amp;$magazname&amp;<span class="hljs-string"><span class="hljs-string">" Type=ASCII PSKAscii="</span></span>&amp;$PSK&amp;<span class="hljs-string"><span class="hljs-string">" Comments="</span></span>&amp;$PSK&amp;<span class="hljs-string"><span class="hljs-string">" -silent"</span></span>) ;  DFL   FileWriteLine ( $file, <span class="hljs-string"><span class="hljs-string">"add IPsecTunnel Magaz_"</span></span>&amp;$magazname&amp;<span class="hljs-string"><span class="hljs-string">" LocalNetwork=InterfaceAddresses/lannet RemoteNetwork=VpnAdresses/Pool"</span></span>&amp;$magaznumber&amp;<span class="hljs-string"><span class="hljs-string">"_"</span></span>&amp;$magazname&amp;<span class="hljs-string"><span class="hljs-string">" RemoteEndpoint=VpnAdresses/Ip"</span></span>&amp;$magaznumber&amp;<span class="hljs-string"><span class="hljs-string">"_"</span></span>&amp;$magazname&amp;<span class="hljs-string"><span class="hljs-string">" IKEAlgorithms=High IPsecAlgorithms=High AuthMethod=PSK PSK=Key_"</span></span>&amp;$magaznumber&amp;<span class="hljs-string"><span class="hljs-string">"_"</span></span>&amp;$magazname&amp;<span class="hljs-string"><span class="hljs-string">" PFS=PFS KeepAlive=Manual KeepAliveSourceIP=VpnAdresses/Router_Main KeepAliveDestinationIP=VpnAdresses/Router"</span></span>&amp;$magaznumber&amp;<span class="hljs-string"><span class="hljs-string">"_"</span></span>&amp;$magazname&amp;<span class="hljs-string"><span class="hljs-string">" index=57 -silent"</span></span>) $line=StringReplace ( $line, <span class="hljs-string"><span class="hljs-string">"add"</span></span>, <span class="hljs-string"><span class="hljs-string">"set"</span></span> ,<span class="hljs-number"><span class="hljs-number">1</span></span>,<span class="hljs-number"><span class="hljs-number">1</span></span> ) $line=StringReplace ( $line, <span class="hljs-string"><span class="hljs-string">" -silent"</span></span>, <span class="hljs-string"><span class="hljs-string">""</span></span> ,<span class="hljs-number"><span class="hljs-number">1</span></span>,<span class="hljs-number"><span class="hljs-number">1</span></span> ) $line=StringReplace ( $line, <span class="hljs-string"><span class="hljs-string">" -force"</span></span>, <span class="hljs-string"><span class="hljs-string">""</span></span> ,<span class="hljs-number"><span class="hljs-number">1</span></span>,<span class="hljs-number"><span class="hljs-number">1</span></span> ) $line=_StringInsert($line, <span class="hljs-string"><span class="hljs-string">", "</span></span>&amp; <span class="hljs-string"><span class="hljs-string">"Magaz_"</span></span>&amp;$magazname, -<span class="hljs-number"><span class="hljs-number">1</span></span>) FileWriteLine ( $file, $line) FileCLose($file) FileCopy($file,$file1) RunWait(@comspec &amp; <span class="hljs-string"><span class="hljs-string">" /c "</span></span> &amp; $scploc &amp; <span class="hljs-string"><span class="hljs-string">" -pw MegaPass "</span></span> &amp; $file1 &amp; <span class="hljs-string"><span class="hljs-string">" admin@"&amp;$_plinkserver&amp;"</span></span>:script/script.sgs<span class="hljs-string"><span class="hljs-string">","</span></span><span class="hljs-string"><span class="hljs-string">",@SW_HIDE,7) $_plinkhandle = Run(@comspec &amp; "</span></span> /c <span class="hljs-string"><span class="hljs-string">" &amp; $_plink_loc &amp; "</span></span> -ssh admin@" &amp; $_plinkserver &amp;<span class="hljs-string"><span class="hljs-string">" -pw QfJatp123"</span></span>,<span class="hljs-string"><span class="hljs-string">""</span></span>,@SW_HIDE,<span class="hljs-number"><span class="hljs-number">7</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">sleep</span></span> (<span class="hljs-number"><span class="hljs-number">500</span></span>) StdinWrite($_plinkhandle, <span class="hljs-string"><span class="hljs-string">"script -execute -name=script.sgs "</span></span>&amp; @CR) <span class="hljs-keyword"><span class="hljs-keyword">sleep</span></span> (<span class="hljs-number"><span class="hljs-number">250</span></span>) StdinWrite($_plinkhandle, <span class="hljs-string"><span class="hljs-string">"activate "</span></span>&amp; @CR) <span class="hljs-keyword"><span class="hljs-keyword">sleep</span></span> (<span class="hljs-number"><span class="hljs-number">10000</span></span>) StdinWrite($_plinkhandle, <span class="hljs-string"><span class="hljs-string">"commit "</span></span>&amp; @CR) <span class="hljs-keyword"><span class="hljs-keyword">sleep</span></span> (<span class="hljs-number"><span class="hljs-number">250</span></span>) StdinWrite($_plinkhandle, <span class="hljs-string"><span class="hljs-string">"exit "</span></span>&amp; @CR) <span class="hljs-keyword"><span class="hljs-keyword">sleep</span></span> (<span class="hljs-number"><span class="hljs-number">250</span></span>) ProcessClose(<span class="hljs-string"><span class="hljs-string">"plink.exe"</span></span>) EndFunc</code> </pre></div></div><br><p> ,         . </p><br><h1 id="pashalka-rezervnoe-kopirovanie-d-link-dfl"> :   D-Link DFL </h1><br><p>       DFL   : full.bak  config.bak.  ,        .          SCP    .             ‚Äì     . </p><br><pre> <code class="hljs mel">#include &lt;Date.au3&gt; #Include &lt;File.au3&gt; Local $_plinkserver = <span class="hljs-string"><span class="hljs-string">" dfl"</span></span> local $scploc=<span class="hljs-string"><span class="hljs-string">"\\server\share\pscp.exe"</span></span> local $path=@ScriptDir&amp;<span class="hljs-string"><span class="hljs-string">"\" $date1=@YEAR&amp;@MON&amp;@MDAY local $file = $path &amp;"</span></span>config-<span class="hljs-string"><span class="hljs-string">"&amp;$date1&amp;"</span></span>.bak<span class="hljs-string"><span class="hljs-string">" $handle=Run(@comspec &amp; "</span></span> /c <span class="hljs-string"><span class="hljs-string">" &amp; $scploc &amp; "</span></span> -pw MegaPass admin@"&amp;$_plinkserver&amp;<span class="hljs-string"><span class="hljs-string">":config.bak "</span></span> &amp; $file,<span class="hljs-string"><span class="hljs-string">""</span></span>,@SW_HIDE,<span class="hljs-number"><span class="hljs-number">7</span></span>) sleep (<span class="hljs-number"><span class="hljs-number">500</span></span>) StdinWrite($_plinkhandle, <span class="hljs-string"><span class="hljs-string">"y"</span></span>&amp; @CR) sleep (<span class="hljs-number"><span class="hljs-number">500</span></span>) $file = $path &amp;<span class="hljs-string"><span class="hljs-string">"full-"</span></span>&amp;$date1&amp;<span class="hljs-string"><span class="hljs-string">".bak"</span></span> RunWait(@comspec &amp; <span class="hljs-string"><span class="hljs-string">" /c "</span></span> &amp; $scploc &amp; <span class="hljs-string"><span class="hljs-string">" -pw MegaPass admin@"</span></span>&amp;$_plinkserver&amp;<span class="hljs-string"><span class="hljs-string">":full.bak "</span></span> &amp; $file,<span class="hljs-string"><span class="hljs-string">""</span></span>,@SW_HIDE,<span class="hljs-number"><span class="hljs-number">7</span></span>) ;   ;  ,      <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> FileExists($path &amp;<span class="hljs-string"><span class="hljs-string">"full-"</span></span>&amp;$date1&amp;<span class="hljs-string"><span class="hljs-string">".bak"</span></span>) and FileExists($file = $path &amp;<span class="hljs-string"><span class="hljs-string">"config-"</span></span>&amp;$date1&amp;<span class="hljs-string"><span class="hljs-string">".bak"</span></span>) Then $files = _FileListToArray($path, <span class="hljs-string"><span class="hljs-string">"*.bak"</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>,True) $date=@YEAR&amp;<span class="hljs-string"><span class="hljs-string">"/"</span></span>&amp;@MON&amp;<span class="hljs-string"><span class="hljs-string">"/"</span></span>&amp;@MDAY $newdate=_DateAdd(<span class="hljs-string"><span class="hljs-string">"D"</span></span>,<span class="hljs-number"><span class="hljs-number">-14</span></span>,$date) $formatdate=StringSplit($newdate,<span class="hljs-string"><span class="hljs-string">"/"</span></span>) $newdate=$formatdate[<span class="hljs-number"><span class="hljs-number">1</span></span>]&amp;$formatdate[<span class="hljs-number"><span class="hljs-number">2</span></span>]&amp;$formatdate[<span class="hljs-number"><span class="hljs-number">3</span></span>]&amp;@HOUR&amp;@MIN&amp;@SEC If IsArray($files) Then For $i = <span class="hljs-number"><span class="hljs-number">1</span></span> To UBound($files) - <span class="hljs-number"><span class="hljs-number">1</span></span> $aTime = FileGetTime( $files[$i], <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>) If $aTime &lt; $newdate Then FileDelete($files[$i]) EndIf Next EndIf EndIf</code> </pre><br><p><img src="https://habrastorage.org/files/e56/3d9/562/e563d95629e0446582c83c8292bae3c3.jpg" alt="image alt text"></p><br><p>      DFL. </p><br><h1 id="itogo">  Total </h1><br><p> ,         ,  -    .         SNMP   <a href="http://wiki.mikrotik.com/wiki/Manual:API">API  </a> .                   Mikrotik .  ,   . </p><br><p> <strong>           ‚Äì    !</strong> </p></div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <p>Source: <a href="https://habr.com/ru/post/321028/">https://habr.com/ru/post/321028/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../321018/index.html">What is crowd marketing?</a></li>
<li><a href="../321020/index.html">How IT professionals work. SearchInform development manager Dmitry Gatsura</a></li>
<li><a href="../321022/index.html">YouTube Video Text Search</a></li>
<li><a href="../321024/index.html">Class'y Class'y</a></li>
<li><a href="../321026/index.html">How we got smarter and learned how to open quests twice as fast</a></li>
<li><a href="../321030/index.html">Data engineer climb</a></li>
<li><a href="../321032/index.html">Using Sketchode 2 in Development: An Overview</a></li>
<li><a href="../321034/index.html">Managing complexity in ruby ‚Äã‚Äãon rails projects. Part 3</a></li>
<li><a href="../321036/index.html">How it all began: developers remember the first games they created</a></li>
<li><a href="../321038/index.html">The history of the creation of the first game on Unity - from idea to release</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>