<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Writing Guard</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hi, Habr! There are several ways to validate arguments. For example, to check for null you can use: 


1. if (! ReferenceEquals (arg, null)) throw ......">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Writing Guard</h1><div class="post__text post__text-html js-mediator-article"><p><img src="https://habrastorage.org/web/bcb/8bc/056/bcb8bc056a8147839ee16e5b162f65eb.jpg"></p><br><p>  Hi, Habr!  There are several ways to validate arguments.  For example, to check for null you can use: </p><br><ol><li>  if (! ReferenceEquals (arg, null)) throw ... </li><li>  <a href="https://msdn.microsoft.com/ru-ru/library/dd264808.aspx">Code Contracts</a> : Contract.Requires (! ReferenceEquals (arg, null)) </li><li>  Guard.IsNotNull (arg, nameof (arg)) </li></ol><br><p>  In the article I will consider only the third option (all code samples are for C #, however some of them will be useful in Java). </p><a name="habracut"></a><br><h1 id="oshibka-1-ne-podgotovilis-k-proverkam-argumentov-i-v-tele-metoda">  Error number 1: not prepared for the checks of the arguments and in the body of the method </h1><br><p>  Most often in a project, to eliminate copying of the same code, someone creates a static class in which you can check the field for null, more than zero, etc. </p><br><p>  However, in this case it is forgotten that one and the same verification can be extremely useful for validating arguments (in this case, the name of the argument is passed as an additional parameter), and for checking inside the method (in this case, another exception is thrown). </p><br><p> So, for a start it is best to agree in advance on the naming of both cases.  For example, <code>Guard.IsNotNull</code> for the body of the method and <code>Guard.ArgumentIsNotNull</code> for the arguments </p><br><h1 id="oshibka-2-vyzov-stringformat-pri-kazhdoy-proverke">  Error number 2: call string.format with each check </h1><br><p>  Immediately examples of erroneous code: </p><br><pre> <code class="hljs sql">Guard.IsNotNull(connection, $"Unable to setup connection <span class="hljs-keyword"><span class="hljs-keyword">with</span></span> host {host} <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> port {port}<span class="hljs-string"><span class="hljs-string">") Guard.IsNotNull(connection, string.Format("</span></span>Unable <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> setup <span class="hljs-keyword"><span class="hljs-keyword">connection</span></span> <span class="hljs-keyword"><span class="hljs-keyword">with</span></span> host {<span class="hljs-number"><span class="hljs-number">0</span></span>} <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> port {<span class="hljs-number"><span class="hljs-number">1</span></span>}<span class="hljs-string"><span class="hljs-string">", host, port)) //     </span></span></code> </pre> <br><p>  Both examples above generate a string for each check (in theory, all Guard do not throw exceptions on the combat server, that is, we generate quite a few lines just to be eaten by the garbage collector). </p><br><p>  Corrected version: </p><br><pre> <code class="hljs cs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">Guard</span></span> { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">IsNotNull</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">object</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">value</span></span></span></span><span class="hljs-function"><span class="hljs-params">, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> format, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">params</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">object</span></span></span></span><span class="hljs-function"><span class="hljs-params">[] formattingArgs</span></span></span><span class="hljs-function">) </span><span class="hljs-comment"><span class="hljs-function"><span class="hljs-comment">//        ,            }</span></span></span></span></code> </pre> <br><p>  In fact, the option above is also bad.  It does not create a string anymore, but for each method call a new array formattingArgs is created.  Of course, less memory is allocated for it, but such methods will still load on the garbage collector. </p><br><p>  The most annoying thing is that the program will slow down, but simple profiling will not cause a problem.  Your program will simply stop to clear memory more often (I fixed this error in one of the programs, garbage collection began to occupy instead of the previous 15% only 5%). </p><br><p>  So, we <a href="https://msdn.microsoft.com/ru-ru/library/system.string.format.aspx">proceed</a> in the same way as done in <a href="https://msdn.microsoft.com/ru-ru/library/system.string.format.aspx">string.Format</a> : we generate more methods for different numbers of arguments. </p><br><pre> <code class="hljs cs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">Guard</span></span> { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">IsNotNull</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">object</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">value</span></span></span></span><span class="hljs-function"><span class="hljs-params">, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> errorMessage</span></span></span><span class="hljs-function">) </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">IsNotNull</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">object</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">value</span></span></span></span><span class="hljs-function"><span class="hljs-params">, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> errorMessageFormat, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">object</span></span></span></span><span class="hljs-function"><span class="hljs-params"> arg1</span></span></span><span class="hljs-function">) </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">IsNotNull</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">object</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">value</span></span></span></span><span class="hljs-function"><span class="hljs-params">, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> errorMessageFormat, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">object</span></span></span></span><span class="hljs-function"><span class="hljs-params"> arg1, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">object</span></span></span></span><span class="hljs-function"><span class="hljs-params"> arg2</span></span></span><span class="hljs-function">) </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">IsNotNull</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">object</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">value</span></span></span></span><span class="hljs-function"><span class="hljs-params">, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> errorMessageFormat, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">object</span></span></span></span><span class="hljs-function"><span class="hljs-params"> arg1, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">object</span></span></span></span><span class="hljs-function"><span class="hljs-params"> arg2, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">object</span></span></span></span><span class="hljs-function"><span class="hljs-params"> arg3</span></span></span><span class="hljs-function">) }</span></span></code> </pre> <br><p>  So, now the array will not be allocated.  However, we automatically received a new problem - Boxing. <br>  Consider the method call: <code>Guard.IsNotNull(connection, "Unable to setup connection with host {0} and port {1}", host, port)</code> .  The variable port is of type int (most often at least). </p><br><p>  It turns out that in order to pass a variable by value, .Net will create an int each time on the heap to pass it as an object.  This situation will occur much less frequently, but it will still be. </p><br><p>  And another problem - if the original object being checked is the value type (for example, we check for null in a generic method that has no type restrictions). <br>  You can fix this by creating Generic methods for checks: </p><br><pre> <code class="hljs cs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">Guard</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">void</span></span> IsNotNull&lt;TObject&gt;(TObject <span class="hljs-keyword"><span class="hljs-keyword">value</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> errorMessage) <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">void</span></span> IsNotNull&lt;TObject, TArg1&gt;(TObject <span class="hljs-keyword"><span class="hljs-keyword">value</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> errorMessageFormat, TArg1 arg1) <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">void</span></span> IsNotNull&lt;TObject, TArg1, TArg2&gt;(TObject <span class="hljs-keyword"><span class="hljs-keyword">value</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> errorMessageFormat, TArg1 arg1, TArg2 arg2) <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">void</span></span> IsNotNull&lt;TObject, TArg1, TArg2, TArg3&gt;(TObject <span class="hljs-keyword"><span class="hljs-keyword">value</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> errorMessageFormat, TArg1 arg1, TArg2 arg2, TArg3 arg3) }</code> </pre> <br><h1 id="oshibka-3-otsutstvie-kodogeneracii">  Error number 3: no code generation </h1><br><p>  As can be seen above, in order to conveniently check the values ‚Äã‚Äãfor null, we need: </p><br><ol><li>  Create two sets of functions - for checking the arguments and for checking in the body of the method </li><li>  In each set - create a bunch of duplicates, which will contain the same code </li></ol><br><p>  Without code generation, it is relatively difficult to add new functions, much less change them. </p><br><h1 id="esche-uluchsheniya">  More improvements </h1><br><p>  The points below do not speed up your program, but just slightly improve readability. </p><br><h2 id="resharper-annotations">  ReSharper Annotations </h2><br><p>  Often ReSharper swears that the value may be null, although it seems to be checked with the help of Guard.  In this case, you can either start gradually to block warnings in the code (which may be fraught), or explain to the verifier that everything is fine.  The full list of attributes <a href="https://www.jetbrains.com/help/resharper/Reference__Code_Annotation_Attributes.html">can be viewed here</a> , but here are useful for us: </p><br><ul><li>  <a href="https://www.jetbrains.com/help/resharper/Reference__Code_Annotation_Attributes.html">AssertionMethodAttribute and AssertionConditionAttribute</a> - the two of them will explain to the system that the method only checks the argument, and at the same time they will write down what they are checking </li><li>  <a href="https://www.jetbrains.com/help/resharper/Reference__Code_Annotation_Attributes.html">NoEnumerationAttribute</a> - shows that if you pass an IEnumerable to the input, then nobody will iterate over it </li><li>  <a href="https://www.jetbrains.com/help/resharper/Reference__Code_Annotation_Attributes.html">CollectionAccessAttribute</a> - if you suddenly decide to check all the arguments of the collection (for example, that there are no more than five, and that they are not null), then using this attribute you can tell what exactly happens to the collection (read, write, etc.) </li><li>  <a href="https://www.jetbrains.com/help/resharper/Reference__Code_Annotation_Attributes.html">StringFormatMethodAttribute</a> - explains that one of the parameters is a string, which will then be used as a format.  In this case, it will additionally be checked that it can be parsed by string.Format, that the number of arguments corresponds to the expectations, etc.  Incidentally, I have not yet seen a project in which this check would be disabled, and in which, after it was turned on, there would be no errors that string.Format simply could not be executed </li></ul><br><h2 id="zapisyvat-bolshe-informacii">  Record more information </h2><br><p>  In theory, the number of exceptions to our functions on combat servers should be the smallest.  Consequently, any actuation of them should carry a maximum of information: what actually happened (after all, the situation is rare).  At a minimum, it is best to include in the text: </p><br><ol><li>  Type (or better call ToString from him), which turned out to be incorrect. </li><li>  If there are more arguments for comparison, then information about them too. </li><li>  Full stacktrace (because otherwise it is trimmed to the place where the exception was caught) </li></ol><br><h1 id="zaklyuchenie">  Conclusion </h1><br><p>  I hope this article will help you to relatively easily improve the checks in your code. <br>  A little earlier, I implemented all the developments in the <a href="https://www.nuget.org/packages/CheckContracts/">library</a> <a href="https://github.com/imanushin/CheckContracts">(source code under the MIT license)</a> - so you can just use it (or copy the code to yourself, etc.) </p></div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <p>Source: <a href="https://habr.com/ru/post/330150/">https://habr.com/ru/post/330150/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../330140/index.html">Blockchain + distributed storage = Sia</a></li>
<li><a href="../330142/index.html">3 Ways to Break Single Responsibility Principle</a></li>
<li><a href="../330144/index.html">Teamwork. How to reconcile the designer and coder</a></li>
<li><a href="../330146/index.html">JSF 2 + Maven + Jetty. CDI, form and AJAX</a></li>
<li><a href="../330148/index.html">Why tree shaking does not work and how to live with it</a></li>
<li><a href="../330152/index.html">How data science helps the development of medicine. Lecture in Yandex</a></li>
<li><a href="../330154/index.html">Run systems without test operation</a></li>
<li><a href="../330156/index.html">The release of the beta version of multi-line TAPI driver for Terminal Services and the announcement of the presentation 3CX v15.5</a></li>
<li><a href="../330158/index.html">How to reduce the number of abandoned baskets in online sales</a></li>
<li><a href="../330160/index.html">Reduced read / write operations on the Raspberry Pi</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>