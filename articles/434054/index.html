<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>BLACK HAT conference. How to make a spy phone. Part 2</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="BLACK HAT conference. How to make a spy phone. Part 1 

 The next thing we need to modify is the manifest. This thing that says which services are inv...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>BLACK HAT conference. How to make a spy phone. Part 2</h1><div class="post__text post__text-html js-mediator-article"> <a href="https://habr.com/company/ua-hosting/blog/434052/">BLACK HAT conference.</a>  <a href="https://habr.com/company/ua-hosting/blog/434052/">How to make a spy phone.</a>  <a href="https://habr.com/company/ua-hosting/blog/434052/">Part 1</a> <br><br>  The next thing we need to modify is the manifest.  This thing that says which services are involved in the operation of the application, what permissions they have, and so on. <br><br>  So, we will start with the code itself, and exactly with the code of the smali directory.  If you look at the Angry Birds directory tree, you will see a lot of folders containing various components, arranged in subdirectories. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <img src="https://habrastorage.org/webt/qh/mp/wc/qhmpwcjpmyo50enzdrvvdmb5eus.jpeg"><br><br>  I don‚Äôt even know which of these things I really need and what they do, but I don‚Äôt need it.  Now I will do a technical thing of tremendous complexity - copy the droidwhisperer directory from here, from the SearchableDictionary directory, here, to the com / burstly / example / android subdirectory of the smali directory.  That's all, I hope you understand what's the point. <a name="habracut"></a><br><br>  So, a copy of our code is inserted where necessary, but there are a few more things that need to be done.  I look again at my list of cheats and see that now you need to make changes to the manifest.  First of all, when we take up the manifest, we need to know the name of the application - I will highlight it in red, later we will need it, because we inserted something into the existing code. <br><br>  So, updating the manifest is needed to enable the integrated spyware service and its permissions.  It consists of the following steps: <br><br>  - remembering the name of the original application for later, <br>  - definition of the service Droidwhisperer <br>  - definition of permissions required for Droidwhisperer to work. <br><br><img src="https://habrastorage.org/webt/gq/5j/ay/gq5jayxh78vqnocwugdnknyoxk4.jpeg"><br><br>  So I take this manifest and drag it to my notebook.  The first thing I do in the application, it defines our service.  For this, I find in the manifest the onCreate function in the main action of the target application.  In the case of Angry Birds, it was com / rovio / ka3d / App.  After that, I cut out a part of the code highlighted in yellow, and place it immediately after invit-super in onCreate. <br><br>  Thus, we specified in the manifest that we will have the Droidwhisperer service, which should start immediately after it becomes available.  That's why we needed the name of the original application com.rovio.ka3d.App, we use it to enter the new name of our application com.rovio.ka3d.  service.Droidwhisperer. <br><br>  Next, I copy and paste the permissions for our spyware application into the appropriate place in the manifest - these are the lines highlighted in green. <br><br><img src="https://habrastorage.org/webt/ek/s5/rc/eks5rc4rh9tddo3icn-xuo8avyi.jpeg"><br><br>  After making changes, we save the manifest, which already includes the permissions we need and a service is defined that needs to be launched when the phone boots, so that's all right. <br><br>  Something is needed in Android that launches applications, so the Angry Birds application must contain code that will launch my spyware service as soon as the original game is launched.  Now I go to the game directory and find the ka3d folder there, open it and copy the App file contained there into a notebook.  This is smali code, which is the Dalvik version of the assembler code.  We use the onCreate feature in Android.  I use notepad search to find the location of this function.  Here, you need a little knowledge of how the Android OS works - so, the onCreate function is used to call super-classes, that is, to create or restart application activity.  It is here that I insert my code, which should initiate the launch of a spyware service.  I go back to my cheat sheet, copy the necessary lines from there and paste them here. <br>  How do I know exactly which code to insert here?  I just copied it from the original application that I wrote.  I said that there is excellent documentation for smali, so you don‚Äôt need to go into all that much to do this. <br><br><img src="https://habrastorage.org/webt/ft/4u/jf/ft4ujf_5sccing9hba0icpfo1_i.jpeg"><br><br>  Just recently some "binding" sets were announced, which allow you to automate the receipt of the necessary code.  Just a few weeks ago, such Android developer toolkits were released, allowing you to create any service and implement it into an existing application.  All this can be done manually. <br><br>  So, as soon as the onCreate function is called, it activates our service.  Do not forget that after this you need to save the modified file.  So, after we had the appropriate technical training, we need to build our modified application.  Therefore, I go back to Apk_tool and collect parts from the Angry Birds directory in the birds.apk directory.  So, we rebuilt the original application, making the necessary changes to it, and placed a new assembly in a file called birds.apk. <br><br>  If you try to install this modified application on the Android phone right now, he will report that this application is not signed, so we need to sign it.  To do this, I create a self-signed digital certificate with the corresponding public key, and save it in my inject working directory.  This is a file called keys. <br><br><img src="https://habrastorage.org/webt/ho/7z/ns/ho7znswsj6ios1i-zawyxwp4aee.jpeg"><br><br>  This is just a certificate that I create myself.  Now I‚Äôll go back and take out this powerful and laconic command from my cheat sheet: <br><br>  jarsigner -verbose -keystore keys birds.apk alias_name <br><br>  In order not to confuse anything, I just cut it out and paste it in the right place.  So I'm going to sign the birds.apk file with my own key, it's pretty simple.  Then I give the command and sign all the application components with this digital key.  Now I can place it in the AppStore, on Google Play - anywhere. <br><br>  As I said before, there is no interface on the phone that shows the user who signed what.  Once the application is signed, it can be installed.  No one can tell who signed this app, and this is just great. <br><br>  So, the modified version of Angry Birds looks exactly the same as the original game and functions the same way, except that it contains my spyware code.  Now you can see on the screen digital signatures made by Kevin McName of Kindsite. <br>  Another interesting thing that I will show you, returning a little back.  Look at the original application - it is signed by Rovio Mobile Ltd, Look at the date of signature - this digital certificate is valid until August 26, 2010, but the application is installed on the phone without question.  Thus, even if your digital certificate has turned into garbage, it still gives the right to install the application, that is, no one checks it.  I think this is one of the things that is one of the serious flaws of the Android security model. <br><br>  The fact is that there is no strict verification of the digital certificates used.  This problem can be solved by committing to register those who want to get a digital certificate.  So back to our presentation.  I want to once again dwell on digital signatures. <br><br><img src="https://habrastorage.org/webt/l3/rd/np/l3rdnppzgwwz7_gd7wdiis0tc40.jpeg"><br><br>  All applications must be signed.  Any old signature remains valid if it is self-signed.  The presence of a signature is checked only when installing the application.  That is, I can change any .apk file already installed in the phone, and the system will not react to it in any way.  This is a pretty significant vulnerability.  If you want to change the .apk file on your phone, you must have access to change the directories in which such files are stored, but it is easy to get root-rights to do whatever you want with the phone. <br><br>  The second thing that worries me is that there is no user interface that shows who signed the application.  For example, when installing the application should appear the inscription that it was signed by Kevin McName of Kindsite.  I note that the signature must match for the moved or updated existing application, so I could not replace the existing version of Angry Birds if I did not change the name of my spyware.  But as soon as I did, no problems arose.  Android developers claim that the certificate does not need to be signed by an authorized center, and Android applications mainly use self-signed signatures. <br><br>  Before you begin to answer questions, I want to say that there is a whole industry of spyware for phones.  They are designed to monitor your loved ones or your children, or business partners. <br><br><img src="https://habrastorage.org/webt/ke/l9/sd/kel9sdzdo-2qk745iy4v4ru0fy8.jpeg"><br><br>  Previously, they were used to spy on the wrong spouses, but now their purpose has changed.  For example, you can monitor your children to ensure their safety, and this is completely legal.  But I think more spy phones are suitable for use in the BYOD system.  You can add any functionality to the spy module and insert it into any application, and the user will not know anything about it.  It is ideally suited for industrial espionage, so these devices expand the scope of ongoing security threats. <br><br>  So, this is a fully functional network device, and if I connect to Wi-Fi at work, I can install software on this phone that will scan the network for vulnerabilities.  At the same time, if necessary, it will be updated and send the stolen information to the command &amp; control site.  That is, an infected mobile phone is an extended platform of persistent security threats with great potential for attack.  For example, someone just walks inside the building with such a phone, scans the network, and then attacks them from the inside.  Of course, people protect their Internet connection through firewalls and similar firewalls, but this device communicates with networks directly through the air, the spy phone connects to the network in any place where there is an access point, and no firewall can help here.  As a matter of fact, the phones enter the network through the ‚Äúback door‚Äù.  A spy phone is pretty cool, but here we have a remote access trojan, and I think it's pretty dangerous. <br><br>  I think I said everything I wanted to say, and now I am ready to answer any questions. <br>  So, the first question is whether this particular application is trying to hide its presence.  I answer - no, it is not, because if you view the services running on the phone, you will see it there.  I think it could be made a hidden process, but in this case our ‚Äúspy phone‚Äù was created just to demonstrate the concept of threat. <br><br>  Can our application be detected by an antivirus program?  No, the antivirus does not detect this spyware module, because it does not know anything about it.  It would be possible to further confuse the code and then insert it into the application, and such a process can be automated. <br>  What can oppose such a spy application?  You can use an antivirus, which in any case detects known malicious applications, but we focused on the traffic sent to the command &amp; control site.  Probably, it would be possible to automate the process of code obfuscation, but it is very difficult to change the communication protocol with the command &amp; control server on the fly, you will need to change the server itself, change clients and so on.  Therefore, we recommend combining both methods of protection: antivirus against known malicious applications and monitoring of network traffic sent by the spy device to command &amp; control. <br><br><img src="https://habrastorage.org/webt/9l/tw/yj/9ltwyjrskfwoeyljshcyxa02shk.jpeg"><br><br>  I will answer the question what does the requirement of digital signatures coincide with when moving or updating an application.  If you are installing the application on your phone for the first time, then you will not have any problems with it.  But if the phone already has the original application and you want to replace it with a new copy with a different digital signature, or a modified application with the same name, you will fail, because the phone will be able to compare the original signature in the application with its modified version and note, that they do not match.  In this case, I bypassed the protection by simply replacing the original name of the application with another name. <br><br>  The command &amp; control server can interact with all Android functionality and use its API.  You can remotely get root access, download files to your phone, and generally dispose of them at your discretion, because Android provides ample opportunities for open access to the phone over the network.  I think that the same functionality is available on the iOS platform, just the developers of this OS are more serious about checking the security of new applications.  For example, you should receive a certificate from them certifying your identity as an application developer, and the application itself will be checked before it reaches its App Store, while Google checks the application after it is placed on the Play Market. <br><br>  I‚Äôm not familiar with the details of the Google Play app store, but I think that if a developer has a bad reputation or the application is compromised, it will not appear in the store.  However, there are many other online mobile app stores where an attacker can host a malicious application.  This is a type of phishing attack, when we force the user to download this application from anywhere, slipping him links. <br>  The fact is that all the functions in our spyware application look as usual, there is nothing illegal that this application would try to do.  When installing, it requires giving it the same permissions as legal applications.  Another thing is how these functions will be used later.  Of course, if someone reports that droidwhisperer is a virus, then any antivirus installed on the phone will not allow installation of the application that contains it. <br><br>  As I said, the spyware application can be downloaded from third-party sites.  In this case, the phishing attack is that you will be given detailed installation instructions and will offer to download this game for free, because this is such a cool game, and you do not need to pay for it by downloading the original in the Google store.  Usually the user is lured by such an offer. <br><br>  I note that we did not set out to penetrate networks protected by encryption, but simply connected to any available network.  Thank you for attention! <br><br><iframe width="560" height="315" src="https://www.youtube.com/embed/h98KtUgUOsg" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br><br>  Thank you for staying with us.  Do you like our articles?  Want to see more interesting materials?  Support us by placing an order or recommending to friends, <b>30% discount for Habr users on a unique analogue of the entry-level servers that we invented for you:</b> <a href="https://habr.com/company/ua-hosting/blog/347386/">The whole truth about VPS (KVM) E5-2650 v4 (6 Cores) 10GB DDR4 240GB SSD 1Gbps from $ 20 or how to share the server?</a>  (Options are available with RAID1 and RAID10, up to 24 cores and up to 40GB DDR4). <br><br>  <b>VPS (KVM) E5-2650 v4 (6 Cores) 10GB DDR4 240GB SSD 1Gbps until January free of charge</b> if you pay for a period of six months, you can order <a href="https://ua-hosting.company/vpsnl">here</a> . <br><br>  <b>Dell R730xd 2 times cheaper?</b>  Only we have <b><a href="https://ua-hosting.company/serversnl">2 x Intel Dodeca-Core Xeon E5-2650v4 128GB DDR4 6x480GB SSD 1Gbps 100 TV from $ 249</a> in the Netherlands and the USA!</b>  Read about <a href="https://habr.com/company/ua-hosting/blog/329618/">How to build an infrastructure building.</a>  <a href="https://habr.com/company/ua-hosting/blog/329618/">class c using servers Dell R730xd E5-2650 v4 worth 9000 euros for a penny?</a> </div><p>Source: <a href="https://habr.com/ru/post/434054/">https://habr.com/ru/post/434054/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../434044/index.html">Two-factor authentication (2FA) resistant to phishing</a></li>
<li><a href="../434046/index.html">GLSL: Center or centroid? Or when shaders attack</a></li>
<li><a href="../434048/index.html">Facebook develops cryptocurrency for WhatsApp</a></li>
<li><a href="../434050/index.html">Java Enterprise vs Android in 2019 - what to choose a newbie?</a></li>
<li><a href="../434052/index.html">BLACK HAT conference. How to make a spy phone. Part 1</a></li>
<li><a href="../434056/index.html">Need to know where to put zero</a></li>
<li><a href="../434058/index.html">A technical presentation of the new SpaceX spacecraft Starship / BFS from SpaceX is planned in March-April 2019</a></li>
<li><a href="../434060/index.html">Should I save the length of the array to a local variable in C #</a></li>
<li><a href="../434062/index.html">Amazon sent Alexa's 1,700 audio recordings to a random person.</a></li>
<li><a href="../434172/index.html">We are looking for the killer on the Prologue</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>