<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Xunlei download manager is used to hide Android applications</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="In this post, we publish information about potentially unwanted software ( Potentially Unwanted Application , PUA), the components of which are found ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Xunlei download manager is used to hide Android applications</h1><div class="post__text post__text-html js-mediator-article">  In this post, we publish information about potentially unwanted software ( <b>Potentially Unwanted Application</b> , PUA), the components of which are found by ESET as <b>Win32 / Kankan</b> .  These components are implemented in the Xunlei download manager.  We noticed this software because of the following interesting features: <br><br><ul><li>  To ensure its secrecy and survival in the system, this software registers one of its components as a plugin for Microsoft Office. </li><li>  The detected malicious code installs applications for Android devices that are connected to the computer via USB, without the user's knowledge. </li><li>  Win32 / Kankan contains code for detecting special system tools that analyze its behavior in the system. </li><li>  The Xunlei files that contain this malicious code are digitally signed by a Chinese company, Xunlei Networking Technologies (developed by Xunlei). </li></ul><br><br><a name="habracut"></a>  <b>Story</b> 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      The history of Win32 / Kankan began in June of last year, when several Chinese forums complained about a suspicious program signed by Xunlei Networking Technologies.  The company in question is developing Xunlei software, which is used to speed up the download of files (download manager).  Xunlei is similar to the <a href="http://www.welivesecurity.com/2013/08/21/orbital-decay-the-dark-side-of-a-popular-file-downloading-tool/">Orbit Downloader</a> download manager, the story with which we published earlier. <br><br>  The popularity of Xunlei is explained by the fact that this program, besides the possibility of accelerated downloading of files, allows the user to search for the necessary files on the network and then download them in an optimized way (torrent client).  The program has a generated database of addresses of various files.  When you need to download a particular file, Xunlei uses a browser or torrent client in such a way that it takes the shortest possible time to download.  To realize this possibility, Xunlei Networking Technologies has built in the software a search engine for files, a torrent client with support for various protocols, its own p2p protocol, as well as other tools.  A more detailed description of Xunlei can be found <a href="http://cis.poly.edu/~prithula/papers/XunleiTR.pdf">here</a> . <br><br>  This download manager is very popular with Chinese users.  <a href="http://torrentfreak.com/thunder-blasts-utorrents-market-share-away-091204/">A TorrentFreak study</a> published in 2009 shows that Xunlei is the most popular torrent client in the world with more than one hundred million user IDs.  While for uTorrent the maximum number of users was 92 million.  It should be noted that Xunlei is a local product for the Chinese market, since there is no other language on the official site except Chinese, and the translation of the software interface itself into other languages ‚Äã‚Äãis done by third-party companies or the users themselves. <br><br>  <b>Analysis</b> <br><br>  Above, we mentioned that some Chinese users found suspicious files on their computers, signed by the certificate of Xunlei Networking Technologies.  The certificate is shown below. <br><br><img src="https://habrastorage.org/storage3/4ff/d85/0bc/4ffd850bc533b41ef165875381f9a4cd.png"><br>  Fig.  Certificate that signed the malicious files. <br><br>  These files belonged to the installer (Windows installer), whose name was INPEnhSetup.exe.  It is based on the <a href="http://nsis.sourceforge.net/Main_Page">Nullsoft Scriptable Install System</a> distribution system.  During the installation process, the installer contacts the kkyouxi.stat.kankan.com domain, which is hardwired in its code, in order to inform the server about the start of a new installation.  Then the installation of three files into the system: <i>INPEn.dll</i> , <i>INPEnhUD.exe</i> and <i>INPEnhSvc.exe</i> .  After this, the INPEn.dll library is loaded into memory and the <i>DllRegisterServer</i> function is <i>called</i> .  Next, the installer again contacts <i>kkyouxi.stat.kankan.com</i> and announces the end of their work. <br><br>  Execution of the code in INPEn.dll begins with registering the dll as a plugin with the name InputEnhance for Word, Excel and PowerPoint.  To perform this operation, it creates registry keys in the appropriate location, which allows the INPEnh.dll library to later act as a plug-in for Office applications.  Below are some of these registry keys. <br><br><img src="https://habrastorage.org/storage3/5a1/f12/7fb/5a1f127fb6d57c62f0ef5df98366860b.png"><br>  Fig.  The registry key through which the malicious DLL performs its loading. <br><br>  The screenshot shows that the parameter LoadBehavior is set to 3. Thus, the plugin will load every time you start the application.  Thus, the authors of the malicious code ensure its survival after a reboot and subsequent launch.  Each time an application is launched from Microsoft Office (for example, Word, Excel or PowerPoint), this library is loaded into memory as a plugin.  For the user, this action is absolutely transparent, that is, he does not see it.  INPEn.dll imperceptibly for the user performs the following actions: <br><br><ul><li>  Downloads the tools.ini configuration file from the remote server (conf.kklm.n0808.com/tools.ini).  The file contains various parameters, for example, a list of names of various system tools, which is encoded by the base64 algorithm.  Below is this file. <br><img src="https://habrastorage.org/storage3/17e/0a9/7d2/17e0a97d23ae1c66cbb997bc5fb022f4.png"></li><li>  Checks if a process is running from the list shown in the configuration file.  If running, the library stops working.  The list of applications from one of the configuration files is given below.  You can see that it contains the names of the processes of the analysis and debugging tools (Windows task manager, Olly Debugger, MS Process Monitor, Wireshark, etc.), and not the names of the processes of anti-virus products.  Thus, it is obvious that the authors have embedded code in the library, which helps to avoid analyzing the behavior of the program or detecting its activity in the system. <br><img src="https://habrastorage.org/storage3/d20/538/885/d20538885f48528fc4f25cd939befe4e.png"></li><li>  Checks whether Internet connection is active, trying to connect with well-known Chinese resources, for example, baidu.com and qq.com.  If there is no connection to the network, the code goes into a loop waiting for such a connection. </li><li>  If all previous checks are successfully passed, the plugin sends various information to the StatServer server (see the configuration file), in particular, the Windows version and the name of the application in the context of which the dll was launched.  Then INPEnhUD.exe is launched. </li><li>  Further, the code is included in the processing cycle of various tasks, which we describe below. </li></ul><br>  The INPEnhUD.exe application can be described as an updater (updater).  It extracts from its code the hard-wired address of the xml file update.kklm.n0808.com/officeaddinupdate.xml, which is presented below. <br><br><img src="https://habrastorage.org/storage3/91b/01e/c40/91b01ec40db23759630f1fffc0a222e1.png"><br>  Fig.  Part of the ‚Äúupdate file‚Äù that is used to download new executables with the Xunlei code. <br><br>  You can see that this xml file contains a list of URLs pointing to various executable files and their MD5 hashes.  Files from this list will be downloaded by the updater to the computer and executed after MD5 verification.  When these actions are executed, the update code runs the executable <i>INPEnhSvc.exe</i> , which we call the service. <br><br>  This <i>INPEnhSvc.exe</i> (‚Äúservice‚Äù) is actually the core of the hidden Xunlei code and can execute various remote commands.  After performing the same checks for debugging and analysis tools that we saw in the previous module, it downloads an XML configuration file, which may contain various commands.  They can be divided into two groups. <br><br><ul><li>  local commands: <i>scanreg</i> , <i>scandesktop</i> , <i>scanflicit</i> </li><li>  remote commands: <i>installpcapp</i> , <i>installphoneapp</i> , <i>setdesktopshortcut</i> , <i>addfinds</i> , <i>setiestartpage</i> </li></ul><br>  As the name implies, local commands are implemented by the service code itself without using network downloads: <i>scanreg</i> searches for a specific registry key and reports its presence or absence to StatServer, <i>scandesktop</i> and <i>scanf Press</i> looking for special .lnk and .url shortcut files in the desktop directories and ‚ÄúFavorites‚Äù respectively. <br><br>  If the service receives a remote command, then it interacts with the Office plugin (described above), which is responsible for the execution of this feature.  This interaction occurs through a configuration file called tasklist.ini and contains three different sections: <i>Doing</i> , <i>Done</i> , <i>DoneByData</i> .  Both executable files contain a list of GUIDs, each of which is associated with a specific task.  The process of interaction between these modules is as follows: <br><br><ul><li>  When a service receives a remote command, it writes the desired GUID to the <i>Doing</i> section with the necessary parameters (for example, the URL address). </li><li>  A library that has been registered as an Office plugin reads this GUID.  It then checks for the presence of such a GUID in the <i>Done</i> and <i>DoneByDate</i> sections of the <i>tasklist.ini</i> file.  If the command has not yet been executed, i.e. is absent in both sections, then it is subject to execution. </li><li>  As soon as the command is executed, the plugin writes the GUID value to the Done section.  In addition, the GUID values ‚Äã‚Äãfor the <i>installpcapp</i> and <i>installphoneapp</i> commands are also recorded in the DoneByDate section.  This is probably done for the subsequent re-execution of these commands. </li></ul><br>  Below is an illustrative diagram of this work process.  Blue boxes represent processes, and yellow boxes represent files. <br><br><img src="https://habrastorage.org/storage3/f20/fa5/6f4/f20fa56f44047150bc06a6e24028d14b.png"><br><br>  Remote commands do not need additional explanations, since their names speak for themselves.  The exception is the <i>installphoneapp</i> command, which we will consider in more detail. <br><br>  <b>Mobile Applications</b> <br><br>  The <i>installphoneapp</i> command, as the name suggests, is used to download a mobile application from a remote server and then install it on an Android mobile device (APK file).  To accomplish this task, the service downloads the <a href="http://developer.android.com/tools/help/adb.html">Android Debug Bridge</a> (ADB) application, which is part of the Android SDK.  Next, the plugin downloads APK files whose addresses are listed in the command XML file (config.xml) and lists Android devices that are connected to a computer using ADB.  After these operations, the code installs each application on the device. <br><br>  It should be noted that the application will be installed only if the device running Android is connected to the computer via USB, and it includes the ability to debug, which is activated through the device settings.  Officially, it is provided only for application development, but is also used by some types of applications, including for updating the firmware on the device.  In this interaction mode, the application on the device will be installed in the hidden mode and the user will not notice this. <br><br>  Screenshots of downloadable applications are shown below. <br><br><img src="https://habrastorage.org/storage3/cda/6c3/015/cda6c3015e82bb3ea983ead1b23043e0.png"><br>  Fig.  Screenshots of applications installed by Xunlei. <br><br>  According to our analysis, all these applications provide real opportunities for the user.  Three of them are available for download in app stores.  We did not find any malicious functions in these applications, however, it should be noted that the code of these applications is strongly obfuscated to complicate the analysis. <br><br>  At the moment, the fourth application is still <a href="https://play.google.com/store/apps/details%3Fid%3Dcom.uu">available on Google Play</a> and allows users to make phone calls at so-called special low rates.  However, the application has some suspicious features, for example, regular interaction with various URL addresses, which are known as distributors of adware for Android.  This application is detected by ESET as <b>Android / SMSreg.BT</b> and is also potentially undesirable (Potentially Unwanted Application, PUA). <br><br>  The motivation for installing these applications through the hidden Xunlei code remains unknown.  However, the role of the developer company Xunlei Networking Technologies is not entirely clear.  The fact is that the files containing this unwanted code are signed with the digital certificate of this company.  In addition, the child domain kankan.com, which is used as a data collection server (StatServer) is also used as another service of this company.  There is no doubt that company employees knew about the unwanted hidden features of their software. <br><br>  Last August, company representatives responded to user complaints by saying that some employees used company resources to create and distribute this code.  In particular, it was stated that the responsibility for this is borne by one of the departments of the company, which, without the approval of the management, has built such possibilities in the software. <br><br>  Note that the Xunlei Uninstaller is signed with the same digital certificate.  It is downloaded to the user's computer thanks to the update component, which we wrote about above.  According to our analysis, the uninstaller works correctly and removes all elements of the program.  The start and end of the campaign to distribute this version of Kankan coincides with the detection indicators of this PUA software in August and September of this year. <br><br><img src="https://habrastorage.org/storage3/2bb/fdf/3bb/2bbfdf3bb5f5e89a0f6d6da0270eeb4c.png"><br><br>  It can be seen that the level of distribution of this software has greatly decreased after the peak of August 8th (the uninstaller was signed on August 9th).  Below is the Win32 / Kankan activity map, according to <a href="http://www.virusradar.com/en">ESET VirusRadar</a> , which shows that China has been the most active. <br><br><img src="https://habrastorage.org/storage3/0e1/1fe/d99/0e11fed9970c45b1fd4fa2a86c2a7d38.png"><br><br>  <b>Conclusion</b> <br><br>  Using one of the Xunlei libraries as an Office plug-in for hiding and subsequent implementation of its unwanted features, the hidden installation mechanism for Android applications, and the backdoor functionality confirm that Xunlei is dangerous for users.  Thus, this software was added to the ESET database as <b>Win32 / Kankan</b> . </div><p>Source: <a href="https://habr.com/ru/post/197610/">https://habr.com/ru/post/197610/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../197596/index.html">Brainbench: 600 free certificates till 10.25.2013</a></li>
<li><a href="../197598/index.html">Introduction to Go - we write a grabber of web pages with multithreading and harlots</a></li>
<li><a href="../197604/index.html">Open Hand Dextrus - palm prosthesis, which costs less than $ 1000</a></li>
<li><a href="../197606/index.html">On a singularity of the Kotelnikov theorem</a></li>
<li><a href="../197608/index.html">The software package ViPNet Client for Android is certified by the Federal Security Service of Russia</a></li>
<li><a href="../197612/index.html">Another FullHD option by air</a></li>
<li><a href="../197614/index.html">Adaptive English grammar test - learn from personal recommendations with LinguaLeo</a></li>
<li><a href="../197622/index.html">Elektron Octatrack DPS-1 - first impressions</a></li>
<li><a href="../197624/index.html">Backdoor deobfuscation without a single alphanumeric character</a></li>
<li><a href="../197626/index.html">Watson supercomputer trained to diagnose patients and train medical students</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>