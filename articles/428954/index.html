<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>How we shot ourselves in the foot and tried to figure out exactly what</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Past posts in the corporate blog did not contain a single console command, and we decided to catch up. 


 In our company there is a metric created to...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>How we shot ourselves in the foot and tried to figure out exactly what</h1><div class="post__text post__text-html js-mediator-article"><p>  Past posts in the corporate blog did not contain a single console command, and we decided to catch up. </p><br><p>  In our company there is a metric created to prevent large fakapov on shared hosting.  Each virtual hosting server hosts a test site on WordPress, which is periodically accessed. </p><br><p><img src="https://habrastorage.org/webt/g_/va/ot/g_vaotdagl43wnkctciq39tewes.png" alt="image"><br>  <em>This is how a test site looks on each shared hosting server.</em> </p><br><p><a name="habracut"></a>  Measured the speed and success of the response site.  Any employee can look at the overall statistics and see how well the company is doing.  Can see the percentage of successful responses of the test site for the entire hosting or for a specific server.  It is not necessary to be an employee of the company - in the control panel, customers also see statistics on the server where their account is located. </p><br><p>  We called this metric <strong>uptime</strong> (the percentage of successful responses from the test site to all requests to the test site).  Not a very good name, it is easy to confuse with the <em>uptime-who-total-time-after-last-restart server</em> . </p><br><p>  The summer has passed, and the uptime schedule has slowly gone down. </p><br><p><img src="https://habrastorage.org/webt/h5/-h/n6/h5-hn6fmxnjepsbj8i7j1azozeu.png" alt="image"></p><br><p>  Administrators immediately identified the cause - a shortage of RAM.  In the logs it was easy to see OOM cases when the server ran out of memory and the kernel killed nginx. </p><br><p>  The head of the department, Andrei, breaks down one task into several tasks with a master's hand and parallelizes them to different administrators.  One is going to analyze the Apache settings - perhaps the settings are not optimal and with a large attendance Apache uses all the memory?  Another analyzes the mysqld memory consumption - suddenly there are any obsolete settings since the time when shared hosting used the Gentoo OS?  The third is looking at the recent changes to the nginx settings. </p><br><p>  One by one, administrators return with results.  Everyone managed to reduce memory consumption in the area allocated to him.  In the case of nginx, for example, the included but not used mod_security was detected.  OOM, meanwhile, is also common. </p><br><p>  Finally, it is possible to note that the memory consumption by the kernel (in particular, SUnreclaim) is terribly large on some servers.  This parameter is not visible in the ps or htop output, so we did not notice it immediately!  An example of a server with a hellish SUnreclaim: </p><br><pre><code class="hljs perl">root@vh28.timeweb.ru:~<span class="hljs-comment"><span class="hljs-comment"># grep SU /proc/meminfo SUnreclaim: 25842956 kB</span></span></code> </pre> <br><p>  24 gigabytes of RAM is given to the kernel, and the kernel spends them unknown on what! </p><br><p>  The administrator (let's call him Gabriel) rushes into battle.  Reassembles the kernel with KMEMLEAK options for searching for leaks. </p><br><div class="spoiler">  <b class="spoiler_title">Rebuild options</b> <div class="spoiler_text"><p>  To enable KMEMLEAK, it is enough to specify the options listed below and load the kernel with the kmemleak = on parameter. </p><br><pre> <code class="hljs">CONFIG_HAVE_DEBUG_KMEMLEAK=y CONFIG_DEBUG_KMEMLEAK=y CONFIG_DEBUG_KMEMLEAK_DEFAULT_OFF=y CONFIG_DEBUG_KMEMLEAK_EARLY_LOG_SIZE=10000</code> </pre> </div></div><br><p>  KMEMLEAK writes (in <code>/sys/kernel/debug/kmemleak</code> ) the following lines: </p><br><pre> <code class="hljs xml">unreferenced object 0xffff88013a028228 (size 8): comm "apache2", pid 23254, jiffies 4346187846 (age 1436.284s) hex dump (first 8 bytes): 00 00 00 00 00 00 00 00 ........ backtrace: [<span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">ffffffff818570c8</span></span></span><span class="hljs-tag">&gt;</span></span>] kmemleak_alloc+0x28/0x50 [<span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">ffffffff811d450a</span></span></span><span class="hljs-tag">&gt;</span></span>] kmem_cache_alloc_trace+0xca/0x1d0 [<span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">ffffffff8136dcc3</span></span></span><span class="hljs-tag">&gt;</span></span>] apparmor_file_alloc_security+0x23/0x40 [<span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">ffffffff81332d63</span></span></span><span class="hljs-tag">&gt;</span></span>] security_file_alloc+0x33/0x50 [<span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">ffffffff811f8013</span></span></span><span class="hljs-tag">&gt;</span></span>] get_empty_filp+0x93/0x1c0 [<span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">ffffffff811f815b</span></span></span><span class="hljs-tag">&gt;</span></span>] alloc_file+0x1b/0xa0 [<span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">ffffffff81728361</span></span></span><span class="hljs-tag">&gt;</span></span>] sock_alloc_file+0x91/0x120 [<span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">ffffffff8172b52e</span></span></span><span class="hljs-tag">&gt;</span></span>] SyS_socket+0x7e/0xc0 [<span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">ffffffff81003854</span></span></span><span class="hljs-tag">&gt;</span></span>] do_syscall_64+0x54/0xc0 [<span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">ffffffff818618ab</span></span></span><span class="hljs-tag">&gt;</span></span>] return_from_SYSCALL_64+0x0/0x6a [<span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">ffffffffffffffff</span></span></span><span class="hljs-tag">&gt;</span></span>] 0xffffffffffffffff unreferenced object 0xffff880d67030280 (size 624): comm "hrrb", pid 23713, jiffies 4346190262 (age 1426.620s) hex dump (first 32 bytes): 01 00 00 00 03 00 ff ff 00 00 00 00 00 00 00 00 ................ 00 e7 1a 06 10 88 ff ff 00 81 76 6e 00 88 ff ff ..........vn.... backtrace: [<span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">ffffffff818570c8</span></span></span><span class="hljs-tag">&gt;</span></span>] kmemleak_alloc+0x28/0x50 [<span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">ffffffff811d4337</span></span></span><span class="hljs-tag">&gt;</span></span>] kmem_cache_alloc+0xc7/0x1d0 [<span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">ffffffff8172a25d</span></span></span><span class="hljs-tag">&gt;</span></span>] sock_alloc_inode+0x1d/0xc0 [<span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">ffffffff8121082d</span></span></span><span class="hljs-tag">&gt;</span></span>] alloc_inode+0x1d/0x90 [<span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">ffffffff81212b01</span></span></span><span class="hljs-tag">&gt;</span></span>] new_inode_pseudo+0x11/0x60 [<span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">ffffffff8172952a</span></span></span><span class="hljs-tag">&gt;</span></span>] sock_alloc+0x1a/0x80 [<span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">ffffffff81729aef</span></span></span><span class="hljs-tag">&gt;</span></span>] __sock_create+0x7f/0x220 [<span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">ffffffff8172b502</span></span></span><span class="hljs-tag">&gt;</span></span>] SyS_socket+0x52/0xc0 [<span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">ffffffff81003854</span></span></span><span class="hljs-tag">&gt;</span></span>] do_syscall_64+0x54/0xc0 [<span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">ffffffff818618ab</span></span></span><span class="hljs-tag">&gt;</span></span>] return_from_SYSCALL_64+0x0/0x6a [<span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">ffffffffffffffff</span></span></span><span class="hljs-tag">&gt;</span></span>] 0xffffffffffffffff</code> </pre> <br><p>  Gabriel did not reveal to us all his secrets and did not tell how he found out from the above lines the exact cause of the memory leak.  Most likely, he used the <code>addr2line /usr/lib/debug/lib/modules/`uname -r`/vmlinux ffffffff81722361</code> to search for the exact string.  Or simply opened the file <code>net/socket.c</code> and looked at it while the file became uncomfortable. </p><br><p>  The problem turned out to be in the patch for the file <code>net/socket.c</code> , which was added to our repository many years ago.  Its purpose is to prevent clients from using the bind () system call, this is a simple protection against the launch of proxy servers by clients.  Patch fulfilled its purpose, but did not clear the memory after itself. <br>  Perhaps there were new fashionable malware for PHP that tried to run a proxy server in a loop - which led to hundreds of thousands of blocked bind () calls and lost gigabytes of RAM. </p><br><p>  Then it was easy - Gabriel corrected the patch and rebuilt the core.  Added monitoring of SUnreclaim values ‚Äã‚Äãon all servers under Linux OS.  Engineers warned customers and rebooted hosting into a new kernel. <br>  OOM disappeared. </p><br><h3 id="no-problema-s-dostupnostyu-saytov-ostalas">  But the problem with the availability of sites remained </h3><br><p>  On all servers, the test site stopped responding several times a day. </p><br><p>  Here the author would begin to tear hair on different parts of the body.  But Gabriel remained calm and turned on the recording of traffic on some hosting servers. </p><br><p>  In the traffic dump, it was clear that most often the request to the test site falls after suddenly receiving a <code>TCP RST</code> packet.  In other words, the request reached the server, but the connection was eventually broken off by nginx. <br>  Further more interesting!  The strace utility launched by Gabriel shows that the nginx daemon <strong>does not</strong> send this packet.  How can this be, because only nginx is listening on port 80? <br>  The reason was a combination of several factors: </p><br><ul><li>  in the nginx settings, there is a <code>reuseport</code> option (which includes the <code>SO_REUSEPORT</code> socket <code>SO_REUSEPORT</code> ), which allows different processes to accept connections at the same address and port </li><li>  at (at the time, the newest) version of nginx 1.13.0 there is a <a href="https://trac.nginx.org/nginx/ticket/1300">bug</a> , which, when running the nginx configuration test via <code>nginx -t</code> and using the <code>SO_REUSEPORT</code> this nginx test process really started listening to port 80 and intercepting requests from real clients .  And at the end of the configuration test process, clients received <code>Connection reset by peer</code> </li><li>  finally, in monitoring zabbiks, monitoring of the correctness of the nginx configuration on all servers with nginx installed was configured: the <code>nginx -t</code> command was <code>nginx -t</code> on them once a minute. </li></ul><br><p>  Only after updating nginx could you breathe out calmly.  Graph uptime sites went up. </p><br><p>  What is the moral of this story?  Stay optimistic and avoid using self-assembled cores. </p></div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <p>Source: <a href="https://habr.com/ru/post/428954/">https://habr.com/ru/post/428954/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../428940/index.html">GitLab 11.4 released with a review of merge-requests and pluggable features</a></li>
<li><a href="../428942/index.html">The penultimate post</a></li>
<li><a href="../428944/index.html">Where to work in IT, release 3: Badoo</a></li>
<li><a href="../428946/index.html">Security Week 45: Something About Bluetooth Vulnerabilities</a></li>
<li><a href="../428950/index.html">Solution of the problem ‚Äúshort left shift‚Äù</a></li>
<li><a href="../428956/index.html">Drones on the ISS</a></li>
<li><a href="../428960/index.html">Rome Club Report 2018, Chapter 1.5: The Climate Challenge</a></li>
<li><a href="../428962/index.html">Relokatsiya in Luxoft: how is life left</a></li>
<li><a href="../428964/index.html">SSD vulnerabilities with hardware encryption allow attackers to easily circumvent defensive measures</a></li>
<li><a href="../428972/index.html">Continuous integration in Yandex</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>