<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Integration of CoreSpotlight on the example of "Rambler. Mail"</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="In iOS 9, Apple added a spotlight search for third-party applications. This is especially important for applications with the same type of content: ne...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Integration of CoreSpotlight on the example of "Rambler. Mail"</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/files/441/411/e31/441411e31416405d89f44555553f1716.jpg"><br><br>  In iOS 9, Apple added a spotlight search for third-party applications.  This is especially important for applications with the same type of content: news applications, email clients, event posters.  The iOS development department of the Rambler &amp; Co holding has already integrated search into some of its applications. <br><br>  This article will highlight the integration of <b>CoreSpotlight</b> into an existing project and talk about the problems encountered and their solutions. <br><a name="habracut"></a><br><h2>  Search API </h2><br>  To begin with, in order to present a complete picture of the current functionality and the places of its application, it is worth clarifying what content search capabilities in third-party applications are currently available in iOS 9. <br>  Currently, the Search API consists of the following components: 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      <b>NSUserActivity</b> is a class that preserves and <b>restores the displayed content</b> and user activity.  This class was introduced in iOS 8 for the implementation of <b><a href="https://developer.apple.com/handoff/">Handoff</a></b> (the ability to continue working in the same application on another device.).  In iOS 9, this class is also used when opening an application from search results.  It is a model that contains: <br><ul><li>  information to restore the state of the interface; <br></li><li>  a description of how to interact with this information; <br></li><li>  ways to store this information in the system. <br></li></ul><br>  It is possible to make this activity public, that is, it will appear in the search results not only of this device, but also among other users.  It is worth noting that this opportunity will begin to work only in a few months. <br><br>  <b>CoreSpotlight</b> is a framework that allows developers to <b>index application content</b> for later display in the spotlight search results.  It presents two models: <br><ol><li>  attributes to display in the search; <br></li><li>  properties to identify content. <br></li></ol><br>  <b>CoreSpotlight</b> also includes methods for adding and removing objects from the search. <br><br>  <b>Web Markup</b> is a technology that allows an Apple bot to <b>index the site content</b> (special meta tags) for displaying it in search results and opening it in an application. <br><br>  You can learn more about Web Markup and NSUserActivity from WWDC 2015, the documentation and links at the end of the article. <br><br><h2>  Formulation of the problem </h2><br>  We consider the integration of <b>CoreSpotlight</b> on the example of the application "Rambler. Mail".  The application adds a search for folders, letters, attachments and contacts that are stored in the database (CoreData).  By the time of the update, this database will already be filled.  Based on this, the first requirement will be the <b>primary indexation of all stored data</b> . <br><br>  Since all these objects can be created, deleted and changed, it is required to maintain <b>consistency between the main database and the indexed objects</b> .  Since there can be a lot of data change operations and they can overlap each other, the system should be implemented in such a way that it <b>processes change sets.</b> <br><br>  Based on the requirements described above, it is necessary to <b>‚Äúcollapse‚Äù the number of operations per indexing</b> .  With several changes of one object, it is enough to process only one update operation.  When deleting an object, there is no point in processing requests for indexation of changes that already exist for it. <br><br>  In the future, it is planned to integrate into other projects, so it is necessary that the indexing system <b>be as independent as possible, able to index all types of objects</b> , as well as <b>easily integrate, modify and expand</b> . <br><br>  Since indexing can be long (especially primary), and can be interrupted, you need to keep its state.  That is, <b>you need to save all the unprocessed changes</b> , and run their indexing on restarting the application.  It is necessary to implement the system so as to <b>minimize the number of calls to the database</b> , and the number of auxiliary objects for storing changes was less than the number of objects being changed. <br><br><h2>  Structure </h2><br>  After setting the task, we can divide our system into several modules, each of which will be responsible for one of the functional tasks.  In this case, modules that work with indexed objects will be closed by protocols, so that, if necessary, you can write your own implementation of the module, and the system would continue to work. <br><br>  <b>The data source</b> is <b>&lt;ChangeProvider&gt;</b> .  The class implementing this protocol <b>provides the monitor with data about changes in</b> objects.  For each entity that needs to be indexed, there must be a provider.  For convenience, a base class is implemented, which is initialized by NSFetchedResultsController, exposes itself as a delegate and proxies all events about changes in IndexerMonitor (it is described further on). <br><br><pre><code class="objectivec hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">@protocol</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">RamblerChangeProvider</span></span></span><span class="hljs-class"> &lt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">NSObject</span></span></span><span class="hljs-class">&gt; @</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">property</span></span></span><span class="hljs-class"> (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">weak</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">nonatomic</span></span></span><span class="hljs-class">) </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">id</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">RamblerChangeProviderDelegate</span></span></span><span class="hljs-class">&gt; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">delegate</span></span></span><span class="hljs-class">; @</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">end</span></span></span></span></code> </pre> <br><pre> <code class="objectivec hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">@protocol</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">RamblerChangeProviderDelegate</span></span></span><span class="hljs-class"> &lt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">NSObject</span></span></span><span class="hljs-class">&gt; - (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">void</span></span></span><span class="hljs-class">)</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">changeProvider</span></span></span><span class="hljs-class">:(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">id</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">RamblerChangeProvider</span></span></span><span class="hljs-class">&gt;)</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">changeProvider</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">didChangeObject</span></span></span><span class="hljs-class">:(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">id</span></span></span><span class="hljs-class">)</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">object</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">changeType</span></span></span><span class="hljs-class">:(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">RamblerChangeType</span></span></span><span class="hljs-class">)</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">changeType</span></span></span><span class="hljs-class">; - (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">void</span></span></span><span class="hljs-class">)</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">processChanges</span></span></span><span class="hljs-class">; - (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">NSArray</span></span></span><span class="hljs-class"> *)</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">obtainObjectsForInitialIndexing</span></span></span><span class="hljs-class">; @</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">end</span></span></span></span></code> </pre><br><pre> <code class="objectivec hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">@interface</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">RamblerFetchedResultsControllerChangeProvider</span></span></span><span class="hljs-class"> : </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">NSObject</span></span></span><span class="hljs-class"> &lt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">RamblerChangeProvider</span></span></span><span class="hljs-class">&gt; + (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">instancetype</span></span></span><span class="hljs-class">)</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">changeProviderWithFetchedResultsController</span></span></span><span class="hljs-class">:(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">NSFetchedResultsController</span></span></span><span class="hljs-class"> *)</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">controller</span></span></span><span class="hljs-class">; @</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">end</span></span></span></span></code> </pre><br>  <b>Indexer</b> - <b>&lt;Indexer&gt;</b> .  The protocol of the object that is <b>engaged in indexing data</b> from the database.  For each entity that needs to be indexed, its own indexer object is added.  He is able to handle a set of changes and give a unique identifier for the object passed to him and the object by identifier.  For convenience, a base class has also been implemented, from which to inherit.  The indexer creates the batch processing operation and returns it to the monitor. <br><br><pre> <code class="objectivec hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">@protocol</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">RamblerIndexer</span></span></span><span class="hljs-class"> &lt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">NSObject</span></span></span><span class="hljs-class">&gt; - (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">NSOperation</span></span></span><span class="hljs-class"> *)</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">operationForIndexBatch</span></span></span><span class="hljs-class">:(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">RamblerIndexTransactionBatch</span></span></span><span class="hljs-class"> *)</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">batch</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">withCompletionBlock</span></span></span><span class="hljs-class">:(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">RamblerErrorBlock</span></span></span><span class="hljs-class">)</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">block</span></span></span><span class="hljs-class">; - (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">BOOL</span></span></span><span class="hljs-class">)</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">canIndexObjectWithIdentifier</span></span></span><span class="hljs-class">:(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">NSString</span></span></span><span class="hljs-class"> *)</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">identifier</span></span></span><span class="hljs-class">; - (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">NSString</span></span></span><span class="hljs-class"> *)</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">identifierForObject</span></span></span><span class="hljs-class">:(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">id</span></span></span><span class="hljs-class">)</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">object</span></span></span><span class="hljs-class">; - (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">id</span></span></span><span class="hljs-class">)</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">objectForIdentifier</span></span></span><span class="hljs-class">:(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">NSString</span></span></span><span class="hljs-class"> *)</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">object</span></span></span><span class="hljs-class">; @</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">end</span></span></span></span></code> </pre><br><pre> <code class="objectivec hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">@interface</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">RamblerIndexerBase</span></span></span><span class="hljs-class"> : </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">NSObject</span></span></span><span class="hljs-class"> &lt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">RamblerIndexer</span></span></span><span class="hljs-class">&gt; @</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">property</span></span></span><span class="hljs-class"> (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">strong</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">nonatomic</span></span></span><span class="hljs-class">) </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">CSSearchableIndex</span></span></span><span class="hljs-class"> *</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">searchableIndex</span></span></span><span class="hljs-class">; - (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">CSSearchableItem</span></span></span><span class="hljs-class"> *)</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">searchableItemForObject</span></span></span><span class="hljs-class">:(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">id</span></span></span><span class="hljs-class">)</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">object</span></span></span><span class="hljs-class">; - (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">BOOL</span></span></span><span class="hljs-class">)</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">canIndexObjectWithType</span></span></span><span class="hljs-class">:(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">NSString</span></span></span><span class="hljs-class"> *)</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">objectType</span></span></span><span class="hljs-class">; @</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">end</span></span></span></span></code> </pre><br>  To work, you must override the two methods from RamblerIndexerBase and the last three methods from the RamblerIndexer protocol. <br><br>  <b>Identifier Generator</b> - <b>IndexIdentifierFormatter</b> - an auxiliary object for <b>generating and breaking an identifier</b> into ‚Äúmeaningful parts‚Äù (parts of the string that are needed for recovery) to search for the original object.  For example, the identifier for the letter would look like this: " <i>RCMMessage_129_Inbox</i> ".  <i>"RCMMessage"</i> is the object type, " <i>129</i> " is the letter identifier in the folder, "Inbox" is the name of the folder in which the message is located.  With this information, you can uniquely determine the type of object and find it. <br><br><pre> <code class="objectivec hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">@protocol</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">RamblerIndexIdentifierFormatter</span></span></span><span class="hljs-class"> &lt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">NSObject</span></span></span><span class="hljs-class">&gt; - (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">NSString</span></span></span><span class="hljs-class"> *)</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">identifierForObject</span></span></span><span class="hljs-class">:(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">id</span></span></span><span class="hljs-class">)</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">object</span></span></span><span class="hljs-class">; - (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">BOOL</span></span></span><span class="hljs-class">)</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">isCorrectIdentifier</span></span></span><span class="hljs-class">:(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">NSString</span></span></span><span class="hljs-class"> *)</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">identifier</span></span></span><span class="hljs-class">; @</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">end</span></span></span></span></code> </pre><br><pre> <code class="objectivec hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">@interface</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">RamblerMessageIndexIdentifierFormatter</span></span></span><span class="hljs-class"> : </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">NSObject</span></span></span><span class="hljs-class"> - (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">NSNumber</span></span></span><span class="hljs-class"> *)</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">messageUIDFromIdentifier</span></span></span><span class="hljs-class">:(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">NSString</span></span></span><span class="hljs-class"> *)</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">identifier</span></span></span><span class="hljs-class">; - (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">NSString</span></span></span><span class="hljs-class"> *)</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">folderNameFromIdentifier</span></span></span><span class="hljs-class">:(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">NSString</span></span></span><span class="hljs-class"> *)</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">identifier</span></span></span><span class="hljs-class">; @</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">end</span></span></span></span></code> </pre><br>  <b>Change</b> <b>store</b> - <b>StateStorage</b> - the module responsible for <b>saving changes</b> for their subsequent processing.  He receives a transaction at the input that stores the type of change, the type of the changed object and its identifier, and then saves it to the database.  For each type of object being indexed, there is one entry in this database.  Each object contains OrderSet identifiers of various types of changes.  This is necessary so that the identifiers for one type of object change are not repeated. <br><br><pre> <code class="objectivec hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">@interface</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">RamblerIndexerStateStorage</span></span></span><span class="hljs-class"> : </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">NSObject</span></span></span><span class="hljs-class"> - (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">void</span></span></span><span class="hljs-class">)</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">insertTransaction</span></span></span><span class="hljs-class">:(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">RamblerIndexTransaction</span></span></span><span class="hljs-class"> *)</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">transaction</span></span></span><span class="hljs-class">; - (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">void</span></span></span><span class="hljs-class">)</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">insertTransactionsArray</span></span></span><span class="hljs-class">:(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">NSArray</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">NSArray</span></span></span><span class="hljs-class"> *&gt; *)</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">transactionsArray</span></span></span><span class="hljs-class">                    </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">changeType</span></span></span><span class="hljs-class">:(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">RamblerChangeType</span></span></span><span class="hljs-class">)</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">changeType</span></span></span><span class="hljs-class">; - (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">RamblerIndexTransactionBatch</span></span></span><span class="hljs-class"> *)</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">obtainTransactionBatch</span></span></span><span class="hljs-class">; - (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">void</span></span></span><span class="hljs-class">)</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">removeProcessedBatch</span></span></span><span class="hljs-class">:(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">RamblerIndexTransactionBatch</span></span></span><span class="hljs-class"> *)</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">batch</span></span></span><span class="hljs-class"> - (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">BOOL</span></span></span><span class="hljs-class">)</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">shouldPerformInitialIndexing</span></span></span><span class="hljs-class">; @</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">end</span></span></span></span></code> </pre><br>  <b>System kernel (Monitor)</b> - <b>IndexerMonitor</b> - this module <b>connects all other parts of the system</b> .  The monitor contains: <br><ul><li>  a set of indexers and providers for each type of object; <br></li><li>  StateStorage for saving changes coming from providers; <br></li><li>  the queue in which the operation is put for indexing a set of changes; <br></li><li>  CSSearchableIndex, and acts as its delegate. <br></li></ul><br><pre> <code class="objectivec hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">@interface</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">RamblerIndexerMonitor</span></span></span><span class="hljs-class"> : </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">NSObject</span></span></span><span class="hljs-class"> - (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">void</span></span></span><span class="hljs-class">)</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">startMonitor</span></span></span><span class="hljs-class">; - (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">void</span></span></span><span class="hljs-class">)</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">stopMonitor</span></span></span><span class="hljs-class">; - (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">void</span></span></span><span class="hljs-class">)</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">addIndexer</span></span></span><span class="hljs-class">:(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">id</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">RamblerIndexer</span></span></span><span class="hljs-class">&gt;)</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">indexer</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">withChangeProvider</span></span></span><span class="hljs-class">:(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">id</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">RamblerChangeProvider</span></span></span><span class="hljs-class">&gt;)</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">changeProvider</span></span></span><span class="hljs-class">; @</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">end</span></span></span></span></code> </pre><br><h2>  Work algorithm </h2><br><img src="https://habrastorage.org/files/72a/6b0/624/72a6b0624e9b40e8b167a2cc772ed235.png"><br><br>  The whole process can be divided into two logical periods: <br><ul><li>  <b>Saving changes</b> - at this stage events about changes are collected and saved to the database.  The stages of this period are marked on the chart with red markers. <br></li><li>  <b>Indexing Changes</b> ‚Äî retrieving a set of changes and indexing them.  Stages of the period are marked with purple markers. <br></li></ul><br><h2>  Stages of saving changes: </h2><br><ol><li>  Using the delegate method NSFetchedResultsController informs the provider (&lt;ChangeProvider&gt;) about a change in the object in the source database. <br><br><pre> <code class="objectivec hljs">- (<span class="hljs-keyword"><span class="hljs-keyword">void</span></span>)controller:(<span class="hljs-built_in"><span class="hljs-built_in">NSFetchedResultsController</span></span> *)controller didChangeObject:(<span class="hljs-built_in"><span class="hljs-built_in">NSManagedObject</span></span> *)anObject atIndexPath:(<span class="hljs-built_in"><span class="hljs-built_in">NSIndexPath</span></span> *)indexPath forChangeType:(<span class="hljs-built_in"><span class="hljs-built_in">NSFetchedResultsChangeType</span></span>)type newIndexPath:(<span class="hljs-built_in"><span class="hljs-built_in">NSIndexPath</span></span> *)newIndexPath;</code> </pre><br></li><li>  The provider calls the delegate method on the monitor, in which it transfers itself, the object and the type of change. <br><pre> <code class="objectivec hljs">- (<span class="hljs-keyword"><span class="hljs-keyword">void</span></span>)changeProvider:(<span class="hljs-keyword"><span class="hljs-keyword">id</span></span>&lt;RamblerChangeProvider&gt;)changeProvider didChangeObject:(<span class="hljs-keyword"><span class="hljs-keyword">id</span></span>)object changeType:(RamblerChangeType)changeType;</code> </pre><br></li><li>  The monitor identifies the indexer associated with it by the provider and asks for its identifier for this object.  The indexer uses the IndexIdentifierFormatter for this.  The monitor then forms the transaction from the identifier and the type of change, and then sends it to the StateStorage. <br></li><li>  StateStorage queries or creates an IndexState (NSManagedObject) for the current object type and populates its OrderSets (insertIdentifiers, updateIdentifiers, deleteIdentifiers).  Sets the modification date needed to determine the relevance of changes.  And writes changes to the database. <br></li></ol><br><h2>  Stages of indexing changes: </h2><br><ol><li>  On a specific event, for example, calling the delegate method of the indexer, starting monitoring or exiting the background, the monitor understands that you need to start indexing if it is not currently being performed. <br></li><li>  The monitor queries the StateStorage for a set of changes in the form of an IndexTransactionBatch object, which contains changes for only one type of object (created from IndexState). <br></li><li>  Monitor using the method <pre> <code class="objectivec hljs">- (<span class="hljs-built_in"><span class="hljs-built_in">BOOL</span></span>)canIndexObjectWithType:(<span class="hljs-built_in"><span class="hljs-built_in">NSString</span></span> *)objectType</code> </pre>  finds the first indexer that can process a change set with a particular type of object, and passes that set to it to create an indexing operation. <br></li><li>  The indexer creates an operation and returns it to the monitor. <br></li><li>  The monitor adds an operation to the processing queue.  By calling the end of the operation block, if the indexing was successful, the batch will be passed to the StateStorage to remove all processed identifiers from the database.  After that, you can handle the following changes. <br></li></ol><br><h2>  Operation: </h2><br><ol><li>  combines insertIdentifiers and updateIdentifiers, leaving only unique identifiers, and then deletes identifiers from deleteIdentifiers from the resulting OrderSet; <br></li><li>  queries the indexer for indexed objects; <br></li><li>  for the resulting objects, it requests the CSSearchableItem array and submits them to the CSSearchableIndex indexing; <br></li><li>  when done, passes the deleteIdentifiers to CSSearchableIndex to remove from the search results; <br></li><li>  after that the completion block is called, which is passed to the method. <br></li></ol><br><h2>  Primary indexing </h2><br>  When our system first starts, the monitor asks the StateStorage for initial indexing.  StateStorage, in turn, looks to see if at least one IndexState exists.  If there is no record, then primary indexing has not yet occurred.  The monitor requests from all providers a list of objects for primary indexing, creating an array of transaction arrays from them (one array for each type of object).  All this is passed on to save in StateStorage. <br><br>  StateStorage saves all these changes for one <a href="https://developer.apple.com/library/prerelease/ios/documentation/Cocoa/Reference/CoreDataFramework/Classes/NSManagedObjectContext_Class/index.html">performBlockAndWait</a> , which guarantees us atomicity.  As a result, either all changes will be saved, or none (if the application is turned off), in which case the primary indexing will be performed anew. <br><br><h2>  Total </h2><br>  We received a system that can be easily expanded and built in for indexing an object of any type, and also satisfies all the other requirements set by us at the beginning of the article. <br><br>  For the integration, we will need to define several of our own indexers that will inherit the basic functionality of the RamblerIndexerBase class, as well as several providers if the objects are not stored in the database.  Otherwise, you can use the RamblerFetchedResultsControllerChangeProvider class.  After that, the entire system is assembled together, either manually or using a DI framework, for example, <a href="http://typhoonframework.org/">Typhoon</a> . <br><br>  Some features of the work: <br><ul><li>  The monitor must <b>process the delegate methods of CSSearchableIndex</b> to re-index objects.  You also need to know that in iOS there is a limit on the number of indexed objects: these are 10K objects and approximately 130 MB of the total size of indexing. <br></li><li>  Indexing should be done <b>simultaneously in only one stream</b> .  That is why we use a <b>queue of operations</b> . <br></li><li>  Do not use spaces for identifiers. <br></li><li>  To increase the relevance of search results, you should implement the <b>NSUserActivity</b> and use the same identifier and the same attributes as in the CoreSpotlight implementation.  To do this, you can use the already prepared indexer. <br></li><li>  It is recommended to use <b>from five to ten keywords</b> . <br></li></ul><br>  The system presented in this article will soon be published on <b>GitHub</b> , we will inform <a href="https://twitter.com/rambler_ios">Rambler.iOS</a> on Twitter, and also add a link to this article. <br><br>  The processing of the discovery of search results will be covered in the next section.  In addition, we will touch on such topics as spacing logic for various application launch options (by push-notification, from search results, normal launch), processing input parameters when opening (userInfo from notification, NSUserActivity), ways to go to the desired screen (for example, manually picking up a navigation stack with several storyboards). <br><br><h2>  Useful links: </h2><br>  Documentation: <br>  <a href="https://developer.apple.com/library/prerelease/ios/technotes/tn2416/_index.html">iOS Search API Best Practices and FAQs</a> <br>  <a href="https://developer.apple.com/library/prerelease/ios/documentation/General/Conceptual/AppSearch/">App Search Programming Guide</a> <br>  <a href="https://developer.apple.com/library/ios/documentation/Foundation/Reference/NSUserActivity_Class/index.html">NSUserActivity Class Reference</a> <br>  <a href="https://developer.apple.com/library/ios/documentation/CoreSpotlight/Reference/CoreSpotlight_Framework/index.html">Core Spotlight Framework Reference</a> <br><br>  Video from WWDC 2015: <br>  <a href="https://developer.apple.com/videos/wwdc/2015/%3Fid%3D709">WWDC 2015 Introducing Search APIs</a> <br>  <a href="https://developer.apple.com/videos/wwdc/2015/%3Fid%3D509">Seamless Linking to Your App</a> <br><br>  Code examples: <br>  <a href="https://www.andyibanez.com/wwdc-2015-introducing-search-apis/">WWDC 2015: Introducing Search APIs by Andr√©s Iba√±ez</a> <br>  <a href="http://code.tutsplus.com/tutorials/ios-9-introducing-search-apis--cms-24375">iOS 9: Introducing Search APIs by Davis Allie</a> </div><p>Source: <a href="https://habr.com/ru/post/268257/">https://habr.com/ru/post/268257/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../268245/index.html">Module example for Magento 2</a></li>
<li><a href="../268247/index.html">Network overlay technologies for data centers. Part 2</a></li>
<li><a href="../268249/index.html">Flux in pictures</a></li>
<li><a href="../268251/index.html">Welcome to GDG DevFest Voronezh 2015</a></li>
<li><a href="../268253/index.html">Usability Authorization Forms</a></li>
<li><a href="../268259/index.html">The problem of cheats in online games</a></li>
<li><a href="../268261/index.html">Three-Way Bitwise Quick Sort</a></li>
<li><a href="../268265/index.html">AngularJS: Migration from 1.2 to 1.4, Part 1</a></li>
<li><a href="../268267/index.html">Sometimes less is better - why only Google authorization? + channel Rusbase</a></li>
<li><a href="../268269/index.html">Why I chose Yii2</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>