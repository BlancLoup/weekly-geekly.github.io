<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Several useful tricks for developing on Yii 2</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="I collected several classes and snippets from the ‚Äútips & tricks‚Äù series that could be useful to someone. 
 Content: 
 - Several attributes in one col...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Several useful tricks for developing on Yii 2</h1><div class="post__text post__text-html js-mediator-article">  I collected several classes and snippets from the ‚Äútips &amp; tricks‚Äù series that could be useful to someone. <br>  Content: <br>  - <a href="https://habr.com/ru/post/303406/">Several attributes in one column grid</a> <br>  - <a href="https://habr.com/ru/post/303406/">Navigation fix for active menu items</a> <br>  - <a href="https://habr.com/ru/post/303406/">Mapping tables to other names</a> <br>  - <a href="https://habr.com/ru/post/303406/">Why TimestampBehavior updates the updated_at property if nothing is changed</a> <br>  - <a href="https://habr.com/ru/post/303406/">Bootstrap DateTimePicker - 2 different formats for displaying in the interface and for sending the value to the server</a> <br>  - <a href="https://habr.com/ru/post/303406/">Accounting user time zone for fields with DateTimePicker</a> <br><a name="habracut"></a><br><br>  First, create a simple CRUD application with a single Product model. <br><br> <a href=""><img src="https://habrastorage.org/files/311/5b4/52a/3115b452a211470482656bf938e08183.png"><br></a> 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <a name="combineddatacolumn"></a><br><h4>  Several attributes in one column grid. </h4><br>  Suppose we want to combine the ‚ÄúCreated At‚Äù and ‚ÄúUpdated At‚Äù columns into one, to save space, but at the same time we want to save the column configuration and sorting by them.  To do this, create a separate small class for the combo box, inherited from the usual ‚ÄúDataColumn‚Äù and specify it in the configuration. <br><br><div class="spoiler">  <b class="spoiler_title">CombinedDataColumn</b> <div class="spoiler_text"><pre><code class="php hljs"><span class="hljs-comment"><span class="hljs-comment">// common/components/grid/CombinedDataColumn.php namespace common\components\grid; use yii\grid\DataColumn; /** * Renders several attributes in one grid column */ class CombinedDataColumn extends DataColumn { /* @var $labelTemplate string */ public $labelTemplate = null; /* @var $valueTemplate string */ public $valueTemplate = null; /* @var $attributes string[] | null */ public $attributes = null; /* @var $formats string[] | null */ public $formats = null; /* @var $values string[] | null */ public $values = null; /* @var $labels string[] | null */ public $labels = null; /* @var $sortLinksOptions string[] | null */ public $sortLinksOptions = null; /** * Sets parent object parameters for current attribute * @param $key string Key of current attribute * @param $attribute string Current attribute */ protected function setParameters($key, $attribute) { list($attribute, $format) = array_pad(explode(':', $attribute), 2, null); $this-&gt;attribute = $attribute; if (isset($format)) { $this-&gt;format = $format; } else if (isset($this-&gt;formats[$key])) { $this-&gt;format = $this-&gt;formats[$key]; } else { $this-&gt;format = null; } if (isset($this-&gt;labels[$key])) { $this-&gt;label = $this-&gt;labels[$key]; } else { $this-&gt;label = null; } if (isset($this-&gt;sortLinksOptions[$key])) { $this-&gt;sortLinkOptions = $this-&gt;sortLinksOptions[$key]; } else { $this-&gt;sortLinkOptions = []; } if (isset($this-&gt;values[$key])) { $this-&gt;value = $this-&gt;values[$key]; } else { $this-&gt;value = null; } } /** * Sets parent object parameters and calls parent method for each attribute, then renders combined cell content * @inheritdoc */ protected function renderHeaderCellContent() { if (!is_array($this-&gt;attributes)) { return parent::renderHeaderCellContent(); } $labels = []; foreach ($this-&gt;attributes as $i =&gt; $attribute) { $this-&gt;setParameters($i, $attribute); $labels['{'.$i.'}'] = parent::renderHeaderCellContent(); } if ($this-&gt;labelTemplate === null) { return implode('&lt;br&gt;', $labels); } else { return strtr($this-&gt;labelTemplate, $labels); } } /** * Sets parent object parameters and calls parent method for each attribute, then renders combined cell content * @inheritdoc */ protected function renderDataCellContent($model, $key, $index) { if (!is_array($this-&gt;attributes)) { return parent::renderDataCellContent($model, $key, $index); } $values = []; foreach ($this-&gt;attributes as $i =&gt; $attribute) { $this-&gt;setParameters($i, $attribute); $values['{'.$i.'}'] = parent::renderDataCellContent($model, $key, $index); } if ($this-&gt;valueTemplate === null) { return implode('&lt;br&gt;', $values); } else { return strtr($this-&gt;valueTemplate, $values); } } }</span></span></code> </pre> <br></div></div><br><br><pre> <code class="php hljs"><span class="hljs-comment"><span class="hljs-comment">// frontend/views/product/index.php GridView::widget([ 'dataProvider' =&gt; $dataProvider, 'columns' =&gt; [ ['class' =&gt; 'yii\grid\SerialColumn'], 'id', 'name', [ 'class' =&gt; 'common\components\grid\CombinedDataColumn', 'labelTemplate' =&gt; '{0} / {1}', 'valueTemplate' =&gt; '{0} / {1}', 'labels' =&gt; [ 'Created At', '[ Updated At ]', ], 'attributes' =&gt; [ 'created_at:datetime', 'updated_at:html', ], 'values' =&gt; [ null, function ($model, $_key, $_index, $_column) { return '[ ' . Yii::$app-&gt;formatter-&gt;asDatetime($model-&gt;updated_at) . ' ]'; }, ], 'sortLinksOptions' =&gt; [ ['class' =&gt; 'text-nowrap'], null, ], ], ['class' =&gt; 'yii\grid\ActionColumn'], ], ]);</span></span></code> </pre><br><br><img src="https://habrastorage.org/files/e62/ad2/414/e62ad24144b3473d8ffccee0203ffa2b.png" align="left"><img src="https://habrastorage.org/files/9d5/77f/f5f/9d577ff5f54141b681d0be67cb0025f8.png" align="left"><br><br clear="all">  Let's make the default sorting be by id DESC. <br><br><pre> <code class="php hljs"><span class="hljs-comment"><span class="hljs-comment">// frontend/models/ProductSearch.php public function search($params) { ... if (empty($dataProvider-&gt;sort-&gt;getAttributeOrders())) { $dataProvider-&gt;query-&gt;orderBy(['id' =&gt; SORT_DESC]); } ... }</span></span></code> </pre><br>  If you do through <code>$dataProvider-&gt;sort-&gt;defaultOrder</code> , then in the grid in the column name is added the sort icon. <br><br><br><a name="nav"></a><br><h4>  Navigation fix for active menu items </h4><br>  Add user management.  We put the module ‚Äúdektrium / yii2-user‚Äù, apply the migration, add the admin user (with the password 123456, as without it), fix the links in the menu in ‚Äúlayouts / main.php‚Äù.  Go to the page "/ user / login".  The link "Login" in the menu is inactive. <br><br><pre> <code class="php hljs"><span class="hljs-comment"><span class="hljs-comment">// frontend/views/layouts/main.php if (Yii::$app-&gt;user-&gt;isGuest) { $menuItems[] = ['label' =&gt; 'Login', 'url' =&gt; ['/user/login']]; }</span></span></code> </pre><br><img src="https://habrastorage.org/files/97a/c4f/ade/97ac4fadebc443d5bb06560d303cade8.png"><br><br>  This is because the module adds its own routing rules.  In order for such links to be active, you need to indicate in them the resulting URL, which is obtained after applying these rules (in this case "/ user / security / login").  It does not suit us, because why do we need routes for beautiful URLs? <br><br>  Let's make the <code>common\components\bootstrap\Nav</code> class inherited from <code>yii\bootstrap\Nav</code> , and override the <code>isItemActive()</code> method, in which we add a couple of match checks to <code>Yii::$app-&gt;request-&gt;getUrl()</code> .  In the ‚Äúlayouts / main.php‚Äù section of the ‚Äúuse‚Äù section, we indicate our class <br><br><div class="spoiler">  <b class="spoiler_title">Nav</b> <div class="spoiler_text"><pre> <code class="php hljs"><span class="hljs-comment"><span class="hljs-comment">// common/components/bootstrap/Nav.php namespace common\components\bootstrap; use Yii; use yii\bootstrap\Nav as YiiBootstrapNav; /** * @inheritdoc */ class Nav extends YiiBootstrapNav { /** * Adds additional check - directly compare item URL and request URL. * Used to make an item active when item URL is handled by module routing * * @inheritdoc */ protected function isItemActive($item) { if (parent::isItemActive($item)) { return true; } if (!isset($item['url'])) { return false; } $route = null; $itemUrl = $item['url']; if (is_array($itemUrl) &amp;&amp; isset($itemUrl[0])) { $route = $itemUrl[0]; if ($route[0] !== '/' &amp;&amp; Yii::$app-&gt;controller) { $route = Yii::$app-&gt;controller-&gt;module-&gt;getUniqueId() . '/' . $route; } } else { $route = $itemUrl; } $requestUrl = Yii::$app-&gt;request-&gt;getUrl(); $isActive = ($route === $requestUrl || (Yii::$app-&gt;homeUrl . $route) === '/' . $requestUrl); return $isActive; } }</span></span></code> </pre><br></div></div><br><br><img src="https://habrastorage.org/files/3fe/365/443/3fe365443f3947adb82f3239a9cbc043.png"><br><br><br><br>  Add TimestampBehavior to the Product model <br><br><pre> <code class="php hljs"><span class="hljs-comment"><span class="hljs-comment">// common/models/Product.php public function behaviors() { return [ 'TimestampBehavior' =&gt; [ 'class' =&gt; \yii\behaviors\TimestampBehavior::className(), 'value' =&gt; function () { return date('Ymd H:i:s'); }, ], ]; }</span></span></code> </pre><br><br>  So far, everything is working fine.  We will come back to this. <br><br><br><a name="tablemap"></a><br><h4>  Mapping tables to other names </h4><br>  Let's make the application a little harder.  Add session storage in the database and RBAC for managing access rights. <br>  We also add the columns ‚Äúuser_id‚Äù and ‚Äúcategory_id‚Äù to the ‚Äúproduct‚Äù table. <br><br><div class="spoiler">  <b class="spoiler_title">teams</b> <div class="spoiler_text"><pre> <code class="bash hljs">php yii migrate --migrationPath=@vendor/yiisoft/yii2/web/migrations php yii migrate --migrationPath=@yii/rbac/migrations php yii migrate</code> </pre><br></div></div><br><div class="spoiler">  <b class="spoiler_title">migration</b> <div class="spoiler_text"><pre> <code class="php hljs"><span class="hljs-comment"><span class="hljs-comment">// product_user $this-&gt;addColumn('{{%product}}', 'user_id', $this-&gt;integer()-&gt;after('id') ); $this-&gt;addForeignKey('fk_product_user', '{{%product}}', 'user_id', '{{%user}}', 'id'); // product_category $this-&gt;createTable('{{%category}}', [ 'id' =&gt; $this-&gt;primaryKey(), 'name' =&gt; $this-&gt;string(100), ]); $this-&gt;addColumn('{{%product}}', 'category_id', $this-&gt;integer()-&gt;after('user_id') ); $this-&gt;addForeignKey('fk_product_category', '{{%product}}', 'category_id', '{{%category}}', 'id');</span></span></code> </pre><br></div></div><br><br>  Let's look at our database. <br><br><img src="https://habrastorage.org/files/db7/cae/635/db7cae63560f44f393349bdb84fc3ca5.png"><br><br>  Something has become a lot of our tables, so right away you won‚Äôt understand where it came from, which ones belong to the application, and which belong to the secondary modules.  What if they rename them?  And it is desirable to change nothing in the code. <br><br><img src="https://habrastorage.org/files/9e5/e0b/f2c/9e5e0bf2ce7140ea99eec97fd1df034d.png"><br><br>  To do this, you need to make your own classes for working with the database connection and with the schema inherited from the standard ones, in which you override the <code>quoteSql()</code> and <code>getRawTableName()</code> methods.  In the connection class there will be a new property <code>$tableMap</code> , in which you can set the correspondence between the internal name of the table, which is used in the application, and the real one, which is used in the database. <br><br><div class="spoiler">  <b class="spoiler_title">Connection</b> <div class="spoiler_text"><pre> <code class="php hljs"><span class="hljs-comment"><span class="hljs-comment">// common/components/db/Connection.php namespace common\components\db; use Yii; use yii\db\Connection as BaseConnection; /** * Allows to add mapping between internal table name used in application and real table name * Can be used to set different prefixes for tables from different modules, just to group them in DB */ class Connection extends BaseConnection { /** * @var array Mapping between internal table name used in application and real table name * Can be used to add different prefixes for tables from different modules * Example: 'tableMap' =&gt; ['%session' =&gt; '%__web__session'] */ public $tableMap = []; /** * @inheritdoc */ public function quoteSql($sql) { return preg_replace_callback( '/(\\{\\{(%?[\w\-\. ]+%?)\\}\\}|\\[\\[([\w\-\. ]+)\\]\\])/', function ($matches) { if (isset($matches[3])) { return $this-&gt;quoteColumnName($matches[3]); } else { return $this-&gt;getRealTableName($matches[2]); } }, $sql ); } /** * Returns real table name which is used in database * @param $tableName string * @param $useMapping bool */ public function getRealTableName($tableName, $useMapping = true) { $tableName = ($useMapping &amp;&amp; isset($this-&gt;tableMap[$tableName]) ? $this-&gt;tableMap[$tableName] : $tableName); $tableName = str_replace('%', $this-&gt;tablePrefix, $this-&gt;quoteTableName($tableName)); return $tableName; } }</span></span></code> </pre><br></div></div><br><div class="spoiler">  <b class="spoiler_title">mysql / Schema</b> <div class="spoiler_text"><pre> <code class="php hljs"><span class="hljs-comment"><span class="hljs-comment">// common/components/db/mysql/Schema.php namespace common\components\db\mysql; use yii\db\mysql\Schema as BaseSchema; /** * @inheritdoc */ class Schema extends BaseSchema { /** * @inheritdoc * Also gets real table name from database connection object before replacing table prefix */ public function getRawTableName($name) { if (strpos($name, '{{') !== false) { $name = preg_replace('/\\{\\{(.*?)\\}\\}/', '\1', $name); $name = $this-&gt;db-&gt;getRealTableName($name); return $name; } else { return $name; } } }</span></span></code> </pre><br></div></div><br><br><pre> <code class="php hljs"><span class="hljs-comment"><span class="hljs-comment">// common/config/main.php 'components' =&gt; [ ... 'db' =&gt; [ 'class' =&gt; 'common\components\db\Connection', 'schemaMap' =&gt; [ 'mysql' =&gt; 'common\components\db\mysql\Schema', ], 'tableMap' =&gt; [ '%migration' =&gt; '%__db__migration', '%session' =&gt; '%__web__session', '%auth_assignment' =&gt; '%__rbac__auth_assignment', '%auth_item' =&gt; '%__rbac__auth_item', '%auth_item_child' =&gt; '%__rbac__auth_item_child', '%auth_rule' =&gt; '%__rbac__auth_rule', '%user' =&gt; '%__user__user', '%profile' =&gt; '%__user__profile', '%token' =&gt; '%__user__token', '%social_account' =&gt; '%__user__social_account', ], ], ... ],</span></span></code> </pre><br>  <sub>the name of the table "__user__user" looks a bit strange, you can not rename it, here just for clarity</sub> <br><br>  If the configuration is set in the file ‚Äúconfig / main.php‚Äù, then the line <code>'class' =&gt; 'yii\db\Connection'</code> should be removed from ‚Äúconfig / main-local.php‚Äù, since it will be connected later, and this parameter will be redefined.  Or set the entire config in "config / main-local.php".  Perhaps this is even better, with the development will be clear names, but in the production of normal. <br><br>  Renaming tables do not need to be migrated.  If you clone the project with these settings and start the migration, the tables will be created with new names.  It is also quite difficult to rename the migration table itself in the migration.  You can dance with a tambourine around copying the table and checking for its presence with a new name, but this is hardly justified. <br><br><br><a name="timestampbehavior"></a><br><h4>  Why TimestampBehavior updates the updated_at property if nothing is changed </h4><br>  Let's go into editing any product and set the user and category.  Note that the property ‚ÄúUpdated At‚Äù has been updated.  Now we‚Äôll go back to editing and, without changing anything, click Save.  The property ‚ÄúUpdated At‚Äù has been updated again.  So it should not be. <br><br>  This happened because we added ‚Äúuser_id‚Äù and ‚Äúcategory_id‚Äù. <br>  The chain is as follows.  We send the form with a POST request.  The data in it, of course, in string form.  On the server, <code>$model-&gt;load(Yii::$app-&gt;request-&gt;post())</code> called.  It sets, for example, the property <code>user_id = "1" (string)</code> . <br>  Next, <code>$model-&gt;save()</code> is called and the <code>TimestampBehavior</code> (which <code>extends AttributeBehavior</code> ) is triggered. <br><br>  <a href="https://github.com/yiisoft/yii2/blob/master/framework/behaviors/AttributeBehavior.php">AttributeBehavior.php</a> <br><pre> <code class="php hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">evaluateAttributes</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($event)</span></span></span><span class="hljs-function"> </span></span>{ ... &amp;&amp; <span class="hljs-keyword"><span class="hljs-keyword">empty</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;owner-&gt;dirtyAttributes) ... }</code> </pre><br>  <a href="https://github.com/yiisoft/yii2/blob/master/framework/db/BaseActiveRecord.php">BaseActiveRecord.php</a> <br><pre> <code class="php hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getDirtyAttributes</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($names = null)</span></span></span><span class="hljs-function"> </span></span>{ ... || $value !== <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;_oldAttributes[$name]) ... }</code> </pre><br><br>  The value of <code>$this-&gt;_oldAttributes[$name]</code> loaded from the database, and then <code>$this-&gt;_oldAttributes['user_id'] = 1 (int)</code> .  A strict comparison returns false, and the property is considered changed. <br><br><br>  To fix this, you need to add value filtering to the rules () method. <br><br>  For properties that are not null, it's pretty simple, we cast them to int.  For properties that can be null, write a callback.  In our application, the second option. <br><br><pre> <code class="php hljs"><span class="hljs-comment"><span class="hljs-comment">// not null [['user_id', 'category_id'], 'filter', 'filter' =&gt; 'intval'], // null [['user_id', 'category_id'], 'filter', 'filter' =&gt; function ($value) { return ($value === '' ? null : (int)$value); }],</span></span></code> </pre><br><br><br><a name="datetimepicker"></a><br><h4>  Bootstrap DateTimePicker - 2 different formats for displaying in the interface and sending the value to the server </h4><br>  Add the <code>created_from, created_to, updated_from, updated_to</code> filters.  For date / time, I usually use <a href="http://demos.krajee.com/widget-details/datetimepicker">kartik widgets</a> for Bootstrap Datepicker / Datetimepicker. <br><br><img src="https://habrastorage.org/files/c28/5c6/8fa/c285c68faf7b4f54ae7965ebff1e1fd7.png"><br><br>  But there is one problem, they cannot specify different formats for display and for storing value.  As a result, something like ‚Äú14 junio 2016, mar.‚Äù Can be sent to the server.  You can fix this by adding a hidden field with a new format to the rendering.  In the Datetimepicker, you can set the linkField and linkFormat options, and in the Datepicker, you must catch the changeDate event and format it manually.  You also need to handle pressing the clear value button. <br><br><div class="spoiler">  <b class="spoiler_title">Datepicker</b> <div class="spoiler_text"><pre> <code class="php hljs"><span class="hljs-comment"><span class="hljs-comment">// common/widgets/DatePicker.php namespace common\widgets; use Yii; use yii\helpers\Html; use yii\helpers\FormatConverter; use yii\base\InvalidParamException; /** * Extended DatePicker, allows to set different formats for sending and displaying value */ class DatePicker extends \kartik\date\DatePicker { public $saveDateFormat = 'php:Ym-d'; private $savedValueInputID = ''; private $attributeValue = null; public function __construct($config = []) { $defaultOptions = [ 'type' =&gt; static::TYPE_COMPONENT_APPEND, 'convertFormat' =&gt; true, 'pluginOptions' =&gt; [ 'autoclose' =&gt; true, 'format' =&gt; Yii::$app-&gt;formatter-&gt;dateFormat, ], ]; $config = array_replace_recursive($defaultOptions, $config); parent::__construct($config); } public function init() { if ($this-&gt;hasModel()) { $model = $this-&gt;model; $attribute = $this-&gt;attribute; $value = $model-&gt;$attribute; $this-&gt;model = null; $this-&gt;attribute = null; $this-&gt;name = Html::getInputName($model, $attribute); $this-&gt;attributeValue = $value; if ($value) { try { $this-&gt;value = Yii::$app-&gt;formatter-&gt;asDateTime($value, $this-&gt;pluginOptions['format']); } catch (InvalidParamException $e) { $this-&gt;value = null; } } } return parent::init(); } protected function parseMarkup($input) { $res = parent::parseMarkup($input); $res .= $this-&gt;renderSavedValueInput(); $this-&gt;registerScript(); return $res; } protected function renderSavedValueInput() { $value = $this-&gt;attributeValue; if ($value !== null &amp;&amp; $value !== '') { // format value according to saveDateFormat try { $value = Yii::$app-&gt;formatter-&gt;asDate($value, $this-&gt;saveDateFormat); } catch(InvalidParamException $e) { // ignore exception and keep original value if it is not a valid date } } $this-&gt;savedValueInputID = $this-&gt;options['id'].'-saved-value'; $options = $this-&gt;options; $options['id'] = $this-&gt;savedValueInputID; $options['value'] = $value; // render hidden input if ($this-&gt;hasModel()) { $contents = Html::activeHiddenInput($this-&gt;model, $this-&gt;attribute, $options); } else { $contents = Html::hiddenInput($this-&gt;name, $value, $options); } return $contents; } protected function registerScript() { $language = $this-&gt;language ? $this-&gt;language : Yii::$app-&gt;language; $format = $this-&gt;saveDateFormat; $format = strncmp($format, 'php:', 4) === 0 ? substr($format, 4) : FormatConverter::convertDateIcuToPhp($format, $type); $saveDateFormatJs = static::convertDateFormat($format); $containerID = $this-&gt;options['data-datepicker-source']; $hiddenInputID = $this-&gt;savedValueInputID; $script = " $('#{$containerID}').on('changeDate', function(e) { var savedValue = e.format(0, '{$saveDateFormatJs}'); $('#{$hiddenInputID}').val(savedValue).trigger('change'); }).on('clearDate', function(e) { var savedValue = e.format(0, '{$saveDateFormatJs}'); $('#{$hiddenInputID}').val(savedValue).trigger('change'); }); $('#{$containerID}').data('datepicker').update(); $('#{$containerID}').data('datepicker')._trigger('changeDate'); "; $view = $this-&gt;getView(); $view-&gt;registerJs($script); } }</span></span></code> </pre><br></div></div><br><div class="spoiler">  <b class="spoiler_title">DateTimePicker</b> <div class="spoiler_text"><pre> <code class="php hljs"><span class="hljs-comment"><span class="hljs-comment">// common/widgets/DateTimePicker.php namespace common\widgets; use Yii; use yii\helpers\Html; use yii\helpers\FormatConverter; use yii\base\InvalidParamException; /** * Extended DateTimePicker, allows to set different formats for sending and displaying value */ class DateTimePicker extends \kartik\datetime\DateTimePicker { public $saveDateFormat = 'php:Ymd H:i'; public $removeButtonSelector = '.kv-date-remove'; private $savedValueInputID = ''; private $attributeValue = null; public function __construct($config = []) { $defaultOptions = [ 'type' =&gt; static::TYPE_COMPONENT_APPEND, 'convertFormat' =&gt; true, 'pluginOptions' =&gt; [ 'autoclose' =&gt; true, 'format' =&gt; Yii::$app-&gt;formatter-&gt;datetimeFormat, 'pickerPosition' =&gt; 'top-left', ], ]; $config = array_replace_recursive($defaultOptions, $config); parent::__construct($config); } public function init() { if ($this-&gt;hasModel()) { $model = $this-&gt;model; $attribute = $this-&gt;attribute; $value = $model-&gt;$attribute; $this-&gt;model = null; $this-&gt;attribute = null; $this-&gt;name = Html::getInputName($model, $attribute); $this-&gt;attributeValue = $value; if ($value) { try { $this-&gt;value = Yii::$app-&gt;formatter-&gt;asDateTime($value, $this-&gt;pluginOptions['format']); } catch (InvalidParamException $e) { $this-&gt;value = null; } } } return parent::init(); } public function registerAssets() { $format = $this-&gt;saveDateFormat; $format = strncmp($format, 'php:', 4) === 0 ? substr($format, 4) : FormatConverter::convertDateIcuToPhp($format, $type); $saveDateFormatJs = static::convertDateFormat($format); $this-&gt;savedValueInputID = $this-&gt;options['id'].'-saved-value'; $this-&gt;pluginOptions['linkField'] = $this-&gt;savedValueInputID; $this-&gt;pluginOptions['linkFormat'] = $saveDateFormatJs; return parent::registerAssets(); } protected function parseMarkup($input) { $res = parent::parseMarkup($input); $res .= $this-&gt;renderSavedValueInput(); $this-&gt;registerScript(); return $res; } protected function renderSavedValueInput() { $value = $this-&gt;attributeValue; if ($value !== null &amp;&amp; $value !== '') { // format value according to saveDateFormat try { $value = Yii::$app-&gt;formatter-&gt;asDateTime($value, $this-&gt;saveDateFormat); } catch(InvalidParamException $e) { // ignore exception and keep original value if it is not a valid date } } $options = $this-&gt;options; $options['id'] = $this-&gt;savedValueInputID; $options['value'] = $value; // render hidden input if ($this-&gt;hasModel()) { $contents = Html::activeHiddenInput($this-&gt;model, $this-&gt;attribute, $options); } else { $contents = Html::hiddenInput($this-&gt;name, $value, $options); } return $contents; } protected function registerScript() { $containerID = $this-&gt;options['id'] . '-datetime'; $hiddenInputID = $this-&gt;savedValueInputID; if ($this-&gt;removeButtonSelector) { $script = " $('#{$containerID}').find('{$this-&gt;removeButtonSelector}').on('click', function(e) { $('#{$containerID}').find('input').val('').trigger('change'); $('#{$containerID}').data('datetimepicker').reset(); $('#{$containerID}').trigger('changeDate', { type: 'changeDate', date: null, }); }); $('#{$containerID}').trigger('changeDate', { type: 'changeDate', date: null, }); "; $view = $this-&gt;getView(); $view-&gt;registerJs($script); } } }</span></span></code> </pre><br></div></div><br><br><pre> <code class="php hljs"><span class="hljs-comment"><span class="hljs-comment">// frontend/views/product/_search.php </span><span class="hljs-meta"><span class="hljs-comment"><span class="hljs-meta">&lt;?</span></span></span><span class="hljs-comment">= $form-&gt;field($model, 'created_from')-&gt;widget(\common\widgets\DateTimePicker::classname()) </span><span class="hljs-meta"><span class="hljs-comment"><span class="hljs-meta">?&gt;</span></span></span></span></code> </pre><br><br>  You can also stylize the cleaning button to make it look better. <br><br><div class="spoiler">  <b class="spoiler_title">main.css</b> <div class="spoiler_text"><pre> <code class="css hljs"><span class="hljs-selector-class"><span class="hljs-selector-class">.input-group</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.date</span></span> <span class="hljs-selector-class"><span class="hljs-selector-class">.kv-date-remove</span></span>, <span class="hljs-selector-class"><span class="hljs-selector-class">.input-group</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.date</span></span> <span class="hljs-selector-class"><span class="hljs-selector-class">.kv-date-calendar</span></span> { <span class="hljs-attribute"><span class="hljs-attribute">color</span></span>: <span class="hljs-number"><span class="hljs-number">#626262</span></span>; } <span class="hljs-selector-class"><span class="hljs-selector-class">.input-group</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.date</span></span> <span class="hljs-selector-class"><span class="hljs-selector-class">.kv-date-remove-custom</span></span> { <span class="hljs-attribute"><span class="hljs-attribute">position</span></span>: absolute; <span class="hljs-attribute"><span class="hljs-attribute">z-index</span></span>: <span class="hljs-number"><span class="hljs-number">3</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">color</span></span>: <span class="hljs-number"><span class="hljs-number">#000</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">opacity</span></span>: <span class="hljs-number"><span class="hljs-number">0.4</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">font-size</span></span>: <span class="hljs-number"><span class="hljs-number">16px</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">font-weight</span></span>: <span class="hljs-number"><span class="hljs-number">700</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">line-height</span></span>: <span class="hljs-number"><span class="hljs-number">0.6</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">right</span></span>: <span class="hljs-number"><span class="hljs-number">50px</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">top</span></span>: <span class="hljs-number"><span class="hljs-number">14px</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">cursor</span></span>: pointer; } <span class="hljs-selector-class"><span class="hljs-selector-class">.input-group</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.date</span></span> <span class="hljs-selector-class"><span class="hljs-selector-class">.kv-date-remove-custom</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:hover</span></span> { <span class="hljs-attribute"><span class="hljs-attribute">opacity</span></span>: <span class="hljs-number"><span class="hljs-number">0.6</span></span>; } <span class="hljs-selector-class"><span class="hljs-selector-class">.input-group</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.date</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">input</span></span> { <span class="hljs-attribute"><span class="hljs-attribute">padding-right</span></span>: <span class="hljs-number"><span class="hljs-number">30px</span></span>; } <span class="hljs-selector-class"><span class="hljs-selector-class">.input-group</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.date</span></span> <span class="hljs-selector-class"><span class="hljs-selector-class">.input-group-addon</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.kv-date-calendar</span></span> + <span class="hljs-selector-class"><span class="hljs-selector-class">.kv-date-remove-custom</span></span> { <span class="hljs-attribute"><span class="hljs-attribute">left</span></span>: <span class="hljs-number"><span class="hljs-number">50px</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">right</span></span>: auto; } <span class="hljs-selector-class"><span class="hljs-selector-class">.input-group</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.date</span></span> <span class="hljs-selector-class"><span class="hljs-selector-class">.input-group-addon</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.kv-date-calendar</span></span> + <span class="hljs-selector-class"><span class="hljs-selector-class">.kv-date-remove-custom</span></span> + <span class="hljs-selector-tag"><span class="hljs-selector-tag">input</span></span> { <span class="hljs-attribute"><span class="hljs-attribute">padding-left</span></span>: <span class="hljs-number"><span class="hljs-number">32px</span></span>; }</code> </pre><br></div></div><br><div class="spoiler">  <b class="spoiler_title">_search.php</b> <div class="spoiler_text"><pre> <code class="php hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?php</span></span> <span class="hljs-comment"><span class="hljs-comment">// frontend/views/product/_search.php $dateTimePickerOptions = [ 'removeButton' =&gt; '&lt;span class="kv-date-remove kv-date-remove-custom"&gt;√ó&lt;/span&gt;', 'removeButtonSelector' =&gt; '.kv-date-remove-custom', 'pluginEvents' =&gt; [ 'changeDate' =&gt; "function(e) { var isEmpty = ($(this).find('input').val() == ''); $(this).find('.kv-date-remove-custom').toggle(!isEmpty); }", ], ]; </span><span class="hljs-meta"><span class="hljs-comment"><span class="hljs-meta">?&gt;</span></span></span><span class="hljs-comment"> </span><span class="hljs-meta"><span class="hljs-comment"><span class="hljs-meta">&lt;?</span></span></span><span class="hljs-comment">= $form-&gt;field($model, 'created_from')-&gt;widget(DateTimePicker::classname(), $dateTimePickerOptions) </span><span class="hljs-meta"><span class="hljs-comment"><span class="hljs-meta">?&gt;</span></span></span></span></code> </pre><br></div></div><br> <a href=""><img src="https://habrastorage.org/files/d09/90d/90b/d0990d90b10e4bfeabf55ac2fe8f1caf.png"><br></a> <br><br>  By the way, I'm a little surprised by the fact that many datepickers have localization support, but there is no way to show and send the value in different formats.  In my opinion, datepicker is a direct analogue of the select tag.  In select, we show the text, we send the option value, in the datepicker we show the date in a beautiful and understandable format, we send it in a technical one. <br><br>  The same kartik has a module yii2-datecontrol, in which you can specify a different saving format.  But I didn‚Äôt like it, because by default it sends the displayed text to the server, there it parses, formats it in the specified format for saving and sends it back.  You can set the setting for formatting on the client, but in general it is kind of cumbersome, and there is no reason to put it just to format the date in YYYY-mm-dd. <br><br><br><a name="timezone"></a><br><h4>  Accounting user time zone for fields with DateTimePicker </h4><br>  So, we have date filters.  Now imagine that we have users from different time zones.  Our server and base are in UTC.  Formatting output is set by the formatter settings, but what to do with the input?  The user in the filter sets the time that he expects to see in the grid data.  The solution is simple; after loading the form, you need to convert field values ‚Äã‚Äãwith time from the user's timezone to the server's timezone.  Thus, within the application time will always be in UTC. <br><br><div class="spoiler">  <b class="spoiler_title">InputTimezoneConverter</b> <div class="spoiler_text"><pre> <code class="php hljs"><span class="hljs-comment"><span class="hljs-comment">// common/components/InputTimezoneConverter.php namespace common\components; use Yii; use yii\i18n\Formatter; /** * Allows to convert time values in user timezone (usually from input fields) * into appplication timezone which is used in models * Conversion from application timezone into user timezone * is usulally done by Yii::$app-&gt;formatter-&gt;asDatetime() */ class InputTimezoneConverter { /** @var Formatter */ private $formatter = null; public function __construct($formatter = null) { if ($formatter === null) { // we change formatter configuration so we need to clone it $formatter = clone(Yii::$app-&gt;formatter); } $this-&gt;formatter = $formatter; $this-&gt;formatter-&gt;datetimeFormat = 'php:Ymd H:i:s'; // swap timeZone and defaultTimeZone of default formatter configuration // to perform conversion back to default timezone $timeZone = $this-&gt;formatter-&gt;timeZone; $this-&gt;formatter-&gt;timeZone = $this-&gt;formatter-&gt;defaultTimeZone; $this-&gt;formatter-&gt;defaultTimeZone = $timeZone; } /** * @param $value string */ public function convertValue($value) { if ($value === null || $value === '') { return $value; } return $this-&gt;formatter-&gt;asDatetime($value); } }</span></span></code> </pre><br></div></div><br><br><pre> <code class="php hljs"><span class="hljs-comment"><span class="hljs-comment">// common/config/main.php return [ 'timeZone' =&gt; 'UTC', ... 'components' =&gt; [ ... 'formatter' =&gt; [ 'dateFormat' =&gt; 'php:md-Y', 'datetimeFormat' =&gt; 'php:mdY H:i', 'timeZone' =&gt; 'Europe/Moscow', 'defaultTimeZone' =&gt; 'UTC', ], ... ], ... ];</span></span></code> </pre><br><br><pre> <code class="php hljs"><span class="hljs-comment"><span class="hljs-comment">// frontend/models/ProductSearch.php /** * @inheritdoc * Additionally converts attributes containing time from user timezone to application timezone */ public function load($data, $formName = NULL) { $loaded = parent::load($data, $formName); if ($loaded) { $timeAttributes = ['created_from', 'created_to', 'updated_from', 'updated_to']; $inputTimezoneConverter = new \common\components\InputTimezoneConverter(); foreach ($timeAttributes as $attribute) { $this-&gt;$attribute = $inputTimezoneConverter-&gt;convertValue($this-&gt;$attribute); } } }</span></span></code> </pre><br><br> <a href=""><img src="https://habrastorage.org/files/8d0/44c/1f1/8d044c1f1753483d9d1122b9c975a78c.png"><br></a> <br><br><br><h4>  Widget for javascript code </h4><br>  Sometimes there is a need to write a javascript code in the view file.  Of course, it is better to write it in js-files, but the cases are different.  Often they write it in a string and register through registerJs () to display it at the end of the document along with the rest of the scripts.  But not all editors have lights in the line, and there may be problems with quotes, and without a line it will be displayed in the middle.  You can make a widget that will take the content between <code>begin()</code> and <code>end()</code> calls, remove tags and call <code>registerJs()</code> (by default, <code>\yii\web\View::POS_READY</code> ). <br><br><div class="spoiler">  <b class="spoiler_title">Script</b> <div class="spoiler_text"><pre> <code class="php hljs"><span class="hljs-comment"><span class="hljs-comment">// common/widgets/Script.php namespace common\widgets; use Yii; use yii\web\View; /** * Allows to write javascript in view inside '&lt;script&gt;&lt;/script&gt;' tags and render it at the end of body together with other scripts * '&lt;script&gt;&lt;/script&gt;' tags are removed from result output */ class Script extends \yii\base\Widget { /** @var string Script position, used in registerJs() function */ public $position = View::POS_READY; /** * @inheritdoc */ public function init() { parent::init(); ob_start(); } /** * @inheritdoc */ public function run() { $script = ob_get_clean(); $script = preg_replace('|^\s*&lt;script&gt;|ui', '', $script); $script = preg_replace('|&lt;/script&gt;\s*$|ui', '', $script); $this-&gt;getView()-&gt;registerJs($script, $this-&gt;position); } }</span></span></code> </pre><br></div></div><br><br><pre> <code class="php hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?php</span></span> <span class="hljs-comment"><span class="hljs-comment">// frontend/views/product/_form.php use common\widgets\Script; </span><span class="hljs-meta"><span class="hljs-comment"><span class="hljs-meta">?&gt;</span></span></span><span class="hljs-comment"> </span><span class="hljs-meta"><span class="hljs-comment"><span class="hljs-meta">&lt;?php</span></span></span><span class="hljs-comment"> Script::begin(); </span><span class="hljs-meta"><span class="hljs-comment"><span class="hljs-meta">?&gt;</span></span></span><span class="hljs-comment"> &lt;script&gt; console.log('Product form: $(document).ready()'); &lt;/script&gt; </span><span class="hljs-meta"><span class="hljs-comment"><span class="hljs-meta">&lt;?php</span></span></span><span class="hljs-comment"> Script::end(); </span><span class="hljs-meta"><span class="hljs-comment"><span class="hljs-meta">?&gt;</span></span></span></span></code> </pre><br><br><h4>  Note </h4><br>  I will also leave a link <a href="http://www.yiiframework.com/doc-2.0/guide-tutorial-shared-hosting.html">to the documentation</a> on how to place the advanced application on the same domain (for example, on a hosting).  Google on demand "yii2 advanced single domain" issues examples with Apache configs, but in fact everything is much simpler.  And for the correct link, you need to guess to enter "yii2 advanced shared hosting".  In short, you need to move the ‚Äúbackend / web‚Äù folder to the ‚Äúfrontend / web / admin‚Äù folder and edit the paths in the ‚Äúindex.php‚Äù. <br><br>  All examples can be viewed <a href="https://github.com/michael-vostrikov/yii2-tips/commits/master">on github</a> in separate commits. <br><br></div><p>Source: <a href="https://habr.com/ru/post/303406/">https://habr.com/ru/post/303406/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../303394/index.html">Creating a motion component for a climbing system in the Unreal Engine</a></li>
<li><a href="../303398/index.html">Do you correspond on personal questions from your work computer? Do you know what the European Court thinks about this?</a></li>
<li><a href="../303400/index.html">KUKU.io - how the cloud service is designed for managing social networks</a></li>
<li><a href="../303402/index.html">Databoom control panel. Work with collections. Part 1</a></li>
<li><a href="../303404/index.html">Trying on deduplication and compression to backup</a></li>
<li><a href="../303408/index.html">Intuit has accelerated the site almost 5 times and increased conversion by 20%</a></li>
<li><a href="../303410/index.html">Adopted a law on Google tax</a></li>
<li><a href="../303412/index.html">Fake Ferrari or why camel hump. How systems with circumcised functionality try to take over the world</a></li>
<li><a href="../303416/index.html">Congratulations to the winners of the "Summer Sprint" PETAMelon</a></li>
<li><a href="../303418/index.html">SaltStack: using salt-ssh</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>