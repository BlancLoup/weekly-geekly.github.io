<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Cluster Docker Swarm in 30 seconds</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="This June, as a keynote to the DockerCon conference, we saw a demo in which a 3-node Swarm cluster was created in 30 seconds using the Swarm clusterin...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Cluster Docker Swarm in 30 seconds</h1><div class="post__text post__text-html js-mediator-article"><p><img src="https://habrastorage.org/files/a2f/096/30c/a2f09630c66d4a11bb308a42aa4ff715.JPG"></p><br><p>  This June, as a keynote to the DockerCon conference, we saw a demo in which a 3-node Swarm cluster was created in 30 seconds using the Swarm clustering toolkit integrated into Docker Engine 1.12. </p><br><p>  Impressive, but naturally, I had to try to do it myself in order to see with my own eyes. </p><br><a name="habracut"></a><br><h2>  Creating nodes in your swarm </h2><br><pre><code class="bash hljs">docker-machine create -d virtualbox node1 docker-machine create -d virtualbox node2 docker-machine create -d virtualbox node3 docker-machine ssh node1 <span class="hljs-comment"><span class="hljs-comment">#  2,  3</span></span></code> </pre> <br><p>  I found the easiest way.  To start working with Swarm (Swarm) use docker-machine.  I used the virtualbox driver to create the hosts with Docker Engine installed on them, but you can use any driver you want, for example amazonec2. </p><br><h2>  Initializing your manager </h2><br><pre> <code class="bash hljs">docker swarm init --advertise-addr [advertise ip]:2377</code> </pre> <br><p><img src="https://habrastorage.org/files/697/a7c/3b1/697a7c3b1db445899e877ce6c885caef.png"></p><br><h2>  Joining workers </h2><br><p>  Copy the command displayed below for the first node of your workers to attach it to the cluster. </p><br><pre> <code class="bash hljs">docker swarm join --token [token] [manager ip]:[manager port]</code> </pre> <br><p><img src="https://habrastorage.org/files/468/13d/afa/46813dafaa1e48bdac1eb9e122a36719.png"></p><br><p>  You now have a swarm cluster! </p><br><h2>  Let's deploy something </h2><br><p>  To start the application, we use the Docker service command create.  Using the --replicas flag, you can scale the service very simply. </p><br><p>  Initially, we want to create a top-level network (overlay network) to deploy our application. </p><br><pre> <code class="bash hljs">docker network create -d overlay mynetwork</code> </pre> <br><p>  Before Docker Engine 1.12, overlay networks required external key / value storage, but with the creation of distributed storage in Docker 1.12, this is no longer required. </p><br><p>  Let's deploy a simple Apache application on the public port 5001. I use a special Apache image that I found on DockerHub, which displays the ID of the container that serves the request.  This will later be used to demonstrate load balancing. </p><br><pre> <code class="bash hljs">docker service create --name web --network mynetwork --replicas 3 -p 5001:80 francois/apache-hostname</code> </pre> <br><p>  You can use the following commands to check your new service: </p><br><pre> <code class="bash hljs">docker service ls docker service tasks web</code> </pre> <br><h2>  Routing grid </h2><br><p>  Adding a routing grid and decentralized architecture in Docker 1.12 allows any node-workers in the cluster to route (direct) traffic to other nodes. </p><br><p>  In our web service (described above), we opened a cluster (cluster-wide) port 5001. You can send a request to any node on port 5001, and the routing network will send a request to the node that launched the container. </p><br><pre> <code class="bash hljs">curl [ip]:5001</code> </pre> <br><p><img src="https://habrastorage.org/files/923/acc/389/923acc389ee04afa9d0b530568df11b4.png"></p><br><h2>  Load balancing </h2><br><p>  Whenever a new service is created, a virtual IP is created along with this service.  IPVS owns (implements) load balancing, high-performance level 4 load balancing, which is built into the Linux kernel. </p><br><p>  To show this, run curl several times, to demonstrate changing the container ID. </p><br><p><img src="https://habrastorage.org/files/078/a20/074/078a2007434b4703a118c1588545b758.png"></p><br><p>  Load Balancing with Docker 1.12 is container-aware.  The host-aware balancing system, such as nginx or haproxy, removes or adds containers to the required configuration of the load balancing update and restart of these services.  There is a useful library called Interlock, which listens for the Docker Events API and updates the configuration / restarts the service on the fly.  But this tool is more needed after the new load balancing addition in Docker 1.12. </p><br><h2>  It can't be that easy ... </h2><br><p>  This image from Nigel Poulton summarizes the differences between the old Swarm and the new Swarm very well. </p><br><p><img src="https://habrastorage.org/files/c09/906/320/c09906320600455396c4e2fe9a38379a.jpg"></p><br><p>  <strong>Translation image:</strong> </p><br><p>  Old way (many steps and commands not shown) </p><br><ol><li>  Create keys </li><li>  Restart the manager1 and node1 daemons with the TLS flags at 2376 </li><li>  Launch Consul distributed service (container) </li><li>  Run Consul client on node1 (not shown, but he successfully joined Consul server) </li><li>  Start swarm control (container) on 2376 and card 3376: 2376 <br>  5.1.  Copy keys to the Swarm Manager container using volume and special keys and port for the Swarm command manager <br>  5.2.  Successfully get the leader role </li><li>  Start attaching to swarm container on node1 <br>  6.1.  Do not mount keys inside the container and set the join command as an unsupported option. </li><li>  Configure the client using DOCKER_HOST (pointing to Swarm) <br>  7.1.  ... </li></ol><br><p>  <strong>New way</strong> </p><br><p>  With Docker 1.12, you can also install external distributed services (consul, etcd, zookeeper), or a separate scheduling service as before.  TLS pass-through setting out of the box, no ‚Äúunprotected mode‚Äù.  I have no doubt that the new Docker Swarm is the fastest way to get a running and running docker-native cluster ready to be deployed in production. </p><br><p>  What about large scale?  Thanks to the efforts of the ‚Äúcaptain‚Äù Docker'a Chanwit Kaewkasi and DockerSwarm2000, they showed us that you can create a cluster of 2384 nodes and 96287 containers. </p><br><h2>  Swarm mode is the most optimal </h2><br><p>  Turning on the Swarm mode is completely optional.  You can think of Swarm mode as a set of hidden procedures that are run with just the command </p><br><pre> <code class="bash hljs">docker swarm init</code> </pre> <br><p>  Swarm in Docker 1.12 also supports matching, rolling updates of the image, global and scheduled services based on restrictions. </p><br><h2>  Nocker failure in Docker Swarm </h2><br><p>  I also want to touch on the topic of node failure in Docker Swarm.  Commands related to Docker Engine 1.12 services are declarative.  For example, if you specify the ‚ÄúI want 3 replicas of this service‚Äù command, the cluster will maintain this state. </p><br><p>  In case of node failure of which containers were involved, swarm will detect that the desired state does not coincide with the actual one and will automatically correct the situation by redistributing the containers to other available nodes. </p><br><p>  To demonstrate this, let's set a new service with three replicas. </p><br><pre> <code class="bash hljs">docker service create --name web --replicas 3 francois/apache-hostname</code> </pre> <br><p>  Run to test the service </p><br><pre> <code class="bash hljs">docker service tasks web</code> </pre> <br><p><img src="https://habrastorage.org/files/015/0b5/231/0150b52310804a1aacf0e1004cc920e7.png"></p><br><p>  Now we have one container on each of the nodes.  Let's disable node 3 to look at adjusting the swarm in action. </p><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># Run this on node3 docker swarm leave</span></span></code> </pre> <br><p>  Now the desired state does not coincide with the actual one.  We only have 2 active containers, whereas we designated 3 containers when we started the service. </p><br><p>  Using the docker service gives you the opportunity to see that the number of replicas has decreased to two, and then again returned to three </p><br><p><img src="https://habrastorage.org/files/0bb/55d/dbf/0bb55ddbfd2b45b3bb777196e8cc7a75.png"></p><br><p><img src="https://habrastorage.org/files/9fa/f1a/4ef/9faf1a4ef320443bb1f9a7175e78b23f.png"></p><br><p>  <code>docker service tasks web</code> will show you a new container assigned to another node in your cluster. </p><br><p><img src="https://habrastorage.org/files/453/a4b/2ac/453a4b2aca7041f4a0a5af51743bc201.png"></p><br><p>  This example shows only the regulation of containers on work nodes.  A completely different process occurs when a manager fails, especially if it is the leader of a raft group for solving consensus tasks. </p><br><h2>  Global Services </h2><br><p>  Global services are useful when you want to create a container on each node in your cluster.  Consider keeping a record or monitoring. </p><br><pre> <code class="bash hljs">docker service create --mode=global --name prometheus prom/prometheus</code> </pre> <br><p><img src="https://habrastorage.org/files/3f6/757/cf1/3f6757cf11764eb3b393b293c02139fb.png"></p><br><p>  Remember, I said that services are declarative?  When you add a new node to your cluster, swarm determines that the desired state does not match the actual state, and starts an instance of the global container on that node. </p><br><h2>  Restrictions </h2><br><p>  To demonstrate the limitations, I used the docker machine to speed up the new machine using the engine label. </p><br><pre> <code class="bash hljs">docker-machine create -d virtualbox --engine-label com.example.storage=<span class="hljs-string"><span class="hljs-string">"ssd"</span></span> sw3</code> </pre> <br><p>  Then I added it to the swarm. </p><br><pre> <code class="bash hljs">docker swarm join --token [token] [manager ip]:[manager port]</code> </pre> <br><p>  Next, I created a service that refers to this restriction. </p><br><pre> <code class="bash hljs">docker service create --name web2 --replicas 3 --constraint <span class="hljs-string"><span class="hljs-string">'engine.labels.com.example.storage == ssd'</span></span> francois/apache-hostname</code> </pre> <br><p><img src="https://habrastorage.org/files/ff2/923/da5/ff2923da59d949b9ac39aac201cca787.png"></p><br><p>  Remember, I said that services are declarative?  ;) This means that when we scale this service, it remembers our limitations and scales only the nodes that meet the conditions. </p><br><p><img src="https://habrastorage.org/files/099/cd1/251/099cd12511284429b79fd9f5d9b1c003.png"></p><br><h2>  John zaccone </h2><br><p>  Docker Captain and Software Engineer at Ippon Technologies, who likes to throw things into the market quickly.  Specializes in agile, microservices, containers, automation, REST, devops. </p></div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <p>Source: <a href="https://habr.com/ru/post/310606/">https://habr.com/ru/post/310606/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../310596/index.html">Distributed monitoring: the next expansion of the HostTracker service network</a></li>
<li><a href="../310598/index.html">To the question of the order of operators</a></li>
<li><a href="../310600/index.html">What colors use the most popular sites?</a></li>
<li><a href="../310602/index.html">SDN, NFV, DPDK, ONP, OPNFV and so on</a></li>
<li><a href="../310604/index.html">Checking Windows domain user passwords for resistance to a dictionary attack without password compromise</a></li>
<li><a href="../310608/index.html">Why is it profitable to create a payment business in Europe</a></li>
<li><a href="../310612/index.html">Finding out how to increase WiFi coverage</a></li>
<li><a href="../310614/index.html">IL2CPP: method calls</a></li>
<li><a href="../310616/index.html">Data Leaks in Health: The New Plague</a></li>
<li><a href="../310618/index.html">Masking Bitmaps on Android</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>