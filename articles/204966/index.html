<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Windows Azure Blob-storage: CORS support</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Recently there were many updates to Windows Azure . Among them, the long-awaited support of Cross-Origin Resource Sharing for storage. I use blob-stor...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Windows Azure Blob-storage: CORS support</h1><div class="post__text post__text-html js-mediator-article">  Recently there were many <a href="http://habrahabr.ru/company/microsoft/blog/204758/">updates to Windows Azure</a> .  Among them, the long-awaited support of Cross-Origin Resource Sharing for storage.  I use blob-storage (file storage) in my work and in this post I will describe how to make file uploading easy and enjoyable. <br><a name="habracut"></a><br>  To start working with storage (blob-storage) using CORS, you need to solve the following subtasks: <br>  1. Create a repository <br>  2. Enable CORS support <br>  3. Create a temporary key for writing (Shared Access Signature) <br>  4. Write downloader <br><br><h4>  Creating a repository </h4><br>  Creating a storage is very simple: you need to go to the Azure management portal and create it. <br><div class="spoiler">  <b class="spoiler_title">screen</b> <div class="spoiler_text"><img src="https://habrastorage.org/getpro/habr/post_images/aaf/0e9/919/aaf0e99194d37c07afb7fac8f4c411c5.png"></div></div><br>  After the storage is created, we need its name, access point and access key. <br><div class="spoiler">  <b class="spoiler_title">screen</b> <div class="spoiler_text"><img src="https://habrastorage.org/getpro/habr/post_images/dc2/33d/1ff/dc233d1ff0dec5b843ecc7e4af9a8336.png"><br><img src="https://habrastorage.org/getpro/habr/post_images/7b2/ddf/967/7b2ddf9673c616bcabcdf8255fdb5704.png"><br></div></div><br>  Now you need to make a container, you can create it in the portal or from the code. <br><div class="spoiler">  <b class="spoiler_title">screen</b> <div class="spoiler_text"><img src="https://habrastorage.org/getpro/habr/post_images/6c2/69d/638/6c269d638f31d98b0450aa3e8bf3385c.png"><br></div></div><br><div class="spoiler">  <b class="spoiler_title">c # create blob container</b> <div class="spoiler_text"><pre><code class="cs hljs">CloudStorageAccount account = CloudStorageAccount.Parse(<span class="hljs-string"><span class="hljs-string">"connectionString"</span></span>); CloudBlobClient client = account.CreateCloudBlobClient(); CloudBlobContainer container = client.GetContainerReference(<span class="hljs-string"><span class="hljs-string">"containername"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (container.CreateIfNotExists()) { container.SetPermissions(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> BlobContainerPermissions { PublicAccess = BlobContainerPublicAccessType.Blob }); }</code> </pre> </div></div><br><br><h4>  Enabling CORS Support for File Storage Service </h4><br>  Up to five CORS rules can be created for each storage service (blob, tables and queue).  For our purposes, one is enough.  The rule has several properties. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h5>  Allowed domains </h5><br>  You can add * to allow access from anywhere.  To restrict access from certain domains, it is necessary to add all of them to the list with indication of the protocol and case sensitive (i.e., if you add only http://domain.com, then the request is https://domain.com or http: // Domain.com will not work). <br><br><h5>  Allowed headers </h5><br>  If the request will contain headers not listed, it will not pass.  To upload files, we need two standard headers: accept and content-length, and blobs specific: x-ms-blob-type, x-ms-blob-content-type and x-ms-blob-cache-control. <br><br><h5>  Allowed methods </h5><br>  List of methods that will be accepted by the repository.  To send files, you need a PUT method. <br><br><h5>  Lifetime </h5><br>  The time that the browser has to cache the pre-request (preflight request), from which it learns the CORS settings.  Considering that all successful requests to the repository are billed, it is worth making it large enough. <br><br><h5>  Cors-rule </h5><br>  If you configure from .net (all of the above and below can be done using the REST-API), you will need the Microsoft.WindowsAzure.Storage library of the third version.  The easiest way to extract it is nuget. <br><pre> <code class="bash hljs">PM&gt; Install-Package WindowsAzure.Storage</code> </pre><br><br><pre> <code class="cs hljs">CorsRule corsRule = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> CorsRule { AllowedOrigins = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> List&lt;<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>&gt; { <span class="hljs-string"><span class="hljs-string">"http://allowed.domain.com"</span></span>, <span class="hljs-string"><span class="hljs-string">"https://allowed.domain.com"</span></span> }, AllowedHeaders = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> List&lt;<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>&gt; { <span class="hljs-string"><span class="hljs-string">"x-ms-blob-*"</span></span>, <span class="hljs-string"><span class="hljs-string">"content-type"</span></span>, <span class="hljs-string"><span class="hljs-string">"accept"</span></span> }, AllowedMethods = CorsHttpMethods.Put, MaxAgeInSeconds=<span class="hljs-number"><span class="hljs-number">60</span></span>*<span class="hljs-number"><span class="hljs-number">60</span></span> };</code> </pre><br><br><h5>  Connecting the rule to the service </h5><br><pre> <code class="cs hljs">ServiceProperties serviceProperties = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ServiceProperties { <span class="hljs-comment"><span class="hljs-comment">//  ( ,  ) -     CORS DefaultServiceVersion = "2013-08-15", //,    ,    NullReference exception //    Logging = new LoggingProperties { Version = "1.0", LoggingOperations = LoggingOperations.None }, HourMetrics = new MetricsProperties { Version = "1.0", MetricsLevel = MetricsLevel.None }, MinuteMetrics = new MetricsProperties { Version = "1.0", MetricsLevel = MetricsLevel.None } }; //    serviceProperties.Cors.CorsRules.Add(corsRule); //    client.SetServiceProperties(serviceProperties);</span></span></code> </pre><br><br><h4>  Getting a temporary key. </h4><br>  With this, everything is also simple: the key is a string passed in the address parameters when accessing the repository.  Valid within the object for which permission is given.  In our case it will be a container.  Formed in the following way: <br><pre> <code class="cs hljs">CloudBlobContainer container = client.GetContainerReference(<span class="hljs-string"><span class="hljs-string">"containername"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> key=container.GetSharedAccessSignature(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> SharedAccessBlobPolicy { Permissions = SharedAccessBlobPermissions.Write, SharedAccessStartTime = DateTime.UtcNow.AddMinutes(<span class="hljs-number"><span class="hljs-number">-1</span></span>), <span class="hljs-comment"><span class="hljs-comment">//   SharedAccessExpiryTime = DateTime.UtcNow.AddMinutes(60), //   })</span></span></code> </pre><br><br><h4>  Loader </h4><br>  Now, after all the preparatory activities, you can begin to create a bootloader. <br><br>  In Windows Azure there are two types of blobs - block and page.  The page is optimized for storing streaming data (video, audio, etc.) and cut into pages of 512 bytes.  Their maximum size is 1 TB.  In this example, block blobs will be used, with a maximum size of 400GB.  For the bootloader, it is important that in one download operation it can transfer no more than 64MB.  Those.  the file is cut into blocks not exceeding 64MB and the final operation blocks are glued together.  In the example, files will be loaded in chunks of 512Kb <br><br>  Accordingly, the algorithm of the loader will be as follows. <br><pre> <code class="bash hljs">10    20     30      10 40    </code> </pre><br><br>  The logic of the loader is quite simple, but since everything in our world has become asynchronous, you need to be careful. <br><br>  We will read files using a new and convenient FileReader. <br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> reader=<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> FileReader();</code> </pre><br><br>  Create a handler for it, which, after reading the block, will send it to the repository: <br><pre> <code class="javascript hljs">reader.onloadend = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">e</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (e.target.readyState == FileReader.DONE) { <span class="hljs-comment"><span class="hljs-comment">// DONE == 2 //url    ,  ,  ,      //     var uri = submitUri + '&amp;comp=block&amp;blockid=' + blockIds[blockIds.length - 1]; var requestData = new Uint8Array(e.target.result); $.ajax({ url: uri, type: "PUT", data: requestData, processData: false, //preflight request beforeSend: function (xhr) { xhr.setRequestHeader('x-ms-blob-type', 'BlockBlob'); xhr.setRequestHeader('Content-Length', requestData.length); }, success: function () { bytesUploaded += requestData.length; var percentage = ((parseFloat(bytesUploaded) / parseFloat(files[fileIndex].size)) * 100).toFixed(2); $('#progress_'+fileIndex).text(' : ' + percentage + '%'); processFile(); }, error: function () { $('#progress_' + fileIndex).text(' '); } }); }</span></span></code> </pre><br><br>  And this is what the function of actually reading the file looks like: <br><pre> <code class="javascript hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">processFile</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (bytesRemain &gt; <span class="hljs-number"><span class="hljs-number">0</span></span>) { <span class="hljs-comment"><span class="hljs-comment">//   blockIds.push(btoa(blockId())); //   var fileContent = files[fileIndex].slice(streamPointer, streamPointer + blockSize); reader.readAsArrayBuffer(fileContent); streamPointer += blockSize; bytesRemain -= blockSize; if (bytesRemain &lt; blockSize) { blockSize = bytesRemain; } } else { // ,     commitBlocks(); } }</span></span></code> </pre><br><br>  When the file has been read and all blocks have been sent, you need to inform the repository about it so that it will glue the blocks together. <br><pre> <code class="javascript hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">commitBlocks</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-comment"><span class="hljs-comment">//    var uri = submitUri + '&amp;comp=blocklist'; var requestBody = '&lt;?xml version="1.0" encoding="utf-8"?&gt;&lt;BlockList&gt;'; for (var i = 0; i &lt; blockIds.length; i++) { requestBody += '&lt;Latest&gt;' + blockIds[i] + '&lt;/Latest&gt;'; } requestBody += '&lt;/BlockList&gt;'; $.ajax({ url: uri, type: 'PUT', data: requestBody, beforeSend: function (xhr) { // mime-type  ,  xhr.setRequestHeader('x-ms-blob-content-type', files[fileIndex].type); //  ,   xhr.setRequestHeader('x-ms-blob-cache-control', 'max-age=31536000'); xhr.setRequestHeader('Content-Length', requestBody.length); }, success: function () { $('#progress_' + fileIndex).text(''); ($('&lt;a&gt;').attr('href', storageurl + files[fileIndex].name).text(files[fileIndex].name)).appendTo($('#progress_' + fileIndex)); fileIndex++; startUpload(); }, error: function () { $('#progress_' + fileIndex).text(' '); } }); }</span></span></code> </pre><br><br>  That's all.  Using the capabilities of CORS, you can now upload files directly to the repositories, almost without involving your servers.  And this is good: the server makes less, it takes less, more money is left for everything else. <br><br>  Project sources: <a href="https://github.com/unconnected4/CORSatWindowsAzureBlobStorage">https://github.com/unconnected4/CORSatWindowsAzureBlobStorage</a> <br><br><h6>  Links to read: </h6><br>  <a href="http://habrahabr.ru/post/109079/">HTML5 File API: multiple file uploads to the server</a> <br>  <a href="http://msdn.microsoft.com/en-us/library/windowsazure/dd179451.aspx">Put Blob (REST-API)</a> - important in the list of headers <br>  <a href="http://gauravmantri.com/2013/12/01/windows-azure-storage-and-cors-lets-have-some-fun/">Windows Azure Storage and Cross-Origin Resource Sharing (CORS) - Lets Have Some Fun</a> <br>  <a href="http://gauravmantri.com/2013/02/16/uploading-large-files-in-windows-azure-blob-storage-using-shared-access-signature-html-and-javascript/">Uploading Large Files in Windows Azure Blob Storage Using Shared Access Signature, HTML, and JavaScript</a> <br><br>  <a href="https://plus.google.com/107862204079203068843%3Frel%3Dauthor">g +</a> </div><p>Source: <a href="https://habr.com/ru/post/204966/">https://habr.com/ru/post/204966/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../204954/index.html">24 ways to finally find a good specialist</a></li>
<li><a href="../204956/index.html">Math Focus for MP3, JPEG and Homer Simpson</a></li>
<li><a href="../204958/index.html">Back to the Upper Paleolithic technologies, from everyone's favorite REST, STATEless, CRUD, CGI, Fast–°GI and MVC</a></li>
<li><a href="../204960/index.html">Tesla Model S car was sold in California using Bitcoin as a means of payment</a></li>
<li><a href="../204964/index.html">The final of the open competition in programming artificial intelligence Russian AI Cup 2013</a></li>
<li><a href="../204968/index.html">Stupid sorting and some others, smarter</a></li>
<li><a href="../204970/index.html">We decided to change the operator? Do not forget to find a favorable rate with the help of Dr. Tariff</a></li>
<li><a href="../204972/index.html">Gifts from geeks to relatives and friends</a></li>
<li><a href="../204976/index.html">Bank of America responded to a statement by the Central Bank of China and calculated the fair price for Bitcoin</a></li>
<li><a href="../204978/index.html">Wireless VoIP with Escene WS320-N IP Phone</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>