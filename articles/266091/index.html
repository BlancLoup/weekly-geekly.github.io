<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>We integrate Paypal payment into web-application</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="This article discusses the integration of one-time payments as well as subscription payments using Paypal into a web application. Examples are impleme...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>We integrate Paypal payment into web-application</h1><div class="post__text post__text-html js-mediator-article">  This article discusses the integration of one-time payments as well as subscription payments using Paypal into a web application.  Examples are implemented in PHP, but, in principle, without special problems, the same can be done with the help of other technologies.  This method is chosen as a compromise between simplicity and flexibility.  This is an attempt to write a guide that will help you quickly understand the topic and integrate Paypal payment into your project. <br><br>  The article focuses mainly on those who previously did not work with this system.  Paypal experts are unlikely to find here something new.  But, perhaps, they will point out the shortcomings of this method or advise how this could be done differently. <br><a name="habracut"></a><br><h2>  Account creation </h2><br>  To implement this scheme, we need a business account.  PayPal Payments Standard should be enough. <br>  Follow the <a href="https://www.paypal.com/us/signup/account">link</a> and create an account. <br><br><h2>  Create a sandbox account </h2><br>  To test our application, we will use Paypal Sandbox.  We need 2 sandbox account.  Account of the buyer (buyer) and account of the seller (facilitator).  First of all, you need to set a password for both sandbox accounts.  To do this, go to the paypal site in the <a href="https://developer.paypal.com/">section for developers</a> .  Login, then go to the <a href="https://developer.paypal.com/developer/applications">dashboard</a> .  In the menu on the left we find the Sandbox section, the accounts tab.  Here we can see 2 sandbox accounts (Buyer and Facilitator). 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <img src="https://habrastorage.org/files/b71/555/f0b/b71555f0bd58430ba0d0c138ad2e1802.jpg"><br><br>  Click on the profile, in the appeared modal window click change password, then save the password. <br>  We set passwords for both accounts.  After that you can go to the <a href="https://www.sandbox.paypal.com/">Paypal Sandbox</a> website and try to login. <br><br><h2>  Paypal Setup </h2><br>  Now we need to set up a Paypal Facilitator account for which we will receive funds.  Go to the site Sandbox, log in using the account facilitator and go to the profile settings.  Open the profile menu, select the item my selling tools. <br><br><img src="https://habrastorage.org/files/155/927/e64/155927e64b2e4b1eb47c5b94da1a6bd9.jpg"><br><br>  In the Selling online section, select the Website preferences option, click Update.  Here you can enable user redirection.  After the payment is completed, the default user will be redirected to the specified url.  But it is also possible to redirect the user to another url (see below). <br><br><img src="https://habrastorage.org/files/5cd/d12/0b5/5cdd120b5b0648a8ad69d5b1304a5024.jpg"><br><br>  You also need to activate Paypal Instant Payment Notifications.  To do this, in the section Getting paid and managing my risk, select Instant payment notifications and also click Update. <br><br><img src="https://habrastorage.org/files/d17/0e4/50b/d170e450b286443f996b7e8404bc5121.jpg"><br><br>  In the IPN settings, specify the URL on which our IPN Listener will work.  This URL must be accessible globally.  it will receive notifications of operations. <br><br><img src="https://habrastorage.org/files/4b4/2dd/8e2/4b42dd8e212d4f08973b5a858d1e269f.jpg"><br><br>  Turn on Message delivery and save.  This completes the account setup.  You can proceed to setting up payments directly. <br><br><h2>  One-time Payments </h2><br>  To begin with, we make one-time payments.  This is probably the most common use case.  The user simply wants to buy some product or a one-time service.  Well, it would be desirable that we no longer need to change anything in the paypal settings.  The list of products and prices would be stored in the database of our application, we could change them as we like.  For one-time payments, we will use <a href="https://developer.paypal.com/docs/integration/web/">Payment Buttons (PayPal Payments Standard)</a> . <br><br><h2>  Data structure </h2><br>  The list of goods is stored in the database of our application.  We can add delete and edit products at any time.  Here is the most simple structure, all information is stored in one table. <br><br>  But you can complicate the task.  For example, to change the price depending on the quantity of goods ordered, or to change the cost depending on the day of the week and time. <br><br>  Or include in the order a lot of different products. <br><br>  products - we will store goods here: <br><br><table><tbody><tr><td>  id </td><td>  name </td><td>  price </td><td>  description </td></tr><tr><td>  one </td><td>  Product 1 </td><td>  1.0 </td><td>  ... </td></tr><tr><td>  2 </td><td>  Product 2 </td><td>  4.0 </td><td>  ... </td></tr></tbody></table><br>  users - we will store users here: <br><br><table><tbody><tr><td>  id </td><td>  firstname </td><td>  lastname </td><td>  email </td><td>  password </td></tr><tr><td>  315 </td><td>  Alan </td><td>  Smith </td><td>  alansmith@example.com </td><td>  $ 1 $ 2z4.hu5. $ E3A3H6csEPDBoH8VYK3AB0 </td></tr><tr><td>  316 </td><td>  Joe </td><td>  Doe </td><td>  joedoe@example.com </td><td>  $ 1 $ Kd4.Lf0. $ PGc1h7vwmy9N6EJxac953 / </td></tr></tbody></table><br>  products_users - to whom we are and what we shipped: <br><br><table><tbody><tr><td>  id </td><td>  user_id </td><td>  product_id </td><td>  items_count </td><td>  created_date </td></tr><tr><td>  one </td><td>  315 </td><td>  one </td><td>  3 </td><td>  2015-09-03 08:23:05 </td></tr></tbody></table><br>  We will also store in our database transaction history in the transactions table: <br><br><table><tbody><tr><td>  txn_id </td><td>  txn_type </td><td>  mc_gross </td><td>  mc_currency </td><td>  quantity </td><td>  payment_date </td><td>  payment_status </td><td>  business </td><td>  receiver_email </td><td>  payer_id </td><td>  payer_email </td><td>  relation_id </td><td>  relation_type </td><td>  created_date </td></tr></tbody></table><br><h2>  Form of payment </h2><br>  First, create an order form.  We generate the form in our application, where we indicate the main parameters of the order (product name, price, quantity). <br><br>  Here we can specify any price, name, quantity, etc.  The custom field is useful in that you can transfer any data in it.  Here we will transmit the product id, user id and possibly other information.  We will need this data for further processing of the payment. <br>  If you need to pass several parameters, you can use json or serialization.  Or you can use additional fields like on0, on1, os0 and os1.  Personally, I did not check it, I found the information <a href="http://www.brianmoreau.com/articles/paypal_buy_now_button_sending_custom_variables.php">here</a> . <br><br>  The following is an example of a form: <br><br><pre><code class="php hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?php</span></span> $payNowButtonUrl = <span class="hljs-string"><span class="hljs-string">'https://www.sandbox.paypal.com/cgi-bin/websc'</span></span>; $userId = <span class="hljs-number"><span class="hljs-number">315</span></span> <span class="hljs-comment"><span class="hljs-comment">// id   $receiverEmail = 'xxx-facilitator@yandex.ru'; //email  (   paypal ) $productId = 1; $itemName = 'Product 1'; //   $amount = '1.0'; //  ( 1 .) $quantity = 3; //  $returnUrl = 'http://your-site.com/single_payment?status=paymentSuccess'; $customData = ['user_id' =&gt; $userId, 'product_id' =&gt; $productId]; </span><span class="hljs-meta"><span class="hljs-comment"><span class="hljs-meta">?&gt;</span></span></span><span class="hljs-comment"> &lt;form action="</span><span class="hljs-meta"><span class="hljs-comment"><span class="hljs-meta">&lt;?php</span></span></span><span class="hljs-comment"> echo $payNowButtonUrl; </span><span class="hljs-meta"><span class="hljs-comment"><span class="hljs-meta">?&gt;</span></span></span><span class="hljs-comment">" method="post"&gt; &lt;input type="hidden" name="cmd" value="_xclick"&gt; &lt;input type="hidden" name="business" value="</span><span class="hljs-meta"><span class="hljs-comment"><span class="hljs-meta">&lt;?php</span></span></span><span class="hljs-comment"> echo $receiverEmail; </span><span class="hljs-meta"><span class="hljs-comment"><span class="hljs-meta">?&gt;</span></span></span><span class="hljs-comment">"&gt; &lt;input id="paypalItemName" type="hidden" name="item_name" value="</span><span class="hljs-meta"><span class="hljs-comment"><span class="hljs-meta">&lt;?php</span></span></span><span class="hljs-comment"> echo $itemName; </span><span class="hljs-meta"><span class="hljs-comment"><span class="hljs-meta">?&gt;</span></span></span><span class="hljs-comment">"&gt; &lt;input id="paypalQuantity" type="hidden" name="quantity" value="</span><span class="hljs-meta"><span class="hljs-comment"><span class="hljs-meta">&lt;?php</span></span></span><span class="hljs-comment"> echo $quantity; </span><span class="hljs-meta"><span class="hljs-comment"><span class="hljs-meta">?&gt;</span></span></span><span class="hljs-comment">"&gt; &lt;input id="paypalAmmount" type="hidden" name="amount" value="</span><span class="hljs-meta"><span class="hljs-comment"><span class="hljs-meta">&lt;?php</span></span></span><span class="hljs-comment"> echo $amount; </span><span class="hljs-meta"><span class="hljs-comment"><span class="hljs-meta">?&gt;</span></span></span><span class="hljs-comment">"&gt; &lt;input type="hidden" name="no_shipping" value="1"&gt; &lt;input type="hidden" name="return" value="</span><span class="hljs-meta"><span class="hljs-comment"><span class="hljs-meta">&lt;?php</span></span></span><span class="hljs-comment"> echo $returnUrl; </span><span class="hljs-meta"><span class="hljs-comment"><span class="hljs-meta">?&gt;</span></span></span><span class="hljs-comment">"&gt; &lt;input type="hidden" name="custom" value="</span><span class="hljs-meta"><span class="hljs-comment"><span class="hljs-meta">&lt;?php</span></span></span><span class="hljs-comment"> echo json_encode($customData);</span><span class="hljs-meta"><span class="hljs-comment"><span class="hljs-meta">?&gt;</span></span></span><span class="hljs-comment">"&gt; &lt;input type="hidden" name="currency_code" value="USD"&gt; &lt;input type="hidden" name="lc" value="US"&gt; &lt;input type="hidden" name="bn" value="PP-BuyNowBF"&gt; &lt;button type="submit"&gt; Pay Now &lt;/button&gt; &lt;/form&gt;</span></span></code> </pre> <br>  In fact, the parameters can be much more, detailed information can be found in the <a href="https://developer.paypal.com/docs/classic/paypal-payments-standard/integration-guide/Appx_websitestandard_htmlvariables/">documentation</a> .  After submitting the form, the user goes to the paypal payment page, where he sees the order details again. <br><br><img src="https://habrastorage.org/files/3a9/39f/0f7/3a939f0f70d54ea392f3e4d5a4872f4e.jpg"><br><br>  Here the user can pay for the order using a paypal account or using a credit card.  Next, the user is redirected back to our site (return parameter), where we can inform him that his payment is being processed. <br><br><h2>  Instant Payment Notification (IPN) </h2><br>  After the user makes a payment, Paypal processes it and sends a confirmation to our application.  To do this, use the service <a href="https://developer.paypal.com/docs/classic/products/instant-payment-notification/">Instant Payment Notification (IPN)</a> . <br><br>  At the beginning of the article, we set up our Paypal account and set the IPN Notification URL.  Now is the time to create an IPN listener that will handle IPN requests.  Paypal provides <a href="https://github.com/paypal/ipn-code-samples">an example implementation of IPN listener</a> .  A detailed explanation of the service can be found <a href="https://developer.paypal.com/docs/classic/ipn/integration-guide/IPNIntro/">here</a> .  In a nutshell, how it works: Paypal processes the user's payment, sees that everything is fine and the payment is completed successfully.  After that, the IPN sends a request to this Notification URL of the following type: Post: <br><pre> <code class="hljs perl">mc_gross=<span class="hljs-number"><span class="hljs-number">37.50</span></span>&amp;protection_eligibility=Ineligible&amp;payer_id=J86MHHMUDEHZU&amp;tax=<span class="hljs-number"><span class="hljs-number">0</span></span>.<span class="hljs-number"><span class="hljs-number">00</span></span>&amp;payment_date=<span class="hljs-number"><span class="hljs-number">07</span></span>%3A04%3A48+Mar+<span class="hljs-number"><span class="hljs-number">30</span></span>%2C+<span class="hljs-number"><span class="hljs-number">2015</span></span>+PDT&amp;payment_status=Completed&amp;charset=windows-<span class="hljs-number"><span class="hljs-number">1252</span></span>&amp;first_name=test&amp;mc_fee=<span class="hljs-number"><span class="hljs-number">1.39</span></span>¬¨ify_version=<span class="hljs-number"><span class="hljs-number">3.8</span></span>&amp;custom=%7B%22user_id%22%3A314%2C%22service_provider%22%3A%22twilio%22%2C%22service_name%22%3A%22textMessages%22%7D&amp;payer_status=verified&amp;business=antonshel-facilitator%40gmail.com&amp;quantity=<span class="hljs-number"><span class="hljs-number">150</span></span>&amp;verify_sign=AR-ITpb83c-ktcbmApqG4jM17OeQAx2RSvfYZo4XU8YFZrTSeF.iYsSx&amp;payer_email=antonshel-buyer%40gmail.com&amp;txn_id=<span class="hljs-number"><span class="hljs-number">30</span></span>R69966SH780054J&amp;payment_type=instant&amp;last_name=buyer&amp;receiver_email=antonshel-facilitator%40gmail.com&amp;payment_fee=<span class="hljs-number"><span class="hljs-number">1.39</span></span>&amp;receiver_id=VM2QHCE6FBR3N&amp;txn_type=web_accept&amp;item_name=GetScorecard+Text+Messages&amp;mc_currency=USD&amp;item_number=&amp;residence_country=US&amp;test_ipn=<span class="hljs-number"><span class="hljs-number">1</span></span>&amp;handling_amount=<span class="hljs-number"><span class="hljs-number">0</span></span>.<span class="hljs-number"><span class="hljs-number">00</span></span>&amp;transaction_subject=%7B%22user_id%22%3A314%2C%22service_provider%22%3A%22twilio%22%2C%22service_name%22%3A%22textMessages%22%7D&amp;payment_gross=<span class="hljs-number"><span class="hljs-number">37.50</span></span>&amp;shipping=<span class="hljs-number"><span class="hljs-number">0</span></span>.<span class="hljs-number"><span class="hljs-number">00</span></span>&amp;ipn_track_id=<span class="hljs-number"><span class="hljs-number">6</span></span>b01a2c76197</code> </pre><br>  Our IPN Listener should process this request.  In particular: <br><br><ul><li>  Check the type of request (one-time payment or subscription).  Depending on this, we will process it differently.  In our case it will be a one-time payment - web_accept. </li><li>  Choose environment - sandbox or live. </li><li>  Check the validity of the request.  Knowing what an IPN request looks like and knowing our IPN Notification URL, anyone can send us a fake request.  Therefore, we must perform this check. </li></ul><br><pre> <code class="php hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?php</span></span> <span class="hljs-comment"><span class="hljs-comment">/** * Class PaypalIpn */</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">PaypalIpn</span></span></span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> $debug = <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> $service; <span class="hljs-comment"><span class="hljs-comment">/** * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@throws</span></span></span><span class="hljs-comment"> Exception */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">createIpnListener</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>{ $postData = file_get_contents(<span class="hljs-string"><span class="hljs-string">'php://input'</span></span>); $transactionType = <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;getPaymentType($postData); $config = Config::get(); <span class="hljs-comment"><span class="hljs-comment">//        if($transactionType == PaypalTransactionType::TRANSACTION_TYPE_SINGLE_PAY){ $this-&gt;service = new PaypalSinglePayment(); } elseif($transactionType == PaypalTransactionType::TRANSACTION_TYPE_SUBSCRIPTION){ $this-&gt;service = new PaypalSubscription($config); } else{ throw new Exception('Wrong payment type'); } $raw_post_data = file_get_contents('php://input'); $raw_post_array = explode('&amp;', $raw_post_data); $myPost = array(); foreach ($raw_post_array as $keyval) { $keyval = explode ('=', $keyval); if (count($keyval) == 2) $myPost[$keyval[0]] = urldecode($keyval[1]); } $customData = $customData = json_decode($myPost['custom'],true); $userId = $customData['user_id']; // read the post from PayPal system and add 'cmd' $req = 'cmd=_notify-validate'; if(function_exists('get_magic_quotes_gpc')) { $get_magic_quotes_exists = true; } else{ $get_magic_quotes_exists = false; } foreach ($myPost as $key =&gt; $value) { if($get_magic_quotes_exists == true &amp;&amp; get_magic_quotes_gpc() == 1) { $value = urlencode(stripslashes($value)); } else { $value = urlencode($value); } $req .= "&amp;$key=$value"; } $myPost['customData'] = $customData; $paypal_url = 'https://www.sandbox.paypal.com/cgi-bin/websc'; //$paypal_url = 'https://www.paypal.com/cgi-bin/websc'; //   IPN  $res = $this-&gt;sendRequest($paypal_url,$req); // Inspect IPN validation result and act accordingly // Split response headers and payload, a better way for strcmp $tokens = explode("\r\n\r\n", trim($res)); $res = trim(end($tokens)); /**/ if (strcmp ($res, "VERIFIED") == 0) { //    $this-&gt;service-&gt;processPayment($myPost); } else if (strcmp ($res, "INVALID") == 0) { //     self::log([ 'message' =&gt; "Invalid IPN: $req" . PHP_EOL, 'level' =&gt; self::LOG_LEVEL_ERROR ], $myPost); } /**/ } private function sendRequest($paypal_url,$req){ $debug = $this-&gt;debug; $ch = curl_init($paypal_url); if ($ch == FALSE) { return FALSE; } curl_setopt($ch, CURLOPT_HTTP_VERSION, CURL_HTTP_VERSION_1_1); curl_setopt($ch, CURLOPT_POST, 1); curl_setopt($ch, CURLOPT_RETURNTRANSFER,1); curl_setopt($ch, CURLOPT_POSTFIELDS, $req); curl_setopt($ch, CURLOPT_SSL_VERIFYPEER, 1); curl_setopt($ch, CURLOPT_SSL_VERIFYHOST, 2); curl_setopt($ch, CURLOPT_FORBID_REUSE, 1); if($debug == true) { curl_setopt($ch, CURLOPT_HEADER, 1); curl_setopt($ch, CURLINFO_HEADER_OUT, 1); } curl_setopt($ch, CURLOPT_CONNECTTIMEOUT, 30); // ,  User-Agent -   .     live  curl_setopt($ch, CURLOPT_HTTPHEADER, array('Connection: Close', 'User-Agent: ' . $this-&gt;projectName)); $res = curl_exec($ch); curl_close($ch); return $res; } public function getPaymentType($rawPostData){ $post = $this-&gt;getPostFromRawData($rawPostData); if(isset($post['subscr_id'])){ return "subscr_payment"; } else{ return "web_accept"; } } /** * @param $raw_post_data * @return array */ public function getPostFromRawData($raw_post_data){ $raw_post_array = explode('&amp;', $raw_post_data); $myPost = array(); foreach ($raw_post_array as $keyval) { $keyval = explode ('=', $keyval); if(count($keyval) == 2) $myPost[$keyval[0]] = urldecode($keyval[1]); } return $myPost; } } </span><span class="hljs-meta"><span class="hljs-comment"><span class="hljs-meta">?&gt;</span></span></span></span></code> </pre><br>  After that, if Paypal has confirmed the authenticity of the request, we can proceed to its further processing. <br><br><h2>  Payment processing </h2><br>  First of all we need to get the value of the custom field, where we passed the order id, user id or something else (depending on the logic of our application).  Accordingly, we can get user / order information from our database.  You also need to get the transaction id. <br><br>  Paypal can send confirmation of the same transaction several times.  Therefore, we need to check and, if the transaction has not been processed, we process it.  If the transaction has already been processed, then we do nothing. <br><br>  We carry out the validation of the payment.  If everything is fine, then you can save the payment information to the database and perform further actions (assign the user status ‚Äúpremium‚Äù, order status ‚Äúpaid‚Äù, etc.).  If the payment did not pass validation, you must establish the reason and contact the user.  Further operations, in particular, the cancellation of payment, are carried out manually. <br><br><pre> <code class="php hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?php</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">processPayment</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($myPost)</span></span></span></span>{ $customData = json_decode($myPost[<span class="hljs-string"><span class="hljs-string">'custom'</span></span>],<span class="hljs-keyword"><span class="hljs-keyword">true</span></span>); $userId = $customData[<span class="hljs-string"><span class="hljs-string">'user_id'</span></span>]; $productId = $customData[<span class="hljs-string"><span class="hljs-string">'product_id'</span></span>]; <span class="hljs-comment"><span class="hljs-comment">// $userService = new UserService(); $userInfo = $userService-&gt;getUserData($userId); //       $transactionService = new TransactionService(); $transaction = $transactionService-&gt;getTransactionById($myPost['txn_id']); if($transaction === null){ //      $productService = new ProductService(); $product = $productService-&gt;getProductById($productId); //    if($this-&gt;validateTransaction($myPost,$product)){ //   .     . $transactionService-&gt;createTransaction($myPost); //  -   } else{ //    .    } } else{ //,     .    } } </span><span class="hljs-meta"><span class="hljs-comment"><span class="hljs-meta">?&gt;</span></span></span></span></code> </pre><br><h2>  Payment validation </h2><br>  Payment validation is highly dependent on the business logic of your application.  Specific conditions may be added.  For example, the user paid for 15 units of goods, and there are only 10. You can not miss such an order. <br><br>  However, it makes sense to check such things at the stage of form generation.  Payment validation is needed rather to prevent fraud (for example, the user manually increased the quantity of goods in the form of payment, and left the price the same). <br><br>  There are a few things worth checking out anyway: <br><ul><li>  Check the price in the payment and in our database </li><li>  Check that the final cost is not 0 (paranoia since the previous paragraph covers this case) </li><li>  Check that the correct payee is indicated </li><li>  Check payment status </li><li>  Check payment currency </li></ul><br><pre> <code class="php hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?php</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">validateTransaction</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($myPost,$product)</span></span></span></span>{ $valid = <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>; <span class="hljs-comment"><span class="hljs-comment">/* *    */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>($product-&gt;getTotalPrice($myPost[<span class="hljs-string"><span class="hljs-string">'quantity'</span></span>]) != $myPost[<span class="hljs-string"><span class="hljs-string">'payment_gross'</span></span>]){ $valid = <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>; } <span class="hljs-comment"><span class="hljs-comment">/* *     */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">elseif</span></span>($myPost[<span class="hljs-string"><span class="hljs-string">'payment_gross'</span></span>] == <span class="hljs-number"><span class="hljs-number">0</span></span>){ $valid = <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>; } <span class="hljs-comment"><span class="hljs-comment">/* *    */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">elseif</span></span>($myPost[<span class="hljs-string"><span class="hljs-string">'payment_status'</span></span>] !== <span class="hljs-string"><span class="hljs-string">'Completed'</span></span>){ $valid = <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>; } <span class="hljs-comment"><span class="hljs-comment">/* *    */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">elseif</span></span>($myPost[<span class="hljs-string"><span class="hljs-string">'receiver_email'</span></span>] != <span class="hljs-string"><span class="hljs-string">'YOUR PAYPAL ACCOUNT'</span></span>){ $valid = <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>; } <span class="hljs-comment"><span class="hljs-comment">/* *   */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">elseif</span></span>($myPost[<span class="hljs-string"><span class="hljs-string">'mc_currency'</span></span>] != <span class="hljs-string"><span class="hljs-string">'USD'</span></span>){ $valid = <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> $valid; } <span class="hljs-meta"><span class="hljs-meta">?&gt;</span></span></code> </pre><br>  And, of course, add your own checks. <br><br>  As a result, you should work one-time payments.  At the stage of creating a payment form, we can specify any parameters.  For example, you can flexibly control the price of goods (2 for the price of 3, each buyer has a 30% discount, etc.).  We do not need to change anything in Paypal for this. <br><br><h2>  Subscriptions </h2><br>  Now consider the implementation of subscriptions.  The principle is the same as with one-time payments.  Only payments are repetitive.  Therefore, their implementation is somewhat more complicated. <br><br>  Several tariff plans are available, for example, Free - for free, Pro - $ 5 per user per month, Premium - $ 10 per user per month. <br>  The user can cancel the subscription with a refund for the unused period.  The user can also change the subscription terms, for example, switch to another tariff plan, or change the number of users. <br><br>  It is clear that for Free subscription paypal is not needed at all.  Perhaps this tariff plan should be activated automatically, immediately when a user registers with our application.  This scheme is good because it shows typical usage for some SaaS system.  And on the move it is not very clear how to implement this using Paypal. <br><br>  To work with subscriptions, you will need additional tables: <br><br>  subscription_plans - to store tariff plans: <br><br><table><tbody><tr><td>  id </td><td>  service_provider </td><td>  service_name </td><td>  price </td><td>  price_type </td><td>  period </td></tr><tr><td>  one </td><td>  Service </td><td>  pro </td><td>  5.00 </td><td>  user </td><td>  month </td></tr><tr><td>  2 </td><td>  Service </td><td>  enterprise </td><td>  10.00 </td><td>  user </td><td>  month </td></tr><tr><td>  3 </td><td>  Service </td><td>  free </td><td>  0.00 </td><td>  user </td><td>  month </td></tr></tbody></table><br>  subscriptions - to store subscriptions: <br><br><table><tbody><tr><td>  id </td><td>  user_id </td><td>  plan_id </td><td>  subscription_id </td><td>  created_date </td><td>  updated_date </td><td>  payment_date </td><td>  items_count </td><td>  status </td></tr></tbody></table><br><h2>  Subscription form </h2><br>  The subscription form is very similar to the one-time payment form. <br><br><pre> <code class="php hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?php</span></span> $payNowButtonUrl = <span class="hljs-string"><span class="hljs-string">'https://www.sandbox.paypal.com/cgi-bin/websc'</span></span>; $userId = <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-comment"><span class="hljs-comment">// id   $receiverEmail = 'xxx-facilitator@gmail.com'; //email  (   paypal ) $serviceId = 1; $serviceName = 'Service Pro'; //  ( ) $servicePrice = '5.00'; //   - 5$  1    $quantity = 3; //   $amount = $servicePrice * $quantity; //   - 15$   $returnUrl = 'http://your-site.com/subscription?status=paymentSuccess'; $customData = ['user_id' =&gt; $userId, 'service_id' =&gt; $serviceId ]; </span><span class="hljs-meta"><span class="hljs-comment"><span class="hljs-meta">?&gt;</span></span></span><span class="hljs-comment"> &lt;form id="createSubscription" action="</span><span class="hljs-meta"><span class="hljs-comment"><span class="hljs-meta">&lt;?php</span></span></span><span class="hljs-comment"> echo $payNowButtonUrl; </span><span class="hljs-meta"><span class="hljs-comment"><span class="hljs-meta">?&gt;</span></span></span><span class="hljs-comment">" method="post" target="_top"&gt; &lt;input type="hidden" name="cmd" value="_xclick-subscriptions"&gt; &lt;input type="hidden" name="business" value="</span><span class="hljs-meta"><span class="hljs-comment"><span class="hljs-meta">&lt;?php</span></span></span><span class="hljs-comment"> echo $receiverEmail; </span><span class="hljs-meta"><span class="hljs-comment"><span class="hljs-meta">?&gt;</span></span></span><span class="hljs-comment">"&gt; &lt;input type="hidden" name="lc" value="GB"&gt; &lt;input type="hidden" name="item_name" value="</span><span class="hljs-meta"><span class="hljs-comment"><span class="hljs-meta">&lt;?php</span></span></span><span class="hljs-comment"> echo $serviceName; </span><span class="hljs-meta"><span class="hljs-comment"><span class="hljs-meta">?&gt;</span></span></span><span class="hljs-comment">"&gt; &lt;input type="hidden" name="no_note" value="1"&gt; &lt;input type="hidden" name="no_shipping" value="1"&gt; &lt;input type="hidden" name="return" value="</span><span class="hljs-meta"><span class="hljs-comment"><span class="hljs-meta">&lt;?php</span></span></span><span class="hljs-comment"> echo $returnUrl; </span><span class="hljs-meta"><span class="hljs-comment"><span class="hljs-meta">?&gt;</span></span></span><span class="hljs-comment">"&gt; &lt;input type="hidden" name="src" value="1"&gt; &lt;input type="hidden" name="a3" value="</span><span class="hljs-meta"><span class="hljs-comment"><span class="hljs-meta">&lt;?php</span></span></span><span class="hljs-comment"> echo $amount; </span><span class="hljs-meta"><span class="hljs-comment"><span class="hljs-meta">?&gt;</span></span></span><span class="hljs-comment">"&gt; &lt;input type="hidden" name="p3" value="1"&gt; &lt;input type="hidden" name="t3" value="M"&gt; &lt;input id="customData" type="hidden" name="custom" value="</span><span class="hljs-meta"><span class="hljs-comment"><span class="hljs-meta">&lt;?php</span></span></span><span class="hljs-comment"> echo json_encode($customData); </span><span class="hljs-meta"><span class="hljs-comment"><span class="hljs-meta">?&gt;</span></span></span><span class="hljs-comment">"&gt; &lt;input type="hidden" name="currency_code" value="USD"&gt; &lt;button type="submit"&gt;Subscribe&lt;/button&gt; &lt;/form&gt;</span></span></code> </pre><br>  The subscription price is set by parameter a3.  The subscription period is set using the parameters p3 and t3 (in this example, payments occur every month). <br><br>  A detailed description of these and other parameters can be found in the <a href="https://developer.paypal.com/docs/classic/paypal-payments-standard/integration-guide/Appx_websitestandard_htmlvariables/">documentation</a> . <br><br><h2>  IPN </h2><br>  With IPN, basically everything is the same as with one-time payments.  True, we will receive more requests because  more events need to be handled: subscription creation, subscription payment, subscription cancellation, etc.  As before, you need to check the accuracy for each request and only then process it. <br><br><h2>  Subscription Validation </h2><br>  Everything is a bit more complicated here than with one-time payments.  We need to validate not only the payment, but also the creation of a subscription, cancellation of the subscription, possibly a change in the subscription.  Perhaps something else, depending on the logic of the application.  For example, we want the Pro tariff plan to create no more than 100 users.  Or something like that.  Again, all this can be tried to take into account at the stage of form creation. <br><br>  What exactly needs to be checked in this case: <br><br><ul><li>  In case of cancellation of subscription, you need to check that the subscription exists. </li><li>  To pay for a subscription, you must verify that <br><ul><li>  price is not equal to 0 </li><li>  the amount of payment is equal to the subscription size </li><li>  the recipient is correct </li><li>  subscription status "Completed" </li><li>  USD currency </li></ul><br></li><li>  In the case of a refund, you need to check that the payment exists and the refund amount is not more than the amount of the payment (the refund amount may be less than the payment, in case we carry out a partial refund) </li><li>  In the case of creating a subscription, you need to check that the tariff plan exists and prices match </li></ul><br><pre> <code class="php hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?php</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">validateSubscription</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($subscriptionPlan,$myPost)</span></span></span></span>{ $userId = $myPost[<span class="hljs-string"><span class="hljs-string">'customData'</span></span>][<span class="hljs-string"><span class="hljs-string">'user_id'</span></span>]; $userService = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> UserService(); $userInfo = $userService-&gt;getUserData($userId); $customData = <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;getCustomData($myPost); <span class="hljs-comment"><span class="hljs-comment">//    if($myPost['txn_type'] == 'subscr_cancel'){ $subscriptionService = new SubscriptionService(); $subscription = $subscriptionService-&gt;loadBySubscriptionId($myPost['subscr_id']); if(!$subscription-&gt;id){ //   return false; } } //   elseif($myPost['txn_type'] == 'subscr_payment'){ //    if($subscriptionPlan-&gt;price * $myPost['customData']['items_count'] != $myPost['mc_gross']){ return false; } // ,     0 if($myPost['mc_gross'] == 0){ return false; } //   if($myPost['receiver_email'] != 'xxx-facilitator@yandex.ru'){ return false; } //  if($myPost['mc_currency'] != 'USD'){ return false; } //   if($myPost['payment_status'] != 'Completed'){ return false; } } //   elseif($myPost['reason_code'] == 'refund' &amp;&amp; $myPost['payment_status'] == 'Refunded'){ $transactionService = new TransactionService(); $lastTransaction = $transactionService-&gt;getLastActiveTransactionBySubscription($myPost['subscr_id']); //,    if(!$lastTransaction){ return false; } //,        if(abs($myPost['mc_gross']) &gt; $lastTransaction['mc_gross']){ return false; } } return true; } </span><span class="hljs-meta"><span class="hljs-comment"><span class="hljs-meta">?&gt;</span></span></span></span></code> </pre><br><h2>  Payment processing </h2><br>  After successful validation, you can continue processing the payment.  Here we have several subscription states: <br><ul><li>  subscription does not exist </li><li>  subscription is active </li><li>  subscription canceled </li></ul><br>  Depending on the status of the subscription, requests will be processed differently. <br><br><pre> <code class="php hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?php</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">processPayment</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($myPost)</span></span></span></span>{ $customData = <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;getCustomData($myPost); $userId = $customData[<span class="hljs-string"><span class="hljs-string">'user_id'</span></span>]; $userService = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> UserService(); $userInfo = $userService-&gt;getUserData($userId); $subscriptionPlanService = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> SubscriptionPlanService(); $subscriptionPlan = $subscriptionPlanService-&gt;getSubscriptionPlan($myPost); $transactionService = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> TransactionService(); $subscriptionService = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> SubscriptionService(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(validateSubscription($subscriptionPlan,$myPost)){ $subscription = $subscriptionService-&gt;loadBySubscriptionId($myPost[<span class="hljs-string"><span class="hljs-string">'subscr_id'</span></span>]); $transaction = $transactionService-&gt;getTransactionById($myPost[<span class="hljs-string"><span class="hljs-string">'txn_id'</span></span>]); <span class="hljs-comment"><span class="hljs-comment">//  if($subscription-&gt;id){ //    if($myPost['txn_type'] == 'subscr_payment'){ //     if(!$transaction){ //   $subscription-&gt;status = 'active'; $subscription-&gt;payment_date = $myPost['payment_date']; $subscription-&gt;updated_date = date('Ymd H:i:s'); $subscription-&gt;save(); //   $myPost['relation_id'] = $subscription-&gt;id; $myPost['relation_type'] = 'transaction'; $transactionService-&gt;createTransaction($myPost); } else{ //  .     } } //   if($myPost['txn_type'] == 'subscr_cancel'){ $subscription-&gt;status = 'cancelled'; $subscription-&gt;updated_date = date('Ymd H:i:s'); $subscription-&gt;save(); } //   if($myPost['txn_type'] == 'subscr_eot'){ $subscription-&gt;status = 'expired'; $subscription-&gt;updated_date = date('Ymd H:i:s'); $subscription-&gt;save(); } //    if($myPost['txn_type'] == 'subscr_signup'){ } //       .  .     if($myPost['txn_type'] == 'subscr_modify'){ $subscription-&gt;status = 'modified'; $subscription-&gt;updated_date = date('Ymd H:i:s'); $subscription-&gt;save(); } //   if($myPost['payment_status'] == 'Refunded' &amp;&amp; $myPost['reason_code'] == 'refund'){ //      $transactionService-&gt;updateTransactionStatus($myPost['parent_txn_id'],'Refunded'); //   () $myPost['txn_type'] = 'refund'; $myPost['relation_id'] = $subscription-&gt;id; $myPost['relation_type'] = 'subscription'; $transactionService-&gt;createTransaction($myPost); } } //    else{ //     if($myPost['txn_type'] == 'subscr_payment'){ $activeSubscriptions = $subscriptionService-&gt;getActiveSubscriptions($userId); // ,      . if(count($activeSubscriptions) &gt; 0){ // ,        } elseif(!$transaction){ //   $subscription = new Subscription(); $subscription-&gt;user_id = $userId; $subscription-&gt;plan_id = $subscriptionPlan-&gt;id; $subscription-&gt;subscription_id = $myPost['subscr_id']; $subscription-&gt;created_date = date("Ymd H:i:s"); $subscription-&gt;updated_date = date('Ymd H:i:s'); $subscription-&gt;payment_date = $myPost['payment_date']; $subscription-&gt;items_count = $customData['items_count']; $subscription-&gt;status = 'active'; $subscriptionId = $subscription-&gt;save(); //   $myPost['relation_id'] = $subscriptionId; $myPost['relation_type'] = PaypalTransaction::TRANSACTION_RELATION_SUBSCRIPTION; $transactionService = new PaypalTransaction(); $transactionService-&gt;createTransaction($myPost); } else{ //    } } //  .      ,         if($myPost['txn_type'] == 'subscr_signup'){ } //  .     ..     if($myPost['txn_type'] == 'subscr_modify'){ } } } else{ //     } } </span><span class="hljs-meta"><span class="hljs-comment"><span class="hljs-meta">?&gt;</span></span></span></span></code> </pre><br><h2>  Cancel subscription </h2><br>  We implement the cancellation of the subscription, in case the user gets tired of using our application.  In this case, use Paypal Classic Api to cancel the subscription. <br><br>  To work with the API, we will need Username, Password and Signature.  They can be found in the profile settings. <br><br><img src="https://habrastorage.org/files/ca8/207/e39/ca8207e39b884b84a1e20ec7e759cb4c.jpg"><br><br>  Subscription cancellation is done using the <a href="https://developer.paypal.com/docs/classic/api/merchant/ManageRecurringPaymentsProfileStatus_API_Operation_NVP/">ManageRecurringPaymentsProfileStatus</a> method <a href="https://developer.paypal.com/docs/classic/api/merchant/ManageRecurringPaymentsProfileStatus_API_Operation_NVP/">.</a> <br><br><pre> <code class="php hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?php</span></span> <span class="hljs-comment"><span class="hljs-comment">// $profile_id - id  ( $myPost['subscr_id']) // $action - 'Cancel' public function changeSubscriptionStatus($profile_id, $action, $apiCredentials){ $api_request = 'USER=' . urlencode( $apiCredentials['username'] ) . '&amp;PWD=' . urlencode( $apiCredentials['password'] ) . '&amp;SIGNATURE=' . urlencode( $apiCredentials['signature'] ) . '&amp;VERSION=76.0' . '&amp;METHOD=ManageRecurringPaymentsProfileStatus' . '&amp;PROFILEID=' . urlencode( $profile_id ) . '&amp;ACTION=' . urlencode( $action ) . '&amp;NOTE=' . urlencode( 'Profile cancelled at store' ); $ch = curl_init(); curl_setopt( $ch, CURLOPT_URL, 'https://api-3t.sandbox.paypal.com/nvp' ); // For live transactions, change to 'https://api-3t.paypal.com/nvp' curl_setopt( $ch, CURLOPT_VERBOSE, 1 ); curl_setopt($ch, CURLOPT_SSL_VERIFYPEER, 1); curl_setopt( $ch, CURLOPT_RETURNTRANSFER, 1 ); curl_setopt( $ch, CURLOPT_POST, 1 ); // Set the API parameters for this transaction curl_setopt( $ch, CURLOPT_POSTFIELDS, $api_request ); // Request response from PayPal $response = curl_exec( $ch ); // If no response was received from PayPal there is no point parsing the response if( ! $response ){ return false; } curl_close( $ch ); // An associative array is more usable than a parameter string parse_str( $response, $parsed_response ); return $parsed_response; } </span><span class="hljs-meta"><span class="hljs-comment"><span class="hljs-meta">?&gt;</span></span></span></span></code> </pre><br>  There is some problem with this method, since  we cannot cancel a subscription if it has already been canceled.  But we also cannot check the status of the subscription.  Therefore, it is necessary to cancel all subscriptions (in the normal situation, we will not have to cancel the subscription twice).  This problem is described in <a href="http://thereforei.am/2012/07/03/cancelling-subscriptions-created-with-paypal-standard-via-the-express-checkout-api/">this post</a> . <br><br><h2>  Refund (full / partial) </h2><br>  Perhaps, besides canceling the subscription, the user would like to return the money for the unused period (note: subscribed for a month, canceled a week later - you need to return 75% of the cost). <br><br>  You can also use Paypal Classic Api, <a href="https://developer.paypal.com/docs/classic/api/merchant/RefundTransaction_API_Operation_NVP/">RefundTransaction</a> method for <a href="https://developer.paypal.com/docs/classic/api/merchant/RefundTransaction_API_Operation_NVP/">this</a> . <br><br><pre> <code class="php hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?php</span></span> <span class="hljs-comment"><span class="hljs-comment">// $transaction_id - $myPost['txn_id'] // $amount -    public function refundTransaction($transaction_id,$apiCredentials$amount = null){ $transaction_id = $transaction['txn_id']; $refundType = 'Full'; if($amount){ $amount = round($amount, 2, PHP_ROUND_HALF_DOWN); $amount = str_replace(',','.',$amount); $refundType = 'Partial'; } $api_request = 'USER=' . urlencode( $apiCredentials['username'] ) . '&amp;PWD=' . urlencode( $apiCredentials['password'] ) . '&amp;SIGNATURE=' . urlencode( $apiCredentials['signature'] ) . '&amp;VERSION=119' . '&amp;METHOD=RefundTransaction' . '&amp;TRANSACTIONID=' . urlencode( $transaction_id ) . '&amp;REFUNDTYPE=' . urlencode( $refundType ) . '&amp;CURRENCYCODE=' . urlencode( 'USD' ); if($amount){ $api_request .= '&amp;AMT=' . urlencode( $amount ); } $ch = curl_init(); curl_setopt( $ch, CURLOPT_URL, 'https://api-3t.sandbox.paypal.com/nvp' ); // For live transactions, change to 'https://api-3t.paypal.com/nvp' curl_setopt( $ch, CURLOPT_VERBOSE, 1 ); curl_setopt($ch, CURLOPT_SSL_VERIFYPEER, 1); curl_setopt( $ch, CURLOPT_RETURNTRANSFER, 1 ); curl_setopt( $ch, CURLOPT_POST, 1 ); // Set the API parameters for this transaction curl_setopt( $ch, CURLOPT_POSTFIELDS, $api_request ); // Request response from PayPal $response = curl_exec( $ch ); // If no response was received from PayPal there is no point parsing the response if( ! $response ){ return false; } curl_close( $ch ); // An associative array is more usable than a parameter string parse_str( $response, $parsed_response ); return $parsed_response; } </span><span class="hljs-meta"><span class="hljs-comment"><span class="hljs-meta">?&gt;</span></span></span></span></code> </pre><br>  You can use the following code to calculate the refund amount.  The code is designed to calculate the return of a monthly subscription. <br><br><pre> <code class="php hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?php</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getTransactionRefundAmount</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($transaction)</span></span></span></span>{ $paymentDate = date(<span class="hljs-string"><span class="hljs-string">'Ym-d'</span></span>,strtotime($transaction[<span class="hljs-string"><span class="hljs-string">'payment_date'</span></span>])); $currentDate = date(<span class="hljs-string"><span class="hljs-string">'Ym-d'</span></span>); $paymentDate = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> DateTime($paymentDate); $currentDate = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> DateTime($currentDate); $dDiff = $paymentDate-&gt;diff($currentDate); $days = $dDiff-&gt;days; $daysInMonth = cal_days_in_month(CAL_GREGORIAN,$currentDate-&gt;format(<span class="hljs-string"><span class="hljs-string">'m'</span></span>),$currentDate-&gt;format(<span class="hljs-string"><span class="hljs-string">'Y'</span></span>)); $amount = $transaction[<span class="hljs-string"><span class="hljs-string">'mc_gross'</span></span>] - $transaction[<span class="hljs-string"><span class="hljs-string">'mc_gross'</span></span>] * $days / $daysInMonth; $amount = round($amount, <span class="hljs-number"><span class="hljs-number">2</span></span>, PHP_ROUND_HALF_DOWN); $amount = str_replace(<span class="hljs-string"><span class="hljs-string">','</span></span>,<span class="hljs-string"><span class="hljs-string">'.'</span></span>,$amount); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> $amount; } <span class="hljs-meta"><span class="hljs-meta">?&gt;</span></span></code> </pre><br><h2>  Subscription change </h2><br>  Now we add the ability to change the subscription terms.  This is needed if the user wants to change the tariff plan, or the number of users.  Unfortunately, paypal imposes certain restrictions on changing the subscription. <br><br>  This issue is discussed <a href="http://stackoverflow.com/questions/7640723/changing-the-amount-of-a-paypal-subscription">here.</a> <br><br>  I don't want to check this information for myself.    ,  ,      ,     .             .       . <br><br> ,   ,    .      . ,  ,     ,      . <br><br><h2>  Conclusion </h2><br>           Paypal.          -. <br><br>            (   ,    ..). <br><br>    .  Thank you all for your attention.    .       . <br><br> <b>Upd</b> : , <a href="https://habrahabr.ru/users/daniyar94/" class="user_link">Daniyar94</a> .   PDT    IPN.        .   <a href="http://habrahabr.ru/post/266091/">habrahabr.ru/post/266091/#comment_8560801</a> </div><p>Source: <a href="https://habr.com/ru/post/266091/">https://habr.com/ru/post/266091/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../266081/index.html">In the footsteps of Meteor, or cycling reactivity</a></li>
<li><a href="../266083/index.html">Restriction of memory available to the program</a></li>
<li><a href="../266085/index.html">We build real-time web applications with RethinkDB</a></li>
<li><a href="../266087/index.html">Broadband Method (Class Library)</a></li>
<li><a href="../266089/index.html">Linux container developers meeting</a></li>
<li><a href="../266093/index.html">Healthcare IT: or how to exceed the budget by 420%</a></li>
<li><a href="../266095/index.html">How many downloads do you need for the TOP-10 free games of the App Store</a></li>
<li><a href="../266097/index.html">Script to calculate the space occupied by Hyper-V virtual machines</a></li>
<li><a href="../266099/index.html">Intel invites to Droidcon. Moscow, September 25-27</a></li>
<li><a href="../266101/index.html">Color Deconvolution at Wolfram Mathematica</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>