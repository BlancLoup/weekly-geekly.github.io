<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Dropbox style sync on your own server</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="With this topic, I would like to start a file synchronization dialog. On Habr√© there were already topics and about Dropbox and about alternative servi...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Dropbox style sync on your own server</h1><div class="post__text post__text-html js-mediator-article">  With this topic, I would like to start a file synchronization dialog.  On Habr√© there were already topics and about <a href="http://habrahabr.ru/blogs/startup/105244/">Dropbox</a> and about alternative services ( <a href="http://habrahabr.ru/blogs/services/114653/">one</a> , <a href="http://habrahabr.ru/blogs/services/115247/">two</a> ).  The services are excellent, but I was interested in the question: how can I organize file synchronization on my own hardware?  I began to look for a ready-made program, but found a little.  It seems that most people just call rsync / unison from cron.  Writing a client ‚Äì ‚Äã‚Äãserver program that would track changes to files in a folder seemed simple, and I decided to try it. <br><a name="habracut"></a><br>  I decided to write using Qt.  Firstly, a rich set of classes, secondly, support for different platforms, and thirdly - the presence of the QFileSystemWatcher class.  With this class, you can receive notifications of changes in the directory.  And as the "engine" of synchronization was chosen unison.  In fact, the entire application is just a superstructure above the unison utility. <br><br><h1>  Server </h1><br>  The server part manages users and clients.  The client is a specific user's computer.  For example, there is a user Vasya, and he has two computers.  These two computers will be customers.  Clients differ based on hostname.  For authorization, I use only the username.  Registration of clients occurs automatically if the connecting client has transferred the existing user name (I am going to add password authorization later).  Information about users and clients is stored in SQLITE database. <br><br><h1>  Customer </h1><br>  The main purpose of the client side is to start the synchronization process due to changes in the observed directory.  After synchronization, the client asks the server to notify all other clients about the need for synchronization.  Clients connected to the server immediately receive a notification, and those not connected will receive it the next time they connect. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Since my main working machine is running Windows, I started the experiments with the client part in this system.  And here one feature of Qt was found.  The QFileSystemWatcher class is a bit strange, in my opinion, it keeps track of directories.  Firstly, notifications about changes in subdirectories are not supported, and secondly, if the change happens to the contents of a file, then the same will not be reported.  I started to understand the implementation of the QFileSystemWatcher class, it uses the <a href="http://msdn.microsoft.com/en-us/library/aa364417.aspx">FindFirstChangeNotification</a> function: <br> <code>HANDLE WINAPI FindFirstChangeNotification( <br> __in LPCTSTR lpPathName, <br> __in BOOL bWatchSubtree, <br> __in DWORD dwNotifyFilter <br> ); <br></code> <br>  It is immediately evident that it supports monitoring the directory tree.  Of course, Qt calls this function with a FALSE value for the bWatchSubtree parameter.  The last parameter was also changed by me to be notified of changes in the contents of files.  It was: <br> <code>const uint flags = isDir <br> ? (FILE_NOTIFY_CHANGE_DIR_NAME <br> | FILE_NOTIFY_CHANGE_FILE_NAME) <br> : (FILE_NOTIFY_CHANGE_DIR_NAME <br> | FILE_NOTIFY_CHANGE_FILE_NAME <br> | FILE_NOTIFY_CHANGE_ATTRIBUTES <br> | FILE_NOTIFY_CHANGE_SIZE <br> | FILE_NOTIFY_CHANGE_LAST_WRITE <br> | FILE_NOTIFY_CHANGE_SECURITY); <br></code>  , it became: <br> <code>const uint flags = isDir <br> ? (FILE_NOTIFY_CHANGE_DIR_NAME <br> | FILE_NOTIFY_CHANGE_FILE_NAME <br> | FILE_NOTIFY_CHANGE_SIZE) <br> : (FILE_NOTIFY_CHANGE_DIR_NAME <br> | FILE_NOTIFY_CHANGE_FILE_NAME <br> | FILE_NOTIFY_CHANGE_ATTRIBUTES <br> | FILE_NOTIFY_CHANGE_SIZE <br> | FILE_NOTIFY_CHANGE_LAST_WRITE <br> | FILE_NOTIFY_CHANGE_SECURITY); <br></code> <br>  And what about other systems?  In Linux, Qt uses either Inotify or Dnotify.  They notify about changes to the contents of the file within the directory, but also do not work with subdirectories.  It is necessary to monitor each directory separately.  The reason why I used to study the implementation of the QFileSystemWatcher class is because I didn‚Äôt want to monitor every directory in the directory tree.  But this is a topic for discussion and it will be interesting for me to hear Habrovchan‚Äôs views on this matter. <br><br>  I did not understand the details of the QFileSystemWatcher implementation under Mac OS X anymore.  Left using the original class.  So as a result, under Windows, I use a modified version of the class, and under all other systems - the original one. <br><br><h1>  results </h1><br><br>  The result is two programs, Easysync-server and Easysync-client.  I tested the server under Ubuntu, and I checked the work of the client part under Windows, Ubuntu and Mac OS X. Under Mac I could not install the version of Unison I needed in the console.  If this is done, the client will work under the Mac. <br><br>  The source code is laid out on Github <a href="https://github.com/fralik/Easysync">https://github.com/fralik/Easysync</a> under the GPL license.  There are more detailed instructions in English.  on installing programs.  If you specifically, Habrochelovek, want the instructions to be in Russian, then you can a) translate them or b) send me a personal message.  With the accumulation of such messages, I promise to do the translation. </div><p>Source: <a href="https://habr.com/ru/post/116215/">https://habr.com/ru/post/116215/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../11621/index.html">Domestic web service UcoZ storms the West!</a></li>
<li><a href="../116210/index.html">IPad 2 Video Review (Part 3 and 4)</a></li>
<li><a href="../116211/index.html">Load Testing: Node.JS vs phpDaemon</a></li>
<li><a href="../116212/index.html">Second shift</a></li>
<li><a href="../116214/index.html">SSH tunnel home without having to leave the home PC on</a></li>
<li><a href="../116216/index.html">March update for Windows Phone 7</a></li>
<li><a href="../116217/index.html">How to choose VPS hosting</a></li>
<li><a href="../116218/index.html">Yahoo! presented an analogue of Google instant</a></li>
<li><a href="../11622/index.html">Comments on the article "Painstaking optimization of PHP-applications"</a></li>
<li><a href="../116220/index.html">And one more wireless charger</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>