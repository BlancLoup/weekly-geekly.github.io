<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Writing extensions for PHP 7 in C ++</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="I had to write extensions in order to use the functions of C ++ libraries in PHP code. Also, one heavy extension ported from version 5 to version 7. 
...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Writing extensions for PHP 7 in C ++</h1><div class="post__text post__text-html js-mediator-article">  I had to write extensions in order to use the functions of C ++ libraries in PHP code.  Also, one heavy extension ported from version 5 to version 7. <br><br>  If you google the documentation on the topic of writing extensions for PHP, then basically it will be texts up to 2014, relevant for version 5. The <a href="http://php.net/">php.net</a> site itself provides <a href="http://php.net/manual/en/internals2.php" title="PHP at the Core: A Hacker's Guide">broken and outdated information</a> , and <a href="https://wiki.php.net/internals/references" title="References about Maintaining and Extending PHP">what</a> you can find in their wiki, again, 5th version.  The maximum that was found on the off site is a <a href="https://wiki.php.net/phpng-upgrading">poor mana</a> on migration of already written extensions. <br><br>  As a result, the only more or less clear mana for writing extensions for me was PHP source code, which I was guided by when writing and migrating extensions. <br><a name="habracut"></a><br>  In fact, the PHP API has changed so much that even the most detailed articles, such as <a href="https://devzone.zend.com/1435/wrapping-c-classes-in-a-php-extension/">Wrapping C ++ Classes in a PHP Extension,</a> do not really help when writing extensions for PHP 7. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      This article discusses working under Linux, I have Kubuntu.  For Windows, you need to write other config files, and since Windows is not installed in the extension, and expanding PHP under Windows is not a thankful task, I didn‚Äôt understand it. <br><br><h3>  What do you need </h3><br>  php-dev, gcc, php source codes.  A combo for installing everything you need to build from source codes, you can easily google. <br><br><h3>  Identify faces in photos </h3><br>  To determine the faces we use the library OpenCV, tested on versions&gt; = 2.3.1 <br><br>  The starting point for creating extensions is the <code>ext_skel</code> utility.  It allows you to create a blank for a new expansion.  We will edit the code that came out after executing this command. <br><br>  You need to go to the folder <code>/ext</code> source code PHP and from there run <br>  <code>ext_skel</code> with the name of the new extension: <br><br><pre> <code class="bash hljs">./ext_skel --extname=phpcv</code> </pre> <br>  After that, the newly created folder phpcv can be moved somewhere in a more convenient place.  We need the <code>tests</code> folder and the files <code>config.m4</code> , <code>php_phpcv.h</code> and <code>phpcv.c</code> .  The <code>phpcv.c</code> file <code>phpcv.c</code> immediately renamed to <code>phpcv.cpp</code> . <br><br><h4>  config.m4 </h4><br>  This is the configuration file used by the <code>phpize</code> utility to prepare our extension for compiling. <br><br>  The file is a kind of bash script using special macros.  These macros are defined in the <code>acinclude.m4</code> and <code>aclocal.m4</code> in php source code, and are written in the language of parentheses and punctuation marks.  In fact, it is enough to read comments that start with the lines ‚Äúdnl‚Äù and it will be more or less clear what these macros do. <br><br>  We delete the superfluous, we correct the code for our needs. <br><br><div class="spoiler">  <b class="spoiler_title">config.m4</b> <div class="spoiler_text"><pre> <code class="bash hljs">PHP_ARG_ENABLE(phpcv, whether to <span class="hljs-built_in"><span class="hljs-built_in">enable</span></span> phpcv support, [ --<span class="hljs-built_in"><span class="hljs-built_in">enable</span></span>-phpcv Enable phpcv support]) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> <span class="hljs-built_in"><span class="hljs-built_in">test</span></span> <span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$PHP_PHPCV</span></span></span><span class="hljs-string">"</span></span> != <span class="hljs-string"><span class="hljs-string">"no"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> PHP_REQUIRE_CXX() SEARCH_PATH=<span class="hljs-string"><span class="hljs-string">"/usr/local /usr /opt/local"</span></span> SEARCH_FOR=<span class="hljs-string"><span class="hljs-string">"/include/opencv2/opencv.hpp"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> <span class="hljs-built_in"><span class="hljs-built_in">test</span></span> -r <span class="hljs-variable"><span class="hljs-variable">$PHP_PHPCV</span></span>/<span class="hljs-variable"><span class="hljs-variable">$SEARCH_FOR</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> CV_DIR=<span class="hljs-variable"><span class="hljs-variable">$PHP_PHPCV</span></span> <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> AC_MSG_CHECKING([<span class="hljs-keyword"><span class="hljs-keyword">for</span></span> opencv <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> default path]) <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> i <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> <span class="hljs-variable"><span class="hljs-variable">$SEARCH_PATH</span></span> ; <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> <span class="hljs-built_in"><span class="hljs-built_in">test</span></span> -r <span class="hljs-variable"><span class="hljs-variable">$i</span></span>/<span class="hljs-variable"><span class="hljs-variable">$SEARCH_FOR</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> CV_DIR=<span class="hljs-variable"><span class="hljs-variable">$i</span></span> AC_MSG_RESULT(found <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> <span class="hljs-variable"><span class="hljs-variable">$i</span></span>) <span class="hljs-built_in"><span class="hljs-built_in">break</span></span> <span class="hljs-keyword"><span class="hljs-keyword">fi</span></span> <span class="hljs-keyword"><span class="hljs-keyword">done</span></span> <span class="hljs-keyword"><span class="hljs-keyword">fi</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> <span class="hljs-built_in"><span class="hljs-built_in">test</span></span> -z <span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$CV_DIR</span></span></span><span class="hljs-string">"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> AC_MSG_RESULT([not found]) AC_MSG_ERROR([Please reinstall the OpenCV distribution]) <span class="hljs-keyword"><span class="hljs-keyword">fi</span></span> AC_CHECK_HEADER([<span class="hljs-variable"><span class="hljs-variable">$CV_DIR</span></span>/include/opencv2/objdetect/objdetect.hpp], [], AC_MSG_ERROR(<span class="hljs-string"><span class="hljs-string">'opencv2/objdetect/objdetect.hpp'</span></span> header not found)) AC_CHECK_HEADER([<span class="hljs-variable"><span class="hljs-variable">$CV_DIR</span></span>/include/opencv2/highgui/highgui.hpp], [], AC_MSG_ERROR(<span class="hljs-string"><span class="hljs-string">'opencv2/highgui/highgui.hpp'</span></span> header not found)) PHP_ADD_LIBRARY_WITH_PATH(opencv_objdetect, <span class="hljs-variable"><span class="hljs-variable">$CV_DIR</span></span>/lib, PHPCV_SHARED_LIBADD) PHP_ADD_LIBRARY_WITH_PATH(opencv_highgui, <span class="hljs-variable"><span class="hljs-variable">$CV_DIR</span></span>/lib, PHPCV_SHARED_LIBADD) PHP_ADD_LIBRARY_WITH_PATH(opencv_imgproc, <span class="hljs-variable"><span class="hljs-variable">$CV_DIR</span></span>/lib, PHPCV_SHARED_LIBADD) PHP_SUBST(PHPCV_SHARED_LIBADD) PHP_NEW_EXTENSION(phpcv, phpcv.cpp, <span class="hljs-variable"><span class="hljs-variable">$ext_shared</span></span>,, -std=c++0x -DZEND_ENABLE_STATIC_TSRMLS_CACHE=1) <span class="hljs-keyword"><span class="hljs-keyword">fi</span></span></code> </pre><br></div></div><br>  <b>PHP_ARG_ENABLE</b> - set up a flag with which the extension can be turned on or off during the PHP build process from source codes. <br>  <b>PHP_REQUIRE_CXX ()</b> - necessary if we are going to use C ++ <br>  Next, the bash code for opencv search. <br>  <b>AC_CHECK_HEADER</b> - we check the availability of the header files we need <br>  <b>PHP_ADD_LIBRARY_WITH_PATH</b> - we include shared libraries <br>  <b>PHP_SUBST</b> - this is necessary to form a make file <br>  <b>PHP_NEW_EXTENSION</b> - the extension name is indicated here, the * .cpp files that participate in the build process are listed, the compiler flags are indicated. <br><br><h4>  php_phpcv.h </h4><br><div class="spoiler">  <b class="spoiler_title">php_phpcv.h</b> <div class="spoiler_text"><pre> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">ifndef</span></span></span><span class="hljs-meta"> PHP_PHPCV_H #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> PHP_PHPCV_H #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> PHP_PHPCV_EXTNAME </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"phpcv"</span></span></span><span class="hljs-meta"> #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> PHP_PHPCV_VERSION </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"0.2.0"</span></span></span><span class="hljs-meta"> #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">ifdef</span></span></span><span class="hljs-meta"> HAVE_CONFIG_H #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"config.h"</span></span></span><span class="hljs-meta"> #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">endif</span></span></span><span class="hljs-meta"> extern </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"C"</span></span></span><span class="hljs-meta"> { #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"php.h"</span></span></span><span class="hljs-meta"> #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"ext/standard/info.h"</span></span></span><span class="hljs-meta"> } #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">ifdef</span></span></span><span class="hljs-meta"> ZTS #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"TSRM.h"</span></span></span><span class="hljs-meta"> #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">endif</span></span></span><span class="hljs-meta"> extern zend_module_entry phpcv_module_entry; #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> phpext_phpcv_ptr &amp;phpcv_module_entry #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">if</span></span></span><span class="hljs-meta"> defined(ZTS) &amp;&amp; defined(COMPILE_DL_PHPCV) ZEND_TSRMLS_CACHE_EXTERN(); #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">endif</span></span></span><span class="hljs-meta"> #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">endif</span></span></span><span class="hljs-meta"> </span><span class="hljs-comment"><span class="hljs-meta"><span class="hljs-comment">/* PHP_PHPCV_H */</span></span></span></span></code> </pre><br></div></div><br>  Here you should pay attention to the design <br><br> <code>extern "C" { ... }</code> <br>  This is necessary for the compatibility of our C ++ code with C PHP code. <br><br><h4>  phpcv.cpp </h4><br>  Here, finally, there will be C ++ code. <br>  To find faces, we will use the <a href="http://docs.opencv.org/2.4/modules/objdetect/doc/cascade_classification.html">cv :: CascadeClassifier :: detectMultiScale ()</a> method. <br><br>  The extension will provide a single function, here is its prototype: <br><br><pre> <code class="php hljs"><span class="hljs-comment"><span class="hljs-comment">/** * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@see</span></span></span><span class="hljs-comment"> cv::CascadeClassifier::detectMultiScale() * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@param</span></span></span><span class="hljs-comment"> string $imgPath * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@param</span></span></span><span class="hljs-comment"> string $cascadePath * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@param</span></span></span><span class="hljs-comment"> double $scaleFactor * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@param</span></span></span><span class="hljs-comment"> int $minNeighbors * * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@return</span></span></span><span class="hljs-comment"> array */</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">cv_detect_multiscale</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($imgPath, $cascadePath, $scaleFactor, $minNeighbors)</span></span></span><span class="hljs-function"> </span></span>{ }</code> </pre><br><div class="spoiler">  <b class="spoiler_title">phpcv.cpp</b> <div class="spoiler_text"><pre> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"php_phpcv.h"</span></span></span><span class="hljs-meta"> #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt;opencv2/objdetect/objdetect.hpp&gt; #include &lt;opencv2/highgui/highgui.hpp&gt; #include &lt;opencv2/imgproc/imgproc.hpp&gt; PHP_MINFO_FUNCTION(phpcv) { php_info_print_table_start(); php_info_print_table_header(2, "phpcv support", "enabled"); php_info_print_table_end(); } PHP_FUNCTION(cv_detect_multiscale) { char *imgPath = NULL, *cascadePath = NULL; long imgPathLen, cascadePathLen, minNeighbors; double scaleFactor, minWidth, minHeight; if (zend_parse_parameters(ZEND_NUM_ARGS() TSRMLS_CC, "ssdl", &amp;imgPath, &amp;imgPathLen, &amp;cascadePath, &amp;cascadePathLen, &amp;scaleFactor, &amp;minNeighbors) == FAILURE) { RETURN_FALSE; } // Read Image cv::Mat image; image = cv::imread(imgPath, CV_LOAD_IMAGE_GRAYSCALE); if (image.empty()) { RETURN_FALSE; } equalizeHist(image, image); //min size for detected object, discarding objects smaller than this minWidth = image.size().width / 10; minHeight = image.size().height / 10; // Load Face cascade (.xml file) cv::CascadeClassifier faceCascade; if (!faceCascade.load(cascadePath)) { RETURN_FALSE; } // Detect faces std::vector&lt;cv::Rect&gt; faces; faceCascade.detectMultiScale(image, faces, scaleFactor, minNeighbors, 0, cv::Size(minWidth, minHeight)); array_init(return_value); // Build array to return for ( int i = 0; i &lt; faces.size(); i++ ) { // Now we have: faces[i].x faces[i].y faces[i].width faces[i].height zval face; array_init(&amp;face); add_assoc_long(&amp;face, "x", faces[i].x); add_assoc_long(&amp;face, "y", faces[i].y); add_assoc_long(&amp;face, "w", faces[i].width); add_assoc_long(&amp;face, "h", faces[i].height); add_next_index_zval(return_value, &amp;face); } } const zend_function_entry phpcv_functions[] = { PHP_FE(cv_detect_multiscale, NULL) PHP_FE_END }; zend_module_entry phpcv_module_entry = { STANDARD_MODULE_HEADER, PHP_PHPCV_EXTNAME, phpcv_functions, NULL, NULL, NULL, NULL, PHP_MINFO(phpcv), PHP_PHPCV_VERSION, STANDARD_MODULE_PROPERTIES }; #ifdef COMPILE_DL_PHPCV #ifdef ZTS ZEND_TSRMLS_CACHE_DEFINE(); #endif ZEND_GET_MODULE(phpcv) #endif</span></span></span></span></code> </pre><br></div></div><br>  <b>PHP_MINFO_FUNCTION</b> - adds information about our extension to the output of phpinfo () <br>  <b>PHP_FUNCTION (cv_detect_multiscale)</b> is the code of our function.  After receiving the input parameters using <code>zend_parse_parameters</code> C ++ code is in it.  Using the opencv library, we find faces and form the output array with the coordinates of the faces found. <br>  <b>zend_function_entry</b> - functions that are provided by the extension are listed here. <br>  <b>zend_module_entry</b> is a standard construct, a structure describing our extension.  Several <code>NULL</code> in a row are instead of methods that are executed during initialization and shutdown extensions and queries, we simply have nothing to do during these phases. <br><br>  In the code you can see two magic dozens.  I decided not to bother with the transfer of parameters for the minimum and maximum size of the face in the photo, which must be found. <br><br><h4>  tests </h4><br>  The extension test consists of code that prints something and checks the output.  Files *. Phpt with tests are placed in the folder <code>tests</code> <br><br><div class="spoiler">  <b class="spoiler_title">002.phpt</b> <div class="spoiler_text"><pre> <code class="php hljs">--TEST-- Test face detection --SKIPIF-- <span class="hljs-meta"><span class="hljs-meta">&lt;?php</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!extension_loaded(<span class="hljs-string"><span class="hljs-string">"phpcv"</span></span>)) <span class="hljs-keyword"><span class="hljs-keyword">print</span></span> <span class="hljs-string"><span class="hljs-string">"skip"</span></span>; <span class="hljs-meta"><span class="hljs-meta">?&gt;</span></span> --FILE-- <span class="hljs-meta"><span class="hljs-meta">&lt;?php</span></span> $cascade = <span class="hljs-string"><span class="hljs-string">'/usr/share/opencv/haarcascades/haarcascade_frontalface_alt2.xml'</span></span>; $img = <span class="hljs-keyword"><span class="hljs-keyword">__DIR__</span></span> . <span class="hljs-string"><span class="hljs-string">'/img.jpg'</span></span>; $faces = cv_detect_multiscale($img, $cascade, <span class="hljs-number"><span class="hljs-number">1.1</span></span>, <span class="hljs-number"><span class="hljs-number">5</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (is_array($faces) &amp;&amp; count($faces) &gt; <span class="hljs-number"><span class="hljs-number">0</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">echo</span></span> <span class="hljs-string"><span class="hljs-string">'face detection works'</span></span>; } <span class="hljs-meta"><span class="hljs-meta">?&gt;</span></span> --EXPECT-- face detection works</code> </pre><br></div></div><br><h4>  Build and Testing </h4><br>  Assemble: <br><br><pre> <code class="bash hljs">phpize &amp;&amp; ./configure &amp;&amp; make</code> </pre> <br>  Test: <br><br><pre> <code class="bash hljs">make <span class="hljs-built_in"><span class="hljs-built_in">test</span></span></code> </pre> <br><h3>  DateTime Pattern Generator </h3><br>  Now consider an extension that provides a class that wraps the C ++ class. <br>  Add the missing functionality to the intl extension class set.  Why it is needed: <a href="https://blog.ksimka.io/a-long-journey-to-formatting-a-date-without-a-year-internationally-with-php/">https://blog.ksimka.io/a-long-journey-to-formatting-a-date-without-a-year-internationally-with-php/#header</a> .  In short, the standard intl extension does not provide the ability to internationally form a date without a year, that is, "February 10" or "February 10th."  This extension fixes this problem. <br><br>  The system must have an ICU library installed.  On Debian-like systems, you can install the libicu-dev package. <br><br><h4>  config.m4 </h4><br><div class="spoiler">  <b class="spoiler_title">config.m4</b> <div class="spoiler_text"><pre> <code class="bash hljs">PHP_ARG_ENABLE(intl-dtpg, whether to <span class="hljs-built_in"><span class="hljs-built_in">enable</span></span> intl-dtpg support, [ --<span class="hljs-built_in"><span class="hljs-built_in">enable</span></span>-intl-dtpg Enable intl-dtpg support]) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> <span class="hljs-built_in"><span class="hljs-built_in">test</span></span> <span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$PHP_INTL_DTPG</span></span></span><span class="hljs-string">"</span></span> != <span class="hljs-string"><span class="hljs-string">"no"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> PHP_SETUP_ICU(INTL_DTPG_SHARED_LIBADD) PHP_SUBST(INTL_DTPG_SHARED_LIBADD) PHP_REQUIRE_CXX() PHP_NEW_EXTENSION(intl_dtpg, intl_dtpg.cpp, <span class="hljs-variable"><span class="hljs-variable">$ext_shared</span></span>,,-std=c++0x <span class="hljs-variable"><span class="hljs-variable">$ICU_INCS</span></span> -DZEND_ENABLE_STATIC_TSRMLS_CACHE=1) <span class="hljs-keyword"><span class="hljs-keyword">fi</span></span></code> </pre><br></div></div><br>  This time everything is very concise.  Since we need the ICU library and the intl extension also requires its presence, we simply borrowed the PHP_SETUP_ICU macro from the intl extension. <br>  In <b>PHP_NEW_EXTENSION</b> <code>$ICU_INCS</code> - ICU specific flags. <br><br><h4>  intl_dtpg.h </h4><br><div class="spoiler">  <b class="spoiler_title">intl_dtpg.h</b> <div class="spoiler_text"><pre> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">ifndef</span></span></span><span class="hljs-meta"> INTL_DTPG_H #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> INTL_DTPG_H #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt;zend_modules.h&gt; #include &lt;zend_types.h&gt; #include &lt;unicode/dtptngen.h&gt; extern "C" { #include "php.h" #include "ext/standard/info.h" } extern zend_module_entry intl_dtpg_module_entry; #define phpext_intl_dtpg_ptr &amp;intl_dtpg_module_entry #define INTL_DTPG_VERSION "1.0.0" #ifdef ZTS #include "TSRM.h" #endif typedef struct { DateTimePatternGenerator *dtpg; UErrorCode status; zend_object zo; } IntlDateTimePatternGenerator_object; static inline IntlDateTimePatternGenerator_object *php_intl_datetimepatterngenerator_fetch_object(zend_object *obj) { return (IntlDateTimePatternGenerator_object *)((char*)(obj) - XtOffsetOf(IntlDateTimePatternGenerator_object, zo)); } #if defined(ZTS) &amp;&amp; defined(COMPILE_DL_INTL_DTPG) ZEND_TSRMLS_CACHE_EXTERN() #endif #endif /* INTL_DTPG_H */</span></span></span></span></code> </pre><br></div></div><br>  Here we define the structure <code>IntlDateTimePatternGenerator_object</code> .  It stores a pointer to a <code>DateTimePatternGenerator</code> object from the ICU library, a variable to store the status, and a <code>zend_object</code> object, which is a PHP class.  This is such a wrapper for the C ++ class.  The PHP API operates with a <code>zend_object</code> object, and we wrapped it in a structure and always have access to what is ‚Äúnext door‚Äù to <code>zend_object</code> . <br><br>  Below we see the definition of the <code>inline</code> function for extracting the <code>IntlDateTimePatternGenerator_object</code> structure with a <code>zend_object</code> object.  Under the hood, we take a step back from the start of the <code>zend_object</code> to the size of our structure minus the size of the <code>zend_object</code> .  Thus, we find ourselves at the beginning of the structure, the pointer to which we are returned.  Such a clever way is peeped in the source codes of the intl extension. <br><br><h4>  intl_dtpg.cpp </h4><br>  The extension will provide a class of the following structure: <br><br><pre> <code class="php hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">IntlDateTimePatternGenerator</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-comment"><span class="hljs-comment">/** * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@param</span></span></span><span class="hljs-comment"> string $locale */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">__construct</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(string $locale)</span></span></span><span class="hljs-function"> </span></span>{} <span class="hljs-comment"><span class="hljs-comment">/** * Return the best pattern matching the input skeleton. * It is guaranteed to have all of the fields in the skeleton. * * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@param</span></span></span><span class="hljs-comment"> string $skeleton The skeleton is a pattern containing only the variable fields. * For example, "MMMdd" and "mmhh" are skeletons. * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@return</span></span></span><span class="hljs-comment"> string The best pattern found from the given skeleton. */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">findBestPattern</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(string $skeleton)</span></span></span><span class="hljs-function"> </span></span>{} }</code> </pre><br><div class="spoiler">  <b class="spoiler_title">intl_dtpg.cpp</b> <div class="spoiler_text"><pre> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">ifdef</span></span></span><span class="hljs-meta"> HAVE_CONFIG_H #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"config.h"</span></span></span><span class="hljs-meta"> #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">endif</span></span></span><span class="hljs-meta"> #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"intl_dtpg.h"</span></span></span><span class="hljs-meta"> #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt;unicode/ustdio.h&gt; #include &lt;unicode/smpdtfmt.h&gt; zend_class_entry *IntlDateTimePatternGenerator_ce; zend_object_handlers IntlDateTimePatternGenerator_object_handlers; /* {{{ IntlDateTimePatternGenerator_objects_dtor */ static void IntlDateTimePatternGenerator_object_dtor(zend_object *object) { zend_objects_destroy_object(object); } /* }}} */ /* {{{ IntlDateTimePatternGenerator_objects_free */ void IntlDateTimePatternGenerator_object_free(zend_object *object) { IntlDateTimePatternGenerator_object *dtpgo = php_intl_datetimepatterngenerator_fetch_object(object); zend_object_std_dtor(&amp;dtpgo-&gt;zo); dtpgo-&gt;status = U_ZERO_ERROR; if (dtpgo-&gt;dtpg) { delete dtpgo-&gt;dtpg; dtpgo-&gt;dtpg = nullptr; } } /* }}} */ /* {{{ IntlDateTimePatternGenerator_object_create */ zend_object *IntlDateTimePatternGenerator_object_create(zend_class_entry *ce) { IntlDateTimePatternGenerator_object* intern; intern = (IntlDateTimePatternGenerator_object*)ecalloc(1, sizeof(IntlDateTimePatternGenerator_object) + zend_object_properties_size(ce)); zend_object_std_init(&amp;intern-&gt;zo, ce); object_properties_init(&amp;intern-&gt;zo, ce); intern-&gt;dtpg = nullptr; intern-&gt;status = U_ZERO_ERROR; intern-&gt;zo.handlers = &amp;IntlDateTimePatternGenerator_object_handlers; return &amp;intern-&gt;zo; } /* }}} */ /* {{{ proto void IntlDateTimePatternGenerator::__construct(string $locale) * IntlDateTimePatternGenerator object constructor. */ PHP_METHOD(IntlDateTimePatternGenerator, __construct) { zend_string *locale; zval *object; IntlDateTimePatternGenerator_object* dtpg = nullptr; if (zend_parse_parameters(ZEND_NUM_ARGS(), "S", &amp;locale) == FAILURE) { return; } object = getThis(); dtpg = php_intl_datetimepatterngenerator_fetch_object(Z_OBJ_P(object)); dtpg-&gt;status = U_ZERO_ERROR; dtpg-&gt;dtpg = DateTimePatternGenerator::createInstance(Locale(ZSTR_VAL(locale)), dtpg-&gt;status); } /* }}} */ /* {{{ proto string IntlDateTimePatternGenerator::findBestPattern(string $skeleton) * Return the best pattern matching the input skeleton. */ PHP_METHOD(IntlDateTimePatternGenerator, findBestPattern) { zend_string *skeleton; zval *object; IntlDateTimePatternGenerator_object* dtpg = nullptr; if (zend_parse_parameters(ZEND_NUM_ARGS(), "S", &amp;skeleton) == FAILURE) { return; } object = getThis(); dtpg = php_intl_datetimepatterngenerator_fetch_object(Z_OBJ_P(object)); UnicodeString pattern = dtpg-&gt;dtpg-&gt;getBestPattern(UnicodeString(ZSTR_VAL(skeleton)), dtpg-&gt;status); std::string s; pattern.toUTF8String(s); RETURN_STRING(s.c_str()); } /* }}} */ ZEND_BEGIN_ARG_INFO_EX(arginfo_findBestPattern, 0, 0, 1) ZEND_ARG_INFO(0, skeleton) ZEND_END_ARG_INFO() ZEND_BEGIN_ARG_INFO_EX(arginfo___construct, 0, 0, 1) ZEND_ARG_INFO(0, locale) ZEND_END_ARG_INFO() const zend_function_entry IntlDateTimePatternGenerator_functions[] = { PHP_ME(IntlDateTimePatternGenerator, __construct, arginfo___construct, ZEND_ACC_PUBLIC | ZEND_ACC_CTOR) PHP_ME(IntlDateTimePatternGenerator, findBestPattern, arginfo_findBestPattern, ZEND_ACC_PUBLIC) PHP_FE_END }; /* {{{ PHP_MINIT_FUNCTION */ PHP_MINIT_FUNCTION(intl_dtpg) { zend_class_entry ce; INIT_CLASS_ENTRY(ce, "IntlDateTimePatternGenerator", IntlDateTimePatternGenerator_functions); ce.create_object = IntlDateTimePatternGenerator_object_create; IntlDateTimePatternGenerator_ce = zend_register_internal_class(&amp;ce); memcpy(&amp;IntlDateTimePatternGenerator_object_handlers, zend_get_std_object_handlers(), sizeof IntlDateTimePatternGenerator_object_handlers); IntlDateTimePatternGenerator_object_handlers.offset = XtOffsetOf(IntlDateTimePatternGenerator_object, zo); IntlDateTimePatternGenerator_object_handlers.clone_obj = NULL; //no clone support IntlDateTimePatternGenerator_object_handlers.dtor_obj = IntlDateTimePatternGenerator_object_dtor; IntlDateTimePatternGenerator_object_handlers.free_obj = IntlDateTimePatternGenerator_object_free; if(!IntlDateTimePatternGenerator_ce) { zend_error(E_ERROR, "Failed to register IntlDateTimePatternGenerator class"); return FAILURE; } return SUCCESS; } /* }}} */ /* {{{ PHP_MSHUTDOWN_FUNCTION */ PHP_MSHUTDOWN_FUNCTION(intl_dtpg) { return SUCCESS; } /* }}} */ /* {{{ PHP_MINFO_FUNCTION */ PHP_MINFO_FUNCTION(intl_dtpg) { php_info_print_table_start(); php_info_print_table_header(2, "intl_dtpg support", "enabled"); php_info_print_table_header(2, "intl_dtpg version", INTL_DTPG_VERSION); php_info_print_table_end(); } /* }}} */ /* {{{ intl_dtpg_functions[] */ const zend_function_entry intl_dtpg_functions[] = { PHP_FE_END }; /* }}} */ /* {{{ intl_dtpg_module_entry */ zend_module_entry intl_dtpg_module_entry = { STANDARD_MODULE_HEADER, "intl_dtpg", intl_dtpg_functions, PHP_MINIT(intl_dtpg), PHP_MSHUTDOWN(intl_dtpg), NULL, NULL, PHP_MINFO(intl_dtpg), INTL_DTPG_VERSION, STANDARD_MODULE_PROPERTIES }; /* }}} */ #ifdef COMPILE_DL_INTL_DTPG #ifdef ZTS ZEND_TSRMLS_CACHE_DEFINE() #endif ZEND_GET_MODULE(intl_dtpg) #endif</span></span></span></span></code> </pre><br></div></div><br>  First, we define handlers that will be executed in certain phases of the life of our PHP object. <br><br>  <b>IntlDateTimePatternGenerator_object_dtor</b> - PHP object destructor.  There is nothing to do, we call the standard API. <br>  <b>IntlDateTimePatternGenerator_object_free</b> - freeing memory.  An important phase, you need to do everything carefully so that there are no memory leaks.  We <code>zend_object</code> our structure, call the destructor for <code>zend_object</code> , reset the status and destroy the C ++ class object. <br>  <b>IntlDateTimePatternGenerator_object_create</b> - memory allocation for a new object.  The code is peeped in the intl source code. <br>  Next, we define the methods of our class. <br>  <b>PHP_METHOD (IntlDateTimePatternGenerator, __construct)</b> - constructor, a new <code>DateTimePatternGenerator</code> object is created. <br>  Here, in <b>zend_parse_parameters</b> , we get a string in the form of a <code>zend_string</code> object, while a large ‚ÄúS‚Äù is indicated in <b>zend_parse_parameters</b> .  This is an innovation in PHP 7. But the old way of indicating a small ‚Äús‚Äù and getting a separate C-style line and its length also works, as we saw in the previous extension. <br>  <b>PHP_METHOD (IntlDateTimePatternGenerator, findBestPattern)</b> - the class method from the ICU library is called here. <br>  The following is a set of macros to define the parameters of the class methods.  By the name of the parameters of these macros in the <code>zend_API.h</code> file, <code>zend_API.h</code> can understand what they mean. <br>  The <b>zend_function_entry</b> structure specifies the class methods.  The previously defined parameter sets and flags are passed to the <b>PHP_ME</b> macro.  This structure is used when registering a class below. <br>  <b>PHP_MINIT_FUNCTION (intl_dtpg)</b> - called when the extension is initialized.  Here our class is registered and handlers are indicated to serve its phases of life. <br>  <b>PHP_MSHUTDOWN_FUNCTION (intl_dtpg)</b> - when there is nothing to do at the time of shutdown, you can simply return <code>SUCCESS</code> , but you can also not specify in the <b>zend_module_entry</b> , specify <code>NULL</code> below. <br>  <b>PHP_MINFO_FUNCTION (intl_dtpg)</b> - adds extension information to the phpinfo () output <br>  Again <b>zend_function_entry</b> , but this time empty - we do not define any functions in this extension. <br>  <b>zend_module_entry</b> - here we specify the methods for initialization and shutdown of our extension, the other two <code>NULL</code> are about request, we do nothing at the moment of initialization and shutdown of the request. <br><br><h4>  tests </h4><br>  A small test, make sure that the patterns are generated: <br><br><div class="spoiler">  <b class="spoiler_title">001.phpt</b> <div class="spoiler_text"><pre> <code class="php hljs">--TEST-- Check <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> intl_dtpg presence --SKIPIF-- <span class="hljs-meta"><span class="hljs-meta">&lt;?php</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!extension_loaded(<span class="hljs-string"><span class="hljs-string">"intl_dtpg"</span></span>)) <span class="hljs-keyword"><span class="hljs-keyword">print</span></span> <span class="hljs-string"><span class="hljs-string">"skip"</span></span>; <span class="hljs-meta"><span class="hljs-meta">?&gt;</span></span> --FILE-- <span class="hljs-meta"><span class="hljs-meta">&lt;?php</span></span> $dtpg = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> IntlDateTimePatternGenerator(<span class="hljs-string"><span class="hljs-string">'ru_RU'</span></span>); $ruPattern = $dtpg-&gt;findBestPattern(<span class="hljs-string"><span class="hljs-string">'MMMMd'</span></span>); $dtpg = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> IntlDateTimePatternGenerator(<span class="hljs-string"><span class="hljs-string">'en_US'</span></span>); $enPattern = $dtpg-&gt;findBestPattern(<span class="hljs-string"><span class="hljs-string">'MMMMd'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">echo</span></span> $ruPattern . <span class="hljs-string"><span class="hljs-string">';'</span></span> . $enPattern; <span class="hljs-meta"><span class="hljs-meta">?&gt;</span></span> --EXPECT-- d MMMM;MMMM d</code> </pre><br></div></div><br><h4>  Build and test </h4><br><pre> <code class="bash hljs">phpize &amp;&amp; ./configure &amp;&amp; make make <span class="hljs-built_in"><span class="hljs-built_in">test</span></span></code> </pre><br><br><h3>  valgrind - we check extensions for memory leaks </h3><br>  Check our <b>intl_dtpg</b> extension for memory leaks.  To do this, create a test ini file in the extension folder: <br><br><div class="spoiler">  <b class="spoiler_title">test-php.ini</b> <div class="spoiler_text"><pre> <code class="hljs swift"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extension</span></span></span><span class="hljs-class">=</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">modules</span></span></span><span class="hljs-class">/</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">intl_dtpg</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">so</span></span></span></span></code> </pre><br></div></div><br>  and test php file: <br><div class="spoiler">  <b class="spoiler_title">test.php</b> <div class="spoiler_text"><pre> <code class="php hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?php</span></span> $dtpg = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> IntlDateTimePatternGenerator(<span class="hljs-string"><span class="hljs-string">'ru_RU'</span></span>); $ruPattern = $dtpg-&gt;findBestPattern(<span class="hljs-string"><span class="hljs-string">'MMMMd'</span></span>); $dtpg = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> IntlDateTimePatternGenerator(<span class="hljs-string"><span class="hljs-string">'en_US'</span></span>); $enPattern = $dtpg-&gt;findBestPattern(<span class="hljs-string"><span class="hljs-string">'MMMMd'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">echo</span></span> $ruPattern . <span class="hljs-string"><span class="hljs-string">';'</span></span> . $enPattern . <span class="hljs-string"><span class="hljs-string">"\n"</span></span>;</code> </pre><br></div></div><br>  Checking: <br><br><pre> <code class="bash hljs">valgrind php -c <span class="hljs-built_in"><span class="hljs-built_in">test</span></span>-php.ini test.php</code> </pre> <br> <code>==30326== HEAP SUMMARY: <br> ==30326== in use at exit: 478,022 bytes in 2,151 blocks <br> ==30326== total heap usage: 22,863 allocs, 20,712 frees, 4,718,469 bytes allocated <br> ==30326== <br> ==30326== LEAK SUMMARY: <br> ==30326== definitely lost: 0 bytes in 0 blocks <br> ==30326== indirectly lost: 0 bytes in 0 blocks <br> ==30326== possibly lost: 1,076 bytes in 14 blocks <br> ==30326== still reachable: 476,946 bytes in 2,137 blocks <br> ==30326== of which reachable via heuristic: <br> ==30326== newarray : 30,416 bytes in 74 blocks <br> ==30326== suppressed: 0 bytes in 0 blocks <br></code> <br><br>  Seems not bad. <br><br>  In order to experiment, comment out the destruction of the object. <br><br>  <code>DateTimePatternGenerator</code> in the IntlDateTimePatternGenerator_object_free <code>IntlDateTimePatternGenerator_object_free</code> <br><br><pre> <code class="cpp hljs"><span class="hljs-comment"><span class="hljs-comment">/* {{{ IntlDateTimePatternGenerator_objects_free */</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">IntlDateTimePatternGenerator_object_free</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(zend_object *object)</span></span></span><span class="hljs-function"> </span></span>{ IntlDateTimePatternGenerator_object *dtpgo = php_intl_datetimepatterngenerator_fetch_object(object); zend_object_std_dtor(&amp;dtpgo-&gt;zo); dtpgo-&gt;status = U_ZERO_ERROR; <span class="hljs-comment"><span class="hljs-comment">// if (dtpgo-&gt;dtpg) { // delete dtpgo-&gt;dtpg; // dtpgo-&gt;dtpg = nullptr; // } } /* }}} */</span></span></code> </pre><br>  Checking: <br><br><pre> <code class="bash hljs">valgrind php -c <span class="hljs-built_in"><span class="hljs-built_in">test</span></span>-php.ini test.php</code> </pre> <br> <code>==411== HEAP SUMMARY: <br> ==411== in use at exit: 770,710 bytes in 2,477 blocks <br> ==411== total heap usage: 22,863 allocs, 20,386 frees, 4,718,469 bytes allocated <br> ==411== <br> ==411== LEAK SUMMARY: <br> ==411== definitely lost: 5,232 bytes in 2 blocks <br> ==411== indirectly lost: 287,456 bytes in 324 blocks <br> ==411== possibly lost: 1,076 bytes in 14 blocks <br> ==411== still reachable: 476,946 bytes in 2,137 blocks <br> ==411== of which reachable via heuristic: <br> ==411== newarray : 30,416 bytes in 74 blocks <br> ==411== suppressed: 0 bytes in 0 blocks <br></code> <br>  The lines ‚Äúdefinitely lost‚Äù and ‚Äúindirectly lost‚Äù clearly indicate a leak. <br><br><h3>  Conclusion </h3><br>  I want to say that the documentation and naming API leave much to be desired.  If you need to write something more complicated than ‚ÄúHello, world‚Äù, you will have to learn the source code of PHP and the built-in extensions. </div><p>Source: <a href="https://habr.com/ru/post/335478/">https://habr.com/ru/post/335478/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../335466/index.html">Apollo Link. Customize GraphQL client "for yourself"</a></li>
<li><a href="../335468/index.html">IOTV - a simple HTTP protocol for working with messages and commands of IOT objects in the VIALATM service</a></li>
<li><a href="../335470/index.html">Security Week 32: A spy got into the npm repository, Disney banned from watching children, Juniper patched a one-year bug</a></li>
<li><a href="../335474/index.html">How to get to the TOP: PR to release and in case of failure</a></li>
<li><a href="../335476/index.html">Practical business of ontology: a story c advanced</a></li>
<li><a href="../335480/index.html">Learn App Shortcuts on Android Nougat 7.1</a></li>
<li><a href="../335484/index.html">Create a checklist for helpdesk implementation</a></li>
<li><a href="../335488/index.html">Rethinking PID 1. Part 2</a></li>
<li><a href="../335490/index.html">Developing a telegram bot using Spring</a></li>
<li><a href="../335492/index.html">Information economy: why the cost of technology companies is so high</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>