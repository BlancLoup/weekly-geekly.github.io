<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Reasonable AOP for IOC container fans</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="I really don't like boilerplate. Such code is boring to write, sadly accompany and modify. I don‚Äôt like it at all when that bolierplate is mixed with ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Reasonable AOP for IOC container fans</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/files/09a/066/6af/09a0666af2de4be8af0402b6cda6b5fe.jpg" align="left">  I really don't like boilerplate.  Such code is boring to write, sadly accompany and modify.  I don‚Äôt like it at all when that bolierplate is mixed with the business logic of the application.  The problem was described very well by <a href="https://habrahabr.ru/users/krestjaninoff/" class="user_link">krestjaninoff</a> <a href="https://habrahabr.ru/post/114649/">5 years ago</a> .  <i>If you are not familiar with the AOP paradigm, read the material on the link, it reveals the topic</i> . <br><br>  As at the time of reading this article, even now neither <a href="https://www.postsharp.net/">PostSharp</a> nor Spring suits me.  But in the meantime, other tools appeared in .NET that allow you to pull out the ‚Äúleft‚Äù code from business logic, decorate it with separate reusable modules and describe it declaratively, without slipping into rewriting the resulting IL and other sodomy. <br><br>  It's about the project <a href="http://www.castleproject.org/projects/dynamicproxy">Castle.DynamicProxy</a> and its application in the development of enterprise applications. <a name="habracut"></a>  I will borrow an example from <a href="https://habrahabr.ru/users/krestjaninoff/" class="user_link">krestjaninoff</a> , because I see the similar code with enviable regularity, and it gives me a lot of trouble. <br><pre><code class="java hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> BookDTO </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getBook</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Integer bookId)</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">throws</span></span></span><span class="hljs-function"> ServiceException, AuthException </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!SecurityContext.getUser().hasRight(<span class="hljs-string"><span class="hljs-string">"GetBook"</span></span>)) <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> AuthException(<span class="hljs-string"><span class="hljs-string">"Permission Denied"</span></span>); LOG.debug(<span class="hljs-string"><span class="hljs-string">"Call method getBook with id "</span></span> + bookId); BookDTO book = <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>; String cacheKey = <span class="hljs-string"><span class="hljs-string">"getBook:"</span></span> + bookId; <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (cache.contains(cacheKey)) { book = (BookDTO) cache.get(cacheKey); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { book = bookDAO.readBook(bookId); cache.put(cacheKey, book); } } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span>(SQLException e) { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ServiceException(e); } LOG.debug(<span class="hljs-string"><span class="hljs-string">"Book info is: "</span></span> + book.toString()); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> book; }</code> </pre> 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      So, in the example above, one ‚Äúuseful‚Äù operation is reading a book from the database by Id.  In the load method received: <br><ul><li>  authorization check </li><li>  caching </li><li>  exception handling </li><li>  logging </li></ul><br>  For the sake of fairness, it is worth noting that the authorization and access rights check, caching could already be provided by ASP.NET using the <i>[Authorize]</i> and <i>[OutputCache] attributes</i> , however, by condition, this is a ‚Äúspherical web service in vacuum‚Äù (also written in Java ), therefore, the requirements for it are unknown, as, however, it is not known whether ASP.NET, WCF or a corporate framework is used. <br><br><h3>  Task </h3><br><img src="https://habrastorage.org/files/c8e/2f2/b00/c8e2f2b00cbd4c9fa45dd5962cb25abe.jpg" align="left"><ul><li>  move the helper code to a suitable place </li><li>  make it (code) reusable for other services </li></ul><br>  In the AOP world there is a special term for the problem we are solving: <a href="http://stackoverflow.com/questions/23700540/cross-cutting-concern-example">cross-cutting concerns</a> .  <i>Base concerns</i> are <i>highlighted</i> - the main functionality of the system, for example, business logic and <i>cross-cutting concerns</i> - minor functionality (logging, access control, error handling, etc.), which is nevertheless necessary everywhere in the application code. <br><br>  Most often I meet and perfectly illustrates the situation of <i>cross-cutting concern of</i> this type: <br><pre> <code class="hljs javascript">dbContext.InTransaction(<span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">x</span></span></span><span class="hljs-function"> =&gt;</span></span> { <span class="hljs-comment"><span class="hljs-comment">//... }, onFailure: e =&gt; {success: false, message: e.Message});</span></span></code> </pre><br>  Absolutely everything is ugly in it, ranging from increasing code nesting, ending with shifting the functions of the system designer to the application programmer: there is no guarantee that transactions will be invoked wherever needed, it is unclear how to manage the isolation level of transactions and nested transactions and this code will be copied one hundred thousand times where necessary and not necessary. <br><br><h3>  Decision </h3><br><img src="https://habrastorage.org/files/db6/bc7/92e/db6bc792e5f54e84b03c2256e6f21aab.jpg" align="left">  Castle.DynamicProxy provides a simple API for creating proxy objects on the fly with the ability to define what we are missing.  This approach is used in popular insulation frameworks: <a href="https://github.com/moq/moq4">Moq</a> and <a href="https://hibernatingrhinos.com/oss/rhino-mocks">Rhino Mocks</a> .  We have <a href="">two options available</a> : <br><ol><li>  creating a proxy for the interface link (in this case the composition will be used) </li><li>  creating a proxy for the class (a successor will be created) </li></ol><br>  The main difference for us will be that in order to modify the methods of the class, they must be declared accessible ( <i>public</i> or <i>protected</i> ) and virtual.  The mechanism is similar to <i>Lazy Loading</i> in <i>Nhibernate</i> or <i>EF</i> .  To enrich the functionality in Castle.DynamicProxy, <i>Interceptors are used</i> .  For example, to ensure that all application services are transacted, you can write an <i>Interceptor</i> like this: <br><pre> <code class="hljs cs"> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">TransactionScoper</span></span> : <span class="hljs-title"><span class="hljs-title">IInterceptor</span></span> { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Intercept</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">IInvocation invocation</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">var</span></span> tr = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> TransactionScope()) { invocation.Proceed(); tr.Complete(); } } }</code> </pre><br>  And create a proxy: <br><pre> <code class="hljs cs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> generator = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ProxyGenerator(); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> foo = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Foo(); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> fooInterfaceProxyWithCallLogerInterceptor = generator.CreateInterfaceProxyWithTarget(foo, TransactionScoper);</code> </pre><br>  Or <a href="http://docs.autofac.org/en/latest/advanced/interceptors.html">using a container</a> : <br><pre> <code class="hljs javascript"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> builder = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ContainerBuilder(); builder.Register(<span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">c</span></span></span><span class="hljs-function"> =&gt;</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> TransactionScoper()); builder.RegisterType&lt;Foo&gt;() .As&lt;IFoo&gt;() .InterceptedBy(<span class="hljs-keyword"><span class="hljs-keyword">typeof</span></span>(TransactionScoper)); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> container = builder.Build(); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> willBeIntercepted = container.Resolve&lt;IFoo&gt;();</code> </pre><br>  Similarly, error handling can be added. <br><pre> <code class="hljs cs"> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">ErrorHandler</span></span> : <span class="hljs-title"><span class="hljs-title">IInterceptor</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">readonly</span></span> TextWriter Output; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ErrorHandler</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">TextWriter output</span></span></span><span class="hljs-function">)</span></span> { Output = output; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Intercept</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">IInvocation invocation</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { Output.WriteLine(<span class="hljs-string"><span class="hljs-string">$"Method </span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">{</span></span><span class="hljs-number"><span class="hljs-string"><span class="hljs-subst"><span class="hljs-number">0</span></span></span></span><span class="hljs-string"><span class="hljs-subst">}</span></span></span><span class="hljs-string"> enters in try/catch block"</span></span>, invoca-tion.Method.Name); invocation.Proceed(); Output.WriteLine(<span class="hljs-string"><span class="hljs-string">"End of try/catch block"</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (Exception ex) { Output.WriteLine(<span class="hljs-string"><span class="hljs-string">"Exception: "</span></span> + ex.Message); <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ValidationException(<span class="hljs-string"><span class="hljs-string">"Sorry, Unhandaled exception occured"</span></span>, ex); } } } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">ValidationException</span></span> : <span class="hljs-title"><span class="hljs-title">Exception</span></span> { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ValidationException</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> message, Exception innerException</span></span></span><span class="hljs-function">) :</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">base</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">message, innerException</span></span></span><span class="hljs-function">)</span></span> { } }</code> </pre><br>  Or logging: <br><pre> <code class="hljs cs"> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">CallLogger</span></span> : <span class="hljs-title"><span class="hljs-title">IInterceptor</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">readonly</span></span> TextWriter Output; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">CallLogger</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">TextWriter output</span></span></span><span class="hljs-function">)</span></span> { Output = output; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Intercept</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">IInvocation invocation</span></span></span><span class="hljs-function">)</span></span> { Output.WriteLine(<span class="hljs-string"><span class="hljs-string">"Calling method {0} with parameters {1}."</span></span>, invocation.Method.Name, <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>.Join(<span class="hljs-string"><span class="hljs-string">", "</span></span>, invocation.Arguments.Select(a =&gt; (a ?? <span class="hljs-string"><span class="hljs-string">""</span></span>).ToString()).ToArray())); invocation.Proceed(); Output.WriteLine(<span class="hljs-string"><span class="hljs-string">"Done: result was {0}."</span></span>, invocation.ReturnValue); } }</code> </pre><br>  Caching and many other operations.  A distinctive feature of this approach from the implementation of the ‚Äúdecorator‚Äù pattern by means of OOP is the ability to add supporting functionality to any types without the need to create heirs.  The approach also solves the problem of multiple inheritance.  We can easily add more than one interceptor for each type: <br><pre> <code class="hljs swift"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> fooInterfaceProxyWith2Interceptors = generator.<span class="hljs-type"><span class="hljs-type">CreateInterfaceProxyWithTarget</span></span>(<span class="hljs-type"><span class="hljs-type">Foo</span></span>, <span class="hljs-type"><span class="hljs-type">CallLogger</span></span>, <span class="hljs-type"><span class="hljs-type">ErrorHandler</span></span>);</code> </pre><br>  Another strength of this approach is the separation of end-to-end functionality from the business logic layer and the best separation of the infrastructure code from the application domain. <br><br>  If during the registration process it is impossible to say exactly which services need to be proxied and which not, then attributes can be used to obtain information at runtime (although this approach may lead to some problems): <br><pre> <code class="hljs pgsql"> <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> abstract <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> AttributeBased&lt;T&gt; : IInterceptor <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> T:<span class="hljs-keyword"><span class="hljs-keyword">Attribute</span></span> { <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> <span class="hljs-type"><span class="hljs-type">void</span></span> Intercept(IInvocation invocation) { var attrs = invocation.<span class="hljs-keyword"><span class="hljs-keyword">Method</span></span> .GetCustomAttributes(typeof(T), <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>) .<span class="hljs-keyword"><span class="hljs-keyword">Cast</span></span>&lt;T&gt;() .ToArray(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!attrs.<span class="hljs-keyword"><span class="hljs-keyword">Any</span></span>()) { invocation.Proceed(); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { Intercept(invocation, attrs); } } protected abstract <span class="hljs-type"><span class="hljs-type">void</span></span> Intercept(IInvocation invocation, params T[] attr); }</code> </pre><br>  You can even use a <a href="https://habrahabr.ru/post/246469/">ready-made solution</a> . <br><br><h2>  Minuses </h2><br>  I see four objective disadvantages of this approach: <br><ol><li>  Not intuitiveness </li><li>  Intersection with the infrastructure code of other frameworks </li><li>  Dependence on the IOC container </li><li>  Performance </li></ol><br><br><h4>  Not intuitiveness </h4><br>  The easiest way to deal with this code structuring is for people familiar with functional programming concepts.  With a dirty number of reservations, the approach can be called reminiscent of a ‚Äú <a href="https://habrahabr.ru/post/246009/">composition</a> ‚Äù.  Crookedly designed interceptors can cause a fair amount of not obvious bugs and performance problems. <br><br><h4>  Intersection with the infrastructure code of other frameworks </h4><br>  As I said at the beginning, the <i>Authorize</i> and <i>OutputCache attributes are</i> already in ASP.NET.  In a sense, we are engaged in cycling.  The approach is more suitable for commands for which it is important to abstract from the final execution infrastructure.  In addition, the approach works in the context of partial application, not ‚Äúall or nothing‚Äù.  Nobody forces us to re-implement AOP-style authorization checks, if this is not required. <br><br><h4>  Dependence on the IOC container </h4><br>  For the service layer, minus is practically absent if you practice IOC / DI.  In 99% of cases, services will be obtained using an IOC container.  Entity and Dto are usually created explicitly using the new operator or the mapper.  I think that this is the right state of affairs and I do not see the use of interceptors at the level of creating Entity or Dto.  I have seen several examples of using interceptors to fill service fields in <i>Entity</i> , but over time this approach has always been discarded.  It is much better that the object itself cares about the safety of its <a href="https://habrahabr.ru/post/259829/">invariant</a> . <br><br><h4>  Performance </h4><br>  I cited the previous three points for accuracy rather than pragmatic considerations.  I rather attribute them to the limits of applicability of the approach, and not to the real problems.  I was not so sure about the performance, so I decided to make a series of benchmarks using <a href="https://github.com/PerfDotNet/BenchmarkDotNet">BenchmarkDotNet</a> .  With the fantasy, I didn‚Äôt have much, so the time of getting a random number was measured: <br><pre> <code class="hljs cs"> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">Foo</span></span> : <span class="hljs-title"><span class="hljs-title">IFoo</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">readonly</span></span> Random Rnd = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Random(); <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">double</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GetRandomNumber</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> =&gt; Rnd.Next(); } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">Foo</span></span> : <span class="hljs-title"><span class="hljs-title">IFoo</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">readonly</span></span> Random Rnd = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Random(); <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">double</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GetRandomNumber</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> =&gt; Rnd.Next(); }</code> </pre><br>  Benchmark sources and code samples <a href="https://github.com/max-arshinov/Castle.DynamicProxy.Benchmarks">are available on github</a> .  Obviously, you have to pay for magic with reflection and dynamic compilation: <br><ol><li>  Object creation time: ~ 2,000 ns.  It doesn't matter if the services are created once, and for the ‚Äúlive‚Äù dependencies, such as the context of the database, another object is responsible. </li><li>  Runtime operations: also approximately ~ 1,000 extra nanoseconds inside Castle.DynamicProxy use Reflection with all the ensuing consequences. </li></ol><br>  In absolute values, this is quite a lot, but if the code runs for longer than 50 ns, for example, it writes to the database or a request over the network, the situation looks different: <br><pre> <code class="hljs cs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">Bus</span></span> : <span class="hljs-title"><span class="hljs-title">Bar</span></span> { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">override</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">double</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GetRandomNumber</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { Thread.Sleep(<span class="hljs-number"><span class="hljs-number">100</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">base</span></span>.GetRandomNumber(); } }</code> </pre><br><pre> Host Process Environment Information:
 BenchmarkDotNet = v0.9.8.0
 OS = Microsoft Windows NT 6.2.9200.0
 Processor = Intel (R) Core (TM) i7-4710HQ CPU 2.50GHz, ProcessorCount = 8
 Frequency = 2435775 ticks, Resolution = 410.5470 ns, Timer = TSC
 CLR = MS.NET 4.0.30319.42000, Arch = 64-bit RELEASE [RyuJIT]
 GC = Concurrent Workstation
 JitModules = clrjit-v4.6.1080.0
</pre><br><pre>  Type = InterceptorBenchmarks Mode = Throughput GarbageCollection = Concurrent Workstation  
 LaunchCount = 1 WarmupCount = 3 TargetCount = 3  
</pre><table><tbody><tr><th>  Method </th><th>  Median </th><th>  Stddev </th></tr><tr><td>  CreateInstance </td><td>  0.0000 ns </td><td>  0.0000 ns </td></tr><tr><td>  CreateClassProxy </td><td>  1,972.0032 ns </td><td>  8.5611 ns </td></tr><tr><td>  CreateClassProxyWithTarget </td><td>  2,246.4208 ns </td><td>  5.3436 ns </td></tr><tr><td>  CreateInterfaceProxyWithTarget </td><td>  2,063.6905 ns </td><td>  41.9450 ns </td></tr><tr><td>  CreateInterfaceProxyWithoutTarget </td><td>  2,105.9238 ns </td><td>  4.9295 ns </td></tr><tr><td>  Foo_GetRandomNumber </td><td>  11.0409 ns </td><td>  0.1306 ns </td></tr><tr><td>  Foo_InterfaceProxyGetRandomNumber </td><td>  51.6061 ns </td><td>  0.2764 ns </td></tr><tr><td>  FooClassProxy_GetRandomNumber </td><td>  9.0125 ns </td><td>  0.1766 ns </td></tr><tr><td>  BarClassProxy_GetRandomNumber </td><td>  44.8110 ns </td><td>  0.4770 ns </td></tr><tr><td>  FooInterfaceProxyWithCallLoggerInterceptor_GetRandomNumber </td><td>  1,756.8129 ns </td><td>  75.4694 ns </td></tr><tr><td>  BarClassProxyWithCallLoggerInterceptor_GetRandomNumber </td><td>  1,714.5871 ns </td><td>  25.2403 ns </td></tr><tr><td>  FooInterfaceProxyWith2Interceptors_GetRandomNumber </td><td>  2,636.1626 ns </td><td>  20.0195 ns </td></tr><tr><td>  BarClassProxyWith2Interceptors_GetRandomNumber </td><td>  2,603.6707 ns </td><td>  4.6360 ns </td></tr><tr><td>  <b>Bus_GetRandomNumber</b> </td><td>  <b>100,471,410.5375 ns</b> </td><td>  <b>113,713.1684 ns</b> </td></tr><tr><td>  <b>BusInterfaceProxyWith2Interceptors_GetRandomNumber</b> </td><td>  <b>100,539,356.0575 ns</b> </td><td>  <b>89,725.5474 ns</b> </td></tr><tr><td>  CallLogger_Intercept </td><td>  3,841.4488 ns </td><td>  26.3829 ns </td></tr><tr><td>  WriteLine </td><td>  859.0076 ns </td><td>  34.1630 ns </td></tr></tbody></table>  I think if you replace <i>Reflection</i> with LambdaExpression, <i>you</i> can ensure that there will be no difference in performance, but you need to rewrite DynamicProxy, add support to popular containers (now interceptors are supported exactly from <a href="http://docs.autofac.org/en/latest/advanced/interceptors.html">Autofac</a> and <a href="">Castle.Windsor boxes</a> , I don‚Äôt know about the others) .  I doubt it will happen soon. <br><br>  Therefore, if on average your operations are performed for at least 100 ms and the three previous minuses do not frighten you, the ‚Äúcontainer AOP‚Äù in C # is already production-ready. </div><p>Source: <a href="https://habr.com/ru/post/305360/">https://habr.com/ru/post/305360/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../305342/index.html">Why tech support is (intentionally) unbearable</a></li>
<li><a href="../305350/index.html">Introduction to ReactiveUI: Studying Teams</a></li>
<li><a href="../305352/index.html">6 "harmful" tips to the developer</a></li>
<li><a href="../305354/index.html">Guilloche</a></li>
<li><a href="../305356/index.html">The digest of interesting materials for the mobile # 161 developer (July 3-10)</a></li>
<li><a href="../305364/index.html">Running cron inside the Docker container</a></li>
<li><a href="../305366/index.html">Amazing story document.write</a></li>
<li><a href="../305368/index.html">QNX 2 per virtual machine</a></li>
<li><a href="../305372/index.html">Ubuntu Unity desktop shell launched in Windows 10 environment</a></li>
<li><a href="../305374/index.html">UX design in the mobile application: a request to evaluate the application</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>