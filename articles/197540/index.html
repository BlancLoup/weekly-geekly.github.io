<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Algorithm of data distribution in a server cluster in dCache</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="In continuation of the article about dCache I will tell about some details of internal implementation. 

 One of the important tasks of distributed sy...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Algorithm of data distribution in a server cluster in dCache</h1><div class="post__text post__text-html js-mediator-article">  In continuation of the <a href="http://habrahabr.ru/post/196584/">article</a> about dCache I will tell about some details of internal implementation. <br><br>  One of the important tasks of distributed systems is how to distribute the load among the available nodes.  For distributed storage, this task is especially important, since the decision taken at the recording stage affects how the data will be read. <br><br><a name="habracut"></a>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Usually, the data is written together, together and will be read.  Whether photos from the last vacation or the latest results of a scientific experiment.  This fact forces us to scatter incoming data across as many nodes as possible, in order to avoid crowding clients on one of the servers.  Easily solvable problem, if all nodes have the same size and the same free disk space.  But it is a rarity in real conditions.  New and, with large volume, servers are connected when the free space is already on the verge. <br><br>  In dCache, this is solved with the help of two mechanisms: <b>weighted random distribution taking into account free space</b> (weighted random distribution) during recording and redistribution of data (rebalancing) when adding new nodes. <br><br>  And the way a weighted arbitrary distribution works, taking into account the free space: <br><ul><li>  each node is calculated <i>weight</i> , which is equal to the amount of free space on the node divided by the total free space in the system: <br>  <b>weight = FreeN / FreeTotal</b> </li><li>  randomly select one of the nodes, and the probability of choosing a node is directly proportional to its <i>weight</i> </li></ul><br>  In code, it looks like this: <br><br><pre><code class="java hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> Pool </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">selectWritePool</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Pool[] pools)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">double</span></span>[] weights = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-keyword"><span class="hljs-keyword">double</span></span>[pools.length]; <span class="hljs-keyword"><span class="hljs-keyword">long</span></span> totalFree = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (Pool pool:pools) { totalFree += pool.getFree(); } <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> i = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (Pool pool:pools) { weights[i] = (<span class="hljs-keyword"><span class="hljs-keyword">double</span></span>) pool.getFree() / totalFree; i++; } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> pools[i]; } <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> Random rand = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Random(); <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">weightetRandom</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">double</span></span></span></span><span class="hljs-function"><span class="hljs-params">[]weights, Random r)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">double</span></span> selection = r.nextDouble(); <span class="hljs-keyword"><span class="hljs-keyword">double</span></span> total = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> i = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (i = <span class="hljs-number"><span class="hljs-number">0</span></span>; (i &lt; weights.length) &amp;&amp; (total &lt;= selection); i++) { total += weights[i]; } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> i - <span class="hljs-number"><span class="hljs-number">1</span></span>; }</code> </pre> <br><br>  This mechanism allows the use of all nodes, but those with more free space - more often.  Probabilistic sampling ensures that the decision to write to any one specific server will not be accepted for different clients at the same time. <br><br>  As mentioned above, the internal re-balance command uses the same algorithm to even out the server load.  Download is calculated by the ratio of free space to total: <br>  <b>load = FreeN / TotalN</b> <br><br>  This algorithm has proven itself in combat conditions. </div><p>Source: <a href="https://habr.com/ru/post/197540/">https://habr.com/ru/post/197540/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../197518/index.html">ePayService at Kyiv CasualConnect 2013</a></li>
<li><a href="../197520/index.html">Lock-free data structures. Basics: Memory Model</a></li>
<li><a href="../197522/index.html">How we did the wiren board</a></li>
<li><a href="../197524/index.html">Symfony CMF. Part 1, data storage</a></li>
<li><a href="../197528/index.html">ABCat: OpenSource catalog and audiobook downloader</a></li>
<li><a href="../197542/index.html">HTC One max officially presented</a></li>
<li><a href="../197546/index.html">Ghost: Just a blogging platform</a></li>
<li><a href="../197550/index.html">A site that matures and grows wiser without you. Pro Wordpress</a></li>
<li><a href="../197552/index.html">Update Squeeze to Wheezy under XenServer 6.2</a></li>
<li><a href="../197554/index.html">Technology rules ... information. Technological pizza</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>