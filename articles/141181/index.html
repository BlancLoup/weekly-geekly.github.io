<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Python threading or GIL us almost no hindrance</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Probably everyone who has ever been interested in Python is aware of GIL - its both a strong and weak point. 
 Without interfering with single-threade...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Python threading or GIL us almost no hindrance</h1><div class="post__text post__text-html js-mediator-article">  Probably everyone who has ever been interested in Python is aware of GIL - its both a strong and weak point. <br>  Without interfering with single-threaded scripts to work, he puts a lot of sticks in the wheels when multi-threaded work on CPU-bound tasks (when threads are running, and not hanging alternately in anticipation of I / O, etc.). <br>  The details are well described in the <a href="http://habrahabr.ru/post/84629/">translation two years ago</a> .  We cannot overcome GIL in the official Python assembly for true thread parallelization, but we can go another way - to prevent the system from transferring Python threads between kernels.  In general, the post of the series, "if you do not need, but really want" :) <br>  If you know about processor / cpu affinity, used ctypes and pywin32, then nothing new will happen. <br><a name="habracut"></a><br><br><h4>  How it all began </h4><br>  Take a simple code (almost as in the translation article): <br><pre><code class="python hljs">cnt = <span class="hljs-number"><span class="hljs-number">100000000</span></span> trying = <span class="hljs-number"><span class="hljs-number">2</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">count</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function">:</span></span> n = cnt <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> n&gt;<span class="hljs-number"><span class="hljs-number">0</span></span>: n-=<span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">test1</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function">:</span></span> count() count() <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">test2</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function">:</span></span> t1 = Thread(target=count) t1.start() t2 = Thread(target=count) t2.start() t1.join(); t2.join() seq1 = timeit.timeit( <span class="hljs-string"><span class="hljs-string">'test1()'</span></span>, <span class="hljs-string"><span class="hljs-string">'from __main__ import test1'</span></span>, number=trying )/trying <span class="hljs-keyword"><span class="hljs-keyword">print</span></span> seq1 par1 = timeit.timeit( <span class="hljs-string"><span class="hljs-string">'test2()'</span></span>, <span class="hljs-string"><span class="hljs-string">'from __main__ import test2'</span></span>, number=trying )/trying <span class="hljs-keyword"><span class="hljs-keyword">print</span></span> par1</code> </pre> <br><br>  Run on python 2.6.5 (ubuntu 10.04 x64, i5 750): <br><pre> 10.41
 13.25 </pre><br>  And in python 2.7.2 (win7 x64, i5 750): <br><pre> 19.25
 27.41 </pre><br>  Immediately discard that the win-version is clearly slower.  In both cases, a significant slowdown in the parallel version is seen. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h4>  If you really want, you can </h4><br>  GIL in any case will not allow the multithreaded version to run faster than the linear one.  However, if the implementation of some functionality is simplified when introducing threading into the code, then it is worthwhile to at least try to reduce this lag if possible. <br>  When a multi-threaded application is running, the OS can arbitrarily ‚Äútransfer‚Äù different threads between cores.  And when two (or more) threads of the same python process simultaneously try to capture GIL, the brakes start.  The transfer is also performed for a single-threaded program, but there it does not affect the speed. <br><br>  Accordingly, in order for threads to take over GIL in turn, you can limit the python process to a single core.  And it will help us in this CPU Affinity Mask, allowing in the format of bit flags to indicate which cores / processors are <u>allowed</u> to run the program. <br><br>  On different operating systems, this operation is performed by various means, but for now let's consider Ubuntu Linux and WinXP +.  <i>FreeBSD 8.2 on Intel Xeon has also been studied, but this will remain outside the article.</i> <br><br><h4>  And how many options do we have? </h4><br>  Before choosing a kernel, you need to decide how many of them we have at our disposal.  It‚Äôs worth dancing on platform features: multiprocessing.cpu_count () in python 2.6+, os.sysconf ('SC_NPROCESSORS_ONLN') by POSIX, etc.  An example of the definition can be found <a href="https://github.com/AterCattus/pycpuinfo/blob/master/cpuinfo/info.py">here</a> . <br><br>  Directly to work with the processor affinity were selected: <br><ul><li>  Linux: <a href="http://linux.die.net/man/2/sched_setaffinity">sched_setaffinity</a> / <a href="http://linux.die.net/man/2/sched_getaffinity">sched_getaffinity</a> from libc </li><li>  Windows: <a href="http://msdn.microsoft.com/en-us/library/windows/desktop/ms686223(v%3Dvs.85).aspx">kernel32 SetProcessAffinityMask</a> / <a href="http://msdn.microsoft.com/en-us/library/windows/desktop/ms683213(v%3Dvs.85).aspx">GetProcessAffinityMask</a> </li><li>  POSIX as an oftopik: pthread_setaffinity_np / pthread_getaffinity_np </li></ul><br><br><h4>  Linux ubuntu </h4><br>  To reach libc we will use the <a href="http://docs.python.org/library/ctypes.html">ctypes</a> module.  To load the required library, use ctypes.CDLL: <br><pre> <code class="python hljs">libc = ctypes.CDLL( <span class="hljs-string"><span class="hljs-string">'libc.so.6'</span></span> ) libc.sched_setaffinity <span class="hljs-comment"><span class="hljs-comment">#  </span></span></code> </pre><br>  Everything would be fine, but there are two points: <br><ul><li>  The hard assignment of the name libc.so.6 is not portable, and the file libc.so, which should be a symlink to the real version, is made a text file on Debian / Ubuntu. <br>  At the moment, a crutch has been made in the form of searching for all files whose names begin with ‚Äúlibc.so‚Äù and an attempt to load them with OSError processing.  Loaded - this is our library. <br>  <i>If someone knows the best and universal solution - I will see it once in the comments or in the PM.</i> <br></li><li>  Specifying a function name is not enough.  We also need the number of parameters and their types.  To do this, use the task ‚Äúmagic‚Äù attribute <a href="http://docs.python.org/library/ctypes.html">argtypes</a> for the functions we need. <br></li></ul><br>  Our functions: <br><pre> <code class="hljs cpp"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">sched_setaffinity</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">pid_t</span></span></span></span><span class="hljs-function"><span class="hljs-params"> pid, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">size_t</span></span></span></span><span class="hljs-function"><span class="hljs-params"> cpusetsize, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">cpu_set_t</span></span></span></span><span class="hljs-function"><span class="hljs-params"> *mask)</span></span></span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">sched_getaffinity</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">pid_t</span></span></span></span><span class="hljs-function"><span class="hljs-params"> pid, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">size_t</span></span></span></span><span class="hljs-function"><span class="hljs-params"> cpusetsize, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">cpu_set_t</span></span></span></span><span class="hljs-function"><span class="hljs-params"> *mask)</span></span></span></span>;</code> </pre><br>  pid_t is an int, cpu_set_t is a structure from a single field with a size of 1024 bits (that is, it is possible to work with 1024 cores / processors). <br>  We use cpusetsize to not work immediately with all kernels and assume that cpu_set_t is unsigned long.  <i>In general, <a href="http://docs.python.org/library/ctypes.html">ctypes.Arrays</a> should be used, but this is beyond the scope of the article.</i> <br>  It is also worth noting that the mask is passed as a pointer, i.e.  ctypes.POINTER (&lt;type of value itself&gt;). <br>  After the <a href="http://docs.python.org/library/ctypes.html">correspondence of types C and ctypes</a> we get: <br><pre> <code class="python hljs">__setaffinity = _libc.sched_setaffinity __setaffinity.argtypes = [ctypes.c_int, ctypes.c_size_t, ctypes.POINTER(ctypes.c_size_t)] __getaffinity = _libc.sched_getaffinity __getaffinity.argtypes = [ctypes.c_int, ctypes.c_size_t, ctypes.POINTER(ctypes.c_size_t)]</code> </pre><br><br>  After specifying argtypes, ctypes follows the types of values ‚Äã‚Äãpassed.  So that the module does not swear, but does its work, we correctly indicate the values ‚Äã‚Äãwhen calling: <br><pre> <code class="python hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">get_affinity</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(pid=</span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">0</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function">:</span></span> mask = ctypes.c_ulong(<span class="hljs-number"><span class="hljs-number">0</span></span>) <span class="hljs-comment"><span class="hljs-comment">#   c_ulong_size = ctypes.sizeof(ctypes.c_ulong) #     32/64  if __getaffinity(pid, c_ulong_size, mask) &lt; 0: raise OSError return mask.value #  ctypes.c_ulong =&gt; python int def set_affinity(pid=0, mask=1): mask = ctypes.c_ulong(mask) c_ulong_size = ctypes.sizeof(ctypes.c_ulong) if __setaffinity(pid, c_ulong_size, mask) &lt; 0: raise OSError return</span></span></code> </pre><br><br>  As you can see, ctypes itself implicitly figured out the pointer.  It is also worth noting that the call with pid = 0 is performed on the current process. <br><br><h4>  Windows XP + </h4><br>  The documentation for the functions we need indicated: <br><pre> Minimum supported client - Windows XP
 Minimum supported server - Windows Server 2003
 DLL - Kernel32.dll
</pre><br>  Now we know when this will work and which library needs to be loaded. <br><br>  We do by analogy with the Linux version.  Take the headlines: <br><pre> <code class="hljs objectivec"><span class="hljs-built_in"><span class="hljs-built_in">BOOL</span></span> WINAPI SetProcessAffinityMask( __<span class="hljs-keyword"><span class="hljs-keyword">in</span></span> HANDLE hProcess, __<span class="hljs-keyword"><span class="hljs-keyword">in</span></span> DWORD_PTR dwProcessAffinityMask ); <span class="hljs-built_in"><span class="hljs-built_in">BOOL</span></span> WINAPI GetProcessAffinityMask( __<span class="hljs-keyword"><span class="hljs-keyword">in</span></span> HANDLE hProcess, __<span class="hljs-keyword"><span class="hljs-keyword">out</span></span> PDWORD_PTR lpProcessAffinityMask, __<span class="hljs-keyword"><span class="hljs-keyword">out</span></span> PDWORD_PTR lpSystemAffinityMask );</code> </pre><br>  As a HANDLE, ctypes.c_uint will suit us perfectly, but with out types of parameters you need to be careful: <br>  DWORD_PTR is all the same ctypes.c_uint, and <b>P</b> DWORD_PTR is already ctypes.POINTER (ctypes.c_uint). <br>  Total we get: <br><pre> <code class="python hljs">__setaffinity = ctypes.windll.kernel32.SetProcessAffinityMask __setaffinity.argtypes = [ctypes.c_uint, ctypes.c_uint] __getaffinity = ctypes.windll.kernel32.GetProcessAffinityMask __getaffinity.argtypes = [ctypes.c_uint, ctypes.POINTER(ctypes.c_uint), ctypes.POINTER(ctypes.c_uint)]</code> </pre><br><br>  And it seems that we will do it there and it will work: <br><pre> <code class="python hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">get_affinity</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(pid=</span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">0</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function">:</span></span> mask_proc = ctypes.c_uint(<span class="hljs-number"><span class="hljs-number">0</span></span>) mask_sys = ctypes.c_uint(<span class="hljs-number"><span class="hljs-number">0</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> __getaffinity(pid, mask_proc, mask_sys): <span class="hljs-keyword"><span class="hljs-keyword">raise</span></span> ValueError <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> mask_proc.value <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">set_affinity</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(pid=</span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">0</span></span></span></span><span class="hljs-function"><span class="hljs-params">, mask=</span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">1</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function">:</span></span> mask_proc = ctypes.c_uint(mask) res = __setaffinity(pid, mask_proc) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> res: <span class="hljs-keyword"><span class="hljs-keyword">raise</span></span> OSError <span class="hljs-keyword"><span class="hljs-keyword">return</span></span></code> </pre><br>  <b>But alas</b> .  Functions accept not the pid, but the HANDLE process.  You still need to get it.  To do this, we use the <a href="http://msdn.microsoft.com/en-us/library/windows/desktop/ms684320(v%3Dvs.85).aspx">OpenProcess</a> function and the <a href="http://msdn.microsoft.com/en-us/library/windows/desktop/ms724211(v%3Dvs.85).aspx">CloseHandle</a> ‚Äúwell‚Äù for it: <br><pre> <code class="python hljs">PROCESS_SET_INFORMATION = <span class="hljs-number"><span class="hljs-number">512</span></span> PROCESS_QUERY_INFORMATION = <span class="hljs-number"><span class="hljs-number">1024</span></span> __close_handle = ctypes.windll.kernel32.CloseHandle <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">__open_process</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(pid, ro=True)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> pid: pid = os.getpid() access = PROCESS_QUERY_INFORMATION <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> ro: access |= PROCESS_SET_INFORMATION hProc = ctypes.windll.kernel32.OpenProcess(access, <span class="hljs-number"><span class="hljs-number">0</span></span>, pid) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> hProc: <span class="hljs-keyword"><span class="hljs-keyword">raise</span></span> OSError <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> hProc</code> </pre><br>  If you do not go into details, then we simply get the HANDLE of the process we need with access to read the parameters, and with ro = False and change them.  This is written in the documentation for SetProcessAffinityMask and GetProcessAffinityMask: <br><pre> SetProcessAffinityMask:
 hProcess [in]
 It is a mask to be set.  This handle must have the PROCESS_SET_INFORMATION access right.

 GetProcessAffinityMask:
 hProcess [in]
 A handle is required.
 Windows Server 2003 and Windows XP: The PROCESS_QUERY_INFORMATION access right.
</pre><br>  So no Monte Carlo method :) <br><br>  We rewrite our get_affinity and set_affinity with the changes: <br><pre> <code class="python hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">get_affinity</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(pid=</span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">0</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function">:</span></span> hProc = __open_process(pid) mask_proc = ctypes.c_uint(<span class="hljs-number"><span class="hljs-number">0</span></span>) mask_sys = ctypes.c_uint(<span class="hljs-number"><span class="hljs-number">0</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> __getaffinity(hProc, mask_proc, mask_sys): <span class="hljs-keyword"><span class="hljs-keyword">raise</span></span> ValueError __close_handle(hProc) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> mask_proc.value <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">set_affinity</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(pid=</span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">0</span></span></span></span><span class="hljs-function"><span class="hljs-params">, mask=</span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">1</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function">:</span></span> hProc = __open_process(pid, ro=<span class="hljs-keyword"><span class="hljs-keyword">False</span></span>) mask_proc = ctypes.c_uint(mask) res = __setaffinity(hProc, mask_proc) __close_handle(hProc) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> res: <span class="hljs-keyword"><span class="hljs-keyword">raise</span></span> OSError <span class="hljs-keyword"><span class="hljs-keyword">return</span></span></code> </pre><br><br><h4>  WindowsXP + for the lazy </h4><br>  To reduce the amount of code for Win-implementation a little, you can install the <a href="http://pypi.python.org/pypi/pywin32">pywin32</a> module.  It will save us from having to set constants and deal with libraries and call parameters.  Our code above might look something like this: <br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> win32process, win32con, win32api, win32security <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> os <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">__open_process</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(pid, ro=True)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> pid: pid = os.getpid() access = win32con.PROCESS_QUERY_INFORMATION <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> ro: access |= win32con.PROCESS_SET_INFORMATION hProc = win32api.OpenProcess(access, <span class="hljs-number"><span class="hljs-number">0</span></span>, pid) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> hProc: <span class="hljs-keyword"><span class="hljs-keyword">raise</span></span> OSError <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> hProc <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">get_affinity</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(pid=</span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">0</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function">:</span></span> hProc = __open_process(pid) mask, mask_sys = win32process.GetProcessAffinityMask(hProc) win32api.CloseHandle(hProc) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> mask <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">set_affinity</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(pid=</span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">0</span></span></span></span><span class="hljs-function"><span class="hljs-params">, mask=</span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">1</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">try</span></span>: hProc = __open_process(pid, ro=<span class="hljs-keyword"><span class="hljs-keyword">False</span></span>) mask_old, mask_sys_old = win32process.GetProcessAffinityMask(hProc) res = win32process.SetProcessAffinityMask(hProc, mask) win32api.CloseHandle(hProc) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> res: <span class="hljs-keyword"><span class="hljs-keyword">raise</span></span> OSError <span class="hljs-keyword"><span class="hljs-keyword">except</span></span> win32process.error <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> e: <span class="hljs-keyword"><span class="hljs-keyword">raise</span></span> ValueError, e <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> mask_old</code> </pre><br>  Briefly, of course, but this is a third-party module. <br><br><h4>  And what is the result? </h4><br>  If you put it all together and add one more to our initial tests: <br><pre> <code class="python hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">test3</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function">:</span></span> cpuinfo.affinity.set_affinity(<span class="hljs-number"><span class="hljs-number">0</span></span>,<span class="hljs-number"><span class="hljs-number">1</span></span>) <span class="hljs-comment"><span class="hljs-comment">#     (pid=0) affinity   . test2() par2 = timeit.timeit( 'test3()', 'from __main__ import test3', number=trying )/trying print par2</span></span></code> </pre><br><br>  then the results will be as follows: <br><pre> Linux:
 test1: 10.41 |  102.89
 test2: 13.25 |  135.29
 test3: 10.45 |  104.51

 Windows:
 test1: 19.25 |  191.97
 test2: 27.41 |  269.78
 test3: 19.52 |  196.17
</pre><br>  The numbers in the second column are the same tests, but with <b>cnt</b> 10 times more. <br>  We received two threads of execution with virtually no loss in speed compared to the single-threaded option. <br><br>  Affinity is set to bitmask on both OSs.  On a <b>4th</b> nuclear machine, <b>get_affinity returns the</b> value 15 (1 + 2 + 4 + 8). <br><br>  The example and all code for article laid out on <a href="https://github.com/AterCattus/pycpuinfo">github</a> . <br>  I accept any suggestions and complaints. <br>  Also interested in the results on the processor with support for HT and other versions of Linux. <br><br>  All from the first of April!  <i>This code really works :)</i> </div><p>Source: <a href="https://habr.com/ru/post/141181/">https://habr.com/ru/post/141181/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../141175/index.html">Digium purchased by Microsoft, Asterisk will not be free and will work under Windows</a></li>
<li><a href="../141176/index.html">New Google Chrome feature for parallel multi-task solving.</a></li>
<li><a href="../141178/index.html">Youtube Collections - all Youtube videos on disks!</a></li>
<li><a href="../141179/index.html">Two cursors in Google Chrome</a></li>
<li><a href="../141180/index.html">Why are rubies so evil?</a></li>
<li><a href="../141182/index.html">Charles Stross on the Girls Around Me app</a></li>
<li><a href="../141183/index.html">Unity - choose javascript editor</a></li>
<li><a href="../141185/index.html">Add Google Chrome Multitask support to your site.</a></li>
<li><a href="../141186/index.html">Have you already played for April 1?</a></li>
<li><a href="../141187/index.html">Test execution of server cases</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>