<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Telegram conference bot (start)</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Good day, Habrahabr! In this article I want to share a little freelancing experience in developing chat bots for business. The article will be useful ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Telegram conference bot (start)</h1><div class="post__text post__text-html js-mediator-article"><p><img src="https://habrastorage.org/getpro/habr/post_images/f60/3b7/60f/f603b760fdda5ba49b836b376050e3d7.png" alt="Bot"></p><br><p>  Good day, Habrahabr!  In this article I want to share a little freelancing experience in developing chat bots for business.  The article will be useful to novice developers, and can also throw a couple of interesting ideas for a more experienced audience. </p><br><p>  Further material is designed for people who imagine how to create a simple express server, and also have basic experience with MongoDB. </p><br><p>  A few years ago, I and my team of acquaintances faced an interesting order.  It was necessary to implement a tool for one IT conference.  This service should have been able to collect instant feedback from the audience and share information about the event.  As a result of discussions, we came to the creation of Telegram bot.  It was the simplest and cheapest solution at the time. </p><br><p>  Today we will try to implement something similar, as well as deal with the basic principle of the chatbots. </p><br><h3 id="chto-dolzhen-umet-nash-bot">  What should be able to our bot? </h3><br><ul><li>  Send the event schedule in the form of telegra.ph links. </li><li>  Share the link to the site or chat event. </li><li>  Be able to send notifications to users from the admin panel. </li></ul><br><p>  We implement the voting system in the next section. </p><a name="habracut"></a><br><h3 id="chto-nam-ponadobitsya-dlya-realizacii-proekta">  What do we need for the project? </h3><br><ul><li>  <strong>mongo db</strong> - a database in which we will store users and text messages. </li><li>  <strong>express.js</strong> is a library for creating a server on node.js, which will help implement the admin panel for sending messages and managing bot settings. </li><li>  <strong>node-telegram-bot-api</strong> is a library for working with the bot itself from code. </li><li>  <strong>mongoose</strong> - orm for mongo db. </li></ul><br><h3 id="poluchaem-vse-neobhodimoe-ot-telegram">  We get everything you need from Telegram </h3><br><p><img src="https://habrastorage.org/getpro/habr/post_images/7f0/043/4ad/7f00434adcf635be818fb0c875f5c29d.png" alt="Botfather"></p><br><p>  First, you need to create a bot on the side of Telegram and get its token. </p><br><p>  To do this, we find in the Telegram bot itself called @BotFather. </p><br><p>  After a short survey, BotFather will give us a token and a link to the created bot. </p><br><h3 id="razvorachivaem-bazu-i-konnektim-mongoose">  Expand base and connect Mongoose </h3><br><p><img src="https://habrastorage.org/getpro/habr/post_images/527/23c/a61/52723ca61a3b70a807c0aad91a9ba5d6.png" alt="Mlab"></p><br><p>  You can use the service mlab.com to create a free mongo database. <br>  In the screenshot, I highlighted the place where the token is located. </p><br><p>  Note: <em>dbuser</em> and <em>dbpassword</em> need to be replaced with the login data specified when creating the database. </p><br><p>  To work with the database, we will use the mongoose.js library. </p><br><p>  At the beginning of the main app.js file, connect mongoose with a base through the token received from mlab. </p><br><pre><code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> mongoose = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'mongoose'</span></span>); mongoose.connect(<span class="hljs-string"><span class="hljs-string">'   '</span></span>, { <span class="hljs-attr"><span class="hljs-attr">useMongoClient</span></span>: <span class="hljs-literal"><span class="hljs-literal">true</span></span> });</code> </pre> <br><h3 id="bot-backend">  Bot-backend </h3><br><p>  Before we start developing our project, let's see how to create a simple Telgram bot. </p><br><p>  To clearly separate the bot, with which the client is working on the Telegram side and its logic of event processing on the side of our server, let's call the server part Bot-backend.  The whole essence of the implementation of the bot-backend is to handle the response to the user's messages. </p><br><p>  Handlers handlers themselves come in several types.  We can respond to a specific text, click a button, or the user sends files.  Let's see how this works with an example. </p><br><p>  First, let's import the library: </p><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> TelegramBot = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'node-telegram-bot-api'</span></span>);</code> </pre> <br><p>  After that, we will create a concrete implementation of api, sending a token received from the telegram to the constructor. </p><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> bot = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> TelegramBot(telegramToken, { <span class="hljs-attr"><span class="hljs-attr">polling</span></span>: <span class="hljs-literal"><span class="hljs-literal">true</span></span> });</code> </pre> <br><p>  Now we have an object on which we can hang our event handlers. </p><br><h3 id="otpravka-soobscheniya-polzolzovatelyu">  Sending a message to the user </h3><br><p>  To send a message, we need three things: </p><br><ul><li>  The user id that we can pull from the incoming message. </li><li>  Message text (you can use Markdown or Html markup) </li><li>  A set of message options. </li></ul><br><pre> <code class="javascript hljs">bot.sendMessage(clientId, <span class="hljs-string"><span class="hljs-string">', !'</span></span>, messageOptions);</code> </pre> <br><p>  What are the message options?  This is an object that contains settings for displaying a message, as well as a set of buttons.  In this case, we say that the message can be parsed as html markup, turn off the preview of the links, if any are contained in the message, and pass a set of buttons.  In more detail with the buttons, we will understand further. </p><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> messageOptions = { <span class="hljs-attr"><span class="hljs-attr">parse_mode</span></span>: <span class="hljs-string"><span class="hljs-string">"HTML"</span></span>, <span class="hljs-attr"><span class="hljs-attr">disable_web_page_preview</span></span>: <span class="hljs-literal"><span class="hljs-literal">false</span></span>, <span class="hljs-attr"><span class="hljs-attr">reply_markup</span></span>: <span class="hljs-built_in"><span class="hljs-built_in">JSON</span></span>.stringify({ <span class="hljs-attr"><span class="hljs-attr">inline_keyboard</span></span>: [[{ <span class="hljs-attr"><span class="hljs-attr">text</span></span>: <span class="hljs-string"><span class="hljs-string">' '</span></span>, <span class="hljs-attr"><span class="hljs-attr">callback_data</span></span>: <span class="hljs-string"><span class="hljs-string">'do_something'</span></span> }]] }) }</code> </pre> <br><p>  Note that callback_data has a limited size.  Read more about this in Telegram's documentation for BotApi. </p><br><h3 id="obrabotchiki-sobytiy">  Event handlers </h3><br><p>  I recommend that all event handlers be placed in a separate directory of handlers. </p><br><p>  Consider the basic handler, which is triggered when you first access the bot. At the very beginning of the dialogue with the bot, Telegram automatically sends the message "/ start", which we catch with a regular schedule.  After that we get the user's telegram id and send him a response message. </p><br><pre> <code class="javascript hljs">bot.onText(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-built_in"><span class="hljs-built_in">RegExp</span></span>(<span class="hljs-string"><span class="hljs-string">'\/start'</span></span>), <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">message, match</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-comment"><span class="hljs-comment">//  id     var clientId = message.hasOwnProperty('chat') ? message.chat.id : message.from.id; //    bot.sendMessage(clientId, 'Some message', messageOptions); });</span></span></code> </pre> <br><p>  Below, a different type of handler is implemented, it responds to a button press from those that were sent along with MessageOptions. </p><br><pre> <code class="javascript hljs">bot.on(<span class="hljs-string"><span class="hljs-string">'callback_query'</span></span>, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">message</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> clientId = message.hasOwnProperty(<span class="hljs-string"><span class="hljs-string">'chat'</span></span>) ? message.chat.id : message.from.id; <span class="hljs-comment"><span class="hljs-comment">//      callback_data     message.data if(message.data === 'do_something'){ bot.sendMessage(clientId, 'Button clicked!', messageOptions); } });</span></span></code> </pre> <br><p>  For convenience, you can make several methods for creating buttons </p><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> BotUtils = { <span class="hljs-comment"><span class="hljs-comment">//  id    getClientIdFromMessage: function (message) { return message.hasOwnProperty('chat') ? message.chat.id : message.from.id; }, //     callback_data buildDefaultButton : function (text, callback_data) { return [{ text: text, callback_data: callback_data }] }, //  -    buildUrlButton : function (text, url) { return [{ text: text, url: url }] }, //    "" buildShareButton: function (text, shareUrl) { return [{ text: text, url: 'https://telegram.me/share/url?url=' + shareUrl }] }, //     buildMessageOptions: function (buttons) { return { parse_mode: "HTML", disable_web_page_preview: false, reply_markup : JSON.stringify({ inline_keyboard: buttons }) } } };</span></span></code> </pre> <br><h3 id="glavnoe-menyu">  Main menu </h3><br><p><img src="https://habrastorage.org/getpro/habr/post_images/b76/298/d3b/b76298d3b6a542241c061357ef1419fa.png" alt="Hello"></p><br><p>  After we figured out how to work with the bot, let's implement a more complex logic for our task. </p><br><p>  I rendered the handler's registration into a separate class, which takes the bot's register method and the basic set of options. </p><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> StartHandler = { <span class="hljs-attr"><span class="hljs-attr">register</span></span>: <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">bot, messageOptions</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> clientMessage = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-built_in"><span class="hljs-built_in">RegExp</span></span>(<span class="hljs-string"><span class="hljs-string">'\/start'</span></span>); bot.onText(clientMessage, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">message, match</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-comment"><span class="hljs-comment">// Id       getClientIdFromMessage   BotUtils. var clientId = BotUtils.getClientIdFromMessage(message); //      UserService            . bot.saveUser(clientId, function (saveErr, result) { if (saveErr) { bot.sendMessage(clientId, 'Some error! Sorry', messageOptions); return; } //       .       ,     . MessagesService.getByTitle('start', function (getErr, message) { if (getErr) { bot.sendMessage(clientId, 'Some error! Sorry', messageOptions); } else { bot.sendMessage(clientId, message.text, messageOptions); } }); }); }); } };</span></span></code> </pre> <br><p>  The user will be saved when you first access the bot, we will need this to automatically send private and global messages through the admin area. </p><br><p>  Now let's implement the work of all services. </p><br><h3 id="rabota-s-mongodb">  Work with MongoDB </h3><br><p><img src="https://habrastorage.org/getpro/habr/post_images/dbf/b6d/4f2/dbfb6d4f2a24fad1c788ba1a3e4c8022.png" alt="Collections"></p><br><p>  In the database itself, we need two collections of <strong>users</strong> and <strong>messages</strong> .  You can create them directly on the mlab website. </p><br><p>  Now we describe the basic data models. </p><br><p>  <strong>The UserModel</strong> will contain the telegramId string field.  In the future, you can add a name, phone number, a link to the avatar, and other data that will be needed for your tasks. </p><br><pre> <code class="javascript hljs"> <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> mongoose = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'mongoose'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> Schema = mongoose.Schema; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> UserSchema = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Schema({ <span class="hljs-attr"><span class="hljs-attr">telegramId</span></span>: <span class="hljs-built_in"><span class="hljs-built_in">String</span></span> }); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> User = mongoose.model(<span class="hljs-string"><span class="hljs-string">'user'</span></span>, UserSchema);</code> </pre> <br><p>  <strong>MessageModel</strong> will contain the title and text of the message.  They can be edited from the admin panel.  Changing the text does not require intervention in the project itself. </p><br><pre> <code class="javascript hljs"> <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> mongoose = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'mongoose'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> Schema = mongoose.Schema; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> MessageSchema = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Schema({ <span class="hljs-attr"><span class="hljs-attr">title</span></span> : <span class="hljs-built_in"><span class="hljs-built_in">String</span></span>, <span class="hljs-attr"><span class="hljs-attr">text</span></span>: <span class="hljs-built_in"><span class="hljs-built_in">String</span></span> }); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> Message = mongoose.model(<span class="hljs-string"><span class="hljs-string">'message'</span></span>, MessageSchema);</code> </pre> <br><h3 id="servisy">  Services </h3><br><p>  Consider saving the user mentioned above.  I will make a check method that the user is new (it is not in the database) </p><br><pre> <code class="javascript hljs">isNew: <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">telegramId, callback</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-comment"><span class="hljs-comment">//    ,     ,     true UserModel.findOne({telegramId: telegramId}, function (err, existingUser) { if (err) { callback(err, null); return; } if (existingUser) { callback(null, false); } else { callback(null, true); } }); }</span></span></code> </pre> <br><p>  While saving the user, we use the method implemented above.  If the user is new, create a new object and save it to the database. </p><br><pre> <code class="javascript hljs">saveUser: <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">telegramId, callback</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-comment"><span class="hljs-comment">//           // this           UserService this.isNew(telegramId, function (err, result) { if (err) { callback(err, null); return; } if (result) { //          save var newUserDto = new UserModel({ telegramId: telegramId }); newUserDto.save(function (err) { if (err) { callback(err, null); } else { callback(null, true); } }); }else{ callback(null, false); } }); }</span></span></code> </pre><br><p>  Next we implement saving and receiving messages in the MessageService. </p><br><p>  There is nothing difficult.  For now, we only need a method for receiving the message by its name.  Reacting messages from the admin panel we will do in the next part, while we fill them with pens right in the database. </p><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> MessagesService = { <span class="hljs-attr"><span class="hljs-attr">getByTitle</span></span>: <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">title, callback</span></span></span><span class="hljs-function">) </span></span>{ MessageModel.findOne({<span class="hljs-attr"><span class="hljs-attr">title</span></span>: title}, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">err, message</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (err) { callback(err, <span class="hljs-literal"><span class="hljs-literal">null</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { callback(<span class="hljs-literal"><span class="hljs-literal">null</span></span>, message); } }); } };</code> </pre> <br><h3 id="express-server-i-administratorskaya-panel">  Express server and admin panel </h3><br><p><img src="https://habrastorage.org/getpro/habr/post_images/3a2/6e4/778/3a26e4778ae9558e152f1f867e8b60dc.png" alt="Admin"></p><br><h4 id="homecontroller">  Homecontroller </h4><br><p>  HomeController renders us a page with an input field for sending a global message.  On the view we send an array of users to display the list.  Later it will be useful to us for sending private messages. </p><br><pre> <code class="javascript hljs">homeController: <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">request, response</span></span></span><span class="hljs-function">) </span></span>{ UserService.getAll(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">err, users</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (err) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>; } response.render(<span class="hljs-string"><span class="hljs-string">'main'</span></span>, {<span class="hljs-attr"><span class="hljs-attr">users</span></span>: users}); }); }</code> </pre> <br><p>  The view itself (main.ejs) might look something like this: </p><br><pre> <code class="html hljs xml"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">h2</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">h2</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">form</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">method</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"POST"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">action</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"/globalmessage"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">h3</span></span></span><span class="hljs-tag">&gt;</span></span>:<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">h3</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">textarea</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"form-control"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">rows</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"3"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">type</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"text"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"message"</span></span></span><span class="hljs-tag">&gt;</span></span>" -..."<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">textarea</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">br</span></span></span><span class="hljs-tag">/&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">br</span></span></span><span class="hljs-tag">/&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">input</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">align</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"right"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"btn btn-success"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">type</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"submit"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">value</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">""</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">form</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">h2</span></span></span><span class="hljs-tag">&gt;</span></span>    :<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">h2</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">ul</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">%</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">for</span></span></span><span class="hljs-tag">(</span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">var</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">i</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">0;</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">i</span></span></span><span class="hljs-tag">&lt;</span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">users.length</span></span></span><span class="hljs-tag">; </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">i</span></span></span><span class="hljs-tag">++) {%&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">li</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"list-group-item list-group-item-info"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">%=</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">users</span></span></span><span class="hljs-tag">[</span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">i</span></span></span><span class="hljs-tag">]</span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">.telegramId</span></span></span><span class="hljs-tag"> %&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">li</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">%</span></span></span><span class="hljs-tag"> } %&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">ul</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">br</span></span></span><span class="hljs-tag">/&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">a</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">href</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"/"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"btn btn-success"</span></span></span><span class="hljs-tag">&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">a</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre> <br><h4 id="globalmessagecontroller">  GlobalMessageController </h4><br><p>  It processes the Post request after clicking the "Send" button, causing the mailing of messages to all users from the database, which we save when we first access the bot. </p><br><pre> <code class="javascript hljs">globalMessageController: <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">request, response</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> message = request.body.message; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> bot = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.bot; UserService.getAll(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">err, users</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (err) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>; } users.forEach(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">user</span></span></span><span class="hljs-function">) </span></span>{ bot.sendMessage(user.telegramId, message, {}); }); }); response.redirect(<span class="hljs-string"><span class="hljs-string">'/'</span></span>); }</code> </pre> <br><h3 id="konfiguraciya-i-otladka">  Configuration and Debugging </h3><br><p>  To run the project, you must have a Telegram token and connection string from the database. <br>  For the development and production version we will create two separate configurations and put them in config.json. </p><br><p>  A better solution would be to put them into server environment variables. </p><br><pre> <code class="javascript hljs"> getConfig: <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> configJson = <span class="hljs-built_in"><span class="hljs-built_in">JSON</span></span>.parse(fs.readFileSync(<span class="hljs-string"><span class="hljs-string">'./src/config.json'</span></span>, <span class="hljs-string"><span class="hljs-string">'utf8'</span></span>)); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(process.env.NODE_ENV === <span class="hljs-string"><span class="hljs-string">'production'</span></span>){ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> configJson.production; }<span class="hljs-keyword"><span class="hljs-keyword">else</span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> configJson.development; } }</code> </pre> <br><p>  For debugging, you can use the simple-node-logger library, which will write all actions with Logger.notify () in logfile.log, which can be viewed via ssh or ftp on the server. </p><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> nodeLogger = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'simple-node-logger'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> Logger = { <span class="hljs-attr"><span class="hljs-attr">logger</span></span>: nodeLogger.createSimpleLogger(<span class="hljs-string"><span class="hljs-string">'logfile.log'</span></span>), <span class="hljs-attr"><span class="hljs-attr">notify</span></span>: <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">data</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.logger.info(data, <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-built_in"><span class="hljs-built_in">Date</span></span>().toJSON()); } };</code> </pre> <br><h3 id="ishodniki">  Sources </h3><br><p>  The complete code for the entire project is here: <a href="https://github.com/mikhailcarlin7/habr-event-bot">GitHub</a> </p><br><p>  You can freely use it as a basis for your projects.  I strongly recommend to conduct a large-scale refactorig, as well as rewrite to ES6 or TypeScript. </p><br><p>  Your telegram token and mongo connection string must be entered in the file <strong>/src/config.json</strong> </p><br><p>  As a hosting service, I recommend using Heroku.  The only inconvenience will be falling asleep server after 30 minutes.  To do this, there is an ancient life hacking with pinging (you can google special services for this). </p><br><h3 id="prodolzhenie">  Continuation </h3><br><p>  In the following parts I will explain how to screw the voting system and the ability to leave applications. </p><br><p>  The following part can be found here: <a href="https://habrahabr.ru/post/343584/">Telegram conference bot (Continued)</a> </p><br><p>  Thank you for your attention, habrovchane! </p></div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <p>Source: <a href="https://habr.com/ru/post/342560/">https://habr.com/ru/post/342560/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../342544/index.html">ONLYOFFICE on the local network: a new interface for editors, CRM reports and much more</a></li>
<li><a href="../342546/index.html">About 3D shooters on CSS + HTML [translation]</a></li>
<li><a href="../342548/index.html">DEV Labs 2017. Online Scala development milestone. November 25</a></li>
<li><a href="../342550/index.html">Planning tasks and constraint programming</a></li>
<li><a href="../342556/index.html">Not a simple coordinate system, but a gold one.</a></li>
<li><a href="../342562/index.html">Vim as an esoteric text editing language</a></li>
<li><a href="../342564/index.html">CubeDB: minimalistic storage of meters with multidimensional keys</a></li>
<li><a href="../342566/index.html">How to write your swagger and not regret it</a></li>
<li><a href="../342570/index.html">Rewrite the message database VKontakte from scratch and survive</a></li>
<li><a href="../342572/index.html">Classification of the humanities and techies by comments in VK</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>