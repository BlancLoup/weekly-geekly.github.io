<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Smart home NooLite. Scenario number 1 - "Master of the house"</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Good day, dear community. 

 Today I want to share with you the experience of building smart with the use of the equipment of NooTechnika, or more pre...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Smart home NooLite. Scenario number 1 - "Master of the house"</h1><div class="post__text post__text-html js-mediator-article">  Good day, dear community. <br><br>  Today I want to share with you the experience of building smart with the use of the equipment of NooTechnika, or more precisely, the implementation of the ‚ÄúMaster of the House‚Äù scenario.  What do I mean by that?  Launch of a special ‚Äúscript‚Äù, at the time of arrival of the ‚Äúmaster‚Äù home.  I understand myself as the owner in this case, and the scenario consists of switching on the light sources in the hallway and decorative lighting in other rooms. <br><a name="habracut"></a><br>  As the hardware for the smart home, I chose the equipment of the company <a href="http://www.noo.com.by/">Nootehnika</a> . <br><br>  Those who are already familiar with the devices from Notech and want to go straight to the description of the implementation of the scenario, can safely scroll to section 2. I invite everyone else to get acquainted with a brief introduction, giving a general idea of ‚Äã‚Äãhow to set up a smart home from Notechnika. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h2>  <b>1. Introduction</b> </h2><br>  As a hardware for my smart home, I have been using the equipment of the company Notechnika for several years.  The range of devices is wide enough to build a smart home within a city apartment and is constantly expanding.  At the moment there are radio switches of different configurations, power units for connecting light sources and electrical appliances, motion, humidity and temperature sensors, as well as transmitters and command receivers (for connecting to a computer).  There are still so-called.  Ethernet-gateway, which can also be used for centralized control of smart home devices from the company Nootehnika. <br><br>  At the moment, in my smart home, I use several 3-button switches, about 10 power units, 2 motion sensors, as well as a signal transmitter (model PC1116) power units and a receiver (model RX2164) signals from sensors and switches. <br><br>  As a smart home control, I use a 3VI nettop based on the Intel ATOM D525 processor with Debian 7 OS on board.  A receiver and a transmitter are connected to it. <br><br>  I use a set of Linux utilities from Oleg Artamonov, which is available on GitHub - <a href="https://github.com/olegart/noolite">github.com/olegart/noolite,</a> as software for managing the smart home.  Also on a nettop, a web server and a handwritten web interface are raised to communicate with smart home devices. <br><br>  Before starting the description of the implementation of the script, a few words about the devices themselves and what is meant for what: <br><br><ol><li>  Power units (there are different, to support different loads, ranging from 200 W and ending with several KW).  They are connected to the AC network and are designed to control electrical appliances (they are connected "into the gap" between the network and the electrical appliance); </li><li>  Radio switches.  Intended for: <br>  - sending commands on, off, load changes (dimming) on ‚Äã‚Äãthe power blocks, <br>  - sending commands to the receiver RX2164 (connected to a PC); </li><li>  Motion sensors, temperature, humidity.  Designed to send commands to the power units or the receiver; </li><li>  Signal receiver RX2164.  Designed to receive signals from sensors or switches; </li><li>  Signal Transmitter PC1116.  Designed to send control signals to power units. </li></ol><br>  An example of a general scheme of the interaction of components is shown in Figure 1. <br><div style="text-align:center;"><img src="https://habrastorage.org/files/d3d/6a8/1dd/d3d6a81dd31e4bff80fc78aa9d7da718.jpg" width="450" height="300"></div><br>  <b>Figure 1</b> - The general scheme of the interaction of components <br><br>  This concludes the introduction and presentation of general information about the components of a smart home from Nootech.  Comprehensive data can be obtained on the Notek <a href="http://www.noo.com.by/">off site</a> .  Next, turn to the description of the script and its implementation. <br><br><h2>  <b>2. Statement of the problem</b> </h2><br>  It is necessary to realize the inclusion of light sources in the hallway area, as well as decorative light sources in the hall and corridor at the moment when the owner (that is, your humble servant) returns home. <br><br>  At this stage I want to note a few points that need to be addressed at the stage of solving the problem: <br><br><ol><li>  It is necessary to identify the visitor (that this is the owner); </li><li>  It is necessary to make sure that the owner has come, and not just was near the door (for example, to check whether the lock is locked); </li><li>  It is necessary to make sure that the owner has come, and not just left the house for a couple of minutes and returned (to meet the courier, open the door in the vestibule, etc.). </li></ol><br><h2>  <b>3. Description of the solution</b> </h2><br>  To solve the problem ‚Ññ1, it was decided to use the host‚Äôs smartphone as its (master) identifier.  Those.  If the smartphone is connected to a home WiFi-router, then the owner of the house.  A static record of the correspondence of the IP address with the MAC address of the smartphone has been created on the router's DHCP server.  Thus, the smartphone always appears on the network with the same IP address. <br><br>  To solve the task ‚Ññ2, two motion sensors of the Nomener of model PM112 and the receiver of signals RX2164 are used.  One of them is installed in front of the entrance door to the apartment in the vestibule.  The second is installed inside the apartment, right near the front door.  The idea is to identify the arrival event to the apartment by the sequential operation of the sensors in the vestibule and in the apartment.  A description of the solution to this subtask is given in section 4. <br><br>  To solve task No. 3, a script is used - the ‚Äústatus generator‚Äù (see Figure 3), which checks the connection of the host‚Äôs smartphone to the WiFi router every minute and writes the current status to a file.  I set up the logic in the script in such a way that it does NOT generate a host home event if its absence is less than 20 minutes (for example, if the host went out for a couple of minutes).  Of course, this threshold can be configured as you like.  A description of the solution to this subtask is given in section 5. <br><br>  In addition, you need something that can link all the events from the sensors, and run the script, which in turn will check the status and if the conditions are met (ie, the host arrives home), turn on the lights.  To solve this problem, I chose the software <a href="https://simple-evcorr.github.io/man.html">Simple Event Correlator</a> , running under Linux and freely distributed.  I wrote a script in addition to it - ‚Äúsmartphone connection checker‚Äù (see Figure 3).  A description of the solution to this subtask is given in section 6. <br><br>  I installed the PM112 motion sensors as shown in Figure 2. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/files/490/829/60f/49082960f0e54623ad0eafc94438e163.jpg" width="500" height="550"></div><br>  <b>Figure 2</b> - The layout of the movement sensors PM112 <br><br>  The locations for the sensors, as well as their sensitivity, were chosen and tuned in such a way as to eliminate false alarms. <br><br>  Further briefly describe the interaction scheme of all components of the solution. <br><br>  The receiver of signals from Noolite sensors is connected to a nettop (hereinafter referred to as a PC, see Figure 1).  The PC is configured to record messages received from the sensors in a log file in real time (see Figure 3).  Simple Event Correlator (hereinafter referred to as SEC) runs on a PC and reads a log file (where events from sensors arrive).  In the SEC, a rule is set up that triggers in the case of receiving signals about movement from sensor 1 (see Figure 2) and for no more than 60 seconds followed by a signal about movement from sensor 2 (see Figure 2).  When this rule is triggered, a script scanner is launched that checks the status of the master smartphone, reading the information from the status file and also performing independent checks (to reduce false positives).  In the case of registration by the script of the fact of the arrival of the host home, the launch of the scenario program for switching on the light is performed. <br><br>  It is also necessary to mention the script - the status generator.  This script continually checks the status of the host‚Äôs smartphone, regardless of whether the host is at home or not, and starts internal counters in case of its (status) change.  In a word - monitors the status of the smartphone. <br><br>  A diagram explaining the above is shown in Figure 3. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/files/ae1/dfb/cb3/ae1dfbcb3874467d814aa6e394c6932a.jpg" width="650" height="250"></div><br>  <b>Figure 3</b> - Block diagram of the interaction of system components <br><br><h2>  <b>4. Identification of the event coming home</b> </h2><br>  In this section, I will discuss the connection and configuration of the PM112 motion sensors, as well as the settings of the RX2164 receiver control utility. <br><br>  The locations for the sensors, as well as their sensitivity, were chosen and tuned in such a way as to eliminate false alarms.  Sensor No. 1 I installed above the cabinet for the shoes (see Figure 4) and adjusted the sensitivity so that it responds to movement at a distance of about 50 cm (this corresponds to the position of the sensitivity regulator, as in Figure 5 - slightly more than half the regulator stroke ).  If you make the sensitivity more, it can react to the neighbors passing by, and if you put it under the cabinet, then the household can make it trivial.  The illumination setting is set to the "On" position - the lowest one.  Although other illumination settings provide energy saving (it works on batteries), but with different illumination settings I was not able to achieve a stable response.  Most likely the reason is not very abundant lighting at the sensor installation sites.  I set the on time for 5 seconds.  For me, this parameter is not very important, because  My sensors are tied to the receiver connected to the PC and I only need to receive motion detection events in the sensor's operating area. <br><br>  I installed the second sensor above the entrance door from the side of the apartment (see Figure 6).  The entrance door is in a small niche, so there is a very convenient place above it for fixing the sensor.  Krepil on screws.  The sensitivity threshold set the same threshold as sensor No. 1, so that it triggered the movement approximately at a distance of 50cm.  If more, then there will be a lot of false positives when someone climbs into the closet for clothes or domestic animals. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/files/d0a/25f/7db/d0a25f7db9c04e2ca4a1541539427bef.jpg" width="300" height="400"></div><br>  <b>Figure 4</b> - Installation of the sensor in the chain area <br><br><div style="text-align:center;"><img src="https://habrastorage.org/files/e46/b6a/0bc/e46b6a0bca8145aeb6955e2cbc37ab82.jpg" width="300" height="300"></div><br>  <b>Figure 5</b> - Motion Sensor Setup <br><br><div style="text-align:center;"><img src="https://habrastorage.org/files/658/90f/8c8/65890f8c8adb42fbbc9e165e1e62e354.jpg" width="300" height="400"></div><br>  <b>Figure 6</b> - Installation of the sensor in the hallway area <br><br>  To receive messages from motion sensors, I use a set of utilities running under the Linux operating system.  In my case, this is Debian 7. <br><br>  This set of utilities was developed by Oleg Artamonov and is available on <a href="https://github.com/olegart/noolite">GitHub</a> .  The installation of a set of utilities is well described by the author himself, so I will not dwell on it.  Just note that for its implementation, you still need knowledge of Linux and in particular the understanding of the device scripts / etc / init.d /. <br><br>  The first thing you need to "tie" motion sensors PM112 to the receiver RX2164.  To do this, follow these steps: <br><br><ul><li>  enable the binding mode on the sensor itself by pressing the ‚Äúsnap / untie‚Äù button on the rear wall of the sensor once; </li><li>  on the PC, execute the command in the console: </li></ul><br><pre><code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># nooliterxcfg ‚Äìbind &lt;   1  64&gt;</span></span></code> </pre> <br>  This procedure must be performed for each sensor.  In my case, there are two of them and they are tied to channels 2 and 3, therefore: <br><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># nooliterxcfg ‚Äìbind 2 # nooliterxcfg ‚Äìbind 3</span></span></code> </pre> <br>  In order for the nooliterx utility to work in the background, you need to start it using the /etc/init.d/nooliterx script.  This script is on github in a place with utilities, but under my Debian it did not work, so I modified it a bit.  The result was the following: <br><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#!/bin/sh # nooliterx Starts and stops the NooLite RX1164 receiver daemon # chkconfig: 2345 55 25 # description: NooLite RX1164 smart home wireless receiver daemon # Source function library. . /lib/lsb/init-functions #. /etc/rc.d/init.d/functions nooliterx="/usr/local/bin/nooliterx" prog=`basename $nooliterx` lockfile="/var/lock/subsys/nooliterx" pidfile="/var/run/$prog.pid" start() { [ -x $nooliterx ] || exit 5 echo -n "Starting $prog: " start-stop-daemon --start --exec $nooliterx --make-pidfile --pidfile $pidfile --background retval=$? echo [ $retval -eq 0 ] &amp;&amp; touch $lockfile return $retval } stop() { echo -n "Stopping $prog: " killproc -p $pidfile $prog retval=$? echo [ $retval -eq 0 ] &amp;&amp; rm -f $lockfile return $retval } restart() { stop start } case "$1" in start) $1 ;; stop) $1 ;; restart) $1 ;; *) echo $"Usage: $0 {start|stop|restart}" exit 2 esac</span></span></code> </pre> <br>  By default, nooliterx writes messages about the movement of motion sensors in a syslog.  It is very convenient.  In order for the messages from the sensors to fall into a separate file (which will be analyzed by the SEC) I set up a redirect to syslog-ng installed on the PC.  To do this, add the following lines to the relevant sections of the /etc/syslog-ng/syslog-ng.conf file: <br><br><pre> <code class="bash hljs">destination sec_log { file(<span class="hljs-string"><span class="hljs-string">"/var/log/sec.log"</span></span>); }; filter motion_sens { program(<span class="hljs-string"><span class="hljs-string">"nooliterx.*"</span></span>); }; <span class="hljs-built_in"><span class="hljs-built_in">log</span></span> { <span class="hljs-built_in"><span class="hljs-built_in">source</span></span>(s_src); filter(motion_sens); destination(sec_log); };</code> </pre> <br>  Restart syslog-ng to apply the changes: <br><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># /etc/init.d/syslog-ng restart</span></span></code> </pre> <br>  To work in the background nooliterx runs as follows: <br><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># /etc/init.d/nooliterx start</span></span></code> </pre> <br>  To check the operation of the configured scheme, we create motion near the sensors and look at the messages coming in the /var/log/sec.log file.  They should look something like this: <br><br><pre> <code class="bash hljs">Dec 19 08:40:55 vmon nooliterx[23022]: Received: status 135, channel 2, <span class="hljs-built_in"><span class="hljs-built_in">command</span></span> 25, format 1, data 1 0 0 0 Dec 19 08:41:19 vmon nooliterx[23022]: Received: status 8, channel 3, <span class="hljs-built_in"><span class="hljs-built_in">command</span></span> 25, format 1, data 1 0 0 0 Dec 19 08:41:22 vmon nooliterx[23022]: Received: status 137, channel 3, <span class="hljs-built_in"><span class="hljs-built_in">command</span></span> 25, format 1, data 1 0 0 0</code> </pre> <br>  Moreover, at each event of motion fixation two messages should appear in the log file since  due to the design feature of the sensors, they send two signals for each of their operation.  This is done to ensure the delivery of the message, since the communication is unidirectional and in very rare cases, messages from the sensor to the receiver can be lost. <br><br><h2>  <b>5. Status generator</b> </h2><br>  The script - ‚Äústatus generator‚Äù checks the connection of the smartphone to the home WiFi network every minute and writes the current status to the file.  The verification is very simple - by sending ICMP packets to the IP address of the smartphone.  A block diagram of the logic according to which the script calculates the status is shown in Figure 7. <br><br>  Based on the data that the script writes to the status file, a correlation is made when motion sensors are triggered and a decision is made to launch the script (this is done by the script-checker, which is described in section 6). <br><br>  The script runs every minute and updates the information in the status file, as well as appends the status information with the current timestamp to the log file. <br>  Information in the status file consists of: <br><br><ul><li>  the current status of the smartphone, which can take the values ‚Äã‚Äãarrived, athome, away; </li><li>  the names of the time counter - ‚Äúleft‚Äù or ‚Äúat home‚Äù; </li><li>  counter value (corresponds to the number of minutes). </li></ul><br>  The ‚Äúathome‚Äù status indicates that the smartphone is connected to the network at home.  The status of "away", respectively, indicates the absence of a smartphone at home (network connection).  The status "arrived" appears when the smartphone has just appeared on the network and the scenario program has not yet been launched.  As soon as the light-on scenario worked, the status changes to ‚Äúathome‚Äù.  This is done to eliminate multiple positives. <br><br>  The absence of the owner of the house is considered the lack of connecting the smartphone to the network for more than 20 minutes.  Such logic is set up to filter out false positives (if, for example, the smartphone has been disconnected from the network for a short time) and so that the script does not activate, if the owner has left the house for a short time.  This condition is provided in the block diagram.  And for this purpose, introduced different types of meters - "left" and "at home".  In the absence of a smartphone on the network, the ‚Äúathome‚Äù status is maintained and the countdown of the ‚Äúoutgoing‚Äù counter begins, while the ‚Äúathome‚Äù status is maintained.  As soon as the counter value exceeds 20, the status changes to ‚Äúaway‚Äù. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/files/55b/3f0/d53/55b3f0d537814cc499ae251a47f62fb1.jpg" width="960" height="480"></div><br>  <b>Figure 7</b> - Block diagram of the "status generator" <br><br>  Below is a complete listing of the status generator script. <br><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#! /bin/sh dir=/usr/local/smarthome/imhome phone_ip=$1 stat_file="$dir/status" log_file="$dir/log_status" dt=`date` if ping -c 5 $phone_ip &gt; /dev/null then if grep "athome" $stat_file then count=$(($(cat $stat_file|grep pingok | awk -F "_" '{print $2}')+1)) stat="athome" png="pingok_" elif grep "arrived" $stat_file then count=$(($(cat $stat_file|grep pingok | awk -F "_" '{print $2}')+1)) stat="arrived" png="pingok_" else count="1" stat="arrived" png="pingok_" fi else if grep "athome" $stat_file then if grep pingnok $stat_file then count=$(($(cat $stat_file|grep pingnok | awk -F "_" '{print $2}')+1)) if [ "$count" -gt 20 ] then count="1" stat="away" png="pingnok_" else stat="athome" png="pingnok_" fi else count="1" stat="athome" png="pingnok_" fi elif grep "away" $stat_file then count=$(($(cat $stat_file|grep pingnok | awk -F "_" '{print $2}')+1)) stat="away" png="pingnok_" else count="1" stat="away" png="pingnok_" fi fi printf "$stat\n$png$count\n" &gt; $stat_file printf "$dt $stat $png$count\n" &gt;&gt; $log_file</span></span></code> </pre> <br><h2>  <b>6. SEC.</b>  <b>Event Correlation and Script Launch</b> </h2><br>  The launch of the light source switching script should be performed under the following conditions: <br><br><ol><li>  Movement detected by the sensor 1; </li><li>  Not later than 60 seconds after event 1, movement was detected by sensor 2; </li><li>  The host's smartphone has connected to the WiFi network for a 1 minute time window. </li></ol><br>  Tasks 1 and 2 are solved by SEC.  The solution of task 3, as well as the launch of the script, is performed by the script - ‚Äúsmartphone connection checker‚Äù. <br><br>  I will not describe in detail the installation and initial configuration of the SEC.  The network has enough materials and detailed MAN for this utility.  In my case, the SEC is configured to read the file /var/log/sec.log.  events coming from Noolite sensors are sent to this file. <br><br>  SEC configuration files are listed below.  The file / etc / default / sec (contains the basic settings - a configuration file with a description of the correlation rules in the ‚Äúconf‚Äù parameter, the analyzed log file in the ‚Äúinput‚Äù parameter, a syslog facility into which the SEC events are written in the ‚Äúdetach‚Äù parameter): <br><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#Defaults for sec RUN_DAEMON="yes" DAEMON_ARGS="-conf=/etc/sec.conf -input=/var/log/sec.log -pid=/var/run/sec.pid -detach -syslog=local6"</span></span></code> </pre> <br>  The /etc/sec.conf file with the description of the correlation rule that executes the checker script in the event of motion being recorded, first by sensor 1, and then by sensor 2 for 1 minute: <br><br><pre> <code class="bash hljs"><span class="hljs-built_in"><span class="hljs-built_in">type</span></span>=PairWithWindow ptype=RegExp pattern=\w+\s+\d+\s+\d+\:\d+\:\d+\s+\w+\s+nooliterx\S+\s+Received\:\s+status\s+\d+,\s+channel\s+3,\s+<span class="hljs-built_in"><span class="hljs-built_in">command</span></span>\s+25.* desc=Motion sensor outside front door triggered action=logonly ptype2=RegExp pattern2=\w+\s+\d+\s+\d+\:\d+\:\d+\s+\w+\s+nooliterx\S+\s+Received\:\s+status\s+\d+,\s+channel\s+2,\s+<span class="hljs-built_in"><span class="hljs-built_in">command</span></span>\s+25.* desc2=Motion sensor by the front door inside the flat triggered action2=shellcmd (/usr/<span class="hljs-built_in"><span class="hljs-built_in">local</span></span>/smarthome/imhome/check_phone.sh 192.168.22.155); write /usr/<span class="hljs-built_in"><span class="hljs-built_in">local</span></span>/smarthome/imhome/test_corr_info %.year-%.mon-%.mday_%.%.hmsstr someone came window=60</code> </pre> <br>  As you can see, the rule looks for sensor trigger events based on regular expressions, which are recorded in the ‚Äúpattern‚Äù parameters. <br><br>  When the SEC conditions are met, the /usr/local/smarthome/imhome/check_phone.sh script is run and passes the smartphone‚Äôs IP address 192.168.22.155 as an argument. <br><br>  The script, in turn, checks the availability of the smartphone (by sending ICMP packets) and, if successful, checks the current status of the smartphone in the status file (created by the script ‚Äî the status generator).  If the status is ‚Äúaway‚Äù or ‚Äúarrived‚Äù, then it runs the script to turn on the light sources and overwrites the status value in the status file to ‚Äúathome‚Äù.  The block diagram of the script is shown in Figure 8. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/files/b5c/9c3/7ed/b5c9c37ed3ba441996f393476ad344ab.jpg" width="300" height="375"></div><br>  <b>Figure 8</b> - Block diagram of the script - the checker <br><br>  Below is a complete listing of the script.  As a scenario program, I perform the inclusion of 4 light sources using the noolitepc utility and also send an e-mail message to myself (this was done in order to simplify debugging for the testing period).  Between the inclusions of light sources made a pause.  When teams follow without it, they do not always reach power blocks. <br><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#! /bin/sh dir="/usr/local/smarthome/imhome" phone_ip=$1 stat_file="$dir/status" log_file="$dir/log_status" dt=`date` noolite="/usr/local/bin/noolitepc" a=1 MAIL="$dir/mail.letter" while [ "$a" -lt 10 ] do if ping -c 2 $phone_ip &gt; /dev/null then if grep 'arrived\|away' $stat_file then printf "$dt $phone_ip has come home. Welcome!\n" &gt;&gt; $log_file printf "Subject: Welcome home Boss!\nThe exact time is $dt\n" &gt; $MAIL /usr/sbin/ssmtp test_email@gmail.com &lt; $MAIL $noolite --on 3 sleep 1 $noolite --on 2 sleep 1 $noolite --on 6 sleep 1 $noolite --on 8 printf "athome\npingok_1\n" &gt; $stat_file fi break fi a=$((a+1)) done</span></span></code> </pre> <br>  As you can see, the script performs several verification cycles (using a while loop).  This is done to ensure the launch of the script in the event that the smartphone did not have time to connect to WiFi at the time of the sensors.  As shown by testing, this happens occasionally. <br><br><h2>  <b>7. Conclusion</b> </h2><br>  As a result, I have a system that can run any scenario programs in the event of registering the arrival of a certain person‚Äôs home.  The scenario can be not only the inclusion of lighting, but everything that is enough imagination.  For example, you can turn on the background music, make a photo of the visitor (using an IP camera) and much more. <br><br>  The SEC correlator monitors the arrival of someone's home (by analyzing events from Noolite sensors), and then sends the data to the script to check who exactly came home.  This means that you can customize different programs for different households.  By transferring the IP addresses of different smartphones to the script and adding the appropriate conditions. <br><br>  I would like to say a separate BIG THANKS to the company Nootech for providing the PM112 motion sensors and the RX2164 receiver provided for the implementation of this system. </div><p>Source: <a href="https://habr.com/ru/post/318162/">https://habr.com/ru/post/318162/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../318146/index.html">Quake Live Server Setup - Step-by-Step Guide</a></li>
<li><a href="../318148/index.html">Fast course Redux + websockets for backend</a></li>
<li><a href="../318150/index.html">Poisson distribution and football betting</a></li>
<li><a href="../318154/index.html">Practical interpretation of the method and indicators of mastered volume</a></li>
<li><a href="../318158/index.html">Slow Cooker: load testing network services</a></li>
<li><a href="../318164/index.html">Why Hackintosh is already relevant. Debunking Myths</a></li>
<li><a href="../318168/index.html">DotNext 2016 Moscow: Calm after a storm</a></li>
<li><a href="../318170/index.html">How ‚Äúinterface‚Äù differs from ‚Äúintermordia‚Äù: our approach to documenting and localizing software products</a></li>
<li><a href="../318172/index.html">Methbot advertising botnet brings $ 3- $ 5 million per day to its owners</a></li>
<li><a href="../318174/index.html">Can bitcoins be calculated faster, easier or easier?</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>