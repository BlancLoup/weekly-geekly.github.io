<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>False positives in PVS-Studio: how deep is the rabbit hole</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Our team provides fast and efficient customer support. Only programmers take part in the support, as the programmers also ask us questions and we have...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>False positives in PVS-Studio: how deep is the rabbit hole</h1><div class="post__text post__text-html js-mediator-article"><p></p><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/fc7/54d/dd0/fc754ddd0f6015be221200db998a2c21.png" alt="Unicorn PVS-Studio and GetNamedSecurityInfo"></div><br>  Our team provides fast and efficient customer support.  Only programmers take part in the support, as the programmers also ask us questions and we have to think about many of them.  I would like to describe one of the recent appeals in support of the topic of false positives, which led to a whole small study of the problem described in the letter. <br><a name="habracut"></a><br><br>  We are working hard to reduce the number of false positives issued by the PVS-Studio analyzer.  Unfortunately, static analyzers often cannot distinguish a correct code from an error, since they simply lack information.  As a result, there are false positives anyway.  However, this is not a problem, since after setting up the analyzer it is easy to achieve a situation where <a href="https://www.viva64.com/ru/b/0523/">9 out of 10</a> warnings will indicate real errors. <br><br>  Although false alarms are not as big a problem as it may seem at first glance, we constantly struggle with them, improving diagnostics.  We notice some glaring false positives ourselves, some customers and free users write to us. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Recently, one of our clients wrote a letter about the following: <br><br>  <i>The analyzer for some reason says that the pointer is always zero, although this is clearly not the case.</i>  <i>Moreover, the analyzer behaves strangely and unstable on a test project: it issues a warning, it does not issue a warning.</i>  <i>Synthetic example that reproduces a false positive:</i> <br><br><pre><code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt;windows.h&gt; #include &lt;aclapi.h&gt; #include &lt;tchar.h&gt; int main() { PACL pDACL = NULL; PSECURITY_DESCRIPTOR pSD = NULL; ::GetNamedSecurityInfo(_T("ObjectName"), SE_FILE_OBJECT, DACL_SECURITY_INFORMATION, NULL, NULL, &amp;pDACL, NULL, &amp;pSD); auto test = pDACL == NULL; // V547 Expression 'pDACL == 0' is always true. return 0; }</span></span></span></span></code> </pre> <br>  I can imagine how similar the responses are from our users.  It is immediately clear that the <i>GetNamedSecurityInfo</i> function changes the value of the <i>pDACL</i> variable.  Couldn't the developers write a handler for such simple situations?  Moreover, it is not clear why the analyzer either displays a message or does not.  Maybe they themselves have some kind of bug in the tool, such as an uninitialized variable? <br><br>  Eh ... Not an easy job - to support a static code analyzer.  But what to do, I myself have chosen such a fate.  Rolling up my sleeves, I proceeded to investigate the cause of the occurrence of a false positive. <br><br>  To begin, I studied the description of the <a href="https://docs.microsoft.com/en-us/windows/desktop/api/aclapi/nf-aclapi-getnamedsecurityinfow"><i>GetNamedSecurityInfo</i></a> function and made sure that its call really should lead to a change in the value of the <i>pDACL</i> variable.  Here is the description of the 6th function argument: <br><table><tbody><tr><td>  <b>ppDacl</b> <br><br>  Descriptor or NULL cript If you‚Äôre security descriptor has no DACL.  The DACL_SECURITY_INFORMATION flag.  Also, this parameter can be NULL if you don‚Äôt need the DACL. <br></td></tr></tbody></table><br>  I know that the PVS-Studio analyzer definitely needs to correctly process such simple code and not issue a meaningless warning.  Already at that moment my intuition told me that this would be an unusual case, which would have to spend time. <br><br>  I became convinced of my concerns when I could not reproduce the false positives either on the current alpha version of the analyzer, or on the exact version that is installed on the client.  And so, and syak, but the analyzer is silent. <br><br>  I asked the client to send me a <a href="https://www.viva64.com/ru/t/0076/">preprocessed i-file</a> generated for the program with a synthetic example.  He generated, sent the file, and I began to examine it in detail. <br><br>  On the sent file, the analyzer immediately issued a false positive.  On the one hand, this is good, since the bug is reproduced.  On the other hand, I experienced the feelings that this picture best describes. <br><br><p></p><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/2a5/3b7/835/2a53b7835cbd19da489074d65e78245a.png" alt="shta"></div><br><br>  Why exactly these?  I know perfectly well how the <a href="https://www.viva64.com/ru/w/v547/">V547</a> analyzer and diagnostics <a href="https://www.viva64.com/ru/w/v547/">work</a> .  Well, there can not be such a response! <br><br>  Ok, make tea and continue. <br><br>  The call to the <i>GetNamedSecurityInfo</i> function <i>is</i> expanded to: <br><br><pre> <code class="cpp hljs">::GetNamedSecurityInfoW(<span class="hljs-string"><span class="hljs-string">L"ObjectName"</span></span>, SE_FILE_OBJECT, (<span class="hljs-number"><span class="hljs-number">0x00000004</span></span>L), <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, &amp;pDACL, <span class="hljs-number"><span class="hljs-number">0</span></span>, &amp;pSD);</code> </pre> <br>  This code looks the same in both my own preprocessed i-file and in the file sent by the client. <br><br>  Hmm ... Ok, now let's see how this function is declared.  In my file I see: <br><br><pre> <code class="cpp hljs">__declspec(dllimport) DWORD __<span class="hljs-function"><span class="hljs-function">stdcall </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GetNamedSecurityInfoW</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">( LPCWSTR pObjectName, SE_OBJECT_TYPE ObjectType, SECURITY_INFORMATION SecurityInfo, PSID * ppsidOwner, PSID * ppsidGroup, PACL * ppDacl, PACL * ppSacl, PSECURITY_DESCRIPTOR * ppSecurityDescriptor )</span></span></span></span>;</code> </pre> <br>  Everything is logical, everything is clear.  Nothing unexpected. <br><br>  Next, I look at the client file and ... <br><br><p></p><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/9bd/833/20b/9bd83320b84acfdd0e153e5105ec2bfd.png" alt="shta ???"></div><br><br>  There I see something from a parallel reality: <br><br><pre> <code class="cpp hljs">__declspec(dllimport) DWORD __<span class="hljs-function"><span class="hljs-function">stdcall </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GetNamedSecurityInfoW</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">( LPCWSTR pObjectName, SE_OBJECT_TYPE ObjectType, SECURITY_INFORMATION SecurityInfo, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> PSID * ppsidOwner, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> PSID * ppsidGroup, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> PACL * ppDacl, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> PACL * ppSacl, PSECURITY_DESCRIPTOR * ppSecurityDescriptor )</span></span></span></span>;</code> </pre> <br>  Notice that the formal argument <i>ppDacl is</i> marked as <i>const</i> . <br><br>  <b>WAT?</b>  <b>WTF?</b>  <b>WAT?</b>  <b>WTF?</b> <br><br>  What <i>const</i> !?  Where is he from here !? <br><br>  At least it is immediately clear that the analyzer is not at fault here and I will be able to protect his honor. <br><br>  The argument is a pointer to a constant object.  It turns out that, from the point of view of the analyzer, the function <i>GetNamedSecurityInfoW</i> cannot change the object to which the pointer refers.  Therefore, here: <br><br><pre> <code class="cpp hljs">PACL pDACL = <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>; PSECURITY_DESCRIPTOR pSD = <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>; ::GetNamedSecurityInfo(_T(<span class="hljs-string"><span class="hljs-string">"ObjectName"</span></span>), SE_FILE_OBJECT, DACL_SECURITY_INFORMATION, <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, &amp;pDACL, <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, &amp;pSD); <span class="hljs-keyword"><span class="hljs-keyword">auto</span></span> test = pDACL == <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>; <span class="hljs-comment"><span class="hljs-comment">// V547 Expression 'pDACL == 0' is always true.</span></span></code> </pre> <br>  The <i>pDACL</i> variable cannot change and the analyzer generates a reasonable warning (Expression 'pDACL == 0' is always true.). <br><br>  Why a warning is issued is understandable.  But it is not clear where this <i>const</i> came from.  It just can't be there! <br><br>  However, there is a guess, and it is confirmed by searches on the Internet.  It turns out that there is an old incorrect aclapi.h file with an incorrect description of the function.  I also found two interesting links on the Internet: <br><br><ul><li>  <a href="https://abi-laboratory.pro/compatibility/Windows_6.0_to_Windows_7.0/x86_64/headers_diff/advapi32.dll/diff.html">Headers diff for advapi32.dll between 6.0.6002.18005-Windows 6.0 and 6.1.7601.23418-Windows 7.0 versions</a> </li><li>  <a href="https://abi-laboratory.pro/compatibility/Windows_7.0_to_Windows_8.1/x86_64/headers_diff/advapi32.dll/diff.html">Headers diff for advapi32.dll between 6.1.7601.23418-Windows_7.0 and 6.3.9600.17415-Windows_8.1 versions</a> </li></ul><br>  So, there was once in the aclapi.h file (6.0.6002.18005-Windows 6.0) here is the description of the function: <br><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-function">WINADVAPI DWORD WINAPI </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GetNamedSecurityInfoW</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">( __in LPWSTR pObjectName, __in SE_OBJECT_TYPE ObjectType, __in SECURITY_INFORMATION SecurityInfo, __out_opt PSID * ppsidOwner, __out_opt PSID * ppsidGroup, __out_opt PACL * ppDacl, __out_opt PACL * ppSacl, __out_opt PSECURITY_DESCRIPTOR * ppSecurityDescriptor )</span></span></span></span>;</code> </pre> <br>  Then someone wanted to correct the type of the formal argument <i>pObjectName</i> , but at the same time spoiled the pointer types by <i>typing</i> <i>const</i> .  And aclapi.h (6.1.7601.23418-Windows 7.0) has become: <br><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-function">WINADVAPI DWORD WINAPI </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GetNamedSecurityInfoW</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">( __in LPCWSTR pObjectName, __in SE_OBJECT_TYPE ObjectType, __in SECURITY_INFORMATION SecurityInfo, __out_opt </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> PSID * ppsidOwner, __out_opt </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> PSID * ppsidGroup, __out_opt </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> PACL * ppDacl, __out_opt </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> PACL * ppSacl, __out PSECURITY_DESCRIPTOR * ppSecurityDescriptor )</span></span></span></span>;</code> </pre> <br><p></p><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/624/afc/b8b/624afcb8ba67c3ebece3128956179188.png" alt="diff 1"></div><br><br>  It becomes clear that this is exactly the wrong aclapi.h file used by the client.  Later in correspondence, he confirmed this hypothesis.  I use a more recent version, so the error was not reproduced. <br><br>  Here is what the revised feature description looks like in aclapi.h (6.3.9600.17415-Windows_8.1). <br><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-function">WINADVAPI DWORD WINAPI </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GetNamedSecurityInfoW</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">( _In_ LPCWSTR pObjectName, _In_ SE_OBJECT_TYPE ObjectType, _In_ SECURITY_INFORMATION SecurityInfo, _Out_opt_ PSID * ppsidOwner, _Out_opt_ PSID * ppsidGroup, _Out_opt_ PACL * ppDacl, _Out_opt_ PACL * ppSacl, _Out_ PSECURITY_DESCRIPTOR * ppSecurityDescriptor )</span></span></span></span>;</code> </pre> <br><p></p><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/06e/655/e79/06e655e791df23af229710143fd2b25f.png" alt="diff 2"></div><br><br>  The type of the <i>pObjectName</i> argument remains the same, but the extra <i>const is</i> removed.  Everything has returned to its place, but in the world so far the header files continue to live with the wrong function declaration. <br><br>  I tell all this to the client.  He is pleased and pleased that the situation has cleared up.  Moreover, he finds the reason why he sees a false positive, then no: <br><br>  <i>I forgot that I once experimented with toolsets on this test project.</i>  <i>In the test project, the Debug configuration is configured on the Platform Toolset by default for Visual Studio 2017 - ‚ÄúVisual Studio 2017 (v141)‚Äù, and here the Release configuration is configured on ‚ÄúVisual Studio 2015 - Windows XP (v140_xp)‚Äù.</i>  <i>Yesterday, I just at some point changed the configuration, and the warning appeared and disappeared.</i> <br><br>  Everything.  In the investigation, you can put a full stop.  With the client, we decide that we will not make any special backup in the analyzer so that it takes this bug into account in the header file.  The main thing is that now the situation is clear.  As they say, "the case is closed." <br><br>  <b>Conclusion</b> <br><br>  PVS-Studio analyzer is a complex software product that collects a lot of information from the program code and uses it for various <a href="https://www.viva64.com/ru/b/0592/">analysis technologies</a> .  Specifically, in this case, the excessive intelligence of the analyzer led to the fact that, due to an incorrect description of the function, it began to produce a false positive. <br><br>  <b>Become our clients and you will receive fast quality support from me and my colleagues.</b> <br><br><p> <a href="https://habr.com/ru/company/pvs-studio/blog/441124/"><img src="https://habrastorage.org/getpro/habr/post_images/898/3b6/5a7/8983b65a74adb29a2113eba12fbec3f1.png" align="left"></a> </p><br><br>  If you want to share this article with an English-speaking audience, then please use the link to the translation: Andrey Karpov.  <a href="https://habr.com/ru/company/pvs-studio/blog/441124/">False Positives in PVS-Studio: How Deep the Rabbit Hole Goes</a> . </div><p>Source: <a href="https://habr.com/ru/post/441126/">https://habr.com/ru/post/441126/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../437996/index.html">SITIS CTF: how a seal helped CTF win</a></li>
<li><a href="../440462/index.html">Top 7 content marketing strategies not to be missed in 2019</a></li>
<li><a href="../441114/index.html">Relational programming: pain, interest, and pain again</a></li>
<li><a href="../441116/index.html">KubeSail and its free Kubernetes-cluster for developers</a></li>
<li><a href="../441118/index.html">The results of the experiment with a four-day working week for office workers in New Zealand</a></li>
<li><a href="../441128/index.html">The right choice: a practical study of the cognitive abilities of great apes</a></li>
<li><a href="../441130/index.html">Balanced site indicators. Part 1: Strategy</a></li>
<li><a href="../441132/index.html">That Roskomnadzor did not come suddenly</a></li>
<li><a href="../441134/index.html">Emotions, independent work</a></li>
<li><a href="../441136/index.html">Long-term storage of Prometheus metrics (Alexey Palazhchenko, Percona)</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>