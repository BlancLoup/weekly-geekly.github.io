<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Optimization optimization in MatLab: nested and anonymous functions</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Good day! 
 I do research in control systems, and Matlab is my main work tool. One of the possibilities in MatLab is numerical optimization. You can o...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Optimization optimization in MatLab: nested and anonymous functions</h1><div class="post__text post__text-html js-mediator-article">  Good day! <br>  I do research in control systems, and Matlab is my main work tool.  One of the possibilities in MatLab is numerical optimization.  You can optimize (minimize) any function that accepts a vector of variable parameters and returns the value of the criterion to be minimized.  Naturally, in the optimization process, the objective function is called many times and its speed is significant.  In the lab there are good software tools that often allow you to significantly improve speed, while maintaining readability and ease of maintenance code.  I will give an example of the task, show it what anonymous functions and nested functions are, and then show how you can combine these two tools for a noticeable increase in speed. <br><br><a name="habracut"></a><br><h5>  Problem statement and optimization </h5><br>  I have been thinking about the example for optimization for a long time, trying to choose something realistic - finding the optimal trajectory for the kinematically redundant manipulator, approximation of experimental data, identification of parameters.  But all this somehow led away from the essence, so I decided to stop at an impractical, but illustrative example.  So, given the parameters <i>a</i> and <i>b</i> .  It is necessary to find <i>x</i> in the range [0; 1], which maximizes the criterion: <br><img src="https://habrastorage.org/getpro/habr/post_images/57f/cbd/f75/57fcbdf7517940850e63b9366c839309.png" alt="image"><br>  Where <img src="https://habrastorage.org/getpro/habr/post_images/c37/65b/328/c3765b3287794021cd32d7fcbf632e87.png" alt="image">  - some function that does not depend explicitly on <i>x</i> , but is necessary to calculate the criterion.  Let it be the modulus of the sum of the first million pseudo-random numbers obtained by setting the seed to <i>z</i> .  We write a matlab function that calculates the criterion value: <br><pre><code class="matlab hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">J</span></span></span><span class="hljs-function"> = </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GetJ</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(a,b,x)</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">randn</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">('seed',a)</span></span></span><span class="hljs-function">; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">phi_a</span></span></span><span class="hljs-function">=</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">abs</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(sum(randn(1,1e6)</span></span></span><span class="hljs-function">)); </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">randn</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">('seed',b)</span></span></span><span class="hljs-function">; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">phi_b</span></span></span><span class="hljs-function">=</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">abs</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(sum(randn(1,1e6)</span></span></span><span class="hljs-function">)); </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">J</span></span></span><span class="hljs-function">=-</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(phi_a*x^2+phi_b*sqrt(1-x^2)</span></span></span><span class="hljs-function">); </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">end</span></span></span></span></code> </pre> <br>  Please note that we return the value with a minus sign, since we want to find the maximum, and the optimization is looking for a minimum. <br>  Now, for optimization with specific values ‚Äã‚Äãof <i>a</i> and <i>b,</i> we need to make an anonymous function.  This is done like this: <br><pre> <code class="matlab hljs">a=<span class="hljs-number"><span class="hljs-number">121233</span></span>; b=<span class="hljs-number"><span class="hljs-number">31235</span></span>; fhnd_GetJ = @(x) GetJ(a,b,x);</code> </pre><br>  Now the <code>fhnd_GetJ</code> variable contains an anonymous function handle that takes one parameter and allows you to calculate <code>GetJ(a,b,  )</code> for the values ‚Äã‚Äãof <i>a</i> and <i>b</i> specified when creating this anonymous function.  You can go directly to the minimization.  Let's say we want to find the optimal value of <i>x</i> with an accuracy of 1 millionth: <pre> <code class="matlab hljs">opt=optimset(<span class="hljs-string"><span class="hljs-string">'TolX'</span></span>,<span class="hljs-number"><span class="hljs-number">1e-6</span></span>); optimal_x=fminbnd(fhnd_GetJ,<span class="hljs-number"><span class="hljs-number">0</span></span>,<span class="hljs-number"><span class="hljs-number">1</span></span>,opt);</code> </pre><br>  The function <code>fminbnd(fun,x_min,x_max)</code> minimizes the scalar function of the scalar argument on the interval [ <i>x_min</i> ;  <i>x_max</i> ].  Here <code>fun</code> is the handle of the function being optimized.  When performing the optimization, the <code>GetJ</code> function <code>GetJ</code> called 12 times; this can be seen by setting the <code>'Display'</code> parameter in the options as <code>'iter'</code> - it will show all iterations.  On my computer, optimization takes, on average, 10 ms. <br><br><h5>  Increase speed </h5><br>  Let's see how this can be optimized.  Obviously, every time we call the <code>GetJ</code> function <code>GetJ</code> we are completely wasting the values ‚Äã‚Äãof <code>phi_a</code> and <code>phi_b</code> , since they do not change with the variation of <i>x</i> and depend only on the given values ‚Äã‚Äãof <i>a</i> and <i>b</i> .  How can you save?  The most frequent variant that occurs to me is to make preliminary calculations from the objective function.  Do this function <br><pre> <code class="matlab hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">J</span></span></span><span class="hljs-function"> = </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GetJ2</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(phi_a,phi_b,x)</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">J</span></span></span><span class="hljs-function">=-</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(phi_a*x^2+phi_b*sqrt(1-x^2)</span></span></span><span class="hljs-function">); </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">end</span></span></span></span></code> </pre><br>  and here is the code: <br><pre> <code class="matlab hljs"><span class="hljs-built_in"><span class="hljs-built_in">randn</span></span>(<span class="hljs-string"><span class="hljs-string">'seed'</span></span>,a); phi_a=<span class="hljs-built_in"><span class="hljs-built_in">abs</span></span>(sum(<span class="hljs-built_in"><span class="hljs-built_in">randn</span></span>(<span class="hljs-number"><span class="hljs-number">1</span></span>,<span class="hljs-number"><span class="hljs-number">1e6</span></span>))); <span class="hljs-built_in"><span class="hljs-built_in">randn</span></span>(<span class="hljs-string"><span class="hljs-string">'seed'</span></span>,b); phi_b=<span class="hljs-built_in"><span class="hljs-built_in">abs</span></span>(sum(<span class="hljs-built_in"><span class="hljs-built_in">randn</span></span>(<span class="hljs-number"><span class="hljs-number">1</span></span>,<span class="hljs-number"><span class="hljs-number">1e6</span></span>))); fhnd_GetJ2 = @(x) GetJ2(phi_a,phi_b,x); optimal_x=fminbnd(fhnd_GetJ2,<span class="hljs-number"><span class="hljs-number">0</span></span>,<span class="hljs-number"><span class="hljs-number">1</span></span>,opt);</code> </pre><br>  Of course, this is considered much faster.  Optimization takes place, on average, in 0.8 ms.  But the price for this is code degradation.  The integrity of the functional is <code>phi_a</code> - the calculation of <code>phi_a</code> and <code>phi_b</code> has no independent value and is not necessary apart from the calculation of <i>J.</i>  If somewhere in another place again you need to consider <i>J (a, b, x)</i> , no longer for optimization, but just like that, then instead of just calling <code>GetJ</code> , you also have to drag the calculation of <code>phi_a</code> and <code>phi_b</code> or do functions for optimization separately, separately for calculations.  Well, just not very beautiful. <br>  It is good that the matlab has a way around this situation.  To do this, let's create a nested function inside the <code>GetJ</code> function: <br><pre> <code class="matlab hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">J</span></span></span><span class="hljs-function"> = </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GetJ3</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(a,b,x)</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">randn</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">('seed',a)</span></span></span><span class="hljs-function">; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">phi_a</span></span></span><span class="hljs-function">=</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">abs</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(sum(randn(1,1e6)</span></span></span><span class="hljs-function">)); </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">randn</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">('seed',b)</span></span></span><span class="hljs-function">; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">phi_b</span></span></span><span class="hljs-function">=</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">abs</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(sum(randn(1,1e6)</span></span></span><span class="hljs-function">)); </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">J</span></span></span><span class="hljs-function">=</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">nf_GetJ</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(x)</span></span></span><span class="hljs-function">; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">out_val</span></span></span><span class="hljs-function"> = </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">nf_GetJ</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(x)</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">out_val</span></span></span><span class="hljs-function">=-</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(phi_a*x^2+phi_b*sqrt(1-x^2)</span></span></span><span class="hljs-function">); </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">end</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">end</span></span></span></span></code> </pre> <br>  Nested function <code>nf_GetJ</code> sees all the variables in the scope of the parent function and, in principle, it is clear what and how it does.  So far, we have not received any gain in speed - all the same 10 ms for optimization. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      And now the most interesting - matlab can work with anonymous nested function.  Instead of a specific value, our <code>GetJ</code> function can return a handle to its own nested function.  And when calling a function on this handle, the parent function will not be executed, but its scope with the parameters counted will remain!  We write: <br><pre> <code class="matlab hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">fhnd_J</span></span></span><span class="hljs-function"> = </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GetJ4</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(a,b,x)</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">randn</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">('seed',a)</span></span></span><span class="hljs-function">; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">phi_a</span></span></span><span class="hljs-function">=</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">abs</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(sum(randn(1,1e6)</span></span></span><span class="hljs-function">)); </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">randn</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">('seed',b)</span></span></span><span class="hljs-function">; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">phi_b</span></span></span><span class="hljs-function">=</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">abs</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(sum(randn(1,1e6)</span></span></span><span class="hljs-function">)); </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">fhnd_J</span></span></span><span class="hljs-function">=@</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(x)</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">nf_GetJ</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(x)</span></span></span><span class="hljs-function">; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">out_val</span></span></span><span class="hljs-function"> = </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">nf_GetJ</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(x)</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">out_val</span></span></span><span class="hljs-function">=-</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(phi_a*x^2+phi_b*sqrt(1-x^2)</span></span></span><span class="hljs-function">); </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">end</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">end</span></span></span></span></code> </pre><br>  Now, the handle of the function is written into the returned variable <code>fhnd_J</code> , which allows to calculate the <i>J</i> value for the used parameters <i>a</i> and <i>b</i> , without calculating the <code>phi_a</code> and <code>phi_b</code> , but using the values ‚Äã‚Äãcalculated when creating the handle.  Further, our optimization looks like this: <br><pre> <code class="matlab hljs">fhnd_GetJ4=GetJ4(a,b,x); optimal_x=fminbnd(fhnd_GetJ4,<span class="hljs-number"><span class="hljs-number">0</span></span>,<span class="hljs-number"><span class="hljs-number">1</span></span>,opt);</code> </pre><br>  And this optimization is performed in 0.8 ms. <br><br>  <b>Result</b> <br>  We obtained the same speed as with the explicit transfer of calculations in the example with <code>GetJ2</code> , but preserved the integrity of the function and the convenience of its use. <br>  In the future, if you intend to use the function both for optimization and just for computing, then you can add one optional parameter flag to it.  If it is not specified, the function returns a value.  If set, the handle to the nested function is returned. </div><p>Source: <a href="https://habr.com/ru/post/199300/">https://habr.com/ru/post/199300/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../199288/index.html">Recovery of the TeXeT TM-9750HD tablet from a state of a full brick</a></li>
<li><a href="../199290/index.html">Yandex maps for angular.js</a></li>
<li><a href="../199292/index.html">Code Retreat at the Faculty of Computer Science</a></li>
<li><a href="../199296/index.html">Pimple? No, have not heard</a></li>
<li><a href="../199298/index.html">Excel Template for Home Bookkeeping</a></li>
<li><a href="../199302/index.html">Install squid + sams + ntlm on centos 6.4 in steps</a></li>
<li><a href="../199306/index.html">The Black Swan Theory and the Fundamental Vulnerability of Automated Systems</a></li>
<li><a href="../199308/index.html">Impressions of girl's hacked on LinkedIn</a></li>
<li><a href="../199310/index.html">Bill Gates Birthday</a></li>
<li><a href="../199312/index.html">The first silicon ionistor</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>