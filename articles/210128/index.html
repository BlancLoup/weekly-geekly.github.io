<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>FORTH: POP3 nanoclient. Part 2</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="In the second part we will try to write a minimal POP3 client. He will be able to connect to the server, log in to the mailbox, find out how many lett...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>FORTH: POP3 nanoclient. Part 2</h1><div class="post__text post__text-html js-mediator-article">  In the second part we will try to write a minimal POP3 client.  He will be able to connect to the server, log in to the mailbox, find out how many letters there are and download the latest.  To illustrate this will be enough. <br><a name="habracut"></a><br>  That it is enough to know from the POP3 protocol.  A couple of USER PASS commands are needed for the login, STAT to get the number of letters in the box and RETR to get the letter itself.  We will not delete letters with the DELE command.  QUIT team will be given out of courtesy. <br>  Let's take a closer look at the teams.  You can see that they can be divided into two groups: commands without arguments NOOP QUIT STAT RSET and commands that have an argument: DELE LIST RETR TOP APOP USER PASS.  And the last three require text strings as an argument.  Strictly speaking, all commands require a string argument.  In one case, this is an empty string, in another the string consists of decimal digits, in the third of arbitrary characters. <br><br>  Consider the simplest case, argumentless commands.  You can write in the forehead <br><br><blockquote><pre>  S "NOOP" sockt WriteSocketLine THROW and so 4 times. 
 S "DELE" sockt WriteSocket THROW S&gt; D (D.) sockt WriteSocketLine THROW </pre>  also 3 times 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      (TOP APOP will not be implemented, and with USER PASS we will not be wise yet.) </blockquote><br><br>  But we write on the Fort, and it has an elegant mechanism for creating defining words.  We use it. <br>  To begin with, we put the sockt WriteSocketLine THROW and buf bufsize sockt ReadSocket THROW TO bytes_read into separate definitions.  Too lazy to write so many letters. <br><blockquote><pre> :&gt; sockt   
               sockt WriteSocketLine THROW;

 : sockt&gt;
               buf bufsize sockt ReadSocket THROW TO bytes_read;

</pre></blockquote><br><br>  And we will start creating creating words. <br><br><blockquote><pre> : pop3_noarg 
                      CREATE LATEST, 
                      DOES&gt; @ COUNT&gt; sockt; 

 : pop3_noargs 
                     0 DO pop3_noarg LOOP;

 4 pop3_noargs NOOP QUIT STAT RSET </pre></blockquote><br><br>  Thus, in three lines, we identified four teams of the same type.  Let me explain a little more in detail what is happening here. <br>  A colon is used to define a new word pop3_noarg, with the following action: select letters from the input stream, delimited by a space, use them to create words with VARIABLE on the top of the dictionary.  This all makes the word CREATE, at the time of execution of the word pop3_noarg.  The next word LATEST pushes onto the stack the address of the name field of the word being defined, for example NOOP.  A comma compiles values ‚Äã‚Äãfrom the stack to the top of the dictionary.  If there were no DOES&gt; part further, a NOOP call would put some address onto the stack, dereferencing which we would get the address of the line with the counter, turning that into the address of the line counter with the word COUNT we could type it with the word TYPE. <br>  As a result, they would see NOOP.  Words look very difficult, faster to try on your own at the command line of the fort system. <br>  What next?  Next we have the most mysterious word of the Fort DOES&gt;.  It is enough to realize that this word changes the default action of a word created through CREATE into an action that we wish.  Everything that is written after DOES&gt; is a common action for all words defined via pop3_noarg.  Here it consists in getting the address and the string counter - the name of the word and sending it to the socket. <br><br><blockquote><pre>  : pop3_digiarg 
                CREATE LATEST, 
                DOES&gt; @&gt; R &lt;# S&gt; D #S BL HOLD R&gt; COUNT HOLDS #&gt;&gt; sockt;

 : pop3_digiargs 0 DO pop3_digiarg LOOP;

 3 pop3_digiargs DELE LIST RETR </pre></blockquote><br><br>  Very similar to the previous group of words with a noticeable difference in the DOES&gt; part.  It is clear that something is sent to the socket.  And so what? <br>  Here we use another great opportunity of the Fort.  We have a beautiful word (D.) which converts a double precision number (64 bits) from stack to line.  And we could easily use it, but for this we would have to write something like <br><br><blockquote><pre> S "LIST" sockt WriteSocket S&gt; D (D.)&gt; sockt </pre></blockquote><br><br>  Not scary, but somehow sad. <br><br>  Since we decided to make it beautiful, why not look for other solutions.  If you look at the source code of the Fort, and find the definition (D.) there you can see that it consists of &lt;# #S #&gt;.  These three words were invented by Chuck Moore and lay out the conversion of a number into a string in three stages.  The first is the preparation of the transformation, the second is the transformation itself, and the third is the output of the result.  Due to the fact that the conversion of the number occurs from the lower digits, and the seal comes from the higher digits - for the conversion you need some temporary buffer where the numbers will be added and where the result will be taken from.  Buffer size is taken with a good margin.  The word HOLD just removes the next character from the stack to the buffer.  HOLDS, a plural form of HOLD, does the same thing with several characters aka a string.  A couple of words&gt; R R&gt; is used as an easy implementation of local variables, when you need to postpone some value from the stack for a while. <br>  Such a balancing act allows you not to get additional buffers, not to copy one and the same to a bunch of places, not to bother with libraries to merge lines, but to do everything in the system buffer practically intended for this purpose. <br><br>  Now look at the server responses.  There are only two of them: + OK or -ERR, after which some text or numbers may or may not follow.  It would be nice if the server responses somehow did all the work themselves.  So that we do not have to jump on the endless branching.  And the fort can allow us that. <br>  Imagine a buffer in which the server response is stored as an input stream for interpretation.  The word EVALUATE we can interpret an arbitrary string.  We use this feature. <br>  Server response always starts with + OK or -ERR.  We put the same meaning in these answers. <br><br>  The easiest with -ERR.  In case of an error, it would be nice to output the rest of the line to the terminal and interrupt the execution of the program. <br><br><blockquote><pre>  : -ERR 1 PARSE TYPE CR ABORT; </pre></blockquote><br><br>  PARSE is used to get the tail of an interpreted string. <br><br>  + OK is not that simple.  It always pops up if the command is processed successfully.  Everything tells us well, but what is the context of this good? <br>  The first + OK reports a successful connection to the server.  We need to accept this fact and bring the server greeting to the terminal. <br>  The second and third + OK arise in the login procedure.  Just ignore the rest of the line. <br>  The fourth + OK appears in response to the STAT and to it, to the + OK, two numbers are attached.  The first is the number of messages in the box.  The second is the number of parrots occupied by them.  We do not need parrots.  So we will need to convert the text number from the server response to the number on the stack, and ignore the rest of the line. <br>  The fifth + OK will inform you that the letter we need will follow.  There is one nuance in the protocol.  First, a pause between the server‚Äôs response and the transmission of the letter.  Secondly, two numbers following + OK - the message number and its size in parrots. <br>  Sixth + OK, you can not wait, but you can handle as well as the first. <br>  So, + OK should be able to do three different actions. <br>  The fort allows you to do without flags and complex logic.  There are so-called vector words in it.  Words that can be assigned to action at any desired moment. <br><br><blockquote><pre> VECT + OK

 : do_type 1 PARSE TYPE CR;
 : do_ignore 1 PARSE 2DROP;
 : do_number 1 PARSE? SLITERAL;
 : do_msg         
                 sockt&gt;                 
                 BEGIN buf bytes_read TYPE CR 
                 bytes_read bufsize - 0 &lt;0 = WHILE sockt&gt; REPEAT do_ignore;
</pre><br></blockquote><br><br>  Now we have everything to put the code together. <br><br><div class="spoiler">  <b class="spoiler_title">Code</b> <div class="spoiler_text"><pre>
 ~ nn / lib / sock2.f  

 0 VALUE sockt
 0 VALUE bytes_read
 0 VALUE num_of_msgs

 8192 CONSTANT bufsize
 bufsize ALLOCATE THROW CONSTANT buf
 
 MODULE:

 :&gt; sockt   
               sockt WriteSocketLine THROW;

 : sockt&gt;
               buf bufsize sockt ReadSocket THROW TO bytes_read;

 : response  
                     sockt&gt;
                      buf bytes_read EVALUATE;


 : pop3_noarg 
                      CREATE LATEST, 
                      DOES&gt; @ COUNT&gt; sockt response; 

 : pop3_noargs 
                     0 DO pop3_noarg LOOP;

 4 pop3_noargs NOOP QUIT STAT RSET


 : pop3_digiarg 
                CREATE LATEST, 
                DOES&gt; @&gt; R &lt;# S&gt; D #S BL HOLD R&gt; COUNT HOLDS #&gt;&gt; sockt response;

 : pop3_digiargs 0 DO pop3_digiarg LOOP;

 3 pop3_digiargs DELE LIST RETR


 : user S "USER username"&gt; sockt response;
 : pass S "PASS password"&gt; sockt response;


 VECT + OK

 : do_type 1 PARSE TYPE CR;
 : do_ignore 1 PARSE 2DROP;
 : do_number 1 PARSE? SLITERAL do_ignore;
 : do_msg         
                 sockt&gt;                 
                 BEGIN buf bytes_read TYPE CR 
                 bytes_read bufsize - 0 &lt;0 = WHILE sockt&gt; REPEAT do_ignore;

 : -ERR do_type ABORT;


 : start_sockets   
                        SocketsStartup THROW
                        CreateSocket THROW TO sockt;

 : connect_to_host
                       GetHostIP THROW 
                      110 sockt ConnectSocket THROW 
                       response;

 \ Below is the executable code.  Above - the necessary definitions.

 start_sockets

 'do_type TO + OK 

 S "pop.server.com" connect_to_host 

 'do_ignore TO + OK

 user pass  

 'do_number TO + OK 

 STAT TO num_of_msgs

 'do_msg TO + OK 
 num_of_msgs RETR  

 'do_type TO + OK
 QUIT </pre></div></div><br><br>  It is easy to add this code so that it downloads all or some number of messages from the server, saves them to a local disk, deletes them from the server, etc.  Here I tried to demonstrate the principle of decomposition that is important for programming in the Fort language, developed and described by Leo Brody, and some tools available in the language for solving problems. <br><br>  <a href="http://habrahabr.ru/post/209818/">FORTH: nano-servers and nanoclients.</a>  <a href="http://habrahabr.ru/post/209818/">Part 1</a> <br><br>  <sub>PS: When writing the topic Habr suffered a bit.</sub> </div><p>Source: <a href="https://habr.com/ru/post/210128/">https://habr.com/ru/post/210128/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../210110/index.html">Appeal to the company "1C" by the All-Russian Society of the Blind on the issue of ensuring the non-visual accessibility of its products (technical aspects of the problem)</a></li>
<li><a href="../210118/index.html">New Googlebot User Agent for Smartphones</a></li>
<li><a href="../210120/index.html">Coursera launched specialization</a></li>
<li><a href="../210124/index.html">The tax service of Ukraine conducted a search in the office of GlobalMoney</a></li>
<li><a href="../210126/index.html">Why is bitcoin so important?</a></li>
<li><a href="../210130/index.html">Web Components is the only bright future for the web. Humble yourself</a></li>
<li><a href="../210132/index.html">IBM says goodbye to x86 servers, the entire line is sold to Lenovo</a></li>
<li><a href="../210134/index.html">Has Google overpaid for NEST?</a></li>
<li><a href="../210136/index.html">There are advances in decoding the Voynich Manuscript</a></li>
<li><a href="../210138/index.html">Fancy Skulls - development diary, entry number 1</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>