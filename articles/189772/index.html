<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>About one way to protect the source code of the Python-program</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="How it all began 
 Once I had to participate in the development of one small project for scientific calculations, which was developed in the programmi...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>About one way to protect the source code of the Python-program</h1><div class="post__text post__text-html js-mediator-article"><h4>  How it all began </h4><br>  Once I had to participate in the development of one small project for scientific calculations, which was developed in the programming language Python.  Initially, Python was chosen as a convenient and flexible language for experiments, visualization, rapid prototyping and development of algorithms, but later became the main language of project development.  It should be noted that the project was, though not large, but rather technically rich.  To ensure the required functionality, the project widely used algorithms of graph theory, mathematical optimization, linear algebra and statistics.  Decorators, metaclasses, and introspection tools were also used.  The development process had to use third-party math packages and libraries, such as numpy and scipy, as well as many others. <br><br>  Over time, it became clear that rewriting a project in a compiled language was too time consuming in terms of resources and resources.  The speed of work and memory consumption were not critical indicators in this case and were quite acceptable and sufficient.  Therefore, it was decided to leave everything as is, and continue to develop and support the project in the Python language.  In addition, the documentation for the most part has already been written using <a href="http://sphinx-doc.org/">Sphinx</a> . <br><br>  The project was a library, the functions of which were used in one of the expansion modules in a large software package.  The software complex was written in C ++, was a commercial product, had protection with a hardware key and was delivered to customers without providing source codes. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Here a new problem immediately became apparent: how to protect the source codes of our Python library?  Maybe, otherwise, no one would do it, I certainly would, but some know-how was implemented in the library, and the project leaders did not want these developments to reach the competitors.  Since I was one of the performers, I had to attend to this problem.  Next, I will try to talk about the main idea, what came of it, and how we managed to hide the Python sources from the eyes. <br><a name="habracut"></a><br><h4>  What do people offer </h4><br>  As it is known, probably, to most developers, Python is an interpretable, dynamic language with rich introspection capabilities.  The binary files of the modules * .pyc and * .pyo (byte-code) are easily decompiled, therefore it is impossible to distribute them in their pure form (if we decided not to show the source code for real). <br><br>  As I think, anyone in my place, at first I decided to search, but what do people do in such cases?  The first search queries showed that people do not know what to do and ask about it on stackoverflow and in other places, for example, here‚Äôs the <a href="http://stackoverflow.com/questions/261638/how-do-i-protect-python-code">question on stackoverflow</a> .  Searching, I came to the conclusion that everywhere they offer several controversial ways: <br><br><ul><li>  To score and not to steam, all the same, who needs it, picks it up; </li><li>  Rewrite in compiled language; </li><li>  Obfuscating source codes, for example, using <a href="https://github.com/astrand/pyobfuscate">one</a> and <a href="http://www.bitboost.com/">two</a> ; </li><li>  Translate all Python modules into extension modules (*. Pyd) using Cython or <a href="http://nuitka.net/">Nuitka</a> (as did <a href="https://habrahabr.ru/users/warsoul/" class="user_link">warsoul</a> - the author of <a href="http://habrahabr.ru/post/138537/">this article</a> ); </li><li>  Replace opcodes in the Python interpreter source code and distribute your build, as <a href="http://habrahabr.ru/post/138537/">suggested by</a> <a href="https://habrahabr.ru/users/hodik/" class="user_link">hodik</a> . </li></ul><br><br>  For many reasons, I have discarded all these methods as inappropriate.  For example, obfuscation of Python code.  Well, what could obfuscation be when the syntax of a language is built on indents, and the language itself is permeated with ‚Äúsly introspection‚Äù?  Translating all Python-modules into binary expansion modules was also not possible, since the project, I recall, was technically quite complex using many third-party packages, and it itself consisted of a large number of modules in a multi-level package hierarchy that was tedious to overtake * .pyd, and then catch bugs, getting out of the blue.  I didn‚Äôt want to mess with replacing opcodes, because I would have to distribute and maintain my own Python interpreter build, and even compile Python modules of all used third-party libraries. <br><br>  At some point it seemed to me that this idea with the protection of the Python source code was useless, I had to give it all up and convince the management that nothing would come out and do something useful.  We give away the * .pyc files, okay, who will understand it?  It was not possible to convince, no one wanted to rewrite the library in C ++, and the project needed to be handed over.  In the end, still something turned out to do.  About this, if still interesting, you can read further. <br><br><h4>  What did we do </h4><br>  What can best protect any information on digital media from outsiders?  I think this is encryption.  Armed with this fundamental idea, I decided that the source code should be encrypted, otherwise it should not be.  For an outside observer who began to show excessive interest, all this should look like a bunch of incomprehensible files with incomprehensible contents.  It is quite an obfuscation, but more advanced than replacing variable names and inserting empty lines. <br><br>  The course of my thoughts was as follows: <br><br><ul><li>  We encrypt in any way all the sources of our Python library, you can even mix them and change the names of the modules and packages files; </li><li>  We write binding in order for the Python interpreter to be able to load and import modules from encrypted text files (decryption, restoration of the package structure and file names, import, etc.); </li><li>  ‚ÄúHide‚Äù all this into a binary extension module (* .pyd), so that <i>no one would guess</i> . </li></ul><br><br>  The basic idea, I think, is clear - this is a more advanced obfuscation.  How to do it?  Googling, I came to the conclusion that this is quite realistic and even quite simple.  With source code encryption, everything is clear; you can encrypt and / or obfuscate files in a variety of ways, as long as there was ‚Äúporridge‚Äù and ‚Äúnothing is clear‚Äù, and all this should be returned to its original form in an unknown way (in the case of obfuscation).  For the example here, I will use the <a href="http://docs.python.org/2/library/base64.html">base64</a> Python module to ‚Äúencrypt‚Äù.  In non-critical cases, you can use the wonderful <a href="">obfuscate</a> package. <br><br><h5>  Python the Importer Protocol </h5><br>  How do we realize the ability to import modules from encrypted files?  Fortunately, Python has an import hook system that works on the basis of the Importer Protocol ( <a href="http://www.python.org/dev/peps/pep-0302/">PEP 302</a> ).  So we will use this opportunity.  To intercept imports, the <code>sys.meta_path</code> dictionary is <code>sys.meta_path</code> , in which <code>finder/loader</code> objects that implement the Importer Protocol should be stored.  A survey of this dictionary always occurs until the paths in <code>sys.path</code> are checked. <br><br>  For a minimal implementation of the import protocol, you need to implement two methods: <code>find_module</code> and <code>load_module</code> .  The <code>find_module</code> method <code>find_module</code> responsible for finding a specific module / package (after all, we only need to intercept the import of our modules, and transfer the rest to the standard mechanism), and the <code>load_module</code> method, respectively, loads a specific module only if it was ‚Äúfound‚Äù in the <code>find_module</code> method. <br><br>  So, seemingly got to the bottom.  You can give a simple example.  A minimal example of a class that implements the Importer Protocol suitable for our purposes.  It will import base64-encoded modules from the usual package structure (in this case, for simplicity, we simply ‚Äúencrypted the contents‚Äù of the files, but did not change their names or package structure).  We believe that the file extensions for our modules will be proudly called ".b64". <br><br><div class="spoiler">  <b class="spoiler_title">Importer class</b> <div class="spoiler_text"><pre> <code class="python hljs"><span class="hljs-comment"><span class="hljs-comment">#coding=utf-8 import os import sys import imp import base64 EXT = '.b64' #=============================================================================== class Base64Importer(object): """     python-,   base64   Import Protocol (PEP 302)    ,   base64   . """ #--------------------------------------------------------------------------- def __init__(self, root_package_path): self.__modules_info = self.__collect_modules_info(root_package_path) #--------------------------------------------------------------------------- def find_module(self, fullname, path=None): """          fullname  base64     ,      (finder),  None,     base64. """ if fullname in self.__modules_info: return self return None #--------------------------------------------------------------------------- def load_module(self, fullname): """  base64      fullname  base64,     .   ImportError    . """ if not fullname in self.__modules_info: raise ImportError(fullname) #   imp.acquire_lock() try: mod = sys.modules.setdefault(fullname, imp.new_module(fullname)) mod.__file__ = "&lt;{}&gt;".format(self.__class__.__name__) mod.__loader__ = self if self.is_package(fullname): mod.__path__ = [] mod.__package__ = fullname else: mod.__package__ = fullname.rpartition('.')[0] src = self.get_source(fullname) try: exec src in mod.__dict__ except: del sys.modules[fullname] raise ImportError(fullname) finally: imp.release_lock() return mod #--------------------------------------------------------------------------- def is_package(self, fullname): """ True  fullname   """ return self.__modules_info[fullname]['ispackage'] #--------------------------------------------------------------------------- def get_source(self, fullname): """    fullname         base64 """ filename = self.__modules_info[fullname]['filename'] try: with file(filename, 'r') as ifile: src = base64.decodestring(ifile.read()) except IOError: src = '' return src #--------------------------------------------------------------------------- def __collect_modules_info(self, root_package_path): """       """ modules = {} p = os.path.abspath(root_package_path) dir_name = os.path.dirname(p) + os.sep for root, _, files in os.walk(p): #     filename = os.path.join(root, '__init__' + EXT) p_fullname = root.rpartition(dir_name)[2].replace(os.sep, '.') modules[p_fullname] = { 'filename': filename, 'ispackage': True } #       for f in files: if not f.endswith(EXT): continue filename = os.path.join(root, f) fullname = '.'.join([p_fullname, os.path.splitext(f)[0]]) modules[fullname] = { 'filename': filename, 'ispackage': False } return modules</span></span></code> </pre><br><br></div></div><br><br>  How it works?  First of all, when creating an instance of a class, information is collected about the modules of our library, which we ‚Äúencrypt‚Äù.  Then, when a specific module is loaded, the necessary ‚Äúencrypted‚Äù file is read, ‚Äúdecrypted‚Äù and imported using the <code>imp</code> module's means already from the ‚Äúdecrypted‚Äù text line.  How to use this class?  Very easy.  Literally, one line includes the ability to import the "encrypted" source code of our library, and in fact put a hook on the import: <br><br><pre> <code class="python hljs">sys.meta_path.append(Base64Importer(root_pkg_path))</code> </pre><br><br>  where <code>root_pkg_path</code> absolute or relative path to the root package of our library.  At the same time, removing this line, we can use the usual source code, if they are available.  Everything happens absolutely transparent, and all changes occur in one place. <br><br>  That's all, from this moment the import of modules from our library is carried out with interception and "decoding".  Our hook will twitch on any invocation of the import instruction, and if modules of our library are imported, the hook will process and load them, the rest of the imports will be processed as standard.  What we needed for more advanced obfuscation.  The presented code of the importer and the installation of the hook can be put in the * .pyd file and hope that no one will disassemble it in the hope of understanding that we are there.  In a real project, you can use real encryption, including using a hardware key, which should increase the reliability of this method.  Also, changing the file names and package structure can be useful for more obfuscation. <br><br><h4>  Conclusion </h4><br>  As a conclusion, I want to say that I am an opponent to hide the sources, which can not be simply taken and hidden.  In this case, I do not dare to discuss the ethical side of the issue and the usefulness / usefulness of hiding Python sources.  Here I just presented a method for how to do this and get some kind of result.  Naturally, this is not a panacea.  Python code is really impossible to hide completely and from everyone.  Module code can always be obtained using introspection by the built-in capabilities of the language after they are loaded, for example, from the variable <code>sys.modules</code> .  But this is not so obvious, as if the source code were open initially. <br><br>  It is possible that everything that is written here is not worth a jigger - long-known truths or the delirium of a madman.  But if the above described may be useful to someone, I will be glad.  For me personally, this experience was useful, if only because it allowed me to better understand the powerful and flexible system of loading and importing modules and the Importer Protocol.  About the very things that are often not required by developers to write programs in Python.  It is always interesting to learn something new. <br><br>  Thanks for attention. <br><br>  <b>UPD 08/14/2013</b> : <br>  At the request of <a href="https://habrahabr.ru/users/tangro/" class="user_link">tangro, he</a> made a minimal project that demonstrates the described method, but without real encryption (only some algorithms of reversible transformation were applied). <br>  Download the zip-archive by the <a href="">link</a> .  Need Python 2.7 x86 under Windows.  You need to run the script "test_main.py". <br><br>  UPD 2: <br>  And a more interesting example in which some calculations are made.  Here, all imports and function calls from encrypted modules are hidden in a binary module.  Download the archive by the <a href="">link</a> . </div><p>Source: <a href="https://habr.com/ru/post/189772/">https://habr.com/ru/post/189772/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../189746/index.html">Predict the future, or what will happen to the "law against the Internet"</a></li>
<li><a href="../189748/index.html">Emmet LiveStyle - a tool for convenient front-end development</a></li>
<li><a href="../189750/index.html">Pseudoscope, or what if you swap eyes</a></li>
<li><a href="../189764/index.html">Image Download Management</a></li>
<li><a href="../189766/index.html">Color theory in numbers</a></li>
<li><a href="../189778/index.html">Client Tests on Lettuce + Selenium</a></li>
<li><a href="../189782/index.html">JavaScript: how to smoke IE10, or migration problems</a></li>
<li><a href="../189784/index.html">Announcement: Introduction to the YotaPhone SDK for Developers</a></li>
<li><a href="../189786/index.html">"Multithreading" WSH VBScript</a></li>
<li><a href="../189788/index.html">The basis of AI - the structure of the mind</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>