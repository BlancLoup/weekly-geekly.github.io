<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Unraveling vulnerability on sites</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="After my first article published on codeby, which entered the top 3 publications of the week, I was very motivated to write the following. But the 11t...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Unraveling vulnerability on sites</h1><div class="post__text post__text-html js-mediator-article"><div style="text-align:center;"><img src="https://habrastorage.org/webt/op/nt/zy/opntzyfa45ep4f6dphmuztga1am.jpeg"></div><br>  After my first <a href="https://codeby.net/threads/vzlom-sajta-za-sps.65904">article</a> published on codeby, which entered the top 3 publications of the week, I was very motivated to write the following.  But the 11th class imposes restrictions on free time by preparing for the exams and olympiads.  Therefore, I write the second only after several months <s>having flown from all the Olympiads</s> . <br><br>  In this publication, an interesting case will be told, when a vulnerability found on one resource entailed finding them on several other sites along the chain. <br><a name="habracut"></a><br><h3>  Beginning </h3><br>  It all started with checking the site of one major manufacturer of forged products.  The user's personal account was not there, and the search area for vulnerabilities was not too extensive. <br><br>  When testing the order submission form, a number of vulnerabilities were discovered in it. <br>  First of all, this is a fairly standard stored XSS in the buyer's data, from which this tangle stretched.  XSS is standard, and the absence of the ‚Äúhttponly‚Äù flag on the cookie was clearly not standard.  Already many times I received cookies from various sites, but I have never received authorization, and already began to doubt that there are nature sites that do not use the ‚Äúhttponly‚Äù flag, because using it significantly reduces the risk of XSS attacks.  It was all the more surprising to find such an event on the website of a large company.  But, as it turned out, the service that made this misstep was much larger than I expected.  But more about that after. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      I substituted the received cookies and logged into the site system‚Äôs crm account (could not resist, for the first time so lucky).  The rights were not admin, but they were enough to access any statistics on orders, including  and customer data. <br><br><img src="https://habrastorage.org/webt/sq/wx/wx/sqwxwxuqyvlrpkdnoscc0pbv4ds.png"><br><br>  Made screenshots to prove the vulnerability and sent a report.  More than a week has passed and I have not waited for an answer.  According to statistics, if you do not respond within three days, you can forget about them.  But after 8 days, an unexpected answer came.  And even more, they were the first to pay me for the found vulnerability. <br><br><img src="https://habrastorage.org/webt/ob/rh/xh/obrhxhj_o-hjay2gz1unykm8-im.png"><br><br>  Returning to testing the order submission form, I found another iDOR vulnerability that allows changing the order price by editing the ‚Äújson_order [0] [price]‚Äù and ‚Äújson_order [0] [total]‚Äù parameters in the POST request domain.ru/shop.php .  Substituting a link to an order in the same request in the json_order [0] [href] field resulted in RFI. <br><br>  No response was received to the message about new discoveries ... <br><br><h3>  Continuation </h3><br>  At that site the crm system was not self-written, but was provided for payment by one well-known service.  After their mistake with the cookie, it was logical to assume that there would be other vulnerabilities there. <br><br>  If the script sent by me through the order form has worked, it means there was no field validation both on the sought site and in the crm system.  x2.  Therefore, having received a trial account, I began by searching for the fields vulnerable to xss. <br><br>  After long journeys through the extensive crm system, more than a dozen fields with insufficient validation were identified.  Somewhere you could directly insert the script tag, somewhere you had to use in-line scripts of the type "onmouseover = alert ()".  And in some places it was possible to embed the script, and in some not, I wonder what logic they were guided by, adding filtering to some places, but not to others?  From the point of view of the logical purpose of the fields, I did not see the patterns.  In some places where almost everything would not go, everything worked fine, and, for example, they did not bother to add filtering in the name of the counterparty. <br><br>  Most of the vulnerable fields could not be influenced "from the outside."  They could only be used by employees to enhance their rights in the system, which is also important. <br><br>  On this with xss it was over, it was possible to move on to more interesting things. <br><br>  Previously, I never looked for CSRF vulnerabilities, the sites I tested were not of the class against which phishing would be used.  Therefore, I did not want to kill with this head neither myself nor the site owners with vulnerabilities that would never be used against them.  This was a completely different case.  This crm system was popular, it was also used by large online stores, plus there was the ability to connect cash registers to offline retail outlets, which made the security issue even more important. <br><br>  Surprisingly, there was no protection against CSRF.  It was possible to send any requests, checks where they were not carried out. <br>  - Change account details?  - You are welcome <br>  - Change the name and price of the goods?  - No problem <br><br>  At the same time, the cookies contained something called ‚Äúcsrftoken‚Äù. <br><br>  Then I still thought, what's the point of putting a csrf token in a cookie?  Googling, I learned that there is a rather convenient way to protect against csrf with a token in cookies and duplicating it in a post request, which does not require to store the token on the server.  Read more <a href="https://habr.com/ru/post/318748/">here</a> . <br><br>  But in our case, only half of the work was done, the token was placed in the cookie, and it was absent in the requests to the server.  And even more, its complete removal from the cookies did not change anything.  Why was it added? <br><br>  In conjunction with the detected csrf, our xss, not previously accessible from the outside, get a second life.  We now do not need to get into the account to edit the vulnerable fields. <br><br>  In addition, through the substitution of the mime-type file, arbitrary files could be uploaded to the server.  But the server was configured correctly and php scripts were not executed there. <br><br>  Further more interesting.  All data about the goods online store took from crm.  Those.  name, description, photo.  The link to the product image looked like "yyyy.domain.ru/file/get/id=xxx".  In order for an online store to take images, they must have read rights for everyone.  122. <br><br>  Checking the ways in which other, more private files are stored, I saw the same url.  It seems, no wonder, they probably also have other access rights.  Not lower than 022 definitely.  But, the reality turned out to be slightly different, they also had free access for unauthorized users. <br><br>  - Have you made a request to import order data in an exel file?  - Great, now anyone can download it. <br><br>  Perhaps there id looked like "yt5bjFb54hb # HJ% $ p" and did not succumb to brute force?  Also no.  All id files had a number format and were in the range of several thousand.  I didn‚Äôt notice protection from brute either.  I tried all the id from 1 to 10,000 obstacles I did not meet.  Repeated several times, nobody was interested in such activity. <br><br>  Answered my report after 3 days. <br><br>  Regarding the absence of the flag httponly said that he was absent "Apparently for a long time, since the update version of php."  Included on the same day. <br><br>  By xss they said that they themselves all know, the filter was turned off at the beginning of summer (at that moment it was already August), this certainly does not explain why there was filtering somewhere, but not somewhere, but pretend that we didn‚Äôt notice this inconsistency.  Also assured that the filter will be launched in a couple of days.  In fact, it turned out that after a couple of months.  But, here I understand them perfectly: I, too, then planned to start preparing for exams in a couple of days ... <br><br>  Uploading arbitrary files to the server didn‚Äôt worry them much, because they aren‚Äôt executed on the server, so there‚Äôs nothing to worry about.  Only while writing the article I had an idea, if the site, which is already on a hosting other than crm, is trying to take an image of the product for the storefront, and receives a php script, will it execute it?  Or due to the fact that it is intended for the img tag, it will be processed only as an image?  Or does it depend on the server settings?  Please reply knowledgeable people. <br><br>  The response to the csrf message was quite interesting.  They answered with the question: ‚ÄúWhat do you consider token to protect against csrf attacks?‚Äù Indeed, what am I talking about? <br><br><img src="https://habrastorage.org/webt/yb/i9/kd/ybi9kdjzr9bkmx7hxozvmsup5ta.png"><br><br>  They said that they did not take into account this moment about free access to any files.  Shut down immediately. <br><br>  I must say that it was the only time when I really expected to receive a cash reward.  The site is large, except crm there is more than one paid project.  Popular online magazine.  But received only verbal gratitude. <br>  I must say thank you to them, it has become even quieter about the issue of payment.  Working for gratitude in any form will not lead to anything.  Over time, you will get used to any praises and other honors, and they will no longer bring satisfaction.  And if you did everything for them, then the meaning of something to do will be lost.  And you cannot lose the pleasure from the very process of your activity, solving new problems, creating something new.  Work for work, however banal it may sound.  Work during which you do not notice how the hours go by, how the sun managed not only to go beyond the horizon, but also to rise again because of it. <br><br>  '' ' <br>  Satisfied with small, happiness is not in big money <br>  ‚ÄúDo what you love‚Äù - valued in our circles <br>  '' '¬© Kolya Manyu - Everyday <br><br><h3>  nding </h3><br>  In technical support of the previous site, a third-party UserEcho ticket acceptance system was used.  I did not fail to check it.  In dreams, of course, it was possible to achieve the opportunity to read any private tickets.  This I, of course, failed.  I had to settle for little. <br><br><img src="https://habrastorage.org/webt/hv/p3/ws/hvp3wsbj374dcubvzwlma57tyas.png"><br><br>  When testing api working with tickets, no anomalies were initially noticed, the right not to look into someone else‚Äôs, not to subscribe to it was not possible.  But, upon further study of the site, it turned out that the developers did allow a small defect. <br>  In the profile it was possible to find a section on how to manage your tickets, it indicated those that you subscribed to or were previously subscribed to. <br><br><img src="https://habrastorage.org/webt/sb/qb/fo/sbqbfojkn8xdxdjc-pgm76w68g8.png"><br><br>  If we send a request to unsubscribe from someone else's ticket, we, as it should be, are informed that we do not have rights to this action.  But at the same time it is entered into our list of tickets, as one of those for which we were subscribed earlier.  In this way, we get the opportunity to find out its name and the url of the format ‚Äúnumber-nickname_kiteta_v_translit‚Äù.  It didn‚Äôt bear any harm, of course.  In very rare cases, it will be possible to learn something important and valuable from the title.  But it was better than nothing at all. <br><br>  A couple of weeks later the bug was fixed. <br><br>  I thank everyone who read to the end! </div><p>Source: <a href="https://habr.com/ru/post/445112/">https://habr.com/ru/post/445112/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../445100/index.html">Anycubic: Photon S, 4Max Pro and Great Renaming</a></li>
<li><a href="../445104/index.html">Brief history of the Klipsch audio brand</a></li>
<li><a href="../445106/index.html">Round table: Additive technologies as an alternative to traditional production</a></li>
<li><a href="../445108/index.html">Not a single Falcon - fundamentally different reusable projects by ESA and ULA</a></li>
<li><a href="../445110/index.html">Computer with terminal-style drive from Fallout</a></li>
<li><a href="../445114/index.html">Improved sandboxing for groovy scripts</a></li>
<li><a href="../445116/index.html">The US Air Force is working on a drone with elements of AI called Skyborg</a></li>
<li><a href="../445118/index.html">In the Telegram personal chat, you can delete any messages - even strangers (added voting result)</a></li>
<li><a href="../445122/index.html">The digest of fresh materials from the world of the frontend for the last week No. 357 (March 18 - 24, 2019)</a></li>
<li><a href="../445124/index.html">Moderate Hardening for Firefox</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>