<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Message broker for ZMQ-based service architecture - or developer‚Äôs leisure</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="A strong wind blew into the side of the ship. Small splashes and raindrops made the slightly unshaven face squint under the glasses. It was not just c...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Message broker for ZMQ-based service architecture - or developer‚Äôs leisure</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/files/e7f/ddb/3a9/e7fddb3a90d44fc6a9b619abcad706df.jpg"><br><br>  A strong wind blew into the side of the ship.  Small splashes and raindrops made the slightly unshaven face squint under the glasses.  It was not just cold: the cold penetrated everywhere.  Under the jacket, pants.  His hands were numb from him and the blood froze.  But the sailor knew that somewhere there behind the cape there is a quiet island where you can wait out bad weather. <br>  The shore was met by an exhausted crew with the noise of trees and the whisper of reeds.  People knew that they had only a day to rest, wash and continue the struggle with the elements. <br><br><a name="habracut"></a>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      But at this very moment of silence and unity with nature, devoid of tasks for survival, the brain of one of the participants, a programmer for life, began to look for problems with redoubled force.  It was the brain of the author and he gave birth to the idea ... <br><br><h1>  Foreword </h1><br><br>  Made just-for-fun in 5 days aboard a ship with an average speed of 7 knots. <br><br><h1>  Introduction </h1><br><br>  The professional happiness of a programmer is quite simple - to write interesting tasks in your favorite language and get paid for it (preferably not small, although there is always little money).  Such desires led to the birth of a whole approach in the form of stand-alone applications and the exchange process between them: <a href="https://ru.wikipedia.org/wiki/%25D0%25A1%25D0%25B5%25D1%2580%25D0%25B2%25D0%25B8%25D1%2581-%25D0%25BE%25D1%2580%25D0%25B8%25D0%25B5%25D0%25BD%25D1%2582%25D0%25B8%25D1%2580%25D0%25BE%25D0%25B2%25D0%25B0%25D0%25BD%25D0%25BD%25D0%25B0%25D1%258F_%25D0%25B0%25D1%2580%25D1%2585%25D0%25B8%25D1%2582%25D0%25B5%25D0%25BA%25D1%2582%25D1%2583%25D1%2580%25D0%25B0">SOA</a> (in particular, SOAP / WSDL / XML-RPC / JSON-RPC, etc.), REST, micro-service architecture.  The point is that following the precepts of Unix, a separate functionality is allocated to applications, and the data exchange between them is specified separately. <br>  One of my hobbies is related to the work of a distributed network of small modules: smart home, computing system and other similar tasks.  For communication between them, it is convenient to use a central message broker.  Typical solution: <a href="https://ru.wikipedia.org/wiki/RabbitMQ">RabbitMQ</a> , Redis, <a href="https://ru.wikipedia.org/wiki/Apache_ActiveMQ">ActiveMQ</a> and other similar solutions.  From the monsters of the industry can be noted <a href="https://ru.wikipedia.org/wiki/IBM_WebSphere_MQ">IBM Broker, IBM MQ</a> , <a href="https://en.wikipedia.org/wiki/TIBCO_Rendezvous">Tibco</a> . <br>  But I didn't like something about them. <br><br><h1>  "Fatal flaws" of existing solutions </h1><br><br><ul><li>  <b>Apache Active MQ and other Java-based brokers.</b>  At least 100MB at the start - anger takes even if there is 16GB of RAM.  I have nothing against Java, but still ... </li><li>  <b>IBM, Tibco and the rest.</b>  It would be so much money - would spend on something else. </li><li>  <b>Rabbit MQ, Redis</b> .  Perhaps the most correct option, but I'm on vacation, which means it is not our way. </li></ul><br>  The choice fell on our own implementation of a certain universal, fast, low-resource, simple protocol message router. <br><br><h1>  Components </h1><br><br>  Communication layer in the form of <a href="https://en.wikipedia.org/wiki/%25C3%2598MQ">ZeroMQ</a> for easy messaging. <br>  There are difficulties with programming language.  JVM-based, Python, Ruby dismissed because of virtual machines, and therefore excessive consumption of resources.  I wanted Rust, but after the start of implementation I realized that I had to wait for the further stabilization of the standard library.  Go - it would be great if there was a native zmq implementation.  As a result, C ++ / C. <br><br><h2>  Primary implementation </h2><br><br>  Broker consists of: <br><ul><li>  services - nominal clients (ZMQ_DEALER), working in response-to-request mode </li><li>  clients - anonymous clients (ZMQ_REQ), making a request to the service through a broker and waiting for a response. </li></ul><br><br>  The connection point to the broker is a socket of type ROUTER.  When receiving data from a socket REQ (from clients), a message is generated containing a unique client code.  Next, a package is created for the request to the service, consisting of the service name, customer number and other data.  Schematically, this can be represented as: <br><br><img src="https://habrastorage.org/files/996/86f/aef/99686faefe694a84938b0ed9aff5b2e7.png"><br><br>  The code can be viewed on <a href="https://github.com/reddec/waha/tree/master/broker">GitHub</a> . <br><br><h2>  Secondary implementation </h2><br><br>  The implementation seemed <i>very</i> simple.  It was necessary to invent and solve some more problems. <br><br><h3>  How to use multiple instances of services with the same name? </h3><br>  Valid for load balancing and fault tolerance. <br>  The fact is that if the same connection name is used in the DEALER-to-ROUTER mode, then only the last connection will be used. <br>  The solution is a separate load balancer for each service connecting to the broker and creating a separate connection point in the DEALER-to-DEALER mode.  In this case, for services, it is enough to change the connection address to the balancer instead of the broker. <br><br><div class="spoiler">  <b class="spoiler_title">Options</b> <div class="spoiler_text"><pre> USAGE: 

    waha-proxy-balance [-b &lt;zmq bind&gt;] [-v] -n &lt;name&gt; [-u &lt;zmq bind&gt;] [-]
                        [--version] [-h]


 Where: 

    -b &lt;zmq bind&gt;, --backend &lt;zmq bind&gt;
      Backend binding for proxy

    -v, --verbose
      Show much more output

    -n &lt;name&gt;, --name &lt;name&gt;
      (required) Balancing service name

    -u &lt;zmq bind&gt;, --url &lt;zmq bind&gt;
      Broker url

    -, --ignore_rest
      Ignores the rest of the labeled arguments following this flag.

    --version
      Displays version information and exits.

    -h, --help
      Displays usage information and exits.


    Broker balance module
</pre><br></div></div><br><br>  The code here is on <a href="https://github.com/reddec/waha/tree/master/proxy-balance">github</a> <br><br><h3>  How to provide access to services via HTTP? </h3><br><br>  Considering the massive love of the people for the HTTP interface, which, given the ability to work even through a smart toaster, is not without meaning, you need to do it right: json / plain output, support for both GET and POST requests, and JSONP for every fireman. <br>  With the help of <a href="https://ru.wikipedia.org/wiki/POCO">Poco</a> libraries, it turned out to be implemented as a separate daemon. <br><br><ul><li>  The args parameter in the GET request or the POST body must contain a JSON array. </li><li>  The optional timeout parameter is the maximum response time in ms. </li><li>  Optional parameter type - type of returned data - plain or json </li><li>  Optional jsonp or callaback parameter - function name for JSON-P request </li></ul><br><br><div class="spoiler">  <b class="spoiler_title">Options</b> <div class="spoiler_text"><pre> USAGE: 

    waha-proxy-http [-t &lt;ms&gt;] [--threads &lt;int&gt;] [-p &lt;int&gt;] [-v] [-u &lt;zmq
                     bind&gt;] [-] [--version] [-h]


 Where: 

    -t &lt;ms&gt;, --timeout &lt;ms&gt;
      Request timeout without `timeout` param.  -1 - infinity

    --threads &lt;int&gt;
      HTTP max threads

    -p &lt;int&gt;, --port &lt;int&gt;
      HTTP binding port

    -v, --verbose
      Show much more output

    -u &lt;zmq bind&gt;, --url &lt;zmq bind&gt;
      Broker url

    -, --ignore_rest
      Ignores the rest of the labeled arguments following this flag.

    --version
      Displays version information and exits.

    -h, --help
      Displays usage information and exits.


    Broker HTTP proxy (REST like) module
</pre><br></div></div><br><br>  The code here is on <a href="http">github</a> <br><br><div class="spoiler">  <b class="spoiler_title">Why poco?</b> <div class="spoiler_text">  Why not boost / libevent or something?  Because Poco is a very thin wrapper over system calls, without too much overweight, is collected with minimal effort and excellent documentation.  And it just is much clearer to me than the boost. <br></div></div><br><br><h3>  How to make a good administrator and just a person who is reluctant to program? </h3><br><br>  We make a daemon that calls any other program, sends the message fields to it as arguments and interprets the output as an answer.  Simplified such a CGI. <br><br><div class="spoiler">  <b class="spoiler_title">Options</b> <div class="spoiler_text"><pre> USAGE: 

    waha-service-script [-s &lt;script&gt;] [--no-stdout] [-e] [-r] -n &lt;name&gt;
                         [-v] [-u &lt;zmq bind&gt;] [-] [--version] [-h] &lt;string&gt;
                         ...


 Where: 

    -s &lt;script&gt;, --script &lt;script&gt;
      Script path for 'script' mode

    --no-stdout
      Do not use stdout as message

    -e, --stderr
      Append script stderr output

    -r, --ret-code
      Append script return code as last field in message

    -n &lt;name&gt;, --name &lt;name&gt;
      (required) Balancing service name

    -v, --verbose
      Show much more output

    -u &lt;zmq bind&gt;, --url &lt;zmq bind&gt;
      Broker url

    -, --ignore_rest
      Ignores the rest of the labeled arguments following this flag.

    --version
      Displays version information and exits.

    -h, --help
      Displays usage information and exits.

    &lt;string&gt; (accepted multiple times)
      Predefined args for script


    Broker script service
</pre><br></div></div><br><br>  The code here is on <a href="https://github.com/reddec/waha/tree/master/service-script">github</a> <br><br><h3>  How to do even better? </h3><br><br>  Make access to all services through the console.  With plain / hex / base64 / json input and output. <br><br><div class="spoiler">  <b class="spoiler_title">Options</b> <div class="spoiler_text"><pre> USAGE: 

    waha-cli [-t &lt;ms&gt;] -n &lt;name&gt; [-v] [-u &lt;zmq bind&gt;] [-p] [-e &lt;plain
              | base64 | hex&gt;] [--out-sep &lt;char&gt;] [-o &lt;empty | plain | delimited
              | json&gt;] [-d &lt;plain | base64 | hex&gt;] [--in-sep &lt;char&gt;] [-i &lt;args
              | plain | delimited | json&gt;] [-] [--version] [-h] &lt;string&gt; ...


 Where: 

    -t &lt;ms&gt;, --timeout &lt;ms&gt;
      Request timeout.  -1 - infinity

    -n &lt;name&gt;, --name &lt;name&gt;
      (required) Remote service name

    -v, --verbose
      Show much more output

    -u &lt;zmq bind&gt;, --url &lt;zmq bind&gt;
      Broker url

    -p, --pretty
      Pretty JSON output for 'json'

    -e &lt;plain | base64 | hex&gt;, --encoder &lt;plain | base64 | hex&gt;
      Output encoder for 'delimited' output

    --out-sep &lt;char&gt;
      Output separator

    -o &lt;empty | plain | delimited | json&gt;, --output &lt;empty | plain | delimited | json&gt;
      Output mode in CLI mode

    -d &lt;plain | base64 | hex&gt;, --decoder &lt;plain | base64 | hex&gt;
      Input decoder for 'delimited' input

    --in-sep &lt;char&gt;
      Input separator

    -i &lt;args | plain | delimited | json&gt;, --input &lt;args | plain | delimited | json&gt;
      Input mode in CLI mode

    -, --ignore_rest
      Ignores the rest of the labeled arguments following this flag.

    --version
      Displays version information and exits.

    -h, --help
      Displays usage information and exits.

    &lt;string&gt; (accepted multiple times)
      Args in request message for for 'args' input


    ZMQ broker console client interface

</pre><br></div></div><br><br>  The code here is <a href="https://github.com/reddec/waha/tree/master/cli">github</a> <br><br><h1>  Build everything </h1><br><br>  GIT + CMake + make <br><br><pre> git clone https://github.com/reddec/waha.git &amp;&amp; cd waha &amp;&amp; mkdir build &amp;&amp; cd build
 cmake ../ -DCMAKE_BUILD_TYPE = Release
 make &amp;&amp; make package
</pre><br><br>  The Debian package will be in waha - *. Deb, for the rest of waha - *. Zip <br><br><h1>  Usage example </h1><br><br><h4>  Authorization of users with a large read load and a small write. </h4><br><br>  Run broker (default port is 10000) <br><pre> $ waha-broker
</pre><br><br>  Run balancer for reading (port 10001 by default) <br><pre> $ waha-proxy-balance -n system.user.check
</pre><br><br>  Run httpasswd to check login / password (run as many times as you want to distribute the load).  Displays only the exit code.  Everything that comes after - is passed as arguments to the script. <br><pre> $ waha-service-script -u tcp: //127.0.0.1: 10001 -n system.user.check -s htpasswd --ret-code --no-stdout - -bv users.passwd
</pre><br><br>  Run the script to add users (without balancing) along with the output <br><pre> $ waha-service-script -n system.user.add -s htpasswd --ret-code --stderr - -b users.passwd
</pre><br><br>  Starting the HTTP interface (default port 9001) <br><br><pre> $ waha-proxy-http
</pre><br><br>  sample request <br><br><pre> http://127.0.0.1:9001/system.user.check?args=["admin","admin "]
 http://127.0.0.1:9001/system.user.check?args=["admin","admin""&amp;callback=func123
</pre><br><br><h4>  Using the command interface </h4><br><br>  Output without formatting: <pre>  $ waha-cli -n system.user.check admin admin </pre><br>  JSON output: <pre>  $ waha-cli -o json -n system.user.check admin admin </pre><br><br><h1>  Total </h1><br><br>  Modular, working message broker, written during a vacation for recreation and entertainment by a programmer just for fun.  So that the code does not disappear, put it in public access. <br>  If anyone needs this - please consult. </div><p>Source: <a href="https://habr.com/ru/post/262977/">https://habr.com/ru/post/262977/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../262957/index.html">The magic of tensor algebra: Part 10 - Get the angular velocity vector. We work on the shortcomings</a></li>
<li><a href="../262963/index.html">Emmett Shire: How to conduct interviews with users</a></li>
<li><a href="../262967/index.html">As we built the constructor of Telegram bots in 24 hours, and then threw half of them and rewrote</a></li>
<li><a href="../262969/index.html">Results of the Summer Hola JS Programming Contest</a></li>
<li><a href="../262971/index.html">Thinking about error handling</a></li>
<li><a href="../262979/index.html">The subtleties of working with PassportJs</a></li>
<li><a href="../262983/index.html">Personal web server on Wolfram Language</a></li>
<li><a href="../262987/index.html">Adding bidirectional support to your own Textbox</a></li>
<li><a href="../262991/index.html">Using morph.io for web parsing</a></li>
<li><a href="../262993/index.html">The digest of interesting materials for the mobile # 112 developer (on July 13-19)</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>