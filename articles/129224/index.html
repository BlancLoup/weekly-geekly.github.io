<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Sending important messages from VKontakte by email</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Good day! 
 Surely, many were faced with the situation that important information (news, announcements, etc.) is published by VKontakte. But firstly, ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Sending important messages from VKontakte by email</h1><div class="post__text post__text-html js-mediator-article">  Good day! <br>  Surely, many were faced with the situation that important information (news, announcements, etc.) is published by VKontakte.  But firstly, it is not always possible to get there (generally it‚Äôs indecent to sit on VKontakte during working hours), and secondly, you have to receive information by polling, that is, constantly updating the group page or something similar. <br>  From here a wonderful thought was born - it would be convenient for important notifications to arrive in the mail.  And at work you can look and <s>convulsively press F5</s> is not constantly updated.  As it turned out, using python you can easily cope with such a task. <br><a name="habracut"></a><br><h4>  Attempt # 1: VK API </h4><br>  For starters, I tried to be honest and use VK API.  On the net, I even managed to find a couple of libraries that knew how to log in and perform functions from the API.  Unfortunately, none of them did not suit me, so I managed to build my bike in a couple of hours.  Okay, it's done, but then I came across an unpleasant moment, namely, using the current version of the API, it is not possible to get messages from the group wall (or I did not find how to do it, which is also likely).  There is only one option - to parse the VK pages independently.  On the one hand, this is not very legal, on the other hand, this approach makes it possible to obtain any information that I can see directly in the browser. <br><br><h4>  Attempt # 2: parsing the page directly! </h4><br><h5>  Login to the site </h5><br>  First of all, I tried using <i>httplib</i> and <i>urllib</i> to get the login page.  Everything is wonderful and beautiful.  It just turned out that I would have to write a lot of ugly code, and even work with cookies ... And somehow it saddened me very much.  I started looking for a replacement.  And I found a wonderful <a href="http://wwwsearch.sourceforge.net/mechanize/">mechanize</a> library, which did a wonderful job for me all the uninteresting work on creating connections, processing sessions and cookies, etc ... <br>  So, with the help of mechanize we get the main page of VKontakte: <br><pre><code class="python hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">initVK</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-comment"><span class="hljs-comment"># Browser br = mechanize.Browser() # Cookie Jar cj = cookielib.LWPCookieJar() br.set_cookiejar(cj) # Browser options br.set_handle_equiv(True) br.set_handle_gzip(True) br.set_handle_redirect(True) br.set_handle_referer(True) br.set_handle_robots(False) # Follows refresh 0 but not hangs on refresh &gt; 0 br.set_handle_refresh(mechanize._http.HTTPRefreshProcessor(), max_time=1) # Little cheating... br.addheaders = [('User-agent', 'Mozilla/5.0 (X11; U; Linux i686; en-US; rv:1.9.0.1) Gecko/2008071615 Fedora/3.0.1-1.fc9 Firefox/3.0.1')] br.open('http://vkontakte.ru') br.select_form(nr=0) br.form['email'] = EMAIL br.form['pass'] = PASSWORD br.submit() return br</span></span></code> </pre> <br>  As an explanation, I will say that on vkontakte.ru the first form is the login form.  With the help of mechanize fill it and voila, we logged on to the site! <br><h5>  We receive important messages from the wall </h5><br>  The following code will allow us to get a group page: <br><pre> <code class="python hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getGroupHTML</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(br)</span></span></span><span class="hljs-function">:</span></span> br.open(<span class="hljs-string"><span class="hljs-string">'http://vkontakte.ru/OUR_GROUP'</span></span>) html = br.response().read() <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> html</code> </pre><br>  Now we will directly parse the received html-code, in order to find the necessary messages in it. <br>  For this we need the <a href="http://docs.python.org/library/htmlparser.html">HTMLParser</a> library.  Let's create our own parser class, which will be inherited from HTMLParser. <br>  For simplicity, we will look for messages that start with some kind of pattern (in my script I used '@ year2007'). <br><pre> <code class="python hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">MyHTMLParser</span></span></span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">(HTMLParser)</span></span></span><span class="hljs-class">:</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">__init__</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self)</span></span></span><span class="hljs-function">:</span></span> HTMLParser.__init__(self) self.recording = <span class="hljs-keyword"><span class="hljs-keyword">False</span></span> self.export_tag = <span class="hljs-keyword"><span class="hljs-keyword">False</span></span> self.message = unicode(<span class="hljs-string"><span class="hljs-string">''</span></span>) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">handle_starttag</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self, tag, attrs)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> tag == <span class="hljs-string"><span class="hljs-string">'div'</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> name, value <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> attrs: <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> name == <span class="hljs-string"><span class="hljs-string">'class'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> value == <span class="hljs-string"><span class="hljs-string">'wall_text'</span></span>: self.export_tag = <span class="hljs-keyword"><span class="hljs-keyword">True</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> name == <span class="hljs-string"><span class="hljs-string">'class'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> value == <span class="hljs-string"><span class="hljs-string">'wall_post_text'</span></span>: self.recording = <span class="hljs-keyword"><span class="hljs-keyword">True</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">handle_endtag</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self, tag)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> tag == <span class="hljs-string"><span class="hljs-string">'div'</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> self.recording: self.recording = <span class="hljs-keyword"><span class="hljs-keyword">False</span></span> year = re.compile(PATTERN) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> year.match(self.message): message_queue.append(year.sub(<span class="hljs-string"><span class="hljs-string">''</span></span>, self.message).strip()) self.message = unicode(<span class="hljs-string"><span class="hljs-string">''</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> self.export_tag: self.export_tag = <span class="hljs-keyword"><span class="hljs-keyword">False</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">handle_data</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self, data)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> self.recording: self.message += unicode(data, <span class="hljs-string"><span class="hljs-string">'CP1251'</span></span>)</code> </pre><br>  All text comes in CP1251, translate it to unicode.  Layers with the wall_text classes are responsible for the messages, wall_post_text - for the message text itself. <br><br>  Now the code for receiving messages can be wrapped in an infinite loop.  In order not to send messages to the mail every pass, you can arrange a message queue or try to parse the time.  For simplicity, let's make a queue. <br>  It is also worth noting that there may be other tags in the text, for example, links.  They can also be processed by cutting out unfortunate away.php.  But these are details. <br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> codecs message_queue = [] <span class="hljs-keyword"><span class="hljs-keyword">try</span></span>: f = codecs.open(<span class="hljs-string"><span class="hljs-string">'/tmp/vk-last-message'</span></span>, <span class="hljs-string"><span class="hljs-string">'r'</span></span>, encoding=<span class="hljs-string"><span class="hljs-string">'utf-8'</span></span>) last_message = f.read() f.close() <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> len(last_message.strip()) == <span class="hljs-number"><span class="hljs-number">0</span></span> : last_message = PATTERN <span class="hljs-keyword"><span class="hljs-keyword">except</span></span>: last_message = PATTERN <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> time browser = initVK() <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> mymail <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> <span class="hljs-keyword"><span class="hljs-keyword">True</span></span>: <span class="hljs-comment"><span class="hljs-comment">#print "Getting vk.com pages" html = getGroupHTML(browser) p = MyHTMLParser() p.feed(html) #print message_queue msgSent = 0 for msg in message_queue: if msg == last_message : break #messageForSend = processMsg(msg) print msg mymail.sendMessage(msg) msgSent += 1 if len(message_queue) &gt; 0 and msgSent &gt; 0 and len(last_message.strip()) &gt; 0: last_message = message_queue[0] f = codecs.open('/tmp/vk-last-message', 'w', encoding='utf-8') f.write(last_message) f.close() #print "last message: " + last_message message_queue = [] #print "Sleeping..." time.sleep(60)</span></span></code> </pre><br><h5>  Sending a message to the mail </h5><br>  Now reveal the mystery of the module mymail. <br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> smtplib <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> email.mime.multipart <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> MIMEMultipart <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> email.mime.text <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> MIMEText <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">sendMessage</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(text)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> len(text) == <span class="hljs-number"><span class="hljs-number">0</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">print</span></span> <span class="hljs-string"><span class="hljs-string">"Empty message"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> fromaddr = FROM_ADDR toaddrs = LIST_OF_RECEPIENTS <span class="hljs-comment"><span class="hljs-comment">#text = 'test message' msg = MIMEMultipart('alternative') msg['Subject'] = "year2007@vkontakte" msg['From'] = fromaddr msg['To'] = toaddrs mime_text = MIMEText(text, 'plain', 'utf-8') msg.attach(mime_text) # Credentials (if needed) username = USER password = PASSWD # The actual mail send server = smtplib.SMTP('SMTP_SERVER:SMTP_PORT') server.starttls() server.login(username,password) server.sendmail(fromaddr, toaddrs, msg.as_string()) server.quit()</span></span></code> </pre><br>  The simplest code to send messages.  I used the smtp server of Yandex: smtp.yandex.ru en87.  The list of recipients can be read from the config or zhardkodit one mailing address, as it was in my case. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h4>  What happened in the end </h4><br>  At the exit we have: <br><ol><li>  important messages come to us in the mail, that is, you do not need to go to VKontakte and update the page yourself </li><li>  experience parsing pages </li><li>  self satisfaction and pride </li></ol><br>  It is worth saying that this code is the basis, you can draw a lot of things on it.  For example, for GUI lovers, you can make a login and password entry box.  You can also parse messages by the author's name (for example, send all messages on behalf of a group), process tags within messages, and so on, so forth. <br>  Experience shows that you should not overstate the page refresh rate, anyway, all messages will be received, and for excessive activity they can punish a temporary ban. <br><br>  That's all.  Thanks for attention! <br><br>  UPD.  Transferred from VKontakte to Python. </div><p>Source: <a href="https://habr.com/ru/post/129224/">https://habr.com/ru/post/129224/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../129212/index.html">What markup is better to use for a content resource?</a></li>
<li><a href="../129217/index.html">What quotes do you use in your code?</a></li>
<li><a href="../129218/index.html">All serious</a></li>
<li><a href="../129219/index.html">Shopping Cart engines. How many of them? And how to find your own?</a></li>
<li><a href="../129221/index.html">MySQL.com hacked and sold for $ 3000</a></li>
<li><a href="../129225/index.html">2 minutes with Bill</a></li>
<li><a href="../129228/index.html">There are already 43 million users on Google+</a></li>
<li><a href="../129229/index.html">Prices for PlayBook tablets reduced by 100-200 dollars</a></li>
<li><a href="../129231/index.html">3D technologies of the future: Sony's Personal 3D Viewer HMZ-T1</a></li>
<li><a href="../129232/index.html">The unique scheme of hacking mobile phones in Russia - how it worked</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>