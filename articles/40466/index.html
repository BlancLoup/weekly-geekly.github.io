<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>We write our first Windows driver</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="So, after my previous article, I realized that the topic of Windows driver programming is interesting for habrovans, so I‚Äôll continue. In this article...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>We write our first Windows driver</h1><div class="post__text post__text-html js-mediator-article">  So, after my <a href="http://habrahabr.ru/blogs/system_programming/40171/">previous article,</a> I realized that the topic of Windows driver programming is interesting for habrovans, so I‚Äôll continue.  In this article, I decided to parse a simple driver program that only does what the debugging message ‚ÄúHello world!‚Äù Writes when the driver starts and ‚ÄúGoodbye!‚Äù At the end, and also describe those development tools that we will need to build and run the driver. <br><br><a name="habracut"></a><br><br>  So, for starters we give the text of this simple program. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <blockquote><ol><li>  <font color="#008000">// TestDriver.c</font> </li><li></li><li>  #include &lt;ntddk.h&gt; </li><li></li><li>  NTSTATUS DriverEntry (IN PDRIVER_OBJECT DriverObject, IN PUNICODE_STRING RegistryPath); </li><li>  VOID UnloadRoutine (IN PDRIVER_OBJECT DriverObject); </li><li></li><li>  <font color="#0000ff">#pragma</font> alloc_text (INIT, DriverEntry) </li><li>  <font color="#0000ff">#pragma</font> alloc_text (PAGE, UnloadRoutine) </li><li></li><li>  NTSTATUS DriverEntry (IN PDRIVER_OBJECT DriverObject, IN PUNICODE_STRING RegistryPath) </li><li>  { </li><li>  DriverObject-&gt; DriverUnload = UnloadRoutine; </li><li></li><li>  DbgPrint ( <font color="#A31515">"Hello world! \ N"</font> ); </li><li></li><li>  <font color="#0000ff">return</font> STATUS_SUCCESS; </li><li>  } </li><li></li><li>  VOID UnloadRoutine (IN PDRIVER_OBJECT DriverObject) </li><li>  { </li><li>  DbgPrint ( <font color="#A31515">"Goodbye! \ N"</font> ); </li><li>  } </li></ol>  <font color="gray">* This source code was highlighted with <a href="http://source.virtser.net/"><font color="gray">Source Code Highlighter</font></a> .</font> </blockquote><br><br>  So, now we first understand what each instruction does.  First of all, we include the header file <b>ntddk.h</b> .  This is one of the basic include files in all drivers: it contains the <b>NTSTATUS, PDRIVER_OBJECT, PUNICODE_STRING type declarations</b> , and the <b>DbgPrint</b> functions. <br><br>  Next comes the declaration of two functions: <b>DriverEntry</b> and <b>UnloadRoutine</b> .  I will tell about the first in more detail.  So, as dear readers know, every program has an entry point, in C programs this is a function of <b>main</b> or <b>WinMain</b> .  In the driver, the role of the entry point is performed by the <b>DriverEntry</b> function, which receives a pointer to the <b>DriverObject</b> structure as well as a pointer to the registry string corresponding to the driver being loaded. <br><br>  The <b>DriverObject</b> structure contains many fields that define the behavior of a future driver.  The most key of them are pointers to so-called called (or callback) functions, that is, functions that will be called when a certain event occurs.  We define one of these functions: this is the <b>UnloadRoutine</b> function.  A pointer to this function is placed in the field <b>DriverUnload</b> .  Thus, when the driver is unloaded, the <b>UnloadRoutine</b> function will first be called.  This is very convenient when the driver has some temporary data that should be cleared before shutting down.  In our example, this function is needed only to track the fact that the driver has been terminated. <br><br>  In order to display debugging messages, we use the <b>DbgPrint</b> function, which has a syntax similar to the <b>printf</b> function from the user mode (userspace). <br><br>  In this simple example, we also used the directives <b>#pragma alloc_text (INIT, DriverEntry)</b> and <b>#pragma alloc_text (PAGE, UnloadRoutine)</b> .  Let me explain what they mean: the first places the <b>DriverEntry</b> function in the <b>INIT</b> section, that is, it says that <b>DriverEntry</b> will be executed once and after that the function code can be safely unloaded from memory.  The second marks the <b>UnloadRoutine</b> function <b>code</b> as unloaded, i.e.  if necessary, the system can move it to the paging file, and then take it from there. <br><br>  You may think, well, the first directive is understandable, such as optimization and all that, but why do we use the second directive, why should we mark the code as possible to be downloaded to the paging file?  Let me clarify this question: each process in the system has such a parameter as <b>IRQL</b> (read more at <a href="http://ext2fsd.sourceforge.net/documents/irql.htm">Interrupt request level</a> for this is the material of a separate article), that is, some parameter responsible for the ability to interrupt the process: the higher the <b>IRQL</b> the less chance of interrupting the process.  The capabilities of the process also depend on the <b>IRQL</b> : the higher the <b>IRQL</b> the less the possibilities of the process, this is quite logical, i.e.  This approach encourages developers to perform only the most necessary operations with a high <b>IRQL</b> , and all other actions to do at a low.  Let us return to the main topic, about why we make <b>it</b> possible for the <b>UnloadRoutine</b> function to upload to the paging file: everything again boils down to optimization: working with the paging file is not available with a high <b>IRQL</b> , and the driver unloading procedure is guaranteed to be performed with a low <b>IRQL</b> , so we specifically specify Hands that the code of the function of unloading the driver can be placed in a swap. <br><br>  Wow, it seems that the discussion of the code of this seemingly small program is over, now let's figure out how to compile and run our driver. <br><br>  For this we need: <br><ul><li>  WDK or DDK </li><li>  Text editor </li><li>  DbgView is a free program for viewing debug messages received from drivers; it can be found on the <a href="http://www.sysinternals.com/">sysinternals</a> website <a href="http://www.sysinternals.com/">.</a> </li><li>  The KmdManager program is a free program for registering, running and testing a driver, it can be found on the site <a href="http://www.wasm.ru/">wasm.ru</a> </li></ul><br><br>  Now the sequence of actions: first we write two files, one is called <b>MAKEFILE</b> , with such content <br><br> <code>################################################## <br> # DO NOT EDIT THIS FILE!!! Edit .\sources. if you want to add a new source <br> # file to this component. This file merely indirects to the real make file <br> # that is shared by all the driver components of the Windows NT DDK <br> # <br> <br> !INCLUDE $(NTMAKEENV)\makefile.def <br> ################################################## <br></code> <br><br>  and the second is called <b>sources</b> and contains the following: <br><br> <code>################################################## <br> TARGETNAME=TestDriver <br> TARGETTYPE=DRIVER <br> <br> SOURCES=TestDriver.c <br> ################################################## <br></code> <br><br>  These files are needed to build the driver.  Yes, I forgot to say that the <b>WDK</b> does not have a built-in development environment, so you need a text editor to type the text of the drivers.  For this purpose, you can use both Visual Studio (some even integrate the ability to build drivers from VS), and any other text editor. <br><br>  Save the driver code to the <b>TestDriver.c</b> file and put it in the same directory as the <b>MAKEFILE</b> and <b>souces files</b> .  After that, run the installed <b>build environment</b> (this is a command line with the given environment variables for compiling the driver; it is included in the WDK, and you can start it like this: ‚ÄúStart-&gt; Programs-&gt; Windows Driver Kits-&gt; ....-&gt; Build Environments-&gt; WindowsXP-&gt; Windows XP x86 Checked Build Environment ‚Äù).  Go to the directory where we put the driver file (I have C: \ Drivers \ TestDriver) using the <b>cd command</b> (my command looks like this: cd C: \ Drivers \ TestDriver) and type the <b>build</b> command. <br><br>  This command will <b>assemble</b> us the <b>TestDriver.sys</b> driver and put it in the ‚Äúobjchk_wxp_x86 \ i386‚Äù folder. <br><br>  Now we need to run the <b>DbgView</b> program to see the messages that the driver will issue.  After starting this program, we need to specify that we want to view messages from the kernel (Capture-&gt; Capture Kernel). <br><br>  Now we start the KmdManager program, specify the path to our driver (file TestDriver.sys), press the Register button, then the Run button.  Now the driver is registered in the system and running.  In the DbgView program, we should see our ‚ÄúHello World!‚Äù Message.  Now we finish the driver operation with the Stop button and remove the driver registration with the Unregister button.  By the way, one more line should appear in DbgView. <br><br>  So, what we have achieved: we wrote, compiled and launched our first Windows driver!  I will only add that when writing complex drivers for debugging, a two-machine configuration is used, when on one computer the driver is being written, and on the other - launching and testing.  This is done because an incorrectly written driver can crash the entire system, and there can be a lot of valuable data on it.  Often a virtual machine is used as the second computer. <br><br></div><p>Source: <a href="https://habr.com/ru/post/40466/">https://habr.com/ru/post/40466/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../40462/index.html">Version Control Audit, Part I</a></li>
<li><a href="../40463/index.html">The second wiki conference will be held in Moscow on October 18-19</a></li>
<li><a href="../40464/index.html">jQuery UI 1.6rc2</a></li>
<li><a href="../40465/index.html">Solving the problem with Russian characters in the URL</a></li>
<li><a href="../404651/index.html">The tariff did its job, or why operators go to defend the rejection of no-limit</a></li>
<li><a href="../40467/index.html">Twitter updated design</a></li>
<li><a href="../40468/index.html">Replacing standard select using Mootools</a></li>
<li><a href="../404693/index.html">Is it possible to go against your age</a></li>
<li><a href="../404695/index.html">[CASE] As we typed a giant machine gun from Mars for a stand at E3</a></li>
<li><a href="../40472/index.html">Live</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>