<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>wTorrent'a modding</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hello, gentlemen. 
 Preamble: 
 A week ago, I bought myself a cheap PC to organize a local file server, router, rocking chair and other convenient ser...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>wTorrent'a modding</h1><div class="post__text post__text-html js-mediator-article"> Hello, gentlemen. <br>  Preamble: <br>  A week ago, I bought myself a cheap PC to organize a local file server, router, rocking chair and other convenient services that I was tired of keeping on the desktop machine.  The whole thing revolves under gentoo. <br><br>  Ambula: <br>  Today I spent the evening and a little undertmodted <a href="http://www.wtorrent-project.org/">wTorrent</a> : <br>  Now it looks like this: <a href=""><img src="http://img21.imageshack.us/img21/122/wtorrent2eb6.th.png"></a> <br><br>  From the innovations: <br>  1. Now it shows the total amount of traffic, in / out. <br>  2. Presented in the center of the page graph of incoming / outgoing traffic. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Consider the first point.  Its implementation is simple: <br>  Add rules to the rtorrent scheduler.  This is done via ctrl + x in the client or by adding a line to the config and restarting. <br>  schedule = export_traffic, 0.15, "execute = / var / www / localhost / htdocs / wtorrent / schedule / passthrough, $ get_up_total =, $ get_down_total =, / var / www / localhost / htdocs / wtorrent / schedule / traffic.rtorrent " <br>  this rule is every 15 seconds in the traffic.rtorrent file through a small passthrough script <br> <code>#!/bin/sh <br> echo $1 $2 &gt; $3 <br></code> <br>  will write 2 numbers: outgoing and incoming traffic.  This is done because a signed integer is given through xmlrpc, which, with a traffic volume of&gt; 2GB, is expected to go into the negative range :-) I could not find how to teach him to give large numbers - so I had to make such a crutch. <br><br>  Now in rtorrent.cls.php add the following three methods: <br> <code>private function getTrafficInfo() <br> { <br> static $data; <br> <br> if (!$data){ <br> if (is_file('./schedule/traffic.rtorrent')) { <br> $data = file('./schedule/traffic.rtorrent'); <br> $data = explode(' ', $data[0]); <br> } else { <br> $data = array(0, 0); <br> } <br> } <br> <br> return $data; <br> } <br> <br> public function getDownTotal() <br> { <br> if ($data = $this-&gt;getTrafficInfo()) { <br> return $this-&gt;getCorrectUnits($data[1]); <br> } <br> <br> return $this-&gt;getCorrectUnits($this-&gt;get_info_rtorrent('get_down_total', false, false)); <br> } <br> <br> public function getUpTotal() <br> { <br> if ($data = $this-&gt;getTrafficInfo()) { <br> return $this-&gt;getCorrectUnits($data[0]); <br> } <br> <br> return $this-&gt;getCorrectUnits($this-&gt;get_info_rtorrent('get_up_total', false, false)); <br> } <br></code> <br>  which simply extract the numbers exported by the torrent client from the file.  Now in the menu.tpl.php template we just show these two numbers: <br> <code>{$str.dw_rate} {$web-&gt;getDownload()} ({$web-&gt;getDownTotal()}) <br> {$str.up_rate} {$web-&gt;getUpload()} ({$web-&gt;getUpTotal()}) <br></code> <br>  adding them to the brackets after the blocks at the current speed. <br><br>  The task of drawing graphics is a little more complicated. <br>  To implement it, we add another rule to the scheduler: <br>  schedule = import_traffic, 0.60, "execute = / usr / bin / php, -f, / var / www / localhost / htdocs / wtorrent / schedule / bandwidth.php" <br>  this rule runs a php script every minute: <br> <code>&lt;?php <br> <br> chdir(dirname(__FILE__)); <br> <br> $datafile = './traffic.rtorrent'; <br> <br> if (is_file($datafile)) { <br> $data = file($datafile); <br> list($out, $in) = explode(' ', $data[0]); <br> <br> $out = (double)$out; <br> $in = (double)$in; <br> <br> require_once '../conf/user.conf.php'; <br> <br> $db = new PDO(DB_STAT_DSN, DB_STAT_LOGIN, DB_STAT_PWD); <br> <br> $qry = 'SELECT `in`, `out`, `time` FROM `bandwidth` ORDER BY `id` DESC LIMIT 1'; <br> $stmt = $db-&gt;query($qry); <br> <br> $delta_in = 0; <br> $delta_out = 0; <br> <br> if ($row = $stmt-&gt;fetch()) { <br> if ($in &gt;= $row['in'] &amp;&amp; $out &gt;= $row['out']) { <br> $delta_in = $in - $row['in']; <br> $delta_out = $out - $row['out']; <br> } <br> } <br> <br> $db-&gt;query('INSERT INTO `bandwidth` (`in`, `delta_in`, `out`, `delta_out`, `period`) VALUES (' . $in . ', ' . $delta_in . ', ' . $out . ', ' . $delta_out . ", TIME_TO_SEC(TIMEDIFF(NOW(), '" . $row['time'] . "')))"); <br> } <br> <br> ?&gt;</code> <br> <br>  This primitive script compares the current traffic values ‚Äã‚Äãin the traffic.torrent file and, based on this data, writes the current values ‚Äã‚Äãand the difference to the previous ones in the database. <br><br>  Here is the database schema and the table in which the script writes the data: <br> <code>CREATE DATABASE `rtorrent` <br> CHARACTER SET 'utf8' <br> COLLATE 'utf8_general_ci'; <br> <br> CREATE TABLE `bandwidth` ( <br> `id` BIGINT(20) UNSIGNED NOT NULL AUTO_INCREMENT, <br> `in` BIGINT(20) DEFAULT NULL, <br> `delta_in` BIGINT(20) DEFAULT NULL, <br> `out` BIGINT(20) DEFAULT NULL, <br> `delta_out` BIGINT(20) DEFAULT NULL, <br> `time` TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP, <br> `period` INTEGER(11) DEFAULT NULL, <br> PRIMARY KEY (`id`), <br> KEY `time` (`time`) <br> )ENGINE=MyISAM <br> AUTO_INCREMENT=1 ROW_FORMAT=FIXED CHARACTER SET 'utf8' COLLATE 'utf8_general_ci'; <br></code> <br><br>  There are very few :-) The drawing graph will use <a href="http://www.aditus.nu/jpgraph/index.php">jpgraph</a> .  Here is the content of the script itself: <br><br> <code>&lt;?php <br> <br> include "../../lib/jpgraph/jpgraph.php"; <br> include "../../lib/jpgraph/jpgraph_line.php"; <br> include "../../lib/jpgraph/jpgraph_scatter.php"; <br> include "../../lib/jpgraph/jpgraph_regstat.php"; <br> <br> include "../../conf/user.conf.php"; <br> <br> $db = new PDO(DB_STAT_DSN, DB_STAT_LOGIN, DB_STAT_PWD); <br> <br> $stmt = $db-&gt;query('SELECT SUM(`delta_in`) / 1024 / SUM(`period`) AS `in`, <br> SUM(`delta_out`) / 1024 / SUM(`period`) AS `out`, <br> MAX(`time`) AS `time` <br> FROM `bandwidth` <br> WHERE `time` &gt; DATE_SUB(NOW(), INTERVAL 12 HOUR) <br> GROUP BY CONCAT(DATE(`time`), HOUR(`time`), FLOOR(MINUTE(`time`) / 5)) <br> ORDER BY `time`'); <br> $x = $in = $out = array(); <br> while ($row = $stmt-&gt;fetch()) { <br> $ts = strtotime($row['time']); <br> $x[] = $ts; <br> $in[] = $row['in']; <br> $out[] = $row['out']; <br> } <br> <br> // Setup the basic graph <br> $graph = new Graph(800, 400); <br> $graph-&gt;SetMargin(30, 10, 0, 30); <br> $graph-&gt;title-&gt;Set('Bandwidth, KB/s'); <br> $graph-&gt;SetAlphaBlending(); <br> <br> // Setup a manual x-scale (We leave the sentinels for the <br> // Y-axis at 0 which will then autoscale the Y-axis.) <br> // We could also use autoscaling for the x-axis but then it <br> // probably will start a little bit earlier than the first value <br> // to make the first value an even number as it sees the timestamp <br> // as an normal integer value. <br> $graph-&gt;SetScale("intlin", 0, max(max($out), max($in)) * 1.1, reset($x), end($x)); <br> $graph-&gt;xgrid-&gt;Show(); <br> $graph-&gt;yaxis-&gt;HideZeroLabel(); <br> $graph-&gt;SetFrame(false); <br> <br> function TimeCallback($aVal) { <br> return Date('H:i',$aVal); <br> } <br> // Setup the x-axis with a format callback to convert the timestamp <br> // to a user readable time <br> $graph-&gt;xaxis-&gt;SetLabelFormatCallback('TimeCallback'); <br> //$graph-&gt;xaxis-&gt;SetLabelAngle(90); <br> <br> // Create the line <br> $p1 = new LinePlot($out, $x); <br> $p1-&gt;SetColor("red"); <br> <br> $p2 = new LinePlot($in, $x); <br> $p2-&gt;SetColor("blue"); <br> <br> // Add lineplot to the graph <br> $graph-&gt;Add($p1); <br> $graph-&gt;Add($p2); <br> <br> header("Expires: Mon, 26 Jul 1997 05:00:00 GMT"); <br> header("Last-Modified: " . gmdate("D, d MYH:i:s") . " GMT"); <br> header("Cache-Control: no-cache, must-revalidate"); <br> header("Cache-Control: post-check=0,pre-check=0"); <br> header("Cache-Control: max-age=0"); <br> header("Pragma: no-cache"); <br> <br> // Output line <br> $graph-&gt;Stroke(); <br> <br> ?&gt;</code> <br> <br>  First we connect the necessary libraries.  Then - by a simple request we select data from the database.  Moreover, we aggregate them in intervals of 5 minutes, so that the graph turns out to be more averaged and smooth.  Then - based on the examples coming with jpgraph, we ‚Äúcollect‚Äù the graph of the desired type.  The resulting code is placed in the file wt / img / bandwidth.php. <br><br>  And the last thing is to display the resulting graph on the wtorrent page. <br><br>  Add a menu item.  This is also done in the rtorrent.cls.php file, by adding the 'Graphic' =&gt; 'Graphic' element to the associative array with the menu menu_admin. <br>  Then we create a class that will manage the display of the Graphic.cls.php page: <br><br> <code>&lt;?php <br> <br> class Graphic extends rtorrent <br> { <br> public function construct() <br> { <br> if(!$this-&gt;setClient()) <br> { <br> return false; <br> } <br> } <br> } <br> ?&gt; <br></code> <br><br>  Finally, we create a template with a single line that will show the graphic, graphic.tpl.php: <br> <code><img src="http://./wt/img/bandwidth.php"></code> <br><br>  Everything, after these simple manipulations, you should have got a result similar to what I showed above.  :-) <br><br>  PS: all the sources listed above can be downloaded <a href="http://www.rapidshare.ru/919126">here</a> . </div><p>Source: <a href="https://habr.com/ru/post/51295/">https://habr.com/ru/post/51295/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../51280/index.html">HP Open Innovation Contest</a></li>
<li><a href="../51281/index.html">Microsoft choose Postfix</a></li>
<li><a href="../51283/index.html">Malware on car windows</a></li>
<li><a href="../51292/index.html">Google Book Search archive on mobile</a></li>
<li><a href="../51294/index.html">Unpredictable symbolic (symbolic) links in Windows.</a></li>
<li><a href="../51297/index.html">Unnecessary indents in lists</a></li>
<li><a href="../51302/index.html">Extending wget features</a></li>
<li><a href="../51305/index.html">Search engine optimization. Part 1 - internal factors</a></li>
<li><a href="../51313/index.html">Psd - trick with file size</a></li>
<li><a href="../51315/index.html">Overview of SSL certificates: types, choices, benefits.</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>