<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Automatic collection and archiving of photo / video surveillance</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="TASK 

 Once, the authorities demanded to keep a record around the clock in the offices. And also, during working hours - periodically publish photos ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Automatic collection and archiving of photo / video surveillance</h1><div class="post__text post__text-html js-mediator-article"><h5>  <b>TASK</b> </h5><br><img align="left" src="https://habrastorage.org/getpro/habr/post_images/ba5/621/bff/ba5621bff9bc04359244a3c4cbf77e14.jpg"><br>  Once, the authorities demanded to keep a record around the clock in the offices.  And also, during working hours - periodically publish photos from offices on the site. <br><br>  From my predecessor I got: <br><ul><li>  Several offices with smart D-Link camcorders that photograph what is happening </li><li>  Server on FreeBSD </li><li>  The site of the organization, where the picture from each camera should go </li><li>  Network folder on the local network where records archives should be stored </li></ul><br><h6>  Known: </h6><br>  - FreeBSD server is not accessible from the outside <br>  - The hoster does not like being connected to his FTP more often than once a minute <br>  - Considering the quality and thickness of communication channels, the cameras do not write video, but make periodic photos <br><br>  At the time of setting the task, the video cameras independently connected to the FTP host and laid out the pictures on a schedule every minute.  As a result, the hoster periodically blocked FTP access to the site. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <a name="habracut"></a><br><br><h5>  <b>DECISION</b> </h5><br><h6>  Solution - Theory </h6><br>  The solution to this problem was one of the lessons on information security, given to me once at SPSU ITMO.  The lesson talked about security zones, their levels, and the rules for reading / writing between levels. <br><br><blockquote>  In a nutshell: an application with a higher level of security, for example, 1, can read and write to an application of level 2 or 3. But application 2 cannot read or write to application 1, although it can read and write to application 3. <br></blockquote><br>  <i>In fact, the <a href="http://ru.wikipedia.org/wiki/%25CC%25EE%25E4%25E5%25EB%25FC_%25C1%25E5%25EB%25EB%25E0-%25CB%25E0%25CF%25E0%25E4%25F3%25EB%25E0">rules are somewhat more complicated</a> , but I simplified to facilitate perception.</i> <br><br><h6>  Who is who </h6><br>  The scheme of interaction of all the above elements is simple: <br>  Cameras add photos to my server via FTP, the server copies them to a network folder, and also publishes them on a hosting. <br><br><img src="https://habrastorage.org/storage1/1be2a1e1/85901011/368f7ab9/af34059d.jpg"><br><br>  The server here is level 1, with access to all other levels.  It is easy to notice that there is a rule violation here: cameras with a lower 2nd level are given the right to write on 1st level.  In an amicable way, the server should have been taught to read the picture from the cameras, and not to open access for them, but in this case, the general security of the system was not affected.  I explain: the trick is that cameras write to an FTP folder that has the same security level as cameras, i.e.  2nd  The folder is separate from all others and contains only the current images from the cameras.  Anyone who connects to FTP using the login and password from the camera will receive only a few photos of the offices, but will not be able to see all the archives. <br><br>  <i>While I painted it all, I thought that an attacker could upload his own photo containing some obscenity in this way, and it would automatically go to the site.</i>  <i>We need to think about how to avoid it.</i>  <i>You can, for example, restrict access to FTP over the static IP addresses of cameras and complicate passwords for accessing cameras and FTP.</i>  <i>But it is better than teaching the server to read the image from the cameras on their own, I'm afraid not to think of anything.</i>  <i>What to do - the technical limitations of cameras.</i> <br><br>  But let's not lose heart.  The cameras do not hang in the most convenient place for physical access, but in order to dig into them - you need to know the password ... and you also need to put on a mask or turn off the light before you unscrew the camera, but these actions also spoil the intruder, because  who knows what time was where. <br><br><h6>  Back to our sheep </h6><br>  So, the cameras will take pictures together on the server, and he, in turn, using the ingenious script on SH, will copy them to the archive folder with the current date and upload copies on the site if the current time matches the institution's mode of operation.  And the next day, the server will clean up the archive folder that has already become yesterday from files with 0 size, collect all the photos into a video using the ffmpeg utility, and delete them. <br><br><h6>  Solution - Practice </h6><br><ol><li>  We install and configure on the FreeBSD ProFTP server (there is no argument about tastes, I just offer a clear option) and ffmpeg. </li><li>  Create a folder for video cameras and a folder for the archive (for example, somewhere in the folder / usr /) </li><li>  Create an account for video cameras in ProFTP and give it the created folder </li><li>  We set up cameras using their web interface, so that they are around the clock and, for example, every minute (to whom what period is right), connect to our server via FTP and save a photo. </li><li>  It is also very important to set the cameras with the correct date, time and automatic synchronization with the local NTP time server. </li><li>  We remember the FTP connection parameters of our hosting. </li><li>  We write an ingenious SH-script and put it in cron with a frequency of execution similar to the frequency of uploading photos with cameras, i.e.  once a minute. </li><li>  Enjoy and go to report to the authorities. </li></ol><br><br>  Finally, the heart of the solution is a script of its own work <br><pre><code class="hljs mel">#!/bin/sh ##  . ,   ##   ,   day=<span class="hljs-string"><span class="hljs-string">"`date +%Y-%m-%d`"</span></span> archive=<span class="hljs-string"><span class="hljs-string">"/store/STORE/cam_archive"</span></span> ##     FTP ##   FTPUSER=<span class="hljs-string"><span class="hljs-string">'*********'</span></span> ## IP-     FTPHOST=<span class="hljs-string"><span class="hljs-string">'***.***.***.***'</span></span> ##  FTP FTPPASS=<span class="hljs-string"><span class="hljs-string">'************'</span></span> ##  ,      REMOTEDIR=<span class="hljs-string"><span class="hljs-string">"/www/img"</span></span> ##       LOCALDIR=<span class="hljs-string"><span class="hljs-string">"/store/STORE/cam"</span></span> ##    ,     cd $LOCALDIR #      echo . echo -================================================- <span class="hljs-keyword"><span class="hljs-keyword">date</span></span> ##  ,       mkdir $archive/$day &gt;/dev/null <span class="hljs-number"><span class="hljs-number">2</span></span>&gt;&amp;<span class="hljs-number"><span class="hljs-number">1</span></span> ##     . time1=<span class="hljs-string"><span class="hljs-string">`date +%H_%M_%S`</span></span> ##      ,  . #       (  ,   ) echo    . <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> <span class="hljs-keyword"><span class="hljs-keyword">file</span></span> <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> $(<span class="hljs-keyword"><span class="hljs-keyword">ls</span></span> <span class="hljs-number"><span class="hljs-number">-1</span></span> *.jpg) <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> camfolder=<span class="hljs-string"><span class="hljs-string">`echo ${file} | sed 's/\.jpg//'`</span></span> mkdir $archive/$day/$camfolder &gt;/dev/null <span class="hljs-number"><span class="hljs-number">2</span></span>&gt;&amp;<span class="hljs-number"><span class="hljs-number">1</span></span> cp $file $archive/$day/$camfolder/$time1\_$file done #      ,      # grep  ,     minutes1    minutes2 minutes1=<span class="hljs-string"><span class="hljs-string">'01 03 05 07 09 11 13 15 17 19 21 23 25 27 29 31 33 35 37 39 41 43 45 47 49 51 53 55 57 59'</span></span> minutes2=<span class="hljs-string"><span class="hljs-string">`date +%M`</span></span> result=<span class="hljs-string"><span class="hljs-string">`echo ${minutes1} | grep ${minutes2}`</span></span> #    ,         (&gt;=<span class="hljs-number"><span class="hljs-number">10</span></span> and &lt;=<span class="hljs-number"><span class="hljs-number">18</span></span> and !result) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> [ <span class="hljs-string"><span class="hljs-string">`date +%H`</span></span> -ge <span class="hljs-number"><span class="hljs-number">10</span></span> ] &amp;&amp; [ <span class="hljs-string"><span class="hljs-string">`date +%H`</span></span> -le <span class="hljs-number"><span class="hljs-number">18</span></span> ] &amp;&amp; [ -n <span class="hljs-string"><span class="hljs-string">"$result"</span></span> ] then { echo    FTP. ##     FTP-    ftp -n $FTPHOST &lt;&lt;EOF quote USER $FTPUSER quote PASS $FTPPASS binary cd $REMOTEDIR dir mput * a EOF } fi #     (=<span class="hljs-number"><span class="hljs-number">00</span></span> and =<span class="hljs-number"><span class="hljs-number">00</span></span>),       . <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> [ <span class="hljs-string"><span class="hljs-string">`date +%H`</span></span> -eq <span class="hljs-string"><span class="hljs-string">'00'</span></span> ] &amp;&amp; [ <span class="hljs-string"><span class="hljs-string">`date +%M`</span></span> -eq <span class="hljs-string"><span class="hljs-string">'00'</span></span> ] then { #    LASTDAY=<span class="hljs-string"><span class="hljs-string">`date -v-1d +"%Y-%m-%d"`</span></span> ##     cd $archive/$LASTDAY/ ##             ##         <span class="hljs-number"><span class="hljs-number">10</span></span>k,     -   find $archive/$LASTDAY/ -<span class="hljs-keyword"><span class="hljs-keyword">size</span></span> <span class="hljs-number"><span class="hljs-number">-10</span></span>k -<span class="hljs-keyword"><span class="hljs-keyword">print</span></span> | { <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> read files <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> rm <span class="hljs-string"><span class="hljs-string">"${files}"</span></span> done } ##       ,    <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> camfolders <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> $(<span class="hljs-keyword"><span class="hljs-keyword">ls</span></span> <span class="hljs-number"><span class="hljs-number">-1</span></span> -U) <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> ## <span class="hljs-number"><span class="hljs-number">1.</span></span>           y=<span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ls</span></span> <span class="hljs-number"><span class="hljs-number">-1</span></span> $archive/$LASTDAY/$camfolders<span class="hljs-comment"><span class="hljs-comment">/*.jpg | { while read files2 do y=`expr ${y} + 1` mv ${files2} $archive/$LASTDAY/$camfolders/img`printf %04d ${y}`.jpg done } ## 2.     ## </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">TODO:</span></span></span><span class="hljs-comment">      ffmpeg -f image2 -i $archive/$LASTDAY/$camfolders/img%04d.jpg -r 6 -s 720x576 $archive/$LASTDAY/$camfolders\_$LASTDAY.avi ## 3.      rm -rf $camfolders done } fi exit 0</span></span></code> </pre> <br><br><h5>  File work: </h5><br><ul><li>  The quality of video compression, to put it mildly, suffers terribly.  I can not figure out the smart options ffmpeg.  And perhaps that is not enough codecs.  I ask those who came across - to prompt the appropriate list of keys. </li><li>  <s>An insider intruder, pretending to be a camera, can arrange a non-sour defeat to a respected site, if of course he finds out the password from FTP.</s>  <s>It is necessary either to close somehow, or to teach the server to enter the web interface of the cameras and download the current image from them (the camera has a static address <a href="http://cam1/snapshot.php">cam1 / snapshot.php</a> for this, and authentication is based on .htaccess).</s>  <s>Please advise, with the help of which commands and utilities, this can be solved.</s> <br>  UPD: the decision of this moment was suggested by <a href="http://habrahabr.ru/users/akint/" class="user_link">Akint</a> .  A little later, add to the code. </li></ul></div><p>Source: <a href="https://habr.com/ru/post/132315/">https://habr.com/ru/post/132315/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../132308/index.html">Implementing the DEEP IDLE power saving mode in the Linux kernel</a></li>
<li><a href="../132309/index.html">TELESAR V - robot for telebeeting</a></li>
<li><a href="../132312/index.html">About unnecessary Spanning Tree</a></li>
<li><a href="../132313/index.html">Cmake - we collect portable applications for Mac Os X and Windows</a></li>
<li><a href="../132314/index.html">Observable.Generate and list listings</a></li>
<li><a href="../132317/index.html">Fluent Interface Organization in Python</a></li>
<li><a href="../132318/index.html">Facebook flight search app</a></li>
<li><a href="../132319/index.html">European investors rules</a></li>
<li><a href="../132320/index.html">Let's hit gadgets on illiteracy (extension for Google Chrome)</a></li>
<li><a href="../132321/index.html">TeamLab CRM Beta - sellers to note: use yourself for a profit, to us for testing</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>