<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>HA (High Available) VMware vSphere cluster on HP BL460c and EVA blades</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Practical application of knowledge about working with EVA and iLO arrays in ProLiant servers , which you received a little earlier, can be the deploym...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>HA (High Available) VMware vSphere cluster on HP BL460c and EVA blades</h1><div class="post__text post__text-html js-mediator-article">  Practical application of knowledge about <a href="http://habrahabr.ru/company/hp/blog/144948/">working with EVA</a> and <a href="http://habrahabr.ru/company/hp/blog/144474/">iLO</a> <a href="http://habrahabr.ru/company/hp/blog/144948/">arrays</a> <a href="http://habrahabr.ru/company/hp/blog/144474/">in ProLiant servers</a> , which you received a little earlier, can be the deployment of a high-availability cluster on vSphere. <br><br>  The cluster can be used for medium and large enterprises to reduce unplanned downtime.  Since for a business such parameters as availability of its service or services to the client in 24x7 mode are important, this solution is based on a high availability cluster.  The cluster always includes at least 2 servers.  In our solution, servers running VMware monitor each other‚Äôs state, while at the same time only one of them will lead, and a virtual machine with our business application will be deployed on it.  In the event of a master server failure, its role automatically assumes the second, while for the customer access to the business application is almost not interrupted. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/storage2/3ca/b8e/72e/3cab8e72ec4e985df1b0f9fa115549b5.jpg"></div><br><a name="habracut"></a><br><h4>  1. Description of the task </h4><br>  In this example, we describe the process of creating a highly available VMware cluster on the BL460c G7 server blades.  The hardware consists of an HP c7000 blade basket and two BL460c G7 blade servers, where a VMware HA (High Available) cluster is configured.  In the HP demo center in Moscow, only models of G7 blade servers are now available, but based on the described example, you can assemble a cluster on new Gen8 blade servers.  Configuration, in general, will not differ.  The storage system is HP EVA 4400. For the Ethernet and Fiber Channel connections in the c7000 cage, 2 HP Virtual Connect Flex Fabric modules are installed in compartments 1 and 2. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h4>  2. Description of components </h4><br><div style="text-align:center;"><img src="https://habrastorage.org/storage2/977/8d7/dea/9778d7deaf7dc3ea0c4d189bb62ddbe5.jpg"></div><br>  <i>Virtual Connect FlexFabric is a converged virtualized I / O module for the c7000 blade basket.</i> <br><br>  The HP Virtual Connect FlexFabric module uses Flex-10, FCoE, Accelerated iSCSI technologies for switching blades and network infrastructure (SAN and LAN) at a speed of 10Gb. <br><br>  From the possibilities: transfer of ‚Äúprofiles‚Äù (table of MAC and WWN servers) not only between different blades in the chassis, but also to remote sites where there is the same server blade. <br><br>  Also, when using Virtual Connect, each of the two ports of a blade server network card can be divided into 4 virtual 1GbE / 10GbE / 8Gb FC / iSCSI ports with a total bandwidth of 10GbE per port.  This allows you to get from 8 virtual ports to the server (on the BL460c G7), which must be set at the first initialization. <br><br>  The only limitation is that HP Virtual Connect FlexFabric are not full switches.  These are aggregators, for which you must have separate Ethernet and SAN switches (in the latest firmware, however, the Direct Connect feature with HP P10000 3PAR appeared). <br><br>  A general view of the equipment used is reflected in the Onboard Administrator. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/storage2/e28/7f1/d6c/e287f1d6cb7dca6cc72d07a449d1c500.jpg"></div><br><br>  Integrated into the ProLiant BL460c G7, the NC553i Dual Port FlexFabric 10Gb card can work with HP Virtual Connect FlexFabric modules directly, without additional mezzanine cards.  Two HP Virtual Connect FlexFabric modules are installed for fault tolerance of the communication paths of the blade servers to the EVA 4400 storage system and Ethernet switches. <br><br>  In this example, we will consider a scenario where traffic from the HP Virtual Connect FlexFabric module is divided into Ethernet switches and an FC factory.  FCoE in this case is used for switching modules with blades inside the basket. <br><br>  HP Virtual Connect FlexFabric modules require transceivers to work with various protocols.  In this example, 4 Gb FC SFP transceivers were installed in ports 1 and 2 on each of the modules, and 10 Gb SFP + transceivers were installed in ports 4 and 5. 10GbE channels were used in this test to enable network equipment in our demo center. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/storage2/bb6/5f2/573/bb65f2573131c53dfa461f0bc2d3a6bd.jpg"></div><br><br>  The diagram shows that the 3 ports of the NC553i Dual Port FlexFabric 10Gb network adapter are configured as FlexNIC for interfacing virtual machines and for connecting to the network infrastructure.  The remaining port was configured as FCoE for communication with the SAN infrastructure and the EVA 4400 storage system. <br><br>  HP Virtual Connect Manager management software is supplied with each Virtual Connect module, HP Virtual Connect Enterprise Manager for Enterprise modules.  Using Enterprise Manager, you can manage up to 256 domains from one console (1 domain - 4 Blade systems with Virtual Connect). <br><br>  After connecting the module, you need to configure it.  This is done either by connecting the basket itself to the Onboard Administrator, or by the IP address that is assigned to the module by default at the factory. <br><br><h4>  3. Configuring Profiles in Virtual Connect Manager </h4><br><div style="text-align:center;"><img src="https://habrastorage.org/storage2/8e9/5ed/f5c/8e95edf5c84c42711ec0851d853ec498.jpg"></div><br><br>  Once HP FlexFabric is connected, we need to define the domain, Ethernet network, SAN fabric and server profiles for the hosts.  These settings are made in the HP Virtual Connect Manager or on the command line.  In our example, the domain has already been created, so the next step is to define the VC Sharing Uplink Sets to support Ethernet networks of virtual machines named HTC-77-A and HTC-77-B.  Enable the ‚ÄúMap VLAN tags‚Äù feature in the installation wizard. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/storage2/003/99d/e4a/00399de4a17e57ecca4fa2e6ed2df47d.jpg"></div><br><br>  The ‚ÄúMap VLAN tags‚Äù feature allows you to use one physical interface to work with multiple networks using Shared Uplink Set.  In this way, multiple VLANs can be configured on the server network card interface.  The Shared Uplink Sets parameters were specified in the VCM installation wizard.  SUS job example: <br><br><iframe width="560" height="315" src="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://www.youtube.com/embed/w2Ddiws1_Uk%3Ffeature%3Doembed&amp;xid=17259,15700021,15700186,15700191,15700253,15700256,15700259&amp;usg=ALkJrhgvbOhUmdq5mogO-RDb0X8Vaq9TnQ" frameborder="0" allowfullscreen=""></iframe><br><br><div style="text-align:center;"><img src="https://habrastorage.org/storage2/53a/a79/e3d/53aa79e3d15140a1e945061a37911430.jpg"></div><br><br>  Both HTC-77-A and HTC-MGMT-A networks were assigned: VLAN_Uplink_1 to port 5 of module 1;  the second Shared Uplink Set (VLAN_Uplink_2) has been assigned to port 5 of module 2, and includes the networks HTC-77-B (VLAN 20) and HTC-MGMT-B (VLAN 21).  An example of creating Ethernet networks in VCM: <br><br><iframe width="560" height="315" src="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://www.youtube.com/embed/nuBYzIS2r9w%3Ffeature%3Doembed&amp;xid=17259,15700021,15700186,15700191,15700253,15700256,15700259&amp;usg=ALkJrhgL1YNqJ04O84zFhQ-3vPYSCSXmSw" frameborder="0" allowfullscreen=""></iframe><br><br>  The HP Virtual Connect module can create an uplink-free internal network using high-performance 10Gb connections to the c7000 backplane.  The internal network can be used for VMware vMotion, as well as for the organization of network resiliency.  The traffic of this network does not reach the external ports of the c7000.  In our case, 2 VMware vMotion networks were configured.  For the management console, two networks have been configured with the names HP-MGMT-A and HP-MGMT-B.  Port 6 of the HP Virtual Connect FlexFabric modules in slots 1 and 2 was used to connect to the management console. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/storage2/2fa/a8d/5f2/2faa8d5f25ab729a6786653a75eb5e91.jpg"></div><br><br>  After that, the SAN factory configuration begins.  It's pretty simple: in VCM choose Define - SAN Fabric.  Select the SAN-1 module in bay 1, port X1.  For the second SAN-2 module, the port is also X1.  SAN Configuration Example: <br><br><iframe width="560" height="315" src="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://www.youtube.com/embed/j5WFfDELgYg%3Ffeature%3Doembed&amp;xid=17259,15700021,15700186,15700191,15700253,15700256,15700259&amp;usg=ALkJrhhtZ6oEiD6UyX3EOTyfAdjF_9W2jw" frameborder="0" allowfullscreen=""></iframe><br><br><div style="text-align:center;"><img src="https://habrastorage.org/storage2/254/792/2d7/2547922d70de02206086e239532c9b0a.jpg"></div><br><br>  The final step is to ‚Äúglue‚Äù all previously made settings to the server profile.  This can be done in several ways: for example, via the VCM web-interface or via the Virtual Connect - Virtual Connect Scripting Utility (VCSU) command line.  Before installing the OS, you need to check that all system, NIC and FC drivers are updated, and all network parameters are set.  An example of creating a profile in CVM: <br><br><iframe width="560" height="315" src="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://www.youtube.com/embed/4_mF9d0g_W0%3Ffeature%3Doembed&amp;xid=17259,15700021,15700186,15700191,15700253,15700256,15700259&amp;usg=ALkJrhhlNJcTIPxHrYa-Xj_E-3Nrok0zfA" frameborder="0" allowfullscreen=""></iframe><br><br>  In VCM, select Define - Server Profile, enter the profile name and select the network connections from the profile created earlier. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/storage2/0df/70e/2c3/0df70e2c37bc40a1e2a909159dec6e7c.jpg"></div><br><br>  In our case, all the ports were assigned by us in advance: 6 Ethernet ports and 2 SAN ports for each profile.  The profiles for compartment 11 and 12 are identical, i.e.  each server sees the same set of ports.  The total speed does not exceed 10 Gb / s for each port of the server network card. <br><br>  If network expansion is planned in the future, it is recommended to assign unassigned ports in the profile.  By doing so, you can further activate these ports without shutting down and restarting the server. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/storage2/b41/cf5/d94/b41cf5d947188d8a21a9ffe9cacccf1b.jpg"></div><br><br>  When creating a default profile, only 2 ports are available in the Ethernet section.  To add more, you need to call the context menu with the right mouse button and select ‚ÄúAdd connection‚Äù. <br><br>  We assign a speed for each type of ports: management ports - 500Mb / s, vMotion ports - 1Gb / s, SAN ports - 4Gb / s, and virtual machine ports - 4.5Gb / s. <br><br>  After creating the profiles, they are attached to the blade compartment of the basket in the same menu. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/storage2/0a3/197/fa3/0a3197fa382f67d38b3b20495e56bb29.jpg"></div><br><br><h4>  4. Configure VMware Cluster </h4><br>  This completes the cart configuration.  Next, there is a remote connection to the blades themselves and the deployment of VMware ESX 5.0, an example of remote installation of the OS on the ProLiant servers via iLO <a href="http://habrahabr.ru/company/hp/blog/144474/">has already been described</a> . <br><br>  In our case, instead of Windows, VMware is selected in the installer drop-down menu and the path to the distribution kit is indicated. <br><br>  After installation, the server restarts and you can begin to configure the virtual machines.  To do this, connect to the ESX server.  Go to the Configuration section, create 6 vmnics on each host, as in the Virtual Connect module: Service Console (vSwitch0), VM Network (vSwitch1), vMotion (vSwitch2).  Thus we get a fault-tolerant configuration, where each network corresponds to 2 vmnics. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/storage2/a8d/198/f14/a8d198f14e3bc57322e132b226519f09.jpg"></div><br><br>  As soon as vmnics are added, you will notice that each adapter is automatically set to the speed specified in the server profile when configured in Virtual Connect Manager. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/storage2/0c9/a09/4ac/0c9a094ac00407b3eeb48b0bada9cdc0.jpg"></div><br><br>  After adding vmnics, we combine them into a group using the vSwitch: Port tab - in the Configuration field, select vSwitch - Edit, select NIC Teaming, make sure that both vmnics are visible.  Load balancing is selected by ‚ÄúRoute based on the originating virtual port ID‚Äù - these settings are recommended to be set by default (for more information about this method, see <a href="http://www.vmware.com/files/pdf/virtual_networking_concepts.pdf">the VMware website</a> . <br><br><div style="text-align:center;"><img src="https://habrastorage.org/storage2/eea/fe4/2b0/eeafe42b0732682664d6f1840212a1c1.jpg"></div><br><br><h4>  5. Setting up the EVA 4400 disk array </h4><br>  <a href="http://habrahabr.ru/company/hp/blog/144948/">The previous review</a> described how to work with the EVA - Command View disk array management interface. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/storage2/2be/f26/516/2bef2651680fd7c23df678ce459c5092.jpg"></div><br><br>  In this example, we create a 500 GB LUN that is shared between two virtual machine hosts.  According to the method described in the previous article, a virtual disk is created and presented to two ESX hosts.  The size of the LUN is determined by the type of OS and the roles that this cluster will perform.  A prerequisite for a cluster (in particular, for VMware vMotion) - the LUN must be shared.  The new LUN must be formatted in VMFS, and the Raw Device mappings (RDMs) feature for the virtual machines must be enabled. <br><br><h4>  6. Implementing VMware HA and VMware vMotion </h4><br>  HP Virtual Connect in combination with VMware vMotion gives the same level of redundancy as when using two VC-FC modules and two VC-Eth modules, except that only 2 HP FlexFabric modules are needed.  HP Virtual Connect FlexFabric allows you to organize fault-tolerant paths to a common LUN and fault-tolerant network interface interconnection (NIC Teaming) for networking.  All VMware vSphere settings meet the Best Practices <a href="http://www.vmware.com/pdf/Perf_Best_Practices_vSphere5.0.pdf">described in the document</a> . <br><br>  A cluster availability check was performed.  A Windows 2008 Server R2 virtual machine was deployed on one of the hosts. <br><br><iframe width="560" height="315" src="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://www.youtube.com/embed/ASCPHxEW6II%3Ffeature%3Doembed&amp;xid=17259,15700021,15700186,15700191,15700253,15700256,15700259&amp;usg=ALkJrhjAzZ-00GZWdp77ovZoa1haj8HIrg" frameborder="0" allowfullscreen=""></iframe><br><br><div style="text-align:center;"><img src="https://habrastorage.org/storage2/c6b/909/348/c6b909348918927697f37731726e7022.jpg"></div><br><br>  The virtual machine was manually migrated from one server to another several times, while the cluster was still available during the flashing. <br><br><iframe width="560" height="315" src="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://www.youtube.com/embed/wJS2sItojmU%3Ffeature%3Doembed&amp;xid=17259,15700021,15700186,15700191,15700253,15700256,15700259&amp;usg=ALkJrhgYXKlIdQMIGysxNBNXWR0CBiRxrA" frameborder="0" allowfullscreen=""></iframe><br><br>  Cluster layout: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/storage2/b0a/6c3/f75/b0a6c3f759c2c10df7ab03554e3bc6e2.jpg"></div><br><br>  HTC DC is our DC, Demo-FlexFabric Cluster is our cluster, Demo-ESX1 and Demo-ESX2 are VMware hosts, vmhba2 are SAS blade server controllers connected to the internal disk subsystem.  Vmhba0 and vmhba1 are two ports of embedded NC553i Dual Port FlexFabric 10Gb Adapter network cards connected to a shared LUN EVA 4400. Demo-VM-W2K8R2-01 is a virtual machine. <br><br>  <b>Literature:</b> <br><br>  1. <a href="http://h18004.www1.hp.com/products/quickspecs/14208_div/14208_div.PDF">HP Blade Server BL460c Gen8</a> <br>  2. <a href="http://h18004.www1.hp.com/products/quickspecs/13652_div/13652_div.PDF">HP Virtual Connect FlexFabric</a> <br>  3. <a href="http://h20195.www2.hp.com/v2/GetPDF.aspx/4AA1-1907ENW.pdf">Deploying a VMware vSphere HA Cluster with HP Virtual Connect FlexFabric</a> <br>  4. <a href="http://www.vmware.com/pdf/Perf_Best_Practices_vSphere5.0.pdf">VMware Best Practices vSphere 5.0</a> <br>  5. <a href="http://www.vmware.com/files/pdf/virtual_networking_concepts.pdf">VMware Virtual Networking Concepts</a> </div><p>Source: <a href="https://habr.com/ru/post/145859/">https://habr.com/ru/post/145859/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../145854/index.html">Canonical announces a developer contest with valuable prizes.</a></li>
<li><a href="../145855/index.html">Working with USB devices in a C program on MacOS X</a></li>
<li><a href="../145856/index.html">Plim - the most complete port of Slim template engine on Python</a></li>
<li><a href="../145857/index.html">June 30, 2012 will be a second longer: 23:59:60</a></li>
<li><a href="../145858/index.html">You can go to jail for 15 years using Google Talk or Skype.</a></li>
<li><a href="../145860/index.html">Cream IT R & D (release 12) - 2016 is the year of change</a></li>
<li><a href="../145861/index.html">iOS 6 - is it all bad?</a></li>
<li><a href="../145862/index.html">J.Subbotnik in St. Petersburg</a></li>
<li><a href="../145863/index.html">The clouds are falling again. AWS EC2 us-east-1 (N. Virginia) - power failure</a></li>
<li><a href="../145864/index.html">Dropbox abandons the Public folder in new accounts</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>