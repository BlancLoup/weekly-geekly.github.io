<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Config generation for nginx, history of one pull request</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Greetings, comrades. On my combat servers, fine nginx has been spinning since 2006 and over the years of its administration I have accumulated a lot o...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Config generation for nginx, history of one pull request</h1><div class="post__text post__text-html js-mediator-article">  Greetings, comrades.  On my combat servers, fine <a href="http://nginx.com/">nginx has been</a> spinning since 2006 and over the years of its administration I have accumulated a lot of configs and patterns.  I praised nginx a lot and somehow it turned out that even the nginx hub on Habr√© also started me up, ponty \ m / <br><br>  Friends asked them to raise a developer farm, and instead of dragging their specific templates to them, I remembered about an interesting project <a href="https://nginxconfig.io/">nginxconfig.io</a> , which <a href="https://nginxconfig.io/">scatters</a> configs on the shelves and lets you encrypt everything and prepare everything.  I thought, why not?  However, I was infuriated by the fact that nginxconfig invites me to download the zip archive into the browser, not allowing it to be merged directly onto the server by means of wget / fetch / curl.  What kind of nonsense, why is it in my browser, I need it on the server from the console.  Angry, I climbed on github to look at the guts of the project, which led to its fork and, as a result, pull request `y.  About which I would not write, if it was not interesting;) <br><br><img src="https://habrastorage.org/getpro/habr/post_images/cf1/0c3/6c3/cf10c36c3b10ad401a5a0f94f4074384.svg" alt="image"><a name="habracut"></a>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Of course, before picking up the sources, I looked up from where chrome pulls the generated zip archive with configs, and there the address starting with ‚Äúblob:‚Äù was waiting for me, oppa.  Already it became clear that in the course of the service does not generate anything, in fact, it all does js.  Indeed, the zip archive is generated by the client, browser, javascript.  Those.  the beauty is that the <a href="http://nginxconfig.io/">nginxconfig.io</a> project can be simply saved as an html page, uploaded to some <a href="http://narod.ru/">narod.ru</a> and it will work) This is a very funny and interesting solution, however, it is terribly inconvenient for setting up servers, in fact, for what this project was created for.  Download the generated archive with the browser, and then transfer it to the server using nc ... in 2019?  I set myself the task of finding a way to download the received config directly to the server. <br><br>  Having made a fork of the project, I began to think what options I have.  The task was complicated by the fact that I did not want to deviate from the condition that the project should remain clean front-end, without any back-end.  Of course, the simplest solution would be to pull up nodejs, and force it to generate an archive with configs by direct links. <br><br>  The options, in fact, there were not many.  More precisely, only one came to mind.  We need to set up configs and get a link that we can copy to the server console to get a zip archive. <br><br>  Several text files in the resulting zip archive weighed quite a bit, literally a few kilobytes.  The obvious solution was to get the base64 line from the generated zip archive and throw it into the buffer, while on the server a command in the console <br><pre><code class="bash hljs"><span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> <span class="hljs-string"><span class="hljs-string">'base64string'</span></span> | base64 --decode &gt; config.zip</code> </pre>  we could create this zip file. <br><br>  <a href="http://nginxconfig.io/">nginxconfig.io</a> was written in AngularJS, I can‚Äôt even imagine what code kilometers would be needed if the author had not chosen the reactive js framework.  But I can well imagine how much simpler and more beautiful it would be to implement all this on VueJS, although this is a completely different topic. <br><br>  In the project we see the method of generating a zip archive: <br><br><pre> <code class="javascript hljs">$scope.downloadZip = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> zip = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> JSZip(); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> sourceCodes = $<span class="hljs-built_in"><span class="hljs-built_in">window</span></span>.document.querySelectorAll(<span class="hljs-string"><span class="hljs-string">'main .file .code.source'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">var</span></span> i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; sourceCodes.length; i++) { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> sourceCode = sourceCodes[i]; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> name = sourceCode.dataset.filename; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> content = sourceCode.children[<span class="hljs-number"><span class="hljs-number">0</span></span>].children[<span class="hljs-number"><span class="hljs-number">0</span></span>].innerText; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!$scope.isSymlink() &amp;&amp; name.match(<span class="hljs-regexp"><span class="hljs-regexp">/^sites-available\//</span></span>)) { name = name.replace(<span class="hljs-regexp"><span class="hljs-regexp">/^sites-available\//</span></span>, <span class="hljs-string"><span class="hljs-string">'sites-enabled/'</span></span>); } zip.file(name, content); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (name.match(<span class="hljs-regexp"><span class="hljs-regexp">/^sites-available\//</span></span>)) { zip.file(name.replace(<span class="hljs-regexp"><span class="hljs-regexp">/^sites-available\//</span></span>, <span class="hljs-string"><span class="hljs-string">'sites-enabled/'</span></span>), <span class="hljs-string"><span class="hljs-string">'../'</span></span> + name, { <span class="hljs-attr"><span class="hljs-attr">unixPermissions</span></span>: <span class="hljs-built_in"><span class="hljs-built_in">parseInt</span></span>(<span class="hljs-string"><span class="hljs-string">'120755'</span></span>, <span class="hljs-number"><span class="hljs-number">8</span></span>), }); } } zip.generateAsync({ <span class="hljs-attr"><span class="hljs-attr">type</span></span>: <span class="hljs-string"><span class="hljs-string">'blob'</span></span>, <span class="hljs-attr"><span class="hljs-attr">platform</span></span>: <span class="hljs-string"><span class="hljs-string">'UNIX'</span></span>, }).then(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">content</span></span></span><span class="hljs-function">) </span></span>{ saveAs(content, <span class="hljs-string"><span class="hljs-string">'nginxconfig.io-'</span></span> + $scope.getDomains().join(<span class="hljs-string"><span class="hljs-string">','</span></span>) + <span class="hljs-string"><span class="hljs-string">'.zip'</span></span>); }); gtag(<span class="hljs-string"><span class="hljs-string">'event'</span></span>, $scope.getDomains().join(<span class="hljs-string"><span class="hljs-string">','</span></span>), { <span class="hljs-attr"><span class="hljs-attr">event_category</span></span>: <span class="hljs-string"><span class="hljs-string">'download_zip'</span></span>, }); };</code> </pre><br>  everything is quite simple, using the <a href="https://stuk.github.io/jszip/">jszip</a> library <a href="https://stuk.github.io/jszip/">creates</a> a zip, where the configuration files are put.  After creating the zip archive, js feeds it to the browser using the <a href="https://github.com/eligrey/FileSaver.js/">FileSaver.js</a> library: <br><br><pre> <code class="javascript hljs">saveAs(content, <span class="hljs-string"><span class="hljs-string">'nginxconfig.io-'</span></span> + $scope.getDomains().join(<span class="hljs-string"><span class="hljs-string">','</span></span>) + <span class="hljs-string"><span class="hljs-string">'.zip'</span></span>);</code> </pre><br>  where content is the resulting blob zip archive object. <br><br>  Ok, all I had to do was add one more button side by side and when I click on it, do not save the resulting zip archive to the browser, but get the base64 code from it.  A little shuffling, I got 2 methods, instead of one downloadZip: <br><br><pre> <code class="javascript hljs">$scope.downloadZip = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ generateZip(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">content</span></span></span><span class="hljs-function">) </span></span>{ saveAs(content, <span class="hljs-string"><span class="hljs-string">'nginxconfig.io-'</span></span> + $scope.getDomains().join(<span class="hljs-string"><span class="hljs-string">','</span></span>) + <span class="hljs-string"><span class="hljs-string">'.zip'</span></span>); }); gtag(<span class="hljs-string"><span class="hljs-string">'event'</span></span>, $scope.getDomains().join(<span class="hljs-string"><span class="hljs-string">','</span></span>), { <span class="hljs-attr"><span class="hljs-attr">event_category</span></span>: <span class="hljs-string"><span class="hljs-string">'download_zip'</span></span>, }); }; $scope.downloadBase64 = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ generateZip(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">content</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> reader = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> FileReader(); reader.readAsDataURL(content); reader.onloadend = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> base64 = reader.result.replace(<span class="hljs-regexp"><span class="hljs-regexp">/^data:.+;base64,/</span></span>, <span class="hljs-string"><span class="hljs-string">''</span></span>); <span class="hljs-comment"><span class="hljs-comment">//   base64     zip    base64  } }); gtag('event', $scope.getDomains().join(','), { event_category: 'download_base64', }); };</span></span></code> </pre><br>  As you can see, the generation of the zip archive itself I brought to the private method generateZip, well, and so on.  This is AngularJS, and the author himself adheres to callbacks, did not implement it through promises.  downloadZip still did saveAs on output, whereas downloadBase64 did a little more.  We create a FileReader object that came to us in html5 and is already <a href="https://caniuse.com/">available</a> for use.  Which, in due time, is able to make a base64 blob from a blob, or rather, it makes a DataURL string, but this is not so important to us, since  DataURL contains exactly what we need.  Bingo, a little tricky waiting for me when trying to put it all in the buffer.  The author used the <a href="https://clipboardjs.com/">clipboardjs</a> library in the project, which allows you to work with the clipboard without flash objects, based on the selected text.  Initially, I decided to put my base64 in an element with display: none; but in that case I could not put it on the clipboard, since  selection does not occur.  Therefore, instead of display: none;  I did <br><br><pre> <code class="css hljs"><span class="hljs-selector-tag"><span class="hljs-selector-tag">position</span></span>: <span class="hljs-selector-tag"><span class="hljs-selector-tag">absolute</span></span>; <span class="hljs-selector-tag"><span class="hljs-selector-tag">z-index</span></span>: <span class="hljs-selector-tag"><span class="hljs-selector-tag">-1</span></span>; <span class="hljs-selector-tag"><span class="hljs-selector-tag">opacity</span></span>: 0;</code> </pre><br>  which allowed me to hide the element from the eyes and in fact leave it on the page.  Voila, the task is completed, when you click on my button, a line of the following type was placed in the buffer: <br><br><pre> <code class="bash hljs"><span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> <span class="hljs-string"><span class="hljs-string">'base64string'</span></span> | base64 --decode &gt; config.zip</code> </pre> <br>  which I just inserted into the console on the server and immediately received a zip archive with all the configs. <br><br>  And, of course, I threw the pull request to the author, because  the project is active and alive, I want to see updates from the author and have my own button) Who cares, here is <a href="">my</a> project <a href="">fork</a> and <a href="https://github.com/valentinxxx/nginxconfig.io/pull/85">pull request</a> myself, where you can see what I fixed / added. <br><br>  All vigorous development :-) <br><br><img src="https://habrastorage.org/webt/et/op/sv/etopsv7os4ew9wv8kkccgvvbw78.gif"></div><p>Source: <a href="https://habr.com/ru/post/448522/">https://habr.com/ru/post/448522/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../448504/index.html">Collected all "Habrom" directory "Issued by whom ..." for passports. Download to health</a></li>
<li><a href="../448506/index.html">‚ÄúThe Matrix‚Äù is 20 years old: how Wachowski made the cyberpunk that set the agenda for a whole generation</a></li>
<li><a href="../448510/index.html">Acer in 2019: what if you remove all the trinkets from the gaming laptops</a></li>
<li><a href="../448516/index.html">Evolving or making a base for a rote cart on the ARDUINO platform, while sensors and video are being driven to a computer via a smartphone</a></li>
<li><a href="../448518/index.html">How to see a black hole?</a></li>
<li><a href="../448524/index.html">Israeli scientists for the first time in the world printed a living heart</a></li>
<li><a href="../448528/index.html">Free Wireguard VPN service on AWS</a></li>
<li><a href="../448530/index.html">How Megaphone burned on mobile subscriptions</a></li>
<li><a href="../448532/index.html">Space data center. Summing up the experiment</a></li>
<li><a href="../448534/index.html">Why do we need industrial switches with improved EMC?</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>