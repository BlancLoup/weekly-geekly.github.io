<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Chained together, or add comfort comments Vkontakte</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="On a typical evening, he looked into the comments of one of the Vkontakte communities and decided to participate in the discussion. But it was not the...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Chained together, or add comfort comments Vkontakte</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/files/5d1/90e/d42/5d190ed42726476fb7a67dfa464f897d.png" alt="Chained by one chain"><br><br>  On a typical evening, he looked into the comments of one of the Vkontakte communities and decided to participate in the discussion.  But it was not there!  To read the "conversation" of several speakers it was necessary to scroll through the discussion and weed out dozens of unnecessary replicas that did not participate in the dialogue I needed.  Obvious routine, which really want to push on the mechanical brains.  But for some reason, there is no tool to isolate only what is needed from Vkontakt.  "Well?  For the cause! ‚Äú- shouted one of the internal voices, and the rest unanimously supported. <br><br>  So I started to cut the Google Chrome browser extension, which allows me to look at the chains of related comments in Vkontakte discussions. <a name="habracut"></a>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Who is not interested in the plot, can immediately see the result: <br><ul><li>  <a href="https://chrome.google.com/webstore/detail/vkcommentschain/ojhbaaoencoeidckdklfmglkkidmndeb">Link</a> to chrome web store. </li><li>  <a href="https://github.com/zak-mamontov/vk_comments_chain/">Link</a> to github. </li></ul><br>  We continue.  Away, little things, like writing a manifesto!  I'll start immediately on the interesting. <br><br><h2>  Embedding script in page code </h2><br>  The goal is to display a comment chain by clicking on the icon at the comment.  To do this, you need to draw this icon and hang an event on it. <br><br><img src="https://habrastorage.org/files/efc/3c8/a45/efc3c8a450dc45508d510b32b95f920a.png" alt="icon"><br>  <i><font color="#999999">So this ‚Äúicon‚Äù looks like</font></i> <br><br>  It immediately became clear that the code should work ‚Äúfrom the inside‚Äù.  The content script that is usual for extensions will be embedded in the page.  So he will deal with it: <br><br><pre><code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> s = <span class="hljs-built_in"><span class="hljs-built_in">document</span></span>.createElement(<span class="hljs-string"><span class="hljs-string">"script"</span></span>); s.src = chrome.extension.getURL(<span class="hljs-string"><span class="hljs-string">'/js/inject.js'</span></span>); (<span class="hljs-built_in"><span class="hljs-built_in">document</span></span>.head || <span class="hljs-built_in"><span class="hljs-built_in">document</span></span>.documentElement).appendChild(s);</code> </pre> <br>  Some more embedded data will need some static data, like urls for background images and the id of the extension itself.  I forward them through a samopny event raised in the content script after the embedded script has loaded.  The entire content script now looks like this: <br><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> s = <span class="hljs-built_in"><span class="hljs-built_in">document</span></span>.createElement(<span class="hljs-string"><span class="hljs-string">"script"</span></span>); s.src = chrome.extension.getURL(<span class="hljs-string"><span class="hljs-string">'/js/inject.js'</span></span>); (<span class="hljs-built_in"><span class="hljs-built_in">document</span></span>.head || <span class="hljs-built_in"><span class="hljs-built_in">document</span></span>.documentElement).appendChild(s); s.onload = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> evt = <span class="hljs-built_in"><span class="hljs-built_in">document</span></span>.createEvent(<span class="hljs-string"><span class="hljs-string">"CustomEvent"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> url = chrome.extension.getURL(<span class="hljs-string"><span class="hljs-string">'/img/planet.gif'</span></span>); app_uid = chrome.runtime.id; evt.initCustomEvent(<span class="hljs-string"><span class="hljs-string">"BindDefData"</span></span>, <span class="hljs-literal"><span class="hljs-literal">true</span></span>, <span class="hljs-literal"><span class="hljs-literal">true</span></span>, { <span class="hljs-string"><span class="hljs-string">'url'</span></span>: url, <span class="hljs-string"><span class="hljs-string">'app_uid'</span></span>: app_uid }); <span class="hljs-built_in"><span class="hljs-built_in">document</span></span>.dispatchEvent(evt); };</code> </pre> <br>  This is the final look.  A "listen" event on the side of the embedded script.  This is pretty commonplace. <br><br><h2>  Communication between embedded and background scripts </h2><br>  Obtaining comments, of course, occurs via api Vkontakte (namely, the <a href="https://vk.com/dev/wall.getComments">wall.getComments</a> method).  The process of obtaining them does not require that the code be written in a script embedded in the page.  It will be written in a so-called ‚Äúbackground script‚Äù.  Let me remind the structure.  We have: <br><br><ul><li>  <b>Content Script</b> - embed code and static information directly on the page </li><li>  <b>embedded script</b> - code responsible for the display logic </li><li>  <b>background script</b> - code running in the background and waiting for commands from the embedded.  Goes on api to Vkontakte to visit for a list of not displayed comments </li></ul><br><img src="https://habrastorage.org/files/08e/611/00b/08e61100b0e64d058406a43101f0b44b.png" alt="preloader"><br>  <i><font color="#999999">During the walk to the api preloader is drawn.</font></i>  <i><font color="#999999">There are usually no delays, but sometimes something doubts the depths of VKontakte and you have to wait a couple of seconds.</font></i> <br><br>  The api request itself is executed by a simple function that implements xhr: <br><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> send_api_request = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">data, url, sync</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> req = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> XMLHttpRequest(); req.open(<span class="hljs-string"><span class="hljs-string">'GET'</span></span>, url + dict_to_uri(data), sync); req.send(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> req.responseText; }</code> </pre><br>  Much more interesting is the background taking commands from the embedded script.  To do this, was written "listener": <br><br><pre> <code class="javascript hljs">chrome.extension.onMessageExternal.addListener(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">request, sender, call_back</span></span></span><span class="hljs-function">) </span></span>{ chain = create_chaine(request.ids_list); <span class="hljs-comment"><span class="hljs-comment">//   call_back({ 'chain': chain[0], 'pid': request.ids_list[1], 'persons': chain[1] }); //     ‚Äû‚Äú })</span></span></code> </pre><br>  Notice that onMessageExternal is used, since the event is fired from the embedded script.  In other words, for a browser, these events are triggered on the site external to it, and not inside its own extension. <br><br>  On the client side, the event is called like this: <br><br><pre> <code class="javascript hljs">chrome.runtime.sendMessage(app_uid, { <span class="hljs-string"><span class="hljs-string">'ids_list'</span></span>: ids_list }, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">result</span></span></span><span class="hljs-function">) </span></span>{ ... })</code> </pre> <br>  In it we transfer the list of necessary id-schnik (speaker id, post, comment) and then we process the received chain of comments.  The process of building the dialogue itself is trivial, it can be found in the source code. <br><br><h2>  Drawing </h2><br>  The time has come for the ‚Äúvisible‚Äù part of the extension - the pop-up window drawing. <br><br><img src="https://habrastorage.org/files/54a/0a7/dcb/54a0a7dcbd484600bd0f799095a8cacb.png"><br>  <i><font color="#999999">It looks like a short dialogue now</font></i> <br><br>  I did not reinvent the wheel and after a minute reverse engineering, I used the MessageBox class, which Vkontakt uses: <br><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> draw_box = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">html</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> box = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> MessageBox({ <span class="hljs-attr"><span class="hljs-attr">title</span></span>: <span class="hljs-literal"><span class="hljs-literal">false</span></span>, <span class="hljs-attr"><span class="hljs-attr">width</span></span>: <span class="hljs-number"><span class="hljs-number">670</span></span>, <span class="hljs-attr"><span class="hljs-attr">onHide</span></span>: <span class="hljs-literal"><span class="hljs-literal">false</span></span>, <span class="hljs-attr"><span class="hljs-attr">onDestroy</span></span>: <span class="hljs-literal"><span class="hljs-literal">false</span></span>, <span class="hljs-attr"><span class="hljs-attr">bodyStyle</span></span>: <span class="hljs-string"><span class="hljs-string">'background-color: rgba(79, 113, 152, 0.3); border-radius: 6px'</span></span>, <span class="hljs-attr"><span class="hljs-attr">hideButtons</span></span>: <span class="hljs-literal"><span class="hljs-literal">true</span></span>, <span class="hljs-attr"><span class="hljs-attr">grey</span></span>: <span class="hljs-literal"><span class="hljs-literal">true</span></span>, <span class="hljs-attr"><span class="hljs-attr">progress</span></span>: <span class="hljs-literal"><span class="hljs-literal">true</span></span>, <span class="hljs-attr"><span class="hljs-attr">hideOnBGClick</span></span>: <span class="hljs-literal"><span class="hljs-literal">false</span></span> }); box.content(html); box.show(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> box; }</code> </pre> <br>  The html template that is being embedded has been ‚Äúripped off‚Äù and slightly altered from the first available hipster site.  He is too clumsy to quote.  And it is filled with the help of a slightly tweaked contact function rs: <br><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> rs_t = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">html, repl</span></span></span><span class="hljs-function">) </span></span>{ each(repl, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">k, v</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (k == <span class="hljs-string"><span class="hljs-string">'text'</span></span>) { v = (<span class="hljs-keyword"><span class="hljs-keyword">typeof</span></span> v === <span class="hljs-string"><span class="hljs-string">'undefined'</span></span> ? <span class="hljs-string"><span class="hljs-string">''</span></span> : v); v = v.replace(<span class="hljs-regexp"><span class="hljs-regexp">/(\r|\n)/g</span></span>, <span class="hljs-string"><span class="hljs-string">' &lt;br /&gt; '</span></span>); <span class="hljs-comment"><span class="hljs-comment">// make newlines v = v.replace(/((http)?s?(\:\/\/)?((www)?\.?[a-zA-Z0-9]+\.[a-zA-Z]+\/?\S+))/g, '&lt;a href="$1" target="_blank"&gt;$4&lt;/a&gt;'); //make links }; html = html.replace(new RegExp('%' + k + '%', 'g'), (typeof v === 'undefined' ? '' : v).toString().replace(/\$/g, '$')); }); html = html.replace(/\[(id[0-9]+)\|([^\]+]+)\]/, '&lt;a href="/$1"&gt;$2&lt;/a&gt;'); // [id|name] -&gt; &lt;a href="/id"&gt;name&lt;/a&gt; return html; }</span></span></code> </pre><br>  Those.  in the template, a construction of the form <i>% data% is</i> replaced with the value of the data variable.  This involved the original function.  I added a couple more things: generating links to a profile from records of the form <i>[id000000 | Ivan Ivanov]</i> , generating links from urls in the message text, and processing end-of-line characters (hyphenation). <br><br><img src="https://habrastorage.org/files/f76/e84/faf/f76e84faf47d4ab6971454ac147ca8be.png"><br>  <i><font color="#999999">Cropped screen of real discussion</font></i> <br><br><div class="spoiler">  <b class="spoiler_title">Full value.</b>  <b class="spoiler_title">Gently, dimensions.</b> <div class="spoiler_text"><img src="https://habrastorage.org/files/b19/117/494/b19117494ae74fc39e5243d50841c9fd.png"></div></div><br>  In general, everything is already working, but there is no main element - handles, having pulled that, we will see all these wonders.  And here again, it was not without the share of reverse engineering.  Vkontakte has a Wall class and a _repliesLoaded class method.  It is called when the comments are loaded, which is clearly hinted at by the name.  I replace this method with my own: <br><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> cloned_function = Wall._repliesLoaded; Wall._repliesLoaded = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">post, hl, replies, names, data</span></span></span><span class="hljs-function">) </span></span>{ cloned_function(post, hl, replies, names, data); wall_overloaded = <span class="hljs-literal"><span class="hljs-literal">true</span></span>; setTimeout(replace_html, <span class="hljs-number"><span class="hljs-number">300</span></span>); };</code> </pre><br>  Those.  technically, I call it the same, but immediately after I launch a function that draws an icon in the required freshly loaded comments, clicking on which we will see a pop-up window with a chain of comments. <br><br><h2>  What is the result? </h2><br>  The extension works.  Able to show comment chains with images and links.  Able to follow the appeared content and add a button to the chain, where necessary. <br><br><img src="https://habrastorage.org/files/cbf/ba7/14b/cbfba714b0aa48b8842914b0d414cbda.png"><br>  <i><font color="#999999">Screen comments chain with links, images and line breaks.</font></i> <br><br>  Does not know how to build parallel chains for cases where the discussion forks and then ‚Äúcollapses‚Äù again to the final comment.  Soon learn.  In the process of selecting the data structure. <br><br>  The frameworks are not smeared.  For someone it is a plus, for someone a minus.  I would very much like to throw my head up high and proudly declare: ‚ÄúAnd I don‚Äôt need them at all!‚Äù  But no.  Everything is more prosaic - I hardly know any local frameworks and batteries.  JS is a non-core language. <br><br>  <a href="https://github.com/zak-mamontov/vk_comments_chain/">Link to the source repository</a> .  I will be glad to forks and pull requests. <br><br>  <b>PS:</b> I did not pay for my developer account in Google.  I do not need it.  If anyone wants, can safely put the extension in the chrome web store.  If you also mention the author, it will be fine. <br><br>  <b>UPD:</b> Great news!  The extension has become available to everyone!  <a href="https://habrahabr.ru/users/maddad/" class="user_link">MadDAD</a> posted it in the chrome store - <a href="https://chrome.google.com/webstore/detail/vkcommentschain/ojhbaaoencoeidckdklfmglkkidmndeb"><b>link</b></a> . <br>  Cheers, comrades!  <a href="https://habrahabr.ru/users/maddad/" class="user_link">MadDAD</a> , thank you very much.  I am infinitely grateful. </div><p>Source: <a href="https://habr.com/ru/post/310146/">https://habr.com/ru/post/310146/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../310136/index.html">A change in PHP 7 breaking some servers on Ubuntu when upgrading from version 5</a></li>
<li><a href="../310138/index.html">Cisco OpenSOC - open source solution for creating your own cyber threat monitoring center</a></li>
<li><a href="../310140/index.html">IBM Watson: the cognitive system in cinema</a></li>
<li><a href="../310142/index.html">The final release of Angular 2</a></li>
<li><a href="../310144/index.html">We raise Owncloud from scratch with dynamic IP and Let's Encrypt. A thousand elephants! *</a></li>
<li><a href="../310148/index.html">CUBA Platform: Java RAD open source framework</a></li>
<li><a href="../310150/index.html">4C: Kyiv - Video Game Developers Conference</a></li>
<li><a href="../310152/index.html">.Net Core, WCF and ODATA clients</a></li>
<li><a href="../310156/index.html">GDB was a tough nut to crack.</a></li>
<li><a href="../310158/index.html">Duty of knowledge</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>