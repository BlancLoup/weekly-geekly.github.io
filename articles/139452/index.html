<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>[asio :: udp] Non-cross-platform behavior</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="So imagine the situation: we have a cross-platform server that should receive data via UDP. Armed with Asio, you create a socket, create a buffer for ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>[asio :: udp] Non-cross-platform behavior</h1><div class="post__text post__text-html js-mediator-article">  So imagine the situation: we have a cross-platform server that should receive data via UDP.  Armed with Asio, you create a socket, create a buffer for the received data, and start listening. <br><br><pre><code class="cpp hljs">udp::<span class="hljs-function"><span class="hljs-function">socket </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">receiver</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(ios, udp::endpoint(udp::v4(), port))</span></span></span></span>; <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> read_buf[buf_len]; udp::endpoint sender_point; receiver.receive_from(buffer(read_buf, <span class="hljs-keyword"><span class="hljs-keyword">sizeof</span></span>(read_buf)), sender_point);</code> </pre> <br><br>  What happens if the received datagram has more data than you allocated for the buffer? <br><a name="habracut"></a><br>  There will be a <b>mismatch of behavior</b> on WIN / LINUX platforms.  On Linux, the operation will go smoothly, it will be read as much as requested, the rest will be discarded.  On Win, you also get the read data, but afterwards you will also get an exception. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      And this is why this will happen: <br><br>  The function of the receive_from function comes down to executing the following code <br><br><pre> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">if</span></span></span><span class="hljs-meta"> defined(BOOST_WINDOWS) || defined(__CYGWIN__) int result = error_wrapper(::WSARecvFrom(s, bufs, recv_buf_count, &amp;bytes_transferred, &amp;recv_flags, addr, &amp;tmp_addrlen, 0, 0), ec); *addrlen = (std::size_t)tmp_addrlen; ... </span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">if</span></span></span><span class="hljs-meta"> (result != 0) return socket_error_retval; ec = boost::system::error_code(); return bytes_transferred; #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">else</span></span></span><span class="hljs-meta"> </span><span class="hljs-comment"><span class="hljs-meta"><span class="hljs-comment">// defined(BOOST_WINDOWS) || defined(__CYGWIN__) msghdr msg = msghdr(); init_msghdr_msg_name(msg.msg_name, addr); msg.msg_namelen = *addrlen; msg.msg_iov = bufs; msg.msg_iovlen = count; int result = error_wrapper(::recvmsg(s, &amp;msg, flags), ec); *addrlen = msg.msg_namelen; if (result &gt;= 0) ec = boost::system::error_code(); return result;</span></span></span></span></code> </pre> <br><br>  WSARecvFrom functions for Win and recvmsg for Linux are used to get data from the socket.  The result of the function (successful / not successful) is determined by the following function. <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">template</span></span> &lt;<span class="hljs-keyword"><span class="hljs-keyword">typename</span></span> ReturnType&gt; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">inline</span></span></span><span class="hljs-function"> ReturnType </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">error_wrapper</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(ReturnType return_value, boost::system::error_code&amp; ec)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">if</span></span></span><span class="hljs-meta"> defined(BOOST_WINDOWS) || defined(__CYGWIN__) ec = boost::system::error_code(WSAGetLastError(), boost::asio::</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">error</span></span></span><span class="hljs-meta">::get_system_category()); #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">else</span></span></span><span class="hljs-meta"> ec = boost::system::error_code(errno, boost::asio::</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">error</span></span></span><span class="hljs-meta">::get_system_category()); #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">endif</span></span></span><span class="hljs-meta"> return return_value; }</span></span></code> </pre> <br><br>  From the description of the function <a href="http://msdn.microsoft.com/en-us/library/windows/desktop/ms741686(v%3Dvs.85).aspx">WSARecvFrom</a> it follows that it returns the error status: <br><br><blockquote>  If no error occurs, WSARecvFrom returns zero.  Otherwise, it can be retrieved by WSAGetLastError. </blockquote><br><br>  One of which is just: <br><br><blockquote>  WSAEMSGSIZE <br>  This has been the case. </blockquote><br><br>  The functions of the <a href="http://www.opennet.ru/man.shtml%3Ftopic%3Drecvmsg%26category%3D2%26russian%3D0">recv</a> family return the number of bytes read successfully, or -1 in the case of an error and the status in errno.  But among her mistakes there is no similar to the above.  It turns out for Linux is not an error?  Not certainly in that way.  In the msvdr structure passed to the recvmsg function (namely, it is used in asio), the error code is written in the msg_flags field: <br><br><blockquote>  MSG_TRUNC <br>  Returns the actual packet length, even if it was larger than the buffer provided.  This flag can only be used with packet protocols. </blockquote><br><br>  Thus, one and the same operation in Win is regarded as erroneous, and on Linux as correct.  What is clearly not considered asio. <br><br>  One of the resulting difficulties is the impossibility under Win to determine that the datagram was not read all. <br><br>  A possible solution to this problem would be to use the <a href="http://www.boost.org/doc/libs/1_49_0/doc/html/boost_asio/reference/basic_datagram_socket/available.html">available</a> function.  But here we get even more frightening non-conformity.  This function on Win platforms returns the total number of data in a UDP socket (the sum of the data of all datagrams), and on Linux platforms, the size is only the first (the one that will be processed during the next reading) of the datagram. <br><br>  And here is a complete example of all of the above: <br><br>  <a href="">source</a> . <br><br><blockquote>  Output win: <br><br>  Exception: receive_from: The message sent to the datagram socket was larger than the internal message buffer or a different network parameter was exceeded.  It is also possible that the buffer for receiving the message was smaller than the size of the message. <br>  Some test <br>  Available: 36 <br>  Available: 18 <br>  Available: 0 <br></blockquote><br><blockquote>  output linux: <br><br>  Some test <br>  Available: 18 <br>  Available: 18 <br>  Available: 0 <br></blockquote><br><br>  Tested on boost versions 1.44 and 1.49. <br><br>  Thanks for attention. </div><p>Source: <a href="https://habr.com/ru/post/139452/">https://habr.com/ru/post/139452/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../139445/index.html">Mini-report from the international conference Cloud Services Russia 2012</a></li>
<li><a href="../139447/index.html">Android Robot has become more popular Opera</a></li>
<li><a href="../139449/index.html">New life of your postal addresses in Rambler-Mail</a></li>
<li><a href="../139450/index.html">Top up in the ASA lineup</a></li>
<li><a href="../139451/index.html">Digest of new materials in Russian MSDN for February</a></li>
<li><a href="../139453/index.html">Javascript malware identification</a></li>
<li><a href="../139454/index.html">Implementing MVC Pattern for PyQt</a></li>
<li><a href="../139455/index.html">Save the gnomes from the terrible, but fair Troll</a></li>
<li><a href="../139458/index.html">New PyCharm 2.1 Early Access Preview has been released</a></li>
<li><a href="../139461/index.html">Proper hosting for MODx do it yourself</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>