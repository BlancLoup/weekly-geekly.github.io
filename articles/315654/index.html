<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>File system, cheap and fast</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Developers often have to deal with files that are a tree structure: XML, JSON, YAML, all sorts of markup languages ‚Äã‚Äãlike Markdown or Org-mode. Facili...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>File system, cheap and fast</h1><div class="post__text post__text-html js-mediator-article"><p>  Developers often have to deal with files that are a tree structure: XML, JSON, YAML, all sorts of markup languages ‚Äã‚Äãlike Markdown or Org-mode.  Facilitating our lives in general, such files tend to grow uncontrollably, at some point turning from solution into a problem. </p><br><p>  The standard solution to this problem is splitting into smaller files.  This, of course, works, but is not always convenient. </p><br><p>  But there is an alternative, about which - below. </p><a name="habracut"></a><br><h1 id="org-mode-i-ego-razmetka">  org-mode and its markup. </h1><br><p>  Perhaps you should first set out my problem.  I use Emax and ‚Äî like many Emax users ‚Äî for writing almost all of my documents, notes, work diary and task lists, I use the markup language <a href="https://ru.wikipedia.org/wiki/Org-mode">org-mode</a> .  The document in this markup looks like this: </p><br><pre><code class="hljs kotlin">...      ... &gt; cat tests/simple.org document section * headline <span class="hljs-number"><span class="hljs-number">1</span></span> headline section <span class="hljs-number"><span class="hljs-number">1</span></span> ** <span class="hljs-keyword"><span class="hljs-keyword">inner</span></span> headline <span class="hljs-number"><span class="hljs-number">1</span></span> some <span class="hljs-keyword"><span class="hljs-keyword">inner</span></span> section <span class="hljs-number"><span class="hljs-number">1</span></span> some <span class="hljs-keyword"><span class="hljs-keyword">inner</span></span> section <span class="hljs-number"><span class="hljs-number">1</span></span>-<span class="hljs-number"><span class="hljs-number">2</span></span> ** <span class="hljs-keyword"><span class="hljs-keyword">inner</span></span> headline <span class="hljs-number"><span class="hljs-number">2</span></span> <span class="hljs-keyword"><span class="hljs-keyword">inner</span></span> section <span class="hljs-number"><span class="hljs-number">2</span></span> ** <span class="hljs-keyword"><span class="hljs-keyword">inner</span></span> headline <span class="hljs-number"><span class="hljs-number">3</span></span> *** <span class="hljs-keyword"><span class="hljs-keyword">inner</span></span> <span class="hljs-keyword"><span class="hljs-keyword">inner</span></span> headline <span class="hljs-number"><span class="hljs-number">1</span></span> * headline <span class="hljs-number"><span class="hljs-number">2</span></span> section text <span class="hljs-number"><span class="hljs-number">2</span></span></code> </pre> <br><p>  One of my documents has grown to several hundred subheadings of various depths of nesting, and for all these headings I regularly stroll through scripts in search of different information.  I didn't want to parse the document into several files, because  it is still easier to process one file between machines or any script.  But it was absolutely impossible to continue living like this. </p><br><p>  And then it occurred to me that it would be great to walk through my file as directories, using, say, the standard Unix <code>cd headline1</code> or <code>cd ..</code> , <code>ls -l</code> and <code>cat section</code> . </p><br><p>  In other words, I wanted to be able to represent a tree of headings and text sections in the form of an ordinary tree of directories and files.  In terms of the same Unixes, this desire sounds like this: mount some kind of specialized file system. </p><br><p>  Of course, writing a full-fledged file system for Linux is a long, ungrateful business, and certainly not worth it in such rare cases. </p><br><h1 id="fuse">  FUSE </h1><br><p>  However, nowadays nobody does it anyway, that is, since ten years ago the <a href="https://ru.wikipedia.org/wiki/FUSE_(%25D0%25BC%25D0%25BE%25D0%25B4%25D1%2583%25D0%25BB%25D1%258C_%25D1%258F%25D0%25B4%25D1%2580%25D0%25B0)">FUSE</a> module was included in Linux, which allows you to create file systems as an ordinary user process, to which all those connected with the mounted file system are routed to the kernel system calls. </p><br><p>  With the help of FUSE, a lot of different file systems were written, from toy file systems that assemble, for example, Wikipedia articles, to quite serious parts of modern Linux like the same Gnome.  Thus, FUSE has become a mandatory element of popular distributions. </p><br><p>  Even more pleasant work with FUSE is made by the fact that nowadays very trivial wrappers are available in high-level languages ‚Äã‚Äãlike Python, Ruby, Java and many others, i.e.  Your own file system can be done in just two or three hours. </p><br><h1 id="fusepy">  fusepy </h1><br><p>  Specifically on Python, there are even a few wrappers around <code>libfuse</code> (the client part of FUSE), but most of all I liked the <a href="https://github.com/terencehonles/fusepy">fusepy</a> project: the project code is very simple and understandable, except for the examples on GitHub and the source code, I didn‚Äôt need anything. </p><br><p>  The <code>fusepy</code> based file system comes down to redefining the methods of the <code>fuse.Operations</code> class, each of which corresponds to a system call. </p><br><p>  For non-redefined system calls, there is either a reasonable default behavior or a standard error. </p><br><h1 id="orgfuse">  Orgfuse </h1><br><p>  Actually, the specific file format that you want to represent in the form of a tree of directories and files is not so important.  In the case of the <code>org-mode</code> markup, I did not like any of the available parsers for Python, and I just wrote <a href="https://github.com/vkazanov/toy-orgfuse/blob/master/orgfuse.py">my own</a> .  The parser passes through the specified file, creating a tree reflecting the structure of the document. </p><br><p>  The parse tree of the markup file is then converted to <a href="https://github.com/vkazanov/toy-orgfuse/blob/master/orgfuse.py">another tree</a> , reflecting the files and directories that the file system user will see. </p><br><p>  To work with the last tree, it was enough to implement four system calls ( <code>open</code> , <code>read</code> , <code>readdir</code> , <code>getattr</code> ), each of which took literally a <a href="https://github.com/vkazanov/toy-orgfuse/blob/master/orgfuse.py">few lines of</a> Python <a href="https://github.com/vkazanov/toy-orgfuse/blob/master/orgfuse.py">code</a> : </p><br><pre> <code class="hljs python"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">FuseOperations</span></span></span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">(Operations)</span></span></span><span class="hljs-class">:</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">__init__</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self, tree)</span></span></span><span class="hljs-function">:</span></span> self.tree = tree self.fd = <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">open</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self, path, flags)</span></span></span><span class="hljs-function">:</span></span> self.fd += <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> self.fd <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">read</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self, path, size, offset, fh)</span></span></span><span class="hljs-function">:</span></span> node = self.tree.find_path(path) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> node <span class="hljs-keyword"><span class="hljs-keyword">is</span></span> <span class="hljs-keyword"><span class="hljs-keyword">None</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">raise</span></span> FuseOSError(EIO) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> node.content[offset:offset + size] <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">readdir</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self, path, fh)</span></span></span><span class="hljs-function">:</span></span> node = self.tree.find_path(path) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> node <span class="hljs-keyword"><span class="hljs-keyword">is</span></span> <span class="hljs-keyword"><span class="hljs-keyword">None</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">raise</span></span> FuseOSError(EROFS) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> [<span class="hljs-string"><span class="hljs-string">'.'</span></span>, <span class="hljs-string"><span class="hljs-string">'..'</span></span>] + [child <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> child <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> node.children] <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getattr</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self, path, fh=None)</span></span></span><span class="hljs-function">:</span></span> node = self.tree.find_path(path) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> node <span class="hljs-keyword"><span class="hljs-keyword">is</span></span> <span class="hljs-keyword"><span class="hljs-keyword">None</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">raise</span></span> FuseOSError(ENOENT) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> node.get_attrs()</code> </pre> <br><p>  The final script works like this: </p><br><pre> <code class="hljs kotlin">...      ... &gt; mkdir mount &gt; python orgfuse.py tests/simple.org mount/ ...      ... &gt; tree mount mount/ ‚îú‚îÄ‚îÄ headline <span class="hljs-number"><span class="hljs-number">1</span></span> ‚îÇ  ‚îú‚îÄ‚îÄ <span class="hljs-keyword"><span class="hljs-keyword">inner</span></span> headline <span class="hljs-number"><span class="hljs-number">1</span></span> ‚îÇ  ‚îÇ  ‚îî‚îÄ‚îÄ section ‚îÇ  ‚îú‚îÄ‚îÄ <span class="hljs-keyword"><span class="hljs-keyword">inner</span></span> headline <span class="hljs-number"><span class="hljs-number">2</span></span> ‚îÇ  ‚îÇ  ‚îî‚îÄ‚îÄ section ‚îÇ  ‚îú‚îÄ‚îÄ <span class="hljs-keyword"><span class="hljs-keyword">inner</span></span> headline <span class="hljs-number"><span class="hljs-number">3</span></span> ‚îÇ  ‚îÇ  ‚îî‚îÄ‚îÄ <span class="hljs-keyword"><span class="hljs-keyword">inner</span></span> <span class="hljs-keyword"><span class="hljs-keyword">inner</span></span> headline <span class="hljs-number"><span class="hljs-number">1</span></span> ‚îÇ  ‚îî‚îÄ‚îÄ section ‚îú‚îÄ‚îÄ headline <span class="hljs-number"><span class="hljs-number">2</span></span> ‚îÇ  ‚îî‚îÄ‚îÄ section ‚îî‚îÄ‚îÄ section <span class="hljs-number"><span class="hljs-number">6</span></span> directories, <span class="hljs-number"><span class="hljs-number">5</span></span> files</code> </pre> <br><p>  All this miracle takes about two hundred lines or 3-4 hours of my lazy evening work, copes with my small task remarkably. </p><br><p>  Installation instructions and code, as usual, can be found <a href="https://github.com/vkazanov/toy-orgfuse/">Github</a> . </p><br><p>  If anyone is interested in converting a prototype into something digestible, with the ability to edit files and support more formats, I will be glad to talk. </p></div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <p>Source: <a href="https://habr.com/ru/post/315654/">https://habr.com/ru/post/315654/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../315640/index.html">Cleaning the air in the data center as a way to extend the life of the equipment and reduce costs</a></li>
<li><a href="../315642/index.html">Alistair Coburn: Team Development and Agile</a></li>
<li><a href="../315646/index.html">Ceph storage cluster on VMWare in 10 minutes</a></li>
<li><a href="../315648/index.html">Cameras, HUD and WTF: improve usability of the next VR game</a></li>
<li><a href="../315652/index.html">JetBrains Night in Moscow. Video. First steps with TeamCity DSL</a></li>
<li><a href="../315656/index.html">Tracking Problems: How Mobile Workers Cheat Companies Due to Control Technology Deficiencies</a></li>
<li><a href="../315660/index.html">Some subtleties of using Service Workers</a></li>
<li><a href="../315664/index.html">Configuring Virtual Private Network on AWS EC2 from OpenVPN on Linux</a></li>
<li><a href="../315666/index.html">How Phoenix Kills React</a></li>
<li><a href="../315668/index.html">Code for which I still feel ashamed</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>