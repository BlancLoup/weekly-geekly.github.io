<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Replacement of analog adjustment with digital one in laboratory power supply HY3005D</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="The article will discuss the replacement of standard potentiometers with EC11 mechanical encoders (accumulating angle sensors) in the Mastech HY3005D ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Replacement of analog adjustment with digital one in laboratory power supply HY3005D</h1><div class="post__text post__text-html js-mediator-article">  The article will discuss the replacement of standard potentiometers with EC11 mechanical encoders (accumulating angle sensors) in the Mastech HY3005D power supply using a PIC16F1829 microcontroller and a 74HC595 shift register with a real-time DAC on a R2R resistor matrix <br><a name="habracut"></a><br><h4>  Foreword </h4><br>  A few years ago, I purchased the Mastech HY3005D power supply.  Not so long ago, there were problems with voltage regulation - the graphite coating of the rheostats was worn out and setting the required voltage became a difficult task.  There were no suitable rheostats, and I decided not to buy similar ones, but to change the method of adjustment. <br>  The level of output voltage and current is set by the reference voltage supplied to the operational amplifiers.  Thus, you can completely get rid of the potentiometers by replacing them with a DAC capable of delivering a voltage in the desired range. <br>  In the microchip catalog, I could not find a suitable microcontroller with two DACs on board, and the external DACs have not a small price tag and too much extra functionality.  Therefore, acquired the shift registers 74HC595 and resistors for the matrix R2R.  The PIC16F1829 microcontroller was already in stock. <br>  To be able to return to the original scheme, all changes are minimized - replacing the adjustment unit performed on a separate board. <br><br><h4>  Description of work </h4><br>  The scheme is based on the <a href="http://ww1.microchip.com/downloads/en/DeviceDoc/41440A.pdf">PIC16F1829</a> microcontroller operating at 32 MHz.  The clock frequency is set by the built-in clock generator, according to the data sheet it is not too accurate, but for this scheme it is not critical.  The advantage of this MC is the presence of pull-up resistors on all digital inputs and two MSSP modules implementing SPI.  All 18 logical outputs of the microcontroller are used. <br>  On four shift registers <a href="https://www.nxp.com/documents/data_sheet/74HC_HCT595.pdf">74HC595</a> and R2R matrices, two 16-bit DACs are implemented.  The advantages of this register include the presence of a separate shift register and storage register.  This allows you to write data to the register without disturbing the current output values.  The R2R matrix is ‚Äã‚Äãassembled on resistors with an accuracy of 1%.  It is worth noting that sample measurements showed an error of no more than 10 ohms.  It was originally planned to use 3 registers, but when setting up the board it seemed to me that this was not a good solution, besides it was necessary to add nibbles. <br>  The pull-up resistors built into the MC are activated at all inputs and simplify the circuit.  All outputs from the encoders are connected directly to the MK pins, only 4 encoders each with two pins for the rotation sensor itself and one for the integrated button.  A total of 12 pins MK is used to process input data.  The contact bounce is smoothed with a capacity of 100 nF.  After changing the values ‚Äã‚Äãof 16-bit current and voltage buffers in accordance with the input data from the encoders, the values ‚Äã‚Äãare transferred to the 74HC595 shift registers via SPI.  To reduce data transfer time, two SPI modules are used, which allows data to be transmitted simultaneously for current and voltage.  After the data is transferred to the register, the command to transfer data from the shift buffer to the storage buffer is sent.  Register outputs are connected to the R2R matrix acting as a divider for the DAC.  The output voltage from the matrix is ‚Äã‚Äãtransmitted to the inputs of the operational amplifiers. <br>  Buttons embedded in the encoders set the values ‚Äã‚Äãto minimum (soft adjustment encoder button) or maximum (coarse adjustment encoder button), respectively, for current or voltage. <br><br><h4>  Scheme </h4><br>  On the Internet, I did not find a scheme that completely coincides with mine, so I took the first link.  Made corrections for identified inconsistencies and then added its own changes.  TinyCAD drew adjustment block scheme - download the file <a href="https://docs.google.com/uc%3Fid%3D0B2AyAaX6M-XNUjd6NTU3dVJRV2s%26export%3Ddownload">HY3005D-regulator.dsn</a> . 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <div class="spoiler">  <b class="spoiler_title">Original</b> <div class="spoiler_text"><img src="https://habrastorage.org/files/c04/fe1/917/c04fe19174fe4b469bd80b9a6c45139c.gif"><br></div></div><br><div class="spoiler">  <b class="spoiler_title">After the found inaccuracies</b> <div class="spoiler_text"><img src="https://habrastorage.org/files/484/820/123/4848201239bc4dfd95b06a98798a6289.gif"><br></div></div><br>  Final scheme after revision <br><img src="https://habrastorage.org/files/b3e/41c/9f1/b3e41c9f1ed941efb654903269157775.gif"><br>  Remote unit with adjustment (highlighted in red) made a separate scheme. <br><img src="https://habrastorage.org/files/306/7ff/1b6/3067ff1b6f29462ba6d4adffad1526f7.png"><br>  A digital voltmeter with a display on the front panel is connected to the J3 connector (it is not in the diagrams). <br><br><h4>  Used components </h4><br>  Below is a list of used components (the case is shown in brackets).  All purchased at different times in China.  It is important to use LEDs with the same characteristics as the native ones, since  they stand consistently in the output circuit of operational amplifiers (I took the same ones that were on my motherboard). <br><ul><li>  U1: PIC16F1829I / ML microcontroller (QFN) </li><li>  U2 - U5: shift register 74HC595BQ (DHVQFN16 or SOT-763) </li><li>  U6: linear voltage regulator AMS1117 to 5V (SOT-223) </li><li>  RE1 - RE4: EC11 Mechanical Accumulation Angle Sensor </li><li>  R1, R2 and R2R arrays: 1 and 2 kŒ© resistors (SMD 0402) </li><li>  C1 - C12, C14-C17: GRM21BR71E104KA01L 100nF ceramic capacitors (SMD 0805) </li><li>  C13: tantalum capacitor 22¬µF 16V (tiv B) </li><li>  D1, D2: front-panel voltage / current indication LEDs </li></ul><br><br><h4>  Pay </h4><br>  <a href="https://docs.google.com/uc%3Fid%3D0B2AyAaX6M-XNZTZTNlpOYk5ET2s%26export%3Ddownload">Plate wired</a> to Sprint Layout 6 - download the file <a href="https://docs.google.com/uc%3Fid%3D0B2AyAaX6M-XNZTZTNlpOYk5ET2s%26export%3Ddownload">HY3005D-regulator.lay6</a> .  Unfortunately, the original, on which I made my version, was not preserved, in lay6 format already with the corrections revealed during the assembly: <br><br><ol><li>  A jumper near the interface for flashing was added to the disconnection of the smooth current control encoder;  containers that bounce contacts did not allow the controller to be flashed </li><li>  Added missing jumpers for ground between sides </li><li>  Moved the stabilizing assembly to 5V on the other side to reduce the through jumpers </li><li>  Added smoothing capacitors on the power line ( <a href="https://geektimes.ru/post/272456/">discussion</a> ) </li></ol><br><div class="spoiler">  <b class="spoiler_title">Photo after etching and drilling (first version)</b> <div class="spoiler_text"><img src="https://habrastorage.org/getpro/geektimes/post_images/593/555/618/593555618b46cfb0ea30bc3fb40f31e6.jpg"><br><img src="https://habrastorage.org/getpro/geektimes/post_images/6ec/ebc/c47/6ecebcc4789fd48ab80a8ef7f690049a.jpg"><br></div></div><br>  Made using film photoresist.  For a long time I suffered with a fine register setting.  In the last version there were small flaws that had to be cleaned after etching.  But in general, the fee was a success.  There are still not enough two jumpers to connect the earth on the front and back sides. <br><br><div class="spoiler">  <b class="spoiler_title">After entering the identified problems (second version)</b> <div class="spoiler_text"><img src="https://habrastorage.org/files/450/175/2fe/4501752fed894a78be212939a76b2794.png"><br><img src="https://habrastorage.org/files/a69/089/610/a6908961064b4f25984f5c1ee53dd8b6.png"><br>  Three 0 Œ© resistors in the SMD 0805 package were used as jumpers. <br></div></div><br><div class="spoiler"> <b class="spoiler_title">Photo after soldering and installing in place</b> <div class="spoiler_text"><img src="https://habrastorage.org/getpro/geektimes/post_images/be4/678/8d1/be46788d12079fd0ca782c1f084cf166.jpg"><br><br>  On the left side is the power supply itself.  In the right - the front panel face down.  The green wire from the upper left corner to the lower right is an additional 12V power supply. <br></div></div><br>  As you can see, the changes are minimal, all the old connectors remain unchanged.  I had to add a separate food, because  the only voltage coming to the 2.5V adjustment board for the native divider is not suitable.  If on the main board of the power supply you remove the 2.5V Zener diode (V5A) and put the jumper in place of the resistor (R1A), you can do without an additional summing up of 12V power supply. <br><br><h4>  Firmware </h4><br>  C code for the XC8 compiler.  Stitched original PICkit 3. <br><br><div class="spoiler">  <b class="spoiler_title">config.h</b> <div class="spoiler_text"><pre><code class="cs hljs"><span class="hljs-comment"><span class="hljs-comment">// PIC16F1829 Configuration Bit Settings // 'C' source line config statements #include &lt;xc.h&gt; // #pragma config statements should precede project file includes. // Use project enums instead of #define for ON and OFF. // CONFIG1 #pragma config FOSC = INTOSC // Oscillator Selection (INTOSC oscillator: I/O function on CLKIN pin) #pragma config WDTE = OFF // Watchdog Timer Enable (WDT disabled) #pragma config PWRTE = OFF // Power-up Timer Enable (PWRT disabled) #pragma config MCLRE = OFF // MCLR Pin Function Select (MCLR/VPP pin function is digital input) #pragma config CP = OFF // Flash Program Memory Code Protection (Program memory code protection is disabled) #pragma config CPD = OFF // Data Memory Code Protection (Data memory code protection is disabled) #pragma config BOREN = OFF // Brown-out Reset Enable (Brown-out Reset disabled) #pragma config CLKOUTEN = OFF // Clock Out Enable (CLKOUT function is disabled. I/O or oscillator function on the CLKOUT pin) #pragma config IESO = OFF // Internal/External Switchover (Internal/External Switchover mode is disabled) #pragma config FCMEN = OFF // Fail-Safe Clock Monitor Enable (Fail-Safe Clock Monitor is disabled) // CONFIG2 #pragma config WRT = OFF // Flash Memory Self-Write Protection (Write protection off) #pragma config PLLEN = OFF // PLL Enable (4x PLL disabled) #pragma config STVREN = ON // Stack Overflow/Underflow Reset Enable (Stack Overflow or Underflow will cause a Reset) #pragma config BORV = LO // Brown-out Reset Voltage Selection (Brown-out Reset Voltage (Vbor), low trip point selected.) #pragma config LVP = OFF // Low-Voltage Programming Enable (High-voltage on MCLR/VPP must be used for programming)</span></span></code> </pre> <br></div></div><br><div class="spoiler">  <b class="spoiler_title">main.c</b> <div class="spoiler_text"><pre> <code class="cs hljs"><span class="hljs-meta"><span class="hljs-meta">#include "config.h" #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> _XTAL_FREQ 32000000 #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">pragma</span></span></span><span class="hljs-meta"> intrinsic(_delay) extern void _delay(unsigned long); #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> __delay_us(x) _delay((unsigned long)((x)*(_XTAL_FREQ/4000000.0))) #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> __delay_ms(x) _delay((unsigned long)((x)*(_XTAL_FREQ/4000.0))) #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> TransferNotDone !(SSP2STAT&amp;0b00000001) #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> StoreAll LATA4 #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> ResetAll LATC6 #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> VoltageSharpCHA RC1 #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> VoltageSharpCHB RC0 #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> VoltageSharpBTN RA2 #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> VoltageSmoothCHA RB5 #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> VoltageSmoothCHB RB4 #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> VoltageSmoothBTN RC2 #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> CurrentSharpCHA RC5 #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> CurrentSharpCHB RC4 #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> CurrentSharpBTN RC3 #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> CurrentSmoothCHA RA1 #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> CurrentSmoothCHB RA0 #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> CurrentSmoothBTN RA3 #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> VoltageRateSharp 0x0100 #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> VoltageRateSmooth 0x0010 #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> CurrentRateSharp 0x0040 #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> CurrentRateSmooth 0x0004 #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> VoltageMax 0xC000 #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> CurrentMax 0x5000 #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> VoltageMin 0x0000 #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> CurrentMin 0x0000 #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> VoltageStart 0x1E00 #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> CurrentStart CurrentMax unsigned short VoltageBuff; unsigned short CurrentBuff; void interrupt tc_int() { }; void SendData() { SSP1BUF = VoltageBuff&gt;&gt;8; SSP2BUF = CurrentBuff&gt;&gt;8; while ( TransferNotDone ); SSP1BUF = VoltageBuff; SSP2BUF = CurrentBuff; while ( TransferNotDone ); StoreAll = 1; StoreAll = 0; }; void main() { // Configure oscillator for 32MHz // 76543210 OSCCON = 0b11110000; //B1 // Enable individual pull-ups // 76543210 OPTION_REG = 0b01111111; //B1 // Configure analog port (1 - enable, 0 - disable) // 76543210 ANSELA = 0b00000000; //B3 ANSELB = 0b00000000; //B3 ANSELC = 0b00000000; //B3 // Reset latch // 76543210 LATA = 0b00000000; //B2 LATB = 0b00000000; //B2 LATC = 0b00000000; //B2 // Alternate pin function (set SDO2 on RA5) // 76543210 APFCON0 = 0b00000000; //B2 APFCON1 = 0b00100000; //B2 // Configure digital port (1 - input, 0 - output) // 76543210 TRISA = 0b00001111; //B1 TRISB = 0b00110000; //B1 TRISC = 0b00111111; //B1 // Configure input level (1 - CMOS, 0 - TTL) INLVLA = 0b11000000; //B7 INLVLB = 0b00001111; //B7 INLVLC = 0b00000000; //B7 // Configure individual pull-ups (1 - enable, 0 - disable) // 76543210 WPUA = 0b00111111; //B4 WPUB = 0b11110000; //B4 WPUC = 0b11111111; //B4 ResetAll = 0; ResetAll = 1; // Configure SPI in master mode // 76543210 //SSP1ADD = 0b00000000; //B4 SSP1STAT = 0b01000000; //B4 SSP1CON3 = 0b00000000; //B4 SSP1CON1 = 0b00100000; //B4 //SSP1ADD = 0b00000000; //B4 SSP2STAT = 0b01000000; //B4 SSP2CON3 = 0b00000000; //B4 SSP2CON1 = 0b00100000; //B4 VoltageBuff = VoltageStart; CurrentBuff = CurrentStart; __delay_ms(50); SendData(); while ( 1 ) { </span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">if</span></span></span><span class="hljs-meta"> ( !VoltageSharpCHA ) { </span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">if</span></span></span><span class="hljs-meta"> ( VoltageSharpCHB ) { VoltageBuff-=VoltageRateSharp; </span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">if</span></span></span><span class="hljs-meta"> ( VoltageBuff &gt; VoltageMax ) VoltageBuff = VoltageMin; } </span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">else</span></span></span><span class="hljs-meta"> { VoltageBuff+=VoltageRateSharp; </span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">if</span></span></span><span class="hljs-meta"> ( VoltageBuff &gt; VoltageMax ) VoltageBuff = VoltageMax; } while ( !VoltageSharpCHA ); SendData(); } </span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">if</span></span></span><span class="hljs-meta"> ( !VoltageSmoothCHA ) { </span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">if</span></span></span><span class="hljs-meta"> ( VoltageSmoothCHB ) { VoltageBuff-=VoltageRateSmooth; </span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">if</span></span></span><span class="hljs-meta"> ( VoltageBuff &gt; VoltageMax ) VoltageBuff = VoltageMin; } </span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">else</span></span></span><span class="hljs-meta"> { VoltageBuff+=VoltageRateSmooth; </span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">if</span></span></span><span class="hljs-meta"> ( VoltageBuff &gt; VoltageMax ) VoltageBuff = VoltageMax; } while ( !VoltageSmoothCHA ); SendData(); } </span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">if</span></span></span><span class="hljs-meta"> ( !CurrentSharpCHA ) { </span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">if</span></span></span><span class="hljs-meta"> ( CurrentSharpCHB ) { CurrentBuff-=CurrentRateSharp; </span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">if</span></span></span><span class="hljs-meta"> ( CurrentBuff &gt; CurrentMax ) CurrentBuff = CurrentMin; } </span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">else</span></span></span><span class="hljs-meta"> { CurrentBuff+=CurrentRateSharp; </span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">if</span></span></span><span class="hljs-meta"> ( CurrentBuff &gt; CurrentMax ) CurrentBuff = CurrentMax; } while ( !CurrentSharpCHA ); SendData(); } </span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">if</span></span></span><span class="hljs-meta"> ( !CurrentSmoothCHA ) { </span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">if</span></span></span><span class="hljs-meta"> ( CurrentSmoothCHB ) { CurrentBuff-=CurrentRateSmooth; </span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">if</span></span></span><span class="hljs-meta"> ( CurrentBuff &gt; CurrentMax ) CurrentBuff = CurrentMin; } </span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">else</span></span></span><span class="hljs-meta"> { CurrentBuff+=CurrentRateSmooth; </span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">if</span></span></span><span class="hljs-meta"> ( CurrentBuff &gt; CurrentMax ) CurrentBuff = CurrentMax; } while ( !CurrentSmoothCHA ); SendData(); } </span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">if</span></span></span><span class="hljs-meta"> ( !VoltageSharpBTN ) { VoltageBuff = VoltageMax; while ( !VoltageSharpBTN ); SendData(); } </span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">if</span></span></span><span class="hljs-meta"> ( !VoltageSmoothBTN ) { VoltageBuff = VoltageMin; while ( !VoltageSmoothBTN ); SendData(); } </span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">if</span></span></span><span class="hljs-meta"> ( !CurrentSharpBTN ) { CurrentBuff = CurrentMax; while ( !CurrentSharpBTN ); SendData(); } </span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">if</span></span></span><span class="hljs-meta"> ( !CurrentSmoothBTN ) { CurrentBuff = CurrentMin; while ( !CurrentSmoothBTN ); SendData(); } }; }</span></span></code> </pre><br></div></div><br>  For minimum values ‚Äã‚Äãof VoltageMin and CurrentMin, 1 is set, since  at 0 in the buffer, the adjustment stops working until I understand where the problem is.  Rates * Rate * selected multiples and most convenient in my opinion.  For the SendData method, I did not pass variables as parameters to save machine instructions and memory.  The low voltage (LVP) firmware mode must be turned off, otherwise the RA3 will not work as a digital input.  Interrupts are not used, the tc_int method is present in the code so that the compiler places the main unit at the beginning of the EPROM. <br>  For the firmware, it is enough to remove the jumpers, connect the PICkit 3 (or another programmer) and execute the firmware.  In the first version there were no jumpers on CLK and DAT, so I had to pull out the smoothing capacitors, flash and then solder them back. <br>  <b>UPD:</b> After installing additional capacitors on the supply line, the problem with exit from the zero position of the counter disappeared.  Just had to change the direction of rotation.  Apparently, the noise from the AMS1117 rectifier made it difficult to correctly recognize the status of the encoders.  Additionally added setting of starting values, now the default voltage is set to 5 volts (the current is still at maximum).  Before the first data transfer to the registers, a delay of 50ms was inserted (the delay value was taken with a large margin) to wait for the SPI modules to initialize. <br><br><h4>  Output Voltage Characteristics </h4><br>  After the final assembly of the device, voltages were measured between pins J4.1 - J4.2 (voltage regulation) and J4.1 - J4.7 (current regulation).  According to the data obtained, graphs (below under the spoiler) of the value / voltage dependencies for the DAC are plotted. <br><div class="spoiler">  <b class="spoiler_title">Charts</b> <div class="spoiler_text"><img src="https://habrastorage.org/files/2d2/2ca/05e/2d22ca05eaf84ab9bebb6ae56a42c00c.png"><br><img src="https://habrastorage.org/files/ef9/598/de4/ef9598de451f4cec96892e3486ada893.png"><br></div></div><br>  The calculated stress values ‚Äã‚Äãare obtained by the formula (U * D) / (2 ^ K), where <br>  U is the voltage at the output of the register, taking into account the dividers in the main circuit (for the current DAC - 4950 mV, for the DAC voltage - 3550 mV); <br>  D is the decimal value of the DAC counter; <br>  K - bit width of the DAC (16 bit) <br><br><h4>  What can be improved </h4><br><ul><li>  add timer saves </li><li>  tie standard values ‚Äã‚Äãto the encoder buttons, for example, for voltage: 3.3;  5.0;  7.5;  12V </li><li>  for protection against an unknown value at startup, it is better to connect the MR to 1, and pull the OE through a resistor to 1 and reset it to 0 after initializing the MC. </li><li>  replace DAC with PWM with a smoothing chain (suggested by <a href="https://geektimes.ru/users/lamptester/" class="user_link">LampTester</a> <a href="https://geektimes.ru/post/272456/">here</a> ) </li></ul></div><p>Source: <a href="https://habr.com/ru/post/391617/">https://habr.com/ru/post/391617/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../391605/index.html">The discovery of a new class of bacteria can lead to the creation of a medicine for caries.</a></li>
<li><a href="../391609/index.html">All space research missions on one infographic</a></li>
<li><a href="../391611/index.html">Chicken Period Park: Scientists Raised Dinosaur Foot in Chicken</a></li>
<li><a href="../391613/index.html">The US authorities want to access data from WhatsApp users. Messenger introduces voice traffic encryption</a></li>
<li><a href="../391615/index.html">Photos and videos of a solar eclipse March 9, 2016</a></li>
<li><a href="../391619/index.html">Western Digital introduced HDD priced at $ 46 and a volume of 314 GB specifically for the Raspberry Pi per day Pi</a></li>
<li><a href="../391621/index.html">VSHBI Round Table: Gaming Industry Trends</a></li>
<li><a href="../391623/index.html">Stolen technologies: the ‚Äúflying fortress‚Äù of the USSR</a></li>
<li><a href="../391631/index.html">M-commerce grows 300% faster than E-commerce</a></li>
<li><a href="../391633/index.html">Dell Alienware 17 R3 laptop video review</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>