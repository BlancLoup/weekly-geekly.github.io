<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Attack of the clones. How to deal with code duplication?</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Despite the fact that problems associated with duplication of code are mentioned quite often, the relevance of these problems from year to year remain...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Attack of the clones. How to deal with code duplication?</h1><div class="post__text post__text-html js-mediator-article"><p>  Despite the fact that problems associated with duplication of code are mentioned quite often, the relevance of these problems from year to year remains almost unchanged.  In many popular projects, the number of clones is measured in hundreds or even thousands. </p><br><p>  In this article, I would like to remind you what software clones are, what problems they entail, and how they can be dealt with.  The article provides examples of refactoring real clones from the popular Spring framework.  The tools used are <strong>Java 8</strong> , IDE <strong>IntelliJ IDEA</strong> 2017.1 and the <strong>Duplicate Detector</strong> 1.1 plugin. </p><br><p><img src="https://habrastorage.org/getpro/habr/post_images/ac1/865/9d0/ac18659d087ec5bbc4261c74f732fabb.png"></p><a name="habracut"></a><br><h2 id="otkuda-berutsya-klony">  Where do clones come from? </h2><br><p>  In essence, clones are just similar source code fragments.  Mostly they appear when copying, even though copying is notoriously bad practice.  Of course, this is not the only possible cause of the appearance of clones, there are other, more objective ones.  For example, the programming language itself may not be expressive enough, or the developer may not have the opportunity to change the source code accordingly. </p><br><p>  The following main causes of clones can be distinguished: </p><br><ul><li>  Intentional copying of program fragments </li><li>  Reuse complex API </li><li>  Reimplement existing functionality </li><li>  Weak expressiveness of the language used </li><li>  Lack of rights to modify the source code </li></ul><br><h2 id="nuzhno-li-borotsya-s-klonami">  Do I need to fight clones? </h2><br><p>  On the one hand, the duplicate code has a number of obvious flaws.  Such code is more difficult to change and develop, because of duplicates, the size of the project increases and its understanding is complicated.  In addition, when copying, there are also risks of spreading errors from the original fragments. </p><br><p>  On the other hand, the removal of duplicates can also lead to errors, especially if for this it is necessary to make significant changes in the text of the program.  However, the main argument against deleting clones is that such deletion often leads to an increase in the number of dependencies.  Quite interesting about this is written in the article " <a href="http://yosefk.com/blog/redundancy-vs-dependencies-which-is-worse.html">Redundancy vs dependencies: which is worse?</a> ". </p><br><hr><br><p><img src="https://habrastorage.org/getpro/habr/post_images/dee/462/b8c/dee462b8cdfb296d415c43920fec57e2.png"></p><br><hr><br><p>  From my point of view, clones are a sign of not very high quality source code and, accordingly, entail the same problems.  Unfortunately, it is not always possible to remove them effectively, and it is not always they that are the real problem.  In some cases, they may indicate an unsuccessful choice of architecture or excessive cluttering of the function. </p><br><p>  Ultimately, whether to delete clones or not depends on the specific situation.  However, in any case, duplicate code is always a reason to think. </p><br><h2 id="instrumenty-dlya-poiska-klonov">  Clone search tools </h2><br><p>  There are quite a few tools for searching for clones: <a href="https://pmd.github.io/pmd-5.5.2/usage/cpd-usage.html">PMD</a> , <a href="http://www.ccfinder.net/ccfinderxos.html">CCFinder</a> , <a href="https://github.com/skyhover/Deckard">Deckard</a> , <a href="http://www.semdesigns.com/products/clone/JavaCloneDR.html">CloneDR</a> , <a href="https://github.com/basepom/duplicate-finder-maven-plugin">Duplicate finder (maven plugin)</a> , and many others. </p><br><p>  Unfortunately, most of these tools are not integrated with the development environment.  Lack of integration makes navigation and refactoring of clones more difficult.  At the same time, there are not so many tools built into the development environment.  For example, in the case of <strong>IntelliJ IDEA, the</strong> choice is only between standard inspections and two plug-ins ( <a href="https://pmd.github.io/pmd-5.5.2/usage/cpd-usage.html">PMD</a> and <a href="http://suhininalex.github.io/IdeaClonePlugin/">Duplicate Detector</a> ). </p><br><p>  This article has two objectives.  On the one hand, with its help, I would like to make a modest contribution to the fight against duplication of source code.  On the other hand, I would like to introduce the reader to the <a href="http://suhininalex.github.io/IdeaClonePlugin/">Duplicate Detector</a> plugin, the developer of which I am.  At the moment, compared to standard inspections, this plugin detects 3-4 times more clones, provides a more user-friendly interface and is available for the non-commercial version IntelliJ IDEA. </p><br><p>  Key features of the Duplicate Detector plugin: </p><br><ul><li>  Code analysis on the fly (during editing) </li><li>  Analysis of industrial scale projects (with millions of lines of code) </li><li>  Easy navigation and comparison of duplicates </li><li>  Java and Kotlin language support </li></ul><br><div class="spoiler">  <b class="spoiler_title">What can clone detection tools come in handy for?</b> <div class="spoiler_text"><ul><li>  To work with <em>legacy</em> code </li><li>  For convenient <em>code review</em> </li><li>  To track clones that cannot be deleted </li><li>  For refactoring if you use a methodology similar to XP </li></ul></div></div><br><h2 id="refaktoring-klonov">  Clone Refactoring </h2><br><p>  In fact, there is only one way to remove clones - to summarize similar functionality.  To do this, you can create an auxiliary method or class, or try to express one duplicate through another.  It should not be forgotten that refactoring is done to improve the quality of the code.  Therefore, it is better to approach it creatively, because sometimes the problem may be wider or narrower, or in general consist in something else. </p><br><p>  Let's take a look at a few specific examples from the popular <strong>Spring</strong> framework.  To do this, use the <strong>IntelliJ IDEA</strong> development environment and the <strong>Duplicate Detector</strong> plugin. </p><br><h3 id="vozmozhnosti-sredy-razrabotki-i-plagina">  Features of the development environment and the plugin </h3><br><p> The <strong>IntelliJ IDEA</strong> development environment and the <strong>Duplicate Detector</strong> plugin provide many features that will simplify clone refactoring.  For example, quite a lot of functions can be found in the context menu of the <code>Refactor</code> or in the tips for code inspections ( <code>Alt + Enter</code> as part of the inspection). </p><br><div class="spoiler">  <b class="spoiler_title">Show Duplicate Compare Panel</b> <div class="spoiler_text"><p><img src="https://habrastorage.org/getpro/habr/post_images/aac/03c/d3f/aac03cd3f298b375d9534e824d504c77.png"></p><br><p><img src="https://habrastorage.org/getpro/habr/post_images/609/126/a77/609126a7754db0a31006b660482794fa.png"></p></div></div><br><div class="spoiler">  <b class="spoiler_title">Summarize the fragment as a method</b> <div class="spoiler_text"><p><img src="https://habrastorage.org/getpro/habr/post_images/8bb/420/e5c/8bb420e5c5e1077feb3a2e5c3e11dcc6.png"></p></div></div><br><div class="spoiler">  <b class="spoiler_title">Substitute return type</b> <div class="spoiler_text"><p><img src="https://habrastorage.org/getpro/habr/post_images/22a/855/31a/22a85531ab16118b82b49a74139d562e.png"></p></div></div><br><h3 id="primer-1-nachnem-s-ochevidnogo">  Example 1. Let's start with the obvious. </h3><br><p><img src="https://habrastorage.org/getpro/habr/post_images/dcc/ad0/2ab/dccad02abc36ef100a9dcd0aa51818f1.png"><br><img src="https://habrastorage.org/getpro/habr/post_images/b7d/845/d76/b7d845d76e5389daa4d74fa0dcd7857a.png"></p><br><p><img src="https://habrastorage.org/getpro/habr/post_images/609/126/a77/609126a7754db0a31006b660482794fa.png"></p><br><p>  In this example, the code snippets are almost identical.  The main differences concern only lines <code>4</code> and <code>9</code> , in which the field values ‚Äã‚Äãchange.  In such cases, in practice, little can be done.  Alternatively, you can try to allocate functional interfaces and use lambdas.  However, with such a refactoring, the code will not necessarily become shorter, and most importantly, clearer. </p><br><div class="spoiler">  <b class="spoiler_title">Refactoring.</b>  <b class="spoiler_title">Option 1.</b> <div class="spoiler_text"><pre> <code class="java hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">setVariableNameOrType</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(String name, Consumer&lt;String&gt; setName, Consumer&lt;Class&lt;?&gt;&gt; setType)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (isVariableName(name)) { setName.accept(name); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { setType.accept(ClassUtils.forName(name, getAspectClassLoader())); } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (Throwable ex) { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> IllegalArgumentException(<span class="hljs-string"><span class="hljs-string">"Class name '"</span></span> + name + <span class="hljs-string"><span class="hljs-string">"' is neither a valid argument name nor the fully-qualified "</span></span> + <span class="hljs-string"><span class="hljs-string">"name of a Java type on the classpath. Root cause: "</span></span> + ex); } } }</code> </pre> <br><pre> <code class="java hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">setThrowingNameNoCheck</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(String name)</span></span></span><span class="hljs-function"> </span></span>{ setVariableNameOrType(name, variableName -&gt; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.throwingName = name, type -&gt; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.discoveredThrowingType = type); }</code> </pre> </div></div><br><p>  Instead, let's take another look at the duplicate code.  Apparently, the main task of the <code>else</code> branch is class loading.  It would be logical, for a start, to single out such a load as a separate method. </p><br><div class="spoiler">  <b class="spoiler_title">Refactoring.</b>  <b class="spoiler_title">Option 2.</b> <div class="spoiler_text"><pre> <code class="java hljs">Class&lt;?&gt; loadClass(String name) { <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> ClassUtils.forName(name, getAspectClassLoader()); } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (Throwable ex) { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> IllegalArgumentException(<span class="hljs-string"><span class="hljs-string">"Class name '"</span></span> + name + <span class="hljs-string"><span class="hljs-string">"' is neither a valid argument name nor the fully-qualified "</span></span> + <span class="hljs-string"><span class="hljs-string">"name of a Java type on the classpath. Root cause: "</span></span> + ex); } }</code> </pre> <br><pre> <code class="java hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">protected</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">setReturningNameNoCheck</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(String name)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (isVariableName(name)) { returningName = name; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { discoveredReturningType = loadClass(name); } }</code> </pre> <br><pre> <code class="java hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">protected</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">setThrowingNameNoCheck</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(String name)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (isVariableName(name)) { throwingName = name; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { discoveredThrowingType = loadClass(name); } }</code> </pre> </div></div><br><p>  The main advantage of this refactoring is its simplicity.  The <code>loadClass()</code> method does not need additional explanation, and its behavior can be guessed simply by its name. </p><br><h3 id="primer-2-problema-s-interfeysami">  Example 2. Problem with interfaces. </h3><br><p><img src="https://habrastorage.org/getpro/habr/post_images/4d8/661/be6/4d8661be61e301cb1a61ed679859c354.png"></p><br><p><img src="https://habrastorage.org/getpro/habr/post_images/d95/d2b/895/d95d2b8950fdce748ef07e87bc794433.png"></p><br><p>  Consider a more ambiguous example.  At first glance it seems that the code in it is almost identical.  However, in reality, the <code>setSource()</code> , <code>setElementTypeName()</code> , <code>setMergeEnabled()</code> are not part of a common interface or class.  Of course, you can create a new interface or expand an existing one.  But this may not be enough if you do not have access to the <code>ManagedList</code> and <code>ManagedSet</code> classes to associate them with this interface.  In this case, you also have to create your own wrappers for these classes. </p><br><div class="spoiler">  <b class="spoiler_title">Sample interface and wrappers</b> <div class="spoiler_text"><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">interface</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ManagedCollection</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">T</span></span></span><span class="hljs-class">&gt; </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Collection</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">T</span></span></span><span class="hljs-class">&gt; </span></span>{ <span class="hljs-function"><span class="hljs-function">Object </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getSource</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">setSource</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Object object)</span></span></span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">setMergeEnabled</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">boolean</span></span></span></span><span class="hljs-function"><span class="hljs-params"> mergeEnabled)</span></span></span></span>; <span class="hljs-function"><span class="hljs-function">String </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getElementTypeName</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">setElementTypeName</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(String elementTypeName)</span></span></span></span>; }</code> </pre> <br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ExtendedManagedSet</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">T</span></span></span><span class="hljs-class">&gt; </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ManagedSet</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">T</span></span></span><span class="hljs-class">&gt; </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ManagedCollection</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">T</span></span></span><span class="hljs-class">&gt;</span></span>{ }</code> </pre> <br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ExtendedManagedList</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">T</span></span></span><span class="hljs-class">&gt; </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ManagedList</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">T</span></span></span><span class="hljs-class">&gt; </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ManagedCollection</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">T</span></span></span><span class="hljs-class">&gt;</span></span>{ }</code> </pre> </div></div><br><p>  As a result, such refactoring will generate many new entities.  In our case, these are two classes and one interface.  Because of this, the program code will only become more complicated, so creating your own wrappers makes sense only if this situation occurs not for the first time. </p><br><div class="spoiler">  <b class="spoiler_title">Refactoring</b> <div class="spoiler_text"><pre> <code class="java hljs">&lt;T extends ManagedCollection&gt; <span class="hljs-function"><span class="hljs-function">T </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">parseManagedElement</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Element collectionEle, @Nullable BeanDefinition bd, T accumulator)</span></span></span><span class="hljs-function"> </span></span>{ NodeList nl = collectionEle.getChildNodes(); String defaultElementType = collectionEle.getAttribute(VALUE_TYPE_ATTRIBUTE); accumulator.setSource(extractSource(collectionEle)); accumulator.setElementTypeName(defaultElementType); accumulator.setMergeEnabled(parseMergeAttribute(collectionEle)); parseCollectionElements(nl, accumulator, bd, defaultElementType); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> accumulator; }</code> </pre> <br><pre> <code class="java hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> List&lt;Object&gt; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">parseListElement</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Element collectionEle, @Nullable BeanDefinition bd)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> parseManagedElement(collectionEle, bd, <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ManagedList&lt;Object&gt;()); }</code> </pre> <br><pre> <code class="java hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> Set&lt;Object&gt; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">parseSetElement</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Element collectionEle, @Nullable BeanDefinition bd)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> parseManagedElement(collectionEle, bd, <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ManagedSet&lt;Object&gt;()); }</code> </pre> </div></div><br><h3 id="primer-3-oshibka-pri-kopirovanii">  Example 3. Error while copying. </h3><br><p><img src="https://habrastorage.org/getpro/habr/post_images/ba0/525/8f7/ba05258f7adc40337ddce3a9c7832538.png"></p><br><p><img src="https://habrastorage.org/getpro/habr/post_images/aa4/e47/120/aa4e47120f12e4d58c86fe72392cee56.png"></p><br><p>  Note the last parts related to the <code>user</code> variable.  Despite their slight difference, they also belong to clones.  This can happen for several reasons.  For example, if one fragment was first copied and then changed (corrected the error).  Or, for example, if fragments were developed separately, the difference in them may be due to inattention or ignorance of one of the developers. </p><br><p>  In fact, the difference between the first fragment, taking into account the implementation of the <code>hasLength()</code> method, is an additional check <code>!user.isEmpty()</code> .  In this particular example, this may not be as critical.  Nevertheless, the example itself well illustrates the essence of the problem. </p><br><pre> <code class="java hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">boolean</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">hasLength</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(@Nullable String str)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> (str != <span class="hljs-keyword"><span class="hljs-keyword">null</span></span> &amp;&amp; !str.isEmpty()); }</code> </pre> <br><div class="spoiler">  <b class="spoiler_title">Refactoring</b> <div class="spoiler_text"><pre> <code class="java hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> String </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">prepareClientParametes</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(HttpServletRequest request)</span></span></span><span class="hljs-function"> </span></span>{ StringBuilder msg = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> StringBuilder(); String client = request.getRemoteAddr(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (StringUtils.hasLength(client)) { msg.append(<span class="hljs-string"><span class="hljs-string">";client="</span></span>).append(client); } HttpSession session = request.getSession(<span class="hljs-keyword"><span class="hljs-keyword">false</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (session != <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) { msg.append(<span class="hljs-string"><span class="hljs-string">";session="</span></span>).append(session.getId()); } String user = request.getRemoteUser(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (StringUtils.hasLength(user)) { msg.append(<span class="hljs-string"><span class="hljs-string">";user="</span></span>).append(user); } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> msg.toString(); }</code> </pre> <br><pre> <code class="java hljs"> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (includeClientInfo) { msg.append(prepareClientParametes(request)); }</code> </pre> <br><pre> <code class="java hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> String </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getDescription</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">boolean</span></span></span></span><span class="hljs-function"><span class="hljs-params"> includeClientInfo)</span></span></span><span class="hljs-function"> </span></span>{ HttpServletRequest request = getRequest(); String clientParameters = includeClientInfo ? prepareClientParametes(request) : <span class="hljs-string"><span class="hljs-string">""</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">"uri="</span></span> + request.getRequestURI() + clientParameters; }</code> </pre> </div></div><br><h3 id="primer-4-nasledovanie">  Example 4. Inheritance </h3><br><p><img src="https://habrastorage.org/getpro/habr/post_images/d77/b43/0b3/d77b430b3a5fe2bddab6935995b6def2.png"><br><img src="https://habrastorage.org/getpro/habr/post_images/7dd/2a7/520/7dd2a7520c35bf1bf6b8709828a95ae2.png"></p><br><p><img src="https://habrastorage.org/getpro/habr/post_images/08c/152/c32/08c152c3270b42088b118cce25dee4b5.png"></p><br><p>  In this example, the clones are constructors.  Duplication of constructors often occurs if the clones are in fact whole classes.  In such cases, they usually either create a new general superclass, or try to express one of the existing classes through the other. </p><br><p>  Sometimes inheritance is also used to refactor individual code fragments.  This allows in the new auxiliary methods to gain access to the fields of the class, and exclude these fields from the list of explicit parameters.  However, despite the fact that the signature of the method becomes simpler from this, as a rule, such refactoring is not a very good idea.  Inheritance can greatly confuse the logic of the program and do more harm than good, especially if it is used for purposes other than its intended purpose. </p><br><div class="spoiler">  <b class="spoiler_title">Refactoring</b> <div class="spoiler_text"><p>  Source files: </p><br><ul><li>  <a href="">SingleCharWildcardedPathElement.java</a> </li><li>  <a href="">LiteralPathElement.java</a> </li></ul><br><p>  Files after refactoring: </p><br><ul><li>  <a href="https://gist.github.com/suhininalex/78fe577f9866dfd5c01a215beda0c8e5">SingleCharWildcardedPathElement.java</a> </li><li>  <a href="https://gist.github.com/suhininalex/13d7e9135867153a4c1f626d72638658">LiteralPathElement.java</a> </li></ul><br><p>  The main differences of the class <code>SingleCharWildcardedPathElement</code> are: </p><br><ul><li>  New field <code>questionMarkCount</code> </li><li>  Lines <a href=""><code>81</code></a> and <a href=""><code>90</code></a> in the <code>matches</code> method ( <a href=""><code>75</code></a> and <a href=""><code>83</code></a> in <code>LiteralPathElement</code> ) </li><li>  Implementing the <code>toString()</code> method </li></ul><br><p>  The greatest difficulties arise with the <code>matches</code> method.  However, if we note that lines <code>81</code> and <code>90</code> , in essence, are engaged in comparing characters, then this method is easily generalized. </p></div></div><br><h3 id="primer-5-ispolzovanie-lyambda-vyrazheniy">  Example 5. Using lambda expressions. </h3><br><p><img src="https://habrastorage.org/getpro/habr/post_images/c86/08d/31b/c8608d31bc8081da4c0111a66f82039f.png"><br><img src="https://habrastorage.org/getpro/habr/post_images/bc0/0b2/3a2/bc00b23a21db503bf98d4bcb87775ff9.png"></p><br><div class="spoiler">  <b class="spoiler_title">Duplicate comparison</b> <div class="spoiler_text"><p><img src="https://habrastorage.org/getpro/habr/post_images/ffe/a3c/d0c/ffea3cd0c21d850940e71746d1042d42.png"></p></div></div><br><p>  Sometimes the differences between clones may concern constructors, methods, or whole snippets of code.  In this case, a generalization can be made using functional interfaces: <a href="https://docs.oracle.com/javase/8/docs/api/java/util/function/Function.html"><code>Function</code></a> , <a href="https://docs.oracle.com/javase/8/docs/api/java/util/function/BiFunction.html"><code>BiFunction</code></a> , <a href="https://docs.oracle.com/javase/8/docs/api/java/util/Comparator.html"><code>Comparator</code></a> , <a href="https://docs.oracle.com/javase/8/docs/api/java/util/function/Supplier.html"><code>Supplier</code></a> , <a href="https://docs.oracle.com/javase/8/docs/api/java/util/function/Consumer.html"><code>Consumer</code></a> or others.  The only limitation is that in the parameterizable fragments the types of input and output data must match. </p><br><p>  In this example, you can successfully generalize the method of creating <code>ConsumeMediaTypeExpression</code> and <code>ProduceMediaTypeExpression</code> objects using a single function parameter <code>BiFunction</code> .  However, sometimes one such parameter is not enough, and more are needed.  Such cases should be treated with caution, since even two functional parameters can complicate the work with the method. </p><br><div class="spoiler">  <b class="spoiler_title">Refactoring</b> <div class="spoiler_text"><pre> <code class="java hljs">&lt;T&gt; <span class="hljs-function"><span class="hljs-function">Set&lt;T&gt; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">processHeader</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(String[] headers, String headerType, BiFunction&lt;MediaType, Boolean, T&gt; process)</span></span></span><span class="hljs-function"> </span></span>{ Set&lt;T&gt; result = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> LinkedHashSet&lt;&gt;(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (headers != <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (String header : headers) { HeadersRequestCondition.HeaderExpression expr = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> HeadersRequestCondition.HeaderExpression(header); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (headerType.equalsIgnoreCase(expr.name)) { <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (MediaType mediaType : MediaType.parseMediaTypes(expr.value)) { result.add(process.apply(mediaType, expr.isNegated)); } } } } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> result; }</code> </pre> <br><pre> <code class="java hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> Set&lt;ConsumeMediaTypeExpression&gt; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">parseExpressions</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(String[] headers)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> processHeader(headers, <span class="hljs-string"><span class="hljs-string">"Content-Type"</span></span>, (mediaType, isNegated) -&gt; <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ConsumeMediaTypeExpression(mediaType, isNegated)); }</code> </pre> <br><pre> <code class="java hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> Set&lt;ProduceMediaTypeExpression&gt; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">parseExpressions</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(String[] headers)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> processHeader(headers, <span class="hljs-string"><span class="hljs-string">"Accept"</span></span>, (mediaType, isNegated) -&gt; <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ProduceMediaTypeExpression(mediaType, isNegated)); }</code> </pre> </div></div><br><h2 id="zaklyuchenie">  Conclusion </h2><br><p>  As a conclusion, I would like to remind you that the problem of duplication of code is not as unambiguous as it may seem.  Sometimes duplicate code cannot be effectively removed, sometimes it is not a real problem at all.  However, in essence, clones are a sign of not very high quality source code.  Therefore, their removal is desirable, but should not become an obsession.  The removal of clones should have a specific goal - to make the program code easier and more understandable. </p><br><p>  Summing up, I would like to highlight several useful principles that can help in the fight against clones: </p><br><ul><li>  <strong>Summarize only meaningful parts.</strong>  Remember that the main goal is to simplify the code, and the simplest code is not always the shortest. </li><li>  <strong>Avoid inheritance.</strong>  Inheritance can greatly complicate the program code, especially if it is used for purposes other than its intended purpose. </li><li>  <strong>Do not focus on clones.</strong>  The real problem may be related to unsuccessful architecture, unsuccessful choice of library, bad interface.  Sometimes it takes a wider look to solve a problem. </li><li>  <strong>Take advantage of the development environment.</strong>  Many features of the development environment can simplify the refactoring process and remove the routine from it. </li></ul></div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <p>Source: <a href="https://habr.com/ru/post/335172/">https://habr.com/ru/post/335172/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../335162/index.html">Polymorphism and function pointers</a></li>
<li><a href="../335164/index.html">How to program a satellite photo? Problem solving Dstl Satellite Imagery Feature Detection</a></li>
<li><a href="../335166/index.html">Very easy monitoring system with Telegram and Consul</a></li>
<li><a href="../335168/index.html">How to set up backup to S3-compatible cloud from Commvault</a></li>
<li><a href="../335170/index.html">How we look for (and why we find) cool developers. HR experience and tips for job seekers</a></li>
<li><a href="../335174/index.html">Smart stores, omni-channel analytics and endless loyalty: 6 retail trends in 2017</a></li>
<li><a href="../335176/index.html">Use PowerShell for IT security. Part I: Event Tracking</a></li>
<li><a href="../335178/index.html">Asynchronous decoder</a></li>
<li><a href="../335180/index.html">How the push notification service helped us make the technical support portal more visited</a></li>
<li><a href="../335184/index.html">Free network security audit with Fortinet. Part 1</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>