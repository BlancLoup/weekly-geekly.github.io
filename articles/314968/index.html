<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Problems that we encountered when updating the PVS-Studio interface</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="In the recently released new version of PVS-Studio 6.10, the graphical user interface of Visual Studio plug-ins and Standalone version has been signif...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Problems that we encountered when updating the PVS-Studio interface</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/getpro/habr/post_images/610/0d5/bc4/6100d5bc41e18b1a4c275465d17aa25e.png" alt="Picture 2" align="left">  In the recently released new version of PVS-Studio 6.10, the graphical user interface of Visual Studio plug-ins and Standalone version has been significantly updated.  The previous version of the interface, despite the constant evolution (new buttons and menu items were added and disappeared), existed for almost 6 years without significant changes, having first appeared in PVS-Studio version 4.0 in 2010. <br><br>  In this article we want to tell you what caused us to think about the need to change the interface, and what problems we encountered in the process of working on it. <br><a name="habracut"></a><br><br><h2>  Problems of the old PVS-Studio interface, and why we decided to change it </h2><br>  First, a little history.  A separate PVS-Studio window has appeared in the Visual Studio plugin since version 4 of the analyzer.  Previous versions used the standard Error List window to display diagnostic messages, however, our requirements quickly outgrew the capabilities of this window.  In addition to the inability to add our own filters, context menus, buttons, etc., the main reason that prompted us to implement our own window for PVS-Studio messages was the performance of the Error List.  When recording at least several thousand messages into it, it became impossible to work with it - the studio hung up even just when trying to scroll through it. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Of course, you can say: the analyzer, which issues thousands of messages, is a bad analyzer.  However, it should be borne in mind that our first diagnostics were errors in porting C ++ programs to a 64-bit platform, and, by their nature, such errors can be quite numerous, especially on real large projects.  In secret, I can say that our ‚Äúanti-record‚Äù was a report on ~ 250,000 messages!  At the same time, I want to reassure our users - the modern version of PVS-Studio doesn‚Äôt usually do this to itself, especially now we have such concepts as ‚Äúlevels of importance‚Äù of errors and various ways to easily easily suppress or disable unsuccessful alarms (which are inevitably found in the framework of static analysis).  However, back in 2010, all this was not yet there, and the interface ‚Äúbrakes‚Äù were more relevant than ever. <br><br>  The first versions of our plug-in with a separate window supported Visual Studio versions 2005 and 2008. It must be said that modern Visual Studio also does not stand still, and the problem with displaying a large number of messages in the standard Error List is already possible and not so relevant, but the advantages of a separate ‚Äúoutput window‚Äù are still obvious.  It's funny here to draw a parallel with the built-in C ++ analyzer Visual Studio - for a certain period (it seems, on versions 2010 - 2012, but I could be wrong), this analyzer also used its own, separate output window to display the results of its work.  However, in recent versions, Visual Studio has returned to displaying the results in the standard Error List window.  The reasons why, in our opinion, the developers of Visual Studio have done this, I will tell you when I will describe our new window. <br><br>  As I mentioned above, the first versions of the PVS-Studio window were made for the 2005 and 2008 versions of the Visual Studio environment.  Thus, when developing the initial design of our window, we were guided by the design of the standard Error List from these versions of the IDE.  This basically explains the style of icons that we adopted then.  Despite the fact that in the modern versions of Visual Studio our window supported all the new-fashioned color themes, the icons have remained in it since that time.  This is how the main components of our interface looked like before the ‚Äúrestyling‚Äù: <br><br><p><img src="https://habrastorage.org/getpro/habr/post_images/fb6/3c3/2db/fb63c32db28375503c0d4275cb1b6a36.png" alt="Picture 11"></p><br>  <font color="#999999"><i>Figure 1 - old PVS-Studio interface in Visual Studio 2015 (output window and main menu)</i></font> <br><br>  What are the problems with our interface, in addition to the purely "aesthetic"?  Probably our main problem, or rather the problem that causes inconvenience to our users, is the intuitiveness of the interface.  Even such seemingly basic features, such as marking false positives through the context menu, or differentiating messages according to their importance, were often not obvious to our users and raised questions.  Often there is a situation in which the user considers the most ‚Äúdangerous‚Äù messages of the 3rd level.  Another problem is general ‚Äúbulkiness‚Äù - too many inscriptions, incomprehensible abbreviations and buttons, it is difficult to find something. <br><br>  In the new interface, we tried to solve these problems, and how much we got it - you can learn more. <br><br><h2>  New design of the main window </h2><br>  Before starting to write code, we turned to a professional designer with the task of creating the concept of a new interface.  As I mentioned earlier, our window repeated the concept of the standard Error List, and, accordingly, its central part was the classic ‚Äúgrid‚Äù - a table with columns and rows.  We wanted to experiment and try to abandon the "classic" formula, especially now minimalism is in fashion, and Visual Studio itself is subject to these trends in its interface.  As a new ‚Äúinspiration‚Äù, we decided to try again using the elements of Visual Studio - the notifications window and the output window of the results of the embedded C ++ analyzer. <br><br><p><img src="https://habrastorage.org/getpro/habr/post_images/96d/d3d/80e/96dd3d80e0328c039afeccb0ad962d3b.png" alt="Picture 3"></p><br>  <font color="#999999"><i>Figure 2 - the built-in static analysis window (Visual Studio 2012) and the notification window (Visual Studio 2013)</i></font> <br><br>  As you can see from the picture, both windows are as minimal as possible - they contain nothing but the message text and some identifier (code or color marker).  There are also search / filter fields on the left window.  Also, unlike the Error List, both windows are oriented more towards a vertical rather than a horizontal location. <br><br>  And here I want to go back to what I already mentioned above - in 2015, the Microsoft developers for some reason abandoned their ‚Äútrendy‚Äù new vertical window of static analysis (on the left) in favor of the ‚Äúgood old‚Äù Error List.  Why did they do that?  In my opinion, as well as from the experience of own use of this new window - simply because it was inconvenient to use this window.  There were few messages on the screen in the vertical table, it was not possible to sort them by any criterion (for example, by code or file), and when the card was ‚Äúopened‚Äù with a message, it sometimes took up the whole screen. <br><br>  ‚ÄúHaving played‚Äù with various design options, we finally came to the same conclusion - analyzer messages (like, for example, compiler warnings) are more convenient to view and analyze in the classic horizontal grid.  Yes, the notification interface (in the picture it is on the right) is convenient when you need to issue two or three messages that require attention, but when the user needs to work with dozens (and sometimes hundreds or even thousands) of messages, the advantages of the table become obvious.  Of course, after the initial setup, developers usually have to deal with several messages simultaneously on a new code, if, of course, the static analyzer is used correctly, i.e.  regularly.  But the initial setup stage is no less important, and often the success of further use of the analyzer depends on the correctness of its implementation.  However, in the notifications window, we learned an interesting idea of ‚Äã‚Äãvisual differentiation of the ‚Äúimportance‚Äù of messages - using a color bar. <br><br>  After we decided on the general direction, it was necessary to choose the technological basis for the interface.  The previous version of our interface used the ‚Äúgood old‚Äù Windows Forms - this was due to the need to support Visual Studio 2005 and 2008. Given that the Visual Studio plugin itself is developed in C #, Visual Studio is not cross-platform and, probably, the main thing is that Visual Studio uses WPF technology, it seems the most logical to use the same WPF for the updated interface.  Nevertheless, even despite the fact that all the internal logic of the plug-in and the data structures it uses are not directly tied to the interface, we decided in the current version to try first ‚Äúredecorating‚Äù, i.e.  simply ‚Äúrepaint‚Äù the current interface in accordance with the updated design, leaving all underlying components unchanged.  Unfortunately, the real world dictates its own conditions, and sometimes you have to prioritize what you want to do and what you need to do.  Moreover, such cosmetic repairs can be done by very small forces and in a short time. <br><br>  We have to admit that the basic capabilities of WinForms are already beginning to be missed - even this seemingly small ‚Äúcosmetic‚Äù edit required the implementation of several ‚Äúcrutches‚Äù in the code - not noticeable for users, but already complicating further support and development of the interface.  For example, I had to ‚Äútinker‚Äù with new level buttons (with a color bar) when displayed on the toolstrip panel.  The standard toolstrip in WinForms is responsible for drawing its elements, but when hosting a user control, the drawing of this control has to be shifted to itself (this was especially important for us in terms of supporting color schemes).  Using WinForms also forces us to support color schemes with the rather archaic VS SDK interface of <i>GetVSSysColorEx</i> <b><i>,</i></b> and to color our components on our own, as well as to catch the moment when the color theme is switched.  For WPF components, Visual Studio offers a more convenient mechanism for picking colors through dynamic resources, directly in the XAML markup. <br><br>  As a result, I think we can say with a great degree of confidence that the next (after the current update) version of the PVS-Studio interface will be completely based on WPF.  Now, our goal, as for the last iteration of the interface, was to preserve ‚Äúauthenticity‚Äù with respect to standard Visual Studio windows.  The result we got can be seen below: <br><br><p><img src="https://habrastorage.org/getpro/habr/post_images/23f/bbd/ec0/23fbbdec0b0d2b0a009ee85d7a65e551.png" alt="Figure 3 - the updated PVS-Studio interface (the output window and the main menu)"></p><br>  <font color="#999999"><i>Figure 3 - the updated PVS-Studio interface (the output window and the main menu)</i></font> <br><br><h2>  Menu items, icons and rakes </h2><br>  The old icons of the PVS-Studio plugin were far from ideal, or rather, from the standard ‚Äútheme‚Äù in Visual Studio, so it was decided to replace them.  The main requirement for new icons was their compliance with a single style and good contrast for all color schemes in Visual Studio. <br><br>  Having defined the set of icons, we started to develop.  The first problem we encountered was, strangely enough, the direct display of icons in the main Visual Studio menu.  You say: ‚ÄúWait, you have already shown your icons in this menu, starting from the first version of PVS-Studio!‚Äù.  Indeed, this is so, but the method we used earlier was not suitable for our purposes.  I‚Äôll clarify that for setting icons we used a single mechanism of Visual Studio extensions for creating menu items - vsct files (you can read more about this <a href="http://www.viva64.com/ru/a/0082/">here</a> ).  What did not suit us in this version?  For a start, the icons could be set only once - when the plug-in was loaded by the studio.  We wanted to imitate the behavior of standard studio icons, i.e.  repaint them depending on the chosen color scheme (as it turned out later, this requirement was unnecessary - the studio is able to do it herself).  Secondly, the vsct file does not know how (or perhaps we do not know how to use the alpha channel in the image of icons within the vsct file), which is why they looked very unattractive. <br><br>  The question arose: how do we set the picture for the menu item's icon programmatically, and is it possible to do this at all?  After a long search, we managed to find a third-party Visual Studio extension that could do it.  A study of its source code has allowed us to find the answer to the question voiced above.  Everything turned out to be extremely simple: <br><br><pre><code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> commandBars = (CommandBars)DTE.CommandBars; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> menuBar = commandBars[menuBarKey]; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> pvsBar = menuBar.Controls[<span class="hljs-string"><span class="hljs-string">"PVS-Studio"</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> CommandBarPopup; ... cmdBtnControl.Picture = ImageHelper.BitmapToStdPicture(bmp);</code> </pre> <br>  We also had a concern that such a method would ‚Äúbreak down‚Äù if the user wants (and why not?) To rename the PVS-Studio menu item, because Visual Studio allows doing this.  However, these fears turned out to be in vain - the internal name of the commandBar objects does not change. <br><br>  Having solved the issue of the dynamic display of icons, we implemented an algorithm by which a monochrome icon would be painted in a color selected from the active theme of Visual Studio.  We inverted all the icons in the resources of the plugin to white and wrote a simple conversion algorithm that multiplied the color of each pixel of the image to the one we need: <br><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Colorize</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">ref</span></span></span></span><span class="hljs-function"><span class="hljs-params"> Bitmap img, Color color</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> x = <span class="hljs-number"><span class="hljs-number">0</span></span>; x &lt; img.Width; x++) { <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> y = <span class="hljs-number"><span class="hljs-number">0</span></span>; y &lt; img.Height; y++) { <span class="hljs-comment"><span class="hljs-comment">//       //            var pixel = img.GetPixel(x, y); var r = (byte)(((float)pixel.R) * ((float)color.R / 255f)); var g = (byte)(((float)pixel.G) * ((float)color.G / 255f)); var b = (byte)(((float)pixel.B) * ((float)color.B / 255f)); img.SetPixel(x, y, Color.FromArgb(pixel.A, r, g, b)); } } }</span></span></code> </pre> <br>  At the exit, we got the following result: <br><br><p></p><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/3be/1bd/0a2/3be1bd0a27898cad5fe7e1f7a608ed9e.png" alt="Figure 4 - An example of the operation of the icon colorization algorithm."></div><p></p><br>  <font color="#999999"><i><i>Figure 4 - An example of the operation of the icon colorization algorithm.</i></i></font> <br><br>  However, we found unexpected behavior - in the case of choosing, for example, the ‚Äúred‚Äù theme of Visual Studio, the icon was displayed correctly.  Correctly, it was displayed in the "light" scheme.  In the ‚Äúdark‚Äù scheme, the icons remained black, rather than becoming white, as we expected.  It turned out that the studio itself is able to invert certain colors of the picture, depending on the "brightness" of the background in the chosen color scheme - previous experiments with the colorization of icons were in vain.  The studio did everything for us.  Despite this, we still decided to leave the method of programming the icons described above, due to problems with the alpha channel. <br><br>  Similarly, in our window of displaying PVS-Studio messages, we changed all the icons and icons to suitable ones from the same set.  However, if the icons in the menu changed color depending on the color scheme of Visual Studio automatically, the icons in the plug-in window remained in their original form for all color schemes. <br><br><p><img src="https://habrastorage.org/getpro/habr/post_images/e11/e8b/55a/e11e8b55a267b3e21a6e0bf8b60711bc.png" alt="Figure 5 - Problems with the display of icons in the dark color scheme of Visual Studio."></p><br>  <font color="#999999"><i><i>Figure 5 - Problems with the display of icons in the dark color scheme of Visual Studio.</i></i></font> <br><br>  We wondered if the Visual Studio SDK could be used to apply the color-coding studio algorithm for our icons.  The result did not make us wait long.  After a few minutes of searching, we stumbled upon the <i>GetThemedBitmap</i> method in the <i>ImageThemingUtilities</i> class of the <i>Microsoft.VisualStudio.PlatformUI</i> namespace.  He did exactly what we needed! <br><br><p><img src="https://habrastorage.org/getpro/habr/post_images/5dc/62c/4eb/5dc62c4eb815dac948533a0b7a88453f.png" alt="Figure 6 - Correct display of icons in our window for the dark theme of Visual Studio."></p><br>  <font color="#999999"><i><i>Figure 6 - Correct display of icons in our window for the dark theme of Visual Studio.</i></i></font> <br><br>  Another problem that we encountered when changing icons was their blurring on a DPI other than 100%.  This happened because all the icons had a size of 16x16 pixels.  We managed to partially defeat this problem, initially using 64x64 icons.  In this case, VisualStudio automatically compressed them to the desired size.  But in this version, everything was not quite smooth.  Now at 100% DPI a slight blur appears.  As a result, it was decided to use images of 64x64 in size, since on DPIs other than 100% this gave the most acceptable result, and at 100% DPI, the blurring was almost not noticeable. <br><br>  Also, at DPI at 115%, cutting off the right edge of the icon by several pixels was noticed.  Attempts to programmatically add a few pixels to the right (so that the image was 64x68 in size) were also unsuccessful.  The icons in Visual Studio shrank back to a square aspect ratio, and even though the circumcision was able to win, the blur increased significantly.  As a result, we simply added a few empty pixels to each icon, leaving the size 64x64.  This solution provided minimal blurring (almost imperceptible to the eyes) and eliminated the clipping of the right side of the icons. <br><br><h2>  Conclusion </h2><br>  Despite the seemingly significant external changes, the ‚Äúunder the hood‚Äù interface of PVS-Studio actually remained the same.  We hope that for our old users the new interface will remain ‚Äúfamiliar‚Äù, and for new users it will be more intuitive and pleasant.  And of course, that it will be "more beautiful" in the eyes of all our users.  As far as we got it - judge you. <br><br><div style="text-align:center;"> <a href="http://www.viva64.com/en/b/0450/"><img src="https://habrastorage.org/getpro/habr/post_images/35e/064/ddf/35e064ddf91f5d99b620384893909ff7.png"></a> </div><br>  If you want to share this article with an English-speaking audience, then please use the link to the translation: Ivan Kishchenko, Paul Eremeev.  <a href="http://www.viva64.com/en/b/0450/">Issues we faced when renewing the PVS-Studio user interface</a> . <br><br><div class="spoiler">  <b class="spoiler_title">Read the article and have a question?</b> <div class="spoiler_text">  Often our articles are asked the same questions.  We collected answers to them here: <a href="http://www.viva64.com/ru/a/0085/">Answers to questions from readers of articles about PVS-Studio, version 2015</a> .  Please review the list. <br></div></div></div><p>Source: <a href="https://habr.com/ru/post/314968/">https://habr.com/ru/post/314968/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../314958/index.html">Rover, Landing</a></li>
<li><a href="../314960/index.html">Product API from Fetchee: automatic parsing of goods online stores</a></li>
<li><a href="../314962/index.html">Canon Laser Shot LBP-1120 printer and Raspberry Pi-based print server</a></li>
<li><a href="../314964/index.html">Why and how to transfer corporate email security to the cloud. Part 1</a></li>
<li><a href="../314966/index.html">Symfony - combine GridFS files with ORM entities</a></li>
<li><a href="../314970/index.html">Taking PHP seriously</a></li>
<li><a href="../314972/index.html">Is there a future for InfiniBand on Hadoop?</a></li>
<li><a href="../314974/index.html">How IT professionals work. Andrey Domas - the leading system administrator in the social network "Odnoklassniki"</a></li>
<li><a href="../314976/index.html">Competition for ZeroNights 2016 from Mail.Ru Group</a></li>
<li><a href="../314978/index.html">Jasmine vs. Mocha, Chai and Sinon</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>