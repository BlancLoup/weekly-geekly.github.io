<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Talk about VPNs? Types of VPN connections. VPN scaling</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Colleagues, hello. My name is Vadim Semenov and I want to submit an article on the issue of the scalability of VPNs, and those VPNs that are available...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Talk about VPNs? Types of VPN connections. VPN scaling</h1><div class="post__text post__text-html js-mediator-article">  Colleagues, hello.  My name is Vadim Semenov and I want to submit an article on the issue of the scalability of VPNs, and those VPNs that are available for configuration in the usual corporate network of the enterprise, and not from the provider.  I hope this article will become a reference material that may be required when designing a network, or when it is upgraded, or in order to refresh the memory of the principle of operation of a particular VPN-on. <br><a name="habracut"></a><br>  At the beginning of the article, the main points of the IPSec protocol stack are described, since the use of this standard will continue to be very frequent.  At the end of the paragraph about IPSec, the most frequent causes of the failure of the IPSec channel were included, as well as the main steps to eliminate them. <br><br><h1>  Types of VPN connections </h1><br>  Below are the VPNs that are available for configuration in the corporate network.  Technologies are distributed by the level of channels provided to the client according to the OSI model (Figure 1): <br><br><img src="https://habrastorage.org/files/8b1/7ca/a5b/8b17caa5bdc7447886f443510ea62398.png">
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Just VPNs for corporate networks will be discussed in this article. <br><habracut text=""><br>  VPN scheme regarding the possibility of multicast skipping and the operation of routing protocols (Fig. 2): <br><br><img src="https://habrastorage.org/files/dcc/2da/aa1/dcc2daaa144548278572705c291ac9aa.png"><br>  In addition, a structured scheme of VPNs is shown (Fig. 3), which can be provided by the provider, but in this article they are not considered in detail: <br><br><img src="https://habrastorage.org/files/a6b/dc7/6da/a6bdc76dae4f4fa8967e2709d20b0ec2.png"><br><br>  The result of the work on the systematization of VPNs and the study of their scalability was the final table, which entered general information on the type of VPN protocol, its features, and the most important thing that needs to be done if you connect another one to existing VPNs. <br>  The table shows the results of the configuration, the study of the received packet format, the configuration of the routing protocol (OSPF) via VPNs, and also examines the scalability of the protocol. <br><br><h1>  VPN table </h1><br><table border="1" cellpadding="4"><tbody><tr><td>  <b>VPN type</b> <br></td><td>  <b>HUB Setup</b> <br></td><td>  <b>Spoke Setup</b> <br></td><td>  <b>Configure HUB when adding a new Spoke</b> <br></td><td>  <b>Spoke setup when adding another new Spoke</b> <br></td><td>  <b>Using dynamic routing protocols OSPF, EIGRP</b> <br></td><td>  <b>Special features</b> <br></td></tr><tr><td>  <a href="https://habr.com/ru/post/246281/">Regular IPSec</a> <a href="https://habr.com/ru/post/246281/"><br></a>  <a href="https://habr.com/ru/post/246281/">(crypto map)</a> <br></td><td>  isakmp <br>  Crypto-map <br></td><td>  isakmp <br>  Crypto-map <br></td><td>  Yes: <br>  isakmp <br>  crypto-map: <br>  set peer, <br>  transform-set, <br>  crypto ACL <br></td><td>  Yes: <br>  To ensure connectivity between the Spokees, it is necessary to add routes of the new Spoke in the crypto ACL of all existing Spokees. <br></td><td>  Not <br></td><td>  Convenient in case of Spoke &lt;5-10.  To ensure connectivity between the Spokes through HUB, it is required to add <b>N</b> <b>networks</b> on <b>N</b> spokes to <b>crypto</b> <b>ACL</b> <br>  Extremely unscalable. <br></td></tr><tr><td>  <a href="https://habr.com/ru/post/246281/">Regular IPSec (Profile)</a> <br></td><td>  isakmp profile, <br>  IPSec Profile, <br>  rypto-map <br></td><td>  isakmp profile, <br>  IPSec Profile, <br>  rypto-map <br></td><td>  Yes: <br>  crypto-map: <br>  set peer, <br>  crypto ACL <br></td><td>  Yes: <br>  Adding new routes to crypto ACL <br></td><td>  Not <br></td><td>  Extremely non-scalable. <br>  Less configuration due to the combination of typical settings in profile. <br></td></tr><tr><td>  <a href="https://habr.com/ru/post/246281/">Regular IPSec (Profile, Static VTI)</a> <br></td><td>  isakmp profile, <br>  IPSec Profile, <br>  VTI (Virtual Tunnel Interface) <br></td><td>  isakmp <br>  IPSec Profile, <br>  VTI (Virtual Tunnel Interface) <br></td><td>  Yes: <br>  isakmp <br>  new VTI (Virtual Tunnel Interface) <br></td><td>  Yes <br>  static route to networks beats.  office <br></td><td>  Yes <br></td><td>  In SVTI configuration without IGP - extremely non-scalable. <br>  For each Spoke on SVTI. <br>  <b>N</b> <b>spoke</b> - <b>N</b> <b>VTI</b> and its own subnet. <br>  Spoke requires adding routes to remote Spoke's.  Skips multicast! <br>  By default, there is only one IPSec SA for each SVTI with traffic selector ‚ÄúIP any any.‚Äù There is no crypto ACL command.  The networks that are defined via the static route on the SVTI are wrapped in the tunnel. <br></td></tr><tr><td>  <a href="https://habr.com/ru/post/246281/">Regular IPSec (Profile, Static VTI and IGP)</a> <br></td><td>  isakmp <br>  IPSec Profile, <br>  VTI (Virtual Tunnel Interface) <br></td><td>  isakmp <br>  IPSec Profile, <br>  VTI (Virtual Tunnel Interface) <br></td><td>  Yes: <br>  isakmp <br>  new VTI (Virtual Tunnel Interface) <br></td><td>  Not <br></td><td>  Yes <br></td><td>  Not scalable. <br>  For each Spoke on SVTI. <br>  N spoke - N VTI and its own subnet.  Routes from IGP fall into the tunnel. <br></td></tr><tr><td>  <a href="https://habr.com/ru/post/246281/">IPSec with dynamic IP (Dynamic VTI and Static VTI and IGP)</a> <br></td><td>  keyring, <br>  isakmp policy, <br>  isakmp profile, <br>  ipsec profile, <br>  loopback for unnumbered interface (required), <br>  Virtual-Template type tunnel <br></td><td>  keyring, <br>  isakmp policy, <br>  isakmp profile, <br>  ipsec profile, <br>  loopback for unnumbered interface <br>  Static VTI <br></td><td>  Not <br></td><td>  Not <br></td><td>  Yes <br></td><td>  Very scalable.  All spoke and hub are in the same network!  Dynamic VTI (DVTIs) is also a point-to-point interface.  In point-to-multipoint mode, OSPF adjacency is not established. <br>  Using <b>Unnumbered IP</b> as DVTI address is required <br></td></tr><tr><td>  <a href="https://habr.com/ru/post/246281/">Easy VPN</a> <br></td><td>  AAA - for client authorization <br>  Isakmp, <br>  isakmp policy, <br>  isakmp profile, <br>  ipsec profile, <br>  interface, <br>  Virtual-Template type tunnel <br>  DHCP for clients <br></td><td>  Minimum <br>  IPsec client configuration, indicating the VPN server, VPN group, user for aaa, <br>  Indication of internal and external interfaces. <br></td><td>  Not <br></td><td>  Not <br></td><td>  Yes <br></td><td>  Scalable. <br>  If NAT / PAT was previously configured, then this configuration should be deleted before implementing EASY VPN.  There are features in the transform-set setup. <br><br></td></tr><tr><td>  <a href="https://habr.com/ru/post/246281/">GRE</a> <br></td><td>  Interface Tunnel, <br>  Static route <br></td><td>  Interface Tunnel, <br>  Static route <br></td><td>  Yes <br>  Int tunnel <br>  Static route <br></td><td>  Yes <br>  Static route <br></td><td>  Yes <br></td><td>  Not scalable.  Forms a P2P link, each tunnel has its own subnet.  Perfect for tunneling IGP protocols. <br></td></tr><tr><td>  <a href="https://habr.com/ru/post/246281/">IGP over GRE</a> <br></td><td>  Interface Tunnel, <br>  Static route <br></td><td>  Interface Tunnel, <br>  Static route <br></td><td>  Yes <br>  Int tunnel <br></td><td>  Not <br></td><td>  Yes <br></td><td>  Not scalable. <br>  Each tunnel has its own subnet.  IGP protocols work through a tunnel with default settings. <br></td></tr><tr><td>  <a href="https://habr.com/ru/post/246281/">DMVPN</a> (proprietary) <br></td><td>  DMVPN phase 1 - mGRE only <br>  DMVPN phase 2 - setting up the ipsec profile to protect traffic <br></td><td>  Minimum: <br>  DMVPN phase 1 - mGRE only <br>  DMVPN phase 2 - setting up the ipsec profile to protect traffic <br></td><td>  Not <br></td><td>  Not: <br>  when adding a new spoke - the tunnel to it is built automatically <br></td><td>  Yes: <br>  EIGRP on HUB turn off the split of the horizon and save yourself as next-hop in route announcements <br></td><td>  The most scalable protocol.  GRE multipoint.  Tunnels between remote offices are dynamically created. <br></td></tr><tr><td>  <a href="https://habr.com/ru/post/246281/">PPTP</a> <br></td><td>  Vpdn-group, <br>  interface virtual-template, <br>  IP local pool, <br>  username / password for authorization, static route to the office network <br></td><td>  service internal (to enable client pptp settings), <br>  vpdn-group, interface dialer, dialer-list, <br>  static route to center networks., Del.  office <br></td><td>  Yes <br>  Static route for internal networks for PPTP client <br></td><td>  Yes <br>  Static route for new internal networks for a new PPTP client <br></td><td>  Yes <br></td><td>  Scalable with restrictions. <br>  Morally obsolete protocol, vulnerabilities in cryptography in the MSCHAPv2 authorization protocol.  Most often used to create remote access.  Supported by many popular versions of Windows.  Isp only one protocol for encryption -MPPE (RC4 with a 128-bit key).  It supports multicast, because  PPP are encapsulated in GRE. <br></td></tr><tr><td>  IGP over PPTP <br></td><td>  Vpdn-group, <br>  interface virtual-template, <br>  IP local pool, <br>  username / password for authentication, IGP protocol (router ospf process) <br></td><td>  service internal (to enable client pptp settings), <br>  vpdn-group, interface dialer, dialer-list, <br>  IGP protocol (router ospf process) <br></td><td>  Not <br></td><td>  Not <br></td><td>  Yes <br></td><td>  Scalable with restrictions. <br>  It supports multicast, because  PPP are encapsulated in GRE. <br>  Morally obsolete protocol -&gt; L2TP over IPSec alternative <br></td></tr><tr><td>  <a href="https://habr.com/ru/post/246281/">L2TPv3</a> <a href="https://habr.com/ru/post/246281/"><br></a>  <a href="https://habr.com/ru/post/246281/">xconnect</a> <br></td><td>  pseudowire-class <br>  xconnect <br></td><td>  pseudowire-class <br>  xconnect <br></td><td>  Yes <br>  xconnect <br></td><td>  Not <br></td><td>  Yes <br></td><td>  Not scalable. <br>  Great for posting native L2 vlan over IP network.  But, you must have a backup gateway by default.  Creating xconnect on the router interface, we have to remove the IP address from its interface, thereby removing the default route for all devices within this network. <br></td></tr><tr><td>  <a href="https://habr.com/ru/post/246281/">L2TPv2 / v3</a> <br></td><td>  aaa new-model, <br>  username to authorize L2TP peer, <br>  VPDN-group, <br>  interface virtual-template, <br>  static route to networks beats.  office <br></td><td>  username for authorization L2TP HUBa, <br>  interface virtual-ppp, <br>  pseudowire class, <br>  static route to center networks., Del.  office <br></td><td>  Yes: <br>  static route to remote office internal networks <br></td><td>  Yes: <br>  static route to remote office internal networks <br></td><td>  Yes <br></td><td>  Scalable. <br>  L2TPv3 provides great benefits by allowing you to not only encapsulate PPP traffic, like L2TPv2, but also send a VLAN tag and also encapsulate HDLC, Frame Relay. <br></td></tr><tr><td>  <a href="https://habr.com/ru/post/246281/">IGP over L2TPv2 / v3</a> <br></td><td>  aaa new-model, <br>  username to authorize L2TP peer, <br>  VPDN-group, <br>  interface virtual-template, <br>  IGP (router ospf process) <br></td><td>  username for authorization L2TP HUBa, <br>  interface virtual-ppp, <br>  pseudowire class, <br>  IGP (router ospf process) <br></td><td>  Not <br></td><td>  Not <br></td><td>  Yes <br></td><td>  Very scalable.  Allows you to configure the routing protocols "by default", the connection of remote offices via L2TPv2 / v3 HUB (at the central office). <br></td></tr></tbody></table><br><br><h1>  The establishment of IPSec, messages, modes of operation. </h1><br>  In the process of establishing a connection via IPSec, two participants of a secure channel need to agree on a significant number of parameters: if necessary, they must authenticate each other, generate and exchange shared keys (and through an untrusted environment), determine what traffic to encrypt (from which sender and to which recipient) and also to agree with the help of which protocols to encrypt, and with the help of which - to authenticate.  The service information is supposed to be exchanged a lot, isn't it?  For this reason, IPSec consists of a protocol stack, the responsibility of which is to ensure the establishment, operation and management of a secure connection.  The process of establishing a connection consists of 2 phases: the first phase is established in order to ensure the secure exchange of ISAKMP messages in the second phase.  And the ISAKMP (Internet Security Association and Key Management Protocol) is used to negotiate security policies (SA) between the participants of a VPN connection, which is determined by what protocol to encrypt (AES, 3DES, DES), and then authenticate (HMAC SHA, MD5). <br><br><h4>  Mode of operation IKE (Internet Key Exchange): </h4><br><h5>  IKE Phase 1 </h5><br><ul><li>  (optional) peer authentication </li><li>  IKE SA negotiation between peers </li></ul><br>  <b>Main</b> <b>Mode</b> (6 posts) <br><ul><li>  [First exchange] Beginning of approvals begins with peering to each other offers of supported encryption, authentication protocols of the IKE messages themselves, the lifetime of the security associations.  A feast chooses the proposed SA and sends them to the proposed feast.  These settings are defined in the ISAKMP Policy </li><li>  [Second exchange] Generate shared shared keys through public key exchange via Diffie-Hellman.  Further messaging occurs already encrypted messages. </li><li>  [Third exchange] Messaging for ISAKMP session authentication (IKE_I_MM4 <i>)</i> </li></ul><br>  After installing IKE SA (i.e., establishing the 1st phase), IPSEC negotiation occurs in quick mode (QM).  Messages Mode Main Mode (MM): <br>  - <i>IKE_READY New State = IKE_I_MM1</i> <br>  - <i>IKE_I_MM1 New State = IKE_I_MM2</i> <br>  - <i>IKE_I_MM2 New State = IKE_I_MM3</i> <br>  - <i>IKE_I_MM3 New State = IKE_I_MM4</i> <br>  - <i>IKE_I_MM4 New State = IKE_I_MM5</i> <br>  - <i>IKE_I_MM5 New State = IKE_I_MM6</i> <br>  <b>Aggressive</b> <b>Mode</b> (3 posts) <br>  The initiator places in the first message the proposal for encryption, the authentication protocol of the IKE messages themselves, the lifetime of the keys, the Diffie-Hellman key exchange (DH) message, the session identifier, its authentication. <br>  Command to diagnose this phase on Cisco equipment <b>** show crypto isakmp sa</b> <br><br><h5>  IKE Phase 1.5 </h5><br>  Not used in a standard peer-to-peer VPN connection, used for remote connections. <br>  It has two modes: <br>  <b>Xauth</b> (User Authentication) <ul><li>  Additional user authentication within the IKE protocol.  For this, the Extended Authentication protocol is used. </li></ul><br>  <b>Mode config</b> (Push Config) <ul><li>  Additional information is transmitted to the client about the IP address, mask, DNS servers, etc. </li></ul><br><br><h5>  IKE Phase 2 </h5><br>  <b>IPsec SAs / SPIs</b> <br>  At this point, the ISAKMP is responsible for exchanging session keys and negotiating security policy (SA) to ensure the confidentiality and integrity of user traffic.  In the configuration (in Cisco IOS), the transform-set is responsible for this. <br>  <b>Quick mode</b> <br>  QM does all the things that IPSec SAs / SPIs do with less overhead.  By analogy with Aggressive Mode. <br>  Consider an example of the exchange of service messages during the establishment of an IPSec tunnel.  A working option. <br><table border="1" cellpadding="4"><tbody><tr><td>  ISAKMP: (1007): Old State = <b>IKE_I_MM6</b> New State = <b>IKE_I_MM6</b> <br>  * Sep 3 08: 59: 27.539: ISAKMP: (1007): Input = IKE_MESG_INTERNAL, <b>IKE_PROCESS_COMPLETE</b> <br>  * Sep 3 08: 59: 27.543: ISAKMP: (1007): Old State = <b>IKE_I_MM6</b> New State = <b>IKE_P1_COMPLETE</b> </td></tr></tbody></table><br><br>  <b>PHASE</b> <b>2</b> <br><table border="1" cellpadding="4"><tbody><tr><td>  * Sep 3 08: 59: 27.559: ISAKMP: (1007): <b>beginning Quick Mode</b> exchange, M-ID of 2551719066 <br>  * Sep 3 08: 59: 27.563: ISAKMP: (1007): QM Initiator gets spi <br>  * Sep 3 08: 59: 27.575: ISAKMP: (1007): sending packet to 192.168.0.2 my_port 500 peer_port 500 (I) QM_IDLE <br>  * Sep 3 08: 59: 27.575: ISAKMP: (1007): Sending an <b>IKE IPv4 Packet</b> . <br>  * Sep 3 08: 59: 27.583: ISAKMP: (1007): Node 2551719066, Input = IKE_MESG_INTERNAL, IKE_INIT_QM <br>  * Sep 3 08: 59: 27.587: ISAKMP: (1007): Old State <b>= IKE_QM_READY</b> New State = <b>IKE_QM_I_QM1</b> <br><br>  * Sep 3 08: 59: 27.803: ISAKMP: (1007): Checking IPSec proposal 1 <br>  * Sep 3 08: 59: 27.803: ISAKMP: transform 1, ESP_AES <br>  * Sep 3 08: 59: 27.807: ISAKMP: attributes in <b>transform</b> : <br>  * Sep 3 08: 59: 27.807: ISAKMP: encaps is 1 (Tunnel) <br>  * Sep 3 08: 59: 27.811: ISAKMP: SA life type in seconds <br>  * Sep 3 08: 59: 27.815: ISAKMP: SA life duration (basic) of 3600 <br>  * Sep 3 08: 59: 27.815: ISAKMP: SA life type in kilobytes <br>  * Sep 3 08: 59: 27.819: ISAKMP: SA life duration (VPI) of 0x0 0x46 0x50 0x0 <br>  * Sep 3 08: 59: 27.827: ISAKMP: authenticator is HMAC-SHA <br>  * Sep 3 08: 59: 27.827: ISAKMP: key length is 128 <br>  * Sep 3 08: 59: 27.831: ISAKMP: (1007): <b>atts are acceptable.</b> <br>  * Sep 3 08: 59: 27.855: ISAKMP: (1007): Old State = IKE_QM_I_QM1 New State = IKE_QM_IPSEC_INSTALL_AWAIT <br>  ISAKMP: (1007): Old State = IKE_QM_IPSEC_INSTALL_AWAIT New State = <b>IKE_QM_PHASE2_COMPLETE</b> </td></tr></tbody></table><br>  And now I propose to consider a couple of examples of IPSec inoperability. <br><br><h3>  Case1 </h3><br>  <i>‚ÄúOld State = IKE_I_MM1 New State = IKE_I_MM1‚Äù</i> <br>  <b>Reason # 1</b> <br>  We did not agree on an IKE proposal (proposed by IKE) in Phase 1. 3des is indicated on one side, aes on the other side. <br><table border="1" cellpadding="4"><tbody><tr><td>  Error while processing SA request: Failed to initialize SA <br>  * Sep 3 08: 36: 38.239: ISAKMP: Error while processing KMI message 0, error 2. <br>  * Sep 3 08: 36: 38.287: ISAKMP: (0): retransmitting phase 1 MM_NO_STATE ... <br>  * Sep 3 08: 40: 38.307: ISAKMP (0): incrementing error on ret 5, retransmit phase 1 <br>  * Sep 3 08: 40: 38.307: ISAKMP: (0): retransmitting phase 1 MM_NO_STATE <br>  * Sep 3 08: 37: 08.339: ISAKMP: (0): deleting SA reason "Death by retransmission P1" state (I) MM_NO_STATE (peer 192.168.0.2) <br>  * Sep 3 08: 41: 08.359: ISAKMP: (0): Input = IKE_MESG_INTERNAL, IKE_PHASE1_DEL <br>  * Sep 3 08: 41: 08.359: ISAKMP: (0): Old State = IKE_I_MM1 New State = IKE_DEST_SA </td></tr></tbody></table><br>  The router displays the following status: <br><table border="1" cellpadding="4"><tbody><tr><td>  R7 # sh crypto isakmp sa <br>  IPv4 Crypto ISAKMP SA <br>  dst src state conn-id status <br>  192.168.0.2 192.168.0.1 MM_NO_STATE 0 ACTIVE </td></tr></tbody></table><br>  <b>Reason # 2</b> <br>  The ACL on the physical interface blocks ISAKMP traffic. <br><br><h3>  Case2 </h3><br>  If transform set on one router is one <br><table border="1" cellpadding="4"><tbody><tr><td>  R7 # sh run |  i transform <br>  crypto ipsec transform-set TRANSFORM <b>esp-aes esp-md5-hmac</b> </td></tr></tbody></table><br>  ... and on the other router another <br><table border="1" cellpadding="4"><tbody><tr><td>  R10 # sh run |  i transform <br>  crypto ipsec transform-set TRANSFORM <b>esp-aes esp-sha-hmac</b> </td></tr></tbody></table><br>  , then IPSEC SA will not converge (the number of encrypted and decrypted packets will not increase <br><table border="1" cellpadding="4"><tbody><tr><td>  * Sep 3 08: 56: 08.551: ISAKMP: (1006): IPSec policy invalidated proposal with error 256 <br>  * Sep 3 08: 56: 08.559: ISAKMP: (1006): <b>phase 2 SA policy not acceptable!</b>  (local 192.168.0.1 remote 192.168.0.2) <br>  * Sep 3 08: 56: 08.563: ISAKMP: set new node -1456368678 to QM_IDLE <br>  * Sep 3 08: 56: 08.567: ISAKMP: (1006): Sending NOTIFY PROPOSAL_NOT_CHOSEN protocol 3 <br>  spi 1785687224, message ID = 2838598618 <br>  * Sep 3 08: 56: 08.575: ISAKMP: (1006): sending packet to 192.168.0.2 my_port 500 peer_port 500 (I) QM_IDLE <br>  * Sep 3 08: 56: 08.579: ISAKMP: (1006): Sending an IKE IPv4 Packet. <br>  * Sep 3 08: 56: 08.583: ISAKMP: (1006): purging node -1456368678 <br>  * Sep 3 08: 56: 08.587: ISAKMP: (1006): deleting node 1350414148 error TRUE reason " <b>QM rejected</b> " <br>  * Sep 3 08: 56: 08.591: ISAKMP: (1006): Node 1350414148, Input = IKE_MESG_FROM_PEER, IKE_QM_EXCH <br>  * Sep 3 08: 56: 08.595: ISAKMP: (1006): Old State = IKE_QM_READY New State = IKE_QM_READY </td></tr></tbody></table><br><h3>  Case3 </h3><br>  If the preshared key on the IPSec peers is incorrect <br><table border="1" cellpadding="4"><tbody><tr><td>  <b>R7</b> #sh run |  i isakmp key <br>  crypto isakmp key <b>cisco123</b> address 172.16.1.2 </td></tr></tbody></table><br><table border="1" cellpadding="4"><tbody><tr><td>  <b>R10</b> #sh run |  i isakmp key <br>  crypto isakmp key <b>cisco</b> address 0.0.0.0 0.0.0.0 </td></tr></tbody></table><br><br>  Then there will be an error retransmitting phase 1 <b>MM_KEY_EXCH</b> <br><table border="1" cellpadding="4"><tbody><tr><td>  * Sep 3 09: 14: 30.659: ISAKMP: (1010): retransmitting phase 1 MM_KEY_EXCH ... <br>  * Sep 3 09: 14: 30.663: ISAKMP (1010): incrementing error on ret 5, retransmit phase 1 <br>  * Sep 3 09: 14: 30.663: ISAKMP: (1010): retransmitting phase 1 MM_KEY_EXCH <br>  * Sep 3 09: 14: 30.663: ISAKMP: (1010): sending packet to 192.168.0.2 my_port 500 peer_port 500 (I) MM_KEY_EXCH <br>  * Sep 3 09: 14: 30.663: ISAKMP: (1010): Sending an IKE IPv4 Packet. <br>  * Sep 3 09: 14: 30.711: ISAKMP (1010): received packet from 192.168.0.2 dport 500 sport 500 Global (I) MM_KEY_EXCH <br>  * Sep 3 09: 14: 30.715: ISAKMP: (1010): phase 1 packet is a duplicate of a previous packet. <br>  * Sep 3 09: 14: 50.883: ISAKMP: (1011): retransmitting due to retransmit <b>phase 1</b> <br>  * Sep 3 09: 14: 51.383: ISAKMP: (1011): retransmitting phase 1 <b>MM_KEY_EXCH ...</b> <br>  * Sep 3 09: 14: 51.387: ISAKMP: (1011): peer does not paranoid keepalives. <br>  * Sep 3 09: 14: 51.387: ISAKMP: (1011): deleting SA reason "Death by retransmission P1" state ¬Æ MM_KEY_EXCH (peer 192.168.0.2) <br>  * Sep 3 09: 14: 51.395: ISAKMP: (1011): Input = IKE_MESG_INTERNAL, IKE_PHASE1_DEL </td></tr></tbody></table><br><br><h1>  Regular IPSec </h1><br><br><img src="https://habrastorage.org/files/4d4/1ba/8ea/4d41ba8ea9194ce39b676165d4b1381b.jpg"><br><br><h3>  Setup via Crypto map </h3><br>  Device Configuration: <br><table border="1" cellpadding="4"><tbody><tr><td>  <b>Hub</b> <br></td><td>  <b>Spoke1</b> <br></td></tr><tr><td>  Configure the first IPSec phase for session key exchange: <br><br>  crypto isakmp policy 1 <br>  hash md5 <br>  authentication pre-share <br>  group 5 <br>  crypto isakmp key cisco123 address 172.16.1.2 <br>  ! <br>  Setting up the second phase of IPSec c setting the encryption algorithm and authentication <br><br>  crypto ipsec transform-set Trans_HUB1_SP1 esp-aes 256 esp-md5-hmac <br>  ! <br>  crypto map HUB_SPOKEs 1 ipsec-isakmp <br>  set peer 172.16.1.2 <br>  set transform-set Trans_HUB1_SP1 <br>  match address TO_Spoke1 <br>  reverse-route static <br>  ! <br></td><td>  crypto isakmp policy 1 <br>  hash md5 <br>  authentication pre-share <br>  group 5 <br>  crypto isakmp key cisco123 address 192.168.1.1 <br>  ! <br>  crypto ipsec transform-set Trans_SP1_HUB1 esp-aes 256 esp-md5-hmac <br>  ! <br>  crypto map SP1_HUB 1 ipsec-isakmp <br>  set peer 192.168.1.1 <br>  set transform-set Trans_SP1_HUB1 <br>  match address TO_HUB <br>  reverse-route static <br>  ! <br></td></tr><tr><td colspan="2">  Configuring route wrapping in a tunnel <br></td></tr><tr><td>  ip access-list extended TO_Spoke1 <br>  permit ip 10.0.0.0 0.0.0.255 1.1.1.0 0.0.0.255 <br>  ! <br>  Interface Ethernet0 / 0 <br>  ip address 192.168.1.1 255.255.255.0 <br>  crypto map HUB_SPOKEs <br>  ! <br></td><td>  ip access-list extended TO_HUB <br>  permit ip 1.1.1.0 0.0.0.255 10.0.0.0 0.0.0.255 <br>  ! <br>  Interface Ethernet0 / 0 <br>  ip address 172.16.1.1 255.255.255.0 <br>  crypto map SP1_HUB <br>  ! <br></td></tr></tbody></table><br><br>  Health check <br><table border="1" cellpadding="4"><tbody><tr><td>  <b>HUB</b> #ping 1.1.1.1 source 10.0.0.1 <br>  . !!!! <br>  Success rate is 80 percent (4/5), round-trip min / avg / max = 4/4/5 ms <br></td><td>  <b>Spoke1</b> #ping 10.0.0.1 source 1.1.1.1 <br>  . !!!! <br>  Success rate is 80 percent (4/5), round-trip min / avg / max = 4/4/5 ms <br></td></tr><tr><td colspan="2">  VPN Convergence Check: <br></td></tr><tr><td colspan="2">  Successful key exchange: <br>  <b>Spoke1</b> #show crypto isakmp sa <br>  IPv4 Crypto ISAKMP SA <br>  dst src state conn-id status <br>  192.168.1.1 172.16.1.2 QM_IDLE 1007 ACTIVE <br><br>  Successful passing of traffic through VPN: <br>  <b>Spoke1</b> #show crypto ipsec sa <br><br>  interface: Ethernet0 / 0 <br>  Crypto map tag: SP1_HUB, local addr 172.16.1.2 <br><br>  protected vrf: (none) <br>  local ident (addr / mask / prot / port): (1.1.1.0/255.255.255.0/256/0) <br>  remote ident (addr / mask / prot / port): (10.0.0.0/255.255.255.0/256/0) <br>  current_peer 192.168.1.1 port 500 <br>  PERMIT, flags = {origin_is_acl,} <br>  # <b>pkts encaps: 4</b> , #pkts encrypt: 4, #pkts digest: 4 <br>  # <b>pkts decaps: 4</b> , #pkts decrypt: 4, #pkts verify: 4 <br>  #pkts compressed: 0, #pkts decompressed: 0 <br>  #pkts not compressed: 0, #pkts compr.  failed: 0 <br>  #pkts not decompressed: 0, #pkts decompress failed: 0 <br>  #send errors 0, #recv errors 0 <br><br>  local crypto endpt .: 172.16.1.2, remote crypto endpt .: 192.168.1.1 <br>  path mtu 1500, ip mtu 1500, ip mtu idb Ethernet0 / 0 <br>  current outbound <b>spi: 0xA7424886 (2806139014)</b> <br>  PFS (Y / N): N, DH group: none <br></td></tr></tbody></table><br>  SPI is transmitted in the IPSec packet so that when it is received as a pier, in this case HUB, HUB knows which SA (security association) to use, that is, what encryption protocol, what authentication protocol, etc.  used as a packet to unscramble.  On the HUB there is exactly the same SA with the same SPI. <br>  Successful passing of traffic through VPN on HUB-e <br><table border="1" cellpadding="4"><tbody><tr><td>  <b>Hub</b> #sho crypto ipsec sa <br><br>  interface: Ethernet0 / 0 <br>  Crypto map tag: HUB_SPOKEs, local addr 192.168.1.1 <br><br>  protected vrf: (none) <br>  local ident (addr / mask / prot / port): (10.0.0.0/255.255.255.0/256/0) <br>  remote ident (addr / mask / prot / port): (1.1.1.0/255.255.255.0/256/0) <br>  current_peer 172.16.1.2 port 500 <br>  PERMIT, flags = {origin_is_acl,} <br>  #pkts encaps: 4, #pkts encrypt: 4, #pkts digest: 4 <br>  #pkts decaps: 4, #pkts decrypt: 4, #pkts verify: 4 <br>  #pkts compressed: 0, #pkts decompressed: 0 <br>  #pkts not compressed: 0, #pkts compr.  failed: 0 <br>  #pkts not decompressed: 0, #pkts decompress failed: 0 <br>  #send errors 0, #recv errors 0 <br><br>  local crypto endpt .: 192.168.1.1, remote crypto endpt .: 172.16.1.2 <br>  path mtu 1500, ip mtu 1500, ip mtu idb Ethernet0 / 0 <br>  current outbound spi: 0x10101858 (269490264) <br>  PFS (Y / N): N, DH group: none <br><br>  <b>inbound esp sas:</b> <br>  <b>spi: 0xA7424886 (2806139014)</b> <br>  transform: esp-256-aes esp-md5-hmac, <br>  in use settings = {Tunnel,} <br>  conn id: 19, flow_id: SW: 19, sibling_flags 80000040, crypto map: HUB_SPOKEs <br>  sa timing: remaining key lifetime (k / sec): (4360017/2846) <br>  IV size: 16 bytes <br>  replay detection support: Y <br>  Status: ACTIVE (ACTIVE) <br></td></tr></tbody></table><br><br>  Now add another Spoke, see what changes we need to make <br><table border="1" cellpadding="4"><tbody><tr><td>  Setup on HUB <br></td><td>  Setup on the new Spoke <br></td></tr><tr><td>  <b>HUB</b> # <br>  crypto isakmp policy 1 <br>  hash md5 <br>  authentication pre-share <br>  group 5 <br>  crypto isakmp key cisco123 address 172.16.1.2 <br>  <b>crypto isakmp key cisco456 address 172.16.2.3</b> <br>  ! <br>  ! <br>  crypto ipsec transform-set Trans_HUB1_SP1 esp-aes 256 esp-md5-hmac <br>  ! <br>  crypto map HUB_SPOKEs 1 ipsec-isakmp <br>  set peer 172.16.1.2 <br>  <b>set peer 172.16.2.3</b> <br>  set transform-set Trans_HUB1_SP1 <br>  match address TO_Spokes <br>  reverse-route static <br>  ! <br>  ip access-list extended TO_Spokes <br>  permit ip 10.0.0.0 0.0.0.255 1.1.1.0 0.0.0.255 <br>  <b>permit ip 10.0.0.0 0.0.0.255 2.2.2.0 0.0.0.255</b> <br><br>  <b>those.</b>  <b>to add</b> <b>N</b> <b>spoke, you need 3</b> <b>N additional lines</b> <br></td><td>  The setup is the same as on the first Spoke1 (including the internal network correction in the ACL) <br>  <b>Spoke2</b> # <br>  crypto isakmp policy 1 <br>  hash md5 <br>  authentication pre-share <br>  group 5 <br>  crypto isakmp key cisco456 address 192.168.1.1 <br>  ! <br>  ! <br>  crypto ipsec transform-set Trans_SP2_HUB1 esp-aes 256 esp-md5-hmac <br>  ! <br>  crypto map SP2_HUB 1 ipsec-isakmp <br>  set peer 192.168.1.1 <br>  set transform-set Trans_SP2_HUB1 <br>  match address TO_HUB <br>  reverse-route static <br>  ! <br>  ip access-list extended TO_HUB <br>  permit ip 2.2.2.0 0.0.0.255 10.0.0.0 0.0.0.255 <br></td></tr></tbody></table><br><br>  Verify VPN operation <br><table border="1" cellpadding="4"><tbody><tr><td>  Check availability of a second remote office: <br>  HUB # ping 2.2.2.2 source 10.0.0.1 <br>  . !!!! <br>  Success rate is 80 percent (4/5), round-trip min / avg / max = 4/4/5 ms <br><br>  An additional key exchange session with the second Spoke now appeared on HUB: <br>  Hub sho crypto isakmp sa <br>  IPv4 Crypto ISAKMP SA <br>  dst src state conn-id status <br>  192.168.1.1 172.16.2.3 QM_IDLE 1009 ACTIVE <br>  192.168.1.1 172.16.1.2 QM_IDLE 1008 ACTIVE <br><br>  However, there is no connection between the offices (even through HUB). <br>  Spoke1 # ping 2.2.2.2 source 1.1.1.1 <br>  ..... <br>  Success rate is 0 percent (0/5) <br></td></tr></tbody></table><br><br>  The lack of connectivity before Spoke2 is not surprising - it is necessary to include the internal networks of the new remote office in the Crypto ACL, as a result, in order to ensure connectivity between the Spokes through the HUB, the addition of <b>N N</b> -addressed networks to the Crypto ACL is required. <br><br><h3>  Alternative.  Multiple Crypto map. </h3><br>  An example of IPSec configuration of multiple VPNs with remote offices with dynamic or static ip addresses, when each office gets access via the VPN-HUB Internet channel, but all remote networks are located in the routing table and they are connected without using NAT. <br><br><img src="https://habrastorage.org/files/f4b/fa6/d05/f4bfa6d05dd14a35a225e7e64dc43c71.jpg"><br><br><table border="1" cellpadding="4"><tbody><tr><td>  <b>HUB #</b> <br>  crypto ipsec transform-set <b>3DES-MD5</b> esp-3des esp-md5-hmac <br>  mode tunnel <br>  ! <br>  crypto ipsec profile Spokes_VPN_Profile <br>  set security-association lifetime seconds 86400 <br>  set transform-set 3DES-MD5 <br>  set reverse-route distance 1 <br>  reverse-route <br>  ! <br>  crypto dynamic-map <b>hq-vpn</b> 30 <br>  set profile Spokes_VPN_Profile <br>  match address VPN33-32-TRAFFIC <br>  crypto dynamic-map <b>hq-vpn</b> 3348 <br>  set profile Spokes_VPN_Profile <br>  match address VPN3348-TRAFFIC <br>  crypto dynamic-map <b>hq-vpn</b> 50 <br>  set profile Spokes_VPN_Profile <br>  match address VPN33-64-TRAFFIC <br>  <b>!</b> <br>  crypto map <b>VPN</b> 1 ipsec-isakmp dynamic <b>hq-vpn</b> <br>  <b>!</b> <br>  interface GigabitEthernet1 / 0 <br>  ip address 55.1.1.5 255.255.255.0 <br>  &lt;omitted ...&gt; <br>  crypto map <b>VPN</b> <br>  <b>!</b> <br>  ip access-list extended <b>VPN33-32-TRAFFIC</b> <br>  permit ip any 192.168.33.32 0.0.0.15 <br>  ip access-list extended <b>VPN33-48-TRAFFIC</b> <br>  permit ip any 192.168.33.48 0.0.0.15 <br>  ip access-list extended <b>VPN33-64-TRAFFIC</b> <br>  permit ip any 192.168.33.64 0.0.0.15 <br></td><td>  <b>Spoke #</b> <br>  crypto ipsec transform-set <b>3DES-MD5</b> esp-3des esp-md5-hmac <br>  mode tunnel <br>  ! <br>  crypto map VPN 1 ipsec-isakmp <br>  set peer 55.1.1.5 <br>  set transform-set <b>3DES-MD5</b> <br>  match address TO_HUB <br>  reverse-route static <br>  ! <br>  interface FastEthernet0 / 0 <br>  ip address negotiated <br>  &lt;omitted ...&gt; <br>  crypto map <b>VPN</b> <br>  ! <br>  ip access-list extended TO_HUB <br>  permit ip 192.168.33.32 0.0.0.15 any <br></td></tr></tbody></table><br>  In this scheme and in this configuration at remote offices it is set up in the Crypto ACL as the destination network - ip any, i.e.  Traffic to any host will be wrapped in a tunnel, and when a new remote office is connected, there is no need to change all other Crypto ACLs in <b>N</b> remote offices. <br>  Regardless of the connection method: Regular IPSec or (running a little ahead, IPSec dynamic IP) in either case we are faced with the task of ensuring accessibility <b>between</b> remote sites.  As part of a Regular IPSec and IPSec dynamic IP connection, you need to manually define networks in a crypto ACL, so to reduce configuration on end devices after connecting another remote office, it is possible to go two ways: <br><ol><li>  Move away from the crypto map to <b>VTI</b> and configure dynamic routing. </li><li>  To configure a dynamic routing protocol (OSPF), we will switch from using the crypto map method to the same setup, but only through the VTI interface (it supports unicast, multicast). </li></ol><br><h3>  Setup via Virtual Tunnel Interface + profiles. </h3><br>  The Virtual Tunnel Interface provides a routing interface for terminating IPSec tunnels and an easier way to securely connect remote corporate networks.  VTI only supports the transmission through the tunnel of a unicast and multicast, which allows for the operation of dynamic routing protocols without the additional need to encapsulate a packet in GRE (additional 4-bytes).  There are two types of virtual tunnel interfaces: <br>  Static virtual interface - is a point-to-point tunnel <br>  Dunicic virtual interface - allows scaling a solution across VPNs by terminating multiple tunnels onto itself from remote Spoke sites, which may have a dynamic IP address.  The only drawback is that only remote spoke routers can initiate the establishment of a tunnel (since only they have specified the tunnel destination HUB_ip). <br>  When DVTI is configured, a virtual-template settings template is created on the HUB router, and when a key is exchanged with a remote spoke and a tunnel is established with it, a virtual-access interface is created on the HUB, which is the SVTI tunnel interface for this tunnel. <br>  VTI Features: <br><ul><li>  Traffic selector (i.e., the traffic that will be wrapped in the tunnel) in Static VTI is <b>always</b> ip any any; </li><li>  Dynamic VTI's traffic selector is also the default ip any any and supports only one IPSec SA, but it can accept the traffic selector that the initiator offers to it; </li><li>  Not supported by Stateful Failover; </li><li>  The transform-set mode is <b>only</b> in tunnel mode. </li></ul><br><br><img src="https://habrastorage.org/files/c83/28e/eb5/c8328eeb5266426eb911c06460e6933f.jpg"><br><br><table border="1" cellpadding="4"><tbody><tr><td colspan="2">  Configuring Static VTI through profiles <br></td></tr><tr><td>  HUB # <br>  crypto isakmp policy 1 <br>  hash md5 <br>  authentication pre-share <br>  group 5 <br>  crypto isakmp key cisco123 address 172.16.1.2 <br>  ! <br>  crypto ipsec transform-set Trans_HUB_SP esp-aes esp-sha-hmac <br>  ! <br>  crypto ipsec profile P1 <br>  set transform-set Trans_HUB_SP <br>  ! <br>  interface Tunnel0 <br>  ip address 10.1.1.254 255.255.255.0 <br>  ip ospf mtu-ignore * (see below) <br>  load-interval 30 <br>  tunnel source 192.168.1.1 <br>  tunnel mode ipsec ipv4 <br>  tunnel destination 172.16.1.2 <br>  tunnel protection ipsec profile P1 <br>  ! <br>  router ospf 1 <br>  network 10.0.0.0 0.0.0.255 area 0 <br>  network 10.1.1.0 0.0.0.255 area 0 <br></td><td>  Spoke1 # <br>  crypto isakmp policy 1 <br>  hash md5 <br>  authentication pre-share <br>  group 5 <br>  crypto isakmp key cisco123 address 192.168.1.1 <br>  ! <br>  crypto ipsec transform-set Trans_HUB_SP esp-aes esp-sha-hmac <br>  ! <br>  crypto ipsec profile P1 <br>  set transform-set Trans_HUB_SP <br>  ! <br>  interface Tunnel0 <br>  ip address 10.1.1.1 255.255.255.0 <br>  ip ospf mtu-ignore <br>  load-interval 30 <br>  tunnel source 172.16.1.2 <br>  tunnel mode ipsec ipv4 <br>  tunnel destination 192.168.1.1 <br>  tunnel protection ipsec profile P1 <br>  ! <br>  router ospf 1 <br>  network 1.1.1.0 0.0.0.255 area 0 <br>  network 10.1.1.0 0.0.0.255 area 0 <br></td></tr></tbody></table><br><br>  OSPF over Static VTI Neighborhood Check <br><table border="1" cellpadding="4"><tbody><tr><td>  Hub # sh ip opf neighbor <br><br>  Neighbor ID Pri State Dead Time Address Interface <br>  1.1.1.1 0 FULL / - 00:00:33 10.1.1.1 Tunnel0 <br><br>  <b>The network on</b> <b>Spoke 1 is now accessible via the tunnel.</b> <br>  HUB # sh ip route <br>  1.0.0.0/32 is subnetted, 1 subnets <br>  O <b>1.1.1.1</b> [110/1001] via 10.1.1.1, 00:02:56, <b>Tunnel0</b> <br>  10.0.0.0/8 is variably subnetted, 6 subnets, 2 masks <br>  C 10.0.0.0/24 is directly connected, Loopback0 <br>  L 10.0.0.1/32 is directly connected, Loopback0 <br>  C 10.0.1.0/24 is directly connected, Loopback1 <br>  L 10.0.1.1/32 is directly connected, Loopback1 <br>  C 10.1.1.0/24 is directly connected, Tunnel0 <br>  L 10.1.1.254/32 is directly connected, Tunnel0 <br><br>  <b>Checking the availability of networks in the Central Office with</b> <b>Spoke 1</b> <br>  Spoke1 # ping 10.0.0.1 source 1.1.1.1 <br>  !!!!! <br>  Success rate is 100 percent (5/5), round-trip min / avg / max = 5/5/5 ms <br></td></tr></tbody></table><br>  Traffic Selector for Static VTI ip any any, i.e. ,            ,    /. <br><table border="1" cellpadding="4"><tbody><tr><td> Spoke1#sho crypto ipsec sa <br><br> interface: Tunnel0 <br> Crypto map tag: Tunnel0-head-0, local addr 172.16.1.2 <br> protected vrf: (none) <br> local  ident (addr/mask/prot/port): ( <b>0.0.0.0</b> /0.0.0.0/256/0) <br> remote ident (addr/mask/prot/port): ( <b>0.0.0.0</b> /0.0.0.0/256/0) <br> current_peer 192.168.1.1 port 500 <br> PERMIT, flags={origin_is_acl,} <br> #pkts encaps: 76, #pkts encrypt: 76, #pkts digest: 76 <br> #pkts decaps: 65, #pkts decrypt: 65, #pkts verify: 65 <br> #pkts compressed: 0, #pkts decompressed: 0 <br> #pkts not compressed: 0, #pkts compr. failed: 0 <br> #pkts not decompressed: 0, #pkts decompress failed: 0 <br> #send errors 0, #recv errors 0 <br></td></tr></tbody></table><br><br> interface Tunnel0 <br> ip address 10.1.1.254 255.255.255.0 <br> <b>ip ospf mtu-ignore</b> <br><br> OSPF Neighbor       MTU  .  neighbor   MTU  DBD  ,  MTU   ,    . <br>    Spoke2   Tunnel (HUB-Spoke2),      . <br><table border="1" cellpadding="4"><tbody><tr><td> <b>HUB</b> #sho ip ospf neighbor <br><br> Neighbor ID     Pri   State       Dead Time   Address         Interface <br> 2.2.2.2            0   FULL/  -        00:00:31    10.1.2.2        Tunnel1 <br> 1.1.1.1            0   FULL/  -        00:00:30    10.1.1.1        Tunnel0 <br><br>   Spoke1 <br> <b>Spoke1</b> #sh ip route <br> Gateway of last resort is 172.16.1.5 to network 0.0.0.0 <br><br> &lt;...ommited...&gt; <br> C        1.1.1.0/24 is directly connected, Loopback0 <br> L        1.1.1.1/32 is directly connected, Loopback0 <br> 2.0.0.0/32 is subnetted, 1 subnets <br> <b>O        2.2.2.2</b> [110/2001] via 10.1.1.254, 01:53:04, <b>Tunnel0</b> <b>&lt;-</b> <b>Spoke2</b> <br> 10.0.0.0/8 is variably subnetted, 5 subnets, 2 masks <br> O <b>10.0.0.1</b> /32 [110/1001] via 10.1.1.254, 02:04:11, <b>Tunnel0  &lt;-  </b> <br> O <b>10.0.1.1</b> /32 [110/1001] via 10.1.1.254, 02:04:11, Tunnel0 <b>&lt;-</b> <b></b> <b></b> <b>HUB-Spoke1</b> <br> C        10.1.1.0/24 is directly connected, Tunnel0 <br> L        10.1.1.1/32 is directly connected, Tunnel0 <br> O <b>10.1.2.0/2</b> 4 [110/2000] via 10.1.1.254, 01:53:14, Tunnel0 <b>&lt;-</b> <b></b> <b></b> <b>HUB-Spoke2</b> <br> 172.16.0.0/16 is variably subnetted, 2 subnets, 2 masks <br><br>        : <br> <b>Spoke1</b> #traceroute 2.2.2.2 <br> Type escape sequence to abort. <br> Tracing the route to 2.2.2.2 <br> VRF info: (vrf in name/id, vrf out name/id) <br> 1 10.1.1.254 5 msec 4 msec 5 msec <br> 2 10.1.2.2 5 msec 10 msec * <br></td></tr></tbody></table><br><br><h1> IPSec with Dynamic IP, Dynamic VTI </h1><br><br><img src="https://habrastorage.org/files/8e9/8ec/f20/8e98ecf209d34ad281035f1fa734a435.jpg"><br><br>        Dynamic VTI  HUB, Static VTI  spoke-.   Dynamic VTI       crypto map-. <br><table border="1" cellpadding="4"><tbody><tr><td> HUB# <br> crypto keyring KEY_Dynamic_connection <br> pre-shared-key address 0.0.0.0 0.0.0.0 key cisco123 <br> ! <br> crypto isakmp policy 1 <br> hash md5 <br> authentication pre-share <br> group 5 <br> crypto isakmp profile DVTI <br> keyring KEY_Dynamic_connection <br> match identity address 0.0.0.0 <br> virtual-template 1 <br> ! <br> crypto ipsec transform-set Trans_HUB_SP esp-aes esp-sha-hmac <br> ! <br> crypto ipsec profile P1 <br> set transform-set Trans_HUB_SP <br> set isakmp-profile DVTI <br> ! <br> interface Loopback1 <br> ip address 10.1.1.254 255.255.255.0 <br> ! <br> interface Virtual-Template1 type tunnel <br> ip unnumbered Loopback1 <br> ip ospf mtu-ignore <br> tunnel mode ipsec ipv4 <br> tunnel protection ipsec profile P1 <br> ! <br> router ospf 1 <br> network 10.0.0.0 0.0.0.255 area 0 <br> network 10.1.1.0 0.0.0.255 area 0 <br></td><td> Spoke1# <br> crypto keyring KEY_Dynamic_connection <br> pre-shared-key address 0.0.0.0 0.0.0.0 key cisco123 <br> ! <br> crypto isakmp policy 1 <br> hash md5 <br> authentication pre-share <br> group 5 <br> crypto isakmp profile DVTI <br> keyring KEY_Dynamic_connection <br> match identity address 0.0.0.0 <br> ! <br> crypto ipsec transform-set Trans_HUB_SP esp-aes esp-sha-hmac <br> ! <br> crypto ipsec profile P1 <br> set transform-set Trans_HUB_SP <br> set isakmp-profile DVTI <br> ! <br> interface Loopback1 <br> ip address 10.1.1.1 255.255.255.0 <br> ! <br> interface Tunnel0 <br> ip unnumbered Loopback1 <br> ip ospf mtu-ignore <br> tunnel source Ethernet0/0 <br> tunnel mode ipsec ipv4 <br> tunnel destination 192.168.1.1 <br> tunnel protection ipsec profile P1 <br> ! <br> router ospf 1 <br> network 1.1.1.0 0.0.0.255 area 0 <br> network 10.1.1.0 0.0.0.255 area 0 <br></td></tr></tbody></table><br>       Spoke-: <br><table border="1" cellpadding="4"><tbody><tr><td> HUB#sh crypto isakmp sa <br> IPv4 Crypto ISAKMP SA <br> dst                  src                  state            conn-id status <br> 192.168.1.1     172.16.2.3      QM_IDLE           1047 ACTIVE <br> 192.168.1.1     172.16.1.2      QM_IDLE           1046 ACTIVE <br><br> HUB# sh ip int br <br> Interface                    IP-Address      OK? Method   Status           Protocol <br> Ethernet0/0                192.168.1.1     YES NVRAM      up                    up <br> Ethernet0/1                unassigned      YES  manual        up                    up <br> Ethernet0/2                unassigned      YES NVRAM    down              down <br> Ethernet0/3                unassigned      YES manual         up                    up <br> Loopback0                   10.0.0.1        YES manual          up                    up <br> Loopback1                   10.1.1.254      YES manual        up                     up <br> <b>Virtual-Access1</b> 10.1.1.254      YES unset           up                    up <br> <b>Virtual-Access2</b> 10.1.1.254      YES unset           up                    up <br> Virtual-Template1      10.1.1.254      YES manual         up                  down <br><br> HUB#sho crypto ipsec sa <br><br> interface: <b>Virtual-Access2</b> <br> Crypto map tag: Virtual-Access2-head-0, local addr 192.168.1.1 <br> protected vrf: (none) <br> local  ident (addr/mask/prot/port): (0.0.0.0/0.0.0.0/256/0) <br> remote ident (addr/mask/prot/port): (0.0.0.0/0.0.0.0/256/0) <br> <b>current_peer 172.16.1.2</b> port 500 <br><br> interface: <b>Virtual-Access1</b> <br> Crypto map tag: Virtual-Access1-head-0, local addr 192.168.1.1 <br> protected vrf: (none) <br> local  ident (addr/mask/prot/port): (0.0.0.0/0.0.0.0/256/0) <br> remote ident (addr/mask/prot/port): (0.0.0.0/0.0.0.0/256/0) <br> <b>current_peer 172.16.2.3</b> port 500 <br></td></tr></tbody></table><br><br>  OSPF  : <br><table border="1" cellpadding="4"><tbody><tr><td> <b>HUB</b> #sh ip ospf neighbor <br><br>  spoke-    ! <br><br> Neighbor ID     Pri   State           Dead Time   Address         Interface <br> 1.1.1.1           0     FULL/  -        00:00:32    10.1.1 <b>.1</b> <b>Virtual-Access2</b> <br> 2.2.2.2           0     FULL/  -        00:00:35    10.1.1 <b>.2</b> <b>Virtual-Access1</b> <br><br>    <br> <b>HUB</b> #sh ip route <br> Gateway of last resort is not set <br><br> 1.0.0.0/32 is subnetted, 1 subnets <br> <b>O        1.1.1.1</b> [110/2] via 10.1.1.1, 00:05:00, Virtual-Access2 <b>&lt;-</b> <b></b> <b>Spoke1</b> <br> 2.0.0.0/32 is subnetted, 1 subnets <br> <b>O        2.2.2.2</b> [110/2] via 10.1.1.2, 00:44:01, Virtual-Access1 <b>&lt;-</b> <b></b> <b>Spoke2</b> <br> 10.0.0.0/8 is variably subnetted, 6 subnets, 2 masks <br> C        10.0.0.0/24 is directly connected, Loopback0 <br> L        10.0.0.1/32 is directly connected, Loopback0 <br> C        10.1.1.0/24 is directly connected, Loopback1 <br> <b>O        10.1.1.1</b> /32 [110/2] via 10.1.1.1, 00:05:00, Virtual-Access2 <b>&lt;-</b> <b></b> <b></b> <b>Spoke1</b> <br> <b>O        10.1.1.2</b> /32 [110/2] via 10.1.1.2, 00:44:01, Virtual-Access1 <b>&lt;-</b> <b></b> <b></b> <b>Spoke2</b> <br> L        10.1.1.254/32 is directly connected, Loopback1 <br> 172.16.0.0/24 is subnetted, 3 subnets <br> 192.168.1.0/24 is variably subnetted, 2 subnets, 2 masks <br> C        192.168.1.0/24 is directly connected, Ethernet0/0 <br> L        192.168.1.1/32 is directly connected, Ethernet0/0 <br><br>   Spoke1: <br> <b>Spoke1</b> #sh ip route <br> Gateway of last resort is 172.16.1.5 to network 0.0.0.0 <br><br> S*    0.0.0.0/0 [1/0] via 172.16.1.5 <br> 1.0.0.0/8 is variably subnetted, 2 subnets, 2 masks <br> C        1.1.1.0/24 is directly connected, Loopback0 <br> L        1.1.1.1/32 is directly connected, Loopback0 <br> 2.0.0.0/32 is subnetted, 1 subnets <br> <b>O        2.2.2.2</b> [110/1002] via 10.1.1.254, 00:05:38, <b>Tunnel0 &lt;-</b> <b></b> <b>Spoke2</b> <br> 10.0.0.0/8 is variably subnetted, 5 subnets, 2 masks <br> <b>O        10.0.0.1</b> /32 [110/1001] via 10.1.1.254, 00:05:38, <b>Tunnel0 &lt;-</b> <b></b> <b></b> <b></b> <br> C        10.1.1.0/24 is directly connected, Loopback1 <br> L        10.1.1.1/32 is directly connected, Loopback1 <br> <b>O        10.1.1.2</b> /32 [110/1002] via 10.1.1.254, 00:05:38, <b>Tunnel0 &lt;-</b> <b></b> <b></b> <b>Spoke2</b> <br> <b>O        10.1.1.254</b> /32 [110/1001] via 10.1.1.254, 00:02:26, <b>Tunnel0 &lt;-</b> <b></b> <b></b> <b>HUBa</b> <br> 172.16.0.0/16 is variably subnetted, 2 subnets, 2 masks <br> C        172.16.1.0/24 is directly connected, Ethernet0/0 <br> L        172.16.1.2/32 is directly connected, Ethernet0/0 <br><br> <b>Spoke1</b> #traceroute 2.2.2.2 <br> 1 10.1.1.254 5 msec 5 msec 5 msec <br> 2 10.1.1.2     9 msec 5 msec * <br><br> <b>Spoke1</b> #traceroute 10.1.1.2 <br> 1 10.1.1.254 5 msec 5 msec 5 msec <br> 2 10.1.1.2     5 msec 10 msec * <br></td></tr></tbody></table><br><br>      <br>  Tunnel   Spoke,  ipsec    .     : <br><table border="1" cellpadding="4"><tbody><tr><td> <b>Spoke1</b> (config-if)#no shutdown <br> *Aug  6 10:02:27.669: %CRYPTO-6-ISAKMP_ON_OFF: ISAKMP is ON <br> *Aug  6 <b>10:02:27.702</b> : %LINEPROTO-5-UPDOWN: Line protocol on Interface Tunnel0, changed state to up <br> *Aug  6 <b>10:02:27.713</b> : %OSPF-5-ADJCHG: Process 1, Nbr 10.0.0.1 on Tunnel0 from LOADING to FULL, Loading Done <br></td></tr></tbody></table><br>    . <br><br><h1> EASY VPN </h1><br>   Easy VPN     VPN-    ,     IPSec  VPN-  VPN HUB-.        (ISAKMP)     1.5.    vpn-     IP-, DNS-, ACL  split tunnel.           Cisco VPN Client. <br>    Easy VPN Remote <a href="http://www.anticisco.ru/blogs/2012/06/cisco-easy-vpn/">[1]</a> : <br><ul><li>  .     VPN-()       NAT/PAT-  ,       </li><li>   .   ,   ,    VPN- (),  IP-     IP-.    PAT  ,          . </li><li>    ¬´¬ª.     ,        IP-             Loopback-.   IPsec   IP-   Easy VPN Remote'.  IP       (ping, telnet, ssh  ..). </li></ul><br>     : <br> Cisco Easy VPN Remote   transform set      (ESP-DES and ESP-3DES)  transform-set,     (ESP-NULL ESP-SHA-HMAC and ESP-NULL ESP-MD5-HMAC) <br>   VPN- ()  NAT/PAT   Cisco Easy VPN Remote,       NAT- (    ) <br><br><img src="https://habrastorage.org/files/9b4/9f2/3a0/9b49f23a007e4828beebe8484784aa32.jpg"><br><br><h3>  Easy VPN  client mode </h3><br>  VPN- ()       NAT/PAT-  ,       <br><table border="1" cellpadding="4"><tbody><tr><td> <b>VPN_HUB#</b> <br> aaa new-model <br> ! <br> aaa authorization network LOCAL-AUTHOR local <br> crypto isakmp policy 10 <br> authentication pre-share <br> group 2 <br> ! <br> crypto isakmp client configuration group VPN-CLIENT-GROUP <br> key vpnclientcisco <br> pool VPN-LOCAL-POOL <br> acl 100 <br> crypto isakmp profile PROFILE-ISAKMP <br> match identity group VPN-CLIENT-GROUP <br> isakmp authorization list LOCAL-AUTHOR <br> client configuration address respond <br> client configuration group VPN-CLIENT-GROUP <br> virtual-template 1 <br> ! <br> crypto ipsec transform-set TRANSFORM-IPSEC esp-aes esp-sha-hmac <br> ! <br> crypto ipsec profile PROFILE-IPSEC <br> set transform-set TRANSFORM-IPSEC <br> set isakmp-profile PROFILE-ISAKMP <br> interface Ethernet0/0 <br> ip address 192.168.1.2 255.255.255.0 <br> ip nat inside <br> ip virtual-reassembly in <br> ! <br> interface Ethernet0/1 <br> ip address 77.1.1.2 255.255.255.0 <br> ip nat outside <br> ip virtual-reassembly in <br> ! <br> interface Virtual-Template1 type tunnel <br> ip unnumbered Ethernet0/1 <br> ip nat inside <br> ip virtual-reassembly in <br> tunnel mode ipsec ipv4 <br> tunnel protection ipsec profile PROFILE-IPSEC <br> ! <br> ip local pool VPN-LOCAL-POOL 172.16.40.1 172.16.40.100 <br> ! <br> ip nat inside source list TONAT interface Ethernet0/1 overload <br></td><td> ( ip  VPN HUB,  VPN-,   VPN-   ) <br> <b>VPN_Client</b> # <br> crypto ipsec client ezvpn EZVPN-CLIENT <br> connect auto <br> group VPN-CLIENT-GROUP key vpnclientcisco <br> mode client <br> peer 77.1.1.2 <br> username cisco password cisco <br> xauth userid mode local <br> ! <br> interface Ethernet0/0 <br> ip address 172.16.1.7 255.255.255.0 <br> crypto ipsec client ezvpn EZVPN-CLIENT <br> ! <br> interface Ethernet0/2 <br> ip address 192.168.2.7 255.255.255.0 <br> ip nat inside <br> crypto ipsec client ezvpn EZVPN-CLIENT inside <br></td></tr><tr><td colspan="2"> <b>  </b> <b>IP</b> <br> <b>VPN_</b> <b>Client</b> #sh ip int br <br> Interface                     IP-Address       OK? Method     Status                Protocol <br> Ethernet0/0                172.16.1.7       YES NVRAM        up                    up <br> Ethernet0/2                192.168.2.7     YES NVRAM        up                    up <br> Loopback0                   7.7.7.7           YES NVRAM       up                     up <br> Loopback10000 <b>172.16.40.49</b> YES TFTP            up                   up <br> NVI0                            172.16.1.7   YES unset            up                    up <br></td></tr></tbody></table><br>   ip outside nat (ip nat inside   )   <b>ACL!</b> <br> ,  NAT  ,         ACL    <br><table border="1" cellpadding="4"><tbody><tr><td> <b>VPN_Client</b> #sh ip nat statistics <br> Total active translations: 0 (0 static, 0 dynamic; 0 extended) <br> Peak translations: 0 <br> Outside interfaces: <br> Ethernet0/0 <br> Inside interfaces: <br> Ethernet0/2 <br> Hits: 0  Misses: 0 <br> CEF Translated packets: 0, CEF Punted packets: 0 <br> Expired translations: 0 <br> Dynamic mappings: <br> ‚Äî Inside Source <br> [Id: 106] access-list <b>EZVPN-CLIENT_internet-list</b> interface Ethernet0/0 refcount 0 <br> [Id: 105] access-list <b>EZVPN-CLIENT_enterprise-list</b> pool EZVPN-CLIENT refcount 0 <br> pool EZVPN-CLIENT: netmask 255.255.255.0 <br> start 172.16.40.49 end 172.16.40.49 <br> type generic, total addresses 1, allocated 0 (0%), misses 0 <br></td></tr></tbody></table><br> ,      . ,      <br><table border="1" cellpadding="4"><tbody><tr><td> <b>VPN_Client#sh access-lists</b> <b>EZVPN-CLIENT_internet-list (</b> <b></b> <b></b> <b></b> <b></b> <b></b> <b></b> <b>)</b> <br> Extended IP access list EZVPN-CLIENT_internet-list <br> 10 deny ip 192.168.2.0 0.0.0.255 192.168.1.0 0.0.0.255 <br> 20 deny ip 192.168.2.0 0.0.0.255 2.2.2.0 0.0.0.255 <br> 30 permit ip 192.168.2.0 0.0.0.255 any <br> ! <br> <b>VPN_Client</b> #sh access-lists <b>EZVPN-CLIENT_enterprise-list (</b> <b></b> <b></b> <b></b> <b></b> <b></b> <b>IP)</b> <br> Extended IP access list EZVPN-CLIENT_enterprise-list <br> 10 permit ip 192.168.2.0 0.0.0.255 192.168.1.0 0.0.0.255 <br> 20 permit ip 192.168.2.0 0.0.0.255 2.2.2.0 0.0.0.255 <br></td></tr></tbody></table><br><br><h1> GRE tunnel. OSPF over GRE </h1><br> Gre        ,        (OSPF, EIGRP)  IPv6 .       IP  ( 47)  GRE . GRE   ,     Cisco,      RFC 2784. <br> GRE   point-to-point        .              ()    . <br><img src="https://habrastorage.org/files/c3b/5c6/eda/c3b5c6edabae43a484ff44fb3338ac40.jpg"><br><br><table border="1" cellpadding="4"><tbody><tr><td> LNS# <br> interface Tunnel1 <br> ip address 10.3.7.3 255.255.255.0 <br> tunnel source Ethernet0/1 <br> tunnel destination 77.1.1.7 <br></td><td> LAC# <br> interface Tunnel1 <br> ip address 10.3.7.7 255.255.255.0 <br> tunnel source Ethernet0/0 <br> tunnel destination 55.1.1.3 <br></td></tr><tr><td colspan="2">    GRE,        OSFP <br></td></tr><tr><td> LNS# <br> router ospf 1 <br> network 10.3.9.0 0.0.0.255 area 0 <br> <b>network 10.3.7.0 0.0.0.255 area 0</b> <br> network 192.168.1.0 0.0.0.255 area 0 <br></td><td> LAC# <br> router ospf 1 <br> <b>network 10.3.7.0 0.0.0.255 area 0</b> <br> network 172.30.1.0 0.0.0.255 area 0 <br></td></tr></tbody></table><br><br>   OSPF <br><table border="1" cellpadding="4"><tbody><tr><td> <b>LAC</b> #sh ip ospf neighbor <br><br> Neighbor ID     Pri   State           Dead Time   Address         Interface <br> 3.3.3.3            0     FULL/  -        00:00:30     10.3.7.3 <b>Tunnel1</b> <br><br>  ,   OSPF,     . <br><br> <b>LAC</b> #sh ip route ospf <br><br> 10.3.9.0/8 is variably subnetted, 3 subnets, 2 masks <br> <b>O        10.3.9.0/24</b> [110/2000] via 10.3.7.3, 00:19:02, Tunnel1 <b>&lt; ‚Äî</b> <b></b> <b></b> <b>R3 &lt;-&gt; R9</b> <br> 99.0.0.0/32 is subnetted, 1 subnets <br> <b>O        99.99.99.99</b> [110/2001] via 10.3.7.3, 00:19:02, Tunnel1 <b>&lt; ‚Äî loopback</b> <b></b> <b>R9</b> <br> <b>O     192.168.1.0/24</b> [110/1010] via 10.3.7.3, 00:19:02, Tunnel1 <b>&lt; ‚Äî  </b> <b>HQ</b> <br><br> LAC#ping 192.168.1.1 source 172.30.1.7 <br> Type escape sequence to abort. <br> Sending 5, 100-byte ICMP Echos to 192.168.1.1, timeout is 2 seconds: <br> Packet sent with a source address of 172.30.1.7 <br> !!!!! <br> Success rate is 100 percent (5/5), round-trip min/avg/max = 1/1/1 ms <br></td></tr></tbody></table><br><br>  : <br><img src="https://habrastorage.org/files/f5f/cc0/f3e/f5fcc0f3e2584c62884976186dc02aad.jpg"><br><br><br><h2> GRE over IPSec </h2><br><table border="1" cellpadding="4"><tbody><tr><td> LNS# <br> crypto isakmp policy 10 <br> encr 3des <br> authentication pre-share <br> group 2 <br> ! <br> crypto isakmp key ipseckey123 address 77.1.1.7 <br> ! <br> crypto ipsec transform-set ESP-AES256-SHA1 esp-aes 256 esp-sha-hmac <br> mode transport <br> ! <br> crypto map GREoverIPSec  5 ipsec-isakmp <br> set peer 77.1.1.7 <br> set transform-set ESP-AES256-SHA1 <br> match address GRE <br> ! <br> !   GRE     47,           47 <br> ip access-list extended GRE <br> permit gre any any <br> ! <br> interface Ethernet0/1 <br> ip address 55.1.1.3 255.255.255.0 <br> crypto map GREoverIPSec <br></td><td> LAC# <br> crypto isakmp policy 10 <br> encr 3des <br> authentication pre-share <br> group 2 <br> ! <br> crypto isakmp key ipseckey123 address 55.1.1.3 <br> ! <br> crypto ipsec transform-set ESP-AES256-SHA1 esp-aes 256 esp-sha-hmac <br> mode transport <br> ! <br> crypto map GREoverIPSec 5 ipsec-isakmp <br> set peer 55.1.1.3 <br> set transform-set ESP-AES256-SHA1 <br> match address GRE <br> ! <br> ! <br> ip access-list extended GRE <br> permit gre any any <br> ! <br> interface Ethernet0/0 <br> ip address 77.1.1.7 255.255.255.0 <br> crypto map GREoverIPSec <br> ! <br> ! <br></td></tr></tbody></table><br><br>   GRE over IPSec <br><table border="1" cellpadding="4"><tbody><tr><td> <b>LAC</b> #ping 192.168.1.1 source 172.30.1.7 <br> Type escape sequence to abort. <br> Sending 5, 100-byte ICMP Echos to 192.168.1.1, timeout is 2 seconds: <br> Packet sent with a source address of 172.30.1.7 <br> !!!!! <br> Success rate is 100 percent (5/5), round-trip min/avg/max = 4/5/6 ms <br><br>   IPSec <br> <b>LAC</b> #sh crypto isakmp sa <br> IPv4 Crypto ISAKMP SA <br> dst                src                   state          conn-id   status <br> 55.1.1.3        77.1.1.7        QM_IDLE           1001   ACTIVE <br><br>     (SA) <br> <b>LAC</b> #sh crypto ipsec sa <br><br> interface: Ethernet0/0 <br> Crypto map tag: <b>GREoverIPSec</b> , local addr 77.1.1.7 <br><br> protected vrf: (none) <br> local  ident (addr/mask/prot/port): (0.0.0.0/0.0.0.0/47/0) <br> remote ident (addr/mask/prot/port): (0.0.0.0/0.0.0.0/47/0) <br> current_peer 55.1.1.3 port 500 <br> PERMIT, flags={origin_is_acl,} <br> # <b>pkts encaps</b> : 109, #pkts encrypt: 28559, #pkts digest: 28559 <br> # <b>pkts decaps</b> : 184, #pkts decrypt: 28784, #pkts verify: 28784 <br> #pkts compressed: 0, #pkts decompressed: 0 <br> #pkts not compressed: 0, #pkts compr. failed: 0 <br> #pkts not decompressed: 0, #pkts decompress failed: 0 <br> #send errors 0, #recv errors 0 <br><br> local crypto endpt.: 77.1.1.7, remote crypto endpt.: 55.1.1.3 <br> path mtu 1500, ip mtu 1500, ip mtu idb Ethernet0/0 <br> current outbound spi: 0xBCF71DA2(3170311586) <br> PFS (Y/N): N, DH group: none <br></td></tr></tbody></table><br>  : <br><img src="https://habrastorage.org/files/f19/e0f/cc3/f19e0fcc3fb84bd8b8b79b9855e5e0b2.jpg"><br><br>  OSPF over GRE over IPSec <br> OSPF     (   network type broadcast) <br><table border="1" cellpadding="4"><tbody><tr><td> <b>LAC</b> #sh ip ospf neighbor <br><br> Neighbor ID     Pri   State           Dead Time   Address         Interface <br> 3.3.3.3           0    FULL/  -        00:00:31    10.3.7.3          Tunnel1 <br></td></tr></tbody></table><br><br><h1> DMVPN </h1><br>  DMVPN implements multipoint GRE architecture, allowing you to use, firstly, one address space for all vpn remote offices, secondly, to pass through the tunnel a large list of third-party protocols, as well as multicast, and thirdly, to establish dynamically tunnels between regional remote sites in case of traffic between them.  However, there is one thing, this technology is only realizable on a mono-vendor network on Cisco. <br><br><img src="https://habrastorage.org/files/27e/d1e/8a9/27ed1e8a95934960b7272231147d4af6.jpg"><br><br>  Configure the HQ router as DMVPN HUB, Spoke 1 as DMVPN Client <br><table border="1" cellpadding="4"><tbody><tr><td>  <b>HUB #</b> <br>  interface Tunnel1 <br>  description DMVPN_HUB <br>  /// mGRE setup <br>  ip address 10.5.5.1 255.255.255.0 <br>  tunnel source FastEthernet0 / 0 <br>  tunnel mode gre multipoint <br>  tunnel key 111001 <br>  no ip redirects <br>  ip mtu 1416 <br>  /// NHRP setup <br>  ip nhrp map multicast dynamic <br>  ip nhrp network-id 101 <br>  ip nhrp server-only <br><br>  ip tcp adjust-mss 1376 <br>  end <br></td><td>  <b>Spoke #</b> <br>  interface Tunnel1 <br>  ip address 10.5.5.3 255.255.255.0 <br>  no ip redirects <br>  ip mtu 1416 <br><br>  ip nhrp map multicast dynamic <br>  ip nhrp map multicast 192.168.1.1 (address) <br>  ip nhrp map 10.5.5.1 192.168.1.1 <br>  ip nhrp network-id 101 <br>  ip nhrp nhs 10.5.5.1 (tunnel address) <br><br>  ip tcp adjust-mss 1380 <br>  keepalive 10 3 <br>  tunnel source FastEthernet0 / 0 <br>  tunnel mode gre multipoint <br>  tunnel key 111001 <br>  end <br></td></tr></tbody></table><br>  DMVPN operation check <br>  Check whether the tunnel is established to DMVPN HUBa. <br>  Please note that NBMA address is the real address of HUBa. <br><table border="1" cellpadding="4"><tbody><tr><td>  <b>Spoke</b> #sh dmvpn <br>  Legend: Attrb -&gt; S - Static, D - Dynamic, I - Incomplete <br>  N - NATed, L - Local, X - No Socket <br>  # Ent -&gt; Number of NHRP entries with same NBMA peer <br>  NHS Status: E -&gt; Expecting Replies, R -&gt; Responding, W -&gt; Waiting <br>  UpDn Time -&gt; Up or Down Time for a Tunnel <br>  ================================================= ======================== <br><br>  Interface: Tunnel1, IPv4 NHRP Details <br>  Type: Spoke, NHRP Peers: 1, <br><br>  # Ent Peer NBMA Addr Peer Tunnel Add State UpDn Tm Attrb <br>  - - - - - ----- <br>  1 192.168.1.1 10.5.5.254 UP 00:02:59 S <br><br>  Two connected remote offices are visible on HUBe: <br><br>  <b>Hub</b> #sh dmvpn <br>  Legend: Attrb -&gt; S - Static, D - Dynamic, I - Incomplete <br>  N - NATed, L - Local, X - No Socket <br>  # Ent -&gt; Number of NHRP entries with same NBMA peer <br>  NHS Status: E -&gt; Expecting Replies, R -&gt; Responding, W -&gt; Waiting <br>  UpDn Time -&gt; Up or Down Time for a Tunnel <br>  ================================================= ======================== <br><br>  Interface: Tunnel1, IPv4 NHRP Details <br>  Type: Hub, NHRP Peers: 2, <br><br>  # Ent Peer NBMA Addr Peer Tunnel Add State UpDn Tm Attrb <br>  - - - - - ----- <br>  1 172.16.1.2 10.5.5.1 UP 00:04:08 D <br>  1 172.16.2.3 10.5.5.2 UP 00:02:57 D <br><br>  A bunch of tunnel address and real (physical) <br>  Hub # sh ip nhrp brief <br>  Target Via NBMA Mode Intfc Claimed <br>  10.5.5.1/32 10.5.5.1 172.16.1.2 dynamic Tu1 &lt;&gt; <br>  10.5.5.2/32 10.5.5.2 172.16.2.3 dynamic Tu1 &lt;&gt; <br></td></tr></tbody></table><br><br>  Creating a dynamic GRE tunnel from a remote office Spoke1 to Spoke2 <br>  At the start of the boot, the Spoke 1 had only 1 tunnel to HUB.  When generating traffic (ping) to Spoke2, a tunnel to Spoke2 was immediately created. <br><table border="1" cellpadding="4"><tbody><tr><td>  Router # ping 10.5.5.2 <br>  Type escape sequence to abort. <br>  Sending 5, 100-byte ICMP Echos to 10.5.5.2, timeout is 2 seconds: <br>  !!!!! <br>  Success rate is 100 percent (5/5), round-trip min / avg / max = 1/4/5 ms <br><br>  We look at the established tunnels at the moment: <br>  Router # sh dmvpn <br>  Legend: Attrb -&gt; S - Static, D - Dynamic, I - Incomplete <br>  N - NATed, L - Local, X - No Socket <br>  # Ent -&gt; Number of NHRP entries with same NBMA peer <br>  NHS Status: E -&gt; Expecting Replies, R -&gt; Responding, W -&gt; Waiting <br>  UpDn Time -&gt; Up or Down Time for a Tunnel <br>  ================================================= ======================== <br><br>  Interface: Tunnel1, IPv4 NHRP Details <br>  Type: Spoke, NHRP Peers: 2, <br><br>  # Ent Peer NBMA Addr Peer Tunnel Add State UpDn Tm Attrb <br>  - - - - - ----- <br>  1 172.16.2.3 <b>10.5.5.2</b> UP 00:04:04 <b>D</b> <br>  1 192.168.1.1 10.5.5.254 UP 00:09:31 S <br></td></tr></tbody></table><br><br>  At the moment, the network diagram (Fig. 13) will look like this: <br><img src="https://habrastorage.org/files/896/84f/8b1/89684f8b10084d6fad58e2fe4ee4ac0d.jpg"><br><br><h3>  Dynamic Routing Protocols via DMVPN </h3><br><h5>  OSPF Setup </h5><br>  Making the settings via DMVPN and including the common network for VPN 10.5.5.0 in the OSPF process - we will see how OSPF on the HUB will establish contiguous relationships first with Spoke1 until it receives a hello packet from Spoke2, after that the relationships collapse with Neighbor Down: Adjacency error forced to reset, since the default interface Tunnel is set as the point-to-point interface.  For OSPF to work correctly, you need to set the network type as broadcast.  If you set the broadcast only on HUBe, then the neighborhood will be established, but there will be no routes through OSPF on Spok-a, so you need to set the broadcast on both the HUB and Spoke-ah. <br>  Below are the tables of OSPF behavior depending on the selected network type value. <br><table border="1" cellpadding="4"><tbody><tr><td>  Hub <br></td><td>  Spoke 1 <br></td><td>  Spoke 2 <br></td></tr><tr><td>  BROADCAST <br></td><td>  BROADCAST <br></td><td>  BROADCAST <br></td></tr><tr><td colspan="3">  Hub # sh ip opf neighbor <br><br>  Neighbor I Pri State Dead Time Address Interface <br>  1.1.1.1 0 FULL / DROTHER 00:00:34 10.5.5.1 Tunnel1 <br>  2.2.2.2 0 FULL / DROTHER 00:00:31 10.5.5.2 Tunnel1 <br><br>  Spoke_1 # sh ip ospf neighbor <br><br>  Neighbor ID Pri State Dead Time Address Interface <br>  10.0.0.1 1 FULL / DR 00:00:36 10.5.5.254 Tunnel1 <br><br>  Spoke_1 # sh ip ospf neighbor <br><br>  Neighbor ID Pri State Dead Time Address Interface <br>  10.0.0.1 1 FULL / DR 00:00:36 10.5.5.254 Tunnel1 <br><br>  Known routes to Spoke 1 via OSPF <br>  Spoke_1 # sh ip route <br><br>  Gateway of last resort is 172.16.1.5 to network 0.0.0.0 <br><br>  S * 0.0.0.0/0 [1/0] via 172.16.1.5 <br>  1.0.0.0/32 is subnetted, 1 subnets <br>  C 1.1.1.1 is directly connected, Loopback1 <br>  2.0.0.0/32 is subnetted, 1 subnets <br>  <b>O 2.2.2.2</b> [110/1001] via 10.5.5.3, 00:00:07, Tunnel1 <b>&lt;-</b> <b>Spoke2</b> <b>internal</b> <b>network</b> <br>  10.0.0.0/8 is variably subnetted, 3 subnets, 2 masks <br>  <b>O 10.0.0.0/24</b> [110/1001] via 10.5.5.254, 00:05:19, Tunnel1 <b>&lt;- internal network of the Central Office</b> <br>  C 10.5.5.0/24 is directly connected, Tunnel1 <br>  L 10.5.5.1/32 is directly connected, Tunnel1 <br>  172.16.0.0/16 is variably subnetted, 2 subnets, 2 masks <br>  C 172.16.1.0/24 is directly connected, GigabitEthernet0 / 0 <br>  L 172.16.1.2/32 is directly connected, GigabitEthernet0 / 0 <br><br>  Connectivity between Spoke 1 and Spoke 2 is done directly: <br>  Spoke_1 # traceroute 2.2.2.2 source 1.1.1.1 <br>  Type escape sequence to abort. <br>  Tracing the route to 2.2.2.2 <br>  VRF info: (vrf in name / id, vrf out name / id) <br>  1 10.5.5.3 216 msec 256 msec 216 msec <br></td></tr></tbody></table><br><br><h3>  DMVPN with EIGRP </h3><br><table border="1" cellpadding="4"><tbody><tr><td>  HUB (R1) <br></td><td>  Spoke (R3) <br></td><td>  Spoke (R4) <br></td></tr><tr><td colspan="3">  By default, routes on Spoke are only HUB (due to the split-horizon, Spoke 2 routes are not visible) <br></td></tr><tr><td colspan="3">  HUB # sh ip route eigrp <br>  1.0.0.0/8 is variably subnetted, 2 subnets, 2 masks <br>  D 1.0.0.0/8 is a summary, 00:04:18, Null0 <br>  D 3.0.0.0/8 [90/409600] via 10.5.5.3, 00:04:24, Tunnel1 <br>  D 4.0.0.0/8 [90/409600] via 10.5.5.4, 00:03:51, Tunnel1 <br>  10.0.0.0/8 is variably subnetted, 3 subnets, 2 masks <br>  D 10.0.0.0/8 is a summary, 00:04:18, Null0 <br><br>  There is no route to 4.4.4.4 <br>  Spoke_1 # sh ip route eigrp <br>  D 1.0.0.0/8 [90/324096] via 10.5.5.1, 00:04:04, Tunnel4 <br>  3.0.0.0/8 is variably subnetted, 2 subnets, 2 masks <br>  D 3.0.0.0/8 is a summary, 00:04:11, Null0 <br>  10.0.0.0/8 is variably subnetted, 3 subnets, 2 masks <br>  D 10.0.0.0/8 is a summary, 00:04:11, Null0 <br></td></tr></tbody></table><br><br>  Turn off on the HUBe split-horizon <br><table border="1" cellpadding="4"><tbody><tr><td>  HUB (R1) <br></td><td>  Spoke (R3) <br></td><td>  Spoke (R4) <br></td></tr><tr><td>  HUB (conf) # <br>  router eigrp 1 <br>  no ip split-horizon eigrp 1 <br></td><td>  No additional settings <br></td><td>  No additional settings <br></td></tr><tr><td colspan="3">  HUB # sh ip route eigrp <br>  1.0.0.0/8 is variably subnetted, 2 subnets, 2 masks <br>  D 1.0.0.0/8 is a summary, 00:04:18, Null0 <br>  D 3.0.0.0/8 [90/409600] via 10.5.5.3, 00:04:24, Tunnel101 <br>  D 4.0.0.0/8 [90/409600] via 10.5.5.4, 00:03:51, Tunnel101 <br>  10.0.0.0/8 is variably subnetted, 3 subnets, 2 masks <br>  D 10.0.0.0/8 is a summary, 00:04:18, Null0 <br><br>  The route to Spoke1 appeared, but leads through HUB <br>  Spoke_1 # sh ip route eigrp <br>  D 1.0.0.0/8 [90/324096] via 10.5.5.1, 00:05:45, Tunnel4 <br>  3.0.0.0/8 is variably subnetted, 2 subnets, 2 masks <br>  D 3.0.0.0/8 is a summary, 00:00:26, Null0 <br>  D <b>4.0.0.0</b> / 8 [90/435200] via <b>10.5.5.1</b> , 00:00:26, Tunnel4 <br>  10.0.0.0/8 is variably subnetted, 3 subnets, 2 masks <br>  D 10.0.0.0/8 is a summary, 00:05:51, Null0 <br><br>  R3 # traceroute 4.4.4.4 source 3.3.3.3 <br><br>  Type escape sequence to abort. <br>  Tracing the route to 4.4.4.4 <br>  1 10.5.5.1 88 msec 92 msec 76 msec <br>  2 10.5.5.4 128 msec * 140 msec <br></td></tr></tbody></table><br><br>  Let's get rid of HUB as an intermediate device in the connectivity of Spoke1 &lt;-&gt; Spoke2 <br><table border="1" cellpadding="4"><tbody><tr><td>  HUB (R1) <br></td><td>  Spoke (R3) <br></td><td>  Spoke (R4) <br></td></tr><tr><td>  HUB (conf) # <br>  router eigrp 1 <br>  no ip split-horizon eigrp 1 <br>  <b>no ip next-hop-self eigrp 1</b> <br></td><td>  No additional settings <br></td><td>  No additional settings <br></td></tr><tr><td colspan="3">  Now the route to the network Spoke_2 leads directly: <br>  R3 # sh ip route eigrp 1 <br>  D 1.0.0.0/8 [90/324096] via 10.5.5.1, 00:00:06, Tunnel4 <br>  3.0.0.0/8 is variably subnetted, 2 subnets, 2 masks <br>  D 3.0.0.0/8 is a summary, 00:00:06, Null0 <br>  <b>D 4.0.0.0</b> / 8 [90/435200] via <b>10.5.5.4</b> , 00:00:04, Tunnel4 <br>  10.0.0.0/8 is variably subnetted, 3 subnets, 2 masks <br>  D 10.0.0.0/8 is a summary, 00:19:55, Null0 <br><br>  R3 # traceroute 4.4.4.4 source 3.3.3.3 <br><br>  Type escape sequence to abort. <br>  Tracing the route to 4.4.4.4 <br>  1 10.5.5.4 84 msec * 72 msec <br></td></tr></tbody></table><br><br><h1>  PPTP </h1><br>  PPTP became a joint development of Microsoft, 3Com, Ascend Communication consortia.  Well scalable protocol.  It can be used to connect offices as a point-to-point, but most of all is suitable for organizing a remote connection on a client-server architecture.  It is enough to configure the central PPTP VPN HUB, and remote users connect through the PPTP client, which is implemented in all Windows OS, including MacOS and Linux distributions. <br>  There are cryptographic problems in the MSCHAPv2 authentication protocol [https://technet.microsoft.com/ru-ru/library/security/2743314.aspx], so in most cases even L2TP over IPSec is recommended instead of PPTP on Windows . <br>  Only <u>one</u> Microsoft Point-to-Point Encryption protocol (128-bit key) is used as encryption means, and MSCHAPv2, PEAP (recommended) is used as authentication. <br>  PPTP in its work establishes 2 sessions: a PPP session using the GRE protocol and a TCP connection on port 1723 for serving the PPTP session. <br>  Establishing a TCP session before establishing a PPP connection <br><br><img src="https://habrastorage.org/files/55e/cf6/d53/55ecf6d5391d4c0b96866b3f3a8502e4.jpg"><br><br>  PPP package format (fig.15) <br><br><img src="https://habrastorage.org/files/959/376/4cd/9593764cd414429f97c9e13a0a22b306.jpg"><br><br><table border="1" cellpadding="4"><tbody><tr><td>  PPTP_HUB # <br>  Username cisco2 password cisco2 <br>  ! <br>  interface Loopback1 <br>  ip address 192.168.2.2 255.255.255.0 <br>  ! <br>  vpdn enable <br>  ! <br>  vpdn-group 1 <br>  !  Default PPTP VPDN group <br>  accept-dialin <br>  protocol pptp <br>  virtual-template 1 <br>  ! <br>  interface Virtual-Template1 <br>  ip unnumbered Loopback1 <br>  ip mtu 1400 <br>  ip tcp adjust-mss 1360 <br>  peer default ip address pool PPTP-Pool <br>  ppp encrypt mppe auto <br>  ppp authentication ms-chap-v2 chap callin <br>  ! <br>  ip local pool PPTP-Pool 192.168.2.5 192.168.2.50 <br>  ! <br></td></tr></tbody></table><br>  Checking the established PPTP connections. <br>  User cisco2 is logged in and session is established. <br><table border="1" cellpadding="4"><tbody><tr><td>  PPTP_HUB #sho vpdn session <br>  % No active L2TP tunnels <br>  PPTP Session Information Total tunnels 1 sessions 1 <br>  LocID RemID TunID Intf Username State Last Chg Uniq ID <br>  55592 0 17168 vi3 cisco2 estabd 00:04:13 6 <br></td></tr></tbody></table><br><br>  The user is given an ip address from the DHCP Pool and created virtual-access <br><table border="1" cellpadding="4"><tbody><tr><td>  PPTP_HUB # sh ip int br <br>  Interface IP Address OK?  Method Status Protocol <br>  Ethernet0 / 0 unassigned YES NVRAM administratively down down <br>  GigabitEthernet0 / 0 192.168.1.3 YES NVRAM up up <br>  GigabitEthernet1 / 0 77.1.1.3 YES NVRAM up up <br>  Loopback0 3.3.3.3 YES NVRAM up up <br>  Loopback1 192.168.2.2 YES NVRAM up up <br>  Virtual-Access1 unassigned YES unset down down <br>  Virtual-Access2 unassigned YES unset up up <br>  Virtual-Access3 192.168.2.5 YES unset up up <br>  Virtual-Template1 192.168.2.5 YES unset down down <br></td></tr></tbody></table><br>  If there is a task for a specific PPTP client to issue an IP address belonging only to it, then you can resort to creating a TXT file listing all PPTP clients. <br>  Setup on the router: <br><table border="1" cellpadding="4"><tbody><tr><td>  ip dhcp pool STATIC <br>  import all <br>  <b>origin file</b> flash: /static2.txt <br>  default-router 192.168.2.2 <br>  dns-server 8.8.8.8 8.8.4.4 <br>  domain-name lab.local <br>  lease 3 <br>  ! <br>  interface Virtual-Template1 <br>  ip unnumbered Loopback1 <br>  ip mtu 1400 <br>  ip tcp adjust-mss 1360 <br>  peer default ip address pool STATIC (PPTP-Pool is no longer needed) <br>  ppp encrypt mppe auto <br>  ppp authentication ms-chap-v2 chap callin <br></td></tr></tbody></table><br><br>  The TXT file itself is static2.txt. <br><table border="1" cellpadding="4"><tbody><tr><td>  * time * Mar 01 2002 12:23 AM <br>  * version * 2 <br>  ! IP address Type VRF hardware address lease expiration <br>  192.168.2.77 / 25 1000c.2984.4f84 Infinite <br>  192.168.2.17 / 25 1000c.294646.1575 Infinite <br>  192.168.2.18 / 25 10000.0000.1111 Infinite <br></td></tr></tbody></table><br><br><h1>  L2TP </h1><br>  L2TP is an IETF standard that incorporates the best of Cisco's L2F protocol and Microsoft's PPTP.  It does not offer data protection tools, so it is often used with IPSec. <br><br>  L2TP is one of the few representatives of VPN protocols (also available for implementation in a corporate network), which pseudowire technology can offer - forwarding native vlan via L3 network.  The pseudowire technology only supports L2TP version 3. In addition, L2TPv3 supports the following L2 protocols, the data (payloads) of which can be transparently transmitted through the pseudo-tunnel L2TPv3: <br><ul><li>  Ethernet </li><li>  Ethernet VLAN (802.1q) </li><li>  HDLC </li><li>  PPP </li><li>  MPLS </li></ul><br><br>  The main difference between L2TPv3 and L2TPv2 is that L2TPv3 can tunnel different types of traffic (see above), while v2 only PPP. <br><br>  L2TPv3 uses two types of messages: <br><ul><li>  Signal (Control Connection) </li><li>  For data (Session data) </li></ul><br>  L2TPv3 signaling messages and data messages can be transferred via IP (protocol ID 115), i.e.  L2TPv3 uses less overhead <br><table border="1" cellpadding="4"><tbody><tr><td>  IP_add_s_global IP_add_d_global <br>  Type 115 <br></td></tr><tr><td>  L2TP_header <br></td></tr><tr><td>  L2_sublayer <br></td></tr><tr><td>  Data <br></td></tr></tbody></table><br><br>  L2TPv2 encapsulates data in IP / UDP (UDP port 1701). <br><br><table border="1" cellpadding="4"><tbody><tr><td align="center">  IP_add_s_global IP_add_d_global <br></td></tr><tr><td>  UDP_s_port UDP_d_port (1701) <br></td></tr><tr><td>  L2TP_header <br></td></tr><tr><td>  PPP_header <br></td></tr><tr><td>  IP_add_s_local IP_add_d_local <br></td></tr><tr><td>  Data <br></td></tr></tbody></table><br><br><br><h3>  L2TPv3 Pseudowire </h3><br>  The L2TP architecture, as well as the PPTP architecture, uses the following concepts: <br><br><table border="1" cellpadding="4"><tbody><tr><td>  LAC <br></td><td>  L2TP access concentrator <br></td><td>  LAC accepts requests from the client and negotiates L2TP tunnel and session parameters with LNS and transmits the LNS request <br></td></tr><tr><td>  Lns <br></td><td>  L2TP network server <br></td><td>  LNS negotiates L2TP tunnel and session parameters with LAC <br></td></tr><tr><td>  LCCE <br></td><td>  L2TP Control Connection Endpoint <br></td><td>  This is the LAC that participates in the signal connection. <br></td></tr></tbody></table><br><br>  The protocol operation model for L2TPv3 LNS is LNS, and for L2TPv2 LAC is LNS (for details, see below). <br>  Let's create a pseudowire between R5 in the Central Office and in R9 in the regional office, thereby expanding the network 192.168.1.x / 24 to the regional office. <br><br><img src="https://habrastorage.org/files/87c/a1e/7dc/87ca1e7dcfa84a358835abf0a2ab2325.jpg"><br><br><table border="1" cellpadding="4" width="638"><tbody><tr><td>  R5 # <br>  pseudowire-class L2TP_Class <br>  encapsulation l2tpv3 <br>  protocol none (i.e. dynamic session setup is not used) <br>  ip pmtu <br>  ip local interface GigabitEthernet1 / 0 <br>  ! <br>  interface GigabitEthernet0 / 0 <br>  <b>no ip address</b> <br>  <b>xconnect 44.1.1.9 1 encapsulation l2tpv3 manual pw-class L2TP_Class</b> <br>  <b>l2tp id 1 2</b> <br>  <b>l2tp cookie local 4 55111</b> <br>  <b>l2tp cookie remote 44119</b> <br></td><td>  R9 # <br>  pseudowire-class L2TP_Class <br>  encapsulation l2tpv3 <br>  protocol none (i.e. dynamic session setup is not used) <br>  ip pmtu <br>  ip local interface GigabitEthernet0 / 0 <br>  ! <br>  interface GigabitEthernet1 / 0 <br>  no ip address <br>  <b>xconnect 55.1.1.1 1 encapsulation l2tpv3 manual pw-class L2TP_Class</b> <br>  <b>l2tp id 2 1</b> <br>  <b>l2tp cookie local 4 44119</b> <br>  <b>l2tp cookie remote 4 55111</b> <br></td></tr></tbody></table><br><br>  Session establishment check: <br><table border="1" cellpadding="4" width="638"><tbody><tr><td>  R5_VPN_HUB_Pr # <b>sh l2tp session</b> <br><br>  L2TP Session Information Total tunnels 0 sessions 1 <br><br>  LocID RemID TunID Username, Intf / State Last Chg Uniq ID <br>  Vcid Circuit <br>  1 2 n / a 1, Gi0 / 0 est 00:00:03 1 <br><br>  R5_VPN_HUB_Pr # <b>sh l2tp session all</b> <br><br>  L2TP Session Information Total tunnels 0 sessions 1 <br><br>  Session id 1 is up, logical session id 33356, tunnel id n / a <br>  Remote session id is 2, remote tunnel id n / a <br>  Locally initiated session <br>  Unique ID is 4 <br>  Session Layer 2 circuit, type is Ethernet, name is GigabitEthernet0 / 0 <br>  Session vcid is 1 <br>  Circuit state is UP <br>  Local circuit state is UP <br>  Remote circuit state is UP <br>  Call serial number is 0 <br>  Remote tunnel name is <br>  Internet address is 44.1.1.9 <br>  Local tunnel name is <br>  Internet address is 55.1.1.5 <br>  IP protocol 115 <br>  Session is manually signaled <br>  Session state is established, time since change 02:29:58 <br>  1130 Packets sent, 1982 received <br>  151213 Bytes sent, 197759 received <br>  Last clearing of counters never <br></td></tr></tbody></table><br><br>  <b>R7 is now available without routing protocols:</b> <br><table border="1" cellpadding="4" width="638"><tbody><tr><td>  R10 # ping 192.168.1.7 repeat 10 <br>  Type escape sequence to abort. <br>  Sending 10, 100-byte ICMP Echos to 192.168.1.7, timeout is 2 seconds: <br>  !!!!!!!!!! <br>  Success rate is 100 percent (10/10), round-trip min / avg / max = 128/142/180 ms <br></td></tr></tbody></table><br><br><br><h3>  OSPF over L2TP </h3><br>  Neighborhood established by default, including the network 192.168.1.0 on R7 and R10 <br><table border="1" cellpadding="4" width="638"><tbody><tr><td>  R7_DATA_Center_Servers # sh ip ospf neighbor <br><br>  Neighbor ID Pri State Dead Time Address Interface <br>  192.168.1.10 1 FULL / DR 00:00:37 192.168.1.10 GigabitEthernet0 / 0 <br><br>  R10 # sh ip ospf neighbor <br><br>  Neighbor ID Pri State Dead Time Address Interface <br>  7.7.7.7 1 FULL / BDR 00:00:35 192.168.1.7 GigabitEthernet0 / 0 <br></td></tr></tbody></table><br><br>  Disadvantages: <br>  If L2TP is created on a router as in our example, then the following L2 PDUs will not go through pseudowire connections: CDP, STP, VTP, LLDP.  To tunnel such protocols, you must create an L2TPv3 tunnel on the L3 switch. <br>  Big minus - we have to remove the ip address on the interface of the router, which serves as the default route for all other stations.  As a result, our PCs remain without communication with other networks. <br>  L2 VPN works in two modes: <br><ul><li>  mandatory tunnel mode </li><li>  voluntary (optional) tunnel mode. </li></ul><br>  Mandatory tunnel mode refers to provider-provisioning and L2F, PPTP, L2TP protocols operate in this mode.  In mandatory tunnel mode via L2TP, remote users connect to the LAC via a normal PPP connection, the LAC terminates them and tunnels the PPP session to the LNS.  Moreover, the remote user does not even suspect about L2TP. <br><br><img src="https://habrastorage.org/files/ba6/9f1/89b/ba69f189b0fd46b0a5ce64abd815253d.jpg"><br><br>  In a voluntary / client initiated tunnel, the remote host acts as a LAC, that is, it negotiates and establishes an L2TP session directly with the LNS. <br><br><br><img src="https://habrastorage.org/files/e0a/797/076/e0a797076b584162965f77f3c6bd74de.jpg"><br><br>  In our example, Cisco R9 (44.1.1.9) will act as a LAC and establish an L2TP connection with Cisco R5 in the data center (55.1.1.1), which will act as an LNS. <br><br><img src="https://habrastorage.org/files/583/9ff/81d/5839ff81d32247b79af2755416b831b9.jpg"><br><br><img src="https://habrastorage.org/files/fd5/412/1b9/fd54121b9f2d49f68cb0bfb6f35fb311.jpg"><br><table border="1" cellpadding="4" width="638"><tbody><tr><td>  * Oct 20 19: 52: 55.861: L2X tnl 08287: ________: Create logical tunnel <br>  * Oct 20 19: 52: 55.865: L2TP tnl 08287: ________: Create tunnel <br>  * Oct 20 19: 52: 55.869: L2TP tnl 08287: ________: version set to V2 <b>(</b> <b>L2TPv2</b> <b>protocol</b> <b>)</b> <br>  * Oct 20 19: 52: 55.873: L2TP tnl 08287: ________: remote ip set to 44.1.1.9 <br>  * Oct 20 19: 52: 55.873: L2TP tnl 08287: ________: local ip set to 55.1.1.1 <br>  * Oct 20 19: 52: 55.877: L2TP tnl 08287: 00003073: FSM-CC ev <b>Rx-SCCRQ</b> <br>  ( <i>Start</i> <i>-</i> <i>Control</i> <i>-</i> <i>Connection</i> <i>-</i> <i>Request</i> <i>)</i> <i>LNS</i> <i>checks the validity of the sender and the availability of its own resources, and the list of supported</i> <i>pseudowire</i> <i>types</i> <i>(</i> <i>Ethernet</i> <i>,</i> <i>Frame</i> <i>Relay</i> ) is <i>also consistent at this stage</i> <br>  * Oct 20 19: 52: 55.877: L2TP tnl 08287: 00003073: FSM-CC Idle-&gt; Proc-SCCRQ <br>  * Oct 20 19: 52: 55.877: L2TP tnl 08287: 00003073: FSM-CC do Rx-SCCRQ <br>  * Oct 20 19: 52: 55.881: L2X _____: ________: Tunnel author started for LAC <br>  * Oct 20 19: 52: 55.901: L2X _____: ________: <b>Tunnel author found</b> <br>  * Oct 20 19: 52: 55.905: L2TP tnl 08287: 00003073: Author reply, data source: "VPDN-L2TP" <br>  * Oct 20 19: 52: 55.909: L2X _____: ________: class [AAA author, group "VPDN-L2TP"] <br>  * Oct 20 19: 52: 55.913: L2X _____: ________: created <br>  * Oct 20 19: 52: 55.917: L2TP tnl 08287: 00003073: FSM-CC ev SCCRQ-OK <br>  * Oct 20 19: 52: 55.917: L2TP tnl 08287: 00003073: FSM-CC Proc-SCCRQ-&gt; Wt-SCCCN <br>  <b>Start-Control-Connection-Connected (SCCCN)</b> <b>wait for the</b> <b>state</b> <b>Connected</b> <br>  * Oct 20 19: 52: 55.917: L2TP tnl 08287: 00003073: FSM-CC do Tx-SCCRP <br>  <b>Start-Control-Connection-Reply (SCCRP)</b> <b>sent a</b> <b>reply</b> <b>message</b> <br>  * Oct 20 19: 52: 55.917: L2X _____: ________: l2x_open_socket: is called <br>  * Oct 20 19: 52: 55.921: L2TP tnl 08287: 00003073: Open sock 55.1.1.1: <b>1701</b> -&gt; 44.1.1.9: <b>1701</b> <br>  <b>Uses</b> <b>UDP with port 1701 for service messages</b> <br>  * Oct 20 19: 52: 55.925: L2TP tnl 08287: 00003073: FSM-CC ev Sock-Ready <br>  * Oct 20 19: 52: 55.929: L2TP tnl 08287: 00003073: FSM-CC in Wt-SCCCN <br>  * Oct 20 19: 52: 55.929: L2TP tnl 08287: 00003073: FSM-CC do Ignore-Sock-Up <br>  * Oct 20 19: 52: 55.941: L2X _____: ________: Disabled security for VPDN <br>  * Oct 20 19: 52: 56.053: L2TP tnl 08287: 00003073: FSM-CC ev Rx-SCCCN <br>  * Oct 20 19: 52: 56.053: L2TP tnl 08287: 00003073: FSM-CC Wt-SCCCN-&gt; Proc-SCCCN <br>  * Oct 20 19: 52: 56.053: L2TP tnl 08287: 00003073: FSM-CC do Rx-SCCCN <br>  * Oct 20 19: 52: 56.053: L2TP tnl 08287: 00003073: <b>Got a response in SCCCN from LAC</b> <br>  * Oct 20 19: 52: 56.057: L2TP tnl 08287: 00003073: <b>Tunnel Authentication success</b> <br>  * Oct 20 19: 52: 56.061: L2TP tnl 08287: 00003073: FSM-CC ev SCCCN-OK <br>  * Oct 20 19: 52: 56.065: L2TP tnl 08287: 00003073: FSM-CC Proc-SCCCN-&gt; established <br>  * Oct 20 19: 52: 56.069: L2TP tnl 08287: 00003073: <b>FSM-CC do Established</b> <br>  * Oct 20 19: 52: 56.073: L2TP tnl 08287: 00003073: <b>Control channel up</b> <br>  * Oct 20 19: 52: 56.077: L2TP tnl 08287: 00003073: 55.1.1.1 &lt;-&gt; 44.1.1.9 <br></td></tr></tbody></table><br><br>  <b>The service channel is established, the channel for data (</b> <b>PPP frames) is</b> <b>now established</b> <b>.</b> <br>  It is worth noting that a set of client sessions can take place on one established tunnel. <br><br><img src="https://habrastorage.org/files/29f/adf/a5b/29fadfa5bd8440c7964166bf99eec8b9.jpg"><br>  To set up a session for LAC data, it sends an ICRQ (Call-Request), if there are enough resources on the LNS, then the LNS responds with an ICRP (Call-Reply) message.  To complete the session establishment - LAC sends ICCN Incoming-Call-Connected. <br><table border="1" cellpadding="4" width="638"><tbody><tr><td>  * Oct 20 19: 52: 56.117: L2X _____: _____: ________: <b>Create logical session</b> <br>  * Oct 20 19: 52: 56.121: L2TP _____: _____: ________: <b>Create session</b> <br>  * Oct 20 19: 52: 56.121: L2TP _____: _____: ________: Using ICRQ FSM <br>  <b>Incoming-Call-Request (ICRQ)</b> <b>The</b> <b>required</b> <b>pseudowire</b> <b>type</b> <b>required</b> <b>for</b> <b>the</b> <b>L2</b> <b>level</b> <b>is transmitted</b> <b>here</b> <br>  * Oct 20 19: 52: 56.125: L2TP _____: _____: ________: remote ip set to 44.1.1.9 <br>  * Oct 20 19: 52: 56.125: L2TP _____: _____: ________: local ip set to 55.1.1.1 <br>  * Oct 20 19: 52: 56.129: L2TP tnl 08287: 00003073: FSM-CC ev Session-Conn <br>  * Oct 20 19: 52: 56.129: L2TP tnl 08287: 00003073: FSM-CC in established <br>  * Oct 20 19: 52: 56.129: L2TP tnl 08287: 00003073: FSM-CC do Session-Conn-Est <br>  * Oct 20 19: 52: 56.129: L2TP tnl 08287: 00003073: Session count now 1 <br>  * Oct 20 19: 52: 56.129: L2TP _____: 08287: 0000754C: Session attached <br>  * Oct 20 19: 52: 56.129: L2TP _____: 08287: 0000754C: FSM-Sn ev Rx-ICRQ <br>  * Oct 20 19: 52: 56.129: L2TP _____: 08287: 0000754C: FSM-Sn Idle-&gt; Proc-ICRQ <br>  * Oct 20 19: 52: 56.129: L2TP _____: 08287: 0000754C: FSM-Sn do <b>Rx-ICRQ</b> <br>  * Oct 20 19: 52: 56.129: L2TP _____: 08287: 0000754C: Chose application VPDN <br>  * Oct 20 19: 52: 56.133: L2TP _____: 08287: 0000754C: App type set to VPDN <br>  * Oct 20 19: 52: 56.133: L2TP tnl 08287: 00003073: VPDN Session count now 1 <br>  * Oct 20 19: 52: 56.189: L2TP 00005: 08287: 0000754C: FSM-Sn ev <b>ICRQ-OK</b> <br>  * Oct 20 19: 52: 56.193: L2TP 00005: 08287: 0000754C: FSM-Sn Proc-ICRQ-&gt; Wt-Tx-ICRP <br>  * Oct 20 19: 52: 56.193: L2TP 00005: 08287: 0000754C: FSM-Sn do Tx-ICRP-Local-Check <br>  * Oct 20 19: 52: 56.193: L2TP 00005: 08287: 0000754C: FSM-Sn ev Local-Cont <br>  * Oct 20 19: 52: 56.193: L2TP 00005: 08287: 0000754C: FSM-Sn Wt-Tx-ICRP-&gt; Wt-Rx-ICCN <br>  * Oct 20 19: 52: 56.193: L2TP 00005: 08287: 0000754C: FSM-Sn do <b>Tx-ICRP</b> <br>  <b>Incoming-Call-Reply (ICRP)</b> <br>  * Oct 20 19: 52: 56.197: L2TP 00005: 08287: 0000754C: Open sock 55.1.1.1:1701-&gt;44.1.1.9.90101 <br>  * Oct 20 19: 52: 56.197: L2TP 00005: 08287: 0000754C: FSM-Sn in <b>Wt-Rx-ICCN (</b> <b>awaiting</b> <b>ICCN)</b> <br>  * Oct 20 19: 52: 56.397: L2TP 00005: 08287: 0000754C: FSM-Sn ev <b>Rx-ICCN (</b> <b>received</b> <b>ICCN</b> <b>)</b> <br>  * Oct 20 19: 52: 56.401: L2TP 00005: 08287: 0000754C: FSM-Sn <b>Wt-Rx-ICCN-&gt; Proc-ICCN</b> <br>  * Oct 20 19: 52: 56.405: L2TP 00005: 08287: 0000754C: FSM-Sn do <b>Rx-ICCN</b> <br>  * Oct 20 19: 52: 56.437: L2TP 00005: 08287: 0000754C: FSM-Sn ev <b>ICCN-OK</b> <br>  * Oct 20 19: 52: 56.441: L2TP 00005: 08287: 0000754C: FSM-Sn <b>Proc-ICCN-&gt; established</b> <br>  * Oct 20 19: 52: 56.445: L2TP 00005: 08287: 0000754C: <b>FSM-Sn do Established</b> <br>  * Oct 20 19: 52: 56.449: L2TP 00005: 08287: 0000754C: <b>Session</b> <b>up (The</b> <b>session is established for the data)</b> <br>  * Oct 20 19: 52: 58.197: L2TP 00005: 08287: 0000754C: <b>FSM-Sn in established</b> <br>  * Oct 20 19: 52: 58.241:% LINEPROTO-5-UPDOWN: Line protocol on Interface Virtual-Access3, changed state to up <br>  * Oct 20 19: 52: 58.273:% LINK-3-UPDOWN: Interface Virtual-Access3, changed state to up <br></td></tr></tbody></table><br><br>  In our example, one tunnel was formed between the LAS and the LNS and one user session. <br><table border="1" cellpadding="4" width="638"><tbody><tr><td>  ISP_NAT # <b>sh l2tun tunnel</b> <br>  L2TP Tunnel Information Total tunnels 1 sessions 1 <br>  LocTunID RemTunID Remote Name State Remote Address Sessn L2TP Class / <br>  Count VPDN Group <br>  30933 12403 LNS est 55.1.1.1 1 1 <br><br>  ISP_NAT # <b>sh l2tp session</b> <br>  L2TP Session Information Total tunnels 1 sessions 1 <br>  LocID RemID TunID Username, Intf / State Last Chg Uniq ID <br>  Vcid Circuit <br>  32700 30028 30933 LNS, Vi1 est 00:51:35 0 <br></td></tr></tbody></table><br>  The L2TP configuration in the voluntary tunnel mode is very similar in configuration with the mandatory tunnel mode.  The difference in setting up a VPDN group is as follows: <br><ul><li>  The <b>terminate-from</b> command is not needed </li><li>  L2TP tunnel authentication disabled by <b>no l2tp tunnel authentication</b> command </li></ul><br><br><h3>  Configure L2TPv2 </h3><br>       interface virtual-ppp,           interface Dialer.   ¬´AS IS¬ª. <br><table border="1" cellpadding="4" width="638"><tbody><tr><td> LNS# <br> aaa new-model <br> aaa authorization network default local <br> ! <br> vpdn enable <br> vpdn-group VPDN-L2TP <br> accept-dialin <br> protocol l2tp <br> virtual-template 2 <br> lcp renegotiation on-mismatch <br> terminate-from hostname LAC <br> l2tp tunnel password 0 cisco123 <br> ip pmtu <br> ! <br> interface Virtual-Template2 <br> ip unnumbered GigabitEthernet0/0 <br> autodetect encapsulation ppp <br> peer default ip address pool L2TP-pool <br> ppp authentication ms-chap-v2 <br></td><td> LAC# <br> vpdn enable <br> ! <br> vpdn-group 1 <br> request-dialin <br> protocol l2tp <br> pool-member 1 <br> initiate-to ip 55.1.1.1 <br> source-ip 44.1.1.9 <br> local name LAC (    terminate-from  LNS) <br> l2tp tunnel password 0 cisco123 <br> ! <br> interface Dialer1 <br> ip address negotiated <br> encapsulation ppp <br> dialer pool 1 <br> dialer idle-timeout 0 <br> dialer string 123 <br> dialer vpdn <br> dialer-group 1 <br> ppp authentication chap callin <br> ppp chap hostname LNC <br> ppp chap password 0 cisco123 <br> ! <br> ip route 192.168.1.0 255.255.255.0 Dialer1 <br></td></tr></tbody></table><br><br>  L2TPv2  interface virtual-ppp <br><br><img src="https://habrastorage.org/files/e73/0d8/64a/e730d864a3714a9cb52789ca3ff2d28b.jpg"><br><br><table border="1" cellpadding="4" width="638"><tbody><tr><td> LNS# <br> aaa new-model <br> ! <br> aaa authorization network default local <br> ! <br> username LAC password 0 cisco123 <br> ! <br> vpdn enable <br> vpdn-group VPDN-L2TP <br> accept-dialin <br> protocol l2tp <br> virtual-template 2 <br> terminate-from hostname LAC <br> l2tp tunnel password 0 cisco123 <br> ! <br>  interface Loopback0 <br> ip address 3.3.3.3 255.255.255.255 <br> ! <br> interface Virtual-Template2 <br> ip unnumbered Loopback0 <br> autodetect encapsulation ppp <br> no peer default ip address <br> ppp authentication ms-chap-v2 <br> ! <br> ip route 172.30.1.0 255.255.255.0 7.7.7.7 <br> !        R7 <br><br> (PS   7.7.7.7      <br> LNS#show ip route <br> 7.0.0.0/32 is subnetted, 1 subnets <br> C 7.7.7.7 is directly connected, Virtual-Access3 ) <br></td><td> LAC# <br> username LNS password 0 cisco123 <br> ! <br> l2tp-class client.init.class <br> authentication <br> password cisco123 <br> ! <br> pseudowire-class pwclass1 <br> encapsulation l2tpv2 <br> protocol l2tpv2 client.init.class <br> ip local interface Ethernet0/0 <br> ! <br>  interface Loopback0 <br> ip address 7.7.7.7 255.255.255.255 <br> ! <br> interface Virtual-PPP1 <br> ip unnumbered loopback0 <br> ppp authentication ms-chap-v2 <br> no cdp enable <br> pseudowire 55.1.1.3 1 pw-class pwclass1 <br> ! <br> ip route 192.168.1.0 255.255.255.0 Virtual-PPP1 <br> !      <br><br> (PS   3.3.3.3      <br> 3.0.0.0/32 is subnetted, 1 subnets <br> C 3.3.3.3 is directly connected, Virtual-PPP1 ) <br></td></tr></tbody></table><br>                (LAC)       L2TP HUBe (LNS) <br><table border="1" cellpadding="4" width="638"><tbody><tr><td> <b>LNS#show vpdn</b> <br> L2TP Tunnel and Session Information Total tunnels 1 sessions 1 <br> LocTunID   RemTunID Remote Name   State   Remote Address   Sessn L2TP Class/ <br> Count VPDN Group <br> <b>60224</b> <i>63290</i> LAC            est         77.1.1.7               1 VPDN-L2TP <br><br> LocID   RemID     TunID     Username, Intf/   State    Last Chg       Uniq ID <br> Vcid, Circuit <br> 46580   40688     60224         LAC, Vi3        est       00:14:12         102 <br><br> <b>LAC#sho vpdn</b> <br> L2TP Tunnel and Session Information Total <b>tunnels</b> 1 <b>sessions</b> 1 <br> LocTunID   RemTunID   Remote Name  State   Remote Address   Sessn L2TP Class/ <br> Count VPDN Group <br> 63290 <b>60224</b> LNS          est         55.1.1.3              1 client.init.cla <br><br> LocID    RemID    TunID    Username, Intf/    State     Last Chg      Uniq ID <br> Vcid, Circuit <br> 40688    46580 <i>63290</i> 1,  Vp1            est        00:20:54          8 <br></td></tr></tbody></table><br><table border="1" cellpadding="4" width="638"><tbody><tr><td> <b>LNS#sh caller user LAC</b> <br><br> User: LAC, line Vi3, service PPPoVPDN <br> Connected for 00:03:34, Idle for 00:00:04 <br> Timeouts: Limit Remaining Timer Type <br> ‚Äî ‚Äî - <br> PPP: LCP Open, MS CHAP V2 (&lt;--&gt;), IPCP <br> <b>IP: Local 3.3.3.3, remote 7.7.7.7</b> <br> Counts: <b><u>101</u> packets input</b> , 2932 bytes, 0 no buffer <br> 0 input errors, 0 CRC, 0 frame, 0 overrun <br> 78 packets output, 3770 bytes, 0 underruns <br> 0 output errors, 0 collisions, 0 interface resets <br><br> &lt;   ping-  &gt; <br> <b>LNS#sh caller user LAC</b> <br><br> User: LAC, line Vi3, service PPPoVPDN <br> Connected for 00:03:40, Idle for 00:00:02 <br> Timeouts: Limit Remaining Timer Type <br> ‚Äî ‚Äî - <br> PPP: LCP Open, MS CHAP V2 (&lt;--&gt;), IPCP <br> <b>IP: Local 3.3.3.3, remote 7.7.7.7</b> <br> Counts: <b><u>201</u> packets input</b> , 13332 bytes, 0 no buffer <br> 0 input errors, 0 CRC, 0 frame, 0 overrun <br> 179 packets output, 15650 bytes, 0 underruns <br> 0 output errors, 0 collisions, 0 interface resets <br></td><td> <b>     (</b> <b>LNS) </b> <b>R7</b> <br> <b>LAC#</b> ping 192.168.1.1 source 172.30.1.7 repeat <b>100</b> <br> Type escape sequence to abort. <br> Sending 100, 100-byte ICMP Echos to 192.168.1.1, timeout is 2 seconds: <br> Packet sent with a source address of 172.30.1.7 <br> !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!! <br> !!!!!!!!!!!!!!!!!!!!!!!!!!!!!! <br> Success rate is 100 percent (100/100), round-trip min/avg/max = 1/4/6 ms <br></td></tr></tbody></table><br><br>   L2TPv2 <br><br><img src="https://habrastorage.org/files/424/0e0/3fe/4240e03fe23046a195012240baac5b3e.jpg"><br> Overhead UDP (8) + L2TPv2 (8) + PPP (4 ) +IPv4 (20 ) = 40 <br><h3></h3><br><h3>  OSPF  L2TPv2 </h3><br><table border="1" cellpadding="4" width="638"><tbody><tr><td> <b>OSPF</b>    broadcast  <br> <b>LNS#</b> <br> router ospf 1 <br> network 3.3.3.3 0.0.0.0 area 0 <br> network 192.168.1.0 0.0.0.255 area 0 <br> default-information originate always <br></td><td>   3.3.3.3  ospf area 0 <br> <b>LAC#</b> <br> interface Loopback1 <br> ip address 77.77.77.77 255.255.255.255 <br> ! <br> router ospf 1 <br> network 3.3.3.3 0.0.0.0 area 0 <br> network 77.77.77.77 0.0.0.0 area 0 <br></td></tr></tbody></table><br><br> LSA  OSPF  L2TPv2 <br> , ,    overhead. <br><br><img src="https://habrastorage.org/files/71c/976/d54/71c976d5407d4780a1190d239966fd91.jpg"><br> Overhead UDP (8) + L2TPv2 (8) + PPP (4 ) +IPv4 (20 ) = 40 <br> <b>  </b> <br><table border="1" cellpadding="4" width="638"><tbody><tr><td> <b>LNS</b> #sh ip ospf neighbor <br><br> Neighbor ID     Pri   State           Dead Time   Address         Interface <br> 7.7.7.7            0   FULL/  -        00:00:30       7.7.7.7         Virtual-Access3 <br><br> <b>LAC</b> #sh ip ospf neighbor <br><br> Neighbor ID     Pri   State           Dead Time   Address         Interface <br> 3.3.3.3            0   FULL/  -           00:00:35    3.3.3.3         Virtual-PPP1 <br></td></tr></tbody></table><br><h2></h2><br><h3>   L2TPv3 </h3><br><br><img src="https://habrastorage.org/files/25f/160/9a2/25f1609a281f459c875b5fc6ab57bad2.jpg"><br>  L2TPv3       ,       VPN HUB-   . <br><table border="1" cellpadding="4" width="638"><tbody><tr><td> LNS# <br> username LAC password 0 cisco123 <br> ! <br> pseudowire-class client.init.pw <br> encapsulation l2tpv3 <br> protocol l2tpv3 client.inint.class <br> ip local interface Ethernet0/1 <br> ! <br> interface Virtual-PPP1 <br> ip unnumbered Loopback0 <br> ppp authentication ms-chap-v2 <br> pseudowire 77.1.1.7 1 pw-class client.init.pw <br> ! <br>  interface Loopback0 <br> ip address 3.3.3.3 255.255.255.255 <br> ! <br> interface Virtual-PPP1 <br> ip unnumbered Loopback0 <br> ppp authentication ms-chap-v2 <br> pseudowire 77.1.1.7 1 pw-class client.init.pw <br> ! <br> ip route 172.30.1.0 255.255.255.0 Virtual-PPP1 <br></td><td> LAC# <br> username LNS password 0 cisco123 <br> ! <br> pseudowire-class pwclass2 <br> encapsulation <b>l2tpv3</b> <br> protocol <b>l2tpv3</b> client.init.class <br> ip local interface Ethernet0/0 <br> ! <br> interface Virtual-PPP1 <br> ip address negotiated <br> ppp authentication ms-chap-v2 <br> no cdp enable <br> pseudowire 55.1.1.3 1 pw-class pwclass2 <br> ! <br> ip route 192.168.1.0 255.255.255.0 Virtual-PPP1 <br></td></tr></tbody></table><br><br>   L2TPv3   LNS <br><table border="1" cellpadding="4" width="638"><tbody><tr><td> <b>LNS#show vpdn</b> <br><br> L2TP Tunnel  and Session Information Total tunnels 1 sessions 1 <br><br> LocTunID        RemTunID   Remote Name   State  Remote Address  Sessn L2TP Class/ <br> Count VPDN Group <br> 4168123058 3050381103              LAC           est           77.1.1.7             1     client.inint.cl <br><br> LocID             RemID         TunID        Username, Intf/      State  Last Chg Uniq ID <br> Vcid, Circuit <br> 2122433254    2810410257   4168123058           1, Vp1 <b>est</b> 00:16:22      53 <br><br>    <b>est</b> ablished,  ID  <br></td></tr></tbody></table><br><br>   L2TPv3   LAC <br><table border="1" cellpadding="4"><tbody><tr><td> <b>LAC</b> #show vpdn <br> L2TP Tunnel and Session Information Total tunnels 1 sessions 1 <br><br> LocTunID     RemTunID     Remote Name   State  Remote Address  Sessn L2TP Class/ <br> Count VPDN Group <br> 3050381103 4168123058          LNS             est         55.1.1.3            1     client.init.cla <br><br> LocID               RemID       TunID        Username, Intf/         State       Last Chg   Uniq ID <br> Vcid, Circuit <br> 2810410257      2122433254 3050381103      1, Vp1               est        00:15:57        5 <br></td></tr></tbody></table><br><br>   L2TPv3 <br><br><img src="https://habrastorage.org/files/e11/155/6b8/e111556b88d04992a5c2a64d8fb7709c.jpg"><br> Overhead L2TPv3 (4) + HDLC (4) = 8  <br><br>           (LAC)       L2TP HUBe (LNS) <br><table border="1" cellpadding="4" width="1038"><tbody><tr><td> <b> </b> <b>L2</b> <b>TPv3 </b> <br> <b>LNS#</b> <b>show</b> <b>caller</b> <b>user</b> <b>LAC</b> <br><br> User: LAC, line Vp1, service PPP <br> Connected for 00:01:52, Idle for 00:01:52 <br> Timeouts:    Limit     Remaining Timer Type <br> -         -         - <br> PPP: LCP Open, MS CHAP V2 (&lt;--&gt;), IPCP <br> IP: <b>Local 3.3.3.3, remote 7.7.7.7</b> <br> Counts: <b><u>1241</u></b> packets input, 74748 bytes, 0 no buffer <br> 0 input errors, 0 CRC, 0 frame, 0 overrun <br> 1078 packets output, 78056 bytes, 0 underruns <br> 0 output errors, 0 collisions, 0 interface resets <br><br> &lt;   ping-  &gt; <br> <b>LNS#show caller user LAC</b> <br><br> User: LAC, line Vp1, service PPP <br> Connected for 00:02:02, Idle for 00:02:02 <br> Timeouts:    Limit     Remaining Timer Type <br> -         -         - <br> PPP: LCP Open, MS CHAP V2 (&lt;--&gt;), IPCP <br> <b>IP: Local 3.3.3.3, remote 7.7.7.7</b> <br> Counts: <b><u>1343</u></b> packets input, 84976 bytes, 0 no buffer <br> 0 input errors, 0 CRC, 0 frame, 0 overrun <br> 1180 packets output, 88552 bytes, 0 underruns <br> 0 output errors, 0 collisions, 0 interface resets <br></td><td> <b> 100     </b> <br> LAC#ping 192.168.1.1 source 172.30.1.7 repeat 100 <br> Type escape sequence to abort. <br> Sending 100, 100-byte ICMP Echos to 192.168.1.1, timeout is 2 seconds: <br> Packet sent with a source address of 172.30.1.7 <br> !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!! <br> Success rate is 100 percent (100/100), round-trip min/avg/max = 2/4/29 ms <br></td></tr></tbody></table><br><h2></h2><br><h3> L2TPv2 over IPSec </h3><br>  L2TP       ,           IPSec.    L2TP    ,  ,   PPP .        L2TPv2,   IP/UDP ,     ACL   UDP    1701.   IPSec   ,   ,        (  ),    IP         (  ). <br><br><img src="https://habrastorage.org/files/cb6/aa3/9e8/cb6aa39e8942455c8e4eebe9d02d0008.jpg"><br><br>  : <br><img src="https://habrastorage.org/files/beb/f99/eb1/bebf99eb1faf466782213be33a2bc1e8.jpg"><br><table border="1" cellpadding="4" width="638"><tbody><tr><td> LNS# <br> crypto isakmp policy 10 <br> encr 3des <br> authentication pre-share <br> group 2 <br> ! <br> crypto isakmp key ipseckey123 address 77.1.1.7 <br> ! <br> crypto ipsec transform-set ESP-AES256-SHA1 esp-aes 256 esp-sha-hmac <br> mode transport <br> ! <br> crypto map L2TP_VPN 10 ipsec-isakmp <br> set peer 77.1.1.7 <br> set transform-set ESP-AES256-SHA1 <br> match address L2TP_TRAFFIC <br> ! <br> !     L2TPv2,  !     UDP !   1701 <br> ip access-list extended L2TP_TRAFFIC <br> permit udp host 55.1.1.3 eq 1701 host 77.1.1.7 eq 1701 <br> ! <br> interface Ethernet0/1 <br> ip address 55.1.1.3 255.255.255.0 <br> crypto map L2TP_VPN <br></td><td> LAC# <br> crypto isakmp policy 10 <br> encr 3des <br> authentication pre-share <br> group 2 <br> ! <br> crypto isakmp key ipseckey123 address 55.1.1.3 <br> ! <br> crypto ipsec transform-set ESP-AES256-SHA1 esp-aes 256 esp-sha-hmac <br> mode transport <br> ! <br> crypto map L2TP_VPN 10 ipsec-isakmp <br> set peer 55.1.1.3 <br> set transform-set ESP-AES256-SHA1 <br> match address L2TP_TRAFFIC <br> ! <br> ! <br> ip access-list extended L2TP_TRAFFIC <br> permit udp host 77.1.1.7 eq 1701 host 55.1.1.3 eq 1701 <br> ! <br> interface Ethernet0/0 <br> ip address 77.1.1.7 255.255.255.0 <br> crypto map L2TP_VPN <br> ! <br> ! <br></td></tr></tbody></table><br><br>           (LAC)       L2TP HUBe (LNS) <br><table border="1" cellpadding="4" width="638"><tbody><tr><td> <b> </b> <b>L2</b> <b>TPv3 </b> <br> <b>LNS#</b> <b>sh</b> <b>caller</b> <b>user</b> <b>LAC</b> <br><br> User: LAC, line Vi3, service PPPoVPDN <br> Connected for 00:04:10, Idle for 00:00:05 <br> Timeouts:    Limit     Remaining Timer Type <br> -         -         - <br> PPP: LCP Open, MS CHAP V2 --&gt;), IPCP <br> IP: Local 3.3.3.3, remote 7.7.7.7 <br> <b>Counts: <u>247</u> packets input,</b> 16456 bytes, 0 no buffer <br> 0 input errors, 0 CRC, 0 frame, 0 overrun <br> 129 packets output, 3846 bytes, 0 underruns <br> 0 output errors, 0 collisions, 0 interface resets <br><br> &lt;   ping-  &gt; <br> <b>LNS#sh caller user LAC</b> <br><br> User: LAC, line Vi3, service PPPoVPDN <br> Connected for 00:04:45, Idle for 00:00:02 <br> Timeouts:    Limit     Remaining Timer Type <br> -         -         - <br> PPP: LCP Open, MS CHAP V2 (√ü&gt;), IPCP <br> IP: Local 3.3.3.3, remote 7.7.7.7 <br> <b>Counts: <u>327</u> packets input</b> , 23288 bytes, 0 no buffer <br> 0 input errors, 0 CRC, 0 frame, 0 overrun <br> 188 packets output, 4226 bytes, 0 underruns <br> 0 output errors, 0 collisions, 0 interface resets <br></td><td> <b> 100     </b> <br> LAC#ping 192.168.1.1 repeat 100 source 172.30.1.7 <br> Type escape sequence to abort. <br> Sending 100, 100-byte ICMP Echos to 192.168.1.1, timeout is 2 seconds: <br> !.!!!!!!!.!!!!!.!!!!!.!!!.!!!!!..!.!!!!!!!!!!!!.!!!!!..!!!!. <br></td></tr></tbody></table><br><br>   L2TPv2 over IPSec <br><br><img src="https://habrastorage.org/getpro/habr/post_images/264/e41/685/264e416856165fc2c77787b5035cf4ed.jpg"><br>   IP | ESP header | UDP | L2TP | PPP | ESP trailer | Auth trailer <br> Overhead ESP_header (8) + UDP (8) + L2TPv2 (8) + PPP (4 ) + ESP_trailer (min 2) + SHA_auth (160 =  20 ) = <u>50 </u> <u>a</u> <u></u> <br><br><br><h3>  OSPF over L2TPv2 over IPSec </h3><br>   OSPF   , hello  -    10 .     OSPF  . <br><table border="1" cellpadding="4" width="638"><tbody><tr><td> LNS#sh ip ospf neighbor <br><br> Neighbor ID     Pri   State           Dead Time   Address         Interface <br> 7.7.7.7                0   FULL/  -        00:00:35    7.7.7.7         Virtual-Access3 <br> 192.168.1.1       1   FULL/DR      00:00:33    192.168.1.1     Ethernet0/0 <br><br> LNS#sh ip route <br> C        7.7.7.7 is directly connected, Virtual-Access3 <br> <b>O</b> 77.77.77.77/32 [110/2] via 7.7.7.7, 21:54:59, Virtual-Access3 <br> 172.30.0.0/24 is subnetted, 1 subnets <br> S        172.30.1.0 [1/0] via 7.7.7.7 <br> 192.168.1.0/24 is variably subnetted, 2 subnets, 2 masks <br></td></tr></tbody></table><br><br><h2>  Scaling.      L2TPv2 </h2><br>   LNS, ..  L2TPv2 HUB  ‚Äì      PPP CHAP .    ,    : <br><table border="1" cellpadding="4"><tbody><tr><td> *Nov  9 10:31:35.178: VPDN uid:123 disconnect (AAA) IETF: 17/user-error Ascend: 26/PPP CHAP Fail <br> *Nov  9 10:31:35.178: VPDN uid:123 vpdn shutdown session, result=2, error=6, vendor_err=0, syslog_error_code=8, syslog_key_type=1 <br></td></tr></tbody></table><br><br>   LAC <br><br><img src="https://habrastorage.org/files/297/5d7/c39/2975d7c399e1408eaf664e9bf6487848.jpg"><br><table border="1" cellpadding="4"><tbody><tr><td> LNS# <br> username LAC_9 password 0 cisco123 <br></td><td> LAC_9# <br> username LNS password 0 cisco123 <br> ! <br> l2tp-class client.init.class <br> authentication <br> password cisco123 <br> ! <br> pseudowire-class pwclass1 <br> encapsulation l2tpv2 <br> protocol l2tpv2 client.init.class <br> ip local interface Ethernet0/0 <br> ! <br>  interface Loopback0 <br> ip address 9.9.9.9 255.255.255.255 <br> ! <br> interface Virtual-PPP1 <br> ip address loopback0 <br> ppp authentication ms-chap-v2 <br> no cdp enable <br> pseudowire 55.1.1.3 1 pw-class pwclass1 <br> ! <br> ip route 192.168.1.0 255.255.255.0 Virtual-PPP1 <br></td></tr></tbody></table><br><br>    LNS  2  <br><table border="1" cellpadding="4"><tbody><tr><td> LNS#sh vpdn tunnel <br><br> L2TP Tunnel Information Total tunnels 2 sessions 2 <br><br> LocTunID   RemTunID   Remote Name   State  Remote Address  Sessn L2TP Class/ <br> Count VPDN Group <br> 35949            21672             LAC                  est           77.1.1.7             1     VPDN-L2TP <br> 49973            18492             LAC_9              est           44.1.1.9            1     VPDN-L2TP <br></td></tr></tbody></table><br><br>  OSPF  L2TPv2 <br>       L2TPv2 ‚Äì       .   OSPF         loopback-: <br><table border="1" cellpadding="4"><tbody><tr><td> LNS# <br>  interface Loopback0 <br> ip address 3.3.3.3 255.255.255.255 <br> router ospf 1 <br> network 3.3.3.3 0.0.0.0 area 0 <br></td><td> LAC# <br>  interface Loopback0 <br> ip address 7.7.7.7 255.255.255.255 <br> ! <br> <b>interface Loopback1</b> <br> ip address 77.77.77.77 255.255.255.255 <br> ! <br> router ospf 1 <br> router-id 7.7.7.7 <br> network 7.7.7.7 0.0.0.0 area 0 <br> network 77.77.77.77 0.0.0.0 area 0 <br></td><td> LAC_9# <br>  interface Loopback0 <br> ip address 9.9.9.9 255.255.255.255 <br> ! <br> <b>interface Loopback1</b> <br> ip address 99.99.99.99 255.255.255.255 <br> ! <br> router ospf 1 <br> router-id 9.9.9.9 <br> network 9.9.9.9 0.0.0.0 area 0 <br> network 99.99.99.99 0.0.0.0 area 0 <br></td></tr></tbody></table><br><br>  OSPF     <br><table border="1" cellpadding="4"><tbody><tr><td> <b>LNS#sh ip ospf neighbor</b> <br><br> Neighbor ID     Pri   State           Dead Time   Address         Interface <br> 9.9.9.9                0   FULL/  -        00:00:39    9.9.9.9         Virtual-Access3 <br> 7.7.7.7                0   FULL/  -        00:00:39    7.7.7.7         Virtual-Access4 <br> 192.168.1.1       1   FULL/DR      00:00:39    192.168.1.1     Ethernet0/0 <br><br>         R3 ‚Äì L2TPv2 HUB <br> <b>LAC_9#</b> <b>sh</b> <b>ip</b> <b>route</b> <b>ospf (  </b> <b>R7)</b> <br> 7.0.0.0/32 is subnetted, 1 subnets <br> O        7.7.7.7 [110/3] via 3.3.3.3, 00:02:14, Virtual-PPP1 <br> 77.0.0.0/32 is subnetted, 1 subnets <br> O        77.77.77.77 [110/3] via 3.3.3.3, 00:02:14, Virtual-PPP1 <br><br>    : <br> <b>LAC_9#traceroute 77.77.77.77 source 99.99.99.99</b> <br> Type escape sequence to abort. <br> Tracing the route to 77.77.77.77 <br> VRF info: (vrf in name/id, vrf out name/id) <br> 1 3.3.3.3 5 msec 2 msec 4 msec <br> 2 7.7.7.7 5 msec 4 msec * <br></td></tr></tbody></table><br><br>     OSPF,              (   L2TP HUBe)    ‚Äì ip  ppp . <br>      IP     ,     1         ,  192.168. <b>25.0</b> /24  interface virtual-ppp VPN HUBa,      - 192.168. <b>25.16</b> /29         ,     VPN HUB    vitual-ppp       : <br> <b>HUB</b> (conf)#ip route 192.168.25.16 255.255.255.248 16.16.16.16 (&lt;-  16.16.16.16  virtual-ppp    ,      VPN HUBa     : <br><table border="1" cellpadding="4"><tbody><tr><td> C        16.16.16.16 is directly connected, Virtual-Access4) <br></td></tr></tbody></table><br><hr><br>      ,     ,     .       ,   ,         ,    ,      . ,        ¬´¬ª     ,     ,            !     . <br><br>  PS <br>    :     ,           VPN-,       ‚Äî    ,      VPN- <a href="http://network-class.net/ru/baza-protokolov.html"></a> . <br><br>        . </habracut></div><p>Source: <a href="https://habr.com/ru/post/246281/">https://habr.com/ru/post/246281/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../246269/index.html">Promotional codes for the free Microsoft 70-695, 70-696 exams</a></li>
<li><a href="../246273/index.html">WordPress updated to version 4.1</a></li>
<li><a href="../246275/index.html">The best instant messenger for team work: Compare HipChat, Slack and Kato</a></li>
<li><a href="../246277/index.html">Assembling and installing Calamari monitoring system packages for CEPH 0.87 distributed storage on Ubuntu 04/14/1 (Trusty Tahr)</a></li>
<li><a href="../246279/index.html">Steam Stealer or Trojan stealing things on Steam. The history of the appearance and scheme of work</a></li>
<li><a href="../246283/index.html">Maintaining a "third-party" information resource. How and for what</a></li>
<li><a href="../246285/index.html">Testing GWT MVP Architecture Applications</a></li>
<li><a href="../246287/index.html">The last day of your discount is 89% on the annual program of Stratoplan</a></li>
<li><a href="../246289/index.html">Improving mobile project management</a></li>
<li><a href="../246293/index.html">6 games in 6 weeks - the third game</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>