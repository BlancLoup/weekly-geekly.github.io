<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Haskell for VK, Javascript and ReactJS, Or Alien vs. The Simpsons</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="This post is an attempt to add a couple of drops of fuel to the Haskell propaganda car, demonstrating its use in everyday tasks. 



 As such, conside...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Haskell for VK, Javascript and ReactJS, Or Alien vs. The Simpsons</h1><div class="post__text post__text-html js-mediator-article">  This post is an attempt to add a couple of drops of fuel to the Haskell propaganda car, demonstrating its use in everyday tasks. <br><br><img src="https://habrastorage.org/files/df7/848/e7c/df7848e7c9644d148d09b4d743d0a838.png"><br><br>  As such, consider the following: 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <ul><li>  We implement a package of access to <a href="https://vk.com/dev">the VK API</a> . <br>  The code will work in both native applications and JavaScript applications via GHCJS, the Haskell compiler in JavaScript <br></li><li>  Write a one-page browser application using our API <br></li></ul><a name="habracut"></a><br>  The narrative is purely illustrative character in the style of "akyn" (what I see, I sing). <br><br>  So let's get started. <br><br><h2>  API Vkontakte </h2><br>  The complete package code is here <a href="">vk-api</a> . <br><br>  A typical use of the API we are developing will be as follows. <br><br><pre><code class="haskell hljs"><span class="hljs-title"><span class="hljs-title">appId</span></span> :: <span class="hljs-type"><span class="hljs-type">Int</span></span> appId = <span class="hljs-number"><span class="hljs-number">123456</span></span> main :: <span class="hljs-type"><span class="hljs-type">IO</span></span> () main = execVKAPI () (createSettings appId <span class="hljs-string"><span class="hljs-string">"myname"</span></span> <span class="hljs-string"><span class="hljs-string">"mypass"</span></span> (<span class="hljs-type"><span class="hljs-type">Just</span></span> [<span class="hljs-type"><span class="hljs-type">Audio</span></span>])) $ <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> <span class="hljs-comment"><span class="hljs-comment">--    (AR (Items (sar:_) _)) &lt;- toAPI $ def{searchQ = "ABBA" , searchCount = Just 2 , searchLyrics = Just 1 } --      (AR (gar:_)) &lt;- toAPI $ GetById [(audioOwnerId sar, audioId sar)] --       (AR aid) &lt;- toAPI $ Add (audioId gar) (audioOwnerId gar) Nothing Just uid &lt;- liftState $ gets getUserId --    toAPI $ def{editOwnerId = UserId uid , editAudioId = aid , editTitle = Just "My Added Record" } return ()</span></span></code> </pre> <br>  The basis for implementing <a href="https://vk.com/dev">the VKontakte API is</a> the <a href="">api-builder</a> package. <br><br>  We want to present the queries and results as <acronym>ADT</acronym> records.  We will receive answers in the form of JSON. <br><br><h3>  Description of API operations </h3><br>  At the type level, we associate queries and results through the class <b>Routable</b> <br><br><pre> <code class="haskell hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> (</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Queryable</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">q</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Receivable</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">a</span></span></span><span class="hljs-class">) =&gt; </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Routable</span></span></span><span class="hljs-class"> qa | q -&gt; a </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">where</span></span></span></span> toRoute :: q -&gt; <span class="hljs-type"><span class="hljs-type">Route</span></span> toAPI :: (<span class="hljs-type"><span class="hljs-type">MonadIO</span></span> m, <span class="hljs-type"><span class="hljs-type">ErrorReceivable</span></span> e) =&gt; q -&gt; <span class="hljs-type"><span class="hljs-type">APIT</span></span> sema toAPI = runRoute . toRoute</code> </pre><br>  Declaring the <a href="https://wiki.haskell.org/Functional_dependencies">functional dependence</a> <b>q -&gt; a</b> , we solemnly promise the compiler that the mapping of query types to types of results will be unique. <br><br>  The final description of each API operation will be succinct and readable, for example, for <a href="https://vk.com/dev/audio.getLyrics">audio.getLyrics</a> <br><br><pre> <code class="haskell hljs"><span class="hljs-comment"><span class="hljs-comment">-- audio.getLyrics    instance Routable GetLyrics (ActionResponse Lyrics) where toRoute q = Route ["audio.getLyrics"] (toURLParams q) "GET"</span></span></code> </pre><br><h3>  Request Description </h3><br>  The request type must be an instance of the <b>Queryable</b> class to be converted to a list of url parameters. <br><br><pre> <code class="haskell hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Queryable</span></span></span><span class="hljs-class"> a </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">where</span></span></span></span> toURLParams :: a -&gt; [<span class="hljs-type"><span class="hljs-type">URLParam</span></span>]</code> </pre><br>  Implementing each specific instance of <b>Queryable</b> is easy but tedious, so we will create a macro. <br>  <a href="https://wiki.haskell.org/Template_Haskell">Template Haskell</a> , let the compiler work for us, and we want to spend a minimum of effort on the description of our requests. <br><br><pre> <code class="haskell hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">data</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">GetLyrics</span></span></span><span class="hljs-class"> = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">GetLyrics</span></span></span><span class="hljs-class"> {</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">getlyricsLyricsId</span></span></span><span class="hljs-class"> :: !</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Int</span></span></span><span class="hljs-class">} </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">deriving</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Show</span></span></span><span class="hljs-class"> $(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">deriveQueryable'</span></span></span><span class="hljs-class"> (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">standard</span></span></span><span class="hljs-class"> . </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">dropLPrefix</span></span></span><span class="hljs-class">) ''</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">GetLyrics</span></span></span><span class="hljs-class">)</span></span></code> </pre><br>  Haskell is far from Lisp in relation to macrology, but an interpreter will help us in creating the basic template.  Ask him to show <acronym>AST</acronym> for the desired expression. <br><br><pre> <code class="haskell hljs"> runQ [d| <span class="hljs-keyword"><span class="hljs-keyword">instance</span></span> <span class="hljs-type"><span class="hljs-type">Queryable</span></span> <span class="hljs-type"><span class="hljs-type">Lyrics</span></span> <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> toURLParams r = [(<span class="hljs-string"><span class="hljs-string">"lyrics_id"</span></span> =. lyricsLyricsId r), (<span class="hljs-string"><span class="hljs-string">"text"</span></span> =. lyricsText r)] |]</code> </pre><br><div class="spoiler">  <b class="spoiler_title">AST</b> <div class="spoiler_text"><pre> <code class="haskell hljs">[<span class="hljs-type"><span class="hljs-type">InstanceD</span></span> [] (<span class="hljs-type"><span class="hljs-type">AppT</span></span> (<span class="hljs-type"><span class="hljs-type">ConT</span></span> <span class="hljs-type"><span class="hljs-type">Queryable</span></span>) (<span class="hljs-type"><span class="hljs-type">ConT</span></span> <span class="hljs-type"><span class="hljs-type">Lyrics</span></span>)) [<span class="hljs-type"><span class="hljs-type">FunD</span></span> toURLParams [<span class="hljs-type"><span class="hljs-type">Clause</span></span> [<span class="hljs-type"><span class="hljs-type">VarP</span></span> r_2] (<span class="hljs-type"><span class="hljs-type">NormalB</span></span> (<span class="hljs-type"><span class="hljs-type">ListE</span></span> [<span class="hljs-type"><span class="hljs-type">InfixE</span></span> (<span class="hljs-type"><span class="hljs-type">Just</span></span> (<span class="hljs-type"><span class="hljs-type">LitE</span></span> (<span class="hljs-type"><span class="hljs-type">StringL</span></span> <span class="hljs-string"><span class="hljs-string">"lyrics_id"</span></span>))) (<span class="hljs-type"><span class="hljs-type">VarE</span></span> =.) (<span class="hljs-type"><span class="hljs-type">Just</span></span> (<span class="hljs-type"><span class="hljs-type">AppE</span></span> (<span class="hljs-type"><span class="hljs-type">VarE</span></span> lyricsLyricsId) (<span class="hljs-type"><span class="hljs-type">VarE</span></span> r_2))), <span class="hljs-type"><span class="hljs-type">InfixE</span></span> (<span class="hljs-type"><span class="hljs-type">Just</span></span> (<span class="hljs-type"><span class="hljs-type">LitE</span></span> (<span class="hljs-type"><span class="hljs-type">StringL</span></span> <span class="hljs-string"><span class="hljs-string">"text"</span></span>))) (<span class="hljs-type"><span class="hljs-type">VarE</span></span> =.) (<span class="hljs-type"><span class="hljs-type">Just</span></span> (<span class="hljs-type"><span class="hljs-type">AppE</span></span> (<span class="hljs-type"><span class="hljs-type">VarE</span></span> lyricsText) (<span class="hljs-type"><span class="hljs-type">VarE</span></span> r_2)))])) []]]]</code> </pre><br></div></div><br>  Then it remains to find the corresponding functions in <a href="http://hackage.haskell.org/package/template-haskell-2.10.0.0/docs/Language-Haskell-TH.html">Language.Haskell.TH</a> by the names of the received AST and construct our <b>deriveQueryable</b> macro. <br><br>  Haskell functions do not have optional parameters, but we will provide default values ‚Äã‚Äãby describing instances of the <a href="http://hackage.haskell.org/package/data-default-generics">Default</a> class for queries. <br><br>  The user will be able to change only the attributes of his record. <br><br><pre> <code class="haskell hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">instance</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Default</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Save</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">where</span></span></span></span> def = <span class="hljs-type"><span class="hljs-type">Save</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-string"><span class="hljs-string">""</span></span> <span class="hljs-string"><span class="hljs-string">""</span></span> <span class="hljs-type"><span class="hljs-type">Nothing</span></span> <span class="hljs-type"><span class="hljs-type">Nothing</span></span></code> </pre><br><h3>  Description of the answers </h3><br>  The association of JSON responses with ADT entries for each type of result will be determined by an instance of the class. <br>  <a href="http://hackage.haskell.org/package/api-builder-0.11.0.0/docs/Network-API-Builder-Receive.html">Receivable</a> . <br><br>  The automation of converting JSON to ADT records is easily handled by <a href="http://hackage.haskell.org/package/aeson">aeson</a> . <br><br><pre> <code class="haskell hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">data</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Lyrics</span></span></span><span class="hljs-class"> = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Lyrics</span></span></span><span class="hljs-class"> { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">lyricsLyricsId</span></span></span><span class="hljs-class"> :: </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Int</span></span></span><span class="hljs-class"> , </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">lyricsText</span></span></span><span class="hljs-class"> :: </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">T</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Text</span></span></span><span class="hljs-class"> } </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">deriving</span></span></span><span class="hljs-class"> (</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Show</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Generic</span></span></span><span class="hljs-class">) instance </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">FromJSON</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Lyrics</span></span></span><span class="hljs-class"> where parseJSON = genericParseJSON $ aesonPrefix snakeCase instance </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Receivable</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Lyrics</span></span></span><span class="hljs-class"> where receive = useFromJSON</span></span></code> </pre><br><a name="maybe"></a><br><h3>  Abort Computation Sequence </h3><br>  Using <a href="https://wiki.haskell.org/Maybe">Maybe</a> , <a href="https://hackage.haskell.org/package/base-4.8.1.0/docs/Data-Either.html">Either</a> types in a monadic context or <a href="https://hackage.haskell.org/package/transformers-0.4.3.0/docs/Control-Monad-Trans-Maybe.html">monodic</a> Transformers <a href="https://hackage.haskell.org/package/transformers-0.4.3.0/docs/Control-Monad-Trans-Maybe.html">MaybeT</a> , <a href="https://hackage.haskell.org/package/either-4.4.1/docs/Control-Monad-Trans-Either.html">EitherT</a> , <a href="https://hackage.haskell.org/package/mtl-2.2.1/docs/Control-Monad-Except.html">ExceptT,</a> etc. allows you to interrupt the calculation at the first ‚Äúexception‚Äù, avoiding tedious checks. <br><br>  Haskell is not alone in this approach, so the <a href="https://developer.apple.com/library/mac/documentation/Swift/Conceptual/Swift_Programming_Language/OptionalChaining.html">optional sequences</a> in Swift are nothing more than a <b>Maybe</b> monad for the poor, synced at the syntax level. <br><br>  The <a href="https://hackage.haskell.org/package/errors">errors</a> package provides all sorts of rewinding back and forth calculations between members of this team.  What we use, otherwise our code for uploading audio files to the server with many checks would be inconvenient. <br><br><div class="spoiler">  <b class="spoiler_title">uploadAudio</b> <div class="spoiler_text"><pre> <code class="haskell hljs"><span class="hljs-comment"><span class="hljs-comment">-- | Upload audio file 'fn' to VKontakte. Register optional 'artist' -- and 'title' for it. uploadAudio :: T.Text -&gt; Maybe T.Text -&gt; Maybe T.Text -&gt; API s VKError (ActionResponse SavedAudio) uploadAudio fn artist title = do (AR (UploadServer uploadURL)) &lt;- toAPI GetUploadServer let msrv = uriToRoute &lt;$&gt; (parseURI $ T.unpack uploadURL) (srvURL, srvArgs, srvRoute) &lt;- hoistEither $ note (mkError "bad upload url") msrv --  ,      let fnPart = partFileSource "file" $ T.unpack fn parts = Multipart $ (fnPart:srvArgs) mreq &lt;- sendMultipart (basicBuilder "audioUpload" srvURL) srvRoute parts req &lt;- hoistEither $ note (mkError "can't construct request") mreq --   manager &lt;- liftManager ask resp &lt;- liftIO $ try $ httpLbs req manager res &lt;- hoistEither $ first HTTPError resp --     'Save'       save &lt;- hoistEither $ receive res toAPI save{saveArtist = artist, saveTitle = title} ...</span></span></code> </pre><br></div></div><br><h3>  Declarative string parsing </h3><br>  There are no fewer tools for working with strings and regular expressions in Haskell than in any other respected language, but there is a better way.  The Haskell parser generators have a pronounced taste of declarativeness, so in the following case we will set aside scissors and write a small parser on <a href="https://wiki.haskell.org/Parsec">Parsec</a> to convert the <a href="https://vk.com/dev/privacy_setting">privacy_setting</a> API to ADT. <br><br><div class="spoiler">  <b class="spoiler_title">ADT and parser</b> <div class="spoiler_text"><pre> <code class="haskell hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">data</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Privacy</span></span></span><span class="hljs-class"> = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">AllowAll</span></span></span><span class="hljs-class"> | </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">AllowFriends</span></span></span><span class="hljs-class"> | </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">AllowFriendsOfFriends</span></span></span><span class="hljs-class"> | </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">AllowFriendsOfFriendsOnly</span></span></span><span class="hljs-class"> | </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">AllowNobody</span></span></span><span class="hljs-class"> | </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">AllowOnlyMe</span></span></span><span class="hljs-class"> | </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">AllowList</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Int</span></span></span><span class="hljs-class"> | </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">AllowUser</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Int</span></span></span><span class="hljs-class"> | </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DenyList</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Int</span></span></span><span class="hljs-class"> | </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DenyUser</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Int</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">deriving</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Show</span></span></span><span class="hljs-class"> instance </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">FromJSON</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Privacy</span></span></span><span class="hljs-class"> where parseJSON = withText "</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Privacy</span></span></span><span class="hljs-class">" doParse where doParse txt = case parse parser "" txt of </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Left</span></span></span><span class="hljs-class"> _ -&gt; mempty </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Right</span></span></span><span class="hljs-class"> v -&gt; pure v parser = try (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">string</span></span></span><span class="hljs-class"> "</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">friends_of_friends_only</span></span></span><span class="hljs-class">" &gt;&gt; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">return</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">AllowFriendsOfFriendsOnly</span></span></span><span class="hljs-class">) &lt;|&gt; try (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">string</span></span></span><span class="hljs-class"> "</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">friends_of_friends</span></span></span><span class="hljs-class">" &gt;&gt; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">return</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">AllowFriendsOfFriends</span></span></span><span class="hljs-class">) &lt;|&gt; (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">string</span></span></span><span class="hljs-class"> "</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">friends</span></span></span><span class="hljs-class">" &gt;&gt; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">return</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">AllowFriends</span></span></span><span class="hljs-class">) &lt;|&gt; (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">string</span></span></span><span class="hljs-class"> "</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">nobody</span></span></span><span class="hljs-class">" &gt;&gt; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">return</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">AllowNobody</span></span></span><span class="hljs-class">) &lt;|&gt; (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">string</span></span></span><span class="hljs-class"> "</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">only_me</span></span></span><span class="hljs-class">" &gt;&gt; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">return</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">AllowOnlyMe</span></span></span><span class="hljs-class">) &lt;|&gt; (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">string</span></span></span><span class="hljs-class"> "</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">list</span></span></span><span class="hljs-class">" &gt;&gt; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">many1</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">digit</span></span></span><span class="hljs-class"> &gt;&gt;= </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">return</span></span></span><span class="hljs-class"> . </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">AllowList</span></span></span><span class="hljs-class"> . </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">read</span></span></span><span class="hljs-class">) &lt;|&gt; (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">many1</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">digit</span></span></span><span class="hljs-class"> &gt;&gt;= </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">return</span></span></span><span class="hljs-class"> . </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">AllowUser</span></span></span><span class="hljs-class"> . </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">read</span></span></span><span class="hljs-class">) &lt;|&gt; (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">string</span></span></span><span class="hljs-class"> "</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">all</span></span></span><span class="hljs-class">" &gt;&gt; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">return</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">AllowAll</span></span></span><span class="hljs-class">) &lt;|&gt; (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">string</span></span></span><span class="hljs-class"> "-" &gt;&gt; ((</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">many1</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">digit</span></span></span><span class="hljs-class"> &gt;&gt;= </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">return</span></span></span><span class="hljs-class"> . </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DenyUser</span></span></span><span class="hljs-class"> . </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">read</span></span></span><span class="hljs-class">) &lt;|&gt; (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">string</span></span></span><span class="hljs-class"> "</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">list</span></span></span><span class="hljs-class">" &gt;&gt; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">many1</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">digit</span></span></span><span class="hljs-class"> &gt;&gt;= </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">return</span></span></span><span class="hljs-class"> . </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DenyList</span></span></span><span class="hljs-class"> . </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">read</span></span></span><span class="hljs-class">)))</span></span></code> </pre><br></div></div><br>  As we see, the implementation in terms of compactness and intelligibility differs little from the text description. <br><br><h3>  Testing </h3><br>  For testing, use the popular <acronym>BDD</acronym> package <a href="http://hspec.github.io/">HSpec</a> . <br><br>  HSpec can search for tests, perform initialization and cleanup, and has a simple declarative interface.  The test for checking OAuth authorization VKontakte will look like this. <br><br><div class="spoiler">  <b class="spoiler_title">Test to check OAuth VK authentication</b> <div class="spoiler_text"><pre> <code class="haskell hljs"><span class="hljs-title"><span class="hljs-title">spec</span></span> :: <span class="hljs-type"><span class="hljs-type">Spec</span></span> spec = <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> describe <span class="hljs-string"><span class="hljs-string">"OAuth authorization"</span></span> $ <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> it <span class="hljs-string"><span class="hljs-string">"doesn't ask for any permissions"</span></span> $ <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> execVKAPI () (vksettings <span class="hljs-type"><span class="hljs-type">Nothing</span></span>) getAuthToken &gt;&gt;= (`shouldSatisfy` checkAuthToken) it <span class="hljs-string"><span class="hljs-string">"asks for some permissions"</span></span> $ <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> execVKAPI () (vksettings $ <span class="hljs-type"><span class="hljs-type">Just</span></span> [<span class="hljs-type"><span class="hljs-type">Audio</span></span>, <span class="hljs-type"><span class="hljs-type">Video</span></span>]) getAuthToken &gt;&gt;= (`shouldSatisfy` checkAuthToken) <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> getAuthToken = liftState $ gets _vkAuthToken checkAuthToken :: <span class="hljs-type"><span class="hljs-type">Either</span></span> (<span class="hljs-type"><span class="hljs-type">APIError</span></span> <span class="hljs-type"><span class="hljs-type">VKError</span></span>) (<span class="hljs-type"><span class="hljs-type">Maybe</span></span> <span class="hljs-type"><span class="hljs-type">AuthToken</span></span>) -&gt; <span class="hljs-type"><span class="hljs-type">Bool</span></span> checkAuthToken (<span class="hljs-type"><span class="hljs-type">Right</span></span> (<span class="hljs-type"><span class="hljs-type">Just</span></span> (<span class="hljs-type"><span class="hljs-type">AuthToken</span></span> _ _ _))) = <span class="hljs-type"><span class="hljs-type">True</span></span> checkAuthToken _ = <span class="hljs-type"><span class="hljs-type">False</span></span> vksettings :: <span class="hljs-type"><span class="hljs-type">Maybe</span></span> [<span class="hljs-type"><span class="hljs-type">AuthPermissions</span></span>] -&gt; <span class="hljs-type"><span class="hljs-type">VKSettings</span></span> vksettings scope = createSettings appId userName userPass scope</code> </pre><br></div></div><br><h2>  Browser application </h2><br>  The complete package code is shown here <a href="">vk-api-example</a> . <br><br>  Our small application will display and play the user's audio player, popular tracks, and search for audio recordings. <br><br>  Now consider how convenient Haskell is for writing JavaScript applications. <br>  The Haskell family of compilers in JavaScript is quite large. Of the most popular, we note: <br><ul><li>  <a href="https://github.com/ghcjs/ghcjs">GHCJS</a> - full Haskell </li><li>  <a href="https://github.com/valderman/haste-compiler">Haste</a> - almost full haskell </li><li>  <a href="https://github.com/faylang/fay">Fay</a> - a subset of Haskell </li><li>  <a href="https://github.com/purescript/purescript">PureScript</a> - Haskell with JavaScript semantics </li><li>  <a href="https://github.com/elm-lang/elm-compiler">Elm</a> - Haskell is a similar, niche language for browser applications. </li></ul><br><br>  We will use GHCJS, where our API package can be used without modification. <br><br>  The basis for building the interface will be a package of <a href="http://hackage.haskell.org/package/react-flux">React-Flux</a> banding to <a href="https://facebook.github.io/react/">React</a> / <a href="https://facebook.github.io/flux/">Flux</a> . <br><br>  React-Flux preserves the semantics and architecture of <a href="https://facebook.github.io/flux/docs/overview.html">Flux</a> applications and uses the same component naming. <br><br><h3>  Some advantages of Haskell as applied to JavaScript </h3><br>  Consider a few advantages, besides the obvious strong typing, using Haskell. <br><br><h4>  <acronym>DSL</acronym> for React, <a href="https://facebook.github.io/react/docs/jsx-in-depth.html">JSX is</a> not needed </h4><br>  Due to the compactness of the syntax, the use of monadic or applicative context computing, Haskell is one of the champions for the production of DSL "from nowhere." <br><br>  Let's compare the equivalent fragments of <a href="https://github.com/eryx67/vk-api-example/tree/master/src/VK/App/Widgets/AudioPlayer">AudioPlayer</a> code ported to our application from the <a href="">react-audio-player</a> JavaScript player with the original. <br><br><div class="spoiler">  <b class="spoiler_title">Jsx</b> <div class="spoiler_text"><pre> <code class="html hljs xml"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">id</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">{audioVolumeBarContainerId}</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">ref</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"audioVolumeBarContainer"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">className</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"audio-volume-bar-container"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Button</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">id</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">{toggleBtnId}</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">ref</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"toggleButton"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">bsSize</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"small"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">onClick</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">{this.toggle}</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Glyphicon</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">glyph</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">{toggleIcon}/</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Button</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">className</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">{audioVolumeBarClasses}</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">className</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"audio-volume-min-max"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">onClick</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">{this.volumeToMax}</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Glyphicon</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">glyph</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"volume-up"</span></span></span><span class="hljs-tag"> /&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">ref</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"audioVolumePercentContainer"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">className</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"audio-volume-percent-container"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">onClick</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">{this.adjustVolumeTo}</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">className</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"audio-volume-percent"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">style</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">{style}</span></span></span><span class="hljs-tag">&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">className</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"audio-volume-min-max"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">onClick</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">{this.volumeToMin}</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Glyphicon</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">glyph</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"volume-off"</span></span></span><span class="hljs-tag"> /&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre><br></div></div><br><div class="spoiler">  <b class="spoiler_title">Haskell</b> <div class="spoiler_text"><pre> <code class="haskell hljs"><span class="hljs-title"><span class="hljs-title">div_</span></span> ((<span class="hljs-string"><span class="hljs-string">"className"</span></span> $= <span class="hljs-string"><span class="hljs-string">"audio-volume-bar-container"</span></span>):mouseLeaveHlr) $ <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> bootstrap_ <span class="hljs-string"><span class="hljs-string">"Button"</span></span> [<span class="hljs-string"><span class="hljs-string">"bsSize"</span></span> $= <span class="hljs-string"><span class="hljs-string">"small"</span></span> , onClick toggleHlr ] $ bootstrap_ <span class="hljs-string"><span class="hljs-string">"Glyphicon"</span></span> [<span class="hljs-string"><span class="hljs-string">"glyph"</span></span> $= toggleIcon] mempty div_ [<span class="hljs-string"><span class="hljs-string">"className"</span></span> $= classes] $ <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> div_ [<span class="hljs-string"><span class="hljs-string">"className"</span></span> $= <span class="hljs-string"><span class="hljs-string">"audio-volume-min-max"</span></span> , onClick (\_ _ -&gt; dispatch st (<span class="hljs-type"><span class="hljs-type">AdjustVolume</span></span> $ fromFactor (<span class="hljs-number"><span class="hljs-number">1</span></span>::<span class="hljs-type"><span class="hljs-type">Int</span></span>)))] $ bootstrap_ <span class="hljs-string"><span class="hljs-string">"Glyphicon"</span></span> [<span class="hljs-string"><span class="hljs-string">"glyph"</span></span> $= <span class="hljs-string"><span class="hljs-string">"volume-up"</span></span>] mempty div_ [<span class="hljs-string"><span class="hljs-string">"className"</span></span> $= <span class="hljs-string"><span class="hljs-string">"audio-volume-percent-container"</span></span> , onClick adjustVolumeToHlr] $ div_ [<span class="hljs-string"><span class="hljs-string">"className"</span></span> $= <span class="hljs-string"><span class="hljs-string">"audio-volume-percent"</span></span> , <span class="hljs-string"><span class="hljs-string">"style"</span></span> @= style] mempty div_ [<span class="hljs-string"><span class="hljs-string">"className"</span></span> $= <span class="hljs-string"><span class="hljs-string">"audio-volume-min-max"</span></span> , onClick (\_ _ -&gt; dispatch st (<span class="hljs-type"><span class="hljs-type">AdjustVolume</span></span> $ fromFactor (<span class="hljs-number"><span class="hljs-number">0</span></span>::<span class="hljs-type"><span class="hljs-type">Int</span></span>)))] $ bootstrap_ <span class="hljs-string"><span class="hljs-string">"Glyphicon"</span></span> [<span class="hljs-string"><span class="hljs-string">"glyph"</span></span> $= <span class="hljs-string"><span class="hljs-string">"volume-off"</span></span>] mempty</code> </pre><br></div></div><br>  The readability of the code is equivalent, but in the second case we do without a specialized translator, do not go beyond the language, we have full support from the development tools. <br><br>  When porting the player, I tried to keep the naming and logic, so that the interested reader could easily make a comparison of the implementations and draw their own conclusions. <br><br><h4>  Solving the problem "callback hell" </h4><br>  The following Haskell properties will help us bypass coding in <acronym>CPS</acronym> style. <br><br><ul><li>  Ranthym GHCJS supports the entire Haskell arsenal of <a href="http://chimera.labs.oreilly.com/books/1230000000929">parallel / competitive computing</a> .  We can write code in the usual semantics of competitive processes, using standard <a href="https://hackage.haskell.org/package/base-4.8.1.0/docs/Control-Concurrent.html">forkIO</a> calls to create them and the usual Haskell synchronization primitives - IORef, MVar, STM, etc. <br></li><li>  The special syntax of the monadic calculation operator <a href="https://en.wikibooks.org/wiki/Haskell/do_notation">do</a> is just a compiler of a sequence of calculations into nested CPS calls. <br></li><li>  The previously mentioned methods of <a href="https://habr.com/ru/post/272871/">interrupting the sequence of calculations</a> also help to make a beautiful dish out of ‚Äúnoodles‚Äù. <br></li></ul><br>  Let's put it all together and give, as an example, the AJAX function to call operations of our API from an application. <br><br><div class="spoiler">  <b class="spoiler_title">runAPI</b> <div class="spoiler_text"><pre> <code class="haskell hljs"><span class="hljs-title"><span class="hljs-title">runAPI</span></span> :: <span class="hljs-type"><span class="hljs-type">State</span></span> -&gt; <span class="hljs-type"><span class="hljs-type">VKAction</span></span> -&gt; <span class="hljs-type"><span class="hljs-type">VK</span></span>.<span class="hljs-type"><span class="hljs-type">VKAPI</span></span> <span class="hljs-type"><span class="hljs-type">ApiState</span></span> a -&gt; (a -&gt; <span class="hljs-type"><span class="hljs-type">VKAction</span></span>) -&gt; <span class="hljs-type"><span class="hljs-type">IO</span></span> () runAPI <span class="hljs-type"><span class="hljs-type">State</span></span>{..} action apiAction hlr = void . forkIO $ <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> res &lt;- runMaybeT $ <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> <span class="hljs-comment"><span class="hljs-comment">--   ? as &lt;- hoistMaybe apiState _ &lt;- hoistMaybe $ if VK.isAuthorized as then Just True else Nothing lift $ do -- AJAX  ,   alterStore store (SetAjaxRunning True) --   (res, nas) &lt;- VK.runVKAPI as apiAction alterStore store (SetApiState nas) -- ,   alterStore store (SetAjaxRunning False) --       either apiError handleAction res --  ,    when (isNothing res) $ alterStore store (Authorize action) where handleAction v = alterStore store (hlr v)</span></span></code> </pre><br></div></div><br><h3>  Routing in the application, we use <acronym>FFI</acronym> </h3><br>  Since the application is one-page, we should take care of using the browser history.  Create a module <a href="">Router</a> . <br><br>  <a href="https://facebook.github.io/flux/docs/overview.html">Actions of</a> our application will be represented by the type ADT <a href="">VKAction</a> . <br><br>  For mutual mapping of the URL from <b>window.location.hash</b> to ADT, we use the popular <a href="http://hackage.haskell.org/package/web-routes">web-routes</a> package. <br><br>  The corresponding macro from the package will create code for such a mapping. <br><br><pre> <code class="haskell hljs">$(derivePathInfo ''<span class="hljs-type"><span class="hljs-type">VKAction</span></span>)</code> </pre><br>  This will be enough to convert Actions to a URL, an example of using is creating a link. <br><br><pre> <code class="haskell hljs"><span class="hljs-title"><span class="hljs-title">a_</span></span> [<span class="hljs-string"><span class="hljs-string">"href"</span></span> $= actionRoute store parentRouter (<span class="hljs-type"><span class="hljs-type">Audios</span></span> $ <span class="hljs-type"><span class="hljs-type">SetAudioSelector</span></span> asel)] label</code> </pre><br>  To react to the change of <b>window.location.hash,</b> we will need to hang the handler on <b>window.onhashchange</b> .  FHI in GHCJS is pretty simple, the following code hardly needs comment. <br><br><pre> <code class="haskell hljs"><span class="hljs-keyword"><span class="hljs-keyword">foreign</span></span> <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> javascript <span class="hljs-keyword"><span class="hljs-keyword">unsafe</span></span> <span class="hljs-string"><span class="hljs-string">"window.onhashchange = function() {$1(location.hash.toString());}"</span></span> js_attachtLocationHashCb :: (<span class="hljs-type"><span class="hljs-type">Callback</span></span> (<span class="hljs-type"><span class="hljs-type">JSVal</span></span> -&gt; <span class="hljs-type"><span class="hljs-type">IO</span></span> ())) -&gt; <span class="hljs-type"><span class="hljs-type">IO</span></span> () onLocationHashChange :: (<span class="hljs-type"><span class="hljs-type">String</span></span> -&gt; <span class="hljs-type"><span class="hljs-type">IO</span></span> ()) -&gt; <span class="hljs-type"><span class="hljs-type">IO</span></span> () onLocationHashChange fn = do cb &lt;- syncCallback1 <span class="hljs-type"><span class="hljs-type">ThrowWouldBlock</span></span> (fn . <span class="hljs-type"><span class="hljs-type">JSS</span></span>.unpack . unsafeCoerce) js_attachtLocationHashCb cb</code> </pre><br><h3>  Application modularity </h3><br>  <b>React-Flux</b> gives us the opportunity to create several controllers, the <b>Store</b> , with their <b>Actions</b> and dispatching and further organize their joint work through competitive processes. <br><br>  So the input entry widget of the <a href="">IncrementalInput</a> application uses the <a href="">IdleTimer</a> timer, which is a full-fledged controller with its own <b>Store</b> and <b>Actions</b> and works independently of the main application controller. <br><br><h3>  Application Testing </h3><br>  To test the application, we will again use <b>HSpec</b> and <a href="http://www.seleniumhq.org/projects/webdriver/">Selenium Webdriver</a> via <a href="http://hackage.haskell.org/package/hspec-webdriver">hspec-webdriver</a> . <br><br><div class="spoiler">  <b class="spoiler_title">Application Tests</b> <div class="spoiler_text"><pre> <code class="haskell hljs"><span class="hljs-title"><span class="hljs-title">spec</span></span> :: <span class="hljs-type"><span class="hljs-type">Spec</span></span> spec = session <span class="hljs-string"><span class="hljs-string">"VK application tests"</span></span> $ using <span class="hljs-type"><span class="hljs-type">Chrome</span></span> $ <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> it <span class="hljs-string"><span class="hljs-string">"login to Vkontakte with user credentials"</span></span> $ runWD $ <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> dir &lt;- liftIO getCurrentDirectory openPage $ <span class="hljs-string"><span class="hljs-string">"file://"</span></span> ++ dir ++ <span class="hljs-string"><span class="hljs-string">"/example/vk.html"</span></span> cw &lt;- getCurrentWindow findElem (<span class="hljs-type"><span class="hljs-type">ByCSS</span></span> <span class="hljs-string"><span class="hljs-string">"div.authorization &gt; div.panel-body &gt; a.btn"</span></span>) &gt;&gt;= click liftIO $ threadDelay <span class="hljs-number"><span class="hljs-number">3000000</span></span> ws &lt;- windows length ws `shouldBe` <span class="hljs-number"><span class="hljs-number">2</span></span> <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> <span class="hljs-type"><span class="hljs-type">Just</span></span> vkW = find (/= cw) ws focusWindow vkW findElem (<span class="hljs-type"><span class="hljs-type">ByName</span></span> <span class="hljs-string"><span class="hljs-string">"email"</span></span>) &gt;&gt;= sendKeys userName findElem (<span class="hljs-type"><span class="hljs-type">ByName</span></span> <span class="hljs-string"><span class="hljs-string">"pass"</span></span>) &gt;&gt;= sendKeys userPass findElem (<span class="hljs-type"><span class="hljs-type">ByCSS</span></span> <span class="hljs-string"><span class="hljs-string">"form input.button"</span></span>) &gt;&gt;= click authUrl &lt;- getCurrentURL closeWindow vkW focusWindow cw findElem (<span class="hljs-type"><span class="hljs-type">ByCSS</span></span> <span class="hljs-string"><span class="hljs-string">"input.form-control"</span></span>) &gt;&gt;= sendKeys (<span class="hljs-type"><span class="hljs-type">T</span></span>.pack authUrl) liftIO $ threadDelay <span class="hljs-number"><span class="hljs-number">3000000</span></span> findElem (<span class="hljs-type"><span class="hljs-type">ByCSS</span></span> <span class="hljs-string"><span class="hljs-string">"button"</span></span>) &gt;&gt;= click liftIO $ threadDelay <span class="hljs-number"><span class="hljs-number">3000000</span></span> it <span class="hljs-string"><span class="hljs-string">"selects \"AnyAudio\""</span></span> $ runWD $ <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> findElem (<span class="hljs-type"><span class="hljs-type">ByCSS</span></span> <span class="hljs-string"><span class="hljs-string">"a[href=\"#/audios/set-audio-selector/any-audio\"]"</span></span>) &gt;&gt;= click liftIO $ threadDelay <span class="hljs-number"><span class="hljs-number">3000000</span></span> pagerEls &lt;- findElems (<span class="hljs-type"><span class="hljs-type">ByCSS</span></span> <span class="hljs-string"><span class="hljs-string">"a[href^=\"#/audios/get-audio/\"]"</span></span>) length pagerEls `shouldBe` <span class="hljs-number"><span class="hljs-number">11</span></span> activeEls &lt;- findElems (<span class="hljs-type"><span class="hljs-type">ByCSS</span></span> <span class="hljs-string"><span class="hljs-string">"li.active a[href=\"#\"]"</span></span>) length activeEls `shouldBe` <span class="hljs-number"><span class="hljs-number">1</span></span></code> </pre><br></div></div><br>  A couple of screenshots of our modest share. <br><br><div class="spoiler">  <b class="spoiler_title">Authorization screen</b> <div class="spoiler_text"><img src="https://habrastorage.org/files/141/567/196/141567196b7940adbaa388a278a38468.png"><br></div></div><br><div class="spoiler">  <b class="spoiler_title">Main screen</b> <div class="spoiler_text"><img src="https://habrastorage.org/files/870/0c2/5f8/8700c25f855c4864bc50cfa43b743c80.png"><br></div></div><br><h2>  Conclusion </h2><br>  I hope this summary review will serve the stated goal at the beginning. <br><br>  Anticipating the predictable wishes of readers, I will go and kill myself about the rock garden. </div><p>Source: <a href="https://habr.com/ru/post/272871/">https://habr.com/ru/post/272871/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../272861/index.html">Java 9 First Steps and the Jigsaw Project - Part Two</a></li>
<li><a href="../272863/index.html">What happened to hook_menu in Drupal 8?</a></li>
<li><a href="../272865/index.html">We are replacing the Bing search engine with the necessary one in Skype</a></li>
<li><a href="../272867/index.html">Organization of a hybrid port on the Alcatel-Lucent 7210 SAS-M</a></li>
<li><a href="../272869/index.html">About how I spent a week in Bareos</a></li>
<li><a href="../272873/index.html">PhoneGap vs. Cordova</a></li>
<li><a href="../272875/index.html">Animated screen orientation changes in a Windows Phone application</a></li>
<li><a href="../272879/index.html">Live Web Standards Days and Community DevCamp on the weekend</a></li>
<li><a href="../272881/index.html">Tanchiki, sand and augmented reality. Using Intel RealSense</a></li>
<li><a href="../272883/index.html">Mathematical secrets of "big data"</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>