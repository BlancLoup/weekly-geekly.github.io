<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Automatic database migration to the Entity Framework</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="In the process of software development, when not all the functionality is finally defined, the database structure often changes. And if any ORM-framew...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Automatic database migration to the Entity Framework</h1><div class="post__text post__text-html js-mediator-article">  In the process of software development, when not all the functionality is finally defined, the database structure often changes.  And if any ORM-framework is used, changing the database after changing the data model gives some inconvenience (in fact, you need to do double work on changing the model class and database structure).  In brief, how to make migration to <acronym>EF</acronym> 4 Code First using the Package Manager Console is described <a href="http://habrahabr.ru/post/143204/">here</a> , I will try to describe how automatic migration works without developer participation (more precisely, with minimal participation). <br><br><a name="habracut"></a><br><h4>  How it all started </h4><br>  The challenge was to create a new project, which is something like an <acronym>AWP</acronym> and. <br>  After some discussion, we decided to use the Entity Framework Code First, since  in the future, a change of the <acronym>DBMS</acronym> is possible, and with this option we will just need to change the connection string (if there is a suitable ADO.NET provider). <br>  Made data models, context class, inherited from DbContext: <br><br><pre><code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">ProjectContext</span></span> : <span class="hljs-title"><span class="hljs-title">DbContext</span></span> { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ProjectContext</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ProjectContext</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> connString</span></span></span><span class="hljs-function">) : </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">base</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">connString</span></span></span><span class="hljs-function">)</span></span> { } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> DbSet&lt;Address&gt; Addresses { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } ... }</code> </pre> <br>  added initializer: 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">ProjectInitializer</span></span> : <span class="hljs-title"><span class="hljs-title">DropCreateDatabaseIfModelChanges</span></span>&lt;<span class="hljs-title"><span class="hljs-title">ProjectContext</span></span>&gt; { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">protected</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">override</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Seed</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">ProjectContext context</span></span></span><span class="hljs-function">)</span></span> { ... } }</code> </pre> <br>  and prescribe (in our case in Global.asax) the initializer: <br><br><pre> <code class="cs hljs">Database.SetInitializer(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ProjectInitializer());</code> </pre> <br>  Everything seems fine, who does not have a database to create, but after specifying details for the customer, it became necessary to add more entities.  And since several developers are developing, there was a massive re-creation of the database, and the data there was already real. <br><br><h4>  Migrations </h4><br>  So we came to migrations.  As the <a href="http://blogs.msdn.com/b/adonet/archive/2012/02/09/ef-4-3-automatic-migrations-walkthrough.aspx">article</a> suggests, execute the command in the Package Manager Console: <br><br><pre> <code class="bash hljs">PM&gt; Add-Migration 1</code> </pre><br>  The project has a folder Migrations, which created two files: Configuration.cs, &lt;date_time&gt; _1.cs.  The first, as the name suggests migration configuration, the second contains the necessary database changes for updating / rolling back the version.  Next, just run in the console NuGet'a: <br><br><pre> <code class="bash hljs">PM&gt; Update-Database</code> </pre><br>  Everything was great, if someone didn‚Äôt have the same model as the database, he just did the migration to the console and deleted the migration file.  Until it is time to place the project on the server of the customer.  NuGet wasn‚Äôt there, and there wasn‚Äôt any opportunity to establish opportunities either (and the hosting provider doesn‚Äôt have such a possibility, in principle, if you don‚Äôt take a server). <br><br><h4>  Automatic migration </h4><br>  Trying to figure out how to do automatic migration, armed with IntelliSense, <s>using</s> empirical method of <s>scientific</s> testing, we found out that we need to change the class from which the initializer is inherited: <br><br><pre> <code class="cs hljs"><span class="hljs-comment"><span class="hljs-comment">//public class ProjectInitializer : DropCreateDatabaseIfModelChanges&lt;ProjectContext&gt; public class ProjectInitializer : MigrateDatabaseToLatestVersion&lt;ProjectContext, Configuration&gt; { ... }</span></span></code> </pre><br>  Launched and received such an exception: <br><br><img src="https://habrastorage.org/storage2/32a/e1a/b09/32ae1ab09f1f7277ba822a58ba7a1f97.png"><br><br>  Aha  We do what is proposed in the exception message, that is: <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">sealed</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">Configuration</span></span> : <span class="hljs-title"><span class="hljs-title">DbMigrationsConfiguration</span></span>&lt;<span class="hljs-title"><span class="hljs-title">ProjectContext</span></span>&gt; { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Configuration</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { AutomaticMigrationsEnabled = <span class="hljs-literal"><span class="hljs-literal">true</span></span>; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">protected</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">override</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Seed</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">ProjectContext context</span></span></span><span class="hljs-function">)</span></span> { } }</code> </pre><br>  we start and see that migration passes automatically. <br>  We achieved what we wanted, now migrations take place without the participation of the developer, but I mentioned that we still need some participation, for example, if we rename the model property and run the project, we will see the following exception: <br><br><img src="https://habrastorage.org/storage2/9aa/ece/760/9aaece760f2aa6f151fb8c4fe30781b7.png"><br><br>  The fact is that from the point of view of the Entity Framework, renaming a property is deleting and adding with a new name, and thus data loss is possible.  In such cases (and there are some of them), you just need to create a manual migration with the Add-Migration command and manually correct the DropColumn and CreateColumn to RenameColumn (or something else, depending on the situation). <br><br><h4>  Conclusion </h4><br>  That's all, I hope the article will be useful.  I also hope that there is very little information from the original source on this issue, because it‚Äôs like a beta version and with the release of Entity Framework 5.0, it‚Äôs not a matter of trial and error to search for the right use case. </div><p>Source: <a href="https://habr.com/ru/post/143292/">https://habr.com/ru/post/143292/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../143286/index.html">Google books knows the whole truth about testing and istqb</a></li>
<li><a href="../143288/index.html">Removing an object reference from a closure</a></li>
<li><a href="../143289/index.html">Opera Mini 7 Next Survey</a></li>
<li><a href="../143290/index.html">Errors of technology transfer ‚Ññ2 / "Disclosure errors"</a></li>
<li><a href="../143291/index.html">Dirty hands on google title page</a></li>
<li><a href="../143293/index.html">Access to the Guitar Hero store from "forbidden" countries</a></li>
<li><a href="../143294/index.html">The Elder Scrolls Online</a></li>
<li><a href="../143295/index.html">Five thousand kilometers of panoramas on Yandex. Maps</a></li>
<li><a href="../143296/index.html">Facebook estimates itself at 95.9 billion dollars</a></li>
<li><a href="../143297/index.html">How to pass the last days before the exam</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>