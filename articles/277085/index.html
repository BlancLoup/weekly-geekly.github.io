<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>CodingFuture + Puppet. Part I: network and network filter (cfnetwork + cffirehol)</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="In short: 


1. cfnetwork - Puppet API for full network configuration and filtering through Puppet resources. Friendly with Hiera and potentially othe...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>CodingFuture + Puppet. Part I: network and network filter (cfnetwork + cffirehol)</h1><div class="post__text post__text-html js-mediator-article"><h1 id="vkratce">  In short: </h1><br><blockquote><ol><li>  <strong><a href="https://forge.puppetlabs.com/codingfuture/cfnetwork">cfnetwork</a></strong> - <a href="https://puppetlabs.com/puppet/puppet-open-source">Puppet</a> API for full network configuration and filtering through Puppet resources.  Friendly with Hiera and potentially other "data providers" in the Puppet concept. </li><li> <strong><a href="https://forge.puppetlabs.com/codingfuture/cffirehol">cffirehol</a></strong> - the "meta-provider" of the specific implementation of filter settings for <code>cfnetwork</code> based on the wonderful <a href="https://github.com/firehol/firehol">FireHOL</a> generator </li><li>  So far, only Debian 8+ (Jessie and above) and Ubuntu 14.04+ (Trusty and above) are supported. </li></ol><br></blockquote><a name="habracut"></a><br><h2 id="tematicheskiy-cikl">  Thematic cycle: </h2><br><ul><li>  <strong><em>Part I: network and network filter (cfnetwork + cffirehol)</em></strong> </li><li>  <em><a href="https://habrahabr.ru/post/277309/">Part II: Access and Standard Environment (cfauth + cfsystem)</a></em> </li><li>  <em><a href="https://habrahabr.ru/post/278163/">Part III: Install Puppet Server (cfpuppetserver)</a></em> </li><li>  <em><a href="https://habrahabr.ru/post/279375/">Part IV: Centralized Management (cftotalcontrol)</a></em> </li><li>  <em><a href="https://habrahabr.ru/post/305108/">Part V: Databases (cfdb)</a></em> </li><li>  <em><a href="https://habrahabr.ru/post/320244/">Part VI: Topical Blacklists and Secure Knock</a></em> </li></ul><br><p>  <strong>Lyrical introduction:</strong> <em>it so happened that the author is extremely paranoid about the control of deployed systems and automation.</em>  <em>For many years, accumulated experience of the problems encountered and with respect to local solutions.</em>  <em>After leaving the previous job, it became clear that in general, there was no tangible baggage in the administration sphere.</em>  <em>However, the fact that it was, especially to drag with them further and did not want to.</em>  <em>So was born a new bike.</em>  <em>And now to the point.</em> </p><br><p>  <em>Note: According to the text, a <code></code> or a <code> </code> instead of another ‚ÄúRussian‚Äù term <code></code> that violates the author‚Äôs children's ear, eyes and brain of the author.</em> </p><br><h1 id="chem-ne-ustraivayut-suschestvuyuschie-resheniya">  What is not satisfied with the existing solutions? </h1><br><ul><li>  <strong>Weak integration of network configuration and network filter</strong> - additional fussing with (re-) configuration and high risk of errors;  difficulties in creating plug &amp; play modules of individual services that are friendly with the security system. </li><li>  <strong>Lack of visualization for auditing</strong> - the configuration is either not concise and smeared over many files, or it exists in general in an unreadable form for a person. </li><li>  <strong>Unnecessarily low-level filter configuration without abstractions</strong> - the same problems as the item above.  It can be compared to writing a web page in assembly language. </li><li>  <strong>The lack of "intelligence" of the default settings</strong> - for some clumsiness is an advantage, but not for the author. </li><li>  <strong>The network stack configuration is generally bypassed</strong> - vanilla kernel settings are not always what you want to see on the combat system even before testing and optimization, not to mention security. </li></ul><br><h1 id="obschaya-koncepciya-nastroyki-seti-i-filtra">  The general concept of network settings and filter </h1><br><p>  <em>No new theories - ordinariness from different places.</em> </p><br><ol><li>  Each logical network interface has a unique meaningful name like <code>world</code> , <code>dmz</code> , <code>office</code> , etc.  <code>local</code> reserved for the <code>loopback</code> interface. </li><li>  The settings of the standard logical interfaces are set and accessible to the filter rule generator. </li><li>  Support for a special type of interface <code>any</code> - the filter generator must be intelligent enough so as not to produce unnecessary rules where they will never work.  For example, if a list of allowed addresses is specified for outgoing or incoming, then the rules should not be added to interfaces where such connections are not assumed to be a network configuration in principle. </li><li>  Instead of directly specifying ports, an associative name is used, which can hide a whole set of ports and protocols. </li><li>  Temporary donation of the network and filter should be easily performed on the target machine without centralized control when recovering from failures. </li><li>  Sufficient network security must be achieved before enabling AppArmor or SeLinux. </li><li>  Dynamic protection must be implemented separately, but the blacklist interface is defined at this level. </li></ol><br><h1 id="vybor-tehnologiy">  Choice of technology </h1><br><ul><li>  <strong>Puppet 4 + Puppet DB + Hiera</strong> - the author honestly tried to instill in himself a love for at least one of Ansible and Chef, but the fourth version of Puppet took its toll.  Although, Ansible looks interesting for periodic tasks on system maintenance and initial deployment of Puppet. </li><li>  <strong>Ruby</strong> is essentially a predefined choice for Puppet extensions.  By the way, the author had to study this PL during the project, which he does not regret at all. </li><li>  <strong><a href="http://firehol.org/">FireHOL</a></strong> is the first third-party <code>iptables</code> generator that the author was able to entrust his network filter for more than 10 years of active server administration.  All other generators subjectively pale. </li></ul><br><h1 id="chto-poluchilos">  What happened </h1><br><p>  The interface itself consists of the main <code>cfnetwork</code> class and the <code>cfnetwork::*</code> type set for specifying network settings and network filter.  It is possible to set all settings programmatically through Puppet DSL or through a data provider like Hiera. </p><br><p>  A brief description of the API with an incomplete list of parameters.  The full is available in <a href="https://github.com/codingfuture/puppet-cfnetwork">English</a> . </p><br><h3 id="klass-cfnetwork">  <code>cfnetwork</code> class </h3><br><ul><li>  <code>main</code> - settings of the <code>cfnetwork::iface</code> for the main interface. </li><li>  <code>dns</code> - list of DNS servers or special values: <br><ul><li>  <code>'$recurse'</code> - put the local server. </li><li>  <code>'$serve'</code> is the same, but also serve clients on <code>$service_face</code> . </li></ul></li><li>  <code>is_router</code> - whether this machine performs the function of a network router. </li><li>  <code>optimize_10gbe</code> - adjust TCP default settings for maximum performance of connections over 10 + Gbit interfaces instead of public "Internet" ones with an estimated delay of 50-100ms. </li><li>  Convenience to use Hiera. <br>  All values ‚Äã‚Äãexcept <code>ifaces</code> have <a href="https://docs.puppetlabs.com/puppet/latest/reference/lookup_quick.html"><code>lookup_options: { merge: hash }</code> (documentation)</a> . <br><ul><li>  <code>ifaces</code> is a set of configurations of minor interfaces like <code>cfnetwork::iface</code> . </li><li>  <code>describe_services</code> - a set of resource descriptions of the type <code>cfnetwork::describe_service</code> (description of services). </li><li>  <code>service_ports</code> - dialing * <code>cfnetwork::service_port</code> (incoming connections). </li><li>  <code>client_ports</code> - set * <code>cfnetwork::client_ports</code> (outgoing connections). </li><li>  <code>dnat_ports</code> - set * <code>cfnetwork::dnat_ports</code> . </li><li>  <code>router_ports</code> - set * <code>cfnetwork::router_ports</code> . </li></ul></li></ul><br><h3 id="tip-cfnetworkiface---konfiguraciya-interfeysa">  type <code>cfnetwork::iface</code> - interface configuration. </h3><br><ul><li>  <code>title</code> - associative identifier that will be used in other resources. </li><li>  <code>device</code> - system network interface. </li><li>  <code>address</code> - the primary IPv4 / IPv6 address along with the network mask in the format <code>"address/cidr"</code> . </li><li>  <code>extra_addresses</code> - additional addresses in the same format. </li><li>  <code>extra_routes</code> - additional routing settings (also important for the filter generator). </li><li>  <code>gateway</code> - implies a default route that is used in the filter generator. </li><li>  <code>force_public = auto</code> is an extremely important setting for the filter: <br><ul><li>  By default, if <code>$address</code> belongs to 10/8, 172.16 / 12 or 192.168 / 16, then <code>false</code> , otherwise <code>true</code> . </li><li>  If <code>true</code> : <br><ul><li>  Automatically adds SNAT or MASQUERADE for outgoing connections. </li><li>  Automatically enables <a href="https://github.com/firehol/firehol/wiki/Working-with-SYNPROXY">TCP SYNPROXY</a> for incoming connections, including DNAT. </li><li>  Sets the <code>DROP</code> policy instead of the default <code>REJECT</code> . </li><li>  Limits incoming ping to 1 / sec.  via hashlimit for one ip. </li><li>  Sets the global black list of incoming IPs, except for the special whitelist. </li></ul></li></ul></li></ul><br><h3 id="tip-cfnetworkdescribe_service---opisanie-servisa-protokolov-i-portov">  type <code>cfnetwork::describe_service</code> - description of the service (protocols and ports). </h3><br><ul><li>  <code>title</code> - the resource name is used for all port names. </li><li>  <code>server</code> ‚Äî list of server ports in the <code>proto/portnum</code> .  Example: <code>[ 'tcp/80', 'tcp/443' ]</code> . </li></ul><br><h3 id="tip-cfnetworkclient_port---opisanie-uishodyaschegou-soedineniy">  type <code>cfnetwork::client_port</code> - description of <u>outgoing</u> connections. </h3><br><p>  Terminology taken from FireHOL .. </p><br><ul><li> <code>title = '&lt;iface&gt;:&lt;service&gt;[:&lt;tag&gt;]'</code> </li> <li>  <code>src</code> , <code>dst</code> , <code>user</code> , <code>group</code> , <code>comment</code> </li></ul><br><h3 id="tip-cfnetworkservice_port---opisanie-uvhodyaschegou-soedineniy">  type <code>cfnetwork::service_port</code> - description of <u>incoming</u> connections. </h3><br><ul><li> <code>title = '&lt;iface&gt;:&lt;service&gt;[:&lt;tag&gt;]'</code> </li> <li>  <code>src</code> , <code>dst</code> , <code>comment</code> </li></ul><br><h3 id="tip-cfnetworkrouter_port---opisanie-razreshyonnogo-marshrutiziruemogo-soedineniya">  type <code>cfnetwork::router_port</code> - description of the allowed routed connection. </h3><br><ul><li> <code>title = '&lt;iface&gt;/&lt;outface&gt;:&lt;service&gt;[:&lt;tag&gt;]'</code> </li> <li>  <code>src</code> , <code>dst</code> , <code>comment</code> </li></ul><br><h3 id="tip-cfnetworkdnat_port---opisanie-odnovremenno-mashrutiziruemogo-soedineniya-i-translyacii-adresa-naznacheniya">  type <code>cfnetwork::dnat_port</code> - description of the simultaneously routed connection and translation of the destination address </h3><br><ul><li> <code>title = '&lt;iface&gt;/&lt;outface&gt;:&lt;service&gt;[:&lt;tag&gt;]'</code> </li> <li>  <code>src</code> , <code>dst</code> , <code>comment</code> </li><li>  <code>to_dst</code> - redirect address (IPv4 and IPv6) </li><li>  <code>to_port</code> - port of redirection (optional) </li></ul><br><h3 id="opisanie-unificirovannyh-parametrov">  Description of unified parameters: </h3><br><ul><li>  <code>&lt;iface&gt;</code> is the name of the associated <code>cfnetwork::iface</code> or: <br><ul><li>  <code>'local'</code> - as already mentioned above - only local traffic, <u>but keep in mind that traffic to your own external IP also goes through <code>local</code> !</u> </li><li>  <code>'any'</code> is a special intricate login based on <code>src</code> , <code>dst</code> and <code>to_dst</code> so as not to create obviously unused rules.  In the absence of these parameters, it is added to all possible interfaces where it makes sense.  (For example, <code>local</code> does not make sense in <code>router_port</code> ) </li></ul></li><li>  <code>&lt;outface&gt;</code> - the same, but for the second interface in the case of <code>dnat_port</code> and <code>router_port</code> </li><li>  <code>&lt;service&gt;</code> - the name of the service description in <code>cfnetwork::describe_service</code> </li><li>  <code>&lt;tag&gt;</code> is an optional part that goes to <code>comment</code> . <br>  Added to avoid resource name conflicts without the need to explicitly use <a href="https://docs.puppetlabs.com/puppet/latest/reference/lang_virtual.html">"virtual resources"</a> </li><li>  <code>src</code> , <code>dst</code> - lists of outgoing and target IPv4 / IPv6 addresses </li><li>  <code>comment</code> - any single-line comment (forced line breaks are cut) </li><li>  <code>user</code> , <code>group</code> - check user and group for outgoing connections (the real paranoid is obliged to use them even for <code>local</code> ) </li></ul><br><h3 id="klass-cfnetworksysctl---vozmozhnost-tonkoy-nastroyki-setevogo-steka-standartnye-klyuchi-vyvedeny-v-vide-parametrov-klassa">  class <code>cfnetwork::sysctl</code> - the ability to fine-tune the network stack, the standard keys are displayed as class parameters. </h3><br><h3 id="klass-cffirehol---generator-filtra">  class <code>cffirehol</code> - filter generator </h3><br><ul><li>  <code>enable=false</code> - you must force it to turn on after you make sure that the filter config meets the expectations </li><li>  <code>synproxy_public=true</code> - SYNPROXY enable flag on public interfaces </li><li>  <code>ip_whitelist</code> / <code>ip_blacklist</code> - static lists.  <code>ip_blacklist</code> should not be asked here at all, but should be dynamically <code>ipset</code> into <code>ipset</code> from constantly updated databases and dynamic protection systems, but this is a separate story. <br>  Predefined sets: <br><ul><li>  <code>whitelist4</code> and <code>whitelist6</code> - IPv4 and IPv6 network whitelist </li><li>  <code>blacklist4</code> - individual IPv4 <code>blacklist4</code> addresses </li><li>  <code>blacklist4net</code> and <code>blacklist6net</code> - IPv4 and IPv6 network blacklist </li></ul></li></ul><br><p>  Since there was not enough fresh FireHOL package in Debian and Ubuntu, and since the standard ones run only AFTER the elevation of the network interfaces, I had to make my own <a href="https://launchpad.net/~andvgal/%2Barchive/ubuntu/firehol-bpo">.deb package builds</a> . </p><br><p>  <em>Note: in the description of each Puppet module from the <code>cfxxx</code> series <code>cfxxx</code> is a section "Implicitly created resources", which describes all detectable network filter resources.</em> </p><br><h1 id="zhivoy-primer">  Living example </h1><br><p>  The full deployment of the infrastructure in Vagrant, using the modules not covered in this article, can be found <a href="https://github.com/codingfuture/puppet-test">here</a> . </p><br><p>  For clarity, the network configuration and the filter of the router are given: </p><br><h3 id="nastroyki-hiera">  Hiera settings </h3><br><pre> <code class="hljs pgsql">classes: - cfnetwork #  ,     `/sbin/firehol try` #cffirehol::<span class="hljs-keyword"><span class="hljs-keyword">enable</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">true</span></span> cfnetwork::is_router: <span class="hljs-keyword"><span class="hljs-keyword">true</span></span> cfnetwork::main: device: eth1 address: <span class="hljs-string"><span class="hljs-string">'192.168.1.30/24'</span></span> extra_addresses: <span class="hljs-string"><span class="hljs-string">'192.168.1.40/24'</span></span> gateway: <span class="hljs-string"><span class="hljs-string">'192.168.1.1'</span></span> #     force_public: <span class="hljs-keyword"><span class="hljs-keyword">true</span></span> cfnetwork::ifaces: vagrant: device: eth0 <span class="hljs-keyword"><span class="hljs-keyword">method</span></span>: dhcp #     extra_routes: [<span class="hljs-string"><span class="hljs-string">'10.0.1.1/25'</span></span>] infradmz: device: eth2 address: <span class="hljs-string"><span class="hljs-string">'10.10.1.254/24'</span></span> dbdmz: device: eth3 address: <span class="hljs-string"><span class="hljs-string">'10.10.2.254/24'</span></span> webdmz: device: eth4 address: <span class="hljs-string"><span class="hljs-string">'10.10.2.254/24'</span></span> cfnetwork::describe_services: testdb: <span class="hljs-keyword"><span class="hljs-keyword">server</span></span>: <span class="hljs-string"><span class="hljs-string">'tcp/1234'</span></span> cfhttp: <span class="hljs-keyword"><span class="hljs-keyword">server</span></span>: - <span class="hljs-string"><span class="hljs-string">'tcp/80'</span></span> - <span class="hljs-string"><span class="hljs-string">'tcp/443'</span></span> # DNAT   HTTP  (     ) cfnetwork::dnat_ports: <span class="hljs-string"><span class="hljs-string">'main/webdmz:cfhttp'</span></span>: dst: <span class="hljs-string"><span class="hljs-string">'192.168.1.40'</span></span> to_dst: <span class="hljs-string"><span class="hljs-string">'10.10.2.10'</span></span> cfnetwork::router_ports: #   NTP, DNS, APT     <span class="hljs-string"><span class="hljs-string">'infradmz/main:cfhttp:apt'</span></span>: src: <span class="hljs-string"><span class="hljs-string">'maint.example.com'</span></span> <span class="hljs-string"><span class="hljs-string">'infradmz/main:ntp'</span></span>: src: <span class="hljs-string"><span class="hljs-string">'maint.example.com'</span></span> #  Puppet <span class="hljs-keyword"><span class="hljs-keyword">Server</span></span> (r10k)   <span class="hljs-string"><span class="hljs-string">'infradmz/main:cfhttp:puppet'</span></span>: {} #    DMZ     <span class="hljs-string"><span class="hljs-string">'any/infradmz:ntp'</span></span>: src: <span class="hljs-string"><span class="hljs-string">'10.10.0.0/16'</span></span> dst: <span class="hljs-string"><span class="hljs-string">'maint.example.com'</span></span> <span class="hljs-string"><span class="hljs-string">'any/infradmz:dns'</span></span>: src: <span class="hljs-string"><span class="hljs-string">'10.10.0.0/16'</span></span> dst: <span class="hljs-string"><span class="hljs-string">'maint.example.com'</span></span> <span class="hljs-string"><span class="hljs-string">'any/infradmz:aptproxy'</span></span>: src: <span class="hljs-string"><span class="hljs-string">'10.10.0.0/16'</span></span> dst: <span class="hljs-string"><span class="hljs-string">'maint.example.com'</span></span> <span class="hljs-string"><span class="hljs-string">'any/infradmz:puppet'</span></span>: src: <span class="hljs-string"><span class="hljs-string">'10.10.0.0/16'</span></span> dst: <span class="hljs-string"><span class="hljs-string">'puppet.example.com'</span></span> #        <span class="hljs-string"><span class="hljs-string">'webdmz/dbdmz:testdb'</span></span>: {}</code> </pre> <br><h3 id="sgenerirovannyy-konfig-generatora-filtra-imenno-tak-vyhodit">  generated filter generator config (this is how it comes out) </h3><br><p>  Yes, there is a small percentage of redundancy, but it is possible to optimize in future versions.  For example, it makes no sense to have two rules, one of which is a special case of the other.  In principle, the generation code is already overgrown with a multitude of "intellectual" conditions as it is implemented. </p><br><p>  <strong>This configuration takes effect automatically when <code>cffirehol::enable=true</code> !</strong> </p><br><div class="spoiler">  <b class="spoiler_title">/etc/firehol/firehol.conf</b> <div class="spoiler_text"><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># This file is autogenerated by cffirehol Puppet Module # Any changes made here may be overwritten at any time version 6 # Defaults #---------------- DEFAULT_INTERFACE_POLICY="DROP" DEFAULT_ROUTER_POLICY="DROP" FIREHOL_LOG_MODE="NFLOG" FIREHOL_TRUST_LOOPBACK="0" FIREHOL_DROP_ORPHAN_TCP_ACK_FIN="1" FIREHOL_INPUT_ACTIVATION_POLICY="DROP" FIREHOL_OUTPUT_ACTIVATION_POLICY="DROP" FIREHOL_FORWARD_ACTIVATION_POLICY="DROP" # Custom Services #---------------- server_dns_ports="tcp/53 udp/53" client_dns_ports="any" # Use to open all TCP ports (eg for local) server_alltcp_ports="tcp/1:65535" client_alltcp_ports="any" # Use to open all UDP ports (eg for local) server_alludp_ports="udp/1:65535" client_alludp_ports="any" # Use to open all TCP and UDP ports (eg for local) server_allports_ports="udp/1:65535 tcp/1:65535" client_allports_ports="any" server_cfhttp_ports="tcp/80 tcp/443" client_cfhttp_ports="default" server_testdb_ports="tcp/1234" client_testdb_ports="default" server_cfssh_ports="tcp/22" client_cfssh_ports="default" server_smtp_ports="tcp/25" client_smtp_ports="default" server_cfsmtp_ports="tcp/25 tcp/465 tcp/587" client_cfsmtp_ports="default" server_puppet_ports="tcp/8140" client_puppet_ports="default" # Setup of ipsets #---------------- ipset4 create whitelist4 hash:net ipset6 create whitelist6 hash:net ipset4 create blacklist4 hash:ip ipset4 create blacklist4net hash:net ipset6 create blacklist6net hash:net # </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">note:</span></span></span><span class="hljs-comment"> hardcoded list is not expected to be large ipset4 add whitelist4 "10.0.0.0/8" # Protection on public-facing interfaces #---------------- # main blacklist4 input inface "eth1" ipset:blacklist4net ipset:blacklist4 except src ipset:whitelist4 blacklist6 input inface "eth1" ipset:blacklist6net ipset:blacklist6 except src ipset:whitelist6 iptables -t raw -N cfunroute_main iptables -t raw -A cfunroute_main -s "10.0.0.0/8,172.16.0.0/12,224.0.0.0/4,127.0.0.1/8" -j DROP iptables -t raw -A cfunroute_main -d "10.0.0.0/8,172.16.0.0/12,224.0.0.0/4,127.0.0.1/8" -j DROP iptables -t raw -A PREROUTING -i "eth1" -j cfunroute_main # cfauth: synproxy4 input inface main dst "192.168.1.30/24" dport "22" src "192.168.0.0/16" accept synproxy4 forward inface main dst "192.168.1.40" dport "80" dnat to "10.10.2.10" synproxy4 forward inface main dst "192.168.1.40" dport "443" dnat to "10.10.2.10" iptables -t nat -N cfpost_snat_main iptables -t nat -A cfpost_snat_main -s 192.168.1.30,192.168.1.40 -j RETURN iptables -t nat -A cfpost_snat_main -j SNAT --to-source=192.168.1.30 iptables -t nat -A POSTROUTING -o "eth1" -j cfpost_snat_main # vagrant blacklist4 input inface "eth0" ipset:blacklist4net ipset:blacklist4 except src ipset:whitelist4 blacklist6 input inface "eth0" ipset:blacklist6net ipset:blacklist6 except src ipset:whitelist6 # cfauth: iptables -t nat -A POSTROUTING -o "eth0" -j MASQUERADE # Custom Headers #---------------- # NAT #---------------- dnat4 to "10.10.2.10" inface "eth1" proto "tcp" dport "80" dst "192.168.1.40" dnat4 to "10.10.2.10" inface "eth1" proto "tcp" dport "443" dst "192.168.1.40" # Interfaces #---------------- interface "eth1" "main" policy deny protection bad-packets client icmp accept server4 ping accept with hashlimit ping upto 1/s burst 2 # cfauth: server4 "cfssh" accept src "192.168.0.0/16" # cfsystem: client "http" accept uid "root" # cfsystem: client "https" accept uid "root" # cfsystem: client "ntp" accept uid "root ntpd" # cfsystem: client "cfsmtp" accept uid "root Debian-exim" # cfsystem: client "puppet" accept uid "root" # cfnetwork: client "dns" accept interface "eth0" "vagrant" policy deny protection bad-packets client icmp accept server4 ping accept with hashlimit ping upto 1/s burst 2 # cfauth: server4 "cfssh" accept src "10.0.0.0/8 192.168.0.0/16 172.16.0.0/12" # cfsystem: client "http" accept uid "root" # cfsystem: client "https" accept uid "root" # cfsystem: client "ntp" accept uid "root ntpd" # cfsystem: client "cfsmtp" accept uid "root Debian-exim" # cfsystem: client "puppet" accept uid "root" # cfnetwork: client4 "dns" accept dst "10.10.1.10" interface "eth2" "infradmz" policy reject client icmp accept server icmp accept # cfauth: server4 "cfssh" accept src "10.0.0.0/8" # cfsystem: client "http" accept uid "root" # cfsystem: client "https" accept uid "root" # cfsystem: client "ntp" accept uid "root ntpd" # cfsystem: client "cfsmtp" accept uid "root Debian-exim" # cfsystem: client "puppet" accept uid "root" # cfnetwork: client4 "dns" accept dst "10.10.1.10" interface "eth3" "dbdmz" policy reject client icmp accept server icmp accept # cfauth: server4 "cfssh" accept src "10.0.0.0/8" # cfsystem: client "http" accept uid "root" # cfsystem: client "https" accept uid "root" # cfsystem: client "ntp" accept uid "root ntpd" # cfsystem: client "cfsmtp" accept uid "root Debian-exim" # cfsystem: client "puppet" accept uid "root" interface "eth4" "webdmz" policy reject client icmp accept server icmp accept # cfauth: server4 "cfssh" accept src "10.0.0.0/8" # cfsystem: client "http" accept uid "root" # cfsystem: client "https" accept uid "root" # cfsystem: client "ntp" accept uid "root ntpd" # cfsystem: client "cfsmtp" accept uid "root Debian-exim" # cfsystem: client "puppet" accept uid "root" interface "lo" "local" policy reject client icmp accept server icmp accept # cfauth: server4 "cfssh" accept src "10.0.0.0/8 192.168.0.0/16" # cfsystem: client "http" accept uid "root" # cfsystem: client "https" accept uid "root" # cfsystem: client "ntp" accept uid "root ntpd" # cfsystem: server "smtp" accept # cfsystem: client "smtp" accept # cfsystem: client "cfsmtp" accept uid "root Debian-exim" # cfsystem: client "puppet" accept uid "root" # Routers #---------------- router "main_infradmz" inface "eth1" outface "eth2" policy drop client icmp accept # apt: client4 "cfhttp" accept src "10.10.1.10" client4 "ntp" accept src "10.10.1.10" # puppet: client "cfhttp" accept router "main_webdmz" inface "eth1" outface "eth4" policy drop client icmp accept server4 "cfhttp" accept dst "10.10.2.10" router "vagrant_infradmz" inface "eth0" outface "eth2" policy drop client icmp accept server4 "ntp" accept dst "10.10.1.10" src "10.10.0.0/8" server4 "dns" accept dst "10.10.1.10" src "10.10.0.0/8" server4 "aptproxy" accept dst "10.10.1.10" src "10.10.0.0/8" server4 "puppet" accept dst "10.10.1.11" src "10.10.0.0/8" router "infradmz_infradmz" inface "eth2" outface "eth2" policy reject server icmp accept client icmp accept server4 "ntp" accept dst "10.10.1.10" src "10.10.0.0/8" server4 "dns" accept dst "10.10.1.10" src "10.10.0.0/8" server4 "aptproxy" accept dst "10.10.1.10" src "10.10.0.0/8" server4 "puppet" accept dst "10.10.1.11" src "10.10.0.0/8" router "dbdmz_infradmz" inface "eth3" outface "eth2" policy reject server icmp accept client icmp accept server4 "ntp" accept dst "10.10.1.10" src "10.10.0.0/8" server4 "dns" accept dst "10.10.1.10" src "10.10.0.0/8" server4 "aptproxy" accept dst "10.10.1.10" src "10.10.0.0/8" server4 "puppet" accept dst "10.10.1.11" src "10.10.0.0/8" router "webdmz_infradmz" inface "eth4" outface "eth2" policy reject server icmp accept client icmp accept server4 "ntp" accept dst "10.10.1.10" src "10.10.0.0/8" server4 "dns" accept dst "10.10.1.10" src "10.10.0.0/8" server4 "aptproxy" accept dst "10.10.1.10" src "10.10.0.0/8" server4 "puppet" accept dst "10.10.1.11" src "10.10.0.0/8" router "webdmz_dbdmz" inface "eth4" outface "eth3" policy reject server icmp accept client icmp accept server "testdb" accept</span></span></code> </pre> </div></div><br><h3 id="konfiguraciya-seti">  network configuration </h3><br><p>  The module itself will not attempt to change the network settings on the fly - this will need to be done with pens or restarts. </p><br><div class="spoiler">  <b class="spoiler_title">/etc/network/interfaces.d/*</b> <div class="spoiler_text"><pre> <code class="hljs pgsql"># # <span class="hljs-keyword"><span class="hljs-keyword">Generated</span></span> <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> cfnetwork::iface puppet module # auto lo iface lo <span class="hljs-type"><span class="hljs-type">inet</span></span> loopback source /etc/network/interfaces.d<span class="hljs-comment"><span class="hljs-comment">/* # # Generated by cfnetwork::iface puppet module # auto eth3 iface eth3 inet static address 10.10.2.254 netmask 24 up sysctl --ignore net.ipv6.conf.eth3.disable_ipv6=1 # # Generated by cfnetwork::iface puppet module # auto eth2 iface eth2 inet static address 10.10.1.254 netmask 24 up sysctl --ignore net.ipv6.conf.eth2.disable_ipv6=1 # # Generated by cfnetwork::iface puppet module # auto eth1 iface eth1 inet static address 192.168.1.30 netmask 24 gateway 192.168.1.1 dns-nameservers 10.10.1.10 dns-search example.com up ip addr add 192.168.1.40/24 dev eth1 up sysctl --ignore net.ipv6.conf.eth1.disable_ipv6=1 # # Generated by cfnetwork::iface puppet module # auto eth0 iface eth0 inet dhcp netmask 255.255.255.0 up ip route add 10.0.1.1/25 dev eth0 up sysctl --ignore net.ipv6.conf.eth0.disable_ipv6=1 # # Generated by cfnetwork::iface puppet module # auto eth4 iface eth4 inet static address 10.10.2.254 netmask 24 up sysctl --ignore net.ipv6.conf.eth4.disable_ipv6=1</span></span></code> </pre> </div></div><br><h1 id="zaklyuchenie">  Conclusion </h1><br><p>  As you can see, the configuration of the network and the filter is elementary, clean and concise, and most importantly, magic numbers are convenient for changes without a mountain. </p><br><p>  There is no long history in combat mode.  Running in runs on a pair of real servers and about a dozen virtual locks without a serious load.  Therefore, volunteers are interested in who have expanded the fleet of systems, and have not yet managed to tune out the approach to administration or are not completely satisfied. </p></div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <p>Source: <a href="https://habr.com/ru/post/277085/">https://habr.com/ru/post/277085/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../277067/index.html">Reverse engineering and slowdown "Kazakov"</a></li>
<li><a href="../277069/index.html">Neurorevolution in heads and villages</a></li>
<li><a href="../277077/index.html">Near-architecture arguments or the results of a single dispute</a></li>
<li><a href="../277079/index.html">We send messages to Telegram from C #</a></li>
<li><a href="../277081/index.html">From FineReader to data entry solutions: how the direction of DataCapture in ABBYY began</a></li>
<li><a href="../277087/index.html">Angular 1.5: Components</a></li>
<li><a href="../277089/index.html">Google refuses to flash in advertising</a></li>
<li><a href="../277091/index.html">Security Week 06: bank robbery on the stream, breaking the grid, Poseidon / Amebey / Kianokhet</a></li>
<li><a href="../277093/index.html">Working with USB devices in Android</a></li>
<li><a href="../277097/index.html">UFCS in the programming language D</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>