<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Guava, Graal and Partial Escape Analysis</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Dozens of releases happened last week - and although Graal was available before, now it has become more accessible - Congratulations, you're running #...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Guava, Graal and Partial Escape Analysis</h1><div class="post__text post__text-html js-mediator-article"><p>  <a href="https://twitter.com/mreinhold/status/976125756584615937">Dozens of releases</a> happened last week - and although <strong>Graal</strong> was available before, now it has become more accessible - <a href="https://twitter.com/shelajev/status/976177307734986753">Congratulations, you're running #Graal!</a>  - just add </p><br><p><code>-XX:+UnlockExperimentalVMOptions -XX:+UseJVMCICompiler</code> </p> <br><p>  What exactly can it give us and where can we expect improvements, and which bikes should we start cutting out? </p><br><p>  An example that I will consider is partially contrived, however, based on real events. </p><br><a name="habracut"></a><br><h2 id="guava">  Guava </h2><br><p>  Surely many people use the <strong>Preconditions</strong> class from the <strong>guava</strong> library: </p><br><p> <code>checkArgument(value &gt; 0, "Non-negative value is expected, was %s", value);</code> </p> <br><p>  And everything would be fine if such a piece did not fall on the critical path in the code - the problem is in the implicit creation of garbage. </p><br><p>  This is the body of the <code>checkArgument</code> method: </p><br><pre> <code class="java hljs"> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">checkArgument</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">( </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">boolean</span></span></span></span><span class="hljs-function"><span class="hljs-params"> expression, @Nullable String errorMessageTemplate, @Nullable Object... errorMessageArgs)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!expression) { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> IllegalArgumentException(format(errorMessageTemplate, errorMessageArgs)); } }</code> </pre> <br><p>  Let's make implicit explicit: </p><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">boolean</span></span> expression = value &gt; <span class="hljs-number"><span class="hljs-number">0</span></span>; Object[] errorMessageArgs = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Object[]{Integer.valueOf(value)}; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!expression) { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> IllegalArgumentException(format(errorMessageTemplate, errorMessageArgs)); }</code> </pre> <br><p>  Here there is a checker-dyalamma-or go: As a rule, similar checks in the production code are overtakings, and on the one hand you don‚Äôt want to pay for them with additional debris, but on the other hand you don‚Äôt want to throw out fast fail. </p><br><p>  The problem is in objects generated by autoboxing and varargs that may not be used.  Alas, faced with branching, <a href="https://www.youtube.com/watch%3Fv%3DK6c3W6vhQOA"><strong>Escape Analysis is</strong></a> no <strong>longer</strong> able to identify an object as unnecessary. </p><br><p>  How can I solve the problem? </p><br><p>  For example, by overloading the <code>checkArgument</code> method (which, in general, is done in guava <strong>&gt; = 20</strong> ): </p><br><pre> <code class="hljs java"> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">checkArgument</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">boolean</span></span></span></span><span class="hljs-function"><span class="hljs-params"> expression, @Nullable String errorMessageTemplate, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> p1)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!expression) { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> IllegalArgumentException(format(errorMessageTemplate, p1)); } }</code> </pre> <br><p>  But, what if we have not one argument, but more than two - for which there are overloaded methods in guava?  Write your crutch, or suffer from garbage?  In our code, we are confronted with a place that contains a combination of 3x int, a single line that is executed millions of times and the response time is limited. </p><br><h2 id="graal">  Graal </h2><br><p>  Java 10 and <code>-XX:+UnlockExperimentalVMOptions -XX:+UseJVMCICompiler</code> </p><br><p>  <strong>Graal</strong> bears on itself many new optimizations, in particular, <strong>Partial Escape Analysis</strong> - the essence of which, among other things, is that it is able to determine that the created objects are used only in one of the branches - and you can move the creation of these objects into it. </p><br><p>  The moment of truth - what is your evidence? </p><br><h2 id="jmh">  Jmh </h2><br><p>  <a href="https://gist.github.com/vladimirdolzhenko/938877e2cb309006464608cc20d1667c">PartialEATest</a> : </p><br><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@BenchmarkMode</span></span>(Mode.AverageTime) <span class="hljs-meta"><span class="hljs-meta">@OutputTimeUnit</span></span>(TimeUnit.NANOSECONDS) <span class="hljs-meta"><span class="hljs-meta">@Fork</span></span>(<span class="hljs-number"><span class="hljs-number">1</span></span>) <span class="hljs-meta"><span class="hljs-meta">@Warmup</span></span>(iterations = <span class="hljs-number"><span class="hljs-number">5</span></span>, time = <span class="hljs-number"><span class="hljs-number">5000</span></span>, timeUnit = TimeUnit.MILLISECONDS) <span class="hljs-meta"><span class="hljs-meta">@Measurement</span></span>(iterations = <span class="hljs-number"><span class="hljs-number">5</span></span>, time = <span class="hljs-number"><span class="hljs-number">5000</span></span>, timeUnit = TimeUnit.MILLISECONDS) <span class="hljs-meta"><span class="hljs-meta">@State</span></span>(Scope.Benchmark) <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">PartialEATest</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-meta"><span class="hljs-meta">@Param</span></span>(value = {<span class="hljs-string"><span class="hljs-string">"-1"</span></span>, <span class="hljs-string"><span class="hljs-string">"1"</span></span>}) <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> value; <span class="hljs-meta"><span class="hljs-meta">@Benchmark</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">allocate</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Blackhole bh)</span></span></span><span class="hljs-function"> </span></span>{ checkArg(bh, value &gt; <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-string"><span class="hljs-string">"expected non-negative value: %s, %s"</span></span>, value, <span class="hljs-number"><span class="hljs-number">1000</span></span>, <span class="hljs-string"><span class="hljs-string">"A"</span></span>, <span class="hljs-number"><span class="hljs-number">700</span></span>); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">checkArg</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Blackhole bh, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">boolean</span></span></span></span><span class="hljs-function"><span class="hljs-params"> cond, String msg, Object ... args)</span></span></span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!cond){ bh.consume(String.format(msg, args)); } } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">main</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(String[] args)</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">throws</span></span></span><span class="hljs-function"> RunnerException </span></span>{ Options opt = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> OptionsBuilder() .include(PartialEATest.class.getSimpleName()) .addProfiler(GCProfiler.class) .build(); <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Runner(opt).run(); } }</code> </pre> <br><p>  Of all the numbers, we are interested in allocations - this is why <strong>GCProfiler is</strong> included: </p><br><table><thead><tr><th>  Options </th><th>  Benchmark </th><th>  (value) </th><th>  Score </th><th>  Error </th><th>  Units </th></tr></thead><tbody><tr><td>  -Graal </td><td>  PartialEATest.allocate: ¬∑ gc.alloc.rate.norm </td><td>  -one </td><td>  1008,000 </td><td>  ¬± 0,001 </td><td>  B / op </td></tr><tr><td>  -Graal </td><td>  PartialEATest.allocate: ¬∑ gc.alloc.rate.norm </td><td>  one </td><td>  32,000 </td><td>  ¬± 0,001 </td><td>  B / op </td></tr><tr><td>  + Graal </td><td>  PartialEATest.allocate: ¬∑ gc.alloc.rate.norm </td><td>  -one </td><td>  1024,220 </td><td>  ¬± 0,908 </td><td>  B / op </td></tr><tr><td>  + Graal </td><td>  PartialEATest.allocate: ¬∑ gc.alloc.rate.norm </td><td>  one </td><td>  ‚âà 10‚Åª‚Å¥ </td><td></td><td>  B / op </td></tr></tbody></table><br><p>  Which quite clearly demonstrates that <strong>Graal</strong> does not create objects unnecessarily - and it's time to cut <em>optimization</em> crutches. </p><br><p>  <strong>Added</strong> : </p><br><p>  <a href="https://habrahabr.ru/users/olegchir/" class="user_link">olegchir</a> reasonably noted: it would be good to see what exactly the code is compiled? </p><br><h2 id="compiled-method">  Compiled method </h2><br><p>  Let's see what kind of assembler code is obtained as a result of compiling the good old <strong>C2</strong> and <strong>Graal</strong> - for this we need <strong>hsdis</strong> - download it or <strong>compile it</strong> <a href="http://dolzhenko.blogspot.com/2018/03/build-hsdis-with-java-10-on-macosx.html">yourself</a> , add parameters to the launch: </p><br><pre> <code class="hljs swift">-<span class="hljs-type"><span class="hljs-type">XX</span></span>:+<span class="hljs-type"><span class="hljs-type">UnlockDiagnosticVMOptions</span></span> -<span class="hljs-type"><span class="hljs-type">XX</span></span>:<span class="hljs-type"><span class="hljs-type">PrintAssemblyOptions</span></span>=intel -<span class="hljs-type"><span class="hljs-type">XX</span></span>:<span class="hljs-type"><span class="hljs-type">CompileCommand</span></span>=<span class="hljs-built_in"><span class="hljs-built_in">print</span></span>,<span class="hljs-string"><span class="hljs-string">"com/elastic/PartialEATest.*"</span></span></code> </pre> <br><h3 id="compiled-method--c2">  Compiled method :: C2 </h3><br><p>  There is a lot of <a href="https://gist.github.com/vladimirdolzhenko/4c17b4476bbb9c98cdd51f2c6ae1572e">code</a> - <a href="https://gist.github.com/vladimirdolzhenko/4c17b4476bbb9c98cdd51f2c6ae1572e">all compiled code</a> is before the first <em>autoboxing</em> : </p><br><pre> <code class="hljs kotlin">ImmutableOopMap{rbx=Oop }pc offsets: <span class="hljs-number"><span class="hljs-number">1684</span></span> <span class="hljs-number"><span class="hljs-number">1697</span></span> Compiled method (c2) <span class="hljs-number"><span class="hljs-number">619</span></span> <span class="hljs-number"><span class="hljs-number">736</span></span> <span class="hljs-number"><span class="hljs-number">4</span></span> com.elastic.PartialEATest::allocate (<span class="hljs-number"><span class="hljs-number">55</span></span> bytes) total <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> heap [<span class="hljs-number"><span class="hljs-number">0x00000001189a0c90</span></span>,<span class="hljs-number"><span class="hljs-number">0x00000001189a1410</span></span>] = <span class="hljs-number"><span class="hljs-number">1920</span></span> relocation [<span class="hljs-number"><span class="hljs-number">0x00000001189a0e08</span></span>,<span class="hljs-number"><span class="hljs-number">0x00000001189a0e38</span></span>] = <span class="hljs-number"><span class="hljs-number">48</span></span> main code [<span class="hljs-number"><span class="hljs-number">0x00000001189a0e40</span></span>,<span class="hljs-number"><span class="hljs-number">0x00000001189a1060</span></span>] = <span class="hljs-number"><span class="hljs-number">544</span></span> stub code [<span class="hljs-number"><span class="hljs-number">0x00000001189a1060</span></span>,<span class="hljs-number"><span class="hljs-number">0x00000001189a1078</span></span>] = <span class="hljs-number"><span class="hljs-number">24</span></span> oops [<span class="hljs-number"><span class="hljs-number">0x00000001189a1078</span></span>,<span class="hljs-number"><span class="hljs-number">0x00000001189a10a0</span></span>] = <span class="hljs-number"><span class="hljs-number">40</span></span> metadata [<span class="hljs-number"><span class="hljs-number">0x00000001189a10a0</span></span>,<span class="hljs-number"><span class="hljs-number">0x00000001189a10b0</span></span>] = <span class="hljs-number"><span class="hljs-number">16</span></span> scopes <span class="hljs-keyword"><span class="hljs-keyword">data</span></span> [<span class="hljs-number"><span class="hljs-number">0x00000001189a10b0</span></span>,<span class="hljs-number"><span class="hljs-number">0x00000001189a1210</span></span>] = <span class="hljs-number"><span class="hljs-number">352</span></span> scopes pcs [<span class="hljs-number"><span class="hljs-number">0x00000001189a1210</span></span>,<span class="hljs-number"><span class="hljs-number">0x00000001189a13c0</span></span>] = <span class="hljs-number"><span class="hljs-number">432</span></span> dependencies [<span class="hljs-number"><span class="hljs-number">0x00000001189a13c0</span></span>,<span class="hljs-number"><span class="hljs-number">0x00000001189a13c8</span></span>] = <span class="hljs-number"><span class="hljs-number">8</span></span> handler table [<span class="hljs-number"><span class="hljs-number">0x00000001189a13c8</span></span>,<span class="hljs-number"><span class="hljs-number">0x00000001189a1410</span></span>] = <span class="hljs-number"><span class="hljs-number">72</span></span> ---------------------------------------------------------------------- com/elastic/PartialEATest.allocate(Lorg/openjdk/jmh/infra/Blackhole;)V [<span class="hljs-number"><span class="hljs-number">0x00000001189a0e40</span></span>, <span class="hljs-number"><span class="hljs-number">0x00000001189a1078</span></span>] <span class="hljs-number"><span class="hljs-number">568</span></span> bytes [Entry Point] [Constants] # {method} {<span class="hljs-number"><span class="hljs-number">0x000000022ea937b8</span></span>} <span class="hljs-string"><span class="hljs-string">'allocate'</span></span> <span class="hljs-string"><span class="hljs-string">'(Lorg/openjdk/jmh/infra/Blackhole;)V'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> <span class="hljs-string"><span class="hljs-string">'com/elastic/PartialEATest'</span></span> # <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>: rsi:rsi = <span class="hljs-string"><span class="hljs-string">'com/elastic/PartialEATest'</span></span> # parm0: rdx:rdx = <span class="hljs-string"><span class="hljs-string">'org/openjdk/jmh/infra/Blackhole'</span></span> # [sp+<span class="hljs-number"><span class="hljs-number">0x30</span></span>] (sp of caller) <span class="hljs-number"><span class="hljs-number">0x00000001189a0e40</span></span>: cmp rax,QWORD PTR [rsi+<span class="hljs-number"><span class="hljs-number">0x8</span></span>] <span class="hljs-number"><span class="hljs-number">0x00000001189a0e44</span></span>: jne <span class="hljs-number"><span class="hljs-number">0x0000000110eb7580</span></span> ; {runtime_call ic_miss_stub} <span class="hljs-number"><span class="hljs-number">0x00000001189a0e4a</span></span>: xchg ax,ax <span class="hljs-number"><span class="hljs-number">0x00000001189a0e4c</span></span>: nop DWORD PTR [rax+<span class="hljs-number"><span class="hljs-number">0x0</span></span>] [Verified Entry Point] <span class="hljs-number"><span class="hljs-number">0x00000001189a0e50</span></span>: mov DWORD PTR [rsp-<span class="hljs-number"><span class="hljs-number">0x14000</span></span>],eax <span class="hljs-number"><span class="hljs-number">0x00000001189a0e57</span></span>: push rbp <span class="hljs-number"><span class="hljs-number">0x00000001189a0e58</span></span>: sub rsp,<span class="hljs-number"><span class="hljs-number">0x20</span></span> ;*synchronization entry ; - com.elastic.PartialEATest::<span class="hljs-symbol"><span class="hljs-symbol">allocate@</span></span>-<span class="hljs-number"><span class="hljs-number">1</span></span> (line <span class="hljs-number"><span class="hljs-number">26</span></span>) <span class="hljs-number"><span class="hljs-number">0x00000001189a0e5c</span></span>: mov r11d,DWORD PTR [rsi+<span class="hljs-number"><span class="hljs-number">0x10</span></span>] ;*getfield value {reexecute=<span class="hljs-number"><span class="hljs-number">0</span></span> rethrow=<span class="hljs-number"><span class="hljs-number">0</span></span> return_oop=<span class="hljs-number"><span class="hljs-number">0</span></span>} ; - com.elastic.PartialEATest::<span class="hljs-symbol"><span class="hljs-symbol">allocate@</span></span><span class="hljs-number"><span class="hljs-number">1</span></span> (line <span class="hljs-number"><span class="hljs-number">26</span></span>) <span class="hljs-number"><span class="hljs-number">0x00000001189a0e60</span></span>: mov DWORD PTR [rsp],r11d <span class="hljs-number"><span class="hljs-number">0x00000001189a0e64</span></span>: test r11d,r11d <span class="hljs-number"><span class="hljs-number">0x00000001189a0e67</span></span>: jle <span class="hljs-number"><span class="hljs-number">0x00000001189a0ffc</span></span> ;*ifle {reexecute=<span class="hljs-number"><span class="hljs-number">0</span></span> rethrow=<span class="hljs-number"><span class="hljs-number">0</span></span> return_oop=<span class="hljs-number"><span class="hljs-number">0</span></span>} ; - com.elastic.PartialEATest::<span class="hljs-symbol"><span class="hljs-symbol">allocate@</span></span><span class="hljs-number"><span class="hljs-number">4</span></span> (line <span class="hljs-number"><span class="hljs-number">26</span></span>) <span class="hljs-number"><span class="hljs-number">0x00000001189a0e6d</span></span>: cmp r11d,<span class="hljs-number"><span class="hljs-number">0xffffff80</span></span> <span class="hljs-number"><span class="hljs-number">0x00000001189a0e71</span></span>: jl <span class="hljs-number"><span class="hljs-number">0x00000001189a100e</span></span> ;*if_icmplt {reexecute=<span class="hljs-number"><span class="hljs-number">0</span></span> rethrow=<span class="hljs-number"><span class="hljs-number">0</span></span> return_oop=<span class="hljs-number"><span class="hljs-number">0</span></span>} ; - java.lang.Integer::<span class="hljs-symbol"><span class="hljs-symbol">valueOf@</span></span><span class="hljs-number"><span class="hljs-number">3</span></span> (line <span class="hljs-number"><span class="hljs-number">1048</span></span>) ; - com.elastic.PartialEATest::<span class="hljs-symbol"><span class="hljs-symbol">allocate@</span></span><span class="hljs-number"><span class="hljs-number">24</span></span> (line <span class="hljs-number"><span class="hljs-number">26</span></span>) <span class="hljs-number"><span class="hljs-number">0x00000001189a0e77</span></span>: cmp r11d,<span class="hljs-number"><span class="hljs-number">0x7f</span></span> <span class="hljs-number"><span class="hljs-number">0x00000001189a0e7b</span></span>: jg <span class="hljs-number"><span class="hljs-number">0x00000001189a0ea9</span></span> ;*if_icmpgt {reexecute=<span class="hljs-number"><span class="hljs-number">0</span></span> rethrow=<span class="hljs-number"><span class="hljs-number">0</span></span> return_oop=<span class="hljs-number"><span class="hljs-number">0</span></span>} ; - java.lang.Integer::<span class="hljs-symbol"><span class="hljs-symbol">valueOf@</span></span><span class="hljs-number"><span class="hljs-number">10</span></span> (line <span class="hljs-number"><span class="hljs-number">1048</span></span>) ; - com.elastic.PartialEATest::<span class="hljs-symbol"><span class="hljs-symbol">allocate@</span></span><span class="hljs-number"><span class="hljs-number">24</span></span> (line <span class="hljs-number"><span class="hljs-number">26</span></span>) <span class="hljs-number"><span class="hljs-number">0x00000001189a0e7d</span></span>: mov ebp,r11d <span class="hljs-number"><span class="hljs-number">0x00000001189a0e80</span></span>: add ebp,<span class="hljs-number"><span class="hljs-number">0x80</span></span> ;*iadd {reexecute=<span class="hljs-number"><span class="hljs-number">0</span></span> rethrow=<span class="hljs-number"><span class="hljs-number">0</span></span> return_oop=<span class="hljs-number"><span class="hljs-number">0</span></span>} ; - java.lang.Integer::<span class="hljs-symbol"><span class="hljs-symbol">valueOf@</span></span><span class="hljs-number"><span class="hljs-number">20</span></span> (line <span class="hljs-number"><span class="hljs-number">1049</span></span>) ; - com.elastic.PartialEATest::<span class="hljs-symbol"><span class="hljs-symbol">allocate@</span></span><span class="hljs-number"><span class="hljs-number">24</span></span> (line <span class="hljs-number"><span class="hljs-number">26</span></span>) <span class="hljs-number"><span class="hljs-number">0x00000001189a0e86</span></span>: cmp ebp,<span class="hljs-number"><span class="hljs-number">0x100</span></span> <span class="hljs-number"><span class="hljs-number">0x00000001189a0e8c</span></span>: jae <span class="hljs-number"><span class="hljs-number">0x00000001189a101e</span></span> <span class="hljs-number"><span class="hljs-number">0x00000001189a0e92</span></span>: movsxd r10,r11d <span class="hljs-number"><span class="hljs-number">0x00000001189a0e95</span></span>: movabs r11,<span class="hljs-number"><span class="hljs-number">0x12ed02000</span></span> ; {oop(a <span class="hljs-string"><span class="hljs-string">'java/lang/Integer'</span></span>[<span class="hljs-number"><span class="hljs-number">256</span></span>] {<span class="hljs-number"><span class="hljs-number">0x000000012ed02000</span></span>})} <span class="hljs-number"><span class="hljs-number">0x00000001189a0e9f</span></span>: mov rbp,QWORD PTR [r11+r10*<span class="hljs-number"><span class="hljs-number">8</span></span>+<span class="hljs-number"><span class="hljs-number">0x418</span></span>] ;*aaload {reexecute=<span class="hljs-number"><span class="hljs-number">0</span></span> rethrow=<span class="hljs-number"><span class="hljs-number">0</span></span> return_oop=<span class="hljs-number"><span class="hljs-number">0</span></span>} ; - java.lang.Integer::<span class="hljs-symbol"><span class="hljs-symbol">valueOf@</span></span><span class="hljs-number"><span class="hljs-number">21</span></span> (line <span class="hljs-number"><span class="hljs-number">1049</span></span>) ; - com.elastic.PartialEATest::<span class="hljs-symbol"><span class="hljs-symbol">allocate@</span></span><span class="hljs-number"><span class="hljs-number">24</span></span> (line <span class="hljs-number"><span class="hljs-number">26</span></span>) ................</code> </pre> <br><p>  <a href="https://gist.github.com/vladimirdolzhenko/4c17b4476bbb9c98cdd51f2c6ae1572e">all compiled C2 code</a> </p><br><h3 id="compiled-method--graal">  Compiled method :: Graal </h3><br><pre> <code class="hljs kotlin">ImmutableOopMap{rbx=Oop }pc offsets: <span class="hljs-number"><span class="hljs-number">251</span></span> <span class="hljs-number"><span class="hljs-number">264</span></span> Compiled method (JVMCI) <span class="hljs-number"><span class="hljs-number">1850</span></span> <span class="hljs-number"><span class="hljs-number">3888</span></span> <span class="hljs-number"><span class="hljs-number">4</span></span> com.elastic.PartialEATest::allocate (<span class="hljs-number"><span class="hljs-number">55</span></span> bytes) total <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> heap [<span class="hljs-number"><span class="hljs-number">0x0000000119292590</span></span>,<span class="hljs-number"><span class="hljs-number">0x0000000119292830</span></span>] = <span class="hljs-number"><span class="hljs-number">672</span></span> relocation [<span class="hljs-number"><span class="hljs-number">0x0000000119292708</span></span>,<span class="hljs-number"><span class="hljs-number">0x0000000119292718</span></span>] = <span class="hljs-number"><span class="hljs-number">16</span></span> main code [<span class="hljs-number"><span class="hljs-number">0x0000000119292720</span></span>,<span class="hljs-number"><span class="hljs-number">0x0000000119292795</span></span>] = <span class="hljs-number"><span class="hljs-number">117</span></span> stub code [<span class="hljs-number"><span class="hljs-number">0x0000000119292795</span></span>,<span class="hljs-number"><span class="hljs-number">0x0000000119292798</span></span>] = <span class="hljs-number"><span class="hljs-number">3</span></span> oops [<span class="hljs-number"><span class="hljs-number">0x0000000119292798</span></span>,<span class="hljs-number"><span class="hljs-number">0x00000001192927a0</span></span>] = <span class="hljs-number"><span class="hljs-number">8</span></span> metadata [<span class="hljs-number"><span class="hljs-number">0x00000001192927a0</span></span>,<span class="hljs-number"><span class="hljs-number">0x00000001192927a8</span></span>] = <span class="hljs-number"><span class="hljs-number">8</span></span> scopes <span class="hljs-keyword"><span class="hljs-keyword">data</span></span> [<span class="hljs-number"><span class="hljs-number">0x00000001192927a8</span></span>,<span class="hljs-number"><span class="hljs-number">0x00000001192927c8</span></span>] = <span class="hljs-number"><span class="hljs-number">32</span></span> scopes pcs [<span class="hljs-number"><span class="hljs-number">0x00000001192927c8</span></span>,<span class="hljs-number"><span class="hljs-number">0x0000000119292828</span></span>] = <span class="hljs-number"><span class="hljs-number">96</span></span> dependencies [<span class="hljs-number"><span class="hljs-number">0x0000000119292828</span></span>,<span class="hljs-number"><span class="hljs-number">0x0000000119292830</span></span>] = <span class="hljs-number"><span class="hljs-number">8</span></span> ---------------------------------------------------------------------- com/elastic/PartialEATest.allocate(Lorg/openjdk/jmh/infra/Blackhole;)V (com.elastic.PartialEATest.allocate(Blackhole)) [<span class="hljs-number"><span class="hljs-number">0x0000000119292720</span></span>, <span class="hljs-number"><span class="hljs-number">0x0000000119292798</span></span>] <span class="hljs-number"><span class="hljs-number">120</span></span> bytes [Entry Point] [Constants] # {method} {<span class="hljs-number"><span class="hljs-number">0x0000000231e007b8</span></span>} <span class="hljs-string"><span class="hljs-string">'allocate'</span></span> <span class="hljs-string"><span class="hljs-string">'(Lorg/openjdk/jmh/infra/Blackhole;)V'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> <span class="hljs-string"><span class="hljs-string">'com/elastic/PartialEATest'</span></span> # <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>: rsi:rsi = <span class="hljs-string"><span class="hljs-string">'com/elastic/PartialEATest'</span></span> # parm0: rdx:rdx = <span class="hljs-string"><span class="hljs-string">'org/openjdk/jmh/infra/Blackhole'</span></span> # [sp+<span class="hljs-number"><span class="hljs-number">0x20</span></span>] (sp of caller) <span class="hljs-number"><span class="hljs-number">0x0000000119292720</span></span>: cmp rax,QWORD PTR [rsi+<span class="hljs-number"><span class="hljs-number">0x8</span></span>] <span class="hljs-number"><span class="hljs-number">0x0000000119292724</span></span>: jne <span class="hljs-number"><span class="hljs-number">0x000000010eadc300</span></span> ; {runtime_call ic_miss_stub} <span class="hljs-number"><span class="hljs-number">0x000000011929272a</span></span>: nop <span class="hljs-number"><span class="hljs-number">0x000000011929272b</span></span>: data16 data16 nop WORD PTR [rax+rax*<span class="hljs-number"><span class="hljs-number">1</span></span>+<span class="hljs-number"><span class="hljs-number">0x0</span></span>] <span class="hljs-number"><span class="hljs-number">0x0000000119292736</span></span>: data16 nop WORD PTR [rax+rax*<span class="hljs-number"><span class="hljs-number">1</span></span>+<span class="hljs-number"><span class="hljs-number">0x0</span></span>] [Verified Entry Point] <span class="hljs-number"><span class="hljs-number">0x0000000119292740</span></span>: mov DWORD PTR [rsp-<span class="hljs-number"><span class="hljs-number">0x14000</span></span>],eax <span class="hljs-number"><span class="hljs-number">0x0000000119292747</span></span>: sub rsp,<span class="hljs-number"><span class="hljs-number">0x18</span></span> <span class="hljs-number"><span class="hljs-number">0x000000011929274b</span></span>: mov QWORD PTR [rsp+<span class="hljs-number"><span class="hljs-number">0x10</span></span>],rbp <span class="hljs-number"><span class="hljs-number">0x0000000119292750</span></span>: cmp DWORD PTR [rsi+<span class="hljs-number"><span class="hljs-number">0x10</span></span>],<span class="hljs-number"><span class="hljs-number">0x1</span></span> <span class="hljs-number"><span class="hljs-number">0x0000000119292754</span></span>: jl <span class="hljs-number"><span class="hljs-number">0x000000011929276d</span></span> ;*ifle {reexecute=<span class="hljs-number"><span class="hljs-number">0</span></span> rethrow=<span class="hljs-number"><span class="hljs-number">0</span></span> return_oop=<span class="hljs-number"><span class="hljs-number">0</span></span>} ; - com.elastic.PartialEATest::<span class="hljs-symbol"><span class="hljs-symbol">allocate@</span></span><span class="hljs-number"><span class="hljs-number">4</span></span> (line <span class="hljs-number"><span class="hljs-number">26</span></span>) <span class="hljs-number"><span class="hljs-number">0x000000011929275a</span></span>: mov rbp,QWORD PTR [rsp+<span class="hljs-number"><span class="hljs-number">0x10</span></span>] <span class="hljs-number"><span class="hljs-number">0x000000011929275f</span></span>: add rsp,<span class="hljs-number"><span class="hljs-number">0x18</span></span> <span class="hljs-number"><span class="hljs-number">0x0000000119292763</span></span>: mov rcx,QWORD PTR [r15+<span class="hljs-number"><span class="hljs-number">0x70</span></span>] <span class="hljs-number"><span class="hljs-number">0x0000000119292767</span></span>: test DWORD PTR [rcx],eax ; {poll_return} <span class="hljs-number"><span class="hljs-number">0x0000000119292769</span></span>: vzeroupper <span class="hljs-number"><span class="hljs-number">0x000000011929276c</span></span>: ret ;*<span class="hljs-keyword"><span class="hljs-keyword">return</span></span> {reexecute=<span class="hljs-number"><span class="hljs-number">0</span></span> rethrow=<span class="hljs-number"><span class="hljs-number">0</span></span> return_oop=<span class="hljs-number"><span class="hljs-number">0</span></span>} ; - com.elastic.PartialEATest::<span class="hljs-symbol"><span class="hljs-symbol">allocate@</span></span><span class="hljs-number"><span class="hljs-number">54</span></span> (line <span class="hljs-number"><span class="hljs-number">27</span></span>) <span class="hljs-number"><span class="hljs-number">0x000000011929276d</span></span>: mov DWORD PTR [r15+<span class="hljs-number"><span class="hljs-number">0x314</span></span>],<span class="hljs-number"><span class="hljs-number">0xffffffed</span></span> ;*ifle {reexecute=<span class="hljs-number"><span class="hljs-number">0</span></span> rethrow=<span class="hljs-number"><span class="hljs-number">0</span></span> return_oop=<span class="hljs-number"><span class="hljs-number">0</span></span>} ; - com.elastic.PartialEATest::<span class="hljs-symbol"><span class="hljs-symbol">allocate@</span></span><span class="hljs-number"><span class="hljs-number">4</span></span> (line <span class="hljs-number"><span class="hljs-number">26</span></span>) <span class="hljs-number"><span class="hljs-number">0x0000000119292778</span></span>: mov QWORD PTR [r15+<span class="hljs-number"><span class="hljs-number">0x320</span></span>],<span class="hljs-number"><span class="hljs-number">0x0</span></span> <span class="hljs-number"><span class="hljs-number">0x0000000119292783</span></span>: call <span class="hljs-number"><span class="hljs-number">0x000000010eadd2a4</span></span> ; ImmutableOopMap{rsi=Oop } ;*aload_0 {reexecute=<span class="hljs-number"><span class="hljs-number">1</span></span> rethrow=<span class="hljs-number"><span class="hljs-number">0</span></span> return_oop=<span class="hljs-number"><span class="hljs-number">0</span></span>} ; - com.elastic.PartialEATest::<span class="hljs-symbol"><span class="hljs-symbol">allocate@</span></span><span class="hljs-number"><span class="hljs-number">0</span></span> (line <span class="hljs-number"><span class="hljs-number">26</span></span>) ; {runtime_call DeoptimizationBlob} <span class="hljs-number"><span class="hljs-number">0x0000000119292788</span></span>: nop</code> </pre> <br><p>  You can see how much the code compiled by <strong>C2 is</strong> larger than the code compiled by <strong>Graal</strong> - both autoboxing and varargs, whereas the version of <strong>Graal</strong> is essentially just a method call. </p></div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <p>Source: <a href="https://habr.com/ru/post/351996/">https://habr.com/ru/post/351996/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../351986/index.html">The digest of fresh materials from the world of the frontend for the last week ‚Ññ307 (March 19 - 25, 2018)</a></li>
<li><a href="../351988/index.html">Uninvented story about performance, reflection and java.lang.Boolean</a></li>
<li><a href="../351990/index.html">Windows Server 2019: Linux and Kubernetes support</a></li>
<li><a href="../351992/index.html">Visualization on the distribution map of votes in Moscow in the presidential elections of 2018</a></li>
<li><a href="../351994/index.html">NGINX and gRPC are real friends now</a></li>
<li><a href="../351998/index.html">The release of Krita 4.0, a free graphic editor for artists, took place.</a></li>
<li><a href="../352000/index.html">Digital events in Moscow from March 26 to April 1</a></li>
<li><a href="../352002/index.html">A manager from Amazon about layoffs in the US and programmer performance evaluation</a></li>
<li><a href="../352004/index.html">What is a digital handwritten signature (CRP)</a></li>
<li><a href="../352006/index.html">Key Application Metrics - Mobile Landmarks 2018 Report</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>