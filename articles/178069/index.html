<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Changing the coding of the git repository</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hey. Due to the specifics, Linux is used at work with KOI8-R, all commits in the git repository were implemented in a local encoding. After some time,...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Changing the coding of the git repository</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/storage2/b99/dae/de4/b99daede44fd2525e140a93aff61ac67.png" align="right" title="Git encoding">  Hey.  Due to the specifics, Linux is used at work with KOI8-R, all commits in the git repository were implemented in a local encoding.  After some time, it was decided to recode the repository in UTF-8.  In this article I want to discuss the technology of changing the encoding of an existing git repository, and at the same time correcting some of the errors made in certain commits. <br><a name="habracut"></a><br><h4>  A warning </h4><br>  <i>In fact, a new repository will be created, respectively, before carrying out the procedure, it is necessary to suspend the current development, merge all changes into the conventionally central repository, in which we will perform the recoding.</i>  <i>After checking the received repository, it will be necessary to re-clone it on all machines.</i> <br><br><h4>  Git and Encoding </h4><br>  Git operates on binary data, so it doesn‚Äôt interact with the encoding of the files, as for commit comments, it also saves them in the form we gave it to them, but for each commit, the <code>encoding</code> header is filled in, which can later be used when requesting comments.  If the <code>encoding</code> header <code>encoding</code> empty, git considers it to be UTF-8. <br><br>  To configure, there are two parameters located in the [i18n] section: 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <pre> <code class="bash hljs">[i18n] commitencoding = UTF-8 logoutputencoding = KOI8-R</code> </pre><br>  The first one just sets the contents of the encoding header for the <code>git commit</code> and <code>git commit-tree</code> commands, the second tells the <code>git log</code> , <code>git show</code> , <code>git blame</code> commands to what encoding the text should be re-encoded before outputting to the user.  If none of the parameters is specified, git assumes that <code>logoutputencoding</code> is UTF-8, however, if only the first parameter is set, git uses its value for the second one. <br><br>  Because of this, various errors can occur - for example, if in the commits the <code>encoding</code> header does not match the comment encoding, but is equal to the value of the <code>logoutputencoding</code> parameter, git decides that transcoding is not required and displays the comment text as it is, respectively, on machines with a locale encoding as the comment, the content will be displayed correctly, although all the rest will be garbage. <br><br>  In order to see the value of the comment <code>encoding</code> header, you can use the following command: <br><br><pre> <code class="bash hljs">git <span class="hljs-built_in"><span class="hljs-built_in">log</span></span> ‚Äìpretty=‚Äù%h - <span class="hljs-string"><span class="hljs-string">'%e'</span></span>: %s‚Äù</code> </pre><br>  Read more about the features of the <code>git log</code> command <a href="https://www.kernel.org/pub/software/scm/git/docs/git-log.html">here</a> . <br><br><h4>  Git filter-branch </h4><br>  So, we come to the main topic of this article.  In order to "rewrite the history" of the existing repository, use the <code>git filter-branch</code> command.  It allows you to consistently repeat all the commits made beforehand processing the files or meta data with various filters. <br><br>  This article uses three filters: <br><ul><li>  <code>--msg-filter</code> is used to rewrite the text of the commit comment; </li><li>  <code>--env-filter</code> - used if you need to change the environment in which the commit was made (author's name, email address, etc.); </li><li>  <code>--tag-name-filter</code> - used to rewrite text labels. </li></ul><br>  After each filter, a command is set that <code>git filter-branch</code> will execute before recording a commit. <br><br>  In order to go through the entire repository, you need to specify the - all parameter, separating it with additional parameters from filters, specify <code>HEAD</code> as the target and overwrite the tags according to new commits.  To do this, you need to add a <code>tag-name</code> filter with the <code>cat</code> : <br><br><pre> <code class="bash hljs">git filter-branch &lt;&gt; --tag-name-filter <span class="hljs-string"><span class="hljs-string">'cat'</span></span> -- --all HEAD</code> </pre><br>  Before changing the encoding of comments, do not forget to set the correct value of the <code>i18n.commitencoding</code> directive - it will be written in all the headers received after performing the repository operation. <br><br>  To convert a comment encoding, use the following command: <br><br><pre> <code class="bash hljs"><span class="hljs-string"><span class="hljs-string">'iconv -c -s -f KOI8-R -t UTF-8'</span></span></code> </pre><br><ul><li>  s - silent mode; </li><li>  c - skip characters that cannot be converted. </li></ul><br>  The <code>git filter-branch</code> command takes the following form: <br><br><pre> <code class="bash hljs">git filter-branch --msg-filter <span class="hljs-string"><span class="hljs-string">'iconv -c -s -f KOI8-R -t UTF-8'</span></span> \ --tag-name-filter <span class="hljs-string"><span class="hljs-string">'cat'</span></span> -- --all HEAD</code> </pre><br>  Since the operation of ‚Äúrewriting history‚Äù rather rudely interferes with the workflow, it makes sense (if you decide to make it) to try to correct the maximum number of errors.  These may be incorrectly set environmental parameters, files stored in the repository, which should not be there, an encoding or part of the data of individual files, etc. <br><br>  In particular, I discovered that the pair of commits had the wrong e-mail address of the author.  Since at that time all commits were created by me, the problem was solved simply by overwriting this parameter in all commits: <br><br><pre> <code class="bash hljs">git filter-branch --msg-filter <span class="hljs-string"><span class="hljs-string">'iconv -c -s -f KOI8-R -t UTF-8'</span></span> \ --env-filter <span class="hljs-string"><span class="hljs-string">'export GIT_AUTHOR_EMAIL="xxx@gmail.com" export GIT_COMMITTER_EMAIL="xxx@gmail.com"'</span></span> \ --tag-name-filter <span class="hljs-string"><span class="hljs-string">'cat'</span></span> -- --all HEAD</code> </pre><br>  But naturally, no one bothers to use more complex structures with different conditions, etc. <br><br>  In general, the <code>git filter-branch</code> command provides very rich functionality for modifying / fixing the git repository.  You can read about all of its features <a href="https://www.kernel.org/pub/software/scm/git/docs/git-filter-branch.html">here</a> . </div><p>Source: <a href="https://habr.com/ru/post/178069/">https://habr.com/ru/post/178069/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../178057/index.html">The 8th Forum for IT directors "I would go to heaven"</a></li>
<li><a href="../178059/index.html">The technology maturity cycle for 2013 according to Gartner</a></li>
<li><a href="../178061/index.html">Themes design. Blackjack and WeakReference</a></li>
<li><a href="../178063/index.html">Another Epson Moverio BT-100 review</a></li>
<li><a href="../178067/index.html">Git FTP example on Windows</a></li>
<li><a href="../178071/index.html">Designing your own computer. Part 1</a></li>
<li><a href="../178073/index.html">Two-factor SMS authorization in Redmine</a></li>
<li><a href="../178081/index.html">WebMarkupMin HTML Minifier - a modern HTML minimizer for the .NET platform</a></li>
<li><a href="../178083/index.html">Crashes caused by exceptions</a></li>
<li><a href="../178085/index.html">Scrum implementation notes - which will necessarily lead to iteration failure if nothing is done</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>