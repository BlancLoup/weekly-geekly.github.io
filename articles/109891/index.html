<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Microsoft Moles</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Moles is a lightweight tool from MS Research that can automatically generate stubs for interfaces and virtual methods, as well as sealed classes, non-...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Microsoft Moles</h1><div class="post__text post__text-html js-mediator-article">  <strong>Moles</strong> is a lightweight tool from MS Research that can automatically generate stubs for interfaces and virtual methods, as well as sealed classes, non-virtual and static methods (!), By generating code that you can later slip on the desired delegate called instead of a specific method .  The first type of plugs is called stubs (stubs), and the second - moles (moles).  This is the thing I used to test asynchronous operations, which I <a href="http://sergeyteplyakov.blogspot.com/2010/12/c-5.html">mentioned earlier</a> , but let's get everything in order. <br><br><h4>  Stubs </h4><br><br>  Let's look at this example.  Suppose that we understand the value of unit tests, as well as such principles as Dependency Inversion, and other insanely useful principles and patterns (maybe all other <a href="http://ru.wikipedia.org/wiki/SOLID_(%25D0%25BE%25D0%25B1%25D1%258A%25D0%25B5%25D0%25BA%25D1%2582%25D0%25BD%25D0%25BE-%25D0%25BE%25D1%2580%25D0%25B8%25D0%25B5%25D0%25BD%25D1%2582%25D0%25B8%25D1%2580%25D0%25BE%25D0%25B2%25D0%25B0%25D0%25BD%25D0%25BD%25D0%25BE%25D0%25B5_%25D0%25BF%25D1%2580%25D0%25BE%25D0%25B3%25D1%2580%25D0%25B0%25D0%25BC%25D0%25BC%25D0%25B8%25D1%2580%25D0%25BE%25D0%25B2%25D0%25B0%25D0%25BD%25D0%25B8%25D0%25B5)">SOLID</a> principles, and maybe even <a href="http://sergeyteplyakov.blogspot.com/2010/06/first-principles.html">FIRST</a> ).  And the point is not that we are fans of tests or Uncle Bob, but simply because we know that high connectivity is bad.  Therefore, we try to reduce dependencies within reasonable limits by allocating interfaces and then ‚Äúinjecting‚Äù them into the class constructors or into the methods by which these interfaces are necessary to perform their tasks. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <a name="habracut"></a><br>  So let's assume that for some abstraction in our code, we have allocated the <strong>IFoo</strong> interface and created some class that uses this interface. <br><br><blockquote><code><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="black"><font color="#0000ff">namespace</font> PlayingWithMoles <br> { <br> <font color="#008000">// ,  -   </font> <br> <font color="#0000ff">public</font> <font color="#0000ff">interface</font> IFoo <br> { <br> <font color="#0000ff">string</font> SomeMethod(); <br> } <br> <font color="#008000">// - ,    IFoo</font> <br> <font color="#0000ff">public</font> <font color="#0000ff">class</font> FooConsumer <br> { <br> <font color="#008000">// ""    </font> <br> <font color="#0000ff">public</font> FooConsumer(IFoo foo) <br> { <br> <font color="#0000ff">this</font> .foo = foo; <br> } <br> <font color="#008000">// , -      IFoo</font> <br> <font color="#0000ff">public</font> <font color="#0000ff">void</font> DoStuff() <br> { <br> <font color="#0000ff">var</font> someResults = foo.SomeMethod(); <br> <font color="#2B91AF">Console</font> .WriteLine( <font color="#A31515">"Doing stuff. IFoo.SomeMethod results: {0}"</font> , someResults); <br> } <br> <font color="#0000ff">private</font> <font color="#0000ff">readonly</font> IFoo foo; <br> } <br> }</font> <br> <br> <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></code> </blockquote> <br><br>  Now, suppose that our bright minds were visited by a no less bright idea, and not to write a unit test of the wonderful class <strong>FooConsumer</strong> , with the equally remarkable <strong>DoStuff</strong> method (it is clear that the meaning in testing such code is approximately zero, but you understood the idea) .  So, to create an instance of the <strong>FooConsumer</strong> class, <strong>you</strong> need to find an implementation of the <strong>IFoo</strong> interface, which may be in our code, but not the fact that it is suitable for unit tests, because it can be difficult (or impossible) to use it, because this class may depend on another class that depends on the third and so on.  Of course, such a trifle of our brother can not stop, and if we took up the testing, we will definitely bring the matter to the end.  Therefore, we will take and implement the interface with our hands, since the method is only one, and this will not cause any difficulties, with the result that we will get a test like this: <br><br><blockquote> <code><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="black">[TestClass()] <br> <font color="#0000ff">public</font> <font color="#0000ff">class</font> FooConsumerTest <br> { <br> <font color="#0000ff">class</font> FooTester : IFoo <br> { <br> <font color="#0000ff">public</font> <font color="#0000ff">string</font> SomeMethod() <br> { <br> <font color="#0000ff">return</font> <font color="#A31515">"Test string"</font> ; <br> } <br> } <br> [TestMethod] <br> <font color="#0000ff">public</font> <font color="#0000ff">void</font> DoStuffTest() <br> { <br> IFoo foo = <font color="#0000ff">new</font> FooTester(); <br> FooConsumer target = <font color="#0000ff">new</font> FooConsumer(foo); <br> target.DoStuff(); <br> } <br> }</font> <br> <br> <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></code> </blockquote> <br><br>  Now you can run this code and see in the Output window: <font>Doing stuff.</font>  <font>IFoo.SomeMethod results: Hello, Custom stub</font> .  Yes, it was not difficult, but we all know that the problems of real applications lie in the details and that in practice we are faced with much more complex interfaces than this and the implementation of each interface can hardly be called the most interesting in the world of work. <br><br>  So, the Moles library.  Creating stubs by this tool is as follows.  In a project with tests, just right-click on the assembly with the business logic you want to test and select ‚ÄúAdd Moles to Assembly‚Äù, after which the file ‚ÄúMyAssemblyName.moles‚Äù will be added to the project, and after compiling this project into The list of connected assemblies will display the assembly MyAssemblyName.Moles, which will contain all the generated stubs.  Then this tool will automatically track successful builds with business logic and will automatically regenerate the stubs.  The MyAssemblyName.moles file is a simple xml file in a specific format that specifies the name of the assembly for which stubs will be generated, as well as some parameters for their generation (for example, you can specify for which types of stubs, stubs or moles) and more). <br><br><br>  <font color="#546e66"><strong>NOTE</strong></font> <font color="#546e66"><br></font>  <font color="#546e66">Starting with version 0.94, the moles file scheme has changed.</font>  <font color="#546e66">Prior to this, you could cancel the automatic compilation of stubs, set Compilation = false in one of the sections of the configuration file, which caused the assembly with stubs not to be generated, but instead the generated file was directly added to the current project.</font>  <font color="#546e66">Starting from version 0.94, this possibility has disappeared, but you can still see what the generated code looks like, rummaging through the subfolders of your project.</font>  <font color="#546e66">For example, the current version of this tool saves the generated files in the following location: MyTestProject \ obj \ Debug \ Moles \ sl \ mgsl.</font> <br><br>  Let's look at a simplified version of the code generated for us by this tool: <br><br><blockquote> <code><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="black"><font color="#0000ff">namespace</font> PlayingWithMoles.Moles <br> { <br> <font color="#0000ff">public</font> <font color="#0000ff">class</font> SIFoo <br> : Microsoft.Moles.Framework.Stubs.StubBase <br> , IFoo <br> { <br> <font color="#0000ff">string</font> IFoo.SomeMethod() <br> { <br> <font color="#0000ff">var</font> sh = <font color="#0000ff">this</font> .SomeMethod; <br> <font color="#0000ff">if</font> (sh != <font color="#0000ff">null</font> ) <br> <font color="#0000ff">return</font> sh.Invoke(); <br> <font color="#0000ff">else</font> <br> { <br> <font color="#008000">//    Behavior-,     </font> <br> } <br> } <br> <font color="#008000">// Sets the stub of IFoo.SomeMethod</font> <br> <font color="#0000ff">public</font> Func&lt; <font color="#0000ff">string</font> &gt; SomeMethod; <br> } <br> }</font> <br> <br> <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></code> </blockquote> <br><br>  So, the generated class explicitly implements the source interface and contains delegates whose types correspond to the signature of the corresponding methods.  Since our method takes no parameters and returns <strong>string</strong> , the stub contains a delegate of type <strong>Func &lt;string&gt;</strong> (that is, a delegate that returns a type of <strong>string</strong> and does not accept any parameters).  Further, in the <strong>SomeMethod</strong> method, this delegate is simply called (if this delegate is <strong>null</strong> , then the <strong>StubNotImplementedException</strong> exception will be thrown by <strong>default</strong> , but this behavior can be changed).  Notice that the class name of the stub is: <strong>S</strong> InterfaceOrClassName, and it is in the OriginalNamespace <strong>.Moles namespace</strong> . <br><br>  Now let's change our initial test and use the stub generated for us: <br><blockquote> <code><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="black">[TestMethod] <br> <font color="#0000ff">public</font> <font color="#0000ff">void</font> DoStuffTestWithStubs() <br> { <br> <font color="#0000ff">var</font> fooStub = <font color="#0000ff">new</font> PlayingWithMoles.Moles.SIFoo(); <br> fooStub.SomeMethod = () =&gt; <font color="#A31515">"Hello, Stub!"</font> ; <br> <font color="#0000ff">var</font> target = <font color="#0000ff">new</font> FooConsumer(fooStub); <br> target.DoStuff(); <br> }</font> <br> <br> <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></code> </blockquote> <br><br>  Running it, we, as expected, see the following line: <font>Doing stuff.</font>  <font>IFoo.SomeMethod results: Hello, Moles Stub!</font> <br><br>  Once again, stubs are generated only for interfaces and virtual (non-sealed) methods of non-sealed classes.  And there is no magic here, since for this, heirs classes or classes that implement your interfaces are generated, and call dispatching takes place at the expense of good old virtual calls.  Yes, this thing is very interesting and allows you to save some time, but there is nothing surprising in it, unlike ... moles. <br><br><h4>  Moles </h4><br><br>  Moles are the second type of plugs, which is designed for the same purposes as stubs, but it can work with static or instance and non-virtual methods.  Let's assume that our <strong>FooConsumer</strong> class is not tied to an <strong>IFoo</strong> interface, but to a specific <strong>Foo</strong> class that does not contain virtual methods: <br><br><blockquote> <code><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="black"><font color="#0000ff">namespace</font> PlayingWithMoles <br> { <br> <font color="#008000">//   Foo,     </font> <br> <font color="#008000">// ,    IFoo</font> <br> <font color="#0000ff">public</font> <font color="#0000ff">class</font> Foo <br> { <br> <font color="#0000ff">public</font> <font color="#0000ff">string</font> SomeMethod() <br> { <br> <font color="#0000ff">return</font> <font color="#A31515">"Hello, from non-virtual method."</font> ; <br> } <br> } <br> <font color="#008000">// - ,      Foo</font> <br> <font color="#0000ff">public</font> <font color="#0000ff">class</font> FooConsumer <br> { <br> <font color="#008000">//    Foo   </font> <br> <font color="#0000ff">public</font> FooConsumer(Foo foo) <br> { <br> <font color="#0000ff">this</font> .foo = foo; <br> } <br> <font color="#008000">// , -       Foo</font> <br> <font color="#0000ff">public</font> <font color="#0000ff">void</font> DoStuff() <br> { <br> <font color="#0000ff">var</font> someResults = foo.SomeMethod(); <br> <font color="#2B91AF">Console</font> .WriteLine( <font color="#A31515">"Doing stuff. Foo.SomeMethod results: {0}"</font> , <br> someResults); <br> } <br> <br> <font color="#0000ff">private</font> <font color="#0000ff">readonly</font> Foo foo; <br> } <br> }</font> <br> <br> <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></code> </blockquote> <br><br>  It is clear that if we have the opportunity to refactor this code and highlight the <strong>IFoo</strong> interface, then this is what should be done, but sometimes it may not be advisable, and sometimes even impossible.  It often happens that we get someone else's code, which we need to unleash the coils of dependencies gradually, and tests are needed now;  Yes, and not rare cases when this code is simply impossible to change, because you do not control it;  After all, it may well be a third-party library or access to external resources, testing the availability of which is not part of your intentions. <br><br>  This is where the second type of plugs that can be generated by this tool - moles will help.  Moles are generated in a similar way and are located in the same nested namespace (OriginalNamespace <strong>.Moles</strong> ), however, they contain the prefix <strong>M</strong> instead of the prefix <strong>S</strong> , but instead of virtual methods and interfaces we can set the behavior of non-virtual static methods.  To implement this behavior, the Moles library uses the CLR Profiler, in particular, it processes the callback function <strong>ICorProfilerCallback :: JITCompilationStarted</strong> in which, instead of the original method, it is pushed by our delegate.  As a result, when calling the original method, the code fragment provided by us will be called. <br><br>  Thus, in our case, the class PlayingWithMoles will be generated.  <strong>Moles.M</strong> Foo, and let's see how you can test the good old (and most importantly useful) <strong>DoStuff</strong> method of the new version of the <strong>FooConsumer</strong> class: <br><br><blockquote> <code><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="black">[TestMethod] <br> [HostType( <font color="#A31515">"Moles"</font> )] <br> <font color="#0000ff">public</font> <font color="#0000ff">void</font> DoStuffTestWithMoles() <br> { <br> <font color="#0000ff">var</font> fooMole = <font color="#0000ff">new</font> PlayingWithMoles.Moles.MFoo(); <br> fooMole.SomeMethod = () =&gt; <font color="#A31515">"Hello, Mole!"</font> ; <br> <font color="#0000ff">var</font> target = <font color="#0000ff">new</font> FooConsumer(fooMole); <br> target.DoStuff(); <br> }</font> <br> <br> <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></code> </blockquote> <br><br>  Pay attention to the <strong>[HostType (‚ÄúMoles‚Äù)]</strong> attribute, without which all the magic of the particles will stop working, because, as mentioned earlier, code ‚Äúinstrumentation‚Äù and the CLR Profiler are used for their work.  This test is no more complicated than the previous one, in which stubs were used, and when we start we get exactly the result that we expect: <font>Doing stuff.</font>  <font>IFoo.SomeMethod results: Hello, Mole!</font> <br><br>  Now let's look at a more interesting example.  In <a href="http://sergeyteplyakov.blogspot.com/2010/10/asyncenumerator.html">several</a> <a href="http://sergeyteplyakov.blogspot.com/2010/11/blog-post.html">previous</a> <a href="http://sergeyteplyakov.blogspot.com/2010/12/c-5.html">posts</a> I looked at different ways of dancing with tambourines around asynchronous operations, and as examples I used asynchronous retrieval of the content of web pages.  But since I sometimes needed to work on a computer without access to the Internet, and every time I didn‚Äôt want to rewrite the examples, I had an idea to use this tool.  In addition, a good rule of unit testing is decoupling from external resources (such as files, network connections, database), since otherwise these tests will no longer be modular, but will be integration tests.  I do not say that integration tests are bad, no, this is good, but in modular tests we can focus on our code, while integration tests require the presence and normal operation of these external resources. <br><br>  Let's assume that we have some <strong>WebRequestor</strong> class that accesses a web page and displays the length of the response received: <br><br><blockquote> <code><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="black"><font color="#0000ff">public</font> <font color="#0000ff">class</font> WebRequester <br> { <br> <font color="#0000ff">public</font> <font color="#0000ff">void</font> RequestWebPage( <font color="#0000ff">string</font> url) <br> { <br> <font color="#0000ff">var</font> request = WebRequest.Create(url); <br> <font color="#0000ff">var</font> response = request.GetResponse(); <br> <font color="#2B91AF">Console</font> .WriteLine( <font color="#A31515">"Sync version. URL: {0}, Response content length: {1}"</font> , <br> url, response.ContentLength); <br> } <br> }</font> <br> <br> <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></code> </blockquote> <br><br>  Before we start writing tests, we need to generate moles for the <strong>WebRequest class</strong> .  To do this, in the test project it is enough to right-click on the System assembly (since this class is located in it), select the ‚ÄúAdd Moles Assembly‚Äù menu item, then recompile the project with tests, which will result in the System.Behaviors.dll assembly. , with all the necessary stubs and moles of the original System.dll assembly. <br><br>  Now let's see how we can test our code: <br><br><blockquote> <code><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="black">[TestMethod] <br> [HostType( <font color="#A31515">"Moles"</font> )] <br> <font color="#0000ff">public</font> <font color="#0000ff">void</font> RequestWebPageTest() <br> { <br> <font color="#0000ff">var</font> mole = <font color="#0000ff">new</font> System.Net.Moles.MHttpWebResponse(); <br> mole.ContentLengthGet = () =&gt; 5; <br> <font color="#008000">//         URL-.</font> <br> <font color="#008000">// , :</font> <br> <font color="#008000">//System.Net.Moles.MHttpWebRequest.AllInstances.GetResponse = (r) =&gt;</font> <br> <font color="#008000">//  {</font> <br> <font color="#008000">//    if (r.RequestUri == new Uri("http://rsdn.ru"))</font> <br> <font color="#008000">//      return mole;</font> <br> <font color="#008000">//    return r.GetResponse();</font> <br> <font color="#008000">//  };</font> <br> <font color="#008000">//     </font> <br> System.Net.Moles.MHttpWebRequest.AllInstances.GetResponse = (r) =&gt; mole; <br> WebRequester target = <font color="#0000ff">new</font> WebRequester(); <br> target.RequestWebPage( <font color="#A31515">"http://rsdn.ru"</font> ); <br> }</font> <br> <br> <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></code> </blockquote> <br><br>  In this test, first we create a stub for the <strong>HttpWebResponse</strong> class located in the System.Net <strong>.Moles namespace</strong> with the name <strong>M</strong> HttpWebRespoonse, and as a ‚Äúbody‚Äù of the <strong>ContentLength</strong> property we <strong>slip</strong> our lambda returning <strong>5</strong> .  Now we ‚Äúchange‚Äù the <strong>GetResponse</strong> method for all instances of the <strong>HttpWebRequest</strong> class by setting the <strong>GetResponse</strong> delegate.  After that, we can safely call the <strong>RequestWebPage</strong> method of the <strong>WebRequester class</strong> and get a normal result, even without access to the Internet: <font>Sync version.</font>  <font>URL:</font> <a href="http://rsdn.ru/"><font></font></a><font><a href="http://rsdn.ru/">rsdn.ru</a></font> <font>, Response content length: 5.</font> <br><br>  Now let's go to the asynchronous version of getting the content of a web page, the <strong>RequestWebPageAsync</strong> method of the <strong>WebRequester class</strong> : <br><br><blockquote> <code><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="black"><font color="#0000ff">public</font> <font color="#0000ff">void</font> RequestWebPageAsync( <font color="#0000ff">string</font> url) <br> { <br> <font color="#0000ff">var</font> waiter = <font color="#0000ff">new</font> ManualResetEvent( <font color="#0000ff">false</font> ); <br> <font color="#0000ff">var</font> request = WebRequest.Create(url); <br> request.BeginGetResponse( <br> ar=&gt; <br> { <br> <font color="#0000ff">var</font> response = request.EndGetResponse(ar); <br> <font color="#2B91AF">Console</font> .WriteLine( <font color="#A31515">"Async version. URL: {0}, Response content length: {1}"</font> , <br> url, response.ContentLength); <br> waiter.Set(); <br> }, <font color="#0000ff">null</font> ); <br> <br> waiter.WaitOne(); <br> }</font> <br> <br> <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></code> </blockquote> <br><br>  For test purposes, I don‚Äôt want the method to complete control until the asynchronous operation is complete.  In this code, we cannot use <strong>AsyncResult.AsyncWaitHandle</strong> , returned by the <strong>BeginGetResponse</strong> method, since the <strong>RequestWebPageAsync</strong> method can continue execution before calling the <strong>request.EndGetResponse</strong> method.  As a result of this, there is no point in such ‚Äúasynchronous‚Äù, but this is not important, because here I just want to show the mechanism for testing asynchronous operations and nothing more.  But I think the idea is clear. <br><br>  So now the test method: <br><br><blockquote> <code><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="black">[TestMethod] <br> [HostType( <font color="#A31515">"Moles"</font> )] <br> <font color="#0000ff">public</font> <font color="#0000ff">void</font> RequestWebPageAsyncTest() <br> { <br> <font color="#0000ff">var</font> mole = <font color="#0000ff">new</font> System.Net.Moles.MHttpWebResponse(); <br> mole.ContentLengthGet = () =&gt; 5; <br> <font color="#008000">//  ,      </font> <br> <font color="#008000">//   </font> <br> Action action = () =&gt; Thread.Sleep(500); <br> <br> <font color="#008000">//   ,    ,</font> <br> <font color="#008000">//       </font> <br> <font color="#008000">//    - (-,   </font> <br> <font color="#008000">//    ).</font> <br> ThreadPool.SetMinThreads(3, 3); <br> System.Net.Moles.MHttpWebRequest.AllInstances.BeginGetResponseAsyncCallbackObject = <br> (r, a, iar) =&gt; action.BeginInvoke(a, iar); <br> System.Net.Moles.MHttpWebRequest.AllInstances.EndGetResponseIAsyncResult = <br> (r, iar) =&gt; { action.EndInvoke(iar); <font color="#0000ff">return</font> mole; }; <br> WebRequester target = <font color="#0000ff">new</font> WebRequester(); <br> target.RequestWebPageAsync(http: <font color="#008000">//rsdn.ru);</font> <br> }</font> <br> <br> <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></code> </blockquote> <br><br>  In our test method, we again create a stub <strong>M</strong> HttpWebResponse, an instance of which will return <strong>5</strong> when accessing the <strong>ContentLength</strong> property, and use the delegate that calls <strong>Thread.Sleep (500)</strong> to simulate a long-running operation.  By running this test for execution, we get: <font>Async version.</font>  <font>URL:</font> <a href="http://rsdn.ru/"><font></font></a><font><a href="http://rsdn.ru/">rsdn.ru</a></font> <font>, Response content length: 5.</font> What was required to prove! <br><br><h4>  Instead of conclusion </h4><br><br>  The Moles library is a very interesting tool that will help you in generating simple stubs for your interfaces, and it will allow you to untie your code from external resources, static or non-virtual methods, and it is simply impossible to create stubs for which in another way.  Here I have shown far from all the functionality of this tool, but this should be enough to understand how it is applicable (or not) for your specific tasks. <br><br>  via <a href="http://sergeyteplyakov.blogspot.com/2010/12/microsoft-moles.html">Programming Stuff</a> . </div><p>Source: <a href="https://habr.com/ru/post/109891/">https://habr.com/ru/post/109891/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../109884/index.html">Web Store Restrictions Bypass</a></li>
<li><a href="../109887/index.html">Made by Us! Site about production in Russia</a></li>
<li><a href="../109888/index.html">A study of the Dutch shows that Anonymus is not so anonymous</a></li>
<li><a href="../109889/index.html">Mobile Application Development</a></li>
<li><a href="../109890/index.html">PHPLego: Do-it-yourself plugins</a></li>
<li><a href="../109892/index.html">Overview of Configuration Management Best Practices Book</a></li>
<li><a href="../109894/index.html">New version of ASP.NET MVC 3 RC2 released</a></li>
<li><a href="../109895/index.html">5th Startup Crash Test</a></li>
<li><a href="../109897/index.html">Live stream from TechCrunch Moscow has begun</a></li>
<li><a href="../109899/index.html">Integrated project management system for small and medium businesses</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>