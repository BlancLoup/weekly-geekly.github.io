<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Magento, news subscription during checkout</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Oh, it turns out that there is even a whole one post about Magento development. I also have something to say. I wonder if it will be interesting to an...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Magento, news subscription during checkout</h1><div class="post__text post__text-html js-mediator-article">  Oh, it turns out that there is even a whole one post about Magento development.  I also have something to say.  I wonder if it will be interesting to anyone ... <br><br>  So, the task is to add a tick "Receive news" to one of the checkout steps (checkout - "pass through the cashier"). <br><br><img src="http://www.fitnesspages.ca/newsletter.png"><br><a name="habracut"></a><br>  It immediately became clear that we would have to write a new module, since  modification of design files is not enough.  How you can add your field to any checkout step, you can peep from the <a href="http://www.magentocommerce.com/extension/1361/checkout-newsletter/">Desitex Checkoutnewsletter</a> modules (it adds a ‚Äúsign for news‚Äù checkbox in the second step, where you need to specify the billing address) and from <a href="http://www.magentocommerce.com/extension/1036/customer-order-comment">Biebersdorf CustomerOrderComment</a> (it adds a field to add a comment to the last step - order confirmation page). 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      I omit the process of digging into the specified modules and finding a solution :) In the end, what would have happened, we need: <br><ul><li>  Modify the design file that draws the desired checkout page - add a check mark there; </li><li>  In any way, subscribe to the event ‚Äúsave the checkout page‚Äù to: </li><li>  Remember tick status in current session </li><li>  To process the "checkout" event that occurs when the user has already placed an order, before the site redirects it to the site for payment (for example, PayPal, AlliedWallet).  Here you need to extract the saved value from the session and sign the user to the newsletter, if he wants it. </li></ul><br><h4>  Module creation </h4><br>  First of all, create a module.  Let it be in the namespace <code>Mage</code> , and be called <code>NewsletterSubscribe</code> . <br><br>  First you need to tell Magento that our module is - create the file <code>Mage_NewsletterSubscribe.xml</code> in the <code>app/etc/modules</code> folder: <br><br><pre>  &lt;? xml version = "1.0"?&gt;
 &lt;config&gt;
     &lt;modules&gt;
         &lt;Mage_NewsletterSubscribe&gt;
             &lt;active&gt; true &lt;/ active&gt;
             &lt;codePool&gt; local &lt;/ codePool&gt;
         &lt;/ Mage_NewsletterSubscribe&gt;
     &lt;/ modules&gt;
 &lt;/ config&gt; </pre><br>  According to XML, the module is active and is in the local pool. <br><br>  Next, create a folder where the new module will be located - <code>app/code/local/Mage/NewsletterSubscribe</code> , and the <code>config.xml</code> configuration file in the <code>app/code/local/Mage/NewsletterSubscribe/etc</code> folder: <br><br><pre>  &lt;? xml version = "1.0"?&gt;
 &lt;config&gt;
     &lt;global&gt;
         &lt;helpers&gt;
             &lt;newslettersubscribe&gt;
                 &lt;class&gt; Mage_NewsletterSubscribe_Helper &lt;/ class&gt;
             &lt;/ newslettersubscribe&gt;
         &lt;/ helpers&gt;
     &lt;/ global&gt;
 &lt;/ config&gt; </pre><br>  Without a helper, the module will not work as expected, but will instead fall.  Therefore, we give the Magento helper, even if it is empty, the <code>Data.php</code> file in the <code>Helper</code> folder: <br><pre>  &lt;? php

 class Mage_NewsletterSubscribe_Helper_Data extends Mage_Core_Helper_Abstract {

 } </pre><br><h4>  Modification of the checkout page </h4><br>  The file that draws the desired checkout page is <code>app\design\frontend\default\sunnyD\template\checkout\onepage\payment\methods.phtml</code> .  Add a tick: <br><br><pre>  ...
 &lt;? php / * bof Subscribe for newsletter checkbox * /?&gt;
 &lt;dt&gt; Join Our Mailing List &lt;/ dt&gt;
 &lt;dd&gt;
     &lt;input type = "checkbox" name = "NewsletterSubscribe" id = "NewsletterSubscribe" checked = "checked" /&gt;
     &lt;label for = "NewsletterSubscribe"&gt; &lt;? php echo Mage :: helper ('newslettersubscribe') -&gt; __ ('would
 &lt;/ dd&gt;
 &lt;? php / * eof Subscribe for newsletter checkbox * /?&gt;
 ... </pre><br>  Yes, now we see our check mark on the payment method selection page.  But why is it inactive?  And because it is made inactive by JS code located at the end of the file: <br><br><pre>  &lt;script type = "text / javascript"&gt; payment.init (); &lt;/ script&gt; </pre><br>  I did not understand why it is needed, but in this case it makes inactive all the &lt;input&gt; tags.  It turns out that we need to activate our checkbox after executing this code: <br><br><pre>  &lt;script type = "text / javascript"&gt; payment.init (); &lt;/ script&gt;

 &lt;script type = "text / javascript"&gt; $ ('NewsletterSubscribe'). disabled = false; &lt;/ script&gt; </pre><br>  Now the tick has become active, we go further. <br><br><h4>  Event "save page checkout" </h4><br>  I spied how it does Checkoutnewsletter.  In the module configuration file there are lines that apparently intercept actions related to the entire checkout, all its pages: <br><br><pre>  &lt;? xml version = "1.0"?&gt;
 &lt;config&gt;
     ...
     &lt;global&gt;
         &lt;models&gt;
             &lt;checkout&gt;
                 &lt;rewrite&gt;
                     &lt;type_onepage&gt; Desitex_Checkoutnewsletter_Model_Checkout_Type_Onepage &lt;/ type_onepage&gt;
                 &lt;/ rewrite&gt;
             &lt;/ checkout&gt;
     ...
 &lt;/ config&gt; </pre><br>  The standard class <code>Mage_Checkout_Model_Type_Onepage</code> is replaced by the module class <code>Desitex_Checkoutnewsletter_Model_Checkout_Type_Onepage</code> (which is inherited from the original class <code>Mage_Checkout_Model_Type_Onepage</code> ).  In this class, only one method is redefined: <br><br><pre>  &lt;? php

 class Desitex_Checkoutnewsletter_Model_Checkout_Type_Onepage extends Mage_Checkout_Model_Type_Onepage
 {
     public function saveBilling ($ data, $ customerAddressId)
     {
         if (isset ($ data ['is_subscribed']) &amp;&amp;! empty ($ data ['is_subscribed'])) {
             $ this-&gt; getCheckout () -&gt; setCustomerIsSubscribed (1);
         }
         else {
             $ this-&gt; getCheckout () -&gt; setCustomerIsSubscribed (0);
         }
         return parent :: saveBilling ($ data, $ customerAddressId);
     }
 } </pre><br>  Obviously, the <code>saveBilling</code> action occurs when the user moves from the input page to the billing address (presses the Continue button).  Here the module saves the value of its checkbox ‚Äúsubscribe to news‚Äù in the current session (or checkout ...).  After that calls the original method of the standard class. <br><br>  We will proceed in a similar way - we will make a class, inherit it from the standard one, and redefine only one method that occurs when the form is saved on our page.  The method will keep the value of our checkbox.  <code>Model/Onepage.php</code> class in the <code>Model/Onepage.php</code> file: <br><br><pre>  &lt;? php

 class Mage_NewsletterSubscribe_Model_Onepage extends Mage_Checkout_Model_Type_Onepage {
     public function savePayment ($ data) {
         if (isset ($ _ POST ['NewsletterSubscribe'])) {
             $ this-&gt; getCheckout () -&gt; setNewsletterSubscribe ((bool) $ _POST ['NewsletterSubscribe']);
         }
         else {
             $ this-&gt; getCheckout () -&gt; setNewsletterSubscribe (false);
         }
         return parent :: savePayment ($ data);
     }
 } </pre><br>  Here I was overtaken by a little stupor.  The tick value is among the form values, but I do not have access to these variables from the current place.  Those.  access to the Magento Request object, which stores all GET and POST variables.  There are various interesting objects like Quote, Checkout, etc., with different interesting data, but not form values.  I was almost desperate, thinking that rewriting the kernel code was very bad, but then I remembered that it was Php, which means that the $ _GET and $ _POST variables are available at any place :) The problem was solved. <br><br>  Now let's say Magento, that instead of the standard class, take ours.  Editing <code>etc/config.xml</code> : <br><br><pre>  &lt;? xml version = "1.0"?&gt;
 &lt;config&gt;
     &lt;global&gt;
         &lt;models&gt;
             &lt;checkout&gt;
                 &lt;rewrite&gt;
                     &lt;type_onepage&gt; Mage_NewsletterSubscribe_Model_Onepage &lt;/ type_onepage&gt;
                 &lt;/ rewrite&gt;
             &lt;/ checkout&gt;
         &lt;/ models&gt;
     ...
 &lt;/ config&gt; </pre><br>  Here is ready.  Only apparently there is one limitation - only one module can override the standard class.  My method was not called until I removed the override from the <code>Checkoutnewsletter</code> module.  Those.  This is not an ordinary event for which an arbitrary number of listeners can subscribe.  Potential difficult problems to solve in the future: ( <br><br><h4>  Event "checkout" </h4><br>  Unlike the previous ‚Äúevent,‚Äù ordering is a ‚Äúreal‚Äù <code>checkout_type_onepage_save_order</code> event.  To subscribe to it, you need to change the configuration of the module <code>etc/config.xml</code> : <br><br><pre>  &lt;? xml version = "1.0"?&gt;
 &lt;config&gt;
     &lt;global&gt;
         ...
         &lt;events&gt;
             &lt;checkout_type_onepage_save_order&gt;
                 &lt;observers&gt;
                     &lt;mage_newslettersubscribe_observer&gt;
                         &lt;type&gt; singleton &lt;/ type&gt;
                         &lt;class&gt; newslettersubscribe / observer &lt;/ class&gt;
                         &lt;method&gt; onOrderSave &lt;/ method&gt;
                     &lt;/ mage_newslettersubscribe_observer&gt;
                 &lt;/ observers&gt;
             &lt;/ checkout_type_onepage_save_order&gt;
         &lt;/ events&gt;
     &lt;/ global&gt;
 &lt;/ config&gt; </pre><br>  Here we have specified which method for which class to call ( <code>Mage_NewsletterSubscribe_Model_Observer::onOrderSave</code> ) when the user places an order.  Now create this class and method - file <code>/Model/Observer.php</code> : <br><br><pre>  &lt;? php
 class Mage_NewsletterSubscribe_Model_Observer extends Mage_Core_Helper_Abstract {
     public function onOrderSave ($ observer) {
         $ isCustomerSubscribed = (bool) Mage :: getSingleton ('checkout / session') -&gt; getNewsletterSubscribe ();
         if ($ isCustomerSubscribed) {
             $ quote = $ observer-&gt; getEvent () -&gt; getQuote ();
             $ session = Mage :: getSingleton ('core / session');
             try {
                 $ status = Mage :: getModel ('newsletter / subscriber') -&gt; subscribe ($ quote-&gt; getBillingAddress () -&gt; getEmail ());
                 if ($ status == Mage_Newsletter_Model_Subscriber :: STATUS_NOT_ACTIVE) {
                     $ session-&gt; addSuccess (Mage :: helper ('checkoutnewsletter') -&gt; __ ('Confirmation request your newsletter subscription'));
                 }
             }
             catch (Mage_Core_Exception $ e) {
                 $ session-&gt; addException ($ e, Mage :: helper ('checkoutnewsletter') -&gt; __ ('There was a problem with the newsletter subscription:% s', $ e-&gt; getMessage ()));
             }
             catch (Exception $ e) {
                 $ session-&gt; addException ($ e, Mage :: helper ('checkoutnewsletter') -&gt; __ ('There was a problem with the newsletter subscription'));
             }
         }

         return $ this;
     }
 } </pre><br>  I took this code from the Checkoutnewsletter module, only redid it to make it work.  Fortunately, Magento has a class that allows users to sign up for news.  In essence, all you need to do is call <code>Mage::getModel('newsletter/subscriber')-&gt;subscribe(&lt;user email&gt;);</code> <br><br><h4>  Total </h4><br>  The result was a small module that performs the task. </div><p>Source: <a href="https://habr.com/ru/post/70049/">https://habr.com/ru/post/70049/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../70044/index.html">Sofa evolution</a></li>
<li><a href="../70045/index.html">T-shirt novice programmer</a></li>
<li><a href="../70046/index.html">PHPUnit + Netbeans</a></li>
<li><a href="../70047/index.html">4G testing from freshtel.ua</a></li>
<li><a href="../70048/index.html">But to whom is the very first Macintosh Plus released? Fly!</a></li>
<li><a href="../70050/index.html">ViewSonic netbook</a></li>
<li><a href="../70051/index.html">Project Management: PRINCE2 - PRojects In Controlled Environments</a></li>
<li><a href="../70052/index.html">Do you minus your friends?</a></li>
<li><a href="../70053/index.html">Mozilla noticed a large number of ‚Äúcrashes‚Äù of their browser on vkontakte.ru</a></li>
<li><a href="../70054/index.html">Illusions</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>