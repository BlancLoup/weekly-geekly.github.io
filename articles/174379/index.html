<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>DCDIAG - health diagnostics AD single utility</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Author's note: The article is primarily written for novice system administrators, experienced ones are unlikely to learn something new and useful for ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>DCDIAG - health diagnostics AD single utility</h1><div class="post__text post__text-html js-mediator-article">  <i>Author's note: The article is primarily written for novice system administrators, experienced ones are unlikely to learn something new and useful for themselves.</i>  <i>Inspired by an article about <a href="http://habrahabr.ru/post/173793/">GPUPDATE / force</a> (thanks to <a href="http://habrahabr.ru/users/mrhobby/" class="user_link">mrHobbY</a> )</i> . <br><br>  Active Directory is a large and complex organism (even if it consists of two domain controllers and one site), and it is very important for the system administrator to make a diagnosis at any time to analyze the operation of this organism. <br>  Well, and since it is inefficient to use the snap-ins to go and watch, the system‚Äôs logs also do not always understand what is happening, so various utilities come to the rescue.  One of them is Microsoft's dcdiag. <br>  Let's look at it carefully - because the utility of this utility is difficult to overestimate.  I will not give the numerous keys of this command - you can read about it in help if you wish - and I‚Äôll dwell only on those - which I use myself in the diagnosis in practice. <br><br><a name="habracut"></a>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      The first thing you need to do to work with this utility is to install it on your workstation or on the server itself (everyone is free to choose himself, but in the latest versions of dcdiag, it is written that the checks need to be run on the servers themselves domain controllers, with the exception of the dcPromo and RegisterInDNS tests.  For Windows 2003, you need to install the Support Tools package from the operating system distribution kit; for Windows 7 and 8, you need to install the Remote System Administration Tools package (they are different for win7, win7sp1, and win8 - be careful when you download).  By the way, RSAT is in itself a useful product - there are many utilities inside that are simply necessary in the daily life of a domain administrator. <br>  After installing the package, the command is already available from the command line. <br>  But do not rush to run it right away; nothing will work on the workstation without specifying the domain controller to which you need to connect.  The utility will issue a warning: <br><img src="https://habrastorage.org/storage2/b7e/0da/17e/b7e0da17e6c04361a7956341f5ec96d5.jpg"><br><br>  <i>Note: Starting with Windows 7, dcdiag messages are translated into Russian.</i>  <i>Before that - everything is only in English.</i>  <i>Maybe it will be useful to someone.</i>  <i>Although the old versions are very simple and understandable English.</i> <i><br></i> <br><br>  It's great - we found out that it is desirable to specify a domain controller using the <i>/ s:</i> key or the naming context is <i>/ n:.</i>  It is clear which server to specify - the domain controller you want to check - but if you specify the domain naming context - (the domain name in other words - you can specify in Netbios, DNS or DN formats.), The nearest controller (within the site) will be found domain (further CD). <br>  Let's do the simplest check: dcdiag / s: dc01-local <br>  And again, the trouble, although something is already visible: <br><div class="spoiler">  <b class="spoiler_title">Work result</b> <div class="spoiler_text"><pre><code class="vbscript hljs">dcdiag /s:dc01-local.local      : *   AD.    .      : Local\dc01-local  : Connectivity ......................... DC01-LOCAL -   Connectivity     : Local\dc01-local  : Advertising ......................... DC01-LOCAL -   Advertising  : FrsEvent  <span class="hljs-number"><span class="hljs-number">5</span></span>   File Replication Service   \\DC01-LOCAL:File Replication Service:   . ......................... DC01-LOCAL -    FrsEvent  : DFSREvent ......................... DC01-LOCAL -   DFSREvent  : SysVolCheck ......................... DC01-LOCAL -    SysVolCheck  : KccEvent  <span class="hljs-number"><span class="hljs-number">5</span></span>   Directory Service   \\DC01-LOCAL:Directory Service:   . ......................... DC01-LOCAL -    KccEvent  : KnowsOfRoleHolders ......................... DC01-LOCAL -   KnowsOfRoleHolders  : MachineAccount ......................... DC01-LOCAL -   MachineAccount  : NCSecDesc ......................... DC01-LOCAL -   NCSecDesc  : NetLogons [DC01-LOCAL]          .  ,    ,           . ......................... DC01-LOCAL -    NetLogons  : ObjectsReplicated ......................... DC01-LOCAL -   ObjectsReplicated  : Replications [ ,DC01-LOCAL]   DsReplicaGetInfo(PENDING_OPS, <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>),  <span class="hljs-number"><span class="hljs-number">0x2105</span></span> <span class="hljs-string"><span class="hljs-string">"   ."</span></span> ......................... DC01-LOCAL -    Replications  : RidManager ......................... DC01-LOCAL -   RidManager  : Services        dc01-local.local,  <span class="hljs-number"><span class="hljs-number">0x5</span></span> <span class="hljs-string"><span class="hljs-string">"  ."</span></span> ......................... DC01-LOCAL -    Services  : SystemLog  <span class="hljs-number"><span class="hljs-number">5</span></span>   System   \\DC01-LOCAL:System:   . ......................... DC01-LOCAL -    SystemLog  : VerifyReferences ......................... DC01-LOCAL -   VerifyReferences    : Schema  : CheckSDRefDom ......................... Schema -   CheckSDRefDom  : CrossRefValidation ......................... Schema -   CrossRefValidation    : Configuration  : CheckSDRefDom ......................... Configuration -   CheckSDRefDom  : CrossRefValidation ......................... Configuration -   CrossRefValidation    : LOCAL  : CheckSDRefDom ......................... LOCAL -   CheckSDRefDom  : CrossRefValidation ......................... LOCAL -   CrossRefValidation    : LOCAL.local  : LocatorCheck ......................... LOCAL.local -   LocatorCheck  : Intersite ......................... LOCAL.local -   Intersite</code> </pre> <br></div></div><br><br>  As we can see, part of the tests passed - but parts were denied access.  This is due to the fact that I ran <b>dcdiag</b> from under a normal domain account, without administrator rights.  It is clear - that part of the checks to pass under it is simply impossible.  Therefore, in order to get the correct diagnostics, you need to run the utility with administrative privileges ‚Äî either run the command prompt as an administrator, or use the <i>/ u</i> keys <i>: domain name \ username</i> and <i>/ p: password</i> .  Let's try: <br>  <b>dcdiag / s: dc01-local / u: local \ user19 / p: Password</b> <br><div class="spoiler">  <b class="spoiler_title">Work result</b> <div class="spoiler_text"><pre> <code class="vbscript hljs">     : *   AD.    .      : Magadan\DC01-LOCAL  : Connectivity ......................... DC01-LOCAL -   Connectivity     : Magadan\DC01-LOCAL  : Advertising ......................... DC01-LOCAL -   Advertising  : FrsEvent ......................... DC01-LOCAL -   FrsEvent  : DFSREvent ......................... DC01-LOCAL -   DFSREvent  : SysVolCheck ......................... DC01-LOCAL -   SysVolCheck  : KccEvent ......................... DC01-LOCAL -   KccEvent  : KnowsOfRoleHolders ......................... DC01-LOCAL -   KnowsOfRoleHolders  : MachineAccount ......................... DC01-LOCAL -   MachineAccount  : NCSecDesc ......................... DC01-LOCAL -   NCSecDesc  : NetLogons ......................... DC01-LOCAL -   NetLogons  : ObjectsReplicated ......................... DC01-LOCAL -   ObjectsReplicated  : Replications ......................... DC01-LOCAL -   Replications  : RidManager ......................... DC01-LOCAL -   RidManager  : Services   : RpcSs  DC01-LOCAL,   - WIN32_OWN_PROCESS,   - WIN32_SHARE_PROCESS ......................... DC01-LOCAL -    Services  : SystemLog ......................... DC01-LOCAL -   SystemLog  : VerifyReferences ......................... DC01-LOCAL -   VerifyReferences    : Schema  : CheckSDRefDom ......................... Schema -   CheckSDRefDom  : CrossRefValidation ......................... Schema -   CrossRefValidation    : Configuration  : CheckSDRefDom ......................... Configuration -   CheckSDRefDom  : CrossRefValidation ......................... Configuration -   CrossRefValidation    : LOCAL  : CheckSDRefDom ......................... LOCAL -   CheckSDRefDom  : CrossRefValidation ......................... LOCAL -   CrossRefValidation    : LOCAL.Local  : LocatorCheck ......................... LOCAL.Local -   LocatorCheck  : Intersite ......................... LOCAL.Local -   Intersite</code> </pre><br></div></div><br><br>  As you can see, the checks passed almost everything except for the Services check.  But here I have a completely logical explanation - I am using a new utility (from a package for windows 7) trying to check a domain controller based on win2003 - and it is quite possible that the name of the service may differ. <br><br><hr><br>  <i>Lyrical digression number 1.</i>  When preparing the article, I encountered an <s>epic fail</s> funny phenomenon, can we discuss it in the comments?  :)  In general, launching dcdiag from under the normal account of another domain (linked by trust with the local domain under investigation) and setting the parameters <i>/ u</i> and <i>/ p</i> - (username and password of the administrative account of the local domain) - the utility generated errors in terms of checks - for example, sysvolchek (in the dcdiag 2003 version, frssysvol).  If you go to the workstation under an account with administrative authority in the local domain, the checks are fine.  So - maybe, all the same, it will not be superfluous to check on the server itself.  To the <i>man of lyrical digression number 1</i> . <br><hr><br><br>  Fully describe the results of the team, I do not see the point.  It is beautifully described in utility help ( <b>dcdiag / h</b> ).  The main thing is clear - there are no problems with this domain controller and all tests have been passed.  But from checking one server - it does not follow the fact that AD is now in a healthy state of <s>chocolate</s> .  And here we come to the aid of the key to check all the servers of the enterprise. <br>  This is the key <i>/ e</i> .  This key forces the utility to bypass all CDs in the domain with the launch of all tests on each server.  It is useful to apply with this <i>/ v</i> - output extended information for each test.  Well, to analyze all this - it is useful to output the data to a file - and the log separately, error messages - separately.  The <i>/ f: log_file_name</i> and <i>ferr: / err_of_file_name_log</i> files help (the <i>/ ferr</i> key is removed in new versions).  If you want to check the wrong domain you are in now, add a key to specify the context name <i>/ n:.</i> <br><br>  The whole team looks like this: <br>  <b>dcdiag / n: local / e / v /f:c:\logs\adtest.log /ferr:c:\logs\aderrors.log / u: local \ user19 / p: Password</b> <br><br>  Attention!  In dcdiag versions, starting with windows 2008, the <i>/ ferr</i> key <i>:</i> removed from supported (specially repeated :)). <br>  If you have a complex forest structure, and even with slow communication channels, be prepared to wait.  Yes, even if it is simple - let's say I have in one real forest - 10 KD, 5 sites and 256 kbit / s channels.  The execution of this command takes on average up to 20 minutes. <br>  The performance result is highly recommended to carefully review for problems.  Well, it is very desirable to run this utility regularly to diagnose AD health. <br>  For hardcore, you can also add the <i>/ fix</i> key - making secure fixes, but you shouldn't do this without a thought. <br><br>  That's all that I wanted to tell today.  And how often do you have to use this utility at work?  What alternatives do you know? <br><br>  <b>update 1</b> : I remembered something, again from personal experience: if you have a large domain connected by slow (for example, satellite) communication channels, the utility will produce a lot of errors if it is not available - most often, RPC is unavailable.  This is normal, and you need to know about it.  If the majority of tests end with a similar message, then there is no connection, it is necessary to apply measures to eliminate the failure.  The second is often a common problem - errors in DNS - but this topic is for a separate article. <br>  ps to update 1 -dcdiag / fix - including registering a new record in the dns of the netlogon service - it is also useful to know! </div><p>Source: <a href="https://habr.com/ru/post/174379/">https://habr.com/ru/post/174379/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../174353/index.html">Bitmessage - program for P2P exchange of encrypted messages</a></li>
<li><a href="../174359/index.html">Lifeboat Foundation: How Stephen Wolfram Prepares for Singularity</a></li>
<li><a href="../174369/index.html">Common mistakes when developing lockfree-algorithms and their solutions</a></li>
<li><a href="../174373/index.html">RPG game in Excel workbook</a></li>
<li><a href="../174375/index.html">Github Visualizer - A service to visualize the history of repositories with GitHub</a></li>
<li><a href="../174381/index.html">Chrome browser woke man at 3:00 AM with monsters shouting</a></li>
<li><a href="../174383/index.html">The book by Leonard Susskind "Battle of a black hole"</a></li>
<li><a href="../174385/index.html">Intel installs coffee and cola in its offices on the Core i7 platform</a></li>
<li><a href="../174387/index.html">Acumatica 4.0 - what can be the design of the ERP, and how to optimize the performance of complex applications</a></li>
<li><a href="../174397/index.html">Biometrics 2013: it's time to abandon bank cards. Dream?</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>