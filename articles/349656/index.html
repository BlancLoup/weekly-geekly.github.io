<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>VLFs - Forgotten Enemy</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hi, Habr! I present to you the translation of the article "VLFs - The Forgotten Foe" by Monica Rathbun. 

 How many of you check the number of virtual...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>VLFs - Forgotten Enemy</h1><div class="post__text post__text-html js-mediator-article">  Hi, Habr!  I present to you the translation of the article "VLFs - The Forgotten Foe" by Monica Rathbun. <br><br>  How many of you check the number of virtual log files (VLF) that are in your transaction logs? <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/617/888/d24/617888d2489fb0585869b63249d84b32.jpg" alt="image"></div><br>  Now, as a consultant, I see that it is often ignored by database administrators.  This is not an easy task to maintain and yet many do not know how to do it.  Storing this data can improve performance not only at startup, but also during insertion / update / deletion, as well as backup / restore operations.  SQL Server works better with fewer virtual log files of the right size.  I highly recommend that you add this to your servers. <br><a name="habracut"></a><br><h3>  What is a VLF? </h3><br>  Each transaction log consists of small segments called virtual log files (VLF).  Each time a growth event occurs in new segments, virtual log files are created at the end of the transaction log file.  Large amounts of VLF may slow down performance. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/a87/447/b3a/a87447b3a758c89a41f4323a2f07f41a.gif" alt="image"></div><br><h3>  What is the reason for the growth of VLF? </h3><br>  Because transactions cause the log file to grow in size, an incorrect log file size or automatic growth settings can lead to a large number of VLFs.  Each event adds a VLF to the log file.  The more often the events in combination occur, the greater the VLF in your transaction log. <br><br><h3>  Example </h3><br>  If you increase your default log by 1 MB, you can get thousands of VLF, and increase the log by 1 GB.  The MSDN is perfectly explained how the transaction logs work, which I recommend reading. <br><br>  How do I know how many VLF files my log files have? <br><br>  It is very easy to understand how many VLFs you have in your log file.  Make sure you are in the context of the database in which you want to know it.  In my case, this is TEMPDB and run the DBCC LOGINFO command. <br><br><pre><code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">USE</span></span> tempdb  DBCC LOGINFO</code> </pre> <br>  The query will return the set of all LSNs created for this database, the COUNT of these rows is the number of VLFs that you have. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/795/4ce/f78/7954cef78c4146001fd0827327ab15e3.png" alt="image"><br><br>  Now there are many ways in which you can get an idea of ‚Äã‚Äãthis with T-SQL, so keep this in mind.  Write something that rolls through all your databases and gives you the number of records for each.  There are many useful examples on the Internet. <br><br>  The number of VLFs should be no more than 100, ideally, all of the above should be considered. <br><br>  * New DMV ( <a href="https://habrahabr.ru/post/70121/">Use SQL Server Dynamic Management Views and Functions</a> ), which will give you an even easier way to get the VLF values ‚Äã‚Äãsys.dm_db_log_stats (database_id). <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">name</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> <span class="hljs-string"><span class="hljs-string">'Database Name'</span></span>, total_vlf_count <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> <span class="hljs-string"><span class="hljs-string">'VLF count'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> sys.databases <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> s <span class="hljs-keyword"><span class="hljs-keyword">CROSS</span></span> <span class="hljs-keyword"><span class="hljs-keyword">APPLY</span></span> sys.dm_db_log_stats(s.database_id) <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> total_vlf_count &gt; <span class="hljs-number"><span class="hljs-number">100</span></span>;</code> </pre> <br><h3>  How to fix it? </h3><br>  These transaction log files should be reduced until there are only two VLFs and then increased to the current size. <br><br><ul><li>  Run Shrink using DBCC SHRINKFILE <br><br><pre> <code class="sql hljs">SHRINKFILE (N'Log_Logical_Name_Here', 0, TRUNCATEONLY);</code> </pre> </li><li>  Restore your journal with an increment that makes sense to your environment.  However, if your file exceeds 8 GB, it is recommended to increase the block size to 8000 MB.  The value of your increment should automatically be set to a lower value.  There is no set rule for what these values ‚Äã‚Äãshould be, it may take a lot of trial and error to figure out what is best for your environment. <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">USE</span></span>[<span class="hljs-keyword"><span class="hljs-keyword">master</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">GO</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ALTER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DATABASE</span></span>[tempdb] <span class="hljs-keyword"><span class="hljs-keyword">MODIFY</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FILE</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">NAME</span></span> = N <span class="hljs-string"><span class="hljs-string">'tempdev'</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">SIZE</span></span> = <span class="hljs-number"><span class="hljs-number">8192000</span></span> KB) <span class="hljs-keyword"><span class="hljs-keyword">GO</span></span></code> </pre> </li></ul><br>  Note.  Increasing the log may result in a performance hit and transaction lock; be sure to do this during maintenance. <br><br>  It's that easy, now take a look at your files.  You may be surprised at what you find. </div><p>Source: <a href="https://habr.com/ru/post/349656/">https://habr.com/ru/post/349656/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../349642/index.html">DEV Labs 2018. Online conference for Java developers. March, 3rd</a></li>
<li><a href="../349644/index.html">Sort Lists by CSS</a></li>
<li><a href="../349646/index.html">[Video] Speeches from the Yandex.Money PieMn mit about agile and coaching</a></li>
<li><a href="../349650/index.html">Continuous transitions between common elements: from RecyclerView to ViewPager</a></li>
<li><a href="../349652/index.html">How to make Java code simpler and clearer</a></li>
<li><a href="../349658/index.html">Case "Monitoring of the business loan portfolio of the bank with the help of three-dimensional visualization"</a></li>
<li><a href="../349660/index.html">Methods for constructing test functions</a></li>
<li><a href="../349662/index.html">We invite you to give lectures on the gaming industry on March 1 at VSBI</a></li>
<li><a href="../349664/index.html">HDR game analysis</a></li>
<li><a href="../349666/index.html">Overview lecture and the launch of the 2nd part of the course on the development of web services on Go</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>