<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Watchdog for replication in PostgreSQL 9</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Greetings. I want to share one samopisny crutch, maybe someone will be useful. 

 Briefly about the main thing 
 We simulate a situation: there is a c...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Watchdog for replication in PostgreSQL 9</h1><div class="post__text post__text-html js-mediator-article">  Greetings.  I want to share one samopisny crutch, maybe someone will be useful. <br><br><h4>  Briefly about the main thing </h4><br>  We simulate a situation: there is a cluster of PostgreSQL servers ‚Äî a master and n-replicas.  There comes a black day and one (or several) replicas falls.  The reasons are unimportant - the piece of iron died, the cleaner cleaned the wire with a mop, or the UFO temporarily zohavalo server.  The result is one - if the replica has been lying for a long time, then she herself will never catch up. <a name="habracut"></a><br><br>  The reason is the PostgreSQL replication process itself.  As data is received, the journal is discarded to disk (by default - chunks of 16 MB each).  In the wizard config we use the wal_keep_segments option, which indicates how many last XLOG pieces we will store.  Let the parameter be equal to 16.  This means that in the pg_xlog directory there will be 16-log files at the same time, and when the 17th appears, an attempt will be made to send the 1st to the archive (in other words, there is a constant rotation).  And if your replica falls behind more than these 16 files - when you try to catch up with the master, in the log you will see a message stating that the necessary piece of XLOG cannot be obtained because  on the master he has already gone to the archive.  And all because the default backup command, as a rule, looks like this: 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
     <code>cp %p /var/lib/postgresql/9.0/main/archive/%f</code> <br> <br>  As you can see, there are no checks on whether the file archiving will hurt anyone. <br>  In essence, there is nothing fatal in this - if the required archive file has not been deleted, you just need to slip it onto the cue in the right place and the file itself will ‚Äúroll‚Äù.  The unpleasant moment is that, depending on the load, to copy, as a rule, not one file, but tens / hundreds / thousands.  In addition, the process must be monitored because  while you are copying the same files, the wizard archives the new ones.  In the worst case, you can be saved by a complete replay of the replica. <br>  In order not to encounter such joys, I wrote a small script on a mixture of Perl and Bash.  I will say in advance that in no case do I pretend to be the best programmer - the main condition was not the beauty of the code, but the execution of the necessary actions.  So, the script is <a href="http://pastebin.com/rELWdnM7">here</a> , but for now I‚Äôll tell you exactly what it does. <br><br><h4>  How it works </h4><br> <code>master01:~# ps aux|grep postg|grep sender <br> postgres 26132 0.0 0.0 6518660 3052 ? Ss 20:21 0:01 postgres: wal sender process postgres 192.168.12.1(36254) streaming 153/ED957E68 <br> postgres 26133 0.0 0.0 6518660 3056 ? Ss 20:21 0:01 postgres: wal sender process postgres 192.168.12.2(51907) streaming 153/ED957E68 <br> postgres 26135 0.0 0.0 6518660 3060 ? Ss 20:21 0:01 postgres: wal sender process postgres 192.168.12.3(39404) streaming 153/ED957E68 <br> postgres 29142 0.0 0.0 6518724 3084 ? Ss 20:44 0:01 postgres: wal sender process postgres 192.168.12.4(51897) streaming 153/ED957E68 <br> postgres 29320 0.0 0.0 6518724 3084 ? Ss 20:45 0:01 postgres: wal sender process postgres 192.168.12.5(49234) streaming 153/ED957E68 <br> postgres 29453 0.0 0.0 6518724 3084 ? Ss 20:46 0:01 postgres: wal sender process postgres 192.168.12.6(35519) streaming 153/ED957E68 <br></code> <br><br>  As we can see from this simple command - in the list of processes you can find: <br>  1. The number of connected replicas, with their ip-addresses. <br>  2. A piece of XLOG, which is currently being processed by them. <br><br>  And we, in our turn, as people who manage this construction, know how many replicas we have and what their addresses are.  Pay attention to the last part of the lines - this is the XLOG position for a particular replica.  If we remove the slash from this value and cut out the last 6 characters from the resulting one, we will have 153ED.  This is a hexadecimal number. <br><br>  And in the list of processes you can find this: <br><br> <code>master01:~# ps aux|grep postg|grep arch <br> postgres 556 0.0 0.0 66184 1668 ? Ss Oct11 0:23 postgres: archiver process last was 0000000100000153000000EB</code> <br> <br>  The last part of the line is the file that was archived.  We take away the last 13 characters, we remove from them 6 zeros coming in a row.  We get 153EB. <br><br>  We convert the resulting numbers to decimal (for clarity), we get 87021 and 87019. Comparing these two numbers, we learn that replicas use a log that is older than the last archived by 2 steps - therefore, we can safely delete one fragment. <br><br>  Based on these simple manipulations, my script works: <br><br>  1. The administrator adds a list of replicas to /etc/postgresql/9.0/main/slaves.list (one per line). <br>  2. The script fits in as archive_command in the PostgreSQL config. <br>  3. When you try to archive a piece of XLOG, the following happens: <br>  3.1.  Checks whether the number of connected replicas corresponds to the number specified in the config. <br>  3.2.  If everything is good, we‚Äôll see if the hosts match the ones specified in the config file (this is done in case we expand the cluster and we forget to write a new replica to the config). <br>  3.3.  We calculate the minimum position of the XLOG among replicas (we are looking for the most lagging behind). <br>  3.4.  Compare the numbers from the file name to be archived and the number from the previous paragraph. <br><br>  If all conditions are passed - copy the file to the archive and return 0. If something went wrong - return one - PostgreSQL will consider the attempt unsuccessful and after some time will take the next one.  You can follow the process in /var/log/postgresql/9.0/watchdog.log <br><br>  <b>Achtung!</b>  <b>It is assumed that the list of replicas will indicate the existing DNS records (made for personal convenience), or the names specified locally in / etc / hosts.</b>  <b>To disable this, you need to comment out the lines from 47th to 55th.</b> </div><p>Source: <a href="https://habr.com/ru/post/130704/">https://habr.com/ru/post/130704/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../130699/index.html">Features of working with networkers</a></li>
<li><a href="../130700/index.html">Native SDK for BlackBerry Tablet OS released</a></li>
<li><a href="../130701/index.html">Motorola introduced the DROID RAZR</a></li>
<li><a href="../130702/index.html">Customization of social buttons</a></li>
<li><a href="../130703/index.html">Chain conversion</a></li>
<li><a href="../130707/index.html">Nesztapap - old-school non-commercial site</a></li>
<li><a href="../130710/index.html">Interception PPPoE session</a></li>
<li><a href="../130712/index.html">Broadcast from a Google and Samsung event in Hong Kong - Galaxy Nexus features, new Android 4.0 Ice Cream Sandwich [updated]</a></li>
<li><a href="../130714/index.html">Acer Iconia Tab - how to disassemble the tablet and what it consists of</a></li>
<li><a href="../130716/index.html">October 19 - It-english speaking club: Silicon Valley from Russia</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>