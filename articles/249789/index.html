<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>How we built the data center alarm system</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="It so happened that in the Embox project team I have the most experience in the field of automated control systems: at the previous place of work I de...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>How we built the data center alarm system</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/files/2b3/457/4dd/2b34574dd846435d8f44c8609a44a153.jpg" alt="image" align="right"><br>  It so happened that in the <a href="https://code.google.com/p/embox/">Embox</a> project team I have the most experience in the field of automated control systems: at the previous place of work I developed industrial controllers.  Therefore, it is not surprising that when the task arose to make the automatic control system for the LEDs in the data center, I was asked to work out the project architecture.  It was originally planned to purchase ready-made remote controllers for I / O port control, but after a more thorough study of the requirements, it became clear that the option of developing a custom controller was preferable for the customer.  Actually you see it in the photo. <br>  For those who are interested to know about what rake we stepped on, what exploded chips look like, how to connect the ground correctly on a DC / DC converter, and, of course, why we used our project, I ask for cat.  Careful, a lot of pictures! <br><a name="habracut"></a><br><h2>  Customer‚Äôs wish is law </h2><br>  Initially, the task seemed very standard, you need to manage + 24V diodes according to messages coming from the customer's SCADA system.  Of course, SCADA receives messages about the status of any sensors, and not about the need to light or extinguish a particular diode, but this is solved by developing a kind of PROXY that translates emergency-type messages in the N cabinet to the corresponding command sent via the <a href="https://ru.wikipedia.org/wiki/Modbus">Modbus</a> protocol. on a specific controller. <br><br>  Accordingly, the architecture proposed by me was very simple and proceeded from my experience in the field of automated control systems.  Namely, take electric boards, such as those in which there are meters, fill them with controllers with a maximum set of discrete outputs, for example, MOXA ioLogik E1211, supply power sources, and, in principle, everything.  That is, the picture was as follows: the shield, as it should be in the ACS, is mounted on the wall, one Ethernet network wire and 220 power supply come into it, and a bunch of wire pairs go to the LEDs.  There were, of course, questions about such a large number of diodes, but they were easily solved by increasing the number of cabinets. <br><br>  But with further refinement of details, nuances began to emerge that began to influence such a simple and understandable scheme of implementation.  The first condition that shattered our confidence was that the equipment should be installed only in telecommunication cabinets.  On the one hand, nobody canceled the DIN rail, but on the other hand, you see, the telecommunications counter will look somehow miserable if I / O controllers and power supply units are hung there.  In addition, the installation and maintenance of such a design is a fairly non-trivial task.  The obvious solution was to use the rack case, and already in it hide the entire inaccessible ‚Äúuser‚Äù kitchen.  In order to make it easier to scale the circuit and increase the number of outputs, I suggested using controllers that do not work via Ethernet, but via RS485 (for example, ioLogik R1212), and put a Modbus-RTU to Modbus / TCP converter (MGate MB3170-T) at the input . 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      But the wish of the customer to have a friendly user web-interface strongly confused our plans.  I began to propose not so beautiful solutions, for example - to put proxy in each case and so on.  These ideas were not very successful, but I continued to defend the decision to do everything on ready-made elements, until it became clear that the delivery time of ready-made controllers in sufficient quantity did not fit into the order time. <br><br><h2>  Own bike should be comfortable </h2><br>  Began to think about other solutions.  The guys from the team said: <br><blockquote>  ‚ÄúWhat is there to do at all?  We just need to control the controller's legs, let the voltage and current be quite large, but there are keys like ULN2803A.  We have a couple of STM32F4Discovery debugging boards on the table right now, and a similar task is perfectly solved on them.  In addition, if you use these debugs, you can very easily implement a web interface, since the web server is already running there. ‚Äù </blockquote><br>  I objected that not everything is so simple that we, for example, do not have support for the ModBus protocol, which is the standard for this kind of devices.  To which one of the members of our <a href="https://habrahabr.ru/users/0xdde/" class="user_link">0xdde</a> team the next day did support by moving the <a href="http://libmodbus.org/">libmodbus</a> library. <br><br>  In general, I gave up, and it was decided to make the controller using the existing STM32F4Discovery, circuit board, MGTF wires, keys and <a href="http://www.notredamedeparis.fr/">some kind of mother</a> . <br><br>  In order to look beautiful, we decided instead of the terminals to put the connectors on the three contacts W7166-03PSGB00, because, as I said, the control is carried out by pairs of diodes, and they have a common ground.  Unfortunately, we could not find any connectors for three contacts with a normal delivery time and put the W7166-04PSGB00 connectors on four contacts.  Initially, we wanted to have 80 such connectors located on one controller, but here we were again confronted with the fact that 80 such connectors barely fit onto the cover of the U1 rack rack.  In addition, we got that the 24V power supply should be at least 20A.  Therefore, we decided to limit ourselves to 40 connectors (pairs of diodes) and put everything into the U2 case. <br><br>  The next question that arose was that our STM32F4Discovery did not have 80 free leads for controlling 40 pairs of diodes.  Help had to call for shift registers 74HCT164N. <br><br><h2>  Requirement analysis is important </h2><br>  Problems with the procurement component, we omit.  But about our oversight when reading the description of the chip keys, I will tell.  If this is not interesting, then at least instructive. <br><br><img src="https://habrastorage.org/files/3b5/be7/a8c/3b5be7a8cbef4b0aaeaa31146ce17373.png" alt="image" align="right"><br>  As I said, the diodes are paired and have a common wire - ground.  The diodes are controlled by the positive voltage on the control contacts.  So, when the diodes arrived, we turned on one diode, successfully controlled it and calmed down.  But when it came to checking on a real pair, it turned out that these keys control the breaking of the ground (common wire), that is, the switching circuit should be the same as in the picture. <br><br>  In general, we urgently had to change the type of keys, first on the UDN2981A-T, and then on the TD62783APG, since the former were considered obsolete, and besides they cost quite a lot, they also turned out to be difficult to buy. <br><br>  When, finally, the scheme for one cascade was created, it looked like this. <br><br><img src="https://habrastorage.org/files/6a8/258/a91/6a8258a91c1645cc8e4bd3b431b4f40c.jpg"><br><br>  The result of an oversight on the documentation was a couple of lost days and the presence of a couple of hundreds of microcircuits that had already arrived by that time. <br><br><h2>  Mounting is not that simple. </h2><br>  After we finally earned one cascade under the control of the STM32F4, we proceeded to the next stage, namely to create a full-fledged prototype of the device. <br><br>  The idea was as follows. <br>  We take the circuit board, arrange the chips and connectors on it.  We solder all this, we connect according to a rather simple scheme (will be next), add a couple of connectors, one for power and one for control signals from STM32F4Discovery, then power up, connect the loop with Discovery, and only the body remains.  In general, everything seemed simple and easy.  However, the reality was not so rosy. <br><br>  The first problem we encountered was a surface mount.  The fact is that there is a big difference between soldering dozens of wires and hundreds of wires, and the latter turned out to be a terrible occupation. <br><br>  In general, they were soldered for a long time, but this is not the worst.  When, finally, they soldered, rang and gave food, an explosion occurred.  Turned off, rang again, turned out to be short between the ground (5B) and + 24V.  We simply drove two tires, and they touched the same metallized hole, and we didn‚Äôt ring the power supply between us.  In general, they themselves are to blame, but it was very scary. <br><br>  We taped the place of the short one with the tape (yes, yes, it did not do without the tape): <br><br><img src="https://habrastorage.org/files/e26/98f/a99/e2698fa99dab476882058b21fc4ea870.jpg"><br><br>  And then they made another mistake, namely, they didn‚Äôt remove the exploded microcircuit from the circuit.  At least, we think that the reason for the next explosion was exactly that. <br><br>  And this is what the chips cut from the board after such a short look like. <br><br><img src="https://habrastorage.org/files/3d4/264/852/3d4264852491454fac559e64f2930467.jpg"><br><br><h2>  Do not work on Saturday </h2><br>  We have ensured that, after energizing the circuit, nothing exploded, did not smoke, and did not get very hot.  Having been delighted, they hooked up the Discovery train and even tried to control the diodes, but to no avail.  It was necessary to look for a problem.  First of all, we checked the supply voltage (+ 5V and + 24V).  They were correct.  Then the voltages on the output contacts of the shift registers ‚Äî they, too, were correct.  And they could even be controlled.  But, oddly enough, nothing changed at the outputs of the keys; they were always open.  Long check of the connection scheme was unsuccessful. <br><br>  Measuring the voltage once again, we were very surprised to see that at the output contact of the shift register is + 5V, and at the input of the key something strange, although they are simply connected by wire.  A little later, it turned out that we measure the voltage at these points from different lands.  We measured the potential difference between the 5V and 24V lands and saw 5V.  It turned out that we simply incorrectly connected the TRACO TEN 12-2411 DC / DC converter chip.  I don‚Äôt even know how it occurred to us, because it‚Äôs obvious that if two voltages come on one and the same microcircuit, then they should have a common ground, and we didn‚Äôt connect the earth and got two untied voltages on the circuit.  In my defense, I can only say that we are programmers, although they are systemic, and even an obvious fact about a common point, we were suggested by familiar engineers. <br><br>  In general, we understood our mistake and decided to connect the lands, but since it was already about ten o'clock on Saturday evening, we decided to make it a thin wiring, while holding it with hands, simply shorting these points on the board.  I don‚Äôt know what happened next, or the hand trembled at the person who held the wire, or after another accident another key flew out, but this time I saw the microcircuit burning, literally burning, and I used to think that neither the ceramic body nor the metal contacts can burn.  In general, even minus the chip of the key and the shift register, which we bit, remembering about the previous experience.  And on this beautiful note, we went home, because further attempts to do something in a hurry seemed out of place to us.  After all, we did not have enough keys even for one device.  Well at least they should have come on Monday. <br><br><h2>  Simplicity will save the world </h2><br>  At the end of Saturday's battles, we still got a working prototype of the device, and it looked like this: <br><br><img src="https://habrastorage.org/files/d1a/b46/8c6/d1ab468c663a40e3849d6eb3e3f64ce2.jpg"><br><br>  Resistors (300 Ohms) in the photo imitate the load.  Before the demonstration to the customer, we did test runs for several hours.  Heat resistors, by the way, up to 120 degrees. <br><br>  I will not talk about working with the body and the final assembly, just bring pictures of the entrails, and that in order for the story to be complete: <br><br><img src="https://habrastorage.org/files/9d9/2c3/14d/9d92c314ddb045b1be901ed67617178e.jpg"><br><br><img src="https://habrastorage.org/files/52d/3a1/f57/52d3a1f57d8644da9a8600ecfcac6658.jpg"><br><br>  We have demonstrated the work to the customer, the functionality has arranged it, the appearance too.  The only thing he asked to change was to put in place of our connectors something that was adopted in telecommunications: RJ45 or RJ11, since this is much more familiar, and therefore easier to operate and maintain.  This time, after consulting with the engineers about whether the necessary currents would withstand such connectors, whether there was enough space on the front panel, and so on, we decided to install RJ12.  They were in stock, well, and constructively take up less space than RJ45.  In addition, given the previous experience, we decided that soldering on a breadboard is not an option, and ordered the design of a printed circuit board.  And since it turned out to be very simple, bilateral, even without metallization, we were let out of it in less than a week. <br><br>  The upgrades carried out greatly simplified our lives and made the board itself more beautiful. <br><br><img src="https://habrastorage.org/files/fb2/472/14d/fb247214d4524b2f87ac7b475674b165.jpg"><br><br><h2>  What does it have to do with Embox? </h2><br>  The strongest argument, as you understand, for using Embox was that we know it well, to say the least. <br><br>  But still I want to note the technical characteristics that greatly simplified the creation of the desired device.  The main thing, of course, is having a full-fledged web server with cgi support.  As a result, you can control our device using a browser, the page looks as close as possible to the real front panel. <br><br><img src="https://habrastorage.org/files/621/167/547/621167547cc74eb5a2838f746f650f5a.png"><br><br>  Of course, you can argue that there is an easier way to get a web server on the device, namely, to use Linux.  I do not argue this way, and it will certainly be more functional and will allow you to use a bunch of frameworks and programming languages ‚Äã‚Äãfor development.  But, first, we are sincerely convinced that managing a GPIO from under Linux is not the right approach.  And secondly, he simply will not get on such a hardware platform <a href="http://www.opennet.ru/opennews/art.shtml%3Fnum%3D33487">without special tricks</a> . <br><br>  Well, if you use FreeRTOS with the lwIP stack, which comes bundled, then the implementation of this functionality is much more complicated, and, of course, libmodbus is so easy to move. <br><br>  PS When developing this device, no LED in the datacenter suffered </div><p>Source: <a href="https://habr.com/ru/post/249789/">https://habr.com/ru/post/249789/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../249779/index.html">Blockchain Formation Algorithm</a></li>
<li><a href="../249781/index.html">Festival "City of Techno-Creativity" is held in Yekaterinburg</a></li>
<li><a href="../249783/index.html">Some interesting and useful things for web developer # 38</a></li>
<li><a href="../249785/index.html">PARI / GP: finite field calculations. Part 1</a></li>
<li><a href="../249787/index.html">Less is better, but better: airFiber 5X is a new generation of radio channels, or Lutz * for your radio route is now in retail</a></li>
<li><a href="../249791/index.html">Behind the Scenes of Skyforge Closed Beta</a></li>
<li><a href="../249793/index.html">Unconventional review of AngularJS</a></li>
<li><a href="../249795/index.html">The Five-Minute JavaScript Podcast, Issue 2</a></li>
<li><a href="../249797/index.html">Hi, Habravchane</a></li>
<li><a href="../249799/index.html">10 interesting facts about CDN and site speed</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>