<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>The evolution of architecture: from "samopisnyh" services to HandlerSocket</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Today we will talk about how the approach to the design of loaded ‚Äúkey-value‚Äù services has changed in Badoo. You will find out by what scheme such ser...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>The evolution of architecture: from "samopisnyh" services to HandlerSocket</h1><div class="post__text post__text-html js-mediator-article"> <a href=""><img src="https://habrastorage.org/storage2/b63/998/d07/b63998d07d90661c687461761f284aa6.png"></a> <br><br>  Today we will talk about how the approach to the design of loaded ‚Äúkey-value‚Äù services has changed in Badoo.  You will find out by what scheme such services were created by us several years ago (using the database as a repository and a specialized daemon as an interface to the data), what difficulties we encountered and what architecture as a result we came to resolve the problems that appeared. <br><a name="habracut"></a><br>  Modern Internet projects are actively using internal services that allow access to values ‚Äã‚Äãby key.  It can be both ready-made solutions, and own development.  Since 2006, a number of such services have been created by Badoo specialists, including: <br><ul><li>  a service that reports the location of user data by its identifier; </li><li>  a service that stores information about the number of accesses to a user profile; </li><li>  user interest list; </li><li>  several ‚Äúgeoservices‚Äù that allow you to locate a user. </li></ul><br><br>  Despite their diversity, a unified design approach was applied, according to which the service should consist of the following components: <br><ol><li>  Database repository that stores the reference version of the data. </li><li>  A fast daemon in C or C ++ that processes requests for data and is updated with the repository database. </li><li>  PHP classes that work with the daemon and the repository database. </li></ol><br>  It was important for us that any of the services could handle a large number of simultaneous requests, so a solution based on only one MySQL was not suitable.  Hence, an additional component appeared in the form of a fast daemon, which could not be replaced by memcached, because  we needed to use specific data indexes. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      At the end of 2010, the <a href="https://github.com/ahiguti/HandlerSocket-Plugin-for-MySQL/">HandlerSocket</a> MySQL plug-in, written by a <a href="http://yoshinorimatsunobu.blogspot.com/">Japanese craftsman</a> , providing NoSQL an interface to the data stored in MySQL, became increasingly popular.  In the spring of 2011, Badoo experts turned their attention to a new technology, hoping with its help to simplify the development and support of the key-value services of the company. <br><br><h4>  ‚ÄúFirst victim‚Äù </h4><br>  A great number of users who receive various e-mail notifications have been registered in the network for finding new friends of Badoo.  And each of these users has the opportunity to select the type of notifications that they would like to receive.  Accordingly, it is necessary to store mail settings somewhere and provide access to this data.  Over 99% of requests to them are read requests.  The main "readers" are script-generators and email senders, who, on the basis of these data, decide whether or not to send correspondence of a certain type to a specific user.  At first, only the database was used to store data, but it ceased to cope with the ever-increasing number of read requests.  To remove this load, a special daemon was created - EmailNotification. <br><br><h4>  ‚ÄúOld school‚Äù service implementation </h4><br>  The key component of the service was the C-daemon, which stores all the settings and gives them access to read and write via the simplest protocol over TCP.  In addition, this daemon collected statistics of requests, on which we built graphs. <br><br>  Initially, the service architecture was fairly simple and looked like this: <br><img src="https://habrastorage.org/storage2/beb/31e/405/beb31e40562a299cd98b74ee7ef92bd3.png"><br><br>  The settings were constantly stored in the database on one DB-server, and the C-daemon worked on another.  At the start, the daemon selected all data from the database and built an index ( <a href="http://judy.sourceforge.net/">judy arrays</a> ) on them.  The initialization process took about 15 minutes, but since this operation was required only a few times during the entire service life, this was not a significant drawback.  In the process, clients (CLI-scripts, web and other services) addressed a daemon through a special API, for example, asking whether the user could send this email or not, and the built-in logic searched the daemon in its memory for setting and responding .  The client writers gave the daemon the command to change certain settings for a specific user. <br><br>  The task of writing data to MySQL was entirely left to the EmailNotification API.  At the same time, potentially out of synchronization of data could occur, for example, when the recording successfully passed to the database, but did not go to the daemon, or vice versa.  Nevertheless, the service worked fine.  Until in 2007 Badoo had a ‚Äúlittle trouble‚Äù, namely, a second data center appeared, geographically distant from the first and intended to serve the users of the New World.  It immediately became clear that the usual duplication of the architectural solution on the new site would not be possible.  Since emails to the same user can be sent from both sites, it is required that both services operate on the same data. <br><br>  Fortunately, especially for such cases within the company there is a system of CPQ-events (CPQ - Cross Platform Queue, cross-platform queues. - Note of the author), which allows you to quickly and, most importantly, with guarantee and in a predetermined sequence to transmit information about the events between sites.  As a result, at two sites, the service architecture took the following form: <br><img src="https://habrastorage.org/storage2/391/790/703/391790703d654e1e5f396b5035a6d100.png"><br><br>  Now, any write requests were sent not only to the base and C-demon of the local site, but also to CPQ.  CPQ sent the request to the adjacent queue of another site, and she was already replaying the write request via the EmailNotification API at the same site. <br><br>  The system became more complicated, but nevertheless continued to work stably for several years.  And everything would be fine if there were no discrepancies in the data at the sites.  The two bases of the available sites had a different number of settings.  And although the difference was less than 0.1%, the feeling of ‚Äúcleanliness and security‚Äù was gone.  Moreover, we found that the difference appeared not only between the bases of the sites, but it was present between the base and the C-demon within the same platform.  I had to think about how to make the service more reliable. <br><br><h4>  New approach </h4><br>  Initially, there were two basic requirements for the EmailNotification service: first, the high speed of processing read requests, which the C-daemon did perfectly well;  the second is the identity of the data at both sites, with which there were problems.  Instead of fighting over synchronization, we decided to completely redo the service architecture, taking the path of simplifying it: <br><img src="https://habrastorage.org/storage2/b3c/46a/2cf/b3c46a2cfa4ab314bbfeec53191a9a18.png"><br><br>  First of all, we connected the HandlerSocket plugin to MySQL and taught our API to work through it with the database.  Thanks to this, we were able to abandon the use of C-demon.  Then, by simplifying the API, we removed the CPQ service from the schema, replacing it with the well-proven ‚Äúmaster-master‚Äù replication between sites.  As a result, we got a very simple and reliable scheme, which has the following advantages: <br><ol><li>  Replication is carried out transparently; no code is required that works with an internal CPQ service.  At the same time, the delay in transferring updates between sites was reduced from a few seconds to fractions of a second. </li><li>  Atomic data recording (finally!).  If the EmailNotification API request for writing to HandlerSocket is completed successfully, then the task is completed, the recording is exactly duplicated at another site, and we do not need to inform any other components about it. </li></ol><br>  Did we have a problem when switching to a new scheme?  Serious - no.  AUTO_INCREMENT is already supported by the HandlerSocket plugin, composite indexes are working, ENUMs, too, all I had to do was abandon the CURRENT_TIMESTAMP default values ‚Äã‚Äãfor one of the timestamp fields. <br><br>  As you know, the advantage of HandlerSocket is not in its speed - it is more likely acceptable than impressive, but in its ability to work stably under a large number of requests per unit of time.  Given that now the service serves only 2 - 2.5 thousand requests per second on one site, then we have a large margin of safety. <br><br>  But for those who are especially interested in the speed of the HandlerSocket plugin, we will present a graph with an average execution time of three commands: connecting to the HandlerSocket, opening the index and retrieving data on it (values ‚Äã‚Äãon the Y axis in milliseconds): <br><img src="https://habrastorage.org/storage2/786/771/aa0/786771aa06a6f6b9bc69548ff1700b10.png"><br><br><h4>  Final word </h4><br>  Over the past year, Badoo has tended to use HandlerSocket as a ‚Äúkey-value‚Äù repository with persistent data storage.  This allows us to write more simple and understandable code, relieves C-programmers from working on trivial tasks and significantly simplifies support.  And while everything says that the movement in this direction will continue. <br><br>  But do not think that using HandlerSocket inside Badoo is limited to the simplest tasks.  For example, we have a wide experience of its use for solving problems with a predominance of the recording function, where a number of nuances are manifested under a really heavy load.  If you are interested in the details - comment, ask, and we will definitely continue this topic with new articles. <br><br>  Thank! </div><p>Source: <a href="https://habr.com/ru/post/141945/">https://habr.com/ru/post/141945/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../141938/index.html">Cleaning infected site files from malicious code. Continuation</a></li>
<li><a href="../141940/index.html">YOTA begins testing a new LTE network in Moscow</a></li>
<li><a href="../141941/index.html">Withdrawing Yandex.Money to Visa cards in new countries</a></li>
<li><a href="../141943/index.html">We write "Snake" for Windows Phone 7</a></li>
<li><a href="../141944/index.html">CouchDB: the story of one accident</a></li>
<li><a href="../141946/index.html">Create a session key using public and private keys</a></li>
<li><a href="../141948/index.html">1366 √ó 768px went around 1024 √ó 768px in the list of the most popular screen resolutions</a></li>
<li><a href="../141949/index.html">How to organize a corporate wintering?</a></li>
<li><a href="../141950/index.html">Habraigre tournament "Startup"</a></li>
<li><a href="../141951/index.html">Internet buyers in Russia</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>