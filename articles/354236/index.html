<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Why the creation of a simple preview on the links in Wikipedia took four years</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="History preview pages. 


 When you hover over a link, a preview card appears (and yes, I have a Wikipedia mobile skin on my desktop). Text from Wikip...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Why the creation of a simple preview on the links in Wikipedia took four years</h1><div class="post__text post__text-html js-mediator-article">  History preview pages. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/75f/f22/826/75ff2282643cbcbf2c5c511aa0b845bf.png"><br>  <i>When you hover over a link, a preview card appears (and yes, I have a Wikipedia mobile skin on my desktop).</i>  <i><font color="gray">Text from Wikipedia articles on <a href="https://en.wikipedia.org/wiki/Iceberg">icebergs</a> and <a href="https://en.wikipedia.org/wiki/Water">water</a> , <a href="">CC BY-SA 3.0</a> .</font></i>  <i><font color="gray">Images from left to right, top to bottom: # 1 Kim Hansen, <a href="">CC BY-SA 3.0</a> ;</font></i>  <i><font color="gray"># 2 Andreas White, <a href="">CC BY-SA 4.0</a> ;</font></i>  <i><font color="gray"># 3 National Library of New Zealand, <a href="">CC0</a></font></i> <br><br>  A few days ago, <a href="https://medium.com/freely-sharing-the-sum-of-all-knowledge/wikipedia-page-previews-738cddac7a21">my team launched</a> the <a href="https://www.mediawiki.org/wiki/Page_Previews">‚ÄúPage Preview‚Äù</a> feature (preview) in hundreds of language versions of Wikipedia.  Our API <a href="https://grafana.wikimedia.org/dashboard/db/reading-web-page-previews%3Frefresh%3D1m%26orgId%3D1%26panelId%3D2%26fullscreen">handles every minute up to half a million calls</a> for issuing preview cards, which are displayed when you hover over any link. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      At first glance, everything is very simple.  This is on many sites.  The image and some text are placed on the card - and it is displayed when you hover over the link.  Nothing innovative ... at least it may seem so at first glance. <br><br>  The original idea of ‚Äã‚Äãthis feature appeared four years ago on the basis of the idea that <a href="https://en.wikipedia.org/wiki/Wikipedia:Tools/Navigation_popups">one volunteer / editor</a> suggested many years before. <br><br>  Thus, it took us several years to roll out the feature to all.  This may seem strange, but as in the iceberg, the underwater part should be evaluated. <br><a name="habracut"></a><br><h2>  It was necessary to choose a thumbnail </h2><br>  We have several million pages - all stored as a raw wiki text.  One could not expect every article to be edited for the selected thumbnail. <br><br>  Back in 2012, Max Semenik, a software engineer at our <a href="https://www.mediawiki.org/wiki/Community_Tech">Community Tech group</a> , developed an <a href="https://www.mediawiki.org/wiki/Extension:PageImages">extension</a> that algorithmically yields the most appropriate image for an article. <br><br>  As with all algorithms, it did not work perfectly.  And since it was not originally intended for use in a preview, it required a special configuration. <br><br>  I had to make some changes to limit the image to the first section of the article.  Working with algorithms is difficult, but in this case it is necessary. <br><br><h2>  It was necessary to generate a resume </h2><br>  We have several million pages in <a href="https://www.mediawiki.org/wiki/Wikitext">wiki text</a> .  How to generate a resume for each of them, without loading our editors with this painstaking work? <br><br>  Max Semenik, who helped us with thumbnails, is also the author of the <a href="https://www.mediawiki.org/wiki/Extension:TextExtracts">extension to generate excerpts from articles</a> .  Initially, it worked primarily with <a href="https://en.wikipedia.org/wiki/Plain_text">text format</a> .  We used it in the first versions of the preview, but soon realized that this was not the best option. <br><br>  Then we stopped using it. <br><br>  We understood the importance of HTML.  For example, in chemistry, there are descriptors that require HTML support. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/34f/3d8/2a3/34f3d82a39070b85848fffa7c393c5d3.png"></div><br><br>  <i>HTML is required to create a summary of content in which the presence of subscripts is important.</i>  <i><font color="gray">Text from an English-language Wikipedia article on <a href="https://en.wikipedia.org/wiki/Water">water</a> , <a href="">CC BY-SA 3.0</a> ;</font></i>  <i><font color="gray"><a href="">Image of</a> Kim Hansen, <a href="">CC BY-SA 3.0</a></font></i> <br><br>  Many of our articles begin with coordinates and word pronunciation information.  Much of this content was not included in the summary, and for the rest it was not entirely clear: what to include here and what not.  After studying a <a href="https://medium.com/freely-sharing-the-sum-of-all-knowledge/how-we-designed-page-previews-for-wikipedia-and-what-could-be-done-with-them-in-the-future-7a5fa6b07b96">lot of design options,</a> we determined which content should not be displayed in the preview.  Then they made a <a href="https://www.mediawiki.org/wiki/Page_Previews/API_Specification">specification that reinforces the desired behavior</a> . <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/191/d81/c17/191d81c171656b86bbbe741f378af4da.png"></div><br>  <i><font color="gray">The coordinates of the place are indicated at the beginning of many articles, but it turned out to be problematic to include them in the summary ...</font></i> <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/ba5/226/f55/ba5226f552b60f7b402618798c7a1ccb.png"></div><br>  <i><font color="gray">... as well as pronunciation information</font></i> <br><br>  In the end, we decided to work on top of an <a href="https://en.m.wikipedia.org/wiki/Application_programming_interface">API</a> that was originally developed for native Wikipedia applications for Android and iOS.  Especially for this we have created a new API. <br><br>  Now the summary is generated based on the whole HTML page.  It is interpreted as in a browser and <a href="https://www.mediawiki.org/wiki/Page_Previews/API_Specification">according to the specification the</a> first ‚Äúnon-empty‚Äù paragraph of each article is determined. <br><br>  One of the main problems was to get rid of the text in brackets.  Since we support more than 300 languages, we had to create localized solutions (not all use the same character set!). <br><br>  Of course, some brackets are extremely important ... border cases everywhere.  I had to think through all the options for the potential use of brackets and how best to deal with them. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/a7d/399/e21/a7d399e21333ccad35411e767cc6529c.png"></div><br>  <i>Sometimes content in brackets is very important, as this example shows.</i>  <i>It is difficult to determine exactly when it is important.</i>  <i><font color="gray">Text from the English-language Wikipedia article on the <a href="https://en.wikipedia.org/wiki/Periodic_table">periodic table of elements</a> , <a href="">CC BY-SA 3.0</a> ;</font></i>  <i><font color="gray"><a href="">Image</a> Offnfopt, public domain.</font></i> <br><br>  Clearing custom HTML brackets has also proven to be rather difficult.  In a text format, you just need a simple regular expression, but it‚Äôs completely different to parse the nested levels of HTML. <br><br>  It was important to make sure that after removing the content in brackets, the content still makes sense - and that we did not add any security vulnerabilities. <br><br>  Thanks to our <a href="https://www.mediawiki.org/wiki/Wikimedia_Reading_Infrastructure_team">infrastructure team</a> for helping to create this API. <br><br><h2>  We work with the community </h2><br>  For the community is very important result.  That is why they write articles for you in their free time without remuneration. <br><br>  We used their help at every stage and worked tirelessly with them, sorting out every border case (be it an incorrect resume or an inappropriate image).  We tried to convince them that the work was proceeding in the right direction, we explained why and why we continue to do this. <br><br>  Our initial version was not good enough.  The community <a href="https://en.wikipedia.org/wiki/Wikipedia:Village_pump_%2528proposals%2529/Archive_131">asked not to release it</a> .  We listened to opinions and tried to improve the preview. <br><br>  Thanks to the community and those users who have helped to establish this communication! <br><br><h2>  Design, design, design </h2><br>  They spent a lot of time on it.  Our designer Nirzar <a href="https://medium.com/freely-sharing-the-sum-of-all-knowledge/how-we-designed-page-previews-for-wikipedia-and-what-could-be-done-with-them-in-the-future-7a5fa6b07b96">wrote an excellent article</a> , so I will not delve too much into this topic here.  But the design work continued at each stage, be it the initial prototypes (thanks, <a href="https://meta.wikimedia.org/wiki/User:Prtksxna">Pratek Saxena</a> !), The discussion of features with the performance team, the improvement of sketches and summaries, or the discussion with the community. <br><br>  Thank you, <a href="https://www.mediawiki.org/wiki/Design">design team</a> ! <br><br><h2>  It was necessary to take measurements </h2><br>  Link preview is a major change in how people interact with content.  We at Wikimedia are very concerned about privacy.  Probably, we are one of the few large sites (the only one ?!) that does not install third-party scripts to track users. <br><br>  Our <a href="https://wikimediafoundation.org/wiki/Privacy_policy">privacy policy</a> prohibits the issuance of visitor data. <br><br>  We do not invite third-party companies to conduct A / B tests or analyze user behavior. <br><br>  Despite all this, we do not cut corners and do not want to make stupid risky changes. <br><br>  Every time we develop something important, we have to build an infrastructure for measuring.  We build hypotheses and tests for the verification of these hypotheses.  We are developing.  We are testing.  We study the data.  Adapt the product.  We are testing again. <br><br>  This means that we combine the responsibilities of development teams and analytics.  Our development team works in several ways.  Given the scale, there are bugs.  Sometimes <a href="https://bugzilla.mozilla.org/show_bug.cgi%3Fid%3D1379762">we find major bugs in browsers</a> . <br><br>  Tilman Bayer's latest A / B test answered many questions.  This is an <a href="https://www.mediawiki.org/wiki/Page_Previews/2017-18_A/B_Tests">entertaining reading</a> ! <br><br>  Considering the results of this A / B test, we decided to add an additional metric for page views - views through the preview.  This metric generates <a href="https://grafana.wikimedia.org/dashboard/db/eventlogging-schema%3ForgId%3D1%26var-datasource%3Deqiad%2520prometheus%252Fops%26var-schema%3DVirtualPageView%26from%3Dnow-7d%26to%3Dnow">1000 events per second</a> , and our <a href="https://wikitech.wikimedia.org/wiki/Analytics">analytics department is</a> working hard, trying to cope with such a scale. <br><br>  Thanks to analysts, thanks to the analytical department! <br><br><h2>  You had to scale the API to support you </h2><br>  Our API processes <a href="https://grafana.wikimedia.org/dashboard/db/reading-web-page-previews%3Frefresh%3D1m%26orgId%3D1%26panelId%3D2%26fullscreen">0.5 million hits per minute</a> . <br><br>  Our API processes <a href="https://grafana.wikimedia.org/dashboard/db/reading-web-page-previews%3Frefresh%3D1m%26orgId%3D1%26panelId%3D2%26fullscreen">0.5 million hits per minute</a> . <br><br>  I wrote it twice because it‚Äôs really big traffic. <br><br>  Our <a href="https://www.mediawiki.org/wiki/API:Main_page">traditional APIs were</a> originally created for bots that clean up your edits.  They were not intended for readers. <br><br>  <a href="https://www.mediawiki.org/wiki/Wikimedia_Services">The Wikimedia service team has</a> proved vital to the success of this project.  She provided the infrastructure, provided a large amount of caching (we rely heavily on <a href="https://en.wikipedia.org/wiki/Varnish_%2528software%2529">Varnish</a> ), and provided guarantees that when editing the content, new resumes are generated.  It is well known that <a href="https://en.wikipedia.org/wiki/Cache_invalidation">cache invalidation</a> is one of the most difficult problems in computer science. <br><br>  Thank you, the service team! <br><br><h2>  Thank you thank you thank you </h2><br>  Any finished business gives a feeling of satisfaction.  I hope you enjoy these ‚Äúsimple‚Äù thumbnails developed by my team with the help of many other teams from around the Wikimedia Foundation. <br><br>  Many were involved in this business - and we are proud of the result. <br><br>  We haven't finished yet.  Software is never complete. <br><br>  We still need to clean up some code and check out <a href="https://medium.com/freely-sharing-the-sum-of-all-knowledge/how-we-designed-page-previews-for-wikipedia-and-what-could-be-done-with-them-in-the-future-7a5fa6b07b96">new ideas</a> that can grow out of this little feature. <br><br>  Someone may say that now we face only the tip of the iceberg. <br><br>  <font color="gray">Original author: <a href="https://blog.wikimedia.org/2018/04/20/why-it-took-a-long-time-to-build-that-tiny-link-preview-on-wikipedia/">Jon Robson</a> ;</font>  <font color="gray">This translation is subject to <a href="https://creativecommons.org/licenses/by/3.0/">CC BY 3.0</a> license.</font> </div><p>Source: <a href="https://habr.com/ru/post/354236/">https://habr.com/ru/post/354236/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../354226/index.html">Another option for generating thumbnails for images using AWS Lambda & golang + nodejs + nginx</a></li>
<li><a href="../354228/index.html">Hyper-v cluster of two nodes, without external storage or hyperconvergence on the knee</a></li>
<li><a href="../354230/index.html">What is wrong with 3D PDF and eDrawings. How do we replace the 3D viewer in our application</a></li>
<li><a href="../354232/index.html">How not to go crazy with Scrum? Experience a growing project</a></li>
<li><a href="../354234/index.html">Release Node.js 10 and NPM 6</a></li>
<li><a href="../354238/index.html">Victor Gamov on Apache Kafka on jug.msk.ru</a></li>
<li><a href="../354240/index.html">Ode to young professionals</a></li>
<li><a href="../354242/index.html">Hi, SaaS | Russian SaaS 2017 - results</a></li>
<li><a href="../354244/index.html">HABR coin</a></li>
<li><a href="../354246/index.html">Bobaos - KNX TP / UART, Raspberry Pi and Unix Domain Socket</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>