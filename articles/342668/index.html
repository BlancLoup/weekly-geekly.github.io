<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>How to write your first Linux device driver. Part 3</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Good evening, habrochityateli! 

 In previous articles ( one , two ) we defined the concept of a character device and wrote the simplest example of a ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>How to write your first Linux device driver. Part 3</h1><div class="post__text post__text-html js-mediator-article">  Good evening, habrochityateli! <br><br>  In previous articles ( <a href="https://habrahabr.ru/post/337946/">one</a> , <a href="https://habrahabr.ru/post/338118/">two</a> ) we defined the concept of a character device and wrote the simplest example of a character driver.  The last part is dedicated to testing its performance.  On Habr√© there are already examples of how to test a driver, for example: <a href="https://habrahabr.ru/post/106702/">tyk</a> . <br><br>  I will try to address this issue in a little more detail, I hope you enjoy it. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <img src="https://habrastorage.org/webt/wz/es/-d/wzes-dyht89f_8g0wnimi3cz9ns.jpeg"><br><a name="habracut"></a><br>  Please, if you have thoughts that you can add / correct, then I am waiting for your comments or letters in PM, thank you. <br><br><h3>  Kernel module assembly </h3><br>  In order to build our module, we need to write a small Makefile.  You can read what a Makefile is here: <a href="https://habrahabr.ru/post/155201/">one</a> , <a href="https://habrahabr.ru/post/211751/">two</a> , <a href="https://habrahabr.ru/post/111691/">three</a> .  I also wrote once an example of a Makefile for students, you can see it here: <a href="https://github.com/A1exrebys/Makefiles/tree/master/subdir_makefiles">click</a> . <br><br>  In short, the Makefile is a set of instructions for the make program, and make is a utility that automates the process of converting files from one form to another.  After a quick acquaintance with the Makefile, you can look at the code: <br><br>  <i>Makefile:</i> <br><br><pre><code class="hljs mel">obj-m += fake.o all: make -C /lib/modules/$(shell uname -r)/build M=$(PWD) modules clean: make -C /lib/modules/$(shell uname -r)/build M=$(PWD) clean</code> </pre> <br>  Let's take a look at the command: <br><br><pre> <code class="hljs mel">make -C /lib/modules/$(shell uname -r)/build M=$(PWD) modules</code> </pre> <br>  It starts with changing the directory (in my case to: /lib/modules/4.4.0-93-generic/build), in this directory are the sources of the kernel, as well as a Makefile that the make utility reads.  The variable M, allows you to specify where our project is located and go back along the path indicated in it.  That is, in fact, we use another Makefile to build our module. <br><br>  We write the make command line and get the output: <br><br><pre> <code class="hljs vhdl">make -C /lib/modules/<span class="hljs-number"><span class="hljs-number">4.4</span></span>.<span class="hljs-number"><span class="hljs-number">0</span></span>-<span class="hljs-number"><span class="hljs-number">93</span></span>-<span class="hljs-keyword"><span class="hljs-keyword">generic</span></span>/build M=/home/alexey/Desktop/drivers/<span class="hljs-built_in"><span class="hljs-built_in">character</span></span> modules make[<span class="hljs-number"><span class="hljs-number">1</span></span>]: Entering directory '/usr/src/linux-headers-<span class="hljs-number"><span class="hljs-number">4.4</span></span>.<span class="hljs-number"><span class="hljs-number">0</span></span>-<span class="hljs-number"><span class="hljs-number">93</span></span>-<span class="hljs-keyword"><span class="hljs-keyword">generic</span></span>' CC [M] /home/alexey/Desktop/drivers/<span class="hljs-built_in"><span class="hljs-built_in">character</span></span>/fake.o Building modules, stage <span class="hljs-number"><span class="hljs-number">2</span></span>. MODPOST <span class="hljs-number"><span class="hljs-number">1</span></span> modules CC /home/alexey/Desktop/drivers/<span class="hljs-built_in"><span class="hljs-built_in">character</span></span>/fake.<span class="hljs-keyword"><span class="hljs-keyword">mod</span></span>.o LD [M] /home/alexey/Desktop/drivers/<span class="hljs-built_in"><span class="hljs-built_in">character</span></span>/fake.ko make[<span class="hljs-number"><span class="hljs-number">1</span></span>]: Leaving directory '/usr/src/linux-headers-<span class="hljs-number"><span class="hljs-number">4.4</span></span>.<span class="hljs-number"><span class="hljs-number">0</span></span>-<span class="hljs-number"><span class="hljs-number">93</span></span>-<span class="hljs-keyword"><span class="hljs-keyword">generic</span></span>'</code> </pre> <br>  After the build, the output is a compiled module fake.ko.  We will load it with the insmod command. <br><br>  Next, you need to perform the following sequence of actions: <br><br><ol><li>  Load module into kernel <br>  Run: <code>sudo insmod fake.ko</code> </li><li>  Check, with the help of the dmesg command, the expected output of the module <br>  Example: <code>scull: register device major = 243 minor = 0</code> </li><li>  Create a file of our device in the file system <br>  Example: <code>sudo mknod /dev/scull c 243 0</code> </li><li>  Change permissions <br>  Example: <code>sudo chmod 777 /dev/scull</code> </li></ol><br>  It remains the case for small, write a small program that allows you to simply read / write data. <br><br><pre> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt;fcntl.h&gt; #include &lt;stdio.h&gt; #include &lt;unistd.h&gt; #define DEVICE "/dev/scull" #define BUFF_SIZE 100 int main() { int fd; char ch, write_buf[BUFF_SIZE], read_buf[BUFF_SIZE]; fd = open(DEVICE, O_RDWR); if (!fd) return -1; printf("r - read, w - write\n"); scanf("%c", &amp;ch); switch (ch) { case 'w': printf("enter data: "); scanf(" %[^\n]", write_buf); write(fd, write_buf, sizeof(write_buf)); break; case 'r': read(fd, read_buf, sizeof(read_buf)); printf("scull: %s\n", read_buf); break; } return 0; }</span></span></span></span></code> </pre><br>  Health Check: <br><br><ol><li>  Compile: <code>gcc test.c -o test</code> </li><li>  Call the executable file: ./test </li><li>  Write to the device: <code>Hello world!</code> </li><li>  Call the executable again: ./test </li><li>  Read the data: <code>scull: Hello world!</code> </li></ol><br>  This completes the testing of a simple symbolic driver, now you can come up with a new functionality, implement and test yourself by yourself :) <br><br>  At the end of the previous article I conducted a survey, I want to say thanks to everyone who took part in it!  Soon I will start writing about the process of porting device drivers from one kernel version to another. <br><br>  PS If you find inaccuracies in the article, I will wait for your messages, thank you! </div><p>Source: <a href="https://habr.com/ru/post/342668/">https://habr.com/ru/post/342668/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../342644/index.html">Gorgeous assholes in the making</a></li>
<li><a href="../342654/index.html">Self-oscillations and resonance</a></li>
<li><a href="../342658/index.html">What happens in Kubernetes when starting the kubectl run? Part 1</a></li>
<li><a href="../342660/index.html">UniRx - Rx for Unity3d</a></li>
<li><a href="../342666/index.html">Facebook or Google? Where it is more profitable to advertise in 2017</a></li>
<li><a href="../342670/index.html">The experience of identifying one bug or how not to make out your code</a></li>
<li><a href="../342674/index.html">About the rotation matrix in simple words</a></li>
<li><a href="../342676/index.html">Detailed analysis of the crackme01_x64 solution</a></li>
<li><a href="../342680/index.html">‚ÄúLike a ram on a new gate‚Äù or custom ‚Äúpseudo-3D‚Äù objects in NanoCAD using the MultiCAD.NET API</a></li>
<li><a href="../342684/index.html">Glass brick fences, online translator plot, remote Boeing hacking</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>