<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Analytical data outside Wrike analytics</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Date engineer in anticipation of the task at the park. 


 Over the years of Wrike development, we have accumulated a lot of scattered information abo...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Analytical data outside Wrike analytics</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/files/d51/7b7/aa3/d517b7aa3f7842dca459c12d208788f1.jpg"><br><p>  <em>Date engineer in anticipation of the task at the park.</em> </p><br><p>  Over the years of Wrike development, we have accumulated a lot of scattered information about user actions.  This information is scattered across several databases, logs, and external services, and we, analysts, need to gather these data together, find patterns in them and find answers to the eternal <strong>SaaS questions</strong> : </p><br><ul><li>  <em>Why do customers leave?</em> </li><li>  <em>What users bring us money?</em> </li><li>  <em>How to develop the product further?</em> </li></ul><br><p>  Most of the tasks we solve using SQL, but queries to the logs via SQL are cumbersome and slow.  They can be used for automation or detailed analytics, but if you need to quickly look at something, it will take longer to prepare data than to analyze. </p><br><p>  If you have to look a lot and often, it causes pain, in this article we will describe how to overcome it and how to extract the maximum benefit from the data obtained. </p><a name="habracut"></a><br><h2 id="nashe-reshenie">  Our solution </h2><br><p>  We keep in logs information about what action the user took and the characteristics of this action.  If the user chooses a subscription, then we log the following events: </p><br><ul><li>  <em>User A came to the page and we offered him a business subscription.</em> </li><li>  <em>User A has chosen a subscription for Marketers, this is not the one we have proposed.</em> </li></ul><br><p>  To turn it into a SQL-friendly form, you need to come up with metrics for these logs and find the dimensions by which we will group these metrics. </p><br><p>  We chose <strong>time</strong> and user <strong>ID</strong> as measurements. </p><br><p>  Time - because we follow the changes in the values ‚Äã‚Äãof metrics. <br>  User ID - because it is in almost all logs, and information on it is easy to aggregate.  If we sum up the metrics of all users in the account, we get account activity. </p><br><p>  Metrics are the questions we ask to extract information from the logs.  Determine them more difficult.  Depending on what we are interested in, these questions will change: </p><br><ul><li>  <em>If we want to estimate the number of users who bought each of the subscriptions, we will ask: ‚ÄúHow many users bought a business subscription?‚Äù ‚ÄúHow many users bought a subscription for marketers?‚Äù.</em> </li><li>  <em>If we want to evaluate conversion, then we ask: "How many people saw this form?", "How many people chose a plan on this form?"</em> </li></ul><br><p>  If we study in detail the structure of the application, ask all the important questions and extract answers to them in the logs, we will get the following structure: </p><br><pre><code class="hljs ruby">user_id<span class="hljs-params"><span class="hljs-params">|date|</span></span>   ?<span class="hljs-params"><span class="hljs-params">|     ?|</span></span>...</code> </pre> <br><p>  But it‚Äôs impossible to guess right away with all the questions, and it‚Äôs important to keep the possibility of adding new metrics and recalculating old ones. </p><br><p>  We combine all metrics, group them by user ID, enrich them with measurements: country, user locale, how many people are in his account, whether this account pays us money.  And we load it into an orc-table in PostgreSQL. </p><br><p>  The structure of this table is as follows: </p><br><pre> <code class="hljs smalltalk">user_id|date|metric1|metric2|metric3|metricN|dimension1|dimension2|dimensionN</code> </pre> <br><p>  Behind this table is an infrastructure that helps analysts get rid of routine tasks and better understand the product.  We call this internal product a <strong>‚Äúuser data mart‚Äù</strong> . </p><br><h2 id="kak-eto-pomogaet-analitikam">  How does this help analysts? </h2><br><p>  We have put together scripts for processing logs and tables from backend.  Previously, analysts kept them themselves, shared the scripts manually, copied and corrected each time in a new way. </p><br><p>  When we made the showcase, we wanted it to be expandable, easy for analysts and to have thoughtful naming.  We wanted all the metrics we create to be accessible both to analysts - in the post-press and to those who want to analyze the data on their own - through the scoreboard.  And most of all we wanted to collect enough data to make the product smarter. </p><br><h4 id="vitrina-rasshiryaema">  Showcase expandable </h4><br><p>  To make the data warehouse extensible, we have made a system of modules. <br>  A module is a python code that tells you how to get the following structure from input data: </p><br><pre> <code class="hljs lisp">(<span class="hljs-name"><span class="hljs-name">user_id</span></span>, {metric_1_key: metric_1_value, metric_2_key: metric_2_value})</code> </pre> <br><p>  In addition to this script, we declare dependencies in the module, write default values ‚Äã‚Äãand descriptions for metrics before and after aggregation. </p><br><p>  We consider modules independently of each other, and if an error occurs in a module, we fill this module with default values ‚Äã‚Äãand write to a specially-trained table that this module was considered incorrect.  Error in a separate module does not affect the system as a whole. </p><br><p>  We try to put modules together according to the principle of <a href="http://butunclebob.com/ArticleS.UncleBob.PrinciplesOfOod">Single Responsibility</a> : only the code that changes for one reason must be in the same module.  The module can work with different logs and databases.  The input to the module is received by non-toll data structures, it cannot spoil the data, and, as long as it does not greatly affect the performance, anything can happen in it. </p><br><p>  How exactly we are developing these modules and what difficulties we have encountered, I will tell in the next article. </p><br><h4 id="vitrina--prostaya-dlya-analitikov">  Showcase - easy for analysts </h4><br><p>  We wanted with the help of the storefront any person who possesses the skills of Python or SQL could add several new metrics, even if he is not an analyst, but a developer who implements the log specification or a tester who wants to better understand the product. </p><br><p>  From this point of view, the python seemed to be the ideal solution: there is a simple programming language and <a href="http://pandas.pydata.org/">Pandas</a> with data frames and PandasSQL.  The solution seemed ideal because not all analysts know and love python, but everyone knows how to work with SQL or data frames. </p><br><p>  True, Pandas worked terribly slowly on large amounts of data, and as the number of modules increased, the execution speed grew exponentially.  Now we have switched to Spark data frames and Spark SQL, got rid of unnecessary deserialization of data, now new modules do not slow down the showcase so much and we even know how to optimize them further. </p><br><h4 id="v-vitrine-produmannyy-neyming">  In the showcase thoughtful naming </h4><br><p>  We wanted the name of the metrics to be unique for similar metrics, even when there were many.  Now we have 750 metrics, every month we add 50 new ones.  And while never faced the intersection of names. </p><br><p>  The name of the metric consists of seven parts: </p><br><ol><li>  <strong>entity</strong> is the entity to which this metric belongs: <br>  <em>act</em> (activity), <em>search</em> (search), <em>i</em> (integration). </li><li>  <strong>event</strong> - what happened? <br>  <em>btn_clckd</em> (clicked on the button), <em>dashb_open</em> (opened the dashboard) </li><li>  <strong>source</strong> - in which application? <br>  <em>ws</em> (workspace, our web application), <em>andr</em> (android), <em>ios</em> ('nough said), <em>x</em> (no matter what). </li><li>  <strong>path</strong> - in which part of the application did the action occur? <br>  For example, editing a task could occur after a search <em>search</em> or on dbord <em>dashboards.</em> </li><li>  <strong>measure</strong> - what action do we use for aggregation? <br>  <em>sum, flg, str (string concatenation), json (describe the events in json).</em> </li><li>  <strong>unit</strong> - what is the unit of measurement? <br>  we can summarize the number of <em>ev</em> events <em>, the</em> number of tasks <em>t</em> or <em>usrs</em> users </li><li>  <strong>details</strong> - something else? <br>  if the same events can be counted differently or read from different logs, you should indicate this here. </li></ol><br><p>  In fact, the names of metrics look like this: </p><br><p>  <strong><code>entity__event__source__path__measure__unit__details</code></strong> - we divide the components (tickers) with two underscores, and the words are one, if part of the description does not apply to the metric put X, for example: </p><br><p>  <code>view__reports_open__ws__x__cnt__ev__x</code> - the number of events for opening a <code>view__reports_open__ws__x__cnt__ev__x</code> view from a web application (read better from the end). </p><br><p>  <code>act__assignment__x__user__flg__fct__non_self_assignment</code> is a fact-metric: if the user is asynil of another user, we write 1, otherwise 0. Such metrics are perfectly aggregated by account or by dimshchenam. </p><br><p>  Do not be afraid of abbreviations, we have a special dictionary that decodes them, and people work with human names. </p><br><p>  We did not immediately come to this naming.  At first we tried to make a showcase with fewer tickers, but we made a mistake and we had to rename a huge number of metrics with our hands.  These alterations touched most analysts, a lot of time was wasted, and we raked the consequences for a long time later. </p><br><h4 id="i-kak-uspehi">  And how are you doing? </h4><br><p>  Now we have 22 modules, which were written by 7 people (this is more than twice the command that supports this showcase). </p><br><p>  Not a single release of a big feature is complete without adding a module to this showcase, and we are getting more and more benefit from this data. </p><br><h2 id="kak-eto-pomogaet-nashim-kollegam">  How does this help our colleagues? </h2><br><p>  We collected a lot of useful data in one place and wanted to give access to interested people, bypassing analysts.  To do this, we made an automatically updated dashboard in Tableau Online.  It is not familiar with programming people can aggregate metrics, cut into dimensions and answer questions about the use of products, for example: </p><br><p>  ‚ÄúHow many paid users are registered with android?‚Äù - you can see the number of registrations on android and filter free users. </p><br><p>  ‚ÄúI found a bug in IE, how many users might have encountered it?‚Äù - you can see on a separate dashboard, how many people use each version of IE. </p><br><p>  ‚ÄúHow many times did you click on this button?‚Äù - you can ask to shake this button and add this event to the showcase. </p><br><p>  To implement these dashboards, we chose <a href="https://www.tableau.com/">Tableau</a> .  We actively use it for dashboards in analytics and decided that for this task Tableau would also be suitable.  In it, we made a dashboard, which automatically gets part of the metrics from the custom storefront. </p><br><p>  We continue to talk about this dashboard to our colleagues and help us understand that analytics is simple.  If someone has a product hypothesis, he can test it quantitatively in this dashboard. </p><br><h3 id="kak-my-rabotaem-s-tablo">  How do we work with the scoreboard? </h3><br><p>  We did not manage to use in the display the scheme from the database in its original form, because: </p><br><ul><li>  You cannot automatically change the names of the columns in the graphs; </li><li>  You cannot use parts of a column name to filter metrics; </li><li>  The functionality of the Measure Values ‚Äã‚Äãand Measure Keys objects is limited and we never managed to automatically add new metrics to them; </li></ul><br><p>  We solved these problems with the help of <a href="https://en.wikipedia.org/wiki/Entity%25E2%2580%2593attribute%25E2%2580%2593value_model">EAV</a> , that is, we turned the table into the form: </p><br><ul><li>  <strong>Day</strong> ; </li><li>  <strong>User ID</strong> ; </li><li>  <strong>The name of the metric;</strong> </li><li>  <strong>The full name of the metric is greater than 63 characters (postgrese limit);</strong> </li><li>  <strong>Metric value;</strong> <br>  On it we build the schedule </li><li>  <strong>Information about the metric;</strong> <br>  To find the metric </li><li>  <strong>Information about the user and his account;</strong> <br>  We cut the graphics on them </li></ul><br><p>  In order to be able to filter and build graphs in the scoreboard, we calculated the aggregated metrics for all combinations of user information values.  If we have two dimensions: a country (Russia or United States) and an account type (paid or free), we aggregate the metrics for all combinations of these values, for each metric we get 4 lines: </p><br><ul><li>  For free from Russia; </li><li>  For paid from Russia; </li><li>  For free from the USA; </li><li>  For paid from the USA. </li></ul><br><p>  Even if there are zeros on these intersections, we do not miss this combination, otherwise it will be impossible to build a graph or there will be gaps on it. </p><br><p>  But we want to filter more than two dimensions.  Because of this, our scoreboard tables are huge, and our scoreboards in the scoreboard are quite slow. </p><br><p>  Moreover, to transfer data to Tableau Online, you need to turn Spark Dataframe into Tableau Data Extract using a library with outdated documentation, and you can only send data to the Tableau Online server using Windows, but these are little things in life, we decided to do it once and forgot. </p><br><h2 id="chto-eto-dalo-kompanii">  What did this give the company? </h2><br><p>  The coolest thing in this data storage format is that they can be analyzed automatically. </p><br><p>  We are looking for anomalies in these metrics.  This gives us the opportunity to monitor the use of all features every day, even if they are not interesting for analysts and product managers and have not been updated for a long time. </p><br><p>  All the benefits can be traced in our last study: <br>  If we predict the outflow of users on this data, we will be able to understand what factors influence it. <br>  If we understand what factors affect - we can better prioritize accounts that do not receive all the benefits of the product and who need support. <br>  If we understand that the model accurately identifies such accounts - we can make support cheap or even free, that is, we will increase the value of the product and save our colleagues from the routine. <br>  If we continue to make expensive things cheap, we will make an intellectual product that adapts itself to the client‚Äôs tasks. </p><br><p>  We have many plans for how to use this data: </p><br><ul><li>  better prioritize leads; </li><li>  Consider user activity in optimizing marketing and onboarding; </li><li>  better understand the outflow of users; </li><li>  better understand product use scenarios; </li><li>  better understand what attracts users; </li><li>  personalization of recommendations to users and accounts. </li></ul><br><p>  In the next article I will tell you how it all works, I will more deeply plunge into compromises in the development of such systems, and I will tell you about the rake and the successful solutions that we have collected along the way. </p><br><p>  <em>The picture in the beginning - a frame from the movie "She" Spike Jones.</em> </p></div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <p>Source: <a href="https://habr.com/ru/post/322366/">https://habr.com/ru/post/322366/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../322352/index.html">As I made the fastest resize of images. Part 1, general optimizations</a></li>
<li><a href="../322354/index.html">Manage application state with Vuex</a></li>
<li><a href="../322360/index.html">Interesting features of Python, which you could not guess</a></li>
<li><a href="../322362/index.html">Red Hat acquires 3scale, which develops API management systems, and intends to open source code of products</a></li>
<li><a href="../322364/index.html">RTM Cybergroup specializes in stealing funds from Russian companies</a></li>
<li><a href="../322368/index.html">CSS for Swift: using styles for any subclass of UIView</a></li>
<li><a href="../322370/index.html">Genetic Algorithms and Turing Machine</a></li>
<li><a href="../322372/index.html">We write simple DSL on Kotlin in 2 steps</a></li>
<li><a href="../322374/index.html">Three-letter service quality</a></li>
<li><a href="../322376/index.html">Elixir and Angular 2 without Hello, world !, or Implementing work with the tree directory, part 1</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>