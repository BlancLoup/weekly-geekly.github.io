<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Star Wars in source code</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="I have long had the idea to implement something interesting related to quineas. And finally it turned out to bring this thing to the end. I once saw t...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Star Wars in source code</h1><div class="post__text post__text-html js-mediator-article"><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/57d/e67/628/57de6762827e000614ac24b327dbf6a7.png"></div><br>  I have long had the idea to implement something interesting related to quineas.  And finally it turned out to bring this thing to the end.  I once saw the implementation of the game "Life" in the source code: <a href="http://igoro.com/archive/self-printing-game-of-life-in-c/">Self Printing Game of Life</a> and I wanted to do something similar.  After some thought, I remembered that there are <a href="http://ru.wikipedia.org/wiki/ASCII-%25D0%25B3%25D1%2580%25D0%25B0%25D1%2584%25D0%25B8%25D0%25BA%25D0%25B0">ASCII graphics</a> .  But it would be even more interesting and more difficult to make animation in ASCII graphics.  It did not take long to find an example, almost immediately the Star Wars animation was found, more precisely, 4 episodes of ‚ÄúNew Hope‚Äù called <a href="http://asciimation.co.nz/">Asciimation</a> .  The work of the Japanese programmer Yusuke Endoh <a href="https://github.com/mame/quine-relay">"Quine Relay"</a> also spurred me to implement this idea.  In the process of implementing such a ‚Äúfilm‚Äù, many other problems had to be solved, which, however, was not to be regretted. <br><br>  The resulting source is: <a href="https://gist.github.com/KvanTTT/061e2a2ecebcfd8bc246">gist</a> .  To make it easier to ‚Äúview,‚Äù it also contains a script that will twist the entire animation.  The sources of the entire project for its generation, the interface and other utilities are laid out on the githaba: <a href="https://github.com/KvanTTT/Freaky-Sources">Freaky-Sources</a> (The quine-palindromes, which I already <a href="http://habrahabr.ru/post/189192/">wrote</a> about, are included there).  It is clear that such a thing does not carry any practical benefits, it is just just for fun. <br><a name="habracut"></a><br><h4>  Introduction </h4><br>  Animation in a quine can only be output in one way: output each subsequent frame to the console at each compilation.  Accordingly, the speed of the ‚Äúmovie‚Äù in this case depends on the size of the code (the larger the code, the longer it will compile and flip through the console), the decompression algorithm, the compilation speed (of iron).  Moreover, the code is mainly occupied by compressed animation frames. <br><br>  The aforementioned ‚ÄúGame of Life‚Äù uses strings as the field, which are initialized and displayed at the beginning of the program source code.  Such an approach is valid if the amount of code is small, and it will always be visible during the compilation process.  However, in my case, the code size is a few hundred kilobytes, and therefore frames must be output at the end so that they can be seen.  It was decided to display the frames not in the form of real lines, but in the form of single-line comments (multi-line ones can also be used), which made it possible to output them without unnecessary tail characters (the final curly bracket) and quotes. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Since <s>I have a low IQ,</s> I do not have special abilities and cannot operate with a large number of parameters in my head, I decided to automate the process of writing a quine to the maximum.  In addition, it allowed for a better understanding of the Quine structure and gaining experience in related fields (parsing and processing C # source code using the NRefactory). <br><br><h4>  Quine generation stages </h4><br>  Thus, I decided to break the process of writing any quine into the following steps: <br><ul><li>  Code generation </li><li>  Data generation </li><li>  Code Minification. </li><li>  Formatting code. </li><li>  Quine generation </li></ul><br>  All these steps are performed for a specially crafted template.  By ‚Äúcode,‚Äù as applied to star wars, is meant a code that unpacks compressed data.  And the data is the packed array of animation frames.  Minification is needed to <s>make the code unreadable to</s> reduce the text size of the code. <br><br>  The truth is, at the beginning, a version with the usual .NET GZipStream class was written to decompress the compressed data.  But I thought it was not sporty, and besides, such a class exists only for this platform.  Thus, I wrote a more complex version with my own archiver. <br><br>  In order to make it easier to navigate in these stages, I wrote the interface on WinForms. <br> <a href=""><img src="https://habrastorage.org/getpro/habr/post_images/b8a/c06/48c/b8ac0648c4b4e0ea984a4a89254c898d.png"></a> <br><br><ul><li>  At the top left there is a text field in which a quine template with all markers is entered.  Their purpose is discussed below.  The first four stages are performed in this field. </li><li>  At the bottom left are various parameters and buttons for performing the above steps.  Also, the code of the template or the resulting Quine can be immediately checked for errors using compilation. </li><li>  At the top right of the field, which is filled with the quine code, generated at the last stage. </li><li>  At the top right of the field, the next iteration of the Quine is displayed after compilation.  Also, the ‚ÄúConsole Output -&gt; Output‚Äù button with the number of iterations is needed in order to loop the Quine compilation process and see the frame-by-frame animation (well, or something else). </li></ul><br><br>  To highlight C # syntax, the <a href="https://habr.com/users/bigobfuscator/" class="user_link">BigObfuscator</a> <a href="https://github.com/PavelTorgashov/FastColoredTextBox">FastColoredTextBox</a> component <a href="https://habr.com/users/bigobfuscator/" class="user_link">was</a> <a href="https://github.com/PavelTorgashov/FastColoredTextBox">used</a> .  Unfortunately, it works rather slowly, so the resulting ‚Äúmovie‚Äù is more convenient to look through a regular console (although it, unfortunately, is also not very fast). <br><br><h5>  Quine template </h5><br>  The template is the starting point of such a complex quine, and it may look like this: <br><div class="spoiler">  <b class="spoiler_title">Quine template</b> <div class="spoiler_text"><pre><code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">using</span></span> System; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> System.Text; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> System.Collections.Generic; <span class="hljs-keyword"><span class="hljs-keyword">namespace</span></span> <span class="hljs-title"><span class="hljs-title">Asciimation_1_3</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">Program</span></span> { <span class="hljs-comment"><span class="hljs-comment">/*#Asciimation_1_3*/</span></span> <span class="hljs-comment"><span class="hljs-comment">/*Asciimation_1_3#*/</span></span> <span class="hljs-comment"><span class="hljs-comment">/*#DecodeBase64*/</span></span> <span class="hljs-comment"><span class="hljs-comment">/*DecodeBase64#*/</span></span> <span class="hljs-comment"><span class="hljs-comment">/*#HuffmanTree*/</span></span> <span class="hljs-comment"><span class="hljs-comment">/*HuffmanTree#*/</span></span> <span class="hljs-comment"><span class="hljs-comment">/*#HuffmanRleDecode2*/</span></span> <span class="hljs-comment"><span class="hljs-comment">/*HuffmanRleDecode2#*/</span></span> <span class="hljs-comment"><span class="hljs-comment">/*#Enums*/</span></span> <span class="hljs-comment"><span class="hljs-comment">/*Enums#*/</span></span> <span class="hljs-comment"><span class="hljs-comment">/*#Utils*/</span></span> <span class="hljs-comment"><span class="hljs-comment">/*Utils#*/</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> Data = <span class="hljs-comment"><span class="hljs-comment">/*%Data_1_3*/</span></span><span class="hljs-string"><span class="hljs-string">""</span></span><span class="hljs-comment"><span class="hljs-comment">/*Data_1_3%*/</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> CurrentFrame = <span class="hljs-comment"><span class="hljs-comment">/*$CurrentFrame*/</span></span><span class="hljs-number"><span class="hljs-number">0</span></span><span class="hljs-comment"><span class="hljs-comment">/*CurrentFrame$*/</span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Main</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> output = Decompress_v_1_3(Data, CurrentFrame++); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (CurrentFrame == <span class="hljs-number"><span class="hljs-number">3591</span></span>) CurrentFrame = <span class="hljs-number"><span class="hljs-number">3590</span></span>; <span class="hljs-comment"><span class="hljs-comment">/*$@$*/</span></span> } } } <span class="hljs-comment"><span class="hljs-comment">/*$Output_1_3$*/</span></span></code> </pre> <br></div></div><br>  As you can see, in the above code a bunch of incomprehensible comments.  But in reality, they are <b>markers</b> that indicate where a particular code or data should be inserted.  The advantage of this approach is that the code can be inserted from other full versions of classes, and they, in turn, can be tested (I use NUnit).  I classified these markers as follows: <br><br><ul><li>  <b>/*#...*/‚Ä¶ /*...#*/ - Code.</b>  Code sections between these markers are searched for files from the specified directory. </li><li>  <b>/*%...*/‚Ä¶ /*...%*/ - Data.</b>  Between these markers, data generated using certain methods is inserted, which should be presented in string form (well, a regular string, an array of strings, an array of bytes, integers, etc.).  Generally speaking, you can retrieve information about a method from data markers, look for it in a compiled assembly, and call it using reflection.  But I have decided so far to limit myself to manually calling the necessary methods, because this is a more universal approach (it is easier to port into other languages). </li><li>  <b>/*$...*/‚Ä¶ /*...$*/ - Options.</b>  These markers indicate the code that changes with each subsequent iteration of the Quine display.  They are indicated in a special table, in which the replacement code is indicated.  In this case, the parameters are the current frame number (it is incremented each time) and the frame output field at the bottom, implemented using single-line comments.  Some parameters are <b>introns</b> , i.e.  lines that do not affect the code in the next iteration.  In this case, the intron is an output field. </li><li>  <b>/ * @ * / - Print.</b>  This is a special marker into which the code itself is inserted to output the entire quine.  It exists only in a single instance.  Replacement occurs at the very end, after generating the code and data in the previous steps.  It is important to note that in order to prevent duplication of the data section (in order not to print them in the quine itself and in this line), at this stage there is a replacement not on the data itself, but on the parameters (i.e. instead of "asdf" contained in output, output '' '+ output +' "'). </li></ul><br><br>  Thus, combining information about the stages and markers, you can build the following graphical scheme: <br><img src="https://habrastorage.org/getpro/habr/post_images/326/131/5fe/3261315fe0c3b5f05d08f5c52e87ed94.png"><br>  It is worth noting that the minifier leaves the parameters of the quine itself unchanged, otherwise a situation will arise in which the parameter will be assigned a different name, and because of this, the quine will not compile or will output what is not necessary.  (True, the parameters are still minified, but in a more cunning way). <br><br>  More details about all the stages listed below. <br><br><h5>  Code generation </h5><br>  When generating the code, all source files from the specified folder are analyzed.  And the code between the markers / <b>* # ... .. * / ... / * ... ... # * / is</b> copied to the appropriate places in the original template.  For example, in the following example, the HuffmanRle2 class is entirely copied to the area between <b>/ * # HuffmanRleDecode2 * // * HuffmanRleDecode2 # * /</b> .  In order to ignore some code fragments inside these markers (for example, .ToString () methods are not needed in Quine, they are needed for debugging) and not to split this fragment into two, markers were entered <b>/ * # Ignore * // * Ignore # * /</b> , which allow you to ignore all the code inside them. <br><br><div class="spoiler">  <b class="spoiler_title">An example of markers in the source code</b> <div class="spoiler_text"><pre> <code class="cs hljs"><span class="hljs-comment"><span class="hljs-comment">/*#HuffmanRleDecode2*/</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">HuffmanRle2</span></span> { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">byte</span></span></span><span class="hljs-function">[] </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Decode</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">HuffmanTree tree, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">byte</span></span></span></span><span class="hljs-function"><span class="hljs-params">[] bytes, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">ref</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> curBit, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> bytesCount, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> bitsCountPerRepLength = </span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">8</span></span></span></span><span class="hljs-function"><span class="hljs-params">, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> bitsCountPerNotRepLength = </span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">8</span></span></span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> minLength = Math.Min(bitsCountPerRepLength, bitsCountPerNotRepLength); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> maxCount = <span class="hljs-number"><span class="hljs-number">1</span></span> &lt;&lt; (minLength - <span class="hljs-number"><span class="hljs-number">1</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> root = tree.Root; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> result = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> List&lt;<span class="hljs-keyword"><span class="hljs-keyword">byte</span></span>&gt;(bytes.Length * <span class="hljs-number"><span class="hljs-number">2</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> curBytesCount = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> i = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (curBytesCount &lt; bytesCount) { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> length = Utils.GetInt(bytes, <span class="hljs-keyword"><span class="hljs-keyword">ref</span></span> curBit, minLength); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ((length &amp; maxCount) == <span class="hljs-number"><span class="hljs-number">0</span></span>) { curBit -= minLength; length = Utils.GetInt(bytes, <span class="hljs-keyword"><span class="hljs-keyword">ref</span></span> curBit, bitsCountPerRepLength); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> repeatCount = length + <span class="hljs-number"><span class="hljs-number">2</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">byte</span></span> <span class="hljs-keyword"><span class="hljs-keyword">value</span></span> = Utils.GetValue(root, bytes, <span class="hljs-keyword"><span class="hljs-keyword">ref</span></span> curBit); <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> j = <span class="hljs-number"><span class="hljs-number">0</span></span>; j &lt; repeatCount; j++) { result.Add(<span class="hljs-keyword"><span class="hljs-keyword">value</span></span>); curBytesCount++; } } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { curBit -= minLength; length = Utils.GetInt(bytes, <span class="hljs-keyword"><span class="hljs-keyword">ref</span></span> curBit, bitsCountPerNotRepLength); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> notRepeatCount = (((<span class="hljs-number"><span class="hljs-number">1</span></span> &lt;&lt; (bitsCountPerNotRepLength - <span class="hljs-number"><span class="hljs-number">1</span></span>)) - <span class="hljs-number"><span class="hljs-number">1</span></span>) &amp; length) + <span class="hljs-number"><span class="hljs-number">1</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> j = <span class="hljs-number"><span class="hljs-number">0</span></span>; j &lt; notRepeatCount; j++) { <span class="hljs-keyword"><span class="hljs-keyword">byte</span></span> <span class="hljs-keyword"><span class="hljs-keyword">value</span></span> = Utils.GetValue(root, bytes, <span class="hljs-keyword"><span class="hljs-keyword">ref</span></span> curBit); result.Add(<span class="hljs-keyword"><span class="hljs-keyword">value</span></span>); curBytesCount++; } } i++; } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> result.ToArray(); } } <span class="hljs-comment"><span class="hljs-comment">/*HuffmanRleDecode2#*/</span></span></code> </pre><br></div></div><br>  Although the code collected from different files may not be optimal from the point of view of the criterion of the minimum length, since  it was written in the standard style, however, this approach allowed us to write and run tests (NUnit) for compressing and extracting Quine data immediately before its generation, which simplifies the development process and makes it less tedious.  Although code minification, which is described below, allows to virtually neutralize the disadvantage of this approach. <br><br><h5>  Data generation </h5><br>  The data compression used the simplest lossless compression algorithms, such as RLE and Huffman coding.  However, this animation, like any movie, can be divided into main and intermediate frames.  Intermediate frames contain information that has changed since the last frame, while the main frames contain all information about the frame.  Thus, in order to get all the intermediate frame characters, you must decode all previous frames to the main frame, and then render all frames to the current frame, taking into account the changes received.  It turned out such a pseudo-MPEG.  The structure of the main and intermediate frames is presented below.  In addition to normal and intermediate frames, I decided to also include intermediate frames obtained by shifting to the left, right, up and down, since they are not so rare. <br><br>  <b>Frame:</b> <br>  0..3 - type: <br><ul><li>  000 - base: <br>  3..13 - chars count <br>  13 ... - huffman rle codes </li><li>  001 - left: <br>  010 - top: <br>  011 - right: <br>  100 - bottom: <br>  101 - changed: <br>  3..10 - changes count <br>  10 ... - changes </li></ul><br>  <b>Change:</b> <br>  0..2 - type: <br><ul><li>  00 - one char: <br>  2..12 - position <br>  12 ... - huffman code </li><li>  01 - line horizontal: <br>  2..12 - position <br>  12..19 - chars count <br>  19 ... - huffman codes </li><li>  10 - line vertical: <br>  2..12 - position <br>  12..16 - chars count <br>  16 ... - huffman codes </li></ul><br><br>  Unfortunately, the final compression was not as big as we would like, but quite acceptable.  And I would like to at the level of lzma in 7-zip, i.e.  less than 100 Kb.  Most likely, with the help of more advanced methods (interval coding, vocabulary methods), an even greater degree of compression could be achieved. <br><br><a name="code-minification"></a><br><br><h5>  Code Minification </h5><br>  Minification is needed in order to reduce the size of the code in text format.  For processing C # code, the <a href="https://github.com/icsharpcode/NRefactory">NRefactory</a> library was <a href="https://github.com/icsharpcode/NRefactory">used</a> .  Its advantage over Roslyn is that the parse tree can be modified in the process, which is required in the task of the minifator. <br><br><h6>  The shortening of the names of classes, methods, fields, local variables </h6><br>  The most important task of the minifier was precisely this stage.  To bypass the constructed syntactic tree, the ‚ÄúVisitor‚Äù pattern was used, implemented as an overload of the necessary methods of traversing the nodes during a depth crawl. <br><br>  In order to use the minimum number of identifiers on the one hand, and on the other, so that they do not overlap and do not lead to compilation errors, the shortening algorithm was divided into the following steps: <br><ul><li>  <b>Minification of local variables.</b>  At this stage, the list of all names of <i>local variables</i> , the <i>arguments of the methods</i> from their definitions and the corresponding nodes in the tree are aggregated.  Each variable is associated with a specific method.  After that, for each old identifier within one method, a new one is replaced. </li><li>  <b>Minification of member types.</b>  At this stage, the list of all names of <i>fields</i> , <i>methods</i> , <i>properties</i> , <i>enumeration members</i> , <i>events</i> and corresponding nodes in the tree is aggregated.  Each member is associated with a specific type ( <i>class</i> , <i>structure</i> , <i>interface</i> ).  After that, for each old identifier within the same type, a new one is replaced. </li><li>  <b>Type name minification.</b>  At this stage, the list of all type names ( <i>classes</i> , <i>structures</i> , <i>interfaces</i> ) and the corresponding nodes in the tree are aggregated.  After that, each name is replaced with a new one. </li></ul><br><br>  To generate substitutions, a class is used that can generate either minimal identifiers or random ones.  This project uses the first option.  When generating a replacement at each stage, any identifier names are ignored (so that there are no intersections and potential errors). <br><br>  It is worth noting that the library supports ignored identifiers, i.e.  those that for some reason should not be shortened, which is used in this project (Quine parameters). <br><br>  To obtain a list of all references to used identifiers (Find All References in Visual Studio), the NRefactory mechanism is used.  To do this, you first need to compile the tree (at each stage: local variables, type members, types): <br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> unresolvedFile = SyntaxTree.ToTypeSystem(); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> projectContent = projectContent.AddOrUpdateFiles(_unresolvedFile); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> compilation = projectContent.CreateCompilation(); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> resolver = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> CSharpAstResolver(_compilation, SyntaxTree, _unresolvedFile);</code> </pre><br><br>  Then you can search for links as follows: <br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> resolveResult = resolver.Resolve(node); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> findReferences = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> FindReferences(); ... findReferences.FindLocalReferences(); ... findReferences.FindReferencesInFile();</code> </pre><br><br><h6>  Other minification </h6><br>  The following small minifikatsii were also implemented: <br><ul><li>  Deleting the <b>private</b> keyword </li><li>  Removing namespaces </li><li>  Reduction of variable initialization expressions: <br><ul><li><pre> <code class="plaintext hljs">List&lt;byte&gt; a = new List&lt;byte&gt;() -&gt; var a = new List&lt;byte&gt;()</code> </pre> </li><li><pre> <code class="plaintext hljs">var a = new b() -&gt; ba = new b()</code> </pre> </li></ul><br>  Note: this replacement can be performed using the template search described in the article: <br>  <a href="http://www.codeproject.com/Articles/408663/Using-NRefactory-for-analyzing-Csharp-code">Using NRefactory for analyzing Csharp code</a> <br></li><li>  Remove curly braces with only one expression inside: <code>if (a) { b; } =&gt; if (a) b;</code> <code>if (a) { b; } =&gt; if (a) b;</code> </li><li>  The abbreviation of the comparison entry with a boolean type: <code>if (a == true) =&gt; if (a); if (a == false) =&gt; if (!a)</code> <code>if (a == true) =&gt; if (a); if (a == false) =&gt; if (!a)</code> </li><li>  Deleting regions and comments. </li></ul><br><br><h6>  Remove whitespace and line breaks </h6><br>  After all kinds of minifikatsii made, from the code it remains to remove only extra whitespace characters and translations, and so that the length of the lines does not exceed a certain value (for beauty). <br><br>  Minifiers implemented a separate project and it can be downloaded here: <a href="https://github.com/KvanTTT/CSharp-Minifier">CSharp-Minifier</a> .  It was primarily developed with the aim of shortening the code in quineas, so there is nothing surprising in the fact that it has some strange functionality.  However, I will gladly accept your comments and / or pull-ricksta. <br><br><h5>  Code formatting </h5><br>  At this stage, the minified code can be brought to mind so that it looks like some kind of picture.  Formatting goes exactly after the minification, because the generated code is basically an array of single characters (they can be broken), from which it is easier to build a picture.  The picture should have only black and white format, so that the symbol represents a white pixel, and black - its absence.  For a better match, you can use any heuristic selection algorithms (genetic).  My formatting was not implemented. <br><br><h5>  Quine generation </h5><br>  The following was used as a marker where the final line of the quine should be printed: <b>/ * @ * /</b> <br>  Step by step everything looks like this.  All code can be completely arbitrary, but in the example line breaks are added for better readability. <br><br><ol><li>  Template initialization: <br>  <b>template =</b> <br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">P</span></span> { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Main</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> a = <span class="hljs-number"><span class="hljs-number">6</span></span>; <span class="hljs-comment"><span class="hljs-comment">/*@*/</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> b = <span class="hljs-number"><span class="hljs-number">10</span></span>; } }</code> </pre><br></li><li>  Generate the line pattern used for quine printing.  Quotation marks, backslashes and line breaks must be escaped, so that their presentation is separate parameters when outputting a formatted string. <br>  <b>kernel =</b> <code>"var s = {1}{0}{1}; System.Console.Write(s,s,'{1}','{2}{2}',{1}{2}r{2}n{1});"</code> <br></li><li>  Replaces the marker in the template with the string used to print from the previous step.  Since  in C #, curly brackets are used when displaying parameters, they must also be escaped.  This is done by duplicating them. <br>  <b>str =</b> <code>template.Replace("{", "{{").Replace("}", "}}").Replace("/*@*/", kernel)</code> <br>  <b>str =</b> <br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">P</span></span> {{ <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Main</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> {{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> a = <span class="hljs-number"><span class="hljs-number">6</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> s = {<span class="hljs-number"><span class="hljs-number">1</span></span>}{<span class="hljs-number"><span class="hljs-number">0</span></span>}{<span class="hljs-number"><span class="hljs-number">1</span></span>}; System.Console.Write(s,s,<span class="hljs-string"><span class="hljs-string">'{1}'</span></span>,<span class="hljs-string"><span class="hljs-string">'{2}{2}'</span></span>,{<span class="hljs-number"><span class="hljs-number">1</span></span>}{<span class="hljs-number"><span class="hljs-number">2</span></span>}r{<span class="hljs-number"><span class="hljs-number">2</span></span>}n{<span class="hljs-number"><span class="hljs-number">1</span></span>}); <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> b = <span class="hljs-number"><span class="hljs-number">10</span></span>; }} }}</code> </pre><br></li><li>  Generating the resulting string used to print a quine: <br>  <b>insertToResult =</b> <code>"var s=\"" + str + "\""</code> <br>  <b>insertToResult =</b> <br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> s=<span class="hljs-string"><span class="hljs-string">" class P {{ static void Main() {{ int a=6; var s={1}{0}{1}; Console.Write(s,s,'{1}','{2}{2}',{1}{2}r{2}n{1}); int b=10; }} }}"</span></span>; Console.Write(s,s,<span class="hljs-string"><span class="hljs-string">'"'</span></span>, <span class="hljs-string"><span class="hljs-string">'\\'</span></span>, <span class="hljs-string"><span class="hljs-string">"\r\n"</span></span>);</code> </pre><br></li><li>  Replacing the marker in the original template with the resulting string: <br>  <b>result =</b> <code>template.Replace("/*@*/", insertToResult)</code> <br>  <b>result =</b> <br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">using</span></span> System; <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">c</span></span> { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Main</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> a=<span class="hljs-number"><span class="hljs-number">6</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> s=<span class="hljs-string"><span class="hljs-string">"using System;class c{{static void Main(){{int a=6;var s={1}{0}{1};Console.Write(s,s,'{1}','{2}{2}',{1}{2}r{2}n{1});int b=10;}}}}"</span></span>; Console.Write(s,s,<span class="hljs-string"><span class="hljs-string">'"'</span></span>, <span class="hljs-string"><span class="hljs-string">'\\'</span></span>, <span class="hljs-string"><span class="hljs-string">"\r\n"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> b=<span class="hljs-number"><span class="hljs-number">10</span></span>; } }</code> </pre><br></li></ol><br>  Done: Received a program that can print itself. <br>  The described approach can be generalized before generating <a href="http://habrahabr.ru/post/189192/">quine palindromes</a> , but so far I have not implemented it. <br><br><h4>  Launch </h4><br>  After the quine is generated, for example, you can save it into the Asciimation.cs file and output one frame with the following command: <br> <code>"C:\Windows\Microsoft.NET\Framework64\v4.0.30319\csc.exe" Asciimation.cs &amp;&amp; (Asciimation &gt; Asciimation.cs) &amp;&amp; Asciimation</code> <br> <br>  And to see the entire generated "movie", you need to use the following script: <br><pre> <code class="bash hljs"><span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> off SET /ai=0 :LOOP IF %i%==3591 GOTO END <span class="hljs-string"><span class="hljs-string">"C:\Windows\Microsoft.NET\Framework64\v4.0.30319\csc.exe"</span></span> Asciimation.cs &amp;&amp; (Asciimation &gt; Asciimation.cs) &amp;&amp; Asciimation SET /ai=%i%+1 GOTO LOOP :END pause</code> </pre><br><br><h4>  Conclusion </h4><br>  The principles described in the article are applicable in the case of the implementation of various quineas in other programming languages.  Unfortunately, using the online services ( <a href="https://ideone.com/">ideone.com</a> , <a href="http://www.compileonline.com/compile_csharp_online.php">compileonline</a> ), it is <a href="http://www.compileonline.com/compile_csharp_online.php">impossible to</a> test the developed code, because it still exceeds the maximum size, despite the compression. <br><br>  The generated files and batch files can be downloaded here: <a href="">AsciimationQuine_1_3.7z</a> .  In the future, you can try to engage in chain quines and, perhaps, repeat the feat of Yusuke Endoh, only by manual generation, not with manual generation. <br><br>  Especially for those who do not have the ability to compile, but want to see the process: <br><iframe width="560" height="315" src="https://www.youtube.com/embed/WGJVOg3zGxw" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe></div><p>Source: <a href="https://habr.com/ru/post/190616/">https://habr.com/ru/post/190616/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../190600/index.html">Ilya Massukh‚Äôs reply (FID, ROI) to an open letter on the petition to cancel 187-–§–ó</a></li>
<li><a href="../190602/index.html">Riddle A858</a></li>
<li><a href="../190604/index.html">Overview of IP phones Escene ES320, ES320P and GS320</a></li>
<li><a href="../190610/index.html">Ludum Dare 27 will take place this weekend.</a></li>
<li><a href="../190612/index.html">On which site to develop your infobusiness?</a></li>
<li><a href="../190618/index.html">Solar-powered drone going to fly for 5 years</a></li>
<li><a href="../190624/index.html">Interview with Anne Gentle, Documentation Development Coordinator for the OpenStack Community</a></li>
<li><a href="../190628/index.html">Demo for Sega MegaDrive</a></li>
<li><a href="../190630/index.html">How we ran the project on BoomStarter. Part 2 - the results of the survey Vkontakte</a></li>
<li><a href="../190632/index.html">Do-it-yourself AVR LAN tester</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>