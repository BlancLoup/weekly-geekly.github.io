<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Simple things with difficult AppEngine</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="I thought to do in the toy , about which I wrote earlier, a simple thing - to calculate what place a person occupies in the overall rating: 
  
 As I ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Simple things with difficult AppEngine</h1><div class="post__text post__text-html js-mediator-article">  I thought to do in the <a href="http://www.vkubiki.ru/">toy</a> , about which I <a href="http://habrahabr.ru/blogs/i_am_advertising/108527/">wrote</a> earlier, a simple thing - to calculate what place a person occupies in the overall rating: <br> <a href="http://www.vkubiki.ru/"><img src="https://habrastorage.org/storage/2a99fd05/8a4e70ac/34df811e/43828dd0.png"></a> <br>  As I wrote, the game uses AppEngine for various statistics.  I will tell tackles about optimizations that had to be applied for this simple feature. <br><a name="habracut"></a><br>  It is obvious that to calculate the place in the rating on the fly is quite a resource-intensive task - you need to sort all users each time and with an impressive amount of them, the page will start to slow down.  So I decided to denormalize this value and added the appropriate field to the user class: <br><br><pre><code class="python hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Player</span></span></span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">(db.Model)</span></span></span><span class="hljs-class">:</span></span> name = db.StringProperty() scores = db.IntegerProperty() <span class="hljs-comment"><span class="hljs-comment">#  #... rank = db.IntegerProperty() # &lt;--  </span></span></code> </pre> <br><br>  Each time a player gains or loses points, his place is recalculated as follows.  Suppose a table of players looks like this: <br><table><tbody><tr><th>  Name </th><th>  Glasses </th><th>  A place </th></tr><tr><td colspan="3">  ... </td></tr><tr><td>  User 1 </td><td>  123 </td><td>  50 </td></tr><tr><td>  User 2 </td><td>  121 </td><td>  51 </td></tr><tr><td>  User 3 </td><td>  111 </td><td>  52 </td></tr><tr><td>  User 4 </td><td>  105 </td><td>  53 </td></tr><tr><td>  User 5 </td><td>  100 </td><td>  54 </td></tr><tr><td>  User 6 </td><td>  99 </td><td>  55 </td></tr><tr><td colspan="3">  ... </td></tr></tbody></table>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Now, if User 5 scores 21 points and has a total of 121, I recount the places of all players with points between 100 and 121. Before the conversion: <br><table><tbody><tr><th>  Name </th><th>  Glasses </th><th>  A place </th></tr><tr><td colspan="3">  ... </td></tr><tr><td>  User 1 </td><td>  123 </td><td>  50 </td></tr><tr><td>  <font color="green">User 5</font> </td><td>  121 </td><td>  <font color="red">54</font> </td></tr><tr><td>  User 2 </td><td>  121 </td><td>  <font color="red">51</font> </td></tr><tr><td>  User 3 </td><td>  111 </td><td>  <font color="red">52</font> </td></tr><tr><td>  User 4 </td><td>  105 </td><td>  <font color="red">53</font> </td></tr><tr><td>  User 6 </td><td>  99 </td><td>  55 </td></tr><tr><td colspan="3">  ... </td></tr></tbody></table><br>  After recalculation: <br><table><tbody><tr><th>  Name </th><th>  Glasses </th><th>  A place </th></tr><tr><td colspan="3">  ... </td></tr><tr><td>  User 1 </td><td>  123 </td><td>  50 </td></tr><tr><td>  User 5 </td><td>  121 </td><td>  <font color="green">51</font> </td></tr><tr><td>  User 2 </td><td>  121 </td><td>  <font color="green">52</font> </td></tr><tr><td>  User 3 </td><td>  111 </td><td>  <font color="green">53</font> </td></tr><tr><td>  User 4 </td><td>  105 </td><td>  <font color="green">54</font> </td></tr><tr><td>  User 6 </td><td>  99 </td><td>  55 </td></tr><tr><td colspan="3">  ... </td></tr></tbody></table><br>  To my surprise, such a simple algorithm gave a high load on AppEngine (CPU goes off scale): <br><img src="http://habrastorage.org/storage/60192e76/8b9128b3/7bd4ec0c/83b3d1cd.png"><br>  I was surprised, and decided that the problem is in more than 30 fields in the Player class, and there is no update without selecting all of these fields in AppEngine.  I then decided to disengage the rank field from the Player class and make a separate ‚Äúplate‚Äù for counting places. <br><pre> <code class="python hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Player</span></span></span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">(db.Model)</span></span></span><span class="hljs-class">:</span></span> <span class="hljs-comment"><span class="hljs-comment">#...  30-  ... rank = db.ReferenceProperty(reference_class=PlayerRank) class PlayerRank(db.Model): score = db.IntegerProperty() rank = db.IntegerProperty()</span></span></code> </pre><br>  Recalculation now occurred only for the PlayerRank class with two fields.  Well, of course this helped a lot with something, but the result is not satisfactory: <br><img src="http://habrastorage.org/storage/55277bbd/74069e1f/61507107/9dea659d.png"><br>  Obviously, AppEngine who spends all its resources recalculating a place in the ranking is a bad AppEngine.  The problem turned out to be too many operations.  For example, if a player has 1 rating point, and another 1,000 players have 2 points, then by typing this player just a couple of points you have to recalculate all 1000 other players who now need to lower the place.  I had to optimize further as follows. <br>  Keep the space occupied not for the player, but for the number of points.  Those.  if 1000 players have 2 points, then they all will have one place (say the 3000th). <br><table><tbody><tr><th>  Glasses </th><th>  A place </th></tr><tr><td colspan="2">  ... </td></tr><tr><td>  2 </td><td>  3000 </td></tr><tr><td>  one </td><td>  3001 </td></tr><tr><td colspan="3">  ... </td></tr></tbody></table><br>  Thus, it is necessary to recount not a thousand player records, but only two. <br><pre> <code class="python hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Player</span></span></span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">(db.Model)</span></span></span><span class="hljs-class">:</span></span> <span class="hljs-comment"><span class="hljs-comment">#...  30-  ... def rank(self): return ScoreRank.all().filter('score =', self.score).get().rank class ScoreRank(db.Model): score = db.IntegerProperty() rank = db.IntegerProperty() count = db.IntegerProperty()</span></span></code> </pre><br>  The ScoreRank.count property is added to control how many players have a given number of points.  If this count becomes 0, the ScoreRank entry for the given number of points is deleted. <br>  AppEngine responded: <br><img src="http://habrastorage.org/storage/75ec7ee9/955aadb4/3644f52b/a9befcda.png"><br><br><h4>  Conclusion </h4><br>  On the one hand, AppEngine is forcing the developer to write intricate algorithms, in which the need would have disappeared, use the developer's relational database and, say, LAMP.  On the other hand, the algorithms thus turn out fast, the pages fly, in other approaches these pages might be a bottleneck and brakes (think brake online stores on php + mysql).  From the third, AppEngne quotas are surprising.  10 thousand requests to select an object with 30 fields and update it threw out the application for a free quota.  The understanding comes that AppEngine is <b>expensive</b> , contrary to popular opinion. <br><br>  Link to the toy: <a href="http://www.vkubiki.ru/">www.vkubiki.ru</a> </div><p>Source: <a href="https://habr.com/ru/post/112216/">https://habr.com/ru/post/112216/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../112206/index.html">What does the new development model html5 promise us?</a></li>
<li><a href="../112207/index.html">Amazon Kindle cover issues and how to solve them</a></li>
<li><a href="../112208/index.html">Quest do it yourself</a></li>
<li><a href="../112210/index.html">Names for metavariables</a></li>
<li><a href="../112215/index.html">Windows Phone 7 Games Review (Part 1)</a></li>
<li><a href="../112217/index.html">The book "Branding and identification of the present and the future"</a></li>
<li><a href="../112221/index.html">Reflections on the implementation of the social graph</a></li>
<li><a href="../112222/index.html">Data structures: binary heap</a></li>
<li><a href="../112227/index.html">Weekday cloud development, part one</a></li>
<li><a href="../112229/index.html">The amendment to allow free copying of books for libraries really gave a red light</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>