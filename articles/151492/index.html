<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Writing a game for Android using Canvas</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hi Habr! 
 Today I want to talk about how to write a simple puzzle game for Android OS using Canvas. I got acquainted with this game about 5 years ago...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Writing a game for Android using Canvas</h1><div class="post__text post__text-html js-mediator-article">  Hi Habr! <br>  Today I want to talk about how to write a simple puzzle game for Android OS using Canvas.  I got acquainted with this game about 5 years ago on my phone.  The name was forgotten, and searches on several thematic forums resulted in nothing, and I decided to write my own implementation of this game.  Development for me is rather a hobby, although sometimes I take on small projects.  After some thought, I decided not to use the engine, but to write on my own.  The reasons for this decision: the desire to gain experience with Canvas. <br><a name="habracut"></a><br><h1>  The bottom line is ... </h1><br><br>  There is a playing field like a chessboard, but without dividing the cells into black and white.  The size of the field can be arbitrary, but playing on a field smaller than 2x3 does not make much sense.  I like to play 10x10 on the pitch. <br><br>  The number of players can be arbitrary, but in my opinion it is more interesting to play together or four together.  If three of us play on a rectangular field, then an imbalance occurs, since one of the players will be distant from the ‚Äúempty‚Äù corner.  If you play a company more than 4 people, it is difficult to implement your strategy. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Each player in turn must put one object (let's call it an atom) in a free cell or in a cell where its atoms already exist.  If a ‚Äúcritical mass‚Äù accumulates in the cell, which is equal to the number of neighboring cells, then the atoms from this cell move to the neighboring cells, while the atoms in the neighboring cells are ‚Äútrapped‚Äù, i.e.  now they belong to the player whose atoms have scattered. <br><br><h4>  A couple of pictures to explain the essence. </h4><br><br>  Empty 4x4 field indicating the critical mass for each cell. <br><img src="https://habrastorage.org/storage2/c68/810/56a/c6881056af0196152474ff511cc508f5.png"><br><br>  Game situation after the third move. <br><img src="https://habrastorage.org/storage2/466/2ff/ee3/4662ffee3d313834efa6e087f9895b10.png"><br><br>  The game situation after the fourth move (the first go blue).  It can be seen that a critical number of atoms has accumulated in the upper left corner. <br><img src="https://habrastorage.org/storage2/2b2/72a/887/2b272a88791a114a6369de00d5d52cbb.png"><br><br>  Bah!  They scattered, capturing 2 blue atoms in the cell [0] [1].  And in this cell [0] [1] is now also a critical amount.  Chain reaction! <br><img src="https://habrastorage.org/storage2/a8e/bc0/6b2/a8ebc06b29db8710138dd61592b1f9ae.png"><br><br>  The situation after the expansion.  The end of the fourth move.  Blue will now make the fifth move. <br><img src="https://habrastorage.org/storage2/7fc/564/415/7fc564415eb856811a9376b683628ba7.png"><br><br><h1>  Implementation.  The grafical part. </h1><br><br>  Let's start the implementation.  Create a derived class from View. <br><pre><code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">GameView</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">View</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> Bitmap mBitmap; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> Canvas mCanvas; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> Paint paint, mBitmapPaint; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">float</span></span> canvasSize; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> horizontalCountOfCells, verticalCountOfCells; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GameView</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Context context, AttributeSet attrs)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">super</span></span>(context, attrs); <span class="hljs-comment"><span class="hljs-comment">//   horizontalCountOfCells =10; verticalCountOfCells =10; // xml       300dp canvasSize=(int)convertDpToPixel(300, context); mBitmap = Bitmap.createBitmap((int) canvasSize, (int) canvasSize, Bitmap.Config.ARGB_8888); mCanvas = new Canvas(mBitmap); mBitmapPaint = new Paint(Paint.DITHER_FLAG); //  ,       paint =new Paint(); paint.setAntiAlias(true); paint.setDither(true); paint.setColor(0xffff0505); paint.setStrokeWidth(5f); paint.setStyle(Paint.Style.STROKE); paint.setStrokeJoin(Paint.Join.ROUND); paint.setStrokeCap(Paint.Cap.ROUND); //  for(int x=0;x&lt; horizontalCountOfCells +1;x++) mCanvas.drawLine((float)x* canvasSize / horizontalCountOfCells, 0, (float)x* canvasSize / horizontalCountOfCells, canvasSize, paint); for(int y=0;y&lt; verticalCountOfCells +1;y++) mCanvas.drawLine(0, (float)y* canvasSize / verticalCountOfCells, canvasSize, (float)y* canvasSize / verticalCountOfCells, paint); } @Override protected void onDraw(Canvas canvas) { canvas.drawBitmap(mBitmap, 0, 0, mBitmapPaint); } // dp   public float convertDpToPixel(float dp,Context context){ Resources resources = context.getResources(); DisplayMetrics metrics = resources.getDisplayMetrics(); return dp * (metrics.densityDpi/160f); } }</span></span></code> </pre> <br><br>  Here I made a bit of bad quality <s>govnod</s> code, namely, in the code, the color of the lines separating the cells of the playing field and the size of the view is considered equal to 300 dp.  This size can be obtained from the attrs object of the AttributeSet class, but we will not clutter up the code. <br><br>  Also immediately throw an Activity in order to make sure that everything is drawn beautifully. <br><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">GameActivity</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Activity</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-function"><span class="hljs-function">Override </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onCreate</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Bundle savedInstanceState)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">super</span></span>.onCreate(savedInstanceState); setContentView(R.layout.main); } }</code> </pre><br><br>  And the main.xml markup <br><br><pre> <code class="xml hljs"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">LinearLayout</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">xmlns:android</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">¬´schemas.android.com/apk/res/android¬ª</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">android:orientation</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">¬´vertical¬ª</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">android:layout_width</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">¬´fill_parent¬ª</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">android:layout_height</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">¬´fill_parent¬ª</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">android:background</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"#aaa"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">android:gravity</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">¬´center_horizontal¬ª</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">com.devindi.chain.GameView</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">android:layout_width</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">¬´300dp¬ª</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">android:layout_height</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">¬´300dp¬ª</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">android:id</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"@+id/game_view"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">android:layout_gravity</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">¬´center¬ª</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">android:background</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"#000"</span></span></span><span class="hljs-tag">/&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">LinearLayout</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre><br><br>  <a href="https://github.com/devindi/catena-reaction-edu/tree/e54dd18b120cd1d9e7326fb52cd575f4c2703027">Code after this stage.</a> <br><br>  Now we add the ability to change the scale of the playing field, since there may be misses past the desired cell due to their small size.  To do this, we override the methods we need to implement the ScaleGestureDetector.SimpleOnScaleGestureListener of the OnScaleGestureListener interface in our GameView class. <br><br><pre> <code class="java hljs"> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> ScaleGestureDetector scaleGestureDetector; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> viewSize; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">float</span></span> mScaleFactor; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GameView</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Context context, AttributeSet attrs)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-comment"><span class="hljs-comment">// xml       300dp viewSize=(int)convertDpToPixel(300, context); mScaleFactor=1f;//    canvasSize=(int)(viewSize*mScaleFactor);//   ‚Ä¶ scaleGestureDetector=new ScaleGestureDetector(context, new MyScaleGestureListener()); } @Override protected void onDraw(Canvas canvas) { canvas.save(); canvas.scale(mScaleFactor, mScaleFactor);//  canvas.drawBitmap(mBitmap, 0, 0, mBitmapPaint); canvas.restore(); } //      MyScaleGestureListener @Override public boolean onTouchEvent(MotionEvent event) { scaleGestureDetector.onTouchEvent(event); return true; } //  ScaleGestureDetector.SimpleOnScaleGestureListener,       //  OnScaleGestureListener private class MyScaleGestureListener extends ScaleGestureDetector.SimpleOnScaleGestureListener { // ""  @Override public boolean onScale(ScaleGestureDetector scaleGestureDetector) { float scaleFactor=scaleGestureDetector.getScaleFactor();//      //    -    float focusX=scaleGestureDetector.getFocusX(); float focusY=scaleGestureDetector.getFocusY(); //               2  if(mScaleFactor*scaleFactor&gt;1 &amp;&amp; mScaleFactor*scaleFactor&lt;2){ mScaleFactor *= scaleGestureDetector.getScaleFactor(); canvasSize =viewSize*mScaleFactor;//       //   //         . //  ,     // ,      //        ( ). int scrollX=(int)((getScrollX()+focusX)*scaleFactor-focusX); scrollX=Math.min( Math.max(scrollX, 0), (int) canvasSize -viewSize); int scrollY=(int)((getScrollY()+focusY)*scaleFactor-focusY); scrollY=Math.min( Math.max(scrollY, 0), (int) canvasSize -viewSize); scrollTo(scrollX, scrollY); } //   invalidate(); return true; } }</span></span></code> </pre><br><br>  <a href="https://github.com/devindi/catena-reaction-edu/tree/2a4e1fb72fad1a3cfe83480bfc0ce6070ba60afc">The resulting code</a> <br><br>  Note that the boundaries of the magnification value are set (the magnification will be between 1 and 2), and the playing field is scrolled to the zoom point (the point is in the middle between the fingers) with a check to show the area outside the playing field.  The scroll to the zoom point (focal point) is performed as follows - the coordinates of the focal point relative to the beginning of the canvas (the upper left corner) are calculated, multiplied by the zoom factor and the coordinates of the point relative to the viewpoint are subtracted.  After that, we take the closest value from the interval [0, canvasSize -viewSize] to prevent scrolling outside the playing field. <br><br>  Now we will write the scrolling, single tap and double tap processing (double tap will return to the original scale of the playing field). <br><br><pre> <code class="java hljs"> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> GestureDetector detector; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GameView</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Context context, AttributeSet attrs)</span></span></span><span class="hljs-function"> </span></span>{ ... detector=<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> GestureDetector(context, <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> MyGestureListener()); } <span class="hljs-comment"><span class="hljs-comment">//      Motion Event' MyGestureListener'  MyScaleGestureListener' @Override public boolean onTouchEvent(MotionEvent event) { detector.onTouchEvent(event); scaleGestureDetector.onTouchEvent(event); return true; } //  GestureDetector.SimpleOnGestureListener,     //    OnGestureListener private class MyGestureListener extends GestureDetector.SimpleOnGestureListener { //  (   ) @Override public boolean onScroll(MotionEvent e1, MotionEvent e2, float distanceX, float distanceY) { //       if(getScrollX()+distanceX&lt; canvasSize -viewSize &amp;&amp; getScrollX()+distanceX&gt;0){ scrollBy((int)distanceX, 0); } //       if(getScrollY()+distanceY&lt; canvasSize -viewSize &amp;&amp; getScrollY()+distanceY&gt;0){ scrollBy(0, (int)distanceY); } return true; } //   @Override public boolean onSingleTapConfirmed(MotionEvent event){ //  ,    int cellX=(int)((event.getX()+getScrollX())/mScaleFactor); int cellY=(int)((event.getY()+getScrollY())/mScaleFactor); return true; } //   @Override public boolean onDoubleTapEvent(MotionEvent event){ //     mScaleFactor=1f; canvasSize =viewSize; scrollTo(0, 0);//,      . invalidate();//  return true; } }</span></span></code> </pre><br><br>  <a href="https://github.com/devindi/catena-reaction-edu/tree/c99e880dc2443861540f75b7c150f34729662fd9">The resulting code</a> <br>  With a single tap, we calculate the coordinates of the cell by which we taped, for example, the upper left cell will have coordinates of 0.0. <br><br>  Let's write a method for drawing atoms to drawAtoms.  The method parameters are the coordinates of the cell in which we draw atoms, the color and the number of atoms. <br><br><pre> <code class="java hljs"> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">drawAtoms</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> cellX, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> cellY, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> color, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> count)</span></span></span></span>{ <span class="hljs-comment"><span class="hljs-comment">//    float x0=((1f/(2* horizontalCountOfCells))*viewSize+(1f/ horizontalCountOfCells)*cellX*viewSize); float y0=((1f/(2* verticalCountOfCells))*viewSize+(1f/ verticalCountOfCells)*cellY*viewSize); paint.setColor(color); switch (count){ //todo non-absolute values case 1: drawAtoms(cellX, cellY, color, 0);//   mCanvas.drawCircle(x0, y0, 3, paint);//      break; case 2: drawAtoms(cellX, cellY, color, 0); //        mCanvas.drawCircle(x0-7, y0, 3, paint); mCanvas.drawCircle(x0+7, y0, 3, paint); break; case 3: drawAtoms(cellX, cellY, color, 0); //            mCanvas.drawCircle(x0 - 7, y0 + 4, 3, paint); mCanvas.drawCircle(x0 + 7, y0 + 4, 3, paint); mCanvas.drawCircle(x0, y0-8, 3, paint); break; case 4: drawAtoms(cellX, cellY, color, 0); // 4          mCanvas.drawCircle(x0-7, y0-7, 3, paint); mCanvas.drawCircle(x0-7, y0+7, 3, paint); mCanvas.drawCircle(x0+7, y0+7, 3, paint); mCanvas.drawCircle(x0+7, y0-7, 3, paint); break; case 0: //    paint.setXfermode(new PorterDuffXfermode(PorterDuff.Mode.CLEAR)); //   paint.setStyle(Paint.Style.FILL); //  ,       mCanvas.drawCircle(x0, y0, 17, paint); //   paint.setStyle(Paint.Style.STROKE); paint.setXfermode(new PorterDuffXfermode(PorterDuff.Mode.SRC)); break; } invalidate();//  }</span></span></code> </pre><br><br>  At the moment, the method has a flaw in the form of absolute values ‚Äã‚Äãof atomic sizes and distances between them.  What can this lead to?  When the field size is less than 10x10, the atoms will look small, and with a larger field size they may not fit into the cell. <br><br>  It remains to add scrollbars.  This process is well described here <a href="http://habrahabr.ru/post/120931/">habrahabr.ru/post/120931</a> . <br><br>  Before proceeding to the description of the game logic, add a global variable of type GameLogic (our class that describes logic) named logic and add onSingleTapConfirmed to the single-tap processing method <br>  call the future method of logical processing of the addition of a new atom. <br>  logic.addAtom (cellX, cellY); <br>  A setter is also required for this variable. <br><br>  <a href="https://github.com/devindi/catena-reaction-edu/tree/ec8af2fe9d104eb6dd004b51e6b916383a6d3782">Code.</a> <br><br><h1>  Implementation.  Game logic. </h1><br><br>  Create a GameLogic class that describes the logic of the game.  We also need the inner Cell class, which stores the cell parameters of the playing field. <br><br><pre> <code class="java hljs"> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">GameLogic</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Cell</span></span></span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> player=<span class="hljs-number"><span class="hljs-number">0</span></span>, countOfAtoms=<span class="hljs-number"><span class="hljs-number">0</span></span>;<span class="hljs-comment"><span class="hljs-comment">// ,     final int maxCountOfAtoms;//  Cell(int maxCountOfAtoms){ this.maxCountOfAtoms=maxCountOfAtoms; } public int getCountOfAtoms() { return countOfAtoms; } public int getPlayer() { return player; } public void setPlayer(int player) { this.player = player; } public void resetCount() { this.countOfAtoms = 0; } public void addAtom(){ this.countOfAtoms++; } boolean isFilled(){ return this.countOfAtoms == this.maxCountOfAtoms; } } }</span></span></code> </pre><br><br>  GameLogic class itself <br><br><pre> <code class="java hljs"> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> GameView view; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> GameActivity activity; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> moveNumber=<span class="hljs-number"><span class="hljs-number">0</span></span>, currentPlayer=<span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> COUNT_OF_PLAYERS, BOARD_WIDTH, BOARD_HEIGHT; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> Cell[][] cells; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span>[] colors={<span class="hljs-number"><span class="hljs-number">0xff1d76fc</span></span>, <span class="hljs-number"><span class="hljs-number">0xfffb1d76</span></span>, <span class="hljs-number"><span class="hljs-number">0xff76fb1d</span></span>, <span class="hljs-number"><span class="hljs-number">0xffa21cfb</span></span>};<span class="hljs-comment"><span class="hljs-comment">//  private final Handler mHandler; public GameLogic(GameView view, GameActivity activity) { this.view = view; this.activity=activity; mHandler=new Handler(); //   ( ,  ) this.COUNT_OF_PLAYERS=2; this.BOARD_HEIGHT=10; this.BOARD_WIDTH=10; cells=new Cell[BOARD_WIDTH][BOARD_HEIGHT]; for(int x=0; x&lt;BOARD_WIDTH; x++){ for(int y=0; y&lt;BOARD_HEIGHT; y++){ if((x==0 || x==BOARD_WIDTH-1) &amp;&amp; (y==0 || y==BOARD_HEIGHT-1)){ cells[x][y]=new Cell(2);//    2 }else if((x==0 || x==BOARD_WIDTH-1) || (y==0 || y==BOARD_HEIGHT-1)){ cells[x][y]=new Cell(3);//,    - 3 }else{ cells[x][y]=new Cell(4);// - 4 } } } } //      public void addAtom(final int cellX, final int cellY) { // ,    ,      -   . final Cell currentCell; try{ currentCell=cells[cellX][cellY]; }catch (IndexOutOfBoundsException ex){ return; } //        if(currentCell.getPlayer()==currentPlayer){ currentCell.addAtom(); view.drawAtoms(cellX, cellY, colors[currentPlayer], currentCell.getCountOfAtoms()); //   if(currentCell.isFilled()){ final List&lt;Cell&gt; nearby=new ArrayList&lt;Cell&gt;(4);//   selfAddCell(cellX, cellY-1, nearby); selfAddCell(cellX, cellY+1, nearby); selfAddCell(cellX-1, cellY, nearby); selfAddCell(cellX+1, cellY, nearby); for(Cell nearbyCell:nearby){ nearbyCell.setPlayer(currentPlayer);//     } delayedAddAtom(cellX, cellY-1); delayedAddAtom(cellX, cellY+1); delayedAddAtom(cellX-1, cellY); delayedAddAtom(cellX+1, cellY); //     run() mHandler.postDelayed(new Runnable() { @Override public void run() { //    () currentCell.setPlayer(-1); //  currentCell.resetCount(); view.drawAtoms(cellX, cellY, 0x000000, 0); } }, 1000); return; } }else if(currentCell.getPlayer()==-1){ currentCell.addAtom(); view.drawAtoms(cellX, cellY, colors[currentPlayer], currentCell.getCountOfAtoms()); currentCell.setPlayer(currentPlayer); }else{ return; } } //       private void delayedAddAtom(final int cellX, final int cellY){ mHandler.postDelayed(new Runnable() { @Override public void run() { addAtom(cellX, cellY); } }, 1000); } //   target   private void selfAddCell(int cellX, int cellY, List&lt;Cell&gt; target){ try{ target.add(cells[cellX][cellY]); }catch (IndexOutOfBoundsException ignore){} }</span></span></code> </pre><br><br>  <a href="https://github.com/devindi/catena-reaction-edu/tree/7eb800705e416cbf4bd106d216e00067da4e4121">Code.</a> <br><br>  Here we see a constructor that creates a two-dimensional array of Cell objects and the addAtom method, called from a single tap view and from itself, provided that the cell is filled with atoms to the eye. <br>  Now you can add atoms to the cells, and when a critical number of atoms accumulate in the cell, they will fly apart in a second.  However, it is now possible to add atoms during this second.  Get rid of this by adding the isLock flag variable and the isLock (), lock (), and unlock () methods to the GameView class. <br><br>  You also need to add a player change after the turn, scoring and processing the end of the game (when all atoms belong to one player and each player has completed at least 1 turn). <br>  Add the following code to the end of the addAtom () method <br><br><pre> <code class="java hljs"> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span>[] score=scoring(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(moveNumber==<span class="hljs-number"><span class="hljs-number">0</span></span>){ endTurn(score); }<span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { <span class="hljs-comment"><span class="hljs-comment">//   .      endTurn()   //       int losersCount=0; for(int i=0; i&lt;COUNT_OF_PLAYERS; i++){ if(score[i]==0) losersCount++; } if(losersCount+1==COUNT_OF_PLAYERS){ isEndGame=true; } if(!mHandler.hasMessages(0)){ view.unlock(); endTurn(score); } } } //   private void endTurn(int[] score){ if(!isEndGame){ if(currentPlayer == COUNT_OF_PLAYERS-1){ moveNumber++; currentPlayer=0; }else { currentPlayer++; } }else{ activity.endGame(currentPlayer, score[currentPlayer]); } // ,  ,   ,      activity.setMoveNumber(moveNumber); activity.setPlayerName(currentPlayer); activity.setScore(score); } //  int[] scoring(){ int[] score=new int[COUNT_OF_PLAYERS]; for(int x=0; x&lt;BOARD_WIDTH; x++){ for(int y=0; y&lt;BOARD_HEIGHT; y++){ if(cells[x][y].getPlayer()!=-1){ score[cells[x][y].getPlayer()]+=cells[x][y].getCountOfAtoms(); } } } return score; }</span></span></code> </pre><br><br>  <a href="https://github.com/devindi/catena-reaction-edu/tree/b27587c0154a96c634566b1c2946c291ea970905">All code</a> <br>  It remains to write the implementation of the methods <br><pre> <code class="java hljs"> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">setPlayerName</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> playerID)</span></span></span></span>{} <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">setScore</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params">[] score)</span></span></span></span>{} <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">setMoveNumber</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> moveNumber)</span></span></span></span>{} <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">endGame</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> winnerID, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> score)</span></span></span></span>{}</code> </pre><br><br>  This will be homework.  It's all trivial. <br><br><h1>  After assembly process file </h1><br><br>  Next, you need a little doping of the resulting application in the form of creating an Activity to customize the game (the size of the playing field, the number of players, the color of the atoms and the names of the players, but this is not the topic of this article. You can see the final code on the <a href="https://github.com/devindi/catena-reaction-edu">github</a> , try out the game on <a href="https://play.google.com/store/apps/details%3Fid%3Dcom.devindi.chain">Google Play</a> <br><br>  I hope someone article will help. <br>  Please do not throw big stones.  I realize the poor quality of the code and promise to try to avoid govnokoda.  Thanks for attention. <br><br>  PS This is my first article on Habr√©. </div><p>Source: <a href="https://habr.com/ru/post/151492/">https://habr.com/ru/post/151492/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../151486/index.html">IPad-based Telepresence Robot</a></li>
<li><a href="../151487/index.html">Breakthrough in spintronics</a></li>
<li><a href="../151488/index.html">Microsoft will give a smartphone, tablet and computer to each employee</a></li>
<li><a href="../151490/index.html">Stanford University introduced vice-rector for online education at Stanford University</a></li>
<li><a href="../151491/index.html">MapReduce without brakes: bypassing bottlenecks using machine learning</a></li>
<li><a href="../151493/index.html">Google has problems with IPv6 connectivity in Europe</a></li>
<li><a href="../151496/index.html">Here is a hybrid ...</a></li>
<li><a href="../151497/index.html">Tower of Babel management</a></li>
<li><a href="../151498/index.html">InterSystems Cach√© 2012.2 release</a></li>
<li><a href="../151499/index.html">Kyocera - a little about the little things</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>