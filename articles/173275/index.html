<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Dependency injection in a Doctrine entity using the Symfony Dependency Injection Component</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Although dependency injection is essentially considered a bad practice in terms of DDD, there are situations in which this is very convenient. The leg...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Dependency injection in a Doctrine entity using the Symfony Dependency Injection Component</h1><div class="post__text post__text-html js-mediator-article">  Although dependency injection is essentially considered a bad practice in terms of DDD, there are situations in which this is very convenient.  The legitimacy of using such an approach, but exactly like comparing it with alternatives (double dispatching, events), is not the topic of this article.  I want to talk about the technical implementation - about the integration of the Symfony Dependency Injection Component (hereinafter referred to as DIC) with Doctrine to automatically embed dependencies in loadable entities.  The versions of symfony and doctrine used are 2. *. <br><a name="habracut"></a><br><br>  So, we have an entity in which you need to embed dependencies when loading or when creating: <br><br><pre><code class="php hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?php</span></span> <span class="hljs-keyword"><span class="hljs-keyword">namespace</span></span> <span class="hljs-title"><span class="hljs-title">Domain</span></span>; <span class="hljs-comment"><span class="hljs-comment">/** * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@Entity</span></span></span><span class="hljs-comment"> */</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">SomeEntity</span></span></span><span class="hljs-class"> </span></span>{ ‚Ä¶... <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> $someService; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> $anotherService; ‚Ä¶... <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">setSomeService</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(SomeService $someService)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;someService = $someService; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">setAnotherService2</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(AnotherService $anotherService)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;anotherService = $anotherService; } }</code> </pre> 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Unfortunately, I did not find a simple way to implement dependency injection into the constructor when using Doctrine - the creation of an object is located deep in the depths of the Unit of Work and ClassMetadata.  Therefore, the implementation will be carried out using setters. <br><br>  Doctrine events and DIC tags will be used for integration.  The format of the DIC configs is yaml, but you can use your favorite one. <br><br>  We want dependencies to be embedded into it after the entity is loaded.  For this we have a postLoad event at our disposal. <br><br>  Implement EventSubscriber, which responds to this event: <br><br><pre> <code class="php hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?php</span></span> <span class="hljs-keyword"><span class="hljs-keyword">namespace</span></span> <span class="hljs-title"><span class="hljs-title">Persistence</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">Doctrine</span></span>\<span class="hljs-title"><span class="hljs-title">ORM</span></span>\<span class="hljs-title"><span class="hljs-title">Events</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">Doctrine</span></span>\<span class="hljs-title"><span class="hljs-title">ORM</span></span>\<span class="hljs-title"><span class="hljs-title">Event</span></span>\<span class="hljs-title"><span class="hljs-title">LifecycleEventArgs</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">Doctrine</span></span>\<span class="hljs-title"><span class="hljs-title">Common</span></span>\<span class="hljs-title"><span class="hljs-title">EventSubscriber</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">DependencyInjection</span></span>\<span class="hljs-title"><span class="hljs-title">Injector</span></span>; <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">EntityConfigurator</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">EventSubscriber</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> $injector; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">__construct</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Injector $injector)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;injector = $injector;; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getSubscribedEvents</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> [Events::postLoad]; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">postLoad</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(LifecycleEventArgs $args)</span></span></span><span class="hljs-function"> </span></span>{ $entity = $args-&gt;getEntity(); <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;injector-&gt;injectSevicesTo($entity); } }</code> </pre><br><br>  And connect it to the entity manager after creating <br><br><pre> <code class="php hljs">$entityManager-&gt;getEventManager()-&gt;addEventSubscriber($entityConfigurator);</code> </pre> <br><br>  All implementation work will occur within the Injector class. <br><br>  The dependency injection algorithm is simple: <br><ul><li>  get all services marked with a special tag from DIC </li><li>  when loaded, if any of the received services has a class equal to the class of the loaded entity - perform all setter calls </li></ul><br><br>  Implementation: <br><pre> <code class="php hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?php</span></span> <span class="hljs-keyword"><span class="hljs-keyword">namespace</span></span> <span class="hljs-title"><span class="hljs-title">DependencyInjection</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">Symfony</span></span>\<span class="hljs-title"><span class="hljs-title">Component</span></span>\<span class="hljs-title"><span class="hljs-title">DependencyInjection</span></span>\<span class="hljs-title"><span class="hljs-title">ContainerBuilder</span></span>; <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Injector</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> DOCTRINE_ENTITY_TAG = <span class="hljs-string"><span class="hljs-string">'doctrine-entity'</span></span>; <span class="hljs-comment"><span class="hljs-comment">/** *</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@var</span></span></span><span class="hljs-comment"> \Symfony\Component\DependencyInjection\ContainerBuilder */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> $container; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> $configurableClasses = []; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">__construct</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(ContainerBuilder $container)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;container = $container; <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;prepareConfigurableClasses(); } <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">prepareConfigurableClasses</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-comment"><span class="hljs-comment">//       foreach($this-&gt;container-&gt;findTaggedServiceIds(self::DOCTRINE_ENTITY_TAG) as $id =&gt; $tag) { //    $definition = $this-&gt;container-&gt;findDefinition($id); //    setter  $this-&gt;configurableClasses[$definition-&gt;getClass()] = $definition-&gt;getMethodCalls(); } } public function injectSevicesTo($object) { if(!is_object($object) || !array_key_exists(get_class($object), $this-&gt;configurableClasses)) { return; } //       DIC $parameter_bag = $this-&gt;container-&gt;getParameterBag(); $calls = $this-&gt;configurableClasses[get_class($object)]; foreach($calls as $call) { //   $parametrized_references = $parameter_bag-&gt;resolveValue($call[1]); call_user_func_array(array($object, $call[0]), $this-&gt;container-&gt;resolveServices($parametrized_references)); } } }</span></span></code> </pre><br>  If necessary, the constant DOCTRINE_ENTITY_TAG can be replaced by an array of different tags. <br><br>  In order for Injector to be able to inject dependencies, entities need to be configured in the DIC (yaml) configuration: <br><br><pre> services:
    ... ....
    entity-object-title:
         class: 'Domain \ SomeEntity'
         tags: [{name: "doctrine-entity"}]
         abstract: true
         calls:
           - [setSomeService, [@ some-service]]
           - [setSomeService2, [@ some-service2]]
    ... ..
</pre><br><br><ul><li>  <code>entity-object-title</code> is an arbitrary name, used for descriptive purposes. </li><li>  <code>abstract: true</code> - disable the ability to create a service directly.  You can use <code>public: false</code> for this purpose. </li><li>  <code>calls</code> is a list of setters in which dependencies are injected. </li></ul><br><br>  Now when loading an entity using Doctrine, dependencies will be automatically injected. <br><br>  If you need to implement dependency injection for new objects, you can use the Injector inside the relevant factories or factory methods. <br><br>  Ps.  In the Injector class, ContainerBuilder is used directly for simplicity, but in a real project, a wrapper over it is used.  This allows you to encapsulate the features of a symfony DIC and, if necessary, use other DI libraries.  More importantly, it allows you to use the principle of ‚ÄúDon't mock types you don't have‚Äù. </div><p>Source: <a href="https://habr.com/ru/post/173275/">https://habr.com/ru/post/173275/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../173265/index.html">Exposing 12 legal misconceptions about computer programs</a></li>
<li><a href="../173267/index.html">Effective online store. How to create marketable content for a large online store? PART 2</a></li>
<li><a href="../173269/index.html">My version of "gravitsapy"</a></li>
<li><a href="../173271/index.html">Why HTML coders don't like web designers</a></li>
<li><a href="../173273/index.html">On artificial intelligence in poker</a></li>
<li><a href="../173277/index.html">Tetris first person</a></li>
<li><a href="../173281/index.html">Single Instance Applications on Qt</a></li>
<li><a href="../173283/index.html">Qt driver assembly for working with PostgreSQL (Windows)</a></li>
<li><a href="../173285/index.html">Freelancer - the story of one pentest</a></li>
<li><a href="../173287/index.html">Rapidly Deploy Development Environment for Ruby on Rails</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>