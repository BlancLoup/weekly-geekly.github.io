<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ML on Scala with a smile, for those who are not afraid of experiments</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hello! Today we will talk about the implementation of machine learning on Scala. I will begin by explaining how we have come to such a life. So, our t...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>ML on Scala with a smile, for those who are not afraid of experiments</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/webt/n4/cq/gu/n4cqgunchqczcws7cj09vm0kpiq.png"><br><br>  Hello!  Today we will talk about the implementation of machine learning on Scala.  I will begin by explaining how we have come to such a life.  So, our team for a long time used all the possibilities of machine learning in Python.  This is convenient, there are many useful libraries for data preparation, a good infrastructure for development, I mean Jupyter Notebook.  All anything, but faced the problem of paralleling calculations in production, and decided to use Scala in the sale.  Why not, we thought, there are a lot of libraries out there, even Apache Spark is written in Scala!  At the same time, today we are developing models in Python, and then repeating training on Scala for further serialization and use in production.  But as they say, the devil is in the details. <br><br>  Immediately I want to clarify, dear reader, this article was not written with the aim of shaking the reputation of Python in machine learning issues.  No, the main goal is to open the door to the world of machine learning on Scala, to make a small review of an alternative approach arising from our experience, and to tell you what difficulties we have encountered. <br><a name="habracut"></a><br>  In practice, everything turned out to be not so joyful: there are not so many libraries implementing the classical machine learning algorithms, and those that exist are often OpenSource projects without the support of large vendors.  Yes, of course, there is Spark MLib, but it is strongly attached to the Apache Hadoop ecosystem, and I really didn‚Äôt want to drag it into the microservice architecture. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      We needed a solution that will save the world and return a peaceful sleep, and it was found! <br><br><h2>  What do you need? </h2><br>  When we chose a tool for machine learning, we proceeded from the following criteria: <br><br><ul><li>  it should be simple; <br></li><li>  despite the simplicity, no one has canceled wide functionality; <br></li><li>  I really wanted to be able to develop models in the web-interpreter, and not through the console or permanent assemblies and compilations; <br></li><li>  documentation is important; <br></li><li>  ideally, there should be support, at least responding to github issues. <br></li></ul><br><h2>  What did we see? </h2><br><ul><li>  <a href="https://spark.apache.org/mllib/">Apache Spark MLib</a> : did not <a href="https://spark.apache.org/mllib/">suit</a> us.  As mentioned above, this set of libraries is strongly tied to the Apache Hadoop stack and Spark Core itself, which weighs too much to build microservices based on it. <br></li><li>  <a href="http://predictionio.apache.org/index.html">Apache PredictionIO</a> : interesting project, many contributors, there is documentation with examples.  In fact, this is a REST server on which models are spinning.  There are ready-made models, for example, text classification, the launch of which is described in the documentation.  The documentation describes how to add and train your models.  We did not fit, since Spark is used under the hood, and this is more from the area of ‚Äã‚Äãa monolithic solution, and not microservice architecture. <br></li><li>  <a href="https://mxnet.incubator.apache.org/">Apache MXNet</a> : an interesting framework for working with neural networks, there is support for Scala and Python - this is convenient, you can train a neural network in Python, and then load the saved result from Scala when creating a production solution.  We use it in production solutions, there is a separate article about it <a href="https://habr.com/ru/company/mailru/blog/439226/">here</a> . <br></li><li>  <a href="https://haifengl.github.io/smile/">Smile</a> : very similar to the scikit-learn package for Python.  There are many implementations of classical machine learning algorithms, good documentation with examples, github support, a built-in visualizer (based on Swing), Jupyter Notebook can be used to develop models.  This is just what you need! <br></li></ul><br><h2>  Environment preparation </h2><br>  So, we have chosen;).  I'll tell you how to run it in Jupyter Notebook on the example of the k-means clustering algorithm.  The first thing we need to do is install a Scala-enabled Jupyter Notebook.  This can be done via pip, or you can use the already compiled and configured Docker image.  I am for a simpler, second option. <br><br>  To make friends with Jupyter from Scala, I wanted to use BeakerX, which is part of the Docker image available in the official BeakerX repository.  This image is recommended in the Smile documentation, and you can start it like this: <br><br><pre><code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#   BeakerX docker run -p 8888:8888 beakerx/beakerx</span></span></code> </pre> <br>  But here the first trouble was waiting: at the time of this writing, BeakerX 1.0.0 was installed inside the beakerx / beakerx image, and version 1.4.1 is already available in the official github of the project (more precisely, the latest release is 1.3.0, but 1.4.1 is in the wizard and it works :-)). <br><br>  It is clear that I want to work with the latest version, so I assembled my own image based on BeakerX 1.4.1.  I will not bore you with Dockerfile content, here is a <a href="https://github.com/AntonYurchenko/docker/blob/master/jupyter-scala/Dockerfile">link</a> to it. <br><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#         mkdir -p /tmp/my_code docker run -it \ -p 8888:8888 \ -v /tmp/my_code:/workspace/my_code \ entony/jupyter-scala:1.4.1</span></span></code> </pre> <br>  By the way, for those who will use my image, there will be a small bonus: in the examples directory there is an example of k-means for a random sequence with plotting (this is not quite a trivial task for Scala notebooks). <br><br><h2>  Downloading Smile to Jupyter Notebook </h2><br>  Great, the surroundings are prepared!  Create a new Scala notebooks in a folder in our directory, then you need to download the library from the Maven library to work Smile. <br><br><pre> <code class="bash hljs">%%classpath add mvn com.github.haifengl smile-scala_2.12 1.5.2</code> </pre> <br>  After the code has been executed, a list of downloaded jar files will appear in its output block. <br><br>  Next step: import the necessary packages for the example. <br><br><pre> <code class="scala hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> java.awt.image.<span class="hljs-type"><span class="hljs-type">BufferedImage</span></span> <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> java.awt.<span class="hljs-type"><span class="hljs-type">Color</span></span> <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> javax.imageio.<span class="hljs-type"><span class="hljs-type">ImageIO</span></span> <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> java.io.<span class="hljs-type"><span class="hljs-type">File</span></span> <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> smile.clustering._</code> </pre> <br><h2>  Prepare data for clustering </h2><br>  Now we will solve the following problem: generation of an image consisting of zones of three primary colors - red, green and blue (R, G, B).  One of the colors in the picture will prevail.  Cluster the pixels of the image, take a cluster with the most pixels, change their color to gray and build a new image of all the pixels.  Expected result: the zone of the predominant color will turn gray, the rest of the zone will not change color. <br><br><pre> <code class="scala hljs"><span class="hljs-comment"><span class="hljs-comment">//    640  360 val width = 640 val hight = 360 //      val testImage = new BufferedImage(width, hight, BufferedImage.TYPE_INT_RGB) //   .    . for { x &lt;- (0 until width) y &lt;- (0 until hight) color = if (y &lt;= hight / 3 &amp;&amp; (x &lt;= width / 3 || x &gt; width / 3 * 2)) Color.RED else if (y &gt; hight / 3 * 2 &amp;&amp; (x &lt;= width / 3 || x &gt; width / 3 * 2)) Color.GREEN else Color.BLUE } testImage.setRGB(x, y, color.getRGB) //    testImage</span></span></code> </pre><br>  As a result of the execution of this code, the following image is displayed: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/499/b59/811/499b59811386f85ef8c0cf68dd01a396.png"><br><br>  Next step: convert the image into a set of pixels.  By pixel we mean an entity with such properties: <br><br><ul><li>  coordinate on the wide side (x); <br></li><li>  coordinate on the narrow side (y); <br></li><li>  color value; <br></li><li>  optional class / cluster number (until clustering is empty). <br></li></ul><br>  It is convenient to use the <code>case class</code> as an entity: <br><br><pre> <code class="scala hljs"><span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Pixel</span></span></span><span class="hljs-class">(</span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">x: </span></span><span class="hljs-type"><span class="hljs-class"><span class="hljs-params"><span class="hljs-type">Int</span></span></span></span><span class="hljs-class"><span class="hljs-params">, y: </span></span><span class="hljs-type"><span class="hljs-class"><span class="hljs-params"><span class="hljs-type">Int</span></span></span></span><span class="hljs-class"><span class="hljs-params">, rgbArray: </span></span><span class="hljs-type"><span class="hljs-class"><span class="hljs-params"><span class="hljs-type">Array</span></span></span></span><span class="hljs-class"><span class="hljs-params">[</span></span><span class="hljs-type"><span class="hljs-class"><span class="hljs-params"><span class="hljs-type">Double</span></span></span></span><span class="hljs-class"><span class="hljs-params">], clusterNumber: </span></span><span class="hljs-type"><span class="hljs-class"><span class="hljs-params"><span class="hljs-type">Option</span></span></span></span><span class="hljs-class"><span class="hljs-params">[</span></span><span class="hljs-type"><span class="hljs-class"><span class="hljs-params"><span class="hljs-type">Int</span></span></span></span><span class="hljs-class"><span class="hljs-params">] = </span></span><span class="hljs-type"><span class="hljs-class"><span class="hljs-params"><span class="hljs-type">None</span></span></span></span></span><span class="hljs-class">)</span></span></code> </pre> <br>  Here, for the color values, the <code>rgbArray</code> array of three values ‚Äã‚Äãof red, green and blue is used (for example, for the red color <code>Array(255.0, 0, 0)</code> ). <br><br><pre> <code class="scala hljs"><span class="hljs-comment"><span class="hljs-comment">//      (Pixel) val pixels = for { x &lt;- (0 until testImage.getWidth).toArray y &lt;- (0 until testImage.getHeight) color = new Color(testImage.getRGB(x, y)) } yield Pixel(x, y, Array(color.getRed.toDouble, color.getGreen.toDouble, color.getBlue.toDouble)) //   10   pixels.take(10)</span></span></code> </pre> <br>  This completes the data preparation. <br><br><h2>  Clustering pixels by color </h2><br>  So, we have a collection of pixels of three primary colors, so we will cluster the pixels into three classes. <br><br><pre> <code class="scala hljs"><span class="hljs-comment"><span class="hljs-comment">//   val countColors = 3 //   val clusters = kmeans(pixels.map(_.rgbArray), k = countColors, runs = 20)</span></span></code> </pre> <br>  The documentation recommends setting the <code>runs</code> parameter in the range from 10 to 20. <br><br>  <code>KMeans</code> this code will create an object of type <code>KMeans</code> .  In the output block will be information about the results of clustering: <br><br><pre> <code class="bash hljs">K-Means distortion: 0.00000 Clusters of 230400 data points of dimension 3: 0 50813 (22.1%) 1 51667 (22.4%) 2 127920 (55.5%)</code> </pre> <br>  One of the clusters does contain more pixels than the rest.  Now we need to mark our collection of pixels with classes from 0 to 2. <br><br><pre> <code class="scala hljs"><span class="hljs-comment"><span class="hljs-comment">//    val clusteredPixels = (pixels zip clusters.getClusterLabel()).map {case (pixel, cluster) =&gt; pixel.copy(clusterNumber = Some(cluster))} //  10   clusteredPixels.take(10)</span></span></code> </pre> <br><h2>  Repaint the image </h2><br>  It remains the case for small - select the cluster with the largest number of pixels and repaint all the pixels included in this cluster in gray (change the value of the <code>rgbArray</code> array). <br><br><pre> <code class="scala hljs"><span class="hljs-comment"><span class="hljs-comment">//   val grayColor = Array(127.0, 127.0, 127.0) //       val blueClusterNumber = clusteredPixels.groupBy(pixel =&gt; pixel.clusterNumber) .map {case (clusterNumber, pixels) =&gt; (clusterNumber, pixels.size) } .maxBy(_._2)._1 //       val modifiedPixels = clusteredPixels.map { case p: Pixel if p.clusterNumber == blueClusterNumber =&gt; p.copy(rgbArray = grayColor) case p: Pixel =&gt; p } //  10      modifiedPixels.take(10)</span></span></code> </pre> <br>  There is nothing complicated here, we simply group by cluster number (this is our <code>Option:[Int]</code> ), count the number of elements in each group and pull out a cluster with the maximum number of elements.  Further, we change the color to gray only for those pixels that belong to the found cluster. <br><br><h2>  Create a new image and save the results. </h2><br>  We collect from the collection of pixels a new image: <br><br><pre> <code class="scala hljs"><span class="hljs-comment"><span class="hljs-comment">//       val modifiedImage = new BufferedImage(width, hight, BufferedImage.TYPE_INT_RGB) //     modifiedPixels.foreach { case Pixel(x, y, rgbArray, _) =&gt; val r = rgbArray(0).toInt val g = rgbArray(1).toInt val b = rgbArray(2).toInt modifiedImage.setRGB(x, y, new Color(r, g, b).getRGB) } //    modifiedImage</span></span></code> </pre> <br>  That's what, in the end, we did. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/950/d15/69a/950d1569a1bc51920f4758499a9bbe26.png"><br><br>  Save both images. <br><br><pre> <code class="scala hljs"><span class="hljs-type"><span class="hljs-type">ImageIO</span></span>.write(testImage, <span class="hljs-string"><span class="hljs-string">"png"</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-type"><span class="hljs-type">File</span></span>(<span class="hljs-string"><span class="hljs-string">"testImage.png"</span></span>)) <span class="hljs-type"><span class="hljs-type">ImageIO</span></span>.write(modifiedImage, <span class="hljs-string"><span class="hljs-string">"png"</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-type"><span class="hljs-type">File</span></span>(<span class="hljs-string"><span class="hljs-string">"modifiedImage.png"</span></span>))</code> </pre> <br><h2>  Conclusion </h2><br>  Machine learning on Scala exists.  To implement the basic algorithms, it is not necessary to drag some huge library.  The above example shows that in developing you can not give up the usual means, the same Jupyter Notebook can, without much difficulty, make friends with Scala. <br><br>  Of course, for a full review of all the possibilities;) one article is not enough, and this was not included in the plans.  The main task - to open the door to the world of machine learning on Scala - I consider accomplished.  Whether to use these tools, and, especially, to drag them in production or not, you decide! <br><br><h2>  Links </h2><br><ul><li>  Dockerfile for the Scala support Jupyter Notebook image: <a href="https://github.com/AntonYurchenko/docker/blob/master/jupyter-scala/Dockerfile">https://github.com/AntonYurchenko/docker/blob/master/jupyter-scala/Dockerfile</a> <br></li><li>  Git with an example: <a href="https://github.com/AntonYurchenko/habr/tree/master/scala-smile-clustering">https://github.com/AntonYurchenko/habr/tree/master/scala-smile-clustering</a> <br></li><li>  Apache Spark MLib: <a href="https://spark.apache.org/mllib/">https://spark.apache.org/mllib</a> <br></li><li>  Apache PredictionIO: <a href="http://predictionio.apache.org/index.html">http://predictionio.apache.org</a> <br></li><li>  Apache MXNet: <a href="https://mxnet.incubator.apache.org/">https://mxnet.incubator.apache.org</a> <br></li><li>  Smile: <a href="https://haifengl.github.io/smile/">https://haifengl.github.io/smile</a> <br></li><li>  Git BeakerX: <a href="https://github.com/twosigma/beakerx">https://github.com/twosigma/beakerx</a> <br></li></ul></div><p>Source: <a href="https://habr.com/ru/post/452914/">https://habr.com/ru/post/452914/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../45290/index.html">Lecturer for RMA students</a></li>
<li><a href="../452902/index.html">Finishing the 4th year of training for a programmer, I understand that I am far from a programmer</a></li>
<li><a href="../452906/index.html">JavaScript engines: how do they work? From the call stack to the promises, (almost) everything you need to know</a></li>
<li><a href="../452908/index.html">Selenium WebDriver - Real-time test metrics using Grafana and InfluxDB</a></li>
<li><a href="../45291/index.html">Prince of Persia - trailer gameplay demonstration and some screenshots.</a></li>
<li><a href="../452916/index.html">Get up and go. Spinal surgery: when to do, what is dangerous</a></li>
<li><a href="../45292/index.html">PhpMathPublisher - Math Formulas in HTML</a></li>
<li><a href="../452922/index.html">Flexible tables on CSS Grid</a></li>
<li><a href="../452926/index.html">Static testing or save Private Ryan</a></li>
<li><a href="../452930/index.html">About beer through the eyes of a chemist. Part 1</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>