<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>MS SQL: generating pseudo-random data using newID (). Opportunities and pitfalls</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="It is known that the built-in function newID () is widely used by developers not only for their intended purpose ‚Äî that is, for generating unique prim...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>MS SQL: generating pseudo-random data using newID (). Opportunities and pitfalls</h1><div class="post__text post__text-html js-mediator-article">  It is known that the built-in function newID () is widely used by developers not only for their intended purpose ‚Äî that is, for generating unique primary keys, but also as a means for generating pseudo-random data arrays. <a name="habracut"></a><br>  As part of the built-in functions, newID () is actually the only one that is not only non-deterministic, but one can also say ‚Äúsuper-non-deterministic‚Äù, since  unlike all the others, it is capable of producing a new value for each new line, and not the same for the whole batch - which makes it extremely useful for such mass generation.  In addition to newID (), this property also has newSequentialID (), but its use elsewhere, except in defining the default value of uniqueidentifier columns, is prohibited. <br>  There is no need to go far for examples - below is the code <br><br><pre><code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> TOP <span class="hljs-number"><span class="hljs-number">100</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ABS</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">CHECKSUM</span></span>(NEWID())) % <span class="hljs-number"><span class="hljs-number">1000</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> sysobjects A <span class="hljs-keyword"><span class="hljs-keyword">CROSS</span></span> <span class="hljs-keyword"><span class="hljs-keyword">JOIN</span></span> sysobjects B</code> </pre> <br>  or this one (if it seems that checksum is a laborious operation): <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> TOP <span class="hljs-number"><span class="hljs-number">100</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ABS</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">CONVERT</span></span>(<span class="hljs-built_in"><span class="hljs-built_in">INT</span></span>, (<span class="hljs-keyword"><span class="hljs-keyword">CONVERT</span></span>(<span class="hljs-built_in"><span class="hljs-built_in">BINARY</span></span>(<span class="hljs-number"><span class="hljs-number">4</span></span>), (NEWID()))))) % <span class="hljs-number"><span class="hljs-number">1000</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> sysobjects A <span class="hljs-keyword"><span class="hljs-keyword">CROSS</span></span> <span class="hljs-keyword"><span class="hljs-keyword">JOIN</span></span> sysobjects B</code> </pre><br>  Generates a table of 100 random integers in the range from 0 to 999. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      For floating numbers, you can use the property of the rand () function to initialize the generator with an integer number: <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> TOP <span class="hljs-number"><span class="hljs-number">100</span></span> <span class="hljs-keyword"><span class="hljs-keyword">RAND</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">CHECKSUM</span></span>(NEWID())) <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> sysobjects A <span class="hljs-keyword"><span class="hljs-keyword">CROSS</span></span> <span class="hljs-keyword"><span class="hljs-keyword">JOIN</span></span> sysobjects B</code> </pre><br>  In this case, rand () is used as a matter of fact simply as a converter of the int32 range to the range [0..1).  The statistical quality check of the distribution of this method on the number of records of the order of a million shows that it is not inferior to the standard use of rand (), initialized once, and then used in the loop.  Therefore - you can safely use. <br><br>  Another interesting option is the generation of normally distributed data.  Here we will use the <a href="http://ru.wikipedia.org/wiki/%25D0%259F%25D1%2580%25D0%25B5%25D0%25BE%25D0%25B1%25D1%2580%25D0%25B0%25D0%25B7%25D0%25BE%25D0%25B2%25D0%25B0%25D0%25BD%25D0%25B8%25D0%25B5_%25D0%2591%25D0%25BE%25D0%25BA%25D1%2581%25D0%25B0_%25E2%2580%2594_%25D0%259C%25D1%258E%25D0%25BB%25D0%25BB%25D0%25B5%25D1%2580%25D0%25B0">Box-Muller</a> method: <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> TOP <span class="hljs-number"><span class="hljs-number">1000</span></span> <span class="hljs-keyword"><span class="hljs-keyword">COS</span></span>(<span class="hljs-number"><span class="hljs-number">2</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">PI</span></span>() * <span class="hljs-keyword"><span class="hljs-keyword">RAND</span></span>(BINARY_CHECKSUM(NEWID()))) * <span class="hljs-keyword"><span class="hljs-keyword">SQRT</span></span>(<span class="hljs-number"><span class="hljs-number">-2</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">LOG</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">RAND</span></span>(BINARY_CHECKSUM(NEWID())))) <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> sysobjects A <span class="hljs-keyword"><span class="hljs-keyword">CROSS</span></span> <span class="hljs-keyword"><span class="hljs-keyword">JOIN</span></span> sysobjects B <span class="hljs-keyword"><span class="hljs-keyword">CROSS</span></span> <span class="hljs-keyword"><span class="hljs-keyword">JOIN</span></span> sysobjects C</code> </pre><br>  Those interested can check that the generated distribution is very close to normal by plotting. <br><br>  All this works well and allows you to very quickly generate at least ten million records without using head-on solutions such as cycles, cursors, or even inserting records one by one into the base from the application layer.  You just need to make sure that the tables that you use as the source of rows have sufficient capacity, and either increase the number of CROSS JOINs, or use the table variables with the required number of rows as the source. <br><br>  However, the topic is not only about this.  In the overwhelming majority of cases, the generated rows materialize, that is, they are inserted into a permanent or temporary table, or into a table variable.  If so, then you can not read further - materialized data will work fine.  However, there are cases when the above statements are used in subqueries.  And here there are difficult at first sight features of the SQL engine behavior.  Consider them with examples, and then try to analyze why this is happening, and how to deal with it: <br><br>  To begin, just write a statement with newID () in the subquery and run it several times in a loop: <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">declare</span></span> @c <span class="hljs-built_in"><span class="hljs-built_in">int</span></span> = <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> @c &lt; <span class="hljs-number"><span class="hljs-number">5</span></span> <span class="hljs-keyword"><span class="hljs-keyword">begin</span></span> <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> ( <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ABS</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">CONVERT</span></span>(<span class="hljs-built_in"><span class="hljs-built_in">INT</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">CONVERT</span></span>(<span class="hljs-built_in"><span class="hljs-built_in">BINARY</span></span>(<span class="hljs-number"><span class="hljs-number">4</span></span>), NEWID()))) % <span class="hljs-number"><span class="hljs-number">5</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> RNDIDX <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> ( <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ID</span></span> ) ROWSRC ) SUBQ <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> @c = @c + <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">end</span></span></code> </pre><br>  The code works as expected - it gives out 5 rezaltsets, each one has exactly one entry with a number in the range from 0 to 4. I do not give a screenshot of the results - when everything is alright, there is little sense in them. <br><br>  Now more interesting.  We try to fire the result from SUBQ to some other table.  You can create it, or you can set up subquery on subquery - the result will not change.  We write: <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">declare</span></span> @c <span class="hljs-built_in"><span class="hljs-built_in">int</span></span> = <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> @c &lt; <span class="hljs-number"><span class="hljs-number">5</span></span> <span class="hljs-keyword"><span class="hljs-keyword">begin</span></span> <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> ( <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ABS</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">CONVERT</span></span>(<span class="hljs-built_in"><span class="hljs-built_in">INT</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">CONVERT</span></span>(<span class="hljs-built_in"><span class="hljs-built_in">BINARY</span></span>(<span class="hljs-number"><span class="hljs-number">4</span></span>), NEWID()))) % <span class="hljs-number"><span class="hljs-number">5</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> RNDIDX <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> ( <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ID</span></span> ) ROWSRC ) SUBQ <span class="hljs-keyword"><span class="hljs-keyword">INNER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">JOIN</span></span> ( <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> VAL <span class="hljs-keyword"><span class="hljs-keyword">UNION</span></span> ALL <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">UNION</span></span> ALL <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> <span class="hljs-number"><span class="hljs-number">2</span></span> <span class="hljs-keyword"><span class="hljs-keyword">UNION</span></span> ALL <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> <span class="hljs-number"><span class="hljs-number">3</span></span> <span class="hljs-keyword"><span class="hljs-keyword">UNION</span></span> ALL <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> <span class="hljs-number"><span class="hljs-number">4</span></span> ) <span class="hljs-keyword"><span class="hljs-keyword">NUM</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> SUBQ.RNDIDX = NUM.VAL <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> @c = @c + <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">end</span></span></code> </pre><br>  Look at the screenshot of the result of the execution - and slowly crawl under the chair - the number of lines in each rezalset is not strictly 1. .4] (which is unbelievable in itself!)), And somewhere - more than one (!) Record. <br><br><img src="https://lh4.googleusercontent.com/-wQKahIsVeBg/UW-_Fn9to-I/AAAAAAAAAAs/XjiK7LuKpPU/s487/resultset1.gif" alt="image"><br><br>  Now we are doing an innocent change - change INNER to LEFT: <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">declare</span></span> @c <span class="hljs-built_in"><span class="hljs-built_in">int</span></span> = <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> @c &lt; <span class="hljs-number"><span class="hljs-number">5</span></span> <span class="hljs-keyword"><span class="hljs-keyword">begin</span></span> <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> ( <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ABS</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">CONVERT</span></span>(<span class="hljs-built_in"><span class="hljs-built_in">INT</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">CONVERT</span></span>(<span class="hljs-built_in"><span class="hljs-built_in">BINARY</span></span>(<span class="hljs-number"><span class="hljs-number">4</span></span>), NEWID()))) % <span class="hljs-number"><span class="hljs-number">5</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> RNDIDX <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> ( <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ID</span></span> ) ROWSRC ) SUBQ <span class="hljs-keyword"><span class="hljs-keyword">LEFT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">JOIN</span></span> ( <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> VAL <span class="hljs-keyword"><span class="hljs-keyword">UNION</span></span> ALL <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">UNION</span></span> ALL <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> <span class="hljs-number"><span class="hljs-number">2</span></span> <span class="hljs-keyword"><span class="hljs-keyword">UNION</span></span> ALL <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> <span class="hljs-number"><span class="hljs-number">3</span></span> <span class="hljs-keyword"><span class="hljs-keyword">UNION</span></span> ALL <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> <span class="hljs-number"><span class="hljs-number">4</span></span> ) <span class="hljs-keyword"><span class="hljs-keyword">NUM</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> SUBQ.RNDIDX = NUM.VAL <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> @c = @c + <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">end</span></span></code> </pre><br>  We carry out - everything began to work correctly (!) - check plz yourself, I didn‚Äôt take a screenshot for proper work.  Note that since for any RNDIDX value from the range [0..4] that is capable of issuing SUBQ subquery, there is always a VAL value from the NUM subquery, from the logical point of view the result LEFT and INNER JOIN must be the same.  However, in fact it is not so! <br><br>  Another test is returning INNER, but adding TOP / ORDER BY to the first subquery.  Why - more on that later, let's just try: <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">declare</span></span> @c <span class="hljs-built_in"><span class="hljs-built_in">int</span></span> = <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> @c &lt; <span class="hljs-number"><span class="hljs-number">5</span></span> <span class="hljs-keyword"><span class="hljs-keyword">begin</span></span> <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> ( <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> TOP <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ABS</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">CONVERT</span></span>(<span class="hljs-built_in"><span class="hljs-built_in">INT</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">CONVERT</span></span>(<span class="hljs-built_in"><span class="hljs-built_in">BINARY</span></span>(<span class="hljs-number"><span class="hljs-number">4</span></span>), NEWID()))) % <span class="hljs-number"><span class="hljs-number">5</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> RNDIDX <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> ( <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ID</span></span> ) ROWSRC <span class="hljs-keyword"><span class="hljs-keyword">ORDER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BY</span></span> RNDIDX ) SUBQ <span class="hljs-keyword"><span class="hljs-keyword">INNER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">JOIN</span></span> ( <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> VAL <span class="hljs-keyword"><span class="hljs-keyword">UNION</span></span> ALL <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">UNION</span></span> ALL <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> <span class="hljs-number"><span class="hljs-number">2</span></span> <span class="hljs-keyword"><span class="hljs-keyword">UNION</span></span> ALL <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> <span class="hljs-number"><span class="hljs-number">3</span></span> <span class="hljs-keyword"><span class="hljs-keyword">UNION</span></span> ALL <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> <span class="hljs-number"><span class="hljs-number">4</span></span> ) <span class="hljs-keyword"><span class="hljs-keyword">NUM</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> SUBQ.RNDIDX = NUM.VAL <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> @c = @c + <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">end</span></span></code> </pre><br>  Everything works correctly again!  Mystic! <br><br>  Googling, we find out that SQL developers from all over the world periodically encounter such behavior - examples <a href="http://stackoverflow.com/questions/9463938/checksumnewid-executes-multiple-times-per-row">here</a> or <a href="http://social.msdn.microsoft.com/Forums/en-US/transactsql/thread/9b1041f7-dc91-4672-94b0-60311b80a121/">here</a> <br><br>  People assume that materializing subquery helps.  Indeed, if you rewrite the example by first selecting the records in an explicit form in the temporary table, and then just by clicking it, everything works fine.  Why does the replacement of INNER affect LEFT for normal operation, or the addition of TOP / ORDER BY where it is not needed?  All for the same reason - in one case there is a materialization of the subquery results, in the other - no.  A clearer difference can be shown by an analysis of the plan of a more detailed case, for example, this: <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">DECLARE</span></span> @B <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> (VAL <span class="hljs-built_in"><span class="hljs-built_in">INT</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">INSERT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INTO</span></span> @B <span class="hljs-keyword"><span class="hljs-keyword">VALUES</span></span> (<span class="hljs-number"><span class="hljs-number">0</span></span>), (<span class="hljs-number"><span class="hljs-number">1</span></span>), (<span class="hljs-number"><span class="hljs-number">2</span></span>), (<span class="hljs-number"><span class="hljs-number">3</span></span>), (<span class="hljs-number"><span class="hljs-number">4</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> ( <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ABS</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">CONVERT</span></span>(<span class="hljs-built_in"><span class="hljs-built_in">INT</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">CONVERT</span></span>(<span class="hljs-built_in"><span class="hljs-built_in">BINARY</span></span>(<span class="hljs-number"><span class="hljs-number">4</span></span>), NEWID()))) % <span class="hljs-number"><span class="hljs-number">5</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> RNDIDX <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> @B ) SUBQ <span class="hljs-keyword"><span class="hljs-keyword">INNER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">JOIN</span></span> @BB <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> SUBQ.RNDIDX = B.VAL  ,   (<span class="hljs-keyword"><span class="hljs-keyword">query</span></span> <span class="hljs-number"><span class="hljs-number">2</span></span>),   @B    :</code> </pre><img src="https://lh4.googleusercontent.com/-SbEQADflEAc/UW_eq3oA7NI/AAAAAAAAACY/y1vfsJe3RUM/s1110/execplan1.gif" alt="image"><br><br>  We see that the query splices two threads of rows before calculating the value of a column that depends on newID ().  This may occur because the SQL engine considers that the value returned by newID (), although non-deterministic, does not change during the entire batch.  However, this is not the case - and most likely, therefore, the request does not work correctly.  Now we change the INNER to LEFT, and see the plan: <br><br><img src="https://lh3.googleusercontent.com/-_CPThga5zcI/UW_hf1GooSI/AAAAAAAAAC0/3AVcvg1TBpk/s1111/execplan2.gif" alt="image"><br><br>  Yeah, LEFT JOIN made the SQL engine execute Compute Scalar before merging threads, so our query started working correctly. <br><br>  Finally, check the version with the addition of TOP / ORDER BY: <br><br><img src="https://lh4.googleusercontent.com/-LH1ksOnbepM/UW_iWVgJE6I/AAAAAAAAADQ/gA3UADaqRrg/s1111/execplan3.gif" alt="image"><br><br>  Actually, the diagnosis is clear.  MS SQL does not take into account the peculiarities of newID (), and accordingly, it plans incorrectly, relying on the constant value returned by the function in the scoped batch.  There is a work around for this feature - to force the SQL engine to materialize the sample by any means before using it in dependent queries.  How you will materialize is your business, but it‚Äôs best to use tabular variables, especially if the size of the subsample is small.  Otherwise, the result, to put it mildly, is not 100% guaranteed;  In addition, there is no guarantee that one day you yourself, or someone else, will not unmask the code by throwing out the ‚Äúunnecessary‚Äù TOP / ORDER BY or wisely replacing LEFT with INNER. <br><br>  Actually, everything.  Successful SQL programming! </div><p>Source: <a href="https://habr.com/ru/post/177221/">https://habr.com/ru/post/177221/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../177203/index.html">22 years in orbit</a></li>
<li><a href="../177209/index.html">High-capacity 3600mAh HLI-820XL Battery for Nokia Lumia 820</a></li>
<li><a href="../177215/index.html">Collecting advanced upstream statistics using nginx-sla</a></li>
<li><a href="../177217/index.html">Knowledge Base. Part 2. Freebase: making requests to the Google Knowledge Graph</a></li>
<li><a href="../177219/index.html">ASP.NET MVC and unobtrusive validation with Backbone.js</a></li>
<li><a href="../177223/index.html">Racoon vs. OpenSWAN: Configuring IPSEC VPN HOST-TO-SITE Tunnel with Cisco and L2TP over IPSEC for Windows, iOS and Android</a></li>
<li><a href="../177225/index.html">Time management on a personal example: 10 theses</a></li>
<li><a href="../177227/index.html">CRUD application on Ext JS and Ruby on Rails in 7 minutes</a></li>
<li><a href="../177229/index.html">An agreement on the development of the site, design, software. Version 1.1</a></li>
<li><a href="../177233/index.html">Conference ‚ÄúStrike! 2013 ". Small report</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>