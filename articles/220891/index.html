<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Running FreeBSD in the Microsoft Azure Cloud</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Since FreeBSD 10 finally has Hyper-V support already in the standard package of x64 release (x86 needs some tweaking), but Microsoft Azure does not ye...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Running FreeBSD in the Microsoft Azure Cloud</h1><div class="post__text post__text-html js-mediator-article">  Since FreeBSD 10 finally has Hyper-V support already in the standard package of x64 release (x86 needs some tweaking), but Microsoft Azure does not yet have direct support for creating a FreeBSD-based virtual machine, I decided to tell you how to install FreeBSD 10 in azure.  There is nothing particularly difficult, except that you will have to pour a lot into the cloud.  And so - in order. <br><a name="habracut"></a><br>  I don‚Äôt see taking iso and making zero sense, since the FreeBsd community releases ready-made images of virtual machines with the latest / stable releases.  There we will take the necessary, already installed image in * .VHD format.  Keep in mind - * .VDHX does not yet support azure. <br>  On the other hand, if you already have an installed system, you can use it. <br><br>  And so, we take the x64 release of FreeBSD 10 in the * .VHD format with <a href="">ftp.FreeBSD.org</a> , the x86 build just won't start - keep in mind. <br>  <a href="">The choice of images there is big</a> , you can both stable and current and even 11 to try, but for the sake of business.  Take release.  By the way, images are available in QEMU and VMWARE formats. <br><br>  The first thing we will face is that the drive for azure should be fixed, not dynamic.  That is, it must be exactly the same size as recorded in it.  Dynamic extension is not supported by azure.  Our Freebsd image unpacked occupies ~ 900mb, and the disk there is marked up as 20gb. <br>  The good news is that the <b>Add-AzureVHD command</b> from <a href="http://azure.microsoft.com/en-us/documentation/articles/install-configure-powershell/">Azure PowerShell is</a> able to convert dynamic to fixed on the fly.  Pouring 900mb instead of 20gb is a big difference.  We will use it at the end. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      The second.  Since the image is ‚Äúnaked‚Äù, you need to adjust it a bit to work in azure.  For this, you can use the Hyper-V hypervisor built into Windows or <a href="https://www.virtualbox.org/wiki/Downloads">Oracle VirtualBox</a> .  My processor does not support SLAT (Windows 8 requires SLAT for the hypervisor, and I didn‚Äôt want to install Windows Server 2012R2 just for the sake of this), so VirtualBox was chosen.  But apparently qemu (the freebsd community seems to use it to create a VHD image) or VirtualBox is somehow not friendly with each other.  You have to rebuild the disk using a third-party utility <a href="http://www.ccboot.com/download/vhdtools/">VhdResize</a> .  In it, we change the size of the disk from 20480mb to 1mb more, to 20481mb.  In this case, we leave the type of disk as Dynamic.  The process is not long, so do not worry.  This nonsense is required only for VirtualBox - it is quite possible that Hyper-V will pick up the disk and so (I can not check it). <br><br>  Create a virtual machine with our already modified disk and boot into FreeBSD. <br><br>  And here we have a choice.  We can create a vm image (virtual machine - template), which will be configured by itself under azure or vm disk - here you are responsible for the configuration of the system under azure. <br><br>  And so, what we need to create a disk, where we will set everything up: <br><br>  Create the file /etc/rc.conf and write there: <br><br><pre><code class="bash hljs">ifconfig_hn0=<span class="hljs-string"><span class="hljs-string">"SYNCDHCP"</span></span> hostname=<span class="hljs-string"><span class="hljs-string">"yourvmname.cloudapp.net"</span></span> sshd_enable=<span class="hljs-string"><span class="hljs-string">"YES"</span></span></code> </pre> <br>  <b>hn0</b> - this will be the interface of the virtual network adapter in azure (in VirtualBox it will be em0, in case you need to download something from the network during setup). <br>  <b>Yourvmname</b> is the name that you later give to the virtual machine in azure.  Then you can change it, so that it is possible to choose it at random in rc.conf. <br>  <b>sshd_enable = "YES"</b> - without this, the sshd daemon will not start.  And so it is clear. <br><br>  You can edit it using the ee editor (vi is a very obnoxious editor): <br><br><pre> <code class="bash hljs"><span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> /etc ee rc.conf</code> </pre><br>  then go to <b>/ etc / ssh</b> and edit <b>sshd_config</b> for login resolution for root.  <b>Look</b> for <b>#PermitRootLogin no</b> , uncomment and write <b>yes</b> , we get <b>PermitRootLogin yes</b> .  Otherwise, there will be no sense from sshd - we will not go under the root. <br>  You also need to set a password for root through <b>passwd</b> .  By default it is not. <br><br>  <b>See for yourself about login permissions for root - you can create a user for ssh and root login is not allowed.</b> <br><br>  That's all for creating a vm disk. <br><br>  If you decide you want to make a vm image (image), that in the ideology of running machines in the cloud is the most correct solution, we will need something completely different. <br><br>  We take <a href="">WALinuxAgent</a> .  It is needed to connect the virtual machine with the azure hypervisor and configure the system (provision).  Install into the system: <b>python27, py27-asn1, sudo</b> , copy to the waagent system in the <b>/ usr / sbin</b> folder and install it: <b>/ usr / sbin / waagent -install</b> . <br>  You can read more about what WALinuxAgent does on their github page. <br><br>  in rc.conf, we only need to add sshd launch and network: <br><br><pre> <code class="bash hljs">ifconfig_hn0=<span class="hljs-string"><span class="hljs-string">"SYNCDHCP"</span></span> sshd_enable=<span class="hljs-string"><span class="hljs-string">"YES"</span></span></code> </pre><br><br>  waagent will add its own daemon launch to rc.conf during installation. <br><br>  That's all for creating vm image. <br><br>  At the moment, waagent starts with some problems (not everything does) and the team actively fixes it on the bugs I found. <br><br>  If you are good at FreeBSD, you can tune everything for yourself.  For example, I remove the delay when the system boots - why wait for the download for an extra 10 seconds if no one else can click anything there. <br><br>  To do this, you will need to create a file loader.conf in the / boot folder and add to it: <br><br><pre> <code class="bash hljs">beastie_disable=<span class="hljs-string"><span class="hljs-string">"YES"</span></span> autoboot_delay=<span class="hljs-string"><span class="hljs-string">"-1"</span></span></code> </pre><br>  And so, we finish setup and <b>shutdown -p now</b> <br><br>  Third.  We need to fill this our disk in azure.  Go to azure -&gt; storage -&gt; create a storage account (if not) -&gt; container (if not). <br><br>  We open <a href="http://azure.microsoft.com/en-us/documentation/articles/install-configure-powershell/">Azure PowerShell</a> , we will become authorized (it seemed to me that it is the most convenient through Certificate method). <br><br>  And fill the disk in azure storage: <br><br><pre> <code class="bash hljs">Add-AzureVhd -Destination http://storage.blob.core.windows.net//.vhd -LocalFilePath :\vhd\.vhd</code> </pre><br><br>  Fourth.  It's simple.  Go to Virtual Machines -&gt; Disk or VM Image and create a disk or image from the file that we uploaded to storage. <br><br>  Create disc: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/a46/0bc/4ef/a460bc4ef469f3987b4fd360324a1a4c.png" alt="image"><br><br>  Creating a vm image: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/b88/18b/17d/b8818b17d70050dc9c67c08a0c3ed211.png"><br><br>  Next, switch to virtual machines and create a machine with our disk / image.  Everything should now work. <br><br>  If you initially created vm image, do not create disks with it - you will not be able to log in.  It will start, but will not be available from the outside.  And vice versa is also not necessary.  Soon I hope to make a port for WALinuxAgent. <br><br>  And here is the finished image in <a href="http://vmdepot.msopentech.com/Vhd/Show%3FvhdId%3D36254">Microsoft Depot</a> .  We take, we put and no nails. <br><br>  That's all the difficulty with installing FreeBSD in azure. </div><p>Source: <a href="https://habr.com/ru/post/220891/">https://habr.com/ru/post/220891/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../220879/index.html">Addon for Overclock`a consciousness or flashback pro</a></li>
<li><a href="../220883/index.html">Practice refactoring. Envious features</a></li>
<li><a href="../220885/index.html">Use RestKit 0.22.x to view Marvel heroes.</a></li>
<li><a href="../220887/index.html">Our journey begins</a></li>
<li><a href="../220889/index.html">YotaPhone, Android and a bit of cryptography</a></li>
<li><a href="../220893/index.html">Iron Budget Habramerka (ZhBH) karma, rating habratopika and other parameters on arduino + openwrt</a></li>
<li><a href="../220897/index.html">TI-84 +</a></li>
<li><a href="../220899/index.html">Solar batteries - 60 years</a></li>
<li><a href="../220901/index.html">Dell Desktop Virtualization Forum 2014</a></li>
<li><a href="../220903/index.html">Eversync - now with iOS and Windows Phone support</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>