<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>R, GIS and fuzzyjoin: restore statistics for the NUTS regions</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="In this post we will talk about how I restored the demographic data for the regions of Denmark, where after the reform of the territorial structure of...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>R, GIS and fuzzyjoin: restore statistics for the NUTS regions</h1><div class="post__text post__text-html js-mediator-article"><p>  In this post we will talk about how I restored the demographic data for the regions of Denmark, where after the reform of the territorial structure of 2007 there was no official data harmonization.  This is only a small part of the harmonization of Eurostat data, which I performed as part of <a href="http://nidi.nl/en/research/al/270rdc">my phd project</a> .  The post was first published <a href="https://ikashnitsky.github.io/2017/denmark-nuts-reconstruction/">in my English-language blog</a> and <a href="https://demotrends.wordpress.com/2017/03/16/working-with-spatial-data-to-generate-a-consistent-demographic-time-series/">Demotrends</a> blog.  I think that it may be of some interest not only to demographers. </p><br><h2 id="chto-takoe-nuts">  What is NUTS? </h2><br><p>  NUTS stands for <a href="http://ec.europa.eu/eurostat/web/nuts/overview"><em>Nomenclature of Territorial Units For Statistics</em></a> .  This is a standardized system of administrative and territorial division adopted by the EU countries.  The story goes back to the 1970s, when the idea was born to make the regions of various European countries comparable.  In a more or less complete and widely used form, the system appeared only at the turn of the century.  There are three main levels of NUTS (see Fig. 1), and NUTS-2 is the most common in regional analysis. </p><br><p> <a href=""><img src="https://habrastorage.org/files/d99/404/59f/d9940459f16844c6ac6016661223512f.png" alt="fig1"></a> <br>  <em>Figure 1. Illustration of the principle of distinguishing NUTS regions of various hierarchical levels</em> </p><a name="habracut"></a><br><p>  The main task of NUTS was to create comparable criteria for identifying regions of different hierarchical levels.  However, in 2013, the population of the Regins of the NUTS-2 level ranged from 28.5 thousand people.  ( <em>Aland island</em> , Finland) to almost 12 million people ( <em>Ile-de-France</em> , France - Paris and its environs). </p><br><h2 id="ne-sopostavimye-ryady-dannyh">  Not comparable data series </h2><br><p>  Rather conditional in its essence, the administrative-territorial division does not remain unchanged and is constantly transforming.  Changes in territorial systems create significant difficulties for long-term analysis of processes at the regional level, since the linking of old and new regions is a laborious and not always uniquely solvable task (if you are interested, you can look at Russian regions <a href="https://ikashnitsky.github.io/doc/pubs/1412-nidi-wp-ik.pdf">in my old work</a> - annexes 1 and 2 at the end).  But despite the obvious difficulties for regional statistics, the boundaries change constantly in accordance with the requirements of state managers at various levels.  Eurostat <a href="http://ec.europa.eu/eurostat/web/nuts/history">records all changes</a> occurring in the NUTS regions and publishes detailed explanations (Fig. 2). </p><br><p> <a href=""><img src="https://habrastorage.org/files/507/3eb/4cf/5073eb4cf0524c5e9bebb3500a7a70e9.png" alt="fig2"></a> <br>  <em>Figure 2. Changes in the NUTS system between 2006 and 2010</em> </p><br><p>  Despite this, Eurostat does not always recalculate in order to dock the current territorial division with historical statistics.  In practice, this means that for the most current versions of NUTS, the data contain a significant number of gaps in cases where the boundaries of the regions have changed.  Therefore, researchers have to independently harmonize data in order to explore sufficiently long time periods.  Of course, the data recovery process is replete with assumptions, sometimes rather coarse, that allow us to evaluate statistical indicators for regions that have never existed in the past. </p><br><p>  In addition, the work is complicated by the fact that Eurostat publishes data only for the current version of NUTS (at least I have not found where to download archived datasets - I will be grateful for the tip, if they still exist somewhere).  As part of my PhD project, I conduct a regional analysis at the NUTS-2 level.  To ensure the longest observation period, in 2015, when I did the main work on data harmonization, I chose the 2010 version of NUTS, on which the official regional demographic forecast <a href="http://ec.europa.eu/eurostat/web/population-demography-migration-projections/population-projections-data">EUROPOP2013 was based</a> .  In order to reproduce the results, I laid out on <a href="https://figshare.com/">figshare</a> copies of the initial data at the NUTS level about the <a href="https://doi.org/10.6084/m9.figshare.3084394">age structures of the population</a> and <a href="https://doi.org/10.6084/m9.figshare.3084418">deaths</a> downloaded in 2015. </p><br><h2 id="daniya">  Denmark </h2><br><p>  Some countries had to make large-scale reforms of the administrative-territorial division in order to meet the standards of NUTS.  <a href="http://www.tandfonline.com/doi/abs/10.1080/03003930903560562">The most significant changes occurred simultaneously in Denmark in 2007</a> , when 271 old municipalities were transformed into 98 new ones (see the <a href="https://doi.org/10.1080/03003930903560562">scientific article on reform</a> ).  The same reform introduced NUTS for Denmark: 98 new municipalities united in 11 NUTS-3 regions, which in turn united in 5 NUTS-2 regions.  The NUTS-1 level does not stand out, which is typical for small countries like Denmark. </p><br><p>  As far as I know, no attempts were made to restore data for NUTS regions of Denmark until 2007 at the official level.  A typical map of European regions published by Eurostat for the period up to 2007 looks like this (Fig. 3) - ‚Äúno data available‚Äù for the Danish regions. </p><br><p> <a href=""><img src="https://habrastorage.org/files/d3c/562/94d/d3c56294d67143bd99ab372b3cfb02a4.png" alt="fig3"></a> <br>  <em>Figure 3. Life expectancy in the NUTS-2 regions of Europe, 2006;</em>  <em>Screenshot of Eurostatov's <a href="http://ec.europa.eu/eurostat/cache/RCI">interactive data exploratory tool</a></em> </p><br><p>  Such a lack of data is extremely surprising for a country as highly developed in many respects as Denmark.  It can be quite difficult to reconcile the old and new systems of municipal division, but aggregating municipal data at much higher hierarchical levels of NUTS is not that difficult.  And this is exactly what I did and I want to show in this post.  I spent quite a lot of effort to find out if someone else had done this before me - much to my surprise, I did not find anything in the public domain. </p><br><p>  The task, in essence, is to correlate the old municipalities (271) with the modern NUTS-3 regions (11) and then simply aggregate the data at the NUTS-3 level.  Further, NUTS-3 is elementarily aggregated to NUTS-2.  Such a task can take long evenings, especially if you take into account all the joy of messing around with the charming Danish names of the municipalities.  But, fortunately, we live in the GIS era.  I used GIS to almost automatically connect old municipalities with NUTS-3 regions.  Further, the whole process is shown step by step with the code <a href="https://cran.r-project.org/">R.</a> </p><br><h2 id="dannye">  Data </h2><br><p>  Data on the age structure of the old 271 municipalities in Denmark are taken from the <a href="http://www.statbank.dk/BEF1A">official website of Statistics Denmark</a> .  The system allows you to download at once only 10K records for unregistered users and 100K after registration.  Given the detail of our data, the process of uploading data is a rather tedious job.  Therefore, for the tasks of my research, I downloaded the data for 2001-2006.  If necessary, detailed municipal data have been available since 1979.  Data downloaded by me in 2015 and slightly formatted before use are <a href="">here</a> . </p><br><p>  The search for the spatial data file of the borders of the old Danish municipalities took considerable time.  Returning to this question a year and a half later, I did not manage to find the original source of the shapefile.  But I'm pretty sure I downloaded it <a href="http://www.geodatabiblioteket.dk/index.php">from here</a> .  Today there is a visit notice that data is not available due to scheduled work.  Copy of used shapefile <a href="">here</a> . </p><br><p>  Finally, for the successful implementation of our plans, we need the boundaries of the NUTS-3 regions.  Everything is simple - data is available on the Eurostat website ( <a href="http://ec.europa.eu/eurostat/web/gisco/geodata/reference-data/administrative-units-statistical-units/nuts">Eurostat geodata repository</a> ).  The archived shapefile I used is called "NUTS_2010_20M_SH.zip".  A sample of 11 Danish regions is <a href="">here</a> . </p><br><p>  The geographical projection used for both shapefiles is <a href="https://epsg.io/3044">ESPG-3044</a> , which is fairly standard for Denmark. </p><br><p>  Finally, the R code preparing the session and downloading the data (I do not translate the comments on the code). </p><br><pre><code class="hljs pgsql"># <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> locale <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> <span class="hljs-keyword"><span class="hljs-keyword">encoding</span></span> parameters <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> <span class="hljs-keyword"><span class="hljs-keyword">read</span></span> Danish <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(Sys.<span class="hljs-keyword"><span class="hljs-keyword">info</span></span>()[<span class="hljs-string"><span class="hljs-string">'sysname'</span></span>]=="Linux"){ Sys.setlocale("LC_CTYPE", "da_DK.utf8") danish_ecnoding &lt;- "WINDOWS-1252" }<span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(Sys.<span class="hljs-keyword"><span class="hljs-keyword">info</span></span>()[<span class="hljs-string"><span class="hljs-string">'sysname'</span></span>]=="Windows"){ Sys.setlocale("LC_CTYPE", "danish") danish_ecnoding &lt;- "Danish_Denmark.1252" } # <span class="hljs-keyword"><span class="hljs-keyword">load</span></span> required packages (install first <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> needed) library(tidyverse) # <span class="hljs-keyword"><span class="hljs-keyword">version</span></span>: <span class="hljs-number"><span class="hljs-number">1.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span> library(ggthemes) # <span class="hljs-keyword"><span class="hljs-keyword">version</span></span>: <span class="hljs-number"><span class="hljs-number">3.3</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span> library(rgdal) # <span class="hljs-keyword"><span class="hljs-keyword">version</span></span>: <span class="hljs-number"><span class="hljs-number">1.2</span></span><span class="hljs-number"><span class="hljs-number">-4</span></span> library(rgeos) # <span class="hljs-keyword"><span class="hljs-keyword">version</span></span>: <span class="hljs-number"><span class="hljs-number">0.3</span></span><span class="hljs-number"><span class="hljs-number">-21</span></span> library(RColorBrewer) # <span class="hljs-keyword"><span class="hljs-keyword">version</span></span>: <span class="hljs-number"><span class="hljs-number">1.1</span></span><span class="hljs-number"><span class="hljs-number">-2</span></span> mypal &lt;- brewer.pal(<span class="hljs-number"><span class="hljs-number">11</span></span>, "BrBG") library(fuzzyjoin) # <span class="hljs-keyword"><span class="hljs-keyword">version</span></span>: <span class="hljs-number"><span class="hljs-number">0.1</span></span><span class="hljs-number"><span class="hljs-number">.2</span></span> library(viridis) # <span class="hljs-keyword"><span class="hljs-keyword">version</span></span>: <span class="hljs-number"><span class="hljs-number">0.3</span></span><span class="hljs-number"><span class="hljs-number">.4</span></span> # <span class="hljs-keyword"><span class="hljs-keyword">load</span></span> Denmark pop structures <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> the <span class="hljs-built_in"><span class="hljs-built_in">old</span></span> municipalities df &lt;- read_csv("https://ikashnitsky.github.io/doc/misc/nuts2-denmark/BEF1A.csv.gz") # <span class="hljs-keyword"><span class="hljs-keyword">create</span></span> a directory <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> geodata ifelse(!dir.<span class="hljs-keyword"><span class="hljs-keyword">exists</span></span>("geodata"), dir.<span class="hljs-keyword"><span class="hljs-keyword">create</span></span>("geodata"), "Directory already exists") # download, unzip <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> <span class="hljs-keyword"><span class="hljs-keyword">read</span></span> Danish NUTS<span class="hljs-number"><span class="hljs-number">-3</span></span> geodata (<span class="hljs-number"><span class="hljs-number">31</span></span>KB) url_nuts &lt;- "https://ikashnitsky.github.io/doc/misc/nuts2-denmark/denmark-nuts3-espg3044.tgz" path_nuts &lt;- "geodata/denmark-nuts3-espg3044.tgz" ifelse(!file.<span class="hljs-keyword"><span class="hljs-keyword">exists</span></span>(path_nuts), download.file(url_nuts, path_nuts, mode="wb"), <span class="hljs-string"><span class="hljs-string">'file alredy exists'</span></span>) # <span class="hljs-keyword"><span class="hljs-keyword">If</span></span> there are problems downloading the data automatically, please download it manually <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> # https://ikashnitsky.github.io/doc/misc/nuts2-denmark/denmark-nuts3-espg3044.tgz untar(tarfile = path_nuts, exdir = "geodata") sp_nuts3 &lt;- readOGR(dsn = "geodata/.", layer = "denmark-nuts3-espg3044") gd_nuts3 &lt;- fortify(sp_nuts3, region = "NUTS_ID") # <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> the ggplot <span class="hljs-keyword"><span class="hljs-keyword">format</span></span> # download, unzip <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> <span class="hljs-keyword"><span class="hljs-keyword">read</span></span> Danish <span class="hljs-built_in"><span class="hljs-built_in">old</span></span> municipal geodata (<span class="hljs-number"><span class="hljs-number">6.0</span></span>MB) url_mun &lt;- "https://ikashnitsky.github.io/doc/misc/nuts2-denmark/kommune2006win1252.tgz" path_mun &lt;- "geodata/kommune2006win1252.tgz" ifelse(!file.<span class="hljs-keyword"><span class="hljs-keyword">exists</span></span>(path_mun), download.file(url_mun, path_mun, mode="wb"), <span class="hljs-string"><span class="hljs-string">'file alredy exists'</span></span>) # <span class="hljs-keyword"><span class="hljs-keyword">If</span></span> there are problems downloading the data automatically, please download it manually <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> # https://ikashnitsky.github.io/doc/misc/nuts2-denmark/kommune2006utf8.tgz untar(tarfile = path_mun, exdir = "geodata") sp_mun &lt;- readOGR(dsn = "geodata/.", layer = "kommune2006win1252", encoding = danish_ecnoding) gd_mun &lt;- fortify(sp_mun) # coordinates <span class="hljs-keyword"><span class="hljs-keyword">of</span></span> the municipalities mun_coord &lt;- bind_cols(<span class="hljs-keyword"><span class="hljs-keyword">as</span></span>.data.frame(coordinates(sp_mun)), sp_mun@data[,<span class="hljs-number"><span class="hljs-number">1</span></span>:<span class="hljs-number"><span class="hljs-number">3</span></span>]) %&gt;% transmute(long = V1, lat = V2, enhedid, objectid, <span class="hljs-type"><span class="hljs-type">name</span></span> = navn)</code> </pre> <br><h2 id="prostranstvennaya-sostykovka">  Spatial docking </h2><br><p>  Let's first look at the map. </p><br><pre> <code class="hljs lisp">ggplot()+ geom_polygon(<span class="hljs-name"><span class="hljs-name">data</span></span> = gd_nuts3, aes(<span class="hljs-name"><span class="hljs-name">long</span></span>, lat, group = group), color = brbg[<span class="hljs-number"><span class="hljs-number">3</span></span>], fill = <span class="hljs-string"><span class="hljs-string">"grey90"</span></span>, size = <span class="hljs-number"><span class="hljs-number">1</span></span>)+ geom_point(<span class="hljs-name"><span class="hljs-name">data</span></span> = mun_coord, aes(<span class="hljs-name"><span class="hljs-name">long</span></span>, lat), color = brbg[<span class="hljs-number"><span class="hljs-number">10</span></span>], size = <span class="hljs-number"><span class="hljs-number">1</span></span>)+ theme_map()</code> </pre> <br><p> <a href=""><img src="https://habrastorage.org/files/96c/995/3a5/96c9953a52b24ee8a963c5b9a8eb70bc.png" alt="fig4"></a> <br>  <em>Figure 4. Old municipalities and NUTS-3 regions of Denmark</em> </p><br><p>  It can be seen that the boundaries of municipalities (light blue) are much more detailed than the boundaries of the NUTS-3 regions (light brown).  This is not difficult as long as the centroids of the municipalities fall within the respective NUTS-3 regions.  This is true for all centroids except the easternmost point.  Fast googlej tells us that this is <a href="https://en.wikipedia.org/wiki/Ertholmene">Christians√∏</a> , a tiny island with a medieval fortress and rich <a href="http://www.christiansoe.dk/historien">history</a> .  This municipality has a special status and is <a href="http://www.dst.dk/da/Statistik/dokumentation/Nomenklaturer/NUTS">not included</a> in the NUTS system.  For our further manipulations, we can safely stick it to the neighboring island of Bornholm. </p><br><p>  To find out which centroids fall into which NUTS regions, I used the spatial overlap function ( <code>over</code> ) from the <code>sp</code> library.  Here I want to thank <a href="https://www.nhh.no/en/employees/faculty/roger-bivand/">Roger Bivand</a> , a person without whom there would be no modern cartographic methods for R. </p><br><pre> <code class="hljs pgsql"># municipality coordinates <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> Spatial mun_centr &lt;- SpatialPoints(coordinates(sp_mun), proj4string = CRS(proj4string(sp_nuts3))) # spatial intersection <span class="hljs-keyword"><span class="hljs-keyword">with</span></span> sp::<span class="hljs-keyword"><span class="hljs-keyword">over</span></span> inter &lt;- bind_cols(mun_coord, <span class="hljs-keyword"><span class="hljs-keyword">over</span></span>(mun_centr, sp_nuts3[,"NUTS_ID"])) %&gt;% transmute(long, lat, objectid, nuts3 = <span class="hljs-keyword"><span class="hljs-keyword">as</span></span>.character(NUTS_ID), nuts2 = substr(nuts3, <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-number"><span class="hljs-number">4</span></span>))</code> </pre> <br><p>  Check if the spatial dock is working. </p><br><pre> <code class="hljs lisp">ggplot()+ geom_polygon(<span class="hljs-name"><span class="hljs-name">data</span></span> = gd_mun, aes(<span class="hljs-name"><span class="hljs-name">long</span></span>, lat, group = group), color = brbg[<span class="hljs-number"><span class="hljs-number">9</span></span>], fill = <span class="hljs-string"><span class="hljs-string">"grey90"</span></span>, size = .<span class="hljs-number"><span class="hljs-number">1</span></span>)+ geom_polygon(<span class="hljs-name"><span class="hljs-name">data</span></span> = gd_nuts3, aes(<span class="hljs-name"><span class="hljs-name">long</span></span>, lat, group = group), color = brbg[<span class="hljs-number"><span class="hljs-number">3</span></span>], fill = NA, size = <span class="hljs-number"><span class="hljs-number">1</span></span>)+ geom_point(<span class="hljs-name"><span class="hljs-name">data</span></span> = inter, aes(<span class="hljs-name"><span class="hljs-name">long</span></span>, lat, color = nuts3), size = <span class="hljs-number"><span class="hljs-number">1</span></span>)+ geom_point(<span class="hljs-name"><span class="hljs-name">data</span></span> = inter[is.na(<span class="hljs-name"><span class="hljs-name">inter</span></span>$nuts3),], aes(<span class="hljs-name"><span class="hljs-name">long</span></span>, lat), color = <span class="hljs-string"><span class="hljs-string">"red"</span></span>, size = <span class="hljs-number"><span class="hljs-number">7</span></span>, pch = <span class="hljs-number"><span class="hljs-number">1</span></span>)+ theme_map(<span class="hljs-name"><span class="hljs-name">base_size</span></span> = <span class="hljs-number"><span class="hljs-number">15</span></span>)+ theme(<span class="hljs-name"><span class="hljs-name">legend</span></span>.position = c(<span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>), legend.justification = c(<span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>))</code> </pre> <br><p> <a href=""><img src="https://habrastorage.org/files/3fb/cf2/9ba/3fbcf29bac02494aae3aa77e89c15fc7.png" alt="fig5"></a> <br>  <em>Figure 5. Checking the spatial intersection between the old municipalities and the NUTS-3 regions of Denmark</em> </p><br><p>  Not bad.  But there are several municipalities that fall into the ‚ÄúNA‚Äù category, which means that they could not find a match at the NUTS level.  How many such cases do we have? </p><br><pre> <code class="hljs lisp"># how many failed cases do we have sum(<span class="hljs-name"><span class="hljs-name">is</span></span>.na(<span class="hljs-name"><span class="hljs-name">inter</span></span>$nuts3))</code> </pre> <br><pre> <code class="hljs vala"><span class="hljs-meta"><span class="hljs-meta">## [1] 3</span></span></code> </pre> <br><pre> <code class="hljs swift"># <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> the intersection failed inter[<span class="hljs-keyword"><span class="hljs-keyword">is</span></span>.na(inter$nuts3),]</code> </pre> <br><pre> <code class="hljs objectivec"><span class="hljs-meta"><span class="hljs-meta">## long lat objectid nuts3 nuts2 ## 23 892474.0 6147918 46399 </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt;NA&gt;</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt;NA&gt;</span></span></span><span class="hljs-meta"> ## 65 504188.4 6269329 105319 </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt;NA&gt;</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt;NA&gt;</span></span></span><span class="hljs-meta"> ## 195 533446.8 6312770 47071 </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt;NA&gt;</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt;NA&gt;</span></span></span></span></code> </pre> <br><p>  Only 3. I decided to fix them manually. </p><br><pre> <code class="hljs swift"># fix the three cases manually fixed &lt;- inter fixed[fixed$objectid==<span class="hljs-string"><span class="hljs-string">"46399"</span></span>, <span class="hljs-number"><span class="hljs-number">4</span></span>:<span class="hljs-number"><span class="hljs-number">5</span></span>] &lt;- <span class="hljs-built_in"><span class="hljs-built_in">c</span></span>(<span class="hljs-string"><span class="hljs-string">"DK014"</span></span>, <span class="hljs-string"><span class="hljs-string">"DK01"</span></span>) fixed[fixed$objectid==<span class="hljs-string"><span class="hljs-string">"105319"</span></span>, <span class="hljs-number"><span class="hljs-number">4</span></span>:<span class="hljs-number"><span class="hljs-number">5</span></span>] &lt;- <span class="hljs-built_in"><span class="hljs-built_in">c</span></span>(<span class="hljs-string"><span class="hljs-string">"DK041"</span></span>, <span class="hljs-string"><span class="hljs-string">"DK04"</span></span>) fixed[fixed$objectid==<span class="hljs-string"><span class="hljs-string">"47071"</span></span>, <span class="hljs-number"><span class="hljs-number">4</span></span>:<span class="hljs-number"><span class="hljs-number">5</span></span>] &lt;- <span class="hljs-built_in"><span class="hljs-built_in">c</span></span>(<span class="hljs-string"><span class="hljs-string">"DK050"</span></span>, <span class="hljs-string"><span class="hljs-string">"DK05"</span></span>)</code> </pre> <br><p>  Final visual check. </p><br><pre> <code class="hljs lisp">ggplot()+ geom_polygon(<span class="hljs-name"><span class="hljs-name">data</span></span> = gd_mun, aes(<span class="hljs-name"><span class="hljs-name">long</span></span>, lat, group = group), color = brbg[<span class="hljs-number"><span class="hljs-number">9</span></span>], fill = <span class="hljs-string"><span class="hljs-string">"grey90"</span></span>, size = .<span class="hljs-number"><span class="hljs-number">1</span></span>)+ geom_polygon(<span class="hljs-name"><span class="hljs-name">data</span></span> = gd_nuts3, aes(<span class="hljs-name"><span class="hljs-name">long</span></span>, lat, group = group), color = brbg[<span class="hljs-number"><span class="hljs-number">3</span></span>], fill = NA, size = <span class="hljs-number"><span class="hljs-number">1</span></span>)+ geom_point(<span class="hljs-name"><span class="hljs-name">data</span></span> = fixed, aes(<span class="hljs-name"><span class="hljs-name">long</span></span>, lat, color = nuts3), size = <span class="hljs-number"><span class="hljs-number">1</span></span>)+ theme_map(<span class="hljs-name"><span class="hljs-name">base_size</span></span> = <span class="hljs-number"><span class="hljs-number">15</span></span>)+ theme(<span class="hljs-name"><span class="hljs-name">legend</span></span>.position = c(<span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>), legend.justification = c(<span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>))</code> </pre> <br><p> <a href=""><img src="https://habrastorage.org/files/f8b/52f/c36/f8b52fc36e34425cb5bf535c2938230b.png" alt="fig6"></a> <br>  <em>Figure 6. Reconciliation of spatial alignment after manual adjustment for 3 municipalities</em> </p><br><p>  Now everything is normal. </p><br><h2 id="soedinyaem-prostranstvennye-i-statisticheskie-dannye-fuzzy-join">  Connect spatial and statistical data (fuzzy join) </h2><br><p>  The next task turned out to be not trivial matching of spatial and statistical data.  The municipality shapefile I found did not contain the identification codes used by Statistics Denmark.  Therefore, we had to connect the municipalities in the spatial and statistical datasets by name - with all the delights of Danish names and Western European coding.  The names of municipalities can be written slightly differently in two datasets.  And hundreds of municipalities.  It would seem rather boring routine work.  Not here it was!  Comes to the aid of 'Fuzzy String Matching' and its excellent implementation in the <a href="https://github.com/dgrtwo/fuzzyjoin"><code>fuzzyjoin</code></a> library, written by the great developer <a href="http://varianceexplained.org/about/">David Robinson</a> . </p><br><p>  To begin with, I simplified the data of the names of municipalities, transferring them to the lower register, of course, in both datasets.  In addition, the first attempts at docking showed that it makes sense to replace the letter ‚Äú√•‚Äù with an alternative spelling - ‚Äúaa‚Äù.  In spatial dataset, I also removed the word ‚ÄúKommune‚Äù from the name of each municipality.  I <a href="">downloaded a tiny</a> dataset from the Statistics Denmark website, containing the names and codes of the old municipalities. </p><br><pre> <code class="hljs pgsql"># simplify municipalities names mun_geo &lt;- mun_coord %&gt;% transmute(<span class="hljs-type"><span class="hljs-type">name</span></span> = sub(x = <span class="hljs-type"><span class="hljs-type">name</span></span>, " Kommune", replacement = ""), objectid) %&gt;% mutate(<span class="hljs-type"><span class="hljs-type">name</span></span> = gsub(x = tolower(<span class="hljs-type"><span class="hljs-type">name</span></span>), "√•", "aa")) mun_stat &lt;- <span class="hljs-keyword"><span class="hljs-keyword">read</span></span>.csv2("https://ikashnitsky.github.io/doc/misc/nuts2-denmark/stat-codes-names.csv", fileEncoding = danish_ecnoding) %&gt;% <span class="hljs-keyword"><span class="hljs-keyword">select</span></span>(<span class="hljs-type"><span class="hljs-type">name</span></span>) %&gt;% separate(<span class="hljs-type"><span class="hljs-type">name</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">into</span></span> = c("code", "name"), sep = " ", extra = "merge") %&gt;% mutate(<span class="hljs-type"><span class="hljs-type">name</span></span> = gsub("\\s*\\([^\\)]+\\)", "", x = <span class="hljs-type"><span class="hljs-type">name</span></span>)) %&gt;% mutate(<span class="hljs-type"><span class="hljs-type">name</span></span> = gsub(x = tolower(<span class="hljs-type"><span class="hljs-type">name</span></span>), "√•", "aa"))</code> </pre> <br><p>  We try fuzzy join. </p><br><pre> <code class="hljs lisp"># first attempt fuz_joined_1 &lt;- regex_left_join(<span class="hljs-name"><span class="hljs-name">mun_geo</span></span>, mun_stat, by = <span class="hljs-string"><span class="hljs-string">"name"</span></span>)</code> </pre> <br><p>  At the output we get a dataframe with 278 lines instead of 271. This means that for some municipalities from the spatial dataset more than one match was found in the statistical dataset.  We find these problem cases. </p><br><pre> <code class="hljs mel"># identify more that <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">match</span></span> (<span class="hljs-number"><span class="hljs-number">7</span></span> cases) and <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> which to drop fuz_joined_1 %&gt;% group_by(objectid) %&gt;% mutate(n = n()) %&gt;% <span class="hljs-keyword"><span class="hljs-keyword">filter</span></span>(n &gt; <span class="hljs-number"><span class="hljs-number">1</span></span>)</code> </pre> <br><pre> <code class="hljs objectivec"><span class="hljs-meta"><span class="hljs-meta">## Source: local data frame [14 x 5] ## Groups: objectid [7] ## ## name.x objectid code name.yn ## </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt;chr&gt;</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt;dbl&gt;</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt;chr&gt;</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt;chr&gt;</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt;int&gt;</span></span></span><span class="hljs-meta"> ## 1 haslev 105112 313 haslev 2 ## 2 haslev 105112 403 hasle 2 ## 3 br√∏nderslev 47003 739 r√∏nde 2 ## 4 br√∏nderslev 47003 805 br√∏nderslev 2 ## 5 hirtshals 47037 817 hals 2 ## 6 hirtshals 47037 819 hirtshals 2 ## 7 r√∏nnede 46378 385 r√∏nnede 2 ## 8 r√∏nnede 46378 407 r√∏nne 2 ## 9 hvideb√¶k 46268 317 hvideb√¶k 2 ## 10 hvideb√¶k 46268 681 videb√¶k 2 ## 11 ryslinge 46463 477 ryslinge 2 ## 12 ryslinge 46463 737 ry 2 ## 13 aarslev 46494 497 aarslev 2 ## 14 aarslev 46494 861 aars 2</span></span></code> </pre> <br><p>  So, for 7 municipalities 2 matches were found.  Not ideal matches will be thrown away at the next iteration of the fuzzy join. </p><br><p>  Another problem is that for some municipalities there was no match at all. </p><br><pre> <code class="hljs pgsql"># <span class="hljs-keyword"><span class="hljs-keyword">show</span></span> the non-matched cases fuz_joined_1 %&gt;% <span class="hljs-keyword"><span class="hljs-keyword">filter</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">is</span></span>.na(code))</code> </pre> <br><pre> <code class="hljs objectivec"><span class="hljs-meta"><span class="hljs-meta">## name.x objectid code name.y ## 1 faxe 105120 </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt;NA&gt;</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt;NA&gt;</span></span></span><span class="hljs-meta"> ## 2 nyk√∏bing falsters 46349 </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt;NA&gt;</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt;NA&gt;</span></span></span><span class="hljs-meta"> ## 3 herstederne 46101 </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt;NA&gt;</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt;NA&gt;</span></span></span></span></code> </pre> <br><p>  Since there were only three such cases, I corrected them manually in the spatial dataset so that they correspond to the names in the statistical dataset.  In two cases, the discrepancy occurred due to inaccuracies in writing, and in another case, <a href="http://albertslund.lokalavisen.dk/fra-herstederne-til-albertslund-/20131017/artikler/710179831">the name of the municipality changed</a> . </p><br><pre> <code class="hljs pgsql"># correct the <span class="hljs-number"><span class="hljs-number">3</span></span> non-matching geo names mun_geo_cor &lt;- mun_geo mun_geo_cor[mun_geo_cor$<span class="hljs-type"><span class="hljs-type">name</span></span>=="faxe", "name"] &lt;- "fakse" mun_geo_cor[mun_geo_cor$<span class="hljs-type"><span class="hljs-type">name</span></span>=="nyk√∏bing falsters", "name"] &lt;- "nyk√∏bing f." mun_geo_cor[mun_geo_cor$<span class="hljs-type"><span class="hljs-type">name</span></span>=="herstederne", "name"] &lt;- "albertslund"</code> </pre> <br><p>  Now we will try to dock a second time (the names in the spatial dataset have been corrected). </p><br><pre> <code class="hljs mel"># second attempt fuz_joined_2 &lt;- regex_left_join(mun_geo_cor, mun_stat, by = <span class="hljs-string"><span class="hljs-string">"name"</span></span>) # drop non-perfect <span class="hljs-keyword"><span class="hljs-keyword">match</span></span> fuz_joined_2 &lt;- fuz_joined_2 %&gt;% group_by(objectid) %&gt;% mutate(n = n()) %&gt;% <span class="hljs-keyword"><span class="hljs-keyword">ungroup</span></span>() %&gt;% <span class="hljs-keyword"><span class="hljs-keyword">filter</span></span>(n &lt; <span class="hljs-number"><span class="hljs-number">2</span></span> | name.x==name.y) fuz_joined_2 &lt;- fuz_joined_2 %&gt;% transmute(name = name.x, objectid, code)</code> </pre> <br><p>  Perfect.  Now the last step - in the ‚Äúobjectid‚Äù field we attach the data on the belonging of the NUTS regions to the old statistical codes of the municipalities. </p><br><pre> <code class="hljs pgsql"># finally, attach the NUTS <span class="hljs-keyword"><span class="hljs-keyword">info</span></span> <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> matched <span class="hljs-keyword"><span class="hljs-keyword">table</span></span> key &lt;- left_join(fuz_joined_2, fixed, "objectid")</code> </pre> <br><h2 id="agregirovanie-municipalnyh-dannyh-na-urovnyah-nuts">  Aggregation of municipal data at NUTS levels </h2><br><p>  The previous manipulations have given us a small, but very valuable data frame, which docks the statistical code of the old municipalities with the modern NUTS regions.  It remains for us to only aggregate the old data.  And I attach the ‚Äúkey‚Äù to the statistics and aggregate from at the NUTS-3 and NUTS-2 levels. </p><br><pre> <code class="hljs pgsql"># finally, we <span class="hljs-keyword"><span class="hljs-keyword">only</span></span> need <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> <span class="hljs-keyword"><span class="hljs-keyword">aggregate</span></span> the <span class="hljs-built_in"><span class="hljs-built_in">old</span></span> stat data df_agr &lt;- left_join(key, df, "code") %&gt;% <span class="hljs-keyword"><span class="hljs-keyword">filter</span></span>(!<span class="hljs-keyword"><span class="hljs-keyword">is</span></span>.na(<span class="hljs-type"><span class="hljs-type">name</span></span>)) %&gt;% gather("year", "value", y2001:y2006) df_nuts3 &lt;- df_agr %&gt;% group_by(year, sex, age, nuts3) %&gt;% summarise(<span class="hljs-keyword"><span class="hljs-keyword">value</span></span> = sum(<span class="hljs-keyword"><span class="hljs-keyword">value</span></span>)) %&gt;% ungroup() df_nuts2 &lt;- df_agr %&gt;% group_by(year, sex, age, nuts2) %&gt;% summarise(<span class="hljs-keyword"><span class="hljs-keyword">value</span></span> = sum(<span class="hljs-keyword"><span class="hljs-keyword">value</span></span>)) %&gt;% ungroup()</code> </pre> <br><p>  Let‚Äôs take a sample of the working-age population (15‚Äì64) in the NUTS-3 regions of Denmark in 2001 and put this information on the map. </p><br><pre> <code class="hljs pgsql"># total population <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> <span class="hljs-number"><span class="hljs-number">2001</span></span> <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> NUTS<span class="hljs-number"><span class="hljs-number">-3</span></span> regions tot_01 &lt;- df_nuts3 %&gt;% <span class="hljs-keyword"><span class="hljs-keyword">filter</span></span>(year=="y2001") %&gt;% group_by(nuts3) %&gt;% summarise(tot = sum(<span class="hljs-keyword"><span class="hljs-keyword">value</span></span>, na.rm = <span class="hljs-keyword"><span class="hljs-keyword">TRUE</span></span>)) %&gt;% ungroup() # working-age population <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> <span class="hljs-number"><span class="hljs-number">2001</span></span> <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> NUTS<span class="hljs-number"><span class="hljs-number">-3</span></span> regions working_01 &lt;- df_nuts3 %&gt;% <span class="hljs-keyword"><span class="hljs-keyword">filter</span></span>(year=="y2001", age %<span class="hljs-keyword"><span class="hljs-keyword">in</span></span>% paste0("a0", <span class="hljs-number"><span class="hljs-number">15</span></span>:<span class="hljs-number"><span class="hljs-number">64</span></span>)) %&gt;% group_by(nuts3) %&gt;% summarise(<span class="hljs-keyword"><span class="hljs-keyword">work</span></span> = sum(<span class="hljs-keyword"><span class="hljs-keyword">value</span></span>, na.rm = <span class="hljs-keyword"><span class="hljs-keyword">TRUE</span></span>)) %&gt;% ungroup() # calculate the shares <span class="hljs-keyword"><span class="hljs-keyword">of</span></span> working age population sw_01 &lt;- left_join(working_01, tot_01, "nuts3") %&gt;% mutate(sw = <span class="hljs-keyword"><span class="hljs-keyword">work</span></span> / tot * <span class="hljs-number"><span class="hljs-number">100</span></span>)</code> </pre> <br><pre> <code class="hljs lisp"># map the shares of working age population in <span class="hljs-number"><span class="hljs-number">2001</span></span> by NUTS-3 regions ggplot()+ geom_polygon(<span class="hljs-name"><span class="hljs-name">data</span></span> = gd_nuts3 %&gt;% left_join(<span class="hljs-name"><span class="hljs-name">sw_01</span></span>, c(<span class="hljs-string"><span class="hljs-string">"id"</span></span> = <span class="hljs-string"><span class="hljs-string">"nuts3"</span></span>)), aes(<span class="hljs-name"><span class="hljs-name">long</span></span>, lat, group = group, fill = sw), color = <span class="hljs-string"><span class="hljs-string">"grey50"</span></span>, size = <span class="hljs-number"><span class="hljs-number">1</span></span>) + scale_fill_viridis()+ theme_map(<span class="hljs-name"><span class="hljs-name">base_size</span></span> = <span class="hljs-number"><span class="hljs-number">15</span></span>)+ theme(<span class="hljs-name"><span class="hljs-name">legend</span></span>.position = c(<span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>), legend.justification = c(<span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>))</code> </pre> <br><p> <a href=""><img src="https://habrastorage.org/files/613/71b/651/61371b6514194c7389a1b3507e923136.png" alt="fig7"></a> <br>  <em>Figure 7. The share of the working-age population (15-64) in the NUTS-3 regions of Denmark in 2001</em> </p><br><p>  The result looks realistic - the figure is higher in the metropolitan area and those regions where there are relatively large cities. </p><br><hr></div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <p>Source: <a href="https://habr.com/ru/post/325564/">https://habr.com/ru/post/325564/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../325550/index.html">7 cases of using Big Data technologies in production</a></li>
<li><a href="../325552/index.html">How automatic testing is arranged in Mail.Ru Mail for iOS</a></li>
<li><a href="../325554/index.html">What will block your site? Roskomnadzor and resource bank in a nutshell</a></li>
<li><a href="../325558/index.html">Oblakoteka has selected Lenovo servers as a platform for the latest IaaS services</a></li>
<li><a href="../325560/index.html">About configuring Open vSwitch a difficult language</a></li>
<li><a href="../325566/index.html">Why the cloud does not take off: how loyalty systems work in stores</a></li>
<li><a href="../325568/index.html">Full development environment automation with docker-compose</a></li>
<li><a href="../325570/index.html">How to test docker image for half a second</a></li>
<li><a href="../325572/index.html">Users convinced GitLab not to leave the cloud</a></li>
<li><a href="../325574/index.html">Announcement of mitc.ap Sync.NET # 4 in Kharkov</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>