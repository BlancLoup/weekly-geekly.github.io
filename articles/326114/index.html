<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Primitives for implementing 1-Wire master using PWM and ICP for STM8L and STM32</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="In the previous article , a variant of the implementation of primitives for asynchronous operation with a 1-wire bus for Atmel microcontrollers was pr...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Primitives for implementing 1-Wire master using PWM and ICP for STM8L and STM32</h1><div class="post__text post__text-html js-mediator-article">  In the <a href="https://habrahabr.ru/post/322710/">previous article</a> , a variant of the implementation of primitives for asynchronous operation with a 1-wire bus for Atmel microcontrollers was presented.  Well, now your attention is invited to the implementation of the same, but on more powerful microcontrollers of the STM8L family (for debugging, the usual STM8L-Discovery evaluation board with an extracted LCD display was used).  With minimal changes, the described implementation can be adapted for the STM32 family. <br><br><img src="https://habrastorage.org/files/929/b3c/fd9/929b3cfd9fe447c4a1cca16d4078aa2a.jpeg"><br><a name="habracut"></a><br>  <a href="https://www.iar.com/">IAR Embedded Workbench</a> for STM8 with a free license was used as a toolchain (code size limit is 8Kb). <br><br>  The 1-Wire bus driver is taken from the previous article.  Connection is as follows: 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <ul><li>  Contact PB1 of the evaluation board is connected to the OCRA driver. </li><li>  contact PD0 of the evaluation board is connected to the ICP driver </li><li>  Contact PA5 evaluation board connect to PULLUP driver </li></ul><br>  Do not forget to connect GND, power + 5V and power + 3V3. <br><br>  Unlike the AVR, the STM8 (and STM32) microcontrollers offer a wider range of internal peripherals.  Thus, the described project can be compiled in several ways: <br><br><ol><li><a name="irq_only"></a>  IRQ-only.  The logic of work is implemented only by interrupt, without using DMA.  This option is compiled when the symbol __DRV_ONEWIRE_DMA is not defined. <br><br>  Pros of implementation: <br><br><ul><li>  Only 3 bytes of RAM required </li><li>  The ability to program a timer for any desired resolution </li></ul><br>  Cons of implementation: <br><br><ul><li>  A large number of interrupts (3 interrupts for each transmitted bit) </li></ul><br></li><li><a name="dma_8"></a>  DMA with 8-bit transmission.  Timer programming and saving of results during the reception and transmission of bits is performed using DMA.  This option is compiled when the symbol __DRV_ONEWIRE_DMA = 1. <br><br>  Pros of implementation: <br><br><ul><li>  Requires 9 bytes of RAM </li><li>  A small number of interrupts (one interrupt on the 1st transmitted bit and 3 interrupts in case of successful completion of the exchange) </li></ul><br>  Cons of implementation: <br><br><ul><li>  The inability to program a timer for high resolution </li></ul><br></li><li><a name="dma_16"></a>  DMA with 16-bit transmission.  The timer is programmed and the results are saved during the reception and transmission of bits using DMA. This option is compiled when the symbol __DRV_ONEWIRE_DMA = 2. <br><br>  Pros of implementation: <br><br><ul><li>  A small number of interrupts (one interrupt on the 1st transmitted bit and 3 interrupts in case of successful completion of the exchange) </li><li>  The ability to program a timer for any desired resolution </li></ul><br>  Cons of implementation: <br><br><ul><li>  17 bytes of RAM required </li></ul></li></ol><br>  In addition, due to the PWM prohibition (BREAK-signal) input timers, it is possible to implement hardware protection against an attempt to perform data exchange at the moment of active-pullup enabled (i.e., so that they do not accidentally close the 1-wire to ground at the moment when it is powered to perform transformations). <br><br>  General implementation features <br><br>  When primitives are not used, the output of PB1 is kept low (i.e. the modulating stage is not active).  The timer is programmed in such a way that the period duration corresponds to the timeslot duration plus the duration of the protective pause between bits (for the bit transmission procedure) or the total RESET pulse duration, the pause before the possible PRESENCE start and the maximum PRESENCE duration (for the RESET procedure). <br><br>  The PWM control registers (TIMx_CCR1) and Capture (TIMx_CCR2) are programmed to use shadow registers.  This means that after a programmatic change of the PWM register ((TIMx_CCR1), its value will be used only after the appearance of the UEV signal inside the microcontroller. And this signal is generated either automatically when the counter reaches the specified vertex (period) or programmatically by setting the UG bit in the TIMx_EGR register) . <br><br>  Immediately before starting the PWM, the required pulse width of the lowest transmitted bit is calculated and loaded into the PWM register (TIMx_CCR1).  After that, the timer is started by setting the CEN bit in the TIMx_CR1 register.  At this moment, the PWM signal is not yet active, since  The MOE bit in the TIMn_BKR register was previously reset to 0. After this, the UG bit is programmatically set to TIMx_EGR, which causes activation of the internal signal UEV, resetting the current counter value to 0 and loading the contents of the PWM register (TIMx_CCR1) into its shadow copy used for comparison . <br><br>  In addition, since the AOE bit was set in advance in the TIMn_BKR register, the MOE bit in the TIMn_BKR register can be automatically set by the UEV signal, which will enable the PWM output.  However, this will happen only when the BREAK signal is not active, which is generated from controlling external active-pullup (this is possible because the BREAK signal inside the microcontroller is formed directly from the signal value on the external pin, regardless of whether it is programmed for input or output mode) .  Thus, if during the RESET procedure or when attempting to transmit / receive bit (s), the active-pullup signal is active, the activation of the PWM output will be blocked. <br><br>  The principle of the <a href="https://habr.com/ru/post/326114/">IRQ-only</a> implementation is the same as described in the <a href="https://habr.com/ru/post/326114/">previous article</a> with the difference that instead of the up-down timer mode, the up-to-specified value count mode is used.  This became possible because the bits of the 16-bit timer is enough for both the formation of a one-time transfer time slot period and the implementation of the ‚ÄúRESET signal generation with PRESENCE waiting‚Äù procedure. <br><br>  In this implementation, the calculation of the duration of the next pulse is performed during the processing of an interrupt that occurs at the moment when the transmission of the previous bit is completed. <br><br>  The implementation using DMA with <a href="https://habr.com/ru/post/326114/">8-bit</a> and <a href="https://habr.com/ru/post/326114/">16-</a> bit transmissions is basically the same and differs only in the bitness of the values ‚Äã‚Äãfor PWM and ICP.  All pulse durations are calculated in advance before the timer starts.  The low-order pulse width is loaded into the PWM register (TIMx_CCR1) as described above, and the 1st DMA channel is programmed to load the remaining values, if necessary.  All measurement results are always saved using the 2nd DMA channel. <br><br>  The generated code fits into the limit of the free license from IAR, therefore, having on hand an estimated fee, you can immediately begin to experiment.  And, thanks to the possibility of hardware debugging, you can also study the features of the microcontroller's periphery functioning. <br><br>  Note. <br>  In the source code you can find a couple of high-level procedures for implementing the exchange protocol on the 1-Wire bus.  They are quite working, but are excluded from the project by conditional compilation directives.  Wait for the continuation of the use of pthreads and the asynchronous implementation of the high-level part of the protocol. <br><br>  Bibliography: <br><br><ol><li><a name="code"></a>  <a href="https://github.com/vedga/1-wire">Project code on github</a> </li><li><a name="avr"></a>  <a href="https://habrahabr.ru/post/322710/">Primitives for implementing 1-Wire master using PWM and ICP on AVR AtMega microcontrollers</a> </li><li><a name="adapter"></a>  <a href="https://geektimes.ru/post/286374/">1-Wire bus driver for power controllers less than 5V</a> </li><li>  <a href="https://habrahabr.ru/post/326320/">High-level functions for working with 1-Wire</a> </li></ol></div><p>Source: <a href="https://habr.com/ru/post/326114/">https://habr.com/ru/post/326114/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../326104/index.html">Not soon the fence is built, especially a beautiful data center. How we build the data center "Avantage". Part 1</a></li>
<li><a href="../326106/index.html">PostgreSQL indexes - 2</a></li>
<li><a href="../326108/index.html">A little about the lines in C, or several options to optimize non-optimizable</a></li>
<li><a href="../326110/index.html">It's very simple</a></li>
<li><a href="../326112/index.html">IP KVM DIY 2.0</a></li>
<li><a href="../326116/index.html">The subtleties of Scala: we study CanBuildFrom</a></li>
<li><a href="../326118/index.html">Editors ONLYOFFICE v.4.3: yes, we added footnotes</a></li>
<li><a href="../326120/index.html">5 courses that will help start your way in the design of games</a></li>
<li><a href="../326122/index.html">Test Lossless Image Optimizers (PNG and JPG)</a></li>
<li><a href="../326124/index.html">One-dimensional linear regression, SQL and machine learning</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>