<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Prism Developer Guide - Part 6, Advanced MVVM Scripts</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Table of contents 


1. Introduction 
2. Initializing Prism Applications 
3. Manage dependencies between components 
4. Modular Application Developmen...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Prism Developer Guide - Part 6, Advanced MVVM Scripts</h1><div class="post__text post__text-html js-mediator-article"><blockquote>  <b>Table of contents</b> <br><ol><li>  <a href="http://habrahabr.ru/post/176851/">Introduction</a> </li><li>  <a href="http://habrahabr.ru/post/176853/">Initializing Prism Applications</a> </li><li>  <a href="http://habrahabr.ru/post/176861/">Manage dependencies between components</a> </li><li>  <a href="http://habrahabr.ru/post/176863/">Modular Application Development</a> </li><li>  <a href="http://habrahabr.ru/post/176867/">Implementation of the MVVM pattern</a> </li><li>  <a href="http://habrahabr.ru/post/176869/">Advanced MVVM scripts</a> </li><li>  <a href="http://habrahabr.ru/post/176895/">Creating user interface</a> <br><ol><li>  <a href="http://habrahabr.ru/post/177925/">User Interface Design Recommendations</a> </li></ol></li><li>  <a href="http://habrahabr.ru/post/178009/">Navigation</a> <ol><li>  <a href="http://habrahabr.ru/post/182052/">View-Based Navigation (View-Based Navigation)</a> </li></ol></li><li>  <a href="http://habrahabr.ru/post/182580/">The interaction between loosely coupled components</a> </li></ol></blockquote><br>  The previous chapter described how to create the main elements of the MVVM pattern, dividing the user interface, presentation logic and business logic into separate classes (presentation, presentation model and model), to realize interaction between them (through data binding, commands and data validation interfaces) , organize their creation and configuration. <br><br>  Implementing the MVVM pattern using these basic elements is likely to fit most scenarios in your application.  However, it is possible to meet with more complex scenarios that require the expansion of the MVVM pattern, or the use of more advanced methods.  This is most likely to happen if your application is large or complex, but you can meet with this in many small applications.  The Prism library provides components that implement many of these methods, allowing you to easily use them in your applications. <br><br>  This chapter describes some complex scenarios and how the MVVM pattern supports them.  The following section shows how commands can be chained or associated with child views, as well as how they can be extended to support user requirements.  The following sections describe how to handle asynchronous data requests and the subsequent interaction with the user interface, as well as how to handle interaction requests between the view and the view model. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      The section ‚ÄúAdvanced Creation and Configuration‚Äù gives an idea of ‚Äã‚Äãhow to create and configure components when using a dependency injection container, such as the Unity Application Block (Unity), or Managed Extensibility Framework (MEF).  The final section describes how to test MVVM applications, and gives an idea about unit testing of model classes and presentation models, as well as testing behaviors. <br><a name="habracut"></a><br><h3>  Teams </h3><br>  Commands provide a way to separate the implementation logic of a command from its presentation in the UI.  Binding data or behavior makes it possible to declaratively link elements in the view with the commands provided by the view model.  Section ‚ÄúCommands‚Äù in Chapter 5 described how commands can be implemented as command objects, or as command methods in a view model, and how they can be called by controls in a view: using behaviors, or the <code>Command</code> property, which have some controls. <br><blockquote>  <b>The note.</b>  <b>WPF routed commands.</b> <br>  It should be noted that commands implemented as command objects or command methods in the MVVM pattern are somewhat different from the built-in implementation of WPF commands called routed commands (Silverlight has no routable command implementations).  WPF routed commands transmit a command message through elements in the UI tree.  Therefore, messages are sent up or down the UI tree from the element with the focus, or to an explicitly specified target element.  By default, they are not passed to components outside the UI tree, such as the view model associated with the view.  However, WPF routed commands can use the handler defined in the code-behind view to send a command call to the view model class. </blockquote><br><h4>  Composite teams </h4><br>  In many cases, the command defined by the view model will be associated with the controls in the associated view so that the user can directly call it from within the view.  However, in some cases, it may be necessary to invoke commands from one or more view models from a control in the parent view. <br><br>  For example, if your application allows the user to edit various elements at the same time, you can allow the user to save all the elements using a single command, represented by a button on the toolbar.  In this case, the <i>Save All</i> command will invoke each of the <code>Save</code> commands implemented by an instance of the view model of each element, as shown in the following illustration. <br><br><img title="Implementing a composite saveAll command." src="https://habrastorage.org/getpro/habr/post_images/d2b/b5c/608/d2bb5c608448c94a253331e8e5ecd3ee.png" alt="   SaveAll."><br><br>  Prism supports such a script through the <code>CompositeCommand</code> class. <br><br>  The <code>CompositeCommand</code> class represents a command that is made up of various child commands.  When a compound command is invoked, each of its child commands is invoked alternately.  This is useful in situations where you want to present a group of commands as a single command in a UI, or somewhere where you want to call several commands, as one logical command. <br><br>  For example, the <code>CompositeCommand</code> class is used in the <i>Stock Trader RI</i> to implement the <code>SubmitAllOrders</code> command, represented by the <i>Submit All</i> button in the buy / sell view.  When the user clicks the <i>Submit All</i> button, each <code>SubmitCommand</code> defined by the buy / sell transaction is executed. <br><br>  The <code>CompositeCommand</code> class maintains a list of child commands ( <code>DelegateCommand</code> instances).  The <code>Execute</code> method of the <code>CompositeCommand</code> class simply calls the <code>Execute</code> method on each of the child commands in turn.  The <code>CanExecute</code> method also calls the <code>CanExecute</code> method of each child command, but if any of the child commands cannot be executed, the <code>CanExecute</code> method returns <code>false</code> .  In other words, by default, the <code>CompositeCommand</code> can be executed only when all the child commands can be executed. <br><br><h3>  Register and delete child commands </h3><br>  Child commands are registered or deleted with the <code>RegisterCommand</code> and <code>UnregisterCommand</code> methods.  In <i>Stock Trader RI</i> , for example, the <code>Submit</code> and <code>Cancel</code> commands for each buy / sell order are registered with the composite <code>SubmitAllOrders</code> and <code>CancelAllOrders</code> , as shown in the following example (see the <code>OrdersController</code> class). <br><br><pre> <code class="cs hljs">commandProxy.SubmitAllOrdersCommand.RegisterCommand( orderCompositeViewModel.SubmitCommand); commandProxy.CancelAllOrdersCommand.RegisterCommand( orderCompositeViewModel.CancelCommand);</code> </pre> <br><blockquote>  <b>The note</b> <br>  The previous <code>commandProxy</code> object provides an instance access to the commands of the compound object <code>Submit</code> and <code>Cancel</code> , which are defined statically.  For more information, see the <code>StockTraderRICommands.cs</code> file. </blockquote><br><h5>  Execution of commands in active child views </h5><br>  It often happens that your application must show a collection of child views within the UI, where each child view will have a corresponding view model, which in turn can implement one or more commands.  Composite commands can be used to represent commands implemented by child views, and can help coordinate how they will be invoked from within the parent view.  To support these scripts, the <code>DelegateCommand</code> and <code>CompositeCommand</code> classes were designed to work with the Prism regions. <br><br>  The Prism regions (described in the section ‚ÄúRegions‚Äù in Chapter 7) allow the child views to be associated with regions in the UI.  They are often used to separate the layout of child views from their region and its position in the UI.  Regions are based on named placeholders that are attached to specific markup controls.  The following illustration shows an example where each child view was added to the <code>EditRegion</code> region, and the UI developer wanted to use the <code>TabControl</code> element to place the views in this region. <br><br><img title="Defining an EditRegion using Tab control." src="https://habrastorage.org/getpro/habr/post_images/125/66d/e52/12566de52f209700bc7197f9d1c3dfa1.png" alt=" EditRegion,    Tab control."><br><br>  Composite commands at the parent view level are often used to coordinate how commands are called at the child view level.  In some cases, you will want the commands for all displayed views to be executed, as in the example of the <i>Save All</i> command described earlier.  In other cases, you want the command to be executed only on the active view.  In this case, the compound command will execute the child commands only on the views that are active.  For example, you might want to implement the <i>Zoom</i> command on the toolbar, which only scales the currently active element, as shown in the following diagram. <br><br><img title="Defining an EditRegion using Tab control." src="https://habrastorage.org/getpro/habr/post_images/e53/c04/f84/e53c04f841754c1e66191a8554256a2c.png" alt=" EditRegion,    Tab control."><br><br>  To support this scenario, Prism provides an <code>IActiveAware</code> interface.  The <code>IActiveAware</code> interface defines the <code>IActiveAware</code> property, which returns <code>true</code> when the control is active, and the <code>IsActiveChanged</code> event, which is generated whenever the active state changes. <br><br>  You can implement an <code>IActiveAware</code> interface on child views or view models.  This is primarily used to track the active state of the child view in the area.  Whether a view is active is determined by the region adapter, which controls the views within a particular area control.  For example, for the <code>TabControl</code> element shown earlier, there is a region adapter that sets the view on the currently selected tab as active. <br><br>  The <code>DelegateCommand</code> class also implements the <code>IActiveAware</code> interface.  By setting the <code>monitorCommandActivity</code> parameter to <code>monitorCommandActivity</code> in the constructor, the <code>CompositeCommand</code> can be configured to evaluate the active state of the child <code>DelegateCommand</code> element (in addition to the <code>CanExecute</code> state).  When these parameters are set to <code>true</code> , the <code>CompositeCommand</code> class will examine the active state of each child <code>DelegateCommand</code> , determining the return value for the <code>CanExecute</code> method and executing the child commands within the <code>Execute</code> method. <br><br>  When the <code>monitorCommandActivity</code> parameter <code>monitorCommandActivity</code> set to <code>true</code> , the <code>CompositeCommand</code> class shows the following behavior: <br><ul><li>  <code>CanExecute</code> .  Returns <code>true</code> only when all active commands can be executed.  Child commands that are inactive are not processed. </li><li>  <code>Execute</code> .  Executes all active commands.  Child commands that are not active are not processed. </li></ul><br>  You can use this functionality to implement the example described earlier.  <code>IActiveAware</code> implementing the <code>IActiveAware</code> interface in your child view models, you will be notified when your child view in the region becomes active or inactive.  When the active state of the child view changes, you can update the active state of the child commands.  Then, when the user invokes the compound <code>Zoom</code> command, it will be called only on the active child view. <br><br><h4>  Binding commands within collections </h4><br>  Another common scenario you'll often see when displaying a collection of items in a view is when you need a UI for each item in the collection that will be associated with a command at the parent view level (instead of the item level). <br><br>  For example, in the application shown in the following illustration, the view shows a collection of items in a <code>ListBox</code> .  The data template, used to show each item, defines the <code>Delete</code> button, which allows the user to delete individual items from the collection. <br><br><img title="Binding commands within the collection." src="https://habrastorage.org/getpro/habr/post_images/2f8/d1a/297/2f8d1a297023e11f3b1442e096e30f5a.png" alt="    ."><br><br>  Since the view model implements the <code>Delete</code> command, the problem is to attach the <code>Delete</code> button in the UI for each element to the <code>Delete</code> command implemented by the view model.  The difficulty arises from the fact that the data context for each of the elements in the <code>ListBox</code> refers to an element in the collection instead of the parent view model that implements the <code>Delete</code> command. <br><br>  One approach to solving this problem is to bind a button in the data template to a command in the parent view, using the <code>ElementName</code> property to ensure that the binding is relative to the parent control, and not to the data template.  The following XAML illustrates this method. <br><br><pre> <code class="xml hljs"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Grid</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">x:Name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"root"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">ListBox</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">ItemsSource</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"{Binding Path=Items}"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">ListBox.ItemTemplate</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">DataTemplate</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Button</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Content</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"{Binding Path=Name}"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Command</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"{Binding ElementName=root, Path=DataContext.DeleteCommand}"</span></span></span><span class="hljs-tag"> /&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">DataTemplate</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">ListBox.ItemTemplate</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">ListBox</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Grid</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre> <br>  The button content in the data template is associated with the <code>Name</code> property of the item in the collection.  However, the command for the button is linked via the data context of the root element with the <code>Delete</code> command.  This allows the button to be associated with a command at the parent view level instead of at the element level.  You can use the <code>CommandParameter</code> property to specify the element to which the command will be applied, or you can implement the command to work with the currently selected element (via the <code>CollectionView</code> ). <br><br><h4>  Command binding behaviors </h4><br>  In Silverlight 3 and earlier versions, Silverlight did not provide controls that support commands.  The <code>ICommand</code> interface was available, but no controls implemented the <code>Command</code> property to allow them to be bound to the <code>ICommand</code> implementation.  To overcome this limitation and maintain the MVVM pattern in Silverlight 3, the Prism library (version 2.0) provided a mechanism that allows any Silverlight control to be associated with a command object using attached behavior.  This mechanism also worked in WPF, which allowed the view model implementations to be again in both Silverlight applications and WPF. <br><br>  The following example shows how Prism uses attached behavior to bind a command object defined on a view model to a button click event. <br><br><pre> <code class="xml hljs"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Button</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Content</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"Submit All"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">prism:Click.Command</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"{Binding Path=SubmitAllCommand}"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">prism:Click.CommandParameter</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"{Binding Path=TickerSymbol}"</span></span></span><span class="hljs-tag"> /&gt;</span></span></code> </pre> <br>  Silverlight 4 added support for the <code>Command</code> property in all controls inherited from <code>Hyperlink</code> and <code>ButtonBase</code> , allowing them to be tied directly to the command object in the same way as in WPF.  The use of the <code>Command</code> property for these controls is described in the " <a href="http://msdn.microsoft.com/en-us/library/gg405484(v%3DPandP.40).aspx">Commands</a> " section in Chapter 5, " <a href="http://msdn.microsoft.com/en-us/library/gg405484(v%3DPandP.40).aspx">Implementing the MVVM Pattern</a> ".  However, the attached behavior of the command remains in the Prism library for reasons of backward compatibility and to support the development of custom behaviors, as will be described later. <br><br>  The behavior approach is a common method for implementing and encapsulating interactive behavior and can be easily applied to controls in a view.  Using behaviors to support commands, as shown earlier, is just one of many scenarios that can support behaviors.  Microsoft Expression Blend provides many behaviors, including <code>InvokeCommandAction</code> and <code>CallMethodAction</code> , described in the section ‚ÄúInvoking Command Methods from the View‚Äù in Chapter 5, ‚Äú <a href="http://msdn.microsoft.com/en-us/library/gg405484(v%3DPandP.40).aspx">Implementing the MVVM Pattern</a> ‚Äù, and the Expression Blend Behaviors SDK provides the ability to develop custom behaviors.  With Expression Blend, you can easily create and edit behaviors, which makes it very easy to add to an application.  For more information on developing custom behaviors in Expression Blend, see " <a href="http://msdn.microsoft.com/en-us/library/ff724708(v%3DExpression.40).aspx">Creating Custom Behaviors</a> " on MSDN. <br><br>  Although the introduction of command-supporting controls in Silverlight 4 and the Expression Blend Behaviors SDK eliminate most of the need for Prism behaviors, their compact syntax and implementation, as well as their easy expansion, can be found useful. <br><br><h5>  Application of behaviors </h5><br>  Command behaviors are based on an attached behavior pattern.  This pattern connects events triggered by controls and command objects provided by the view model.  The command behavior consists of two parts: an attached property and an object of behavior.  The attached property establishes the relationship between the target control and the behavior object.  The behavior object controls the target control and raises events based on events or state changes in the control or view model. <br><br>  Commands triggered by a <code>Click</code> event in <code>ButtonBase</code> controls are provided by the <code>ButtonBaseClickCommandBehavior</code> class.  The following illustration shows the relationship between <code>ButtonBase</code> , <code>ButtonBaseClickCommandBehavior</code> , and the <code>ICommand</code> object provided by the view model. <br><br><img title="Redirect ButtonClick events to IComman." src="https://habrastorage.org/getpro/habr/post_images/03a/9f1/152/03a9f11527e53e4f339176ca3e5ee173.png" alt="  ButtonClick  IComman."><br><br>  Your application may need to call commands not only at the <code>Click</code> event of <code>ButtonBase</code> , or it may need to customize how the behavior interacts with the target control or view model with which it is associated.  In these cases, you will need to define your own associated property and / or behavior implementation. <br><br>  The Prism library provides the <code><code>CommandBehaviorBase ,    ,    ICommand .           <code>CanExecuteChanged</code> ,          Silverlight,    WPF. <br> <br>    ,  ,   <code><code>CommandBehaviorBase    ,    .         ,      .         ,    .      ButtonBaseClickCommandBehavior</code> . <br> <br> <code class="cs">public class ButtonBaseClickCommandBehavior : CommandBehaviorBase&lt;ButtonBase&gt; { public ButtonBaseClickCommandBehavior(ButtonBase clickableObject) : base(clickableObject) { clickableObject.Click += OnClick; } private void OnClick(object sender, System.Windows.RoutedEventArgs e) { ExecuteCommand(); } }</code> <br>   <code><code>CommandBehaviorBase ,     .     ,          ,   . ,    ,    ,      , ,    CanExecute</code>  ,     . <br> <br>          ,   .           XAML.           .       .  Prism      ,       ,  ,   .       ,    . , ,  ,      <code>Click</code> ,       <code>Command</code> .    <code>Click.Command</code> ,  . <br> <br>             .             . <br> <br> <code class="cs">public static readonly DependencyProperty CommandProperty = DependencyProperty.RegisterAttached( "Command", typeof(ICommand), typeof(Click), new PropertyMetadata(OnSetCommandCallback)); private static readonly DependencyProperty ClickCommandBehaviorProperty = DependencyProperty.RegisterAttached( "ClickCommandBehavior", typeof(ButtonBaseClickCommandBehavior), typeof(Click), null);</code> <br>    <code>Command</code>    <code>ButtonBaseClickCommandBehavior</code> ,     <code>OnSetCommandCallback</code> ,     . <br> <br> <code class="cs">private static void OnSetCommandCallback(DependencyObject dependencyObject, DependencyPropertyChangedEventArgs e) { ButtonBase buttonBase = dependencyObject as ButtonBase; if (buttonBase != null) { ButtonBaseClickCommandBehavior behavior = GetOrCreateBehavior(buttonBase); behavior.Command = e.NewValue as ICommand; } } private static void OnSetCommandParameterCallback(DependencyObject dependencyObject, DependencyPropertyChangedEventArgs e) { ButtonBase buttonBase = dependencyObject as ButtonBase; if (buttonBase != null) { ButtonBaseClickCommandBehavior behavior = GetOrCreateBehavior(buttonBase); behavior.CommandParameter = e.NewValue; } } private static ButtonBaseClickCommandBehavior GetOrCreateBehavior(ButtonBase buttonBase ) { ButtonBaseClickCommandBehavior behavior = buttonBase.GetValue(ClickCommandBehaviorProperty) as ButtonBaseClickCommandBehavior; if ( behavior == null ) { behavior = new ButtonBaseClickCommandBehavior(buttonBase); buttonBase.SetValue(ClickCommandBehaviorProperty, behavior); } return behavior; }</code> <br>        ,  <a href="http://msdn.microsoft.com/en-us/library/cc265152(VS.95).aspx">Attached Properties Overview</a>  MSDN. <br> <br>    <br>              . ,     Silverlight,    -,     ,      ,     .     ,       . <br> <br>        ,    ( )  ,  ,     .  UI       ,            UI. <br> <br>      - <br>   -     ,       <code>IAsyncResult</code> .   ,  ,   ,  <code>GetQuestionnaire</code> ,   : <code>BeginGetQuestionnaire</code>  <code>EndGetQuestionnaire</code> .    ,   <code>BeginGetQuestionnaire</code> .     ,   ,   <code>EndGetQuestionnaire</code>    . <br> <b></b> <br>  .NET Framework 4.5      <code>await</code>  <code>async</code>     <code>*Async</code> .      <a href="http://msdn.microsoft.com/en-us/library/vstudio/hh391443.aspx">"Asynchronous Programming with Async and Await (C# and Visual Basic)"</a> . <br>  ,    <code>EndGetQuestionnaire</code> ,      ,  ()      <code>BeginGetQuestionnaire</code> .     ,      ,   <code>EndGetQuestionnaire</code> ,   . <br> <br> <code class="xml">IAsyncResult asyncResult = this.service.BeginGetQuestionnaire( GetQuestionnaireCompleted, null //  ,      ); private void GetQuestionnaireCompleted(IAsyncResult result) { try { questionnaire = this.service.EndGetQuestionnaire(ar); } catch (Exception ex) { //  -   . } }</code> <br>  ,     <code>End*</code> (  , <code>EndGetQuestionnaire</code> ),    ,      .      , ,          UI.     ,   ,        . <br> <br>        UI,     -,      UI,         UI,   <code>Dispatcher</code>    <code>SynchronizationContext</code> .  WPF  Silverlight,   <code>Dispatcher</code> . <br> <br>      <code>Questionnaire</code>  ,        <code>QuestionnaireView</code> .  Silverlight    <code>CheckAccess</code> ,  ,      UI.  ,     <code>BeginInvoke</code> ,      UI. <br> <br> <code class="cs">var dispatcher = System.Windows.Deployment.Current.Dispatcher; if (dispatcher.CheckAccess()) { QuestionnaireView.DataContext = questionnaire; } else { dispatcher.BeginInvoke(() =&gt; { Questionnaire.DataContext = questionnaire; }); }</code> <br> <i>MVVM RI</i>   ,    ,   <code>IAsyncResult</code> ,   .      ,                 . ,       . <br> <br> <code class="cs">this.questionnaireRepository.GetQuestionnaireAsync( result =&gt; { this.Questionnaire = result.Result; });</code> <br>  <code>result</code>   ,     , , , .    ,     . <br> <br> <code class="cs">this.questionnaireRepository.GetQuestionnaireAsync( result =&gt; { if (result.Error == null) { this.Questionnaire = result.Result; ... } else { // Handle error. } })</code> <br>     <br>        ,      .     , ,             .        ,      ,     ,     . <br> <br>         ,      MVVM,     ,   . ,  -MVVM ,     <code>MessageBox</code>   code-behind UI,      .   MVVM     ,          . <br> <br>     MVVM,              ,          .      ,    ,   ,  ,     . <br> <br>              MVVM.      ,     ,     ,  ,     .    ,         ,     ,          .       . <br> <br>    <br>                  .        ,        .  ,         .         . <br> <br>  ,         ,         ,  .      ,     .           ,       . ,        WPF  Silverlight,        . <br> <br> <img title="Using the service to interact with the user." src="https://habrastorage.org/getpro/habr/post_images/4b5/397/f2d/4b5397f2d02e5851195b29f1893be6fc.png" alt=" ,    ."> <br> <br>  ,   <code>MessageBox</code>        ,     ,    ,     . <br> <br> <code class="cs">var result = interactionService.ShowMessageBox( "Are you sure you want to cancel this operation?", "Confirm", MessageBoxButton.OK); if (result == MessageBoxResult.Yes) { CancelRequest(); }</code> <br> ,      - ,      ,         Silverlight.         .             .     . <br> <br> <code class="cs">interactionService.ShowMessageBox( "Are you sure you want to cancel this operation?", "Confirm", MessageBoxButton.OK, result =&gt; { if (result == MessageBoxResult.Yes) { CancelRequest(); } });</code> <br>         ,      . ,  WPF    <code>MessageBox</code> ,       ;    Silverlight    ,    . <br> <br>     <br>         ‚Äì             .         ,      .     ,     .        ,        ,   ,     . <br> <br> <img title="Using interaction request objects." src="https://habrastorage.org/getpro/habr/post_images/3d0/ff0/1c5/3d0ff01c5518558c2d3c5c5f47ce0ce9.png" alt="   ."> <br> <br>    ,   ,          ‚Äì       ,      ,   ‚Äì     .   ,        ,    ,    UI            . <br> <br>       MVVM,     ,       ,         .         ,        ,    ,   . <br> <br>  Prism       <code>IInteractionRequest</code>   <code><code>InteractionRequest .  IInteractionRequest</code>  ,   .           ,   .  <code><code>InteractionRequest   IInteractionRequest</code>     <code>Raise</code> ,           , , ,   . <br> <br>       <br>  <code><code>InteractionRequest          .  Raise</code>          ( <code>T</code> )    ,    ,   .          ,       .      ,        .    ,  ,     . <br> <code class="cs">public interface IInteractionRequest { event EventHandler&lt;InteractionRequestedEventArgs&gt; Raised; } public class InteractionRequest&lt;T&gt; : IInteractionRequest { public event EventHandler&lt;InteractionRequestedEventArgs&gt; Raised; public void Raise(T context, Action&lt;T&gt; callback) { var handler = this.Raised; if (handler != null) { handler( this, new InteractionRequestedEventArgs(context, () =&gt; callback(context))); } } }</code> <br> Prism    ,      .  <code>Notification</code>       .    ,            .     ‚Äì <code>Title</code>  <code>Content</code> ,    .  ,   ,  ,  ,        . <br> <br>  <code>Confirmation</code>    <code>Notification</code>     ‚Äì <code>Confirmed</code> ,  ,  ,      .  <code>Confirmation</code> ,     <code>MessageBox</code> ,     /  .     ,     <code>Notification</code> ,     ,      . <br> <br>    <code><code><code>InteractionRequest ,       InteractionRequest      ,      .      ,    Raise</code> ,    , ,   . <br> <br> <code class="cs">public IInteractionRequest ConfirmCancelInteractionRequest { get { return this.confirmCancelInteractionRequest; } } this.confirmCancelInteractionRequest.Raise( new Confirmation("Are you sure you wish to cancel?"), confirmation =&gt; { if (confirmation.Confirmed) { this.NavigateToQuestionnaireList(); } }); }</code> <br> <i>MVVM Reference Implementation (MVVM RI)</i> ,    <code>IInteractionRequest</code>   <code><code>InteractionRequest ,          (. QuestionnaireViewModel.cs</code> ). <br> <br>        <br>       ,       .   ,       .    UI             . <br> <br>                . Microsoft Expression Blend Behaviors Framework     .  ,     ,    . <br> <br>  <code>EventTrigger</code> ,  Expression Blend,  ,      ,     ,   . , Prism   <code>EventTrigger</code> ,  <code>InteractionRequestTrigger</code> ,      <code>Raised</code>   <code>IInteractionRequest</code> .    XAML        . <br> <br>  ,   , <code>InteractionRequestTrigger</code>   .  Silverlight Prism   <code>PopupChildWindowAction</code> ,     .    ,         .   <code>ContentTemplate</code>  <code>PopupChildWindowAction</code> ,    ,    UI,      <code>Content</code>  .       <code>Title</code>  . <br> <b></b> <br>  ,    ,   <code>PopupChildWindowAction</code> ,     .    <code>Notification</code>  <code>NotificationChildWindow</code> ,        <code>Confirmation</code> ‚Äì <code>ConfirmationChildWindow</code> . <code>NotificationChildWindow</code>    ,   ,     <code>ConfirmationChildWindow</code>    <i>OK</i>  <i>Cancel</i> ,    .    ,   ,   <code>ChildWindow</code>  <code>PopupChildWindowAction</code> . <br>   ,  <code>InteractionRequestTrigger</code>  <code>PopupChildWindowAction</code> ,       <i>RI MVVM</i> . <br> <br> <code class="xml">&lt;i:Interaction.Triggers&gt; &lt;prism:InteractionRequestTrigger SourceObject="{Binding ConfirmCancelInteractionRequest}"&gt; &lt;prism:PopupChildWindowAction ContentTemplate="{StaticResource ConfirmWindowTemplate}"/&gt; &lt;/prism:InteractionRequestTrigger&gt; &lt;/i:Interaction.Triggers&gt; &lt;UserControl.Resources&gt; &lt;DataTemplate x:Key="ConfirmWindowTemplate"&gt; &lt;Grid MinWidth="250" MinHeight="100"&gt; &lt;TextBlock TextWrapping="Wrap" Grid.Row="0" Text="{Binding}"/&gt; &lt;/Grid&gt; &lt;/DataTemplate&gt; &lt;/UserControl.Resources&gt;</code> <br> <b></b> <br>      <code>ContentTemplate</code> ,   UI   <code>Content</code>  .    <code>Content</code>  ,  , <code>TextBlock</code>     <code>Content</code> . <br>      ,     ,    ,    .  ,     ,       ,     ,    .   ,   <i>RI MVVM</i> ,         <code>Confirmed</code>    <code>Confirmation</code>  <code>true</code> ,     OK. <br> <br>        ,     .  Prism <code>InteractionRequestTrigger</code>   <code>PopupChildWindowAction</code>            . <br> <br>     <br>     MVVM,       , ,    ,         .        (  , ,  ,   ).    ,  ,  ,            . <br> <br>        ,         . Managed Extensibility Framework (MEF)  Unity Application Block (Unity)      ,  ,           . <br> <br>  ,       , , ,    ( )      . ,       ,     .  ,     ,       . <br> <br>     ,  MEF <br>  MEF,       ,   <code>Import</code> ,      ,  ,   <code>Export</code> .         ,    . <br> <br> , <code>QuestionnaireView</code>   <i>RI MVVM</i> ,        ,    <code>Import</code> .   , MEF           .  <code>set</code>        ,   . <br> <br> <code class="cs">[Import] public QuestionnaireViewModel ViewModel { set { this.DataContext = value; } }</code> <br>     ,   . <br> <br> <code class="cs">[Export] public class QuestionnaireViewModel : NotificationObject { ... }</code> <br>        ,   . <br> <br> <code class="cs">public QuestionnaireView() { InitializeComponent(); } [ImportingConstructor] public QuestionnaireView(QuestionnaireViewModel viewModel) : this() { this.DataContext = viewModel; }</code> <br> <b></b> <br>          MEF,   Unity.   ,     ,        .   ,   Visual Studio  Expression Blend, ,        ,     .   ,   ,  ,      ,          <code>InitializeComponent</code> . <br>     ,  Unity <br>  Unity,    ,   MEF.     ,      .    ,         .  ,      . <br> <br>  ,      ,  ,         . ,           ,   . <br> <br> <code class="cs">public QuestionnaireView() { InitializeComponent(); } public QuestionnaireView(QuestionnaireViewModel viewModel) : this() { this.DataContext = viewModel; }</code> <br> <b></b> <br>    ,        ,   Visual Studio  Expression Blend. <br>  ,          ,   . Unity        <code>set</code>   ,   . <br> <br> <code class="cs">public QuestionnaireView() { InitializeComponent(); } [Dependency] public QuestionnaireViewModel ViewModel { set { this.DataContext = value; } }</code> <br>       Unity. <br> <br> <code class="cs">container.RegisterType&lt;QuestionnaireViewModel&gt;();</code> <br>  ,     . <br> <br> <code class="cs">var view = container.Resolve&lt;QuestionnaireView&gt;();</code> <br>     ,    <br>   ,     ,        .        ,   MEF  Unity,        . <br> <br>          .   ,         UI,           . <br> <br> , <i>RI MVVM</i>   ,   ,        .   ,    .      <code>ShowView</code>   UI. <br> <br> <code class="cs">private void NavigateToQuestionnaireList() { //     "questionnaire list". this.uiService.ShowView(ViewNames.QuestionnaireTemplatesList); }</code> <br>  UI      UI .           UI.  <code>ShowView</code>  <code>UIService</code>      (,          ),       ,   . <br> <br> <code class="cs">public void ShowView(string viewName) { var view = this.ViewFactory.GetView(viewName); this.MainWindow.CurrentView = view; }</code> <br> <b></b> <br> Prism       .   ,   ,   ,             .    ,  , " <a href="http://msdn.microsoft.com/en-us/library/gg430861(v%3DPandP.40).aspx">View-Based Navigation</a> "   8, " <a href="http://msdn.microsoft.com/en-us/library/gg430861(v%3DPandP.40).aspx">Navigation</a> ". <br>  MVVM  <br>        MVVM      .           -      mocking . ,   ,        . <br> <br>   <i>INotifyPropertyChanged</i> <br>   <code>INotifyPropertyChanged</code>     ,      .      ,    ;   ,   ,     ,    ,       . <br> <br>   <br> ,       ,           <code>PropertyChanged</code>  ,         .  ,    <code>ChangeTracker</code> ,     MVVM,  ,      .      .     ,    . <br> <br> <code class="cs">var changeTracker = new PropertyChangeTracker(viewModel); viewModel.CurrentState = "newState"; CollectionAssert.Contains(changeTracker.ChangedProperties, "CurrentState");</code> <br> ,     ,     <code>INotifyPropertyChanged</code> ,    ,   ,     . <br> <br>      <br>        ,   ,    <code>set</code>      ,           . ,     ,     ,      ,          . <br> <br> <code class="cs">var changeTracker = new PropertyChangeTracker(viewModel); var question = viewModel.Questions.First() as OpenQuestionViewModel; question.Question.Response = "some text"; CollectionAssert.Contains(changeTracker.ChangedProperties, "UnansweredQuestions");</code> <br>      <br>     <code>INotifyPropertyChanged</code> ,      <code>PropertyChanged</code>        ,  ,     , , .        ,       . <br> <br>   <i>INotifyDataErrorInfo</i> <br>   ,     ,    ,   ,   <code>IDataErrorInfo</code> ,  ( Silverlight)   <code>INotifyDataErrorInfo</code> .   <code>INotifyDataErrorInfo</code>   ,         ,    ,  ,   ,    . <br> <br>       <code>INotifyDataErrorInfo</code> : ,     ,  ,     ,     <code>ErrorsChanged</code> ,      <code>GetErrors</code> , . <br> <br>    <br>     ,      ,     .       ,         <code>GetErrors</code>       ,  ,  ,   .    , ,  ,     ,        .   ,        . <br> <br> <code class="cs">//  . var notifyErrorInfo = (INotifyDataErrorInfo)question; question.Response = -15; Assert.IsTrue(notifyErrorInfo.GetErrors("Response").Cast&lt;ValidationResult&gt;().Any()); //  . var notifyErrorInfo = (INotifyDataErrorInfo)question; question.Response = 15; Assert.IsFalse(notifyErrorInfo.GetErrors("Response").Cast&lt;ValidationResult&gt;().Any());</code> <br>    ,    ,             . <br> <br>    <i>INotifyDataErrorInfo</i> <br>       <code>GetErrors</code> ,   <code>INotifyDataErrorInfo</code>  ,   <code>ErrorsChanged</code>      <code>GetErrors</code> . ,  <code>HasErrors</code>      ,  . <br> <br>       <code>INotifyDataErrorInfo</code> . , ,           ,   -  .      ,        <code>INotifyDataErrorInfo</code>         (,        ). <br> <br>     ,   ,  : <br>  <code>HasErrors</code>     .              ,       .  <code>ErrorsChanged</code> ,      ,         <code>GetErrors</code> .         ( ,  )     ,           .    <code>GetErrors</code>       <code>ErrorsChanged</code> . <br>    <code>INotifyPropertyChanged</code> ,  ,    <code>NotifyDataErrorInfoTestHelper</code>    MVVM,        <code>INotifyDataErrorInfo</code> ,       .   ,   ,      ,   .      . <br> <code class="cs">var helper = new NotifyDataErrorInfoTestHelper&lt;NumericQuestion, int?&gt;( question, q =&gt; q.Response); helper.ValidatePropertyChange( 6, NotifyDataErrorInfoBehavior.Nothing); helper.ValidatePropertyChange( 20, NotifyDataErrorInfoBehavior.FiresErrorsChanged | NotifyDataErrorInfoBehavior.HasErrors | NotifyDataErrorInfoBehavior.HasErrorsForProperty); helper.ValidatePropertyChange( null, NotifyDataErrorInfoBehavior.FiresErrorsChanged | NotifyDataErrorInfoBehavior.HasErrors | NotifyDataErrorInfoBehavior.HasErrorsForProperty); helper.ValidatePropertyChange( 2, NotifyDataErrorInfoBehavior.FiresErrorsChanged);</code> <br>     <br>   MVVM,     ,  .   ,    ,         . <br> <br>  ,     ,     ,       .   ,   , ,       ,     ,   <code>IAsyncResult</code>    ,  - ,   ,    UI. <br> <br>       , , ,    .   ,     .  ,      UI,     ,   ,          ,     ,        "   UI." <br> <br>     ,    ,    .   ,    ,     mock-, ,   ,   ,      ,          . <br> <br>           UI,    ,    .   ,     ,   ,      .        ,   .     ,    ,     . <br> <br> <code class="cs">questionnaireRepositoryMock .Setup( r =&gt; r.SubmitQuestionnaireAsync( It.IsAny&lt;Questionnaire&gt;(), It.IsAny&lt;Action&lt;IOperationResult&gt;&gt;())) .Callback&lt;Questionnaire, Action&lt;IOperationResult&gt;&gt;( (q, a) =&gt; callback = a); uiServicemock .Setup(svc =&gt; svc.ShowView(ViewNames.QuestionnaireTemplatesList)) .Callback&lt;string&gt;(viewName =&gt; requestedViewName = viewName); submitResultMock .Setup(sr =&gt; sr.Error) .Returns&lt;Exception&gt;(null); CompleteQuestionnaire(viewModel); viewModel.Submit(); //      UI . callback(submitResultMock.Object); //    ‚Äì     . Assert.AreEqual(ViewNames.QuestionnaireTemplatesList, requestedViewName);</code> <br> <b></b> <br>          ,        . <br>   <br>       , . "Trees in WPF"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ms753391.aspx">http://msdn.microsoft.com/en-us/library/ms753391.aspx</a> <br> <br>       , . "Attached Properties Overview"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/cc265152(VS.95).aspx">http://msdn.microsoft.com/en-us/library/cc265152(VS.95).aspx</a> <br> <br>      MEF, ."Managed Extensibility Framework Overview"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/dd460648.aspx">http://msdn.microsoft.com/en-us/library/dd460648.aspx</a> . <br> <br>      Unity, ."Unity Application Block"  MSDN: <a href="http://www.msdn.com/unity">http://www.msdn.com/unity</a> . <br> <br>      <code>DelegateCommand</code> , .Chapter 5, " <a href="http://msdn.microsoft.com/en-us/library/gg405484(v%3DPandP.40).aspx">Implementing the MVVM Pattern</a> ." <br> <br>        Microsoft Expression Blend, ."Working with built-in behaviors"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ff724013(v%3DExpression.40).aspx">http://msdn.microsoft.com/en-us/library/ff724013(v=Expression.40).aspx</a> . <br> <br>          Microsoft Expression Blend, ."Creating Custom Behaviors"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ff724708(v%3DExpression.40).aspx">http://msdn.microsoft.com/en-us/library/ff724708(v=Expression.40).aspx</a> . <br> <br>            Microsoft Expression Blend, ."Creating Custom Triggers and Actions"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ff724707(v%3DExpression.40).aspx">http://msdn.microsoft.com/en-us/library/ff724707(v=Expression.40).aspx</a> . <br> <br>         WPF  Silverlight, ."Threading Model"  "The Dispatcher Class"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ms741870.aspx">http://msdn.microsoft.com/en-us/library/ms741870.aspx</a> <br> <a href="http://msdn.microsoft.com/en-us/library/ms615907(v%3DVS.95).aspx">http://msdn.microsoft.com/en-us/library/ms615907(v=VS.95).aspx</a> . <br> <br>      unit-  Silverlight, ."Unit Testing with Silverlight 2": <a href="http://www.jeff.wilcox.name/2008/03/silverlight2-unit-testing/">http://www.jeff.wilcox.name/2008/03/silverlight2-unit-testing/</a> . <br> <br>         , .  " <a href="http://msdn.microsoft.com/en-us/library/gg430861(v%3DPandP.40).aspx">View-Based Navigation</a> " in Chapter 8, " <a href="http://msdn.microsoft.com/en-us/library/gg430861(v%3DPandP.40).aspx">Navigation</a> ." <br> <br>       ,   , ."Event-based Asynchronous Pattern Overview"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/wewwczdw.aspx">http://msdn.microsoft.com/en-us/library/wewwczdw.aspx</a> <br> <br>        <code>IAsyncResult</code> , ."Asynchronous Programming Overview"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ms228963.aspx">http://msdn.microsoft.com/en-us/library/ms228963.aspx</a></code></code></code></code></code></code></code></code></code></code> class <code><code>CommandBehaviorBase ,    ,    ICommand</code> .           <code>CanExecuteChanged</code> ,          Silverlight,    WPF. <br> <br>    ,  ,   <code><code>CommandBehaviorBase    ,    .         ,      .         ,    .      ButtonBaseClickCommandBehavior</code> . <br> <br> <code class="cs">public class ButtonBaseClickCommandBehavior : CommandBehaviorBase&lt;ButtonBase&gt; { public ButtonBaseClickCommandBehavior(ButtonBase clickableObject) : base(clickableObject) { clickableObject.Click += OnClick; } private void OnClick(object sender, System.Windows.RoutedEventArgs e) { ExecuteCommand(); } }</code> <br>   <code><code>CommandBehaviorBase ,     .     ,          ,   . ,    ,    ,      , ,    CanExecute</code>  ,     . <br> <br>          ,   .           XAML.           .       .  Prism      ,       ,  ,   .       ,    . , ,  ,      <code>Click</code> ,       <code>Command</code> .    <code>Click.Command</code> ,  . <br> <br>             .             . <br> <br> <code class="cs">public static readonly DependencyProperty CommandProperty = DependencyProperty.RegisterAttached( "Command", typeof(ICommand), typeof(Click), new PropertyMetadata(OnSetCommandCallback)); private static readonly DependencyProperty ClickCommandBehaviorProperty = DependencyProperty.RegisterAttached( "ClickCommandBehavior", typeof(ButtonBaseClickCommandBehavior), typeof(Click), null);</code> <br>    <code>Command</code>    <code>ButtonBaseClickCommandBehavior</code> ,     <code>OnSetCommandCallback</code> ,     . <br> <br> <code class="cs">private static void OnSetCommandCallback(DependencyObject dependencyObject, DependencyPropertyChangedEventArgs e) { ButtonBase buttonBase = dependencyObject as ButtonBase; if (buttonBase != null) { ButtonBaseClickCommandBehavior behavior = GetOrCreateBehavior(buttonBase); behavior.Command = e.NewValue as ICommand; } } private static void OnSetCommandParameterCallback(DependencyObject dependencyObject, DependencyPropertyChangedEventArgs e) { ButtonBase buttonBase = dependencyObject as ButtonBase; if (buttonBase != null) { ButtonBaseClickCommandBehavior behavior = GetOrCreateBehavior(buttonBase); behavior.CommandParameter = e.NewValue; } } private static ButtonBaseClickCommandBehavior GetOrCreateBehavior(ButtonBase buttonBase ) { ButtonBaseClickCommandBehavior behavior = buttonBase.GetValue(ClickCommandBehaviorProperty) as ButtonBaseClickCommandBehavior; if ( behavior == null ) { behavior = new ButtonBaseClickCommandBehavior(buttonBase); buttonBase.SetValue(ClickCommandBehaviorProperty, behavior); } return behavior; }</code> <br>        ,  <a href="http://msdn.microsoft.com/en-us/library/cc265152(VS.95).aspx">Attached Properties Overview</a>  MSDN. <br> <br>    <br>              . ,     Silverlight,    -,     ,      ,     .     ,       . <br> <br>        ,    ( )  ,  ,     .  UI       ,            UI. <br> <br>      - <br>   -     ,       <code>IAsyncResult</code> .   ,  ,   ,  <code>GetQuestionnaire</code> ,   : <code>BeginGetQuestionnaire</code>  <code>EndGetQuestionnaire</code> .    ,   <code>BeginGetQuestionnaire</code> .     ,   ,   <code>EndGetQuestionnaire</code>    . <br> <b></b> <br>  .NET Framework 4.5      <code>await</code>  <code>async</code>     <code>*Async</code> .      <a href="http://msdn.microsoft.com/en-us/library/vstudio/hh391443.aspx">"Asynchronous Programming with Async and Await (C# and Visual Basic)"</a> . <br>  ,    <code>EndGetQuestionnaire</code> ,      ,  ()      <code>BeginGetQuestionnaire</code> .     ,      ,   <code>EndGetQuestionnaire</code> ,   . <br> <br> <code class="xml">IAsyncResult asyncResult = this.service.BeginGetQuestionnaire( GetQuestionnaireCompleted, null //  ,      ); private void GetQuestionnaireCompleted(IAsyncResult result) { try { questionnaire = this.service.EndGetQuestionnaire(ar); } catch (Exception ex) { //  -   . } }</code> <br>  ,     <code>End*</code> (  , <code>EndGetQuestionnaire</code> ),    ,      .      , ,          UI.     ,   ,        . <br> <br>        UI,     -,      UI,         UI,   <code>Dispatcher</code>    <code>SynchronizationContext</code> .  WPF  Silverlight,   <code>Dispatcher</code> . <br> <br>      <code>Questionnaire</code>  ,        <code>QuestionnaireView</code> .  Silverlight    <code>CheckAccess</code> ,  ,      UI.  ,     <code>BeginInvoke</code> ,      UI. <br> <br> <code class="cs">var dispatcher = System.Windows.Deployment.Current.Dispatcher; if (dispatcher.CheckAccess()) { QuestionnaireView.DataContext = questionnaire; } else { dispatcher.BeginInvoke(() =&gt; { Questionnaire.DataContext = questionnaire; }); }</code> <br> <i>MVVM RI</i>   ,    ,   <code>IAsyncResult</code> ,   .      ,                 . ,       . <br> <br> <code class="cs">this.questionnaireRepository.GetQuestionnaireAsync( result =&gt; { this.Questionnaire = result.Result; });</code> <br>  <code>result</code>   ,     , , , .    ,     . <br> <br> <code class="cs">this.questionnaireRepository.GetQuestionnaireAsync( result =&gt; { if (result.Error == null) { this.Questionnaire = result.Result; ... } else { // Handle error. } })</code> <br>     <br>        ,      .     , ,             .        ,      ,     ,     . <br> <br>         ,      MVVM,     ,   . ,  -MVVM ,     <code>MessageBox</code>   code-behind UI,      .   MVVM     ,          . <br> <br>     MVVM,              ,          .      ,    ,   ,  ,     . <br> <br>              MVVM.      ,     ,     ,  ,     .    ,         ,     ,          .       . <br> <br>    <br>                  .        ,        .  ,         .         . <br> <br>  ,         ,         ,  .      ,     .           ,       . ,        WPF  Silverlight,        . <br> <br> <img title="Using the service to interact with the user." src="https://habrastorage.org/getpro/habr/post_images/4b5/397/f2d/4b5397f2d02e5851195b29f1893be6fc.png" alt=" ,    ."> <br> <br>  ,   <code>MessageBox</code>        ,     ,    ,     . <br> <br> <code class="cs">var result = interactionService.ShowMessageBox( "Are you sure you want to cancel this operation?", "Confirm", MessageBoxButton.OK); if (result == MessageBoxResult.Yes) { CancelRequest(); }</code> <br> ,      - ,      ,         Silverlight.         .             .     . <br> <br> <code class="cs">interactionService.ShowMessageBox( "Are you sure you want to cancel this operation?", "Confirm", MessageBoxButton.OK, result =&gt; { if (result == MessageBoxResult.Yes) { CancelRequest(); } });</code> <br>         ,      . ,  WPF    <code>MessageBox</code> ,       ;    Silverlight    ,    . <br> <br>     <br>         ‚Äì             .         ,      .     ,     .        ,        ,   ,     . <br> <br> <img title="Using interaction request objects." src="https://habrastorage.org/getpro/habr/post_images/3d0/ff0/1c5/3d0ff01c5518558c2d3c5c5f47ce0ce9.png" alt="   ."> <br> <br>    ,   ,          ‚Äì       ,      ,   ‚Äì     .   ,        ,    ,    UI            . <br> <br>       MVVM,     ,       ,         .         ,        ,    ,   . <br> <br>  Prism       <code>IInteractionRequest</code>   <code><code>InteractionRequest .  IInteractionRequest</code>  ,   .           ,   .  <code><code>InteractionRequest   IInteractionRequest</code>     <code>Raise</code> ,           , , ,   . <br> <br>       <br>  <code><code>InteractionRequest          .  Raise</code>          ( <code>T</code> )    ,    ,   .          ,       .      ,        .    ,  ,     . <br> <code class="cs">public interface IInteractionRequest { event EventHandler&lt;InteractionRequestedEventArgs&gt; Raised; } public class InteractionRequest&lt;T&gt; : IInteractionRequest { public event EventHandler&lt;InteractionRequestedEventArgs&gt; Raised; public void Raise(T context, Action&lt;T&gt; callback) { var handler = this.Raised; if (handler != null) { handler( this, new InteractionRequestedEventArgs(context, () =&gt; callback(context))); } } }</code> <br> Prism    ,      .  <code>Notification</code>       .    ,            .     ‚Äì <code>Title</code>  <code>Content</code> ,    .  ,   ,  ,  ,        . <br> <br>  <code>Confirmation</code>    <code>Notification</code>     ‚Äì <code>Confirmed</code> ,  ,  ,      .  <code>Confirmation</code> ,     <code>MessageBox</code> ,     /  .     ,     <code>Notification</code> ,     ,      . <br> <br>    <code><code><code>InteractionRequest ,       InteractionRequest      ,      .      ,    Raise</code> ,    , ,   . <br> <br> <code class="cs">public IInteractionRequest ConfirmCancelInteractionRequest { get { return this.confirmCancelInteractionRequest; } } this.confirmCancelInteractionRequest.Raise( new Confirmation("Are you sure you wish to cancel?"), confirmation =&gt; { if (confirmation.Confirmed) { this.NavigateToQuestionnaireList(); } }); }</code> <br> <i>MVVM Reference Implementation (MVVM RI)</i> ,    <code>IInteractionRequest</code>   <code><code>InteractionRequest ,          (. QuestionnaireViewModel.cs</code> ). <br> <br>        <br>       ,       .   ,       .    UI             . <br> <br>                . Microsoft Expression Blend Behaviors Framework     .  ,     ,    . <br> <br>  <code>EventTrigger</code> ,  Expression Blend,  ,      ,     ,   . , Prism   <code>EventTrigger</code> ,  <code>InteractionRequestTrigger</code> ,      <code>Raised</code>   <code>IInteractionRequest</code> .    XAML        . <br> <br>  ,   , <code>InteractionRequestTrigger</code>   .  Silverlight Prism   <code>PopupChildWindowAction</code> ,     .    ,         .   <code>ContentTemplate</code>  <code>PopupChildWindowAction</code> ,    ,    UI,      <code>Content</code>  .       <code>Title</code>  . <br> <b></b> <br>  ,    ,   <code>PopupChildWindowAction</code> ,     .    <code>Notification</code>  <code>NotificationChildWindow</code> ,        <code>Confirmation</code> ‚Äì <code>ConfirmationChildWindow</code> . <code>NotificationChildWindow</code>    ,   ,     <code>ConfirmationChildWindow</code>    <i>OK</i>  <i>Cancel</i> ,    .    ,   ,   <code>ChildWindow</code>  <code>PopupChildWindowAction</code> . <br>   ,  <code>InteractionRequestTrigger</code>  <code>PopupChildWindowAction</code> ,       <i>RI MVVM</i> . <br> <br> <code class="xml">&lt;i:Interaction.Triggers&gt; &lt;prism:InteractionRequestTrigger SourceObject="{Binding ConfirmCancelInteractionRequest}"&gt; &lt;prism:PopupChildWindowAction ContentTemplate="{StaticResource ConfirmWindowTemplate}"/&gt; &lt;/prism:InteractionRequestTrigger&gt; &lt;/i:Interaction.Triggers&gt; &lt;UserControl.Resources&gt; &lt;DataTemplate x:Key="ConfirmWindowTemplate"&gt; &lt;Grid MinWidth="250" MinHeight="100"&gt; &lt;TextBlock TextWrapping="Wrap" Grid.Row="0" Text="{Binding}"/&gt; &lt;/Grid&gt; &lt;/DataTemplate&gt; &lt;/UserControl.Resources&gt;</code> <br> <b></b> <br>      <code>ContentTemplate</code> ,   UI   <code>Content</code>  .    <code>Content</code>  ,  , <code>TextBlock</code>     <code>Content</code> . <br>      ,     ,    ,    .  ,     ,       ,     ,    .   ,   <i>RI MVVM</i> ,         <code>Confirmed</code>    <code>Confirmation</code>  <code>true</code> ,     OK. <br> <br>        ,     .  Prism <code>InteractionRequestTrigger</code>   <code>PopupChildWindowAction</code>            . <br> <br>     <br>     MVVM,       , ,    ,         .        (  , ,  ,   ).    ,  ,  ,            . <br> <br>        ,         . Managed Extensibility Framework (MEF)  Unity Application Block (Unity)      ,  ,           . <br> <br>  ,       , , ,    ( )      . ,       ,     .  ,     ,       . <br> <br>     ,  MEF <br>  MEF,       ,   <code>Import</code> ,      ,  ,   <code>Export</code> .         ,    . <br> <br> , <code>QuestionnaireView</code>   <i>RI MVVM</i> ,        ,    <code>Import</code> .   , MEF           .  <code>set</code>        ,   . <br> <br> <code class="cs">[Import] public QuestionnaireViewModel ViewModel { set { this.DataContext = value; } }</code> <br>     ,   . <br> <br> <code class="cs">[Export] public class QuestionnaireViewModel : NotificationObject { ... }</code> <br>        ,   . <br> <br> <code class="cs">public QuestionnaireView() { InitializeComponent(); } [ImportingConstructor] public QuestionnaireView(QuestionnaireViewModel viewModel) : this() { this.DataContext = viewModel; }</code> <br> <b></b> <br>          MEF,   Unity.   ,     ,        .   ,   Visual Studio  Expression Blend, ,        ,     .   ,   ,  ,      ,          <code>InitializeComponent</code> . <br>     ,  Unity <br>  Unity,    ,   MEF.     ,      .    ,         .  ,      . <br> <br>  ,      ,  ,         . ,           ,   . <br> <br> <code class="cs">public QuestionnaireView() { InitializeComponent(); } public QuestionnaireView(QuestionnaireViewModel viewModel) : this() { this.DataContext = viewModel; }</code> <br> <b></b> <br>    ,        ,   Visual Studio  Expression Blend. <br>  ,          ,   . Unity        <code>set</code>   ,   . <br> <br> <code class="cs">public QuestionnaireView() { InitializeComponent(); } [Dependency] public QuestionnaireViewModel ViewModel { set { this.DataContext = value; } }</code> <br>       Unity. <br> <br> <code class="cs">container.RegisterType&lt;QuestionnaireViewModel&gt;();</code> <br>  ,     . <br> <br> <code class="cs">var view = container.Resolve&lt;QuestionnaireView&gt;();</code> <br>     ,    <br>   ,     ,        .        ,   MEF  Unity,        . <br> <br>          .   ,         UI,           . <br> <br> , <i>RI MVVM</i>   ,   ,        .   ,    .      <code>ShowView</code>   UI. <br> <br> <code class="cs">private void NavigateToQuestionnaireList() { //     "questionnaire list". this.uiService.ShowView(ViewNames.QuestionnaireTemplatesList); }</code> <br>  UI      UI .           UI.  <code>ShowView</code>  <code>UIService</code>      (,          ),       ,   . <br> <br> <code class="cs">public void ShowView(string viewName) { var view = this.ViewFactory.GetView(viewName); this.MainWindow.CurrentView = view; }</code> <br> <b></b> <br> Prism       .   ,   ,   ,             .    ,  , " <a href="http://msdn.microsoft.com/en-us/library/gg430861(v%3DPandP.40).aspx">View-Based Navigation</a> "   8, " <a href="http://msdn.microsoft.com/en-us/library/gg430861(v%3DPandP.40).aspx">Navigation</a> ". <br>  MVVM  <br>        MVVM      .           -      mocking . ,   ,        . <br> <br>   <i>INotifyPropertyChanged</i> <br>   <code>INotifyPropertyChanged</code>     ,      .      ,    ;   ,   ,     ,    ,       . <br> <br>   <br> ,       ,           <code>PropertyChanged</code>  ,         .  ,    <code>ChangeTracker</code> ,     MVVM,  ,      .      .     ,    . <br> <br> <code class="cs">var changeTracker = new PropertyChangeTracker(viewModel); viewModel.CurrentState = "newState"; CollectionAssert.Contains(changeTracker.ChangedProperties, "CurrentState");</code> <br> ,     ,     <code>INotifyPropertyChanged</code> ,    ,   ,     . <br> <br>      <br>        ,   ,    <code>set</code>      ,           . ,     ,     ,      ,          . <br> <br> <code class="cs">var changeTracker = new PropertyChangeTracker(viewModel); var question = viewModel.Questions.First() as OpenQuestionViewModel; question.Question.Response = "some text"; CollectionAssert.Contains(changeTracker.ChangedProperties, "UnansweredQuestions");</code> <br>      <br>     <code>INotifyPropertyChanged</code> ,      <code>PropertyChanged</code>        ,  ,     , , .        ,       . <br> <br>   <i>INotifyDataErrorInfo</i> <br>   ,     ,    ,   ,   <code>IDataErrorInfo</code> ,  ( Silverlight)   <code>INotifyDataErrorInfo</code> .   <code>INotifyDataErrorInfo</code>   ,         ,    ,  ,   ,    . <br> <br>       <code>INotifyDataErrorInfo</code> : ,     ,  ,     ,     <code>ErrorsChanged</code> ,      <code>GetErrors</code> , . <br> <br>    <br>     ,      ,     .       ,         <code>GetErrors</code>       ,  ,  ,   .    , ,  ,     ,        .   ,        . <br> <br> <code class="cs">//  . var notifyErrorInfo = (INotifyDataErrorInfo)question; question.Response = -15; Assert.IsTrue(notifyErrorInfo.GetErrors("Response").Cast&lt;ValidationResult&gt;().Any()); //  . var notifyErrorInfo = (INotifyDataErrorInfo)question; question.Response = 15; Assert.IsFalse(notifyErrorInfo.GetErrors("Response").Cast&lt;ValidationResult&gt;().Any());</code> <br>    ,    ,             . <br> <br>    <i>INotifyDataErrorInfo</i> <br>       <code>GetErrors</code> ,   <code>INotifyDataErrorInfo</code>  ,   <code>ErrorsChanged</code>      <code>GetErrors</code> . ,  <code>HasErrors</code>      ,  . <br> <br>       <code>INotifyDataErrorInfo</code> . , ,           ,   -  .      ,        <code>INotifyDataErrorInfo</code>         (,        ). <br> <br>     ,   ,  : <br>  <code>HasErrors</code>     .              ,       .  <code>ErrorsChanged</code> ,      ,         <code>GetErrors</code> .         ( ,  )     ,           .    <code>GetErrors</code>       <code>ErrorsChanged</code> . <br>    <code>INotifyPropertyChanged</code> ,  ,    <code>NotifyDataErrorInfoTestHelper</code>    MVVM,        <code>INotifyDataErrorInfo</code> ,       .   ,   ,      ,   .      . <br> <code class="cs">var helper = new NotifyDataErrorInfoTestHelper&lt;NumericQuestion, int?&gt;( question, q =&gt; q.Response); helper.ValidatePropertyChange( 6, NotifyDataErrorInfoBehavior.Nothing); helper.ValidatePropertyChange( 20, NotifyDataErrorInfoBehavior.FiresErrorsChanged | NotifyDataErrorInfoBehavior.HasErrors | NotifyDataErrorInfoBehavior.HasErrorsForProperty); helper.ValidatePropertyChange( null, NotifyDataErrorInfoBehavior.FiresErrorsChanged | NotifyDataErrorInfoBehavior.HasErrors | NotifyDataErrorInfoBehavior.HasErrorsForProperty); helper.ValidatePropertyChange( 2, NotifyDataErrorInfoBehavior.FiresErrorsChanged);</code> <br>     <br>   MVVM,     ,  .   ,    ,         . <br> <br>  ,     ,     ,       .   ,   , ,       ,     ,   <code>IAsyncResult</code>    ,  - ,   ,    UI. <br> <br>       , , ,    .   ,     .  ,      UI,     ,   ,          ,     ,        "   UI." <br> <br>     ,    ,    .   ,    ,     mock-, ,   ,   ,      ,          . <br> <br>           UI,    ,    .   ,     ,   ,      .        ,   .     ,    ,     . <br> <br> <code class="cs">questionnaireRepositoryMock .Setup( r =&gt; r.SubmitQuestionnaireAsync( It.IsAny&lt;Questionnaire&gt;(), It.IsAny&lt;Action&lt;IOperationResult&gt;&gt;())) .Callback&lt;Questionnaire, Action&lt;IOperationResult&gt;&gt;( (q, a) =&gt; callback = a); uiServicemock .Setup(svc =&gt; svc.ShowView(ViewNames.QuestionnaireTemplatesList)) .Callback&lt;string&gt;(viewName =&gt; requestedViewName = viewName); submitResultMock .Setup(sr =&gt; sr.Error) .Returns&lt;Exception&gt;(null); CompleteQuestionnaire(viewModel); viewModel.Submit(); //      UI . callback(submitResultMock.Object); //    ‚Äì     . Assert.AreEqual(ViewNames.QuestionnaireTemplatesList, requestedViewName);</code> <br> <b></b> <br>          ,        . <br>   <br>       , . "Trees in WPF"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ms753391.aspx">http://msdn.microsoft.com/en-us/library/ms753391.aspx</a> <br> <br>       , . "Attached Properties Overview"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/cc265152(VS.95).aspx">http://msdn.microsoft.com/en-us/library/cc265152(VS.95).aspx</a> <br> <br>      MEF, ."Managed Extensibility Framework Overview"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/dd460648.aspx">http://msdn.microsoft.com/en-us/library/dd460648.aspx</a> . <br> <br>      Unity, ."Unity Application Block"  MSDN: <a href="http://www.msdn.com/unity">http://www.msdn.com/unity</a> . <br> <br>      <code>DelegateCommand</code> , .Chapter 5, " <a href="http://msdn.microsoft.com/en-us/library/gg405484(v%3DPandP.40).aspx">Implementing the MVVM Pattern</a> ." <br> <br>        Microsoft Expression Blend, ."Working with built-in behaviors"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ff724013(v%3DExpression.40).aspx">http://msdn.microsoft.com/en-us/library/ff724013(v=Expression.40).aspx</a> . <br> <br>          Microsoft Expression Blend, ."Creating Custom Behaviors"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ff724708(v%3DExpression.40).aspx">http://msdn.microsoft.com/en-us/library/ff724708(v=Expression.40).aspx</a> . <br> <br>            Microsoft Expression Blend, ."Creating Custom Triggers and Actions"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ff724707(v%3DExpression.40).aspx">http://msdn.microsoft.com/en-us/library/ff724707(v=Expression.40).aspx</a> . <br> <br>         WPF  Silverlight, ."Threading Model"  "The Dispatcher Class"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ms741870.aspx">http://msdn.microsoft.com/en-us/library/ms741870.aspx</a> <br> <a href="http://msdn.microsoft.com/en-us/library/ms615907(v%3DVS.95).aspx">http://msdn.microsoft.com/en-us/library/ms615907(v=VS.95).aspx</a> . <br> <br>      unit-  Silverlight, ."Unit Testing with Silverlight 2": <a href="http://www.jeff.wilcox.name/2008/03/silverlight2-unit-testing/">http://www.jeff.wilcox.name/2008/03/silverlight2-unit-testing/</a> . <br> <br>         , .  " <a href="http://msdn.microsoft.com/en-us/library/gg430861(v%3DPandP.40).aspx">View-Based Navigation</a> " in Chapter 8, " <a href="http://msdn.microsoft.com/en-us/library/gg430861(v%3DPandP.40).aspx">Navigation</a> ." <br> <br>       ,   , ."Event-based Asynchronous Pattern Overview"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/wewwczdw.aspx">http://msdn.microsoft.com/en-us/library/wewwczdw.aspx</a> <br> <br>        <code>IAsyncResult</code> , ."Asynchronous Programming Overview"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ms228963.aspx">http://msdn.microsoft.com/en-us/library/ms228963.aspx</a></code></code></code></code></code></code></code></code></code> <code><code>CommandBehaviorBase ,    ,    ICommand</code> .           <code>CanExecuteChanged</code> ,          Silverlight,    WPF. <br> <br>    ,  ,   <code><code>CommandBehaviorBase    ,    .         ,      .         ,    .      ButtonBaseClickCommandBehavior</code> . <br> <br> <code class="cs">public class ButtonBaseClickCommandBehavior : CommandBehaviorBase&lt;ButtonBase&gt; { public ButtonBaseClickCommandBehavior(ButtonBase clickableObject) : base(clickableObject) { clickableObject.Click += OnClick; } private void OnClick(object sender, System.Windows.RoutedEventArgs e) { ExecuteCommand(); } }</code> <br>   <code><code>CommandBehaviorBase ,     .     ,          ,   . ,    ,    ,      , ,    CanExecute</code>  ,     . <br> <br>          ,   .           XAML.           .       .  Prism      ,       ,  ,   .       ,    . , ,  ,      <code>Click</code> ,       <code>Command</code> .    <code>Click.Command</code> ,  . <br> <br>             .             . <br> <br> <code class="cs">public static readonly DependencyProperty CommandProperty = DependencyProperty.RegisterAttached( "Command", typeof(ICommand), typeof(Click), new PropertyMetadata(OnSetCommandCallback)); private static readonly DependencyProperty ClickCommandBehaviorProperty = DependencyProperty.RegisterAttached( "ClickCommandBehavior", typeof(ButtonBaseClickCommandBehavior), typeof(Click), null);</code> <br>    <code>Command</code>    <code>ButtonBaseClickCommandBehavior</code> ,     <code>OnSetCommandCallback</code> ,     . <br> <br> <code class="cs">private static void OnSetCommandCallback(DependencyObject dependencyObject, DependencyPropertyChangedEventArgs e) { ButtonBase buttonBase = dependencyObject as ButtonBase; if (buttonBase != null) { ButtonBaseClickCommandBehavior behavior = GetOrCreateBehavior(buttonBase); behavior.Command = e.NewValue as ICommand; } } private static void OnSetCommandParameterCallback(DependencyObject dependencyObject, DependencyPropertyChangedEventArgs e) { ButtonBase buttonBase = dependencyObject as ButtonBase; if (buttonBase != null) { ButtonBaseClickCommandBehavior behavior = GetOrCreateBehavior(buttonBase); behavior.CommandParameter = e.NewValue; } } private static ButtonBaseClickCommandBehavior GetOrCreateBehavior(ButtonBase buttonBase ) { ButtonBaseClickCommandBehavior behavior = buttonBase.GetValue(ClickCommandBehaviorProperty) as ButtonBaseClickCommandBehavior; if ( behavior == null ) { behavior = new ButtonBaseClickCommandBehavior(buttonBase); buttonBase.SetValue(ClickCommandBehaviorProperty, behavior); } return behavior; }</code> <br>        ,  <a href="http://msdn.microsoft.com/en-us/library/cc265152(VS.95).aspx">Attached Properties Overview</a>  MSDN. <br> <br>    <br>              . ,     Silverlight,    -,     ,      ,     .     ,       . <br> <br>        ,    ( )  ,  ,     .  UI       ,            UI. <br> <br>      - <br>   -     ,       <code>IAsyncResult</code> .   ,  ,   ,  <code>GetQuestionnaire</code> ,   : <code>BeginGetQuestionnaire</code>  <code>EndGetQuestionnaire</code> .    ,   <code>BeginGetQuestionnaire</code> .     ,   ,   <code>EndGetQuestionnaire</code>    . <br> <b></b> <br>  .NET Framework 4.5      <code>await</code>  <code>async</code>     <code>*Async</code> .      <a href="http://msdn.microsoft.com/en-us/library/vstudio/hh391443.aspx">"Asynchronous Programming with Async and Await (C# and Visual Basic)"</a> . <br>  ,    <code>EndGetQuestionnaire</code> ,      ,  ()      <code>BeginGetQuestionnaire</code> .     ,      ,   <code>EndGetQuestionnaire</code> ,   . <br> <br> <code class="xml">IAsyncResult asyncResult = this.service.BeginGetQuestionnaire( GetQuestionnaireCompleted, null //  ,      ); private void GetQuestionnaireCompleted(IAsyncResult result) { try { questionnaire = this.service.EndGetQuestionnaire(ar); } catch (Exception ex) { //  -   . } }</code> <br>  ,     <code>End*</code> (  , <code>EndGetQuestionnaire</code> ),    ,      .      , ,          UI.     ,   ,        . <br> <br>        UI,     -,      UI,         UI,   <code>Dispatcher</code>    <code>SynchronizationContext</code> .  WPF  Silverlight,   <code>Dispatcher</code> . <br> <br>      <code>Questionnaire</code>  ,        <code>QuestionnaireView</code> .  Silverlight    <code>CheckAccess</code> ,  ,      UI.  ,     <code>BeginInvoke</code> ,      UI. <br> <br> <code class="cs">var dispatcher = System.Windows.Deployment.Current.Dispatcher; if (dispatcher.CheckAccess()) { QuestionnaireView.DataContext = questionnaire; } else { dispatcher.BeginInvoke(() =&gt; { Questionnaire.DataContext = questionnaire; }); }</code> <br> <i>MVVM RI</i>   ,    ,   <code>IAsyncResult</code> ,   .      ,                 . ,       . <br> <br> <code class="cs">this.questionnaireRepository.GetQuestionnaireAsync( result =&gt; { this.Questionnaire = result.Result; });</code> <br>  <code>result</code>   ,     , , , .    ,     . <br> <br> <code class="cs">this.questionnaireRepository.GetQuestionnaireAsync( result =&gt; { if (result.Error == null) { this.Questionnaire = result.Result; ... } else { // Handle error. } })</code> <br>     <br>        ,      .     , ,             .        ,      ,     ,     . <br> <br>         ,      MVVM,     ,   . ,  -MVVM ,     <code>MessageBox</code>   code-behind UI,      .   MVVM     ,          . <br> <br>     MVVM,              ,          .      ,    ,   ,  ,     . <br> <br>              MVVM.      ,     ,     ,  ,     .    ,         ,     ,          .       . <br> <br>    <br>                  .        ,        .  ,         .         . <br> <br>  ,         ,         ,  .      ,     .           ,       . ,        WPF  Silverlight,        . <br> <br> <img title="Using the service to interact with the user." src="https://habrastorage.org/getpro/habr/post_images/4b5/397/f2d/4b5397f2d02e5851195b29f1893be6fc.png" alt=" ,    ."> <br> <br>  ,   <code>MessageBox</code>        ,     ,    ,     . <br> <br> <code class="cs">var result = interactionService.ShowMessageBox( "Are you sure you want to cancel this operation?", "Confirm", MessageBoxButton.OK); if (result == MessageBoxResult.Yes) { CancelRequest(); }</code> <br> ,      - ,      ,         Silverlight.         .             .     . <br> <br> <code class="cs">interactionService.ShowMessageBox( "Are you sure you want to cancel this operation?", "Confirm", MessageBoxButton.OK, result =&gt; { if (result == MessageBoxResult.Yes) { CancelRequest(); } });</code> <br>         ,      . ,  WPF    <code>MessageBox</code> ,       ;    Silverlight    ,    . <br> <br>     <br>         ‚Äì             .         ,      .     ,     .        ,        ,   ,     . <br> <br> <img title="Using interaction request objects." src="https://habrastorage.org/getpro/habr/post_images/3d0/ff0/1c5/3d0ff01c5518558c2d3c5c5f47ce0ce9.png" alt="   ."> <br> <br>    ,   ,          ‚Äì       ,      ,   ‚Äì     .   ,        ,    ,    UI            . <br> <br>       MVVM,     ,       ,         .         ,        ,    ,   . <br> <br>  Prism       <code>IInteractionRequest</code>   <code><code>InteractionRequest .  IInteractionRequest</code>  ,   .           ,   .  <code><code>InteractionRequest   IInteractionRequest</code>     <code>Raise</code> ,           , , ,   . <br> <br>       <br>  <code><code>InteractionRequest          .  Raise</code>          ( <code>T</code> )    ,    ,   .          ,       .      ,        .    ,  ,     . <br> <code class="cs">public interface IInteractionRequest { event EventHandler&lt;InteractionRequestedEventArgs&gt; Raised; } public class InteractionRequest&lt;T&gt; : IInteractionRequest { public event EventHandler&lt;InteractionRequestedEventArgs&gt; Raised; public void Raise(T context, Action&lt;T&gt; callback) { var handler = this.Raised; if (handler != null) { handler( this, new InteractionRequestedEventArgs(context, () =&gt; callback(context))); } } }</code> <br> Prism    ,      .  <code>Notification</code>       .    ,            .     ‚Äì <code>Title</code>  <code>Content</code> ,    .  ,   ,  ,  ,        . <br> <br>  <code>Confirmation</code>    <code>Notification</code>     ‚Äì <code>Confirmed</code> ,  ,  ,      .  <code>Confirmation</code> ,     <code>MessageBox</code> ,     /  .     ,     <code>Notification</code> ,     ,      . <br> <br>    <code><code><code>InteractionRequest ,       InteractionRequest      ,      .      ,    Raise</code> ,    , ,   . <br> <br> <code class="cs">public IInteractionRequest ConfirmCancelInteractionRequest { get { return this.confirmCancelInteractionRequest; } } this.confirmCancelInteractionRequest.Raise( new Confirmation("Are you sure you wish to cancel?"), confirmation =&gt; { if (confirmation.Confirmed) { this.NavigateToQuestionnaireList(); } }); }</code> <br> <i>MVVM Reference Implementation (MVVM RI)</i> ,    <code>IInteractionRequest</code>   <code><code>InteractionRequest ,          (. QuestionnaireViewModel.cs</code> ). <br> <br>        <br>       ,       .   ,       .    UI             . <br> <br>                . Microsoft Expression Blend Behaviors Framework     .  ,     ,    . <br> <br>  <code>EventTrigger</code> ,  Expression Blend,  ,      ,     ,   . , Prism   <code>EventTrigger</code> ,  <code>InteractionRequestTrigger</code> ,      <code>Raised</code>   <code>IInteractionRequest</code> .    XAML        . <br> <br>  ,   , <code>InteractionRequestTrigger</code>   .  Silverlight Prism   <code>PopupChildWindowAction</code> ,     .    ,         .   <code>ContentTemplate</code>  <code>PopupChildWindowAction</code> ,    ,    UI,      <code>Content</code>  .       <code>Title</code>  . <br> <b></b> <br>  ,    ,   <code>PopupChildWindowAction</code> ,     .    <code>Notification</code>  <code>NotificationChildWindow</code> ,        <code>Confirmation</code> ‚Äì <code>ConfirmationChildWindow</code> . <code>NotificationChildWindow</code>    ,   ,     <code>ConfirmationChildWindow</code>    <i>OK</i>  <i>Cancel</i> ,    .    ,   ,   <code>ChildWindow</code>  <code>PopupChildWindowAction</code> . <br>   ,  <code>InteractionRequestTrigger</code>  <code>PopupChildWindowAction</code> ,       <i>RI MVVM</i> . <br> <br> <code class="xml">&lt;i:Interaction.Triggers&gt; &lt;prism:InteractionRequestTrigger SourceObject="{Binding ConfirmCancelInteractionRequest}"&gt; &lt;prism:PopupChildWindowAction ContentTemplate="{StaticResource ConfirmWindowTemplate}"/&gt; &lt;/prism:InteractionRequestTrigger&gt; &lt;/i:Interaction.Triggers&gt; &lt;UserControl.Resources&gt; &lt;DataTemplate x:Key="ConfirmWindowTemplate"&gt; &lt;Grid MinWidth="250" MinHeight="100"&gt; &lt;TextBlock TextWrapping="Wrap" Grid.Row="0" Text="{Binding}"/&gt; &lt;/Grid&gt; &lt;/DataTemplate&gt; &lt;/UserControl.Resources&gt;</code> <br> <b></b> <br>      <code>ContentTemplate</code> ,   UI   <code>Content</code>  .    <code>Content</code>  ,  , <code>TextBlock</code>     <code>Content</code> . <br>      ,     ,    ,    .  ,     ,       ,     ,    .   ,   <i>RI MVVM</i> ,         <code>Confirmed</code>    <code>Confirmation</code>  <code>true</code> ,     OK. <br> <br>        ,     .  Prism <code>InteractionRequestTrigger</code>   <code>PopupChildWindowAction</code>            . <br> <br>     <br>     MVVM,       , ,    ,         .        (  , ,  ,   ).    ,  ,  ,            . <br> <br>        ,         . Managed Extensibility Framework (MEF)  Unity Application Block (Unity)      ,  ,           . <br> <br>  ,       , , ,    ( )      . ,       ,     .  ,     ,       . <br> <br>     ,  MEF <br>  MEF,       ,   <code>Import</code> ,      ,  ,   <code>Export</code> .         ,    . <br> <br> , <code>QuestionnaireView</code>   <i>RI MVVM</i> ,        ,    <code>Import</code> .   , MEF           .  <code>set</code>        ,   . <br> <br> <code class="cs">[Import] public QuestionnaireViewModel ViewModel { set { this.DataContext = value; } }</code> <br>     ,   . <br> <br> <code class="cs">[Export] public class QuestionnaireViewModel : NotificationObject { ... }</code> <br>        ,   . <br> <br> <code class="cs">public QuestionnaireView() { InitializeComponent(); } [ImportingConstructor] public QuestionnaireView(QuestionnaireViewModel viewModel) : this() { this.DataContext = viewModel; }</code> <br> <b></b> <br>          MEF,   Unity.   ,     ,        .   ,   Visual Studio  Expression Blend, ,        ,     .   ,   ,  ,      ,          <code>InitializeComponent</code> . <br>     ,  Unity <br>  Unity,    ,   MEF.     ,      .    ,         .  ,      . <br> <br>  ,      ,  ,         . ,           ,   . <br> <br> <code class="cs">public QuestionnaireView() { InitializeComponent(); } public QuestionnaireView(QuestionnaireViewModel viewModel) : this() { this.DataContext = viewModel; }</code> <br> <b></b> <br>    ,        ,   Visual Studio  Expression Blend. <br>  ,          ,   . Unity        <code>set</code>   ,   . <br> <br> <code class="cs">public QuestionnaireView() { InitializeComponent(); } [Dependency] public QuestionnaireViewModel ViewModel { set { this.DataContext = value; } }</code> <br>       Unity. <br> <br> <code class="cs">container.RegisterType&lt;QuestionnaireViewModel&gt;();</code> <br>  ,     . <br> <br> <code class="cs">var view = container.Resolve&lt;QuestionnaireView&gt;();</code> <br>     ,    <br>   ,     ,        .        ,   MEF  Unity,        . <br> <br>          .   ,         UI,           . <br> <br> , <i>RI MVVM</i>   ,   ,        .   ,    .      <code>ShowView</code>   UI. <br> <br> <code class="cs">private void NavigateToQuestionnaireList() { //     "questionnaire list". this.uiService.ShowView(ViewNames.QuestionnaireTemplatesList); }</code> <br>  UI      UI .           UI.  <code>ShowView</code>  <code>UIService</code>      (,          ),       ,   . <br> <br> <code class="cs">public void ShowView(string viewName) { var view = this.ViewFactory.GetView(viewName); this.MainWindow.CurrentView = view; }</code> <br> <b></b> <br> Prism       .   ,   ,   ,             .    ,  , " <a href="http://msdn.microsoft.com/en-us/library/gg430861(v%3DPandP.40).aspx">View-Based Navigation</a> "   8, " <a href="http://msdn.microsoft.com/en-us/library/gg430861(v%3DPandP.40).aspx">Navigation</a> ". <br>  MVVM  <br>        MVVM      .           -      mocking . ,   ,        . <br> <br>   <i>INotifyPropertyChanged</i> <br>   <code>INotifyPropertyChanged</code>     ,      .      ,    ;   ,   ,     ,    ,       . <br> <br>   <br> ,       ,           <code>PropertyChanged</code>  ,         .  ,    <code>ChangeTracker</code> ,     MVVM,  ,      .      .     ,    . <br> <br> <code class="cs">var changeTracker = new PropertyChangeTracker(viewModel); viewModel.CurrentState = "newState"; CollectionAssert.Contains(changeTracker.ChangedProperties, "CurrentState");</code> <br> ,     ,     <code>INotifyPropertyChanged</code> ,    ,   ,     . <br> <br>      <br>        ,   ,    <code>set</code>      ,           . ,     ,     ,      ,          . <br> <br> <code class="cs">var changeTracker = new PropertyChangeTracker(viewModel); var question = viewModel.Questions.First() as OpenQuestionViewModel; question.Question.Response = "some text"; CollectionAssert.Contains(changeTracker.ChangedProperties, "UnansweredQuestions");</code> <br>      <br>     <code>INotifyPropertyChanged</code> ,      <code>PropertyChanged</code>        ,  ,     , , .        ,       . <br> <br>   <i>INotifyDataErrorInfo</i> <br>   ,     ,    ,   ,   <code>IDataErrorInfo</code> ,  ( Silverlight)   <code>INotifyDataErrorInfo</code> .   <code>INotifyDataErrorInfo</code>   ,         ,    ,  ,   ,    . <br> <br>       <code>INotifyDataErrorInfo</code> : ,     ,  ,     ,     <code>ErrorsChanged</code> ,      <code>GetErrors</code> , . <br> <br>    <br>     ,      ,     .       ,         <code>GetErrors</code>       ,  ,  ,   .    , ,  ,     ,        .   ,        . <br> <br> <code class="cs">//  . var notifyErrorInfo = (INotifyDataErrorInfo)question; question.Response = -15; Assert.IsTrue(notifyErrorInfo.GetErrors("Response").Cast&lt;ValidationResult&gt;().Any()); //  . var notifyErrorInfo = (INotifyDataErrorInfo)question; question.Response = 15; Assert.IsFalse(notifyErrorInfo.GetErrors("Response").Cast&lt;ValidationResult&gt;().Any());</code> <br>    ,    ,             . <br> <br>    <i>INotifyDataErrorInfo</i> <br>       <code>GetErrors</code> ,   <code>INotifyDataErrorInfo</code>  ,   <code>ErrorsChanged</code>      <code>GetErrors</code> . ,  <code>HasErrors</code>      ,  . <br> <br>       <code>INotifyDataErrorInfo</code> . , ,           ,   -  .      ,        <code>INotifyDataErrorInfo</code>         (,        ). <br> <br>     ,   ,  : <br>  <code>HasErrors</code>     .              ,       .  <code>ErrorsChanged</code> ,      ,         <code>GetErrors</code> .         ( ,  )     ,           .    <code>GetErrors</code>       <code>ErrorsChanged</code> . <br>    <code>INotifyPropertyChanged</code> ,  ,    <code>NotifyDataErrorInfoTestHelper</code>    MVVM,        <code>INotifyDataErrorInfo</code> ,       .   ,   ,      ,   .      . <br> <code class="cs">var helper = new NotifyDataErrorInfoTestHelper&lt;NumericQuestion, int?&gt;( question, q =&gt; q.Response); helper.ValidatePropertyChange( 6, NotifyDataErrorInfoBehavior.Nothing); helper.ValidatePropertyChange( 20, NotifyDataErrorInfoBehavior.FiresErrorsChanged | NotifyDataErrorInfoBehavior.HasErrors | NotifyDataErrorInfoBehavior.HasErrorsForProperty); helper.ValidatePropertyChange( null, NotifyDataErrorInfoBehavior.FiresErrorsChanged | NotifyDataErrorInfoBehavior.HasErrors | NotifyDataErrorInfoBehavior.HasErrorsForProperty); helper.ValidatePropertyChange( 2, NotifyDataErrorInfoBehavior.FiresErrorsChanged);</code> <br>     <br>   MVVM,     ,  .   ,    ,         . <br> <br>  ,     ,     ,       .   ,   , ,       ,     ,   <code>IAsyncResult</code>    ,  - ,   ,    UI. <br> <br>       , , ,    .   ,     .  ,      UI,     ,   ,          ,     ,        "   UI." <br> <br>     ,    ,    .   ,    ,     mock-, ,   ,   ,      ,          . <br> <br>           UI,    ,    .   ,     ,   ,      .        ,   .     ,    ,     . <br> <br> <code class="cs">questionnaireRepositoryMock .Setup( r =&gt; r.SubmitQuestionnaireAsync( It.IsAny&lt;Questionnaire&gt;(), It.IsAny&lt;Action&lt;IOperationResult&gt;&gt;())) .Callback&lt;Questionnaire, Action&lt;IOperationResult&gt;&gt;( (q, a) =&gt; callback = a); uiServicemock .Setup(svc =&gt; svc.ShowView(ViewNames.QuestionnaireTemplatesList)) .Callback&lt;string&gt;(viewName =&gt; requestedViewName = viewName); submitResultMock .Setup(sr =&gt; sr.Error) .Returns&lt;Exception&gt;(null); CompleteQuestionnaire(viewModel); viewModel.Submit(); //      UI . callback(submitResultMock.Object); //    ‚Äì     . Assert.AreEqual(ViewNames.QuestionnaireTemplatesList, requestedViewName);</code> <br> <b></b> <br>          ,        . <br>   <br>       , . "Trees in WPF"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ms753391.aspx">http://msdn.microsoft.com/en-us/library/ms753391.aspx</a> <br> <br>       , . "Attached Properties Overview"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/cc265152(VS.95).aspx">http://msdn.microsoft.com/en-us/library/cc265152(VS.95).aspx</a> <br> <br>      MEF, ."Managed Extensibility Framework Overview"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/dd460648.aspx">http://msdn.microsoft.com/en-us/library/dd460648.aspx</a> . <br> <br>      Unity, ."Unity Application Block"  MSDN: <a href="http://www.msdn.com/unity">http://www.msdn.com/unity</a> . <br> <br>      <code>DelegateCommand</code> , .Chapter 5, " <a href="http://msdn.microsoft.com/en-us/library/gg405484(v%3DPandP.40).aspx">Implementing the MVVM Pattern</a> ." <br> <br>        Microsoft Expression Blend, ."Working with built-in behaviors"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ff724013(v%3DExpression.40).aspx">http://msdn.microsoft.com/en-us/library/ff724013(v=Expression.40).aspx</a> . <br> <br>          Microsoft Expression Blend, ."Creating Custom Behaviors"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ff724708(v%3DExpression.40).aspx">http://msdn.microsoft.com/en-us/library/ff724708(v=Expression.40).aspx</a> . <br> <br>            Microsoft Expression Blend, ."Creating Custom Triggers and Actions"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ff724707(v%3DExpression.40).aspx">http://msdn.microsoft.com/en-us/library/ff724707(v=Expression.40).aspx</a> . <br> <br>         WPF  Silverlight, ."Threading Model"  "The Dispatcher Class"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ms741870.aspx">http://msdn.microsoft.com/en-us/library/ms741870.aspx</a> <br> <a href="http://msdn.microsoft.com/en-us/library/ms615907(v%3DVS.95).aspx">http://msdn.microsoft.com/en-us/library/ms615907(v=VS.95).aspx</a> . <br> <br>      unit-  Silverlight, ."Unit Testing with Silverlight 2": <a href="http://www.jeff.wilcox.name/2008/03/silverlight2-unit-testing/">http://www.jeff.wilcox.name/2008/03/silverlight2-unit-testing/</a> . <br> <br>         , .  " <a href="http://msdn.microsoft.com/en-us/library/gg430861(v%3DPandP.40).aspx">View-Based Navigation</a> " in Chapter 8, " <a href="http://msdn.microsoft.com/en-us/library/gg430861(v%3DPandP.40).aspx">Navigation</a> ." <br> <br>       ,   , ."Event-based Asynchronous Pattern Overview"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/wewwczdw.aspx">http://msdn.microsoft.com/en-us/library/wewwczdw.aspx</a> <br> <br>        <code>IAsyncResult</code> , ."Asynchronous Programming Overview"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ms228963.aspx">http://msdn.microsoft.com/en-us/library/ms228963.aspx</a></code></code></code></code></code></code></code></code></code> <pre> <code class="hljs cmake"><code>CommandBehaviorBase ,    ,    ICommand</code> .           <code>CanExecuteChanged</code> ,          Silverlight,    WPF. <br> <br>    ,  ,   <code><code>CommandBehaviorBase    ,    .         ,      .         ,    .      ButtonBaseClickCommandBehavior</code> . <br> <br> <code class="cs">public class ButtonBaseClickCommandBehavior : CommandBehaviorBase&lt;ButtonBase&gt; { public ButtonBaseClickCommandBehavior(ButtonBase clickableObject) : base(clickableObject) { clickableObject.Click += OnClick; } private void OnClick(object sender, System.Windows.RoutedEventArgs e) { ExecuteCommand(); } }</code> <br>   <code><code>CommandBehaviorBase ,     .     ,          ,   . ,    ,    ,      , ,    CanExecute</code>  ,     . <br> <br>          ,   .           XAML.           .       .  Prism      ,       ,  ,   .       ,    . , ,  ,      <code>Click</code> ,       <code><span class="hljs-keyword"><span class="hljs-keyword">Command</span></span></code> .    <code>Click.<span class="hljs-keyword"><span class="hljs-keyword">Command</span></span></code> ,  . <br> <br>             .             . <br> <br> <code class="cs">public static readonly DependencyProperty CommandProperty = DependencyProperty.RegisterAttached( <span class="hljs-string"><span class="hljs-string">"Command"</span></span>, typeof(ICommand), typeof(Click), new PropertyMetadata(OnSetCommandCallback)); private static readonly DependencyProperty ClickCommandBehaviorProperty = DependencyProperty.RegisterAttached( <span class="hljs-string"><span class="hljs-string">"ClickCommandBehavior"</span></span>, typeof(ButtonBaseClickCommandBehavior), typeof(Click), null);</code> <br>    <code><span class="hljs-keyword"><span class="hljs-keyword">Command</span></span></code>    <code>ButtonBaseClickCommandBehavior</code> ,     <code>OnSetCommandCallback</code> ,     . <br> <br> <code class="cs">private static void OnSetCommandCallback(DependencyObject dependencyObject, DependencyPropertyChangedEventArgs e) { ButtonBase buttonBase = dependencyObject as ButtonBase; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (buttonBase != null) { ButtonBaseClickCommandBehavior behavior = GetOrCreateBehavior(buttonBase); behavior.<span class="hljs-keyword"><span class="hljs-keyword">Command</span></span> = e.NewValue as ICommand; } } private static void OnSetCommandParameterCallback(DependencyObject dependencyObject, DependencyPropertyChangedEventArgs e) { ButtonBase buttonBase = dependencyObject as ButtonBase; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (buttonBase != null) { ButtonBaseClickCommandBehavior behavior = GetOrCreateBehavior(buttonBase); behavior.CommandParameter = e.NewValue; } } private static ButtonBaseClickCommandBehavior GetOrCreateBehavior(ButtonBase buttonBase ) { ButtonBaseClickCommandBehavior behavior = buttonBase.GetValue(ClickCommandBehaviorProperty) as ButtonBaseClickCommandBehavior; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ( behavior == null ) { behavior = new ButtonBaseClickCommandBehavior(buttonBase); buttonBase.SetValue(ClickCommandBehaviorProperty, behavior); } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> behavior; }</code> <br>        ,  <a href="http://msdn.microsoft.com/en-us/library/cc265152(VS.95).aspx">Attached Properties Overview</a>  MSDN. <br> <br>    <br>              . ,     Silverlight,    -,     ,      ,     .     ,       . <br> <br>        ,    ( )  ,  ,     .  UI       ,            UI. <br> <br>      - <br>   -     ,       <code>IAsyncResult</code> .   ,  ,   ,  <code>GetQuestionnaire</code> ,   : <code>BeginGetQuestionnaire</code>  <code>EndGetQuestionnaire</code> .    ,   <code>BeginGetQuestionnaire</code> .     ,   ,   <code>EndGetQuestionnaire</code>    . <br> <b></b> <br>  .NET Framework <span class="hljs-number"><span class="hljs-number">4.5</span></span>      <code>await</code>  <code>async</code>     <code>*Async</code> .      <a href="http://msdn.microsoft.com/en-us/library/vstudio/hh391443.aspx"><span class="hljs-string"><span class="hljs-string">"Asynchronous Programming with Async and Await (C# and Visual Basic)"</span></span></a> . <br>  ,    <code>EndGetQuestionnaire</code> ,      ,  ()      <code>BeginGetQuestionnaire</code> .     ,      ,   <code>EndGetQuestionnaire</code> ,   . <br> <br> <code class="xml">IAsyncResult asyncResult = this.service.BeginGetQuestionnaire( GetQuestionnaireCompleted, null //  ,      ); private void GetQuestionnaireCompleted(IAsyncResult result) { try { questionnaire = this.service.EndGetQuestionnaire(ar); } catch (Exception ex) { //  -   . } }</code> <br>  ,     <code>End*</code> (  , <code>EndGetQuestionnaire</code> ),    ,      .      , ,          UI.     ,   ,        . <br> <br>        UI,     -,      UI,         UI,   <code>Dispatcher</code>    <code>SynchronizationContext</code> .  WPF  Silverlight,   <code>Dispatcher</code> . <br> <br>      <code>Questionnaire</code>  ,        <code>QuestionnaireView</code> .  Silverlight    <code>CheckAccess</code> ,  ,      UI.  ,     <code>BeginInvoke</code> ,      UI. <br> <br> <code class="cs">var dispatcher = System.Windows.Deployment.Current.Dispatcher; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (dispatcher.CheckAccess()) { QuestionnaireView.DataContext = questionnaire; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { dispatcher.BeginInvoke(() =&gt; { Questionnaire.DataContext = questionnaire; }); }</code> <br> <i>MVVM RI</i>   ,    ,   <code>IAsyncResult</code> ,   .      ,                 . ,       . <br> <br> <code class="cs">this.questionnaireRepository.GetQuestionnaireAsync( result =&gt; { this.Questionnaire = result.Result; });</code> <br>  <code>result</code>   ,     , , , .    ,     . <br> <br> <code class="cs">this.questionnaireRepository.GetQuestionnaireAsync( result =&gt; { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (result.Error == null) { this.Questionnaire = result.Result; ... } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { // Handle error. } })</code> <br>     <br>        ,      .     , ,             .        ,      ,     ,     . <br> <br>         ,      MVVM,     ,   . ,  -MVVM ,     <code>MessageBox</code>   code-behind UI,      .   MVVM     ,          . <br> <br>     MVVM,              ,          .      ,    ,   ,  ,     . <br> <br>              MVVM.      ,     ,     ,  ,     .    ,         ,     ,          .       . <br> <br>    <br>                  .        ,        .  ,         .         . <br> <br>  ,         ,         ,  .      ,     .           ,       . ,        WPF  Silverlight,        . <br> <br> <img title="Using the service to interact with the user." src="https://habrastorage.org/getpro/habr/post_images/4b5/397/f2d/4b5397f2d02e5851195b29f1893be6fc.png" alt=" ,    ."> <br> <br>  ,   <code>MessageBox</code>        ,     ,    ,     . <br> <br> <code class="cs">var result = interactionService.ShowMessageBox( <span class="hljs-string"><span class="hljs-string">"Are you sure you want to cancel this operation?"</span></span>, <span class="hljs-string"><span class="hljs-string">"Confirm"</span></span>, MessageBoxButton.OK); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (result == MessageBoxResult.Yes) { CancelRequest(); }</code> <br> ,      - ,      ,         Silverlight.         .             .     . <br> <br> <code class="cs">interactionService.ShowMessageBox( <span class="hljs-string"><span class="hljs-string">"Are you sure you want to cancel this operation?"</span></span>, <span class="hljs-string"><span class="hljs-string">"Confirm"</span></span>, MessageBoxButton.OK, result =&gt; { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (result == MessageBoxResult.Yes) { CancelRequest(); } });</code> <br>         ,      . ,  WPF    <code>MessageBox</code> ,       ;    Silverlight    ,    . <br> <br>     <br>         ‚Äì             .         ,      .     ,     .        ,        ,   ,     . <br> <br> <img title="Using interaction request objects." src="https://habrastorage.org/getpro/habr/post_images/3d0/ff0/1c5/3d0ff01c5518558c2d3c5c5f47ce0ce9.png" alt="   ."> <br> <br>    ,   ,          ‚Äì       ,      ,   ‚Äì     .   ,        ,    ,    UI            . <br> <br>       MVVM,     ,       ,         .         ,        ,    ,   . <br> <br>  Prism       <code>IInteractionRequest</code>   <code><code>InteractionRequest .  IInteractionRequest</code>  ,   .           ,   .  <code><code>InteractionRequest   IInteractionRequest</code>     <code>Raise</code> ,           , , ,   . <br> <br>       <br>  <code><code>InteractionRequest          .  Raise</code>          ( <code>T</code> )    ,    ,   .          ,       .      ,        .    ,  ,     . <br> <code class="cs">public interface IInteractionRequest { event EventHandler&lt;InteractionRequestedEventArgs&gt; Raised; } public class InteractionRequest&lt;T&gt; : IInteractionRequest { public event EventHandler&lt;InteractionRequestedEventArgs&gt; Raised; public void Raise(T context, Action&lt;T&gt; callback) { var handler = this.Raised; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (handler != null) { handler( this, new InteractionRequestedEventArgs(context, () =&gt; callback(context))); } } }</code> <br> Prism    ,      .  <code>Notification</code>       .    ,            .     ‚Äì <code>Title</code>  <code>Content</code> ,    .  ,   ,  ,  ,        . <br> <br>  <code>Confirmation</code>    <code>Notification</code>     ‚Äì <code>Confirmed</code> ,  ,  ,      .  <code>Confirmation</code> ,     <code>MessageBox</code> ,     /  .     ,     <code>Notification</code> ,     ,      . <br> <br>    <code><code><code>InteractionRequest ,       InteractionRequest      ,      .      ,    Raise</code> ,    , ,   . <br> <br> <code class="cs">public IInteractionRequest ConfirmCancelInteractionRequest { get { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> this.confirmCancelInteractionRequest; } } this.confirmCancelInteractionRequest.Raise( new Confirmation(<span class="hljs-string"><span class="hljs-string">"Are you sure you wish to cancel?"</span></span>), confirmation =&gt; { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (confirmation.Confirmed) { this.NavigateToQuestionnaireList(); } }); }</code> <br> <i>MVVM Reference Implementation (MVVM RI)</i> ,    <code>IInteractionRequest</code>   <code><code>InteractionRequest ,          (. QuestionnaireViewModel.cs</code> ). <br> <br>        <br>       ,       .   ,       .    UI             . <br> <br>                . Microsoft Expression Blend Behaviors Framework     .  ,     ,    . <br> <br>  <code>EventTrigger</code> ,  Expression Blend,  ,      ,     ,   . , Prism   <code>EventTrigger</code> ,  <code>InteractionRequestTrigger</code> ,      <code>Raised</code>   <code>IInteractionRequest</code> .    XAML        . <br> <br>  ,   , <code>InteractionRequestTrigger</code>   .  Silverlight Prism   <code>PopupChildWindowAction</code> ,     .    ,         .   <code>ContentTemplate</code>  <code>PopupChildWindowAction</code> ,    ,    UI,      <code>Content</code>  .       <code>Title</code>  . <br> <b></b> <br>  ,    ,   <code>PopupChildWindowAction</code> ,     .    <code>Notification</code>  <code>NotificationChildWindow</code> ,        <code>Confirmation</code> ‚Äì <code>ConfirmationChildWindow</code> . <code>NotificationChildWindow</code>    ,   ,     <code>ConfirmationChildWindow</code>    <i>OK</i>  <i>Cancel</i> ,    .    ,   ,   <code>ChildWindow</code>  <code>PopupChildWindowAction</code> . <br>   ,  <code>InteractionRequestTrigger</code>  <code>PopupChildWindowAction</code> ,       <i>RI MVVM</i> . <br> <br> <code class="xml">&lt;i:Interaction.Triggers&gt; &lt;prism:InteractionRequestTrigger SourceObject=<span class="hljs-string"><span class="hljs-string">"{Binding ConfirmCancelInteractionRequest}"</span></span>&gt; &lt;prism:PopupChildWindowAction ContentTemplate=<span class="hljs-string"><span class="hljs-string">"{StaticResource ConfirmWindowTemplate}"</span></span>/&gt; &lt;/prism:InteractionRequestTrigger&gt; &lt;/i:Interaction.Triggers&gt; &lt;UserControl.Resources&gt; &lt;DataTemplate x:Key=<span class="hljs-string"><span class="hljs-string">"ConfirmWindowTemplate"</span></span>&gt; &lt;Grid MinWidth=<span class="hljs-string"><span class="hljs-string">"250"</span></span> MinHeight=<span class="hljs-string"><span class="hljs-string">"100"</span></span>&gt; &lt;TextBlock TextWrapping=<span class="hljs-string"><span class="hljs-string">"Wrap"</span></span> Grid.Row=<span class="hljs-string"><span class="hljs-string">"0"</span></span> Text=<span class="hljs-string"><span class="hljs-string">"{Binding}"</span></span>/&gt; &lt;/Grid&gt; &lt;/DataTemplate&gt; &lt;/UserControl.Resources&gt;</code> <br> <b></b> <br>      <code>ContentTemplate</code> ,   UI   <code>Content</code>  .    <code>Content</code>  ,  , <code>TextBlock</code>     <code>Content</code> . <br>      ,     ,    ,    .  ,     ,       ,     ,    .   ,   <i>RI MVVM</i> ,         <code>Confirmed</code>    <code>Confirmation</code>  <code><span class="hljs-keyword"><span class="hljs-keyword">true</span></span></code> ,     OK. <br> <br>        ,     .  Prism <code>InteractionRequestTrigger</code>   <code>PopupChildWindowAction</code>            . <br> <br>     <br>     MVVM,       , ,    ,         .        (  , ,  ,   ).    ,  ,  ,            . <br> <br>        ,         . Managed Extensibility Framework (MEF)  Unity Application Block (Unity)      ,  ,           . <br> <br>  ,       , , ,    ( )      . ,       ,     .  ,     ,       . <br> <br>     ,  MEF <br>  MEF,       ,   <code>Import</code> ,      ,  ,   <code><span class="hljs-keyword"><span class="hljs-keyword">Export</span></span></code> .         ,    . <br> <br> , <code>QuestionnaireView</code>   <i>RI MVVM</i> ,        ,    <code>Import</code> .   , MEF           .  <code><span class="hljs-keyword"><span class="hljs-keyword">set</span></span></code>        ,   . <br> <br> <code class="cs">[Import] public QuestionnaireViewModel ViewModel { <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> { this.DataContext = value; } }</code> <br>     ,   . <br> <br> <code class="cs">[<span class="hljs-keyword"><span class="hljs-keyword">Export</span></span>] public class QuestionnaireViewModel : NotificationObject { ... }</code> <br>        ,   . <br> <br> <code class="cs">public QuestionnaireView() { InitializeComponent(); } [ImportingConstructor] public QuestionnaireView(QuestionnaireViewModel viewModel) : this() { this.DataContext = viewModel; }</code> <br> <b></b> <br>          MEF,   Unity.   ,     ,        .   ,   Visual Studio  Expression Blend, ,        ,     .   ,   ,  ,      ,          <code>InitializeComponent</code> . <br>     ,  Unity <br>  Unity,    ,   MEF.     ,      .    ,         .  ,      . <br> <br>  ,      ,  ,         . ,           ,   . <br> <br> <code class="cs">public QuestionnaireView() { InitializeComponent(); } public QuestionnaireView(QuestionnaireViewModel viewModel) : this() { this.DataContext = viewModel; }</code> <br> <b></b> <br>    ,        ,   Visual Studio  Expression Blend. <br>  ,          ,   . Unity        <code><span class="hljs-keyword"><span class="hljs-keyword">set</span></span></code>   ,   . <br> <br> <code class="cs">public QuestionnaireView() { InitializeComponent(); } [Dependency] public QuestionnaireViewModel ViewModel { <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> { this.DataContext = value; } }</code> <br>       Unity. <br> <br> <code class="cs">container.RegisterType&lt;QuestionnaireViewModel&gt;();</code> <br>  ,     . <br> <br> <code class="cs">var view = container.Resolve&lt;QuestionnaireView&gt;();</code> <br>     ,    <br>   ,     ,        .        ,   MEF  Unity,        . <br> <br>          .   ,         UI,           . <br> <br> , <i>RI MVVM</i>   ,   ,        .   ,    .      <code>ShowView</code>   UI. <br> <br> <code class="cs">private void NavigateToQuestionnaireList() { //     <span class="hljs-string"><span class="hljs-string">"questionnaire list"</span></span>. this.uiService.ShowView(ViewNames.QuestionnaireTemplatesList); }</code> <br>  UI      UI .           UI.  <code>ShowView</code>  <code>UIService</code>      (,          ),       ,   . <br> <br> <code class="cs">public void ShowView(<span class="hljs-keyword"><span class="hljs-keyword">string</span></span> viewName) { var view = this.ViewFactory.GetView(viewName); this.MainWindow.CurrentView = view; }</code> <br> <b></b> <br> Prism       .   ,   ,   ,             .    ,  , <span class="hljs-string"><span class="hljs-string">" </span></span><a href="http://msdn.microsoft.com/en-us/library/gg430861(v%3DPandP.40).aspx"><span class="hljs-string"><span class="hljs-string">View-Based Navigation</span></span></a><span class="hljs-string"><span class="hljs-string"> "</span></span>   <span class="hljs-number"><span class="hljs-number">8</span></span>, <span class="hljs-string"><span class="hljs-string">" </span></span><a href="http://msdn.microsoft.com/en-us/library/gg430861(v%3DPandP.40).aspx"><span class="hljs-string"><span class="hljs-string">Navigation</span></span></a><span class="hljs-string"><span class="hljs-string"> "</span></span>. <br>  MVVM  <br>        MVVM      .           -      mocking . ,   ,        . <br> <br>   <i>INotifyPropertyChanged</i> <br>   <code>INotifyPropertyChanged</code>     ,      .      ,    ;   ,   ,     ,    ,       . <br> <br>   <br> ,       ,           <code>PropertyChanged</code>  ,         .  ,    <code>ChangeTracker</code> ,     MVVM,  ,      .      .     ,    . <br> <br> <code class="cs">var changeTracker = new PropertyChangeTracker(viewModel); viewModel.CurrentState = <span class="hljs-string"><span class="hljs-string">"newState"</span></span>; CollectionAssert.Contains(changeTracker.ChangedProperties, <span class="hljs-string"><span class="hljs-string">"CurrentState"</span></span>);</code> <br> ,     ,     <code>INotifyPropertyChanged</code> ,    ,   ,     . <br> <br>      <br>        ,   ,    <code><span class="hljs-keyword"><span class="hljs-keyword">set</span></span></code>      ,           . ,     ,     ,      ,          . <br> <br> <code class="cs">var changeTracker = new PropertyChangeTracker(viewModel); var question = viewModel.Questions.First() as OpenQuestionViewModel; question.Question.Response = <span class="hljs-string"><span class="hljs-string">"some text"</span></span>; CollectionAssert.Contains(changeTracker.ChangedProperties, <span class="hljs-string"><span class="hljs-string">"UnansweredQuestions"</span></span>);</code> <br>      <br>     <code>INotifyPropertyChanged</code> ,      <code>PropertyChanged</code>        ,  ,     , , .        ,       . <br> <br>   <i>INotifyDataErrorInfo</i> <br>   ,     ,    ,   ,   <code>IDataErrorInfo</code> ,  ( Silverlight)   <code>INotifyDataErrorInfo</code> .   <code>INotifyDataErrorInfo</code>   ,         ,    ,  ,   ,    . <br> <br>       <code>INotifyDataErrorInfo</code> : ,     ,  ,     ,     <code>ErrorsChanged</code> ,      <code>GetErrors</code> , . <br> <br>    <br>     ,      ,     .       ,         <code>GetErrors</code>       ,  ,  ,   .    , ,  ,     ,        .   ,        . <br> <br> <code class="cs">//  . var notifyErrorInfo = (INotifyDataErrorInfo)question; question.Response = -<span class="hljs-number"><span class="hljs-number">15</span></span>; Assert.IsTrue(notifyErrorInfo.GetErrors(<span class="hljs-string"><span class="hljs-string">"Response"</span></span>).Cast&lt;ValidationResult&gt;().Any()); //  . var notifyErrorInfo = (INotifyDataErrorInfo)question; question.Response = <span class="hljs-number"><span class="hljs-number">15</span></span>; Assert.IsFalse(notifyErrorInfo.GetErrors(<span class="hljs-string"><span class="hljs-string">"Response"</span></span>).Cast&lt;ValidationResult&gt;().Any());</code> <br>    ,    ,             . <br> <br>    <i>INotifyDataErrorInfo</i> <br>       <code>GetErrors</code> ,   <code>INotifyDataErrorInfo</code>  ,   <code>ErrorsChanged</code>      <code>GetErrors</code> . ,  <code>HasErrors</code>      ,  . <br> <br>       <code>INotifyDataErrorInfo</code> . , ,           ,   -  .      ,        <code>INotifyDataErrorInfo</code>         (,        ). <br> <br>     ,   ,  : <br>  <code>HasErrors</code>     .              ,       .  <code>ErrorsChanged</code> ,      ,         <code>GetErrors</code> .         ( ,  )     ,           .    <code>GetErrors</code>       <code>ErrorsChanged</code> . <br>    <code>INotifyPropertyChanged</code> ,  ,    <code>NotifyDataErrorInfoTestHelper</code>    MVVM,        <code>INotifyDataErrorInfo</code> ,       .   ,   ,      ,   .      . <br> <code class="cs">var helper = new NotifyDataErrorInfoTestHelper&lt;NumericQuestion, int?&gt;( question, q =&gt; q.Response); helper.ValidatePropertyChange( <span class="hljs-number"><span class="hljs-number">6</span></span>, NotifyDataErrorInfoBehavior.Nothing); helper.ValidatePropertyChange( <span class="hljs-number"><span class="hljs-number">20</span></span>, NotifyDataErrorInfoBehavior.FiresErrorsChanged | NotifyDataErrorInfoBehavior.HasErrors | NotifyDataErrorInfoBehavior.HasErrorsForProperty); helper.ValidatePropertyChange( null, NotifyDataErrorInfoBehavior.FiresErrorsChanged | NotifyDataErrorInfoBehavior.HasErrors | NotifyDataErrorInfoBehavior.HasErrorsForProperty); helper.ValidatePropertyChange( <span class="hljs-number"><span class="hljs-number">2</span></span>, NotifyDataErrorInfoBehavior.FiresErrorsChanged);</code> <br>     <br>   MVVM,     ,  .   ,    ,         . <br> <br>  ,     ,     ,       .   ,   , ,       ,     ,   <code>IAsyncResult</code>    ,  - ,   ,    UI. <br> <br>       , , ,    .   ,     .  ,      UI,     ,   ,          ,     ,        <span class="hljs-string"><span class="hljs-string">"   UI."</span></span> <br> <br>     ,    ,    .   ,    ,     mock-, ,   ,   ,      ,          . <br> <br>           UI,    ,    .   ,     ,   ,      .        ,   .     ,    ,     . <br> <br> <code class="cs">questionnaireRepositoryMock .Setup( r =&gt; r.SubmitQuestionnaireAsync( It.IsAny&lt;Questionnaire&gt;(), It.IsAny&lt;Action&lt;IOperationResult&gt;&gt;())) .Callback&lt;Questionnaire, Action&lt;IOperationResult&gt;&gt;( (q, a) =&gt; callback = a); uiServicemock .Setup(svc =&gt; svc.ShowView(ViewNames.QuestionnaireTemplatesList)) .Callback&lt;<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>&gt;(viewName =&gt; requestedViewName = viewName); submitResultMock .Setup(sr =&gt; sr.Error) .Returns&lt;Exception&gt;(null); CompleteQuestionnaire(viewModel); viewModel.Submit(); //      UI . callback(submitResultMock.Object); //    ‚Äì     . Assert.AreEqual(ViewNames.QuestionnaireTemplatesList, requestedViewName);</code> <br> <b></b> <br>          ,        . <br>   <br>       , . <span class="hljs-string"><span class="hljs-string">"Trees in WPF"</span></span>  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ms753391.aspx">http://msdn.microsoft.com/en-us/library/ms753391.aspx</a> <br> <br>       , . <span class="hljs-string"><span class="hljs-string">"Attached Properties Overview"</span></span>  MSDN: <a href="http://msdn.microsoft.com/en-us/library/cc265152(VS.95).aspx">http://msdn.microsoft.com/en-us/library/cc265152(VS.<span class="hljs-number"><span class="hljs-number">95</span></span>).aspx</a> <br> <br>      MEF, .<span class="hljs-string"><span class="hljs-string">"Managed Extensibility Framework Overview"</span></span>  MSDN: <a href="http://msdn.microsoft.com/en-us/library/dd460648.aspx">http://msdn.microsoft.com/en-us/library/dd460648.aspx</a> . <br> <br>      Unity, .<span class="hljs-string"><span class="hljs-string">"Unity Application Block"</span></span>  MSDN: <a href="http://www.msdn.com/unity">http://www.msdn.com/unity</a> . <br> <br>      <code>DelegateCommand</code> , .Chapter <span class="hljs-number"><span class="hljs-number">5</span></span>, <span class="hljs-string"><span class="hljs-string">" </span></span><a href="http://msdn.microsoft.com/en-us/library/gg405484(v%3DPandP.40).aspx"><span class="hljs-string"><span class="hljs-string">Implementing the MVVM Pattern</span></span></a><span class="hljs-string"><span class="hljs-string"> ."</span></span> <br> <br>        Microsoft Expression Blend, .<span class="hljs-string"><span class="hljs-string">"Working with built-in behaviors"</span></span>  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ff724013(v%3DExpression.40).aspx">http://msdn.microsoft.com/en-us/library/ff724013(v=Expression.<span class="hljs-number"><span class="hljs-number">40</span></span>).aspx</a> . <br> <br>          Microsoft Expression Blend, .<span class="hljs-string"><span class="hljs-string">"Creating Custom Behaviors"</span></span>  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ff724708(v%3DExpression.40).aspx">http://msdn.microsoft.com/en-us/library/ff724708(v=Expression.<span class="hljs-number"><span class="hljs-number">40</span></span>).aspx</a> . <br> <br>            Microsoft Expression Blend, .<span class="hljs-string"><span class="hljs-string">"Creating Custom Triggers and Actions"</span></span>  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ff724707(v%3DExpression.40).aspx">http://msdn.microsoft.com/en-us/library/ff724707(v=Expression.<span class="hljs-number"><span class="hljs-number">40</span></span>).aspx</a> . <br> <br>         WPF  Silverlight, .<span class="hljs-string"><span class="hljs-string">"Threading Model"</span></span>  <span class="hljs-string"><span class="hljs-string">"The Dispatcher Class"</span></span>  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ms741870.aspx">http://msdn.microsoft.com/en-us/library/ms741870.aspx</a> <br> <a href="http://msdn.microsoft.com/en-us/library/ms615907(v%3DVS.95).aspx">http://msdn.microsoft.com/en-us/library/ms615907(v=VS.<span class="hljs-number"><span class="hljs-number">95</span></span>).aspx</a> . <br> <br>      unit-  Silverlight, .<span class="hljs-string"><span class="hljs-string">"Unit Testing with Silverlight 2"</span></span>: <a href="http://www.jeff.wilcox.name/2008/03/silverlight2-unit-testing/">http://www.jeff.wilcox.name/<span class="hljs-number"><span class="hljs-number">2008</span></span>/<span class="hljs-number"><span class="hljs-number">03</span></span>/silverlight2-unit-testing/</a> . <br> <br>         , .  <span class="hljs-string"><span class="hljs-string">" </span></span><a href="http://msdn.microsoft.com/en-us/library/gg430861(v%3DPandP.40).aspx"><span class="hljs-string"><span class="hljs-string">View-Based Navigation</span></span></a><span class="hljs-string"><span class="hljs-string"> "</span></span> in Chapter <span class="hljs-number"><span class="hljs-number">8</span></span>, <span class="hljs-string"><span class="hljs-string">" </span></span><a href="http://msdn.microsoft.com/en-us/library/gg430861(v%3DPandP.40).aspx"><span class="hljs-string"><span class="hljs-string">Navigation</span></span></a><span class="hljs-string"><span class="hljs-string"> ."</span></span> <br> <br>       ,   , .<span class="hljs-string"><span class="hljs-string">"Event-based Asynchronous Pattern Overview"</span></span>  MSDN: <a href="http://msdn.microsoft.com/en-us/library/wewwczdw.aspx">http://msdn.microsoft.com/en-us/library/wewwczdw.aspx</a> <br> <br>        <code>IAsyncResult</code> , .<span class="hljs-string"><span class="hljs-string">"Asynchronous Programming Overview"</span></span>  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ms228963.aspx">http://msdn.microsoft.com/en-us/library/ms228963.aspx</a></code></code></code></code></code></code></code></code></code> </pre> <code><code><code>CommandBehaviorBase ,    ,    ICommand</code> .           <code>CanExecuteChanged</code> ,          Silverlight,    WPF. <br> <br>    ,  ,   <code>CommandBehaviorBase    ,    .         ,      .         ,    .      ButtonBaseClickCommandBehavior</code> . <br> <br> <code class="cs">public class ButtonBaseClickCommandBehavior : CommandBehaviorBase&lt;ButtonBase&gt; { public ButtonBaseClickCommandBehavior(ButtonBase clickableObject) : base(clickableObject) { clickableObject.Click += OnClick; } private void OnClick(object sender, System.Windows.RoutedEventArgs e) { ExecuteCommand(); } }</code> <br>   <code><code>CommandBehaviorBase ,     .     ,          ,   . ,    ,    ,      , ,    CanExecute</code>  ,     . <br> <br>          ,   .           XAML.           .       .  Prism      ,       ,  ,   .       ,    . , ,  ,      <code>Click</code> ,       <code>Command</code> .    <code>Click.Command</code> ,  . <br> <br>             .             . <br> <br> <code class="cs">public static readonly DependencyProperty CommandProperty = DependencyProperty.RegisterAttached( "Command", typeof(ICommand), typeof(Click), new PropertyMetadata(OnSetCommandCallback)); private static readonly DependencyProperty ClickCommandBehaviorProperty = DependencyProperty.RegisterAttached( "ClickCommandBehavior", typeof(ButtonBaseClickCommandBehavior), typeof(Click), null);</code> <br>    <code>Command</code>    <code>ButtonBaseClickCommandBehavior</code> ,     <code>OnSetCommandCallback</code> ,     . <br> <br> <code class="cs">private static void OnSetCommandCallback(DependencyObject dependencyObject, DependencyPropertyChangedEventArgs e) { ButtonBase buttonBase = dependencyObject as ButtonBase; if (buttonBase != null) { ButtonBaseClickCommandBehavior behavior = GetOrCreateBehavior(buttonBase); behavior.Command = e.NewValue as ICommand; } } private static void OnSetCommandParameterCallback(DependencyObject dependencyObject, DependencyPropertyChangedEventArgs e) { ButtonBase buttonBase = dependencyObject as ButtonBase; if (buttonBase != null) { ButtonBaseClickCommandBehavior behavior = GetOrCreateBehavior(buttonBase); behavior.CommandParameter = e.NewValue; } } private static ButtonBaseClickCommandBehavior GetOrCreateBehavior(ButtonBase buttonBase ) { ButtonBaseClickCommandBehavior behavior = buttonBase.GetValue(ClickCommandBehaviorProperty) as ButtonBaseClickCommandBehavior; if ( behavior == null ) { behavior = new ButtonBaseClickCommandBehavior(buttonBase); buttonBase.SetValue(ClickCommandBehaviorProperty, behavior); } return behavior; }</code> <br>        ,  <a href="http://msdn.microsoft.com/en-us/library/cc265152(VS.95).aspx">Attached Properties Overview</a>  MSDN. <br> <br>    <br>              . ,     Silverlight,    -,     ,      ,     .     ,       . <br> <br>        ,    ( )  ,  ,     .  UI       ,            UI. <br> <br>      - <br>   -     ,       <code>IAsyncResult</code> .   ,  ,   ,  <code>GetQuestionnaire</code> ,   : <code>BeginGetQuestionnaire</code>  <code>EndGetQuestionnaire</code> .    ,   <code>BeginGetQuestionnaire</code> .     ,   ,   <code>EndGetQuestionnaire</code>    . <br> <b></b> <br>  .NET Framework 4.5      <code>await</code>  <code>async</code>     <code>*Async</code> .      <a href="http://msdn.microsoft.com/en-us/library/vstudio/hh391443.aspx">"Asynchronous Programming with Async and Await (C# and Visual Basic)"</a> . <br>  ,    <code>EndGetQuestionnaire</code> ,      ,  ()      <code>BeginGetQuestionnaire</code> .     ,      ,   <code>EndGetQuestionnaire</code> ,   . <br> <br> <code class="xml">IAsyncResult asyncResult = this.service.BeginGetQuestionnaire( GetQuestionnaireCompleted, null //  ,      ); private void GetQuestionnaireCompleted(IAsyncResult result) { try { questionnaire = this.service.EndGetQuestionnaire(ar); } catch (Exception ex) { //  -   . } }</code> <br>  ,     <code>End*</code> (  , <code>EndGetQuestionnaire</code> ),    ,      .      , ,          UI.     ,   ,        . <br> <br>        UI,     -,      UI,         UI,   <code>Dispatcher</code>    <code>SynchronizationContext</code> .  WPF  Silverlight,   <code>Dispatcher</code> . <br> <br>      <code>Questionnaire</code>  ,        <code>QuestionnaireView</code> .  Silverlight    <code>CheckAccess</code> ,  ,      UI.  ,     <code>BeginInvoke</code> ,      UI. <br> <br> <code class="cs">var dispatcher = System.Windows.Deployment.Current.Dispatcher; if (dispatcher.CheckAccess()) { QuestionnaireView.DataContext = questionnaire; } else { dispatcher.BeginInvoke(() =&gt; { Questionnaire.DataContext = questionnaire; }); }</code> <br> <i>MVVM RI</i>   ,    ,   <code>IAsyncResult</code> ,   .      ,                 . ,       . <br> <br> <code class="cs">this.questionnaireRepository.GetQuestionnaireAsync( result =&gt; { this.Questionnaire = result.Result; });</code> <br>  <code>result</code>   ,     , , , .    ,     . <br> <br> <code class="cs">this.questionnaireRepository.GetQuestionnaireAsync( result =&gt; { if (result.Error == null) { this.Questionnaire = result.Result; ... } else { // Handle error. } })</code> <br>     <br>        ,      .     , ,             .        ,      ,     ,     . <br> <br>         ,      MVVM,     ,   . ,  -MVVM ,     <code>MessageBox</code>   code-behind UI,      .   MVVM     ,          . <br> <br>     MVVM,              ,          .      ,    ,   ,  ,     . <br> <br>              MVVM.      ,     ,     ,  ,     .    ,         ,     ,          .       . <br> <br>    <br>                  .        ,        .  ,         .         . <br> <br>  ,         ,         ,  .      ,     .           ,       . ,        WPF  Silverlight,        . <br> <br> <img title="Using the service to interact with the user." src="https://habrastorage.org/getpro/habr/post_images/4b5/397/f2d/4b5397f2d02e5851195b29f1893be6fc.png" alt=" ,    ."> <br> <br>  ,   <code>MessageBox</code>        ,     ,    ,     . <br> <br> <code class="cs">var result = interactionService.ShowMessageBox( "Are you sure you want to cancel this operation?", "Confirm", MessageBoxButton.OK); if (result == MessageBoxResult.Yes) { CancelRequest(); }</code> <br> ,      - ,      ,         Silverlight.         .             .     . <br> <br> <code class="cs">interactionService.ShowMessageBox( "Are you sure you want to cancel this operation?", "Confirm", MessageBoxButton.OK, result =&gt; { if (result == MessageBoxResult.Yes) { CancelRequest(); } });</code> <br>         ,      . ,  WPF    <code>MessageBox</code> ,       ;    Silverlight    ,    . <br> <br>     <br>         ‚Äì             .         ,      .     ,     .        ,        ,   ,     . <br> <br> <img title="Using interaction request objects." src="https://habrastorage.org/getpro/habr/post_images/3d0/ff0/1c5/3d0ff01c5518558c2d3c5c5f47ce0ce9.png" alt="   ."> <br> <br>    ,   ,          ‚Äì       ,      ,   ‚Äì     .   ,        ,    ,    UI            . <br> <br>       MVVM,     ,       ,         .         ,        ,    ,   . <br> <br>  Prism       <code>IInteractionRequest</code>   <code><code>InteractionRequest .  IInteractionRequest</code>  ,   .           ,   .  <code><code>InteractionRequest   IInteractionRequest</code>     <code>Raise</code> ,           , , ,   . <br> <br>       <br>  <code><code>InteractionRequest          .  Raise</code>          ( <code>T</code> )    ,    ,   .          ,       .      ,        .    ,  ,     . <br> <code class="cs">public interface IInteractionRequest { event EventHandler&lt;InteractionRequestedEventArgs&gt; Raised; } public class InteractionRequest&lt;T&gt; : IInteractionRequest { public event EventHandler&lt;InteractionRequestedEventArgs&gt; Raised; public void Raise(T context, Action&lt;T&gt; callback) { var handler = this.Raised; if (handler != null) { handler( this, new InteractionRequestedEventArgs(context, () =&gt; callback(context))); } } }</code> <br> Prism    ,      .  <code>Notification</code>       .    ,            .     ‚Äì <code>Title</code>  <code>Content</code> ,    .  ,   ,  ,  ,        . <br> <br>  <code>Confirmation</code>    <code>Notification</code>     ‚Äì <code>Confirmed</code> ,  ,  ,      .  <code>Confirmation</code> ,     <code>MessageBox</code> ,     /  .     ,     <code>Notification</code> ,     ,      . <br> <br>    <code><code><code>InteractionRequest ,       InteractionRequest      ,      .      ,    Raise</code> ,    , ,   . <br> <br> <code class="cs">public IInteractionRequest ConfirmCancelInteractionRequest { get { return this.confirmCancelInteractionRequest; } } this.confirmCancelInteractionRequest.Raise( new Confirmation("Are you sure you wish to cancel?"), confirmation =&gt; { if (confirmation.Confirmed) { this.NavigateToQuestionnaireList(); } }); }</code> <br> <i>MVVM Reference Implementation (MVVM RI)</i> ,    <code>IInteractionRequest</code>   <code><code>InteractionRequest ,          (. QuestionnaireViewModel.cs</code> ). <br> <br>        <br>       ,       .   ,       .    UI             . <br> <br>                . Microsoft Expression Blend Behaviors Framework     .  ,     ,    . <br> <br>  <code>EventTrigger</code> ,  Expression Blend,  ,      ,     ,   . , Prism   <code>EventTrigger</code> ,  <code>InteractionRequestTrigger</code> ,      <code>Raised</code>   <code>IInteractionRequest</code> .    XAML        . <br> <br>  ,   , <code>InteractionRequestTrigger</code>   .  Silverlight Prism   <code>PopupChildWindowAction</code> ,     .    ,         .   <code>ContentTemplate</code>  <code>PopupChildWindowAction</code> ,    ,    UI,      <code>Content</code>  .       <code>Title</code>  . <br> <b></b> <br>  ,    ,   <code>PopupChildWindowAction</code> ,     .    <code>Notification</code>  <code>NotificationChildWindow</code> ,        <code>Confirmation</code> ‚Äì <code>ConfirmationChildWindow</code> . <code>NotificationChildWindow</code>    ,   ,     <code>ConfirmationChildWindow</code>    <i>OK</i>  <i>Cancel</i> ,    .    ,   ,   <code>ChildWindow</code>  <code>PopupChildWindowAction</code> . <br>   ,  <code>InteractionRequestTrigger</code>  <code>PopupChildWindowAction</code> ,       <i>RI MVVM</i> . <br> <br> <code class="xml">&lt;i:Interaction.Triggers&gt; &lt;prism:InteractionRequestTrigger SourceObject="{Binding ConfirmCancelInteractionRequest}"&gt; &lt;prism:PopupChildWindowAction ContentTemplate="{StaticResource ConfirmWindowTemplate}"/&gt; &lt;/prism:InteractionRequestTrigger&gt; &lt;/i:Interaction.Triggers&gt; &lt;UserControl.Resources&gt; &lt;DataTemplate x:Key="ConfirmWindowTemplate"&gt; &lt;Grid MinWidth="250" MinHeight="100"&gt; &lt;TextBlock TextWrapping="Wrap" Grid.Row="0" Text="{Binding}"/&gt; &lt;/Grid&gt; &lt;/DataTemplate&gt; &lt;/UserControl.Resources&gt;</code> <br> <b></b> <br>      <code>ContentTemplate</code> ,   UI   <code>Content</code>  .    <code>Content</code>  ,  , <code>TextBlock</code>     <code>Content</code> . <br>      ,     ,    ,    .  ,     ,       ,     ,    .   ,   <i>RI MVVM</i> ,         <code>Confirmed</code>    <code>Confirmation</code>  <code>true</code> ,     OK. <br> <br>        ,     .  Prism <code>InteractionRequestTrigger</code>   <code>PopupChildWindowAction</code>            . <br> <br>     <br>     MVVM,       , ,    ,         .        (  , ,  ,   ).    ,  ,  ,            . <br> <br>        ,         . Managed Extensibility Framework (MEF)  Unity Application Block (Unity)      ,  ,           . <br> <br>  ,       , , ,    ( )      . ,       ,     .  ,     ,       . <br> <br>     ,  MEF <br>  MEF,       ,   <code>Import</code> ,      ,  ,   <code>Export</code> .         ,    . <br> <br> , <code>QuestionnaireView</code>   <i>RI MVVM</i> ,        ,    <code>Import</code> .   , MEF           .  <code>set</code>        ,   . <br> <br> <code class="cs">[Import] public QuestionnaireViewModel ViewModel { set { this.DataContext = value; } }</code> <br>     ,   . <br> <br> <code class="cs">[Export] public class QuestionnaireViewModel : NotificationObject { ... }</code> <br>        ,   . <br> <br> <code class="cs">public QuestionnaireView() { InitializeComponent(); } [ImportingConstructor] public QuestionnaireView(QuestionnaireViewModel viewModel) : this() { this.DataContext = viewModel; }</code> <br> <b></b> <br>          MEF,   Unity.   ,     ,        .   ,   Visual Studio  Expression Blend, ,        ,     .   ,   ,  ,      ,          <code>InitializeComponent</code> . <br>     ,  Unity <br>  Unity,    ,   MEF.     ,      .    ,         .  ,      . <br> <br>  ,      ,  ,         . ,           ,   . <br> <br> <code class="cs">public QuestionnaireView() { InitializeComponent(); } public QuestionnaireView(QuestionnaireViewModel viewModel) : this() { this.DataContext = viewModel; }</code> <br> <b></b> <br>    ,        ,   Visual Studio  Expression Blend. <br>  ,          ,   . Unity        <code>set</code>   ,   . <br> <br> <code class="cs">public QuestionnaireView() { InitializeComponent(); } [Dependency] public QuestionnaireViewModel ViewModel { set { this.DataContext = value; } }</code> <br>       Unity. <br> <br> <code class="cs">container.RegisterType&lt;QuestionnaireViewModel&gt;();</code> <br>  ,     . <br> <br> <code class="cs">var view = container.Resolve&lt;QuestionnaireView&gt;();</code> <br>     ,    <br>   ,     ,        .        ,   MEF  Unity,        . <br> <br>          .   ,         UI,           . <br> <br> , <i>RI MVVM</i>   ,   ,        .   ,    .      <code>ShowView</code>   UI. <br> <br> <code class="cs">private void NavigateToQuestionnaireList() { //     "questionnaire list". this.uiService.ShowView(ViewNames.QuestionnaireTemplatesList); }</code> <br>  UI      UI .           UI.  <code>ShowView</code>  <code>UIService</code>      (,          ),       ,   . <br> <br> <code class="cs">public void ShowView(string viewName) { var view = this.ViewFactory.GetView(viewName); this.MainWindow.CurrentView = view; }</code> <br> <b></b> <br> Prism       .   ,   ,   ,             .    ,  , " <a href="http://msdn.microsoft.com/en-us/library/gg430861(v%3DPandP.40).aspx">View-Based Navigation</a> "   8, " <a href="http://msdn.microsoft.com/en-us/library/gg430861(v%3DPandP.40).aspx">Navigation</a> ". <br>  MVVM  <br>        MVVM      .           -      mocking . ,   ,        . <br> <br>   <i>INotifyPropertyChanged</i> <br>   <code>INotifyPropertyChanged</code>     ,      .      ,    ;   ,   ,     ,    ,       . <br> <br>   <br> ,       ,           <code>PropertyChanged</code>  ,         .  ,    <code>ChangeTracker</code> ,     MVVM,  ,      .      .     ,    . <br> <br> <code class="cs">var changeTracker = new PropertyChangeTracker(viewModel); viewModel.CurrentState = "newState"; CollectionAssert.Contains(changeTracker.ChangedProperties, "CurrentState");</code> <br> ,     ,     <code>INotifyPropertyChanged</code> ,    ,   ,     . <br> <br>      <br>        ,   ,    <code>set</code>      ,           . ,     ,     ,      ,          . <br> <br> <code class="cs">var changeTracker = new PropertyChangeTracker(viewModel); var question = viewModel.Questions.First() as OpenQuestionViewModel; question.Question.Response = "some text"; CollectionAssert.Contains(changeTracker.ChangedProperties, "UnansweredQuestions");</code> <br>      <br>     <code>INotifyPropertyChanged</code> ,      <code>PropertyChanged</code>        ,  ,     , , .        ,       . <br> <br>   <i>INotifyDataErrorInfo</i> <br>   ,     ,    ,   ,   <code>IDataErrorInfo</code> ,  ( Silverlight)   <code>INotifyDataErrorInfo</code> .   <code>INotifyDataErrorInfo</code>   ,         ,    ,  ,   ,    . <br> <br>       <code>INotifyDataErrorInfo</code> : ,     ,  ,     ,     <code>ErrorsChanged</code> ,      <code>GetErrors</code> , . <br> <br>    <br>     ,      ,     .       ,         <code>GetErrors</code>       ,  ,  ,   .    , ,  ,     ,        .   ,        . <br> <br> <code class="cs">//  . var notifyErrorInfo = (INotifyDataErrorInfo)question; question.Response = -15; Assert.IsTrue(notifyErrorInfo.GetErrors("Response").Cast&lt;ValidationResult&gt;().Any()); //  . var notifyErrorInfo = (INotifyDataErrorInfo)question; question.Response = 15; Assert.IsFalse(notifyErrorInfo.GetErrors("Response").Cast&lt;ValidationResult&gt;().Any());</code> <br>    ,    ,             . <br> <br>    <i>INotifyDataErrorInfo</i> <br>       <code>GetErrors</code> ,   <code>INotifyDataErrorInfo</code>  ,   <code>ErrorsChanged</code>      <code>GetErrors</code> . ,  <code>HasErrors</code>      ,  . <br> <br>       <code>INotifyDataErrorInfo</code> . , ,           ,   -  .      ,        <code>INotifyDataErrorInfo</code>         (,        ). <br> <br>     ,   ,  : <br>  <code>HasErrors</code>     .              ,       .  <code>ErrorsChanged</code> ,      ,         <code>GetErrors</code> .         ( ,  )     ,           .    <code>GetErrors</code>       <code>ErrorsChanged</code> . <br>    <code>INotifyPropertyChanged</code> ,  ,    <code>NotifyDataErrorInfoTestHelper</code>    MVVM,        <code>INotifyDataErrorInfo</code> ,       .   ,   ,      ,   .      . <br> <code class="cs">var helper = new NotifyDataErrorInfoTestHelper&lt;NumericQuestion, int?&gt;( question, q =&gt; q.Response); helper.ValidatePropertyChange( 6, NotifyDataErrorInfoBehavior.Nothing); helper.ValidatePropertyChange( 20, NotifyDataErrorInfoBehavior.FiresErrorsChanged | NotifyDataErrorInfoBehavior.HasErrors | NotifyDataErrorInfoBehavior.HasErrorsForProperty); helper.ValidatePropertyChange( null, NotifyDataErrorInfoBehavior.FiresErrorsChanged | NotifyDataErrorInfoBehavior.HasErrors | NotifyDataErrorInfoBehavior.HasErrorsForProperty); helper.ValidatePropertyChange( 2, NotifyDataErrorInfoBehavior.FiresErrorsChanged);</code> <br>     <br>   MVVM,     ,  .   ,    ,         . <br> <br>  ,     ,     ,       .   ,   , ,       ,     ,   <code>IAsyncResult</code>    ,  - ,   ,    UI. <br> <br>       , , ,    .   ,     .  ,      UI,     ,   ,          ,     ,        "   UI." <br> <br>     ,    ,    .   ,    ,     mock-, ,   ,   ,      ,          . <br> <br>           UI,    ,    .   ,     ,   ,      .        ,   .     ,    ,     . <br> <br> <code class="cs">questionnaireRepositoryMock .Setup( r =&gt; r.SubmitQuestionnaireAsync( It.IsAny&lt;Questionnaire&gt;(), It.IsAny&lt;Action&lt;IOperationResult&gt;&gt;())) .Callback&lt;Questionnaire, Action&lt;IOperationResult&gt;&gt;( (q, a) =&gt; callback = a); uiServicemock .Setup(svc =&gt; svc.ShowView(ViewNames.QuestionnaireTemplatesList)) .Callback&lt;string&gt;(viewName =&gt; requestedViewName = viewName); submitResultMock .Setup(sr =&gt; sr.Error) .Returns&lt;Exception&gt;(null); CompleteQuestionnaire(viewModel); viewModel.Submit(); //      UI . callback(submitResultMock.Object); //    ‚Äì     . Assert.AreEqual(ViewNames.QuestionnaireTemplatesList, requestedViewName);</code> <br> <b></b> <br>          ,        . <br>   <br>       , . "Trees in WPF"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ms753391.aspx">http://msdn.microsoft.com/en-us/library/ms753391.aspx</a> <br> <br>       , . "Attached Properties Overview"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/cc265152(VS.95).aspx">http://msdn.microsoft.com/en-us/library/cc265152(VS.95).aspx</a> <br> <br>      MEF, ."Managed Extensibility Framework Overview"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/dd460648.aspx">http://msdn.microsoft.com/en-us/library/dd460648.aspx</a> . <br> <br>      Unity, ."Unity Application Block"  MSDN: <a href="http://www.msdn.com/unity">http://www.msdn.com/unity</a> . <br> <br>      <code>DelegateCommand</code> , .Chapter 5, " <a href="http://msdn.microsoft.com/en-us/library/gg405484(v%3DPandP.40).aspx">Implementing the MVVM Pattern</a> ." <br> <br>        Microsoft Expression Blend, ."Working with built-in behaviors"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ff724013(v%3DExpression.40).aspx">http://msdn.microsoft.com/en-us/library/ff724013(v=Expression.40).aspx</a> . <br> <br>          Microsoft Expression Blend, ."Creating Custom Behaviors"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ff724708(v%3DExpression.40).aspx">http://msdn.microsoft.com/en-us/library/ff724708(v=Expression.40).aspx</a> . <br> <br>            Microsoft Expression Blend, ."Creating Custom Triggers and Actions"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ff724707(v%3DExpression.40).aspx">http://msdn.microsoft.com/en-us/library/ff724707(v=Expression.40).aspx</a> . <br> <br>         WPF  Silverlight, ."Threading Model"  "The Dispatcher Class"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ms741870.aspx">http://msdn.microsoft.com/en-us/library/ms741870.aspx</a> <br> <a href="http://msdn.microsoft.com/en-us/library/ms615907(v%3DVS.95).aspx">http://msdn.microsoft.com/en-us/library/ms615907(v=VS.95).aspx</a> . <br> <br>      unit-  Silverlight, ."Unit Testing with Silverlight 2": <a href="http://www.jeff.wilcox.name/2008/03/silverlight2-unit-testing/">http://www.jeff.wilcox.name/2008/03/silverlight2-unit-testing/</a> . <br> <br>         , .  " <a href="http://msdn.microsoft.com/en-us/library/gg430861(v%3DPandP.40).aspx">View-Based Navigation</a> " in Chapter 8, " <a href="http://msdn.microsoft.com/en-us/library/gg430861(v%3DPandP.40).aspx">Navigation</a> ." <br> <br>       ,   , ."Event-based Asynchronous Pattern Overview"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/wewwczdw.aspx">http://msdn.microsoft.com/en-us/library/wewwczdw.aspx</a> <br> <br>        <code>IAsyncResult</code> , ."Asynchronous Programming Overview"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ms228963.aspx">http://msdn.microsoft.com/en-us/library/ms228963.aspx</a></code></code></code></code></code></code></code></code></code> <pre> <code class="hljs cmake"><code>CommandBehaviorBase ,    ,    ICommand</code> .           <code>CanExecuteChanged</code> ,          Silverlight,    WPF. <br> <br>    ,  ,   <code><code>CommandBehaviorBase    ,    .         ,      .         ,    .      ButtonBaseClickCommandBehavior</code> . <br> <br> <code class="cs">public class ButtonBaseClickCommandBehavior : CommandBehaviorBase&lt;ButtonBase&gt; { public ButtonBaseClickCommandBehavior(ButtonBase clickableObject) : base(clickableObject) { clickableObject.Click += OnClick; } private void OnClick(object sender, System.Windows.RoutedEventArgs e) { ExecuteCommand(); } }</code> <br>   <code><code>CommandBehaviorBase ,     .     ,          ,   . ,    ,    ,      , ,    CanExecute</code>  ,     . <br> <br>          ,   .           XAML.           .       .  Prism      ,       ,  ,   .       ,    . , ,  ,      <code>Click</code> ,       <code><span class="hljs-keyword"><span class="hljs-keyword">Command</span></span></code> .    <code>Click.<span class="hljs-keyword"><span class="hljs-keyword">Command</span></span></code> ,  . <br> <br>             .             . <br> <br> <code class="cs">public static readonly DependencyProperty CommandProperty = DependencyProperty.RegisterAttached( <span class="hljs-string"><span class="hljs-string">"Command"</span></span>, typeof(ICommand), typeof(Click), new PropertyMetadata(OnSetCommandCallback)); private static readonly DependencyProperty ClickCommandBehaviorProperty = DependencyProperty.RegisterAttached( <span class="hljs-string"><span class="hljs-string">"ClickCommandBehavior"</span></span>, typeof(ButtonBaseClickCommandBehavior), typeof(Click), null);</code> <br>    <code><span class="hljs-keyword"><span class="hljs-keyword">Command</span></span></code>    <code>ButtonBaseClickCommandBehavior</code> ,     <code>OnSetCommandCallback</code> ,     . <br> <br> <code class="cs">private static void OnSetCommandCallback(DependencyObject dependencyObject, DependencyPropertyChangedEventArgs e) { ButtonBase buttonBase = dependencyObject as ButtonBase; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (buttonBase != null) { ButtonBaseClickCommandBehavior behavior = GetOrCreateBehavior(buttonBase); behavior.<span class="hljs-keyword"><span class="hljs-keyword">Command</span></span> = e.NewValue as ICommand; } } private static void OnSetCommandParameterCallback(DependencyObject dependencyObject, DependencyPropertyChangedEventArgs e) { ButtonBase buttonBase = dependencyObject as ButtonBase; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (buttonBase != null) { ButtonBaseClickCommandBehavior behavior = GetOrCreateBehavior(buttonBase); behavior.CommandParameter = e.NewValue; } } private static ButtonBaseClickCommandBehavior GetOrCreateBehavior(ButtonBase buttonBase ) { ButtonBaseClickCommandBehavior behavior = buttonBase.GetValue(ClickCommandBehaviorProperty) as ButtonBaseClickCommandBehavior; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ( behavior == null ) { behavior = new ButtonBaseClickCommandBehavior(buttonBase); buttonBase.SetValue(ClickCommandBehaviorProperty, behavior); } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> behavior; }</code> <br>        ,  <a href="http://msdn.microsoft.com/en-us/library/cc265152(VS.95).aspx">Attached Properties Overview</a>  MSDN. <br> <br>    <br>              . ,     Silverlight,    -,     ,      ,     .     ,       . <br> <br>        ,    ( )  ,  ,     .  UI       ,            UI. <br> <br>      - <br>   -     ,       <code>IAsyncResult</code> .   ,  ,   ,  <code>GetQuestionnaire</code> ,   : <code>BeginGetQuestionnaire</code>  <code>EndGetQuestionnaire</code> .    ,   <code>BeginGetQuestionnaire</code> .     ,   ,   <code>EndGetQuestionnaire</code>    . <br> <b></b> <br>  .NET Framework <span class="hljs-number"><span class="hljs-number">4.5</span></span>      <code>await</code>  <code>async</code>     <code>*Async</code> .      <a href="http://msdn.microsoft.com/en-us/library/vstudio/hh391443.aspx"><span class="hljs-string"><span class="hljs-string">"Asynchronous Programming with Async and Await (C# and Visual Basic)"</span></span></a> . <br>  ,    <code>EndGetQuestionnaire</code> ,      ,  ()      <code>BeginGetQuestionnaire</code> .     ,      ,   <code>EndGetQuestionnaire</code> ,   . <br> <br> <code class="xml">IAsyncResult asyncResult = this.service.BeginGetQuestionnaire( GetQuestionnaireCompleted, null //  ,      ); private void GetQuestionnaireCompleted(IAsyncResult result) { try { questionnaire = this.service.EndGetQuestionnaire(ar); } catch (Exception ex) { //  -   . } }</code> <br>  ,     <code>End*</code> (  , <code>EndGetQuestionnaire</code> ),    ,      .      , ,          UI.     ,   ,        . <br> <br>        UI,     -,      UI,         UI,   <code>Dispatcher</code>    <code>SynchronizationContext</code> .  WPF  Silverlight,   <code>Dispatcher</code> . <br> <br>      <code>Questionnaire</code>  ,        <code>QuestionnaireView</code> .  Silverlight    <code>CheckAccess</code> ,  ,      UI.  ,     <code>BeginInvoke</code> ,      UI. <br> <br> <code class="cs">var dispatcher = System.Windows.Deployment.Current.Dispatcher; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (dispatcher.CheckAccess()) { QuestionnaireView.DataContext = questionnaire; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { dispatcher.BeginInvoke(() =&gt; { Questionnaire.DataContext = questionnaire; }); }</code> <br> <i>MVVM RI</i>   ,    ,   <code>IAsyncResult</code> ,   .      ,                 . ,       . <br> <br> <code class="cs">this.questionnaireRepository.GetQuestionnaireAsync( result =&gt; { this.Questionnaire = result.Result; });</code> <br>  <code>result</code>   ,     , , , .    ,     . <br> <br> <code class="cs">this.questionnaireRepository.GetQuestionnaireAsync( result =&gt; { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (result.Error == null) { this.Questionnaire = result.Result; ... } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { // Handle error. } })</code> <br>     <br>        ,      .     , ,             .        ,      ,     ,     . <br> <br>         ,      MVVM,     ,   . ,  -MVVM ,     <code>MessageBox</code>   code-behind UI,      .   MVVM     ,          . <br> <br>     MVVM,              ,          .      ,    ,   ,  ,     . <br> <br>              MVVM.      ,     ,     ,  ,     .    ,         ,     ,          .       . <br> <br>    <br>                  .        ,        .  ,         .         . <br> <br>  ,         ,         ,  .      ,     .           ,       . ,        WPF  Silverlight,        . <br> <br> <img title="Using the service to interact with the user." src="https://habrastorage.org/getpro/habr/post_images/4b5/397/f2d/4b5397f2d02e5851195b29f1893be6fc.png" alt=" ,    ."> <br> <br>  ,   <code>MessageBox</code>        ,     ,    ,     . <br> <br> <code class="cs">var result = interactionService.ShowMessageBox( <span class="hljs-string"><span class="hljs-string">"Are you sure you want to cancel this operation?"</span></span>, <span class="hljs-string"><span class="hljs-string">"Confirm"</span></span>, MessageBoxButton.OK); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (result == MessageBoxResult.Yes) { CancelRequest(); }</code> <br> ,      - ,      ,         Silverlight.         .             .     . <br> <br> <code class="cs">interactionService.ShowMessageBox( <span class="hljs-string"><span class="hljs-string">"Are you sure you want to cancel this operation?"</span></span>, <span class="hljs-string"><span class="hljs-string">"Confirm"</span></span>, MessageBoxButton.OK, result =&gt; { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (result == MessageBoxResult.Yes) { CancelRequest(); } });</code> <br>         ,      . ,  WPF    <code>MessageBox</code> ,       ;    Silverlight    ,    . <br> <br>     <br>         ‚Äì             .         ,      .     ,     .        ,        ,   ,     . <br> <br> <img title="Using interaction request objects." src="https://habrastorage.org/getpro/habr/post_images/3d0/ff0/1c5/3d0ff01c5518558c2d3c5c5f47ce0ce9.png" alt="   ."> <br> <br>    ,   ,          ‚Äì       ,      ,   ‚Äì     .   ,        ,    ,    UI            . <br> <br>       MVVM,     ,       ,         .         ,        ,    ,   . <br> <br>  Prism       <code>IInteractionRequest</code>   <code><code>InteractionRequest .  IInteractionRequest</code>  ,   .           ,   .  <code><code>InteractionRequest   IInteractionRequest</code>     <code>Raise</code> ,           , , ,   . <br> <br>       <br>  <code><code>InteractionRequest          .  Raise</code>          ( <code>T</code> )    ,    ,   .          ,       .      ,        .    ,  ,     . <br> <code class="cs">public interface IInteractionRequest { event EventHandler&lt;InteractionRequestedEventArgs&gt; Raised; } public class InteractionRequest&lt;T&gt; : IInteractionRequest { public event EventHandler&lt;InteractionRequestedEventArgs&gt; Raised; public void Raise(T context, Action&lt;T&gt; callback) { var handler = this.Raised; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (handler != null) { handler( this, new InteractionRequestedEventArgs(context, () =&gt; callback(context))); } } }</code> <br> Prism    ,      .  <code>Notification</code>       .    ,            .     ‚Äì <code>Title</code>  <code>Content</code> ,    .  ,   ,  ,  ,        . <br> <br>  <code>Confirmation</code>    <code>Notification</code>     ‚Äì <code>Confirmed</code> ,  ,  ,      .  <code>Confirmation</code> ,     <code>MessageBox</code> ,     /  .     ,     <code>Notification</code> ,     ,      . <br> <br>    <code><code><code>InteractionRequest ,       InteractionRequest      ,      .      ,    Raise</code> ,    , ,   . <br> <br> <code class="cs">public IInteractionRequest ConfirmCancelInteractionRequest { get { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> this.confirmCancelInteractionRequest; } } this.confirmCancelInteractionRequest.Raise( new Confirmation(<span class="hljs-string"><span class="hljs-string">"Are you sure you wish to cancel?"</span></span>), confirmation =&gt; { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (confirmation.Confirmed) { this.NavigateToQuestionnaireList(); } }); }</code> <br> <i>MVVM Reference Implementation (MVVM RI)</i> ,    <code>IInteractionRequest</code>   <code><code>InteractionRequest ,          (. QuestionnaireViewModel.cs</code> ). <br> <br>        <br>       ,       .   ,       .    UI             . <br> <br>                . Microsoft Expression Blend Behaviors Framework     .  ,     ,    . <br> <br>  <code>EventTrigger</code> ,  Expression Blend,  ,      ,     ,   . , Prism   <code>EventTrigger</code> ,  <code>InteractionRequestTrigger</code> ,      <code>Raised</code>   <code>IInteractionRequest</code> .    XAML        . <br> <br>  ,   , <code>InteractionRequestTrigger</code>   .  Silverlight Prism   <code>PopupChildWindowAction</code> ,     .    ,         .   <code>ContentTemplate</code>  <code>PopupChildWindowAction</code> ,    ,    UI,      <code>Content</code>  .       <code>Title</code>  . <br> <b></b> <br>  ,    ,   <code>PopupChildWindowAction</code> ,     .    <code>Notification</code>  <code>NotificationChildWindow</code> ,        <code>Confirmation</code> ‚Äì <code>ConfirmationChildWindow</code> . <code>NotificationChildWindow</code>    ,   ,     <code>ConfirmationChildWindow</code>    <i>OK</i>  <i>Cancel</i> ,    .    ,   ,   <code>ChildWindow</code>  <code>PopupChildWindowAction</code> . <br>   ,  <code>InteractionRequestTrigger</code>  <code>PopupChildWindowAction</code> ,       <i>RI MVVM</i> . <br> <br> <code class="xml">&lt;i:Interaction.Triggers&gt; &lt;prism:InteractionRequestTrigger SourceObject=<span class="hljs-string"><span class="hljs-string">"{Binding ConfirmCancelInteractionRequest}"</span></span>&gt; &lt;prism:PopupChildWindowAction ContentTemplate=<span class="hljs-string"><span class="hljs-string">"{StaticResource ConfirmWindowTemplate}"</span></span>/&gt; &lt;/prism:InteractionRequestTrigger&gt; &lt;/i:Interaction.Triggers&gt; &lt;UserControl.Resources&gt; &lt;DataTemplate x:Key=<span class="hljs-string"><span class="hljs-string">"ConfirmWindowTemplate"</span></span>&gt; &lt;Grid MinWidth=<span class="hljs-string"><span class="hljs-string">"250"</span></span> MinHeight=<span class="hljs-string"><span class="hljs-string">"100"</span></span>&gt; &lt;TextBlock TextWrapping=<span class="hljs-string"><span class="hljs-string">"Wrap"</span></span> Grid.Row=<span class="hljs-string"><span class="hljs-string">"0"</span></span> Text=<span class="hljs-string"><span class="hljs-string">"{Binding}"</span></span>/&gt; &lt;/Grid&gt; &lt;/DataTemplate&gt; &lt;/UserControl.Resources&gt;</code> <br> <b></b> <br>      <code>ContentTemplate</code> ,   UI   <code>Content</code>  .    <code>Content</code>  ,  , <code>TextBlock</code>     <code>Content</code> . <br>      ,     ,    ,    .  ,     ,       ,     ,    .   ,   <i>RI MVVM</i> ,         <code>Confirmed</code>    <code>Confirmation</code>  <code><span class="hljs-keyword"><span class="hljs-keyword">true</span></span></code> ,     OK. <br> <br>        ,     .  Prism <code>InteractionRequestTrigger</code>   <code>PopupChildWindowAction</code>            . <br> <br>     <br>     MVVM,       , ,    ,         .        (  , ,  ,   ).    ,  ,  ,            . <br> <br>        ,         . Managed Extensibility Framework (MEF)  Unity Application Block (Unity)      ,  ,           . <br> <br>  ,       , , ,    ( )      . ,       ,     .  ,     ,       . <br> <br>     ,  MEF <br>  MEF,       ,   <code>Import</code> ,      ,  ,   <code><span class="hljs-keyword"><span class="hljs-keyword">Export</span></span></code> .         ,    . <br> <br> , <code>QuestionnaireView</code>   <i>RI MVVM</i> ,        ,    <code>Import</code> .   , MEF           .  <code><span class="hljs-keyword"><span class="hljs-keyword">set</span></span></code>        ,   . <br> <br> <code class="cs">[Import] public QuestionnaireViewModel ViewModel { <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> { this.DataContext = value; } }</code> <br>     ,   . <br> <br> <code class="cs">[<span class="hljs-keyword"><span class="hljs-keyword">Export</span></span>] public class QuestionnaireViewModel : NotificationObject { ... }</code> <br>        ,   . <br> <br> <code class="cs">public QuestionnaireView() { InitializeComponent(); } [ImportingConstructor] public QuestionnaireView(QuestionnaireViewModel viewModel) : this() { this.DataContext = viewModel; }</code> <br> <b></b> <br>          MEF,   Unity.   ,     ,        .   ,   Visual Studio  Expression Blend, ,        ,     .   ,   ,  ,      ,          <code>InitializeComponent</code> . <br>     ,  Unity <br>  Unity,    ,   MEF.     ,      .    ,         .  ,      . <br> <br>  ,      ,  ,         . ,           ,   . <br> <br> <code class="cs">public QuestionnaireView() { InitializeComponent(); } public QuestionnaireView(QuestionnaireViewModel viewModel) : this() { this.DataContext = viewModel; }</code> <br> <b></b> <br>    ,        ,   Visual Studio  Expression Blend. <br>  ,          ,   . Unity        <code><span class="hljs-keyword"><span class="hljs-keyword">set</span></span></code>   ,   . <br> <br> <code class="cs">public QuestionnaireView() { InitializeComponent(); } [Dependency] public QuestionnaireViewModel ViewModel { <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> { this.DataContext = value; } }</code> <br>       Unity. <br> <br> <code class="cs">container.RegisterType&lt;QuestionnaireViewModel&gt;();</code> <br>  ,     . <br> <br> <code class="cs">var view = container.Resolve&lt;QuestionnaireView&gt;();</code> <br>     ,    <br>   ,     ,        .        ,   MEF  Unity,        . <br> <br>          .   ,         UI,           . <br> <br> , <i>RI MVVM</i>   ,   ,        .   ,    .      <code>ShowView</code>   UI. <br> <br> <code class="cs">private void NavigateToQuestionnaireList() { //     <span class="hljs-string"><span class="hljs-string">"questionnaire list"</span></span>. this.uiService.ShowView(ViewNames.QuestionnaireTemplatesList); }</code> <br>  UI      UI .           UI.  <code>ShowView</code>  <code>UIService</code>      (,          ),       ,   . <br> <br> <code class="cs">public void ShowView(<span class="hljs-keyword"><span class="hljs-keyword">string</span></span> viewName) { var view = this.ViewFactory.GetView(viewName); this.MainWindow.CurrentView = view; }</code> <br> <b></b> <br> Prism       .   ,   ,   ,             .    ,  , <span class="hljs-string"><span class="hljs-string">" </span></span><a href="http://msdn.microsoft.com/en-us/library/gg430861(v%3DPandP.40).aspx"><span class="hljs-string"><span class="hljs-string">View-Based Navigation</span></span></a><span class="hljs-string"><span class="hljs-string"> "</span></span>   <span class="hljs-number"><span class="hljs-number">8</span></span>, <span class="hljs-string"><span class="hljs-string">" </span></span><a href="http://msdn.microsoft.com/en-us/library/gg430861(v%3DPandP.40).aspx"><span class="hljs-string"><span class="hljs-string">Navigation</span></span></a><span class="hljs-string"><span class="hljs-string"> "</span></span>. <br>  MVVM  <br>        MVVM      .           -      mocking . ,   ,        . <br> <br>   <i>INotifyPropertyChanged</i> <br>   <code>INotifyPropertyChanged</code>     ,      .      ,    ;   ,   ,     ,    ,       . <br> <br>   <br> ,       ,           <code>PropertyChanged</code>  ,         .  ,    <code>ChangeTracker</code> ,     MVVM,  ,      .      .     ,    . <br> <br> <code class="cs">var changeTracker = new PropertyChangeTracker(viewModel); viewModel.CurrentState = <span class="hljs-string"><span class="hljs-string">"newState"</span></span>; CollectionAssert.Contains(changeTracker.ChangedProperties, <span class="hljs-string"><span class="hljs-string">"CurrentState"</span></span>);</code> <br> ,     ,     <code>INotifyPropertyChanged</code> ,    ,   ,     . <br> <br>      <br>        ,   ,    <code><span class="hljs-keyword"><span class="hljs-keyword">set</span></span></code>      ,           . ,     ,     ,      ,          . <br> <br> <code class="cs">var changeTracker = new PropertyChangeTracker(viewModel); var question = viewModel.Questions.First() as OpenQuestionViewModel; question.Question.Response = <span class="hljs-string"><span class="hljs-string">"some text"</span></span>; CollectionAssert.Contains(changeTracker.ChangedProperties, <span class="hljs-string"><span class="hljs-string">"UnansweredQuestions"</span></span>);</code> <br>      <br>     <code>INotifyPropertyChanged</code> ,      <code>PropertyChanged</code>        ,  ,     , , .        ,       . <br> <br>   <i>INotifyDataErrorInfo</i> <br>   ,     ,    ,   ,   <code>IDataErrorInfo</code> ,  ( Silverlight)   <code>INotifyDataErrorInfo</code> .   <code>INotifyDataErrorInfo</code>   ,         ,    ,  ,   ,    . <br> <br>       <code>INotifyDataErrorInfo</code> : ,     ,  ,     ,     <code>ErrorsChanged</code> ,      <code>GetErrors</code> , . <br> <br>    <br>     ,      ,     .       ,         <code>GetErrors</code>       ,  ,  ,   .    , ,  ,     ,        .   ,        . <br> <br> <code class="cs">//  . var notifyErrorInfo = (INotifyDataErrorInfo)question; question.Response = -<span class="hljs-number"><span class="hljs-number">15</span></span>; Assert.IsTrue(notifyErrorInfo.GetErrors(<span class="hljs-string"><span class="hljs-string">"Response"</span></span>).Cast&lt;ValidationResult&gt;().Any()); //  . var notifyErrorInfo = (INotifyDataErrorInfo)question; question.Response = <span class="hljs-number"><span class="hljs-number">15</span></span>; Assert.IsFalse(notifyErrorInfo.GetErrors(<span class="hljs-string"><span class="hljs-string">"Response"</span></span>).Cast&lt;ValidationResult&gt;().Any());</code> <br>    ,    ,             . <br> <br>    <i>INotifyDataErrorInfo</i> <br>       <code>GetErrors</code> ,   <code>INotifyDataErrorInfo</code>  ,   <code>ErrorsChanged</code>      <code>GetErrors</code> . ,  <code>HasErrors</code>      ,  . <br> <br>       <code>INotifyDataErrorInfo</code> . , ,           ,   -  .      ,        <code>INotifyDataErrorInfo</code>         (,        ). <br> <br>     ,   ,  : <br>  <code>HasErrors</code>     .              ,       .  <code>ErrorsChanged</code> ,      ,         <code>GetErrors</code> .         ( ,  )     ,           .    <code>GetErrors</code>       <code>ErrorsChanged</code> . <br>    <code>INotifyPropertyChanged</code> ,  ,    <code>NotifyDataErrorInfoTestHelper</code>    MVVM,        <code>INotifyDataErrorInfo</code> ,       .   ,   ,      ,   .      . <br> <code class="cs">var helper = new NotifyDataErrorInfoTestHelper&lt;NumericQuestion, int?&gt;( question, q =&gt; q.Response); helper.ValidatePropertyChange( <span class="hljs-number"><span class="hljs-number">6</span></span>, NotifyDataErrorInfoBehavior.Nothing); helper.ValidatePropertyChange( <span class="hljs-number"><span class="hljs-number">20</span></span>, NotifyDataErrorInfoBehavior.FiresErrorsChanged | NotifyDataErrorInfoBehavior.HasErrors | NotifyDataErrorInfoBehavior.HasErrorsForProperty); helper.ValidatePropertyChange( null, NotifyDataErrorInfoBehavior.FiresErrorsChanged | NotifyDataErrorInfoBehavior.HasErrors | NotifyDataErrorInfoBehavior.HasErrorsForProperty); helper.ValidatePropertyChange( <span class="hljs-number"><span class="hljs-number">2</span></span>, NotifyDataErrorInfoBehavior.FiresErrorsChanged);</code> <br>     <br>   MVVM,     ,  .   ,    ,         . <br> <br>  ,     ,     ,       .   ,   , ,       ,     ,   <code>IAsyncResult</code>    ,  - ,   ,    UI. <br> <br>       , , ,    .   ,     .  ,      UI,     ,   ,          ,     ,        <span class="hljs-string"><span class="hljs-string">"   UI."</span></span> <br> <br>     ,    ,    .   ,    ,     mock-, ,   ,   ,      ,          . <br> <br>           UI,    ,    .   ,     ,   ,      .        ,   .     ,    ,     . <br> <br> <code class="cs">questionnaireRepositoryMock .Setup( r =&gt; r.SubmitQuestionnaireAsync( It.IsAny&lt;Questionnaire&gt;(), It.IsAny&lt;Action&lt;IOperationResult&gt;&gt;())) .Callback&lt;Questionnaire, Action&lt;IOperationResult&gt;&gt;( (q, a) =&gt; callback = a); uiServicemock .Setup(svc =&gt; svc.ShowView(ViewNames.QuestionnaireTemplatesList)) .Callback&lt;<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>&gt;(viewName =&gt; requestedViewName = viewName); submitResultMock .Setup(sr =&gt; sr.Error) .Returns&lt;Exception&gt;(null); CompleteQuestionnaire(viewModel); viewModel.Submit(); //      UI . callback(submitResultMock.Object); //    ‚Äì     . Assert.AreEqual(ViewNames.QuestionnaireTemplatesList, requestedViewName);</code> <br> <b></b> <br>          ,        . <br>   <br>       , . <span class="hljs-string"><span class="hljs-string">"Trees in WPF"</span></span>  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ms753391.aspx">http://msdn.microsoft.com/en-us/library/ms753391.aspx</a> <br> <br>       , . <span class="hljs-string"><span class="hljs-string">"Attached Properties Overview"</span></span>  MSDN: <a href="http://msdn.microsoft.com/en-us/library/cc265152(VS.95).aspx">http://msdn.microsoft.com/en-us/library/cc265152(VS.<span class="hljs-number"><span class="hljs-number">95</span></span>).aspx</a> <br> <br>      MEF, .<span class="hljs-string"><span class="hljs-string">"Managed Extensibility Framework Overview"</span></span>  MSDN: <a href="http://msdn.microsoft.com/en-us/library/dd460648.aspx">http://msdn.microsoft.com/en-us/library/dd460648.aspx</a> . <br> <br>      Unity, .<span class="hljs-string"><span class="hljs-string">"Unity Application Block"</span></span>  MSDN: <a href="http://www.msdn.com/unity">http://www.msdn.com/unity</a> . <br> <br>      <code>DelegateCommand</code> , .Chapter <span class="hljs-number"><span class="hljs-number">5</span></span>, <span class="hljs-string"><span class="hljs-string">" </span></span><a href="http://msdn.microsoft.com/en-us/library/gg405484(v%3DPandP.40).aspx"><span class="hljs-string"><span class="hljs-string">Implementing the MVVM Pattern</span></span></a><span class="hljs-string"><span class="hljs-string"> ."</span></span> <br> <br>        Microsoft Expression Blend, .<span class="hljs-string"><span class="hljs-string">"Working with built-in behaviors"</span></span>  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ff724013(v%3DExpression.40).aspx">http://msdn.microsoft.com/en-us/library/ff724013(v=Expression.<span class="hljs-number"><span class="hljs-number">40</span></span>).aspx</a> . <br> <br>          Microsoft Expression Blend, .<span class="hljs-string"><span class="hljs-string">"Creating Custom Behaviors"</span></span>  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ff724708(v%3DExpression.40).aspx">http://msdn.microsoft.com/en-us/library/ff724708(v=Expression.<span class="hljs-number"><span class="hljs-number">40</span></span>).aspx</a> . <br> <br>            Microsoft Expression Blend, .<span class="hljs-string"><span class="hljs-string">"Creating Custom Triggers and Actions"</span></span>  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ff724707(v%3DExpression.40).aspx">http://msdn.microsoft.com/en-us/library/ff724707(v=Expression.<span class="hljs-number"><span class="hljs-number">40</span></span>).aspx</a> . <br> <br>         WPF  Silverlight, .<span class="hljs-string"><span class="hljs-string">"Threading Model"</span></span>  <span class="hljs-string"><span class="hljs-string">"The Dispatcher Class"</span></span>  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ms741870.aspx">http://msdn.microsoft.com/en-us/library/ms741870.aspx</a> <br> <a href="http://msdn.microsoft.com/en-us/library/ms615907(v%3DVS.95).aspx">http://msdn.microsoft.com/en-us/library/ms615907(v=VS.<span class="hljs-number"><span class="hljs-number">95</span></span>).aspx</a> . <br> <br>      unit-  Silverlight, .<span class="hljs-string"><span class="hljs-string">"Unit Testing with Silverlight 2"</span></span>: <a href="http://www.jeff.wilcox.name/2008/03/silverlight2-unit-testing/">http://www.jeff.wilcox.name/<span class="hljs-number"><span class="hljs-number">2008</span></span>/<span class="hljs-number"><span class="hljs-number">03</span></span>/silverlight2-unit-testing/</a> . <br> <br>         , .  <span class="hljs-string"><span class="hljs-string">" </span></span><a href="http://msdn.microsoft.com/en-us/library/gg430861(v%3DPandP.40).aspx"><span class="hljs-string"><span class="hljs-string">View-Based Navigation</span></span></a><span class="hljs-string"><span class="hljs-string"> "</span></span> in Chapter <span class="hljs-number"><span class="hljs-number">8</span></span>, <span class="hljs-string"><span class="hljs-string">" </span></span><a href="http://msdn.microsoft.com/en-us/library/gg430861(v%3DPandP.40).aspx"><span class="hljs-string"><span class="hljs-string">Navigation</span></span></a><span class="hljs-string"><span class="hljs-string"> ."</span></span> <br> <br>       ,   , .<span class="hljs-string"><span class="hljs-string">"Event-based Asynchronous Pattern Overview"</span></span>  MSDN: <a href="http://msdn.microsoft.com/en-us/library/wewwczdw.aspx">http://msdn.microsoft.com/en-us/library/wewwczdw.aspx</a> <br> <br>        <code>IAsyncResult</code> , .<span class="hljs-string"><span class="hljs-string">"Asynchronous Programming Overview"</span></span>  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ms228963.aspx">http://msdn.microsoft.com/en-us/library/ms228963.aspx</a></code></code></code></code></code></code></code></code></code> </pre> <code><code><code><code>CommandBehaviorBase ,    ,    ICommand</code> .           <code>CanExecuteChanged</code> ,          Silverlight,    WPF. <br> <br>    ,  ,   <code>CommandBehaviorBase    ,    .         ,      .         ,    .      ButtonBaseClickCommandBehavior</code> . <br> <br> <code class="cs">public class ButtonBaseClickCommandBehavior : CommandBehaviorBase&lt;ButtonBase&gt; { public ButtonBaseClickCommandBehavior(ButtonBase clickableObject) : base(clickableObject) { clickableObject.Click += OnClick; } private void OnClick(object sender, System.Windows.RoutedEventArgs e) { ExecuteCommand(); } }</code> <br>   <code>CommandBehaviorBase ,     .     ,          ,   . ,    ,    ,      , ,    CanExecute</code>  ,     . <br> <br>          ,   .           XAML.           .       .  Prism      ,       ,  ,   .       ,    . , ,  ,      <code>Click</code> ,       <code>Command</code> .    <code>Click.Command</code> ,  . <br> <br>             .             . <br> <br> <code class="cs">public static readonly DependencyProperty CommandProperty = DependencyProperty.RegisterAttached( "Command", typeof(ICommand), typeof(Click), new PropertyMetadata(OnSetCommandCallback)); private static readonly DependencyProperty ClickCommandBehaviorProperty = DependencyProperty.RegisterAttached( "ClickCommandBehavior", typeof(ButtonBaseClickCommandBehavior), typeof(Click), null);</code> <br>    <code>Command</code>    <code>ButtonBaseClickCommandBehavior</code> ,     <code>OnSetCommandCallback</code> ,     . <br> <br> <code class="cs">private static void OnSetCommandCallback(DependencyObject dependencyObject, DependencyPropertyChangedEventArgs e) { ButtonBase buttonBase = dependencyObject as ButtonBase; if (buttonBase != null) { ButtonBaseClickCommandBehavior behavior = GetOrCreateBehavior(buttonBase); behavior.Command = e.NewValue as ICommand; } } private static void OnSetCommandParameterCallback(DependencyObject dependencyObject, DependencyPropertyChangedEventArgs e) { ButtonBase buttonBase = dependencyObject as ButtonBase; if (buttonBase != null) { ButtonBaseClickCommandBehavior behavior = GetOrCreateBehavior(buttonBase); behavior.CommandParameter = e.NewValue; } } private static ButtonBaseClickCommandBehavior GetOrCreateBehavior(ButtonBase buttonBase ) { ButtonBaseClickCommandBehavior behavior = buttonBase.GetValue(ClickCommandBehaviorProperty) as ButtonBaseClickCommandBehavior; if ( behavior == null ) { behavior = new ButtonBaseClickCommandBehavior(buttonBase); buttonBase.SetValue(ClickCommandBehaviorProperty, behavior); } return behavior; }</code> <br>        ,  <a href="http://msdn.microsoft.com/en-us/library/cc265152(VS.95).aspx">Attached Properties Overview</a>  MSDN. <br> <br>    <br>              . ,     Silverlight,    -,     ,      ,     .     ,       . <br> <br>        ,    ( )  ,  ,     .  UI       ,            UI. <br> <br>      - <br>   -     ,       <code>IAsyncResult</code> .   ,  ,   ,  <code>GetQuestionnaire</code> ,   : <code>BeginGetQuestionnaire</code>  <code>EndGetQuestionnaire</code> .    ,   <code>BeginGetQuestionnaire</code> .     ,   ,   <code>EndGetQuestionnaire</code>    . <br> <b></b> <br>  .NET Framework 4.5      <code>await</code>  <code>async</code>     <code>*Async</code> .      <a href="http://msdn.microsoft.com/en-us/library/vstudio/hh391443.aspx">"Asynchronous Programming with Async and Await (C# and Visual Basic)"</a> . <br>  ,    <code>EndGetQuestionnaire</code> ,      ,  ()      <code>BeginGetQuestionnaire</code> .     ,      ,   <code>EndGetQuestionnaire</code> ,   . <br> <br> <code class="xml">IAsyncResult asyncResult = this.service.BeginGetQuestionnaire( GetQuestionnaireCompleted, null //  ,      ); private void GetQuestionnaireCompleted(IAsyncResult result) { try { questionnaire = this.service.EndGetQuestionnaire(ar); } catch (Exception ex) { //  -   . } }</code> <br>  ,     <code>End*</code> (  , <code>EndGetQuestionnaire</code> ),    ,      .      , ,          UI.     ,   ,        . <br> <br>        UI,     -,      UI,         UI,   <code>Dispatcher</code>    <code>SynchronizationContext</code> .  WPF  Silverlight,   <code>Dispatcher</code> . <br> <br>      <code>Questionnaire</code>  ,        <code>QuestionnaireView</code> .  Silverlight    <code>CheckAccess</code> ,  ,      UI.  ,     <code>BeginInvoke</code> ,      UI. <br> <br> <code class="cs">var dispatcher = System.Windows.Deployment.Current.Dispatcher; if (dispatcher.CheckAccess()) { QuestionnaireView.DataContext = questionnaire; } else { dispatcher.BeginInvoke(() =&gt; { Questionnaire.DataContext = questionnaire; }); }</code> <br> <i>MVVM RI</i>   ,    ,   <code>IAsyncResult</code> ,   .      ,                 . ,       . <br> <br> <code class="cs">this.questionnaireRepository.GetQuestionnaireAsync( result =&gt; { this.Questionnaire = result.Result; });</code> <br>  <code>result</code>   ,     , , , .    ,     . <br> <br> <code class="cs">this.questionnaireRepository.GetQuestionnaireAsync( result =&gt; { if (result.Error == null) { this.Questionnaire = result.Result; ... } else { // Handle error. } })</code> <br>     <br>        ,      .     , ,             .        ,      ,     ,     . <br> <br>         ,      MVVM,     ,   . ,  -MVVM ,     <code>MessageBox</code>   code-behind UI,      .   MVVM     ,          . <br> <br>     MVVM,              ,          .      ,    ,   ,  ,     . <br> <br>              MVVM.      ,     ,     ,  ,     .    ,         ,     ,          .       . <br> <br>    <br>                  .        ,        .  ,         .         . <br> <br>  ,         ,         ,  .      ,     .           ,       . ,        WPF  Silverlight,        . <br> <br> <img title="Using the service to interact with the user." src="https://habrastorage.org/getpro/habr/post_images/4b5/397/f2d/4b5397f2d02e5851195b29f1893be6fc.png" alt=" ,    ."> <br> <br>  ,   <code>MessageBox</code>        ,     ,    ,     . <br> <br> <code class="cs">var result = interactionService.ShowMessageBox( "Are you sure you want to cancel this operation?", "Confirm", MessageBoxButton.OK); if (result == MessageBoxResult.Yes) { CancelRequest(); }</code> <br> ,      - ,      ,         Silverlight.         .             .     . <br> <br> <code class="cs">interactionService.ShowMessageBox( "Are you sure you want to cancel this operation?", "Confirm", MessageBoxButton.OK, result =&gt; { if (result == MessageBoxResult.Yes) { CancelRequest(); } });</code> <br>         ,      . ,  WPF    <code>MessageBox</code> ,       ;    Silverlight    ,    . <br> <br>     <br>         ‚Äì             .         ,      .     ,     .        ,        ,   ,     . <br> <br> <img title="Using interaction request objects." src="https://habrastorage.org/getpro/habr/post_images/3d0/ff0/1c5/3d0ff01c5518558c2d3c5c5f47ce0ce9.png" alt="   ."> <br> <br>    ,   ,          ‚Äì       ,      ,   ‚Äì     .   ,        ,    ,    UI            . <br> <br>       MVVM,     ,       ,         .         ,        ,    ,   . <br> <br>  Prism       <code>IInteractionRequest</code>   <code><code>InteractionRequest .  IInteractionRequest</code>  ,   .           ,   .  <code><code>InteractionRequest   IInteractionRequest</code>     <code>Raise</code> ,           , , ,   . <br> <br>       <br>  <code><code>InteractionRequest          .  Raise</code>          ( <code>T</code> )    ,    ,   .          ,       .      ,        .    ,  ,     . <br> <code class="cs">public interface IInteractionRequest { event EventHandler&lt;InteractionRequestedEventArgs&gt; Raised; } public class InteractionRequest&lt;T&gt; : IInteractionRequest { public event EventHandler&lt;InteractionRequestedEventArgs&gt; Raised; public void Raise(T context, Action&lt;T&gt; callback) { var handler = this.Raised; if (handler != null) { handler( this, new InteractionRequestedEventArgs(context, () =&gt; callback(context))); } } }</code> <br> Prism    ,      .  <code>Notification</code>       .    ,            .     ‚Äì <code>Title</code>  <code>Content</code> ,    .  ,   ,  ,  ,        . <br> <br>  <code>Confirmation</code>    <code>Notification</code>     ‚Äì <code>Confirmed</code> ,  ,  ,      .  <code>Confirmation</code> ,     <code>MessageBox</code> ,     /  .     ,     <code>Notification</code> ,     ,      . <br> <br>    <code><code><code>InteractionRequest ,       InteractionRequest      ,      .      ,    Raise</code> ,    , ,   . <br> <br> <code class="cs">public IInteractionRequest ConfirmCancelInteractionRequest { get { return this.confirmCancelInteractionRequest; } } this.confirmCancelInteractionRequest.Raise( new Confirmation("Are you sure you wish to cancel?"), confirmation =&gt; { if (confirmation.Confirmed) { this.NavigateToQuestionnaireList(); } }); }</code> <br> <i>MVVM Reference Implementation (MVVM RI)</i> ,    <code>IInteractionRequest</code>   <code><code>InteractionRequest ,          (. QuestionnaireViewModel.cs</code> ). <br> <br>        <br>       ,       .   ,       .    UI             . <br> <br>                . Microsoft Expression Blend Behaviors Framework     .  ,     ,    . <br> <br>  <code>EventTrigger</code> ,  Expression Blend,  ,      ,     ,   . , Prism   <code>EventTrigger</code> ,  <code>InteractionRequestTrigger</code> ,      <code>Raised</code>   <code>IInteractionRequest</code> .    XAML        . <br> <br>  ,   , <code>InteractionRequestTrigger</code>   .  Silverlight Prism   <code>PopupChildWindowAction</code> ,     .    ,         .   <code>ContentTemplate</code>  <code>PopupChildWindowAction</code> ,    ,    UI,      <code>Content</code>  .       <code>Title</code>  . <br> <b></b> <br>  ,    ,   <code>PopupChildWindowAction</code> ,     .    <code>Notification</code>  <code>NotificationChildWindow</code> ,        <code>Confirmation</code> ‚Äì <code>ConfirmationChildWindow</code> . <code>NotificationChildWindow</code>    ,   ,     <code>ConfirmationChildWindow</code>    <i>OK</i>  <i>Cancel</i> ,    .    ,   ,   <code>ChildWindow</code>  <code>PopupChildWindowAction</code> . <br>   ,  <code>InteractionRequestTrigger</code>  <code>PopupChildWindowAction</code> ,       <i>RI MVVM</i> . <br> <br> <code class="xml">&lt;i:Interaction.Triggers&gt; &lt;prism:InteractionRequestTrigger SourceObject="{Binding ConfirmCancelInteractionRequest}"&gt; &lt;prism:PopupChildWindowAction ContentTemplate="{StaticResource ConfirmWindowTemplate}"/&gt; &lt;/prism:InteractionRequestTrigger&gt; &lt;/i:Interaction.Triggers&gt; &lt;UserControl.Resources&gt; &lt;DataTemplate x:Key="ConfirmWindowTemplate"&gt; &lt;Grid MinWidth="250" MinHeight="100"&gt; &lt;TextBlock TextWrapping="Wrap" Grid.Row="0" Text="{Binding}"/&gt; &lt;/Grid&gt; &lt;/DataTemplate&gt; &lt;/UserControl.Resources&gt;</code> <br> <b></b> <br>      <code>ContentTemplate</code> ,   UI   <code>Content</code>  .    <code>Content</code>  ,  , <code>TextBlock</code>     <code>Content</code> . <br>      ,     ,    ,    .  ,     ,       ,     ,    .   ,   <i>RI MVVM</i> ,         <code>Confirmed</code>    <code>Confirmation</code>  <code>true</code> ,     OK. <br> <br>        ,     .  Prism <code>InteractionRequestTrigger</code>   <code>PopupChildWindowAction</code>            . <br> <br>     <br>     MVVM,       , ,    ,         .        (  , ,  ,   ).    ,  ,  ,            . <br> <br>        ,         . Managed Extensibility Framework (MEF)  Unity Application Block (Unity)      ,  ,           . <br> <br>  ,       , , ,    ( )      . ,       ,     .  ,     ,       . <br> <br>     ,  MEF <br>  MEF,       ,   <code>Import</code> ,      ,  ,   <code>Export</code> .         ,    . <br> <br> , <code>QuestionnaireView</code>   <i>RI MVVM</i> ,        ,    <code>Import</code> .   , MEF           .  <code>set</code>        ,   . <br> <br> <code class="cs">[Import] public QuestionnaireViewModel ViewModel { set { this.DataContext = value; } }</code> <br>     ,   . <br> <br> <code class="cs">[Export] public class QuestionnaireViewModel : NotificationObject { ... }</code> <br>        ,   . <br> <br> <code class="cs">public QuestionnaireView() { InitializeComponent(); } [ImportingConstructor] public QuestionnaireView(QuestionnaireViewModel viewModel) : this() { this.DataContext = viewModel; }</code> <br> <b></b> <br>          MEF,   Unity.   ,     ,        .   ,   Visual Studio  Expression Blend, ,        ,     .   ,   ,  ,      ,          <code>InitializeComponent</code> . <br>     ,  Unity <br>  Unity,    ,   MEF.     ,      .    ,         .  ,      . <br> <br>  ,      ,  ,         . ,           ,   . <br> <br> <code class="cs">public QuestionnaireView() { InitializeComponent(); } public QuestionnaireView(QuestionnaireViewModel viewModel) : this() { this.DataContext = viewModel; }</code> <br> <b></b> <br>    ,        ,   Visual Studio  Expression Blend. <br>  ,          ,   . Unity        <code>set</code>   ,   . <br> <br> <code class="cs">public QuestionnaireView() { InitializeComponent(); } [Dependency] public QuestionnaireViewModel ViewModel { set { this.DataContext = value; } }</code> <br>       Unity. <br> <br> <code class="cs">container.RegisterType&lt;QuestionnaireViewModel&gt;();</code> <br>  ,     . <br> <br> <code class="cs">var view = container.Resolve&lt;QuestionnaireView&gt;();</code> <br>     ,    <br>   ,     ,        .        ,   MEF  Unity,        . <br> <br>          .   ,         UI,           . <br> <br> , <i>RI MVVM</i>   ,   ,        .   ,    .      <code>ShowView</code>   UI. <br> <br> <code class="cs">private void NavigateToQuestionnaireList() { //     "questionnaire list". this.uiService.ShowView(ViewNames.QuestionnaireTemplatesList); }</code> <br>  UI      UI .           UI.  <code>ShowView</code>  <code>UIService</code>      (,          ),       ,   . <br> <br> <code class="cs">public void ShowView(string viewName) { var view = this.ViewFactory.GetView(viewName); this.MainWindow.CurrentView = view; }</code> <br> <b></b> <br> Prism       .   ,   ,   ,             .    ,  , " <a href="http://msdn.microsoft.com/en-us/library/gg430861(v%3DPandP.40).aspx">View-Based Navigation</a> "   8, " <a href="http://msdn.microsoft.com/en-us/library/gg430861(v%3DPandP.40).aspx">Navigation</a> ". <br>  MVVM  <br>        MVVM      .           -      mocking . ,   ,        . <br> <br>   <i>INotifyPropertyChanged</i> <br>   <code>INotifyPropertyChanged</code>     ,      .      ,    ;   ,   ,     ,    ,       . <br> <br>   <br> ,       ,           <code>PropertyChanged</code>  ,         .  ,    <code>ChangeTracker</code> ,     MVVM,  ,      .      .     ,    . <br> <br> <code class="cs">var changeTracker = new PropertyChangeTracker(viewModel); viewModel.CurrentState = "newState"; CollectionAssert.Contains(changeTracker.ChangedProperties, "CurrentState");</code> <br> ,     ,     <code>INotifyPropertyChanged</code> ,    ,   ,     . <br> <br>      <br>        ,   ,    <code>set</code>      ,           . ,     ,     ,      ,          . <br> <br> <code class="cs">var changeTracker = new PropertyChangeTracker(viewModel); var question = viewModel.Questions.First() as OpenQuestionViewModel; question.Question.Response = "some text"; CollectionAssert.Contains(changeTracker.ChangedProperties, "UnansweredQuestions");</code> <br>      <br>     <code>INotifyPropertyChanged</code> ,      <code>PropertyChanged</code>        ,  ,     , , .        ,       . <br> <br>   <i>INotifyDataErrorInfo</i> <br>   ,     ,    ,   ,   <code>IDataErrorInfo</code> ,  ( Silverlight)   <code>INotifyDataErrorInfo</code> .   <code>INotifyDataErrorInfo</code>   ,         ,    ,  ,   ,    . <br> <br>       <code>INotifyDataErrorInfo</code> : ,     ,  ,     ,     <code>ErrorsChanged</code> ,      <code>GetErrors</code> , . <br> <br>    <br>     ,      ,     .       ,         <code>GetErrors</code>       ,  ,  ,   .    , ,  ,     ,        .   ,        . <br> <br> <code class="cs">//  . var notifyErrorInfo = (INotifyDataErrorInfo)question; question.Response = -15; Assert.IsTrue(notifyErrorInfo.GetErrors("Response").Cast&lt;ValidationResult&gt;().Any()); //  . var notifyErrorInfo = (INotifyDataErrorInfo)question; question.Response = 15; Assert.IsFalse(notifyErrorInfo.GetErrors("Response").Cast&lt;ValidationResult&gt;().Any());</code> <br>    ,    ,             . <br> <br>    <i>INotifyDataErrorInfo</i> <br>       <code>GetErrors</code> ,   <code>INotifyDataErrorInfo</code>  ,   <code>ErrorsChanged</code>      <code>GetErrors</code> . ,  <code>HasErrors</code>      ,  . <br> <br>       <code>INotifyDataErrorInfo</code> . , ,           ,   -  .      ,        <code>INotifyDataErrorInfo</code>         (,        ). <br> <br>     ,   ,  : <br>  <code>HasErrors</code>     .              ,       .  <code>ErrorsChanged</code> ,      ,         <code>GetErrors</code> .         ( ,  )     ,           .    <code>GetErrors</code>       <code>ErrorsChanged</code> . <br>    <code>INotifyPropertyChanged</code> ,  ,    <code>NotifyDataErrorInfoTestHelper</code>    MVVM,        <code>INotifyDataErrorInfo</code> ,       .   ,   ,      ,   .      . <br> <code class="cs">var helper = new NotifyDataErrorInfoTestHelper&lt;NumericQuestion, int?&gt;( question, q =&gt; q.Response); helper.ValidatePropertyChange( 6, NotifyDataErrorInfoBehavior.Nothing); helper.ValidatePropertyChange( 20, NotifyDataErrorInfoBehavior.FiresErrorsChanged | NotifyDataErrorInfoBehavior.HasErrors | NotifyDataErrorInfoBehavior.HasErrorsForProperty); helper.ValidatePropertyChange( null, NotifyDataErrorInfoBehavior.FiresErrorsChanged | NotifyDataErrorInfoBehavior.HasErrors | NotifyDataErrorInfoBehavior.HasErrorsForProperty); helper.ValidatePropertyChange( 2, NotifyDataErrorInfoBehavior.FiresErrorsChanged);</code> <br>     <br>   MVVM,     ,  .   ,    ,         . <br> <br>  ,     ,     ,       .   ,   , ,       ,     ,   <code>IAsyncResult</code>    ,  - ,   ,    UI. <br> <br>       , , ,    .   ,     .  ,      UI,     ,   ,          ,     ,        "   UI." <br> <br>     ,    ,    .   ,    ,     mock-, ,   ,   ,      ,          . <br> <br>           UI,    ,    .   ,     ,   ,      .        ,   .     ,    ,     . <br> <br> <code class="cs">questionnaireRepositoryMock .Setup( r =&gt; r.SubmitQuestionnaireAsync( It.IsAny&lt;Questionnaire&gt;(), It.IsAny&lt;Action&lt;IOperationResult&gt;&gt;())) .Callback&lt;Questionnaire, Action&lt;IOperationResult&gt;&gt;( (q, a) =&gt; callback = a); uiServicemock .Setup(svc =&gt; svc.ShowView(ViewNames.QuestionnaireTemplatesList)) .Callback&lt;string&gt;(viewName =&gt; requestedViewName = viewName); submitResultMock .Setup(sr =&gt; sr.Error) .Returns&lt;Exception&gt;(null); CompleteQuestionnaire(viewModel); viewModel.Submit(); //      UI . callback(submitResultMock.Object); //    ‚Äì     . Assert.AreEqual(ViewNames.QuestionnaireTemplatesList, requestedViewName);</code> <br> <b></b> <br>          ,        . <br>   <br>       , . "Trees in WPF"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ms753391.aspx">http://msdn.microsoft.com/en-us/library/ms753391.aspx</a> <br> <br>       , . "Attached Properties Overview"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/cc265152(VS.95).aspx">http://msdn.microsoft.com/en-us/library/cc265152(VS.95).aspx</a> <br> <br>      MEF, ."Managed Extensibility Framework Overview"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/dd460648.aspx">http://msdn.microsoft.com/en-us/library/dd460648.aspx</a> . <br> <br>      Unity, ."Unity Application Block"  MSDN: <a href="http://www.msdn.com/unity">http://www.msdn.com/unity</a> . <br> <br>      <code>DelegateCommand</code> , .Chapter 5, " <a href="http://msdn.microsoft.com/en-us/library/gg405484(v%3DPandP.40).aspx">Implementing the MVVM Pattern</a> ." <br> <br>        Microsoft Expression Blend, ."Working with built-in behaviors"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ff724013(v%3DExpression.40).aspx">http://msdn.microsoft.com/en-us/library/ff724013(v=Expression.40).aspx</a> . <br> <br>          Microsoft Expression Blend, ."Creating Custom Behaviors"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ff724708(v%3DExpression.40).aspx">http://msdn.microsoft.com/en-us/library/ff724708(v=Expression.40).aspx</a> . <br> <br>            Microsoft Expression Blend, ."Creating Custom Triggers and Actions"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ff724707(v%3DExpression.40).aspx">http://msdn.microsoft.com/en-us/library/ff724707(v=Expression.40).aspx</a> . <br> <br>         WPF  Silverlight, ."Threading Model"  "The Dispatcher Class"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ms741870.aspx">http://msdn.microsoft.com/en-us/library/ms741870.aspx</a> <br> <a href="http://msdn.microsoft.com/en-us/library/ms615907(v%3DVS.95).aspx">http://msdn.microsoft.com/en-us/library/ms615907(v=VS.95).aspx</a> . <br> <br>      unit-  Silverlight, ."Unit Testing with Silverlight 2": <a href="http://www.jeff.wilcox.name/2008/03/silverlight2-unit-testing/">http://www.jeff.wilcox.name/2008/03/silverlight2-unit-testing/</a> . <br> <br>         , .  " <a href="http://msdn.microsoft.com/en-us/library/gg430861(v%3DPandP.40).aspx">View-Based Navigation</a> " in Chapter 8, " <a href="http://msdn.microsoft.com/en-us/library/gg430861(v%3DPandP.40).aspx">Navigation</a> ." <br> <br>       ,   , ."Event-based Asynchronous Pattern Overview"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/wewwczdw.aspx">http://msdn.microsoft.com/en-us/library/wewwczdw.aspx</a> <br> <br>        <code>IAsyncResult</code> , ."Asynchronous Programming Overview"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ms228963.aspx">http://msdn.microsoft.com/en-us/library/ms228963.aspx</a></code></code></code></code></code></code></code></code></code> <pre> <code class="hljs cmake"><code>CommandBehaviorBase ,    ,    ICommand</code> .           <code>CanExecuteChanged</code> ,          Silverlight,    WPF. <br> <br>    ,  ,   <code><code>CommandBehaviorBase    ,    .         ,      .         ,    .      ButtonBaseClickCommandBehavior</code> . <br> <br> <code class="cs">public class ButtonBaseClickCommandBehavior : CommandBehaviorBase&lt;ButtonBase&gt; { public ButtonBaseClickCommandBehavior(ButtonBase clickableObject) : base(clickableObject) { clickableObject.Click += OnClick; } private void OnClick(object sender, System.Windows.RoutedEventArgs e) { ExecuteCommand(); } }</code> <br>   <code><code>CommandBehaviorBase ,     .     ,          ,   . ,    ,    ,      , ,    CanExecute</code>  ,     . <br> <br>          ,   .           XAML.           .       .  Prism      ,       ,  ,   .       ,    . , ,  ,      <code>Click</code> ,       <code><span class="hljs-keyword"><span class="hljs-keyword">Command</span></span></code> .    <code>Click.<span class="hljs-keyword"><span class="hljs-keyword">Command</span></span></code> ,  . <br> <br>             .             . <br> <br> <code class="cs">public static readonly DependencyProperty CommandProperty = DependencyProperty.RegisterAttached( <span class="hljs-string"><span class="hljs-string">"Command"</span></span>, typeof(ICommand), typeof(Click), new PropertyMetadata(OnSetCommandCallback)); private static readonly DependencyProperty ClickCommandBehaviorProperty = DependencyProperty.RegisterAttached( <span class="hljs-string"><span class="hljs-string">"ClickCommandBehavior"</span></span>, typeof(ButtonBaseClickCommandBehavior), typeof(Click), null);</code> <br>    <code><span class="hljs-keyword"><span class="hljs-keyword">Command</span></span></code>    <code>ButtonBaseClickCommandBehavior</code> ,     <code>OnSetCommandCallback</code> ,     . <br> <br> <code class="cs">private static void OnSetCommandCallback(DependencyObject dependencyObject, DependencyPropertyChangedEventArgs e) { ButtonBase buttonBase = dependencyObject as ButtonBase; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (buttonBase != null) { ButtonBaseClickCommandBehavior behavior = GetOrCreateBehavior(buttonBase); behavior.<span class="hljs-keyword"><span class="hljs-keyword">Command</span></span> = e.NewValue as ICommand; } } private static void OnSetCommandParameterCallback(DependencyObject dependencyObject, DependencyPropertyChangedEventArgs e) { ButtonBase buttonBase = dependencyObject as ButtonBase; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (buttonBase != null) { ButtonBaseClickCommandBehavior behavior = GetOrCreateBehavior(buttonBase); behavior.CommandParameter = e.NewValue; } } private static ButtonBaseClickCommandBehavior GetOrCreateBehavior(ButtonBase buttonBase ) { ButtonBaseClickCommandBehavior behavior = buttonBase.GetValue(ClickCommandBehaviorProperty) as ButtonBaseClickCommandBehavior; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ( behavior == null ) { behavior = new ButtonBaseClickCommandBehavior(buttonBase); buttonBase.SetValue(ClickCommandBehaviorProperty, behavior); } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> behavior; }</code> <br>        ,  <a href="http://msdn.microsoft.com/en-us/library/cc265152(VS.95).aspx">Attached Properties Overview</a>  MSDN. <br> <br>    <br>              . ,     Silverlight,    -,     ,      ,     .     ,       . <br> <br>        ,    ( )  ,  ,     .  UI       ,            UI. <br> <br>      - <br>   -     ,       <code>IAsyncResult</code> .   ,  ,   ,  <code>GetQuestionnaire</code> ,   : <code>BeginGetQuestionnaire</code>  <code>EndGetQuestionnaire</code> .    ,   <code>BeginGetQuestionnaire</code> .     ,   ,   <code>EndGetQuestionnaire</code>    . <br> <b></b> <br>  .NET Framework <span class="hljs-number"><span class="hljs-number">4.5</span></span>      <code>await</code>  <code>async</code>     <code>*Async</code> .      <a href="http://msdn.microsoft.com/en-us/library/vstudio/hh391443.aspx"><span class="hljs-string"><span class="hljs-string">"Asynchronous Programming with Async and Await (C# and Visual Basic)"</span></span></a> . <br>  ,    <code>EndGetQuestionnaire</code> ,      ,  ()      <code>BeginGetQuestionnaire</code> .     ,      ,   <code>EndGetQuestionnaire</code> ,   . <br> <br> <code class="xml">IAsyncResult asyncResult = this.service.BeginGetQuestionnaire( GetQuestionnaireCompleted, null //  ,      ); private void GetQuestionnaireCompleted(IAsyncResult result) { try { questionnaire = this.service.EndGetQuestionnaire(ar); } catch (Exception ex) { //  -   . } }</code> <br>  ,     <code>End*</code> (  , <code>EndGetQuestionnaire</code> ),    ,      .      , ,          UI.     ,   ,        . <br> <br>        UI,     -,      UI,         UI,   <code>Dispatcher</code>    <code>SynchronizationContext</code> .  WPF  Silverlight,   <code>Dispatcher</code> . <br> <br>      <code>Questionnaire</code>  ,        <code>QuestionnaireView</code> .  Silverlight    <code>CheckAccess</code> ,  ,      UI.  ,     <code>BeginInvoke</code> ,      UI. <br> <br> <code class="cs">var dispatcher = System.Windows.Deployment.Current.Dispatcher; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (dispatcher.CheckAccess()) { QuestionnaireView.DataContext = questionnaire; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { dispatcher.BeginInvoke(() =&gt; { Questionnaire.DataContext = questionnaire; }); }</code> <br> <i>MVVM RI</i>   ,    ,   <code>IAsyncResult</code> ,   .      ,                 . ,       . <br> <br> <code class="cs">this.questionnaireRepository.GetQuestionnaireAsync( result =&gt; { this.Questionnaire = result.Result; });</code> <br>  <code>result</code>   ,     , , , .    ,     . <br> <br> <code class="cs">this.questionnaireRepository.GetQuestionnaireAsync( result =&gt; { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (result.Error == null) { this.Questionnaire = result.Result; ... } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { // Handle error. } })</code> <br>     <br>        ,      .     , ,             .        ,      ,     ,     . <br> <br>         ,      MVVM,     ,   . ,  -MVVM ,     <code>MessageBox</code>   code-behind UI,      .   MVVM     ,          . <br> <br>     MVVM,              ,          .      ,    ,   ,  ,     . <br> <br>              MVVM.      ,     ,     ,  ,     .    ,         ,     ,          .       . <br> <br>    <br>                  .        ,        .  ,         .         . <br> <br>  ,         ,         ,  .      ,     .           ,       . ,        WPF  Silverlight,        . <br> <br> <img title="Using the service to interact with the user." src="https://habrastorage.org/getpro/habr/post_images/4b5/397/f2d/4b5397f2d02e5851195b29f1893be6fc.png" alt=" ,    ."> <br> <br>  ,   <code>MessageBox</code>        ,     ,    ,     . <br> <br> <code class="cs">var result = interactionService.ShowMessageBox( <span class="hljs-string"><span class="hljs-string">"Are you sure you want to cancel this operation?"</span></span>, <span class="hljs-string"><span class="hljs-string">"Confirm"</span></span>, MessageBoxButton.OK); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (result == MessageBoxResult.Yes) { CancelRequest(); }</code> <br> ,      - ,      ,         Silverlight.         .             .     . <br> <br> <code class="cs">interactionService.ShowMessageBox( <span class="hljs-string"><span class="hljs-string">"Are you sure you want to cancel this operation?"</span></span>, <span class="hljs-string"><span class="hljs-string">"Confirm"</span></span>, MessageBoxButton.OK, result =&gt; { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (result == MessageBoxResult.Yes) { CancelRequest(); } });</code> <br>         ,      . ,  WPF    <code>MessageBox</code> ,       ;    Silverlight    ,    . <br> <br>     <br>         ‚Äì             .         ,      .     ,     .        ,        ,   ,     . <br> <br> <img title="Using interaction request objects." src="https://habrastorage.org/getpro/habr/post_images/3d0/ff0/1c5/3d0ff01c5518558c2d3c5c5f47ce0ce9.png" alt="   ."> <br> <br>    ,   ,          ‚Äì       ,      ,   ‚Äì     .   ,        ,    ,    UI            . <br> <br>       MVVM,     ,       ,         .         ,        ,    ,   . <br> <br>  Prism       <code>IInteractionRequest</code>   <code><code>InteractionRequest .  IInteractionRequest</code>  ,   .           ,   .  <code><code>InteractionRequest   IInteractionRequest</code>     <code>Raise</code> ,           , , ,   . <br> <br>       <br>  <code><code>InteractionRequest          .  Raise</code>          ( <code>T</code> )    ,    ,   .          ,       .      ,        .    ,  ,     . <br> <code class="cs">public interface IInteractionRequest { event EventHandler&lt;InteractionRequestedEventArgs&gt; Raised; } public class InteractionRequest&lt;T&gt; : IInteractionRequest { public event EventHandler&lt;InteractionRequestedEventArgs&gt; Raised; public void Raise(T context, Action&lt;T&gt; callback) { var handler = this.Raised; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (handler != null) { handler( this, new InteractionRequestedEventArgs(context, () =&gt; callback(context))); } } }</code> <br> Prism    ,      .  <code>Notification</code>       .    ,            .     ‚Äì <code>Title</code>  <code>Content</code> ,    .  ,   ,  ,  ,        . <br> <br>  <code>Confirmation</code>    <code>Notification</code>     ‚Äì <code>Confirmed</code> ,  ,  ,      .  <code>Confirmation</code> ,     <code>MessageBox</code> ,     /  .     ,     <code>Notification</code> ,     ,      . <br> <br>    <code><code><code>InteractionRequest ,       InteractionRequest      ,      .      ,    Raise</code> ,    , ,   . <br> <br> <code class="cs">public IInteractionRequest ConfirmCancelInteractionRequest { get { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> this.confirmCancelInteractionRequest; } } this.confirmCancelInteractionRequest.Raise( new Confirmation(<span class="hljs-string"><span class="hljs-string">"Are you sure you wish to cancel?"</span></span>), confirmation =&gt; { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (confirmation.Confirmed) { this.NavigateToQuestionnaireList(); } }); }</code> <br> <i>MVVM Reference Implementation (MVVM RI)</i> ,    <code>IInteractionRequest</code>   <code><code>InteractionRequest ,          (. QuestionnaireViewModel.cs</code> ). <br> <br>        <br>       ,       .   ,       .    UI             . <br> <br>                . Microsoft Expression Blend Behaviors Framework     .  ,     ,    . <br> <br>  <code>EventTrigger</code> ,  Expression Blend,  ,      ,     ,   . , Prism   <code>EventTrigger</code> ,  <code>InteractionRequestTrigger</code> ,      <code>Raised</code>   <code>IInteractionRequest</code> .    XAML        . <br> <br>  ,   , <code>InteractionRequestTrigger</code>   .  Silverlight Prism   <code>PopupChildWindowAction</code> ,     .    ,         .   <code>ContentTemplate</code>  <code>PopupChildWindowAction</code> ,    ,    UI,      <code>Content</code>  .       <code>Title</code>  . <br> <b></b> <br>  ,    ,   <code>PopupChildWindowAction</code> ,     .    <code>Notification</code>  <code>NotificationChildWindow</code> ,        <code>Confirmation</code> ‚Äì <code>ConfirmationChildWindow</code> . <code>NotificationChildWindow</code>    ,   ,     <code>ConfirmationChildWindow</code>    <i>OK</i>  <i>Cancel</i> ,    .    ,   ,   <code>ChildWindow</code>  <code>PopupChildWindowAction</code> . <br>   ,  <code>InteractionRequestTrigger</code>  <code>PopupChildWindowAction</code> ,       <i>RI MVVM</i> . <br> <br> <code class="xml">&lt;i:Interaction.Triggers&gt; &lt;prism:InteractionRequestTrigger SourceObject=<span class="hljs-string"><span class="hljs-string">"{Binding ConfirmCancelInteractionRequest}"</span></span>&gt; &lt;prism:PopupChildWindowAction ContentTemplate=<span class="hljs-string"><span class="hljs-string">"{StaticResource ConfirmWindowTemplate}"</span></span>/&gt; &lt;/prism:InteractionRequestTrigger&gt; &lt;/i:Interaction.Triggers&gt; &lt;UserControl.Resources&gt; &lt;DataTemplate x:Key=<span class="hljs-string"><span class="hljs-string">"ConfirmWindowTemplate"</span></span>&gt; &lt;Grid MinWidth=<span class="hljs-string"><span class="hljs-string">"250"</span></span> MinHeight=<span class="hljs-string"><span class="hljs-string">"100"</span></span>&gt; &lt;TextBlock TextWrapping=<span class="hljs-string"><span class="hljs-string">"Wrap"</span></span> Grid.Row=<span class="hljs-string"><span class="hljs-string">"0"</span></span> Text=<span class="hljs-string"><span class="hljs-string">"{Binding}"</span></span>/&gt; &lt;/Grid&gt; &lt;/DataTemplate&gt; &lt;/UserControl.Resources&gt;</code> <br> <b></b> <br>      <code>ContentTemplate</code> ,   UI   <code>Content</code>  .    <code>Content</code>  ,  , <code>TextBlock</code>     <code>Content</code> . <br>      ,     ,    ,    .  ,     ,       ,     ,    .   ,   <i>RI MVVM</i> ,         <code>Confirmed</code>    <code>Confirmation</code>  <code><span class="hljs-keyword"><span class="hljs-keyword">true</span></span></code> ,     OK. <br> <br>        ,     .  Prism <code>InteractionRequestTrigger</code>   <code>PopupChildWindowAction</code>            . <br> <br>     <br>     MVVM,       , ,    ,         .        (  , ,  ,   ).    ,  ,  ,            . <br> <br>        ,         . Managed Extensibility Framework (MEF)  Unity Application Block (Unity)      ,  ,           . <br> <br>  ,       , , ,    ( )      . ,       ,     .  ,     ,       . <br> <br>     ,  MEF <br>  MEF,       ,   <code>Import</code> ,      ,  ,   <code><span class="hljs-keyword"><span class="hljs-keyword">Export</span></span></code> .         ,    . <br> <br> , <code>QuestionnaireView</code>   <i>RI MVVM</i> ,        ,    <code>Import</code> .   , MEF           .  <code><span class="hljs-keyword"><span class="hljs-keyword">set</span></span></code>        ,   . <br> <br> <code class="cs">[Import] public QuestionnaireViewModel ViewModel { <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> { this.DataContext = value; } }</code> <br>     ,   . <br> <br> <code class="cs">[<span class="hljs-keyword"><span class="hljs-keyword">Export</span></span>] public class QuestionnaireViewModel : NotificationObject { ... }</code> <br>        ,   . <br> <br> <code class="cs">public QuestionnaireView() { InitializeComponent(); } [ImportingConstructor] public QuestionnaireView(QuestionnaireViewModel viewModel) : this() { this.DataContext = viewModel; }</code> <br> <b></b> <br>          MEF,   Unity.   ,     ,        .   ,   Visual Studio  Expression Blend, ,        ,     .   ,   ,  ,      ,          <code>InitializeComponent</code> . <br>     ,  Unity <br>  Unity,    ,   MEF.     ,      .    ,         .  ,      . <br> <br>  ,      ,  ,         . ,           ,   . <br> <br> <code class="cs">public QuestionnaireView() { InitializeComponent(); } public QuestionnaireView(QuestionnaireViewModel viewModel) : this() { this.DataContext = viewModel; }</code> <br> <b></b> <br>    ,        ,   Visual Studio  Expression Blend. <br>  ,          ,   . Unity        <code><span class="hljs-keyword"><span class="hljs-keyword">set</span></span></code>   ,   . <br> <br> <code class="cs">public QuestionnaireView() { InitializeComponent(); } [Dependency] public QuestionnaireViewModel ViewModel { <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> { this.DataContext = value; } }</code> <br>       Unity. <br> <br> <code class="cs">container.RegisterType&lt;QuestionnaireViewModel&gt;();</code> <br>  ,     . <br> <br> <code class="cs">var view = container.Resolve&lt;QuestionnaireView&gt;();</code> <br>     ,    <br>   ,     ,        .        ,   MEF  Unity,        . <br> <br>          .   ,         UI,           . <br> <br> , <i>RI MVVM</i>   ,   ,        .   ,    .      <code>ShowView</code>   UI. <br> <br> <code class="cs">private void NavigateToQuestionnaireList() { //     <span class="hljs-string"><span class="hljs-string">"questionnaire list"</span></span>. this.uiService.ShowView(ViewNames.QuestionnaireTemplatesList); }</code> <br>  UI      UI .           UI.  <code>ShowView</code>  <code>UIService</code>      (,          ),       ,   . <br> <br> <code class="cs">public void ShowView(<span class="hljs-keyword"><span class="hljs-keyword">string</span></span> viewName) { var view = this.ViewFactory.GetView(viewName); this.MainWindow.CurrentView = view; }</code> <br> <b></b> <br> Prism       .   ,   ,   ,             .    ,  , <span class="hljs-string"><span class="hljs-string">" </span></span><a href="http://msdn.microsoft.com/en-us/library/gg430861(v%3DPandP.40).aspx"><span class="hljs-string"><span class="hljs-string">View-Based Navigation</span></span></a><span class="hljs-string"><span class="hljs-string"> "</span></span>   <span class="hljs-number"><span class="hljs-number">8</span></span>, <span class="hljs-string"><span class="hljs-string">" </span></span><a href="http://msdn.microsoft.com/en-us/library/gg430861(v%3DPandP.40).aspx"><span class="hljs-string"><span class="hljs-string">Navigation</span></span></a><span class="hljs-string"><span class="hljs-string"> "</span></span>. <br>  MVVM  <br>        MVVM      .           -      mocking . ,   ,        . <br> <br>   <i>INotifyPropertyChanged</i> <br>   <code>INotifyPropertyChanged</code>     ,      .      ,    ;   ,   ,     ,    ,       . <br> <br>   <br> ,       ,           <code>PropertyChanged</code>  ,         .  ,    <code>ChangeTracker</code> ,     MVVM,  ,      .      .     ,    . <br> <br> <code class="cs">var changeTracker = new PropertyChangeTracker(viewModel); viewModel.CurrentState = <span class="hljs-string"><span class="hljs-string">"newState"</span></span>; CollectionAssert.Contains(changeTracker.ChangedProperties, <span class="hljs-string"><span class="hljs-string">"CurrentState"</span></span>);</code> <br> ,     ,     <code>INotifyPropertyChanged</code> ,    ,   ,     . <br> <br>      <br>        ,   ,    <code><span class="hljs-keyword"><span class="hljs-keyword">set</span></span></code>      ,           . ,     ,     ,      ,          . <br> <br> <code class="cs">var changeTracker = new PropertyChangeTracker(viewModel); var question = viewModel.Questions.First() as OpenQuestionViewModel; question.Question.Response = <span class="hljs-string"><span class="hljs-string">"some text"</span></span>; CollectionAssert.Contains(changeTracker.ChangedProperties, <span class="hljs-string"><span class="hljs-string">"UnansweredQuestions"</span></span>);</code> <br>      <br>     <code>INotifyPropertyChanged</code> ,      <code>PropertyChanged</code>        ,  ,     , , .        ,       . <br> <br>   <i>INotifyDataErrorInfo</i> <br>   ,     ,    ,   ,   <code>IDataErrorInfo</code> ,  ( Silverlight)   <code>INotifyDataErrorInfo</code> .   <code>INotifyDataErrorInfo</code>   ,         ,    ,  ,   ,    . <br> <br>       <code>INotifyDataErrorInfo</code> : ,     ,  ,     ,     <code>ErrorsChanged</code> ,      <code>GetErrors</code> , . <br> <br>    <br>     ,      ,     .       ,         <code>GetErrors</code>       ,  ,  ,   .    , ,  ,     ,        .   ,        . <br> <br> <code class="cs">//  . var notifyErrorInfo = (INotifyDataErrorInfo)question; question.Response = -<span class="hljs-number"><span class="hljs-number">15</span></span>; Assert.IsTrue(notifyErrorInfo.GetErrors(<span class="hljs-string"><span class="hljs-string">"Response"</span></span>).Cast&lt;ValidationResult&gt;().Any()); //  . var notifyErrorInfo = (INotifyDataErrorInfo)question; question.Response = <span class="hljs-number"><span class="hljs-number">15</span></span>; Assert.IsFalse(notifyErrorInfo.GetErrors(<span class="hljs-string"><span class="hljs-string">"Response"</span></span>).Cast&lt;ValidationResult&gt;().Any());</code> <br>    ,    ,             . <br> <br>    <i>INotifyDataErrorInfo</i> <br>       <code>GetErrors</code> ,   <code>INotifyDataErrorInfo</code>  ,   <code>ErrorsChanged</code>      <code>GetErrors</code> . ,  <code>HasErrors</code>      ,  . <br> <br>       <code>INotifyDataErrorInfo</code> . , ,           ,   -  .      ,        <code>INotifyDataErrorInfo</code>         (,        ). <br> <br>     ,   ,  : <br>  <code>HasErrors</code>     .              ,       .  <code>ErrorsChanged</code> ,      ,         <code>GetErrors</code> .         ( ,  )     ,           .    <code>GetErrors</code>       <code>ErrorsChanged</code> . <br>    <code>INotifyPropertyChanged</code> ,  ,    <code>NotifyDataErrorInfoTestHelper</code>    MVVM,        <code>INotifyDataErrorInfo</code> ,       .   ,   ,      ,   .      . <br> <code class="cs">var helper = new NotifyDataErrorInfoTestHelper&lt;NumericQuestion, int?&gt;( question, q =&gt; q.Response); helper.ValidatePropertyChange( <span class="hljs-number"><span class="hljs-number">6</span></span>, NotifyDataErrorInfoBehavior.Nothing); helper.ValidatePropertyChange( <span class="hljs-number"><span class="hljs-number">20</span></span>, NotifyDataErrorInfoBehavior.FiresErrorsChanged | NotifyDataErrorInfoBehavior.HasErrors | NotifyDataErrorInfoBehavior.HasErrorsForProperty); helper.ValidatePropertyChange( null, NotifyDataErrorInfoBehavior.FiresErrorsChanged | NotifyDataErrorInfoBehavior.HasErrors | NotifyDataErrorInfoBehavior.HasErrorsForProperty); helper.ValidatePropertyChange( <span class="hljs-number"><span class="hljs-number">2</span></span>, NotifyDataErrorInfoBehavior.FiresErrorsChanged);</code> <br>     <br>   MVVM,     ,  .   ,    ,         . <br> <br>  ,     ,     ,       .   ,   , ,       ,     ,   <code>IAsyncResult</code>    ,  - ,   ,    UI. <br> <br>       , , ,    .   ,     .  ,      UI,     ,   ,          ,     ,        <span class="hljs-string"><span class="hljs-string">"   UI."</span></span> <br> <br>     ,    ,    .   ,    ,     mock-, ,   ,   ,      ,          . <br> <br>           UI,    ,    .   ,     ,   ,      .        ,   .     ,    ,     . <br> <br> <code class="cs">questionnaireRepositoryMock .Setup( r =&gt; r.SubmitQuestionnaireAsync( It.IsAny&lt;Questionnaire&gt;(), It.IsAny&lt;Action&lt;IOperationResult&gt;&gt;())) .Callback&lt;Questionnaire, Action&lt;IOperationResult&gt;&gt;( (q, a) =&gt; callback = a); uiServicemock .Setup(svc =&gt; svc.ShowView(ViewNames.QuestionnaireTemplatesList)) .Callback&lt;<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>&gt;(viewName =&gt; requestedViewName = viewName); submitResultMock .Setup(sr =&gt; sr.Error) .Returns&lt;Exception&gt;(null); CompleteQuestionnaire(viewModel); viewModel.Submit(); //      UI . callback(submitResultMock.Object); //    ‚Äì     . Assert.AreEqual(ViewNames.QuestionnaireTemplatesList, requestedViewName);</code> <br> <b></b> <br>          ,        . <br>   <br>       , . <span class="hljs-string"><span class="hljs-string">"Trees in WPF"</span></span>  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ms753391.aspx">http://msdn.microsoft.com/en-us/library/ms753391.aspx</a> <br> <br>       , . <span class="hljs-string"><span class="hljs-string">"Attached Properties Overview"</span></span>  MSDN: <a href="http://msdn.microsoft.com/en-us/library/cc265152(VS.95).aspx">http://msdn.microsoft.com/en-us/library/cc265152(VS.<span class="hljs-number"><span class="hljs-number">95</span></span>).aspx</a> <br> <br>      MEF, .<span class="hljs-string"><span class="hljs-string">"Managed Extensibility Framework Overview"</span></span>  MSDN: <a href="http://msdn.microsoft.com/en-us/library/dd460648.aspx">http://msdn.microsoft.com/en-us/library/dd460648.aspx</a> . <br> <br>      Unity, .<span class="hljs-string"><span class="hljs-string">"Unity Application Block"</span></span>  MSDN: <a href="http://www.msdn.com/unity">http://www.msdn.com/unity</a> . <br> <br>      <code>DelegateCommand</code> , .Chapter <span class="hljs-number"><span class="hljs-number">5</span></span>, <span class="hljs-string"><span class="hljs-string">" </span></span><a href="http://msdn.microsoft.com/en-us/library/gg405484(v%3DPandP.40).aspx"><span class="hljs-string"><span class="hljs-string">Implementing the MVVM Pattern</span></span></a><span class="hljs-string"><span class="hljs-string"> ."</span></span> <br> <br>        Microsoft Expression Blend, .<span class="hljs-string"><span class="hljs-string">"Working with built-in behaviors"</span></span>  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ff724013(v%3DExpression.40).aspx">http://msdn.microsoft.com/en-us/library/ff724013(v=Expression.<span class="hljs-number"><span class="hljs-number">40</span></span>).aspx</a> . <br> <br>          Microsoft Expression Blend, .<span class="hljs-string"><span class="hljs-string">"Creating Custom Behaviors"</span></span>  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ff724708(v%3DExpression.40).aspx">http://msdn.microsoft.com/en-us/library/ff724708(v=Expression.<span class="hljs-number"><span class="hljs-number">40</span></span>).aspx</a> . <br> <br>            Microsoft Expression Blend, .<span class="hljs-string"><span class="hljs-string">"Creating Custom Triggers and Actions"</span></span>  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ff724707(v%3DExpression.40).aspx">http://msdn.microsoft.com/en-us/library/ff724707(v=Expression.<span class="hljs-number"><span class="hljs-number">40</span></span>).aspx</a> . <br> <br>         WPF  Silverlight, .<span class="hljs-string"><span class="hljs-string">"Threading Model"</span></span>  <span class="hljs-string"><span class="hljs-string">"The Dispatcher Class"</span></span>  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ms741870.aspx">http://msdn.microsoft.com/en-us/library/ms741870.aspx</a> <br> <a href="http://msdn.microsoft.com/en-us/library/ms615907(v%3DVS.95).aspx">http://msdn.microsoft.com/en-us/library/ms615907(v=VS.<span class="hljs-number"><span class="hljs-number">95</span></span>).aspx</a> . <br> <br>      unit-  Silverlight, .<span class="hljs-string"><span class="hljs-string">"Unit Testing with Silverlight 2"</span></span>: <a href="http://www.jeff.wilcox.name/2008/03/silverlight2-unit-testing/">http://www.jeff.wilcox.name/<span class="hljs-number"><span class="hljs-number">2008</span></span>/<span class="hljs-number"><span class="hljs-number">03</span></span>/silverlight2-unit-testing/</a> . <br> <br>         , .  <span class="hljs-string"><span class="hljs-string">" </span></span><a href="http://msdn.microsoft.com/en-us/library/gg430861(v%3DPandP.40).aspx"><span class="hljs-string"><span class="hljs-string">View-Based Navigation</span></span></a><span class="hljs-string"><span class="hljs-string"> "</span></span> in Chapter <span class="hljs-number"><span class="hljs-number">8</span></span>, <span class="hljs-string"><span class="hljs-string">" </span></span><a href="http://msdn.microsoft.com/en-us/library/gg430861(v%3DPandP.40).aspx"><span class="hljs-string"><span class="hljs-string">Navigation</span></span></a><span class="hljs-string"><span class="hljs-string"> ."</span></span> <br> <br>       ,   , .<span class="hljs-string"><span class="hljs-string">"Event-based Asynchronous Pattern Overview"</span></span>  MSDN: <a href="http://msdn.microsoft.com/en-us/library/wewwczdw.aspx">http://msdn.microsoft.com/en-us/library/wewwczdw.aspx</a> <br> <br>        <code>IAsyncResult</code> , .<span class="hljs-string"><span class="hljs-string">"Asynchronous Programming Overview"</span></span>  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ms228963.aspx">http://msdn.microsoft.com/en-us/library/ms228963.aspx</a></code></code></code></code></code></code></code></code></code> </pre> <code><code><code><code>CommandBehaviorBase ,    ,    ICommand</code> .           <code>CanExecuteChanged</code> ,          Silverlight,    WPF. <br> <br>    ,  ,   <code>CommandBehaviorBase    ,    .         ,      .         ,    .      ButtonBaseClickCommandBehavior</code> . <br> <br> <code class="cs">public class ButtonBaseClickCommandBehavior : CommandBehaviorBase&lt;ButtonBase&gt; { public ButtonBaseClickCommandBehavior(ButtonBase clickableObject) : base(clickableObject) { clickableObject.Click += OnClick; } private void OnClick(object sender, System.Windows.RoutedEventArgs e) { ExecuteCommand(); } }</code> <br>   <code>CommandBehaviorBase ,     .     ,          ,   . ,    ,    ,      , ,    CanExecute</code>  ,     . <br> <br>          ,   .           XAML.           .       .  Prism      ,       ,  ,   .       ,    . , ,  ,      <code>Click</code> ,       <code>Command</code> .    <code>Click.Command</code> ,  . <br> <br>             .             . <br> <br> <code class="cs">public static readonly DependencyProperty CommandProperty = DependencyProperty.RegisterAttached( "Command", typeof(ICommand), typeof(Click), new PropertyMetadata(OnSetCommandCallback)); private static readonly DependencyProperty ClickCommandBehaviorProperty = DependencyProperty.RegisterAttached( "ClickCommandBehavior", typeof(ButtonBaseClickCommandBehavior), typeof(Click), null);</code> <br>    <code>Command</code>    <code>ButtonBaseClickCommandBehavior</code> ,     <code>OnSetCommandCallback</code> ,     . <br> <br> <code class="cs">private static void OnSetCommandCallback(DependencyObject dependencyObject, DependencyPropertyChangedEventArgs e) { ButtonBase buttonBase = dependencyObject as ButtonBase; if (buttonBase != null) { ButtonBaseClickCommandBehavior behavior = GetOrCreateBehavior(buttonBase); behavior.Command = e.NewValue as ICommand; } } private static void OnSetCommandParameterCallback(DependencyObject dependencyObject, DependencyPropertyChangedEventArgs e) { ButtonBase buttonBase = dependencyObject as ButtonBase; if (buttonBase != null) { ButtonBaseClickCommandBehavior behavior = GetOrCreateBehavior(buttonBase); behavior.CommandParameter = e.NewValue; } } private static ButtonBaseClickCommandBehavior GetOrCreateBehavior(ButtonBase buttonBase ) { ButtonBaseClickCommandBehavior behavior = buttonBase.GetValue(ClickCommandBehaviorProperty) as ButtonBaseClickCommandBehavior; if ( behavior == null ) { behavior = new ButtonBaseClickCommandBehavior(buttonBase); buttonBase.SetValue(ClickCommandBehaviorProperty, behavior); } return behavior; }</code> <br>        ,  <a href="http://msdn.microsoft.com/en-us/library/cc265152(VS.95).aspx">Attached Properties Overview</a>  MSDN. <br> <br>    <br>              . ,     Silverlight,    -,     ,      ,     .     ,       . <br> <br>        ,    ( )  ,  ,     .  UI       ,            UI. <br> <br>      - <br>   -     ,       <code>IAsyncResult</code> .   ,  ,   ,  <code>GetQuestionnaire</code> ,   : <code>BeginGetQuestionnaire</code>  <code>EndGetQuestionnaire</code> .    ,   <code>BeginGetQuestionnaire</code> .     ,   ,   <code>EndGetQuestionnaire</code>    . <br> <b></b> <br>  .NET Framework 4.5      <code>await</code>  <code>async</code>     <code>*Async</code> .      <a href="http://msdn.microsoft.com/en-us/library/vstudio/hh391443.aspx">"Asynchronous Programming with Async and Await (C# and Visual Basic)"</a> . <br>  ,    <code>EndGetQuestionnaire</code> ,      ,  ()      <code>BeginGetQuestionnaire</code> .     ,      ,   <code>EndGetQuestionnaire</code> ,   . <br> <br> <code class="xml">IAsyncResult asyncResult = this.service.BeginGetQuestionnaire( GetQuestionnaireCompleted, null //  ,      ); private void GetQuestionnaireCompleted(IAsyncResult result) { try { questionnaire = this.service.EndGetQuestionnaire(ar); } catch (Exception ex) { //  -   . } }</code> <br>  ,     <code>End*</code> (  , <code>EndGetQuestionnaire</code> ),    ,      .      , ,          UI.     ,   ,        . <br> <br>        UI,     -,      UI,         UI,   <code>Dispatcher</code>    <code>SynchronizationContext</code> .  WPF  Silverlight,   <code>Dispatcher</code> . <br> <br>      <code>Questionnaire</code>  ,        <code>QuestionnaireView</code> .  Silverlight    <code>CheckAccess</code> ,  ,      UI.  ,     <code>BeginInvoke</code> ,      UI. <br> <br> <code class="cs">var dispatcher = System.Windows.Deployment.Current.Dispatcher; if (dispatcher.CheckAccess()) { QuestionnaireView.DataContext = questionnaire; } else { dispatcher.BeginInvoke(() =&gt; { Questionnaire.DataContext = questionnaire; }); }</code> <br> <i>MVVM RI</i>   ,    ,   <code>IAsyncResult</code> ,   .      ,                 . ,       . <br> <br> <code class="cs">this.questionnaireRepository.GetQuestionnaireAsync( result =&gt; { this.Questionnaire = result.Result; });</code> <br>  <code>result</code>   ,     , , , .    ,     . <br> <br> <code class="cs">this.questionnaireRepository.GetQuestionnaireAsync( result =&gt; { if (result.Error == null) { this.Questionnaire = result.Result; ... } else { // Handle error. } })</code> <br>     <br>        ,      .     , ,             .        ,      ,     ,     . <br> <br>         ,      MVVM,     ,   . ,  -MVVM ,     <code>MessageBox</code>   code-behind UI,      .   MVVM     ,          . <br> <br>     MVVM,              ,          .      ,    ,   ,  ,     . <br> <br>              MVVM.      ,     ,     ,  ,     .    ,         ,     ,          .       . <br> <br>    <br>                  .        ,        .  ,         .         . <br> <br>  ,         ,         ,  .      ,     .           ,       . ,        WPF  Silverlight,        . <br> <br> <img title="Using the service to interact with the user." src="https://habrastorage.org/getpro/habr/post_images/4b5/397/f2d/4b5397f2d02e5851195b29f1893be6fc.png" alt=" ,    ."> <br> <br>  ,   <code>MessageBox</code>        ,     ,    ,     . <br> <br> <code class="cs">var result = interactionService.ShowMessageBox( "Are you sure you want to cancel this operation?", "Confirm", MessageBoxButton.OK); if (result == MessageBoxResult.Yes) { CancelRequest(); }</code> <br> ,      - ,      ,         Silverlight.         .             .     . <br> <br> <code class="cs">interactionService.ShowMessageBox( "Are you sure you want to cancel this operation?", "Confirm", MessageBoxButton.OK, result =&gt; { if (result == MessageBoxResult.Yes) { CancelRequest(); } });</code> <br>         ,      . ,  WPF    <code>MessageBox</code> ,       ;    Silverlight    ,    . <br> <br>     <br>         ‚Äì             .         ,      .     ,     .        ,        ,   ,     . <br> <br> <img title="Using interaction request objects." src="https://habrastorage.org/getpro/habr/post_images/3d0/ff0/1c5/3d0ff01c5518558c2d3c5c5f47ce0ce9.png" alt="   ."> <br> <br>    ,   ,          ‚Äì       ,      ,   ‚Äì     .   ,        ,    ,    UI            . <br> <br>       MVVM,     ,       ,         .         ,        ,    ,   . <br> <br>  Prism       <code>IInteractionRequest</code>   <code><code>InteractionRequest .  IInteractionRequest</code>  ,   .           ,   .  <code><code>InteractionRequest   IInteractionRequest</code>     <code>Raise</code> ,           , , ,   . <br> <br>       <br>  <code><code>InteractionRequest          .  Raise</code>          ( <code>T</code> )    ,    ,   .          ,       .      ,        .    ,  ,     . <br> <code class="cs">public interface IInteractionRequest { event EventHandler&lt;InteractionRequestedEventArgs&gt; Raised; } public class InteractionRequest&lt;T&gt; : IInteractionRequest { public event EventHandler&lt;InteractionRequestedEventArgs&gt; Raised; public void Raise(T context, Action&lt;T&gt; callback) { var handler = this.Raised; if (handler != null) { handler( this, new InteractionRequestedEventArgs(context, () =&gt; callback(context))); } } }</code> <br> Prism    ,      .  <code>Notification</code>       .    ,            .     ‚Äì <code>Title</code>  <code>Content</code> ,    .  ,   ,  ,  ,        . <br> <br>  <code>Confirmation</code>    <code>Notification</code>     ‚Äì <code>Confirmed</code> ,  ,  ,      .  <code>Confirmation</code> ,     <code>MessageBox</code> ,     /  .     ,     <code>Notification</code> ,     ,      . <br> <br>    <code><code><code>InteractionRequest ,       InteractionRequest      ,      .      ,    Raise</code> ,    , ,   . <br> <br> <code class="cs">public IInteractionRequest ConfirmCancelInteractionRequest { get { return this.confirmCancelInteractionRequest; } } this.confirmCancelInteractionRequest.Raise( new Confirmation("Are you sure you wish to cancel?"), confirmation =&gt; { if (confirmation.Confirmed) { this.NavigateToQuestionnaireList(); } }); }</code> <br> <i>MVVM Reference Implementation (MVVM RI)</i> ,    <code>IInteractionRequest</code>   <code><code>InteractionRequest ,          (. QuestionnaireViewModel.cs</code> ). <br> <br>        <br>       ,       .   ,       .    UI             . <br> <br>                . Microsoft Expression Blend Behaviors Framework     .  ,     ,    . <br> <br>  <code>EventTrigger</code> ,  Expression Blend,  ,      ,     ,   . , Prism   <code>EventTrigger</code> ,  <code>InteractionRequestTrigger</code> ,      <code>Raised</code>   <code>IInteractionRequest</code> .    XAML        . <br> <br>  ,   , <code>InteractionRequestTrigger</code>   .  Silverlight Prism   <code>PopupChildWindowAction</code> ,     .    ,         .   <code>ContentTemplate</code>  <code>PopupChildWindowAction</code> ,    ,    UI,      <code>Content</code>  .       <code>Title</code>  . <br> <b></b> <br>  ,    ,   <code>PopupChildWindowAction</code> ,     .    <code>Notification</code>  <code>NotificationChildWindow</code> ,        <code>Confirmation</code> ‚Äì <code>ConfirmationChildWindow</code> . <code>NotificationChildWindow</code>    ,   ,     <code>ConfirmationChildWindow</code>    <i>OK</i>  <i>Cancel</i> ,    .    ,   ,   <code>ChildWindow</code>  <code>PopupChildWindowAction</code> . <br>   ,  <code>InteractionRequestTrigger</code>  <code>PopupChildWindowAction</code> ,       <i>RI MVVM</i> . <br> <br> <code class="xml">&lt;i:Interaction.Triggers&gt; &lt;prism:InteractionRequestTrigger SourceObject="{Binding ConfirmCancelInteractionRequest}"&gt; &lt;prism:PopupChildWindowAction ContentTemplate="{StaticResource ConfirmWindowTemplate}"/&gt; &lt;/prism:InteractionRequestTrigger&gt; &lt;/i:Interaction.Triggers&gt; &lt;UserControl.Resources&gt; &lt;DataTemplate x:Key="ConfirmWindowTemplate"&gt; &lt;Grid MinWidth="250" MinHeight="100"&gt; &lt;TextBlock TextWrapping="Wrap" Grid.Row="0" Text="{Binding}"/&gt; &lt;/Grid&gt; &lt;/DataTemplate&gt; &lt;/UserControl.Resources&gt;</code> <br> <b></b> <br>      <code>ContentTemplate</code> ,   UI   <code>Content</code>  .    <code>Content</code>  ,  , <code>TextBlock</code>     <code>Content</code> . <br>      ,     ,    ,    .  ,     ,       ,     ,    .   ,   <i>RI MVVM</i> ,         <code>Confirmed</code>    <code>Confirmation</code>  <code>true</code> ,     OK. <br> <br>        ,     .  Prism <code>InteractionRequestTrigger</code>   <code>PopupChildWindowAction</code>            . <br> <br>     <br>     MVVM,       , ,    ,         .        (  , ,  ,   ).    ,  ,  ,            . <br> <br>        ,         . Managed Extensibility Framework (MEF)  Unity Application Block (Unity)      ,  ,           . <br> <br>  ,       , , ,    ( )      . ,       ,     .  ,     ,       . <br> <br>     ,  MEF <br>  MEF,       ,   <code>Import</code> ,      ,  ,   <code>Export</code> .         ,    . <br> <br> , <code>QuestionnaireView</code>   <i>RI MVVM</i> ,        ,    <code>Import</code> .   , MEF           .  <code>set</code>        ,   . <br> <br> <code class="cs">[Import] public QuestionnaireViewModel ViewModel { set { this.DataContext = value; } }</code> <br>     ,   . <br> <br> <code class="cs">[Export] public class QuestionnaireViewModel : NotificationObject { ... }</code> <br>        ,   . <br> <br> <code class="cs">public QuestionnaireView() { InitializeComponent(); } [ImportingConstructor] public QuestionnaireView(QuestionnaireViewModel viewModel) : this() { this.DataContext = viewModel; }</code> <br> <b></b> <br>          MEF,   Unity.   ,     ,        .   ,   Visual Studio  Expression Blend, ,        ,     .   ,   ,  ,      ,          <code>InitializeComponent</code> . <br>     ,  Unity <br>  Unity,    ,   MEF.     ,      .    ,         .  ,      . <br> <br>  ,      ,  ,         . ,           ,   . <br> <br> <code class="cs">public QuestionnaireView() { InitializeComponent(); } public QuestionnaireView(QuestionnaireViewModel viewModel) : this() { this.DataContext = viewModel; }</code> <br> <b></b> <br>    ,        ,   Visual Studio  Expression Blend. <br>  ,          ,   . Unity        <code>set</code>   ,   . <br> <br> <code class="cs">public QuestionnaireView() { InitializeComponent(); } [Dependency] public QuestionnaireViewModel ViewModel { set { this.DataContext = value; } }</code> <br>       Unity. <br> <br> <code class="cs">container.RegisterType&lt;QuestionnaireViewModel&gt;();</code> <br>  ,     . <br> <br> <code class="cs">var view = container.Resolve&lt;QuestionnaireView&gt;();</code> <br>     ,    <br>   ,     ,        .        ,   MEF  Unity,        . <br> <br>          .   ,         UI,           . <br> <br> , <i>RI MVVM</i>   ,   ,        .   ,    .      <code>ShowView</code>   UI. <br> <br> <code class="cs">private void NavigateToQuestionnaireList() { //     "questionnaire list". this.uiService.ShowView(ViewNames.QuestionnaireTemplatesList); }</code> <br>  UI      UI .           UI.  <code>ShowView</code>  <code>UIService</code>      (,          ),       ,   . <br> <br> <code class="cs">public void ShowView(string viewName) { var view = this.ViewFactory.GetView(viewName); this.MainWindow.CurrentView = view; }</code> <br> <b></b> <br> Prism       .   ,   ,   ,             .    ,  , " <a href="http://msdn.microsoft.com/en-us/library/gg430861(v%3DPandP.40).aspx">View-Based Navigation</a> "   8, " <a href="http://msdn.microsoft.com/en-us/library/gg430861(v%3DPandP.40).aspx">Navigation</a> ". <br>  MVVM  <br>        MVVM      .           -      mocking . ,   ,        . <br> <br>   <i>INotifyPropertyChanged</i> <br>   <code>INotifyPropertyChanged</code>     ,      .      ,    ;   ,   ,     ,    ,       . <br> <br>   <br> ,       ,           <code>PropertyChanged</code>  ,         .  ,    <code>ChangeTracker</code> ,     MVVM,  ,      .      .     ,    . <br> <br> <code class="cs">var changeTracker = new PropertyChangeTracker(viewModel); viewModel.CurrentState = "newState"; CollectionAssert.Contains(changeTracker.ChangedProperties, "CurrentState");</code> <br> ,     ,     <code>INotifyPropertyChanged</code> ,    ,   ,     . <br> <br>      <br>        ,   ,    <code>set</code>      ,           . ,     ,     ,      ,          . <br> <br> <code class="cs">var changeTracker = new PropertyChangeTracker(viewModel); var question = viewModel.Questions.First() as OpenQuestionViewModel; question.Question.Response = "some text"; CollectionAssert.Contains(changeTracker.ChangedProperties, "UnansweredQuestions");</code> <br>      <br>     <code>INotifyPropertyChanged</code> ,      <code>PropertyChanged</code>        ,  ,     , , .        ,       . <br> <br>   <i>INotifyDataErrorInfo</i> <br>   ,     ,    ,   ,   <code>IDataErrorInfo</code> ,  ( Silverlight)   <code>INotifyDataErrorInfo</code> .   <code>INotifyDataErrorInfo</code>   ,         ,    ,  ,   ,    . <br> <br>       <code>INotifyDataErrorInfo</code> : ,     ,  ,     ,     <code>ErrorsChanged</code> ,      <code>GetErrors</code> , . <br> <br>    <br>     ,      ,     .       ,         <code>GetErrors</code>       ,  ,  ,   .    , ,  ,     ,        .   ,        . <br> <br> <code class="cs">//  . var notifyErrorInfo = (INotifyDataErrorInfo)question; question.Response = -15; Assert.IsTrue(notifyErrorInfo.GetErrors("Response").Cast&lt;ValidationResult&gt;().Any()); //  . var notifyErrorInfo = (INotifyDataErrorInfo)question; question.Response = 15; Assert.IsFalse(notifyErrorInfo.GetErrors("Response").Cast&lt;ValidationResult&gt;().Any());</code> <br>    ,    ,             . <br> <br>    <i>INotifyDataErrorInfo</i> <br>       <code>GetErrors</code> ,   <code>INotifyDataErrorInfo</code>  ,   <code>ErrorsChanged</code>      <code>GetErrors</code> . ,  <code>HasErrors</code>      ,  . <br> <br>       <code>INotifyDataErrorInfo</code> . , ,           ,   -  .      ,        <code>INotifyDataErrorInfo</code>         (,        ). <br> <br>     ,   ,  : <br>  <code>HasErrors</code>     .              ,       .  <code>ErrorsChanged</code> ,      ,         <code>GetErrors</code> .         ( ,  )     ,           .    <code>GetErrors</code>       <code>ErrorsChanged</code> . <br>    <code>INotifyPropertyChanged</code> ,  ,    <code>NotifyDataErrorInfoTestHelper</code>    MVVM,        <code>INotifyDataErrorInfo</code> ,       .   ,   ,      ,   .      . <br> <code class="cs">var helper = new NotifyDataErrorInfoTestHelper&lt;NumericQuestion, int?&gt;( question, q =&gt; q.Response); helper.ValidatePropertyChange( 6, NotifyDataErrorInfoBehavior.Nothing); helper.ValidatePropertyChange( 20, NotifyDataErrorInfoBehavior.FiresErrorsChanged | NotifyDataErrorInfoBehavior.HasErrors | NotifyDataErrorInfoBehavior.HasErrorsForProperty); helper.ValidatePropertyChange( null, NotifyDataErrorInfoBehavior.FiresErrorsChanged | NotifyDataErrorInfoBehavior.HasErrors | NotifyDataErrorInfoBehavior.HasErrorsForProperty); helper.ValidatePropertyChange( 2, NotifyDataErrorInfoBehavior.FiresErrorsChanged);</code> <br>     <br>   MVVM,     ,  .   ,    ,         . <br> <br>  ,     ,     ,       .   ,   , ,       ,     ,   <code>IAsyncResult</code>    ,  - ,   ,    UI. <br> <br>       , , ,    .   ,     .  ,      UI,     ,   ,          ,     ,        "   UI." <br> <br>     ,    ,    .   ,    ,     mock-, ,   ,   ,      ,          . <br> <br>           UI,    ,    .   ,     ,   ,      .        ,   .     ,    ,     . <br> <br> <code class="cs">questionnaireRepositoryMock .Setup( r =&gt; r.SubmitQuestionnaireAsync( It.IsAny&lt;Questionnaire&gt;(), It.IsAny&lt;Action&lt;IOperationResult&gt;&gt;())) .Callback&lt;Questionnaire, Action&lt;IOperationResult&gt;&gt;( (q, a) =&gt; callback = a); uiServicemock .Setup(svc =&gt; svc.ShowView(ViewNames.QuestionnaireTemplatesList)) .Callback&lt;string&gt;(viewName =&gt; requestedViewName = viewName); submitResultMock .Setup(sr =&gt; sr.Error) .Returns&lt;Exception&gt;(null); CompleteQuestionnaire(viewModel); viewModel.Submit(); //      UI . callback(submitResultMock.Object); //    ‚Äì     . Assert.AreEqual(ViewNames.QuestionnaireTemplatesList, requestedViewName);</code> <br> <b></b> <br>          ,        . <br>   <br>       , . "Trees in WPF"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ms753391.aspx">http://msdn.microsoft.com/en-us/library/ms753391.aspx</a> <br> <br>       , . "Attached Properties Overview"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/cc265152(VS.95).aspx">http://msdn.microsoft.com/en-us/library/cc265152(VS.95).aspx</a> <br> <br>      MEF, ."Managed Extensibility Framework Overview"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/dd460648.aspx">http://msdn.microsoft.com/en-us/library/dd460648.aspx</a> . <br> <br>      Unity, ."Unity Application Block"  MSDN: <a href="http://www.msdn.com/unity">http://www.msdn.com/unity</a> . <br> <br>      <code>DelegateCommand</code> , .Chapter 5, " <a href="http://msdn.microsoft.com/en-us/library/gg405484(v%3DPandP.40).aspx">Implementing the MVVM Pattern</a> ." <br> <br>        Microsoft Expression Blend, ."Working with built-in behaviors"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ff724013(v%3DExpression.40).aspx">http://msdn.microsoft.com/en-us/library/ff724013(v=Expression.40).aspx</a> . <br> <br>          Microsoft Expression Blend, ."Creating Custom Behaviors"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ff724708(v%3DExpression.40).aspx">http://msdn.microsoft.com/en-us/library/ff724708(v=Expression.40).aspx</a> . <br> <br>            Microsoft Expression Blend, ."Creating Custom Triggers and Actions"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ff724707(v%3DExpression.40).aspx">http://msdn.microsoft.com/en-us/library/ff724707(v=Expression.40).aspx</a> . <br> <br>         WPF  Silverlight, ."Threading Model"  "The Dispatcher Class"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ms741870.aspx">http://msdn.microsoft.com/en-us/library/ms741870.aspx</a> <br> <a href="http://msdn.microsoft.com/en-us/library/ms615907(v%3DVS.95).aspx">http://msdn.microsoft.com/en-us/library/ms615907(v=VS.95).aspx</a> . <br> <br>      unit-  Silverlight, ."Unit Testing with Silverlight 2": <a href="http://www.jeff.wilcox.name/2008/03/silverlight2-unit-testing/">http://www.jeff.wilcox.name/2008/03/silverlight2-unit-testing/</a> . <br> <br>         , .  " <a href="http://msdn.microsoft.com/en-us/library/gg430861(v%3DPandP.40).aspx">View-Based Navigation</a> " in Chapter 8, " <a href="http://msdn.microsoft.com/en-us/library/gg430861(v%3DPandP.40).aspx">Navigation</a> ." <br> <br>       ,   , ."Event-based Asynchronous Pattern Overview"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/wewwczdw.aspx">http://msdn.microsoft.com/en-us/library/wewwczdw.aspx</a> <br> <br>        <code>IAsyncResult</code> , ."Asynchronous Programming Overview"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ms228963.aspx">http://msdn.microsoft.com/en-us/library/ms228963.aspx</a></code></code></code></code></code></code></code></code></code> <h3> <code><code><code><code>CommandBehaviorBase ,    ,    ICommand</code> .           <code>CanExecuteChanged</code> ,          Silverlight,    WPF. <br> <br>    ,  ,   <code>CommandBehaviorBase    ,    .         ,      .         ,    .      ButtonBaseClickCommandBehavior</code> . <br> <br> <code class="cs">public class ButtonBaseClickCommandBehavior : CommandBehaviorBase&lt;ButtonBase&gt; { public ButtonBaseClickCommandBehavior(ButtonBase clickableObject) : base(clickableObject) { clickableObject.Click += OnClick; } private void OnClick(object sender, System.Windows.RoutedEventArgs e) { ExecuteCommand(); } }</code> <br>   <code>CommandBehaviorBase ,     .     ,          ,   . ,    ,    ,      , ,    CanExecute</code>  ,     . <br> <br>          ,   .           XAML.           .       .  Prism      ,       ,  ,   .       ,    . , ,  ,      <code>Click</code> ,       <code>Command</code> .    <code>Click.Command</code> ,  . <br> <br>             .             . <br> <br> <code class="cs">public static readonly DependencyProperty CommandProperty = DependencyProperty.RegisterAttached( "Command", typeof(ICommand), typeof(Click), new PropertyMetadata(OnSetCommandCallback)); private static readonly DependencyProperty ClickCommandBehaviorProperty = DependencyProperty.RegisterAttached( "ClickCommandBehavior", typeof(ButtonBaseClickCommandBehavior), typeof(Click), null);</code> <br>    <code>Command</code>    <code>ButtonBaseClickCommandBehavior</code> ,     <code>OnSetCommandCallback</code> ,     . <br> <br> <code class="cs">private static void OnSetCommandCallback(DependencyObject dependencyObject, DependencyPropertyChangedEventArgs e) { ButtonBase buttonBase = dependencyObject as ButtonBase; if (buttonBase != null) { ButtonBaseClickCommandBehavior behavior = GetOrCreateBehavior(buttonBase); behavior.Command = e.NewValue as ICommand; } } private static void OnSetCommandParameterCallback(DependencyObject dependencyObject, DependencyPropertyChangedEventArgs e) { ButtonBase buttonBase = dependencyObject as ButtonBase; if (buttonBase != null) { ButtonBaseClickCommandBehavior behavior = GetOrCreateBehavior(buttonBase); behavior.CommandParameter = e.NewValue; } } private static ButtonBaseClickCommandBehavior GetOrCreateBehavior(ButtonBase buttonBase ) { ButtonBaseClickCommandBehavior behavior = buttonBase.GetValue(ClickCommandBehaviorProperty) as ButtonBaseClickCommandBehavior; if ( behavior == null ) { behavior = new ButtonBaseClickCommandBehavior(buttonBase); buttonBase.SetValue(ClickCommandBehaviorProperty, behavior); } return behavior; }</code> <br>        ,  <a href="http://msdn.microsoft.com/en-us/library/cc265152(VS.95).aspx">Attached Properties Overview</a>  MSDN. <br> <br>    <br>              . ,     Silverlight,    -,     ,      ,     .     ,       . <br> <br>        ,    ( )  ,  ,     .  UI       ,            UI. <br> <br>      - <br>   -     ,       <code>IAsyncResult</code> .   ,  ,   ,  <code>GetQuestionnaire</code> ,   : <code>BeginGetQuestionnaire</code>  <code>EndGetQuestionnaire</code> .    ,   <code>BeginGetQuestionnaire</code> .     ,   ,   <code>EndGetQuestionnaire</code>    . <br> <b></b> <br>  .NET Framework 4.5      <code>await</code>  <code>async</code>     <code>*Async</code> .      <a href="http://msdn.microsoft.com/en-us/library/vstudio/hh391443.aspx">"Asynchronous Programming with Async and Await (C# and Visual Basic)"</a> . <br>  ,    <code>EndGetQuestionnaire</code> ,      ,  ()      <code>BeginGetQuestionnaire</code> .     ,      ,   <code>EndGetQuestionnaire</code> ,   . <br> <br> <code class="xml">IAsyncResult asyncResult = this.service.BeginGetQuestionnaire( GetQuestionnaireCompleted, null //  ,      ); private void GetQuestionnaireCompleted(IAsyncResult result) { try { questionnaire = this.service.EndGetQuestionnaire(ar); } catch (Exception ex) { //  -   . } }</code> <br>  ,     <code>End*</code> (  , <code>EndGetQuestionnaire</code> ),    ,      .      , ,          UI.     ,   ,        . <br> <br>        UI,     -,      UI,         UI,   <code>Dispatcher</code>    <code>SynchronizationContext</code> .  WPF  Silverlight,   <code>Dispatcher</code> . <br> <br>      <code>Questionnaire</code>  ,        <code>QuestionnaireView</code> .  Silverlight    <code>CheckAccess</code> ,  ,      UI.  ,     <code>BeginInvoke</code> ,      UI. <br> <br> <code class="cs">var dispatcher = System.Windows.Deployment.Current.Dispatcher; if (dispatcher.CheckAccess()) { QuestionnaireView.DataContext = questionnaire; } else { dispatcher.BeginInvoke(() =&gt; { Questionnaire.DataContext = questionnaire; }); }</code> <br> <i>MVVM RI</i>   ,    ,   <code>IAsyncResult</code> ,   .      ,                 . ,       . <br> <br> <code class="cs">this.questionnaireRepository.GetQuestionnaireAsync( result =&gt; { this.Questionnaire = result.Result; });</code> <br>  <code>result</code>   ,     , , , .    ,     . <br> <br> <code class="cs">this.questionnaireRepository.GetQuestionnaireAsync( result =&gt; { if (result.Error == null) { this.Questionnaire = result.Result; ... } else { // Handle error. } })</code> <br>     <br>        ,      .     , ,             .        ,      ,     ,     . <br> <br>         ,      MVVM,     ,   . ,  -MVVM ,     <code>MessageBox</code>   code-behind UI,      .   MVVM     ,          . <br> <br>     MVVM,              ,          .      ,    ,   ,  ,     . <br> <br>              MVVM.      ,     ,     ,  ,     .    ,         ,     ,          .       . <br> <br>    <br>                  .        ,        .  ,         .         . <br> <br>  ,         ,         ,  .      ,     .           ,       . ,        WPF  Silverlight,        . <br> <br> <img title="Using the service to interact with the user." src="https://habrastorage.org/getpro/habr/post_images/4b5/397/f2d/4b5397f2d02e5851195b29f1893be6fc.png" alt=" ,    ."> <br> <br>  ,   <code>MessageBox</code>        ,     ,    ,     . <br> <br> <code class="cs">var result = interactionService.ShowMessageBox( "Are you sure you want to cancel this operation?", "Confirm", MessageBoxButton.OK); if (result == MessageBoxResult.Yes) { CancelRequest(); }</code> <br> ,      - ,      ,         Silverlight.         .             .     . <br> <br> <code class="cs">interactionService.ShowMessageBox( "Are you sure you want to cancel this operation?", "Confirm", MessageBoxButton.OK, result =&gt; { if (result == MessageBoxResult.Yes) { CancelRequest(); } });</code> <br>         ,      . ,  WPF    <code>MessageBox</code> ,       ;    Silverlight    ,    . <br> <br>     <br>         ‚Äì             .         ,      .     ,     .        ,        ,   ,     . <br> <br> <img title="Using interaction request objects." src="https://habrastorage.org/getpro/habr/post_images/3d0/ff0/1c5/3d0ff01c5518558c2d3c5c5f47ce0ce9.png" alt="   ."> <br> <br>    ,   ,          ‚Äì       ,      ,   ‚Äì     .   ,        ,    ,    UI            . <br> <br>       MVVM,     ,       ,         .         ,        ,    ,   . <br> <br>  Prism       <code>IInteractionRequest</code>   <code><code>InteractionRequest .  IInteractionRequest</code>  ,   .           ,   .  <code><code>InteractionRequest   IInteractionRequest</code>     <code>Raise</code> ,           , , ,   . <br> <br>       <br>  <code><code>InteractionRequest          .  Raise</code>          ( <code>T</code> )    ,    ,   .          ,       .      ,        .    ,  ,     . <br> <code class="cs">public interface IInteractionRequest { event EventHandler&lt;InteractionRequestedEventArgs&gt; Raised; } public class InteractionRequest&lt;T&gt; : IInteractionRequest { public event EventHandler&lt;InteractionRequestedEventArgs&gt; Raised; public void Raise(T context, Action&lt;T&gt; callback) { var handler = this.Raised; if (handler != null) { handler( this, new InteractionRequestedEventArgs(context, () =&gt; callback(context))); } } }</code> <br> Prism    ,      .  <code>Notification</code>       .    ,            .     ‚Äì <code>Title</code>  <code>Content</code> ,    .  ,   ,  ,  ,        . <br> <br>  <code>Confirmation</code>    <code>Notification</code>     ‚Äì <code>Confirmed</code> ,  ,  ,      .  <code>Confirmation</code> ,     <code>MessageBox</code> ,     /  .     ,     <code>Notification</code> ,     ,      . <br> <br>    <code><code><code>InteractionRequest ,       InteractionRequest      ,      .      ,    Raise</code> ,    , ,   . <br> <br> <code class="cs">public IInteractionRequest ConfirmCancelInteractionRequest { get { return this.confirmCancelInteractionRequest; } } this.confirmCancelInteractionRequest.Raise( new Confirmation("Are you sure you wish to cancel?"), confirmation =&gt; { if (confirmation.Confirmed) { this.NavigateToQuestionnaireList(); } }); }</code> <br> <i>MVVM Reference Implementation (MVVM RI)</i> ,    <code>IInteractionRequest</code>   <code><code>InteractionRequest ,          (. QuestionnaireViewModel.cs</code> ). <br> <br>        <br>       ,       .   ,       .    UI             . <br> <br>                . Microsoft Expression Blend Behaviors Framework     .  ,     ,    . <br> <br>  <code>EventTrigger</code> ,  Expression Blend,  ,      ,     ,   . , Prism   <code>EventTrigger</code> ,  <code>InteractionRequestTrigger</code> ,      <code>Raised</code>   <code>IInteractionRequest</code> .    XAML        . <br> <br>  ,   , <code>InteractionRequestTrigger</code>   .  Silverlight Prism   <code>PopupChildWindowAction</code> ,     .    ,         .   <code>ContentTemplate</code>  <code>PopupChildWindowAction</code> ,    ,    UI,      <code>Content</code>  .       <code>Title</code>  . <br> <b></b> <br>  ,    ,   <code>PopupChildWindowAction</code> ,     .    <code>Notification</code>  <code>NotificationChildWindow</code> ,        <code>Confirmation</code> ‚Äì <code>ConfirmationChildWindow</code> . <code>NotificationChildWindow</code>    ,   ,     <code>ConfirmationChildWindow</code>    <i>OK</i>  <i>Cancel</i> ,    .    ,   ,   <code>ChildWindow</code>  <code>PopupChildWindowAction</code> . <br>   ,  <code>InteractionRequestTrigger</code>  <code>PopupChildWindowAction</code> ,       <i>RI MVVM</i> . <br> <br> <code class="xml">&lt;i:Interaction.Triggers&gt; &lt;prism:InteractionRequestTrigger SourceObject="{Binding ConfirmCancelInteractionRequest}"&gt; &lt;prism:PopupChildWindowAction ContentTemplate="{StaticResource ConfirmWindowTemplate}"/&gt; &lt;/prism:InteractionRequestTrigger&gt; &lt;/i:Interaction.Triggers&gt; &lt;UserControl.Resources&gt; &lt;DataTemplate x:Key="ConfirmWindowTemplate"&gt; &lt;Grid MinWidth="250" MinHeight="100"&gt; &lt;TextBlock TextWrapping="Wrap" Grid.Row="0" Text="{Binding}"/&gt; &lt;/Grid&gt; &lt;/DataTemplate&gt; &lt;/UserControl.Resources&gt;</code> <br> <b></b> <br>      <code>ContentTemplate</code> ,   UI   <code>Content</code>  .    <code>Content</code>  ,  , <code>TextBlock</code>     <code>Content</code> . <br>      ,     ,    ,    .  ,     ,       ,     ,    .   ,   <i>RI MVVM</i> ,         <code>Confirmed</code>    <code>Confirmation</code>  <code>true</code> ,     OK. <br> <br>        ,     .  Prism <code>InteractionRequestTrigger</code>   <code>PopupChildWindowAction</code>            . <br> <br>     <br>     MVVM,       , ,    ,         .        (  , ,  ,   ).    ,  ,  ,            . <br> <br>        ,         . Managed Extensibility Framework (MEF)  Unity Application Block (Unity)      ,  ,           . <br> <br>  ,       , , ,    ( )      . ,       ,     .  ,     ,       . <br> <br>     ,  MEF <br>  MEF,       ,   <code>Import</code> ,      ,  ,   <code>Export</code> .         ,    . <br> <br> , <code>QuestionnaireView</code>   <i>RI MVVM</i> ,        ,    <code>Import</code> .   , MEF           .  <code>set</code>        ,   . <br> <br> <code class="cs">[Import] public QuestionnaireViewModel ViewModel { set { this.DataContext = value; } }</code> <br>     ,   . <br> <br> <code class="cs">[Export] public class QuestionnaireViewModel : NotificationObject { ... }</code> <br>        ,   . <br> <br> <code class="cs">public QuestionnaireView() { InitializeComponent(); } [ImportingConstructor] public QuestionnaireView(QuestionnaireViewModel viewModel) : this() { this.DataContext = viewModel; }</code> <br> <b></b> <br>          MEF,   Unity.   ,     ,        .   ,   Visual Studio  Expression Blend, ,        ,     .   ,   ,  ,      ,          <code>InitializeComponent</code> . <br>     ,  Unity <br>  Unity,    ,   MEF.     ,      .    ,         .  ,      . <br> <br>  ,      ,  ,         . ,           ,   . <br> <br> <code class="cs">public QuestionnaireView() { InitializeComponent(); } public QuestionnaireView(QuestionnaireViewModel viewModel) : this() { this.DataContext = viewModel; }</code> <br> <b></b> <br>    ,        ,   Visual Studio  Expression Blend. <br>  ,          ,   . Unity        <code>set</code>   ,   . <br> <br> <code class="cs">public QuestionnaireView() { InitializeComponent(); } [Dependency] public QuestionnaireViewModel ViewModel { set { this.DataContext = value; } }</code> <br>       Unity. <br> <br> <code class="cs">container.RegisterType&lt;QuestionnaireViewModel&gt;();</code> <br>  ,     . <br> <br> <code class="cs">var view = container.Resolve&lt;QuestionnaireView&gt;();</code> <br>     ,    <br>   ,     ,        .        ,   MEF  Unity,        . <br> <br>          .   ,         UI,           . <br> <br> , <i>RI MVVM</i>   ,   ,        .   ,    .      <code>ShowView</code>   UI. <br> <br> <code class="cs">private void NavigateToQuestionnaireList() { //     "questionnaire list". this.uiService.ShowView(ViewNames.QuestionnaireTemplatesList); }</code> <br>  UI      UI .           UI.  <code>ShowView</code>  <code>UIService</code>      (,          ),       ,   . <br> <br> <code class="cs">public void ShowView(string viewName) { var view = this.ViewFactory.GetView(viewName); this.MainWindow.CurrentView = view; }</code> <br> <b></b> <br> Prism       .   ,   ,   ,             .    ,  , " <a href="http://msdn.microsoft.com/en-us/library/gg430861(v%3DPandP.40).aspx">View-Based Navigation</a> "   8, " <a href="http://msdn.microsoft.com/en-us/library/gg430861(v%3DPandP.40).aspx">Navigation</a> ". <br>  MVVM  <br>        MVVM      .           -      mocking . ,   ,        . <br> <br>   <i>INotifyPropertyChanged</i> <br>   <code>INotifyPropertyChanged</code>     ,      .      ,    ;   ,   ,     ,    ,       . <br> <br>   <br> ,       ,           <code>PropertyChanged</code>  ,         .  ,    <code>ChangeTracker</code> ,     MVVM,  ,      .      .     ,    . <br> <br> <code class="cs">var changeTracker = new PropertyChangeTracker(viewModel); viewModel.CurrentState = "newState"; CollectionAssert.Contains(changeTracker.ChangedProperties, "CurrentState");</code> <br> ,     ,     <code>INotifyPropertyChanged</code> ,    ,   ,     . <br> <br>      <br>        ,   ,    <code>set</code>      ,           . ,     ,     ,      ,          . <br> <br> <code class="cs">var changeTracker = new PropertyChangeTracker(viewModel); var question = viewModel.Questions.First() as OpenQuestionViewModel; question.Question.Response = "some text"; CollectionAssert.Contains(changeTracker.ChangedProperties, "UnansweredQuestions");</code> <br>      <br>     <code>INotifyPropertyChanged</code> ,      <code>PropertyChanged</code>        ,  ,     , , .        ,       . <br> <br>   <i>INotifyDataErrorInfo</i> <br>   ,     ,    ,   ,   <code>IDataErrorInfo</code> ,  ( Silverlight)   <code>INotifyDataErrorInfo</code> .   <code>INotifyDataErrorInfo</code>   ,         ,    ,  ,   ,    . <br> <br>       <code>INotifyDataErrorInfo</code> : ,     ,  ,     ,     <code>ErrorsChanged</code> ,      <code>GetErrors</code> , . <br> <br>    <br>     ,      ,     .       ,         <code>GetErrors</code>       ,  ,  ,   .    , ,  ,     ,        .   ,        . <br> <br> <code class="cs">//  . var notifyErrorInfo = (INotifyDataErrorInfo)question; question.Response = -15; Assert.IsTrue(notifyErrorInfo.GetErrors("Response").Cast&lt;ValidationResult&gt;().Any()); //  . var notifyErrorInfo = (INotifyDataErrorInfo)question; question.Response = 15; Assert.IsFalse(notifyErrorInfo.GetErrors("Response").Cast&lt;ValidationResult&gt;().Any());</code> <br>    ,    ,             . <br> <br>    <i>INotifyDataErrorInfo</i> <br>       <code>GetErrors</code> ,   <code>INotifyDataErrorInfo</code>  ,   <code>ErrorsChanged</code>      <code>GetErrors</code> . ,  <code>HasErrors</code>      ,  . <br> <br>       <code>INotifyDataErrorInfo</code> . , ,           ,   -  .      ,        <code>INotifyDataErrorInfo</code>         (,        ). <br> <br>     ,   ,  : <br>  <code>HasErrors</code>     .              ,       .  <code>ErrorsChanged</code> ,      ,         <code>GetErrors</code> .         ( ,  )     ,           .    <code>GetErrors</code>       <code>ErrorsChanged</code> . <br>    <code>INotifyPropertyChanged</code> ,  ,    <code>NotifyDataErrorInfoTestHelper</code>    MVVM,        <code>INotifyDataErrorInfo</code> ,       .   ,   ,      ,   .      . <br> <code class="cs">var helper = new NotifyDataErrorInfoTestHelper&lt;NumericQuestion, int?&gt;( question, q =&gt; q.Response); helper.ValidatePropertyChange( 6, NotifyDataErrorInfoBehavior.Nothing); helper.ValidatePropertyChange( 20, NotifyDataErrorInfoBehavior.FiresErrorsChanged | NotifyDataErrorInfoBehavior.HasErrors | NotifyDataErrorInfoBehavior.HasErrorsForProperty); helper.ValidatePropertyChange( null, NotifyDataErrorInfoBehavior.FiresErrorsChanged | NotifyDataErrorInfoBehavior.HasErrors | NotifyDataErrorInfoBehavior.HasErrorsForProperty); helper.ValidatePropertyChange( 2, NotifyDataErrorInfoBehavior.FiresErrorsChanged);</code> <br>     <br>   MVVM,     ,  .   ,    ,         . <br> <br>  ,     ,     ,       .   ,   , ,       ,     ,   <code>IAsyncResult</code>    ,  - ,   ,    UI. <br> <br>       , , ,    .   ,     .  ,      UI,     ,   ,          ,     ,        "   UI." <br> <br>     ,    ,    .   ,    ,     mock-, ,   ,   ,      ,          . <br> <br>           UI,    ,    .   ,     ,   ,      .        ,   .     ,    ,     . <br> <br> <code class="cs">questionnaireRepositoryMock .Setup( r =&gt; r.SubmitQuestionnaireAsync( It.IsAny&lt;Questionnaire&gt;(), It.IsAny&lt;Action&lt;IOperationResult&gt;&gt;())) .Callback&lt;Questionnaire, Action&lt;IOperationResult&gt;&gt;( (q, a) =&gt; callback = a); uiServicemock .Setup(svc =&gt; svc.ShowView(ViewNames.QuestionnaireTemplatesList)) .Callback&lt;string&gt;(viewName =&gt; requestedViewName = viewName); submitResultMock .Setup(sr =&gt; sr.Error) .Returns&lt;Exception&gt;(null); CompleteQuestionnaire(viewModel); viewModel.Submit(); //      UI . callback(submitResultMock.Object); //    ‚Äì     . Assert.AreEqual(ViewNames.QuestionnaireTemplatesList, requestedViewName);</code> <br> <b></b> <br>          ,        . <br>   <br>       , . "Trees in WPF"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ms753391.aspx">http://msdn.microsoft.com/en-us/library/ms753391.aspx</a> <br> <br>       , . "Attached Properties Overview"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/cc265152(VS.95).aspx">http://msdn.microsoft.com/en-us/library/cc265152(VS.95).aspx</a> <br> <br>      MEF, ."Managed Extensibility Framework Overview"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/dd460648.aspx">http://msdn.microsoft.com/en-us/library/dd460648.aspx</a> . <br> <br>      Unity, ."Unity Application Block"  MSDN: <a href="http://www.msdn.com/unity">http://www.msdn.com/unity</a> . <br> <br>      <code>DelegateCommand</code> , .Chapter 5, " <a href="http://msdn.microsoft.com/en-us/library/gg405484(v%3DPandP.40).aspx">Implementing the MVVM Pattern</a> ." <br> <br>        Microsoft Expression Blend, ."Working with built-in behaviors"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ff724013(v%3DExpression.40).aspx">http://msdn.microsoft.com/en-us/library/ff724013(v=Expression.40).aspx</a> . <br> <br>          Microsoft Expression Blend, ."Creating Custom Behaviors"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ff724708(v%3DExpression.40).aspx">http://msdn.microsoft.com/en-us/library/ff724708(v=Expression.40).aspx</a> . <br> <br>            Microsoft Expression Blend, ."Creating Custom Triggers and Actions"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ff724707(v%3DExpression.40).aspx">http://msdn.microsoft.com/en-us/library/ff724707(v=Expression.40).aspx</a> . <br> <br>         WPF  Silverlight, ."Threading Model"  "The Dispatcher Class"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ms741870.aspx">http://msdn.microsoft.com/en-us/library/ms741870.aspx</a> <br> <a href="http://msdn.microsoft.com/en-us/library/ms615907(v%3DVS.95).aspx">http://msdn.microsoft.com/en-us/library/ms615907(v=VS.95).aspx</a> . <br> <br>      unit-  Silverlight, ."Unit Testing with Silverlight 2": <a href="http://www.jeff.wilcox.name/2008/03/silverlight2-unit-testing/">http://www.jeff.wilcox.name/2008/03/silverlight2-unit-testing/</a> . <br> <br>         , .  " <a href="http://msdn.microsoft.com/en-us/library/gg430861(v%3DPandP.40).aspx">View-Based Navigation</a> " in Chapter 8, " <a href="http://msdn.microsoft.com/en-us/library/gg430861(v%3DPandP.40).aspx">Navigation</a> ." <br> <br>       ,   , ."Event-based Asynchronous Pattern Overview"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/wewwczdw.aspx">http://msdn.microsoft.com/en-us/library/wewwczdw.aspx</a> <br> <br>        <code>IAsyncResult</code> , ."Asynchronous Programming Overview"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ms228963.aspx">http://msdn.microsoft.com/en-us/library/ms228963.aspx</a></code></code></code></code></code></code></code></code></code> </h3> <code><code><code><code>CommandBehaviorBase ,    ,    ICommand</code> .           <code>CanExecuteChanged</code> ,          Silverlight,    WPF. <br> <br>    ,  ,   <code>CommandBehaviorBase    ,    .         ,      .         ,    .      ButtonBaseClickCommandBehavior</code> . <br> <br> <code class="cs">public class ButtonBaseClickCommandBehavior : CommandBehaviorBase&lt;ButtonBase&gt; { public ButtonBaseClickCommandBehavior(ButtonBase clickableObject) : base(clickableObject) { clickableObject.Click += OnClick; } private void OnClick(object sender, System.Windows.RoutedEventArgs e) { ExecuteCommand(); } }</code> <br>   <code>CommandBehaviorBase ,     .     ,          ,   . ,    ,    ,      , ,    CanExecute</code>  ,     . <br> <br>          ,   .           XAML.           .       .  Prism      ,       ,  ,   .       ,    . , ,  ,      <code>Click</code> ,       <code>Command</code> .    <code>Click.Command</code> ,  . <br> <br>             .             . <br> <br> <code class="cs">public static readonly DependencyProperty CommandProperty = DependencyProperty.RegisterAttached( "Command", typeof(ICommand), typeof(Click), new PropertyMetadata(OnSetCommandCallback)); private static readonly DependencyProperty ClickCommandBehaviorProperty = DependencyProperty.RegisterAttached( "ClickCommandBehavior", typeof(ButtonBaseClickCommandBehavior), typeof(Click), null);</code> <br>    <code>Command</code>    <code>ButtonBaseClickCommandBehavior</code> ,     <code>OnSetCommandCallback</code> ,     . <br> <br> <code class="cs">private static void OnSetCommandCallback(DependencyObject dependencyObject, DependencyPropertyChangedEventArgs e) { ButtonBase buttonBase = dependencyObject as ButtonBase; if (buttonBase != null) { ButtonBaseClickCommandBehavior behavior = GetOrCreateBehavior(buttonBase); behavior.Command = e.NewValue as ICommand; } } private static void OnSetCommandParameterCallback(DependencyObject dependencyObject, DependencyPropertyChangedEventArgs e) { ButtonBase buttonBase = dependencyObject as ButtonBase; if (buttonBase != null) { ButtonBaseClickCommandBehavior behavior = GetOrCreateBehavior(buttonBase); behavior.CommandParameter = e.NewValue; } } private static ButtonBaseClickCommandBehavior GetOrCreateBehavior(ButtonBase buttonBase ) { ButtonBaseClickCommandBehavior behavior = buttonBase.GetValue(ClickCommandBehaviorProperty) as ButtonBaseClickCommandBehavior; if ( behavior == null ) { behavior = new ButtonBaseClickCommandBehavior(buttonBase); buttonBase.SetValue(ClickCommandBehaviorProperty, behavior); } return behavior; }</code> <br>        ,  <a href="http://msdn.microsoft.com/en-us/library/cc265152(VS.95).aspx">Attached Properties Overview</a>  MSDN. <br> <br>    <br>              . ,     Silverlight,    -,     ,      ,     .     ,       . <br> <br>        ,    ( )  ,  ,     .  UI       ,            UI. <br> <br>      - <br>   -     ,       <code>IAsyncResult</code> .   ,  ,   ,  <code>GetQuestionnaire</code> ,   : <code>BeginGetQuestionnaire</code>  <code>EndGetQuestionnaire</code> .    ,   <code>BeginGetQuestionnaire</code> .     ,   ,   <code>EndGetQuestionnaire</code>    . <br> <b></b> <br>  .NET Framework 4.5      <code>await</code>  <code>async</code>     <code>*Async</code> .      <a href="http://msdn.microsoft.com/en-us/library/vstudio/hh391443.aspx">"Asynchronous Programming with Async and Await (C# and Visual Basic)"</a> . <br>  ,    <code>EndGetQuestionnaire</code> ,      ,  ()      <code>BeginGetQuestionnaire</code> .     ,      ,   <code>EndGetQuestionnaire</code> ,   . <br> <br> <code class="xml">IAsyncResult asyncResult = this.service.BeginGetQuestionnaire( GetQuestionnaireCompleted, null //  ,      ); private void GetQuestionnaireCompleted(IAsyncResult result) { try { questionnaire = this.service.EndGetQuestionnaire(ar); } catch (Exception ex) { //  -   . } }</code> <br>  ,     <code>End*</code> (  , <code>EndGetQuestionnaire</code> ),    ,      .      , ,          UI.     ,   ,        . <br> <br>        UI,     -,      UI,         UI,   <code>Dispatcher</code>    <code>SynchronizationContext</code> .  WPF  Silverlight,   <code>Dispatcher</code> . <br> <br>      <code>Questionnaire</code>  ,        <code>QuestionnaireView</code> .  Silverlight    <code>CheckAccess</code> ,  ,      UI.  ,     <code>BeginInvoke</code> ,      UI. <br> <br> <code class="cs">var dispatcher = System.Windows.Deployment.Current.Dispatcher; if (dispatcher.CheckAccess()) { QuestionnaireView.DataContext = questionnaire; } else { dispatcher.BeginInvoke(() =&gt; { Questionnaire.DataContext = questionnaire; }); }</code> <br> <i>MVVM RI</i>   ,    ,   <code>IAsyncResult</code> ,   .      ,                 . ,       . <br> <br> <code class="cs">this.questionnaireRepository.GetQuestionnaireAsync( result =&gt; { this.Questionnaire = result.Result; });</code> <br>  <code>result</code>   ,     , , , .    ,     . <br> <br> <code class="cs">this.questionnaireRepository.GetQuestionnaireAsync( result =&gt; { if (result.Error == null) { this.Questionnaire = result.Result; ... } else { // Handle error. } })</code> <br>     <br>        ,      .     , ,             .        ,      ,     ,     . <br> <br>         ,      MVVM,     ,   . ,  -MVVM ,     <code>MessageBox</code>   code-behind UI,      .   MVVM     ,          . <br> <br>     MVVM,              ,          .      ,    ,   ,  ,     . <br> <br>              MVVM.      ,     ,     ,  ,     .    ,         ,     ,          .       . <br> <br>    <br>                  .        ,        .  ,         .         . <br> <br>  ,         ,         ,  .      ,     .           ,       . ,        WPF  Silverlight,        . <br> <br> <img title="Using the service to interact with the user." src="https://habrastorage.org/getpro/habr/post_images/4b5/397/f2d/4b5397f2d02e5851195b29f1893be6fc.png" alt=" ,    ."> <br> <br>  ,   <code>MessageBox</code>        ,     ,    ,     . <br> <br> <code class="cs">var result = interactionService.ShowMessageBox( "Are you sure you want to cancel this operation?", "Confirm", MessageBoxButton.OK); if (result == MessageBoxResult.Yes) { CancelRequest(); }</code> <br> ,      - ,      ,         Silverlight.         .             .     . <br> <br> <code class="cs">interactionService.ShowMessageBox( "Are you sure you want to cancel this operation?", "Confirm", MessageBoxButton.OK, result =&gt; { if (result == MessageBoxResult.Yes) { CancelRequest(); } });</code> <br>         ,      . ,  WPF    <code>MessageBox</code> ,       ;    Silverlight    ,    . <br> <br>     <br>         ‚Äì             .         ,      .     ,     .        ,        ,   ,     . <br> <br> <img title="Using interaction request objects." src="https://habrastorage.org/getpro/habr/post_images/3d0/ff0/1c5/3d0ff01c5518558c2d3c5c5f47ce0ce9.png" alt="   ."> <br> <br>    ,   ,          ‚Äì       ,      ,   ‚Äì     .   ,        ,    ,    UI            . <br> <br>       MVVM,     ,       ,         .         ,        ,    ,   . <br> <br>  Prism       <code>IInteractionRequest</code>   <code><code>InteractionRequest .  IInteractionRequest</code>  ,   .           ,   .  <code><code>InteractionRequest   IInteractionRequest</code>     <code>Raise</code> ,           , , ,   . <br> <br>       <br>  <code><code>InteractionRequest          .  Raise</code>          ( <code>T</code> )    ,    ,   .          ,       .      ,        .    ,  ,     . <br> <code class="cs">public interface IInteractionRequest { event EventHandler&lt;InteractionRequestedEventArgs&gt; Raised; } public class InteractionRequest&lt;T&gt; : IInteractionRequest { public event EventHandler&lt;InteractionRequestedEventArgs&gt; Raised; public void Raise(T context, Action&lt;T&gt; callback) { var handler = this.Raised; if (handler != null) { handler( this, new InteractionRequestedEventArgs(context, () =&gt; callback(context))); } } }</code> <br> Prism    ,      .  <code>Notification</code>       .    ,            .     ‚Äì <code>Title</code>  <code>Content</code> ,    .  ,   ,  ,  ,        . <br> <br>  <code>Confirmation</code>    <code>Notification</code>     ‚Äì <code>Confirmed</code> ,  ,  ,      .  <code>Confirmation</code> ,     <code>MessageBox</code> ,     /  .     ,     <code>Notification</code> ,     ,      . <br> <br>    <code><code><code>InteractionRequest ,       InteractionRequest      ,      .      ,    Raise</code> ,    , ,   . <br> <br> <code class="cs">public IInteractionRequest ConfirmCancelInteractionRequest { get { return this.confirmCancelInteractionRequest; } } this.confirmCancelInteractionRequest.Raise( new Confirmation("Are you sure you wish to cancel?"), confirmation =&gt; { if (confirmation.Confirmed) { this.NavigateToQuestionnaireList(); } }); }</code> <br> <i>MVVM Reference Implementation (MVVM RI)</i> ,    <code>IInteractionRequest</code>   <code><code>InteractionRequest ,          (. QuestionnaireViewModel.cs</code> ). <br> <br>        <br>       ,       .   ,       .    UI             . <br> <br>                . Microsoft Expression Blend Behaviors Framework     .  ,     ,    . <br> <br>  <code>EventTrigger</code> ,  Expression Blend,  ,      ,     ,   . , Prism   <code>EventTrigger</code> ,  <code>InteractionRequestTrigger</code> ,      <code>Raised</code>   <code>IInteractionRequest</code> .    XAML        . <br> <br>  ,   , <code>InteractionRequestTrigger</code>   .  Silverlight Prism   <code>PopupChildWindowAction</code> ,     .    ,         .   <code>ContentTemplate</code>  <code>PopupChildWindowAction</code> ,    ,    UI,      <code>Content</code>  .       <code>Title</code>  . <br> <b></b> <br>  ,    ,   <code>PopupChildWindowAction</code> ,     .    <code>Notification</code>  <code>NotificationChildWindow</code> ,        <code>Confirmation</code> ‚Äì <code>ConfirmationChildWindow</code> . <code>NotificationChildWindow</code>    ,   ,     <code>ConfirmationChildWindow</code>    <i>OK</i>  <i>Cancel</i> ,    .    ,   ,   <code>ChildWindow</code>  <code>PopupChildWindowAction</code> . <br>   ,  <code>InteractionRequestTrigger</code>  <code>PopupChildWindowAction</code> ,       <i>RI MVVM</i> . <br> <br> <code class="xml">&lt;i:Interaction.Triggers&gt; &lt;prism:InteractionRequestTrigger SourceObject="{Binding ConfirmCancelInteractionRequest}"&gt; &lt;prism:PopupChildWindowAction ContentTemplate="{StaticResource ConfirmWindowTemplate}"/&gt; &lt;/prism:InteractionRequestTrigger&gt; &lt;/i:Interaction.Triggers&gt; &lt;UserControl.Resources&gt; &lt;DataTemplate x:Key="ConfirmWindowTemplate"&gt; &lt;Grid MinWidth="250" MinHeight="100"&gt; &lt;TextBlock TextWrapping="Wrap" Grid.Row="0" Text="{Binding}"/&gt; &lt;/Grid&gt; &lt;/DataTemplate&gt; &lt;/UserControl.Resources&gt;</code> <br> <b></b> <br>      <code>ContentTemplate</code> ,   UI   <code>Content</code>  .    <code>Content</code>  ,  , <code>TextBlock</code>     <code>Content</code> . <br>      ,     ,    ,    .  ,     ,       ,     ,    .   ,   <i>RI MVVM</i> ,         <code>Confirmed</code>    <code>Confirmation</code>  <code>true</code> ,     OK. <br> <br>        ,     .  Prism <code>InteractionRequestTrigger</code>   <code>PopupChildWindowAction</code>            . <br> <br>     <br>     MVVM,       , ,    ,         .        (  , ,  ,   ).    ,  ,  ,            . <br> <br>        ,         . Managed Extensibility Framework (MEF)  Unity Application Block (Unity)      ,  ,           . <br> <br>  ,       , , ,    ( )      . ,       ,     .  ,     ,       . <br> <br>     ,  MEF <br>  MEF,       ,   <code>Import</code> ,      ,  ,   <code>Export</code> .         ,    . <br> <br> , <code>QuestionnaireView</code>   <i>RI MVVM</i> ,        ,    <code>Import</code> .   , MEF           .  <code>set</code>        ,   . <br> <br> <code class="cs">[Import] public QuestionnaireViewModel ViewModel { set { this.DataContext = value; } }</code> <br>     ,   . <br> <br> <code class="cs">[Export] public class QuestionnaireViewModel : NotificationObject { ... }</code> <br>        ,   . <br> <br> <code class="cs">public QuestionnaireView() { InitializeComponent(); } [ImportingConstructor] public QuestionnaireView(QuestionnaireViewModel viewModel) : this() { this.DataContext = viewModel; }</code> <br> <b></b> <br>          MEF,   Unity.   ,     ,        .   ,   Visual Studio  Expression Blend, ,        ,     .   ,   ,  ,      ,          <code>InitializeComponent</code> . <br>     ,  Unity <br>  Unity,    ,   MEF.     ,      .    ,         .  ,      . <br> <br>  ,      ,  ,         . ,           ,   . <br> <br> <code class="cs">public QuestionnaireView() { InitializeComponent(); } public QuestionnaireView(QuestionnaireViewModel viewModel) : this() { this.DataContext = viewModel; }</code> <br> <b></b> <br>    ,        ,   Visual Studio  Expression Blend. <br>  ,          ,   . Unity        <code>set</code>   ,   . <br> <br> <code class="cs">public QuestionnaireView() { InitializeComponent(); } [Dependency] public QuestionnaireViewModel ViewModel { set { this.DataContext = value; } }</code> <br>       Unity. <br> <br> <code class="cs">container.RegisterType&lt;QuestionnaireViewModel&gt;();</code> <br>  ,     . <br> <br> <code class="cs">var view = container.Resolve&lt;QuestionnaireView&gt;();</code> <br>     ,    <br>   ,     ,        .        ,   MEF  Unity,        . <br> <br>          .   ,         UI,           . <br> <br> , <i>RI MVVM</i>   ,   ,        .   ,    .      <code>ShowView</code>   UI. <br> <br> <code class="cs">private void NavigateToQuestionnaireList() { //     "questionnaire list". this.uiService.ShowView(ViewNames.QuestionnaireTemplatesList); }</code> <br>  UI      UI .           UI.  <code>ShowView</code>  <code>UIService</code>      (,          ),       ,   . <br> <br> <code class="cs">public void ShowView(string viewName) { var view = this.ViewFactory.GetView(viewName); this.MainWindow.CurrentView = view; }</code> <br> <b></b> <br> Prism       .   ,   ,   ,             .    ,  , " <a href="http://msdn.microsoft.com/en-us/library/gg430861(v%3DPandP.40).aspx">View-Based Navigation</a> "   8, " <a href="http://msdn.microsoft.com/en-us/library/gg430861(v%3DPandP.40).aspx">Navigation</a> ". <br>  MVVM  <br>        MVVM      .           -      mocking . ,   ,        . <br> <br>   <i>INotifyPropertyChanged</i> <br>   <code>INotifyPropertyChanged</code>     ,      .      ,    ;   ,   ,     ,    ,       . <br> <br>   <br> ,       ,           <code>PropertyChanged</code>  ,         .  ,    <code>ChangeTracker</code> ,     MVVM,  ,      .      .     ,    . <br> <br> <code class="cs">var changeTracker = new PropertyChangeTracker(viewModel); viewModel.CurrentState = "newState"; CollectionAssert.Contains(changeTracker.ChangedProperties, "CurrentState");</code> <br> ,     ,     <code>INotifyPropertyChanged</code> ,    ,   ,     . <br> <br>      <br>        ,   ,    <code>set</code>      ,           . ,     ,     ,      ,          . <br> <br> <code class="cs">var changeTracker = new PropertyChangeTracker(viewModel); var question = viewModel.Questions.First() as OpenQuestionViewModel; question.Question.Response = "some text"; CollectionAssert.Contains(changeTracker.ChangedProperties, "UnansweredQuestions");</code> <br>      <br>     <code>INotifyPropertyChanged</code> ,      <code>PropertyChanged</code>        ,  ,     , , .        ,       . <br> <br>   <i>INotifyDataErrorInfo</i> <br>   ,     ,    ,   ,   <code>IDataErrorInfo</code> ,  ( Silverlight)   <code>INotifyDataErrorInfo</code> .   <code>INotifyDataErrorInfo</code>   ,         ,    ,  ,   ,    . <br> <br>       <code>INotifyDataErrorInfo</code> : ,     ,  ,     ,     <code>ErrorsChanged</code> ,      <code>GetErrors</code> , . <br> <br>    <br>     ,      ,     .       ,         <code>GetErrors</code>       ,  ,  ,   .    , ,  ,     ,        .   ,        . <br> <br> <code class="cs">//  . var notifyErrorInfo = (INotifyDataErrorInfo)question; question.Response = -15; Assert.IsTrue(notifyErrorInfo.GetErrors("Response").Cast&lt;ValidationResult&gt;().Any()); //  . var notifyErrorInfo = (INotifyDataErrorInfo)question; question.Response = 15; Assert.IsFalse(notifyErrorInfo.GetErrors("Response").Cast&lt;ValidationResult&gt;().Any());</code> <br>    ,    ,             . <br> <br>    <i>INotifyDataErrorInfo</i> <br>       <code>GetErrors</code> ,   <code>INotifyDataErrorInfo</code>  ,   <code>ErrorsChanged</code>      <code>GetErrors</code> . ,  <code>HasErrors</code>      ,  . <br> <br>       <code>INotifyDataErrorInfo</code> . , ,           ,   -  .      ,        <code>INotifyDataErrorInfo</code>         (,        ). <br> <br>     ,   ,  : <br>  <code>HasErrors</code>     .              ,       .  <code>ErrorsChanged</code> ,      ,         <code>GetErrors</code> .         ( ,  )     ,           .    <code>GetErrors</code>       <code>ErrorsChanged</code> . <br>    <code>INotifyPropertyChanged</code> ,  ,    <code>NotifyDataErrorInfoTestHelper</code>    MVVM,        <code>INotifyDataErrorInfo</code> ,       .   ,   ,      ,   .      . <br> <code class="cs">var helper = new NotifyDataErrorInfoTestHelper&lt;NumericQuestion, int?&gt;( question, q =&gt; q.Response); helper.ValidatePropertyChange( 6, NotifyDataErrorInfoBehavior.Nothing); helper.ValidatePropertyChange( 20, NotifyDataErrorInfoBehavior.FiresErrorsChanged | NotifyDataErrorInfoBehavior.HasErrors | NotifyDataErrorInfoBehavior.HasErrorsForProperty); helper.ValidatePropertyChange( null, NotifyDataErrorInfoBehavior.FiresErrorsChanged | NotifyDataErrorInfoBehavior.HasErrors | NotifyDataErrorInfoBehavior.HasErrorsForProperty); helper.ValidatePropertyChange( 2, NotifyDataErrorInfoBehavior.FiresErrorsChanged);</code> <br>     <br>   MVVM,     ,  .   ,    ,         . <br> <br>  ,     ,     ,       .   ,   , ,       ,     ,   <code>IAsyncResult</code>    ,  - ,   ,    UI. <br> <br>       , , ,    .   ,     .  ,      UI,     ,   ,          ,     ,        "   UI." <br> <br>     ,    ,    .   ,    ,     mock-, ,   ,   ,      ,          . <br> <br>           UI,    ,    .   ,     ,   ,      .        ,   .     ,    ,     . <br> <br> <code class="cs">questionnaireRepositoryMock .Setup( r =&gt; r.SubmitQuestionnaireAsync( It.IsAny&lt;Questionnaire&gt;(), It.IsAny&lt;Action&lt;IOperationResult&gt;&gt;())) .Callback&lt;Questionnaire, Action&lt;IOperationResult&gt;&gt;( (q, a) =&gt; callback = a); uiServicemock .Setup(svc =&gt; svc.ShowView(ViewNames.QuestionnaireTemplatesList)) .Callback&lt;string&gt;(viewName =&gt; requestedViewName = viewName); submitResultMock .Setup(sr =&gt; sr.Error) .Returns&lt;Exception&gt;(null); CompleteQuestionnaire(viewModel); viewModel.Submit(); //      UI . callback(submitResultMock.Object); //    ‚Äì     . Assert.AreEqual(ViewNames.QuestionnaireTemplatesList, requestedViewName);</code> <br> <b></b> <br>          ,        . <br>   <br>       , . "Trees in WPF"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ms753391.aspx">http://msdn.microsoft.com/en-us/library/ms753391.aspx</a> <br> <br>       , . "Attached Properties Overview"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/cc265152(VS.95).aspx">http://msdn.microsoft.com/en-us/library/cc265152(VS.95).aspx</a> <br> <br>      MEF, ."Managed Extensibility Framework Overview"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/dd460648.aspx">http://msdn.microsoft.com/en-us/library/dd460648.aspx</a> . <br> <br>      Unity, ."Unity Application Block"  MSDN: <a href="http://www.msdn.com/unity">http://www.msdn.com/unity</a> . <br> <br>      <code>DelegateCommand</code> , .Chapter 5, " <a href="http://msdn.microsoft.com/en-us/library/gg405484(v%3DPandP.40).aspx">Implementing the MVVM Pattern</a> ." <br> <br>        Microsoft Expression Blend, ."Working with built-in behaviors"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ff724013(v%3DExpression.40).aspx">http://msdn.microsoft.com/en-us/library/ff724013(v=Expression.40).aspx</a> . <br> <br>          Microsoft Expression Blend, ."Creating Custom Behaviors"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ff724708(v%3DExpression.40).aspx">http://msdn.microsoft.com/en-us/library/ff724708(v=Expression.40).aspx</a> . <br> <br>            Microsoft Expression Blend, ."Creating Custom Triggers and Actions"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ff724707(v%3DExpression.40).aspx">http://msdn.microsoft.com/en-us/library/ff724707(v=Expression.40).aspx</a> . <br> <br>         WPF  Silverlight, ."Threading Model"  "The Dispatcher Class"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ms741870.aspx">http://msdn.microsoft.com/en-us/library/ms741870.aspx</a> <br> <a href="http://msdn.microsoft.com/en-us/library/ms615907(v%3DVS.95).aspx">http://msdn.microsoft.com/en-us/library/ms615907(v=VS.95).aspx</a> . <br> <br>      unit-  Silverlight, ."Unit Testing with Silverlight 2": <a href="http://www.jeff.wilcox.name/2008/03/silverlight2-unit-testing/">http://www.jeff.wilcox.name/2008/03/silverlight2-unit-testing/</a> . <br> <br>         , .  " <a href="http://msdn.microsoft.com/en-us/library/gg430861(v%3DPandP.40).aspx">View-Based Navigation</a> " in Chapter 8, " <a href="http://msdn.microsoft.com/en-us/library/gg430861(v%3DPandP.40).aspx">Navigation</a> ." <br> <br>       ,   , ."Event-based Asynchronous Pattern Overview"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/wewwczdw.aspx">http://msdn.microsoft.com/en-us/library/wewwczdw.aspx</a> <br> <br>        <code>IAsyncResult</code> , ."Asynchronous Programming Overview"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ms228963.aspx">http://msdn.microsoft.com/en-us/library/ms228963.aspx</a></code></code></code></code></code></code></code></code></code> <h4> <code><code><code><code>CommandBehaviorBase ,    ,    ICommand</code> .           <code>CanExecuteChanged</code> ,          Silverlight,    WPF. <br> <br>    ,  ,   <code>CommandBehaviorBase    ,    .         ,      .         ,    .      ButtonBaseClickCommandBehavior</code> . <br> <br> <code class="cs">public class ButtonBaseClickCommandBehavior : CommandBehaviorBase&lt;ButtonBase&gt; { public ButtonBaseClickCommandBehavior(ButtonBase clickableObject) : base(clickableObject) { clickableObject.Click += OnClick; } private void OnClick(object sender, System.Windows.RoutedEventArgs e) { ExecuteCommand(); } }</code> <br>   <code>CommandBehaviorBase ,     .     ,          ,   . ,    ,    ,      , ,    CanExecute</code>  ,     . <br> <br>          ,   .           XAML.           .       .  Prism      ,       ,  ,   .       ,    . , ,  ,      <code>Click</code> ,       <code>Command</code> .    <code>Click.Command</code> ,  . <br> <br>             .             . <br> <br> <code class="cs">public static readonly DependencyProperty CommandProperty = DependencyProperty.RegisterAttached( "Command", typeof(ICommand), typeof(Click), new PropertyMetadata(OnSetCommandCallback)); private static readonly DependencyProperty ClickCommandBehaviorProperty = DependencyProperty.RegisterAttached( "ClickCommandBehavior", typeof(ButtonBaseClickCommandBehavior), typeof(Click), null);</code> <br>    <code>Command</code>    <code>ButtonBaseClickCommandBehavior</code> ,     <code>OnSetCommandCallback</code> ,     . <br> <br> <code class="cs">private static void OnSetCommandCallback(DependencyObject dependencyObject, DependencyPropertyChangedEventArgs e) { ButtonBase buttonBase = dependencyObject as ButtonBase; if (buttonBase != null) { ButtonBaseClickCommandBehavior behavior = GetOrCreateBehavior(buttonBase); behavior.Command = e.NewValue as ICommand; } } private static void OnSetCommandParameterCallback(DependencyObject dependencyObject, DependencyPropertyChangedEventArgs e) { ButtonBase buttonBase = dependencyObject as ButtonBase; if (buttonBase != null) { ButtonBaseClickCommandBehavior behavior = GetOrCreateBehavior(buttonBase); behavior.CommandParameter = e.NewValue; } } private static ButtonBaseClickCommandBehavior GetOrCreateBehavior(ButtonBase buttonBase ) { ButtonBaseClickCommandBehavior behavior = buttonBase.GetValue(ClickCommandBehaviorProperty) as ButtonBaseClickCommandBehavior; if ( behavior == null ) { behavior = new ButtonBaseClickCommandBehavior(buttonBase); buttonBase.SetValue(ClickCommandBehaviorProperty, behavior); } return behavior; }</code> <br>        ,  <a href="http://msdn.microsoft.com/en-us/library/cc265152(VS.95).aspx">Attached Properties Overview</a>  MSDN. <br> <br>    <br>              . ,     Silverlight,    -,     ,      ,     .     ,       . <br> <br>        ,    ( )  ,  ,     .  UI       ,            UI. <br> <br>      - <br>   -     ,       <code>IAsyncResult</code> .   ,  ,   ,  <code>GetQuestionnaire</code> ,   : <code>BeginGetQuestionnaire</code>  <code>EndGetQuestionnaire</code> .    ,   <code>BeginGetQuestionnaire</code> .     ,   ,   <code>EndGetQuestionnaire</code>    . <br> <b></b> <br>  .NET Framework 4.5      <code>await</code>  <code>async</code>     <code>*Async</code> .      <a href="http://msdn.microsoft.com/en-us/library/vstudio/hh391443.aspx">"Asynchronous Programming with Async and Await (C# and Visual Basic)"</a> . <br>  ,    <code>EndGetQuestionnaire</code> ,      ,  ()      <code>BeginGetQuestionnaire</code> .     ,      ,   <code>EndGetQuestionnaire</code> ,   . <br> <br> <code class="xml">IAsyncResult asyncResult = this.service.BeginGetQuestionnaire( GetQuestionnaireCompleted, null //  ,      ); private void GetQuestionnaireCompleted(IAsyncResult result) { try { questionnaire = this.service.EndGetQuestionnaire(ar); } catch (Exception ex) { //  -   . } }</code> <br>  ,     <code>End*</code> (  , <code>EndGetQuestionnaire</code> ),    ,      .      , ,          UI.     ,   ,        . <br> <br>        UI,     -,      UI,         UI,   <code>Dispatcher</code>    <code>SynchronizationContext</code> .  WPF  Silverlight,   <code>Dispatcher</code> . <br> <br>      <code>Questionnaire</code>  ,        <code>QuestionnaireView</code> .  Silverlight    <code>CheckAccess</code> ,  ,      UI.  ,     <code>BeginInvoke</code> ,      UI. <br> <br> <code class="cs">var dispatcher = System.Windows.Deployment.Current.Dispatcher; if (dispatcher.CheckAccess()) { QuestionnaireView.DataContext = questionnaire; } else { dispatcher.BeginInvoke(() =&gt; { Questionnaire.DataContext = questionnaire; }); }</code> <br> <i>MVVM RI</i>   ,    ,   <code>IAsyncResult</code> ,   .      ,                 . ,       . <br> <br> <code class="cs">this.questionnaireRepository.GetQuestionnaireAsync( result =&gt; { this.Questionnaire = result.Result; });</code> <br>  <code>result</code>   ,     , , , .    ,     . <br> <br> <code class="cs">this.questionnaireRepository.GetQuestionnaireAsync( result =&gt; { if (result.Error == null) { this.Questionnaire = result.Result; ... } else { // Handle error. } })</code> <br>     <br>        ,      .     , ,             .        ,      ,     ,     . <br> <br>         ,      MVVM,     ,   . ,  -MVVM ,     <code>MessageBox</code>   code-behind UI,      .   MVVM     ,          . <br> <br>     MVVM,              ,          .      ,    ,   ,  ,     . <br> <br>              MVVM.      ,     ,     ,  ,     .    ,         ,     ,          .       . <br> <br>    <br>                  .        ,        .  ,         .         . <br> <br>  ,         ,         ,  .      ,     .           ,       . ,        WPF  Silverlight,        . <br> <br> <img title="Using the service to interact with the user." src="https://habrastorage.org/getpro/habr/post_images/4b5/397/f2d/4b5397f2d02e5851195b29f1893be6fc.png" alt=" ,    ."> <br> <br>  ,   <code>MessageBox</code>        ,     ,    ,     . <br> <br> <code class="cs">var result = interactionService.ShowMessageBox( "Are you sure you want to cancel this operation?", "Confirm", MessageBoxButton.OK); if (result == MessageBoxResult.Yes) { CancelRequest(); }</code> <br> ,      - ,      ,         Silverlight.         .             .     . <br> <br> <code class="cs">interactionService.ShowMessageBox( "Are you sure you want to cancel this operation?", "Confirm", MessageBoxButton.OK, result =&gt; { if (result == MessageBoxResult.Yes) { CancelRequest(); } });</code> <br>         ,      . ,  WPF    <code>MessageBox</code> ,       ;    Silverlight    ,    . <br> <br>     <br>         ‚Äì             .         ,      .     ,     .        ,        ,   ,     . <br> <br> <img title="Using interaction request objects." src="https://habrastorage.org/getpro/habr/post_images/3d0/ff0/1c5/3d0ff01c5518558c2d3c5c5f47ce0ce9.png" alt="   ."> <br> <br>    ,   ,          ‚Äì       ,      ,   ‚Äì     .   ,        ,    ,    UI            . <br> <br>       MVVM,     ,       ,         .         ,        ,    ,   . <br> <br>  Prism       <code>IInteractionRequest</code>   <code><code>InteractionRequest .  IInteractionRequest</code>  ,   .           ,   .  <code><code>InteractionRequest   IInteractionRequest</code>     <code>Raise</code> ,           , , ,   . <br> <br>       <br>  <code><code>InteractionRequest          .  Raise</code>          ( <code>T</code> )    ,    ,   .          ,       .      ,        .    ,  ,     . <br> <code class="cs">public interface IInteractionRequest { event EventHandler&lt;InteractionRequestedEventArgs&gt; Raised; } public class InteractionRequest&lt;T&gt; : IInteractionRequest { public event EventHandler&lt;InteractionRequestedEventArgs&gt; Raised; public void Raise(T context, Action&lt;T&gt; callback) { var handler = this.Raised; if (handler != null) { handler( this, new InteractionRequestedEventArgs(context, () =&gt; callback(context))); } } }</code> <br> Prism    ,      .  <code>Notification</code>       .    ,            .     ‚Äì <code>Title</code>  <code>Content</code> ,    .  ,   ,  ,  ,        . <br> <br>  <code>Confirmation</code>    <code>Notification</code>     ‚Äì <code>Confirmed</code> ,  ,  ,      .  <code>Confirmation</code> ,     <code>MessageBox</code> ,     /  .     ,     <code>Notification</code> ,     ,      . <br> <br>    <code><code><code>InteractionRequest ,       InteractionRequest      ,      .      ,    Raise</code> ,    , ,   . <br> <br> <code class="cs">public IInteractionRequest ConfirmCancelInteractionRequest { get { return this.confirmCancelInteractionRequest; } } this.confirmCancelInteractionRequest.Raise( new Confirmation("Are you sure you wish to cancel?"), confirmation =&gt; { if (confirmation.Confirmed) { this.NavigateToQuestionnaireList(); } }); }</code> <br> <i>MVVM Reference Implementation (MVVM RI)</i> ,    <code>IInteractionRequest</code>   <code><code>InteractionRequest ,          (. QuestionnaireViewModel.cs</code> ). <br> <br>        <br>       ,       .   ,       .    UI             . <br> <br>                . Microsoft Expression Blend Behaviors Framework     .  ,     ,    . <br> <br>  <code>EventTrigger</code> ,  Expression Blend,  ,      ,     ,   . , Prism   <code>EventTrigger</code> ,  <code>InteractionRequestTrigger</code> ,      <code>Raised</code>   <code>IInteractionRequest</code> .    XAML        . <br> <br>  ,   , <code>InteractionRequestTrigger</code>   .  Silverlight Prism   <code>PopupChildWindowAction</code> ,     .    ,         .   <code>ContentTemplate</code>  <code>PopupChildWindowAction</code> ,    ,    UI,      <code>Content</code>  .       <code>Title</code>  . <br> <b></b> <br>  ,    ,   <code>PopupChildWindowAction</code> ,     .    <code>Notification</code>  <code>NotificationChildWindow</code> ,        <code>Confirmation</code> ‚Äì <code>ConfirmationChildWindow</code> . <code>NotificationChildWindow</code>    ,   ,     <code>ConfirmationChildWindow</code>    <i>OK</i>  <i>Cancel</i> ,    .    ,   ,   <code>ChildWindow</code>  <code>PopupChildWindowAction</code> . <br>   ,  <code>InteractionRequestTrigger</code>  <code>PopupChildWindowAction</code> ,       <i>RI MVVM</i> . <br> <br> <code class="xml">&lt;i:Interaction.Triggers&gt; &lt;prism:InteractionRequestTrigger SourceObject="{Binding ConfirmCancelInteractionRequest}"&gt; &lt;prism:PopupChildWindowAction ContentTemplate="{StaticResource ConfirmWindowTemplate}"/&gt; &lt;/prism:InteractionRequestTrigger&gt; &lt;/i:Interaction.Triggers&gt; &lt;UserControl.Resources&gt; &lt;DataTemplate x:Key="ConfirmWindowTemplate"&gt; &lt;Grid MinWidth="250" MinHeight="100"&gt; &lt;TextBlock TextWrapping="Wrap" Grid.Row="0" Text="{Binding}"/&gt; &lt;/Grid&gt; &lt;/DataTemplate&gt; &lt;/UserControl.Resources&gt;</code> <br> <b></b> <br>      <code>ContentTemplate</code> ,   UI   <code>Content</code>  .    <code>Content</code>  ,  , <code>TextBlock</code>     <code>Content</code> . <br>      ,     ,    ,    .  ,     ,       ,     ,    .   ,   <i>RI MVVM</i> ,         <code>Confirmed</code>    <code>Confirmation</code>  <code>true</code> ,     OK. <br> <br>        ,     .  Prism <code>InteractionRequestTrigger</code>   <code>PopupChildWindowAction</code>            . <br> <br>     <br>     MVVM,       , ,    ,         .        (  , ,  ,   ).    ,  ,  ,            . <br> <br>        ,         . Managed Extensibility Framework (MEF)  Unity Application Block (Unity)      ,  ,           . <br> <br>  ,       , , ,    ( )      . ,       ,     .  ,     ,       . <br> <br>     ,  MEF <br>  MEF,       ,   <code>Import</code> ,      ,  ,   <code>Export</code> .         ,    . <br> <br> , <code>QuestionnaireView</code>   <i>RI MVVM</i> ,        ,    <code>Import</code> .   , MEF           .  <code>set</code>        ,   . <br> <br> <code class="cs">[Import] public QuestionnaireViewModel ViewModel { set { this.DataContext = value; } }</code> <br>     ,   . <br> <br> <code class="cs">[Export] public class QuestionnaireViewModel : NotificationObject { ... }</code> <br>        ,   . <br> <br> <code class="cs">public QuestionnaireView() { InitializeComponent(); } [ImportingConstructor] public QuestionnaireView(QuestionnaireViewModel viewModel) : this() { this.DataContext = viewModel; }</code> <br> <b></b> <br>          MEF,   Unity.   ,     ,        .   ,   Visual Studio  Expression Blend, ,        ,     .   ,   ,  ,      ,          <code>InitializeComponent</code> . <br>     ,  Unity <br>  Unity,    ,   MEF.     ,      .    ,         .  ,      . <br> <br>  ,      ,  ,         . ,           ,   . <br> <br> <code class="cs">public QuestionnaireView() { InitializeComponent(); } public QuestionnaireView(QuestionnaireViewModel viewModel) : this() { this.DataContext = viewModel; }</code> <br> <b></b> <br>    ,        ,   Visual Studio  Expression Blend. <br>  ,          ,   . Unity        <code>set</code>   ,   . <br> <br> <code class="cs">public QuestionnaireView() { InitializeComponent(); } [Dependency] public QuestionnaireViewModel ViewModel { set { this.DataContext = value; } }</code> <br>       Unity. <br> <br> <code class="cs">container.RegisterType&lt;QuestionnaireViewModel&gt;();</code> <br>  ,     . <br> <br> <code class="cs">var view = container.Resolve&lt;QuestionnaireView&gt;();</code> <br>     ,    <br>   ,     ,        .        ,   MEF  Unity,        . <br> <br>          .   ,         UI,           . <br> <br> , <i>RI MVVM</i>   ,   ,        .   ,    .      <code>ShowView</code>   UI. <br> <br> <code class="cs">private void NavigateToQuestionnaireList() { //     "questionnaire list". this.uiService.ShowView(ViewNames.QuestionnaireTemplatesList); }</code> <br>  UI      UI .           UI.  <code>ShowView</code>  <code>UIService</code>      (,          ),       ,   . <br> <br> <code class="cs">public void ShowView(string viewName) { var view = this.ViewFactory.GetView(viewName); this.MainWindow.CurrentView = view; }</code> <br> <b></b> <br> Prism       .   ,   ,   ,             .    ,  , " <a href="http://msdn.microsoft.com/en-us/library/gg430861(v%3DPandP.40).aspx">View-Based Navigation</a> "   8, " <a href="http://msdn.microsoft.com/en-us/library/gg430861(v%3DPandP.40).aspx">Navigation</a> ". <br>  MVVM  <br>        MVVM      .           -      mocking . ,   ,        . <br> <br>   <i>INotifyPropertyChanged</i> <br>   <code>INotifyPropertyChanged</code>     ,      .      ,    ;   ,   ,     ,    ,       . <br> <br>   <br> ,       ,           <code>PropertyChanged</code>  ,         .  ,    <code>ChangeTracker</code> ,     MVVM,  ,      .      .     ,    . <br> <br> <code class="cs">var changeTracker = new PropertyChangeTracker(viewModel); viewModel.CurrentState = "newState"; CollectionAssert.Contains(changeTracker.ChangedProperties, "CurrentState");</code> <br> ,     ,     <code>INotifyPropertyChanged</code> ,    ,   ,     . <br> <br>      <br>        ,   ,    <code>set</code>      ,           . ,     ,     ,      ,          . <br> <br> <code class="cs">var changeTracker = new PropertyChangeTracker(viewModel); var question = viewModel.Questions.First() as OpenQuestionViewModel; question.Question.Response = "some text"; CollectionAssert.Contains(changeTracker.ChangedProperties, "UnansweredQuestions");</code> <br>      <br>     <code>INotifyPropertyChanged</code> ,      <code>PropertyChanged</code>        ,  ,     , , .        ,       . <br> <br>   <i>INotifyDataErrorInfo</i> <br>   ,     ,    ,   ,   <code>IDataErrorInfo</code> ,  ( Silverlight)   <code>INotifyDataErrorInfo</code> .   <code>INotifyDataErrorInfo</code>   ,         ,    ,  ,   ,    . <br> <br>       <code>INotifyDataErrorInfo</code> : ,     ,  ,     ,     <code>ErrorsChanged</code> ,      <code>GetErrors</code> , . <br> <br>    <br>     ,      ,     .       ,         <code>GetErrors</code>       ,  ,  ,   .    , ,  ,     ,        .   ,        . <br> <br> <code class="cs">//  . var notifyErrorInfo = (INotifyDataErrorInfo)question; question.Response = -15; Assert.IsTrue(notifyErrorInfo.GetErrors("Response").Cast&lt;ValidationResult&gt;().Any()); //  . var notifyErrorInfo = (INotifyDataErrorInfo)question; question.Response = 15; Assert.IsFalse(notifyErrorInfo.GetErrors("Response").Cast&lt;ValidationResult&gt;().Any());</code> <br>    ,    ,             . <br> <br>    <i>INotifyDataErrorInfo</i> <br>       <code>GetErrors</code> ,   <code>INotifyDataErrorInfo</code>  ,   <code>ErrorsChanged</code>      <code>GetErrors</code> . ,  <code>HasErrors</code>      ,  . <br> <br>       <code>INotifyDataErrorInfo</code> . , ,           ,   -  .      ,        <code>INotifyDataErrorInfo</code>         (,        ). <br> <br>     ,   ,  : <br>  <code>HasErrors</code>     .              ,       .  <code>ErrorsChanged</code> ,      ,         <code>GetErrors</code> .         ( ,  )     ,           .    <code>GetErrors</code>       <code>ErrorsChanged</code> . <br>    <code>INotifyPropertyChanged</code> ,  ,    <code>NotifyDataErrorInfoTestHelper</code>    MVVM,        <code>INotifyDataErrorInfo</code> ,       .   ,   ,      ,   .      . <br> <code class="cs">var helper = new NotifyDataErrorInfoTestHelper&lt;NumericQuestion, int?&gt;( question, q =&gt; q.Response); helper.ValidatePropertyChange( 6, NotifyDataErrorInfoBehavior.Nothing); helper.ValidatePropertyChange( 20, NotifyDataErrorInfoBehavior.FiresErrorsChanged | NotifyDataErrorInfoBehavior.HasErrors | NotifyDataErrorInfoBehavior.HasErrorsForProperty); helper.ValidatePropertyChange( null, NotifyDataErrorInfoBehavior.FiresErrorsChanged | NotifyDataErrorInfoBehavior.HasErrors | NotifyDataErrorInfoBehavior.HasErrorsForProperty); helper.ValidatePropertyChange( 2, NotifyDataErrorInfoBehavior.FiresErrorsChanged);</code> <br>     <br>   MVVM,     ,  .   ,    ,         . <br> <br>  ,     ,     ,       .   ,   , ,       ,     ,   <code>IAsyncResult</code>    ,  - ,   ,    UI. <br> <br>       , , ,    .   ,     .  ,      UI,     ,   ,          ,     ,        "   UI." <br> <br>     ,    ,    .   ,    ,     mock-, ,   ,   ,      ,          . <br> <br>           UI,    ,    .   ,     ,   ,      .        ,   .     ,    ,     . <br> <br> <code class="cs">questionnaireRepositoryMock .Setup( r =&gt; r.SubmitQuestionnaireAsync( It.IsAny&lt;Questionnaire&gt;(), It.IsAny&lt;Action&lt;IOperationResult&gt;&gt;())) .Callback&lt;Questionnaire, Action&lt;IOperationResult&gt;&gt;( (q, a) =&gt; callback = a); uiServicemock .Setup(svc =&gt; svc.ShowView(ViewNames.QuestionnaireTemplatesList)) .Callback&lt;string&gt;(viewName =&gt; requestedViewName = viewName); submitResultMock .Setup(sr =&gt; sr.Error) .Returns&lt;Exception&gt;(null); CompleteQuestionnaire(viewModel); viewModel.Submit(); //      UI . callback(submitResultMock.Object); //    ‚Äì     . Assert.AreEqual(ViewNames.QuestionnaireTemplatesList, requestedViewName);</code> <br> <b></b> <br>          ,        . <br>   <br>       , . "Trees in WPF"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ms753391.aspx">http://msdn.microsoft.com/en-us/library/ms753391.aspx</a> <br> <br>       , . "Attached Properties Overview"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/cc265152(VS.95).aspx">http://msdn.microsoft.com/en-us/library/cc265152(VS.95).aspx</a> <br> <br>      MEF, ."Managed Extensibility Framework Overview"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/dd460648.aspx">http://msdn.microsoft.com/en-us/library/dd460648.aspx</a> . <br> <br>      Unity, ."Unity Application Block"  MSDN: <a href="http://www.msdn.com/unity">http://www.msdn.com/unity</a> . <br> <br>      <code>DelegateCommand</code> , .Chapter 5, " <a href="http://msdn.microsoft.com/en-us/library/gg405484(v%3DPandP.40).aspx">Implementing the MVVM Pattern</a> ." <br> <br>        Microsoft Expression Blend, ."Working with built-in behaviors"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ff724013(v%3DExpression.40).aspx">http://msdn.microsoft.com/en-us/library/ff724013(v=Expression.40).aspx</a> . <br> <br>          Microsoft Expression Blend, ."Creating Custom Behaviors"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ff724708(v%3DExpression.40).aspx">http://msdn.microsoft.com/en-us/library/ff724708(v=Expression.40).aspx</a> . <br> <br>            Microsoft Expression Blend, ."Creating Custom Triggers and Actions"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ff724707(v%3DExpression.40).aspx">http://msdn.microsoft.com/en-us/library/ff724707(v=Expression.40).aspx</a> . <br> <br>         WPF  Silverlight, ."Threading Model"  "The Dispatcher Class"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ms741870.aspx">http://msdn.microsoft.com/en-us/library/ms741870.aspx</a> <br> <a href="http://msdn.microsoft.com/en-us/library/ms615907(v%3DVS.95).aspx">http://msdn.microsoft.com/en-us/library/ms615907(v=VS.95).aspx</a> . <br> <br>      unit-  Silverlight, ."Unit Testing with Silverlight 2": <a href="http://www.jeff.wilcox.name/2008/03/silverlight2-unit-testing/">http://www.jeff.wilcox.name/2008/03/silverlight2-unit-testing/</a> . <br> <br>         , .  " <a href="http://msdn.microsoft.com/en-us/library/gg430861(v%3DPandP.40).aspx">View-Based Navigation</a> " in Chapter 8, " <a href="http://msdn.microsoft.com/en-us/library/gg430861(v%3DPandP.40).aspx">Navigation</a> ." <br> <br>       ,   , ."Event-based Asynchronous Pattern Overview"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/wewwczdw.aspx">http://msdn.microsoft.com/en-us/library/wewwczdw.aspx</a> <br> <br>        <code>IAsyncResult</code> , ."Asynchronous Programming Overview"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ms228963.aspx">http://msdn.microsoft.com/en-us/library/ms228963.aspx</a></code></code></code></code></code></code></code></code></code> </h4> <code><code><code><code>CommandBehaviorBase ,    ,    ICommand</code> .           <code>CanExecuteChanged</code> ,          Silverlight,    WPF. <br> <br>    ,  ,   <code>CommandBehaviorBase    ,    .         ,      .         ,    .      ButtonBaseClickCommandBehavior</code> . <br> <br> <code class="cs">public class ButtonBaseClickCommandBehavior : CommandBehaviorBase&lt;ButtonBase&gt; { public ButtonBaseClickCommandBehavior(ButtonBase clickableObject) : base(clickableObject) { clickableObject.Click += OnClick; } private void OnClick(object sender, System.Windows.RoutedEventArgs e) { ExecuteCommand(); } }</code> <br>   <code>CommandBehaviorBase ,     .     ,          ,   . ,    ,    ,      , ,    CanExecute</code>  ,     . <br> <br>          ,   .           XAML.           .       .  Prism      ,       ,  ,   .       ,    . , ,  ,      <code>Click</code> ,       <code>Command</code> .    <code>Click.Command</code> ,  . <br> <br>             .             . <br> <br> <code class="cs">public static readonly DependencyProperty CommandProperty = DependencyProperty.RegisterAttached( "Command", typeof(ICommand), typeof(Click), new PropertyMetadata(OnSetCommandCallback)); private static readonly DependencyProperty ClickCommandBehaviorProperty = DependencyProperty.RegisterAttached( "ClickCommandBehavior", typeof(ButtonBaseClickCommandBehavior), typeof(Click), null);</code> <br>    <code>Command</code>    <code>ButtonBaseClickCommandBehavior</code> ,     <code>OnSetCommandCallback</code> ,     . <br> <br> <code class="cs">private static void OnSetCommandCallback(DependencyObject dependencyObject, DependencyPropertyChangedEventArgs e) { ButtonBase buttonBase = dependencyObject as ButtonBase; if (buttonBase != null) { ButtonBaseClickCommandBehavior behavior = GetOrCreateBehavior(buttonBase); behavior.Command = e.NewValue as ICommand; } } private static void OnSetCommandParameterCallback(DependencyObject dependencyObject, DependencyPropertyChangedEventArgs e) { ButtonBase buttonBase = dependencyObject as ButtonBase; if (buttonBase != null) { ButtonBaseClickCommandBehavior behavior = GetOrCreateBehavior(buttonBase); behavior.CommandParameter = e.NewValue; } } private static ButtonBaseClickCommandBehavior GetOrCreateBehavior(ButtonBase buttonBase ) { ButtonBaseClickCommandBehavior behavior = buttonBase.GetValue(ClickCommandBehaviorProperty) as ButtonBaseClickCommandBehavior; if ( behavior == null ) { behavior = new ButtonBaseClickCommandBehavior(buttonBase); buttonBase.SetValue(ClickCommandBehaviorProperty, behavior); } return behavior; }</code> <br>        ,  <a href="http://msdn.microsoft.com/en-us/library/cc265152(VS.95).aspx">Attached Properties Overview</a>  MSDN. <br> <br>    <br>              . ,     Silverlight,    -,     ,      ,     .     ,       . <br> <br>        ,    ( )  ,  ,     .  UI       ,            UI. <br> <br>      - <br>   -     ,       <code>IAsyncResult</code> .   ,  ,   ,  <code>GetQuestionnaire</code> ,   : <code>BeginGetQuestionnaire</code>  <code>EndGetQuestionnaire</code> .    ,   <code>BeginGetQuestionnaire</code> .     ,   ,   <code>EndGetQuestionnaire</code>    . <br> <b></b> <br>  .NET Framework 4.5      <code>await</code>  <code>async</code>     <code>*Async</code> .      <a href="http://msdn.microsoft.com/en-us/library/vstudio/hh391443.aspx">"Asynchronous Programming with Async and Await (C# and Visual Basic)"</a> . <br>  ,    <code>EndGetQuestionnaire</code> ,      ,  ()      <code>BeginGetQuestionnaire</code> .     ,      ,   <code>EndGetQuestionnaire</code> ,   . <br> <br> <code class="xml">IAsyncResult asyncResult = this.service.BeginGetQuestionnaire( GetQuestionnaireCompleted, null //  ,      ); private void GetQuestionnaireCompleted(IAsyncResult result) { try { questionnaire = this.service.EndGetQuestionnaire(ar); } catch (Exception ex) { //  -   . } }</code> <br>  ,     <code>End*</code> (  , <code>EndGetQuestionnaire</code> ),    ,      .      , ,          UI.     ,   ,        . <br> <br>        UI,     -,      UI,         UI,   <code>Dispatcher</code>    <code>SynchronizationContext</code> .  WPF  Silverlight,   <code>Dispatcher</code> . <br> <br>      <code>Questionnaire</code>  ,        <code>QuestionnaireView</code> .  Silverlight    <code>CheckAccess</code> ,  ,      UI.  ,     <code>BeginInvoke</code> ,      UI. <br> <br> <code class="cs">var dispatcher = System.Windows.Deployment.Current.Dispatcher; if (dispatcher.CheckAccess()) { QuestionnaireView.DataContext = questionnaire; } else { dispatcher.BeginInvoke(() =&gt; { Questionnaire.DataContext = questionnaire; }); }</code> <br> <i>MVVM RI</i>   ,    ,   <code>IAsyncResult</code> ,   .      ,                 . ,       . <br> <br> <code class="cs">this.questionnaireRepository.GetQuestionnaireAsync( result =&gt; { this.Questionnaire = result.Result; });</code> <br>  <code>result</code>   ,     , , , .    ,     . <br> <br> <code class="cs">this.questionnaireRepository.GetQuestionnaireAsync( result =&gt; { if (result.Error == null) { this.Questionnaire = result.Result; ... } else { // Handle error. } })</code> <br>     <br>        ,      .     , ,             .        ,      ,     ,     . <br> <br>         ,      MVVM,     ,   . ,  -MVVM ,     <code>MessageBox</code>   code-behind UI,      .   MVVM     ,          . <br> <br>     MVVM,              ,          .      ,    ,   ,  ,     . <br> <br>              MVVM.      ,     ,     ,  ,     .    ,         ,     ,          .       . <br> <br>    <br>                  .        ,        .  ,         .         . <br> <br>  ,         ,         ,  .      ,     .           ,       . ,        WPF  Silverlight,        . <br> <br> <img title="Using the service to interact with the user." src="https://habrastorage.org/getpro/habr/post_images/4b5/397/f2d/4b5397f2d02e5851195b29f1893be6fc.png" alt=" ,    ."> <br> <br>  ,   <code>MessageBox</code>        ,     ,    ,     . <br> <br> <code class="cs">var result = interactionService.ShowMessageBox( "Are you sure you want to cancel this operation?", "Confirm", MessageBoxButton.OK); if (result == MessageBoxResult.Yes) { CancelRequest(); }</code> <br> ,      - ,      ,         Silverlight.         .             .     . <br> <br> <code class="cs">interactionService.ShowMessageBox( "Are you sure you want to cancel this operation?", "Confirm", MessageBoxButton.OK, result =&gt; { if (result == MessageBoxResult.Yes) { CancelRequest(); } });</code> <br>         ,      . ,  WPF    <code>MessageBox</code> ,       ;    Silverlight    ,    . <br> <br>     <br>         ‚Äì             .         ,      .     ,     .        ,        ,   ,     . <br> <br> <img title="Using interaction request objects." src="https://habrastorage.org/getpro/habr/post_images/3d0/ff0/1c5/3d0ff01c5518558c2d3c5c5f47ce0ce9.png" alt="   ."> <br> <br>    ,   ,          ‚Äì       ,      ,   ‚Äì     .   ,        ,    ,    UI            . <br> <br>       MVVM,     ,       ,         .         ,        ,    ,   . <br> <br>  Prism       <code>IInteractionRequest</code>   <code><code>InteractionRequest .  IInteractionRequest</code>  ,   .           ,   .  <code><code>InteractionRequest   IInteractionRequest</code>     <code>Raise</code> ,           , , ,   . <br> <br>       <br>  <code><code>InteractionRequest          .  Raise</code>          ( <code>T</code> )    ,    ,   .          ,       .      ,        .    ,  ,     . <br> <code class="cs">public interface IInteractionRequest { event EventHandler&lt;InteractionRequestedEventArgs&gt; Raised; } public class InteractionRequest&lt;T&gt; : IInteractionRequest { public event EventHandler&lt;InteractionRequestedEventArgs&gt; Raised; public void Raise(T context, Action&lt;T&gt; callback) { var handler = this.Raised; if (handler != null) { handler( this, new InteractionRequestedEventArgs(context, () =&gt; callback(context))); } } }</code> <br> Prism    ,      .  <code>Notification</code>       .    ,            .     ‚Äì <code>Title</code>  <code>Content</code> ,    .  ,   ,  ,  ,        . <br> <br>  <code>Confirmation</code>    <code>Notification</code>     ‚Äì <code>Confirmed</code> ,  ,  ,      .  <code>Confirmation</code> ,     <code>MessageBox</code> ,     /  .     ,     <code>Notification</code> ,     ,      . <br> <br>    <code><code><code>InteractionRequest ,       InteractionRequest      ,      .      ,    Raise</code> ,    , ,   . <br> <br> <code class="cs">public IInteractionRequest ConfirmCancelInteractionRequest { get { return this.confirmCancelInteractionRequest; } } this.confirmCancelInteractionRequest.Raise( new Confirmation("Are you sure you wish to cancel?"), confirmation =&gt; { if (confirmation.Confirmed) { this.NavigateToQuestionnaireList(); } }); }</code> <br> <i>MVVM Reference Implementation (MVVM RI)</i> ,    <code>IInteractionRequest</code>   <code><code>InteractionRequest ,          (. QuestionnaireViewModel.cs</code> ). <br> <br>        <br>       ,       .   ,       .    UI             . <br> <br>                . Microsoft Expression Blend Behaviors Framework     .  ,     ,    . <br> <br>  <code>EventTrigger</code> ,  Expression Blend,  ,      ,     ,   . , Prism   <code>EventTrigger</code> ,  <code>InteractionRequestTrigger</code> ,      <code>Raised</code>   <code>IInteractionRequest</code> .    XAML        . <br> <br>  ,   , <code>InteractionRequestTrigger</code>   .  Silverlight Prism   <code>PopupChildWindowAction</code> ,     .    ,         .   <code>ContentTemplate</code>  <code>PopupChildWindowAction</code> ,    ,    UI,      <code>Content</code>  .       <code>Title</code>  . <br> <b></b> <br>  ,    ,   <code>PopupChildWindowAction</code> ,     .    <code>Notification</code>  <code>NotificationChildWindow</code> ,        <code>Confirmation</code> ‚Äì <code>ConfirmationChildWindow</code> . <code>NotificationChildWindow</code>    ,   ,     <code>ConfirmationChildWindow</code>    <i>OK</i>  <i>Cancel</i> ,    .    ,   ,   <code>ChildWindow</code>  <code>PopupChildWindowAction</code> . <br>   ,  <code>InteractionRequestTrigger</code>  <code>PopupChildWindowAction</code> ,       <i>RI MVVM</i> . <br> <br> <code class="xml">&lt;i:Interaction.Triggers&gt; &lt;prism:InteractionRequestTrigger SourceObject="{Binding ConfirmCancelInteractionRequest}"&gt; &lt;prism:PopupChildWindowAction ContentTemplate="{StaticResource ConfirmWindowTemplate}"/&gt; &lt;/prism:InteractionRequestTrigger&gt; &lt;/i:Interaction.Triggers&gt; &lt;UserControl.Resources&gt; &lt;DataTemplate x:Key="ConfirmWindowTemplate"&gt; &lt;Grid MinWidth="250" MinHeight="100"&gt; &lt;TextBlock TextWrapping="Wrap" Grid.Row="0" Text="{Binding}"/&gt; &lt;/Grid&gt; &lt;/DataTemplate&gt; &lt;/UserControl.Resources&gt;</code> <br> <b></b> <br>      <code>ContentTemplate</code> ,   UI   <code>Content</code>  .    <code>Content</code>  ,  , <code>TextBlock</code>     <code>Content</code> . <br>      ,     ,    ,    .  ,     ,       ,     ,    .   ,   <i>RI MVVM</i> ,         <code>Confirmed</code>    <code>Confirmation</code>  <code>true</code> ,     OK. <br> <br>        ,     .  Prism <code>InteractionRequestTrigger</code>   <code>PopupChildWindowAction</code>            . <br> <br>     <br>     MVVM,       , ,    ,         .        (  , ,  ,   ).    ,  ,  ,            . <br> <br>        ,         . Managed Extensibility Framework (MEF)  Unity Application Block (Unity)      ,  ,           . <br> <br>  ,       , , ,    ( )      . ,       ,     .  ,     ,       . <br> <br>     ,  MEF <br>  MEF,       ,   <code>Import</code> ,      ,  ,   <code>Export</code> .         ,    . <br> <br> , <code>QuestionnaireView</code>   <i>RI MVVM</i> ,        ,    <code>Import</code> .   , MEF           .  <code>set</code>        ,   . <br> <br> <code class="cs">[Import] public QuestionnaireViewModel ViewModel { set { this.DataContext = value; } }</code> <br>     ,   . <br> <br> <code class="cs">[Export] public class QuestionnaireViewModel : NotificationObject { ... }</code> <br>        ,   . <br> <br> <code class="cs">public QuestionnaireView() { InitializeComponent(); } [ImportingConstructor] public QuestionnaireView(QuestionnaireViewModel viewModel) : this() { this.DataContext = viewModel; }</code> <br> <b></b> <br>          MEF,   Unity.   ,     ,        .   ,   Visual Studio  Expression Blend, ,        ,     .   ,   ,  ,      ,          <code>InitializeComponent</code> . <br>     ,  Unity <br>  Unity,    ,   MEF.     ,      .    ,         .  ,      . <br> <br>  ,      ,  ,         . ,           ,   . <br> <br> <code class="cs">public QuestionnaireView() { InitializeComponent(); } public QuestionnaireView(QuestionnaireViewModel viewModel) : this() { this.DataContext = viewModel; }</code> <br> <b></b> <br>    ,        ,   Visual Studio  Expression Blend. <br>  ,          ,   . Unity        <code>set</code>   ,   . <br> <br> <code class="cs">public QuestionnaireView() { InitializeComponent(); } [Dependency] public QuestionnaireViewModel ViewModel { set { this.DataContext = value; } }</code> <br>       Unity. <br> <br> <code class="cs">container.RegisterType&lt;QuestionnaireViewModel&gt;();</code> <br>  ,     . <br> <br> <code class="cs">var view = container.Resolve&lt;QuestionnaireView&gt;();</code> <br>     ,    <br>   ,     ,        .        ,   MEF  Unity,        . <br> <br>          .   ,         UI,           . <br> <br> , <i>RI MVVM</i>   ,   ,        .   ,    .      <code>ShowView</code>   UI. <br> <br> <code class="cs">private void NavigateToQuestionnaireList() { //     "questionnaire list". this.uiService.ShowView(ViewNames.QuestionnaireTemplatesList); }</code> <br>  UI      UI .           UI.  <code>ShowView</code>  <code>UIService</code>      (,          ),       ,   . <br> <br> <code class="cs">public void ShowView(string viewName) { var view = this.ViewFactory.GetView(viewName); this.MainWindow.CurrentView = view; }</code> <br> <b></b> <br> Prism       .   ,   ,   ,             .    ,  , " <a href="http://msdn.microsoft.com/en-us/library/gg430861(v%3DPandP.40).aspx">View-Based Navigation</a> "   8, " <a href="http://msdn.microsoft.com/en-us/library/gg430861(v%3DPandP.40).aspx">Navigation</a> ". <br>  MVVM  <br>        MVVM      .           -      mocking . ,   ,        . <br> <br>   <i>INotifyPropertyChanged</i> <br>   <code>INotifyPropertyChanged</code>     ,      .      ,    ;   ,   ,     ,    ,       . <br> <br>   <br> ,       ,           <code>PropertyChanged</code>  ,         .  ,    <code>ChangeTracker</code> ,     MVVM,  ,      .      .     ,    . <br> <br> <code class="cs">var changeTracker = new PropertyChangeTracker(viewModel); viewModel.CurrentState = "newState"; CollectionAssert.Contains(changeTracker.ChangedProperties, "CurrentState");</code> <br> ,     ,     <code>INotifyPropertyChanged</code> ,    ,   ,     . <br> <br>      <br>        ,   ,    <code>set</code>      ,           . ,     ,     ,      ,          . <br> <br> <code class="cs">var changeTracker = new PropertyChangeTracker(viewModel); var question = viewModel.Questions.First() as OpenQuestionViewModel; question.Question.Response = "some text"; CollectionAssert.Contains(changeTracker.ChangedProperties, "UnansweredQuestions");</code> <br>      <br>     <code>INotifyPropertyChanged</code> ,      <code>PropertyChanged</code>        ,  ,     , , .        ,       . <br> <br>   <i>INotifyDataErrorInfo</i> <br>   ,     ,    ,   ,   <code>IDataErrorInfo</code> ,  ( Silverlight)   <code>INotifyDataErrorInfo</code> .   <code>INotifyDataErrorInfo</code>   ,         ,    ,  ,   ,    . <br> <br>       <code>INotifyDataErrorInfo</code> : ,     ,  ,     ,     <code>ErrorsChanged</code> ,      <code>GetErrors</code> , . <br> <br>    <br>     ,      ,     .       ,         <code>GetErrors</code>       ,  ,  ,   .    , ,  ,     ,        .   ,        . <br> <br> <code class="cs">//  . var notifyErrorInfo = (INotifyDataErrorInfo)question; question.Response = -15; Assert.IsTrue(notifyErrorInfo.GetErrors("Response").Cast&lt;ValidationResult&gt;().Any()); //  . var notifyErrorInfo = (INotifyDataErrorInfo)question; question.Response = 15; Assert.IsFalse(notifyErrorInfo.GetErrors("Response").Cast&lt;ValidationResult&gt;().Any());</code> <br>    ,    ,             . <br> <br>    <i>INotifyDataErrorInfo</i> <br>       <code>GetErrors</code> ,   <code>INotifyDataErrorInfo</code>  ,   <code>ErrorsChanged</code>      <code>GetErrors</code> . ,  <code>HasErrors</code>      ,  . <br> <br>       <code>INotifyDataErrorInfo</code> . , ,           ,   -  .      ,        <code>INotifyDataErrorInfo</code>         (,        ). <br> <br>     ,   ,  : <br>  <code>HasErrors</code>     .              ,       .  <code>ErrorsChanged</code> ,      ,         <code>GetErrors</code> .         ( ,  )     ,           .    <code>GetErrors</code>       <code>ErrorsChanged</code> . <br>    <code>INotifyPropertyChanged</code> ,  ,    <code>NotifyDataErrorInfoTestHelper</code>    MVVM,        <code>INotifyDataErrorInfo</code> ,       .   ,   ,      ,   .      . <br> <code class="cs">var helper = new NotifyDataErrorInfoTestHelper&lt;NumericQuestion, int?&gt;( question, q =&gt; q.Response); helper.ValidatePropertyChange( 6, NotifyDataErrorInfoBehavior.Nothing); helper.ValidatePropertyChange( 20, NotifyDataErrorInfoBehavior.FiresErrorsChanged | NotifyDataErrorInfoBehavior.HasErrors | NotifyDataErrorInfoBehavior.HasErrorsForProperty); helper.ValidatePropertyChange( null, NotifyDataErrorInfoBehavior.FiresErrorsChanged | NotifyDataErrorInfoBehavior.HasErrors | NotifyDataErrorInfoBehavior.HasErrorsForProperty); helper.ValidatePropertyChange( 2, NotifyDataErrorInfoBehavior.FiresErrorsChanged);</code> <br>     <br>   MVVM,     ,  .   ,    ,         . <br> <br>  ,     ,     ,       .   ,   , ,       ,     ,   <code>IAsyncResult</code>    ,  - ,   ,    UI. <br> <br>       , , ,    .   ,     .  ,      UI,     ,   ,          ,     ,        "   UI." <br> <br>     ,    ,    .   ,    ,     mock-, ,   ,   ,      ,          . <br> <br>           UI,    ,    .   ,     ,   ,      .        ,   .     ,    ,     . <br> <br> <code class="cs">questionnaireRepositoryMock .Setup( r =&gt; r.SubmitQuestionnaireAsync( It.IsAny&lt;Questionnaire&gt;(), It.IsAny&lt;Action&lt;IOperationResult&gt;&gt;())) .Callback&lt;Questionnaire, Action&lt;IOperationResult&gt;&gt;( (q, a) =&gt; callback = a); uiServicemock .Setup(svc =&gt; svc.ShowView(ViewNames.QuestionnaireTemplatesList)) .Callback&lt;string&gt;(viewName =&gt; requestedViewName = viewName); submitResultMock .Setup(sr =&gt; sr.Error) .Returns&lt;Exception&gt;(null); CompleteQuestionnaire(viewModel); viewModel.Submit(); //      UI . callback(submitResultMock.Object); //    ‚Äì     . Assert.AreEqual(ViewNames.QuestionnaireTemplatesList, requestedViewName);</code> <br> <b></b> <br>          ,        . <br>   <br>       , . "Trees in WPF"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ms753391.aspx">http://msdn.microsoft.com/en-us/library/ms753391.aspx</a> <br> <br>       , . "Attached Properties Overview"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/cc265152(VS.95).aspx">http://msdn.microsoft.com/en-us/library/cc265152(VS.95).aspx</a> <br> <br>      MEF, ."Managed Extensibility Framework Overview"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/dd460648.aspx">http://msdn.microsoft.com/en-us/library/dd460648.aspx</a> . <br> <br>      Unity, ."Unity Application Block"  MSDN: <a href="http://www.msdn.com/unity">http://www.msdn.com/unity</a> . <br> <br>      <code>DelegateCommand</code> , .Chapter 5, " <a href="http://msdn.microsoft.com/en-us/library/gg405484(v%3DPandP.40).aspx">Implementing the MVVM Pattern</a> ." <br> <br>        Microsoft Expression Blend, ."Working with built-in behaviors"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ff724013(v%3DExpression.40).aspx">http://msdn.microsoft.com/en-us/library/ff724013(v=Expression.40).aspx</a> . <br> <br>          Microsoft Expression Blend, ."Creating Custom Behaviors"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ff724708(v%3DExpression.40).aspx">http://msdn.microsoft.com/en-us/library/ff724708(v=Expression.40).aspx</a> . <br> <br>            Microsoft Expression Blend, ."Creating Custom Triggers and Actions"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ff724707(v%3DExpression.40).aspx">http://msdn.microsoft.com/en-us/library/ff724707(v=Expression.40).aspx</a> . <br> <br>         WPF  Silverlight, ."Threading Model"  "The Dispatcher Class"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ms741870.aspx">http://msdn.microsoft.com/en-us/library/ms741870.aspx</a> <br> <a href="http://msdn.microsoft.com/en-us/library/ms615907(v%3DVS.95).aspx">http://msdn.microsoft.com/en-us/library/ms615907(v=VS.95).aspx</a> . <br> <br>      unit-  Silverlight, ."Unit Testing with Silverlight 2": <a href="http://www.jeff.wilcox.name/2008/03/silverlight2-unit-testing/">http://www.jeff.wilcox.name/2008/03/silverlight2-unit-testing/</a> . <br> <br>         , .  " <a href="http://msdn.microsoft.com/en-us/library/gg430861(v%3DPandP.40).aspx">View-Based Navigation</a> " in Chapter 8, " <a href="http://msdn.microsoft.com/en-us/library/gg430861(v%3DPandP.40).aspx">Navigation</a> ." <br> <br>       ,   , ."Event-based Asynchronous Pattern Overview"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/wewwczdw.aspx">http://msdn.microsoft.com/en-us/library/wewwczdw.aspx</a> <br> <br>        <code>IAsyncResult</code> , ."Asynchronous Programming Overview"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ms228963.aspx">http://msdn.microsoft.com/en-us/library/ms228963.aspx</a></code></code></code></code></code></code></code></code></code> <blockquote> <code><code><code><code>CommandBehaviorBase ,    ,    ICommand</code> .           <code>CanExecuteChanged</code> ,          Silverlight,    WPF. <br> <br>    ,  ,   <code>CommandBehaviorBase    ,    .         ,      .         ,    .      ButtonBaseClickCommandBehavior</code> . <br> <br> <code class="cs">public class ButtonBaseClickCommandBehavior : CommandBehaviorBase&lt;ButtonBase&gt; { public ButtonBaseClickCommandBehavior(ButtonBase clickableObject) : base(clickableObject) { clickableObject.Click += OnClick; } private void OnClick(object sender, System.Windows.RoutedEventArgs e) { ExecuteCommand(); } }</code> <br>   <code>CommandBehaviorBase ,     .     ,          ,   . ,    ,    ,      , ,    CanExecute</code>  ,     . <br> <br>          ,   .           XAML.           .       .  Prism      ,       ,  ,   .       ,    . , ,  ,      <code>Click</code> ,       <code>Command</code> .    <code>Click.Command</code> ,  . <br> <br>             .             . <br> <br> <code class="cs">public static readonly DependencyProperty CommandProperty = DependencyProperty.RegisterAttached( "Command", typeof(ICommand), typeof(Click), new PropertyMetadata(OnSetCommandCallback)); private static readonly DependencyProperty ClickCommandBehaviorProperty = DependencyProperty.RegisterAttached( "ClickCommandBehavior", typeof(ButtonBaseClickCommandBehavior), typeof(Click), null);</code> <br>    <code>Command</code>    <code>ButtonBaseClickCommandBehavior</code> ,     <code>OnSetCommandCallback</code> ,     . <br> <br> <code class="cs">private static void OnSetCommandCallback(DependencyObject dependencyObject, DependencyPropertyChangedEventArgs e) { ButtonBase buttonBase = dependencyObject as ButtonBase; if (buttonBase != null) { ButtonBaseClickCommandBehavior behavior = GetOrCreateBehavior(buttonBase); behavior.Command = e.NewValue as ICommand; } } private static void OnSetCommandParameterCallback(DependencyObject dependencyObject, DependencyPropertyChangedEventArgs e) { ButtonBase buttonBase = dependencyObject as ButtonBase; if (buttonBase != null) { ButtonBaseClickCommandBehavior behavior = GetOrCreateBehavior(buttonBase); behavior.CommandParameter = e.NewValue; } } private static ButtonBaseClickCommandBehavior GetOrCreateBehavior(ButtonBase buttonBase ) { ButtonBaseClickCommandBehavior behavior = buttonBase.GetValue(ClickCommandBehaviorProperty) as ButtonBaseClickCommandBehavior; if ( behavior == null ) { behavior = new ButtonBaseClickCommandBehavior(buttonBase); buttonBase.SetValue(ClickCommandBehaviorProperty, behavior); } return behavior; }</code> <br>        ,  <a href="http://msdn.microsoft.com/en-us/library/cc265152(VS.95).aspx">Attached Properties Overview</a>  MSDN. <br> <br>    <br>              . ,     Silverlight,    -,     ,      ,     .     ,       . <br> <br>        ,    ( )  ,  ,     .  UI       ,            UI. <br> <br>      - <br>   -     ,       <code>IAsyncResult</code> .   ,  ,   ,  <code>GetQuestionnaire</code> ,   : <code>BeginGetQuestionnaire</code>  <code>EndGetQuestionnaire</code> .    ,   <code>BeginGetQuestionnaire</code> .     ,   ,   <code>EndGetQuestionnaire</code>    . <br> <b></b> <br>  .NET Framework 4.5      <code>await</code>  <code>async</code>     <code>*Async</code> .      <a href="http://msdn.microsoft.com/en-us/library/vstudio/hh391443.aspx">"Asynchronous Programming with Async and Await (C# and Visual Basic)"</a> . <br>  ,    <code>EndGetQuestionnaire</code> ,      ,  ()      <code>BeginGetQuestionnaire</code> .     ,      ,   <code>EndGetQuestionnaire</code> ,   . <br> <br> <code class="xml">IAsyncResult asyncResult = this.service.BeginGetQuestionnaire( GetQuestionnaireCompleted, null //  ,      ); private void GetQuestionnaireCompleted(IAsyncResult result) { try { questionnaire = this.service.EndGetQuestionnaire(ar); } catch (Exception ex) { //  -   . } }</code> <br>  ,     <code>End*</code> (  , <code>EndGetQuestionnaire</code> ),    ,      .      , ,          UI.     ,   ,        . <br> <br>        UI,     -,      UI,         UI,   <code>Dispatcher</code>    <code>SynchronizationContext</code> .  WPF  Silverlight,   <code>Dispatcher</code> . <br> <br>      <code>Questionnaire</code>  ,        <code>QuestionnaireView</code> .  Silverlight    <code>CheckAccess</code> ,  ,      UI.  ,     <code>BeginInvoke</code> ,      UI. <br> <br> <code class="cs">var dispatcher = System.Windows.Deployment.Current.Dispatcher; if (dispatcher.CheckAccess()) { QuestionnaireView.DataContext = questionnaire; } else { dispatcher.BeginInvoke(() =&gt; { Questionnaire.DataContext = questionnaire; }); }</code> <br> <i>MVVM RI</i>   ,    ,   <code>IAsyncResult</code> ,   .      ,                 . ,       . <br> <br> <code class="cs">this.questionnaireRepository.GetQuestionnaireAsync( result =&gt; { this.Questionnaire = result.Result; });</code> <br>  <code>result</code>   ,     , , , .    ,     . <br> <br> <code class="cs">this.questionnaireRepository.GetQuestionnaireAsync( result =&gt; { if (result.Error == null) { this.Questionnaire = result.Result; ... } else { // Handle error. } })</code> <br>     <br>        ,      .     , ,             .        ,      ,     ,     . <br> <br>         ,      MVVM,     ,   . ,  -MVVM ,     <code>MessageBox</code>   code-behind UI,      .   MVVM     ,          . <br> <br>     MVVM,              ,          .      ,    ,   ,  ,     . <br> <br>              MVVM.      ,     ,     ,  ,     .    ,         ,     ,          .       . <br> <br>    <br>                  .        ,        .  ,         .         . <br> <br>  ,         ,         ,  .      ,     .           ,       . ,        WPF  Silverlight,        . <br> <br> <img title="Using the service to interact with the user." src="https://habrastorage.org/getpro/habr/post_images/4b5/397/f2d/4b5397f2d02e5851195b29f1893be6fc.png" alt=" ,    ."> <br> <br>  ,   <code>MessageBox</code>        ,     ,    ,     . <br> <br> <code class="cs">var result = interactionService.ShowMessageBox( "Are you sure you want to cancel this operation?", "Confirm", MessageBoxButton.OK); if (result == MessageBoxResult.Yes) { CancelRequest(); }</code> <br> ,      - ,      ,         Silverlight.         .             .     . <br> <br> <code class="cs">interactionService.ShowMessageBox( "Are you sure you want to cancel this operation?", "Confirm", MessageBoxButton.OK, result =&gt; { if (result == MessageBoxResult.Yes) { CancelRequest(); } });</code> <br>         ,      . ,  WPF    <code>MessageBox</code> ,       ;    Silverlight    ,    . <br> <br>     <br>         ‚Äì             .         ,      .     ,     .        ,        ,   ,     . <br> <br> <img title="Using interaction request objects." src="https://habrastorage.org/getpro/habr/post_images/3d0/ff0/1c5/3d0ff01c5518558c2d3c5c5f47ce0ce9.png" alt="   ."> <br> <br>    ,   ,          ‚Äì       ,      ,   ‚Äì     .   ,        ,    ,    UI            . <br> <br>       MVVM,     ,       ,         .         ,        ,    ,   . <br> <br>  Prism       <code>IInteractionRequest</code>   <code><code>InteractionRequest .  IInteractionRequest</code>  ,   .           ,   .  <code><code>InteractionRequest   IInteractionRequest</code>     <code>Raise</code> ,           , , ,   . <br> <br>       <br>  <code><code>InteractionRequest          .  Raise</code>          ( <code>T</code> )    ,    ,   .          ,       .      ,        .    ,  ,     . <br> <code class="cs">public interface IInteractionRequest { event EventHandler&lt;InteractionRequestedEventArgs&gt; Raised; } public class InteractionRequest&lt;T&gt; : IInteractionRequest { public event EventHandler&lt;InteractionRequestedEventArgs&gt; Raised; public void Raise(T context, Action&lt;T&gt; callback) { var handler = this.Raised; if (handler != null) { handler( this, new InteractionRequestedEventArgs(context, () =&gt; callback(context))); } } }</code> <br> Prism    ,      .  <code>Notification</code>       .    ,            .     ‚Äì <code>Title</code>  <code>Content</code> ,    .  ,   ,  ,  ,        . <br> <br>  <code>Confirmation</code>    <code>Notification</code>     ‚Äì <code>Confirmed</code> ,  ,  ,      .  <code>Confirmation</code> ,     <code>MessageBox</code> ,     /  .     ,     <code>Notification</code> ,     ,      . <br> <br>    <code><code><code>InteractionRequest ,       InteractionRequest      ,      .      ,    Raise</code> ,    , ,   . <br> <br> <code class="cs">public IInteractionRequest ConfirmCancelInteractionRequest { get { return this.confirmCancelInteractionRequest; } } this.confirmCancelInteractionRequest.Raise( new Confirmation("Are you sure you wish to cancel?"), confirmation =&gt; { if (confirmation.Confirmed) { this.NavigateToQuestionnaireList(); } }); }</code> <br> <i>MVVM Reference Implementation (MVVM RI)</i> ,    <code>IInteractionRequest</code>   <code><code>InteractionRequest ,          (. QuestionnaireViewModel.cs</code> ). <br> <br>        <br>       ,       .   ,       .    UI             . <br> <br>                . Microsoft Expression Blend Behaviors Framework     .  ,     ,    . <br> <br>  <code>EventTrigger</code> ,  Expression Blend,  ,      ,     ,   . , Prism   <code>EventTrigger</code> ,  <code>InteractionRequestTrigger</code> ,      <code>Raised</code>   <code>IInteractionRequest</code> .    XAML        . <br> <br>  ,   , <code>InteractionRequestTrigger</code>   .  Silverlight Prism   <code>PopupChildWindowAction</code> ,     .    ,         .   <code>ContentTemplate</code>  <code>PopupChildWindowAction</code> ,    ,    UI,      <code>Content</code>  .       <code>Title</code>  . <br> <b></b> <br>  ,    ,   <code>PopupChildWindowAction</code> ,     .    <code>Notification</code>  <code>NotificationChildWindow</code> ,        <code>Confirmation</code> ‚Äì <code>ConfirmationChildWindow</code> . <code>NotificationChildWindow</code>    ,   ,     <code>ConfirmationChildWindow</code>    <i>OK</i>  <i>Cancel</i> ,    .    ,   ,   <code>ChildWindow</code>  <code>PopupChildWindowAction</code> . <br>   ,  <code>InteractionRequestTrigger</code>  <code>PopupChildWindowAction</code> ,       <i>RI MVVM</i> . <br> <br> <code class="xml">&lt;i:Interaction.Triggers&gt; &lt;prism:InteractionRequestTrigger SourceObject="{Binding ConfirmCancelInteractionRequest}"&gt; &lt;prism:PopupChildWindowAction ContentTemplate="{StaticResource ConfirmWindowTemplate}"/&gt; &lt;/prism:InteractionRequestTrigger&gt; &lt;/i:Interaction.Triggers&gt; &lt;UserControl.Resources&gt; &lt;DataTemplate x:Key="ConfirmWindowTemplate"&gt; &lt;Grid MinWidth="250" MinHeight="100"&gt; &lt;TextBlock TextWrapping="Wrap" Grid.Row="0" Text="{Binding}"/&gt; &lt;/Grid&gt; &lt;/DataTemplate&gt; &lt;/UserControl.Resources&gt;</code> <br> <b></b> <br>      <code>ContentTemplate</code> ,   UI   <code>Content</code>  .    <code>Content</code>  ,  , <code>TextBlock</code>     <code>Content</code> . <br>      ,     ,    ,    .  ,     ,       ,     ,    .   ,   <i>RI MVVM</i> ,         <code>Confirmed</code>    <code>Confirmation</code>  <code>true</code> ,     OK. <br> <br>        ,     .  Prism <code>InteractionRequestTrigger</code>   <code>PopupChildWindowAction</code>            . <br> <br>     <br>     MVVM,       , ,    ,         .        (  , ,  ,   ).    ,  ,  ,            . <br> <br>        ,         . Managed Extensibility Framework (MEF)  Unity Application Block (Unity)      ,  ,           . <br> <br>  ,       , , ,    ( )      . ,       ,     .  ,     ,       . <br> <br>     ,  MEF <br>  MEF,       ,   <code>Import</code> ,      ,  ,   <code>Export</code> .         ,    . <br> <br> , <code>QuestionnaireView</code>   <i>RI MVVM</i> ,        ,    <code>Import</code> .   , MEF           .  <code>set</code>        ,   . <br> <br> <code class="cs">[Import] public QuestionnaireViewModel ViewModel { set { this.DataContext = value; } }</code> <br>     ,   . <br> <br> <code class="cs">[Export] public class QuestionnaireViewModel : NotificationObject { ... }</code> <br>        ,   . <br> <br> <code class="cs">public QuestionnaireView() { InitializeComponent(); } [ImportingConstructor] public QuestionnaireView(QuestionnaireViewModel viewModel) : this() { this.DataContext = viewModel; }</code> <br> <b></b> <br>          MEF,   Unity.   ,     ,        .   ,   Visual Studio  Expression Blend, ,        ,     .   ,   ,  ,      ,          <code>InitializeComponent</code> . <br>     ,  Unity <br>  Unity,    ,   MEF.     ,      .    ,         .  ,      . <br> <br>  ,      ,  ,         . ,           ,   . <br> <br> <code class="cs">public QuestionnaireView() { InitializeComponent(); } public QuestionnaireView(QuestionnaireViewModel viewModel) : this() { this.DataContext = viewModel; }</code> <br> <b></b> <br>    ,        ,   Visual Studio  Expression Blend. <br>  ,          ,   . Unity        <code>set</code>   ,   . <br> <br> <code class="cs">public QuestionnaireView() { InitializeComponent(); } [Dependency] public QuestionnaireViewModel ViewModel { set { this.DataContext = value; } }</code> <br>       Unity. <br> <br> <code class="cs">container.RegisterType&lt;QuestionnaireViewModel&gt;();</code> <br>  ,     . <br> <br> <code class="cs">var view = container.Resolve&lt;QuestionnaireView&gt;();</code> <br>     ,    <br>   ,     ,        .        ,   MEF  Unity,        . <br> <br>          .   ,         UI,           . <br> <br> , <i>RI MVVM</i>   ,   ,        .   ,    .      <code>ShowView</code>   UI. <br> <br> <code class="cs">private void NavigateToQuestionnaireList() { //     "questionnaire list". this.uiService.ShowView(ViewNames.QuestionnaireTemplatesList); }</code> <br>  UI      UI .           UI.  <code>ShowView</code>  <code>UIService</code>      (,          ),       ,   . <br> <br> <code class="cs">public void ShowView(string viewName) { var view = this.ViewFactory.GetView(viewName); this.MainWindow.CurrentView = view; }</code> <br> <b></b> <br> Prism       .   ,   ,   ,             .    ,  , " <a href="http://msdn.microsoft.com/en-us/library/gg430861(v%3DPandP.40).aspx">View-Based Navigation</a> "   8, " <a href="http://msdn.microsoft.com/en-us/library/gg430861(v%3DPandP.40).aspx">Navigation</a> ". <br>  MVVM  <br>        MVVM      .           -      mocking . ,   ,        . <br> <br>   <i>INotifyPropertyChanged</i> <br>   <code>INotifyPropertyChanged</code>     ,      .      ,    ;   ,   ,     ,    ,       . <br> <br>   <br> ,       ,           <code>PropertyChanged</code>  ,         .  ,    <code>ChangeTracker</code> ,     MVVM,  ,      .      .     ,    . <br> <br> <code class="cs">var changeTracker = new PropertyChangeTracker(viewModel); viewModel.CurrentState = "newState"; CollectionAssert.Contains(changeTracker.ChangedProperties, "CurrentState");</code> <br> ,     ,     <code>INotifyPropertyChanged</code> ,    ,   ,     . <br> <br>      <br>        ,   ,    <code>set</code>      ,           . ,     ,     ,      ,          . <br> <br> <code class="cs">var changeTracker = new PropertyChangeTracker(viewModel); var question = viewModel.Questions.First() as OpenQuestionViewModel; question.Question.Response = "some text"; CollectionAssert.Contains(changeTracker.ChangedProperties, "UnansweredQuestions");</code> <br>      <br>     <code>INotifyPropertyChanged</code> ,      <code>PropertyChanged</code>        ,  ,     , , .        ,       . <br> <br>   <i>INotifyDataErrorInfo</i> <br>   ,     ,    ,   ,   <code>IDataErrorInfo</code> ,  ( Silverlight)   <code>INotifyDataErrorInfo</code> .   <code>INotifyDataErrorInfo</code>   ,         ,    ,  ,   ,    . <br> <br>       <code>INotifyDataErrorInfo</code> : ,     ,  ,     ,     <code>ErrorsChanged</code> ,      <code>GetErrors</code> , . <br> <br>    <br>     ,      ,     .       ,         <code>GetErrors</code>       ,  ,  ,   .    , ,  ,     ,        .   ,        . <br> <br> <code class="cs">//  . var notifyErrorInfo = (INotifyDataErrorInfo)question; question.Response = -15; Assert.IsTrue(notifyErrorInfo.GetErrors("Response").Cast&lt;ValidationResult&gt;().Any()); //  . var notifyErrorInfo = (INotifyDataErrorInfo)question; question.Response = 15; Assert.IsFalse(notifyErrorInfo.GetErrors("Response").Cast&lt;ValidationResult&gt;().Any());</code> <br>    ,    ,             . <br> <br>    <i>INotifyDataErrorInfo</i> <br>       <code>GetErrors</code> ,   <code>INotifyDataErrorInfo</code>  ,   <code>ErrorsChanged</code>      <code>GetErrors</code> . ,  <code>HasErrors</code>      ,  . <br> <br>       <code>INotifyDataErrorInfo</code> . , ,           ,   -  .      ,        <code>INotifyDataErrorInfo</code>         (,        ). <br> <br>     ,   ,  : <br>  <code>HasErrors</code>     .              ,       .  <code>ErrorsChanged</code> ,      ,         <code>GetErrors</code> .         ( ,  )     ,           .    <code>GetErrors</code>       <code>ErrorsChanged</code> . <br>    <code>INotifyPropertyChanged</code> ,  ,    <code>NotifyDataErrorInfoTestHelper</code>    MVVM,        <code>INotifyDataErrorInfo</code> ,       .   ,   ,      ,   .      . <br> <code class="cs">var helper = new NotifyDataErrorInfoTestHelper&lt;NumericQuestion, int?&gt;( question, q =&gt; q.Response); helper.ValidatePropertyChange( 6, NotifyDataErrorInfoBehavior.Nothing); helper.ValidatePropertyChange( 20, NotifyDataErrorInfoBehavior.FiresErrorsChanged | NotifyDataErrorInfoBehavior.HasErrors | NotifyDataErrorInfoBehavior.HasErrorsForProperty); helper.ValidatePropertyChange( null, NotifyDataErrorInfoBehavior.FiresErrorsChanged | NotifyDataErrorInfoBehavior.HasErrors | NotifyDataErrorInfoBehavior.HasErrorsForProperty); helper.ValidatePropertyChange( 2, NotifyDataErrorInfoBehavior.FiresErrorsChanged);</code> <br>     <br>   MVVM,     ,  .   ,    ,         . <br> <br>  ,     ,     ,       .   ,   , ,       ,     ,   <code>IAsyncResult</code>    ,  - ,   ,    UI. <br> <br>       , , ,    .   ,     .  ,      UI,     ,   ,          ,     ,        "   UI." <br> <br>     ,    ,    .   ,    ,     mock-, ,   ,   ,      ,          . <br> <br>           UI,    ,    .   ,     ,   ,      .        ,   .     ,    ,     . <br> <br> <code class="cs">questionnaireRepositoryMock .Setup( r =&gt; r.SubmitQuestionnaireAsync( It.IsAny&lt;Questionnaire&gt;(), It.IsAny&lt;Action&lt;IOperationResult&gt;&gt;())) .Callback&lt;Questionnaire, Action&lt;IOperationResult&gt;&gt;( (q, a) =&gt; callback = a); uiServicemock .Setup(svc =&gt; svc.ShowView(ViewNames.QuestionnaireTemplatesList)) .Callback&lt;string&gt;(viewName =&gt; requestedViewName = viewName); submitResultMock .Setup(sr =&gt; sr.Error) .Returns&lt;Exception&gt;(null); CompleteQuestionnaire(viewModel); viewModel.Submit(); //      UI . callback(submitResultMock.Object); //    ‚Äì     . Assert.AreEqual(ViewNames.QuestionnaireTemplatesList, requestedViewName);</code> <br> <b></b> <br>          ,        . <br>   <br>       , . "Trees in WPF"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ms753391.aspx">http://msdn.microsoft.com/en-us/library/ms753391.aspx</a> <br> <br>       , . "Attached Properties Overview"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/cc265152(VS.95).aspx">http://msdn.microsoft.com/en-us/library/cc265152(VS.95).aspx</a> <br> <br>      MEF, ."Managed Extensibility Framework Overview"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/dd460648.aspx">http://msdn.microsoft.com/en-us/library/dd460648.aspx</a> . <br> <br>      Unity, ."Unity Application Block"  MSDN: <a href="http://www.msdn.com/unity">http://www.msdn.com/unity</a> . <br> <br>      <code>DelegateCommand</code> , .Chapter 5, " <a href="http://msdn.microsoft.com/en-us/library/gg405484(v%3DPandP.40).aspx">Implementing the MVVM Pattern</a> ." <br> <br>        Microsoft Expression Blend, ."Working with built-in behaviors"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ff724013(v%3DExpression.40).aspx">http://msdn.microsoft.com/en-us/library/ff724013(v=Expression.40).aspx</a> . <br> <br>          Microsoft Expression Blend, ."Creating Custom Behaviors"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ff724708(v%3DExpression.40).aspx">http://msdn.microsoft.com/en-us/library/ff724708(v=Expression.40).aspx</a> . <br> <br>            Microsoft Expression Blend, ."Creating Custom Triggers and Actions"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ff724707(v%3DExpression.40).aspx">http://msdn.microsoft.com/en-us/library/ff724707(v=Expression.40).aspx</a> . <br> <br>         WPF  Silverlight, ."Threading Model"  "The Dispatcher Class"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ms741870.aspx">http://msdn.microsoft.com/en-us/library/ms741870.aspx</a> <br> <a href="http://msdn.microsoft.com/en-us/library/ms615907(v%3DVS.95).aspx">http://msdn.microsoft.com/en-us/library/ms615907(v=VS.95).aspx</a> . <br> <br>      unit-  Silverlight, ."Unit Testing with Silverlight 2": <a href="http://www.jeff.wilcox.name/2008/03/silverlight2-unit-testing/">http://www.jeff.wilcox.name/2008/03/silverlight2-unit-testing/</a> . <br> <br>         , .  " <a href="http://msdn.microsoft.com/en-us/library/gg430861(v%3DPandP.40).aspx">View-Based Navigation</a> " in Chapter 8, " <a href="http://msdn.microsoft.com/en-us/library/gg430861(v%3DPandP.40).aspx">Navigation</a> ." <br> <br>       ,   , ."Event-based Asynchronous Pattern Overview"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/wewwczdw.aspx">http://msdn.microsoft.com/en-us/library/wewwczdw.aspx</a> <br> <br>        <code>IAsyncResult</code> , ."Asynchronous Programming Overview"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ms228963.aspx">http://msdn.microsoft.com/en-us/library/ms228963.aspx</a></code></code></code></code></code></code></code></code></code> </blockquote> <code><code><code><code>CommandBehaviorBase ,    ,    ICommand</code> .           <code>CanExecuteChanged</code> ,          Silverlight,    WPF. <br> <br>    ,  ,   <code>CommandBehaviorBase    ,    .         ,      .         ,    .      ButtonBaseClickCommandBehavior</code> . <br> <br> <code class="cs">public class ButtonBaseClickCommandBehavior : CommandBehaviorBase&lt;ButtonBase&gt; { public ButtonBaseClickCommandBehavior(ButtonBase clickableObject) : base(clickableObject) { clickableObject.Click += OnClick; } private void OnClick(object sender, System.Windows.RoutedEventArgs e) { ExecuteCommand(); } }</code> <br>   <code>CommandBehaviorBase ,     .     ,          ,   . ,    ,    ,      , ,    CanExecute</code>  ,     . <br> <br>          ,   .           XAML.           .       .  Prism      ,       ,  ,   .       ,    . , ,  ,      <code>Click</code> ,       <code>Command</code> .    <code>Click.Command</code> ,  . <br> <br>             .             . <br> <br> <code class="cs">public static readonly DependencyProperty CommandProperty = DependencyProperty.RegisterAttached( "Command", typeof(ICommand), typeof(Click), new PropertyMetadata(OnSetCommandCallback)); private static readonly DependencyProperty ClickCommandBehaviorProperty = DependencyProperty.RegisterAttached( "ClickCommandBehavior", typeof(ButtonBaseClickCommandBehavior), typeof(Click), null);</code> <br>    <code>Command</code>    <code>ButtonBaseClickCommandBehavior</code> ,     <code>OnSetCommandCallback</code> ,     . <br> <br> <code class="cs">private static void OnSetCommandCallback(DependencyObject dependencyObject, DependencyPropertyChangedEventArgs e) { ButtonBase buttonBase = dependencyObject as ButtonBase; if (buttonBase != null) { ButtonBaseClickCommandBehavior behavior = GetOrCreateBehavior(buttonBase); behavior.Command = e.NewValue as ICommand; } } private static void OnSetCommandParameterCallback(DependencyObject dependencyObject, DependencyPropertyChangedEventArgs e) { ButtonBase buttonBase = dependencyObject as ButtonBase; if (buttonBase != null) { ButtonBaseClickCommandBehavior behavior = GetOrCreateBehavior(buttonBase); behavior.CommandParameter = e.NewValue; } } private static ButtonBaseClickCommandBehavior GetOrCreateBehavior(ButtonBase buttonBase ) { ButtonBaseClickCommandBehavior behavior = buttonBase.GetValue(ClickCommandBehaviorProperty) as ButtonBaseClickCommandBehavior; if ( behavior == null ) { behavior = new ButtonBaseClickCommandBehavior(buttonBase); buttonBase.SetValue(ClickCommandBehaviorProperty, behavior); } return behavior; }</code> <br>        ,  <a href="http://msdn.microsoft.com/en-us/library/cc265152(VS.95).aspx">Attached Properties Overview</a>  MSDN. <br> <br>    <br>              . ,     Silverlight,    -,     ,      ,     .     ,       . <br> <br>        ,    ( )  ,  ,     .  UI       ,            UI. <br> <br>      - <br>   -     ,       <code>IAsyncResult</code> .   ,  ,   ,  <code>GetQuestionnaire</code> ,   : <code>BeginGetQuestionnaire</code>  <code>EndGetQuestionnaire</code> .    ,   <code>BeginGetQuestionnaire</code> .     ,   ,   <code>EndGetQuestionnaire</code>    . <br> <b></b> <br>  .NET Framework 4.5      <code>await</code>  <code>async</code>     <code>*Async</code> .      <a href="http://msdn.microsoft.com/en-us/library/vstudio/hh391443.aspx">"Asynchronous Programming with Async and Await (C# and Visual Basic)"</a> . <br>  ,    <code>EndGetQuestionnaire</code> ,      ,  ()      <code>BeginGetQuestionnaire</code> .     ,      ,   <code>EndGetQuestionnaire</code> ,   . <br> <br> <code class="xml">IAsyncResult asyncResult = this.service.BeginGetQuestionnaire( GetQuestionnaireCompleted, null //  ,      ); private void GetQuestionnaireCompleted(IAsyncResult result) { try { questionnaire = this.service.EndGetQuestionnaire(ar); } catch (Exception ex) { //  -   . } }</code> <br>  ,     <code>End*</code> (  , <code>EndGetQuestionnaire</code> ),    ,      .      , ,          UI.     ,   ,        . <br> <br>        UI,     -,      UI,         UI,   <code>Dispatcher</code>    <code>SynchronizationContext</code> .  WPF  Silverlight,   <code>Dispatcher</code> . <br> <br>      <code>Questionnaire</code>  ,        <code>QuestionnaireView</code> .  Silverlight    <code>CheckAccess</code> ,  ,      UI.  ,     <code>BeginInvoke</code> ,      UI. <br> <br> <code class="cs">var dispatcher = System.Windows.Deployment.Current.Dispatcher; if (dispatcher.CheckAccess()) { QuestionnaireView.DataContext = questionnaire; } else { dispatcher.BeginInvoke(() =&gt; { Questionnaire.DataContext = questionnaire; }); }</code> <br> <i>MVVM RI</i>   ,    ,   <code>IAsyncResult</code> ,   .      ,                 . ,       . <br> <br> <code class="cs">this.questionnaireRepository.GetQuestionnaireAsync( result =&gt; { this.Questionnaire = result.Result; });</code> <br>  <code>result</code>   ,     , , , .    ,     . <br> <br> <code class="cs">this.questionnaireRepository.GetQuestionnaireAsync( result =&gt; { if (result.Error == null) { this.Questionnaire = result.Result; ... } else { // Handle error. } })</code> <br>     <br>        ,      .     , ,             .        ,      ,     ,     . <br> <br>         ,      MVVM,     ,   . ,  -MVVM ,     <code>MessageBox</code>   code-behind UI,      .   MVVM     ,          . <br> <br>     MVVM,              ,          .      ,    ,   ,  ,     . <br> <br>              MVVM.      ,     ,     ,  ,     .    ,         ,     ,          .       . <br> <br>    <br>                  .        ,        .  ,         .         . <br> <br>  ,         ,         ,  .      ,     .           ,       . ,        WPF  Silverlight,        . <br> <br> <img title="Using the service to interact with the user." src="https://habrastorage.org/getpro/habr/post_images/4b5/397/f2d/4b5397f2d02e5851195b29f1893be6fc.png" alt=" ,    ."> <br> <br>  ,   <code>MessageBox</code>        ,     ,    ,     . <br> <br> <code class="cs">var result = interactionService.ShowMessageBox( "Are you sure you want to cancel this operation?", "Confirm", MessageBoxButton.OK); if (result == MessageBoxResult.Yes) { CancelRequest(); }</code> <br> ,      - ,      ,         Silverlight.         .             .     . <br> <br> <code class="cs">interactionService.ShowMessageBox( "Are you sure you want to cancel this operation?", "Confirm", MessageBoxButton.OK, result =&gt; { if (result == MessageBoxResult.Yes) { CancelRequest(); } });</code> <br>         ,      . ,  WPF    <code>MessageBox</code> ,       ;    Silverlight    ,    . <br> <br>     <br>         ‚Äì             .         ,      .     ,     .        ,        ,   ,     . <br> <br> <img title="Using interaction request objects." src="https://habrastorage.org/getpro/habr/post_images/3d0/ff0/1c5/3d0ff01c5518558c2d3c5c5f47ce0ce9.png" alt="   ."> <br> <br>    ,   ,          ‚Äì       ,      ,   ‚Äì     .   ,        ,    ,    UI            . <br> <br>       MVVM,     ,       ,         .         ,        ,    ,   . <br> <br>  Prism       <code>IInteractionRequest</code>   <code><code>InteractionRequest .  IInteractionRequest</code>  ,   .           ,   .  <code><code>InteractionRequest   IInteractionRequest</code>     <code>Raise</code> ,           , , ,   . <br> <br>       <br>  <code><code>InteractionRequest          .  Raise</code>          ( <code>T</code> )    ,    ,   .          ,       .      ,        .    ,  ,     . <br> <code class="cs">public interface IInteractionRequest { event EventHandler&lt;InteractionRequestedEventArgs&gt; Raised; } public class InteractionRequest&lt;T&gt; : IInteractionRequest { public event EventHandler&lt;InteractionRequestedEventArgs&gt; Raised; public void Raise(T context, Action&lt;T&gt; callback) { var handler = this.Raised; if (handler != null) { handler( this, new InteractionRequestedEventArgs(context, () =&gt; callback(context))); } } }</code> <br> Prism    ,      .  <code>Notification</code>       .    ,            .     ‚Äì <code>Title</code>  <code>Content</code> ,    .  ,   ,  ,  ,        . <br> <br>  <code>Confirmation</code>    <code>Notification</code>     ‚Äì <code>Confirmed</code> ,  ,  ,      .  <code>Confirmation</code> ,     <code>MessageBox</code> ,     /  .     ,     <code>Notification</code> ,     ,      . <br> <br>    <code><code><code>InteractionRequest ,       InteractionRequest      ,      .      ,    Raise</code> ,    , ,   . <br> <br> <code class="cs">public IInteractionRequest ConfirmCancelInteractionRequest { get { return this.confirmCancelInteractionRequest; } } this.confirmCancelInteractionRequest.Raise( new Confirmation("Are you sure you wish to cancel?"), confirmation =&gt; { if (confirmation.Confirmed) { this.NavigateToQuestionnaireList(); } }); }</code> <br> <i>MVVM Reference Implementation (MVVM RI)</i> ,    <code>IInteractionRequest</code>   <code><code>InteractionRequest ,          (. QuestionnaireViewModel.cs</code> ). <br> <br>        <br>       ,       .   ,       .    UI             . <br> <br>                . Microsoft Expression Blend Behaviors Framework     .  ,     ,    . <br> <br>  <code>EventTrigger</code> ,  Expression Blend,  ,      ,     ,   . , Prism   <code>EventTrigger</code> ,  <code>InteractionRequestTrigger</code> ,      <code>Raised</code>   <code>IInteractionRequest</code> .    XAML        . <br> <br>  ,   , <code>InteractionRequestTrigger</code>   .  Silverlight Prism   <code>PopupChildWindowAction</code> ,     .    ,         .   <code>ContentTemplate</code>  <code>PopupChildWindowAction</code> ,    ,    UI,      <code>Content</code>  .       <code>Title</code>  . <br> <b></b> <br>  ,    ,   <code>PopupChildWindowAction</code> ,     .    <code>Notification</code>  <code>NotificationChildWindow</code> ,        <code>Confirmation</code> ‚Äì <code>ConfirmationChildWindow</code> . <code>NotificationChildWindow</code>    ,   ,     <code>ConfirmationChildWindow</code>    <i>OK</i>  <i>Cancel</i> ,    .    ,   ,   <code>ChildWindow</code>  <code>PopupChildWindowAction</code> . <br>   ,  <code>InteractionRequestTrigger</code>  <code>PopupChildWindowAction</code> ,       <i>RI MVVM</i> . <br> <br> <code class="xml">&lt;i:Interaction.Triggers&gt; &lt;prism:InteractionRequestTrigger SourceObject="{Binding ConfirmCancelInteractionRequest}"&gt; &lt;prism:PopupChildWindowAction ContentTemplate="{StaticResource ConfirmWindowTemplate}"/&gt; &lt;/prism:InteractionRequestTrigger&gt; &lt;/i:Interaction.Triggers&gt; &lt;UserControl.Resources&gt; &lt;DataTemplate x:Key="ConfirmWindowTemplate"&gt; &lt;Grid MinWidth="250" MinHeight="100"&gt; &lt;TextBlock TextWrapping="Wrap" Grid.Row="0" Text="{Binding}"/&gt; &lt;/Grid&gt; &lt;/DataTemplate&gt; &lt;/UserControl.Resources&gt;</code> <br> <b></b> <br>      <code>ContentTemplate</code> ,   UI   <code>Content</code>  .    <code>Content</code>  ,  , <code>TextBlock</code>     <code>Content</code> . <br>      ,     ,    ,    .  ,     ,       ,     ,    .   ,   <i>RI MVVM</i> ,         <code>Confirmed</code>    <code>Confirmation</code>  <code>true</code> ,     OK. <br> <br>        ,     .  Prism <code>InteractionRequestTrigger</code>   <code>PopupChildWindowAction</code>            . <br> <br>     <br>     MVVM,       , ,    ,         .        (  , ,  ,   ).    ,  ,  ,            . <br> <br>        ,         . Managed Extensibility Framework (MEF)  Unity Application Block (Unity)      ,  ,           . <br> <br>  ,       , , ,    ( )      . ,       ,     .  ,     ,       . <br> <br>     ,  MEF <br>  MEF,       ,   <code>Import</code> ,      ,  ,   <code>Export</code> .         ,    . <br> <br> , <code>QuestionnaireView</code>   <i>RI MVVM</i> ,        ,    <code>Import</code> .   , MEF           .  <code>set</code>        ,   . <br> <br> <code class="cs">[Import] public QuestionnaireViewModel ViewModel { set { this.DataContext = value; } }</code> <br>     ,   . <br> <br> <code class="cs">[Export] public class QuestionnaireViewModel : NotificationObject { ... }</code> <br>        ,   . <br> <br> <code class="cs">public QuestionnaireView() { InitializeComponent(); } [ImportingConstructor] public QuestionnaireView(QuestionnaireViewModel viewModel) : this() { this.DataContext = viewModel; }</code> <br> <b></b> <br>          MEF,   Unity.   ,     ,        .   ,   Visual Studio  Expression Blend, ,        ,     .   ,   ,  ,      ,          <code>InitializeComponent</code> . <br>     ,  Unity <br>  Unity,    ,   MEF.     ,      .    ,         .  ,      . <br> <br>  ,      ,  ,         . ,           ,   . <br> <br> <code class="cs">public QuestionnaireView() { InitializeComponent(); } public QuestionnaireView(QuestionnaireViewModel viewModel) : this() { this.DataContext = viewModel; }</code> <br> <b></b> <br>    ,        ,   Visual Studio  Expression Blend. <br>  ,          ,   . Unity        <code>set</code>   ,   . <br> <br> <code class="cs">public QuestionnaireView() { InitializeComponent(); } [Dependency] public QuestionnaireViewModel ViewModel { set { this.DataContext = value; } }</code> <br>       Unity. <br> <br> <code class="cs">container.RegisterType&lt;QuestionnaireViewModel&gt;();</code> <br>  ,     . <br> <br> <code class="cs">var view = container.Resolve&lt;QuestionnaireView&gt;();</code> <br>     ,    <br>   ,     ,        .        ,   MEF  Unity,        . <br> <br>          .   ,         UI,           . <br> <br> , <i>RI MVVM</i>   ,   ,        .   ,    .      <code>ShowView</code>   UI. <br> <br> <code class="cs">private void NavigateToQuestionnaireList() { //     "questionnaire list". this.uiService.ShowView(ViewNames.QuestionnaireTemplatesList); }</code> <br>  UI      UI .           UI.  <code>ShowView</code>  <code>UIService</code>      (,          ),       ,   . <br> <br> <code class="cs">public void ShowView(string viewName) { var view = this.ViewFactory.GetView(viewName); this.MainWindow.CurrentView = view; }</code> <br> <b></b> <br> Prism       .   ,   ,   ,             .    ,  , " <a href="http://msdn.microsoft.com/en-us/library/gg430861(v%3DPandP.40).aspx">View-Based Navigation</a> "   8, " <a href="http://msdn.microsoft.com/en-us/library/gg430861(v%3DPandP.40).aspx">Navigation</a> ". <br>  MVVM  <br>        MVVM      .           -      mocking . ,   ,        . <br> <br>   <i>INotifyPropertyChanged</i> <br>   <code>INotifyPropertyChanged</code>     ,      .      ,    ;   ,   ,     ,    ,       . <br> <br>   <br> ,       ,           <code>PropertyChanged</code>  ,         .  ,    <code>ChangeTracker</code> ,     MVVM,  ,      .      .     ,    . <br> <br> <code class="cs">var changeTracker = new PropertyChangeTracker(viewModel); viewModel.CurrentState = "newState"; CollectionAssert.Contains(changeTracker.ChangedProperties, "CurrentState");</code> <br> ,     ,     <code>INotifyPropertyChanged</code> ,    ,   ,     . <br> <br>      <br>        ,   ,    <code>set</code>      ,           . ,     ,     ,      ,          . <br> <br> <code class="cs">var changeTracker = new PropertyChangeTracker(viewModel); var question = viewModel.Questions.First() as OpenQuestionViewModel; question.Question.Response = "some text"; CollectionAssert.Contains(changeTracker.ChangedProperties, "UnansweredQuestions");</code> <br>      <br>     <code>INotifyPropertyChanged</code> ,      <code>PropertyChanged</code>        ,  ,     , , .        ,       . <br> <br>   <i>INotifyDataErrorInfo</i> <br>   ,     ,    ,   ,   <code>IDataErrorInfo</code> ,  ( Silverlight)   <code>INotifyDataErrorInfo</code> .   <code>INotifyDataErrorInfo</code>   ,         ,    ,  ,   ,    . <br> <br>       <code>INotifyDataErrorInfo</code> : ,     ,  ,     ,     <code>ErrorsChanged</code> ,      <code>GetErrors</code> , . <br> <br>    <br>     ,      ,     .       ,         <code>GetErrors</code>       ,  ,  ,   .    , ,  ,     ,        .   ,        . <br> <br> <code class="cs">//  . var notifyErrorInfo = (INotifyDataErrorInfo)question; question.Response = -15; Assert.IsTrue(notifyErrorInfo.GetErrors("Response").Cast&lt;ValidationResult&gt;().Any()); //  . var notifyErrorInfo = (INotifyDataErrorInfo)question; question.Response = 15; Assert.IsFalse(notifyErrorInfo.GetErrors("Response").Cast&lt;ValidationResult&gt;().Any());</code> <br>    ,    ,             . <br> <br>    <i>INotifyDataErrorInfo</i> <br>       <code>GetErrors</code> ,   <code>INotifyDataErrorInfo</code>  ,   <code>ErrorsChanged</code>      <code>GetErrors</code> . ,  <code>HasErrors</code>      ,  . <br> <br>       <code>INotifyDataErrorInfo</code> . , ,           ,   -  .      ,        <code>INotifyDataErrorInfo</code>         (,        ). <br> <br>     ,   ,  : <br>  <code>HasErrors</code>     .              ,       .  <code>ErrorsChanged</code> ,      ,         <code>GetErrors</code> .         ( ,  )     ,           .    <code>GetErrors</code>       <code>ErrorsChanged</code> . <br>    <code>INotifyPropertyChanged</code> ,  ,    <code>NotifyDataErrorInfoTestHelper</code>    MVVM,        <code>INotifyDataErrorInfo</code> ,       .   ,   ,      ,   .      . <br> <code class="cs">var helper = new NotifyDataErrorInfoTestHelper&lt;NumericQuestion, int?&gt;( question, q =&gt; q.Response); helper.ValidatePropertyChange( 6, NotifyDataErrorInfoBehavior.Nothing); helper.ValidatePropertyChange( 20, NotifyDataErrorInfoBehavior.FiresErrorsChanged | NotifyDataErrorInfoBehavior.HasErrors | NotifyDataErrorInfoBehavior.HasErrorsForProperty); helper.ValidatePropertyChange( null, NotifyDataErrorInfoBehavior.FiresErrorsChanged | NotifyDataErrorInfoBehavior.HasErrors | NotifyDataErrorInfoBehavior.HasErrorsForProperty); helper.ValidatePropertyChange( 2, NotifyDataErrorInfoBehavior.FiresErrorsChanged);</code> <br>     <br>   MVVM,     ,  .   ,    ,         . <br> <br>  ,     ,     ,       .   ,   , ,       ,     ,   <code>IAsyncResult</code>    ,  - ,   ,    UI. <br> <br>       , , ,    .   ,     .  ,      UI,     ,   ,          ,     ,        "   UI." <br> <br>     ,    ,    .   ,    ,     mock-, ,   ,   ,      ,          . <br> <br>           UI,    ,    .   ,     ,   ,      .        ,   .     ,    ,     . <br> <br> <code class="cs">questionnaireRepositoryMock .Setup( r =&gt; r.SubmitQuestionnaireAsync( It.IsAny&lt;Questionnaire&gt;(), It.IsAny&lt;Action&lt;IOperationResult&gt;&gt;())) .Callback&lt;Questionnaire, Action&lt;IOperationResult&gt;&gt;( (q, a) =&gt; callback = a); uiServicemock .Setup(svc =&gt; svc.ShowView(ViewNames.QuestionnaireTemplatesList)) .Callback&lt;string&gt;(viewName =&gt; requestedViewName = viewName); submitResultMock .Setup(sr =&gt; sr.Error) .Returns&lt;Exception&gt;(null); CompleteQuestionnaire(viewModel); viewModel.Submit(); //      UI . callback(submitResultMock.Object); //    ‚Äì     . Assert.AreEqual(ViewNames.QuestionnaireTemplatesList, requestedViewName);</code> <br> <b></b> <br>          ,        . <br>   <br>       , . "Trees in WPF"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ms753391.aspx">http://msdn.microsoft.com/en-us/library/ms753391.aspx</a> <br> <br>       , . "Attached Properties Overview"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/cc265152(VS.95).aspx">http://msdn.microsoft.com/en-us/library/cc265152(VS.95).aspx</a> <br> <br>      MEF, ."Managed Extensibility Framework Overview"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/dd460648.aspx">http://msdn.microsoft.com/en-us/library/dd460648.aspx</a> . <br> <br>      Unity, ."Unity Application Block"  MSDN: <a href="http://www.msdn.com/unity">http://www.msdn.com/unity</a> . <br> <br>      <code>DelegateCommand</code> , .Chapter 5, " <a href="http://msdn.microsoft.com/en-us/library/gg405484(v%3DPandP.40).aspx">Implementing the MVVM Pattern</a> ." <br> <br>        Microsoft Expression Blend, ."Working with built-in behaviors"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ff724013(v%3DExpression.40).aspx">http://msdn.microsoft.com/en-us/library/ff724013(v=Expression.40).aspx</a> . <br> <br>          Microsoft Expression Blend, ."Creating Custom Behaviors"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ff724708(v%3DExpression.40).aspx">http://msdn.microsoft.com/en-us/library/ff724708(v=Expression.40).aspx</a> . <br> <br>            Microsoft Expression Blend, ."Creating Custom Triggers and Actions"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ff724707(v%3DExpression.40).aspx">http://msdn.microsoft.com/en-us/library/ff724707(v=Expression.40).aspx</a> . <br> <br>         WPF  Silverlight, ."Threading Model"  "The Dispatcher Class"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ms741870.aspx">http://msdn.microsoft.com/en-us/library/ms741870.aspx</a> <br> <a href="http://msdn.microsoft.com/en-us/library/ms615907(v%3DVS.95).aspx">http://msdn.microsoft.com/en-us/library/ms615907(v=VS.95).aspx</a> . <br> <br>      unit-  Silverlight, ."Unit Testing with Silverlight 2": <a href="http://www.jeff.wilcox.name/2008/03/silverlight2-unit-testing/">http://www.jeff.wilcox.name/2008/03/silverlight2-unit-testing/</a> . <br> <br>         , .  " <a href="http://msdn.microsoft.com/en-us/library/gg430861(v%3DPandP.40).aspx">View-Based Navigation</a> " in Chapter 8, " <a href="http://msdn.microsoft.com/en-us/library/gg430861(v%3DPandP.40).aspx">Navigation</a> ." <br> <br>       ,   , ."Event-based Asynchronous Pattern Overview"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/wewwczdw.aspx">http://msdn.microsoft.com/en-us/library/wewwczdw.aspx</a> <br> <br>        <code>IAsyncResult</code> , ."Asynchronous Programming Overview"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ms228963.aspx">http://msdn.microsoft.com/en-us/library/ms228963.aspx</a></code></code></code></code></code></code></code></code></code> <pre> <code class="hljs cmake"><code>CommandBehaviorBase ,    ,    ICommand</code> .           <code>CanExecuteChanged</code> ,          Silverlight,    WPF. <br> <br>    ,  ,   <code><code>CommandBehaviorBase    ,    .         ,      .         ,    .      ButtonBaseClickCommandBehavior</code> . <br> <br> <code class="cs">public class ButtonBaseClickCommandBehavior : CommandBehaviorBase&lt;ButtonBase&gt; { public ButtonBaseClickCommandBehavior(ButtonBase clickableObject) : base(clickableObject) { clickableObject.Click += OnClick; } private void OnClick(object sender, System.Windows.RoutedEventArgs e) { ExecuteCommand(); } }</code> <br>   <code><code>CommandBehaviorBase ,     .     ,          ,   . ,    ,    ,      , ,    CanExecute</code>  ,     . <br> <br>          ,   .           XAML.           .       .  Prism      ,       ,  ,   .       ,    . , ,  ,      <code>Click</code> ,       <code><span class="hljs-keyword"><span class="hljs-keyword">Command</span></span></code> .    <code>Click.<span class="hljs-keyword"><span class="hljs-keyword">Command</span></span></code> ,  . <br> <br>             .             . <br> <br> <code class="cs">public static readonly DependencyProperty CommandProperty = DependencyProperty.RegisterAttached( <span class="hljs-string"><span class="hljs-string">"Command"</span></span>, typeof(ICommand), typeof(Click), new PropertyMetadata(OnSetCommandCallback)); private static readonly DependencyProperty ClickCommandBehaviorProperty = DependencyProperty.RegisterAttached( <span class="hljs-string"><span class="hljs-string">"ClickCommandBehavior"</span></span>, typeof(ButtonBaseClickCommandBehavior), typeof(Click), null);</code> <br>    <code><span class="hljs-keyword"><span class="hljs-keyword">Command</span></span></code>    <code>ButtonBaseClickCommandBehavior</code> ,     <code>OnSetCommandCallback</code> ,     . <br> <br> <code class="cs">private static void OnSetCommandCallback(DependencyObject dependencyObject, DependencyPropertyChangedEventArgs e) { ButtonBase buttonBase = dependencyObject as ButtonBase; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (buttonBase != null) { ButtonBaseClickCommandBehavior behavior = GetOrCreateBehavior(buttonBase); behavior.<span class="hljs-keyword"><span class="hljs-keyword">Command</span></span> = e.NewValue as ICommand; } } private static void OnSetCommandParameterCallback(DependencyObject dependencyObject, DependencyPropertyChangedEventArgs e) { ButtonBase buttonBase = dependencyObject as ButtonBase; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (buttonBase != null) { ButtonBaseClickCommandBehavior behavior = GetOrCreateBehavior(buttonBase); behavior.CommandParameter = e.NewValue; } } private static ButtonBaseClickCommandBehavior GetOrCreateBehavior(ButtonBase buttonBase ) { ButtonBaseClickCommandBehavior behavior = buttonBase.GetValue(ClickCommandBehaviorProperty) as ButtonBaseClickCommandBehavior; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ( behavior == null ) { behavior = new ButtonBaseClickCommandBehavior(buttonBase); buttonBase.SetValue(ClickCommandBehaviorProperty, behavior); } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> behavior; }</code> <br>        ,  <a href="http://msdn.microsoft.com/en-us/library/cc265152(VS.95).aspx">Attached Properties Overview</a>  MSDN. <br> <br>    <br>              . ,     Silverlight,    -,     ,      ,     .     ,       . <br> <br>        ,    ( )  ,  ,     .  UI       ,            UI. <br> <br>      - <br>   -     ,       <code>IAsyncResult</code> .   ,  ,   ,  <code>GetQuestionnaire</code> ,   : <code>BeginGetQuestionnaire</code>  <code>EndGetQuestionnaire</code> .    ,   <code>BeginGetQuestionnaire</code> .     ,   ,   <code>EndGetQuestionnaire</code>    . <br> <b></b> <br>  .NET Framework <span class="hljs-number"><span class="hljs-number">4.5</span></span>      <code>await</code>  <code>async</code>     <code>*Async</code> .      <a href="http://msdn.microsoft.com/en-us/library/vstudio/hh391443.aspx"><span class="hljs-string"><span class="hljs-string">"Asynchronous Programming with Async and Await (C# and Visual Basic)"</span></span></a> . <br>  ,    <code>EndGetQuestionnaire</code> ,      ,  ()      <code>BeginGetQuestionnaire</code> .     ,      ,   <code>EndGetQuestionnaire</code> ,   . <br> <br> <code class="xml">IAsyncResult asyncResult = this.service.BeginGetQuestionnaire( GetQuestionnaireCompleted, null //  ,      ); private void GetQuestionnaireCompleted(IAsyncResult result) { try { questionnaire = this.service.EndGetQuestionnaire(ar); } catch (Exception ex) { //  -   . } }</code> <br>  ,     <code>End*</code> (  , <code>EndGetQuestionnaire</code> ),    ,      .      , ,          UI.     ,   ,        . <br> <br>        UI,     -,      UI,         UI,   <code>Dispatcher</code>    <code>SynchronizationContext</code> .  WPF  Silverlight,   <code>Dispatcher</code> . <br> <br>      <code>Questionnaire</code>  ,        <code>QuestionnaireView</code> .  Silverlight    <code>CheckAccess</code> ,  ,      UI.  ,     <code>BeginInvoke</code> ,      UI. <br> <br> <code class="cs">var dispatcher = System.Windows.Deployment.Current.Dispatcher; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (dispatcher.CheckAccess()) { QuestionnaireView.DataContext = questionnaire; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { dispatcher.BeginInvoke(() =&gt; { Questionnaire.DataContext = questionnaire; }); }</code> <br> <i>MVVM RI</i>   ,    ,   <code>IAsyncResult</code> ,   .      ,                 . ,       . <br> <br> <code class="cs">this.questionnaireRepository.GetQuestionnaireAsync( result =&gt; { this.Questionnaire = result.Result; });</code> <br>  <code>result</code>   ,     , , , .    ,     . <br> <br> <code class="cs">this.questionnaireRepository.GetQuestionnaireAsync( result =&gt; { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (result.Error == null) { this.Questionnaire = result.Result; ... } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { // Handle error. } })</code> <br>     <br>        ,      .     , ,             .        ,      ,     ,     . <br> <br>         ,      MVVM,     ,   . ,  -MVVM ,     <code>MessageBox</code>   code-behind UI,      .   MVVM     ,          . <br> <br>     MVVM,              ,          .      ,    ,   ,  ,     . <br> <br>              MVVM.      ,     ,     ,  ,     .    ,         ,     ,          .       . <br> <br>    <br>                  .        ,        .  ,         .         . <br> <br>  ,         ,         ,  .      ,     .           ,       . ,        WPF  Silverlight,        . <br> <br> <img title="Using the service to interact with the user." src="https://habrastorage.org/getpro/habr/post_images/4b5/397/f2d/4b5397f2d02e5851195b29f1893be6fc.png" alt=" ,    ."> <br> <br>  ,   <code>MessageBox</code>        ,     ,    ,     . <br> <br> <code class="cs">var result = interactionService.ShowMessageBox( <span class="hljs-string"><span class="hljs-string">"Are you sure you want to cancel this operation?"</span></span>, <span class="hljs-string"><span class="hljs-string">"Confirm"</span></span>, MessageBoxButton.OK); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (result == MessageBoxResult.Yes) { CancelRequest(); }</code> <br> ,      - ,      ,         Silverlight.         .             .     . <br> <br> <code class="cs">interactionService.ShowMessageBox( <span class="hljs-string"><span class="hljs-string">"Are you sure you want to cancel this operation?"</span></span>, <span class="hljs-string"><span class="hljs-string">"Confirm"</span></span>, MessageBoxButton.OK, result =&gt; { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (result == MessageBoxResult.Yes) { CancelRequest(); } });</code> <br>         ,      . ,  WPF    <code>MessageBox</code> ,       ;    Silverlight    ,    . <br> <br>     <br>         ‚Äì             .         ,      .     ,     .        ,        ,   ,     . <br> <br> <img title="Using interaction request objects." src="https://habrastorage.org/getpro/habr/post_images/3d0/ff0/1c5/3d0ff01c5518558c2d3c5c5f47ce0ce9.png" alt="   ."> <br> <br>    ,   ,          ‚Äì       ,      ,   ‚Äì     .   ,        ,    ,    UI            . <br> <br>       MVVM,     ,       ,         .         ,        ,    ,   . <br> <br>  Prism       <code>IInteractionRequest</code>   <code><code>InteractionRequest .  IInteractionRequest</code>  ,   .           ,   .  <code><code>InteractionRequest   IInteractionRequest</code>     <code>Raise</code> ,           , , ,   . <br> <br>       <br>  <code><code>InteractionRequest          .  Raise</code>          ( <code>T</code> )    ,    ,   .          ,       .      ,        .    ,  ,     . <br> <code class="cs">public interface IInteractionRequest { event EventHandler&lt;InteractionRequestedEventArgs&gt; Raised; } public class InteractionRequest&lt;T&gt; : IInteractionRequest { public event EventHandler&lt;InteractionRequestedEventArgs&gt; Raised; public void Raise(T context, Action&lt;T&gt; callback) { var handler = this.Raised; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (handler != null) { handler( this, new InteractionRequestedEventArgs(context, () =&gt; callback(context))); } } }</code> <br> Prism    ,      .  <code>Notification</code>       .    ,            .     ‚Äì <code>Title</code>  <code>Content</code> ,    .  ,   ,  ,  ,        . <br> <br>  <code>Confirmation</code>    <code>Notification</code>     ‚Äì <code>Confirmed</code> ,  ,  ,      .  <code>Confirmation</code> ,     <code>MessageBox</code> ,     /  .     ,     <code>Notification</code> ,     ,      . <br> <br>    <code><code><code>InteractionRequest ,       InteractionRequest      ,      .      ,    Raise</code> ,    , ,   . <br> <br> <code class="cs">public IInteractionRequest ConfirmCancelInteractionRequest { get { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> this.confirmCancelInteractionRequest; } } this.confirmCancelInteractionRequest.Raise( new Confirmation(<span class="hljs-string"><span class="hljs-string">"Are you sure you wish to cancel?"</span></span>), confirmation =&gt; { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (confirmation.Confirmed) { this.NavigateToQuestionnaireList(); } }); }</code> <br> <i>MVVM Reference Implementation (MVVM RI)</i> ,    <code>IInteractionRequest</code>   <code><code>InteractionRequest ,          (. QuestionnaireViewModel.cs</code> ). <br> <br>        <br>       ,       .   ,       .    UI             . <br> <br>                . Microsoft Expression Blend Behaviors Framework     .  ,     ,    . <br> <br>  <code>EventTrigger</code> ,  Expression Blend,  ,      ,     ,   . , Prism   <code>EventTrigger</code> ,  <code>InteractionRequestTrigger</code> ,      <code>Raised</code>   <code>IInteractionRequest</code> .    XAML        . <br> <br>  ,   , <code>InteractionRequestTrigger</code>   .  Silverlight Prism   <code>PopupChildWindowAction</code> ,     .    ,         .   <code>ContentTemplate</code>  <code>PopupChildWindowAction</code> ,    ,    UI,      <code>Content</code>  .       <code>Title</code>  . <br> <b></b> <br>  ,    ,   <code>PopupChildWindowAction</code> ,     .    <code>Notification</code>  <code>NotificationChildWindow</code> ,        <code>Confirmation</code> ‚Äì <code>ConfirmationChildWindow</code> . <code>NotificationChildWindow</code>    ,   ,     <code>ConfirmationChildWindow</code>    <i>OK</i>  <i>Cancel</i> ,    .    ,   ,   <code>ChildWindow</code>  <code>PopupChildWindowAction</code> . <br>   ,  <code>InteractionRequestTrigger</code>  <code>PopupChildWindowAction</code> ,       <i>RI MVVM</i> . <br> <br> <code class="xml">&lt;i:Interaction.Triggers&gt; &lt;prism:InteractionRequestTrigger SourceObject=<span class="hljs-string"><span class="hljs-string">"{Binding ConfirmCancelInteractionRequest}"</span></span>&gt; &lt;prism:PopupChildWindowAction ContentTemplate=<span class="hljs-string"><span class="hljs-string">"{StaticResource ConfirmWindowTemplate}"</span></span>/&gt; &lt;/prism:InteractionRequestTrigger&gt; &lt;/i:Interaction.Triggers&gt; &lt;UserControl.Resources&gt; &lt;DataTemplate x:Key=<span class="hljs-string"><span class="hljs-string">"ConfirmWindowTemplate"</span></span>&gt; &lt;Grid MinWidth=<span class="hljs-string"><span class="hljs-string">"250"</span></span> MinHeight=<span class="hljs-string"><span class="hljs-string">"100"</span></span>&gt; &lt;TextBlock TextWrapping=<span class="hljs-string"><span class="hljs-string">"Wrap"</span></span> Grid.Row=<span class="hljs-string"><span class="hljs-string">"0"</span></span> Text=<span class="hljs-string"><span class="hljs-string">"{Binding}"</span></span>/&gt; &lt;/Grid&gt; &lt;/DataTemplate&gt; &lt;/UserControl.Resources&gt;</code> <br> <b></b> <br>      <code>ContentTemplate</code> ,   UI   <code>Content</code>  .    <code>Content</code>  ,  , <code>TextBlock</code>     <code>Content</code> . <br>      ,     ,    ,    .  ,     ,       ,     ,    .   ,   <i>RI MVVM</i> ,         <code>Confirmed</code>    <code>Confirmation</code>  <code><span class="hljs-keyword"><span class="hljs-keyword">true</span></span></code> ,     OK. <br> <br>        ,     .  Prism <code>InteractionRequestTrigger</code>   <code>PopupChildWindowAction</code>            . <br> <br>     <br>     MVVM,       , ,    ,         .        (  , ,  ,   ).    ,  ,  ,            . <br> <br>        ,         . Managed Extensibility Framework (MEF)  Unity Application Block (Unity)      ,  ,           . <br> <br>  ,       , , ,    ( )      . ,       ,     .  ,     ,       . <br> <br>     ,  MEF <br>  MEF,       ,   <code>Import</code> ,      ,  ,   <code><span class="hljs-keyword"><span class="hljs-keyword">Export</span></span></code> .         ,    . <br> <br> , <code>QuestionnaireView</code>   <i>RI MVVM</i> ,        ,    <code>Import</code> .   , MEF           .  <code><span class="hljs-keyword"><span class="hljs-keyword">set</span></span></code>        ,   . <br> <br> <code class="cs">[Import] public QuestionnaireViewModel ViewModel { <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> { this.DataContext = value; } }</code> <br>     ,   . <br> <br> <code class="cs">[<span class="hljs-keyword"><span class="hljs-keyword">Export</span></span>] public class QuestionnaireViewModel : NotificationObject { ... }</code> <br>        ,   . <br> <br> <code class="cs">public QuestionnaireView() { InitializeComponent(); } [ImportingConstructor] public QuestionnaireView(QuestionnaireViewModel viewModel) : this() { this.DataContext = viewModel; }</code> <br> <b></b> <br>          MEF,   Unity.   ,     ,        .   ,   Visual Studio  Expression Blend, ,        ,     .   ,   ,  ,      ,          <code>InitializeComponent</code> . <br>     ,  Unity <br>  Unity,    ,   MEF.     ,      .    ,         .  ,      . <br> <br>  ,      ,  ,         . ,           ,   . <br> <br> <code class="cs">public QuestionnaireView() { InitializeComponent(); } public QuestionnaireView(QuestionnaireViewModel viewModel) : this() { this.DataContext = viewModel; }</code> <br> <b></b> <br>    ,        ,   Visual Studio  Expression Blend. <br>  ,          ,   . Unity        <code><span class="hljs-keyword"><span class="hljs-keyword">set</span></span></code>   ,   . <br> <br> <code class="cs">public QuestionnaireView() { InitializeComponent(); } [Dependency] public QuestionnaireViewModel ViewModel { <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> { this.DataContext = value; } }</code> <br>       Unity. <br> <br> <code class="cs">container.RegisterType&lt;QuestionnaireViewModel&gt;();</code> <br>  ,     . <br> <br> <code class="cs">var view = container.Resolve&lt;QuestionnaireView&gt;();</code> <br>     ,    <br>   ,     ,        .        ,   MEF  Unity,        . <br> <br>          .   ,         UI,           . <br> <br> , <i>RI MVVM</i>   ,   ,        .   ,    .      <code>ShowView</code>   UI. <br> <br> <code class="cs">private void NavigateToQuestionnaireList() { //     <span class="hljs-string"><span class="hljs-string">"questionnaire list"</span></span>. this.uiService.ShowView(ViewNames.QuestionnaireTemplatesList); }</code> <br>  UI      UI .           UI.  <code>ShowView</code>  <code>UIService</code>      (,          ),       ,   . <br> <br> <code class="cs">public void ShowView(<span class="hljs-keyword"><span class="hljs-keyword">string</span></span> viewName) { var view = this.ViewFactory.GetView(viewName); this.MainWindow.CurrentView = view; }</code> <br> <b></b> <br> Prism       .   ,   ,   ,             .    ,  , <span class="hljs-string"><span class="hljs-string">" </span></span><a href="http://msdn.microsoft.com/en-us/library/gg430861(v%3DPandP.40).aspx"><span class="hljs-string"><span class="hljs-string">View-Based Navigation</span></span></a><span class="hljs-string"><span class="hljs-string"> "</span></span>   <span class="hljs-number"><span class="hljs-number">8</span></span>, <span class="hljs-string"><span class="hljs-string">" </span></span><a href="http://msdn.microsoft.com/en-us/library/gg430861(v%3DPandP.40).aspx"><span class="hljs-string"><span class="hljs-string">Navigation</span></span></a><span class="hljs-string"><span class="hljs-string"> "</span></span>. <br>  MVVM  <br>        MVVM      .           -      mocking . ,   ,        . <br> <br>   <i>INotifyPropertyChanged</i> <br>   <code>INotifyPropertyChanged</code>     ,      .      ,    ;   ,   ,     ,    ,       . <br> <br>   <br> ,       ,           <code>PropertyChanged</code>  ,         .  ,    <code>ChangeTracker</code> ,     MVVM,  ,      .      .     ,    . <br> <br> <code class="cs">var changeTracker = new PropertyChangeTracker(viewModel); viewModel.CurrentState = <span class="hljs-string"><span class="hljs-string">"newState"</span></span>; CollectionAssert.Contains(changeTracker.ChangedProperties, <span class="hljs-string"><span class="hljs-string">"CurrentState"</span></span>);</code> <br> ,     ,     <code>INotifyPropertyChanged</code> ,    ,   ,     . <br> <br>      <br>        ,   ,    <code><span class="hljs-keyword"><span class="hljs-keyword">set</span></span></code>      ,           . ,     ,     ,      ,          . <br> <br> <code class="cs">var changeTracker = new PropertyChangeTracker(viewModel); var question = viewModel.Questions.First() as OpenQuestionViewModel; question.Question.Response = <span class="hljs-string"><span class="hljs-string">"some text"</span></span>; CollectionAssert.Contains(changeTracker.ChangedProperties, <span class="hljs-string"><span class="hljs-string">"UnansweredQuestions"</span></span>);</code> <br>      <br>     <code>INotifyPropertyChanged</code> ,      <code>PropertyChanged</code>        ,  ,     , , .        ,       . <br> <br>   <i>INotifyDataErrorInfo</i> <br>   ,     ,    ,   ,   <code>IDataErrorInfo</code> ,  ( Silverlight)   <code>INotifyDataErrorInfo</code> .   <code>INotifyDataErrorInfo</code>   ,         ,    ,  ,   ,    . <br> <br>       <code>INotifyDataErrorInfo</code> : ,     ,  ,     ,     <code>ErrorsChanged</code> ,      <code>GetErrors</code> , . <br> <br>    <br>     ,      ,     .       ,         <code>GetErrors</code>       ,  ,  ,   .    , ,  ,     ,        .   ,        . <br> <br> <code class="cs">//  . var notifyErrorInfo = (INotifyDataErrorInfo)question; question.Response = -<span class="hljs-number"><span class="hljs-number">15</span></span>; Assert.IsTrue(notifyErrorInfo.GetErrors(<span class="hljs-string"><span class="hljs-string">"Response"</span></span>).Cast&lt;ValidationResult&gt;().Any()); //  . var notifyErrorInfo = (INotifyDataErrorInfo)question; question.Response = <span class="hljs-number"><span class="hljs-number">15</span></span>; Assert.IsFalse(notifyErrorInfo.GetErrors(<span class="hljs-string"><span class="hljs-string">"Response"</span></span>).Cast&lt;ValidationResult&gt;().Any());</code> <br>    ,    ,             . <br> <br>    <i>INotifyDataErrorInfo</i> <br>       <code>GetErrors</code> ,   <code>INotifyDataErrorInfo</code>  ,   <code>ErrorsChanged</code>      <code>GetErrors</code> . ,  <code>HasErrors</code>      ,  . <br> <br>       <code>INotifyDataErrorInfo</code> . , ,           ,   -  .      ,        <code>INotifyDataErrorInfo</code>         (,        ). <br> <br>     ,   ,  : <br>  <code>HasErrors</code>     .              ,       .  <code>ErrorsChanged</code> ,      ,         <code>GetErrors</code> .         ( ,  )     ,           .    <code>GetErrors</code>       <code>ErrorsChanged</code> . <br>    <code>INotifyPropertyChanged</code> ,  ,    <code>NotifyDataErrorInfoTestHelper</code>    MVVM,        <code>INotifyDataErrorInfo</code> ,       .   ,   ,      ,   .      . <br> <code class="cs">var helper = new NotifyDataErrorInfoTestHelper&lt;NumericQuestion, int?&gt;( question, q =&gt; q.Response); helper.ValidatePropertyChange( <span class="hljs-number"><span class="hljs-number">6</span></span>, NotifyDataErrorInfoBehavior.Nothing); helper.ValidatePropertyChange( <span class="hljs-number"><span class="hljs-number">20</span></span>, NotifyDataErrorInfoBehavior.FiresErrorsChanged | NotifyDataErrorInfoBehavior.HasErrors | NotifyDataErrorInfoBehavior.HasErrorsForProperty); helper.ValidatePropertyChange( null, NotifyDataErrorInfoBehavior.FiresErrorsChanged | NotifyDataErrorInfoBehavior.HasErrors | NotifyDataErrorInfoBehavior.HasErrorsForProperty); helper.ValidatePropertyChange( <span class="hljs-number"><span class="hljs-number">2</span></span>, NotifyDataErrorInfoBehavior.FiresErrorsChanged);</code> <br>     <br>   MVVM,     ,  .   ,    ,         . <br> <br>  ,     ,     ,       .   ,   , ,       ,     ,   <code>IAsyncResult</code>    ,  - ,   ,    UI. <br> <br>       , , ,    .   ,     .  ,      UI,     ,   ,          ,     ,        <span class="hljs-string"><span class="hljs-string">"   UI."</span></span> <br> <br>     ,    ,    .   ,    ,     mock-, ,   ,   ,      ,          . <br> <br>           UI,    ,    .   ,     ,   ,      .        ,   .     ,    ,     . <br> <br> <code class="cs">questionnaireRepositoryMock .Setup( r =&gt; r.SubmitQuestionnaireAsync( It.IsAny&lt;Questionnaire&gt;(), It.IsAny&lt;Action&lt;IOperationResult&gt;&gt;())) .Callback&lt;Questionnaire, Action&lt;IOperationResult&gt;&gt;( (q, a) =&gt; callback = a); uiServicemock .Setup(svc =&gt; svc.ShowView(ViewNames.QuestionnaireTemplatesList)) .Callback&lt;<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>&gt;(viewName =&gt; requestedViewName = viewName); submitResultMock .Setup(sr =&gt; sr.Error) .Returns&lt;Exception&gt;(null); CompleteQuestionnaire(viewModel); viewModel.Submit(); //      UI . callback(submitResultMock.Object); //    ‚Äì     . Assert.AreEqual(ViewNames.QuestionnaireTemplatesList, requestedViewName);</code> <br> <b></b> <br>          ,        . <br>   <br>       , . <span class="hljs-string"><span class="hljs-string">"Trees in WPF"</span></span>  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ms753391.aspx">http://msdn.microsoft.com/en-us/library/ms753391.aspx</a> <br> <br>       , . <span class="hljs-string"><span class="hljs-string">"Attached Properties Overview"</span></span>  MSDN: <a href="http://msdn.microsoft.com/en-us/library/cc265152(VS.95).aspx">http://msdn.microsoft.com/en-us/library/cc265152(VS.<span class="hljs-number"><span class="hljs-number">95</span></span>).aspx</a> <br> <br>      MEF, .<span class="hljs-string"><span class="hljs-string">"Managed Extensibility Framework Overview"</span></span>  MSDN: <a href="http://msdn.microsoft.com/en-us/library/dd460648.aspx">http://msdn.microsoft.com/en-us/library/dd460648.aspx</a> . <br> <br>      Unity, .<span class="hljs-string"><span class="hljs-string">"Unity Application Block"</span></span>  MSDN: <a href="http://www.msdn.com/unity">http://www.msdn.com/unity</a> . <br> <br>      <code>DelegateCommand</code> , .Chapter <span class="hljs-number"><span class="hljs-number">5</span></span>, <span class="hljs-string"><span class="hljs-string">" </span></span><a href="http://msdn.microsoft.com/en-us/library/gg405484(v%3DPandP.40).aspx"><span class="hljs-string"><span class="hljs-string">Implementing the MVVM Pattern</span></span></a><span class="hljs-string"><span class="hljs-string"> ."</span></span> <br> <br>        Microsoft Expression Blend, .<span class="hljs-string"><span class="hljs-string">"Working with built-in behaviors"</span></span>  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ff724013(v%3DExpression.40).aspx">http://msdn.microsoft.com/en-us/library/ff724013(v=Expression.<span class="hljs-number"><span class="hljs-number">40</span></span>).aspx</a> . <br> <br>          Microsoft Expression Blend, .<span class="hljs-string"><span class="hljs-string">"Creating Custom Behaviors"</span></span>  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ff724708(v%3DExpression.40).aspx">http://msdn.microsoft.com/en-us/library/ff724708(v=Expression.<span class="hljs-number"><span class="hljs-number">40</span></span>).aspx</a> . <br> <br>            Microsoft Expression Blend, .<span class="hljs-string"><span class="hljs-string">"Creating Custom Triggers and Actions"</span></span>  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ff724707(v%3DExpression.40).aspx">http://msdn.microsoft.com/en-us/library/ff724707(v=Expression.<span class="hljs-number"><span class="hljs-number">40</span></span>).aspx</a> . <br> <br>         WPF  Silverlight, .<span class="hljs-string"><span class="hljs-string">"Threading Model"</span></span>  <span class="hljs-string"><span class="hljs-string">"The Dispatcher Class"</span></span>  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ms741870.aspx">http://msdn.microsoft.com/en-us/library/ms741870.aspx</a> <br> <a href="http://msdn.microsoft.com/en-us/library/ms615907(v%3DVS.95).aspx">http://msdn.microsoft.com/en-us/library/ms615907(v=VS.<span class="hljs-number"><span class="hljs-number">95</span></span>).aspx</a> . <br> <br>      unit-  Silverlight, .<span class="hljs-string"><span class="hljs-string">"Unit Testing with Silverlight 2"</span></span>: <a href="http://www.jeff.wilcox.name/2008/03/silverlight2-unit-testing/">http://www.jeff.wilcox.name/<span class="hljs-number"><span class="hljs-number">2008</span></span>/<span class="hljs-number"><span class="hljs-number">03</span></span>/silverlight2-unit-testing/</a> . <br> <br>         , .  <span class="hljs-string"><span class="hljs-string">" </span></span><a href="http://msdn.microsoft.com/en-us/library/gg430861(v%3DPandP.40).aspx"><span class="hljs-string"><span class="hljs-string">View-Based Navigation</span></span></a><span class="hljs-string"><span class="hljs-string"> "</span></span> in Chapter <span class="hljs-number"><span class="hljs-number">8</span></span>, <span class="hljs-string"><span class="hljs-string">" </span></span><a href="http://msdn.microsoft.com/en-us/library/gg430861(v%3DPandP.40).aspx"><span class="hljs-string"><span class="hljs-string">Navigation</span></span></a><span class="hljs-string"><span class="hljs-string"> ."</span></span> <br> <br>       ,   , .<span class="hljs-string"><span class="hljs-string">"Event-based Asynchronous Pattern Overview"</span></span>  MSDN: <a href="http://msdn.microsoft.com/en-us/library/wewwczdw.aspx">http://msdn.microsoft.com/en-us/library/wewwczdw.aspx</a> <br> <br>        <code>IAsyncResult</code> , .<span class="hljs-string"><span class="hljs-string">"Asynchronous Programming Overview"</span></span>  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ms228963.aspx">http://msdn.microsoft.com/en-us/library/ms228963.aspx</a></code></code></code></code></code></code></code></code></code> </pre> <code><code><code><code>CommandBehaviorBase ,    ,    ICommand</code> .           <code>CanExecuteChanged</code> ,          Silverlight,    WPF. <br> <br>    ,  ,   <code>CommandBehaviorBase    ,    .         ,      .         ,    .      ButtonBaseClickCommandBehavior</code> . <br> <br> <code class="cs">public class ButtonBaseClickCommandBehavior : CommandBehaviorBase&lt;ButtonBase&gt; { public ButtonBaseClickCommandBehavior(ButtonBase clickableObject) : base(clickableObject) { clickableObject.Click += OnClick; } private void OnClick(object sender, System.Windows.RoutedEventArgs e) { ExecuteCommand(); } }</code> <br>   <code>CommandBehaviorBase ,     .     ,          ,   . ,    ,    ,      , ,    CanExecute</code>  ,     . <br> <br>          ,   .           XAML.           .       .  Prism      ,       ,  ,   .       ,    . , ,  ,      <code>Click</code> ,       <code>Command</code> .    <code>Click.Command</code> ,  . <br> <br>             .             . <br> <br> <code class="cs">public static readonly DependencyProperty CommandProperty = DependencyProperty.RegisterAttached( "Command", typeof(ICommand), typeof(Click), new PropertyMetadata(OnSetCommandCallback)); private static readonly DependencyProperty ClickCommandBehaviorProperty = DependencyProperty.RegisterAttached( "ClickCommandBehavior", typeof(ButtonBaseClickCommandBehavior), typeof(Click), null);</code> <br>    <code>Command</code>    <code>ButtonBaseClickCommandBehavior</code> ,     <code>OnSetCommandCallback</code> ,     . <br> <br> <code class="cs">private static void OnSetCommandCallback(DependencyObject dependencyObject, DependencyPropertyChangedEventArgs e) { ButtonBase buttonBase = dependencyObject as ButtonBase; if (buttonBase != null) { ButtonBaseClickCommandBehavior behavior = GetOrCreateBehavior(buttonBase); behavior.Command = e.NewValue as ICommand; } } private static void OnSetCommandParameterCallback(DependencyObject dependencyObject, DependencyPropertyChangedEventArgs e) { ButtonBase buttonBase = dependencyObject as ButtonBase; if (buttonBase != null) { ButtonBaseClickCommandBehavior behavior = GetOrCreateBehavior(buttonBase); behavior.CommandParameter = e.NewValue; } } private static ButtonBaseClickCommandBehavior GetOrCreateBehavior(ButtonBase buttonBase ) { ButtonBaseClickCommandBehavior behavior = buttonBase.GetValue(ClickCommandBehaviorProperty) as ButtonBaseClickCommandBehavior; if ( behavior == null ) { behavior = new ButtonBaseClickCommandBehavior(buttonBase); buttonBase.SetValue(ClickCommandBehaviorProperty, behavior); } return behavior; }</code> <br>        ,  <a href="http://msdn.microsoft.com/en-us/library/cc265152(VS.95).aspx">Attached Properties Overview</a>  MSDN. <br> <br>    <br>              . ,     Silverlight,    -,     ,      ,     .     ,       . <br> <br>        ,    ( )  ,  ,     .  UI       ,            UI. <br> <br>      - <br>   -     ,       <code>IAsyncResult</code> .   ,  ,   ,  <code>GetQuestionnaire</code> ,   : <code>BeginGetQuestionnaire</code>  <code>EndGetQuestionnaire</code> .    ,   <code>BeginGetQuestionnaire</code> .     ,   ,   <code>EndGetQuestionnaire</code>    . <br> <b></b> <br>  .NET Framework 4.5      <code>await</code>  <code>async</code>     <code>*Async</code> .      <a href="http://msdn.microsoft.com/en-us/library/vstudio/hh391443.aspx">"Asynchronous Programming with Async and Await (C# and Visual Basic)"</a> . <br>  ,    <code>EndGetQuestionnaire</code> ,      ,  ()      <code>BeginGetQuestionnaire</code> .     ,      ,   <code>EndGetQuestionnaire</code> ,   . <br> <br> <code class="xml">IAsyncResult asyncResult = this.service.BeginGetQuestionnaire( GetQuestionnaireCompleted, null //  ,      ); private void GetQuestionnaireCompleted(IAsyncResult result) { try { questionnaire = this.service.EndGetQuestionnaire(ar); } catch (Exception ex) { //  -   . } }</code> <br>  ,     <code>End*</code> (  , <code>EndGetQuestionnaire</code> ),    ,      .      , ,          UI.     ,   ,        . <br> <br>        UI,     -,      UI,         UI,   <code>Dispatcher</code>    <code>SynchronizationContext</code> .  WPF  Silverlight,   <code>Dispatcher</code> . <br> <br>      <code>Questionnaire</code>  ,        <code>QuestionnaireView</code> .  Silverlight    <code>CheckAccess</code> ,  ,      UI.  ,     <code>BeginInvoke</code> ,      UI. <br> <br> <code class="cs">var dispatcher = System.Windows.Deployment.Current.Dispatcher; if (dispatcher.CheckAccess()) { QuestionnaireView.DataContext = questionnaire; } else { dispatcher.BeginInvoke(() =&gt; { Questionnaire.DataContext = questionnaire; }); }</code> <br> <i>MVVM RI</i>   ,    ,   <code>IAsyncResult</code> ,   .      ,                 . ,       . <br> <br> <code class="cs">this.questionnaireRepository.GetQuestionnaireAsync( result =&gt; { this.Questionnaire = result.Result; });</code> <br>  <code>result</code>   ,     , , , .    ,     . <br> <br> <code class="cs">this.questionnaireRepository.GetQuestionnaireAsync( result =&gt; { if (result.Error == null) { this.Questionnaire = result.Result; ... } else { // Handle error. } })</code> <br>     <br>        ,      .     , ,             .        ,      ,     ,     . <br> <br>         ,      MVVM,     ,   . ,  -MVVM ,     <code>MessageBox</code>   code-behind UI,      .   MVVM     ,          . <br> <br>     MVVM,              ,          .      ,    ,   ,  ,     . <br> <br>              MVVM.      ,     ,     ,  ,     .    ,         ,     ,          .       . <br> <br>    <br>                  .        ,        .  ,         .         . <br> <br>  ,         ,         ,  .      ,     .           ,       . ,        WPF  Silverlight,        . <br> <br> <img title="Using the service to interact with the user." src="https://habrastorage.org/getpro/habr/post_images/4b5/397/f2d/4b5397f2d02e5851195b29f1893be6fc.png" alt=" ,    ."> <br> <br>  ,   <code>MessageBox</code>        ,     ,    ,     . <br> <br> <code class="cs">var result = interactionService.ShowMessageBox( "Are you sure you want to cancel this operation?", "Confirm", MessageBoxButton.OK); if (result == MessageBoxResult.Yes) { CancelRequest(); }</code> <br> ,      - ,      ,         Silverlight.         .             .     . <br> <br> <code class="cs">interactionService.ShowMessageBox( "Are you sure you want to cancel this operation?", "Confirm", MessageBoxButton.OK, result =&gt; { if (result == MessageBoxResult.Yes) { CancelRequest(); } });</code> <br>         ,      . ,  WPF    <code>MessageBox</code> ,       ;    Silverlight    ,    . <br> <br>     <br>         ‚Äì             .         ,      .     ,     .        ,        ,   ,     . <br> <br> <img title="Using interaction request objects." src="https://habrastorage.org/getpro/habr/post_images/3d0/ff0/1c5/3d0ff01c5518558c2d3c5c5f47ce0ce9.png" alt="   ."> <br> <br>    ,   ,          ‚Äì       ,      ,   ‚Äì     .   ,        ,    ,    UI            . <br> <br>       MVVM,     ,       ,         .         ,        ,    ,   . <br> <br>  Prism       <code>IInteractionRequest</code>   <code><code>InteractionRequest .  IInteractionRequest</code>  ,   .           ,   .  <code><code>InteractionRequest   IInteractionRequest</code>     <code>Raise</code> ,           , , ,   . <br> <br>       <br>  <code><code>InteractionRequest          .  Raise</code>          ( <code>T</code> )    ,    ,   .          ,       .      ,        .    ,  ,     . <br> <code class="cs">public interface IInteractionRequest { event EventHandler&lt;InteractionRequestedEventArgs&gt; Raised; } public class InteractionRequest&lt;T&gt; : IInteractionRequest { public event EventHandler&lt;InteractionRequestedEventArgs&gt; Raised; public void Raise(T context, Action&lt;T&gt; callback) { var handler = this.Raised; if (handler != null) { handler( this, new InteractionRequestedEventArgs(context, () =&gt; callback(context))); } } }</code> <br> Prism    ,      .  <code>Notification</code>       .    ,            .     ‚Äì <code>Title</code>  <code>Content</code> ,    .  ,   ,  ,  ,        . <br> <br>  <code>Confirmation</code>    <code>Notification</code>     ‚Äì <code>Confirmed</code> ,  ,  ,      .  <code>Confirmation</code> ,     <code>MessageBox</code> ,     /  .     ,     <code>Notification</code> ,     ,      . <br> <br>    <code><code><code>InteractionRequest ,       InteractionRequest      ,      .      ,    Raise</code> ,    , ,   . <br> <br> <code class="cs">public IInteractionRequest ConfirmCancelInteractionRequest { get { return this.confirmCancelInteractionRequest; } } this.confirmCancelInteractionRequest.Raise( new Confirmation("Are you sure you wish to cancel?"), confirmation =&gt; { if (confirmation.Confirmed) { this.NavigateToQuestionnaireList(); } }); }</code> <br> <i>MVVM Reference Implementation (MVVM RI)</i> ,    <code>IInteractionRequest</code>   <code><code>InteractionRequest ,          (. QuestionnaireViewModel.cs</code> ). <br> <br>        <br>       ,       .   ,       .    UI             . <br> <br>                . Microsoft Expression Blend Behaviors Framework     .  ,     ,    . <br> <br>  <code>EventTrigger</code> ,  Expression Blend,  ,      ,     ,   . , Prism   <code>EventTrigger</code> ,  <code>InteractionRequestTrigger</code> ,      <code>Raised</code>   <code>IInteractionRequest</code> .    XAML        . <br> <br>  ,   , <code>InteractionRequestTrigger</code>   .  Silverlight Prism   <code>PopupChildWindowAction</code> ,     .    ,         .   <code>ContentTemplate</code>  <code>PopupChildWindowAction</code> ,    ,    UI,      <code>Content</code>  .       <code>Title</code>  . <br> <b></b> <br>  ,    ,   <code>PopupChildWindowAction</code> ,     .    <code>Notification</code>  <code>NotificationChildWindow</code> ,        <code>Confirmation</code> ‚Äì <code>ConfirmationChildWindow</code> . <code>NotificationChildWindow</code>    ,   ,     <code>ConfirmationChildWindow</code>    <i>OK</i>  <i>Cancel</i> ,    .    ,   ,   <code>ChildWindow</code>  <code>PopupChildWindowAction</code> . <br>   ,  <code>InteractionRequestTrigger</code>  <code>PopupChildWindowAction</code> ,       <i>RI MVVM</i> . <br> <br> <code class="xml">&lt;i:Interaction.Triggers&gt; &lt;prism:InteractionRequestTrigger SourceObject="{Binding ConfirmCancelInteractionRequest}"&gt; &lt;prism:PopupChildWindowAction ContentTemplate="{StaticResource ConfirmWindowTemplate}"/&gt; &lt;/prism:InteractionRequestTrigger&gt; &lt;/i:Interaction.Triggers&gt; &lt;UserControl.Resources&gt; &lt;DataTemplate x:Key="ConfirmWindowTemplate"&gt; &lt;Grid MinWidth="250" MinHeight="100"&gt; &lt;TextBlock TextWrapping="Wrap" Grid.Row="0" Text="{Binding}"/&gt; &lt;/Grid&gt; &lt;/DataTemplate&gt; &lt;/UserControl.Resources&gt;</code> <br> <b></b> <br>      <code>ContentTemplate</code> ,   UI   <code>Content</code>  .    <code>Content</code>  ,  , <code>TextBlock</code>     <code>Content</code> . <br>      ,     ,    ,    .  ,     ,       ,     ,    .   ,   <i>RI MVVM</i> ,         <code>Confirmed</code>    <code>Confirmation</code>  <code>true</code> ,     OK. <br> <br>        ,     .  Prism <code>InteractionRequestTrigger</code>   <code>PopupChildWindowAction</code>            . <br> <br>     <br>     MVVM,       , ,    ,         .        (  , ,  ,   ).    ,  ,  ,            . <br> <br>        ,         . Managed Extensibility Framework (MEF)  Unity Application Block (Unity)      ,  ,           . <br> <br>  ,       , , ,    ( )      . ,       ,     .  ,     ,       . <br> <br>     ,  MEF <br>  MEF,       ,   <code>Import</code> ,      ,  ,   <code>Export</code> .         ,    . <br> <br> , <code>QuestionnaireView</code>   <i>RI MVVM</i> ,        ,    <code>Import</code> .   , MEF           .  <code>set</code>        ,   . <br> <br> <code class="cs">[Import] public QuestionnaireViewModel ViewModel { set { this.DataContext = value; } }</code> <br>     ,   . <br> <br> <code class="cs">[Export] public class QuestionnaireViewModel : NotificationObject { ... }</code> <br>        ,   . <br> <br> <code class="cs">public QuestionnaireView() { InitializeComponent(); } [ImportingConstructor] public QuestionnaireView(QuestionnaireViewModel viewModel) : this() { this.DataContext = viewModel; }</code> <br> <b></b> <br>          MEF,   Unity.   ,     ,        .   ,   Visual Studio  Expression Blend, ,        ,     .   ,   ,  ,      ,          <code>InitializeComponent</code> . <br>     ,  Unity <br>  Unity,    ,   MEF.     ,      .    ,         .  ,      . <br> <br>  ,      ,  ,         . ,           ,   . <br> <br> <code class="cs">public QuestionnaireView() { InitializeComponent(); } public QuestionnaireView(QuestionnaireViewModel viewModel) : this() { this.DataContext = viewModel; }</code> <br> <b></b> <br>    ,        ,   Visual Studio  Expression Blend. <br>  ,          ,   . Unity        <code>set</code>   ,   . <br> <br> <code class="cs">public QuestionnaireView() { InitializeComponent(); } [Dependency] public QuestionnaireViewModel ViewModel { set { this.DataContext = value; } }</code> <br>       Unity. <br> <br> <code class="cs">container.RegisterType&lt;QuestionnaireViewModel&gt;();</code> <br>  ,     . <br> <br> <code class="cs">var view = container.Resolve&lt;QuestionnaireView&gt;();</code> <br>     ,    <br>   ,     ,        .        ,   MEF  Unity,        . <br> <br>          .   ,         UI,           . <br> <br> , <i>RI MVVM</i>   ,   ,        .   ,    .      <code>ShowView</code>   UI. <br> <br> <code class="cs">private void NavigateToQuestionnaireList() { //     "questionnaire list". this.uiService.ShowView(ViewNames.QuestionnaireTemplatesList); }</code> <br>  UI      UI .           UI.  <code>ShowView</code>  <code>UIService</code>      (,          ),       ,   . <br> <br> <code class="cs">public void ShowView(string viewName) { var view = this.ViewFactory.GetView(viewName); this.MainWindow.CurrentView = view; }</code> <br> <b></b> <br> Prism       .   ,   ,   ,             .    ,  , " <a href="http://msdn.microsoft.com/en-us/library/gg430861(v%3DPandP.40).aspx">View-Based Navigation</a> "   8, " <a href="http://msdn.microsoft.com/en-us/library/gg430861(v%3DPandP.40).aspx">Navigation</a> ". <br>  MVVM  <br>        MVVM      .           -      mocking . ,   ,        . <br> <br>   <i>INotifyPropertyChanged</i> <br>   <code>INotifyPropertyChanged</code>     ,      .      ,    ;   ,   ,     ,    ,       . <br> <br>   <br> ,       ,           <code>PropertyChanged</code>  ,         .  ,    <code>ChangeTracker</code> ,     MVVM,  ,      .      .     ,    . <br> <br> <code class="cs">var changeTracker = new PropertyChangeTracker(viewModel); viewModel.CurrentState = "newState"; CollectionAssert.Contains(changeTracker.ChangedProperties, "CurrentState");</code> <br> ,     ,     <code>INotifyPropertyChanged</code> ,    ,   ,     . <br> <br>      <br>        ,   ,    <code>set</code>      ,           . ,     ,     ,      ,          . <br> <br> <code class="cs">var changeTracker = new PropertyChangeTracker(viewModel); var question = viewModel.Questions.First() as OpenQuestionViewModel; question.Question.Response = "some text"; CollectionAssert.Contains(changeTracker.ChangedProperties, "UnansweredQuestions");</code> <br>      <br>     <code>INotifyPropertyChanged</code> ,      <code>PropertyChanged</code>        ,  ,     , , .        ,       . <br> <br>   <i>INotifyDataErrorInfo</i> <br>   ,     ,    ,   ,   <code>IDataErrorInfo</code> ,  ( Silverlight)   <code>INotifyDataErrorInfo</code> .   <code>INotifyDataErrorInfo</code>   ,         ,    ,  ,   ,    . <br> <br>       <code>INotifyDataErrorInfo</code> : ,     ,  ,     ,     <code>ErrorsChanged</code> ,      <code>GetErrors</code> , . <br> <br>    <br>     ,      ,     .       ,         <code>GetErrors</code>       ,  ,  ,   .    , ,  ,     ,        .   ,        . <br> <br> <code class="cs">//  . var notifyErrorInfo = (INotifyDataErrorInfo)question; question.Response = -15; Assert.IsTrue(notifyErrorInfo.GetErrors("Response").Cast&lt;ValidationResult&gt;().Any()); //  . var notifyErrorInfo = (INotifyDataErrorInfo)question; question.Response = 15; Assert.IsFalse(notifyErrorInfo.GetErrors("Response").Cast&lt;ValidationResult&gt;().Any());</code> <br>    ,    ,             . <br> <br>    <i>INotifyDataErrorInfo</i> <br>       <code>GetErrors</code> ,   <code>INotifyDataErrorInfo</code>  ,   <code>ErrorsChanged</code>      <code>GetErrors</code> . ,  <code>HasErrors</code>      ,  . <br> <br>       <code>INotifyDataErrorInfo</code> . , ,           ,   -  .      ,        <code>INotifyDataErrorInfo</code>         (,        ). <br> <br>     ,   ,  : <br>  <code>HasErrors</code>     .              ,       .  <code>ErrorsChanged</code> ,      ,         <code>GetErrors</code> .         ( ,  )     ,           .    <code>GetErrors</code>       <code>ErrorsChanged</code> . <br>    <code>INotifyPropertyChanged</code> ,  ,    <code>NotifyDataErrorInfoTestHelper</code>    MVVM,        <code>INotifyDataErrorInfo</code> ,       .   ,   ,      ,   .      . <br> <code class="cs">var helper = new NotifyDataErrorInfoTestHelper&lt;NumericQuestion, int?&gt;( question, q =&gt; q.Response); helper.ValidatePropertyChange( 6, NotifyDataErrorInfoBehavior.Nothing); helper.ValidatePropertyChange( 20, NotifyDataErrorInfoBehavior.FiresErrorsChanged | NotifyDataErrorInfoBehavior.HasErrors | NotifyDataErrorInfoBehavior.HasErrorsForProperty); helper.ValidatePropertyChange( null, NotifyDataErrorInfoBehavior.FiresErrorsChanged | NotifyDataErrorInfoBehavior.HasErrors | NotifyDataErrorInfoBehavior.HasErrorsForProperty); helper.ValidatePropertyChange( 2, NotifyDataErrorInfoBehavior.FiresErrorsChanged);</code> <br>     <br>   MVVM,     ,  .   ,    ,         . <br> <br>  ,     ,     ,       .   ,   , ,       ,     ,   <code>IAsyncResult</code>    ,  - ,   ,    UI. <br> <br>       , , ,    .   ,     .  ,      UI,     ,   ,          ,     ,        "   UI." <br> <br>     ,    ,    .   ,    ,     mock-, ,   ,   ,      ,          . <br> <br>           UI,    ,    .   ,     ,   ,      .        ,   .     ,    ,     . <br> <br> <code class="cs">questionnaireRepositoryMock .Setup( r =&gt; r.SubmitQuestionnaireAsync( It.IsAny&lt;Questionnaire&gt;(), It.IsAny&lt;Action&lt;IOperationResult&gt;&gt;())) .Callback&lt;Questionnaire, Action&lt;IOperationResult&gt;&gt;( (q, a) =&gt; callback = a); uiServicemock .Setup(svc =&gt; svc.ShowView(ViewNames.QuestionnaireTemplatesList)) .Callback&lt;string&gt;(viewName =&gt; requestedViewName = viewName); submitResultMock .Setup(sr =&gt; sr.Error) .Returns&lt;Exception&gt;(null); CompleteQuestionnaire(viewModel); viewModel.Submit(); //      UI . callback(submitResultMock.Object); //    ‚Äì     . Assert.AreEqual(ViewNames.QuestionnaireTemplatesList, requestedViewName);</code> <br> <b></b> <br>          ,        . <br>   <br>       , . "Trees in WPF"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ms753391.aspx">http://msdn.microsoft.com/en-us/library/ms753391.aspx</a> <br> <br>       , . "Attached Properties Overview"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/cc265152(VS.95).aspx">http://msdn.microsoft.com/en-us/library/cc265152(VS.95).aspx</a> <br> <br>      MEF, ."Managed Extensibility Framework Overview"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/dd460648.aspx">http://msdn.microsoft.com/en-us/library/dd460648.aspx</a> . <br> <br>      Unity, ."Unity Application Block"  MSDN: <a href="http://www.msdn.com/unity">http://www.msdn.com/unity</a> . <br> <br>      <code>DelegateCommand</code> , .Chapter 5, " <a href="http://msdn.microsoft.com/en-us/library/gg405484(v%3DPandP.40).aspx">Implementing the MVVM Pattern</a> ." <br> <br>        Microsoft Expression Blend, ."Working with built-in behaviors"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ff724013(v%3DExpression.40).aspx">http://msdn.microsoft.com/en-us/library/ff724013(v=Expression.40).aspx</a> . <br> <br>          Microsoft Expression Blend, ."Creating Custom Behaviors"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ff724708(v%3DExpression.40).aspx">http://msdn.microsoft.com/en-us/library/ff724708(v=Expression.40).aspx</a> . <br> <br>            Microsoft Expression Blend, ."Creating Custom Triggers and Actions"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ff724707(v%3DExpression.40).aspx">http://msdn.microsoft.com/en-us/library/ff724707(v=Expression.40).aspx</a> . <br> <br>         WPF  Silverlight, ."Threading Model"  "The Dispatcher Class"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ms741870.aspx">http://msdn.microsoft.com/en-us/library/ms741870.aspx</a> <br> <a href="http://msdn.microsoft.com/en-us/library/ms615907(v%3DVS.95).aspx">http://msdn.microsoft.com/en-us/library/ms615907(v=VS.95).aspx</a> . <br> <br>      unit-  Silverlight, ."Unit Testing with Silverlight 2": <a href="http://www.jeff.wilcox.name/2008/03/silverlight2-unit-testing/">http://www.jeff.wilcox.name/2008/03/silverlight2-unit-testing/</a> . <br> <br>         , .  " <a href="http://msdn.microsoft.com/en-us/library/gg430861(v%3DPandP.40).aspx">View-Based Navigation</a> " in Chapter 8, " <a href="http://msdn.microsoft.com/en-us/library/gg430861(v%3DPandP.40).aspx">Navigation</a> ." <br> <br>       ,   , ."Event-based Asynchronous Pattern Overview"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/wewwczdw.aspx">http://msdn.microsoft.com/en-us/library/wewwczdw.aspx</a> <br> <br>        <code>IAsyncResult</code> , ."Asynchronous Programming Overview"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ms228963.aspx">http://msdn.microsoft.com/en-us/library/ms228963.aspx</a></code></code></code></code></code></code></code></code></code> <pre> <code class="hljs cmake"><code>CommandBehaviorBase ,    ,    ICommand</code> .           <code>CanExecuteChanged</code> ,          Silverlight,    WPF. <br> <br>    ,  ,   <code><code>CommandBehaviorBase    ,    .         ,      .         ,    .      ButtonBaseClickCommandBehavior</code> . <br> <br> <code class="cs">public class ButtonBaseClickCommandBehavior : CommandBehaviorBase&lt;ButtonBase&gt; { public ButtonBaseClickCommandBehavior(ButtonBase clickableObject) : base(clickableObject) { clickableObject.Click += OnClick; } private void OnClick(object sender, System.Windows.RoutedEventArgs e) { ExecuteCommand(); } }</code> <br>   <code><code>CommandBehaviorBase ,     .     ,          ,   . ,    ,    ,      , ,    CanExecute</code>  ,     . <br> <br>          ,   .           XAML.           .       .  Prism      ,       ,  ,   .       ,    . , ,  ,      <code>Click</code> ,       <code><span class="hljs-keyword"><span class="hljs-keyword">Command</span></span></code> .    <code>Click.<span class="hljs-keyword"><span class="hljs-keyword">Command</span></span></code> ,  . <br> <br>             .             . <br> <br> <code class="cs">public static readonly DependencyProperty CommandProperty = DependencyProperty.RegisterAttached( <span class="hljs-string"><span class="hljs-string">"Command"</span></span>, typeof(ICommand), typeof(Click), new PropertyMetadata(OnSetCommandCallback)); private static readonly DependencyProperty ClickCommandBehaviorProperty = DependencyProperty.RegisterAttached( <span class="hljs-string"><span class="hljs-string">"ClickCommandBehavior"</span></span>, typeof(ButtonBaseClickCommandBehavior), typeof(Click), null);</code> <br>    <code><span class="hljs-keyword"><span class="hljs-keyword">Command</span></span></code>    <code>ButtonBaseClickCommandBehavior</code> ,     <code>OnSetCommandCallback</code> ,     . <br> <br> <code class="cs">private static void OnSetCommandCallback(DependencyObject dependencyObject, DependencyPropertyChangedEventArgs e) { ButtonBase buttonBase = dependencyObject as ButtonBase; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (buttonBase != null) { ButtonBaseClickCommandBehavior behavior = GetOrCreateBehavior(buttonBase); behavior.<span class="hljs-keyword"><span class="hljs-keyword">Command</span></span> = e.NewValue as ICommand; } } private static void OnSetCommandParameterCallback(DependencyObject dependencyObject, DependencyPropertyChangedEventArgs e) { ButtonBase buttonBase = dependencyObject as ButtonBase; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (buttonBase != null) { ButtonBaseClickCommandBehavior behavior = GetOrCreateBehavior(buttonBase); behavior.CommandParameter = e.NewValue; } } private static ButtonBaseClickCommandBehavior GetOrCreateBehavior(ButtonBase buttonBase ) { ButtonBaseClickCommandBehavior behavior = buttonBase.GetValue(ClickCommandBehaviorProperty) as ButtonBaseClickCommandBehavior; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ( behavior == null ) { behavior = new ButtonBaseClickCommandBehavior(buttonBase); buttonBase.SetValue(ClickCommandBehaviorProperty, behavior); } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> behavior; }</code> <br>        ,  <a href="http://msdn.microsoft.com/en-us/library/cc265152(VS.95).aspx">Attached Properties Overview</a>  MSDN. <br> <br>    <br>              . ,     Silverlight,    -,     ,      ,     .     ,       . <br> <br>        ,    ( )  ,  ,     .  UI       ,            UI. <br> <br>      - <br>   -     ,       <code>IAsyncResult</code> .   ,  ,   ,  <code>GetQuestionnaire</code> ,   : <code>BeginGetQuestionnaire</code>  <code>EndGetQuestionnaire</code> .    ,   <code>BeginGetQuestionnaire</code> .     ,   ,   <code>EndGetQuestionnaire</code>    . <br> <b></b> <br>  .NET Framework <span class="hljs-number"><span class="hljs-number">4.5</span></span>      <code>await</code>  <code>async</code>     <code>*Async</code> .      <a href="http://msdn.microsoft.com/en-us/library/vstudio/hh391443.aspx"><span class="hljs-string"><span class="hljs-string">"Asynchronous Programming with Async and Await (C# and Visual Basic)"</span></span></a> . <br>  ,    <code>EndGetQuestionnaire</code> ,      ,  ()      <code>BeginGetQuestionnaire</code> .     ,      ,   <code>EndGetQuestionnaire</code> ,   . <br> <br> <code class="xml">IAsyncResult asyncResult = this.service.BeginGetQuestionnaire( GetQuestionnaireCompleted, null //  ,      ); private void GetQuestionnaireCompleted(IAsyncResult result) { try { questionnaire = this.service.EndGetQuestionnaire(ar); } catch (Exception ex) { //  -   . } }</code> <br>  ,     <code>End*</code> (  , <code>EndGetQuestionnaire</code> ),    ,      .      , ,          UI.     ,   ,        . <br> <br>        UI,     -,      UI,         UI,   <code>Dispatcher</code>    <code>SynchronizationContext</code> .  WPF  Silverlight,   <code>Dispatcher</code> . <br> <br>      <code>Questionnaire</code>  ,        <code>QuestionnaireView</code> .  Silverlight    <code>CheckAccess</code> ,  ,      UI.  ,     <code>BeginInvoke</code> ,      UI. <br> <br> <code class="cs">var dispatcher = System.Windows.Deployment.Current.Dispatcher; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (dispatcher.CheckAccess()) { QuestionnaireView.DataContext = questionnaire; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { dispatcher.BeginInvoke(() =&gt; { Questionnaire.DataContext = questionnaire; }); }</code> <br> <i>MVVM RI</i>   ,    ,   <code>IAsyncResult</code> ,   .      ,                 . ,       . <br> <br> <code class="cs">this.questionnaireRepository.GetQuestionnaireAsync( result =&gt; { this.Questionnaire = result.Result; });</code> <br>  <code>result</code>   ,     , , , .    ,     . <br> <br> <code class="cs">this.questionnaireRepository.GetQuestionnaireAsync( result =&gt; { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (result.Error == null) { this.Questionnaire = result.Result; ... } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { // Handle error. } })</code> <br>     <br>        ,      .     , ,             .        ,      ,     ,     . <br> <br>         ,      MVVM,     ,   . ,  -MVVM ,     <code>MessageBox</code>   code-behind UI,      .   MVVM     ,          . <br> <br>     MVVM,              ,          .      ,    ,   ,  ,     . <br> <br>              MVVM.      ,     ,     ,  ,     .    ,         ,     ,          .       . <br> <br>    <br>                  .        ,        .  ,         .         . <br> <br>  ,         ,         ,  .      ,     .           ,       . ,        WPF  Silverlight,        . <br> <br> <img title="Using the service to interact with the user." src="https://habrastorage.org/getpro/habr/post_images/4b5/397/f2d/4b5397f2d02e5851195b29f1893be6fc.png" alt=" ,    ."> <br> <br>  ,   <code>MessageBox</code>        ,     ,    ,     . <br> <br> <code class="cs">var result = interactionService.ShowMessageBox( <span class="hljs-string"><span class="hljs-string">"Are you sure you want to cancel this operation?"</span></span>, <span class="hljs-string"><span class="hljs-string">"Confirm"</span></span>, MessageBoxButton.OK); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (result == MessageBoxResult.Yes) { CancelRequest(); }</code> <br> ,      - ,      ,         Silverlight.         .             .     . <br> <br> <code class="cs">interactionService.ShowMessageBox( <span class="hljs-string"><span class="hljs-string">"Are you sure you want to cancel this operation?"</span></span>, <span class="hljs-string"><span class="hljs-string">"Confirm"</span></span>, MessageBoxButton.OK, result =&gt; { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (result == MessageBoxResult.Yes) { CancelRequest(); } });</code> <br>         ,      . ,  WPF    <code>MessageBox</code> ,       ;    Silverlight    ,    . <br> <br>     <br>         ‚Äì             .         ,      .     ,     .        ,        ,   ,     . <br> <br> <img title="Using interaction request objects." src="https://habrastorage.org/getpro/habr/post_images/3d0/ff0/1c5/3d0ff01c5518558c2d3c5c5f47ce0ce9.png" alt="   ."> <br> <br>    ,   ,          ‚Äì       ,      ,   ‚Äì     .   ,        ,    ,    UI            . <br> <br>       MVVM,     ,       ,         .         ,        ,    ,   . <br> <br>  Prism       <code>IInteractionRequest</code>   <code><code>InteractionRequest .  IInteractionRequest</code>  ,   .           ,   .  <code><code>InteractionRequest   IInteractionRequest</code>     <code>Raise</code> ,           , , ,   . <br> <br>       <br>  <code><code>InteractionRequest          .  Raise</code>          ( <code>T</code> )    ,    ,   .          ,       .      ,        .    ,  ,     . <br> <code class="cs">public interface IInteractionRequest { event EventHandler&lt;InteractionRequestedEventArgs&gt; Raised; } public class InteractionRequest&lt;T&gt; : IInteractionRequest { public event EventHandler&lt;InteractionRequestedEventArgs&gt; Raised; public void Raise(T context, Action&lt;T&gt; callback) { var handler = this.Raised; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (handler != null) { handler( this, new InteractionRequestedEventArgs(context, () =&gt; callback(context))); } } }</code> <br> Prism    ,      .  <code>Notification</code>       .    ,            .     ‚Äì <code>Title</code>  <code>Content</code> ,    .  ,   ,  ,  ,        . <br> <br>  <code>Confirmation</code>    <code>Notification</code>     ‚Äì <code>Confirmed</code> ,  ,  ,      .  <code>Confirmation</code> ,     <code>MessageBox</code> ,     /  .     ,     <code>Notification</code> ,     ,      . <br> <br>    <code><code><code>InteractionRequest ,       InteractionRequest      ,      .      ,    Raise</code> ,    , ,   . <br> <br> <code class="cs">public IInteractionRequest ConfirmCancelInteractionRequest { get { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> this.confirmCancelInteractionRequest; } } this.confirmCancelInteractionRequest.Raise( new Confirmation(<span class="hljs-string"><span class="hljs-string">"Are you sure you wish to cancel?"</span></span>), confirmation =&gt; { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (confirmation.Confirmed) { this.NavigateToQuestionnaireList(); } }); }</code> <br> <i>MVVM Reference Implementation (MVVM RI)</i> ,    <code>IInteractionRequest</code>   <code><code>InteractionRequest ,          (. QuestionnaireViewModel.cs</code> ). <br> <br>        <br>       ,       .   ,       .    UI             . <br> <br>                . Microsoft Expression Blend Behaviors Framework     .  ,     ,    . <br> <br>  <code>EventTrigger</code> ,  Expression Blend,  ,      ,     ,   . , Prism   <code>EventTrigger</code> ,  <code>InteractionRequestTrigger</code> ,      <code>Raised</code>   <code>IInteractionRequest</code> .    XAML        . <br> <br>  ,   , <code>InteractionRequestTrigger</code>   .  Silverlight Prism   <code>PopupChildWindowAction</code> ,     .    ,         .   <code>ContentTemplate</code>  <code>PopupChildWindowAction</code> ,    ,    UI,      <code>Content</code>  .       <code>Title</code>  . <br> <b></b> <br>  ,    ,   <code>PopupChildWindowAction</code> ,     .    <code>Notification</code>  <code>NotificationChildWindow</code> ,        <code>Confirmation</code> ‚Äì <code>ConfirmationChildWindow</code> . <code>NotificationChildWindow</code>    ,   ,     <code>ConfirmationChildWindow</code>    <i>OK</i>  <i>Cancel</i> ,    .    ,   ,   <code>ChildWindow</code>  <code>PopupChildWindowAction</code> . <br>   ,  <code>InteractionRequestTrigger</code>  <code>PopupChildWindowAction</code> ,       <i>RI MVVM</i> . <br> <br> <code class="xml">&lt;i:Interaction.Triggers&gt; &lt;prism:InteractionRequestTrigger SourceObject=<span class="hljs-string"><span class="hljs-string">"{Binding ConfirmCancelInteractionRequest}"</span></span>&gt; &lt;prism:PopupChildWindowAction ContentTemplate=<span class="hljs-string"><span class="hljs-string">"{StaticResource ConfirmWindowTemplate}"</span></span>/&gt; &lt;/prism:InteractionRequestTrigger&gt; &lt;/i:Interaction.Triggers&gt; &lt;UserControl.Resources&gt; &lt;DataTemplate x:Key=<span class="hljs-string"><span class="hljs-string">"ConfirmWindowTemplate"</span></span>&gt; &lt;Grid MinWidth=<span class="hljs-string"><span class="hljs-string">"250"</span></span> MinHeight=<span class="hljs-string"><span class="hljs-string">"100"</span></span>&gt; &lt;TextBlock TextWrapping=<span class="hljs-string"><span class="hljs-string">"Wrap"</span></span> Grid.Row=<span class="hljs-string"><span class="hljs-string">"0"</span></span> Text=<span class="hljs-string"><span class="hljs-string">"{Binding}"</span></span>/&gt; &lt;/Grid&gt; &lt;/DataTemplate&gt; &lt;/UserControl.Resources&gt;</code> <br> <b></b> <br>      <code>ContentTemplate</code> ,   UI   <code>Content</code>  .    <code>Content</code>  ,  , <code>TextBlock</code>     <code>Content</code> . <br>      ,     ,    ,    .  ,     ,       ,     ,    .   ,   <i>RI MVVM</i> ,         <code>Confirmed</code>    <code>Confirmation</code>  <code><span class="hljs-keyword"><span class="hljs-keyword">true</span></span></code> ,     OK. <br> <br>        ,     .  Prism <code>InteractionRequestTrigger</code>   <code>PopupChildWindowAction</code>            . <br> <br>     <br>     MVVM,       , ,    ,         .        (  , ,  ,   ).    ,  ,  ,            . <br> <br>        ,         . Managed Extensibility Framework (MEF)  Unity Application Block (Unity)      ,  ,           . <br> <br>  ,       , , ,    ( )      . ,       ,     .  ,     ,       . <br> <br>     ,  MEF <br>  MEF,       ,   <code>Import</code> ,      ,  ,   <code><span class="hljs-keyword"><span class="hljs-keyword">Export</span></span></code> .         ,    . <br> <br> , <code>QuestionnaireView</code>   <i>RI MVVM</i> ,        ,    <code>Import</code> .   , MEF           .  <code><span class="hljs-keyword"><span class="hljs-keyword">set</span></span></code>        ,   . <br> <br> <code class="cs">[Import] public QuestionnaireViewModel ViewModel { <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> { this.DataContext = value; } }</code> <br>     ,   . <br> <br> <code class="cs">[<span class="hljs-keyword"><span class="hljs-keyword">Export</span></span>] public class QuestionnaireViewModel : NotificationObject { ... }</code> <br>        ,   . <br> <br> <code class="cs">public QuestionnaireView() { InitializeComponent(); } [ImportingConstructor] public QuestionnaireView(QuestionnaireViewModel viewModel) : this() { this.DataContext = viewModel; }</code> <br> <b></b> <br>          MEF,   Unity.   ,     ,        .   ,   Visual Studio  Expression Blend, ,        ,     .   ,   ,  ,      ,          <code>InitializeComponent</code> . <br>     ,  Unity <br>  Unity,    ,   MEF.     ,      .    ,         .  ,      . <br> <br>  ,      ,  ,         . ,           ,   . <br> <br> <code class="cs">public QuestionnaireView() { InitializeComponent(); } public QuestionnaireView(QuestionnaireViewModel viewModel) : this() { this.DataContext = viewModel; }</code> <br> <b></b> <br>    ,        ,   Visual Studio  Expression Blend. <br>  ,          ,   . Unity        <code><span class="hljs-keyword"><span class="hljs-keyword">set</span></span></code>   ,   . <br> <br> <code class="cs">public QuestionnaireView() { InitializeComponent(); } [Dependency] public QuestionnaireViewModel ViewModel { <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> { this.DataContext = value; } }</code> <br>       Unity. <br> <br> <code class="cs">container.RegisterType&lt;QuestionnaireViewModel&gt;();</code> <br>  ,     . <br> <br> <code class="cs">var view = container.Resolve&lt;QuestionnaireView&gt;();</code> <br>     ,    <br>   ,     ,        .        ,   MEF  Unity,        . <br> <br>          .   ,         UI,           . <br> <br> , <i>RI MVVM</i>   ,   ,        .   ,    .      <code>ShowView</code>   UI. <br> <br> <code class="cs">private void NavigateToQuestionnaireList() { //     <span class="hljs-string"><span class="hljs-string">"questionnaire list"</span></span>. this.uiService.ShowView(ViewNames.QuestionnaireTemplatesList); }</code> <br>  UI      UI .           UI.  <code>ShowView</code>  <code>UIService</code>      (,          ),       ,   . <br> <br> <code class="cs">public void ShowView(<span class="hljs-keyword"><span class="hljs-keyword">string</span></span> viewName) { var view = this.ViewFactory.GetView(viewName); this.MainWindow.CurrentView = view; }</code> <br> <b></b> <br> Prism       .   ,   ,   ,             .    ,  , <span class="hljs-string"><span class="hljs-string">" </span></span><a href="http://msdn.microsoft.com/en-us/library/gg430861(v%3DPandP.40).aspx"><span class="hljs-string"><span class="hljs-string">View-Based Navigation</span></span></a><span class="hljs-string"><span class="hljs-string"> "</span></span>   <span class="hljs-number"><span class="hljs-number">8</span></span>, <span class="hljs-string"><span class="hljs-string">" </span></span><a href="http://msdn.microsoft.com/en-us/library/gg430861(v%3DPandP.40).aspx"><span class="hljs-string"><span class="hljs-string">Navigation</span></span></a><span class="hljs-string"><span class="hljs-string"> "</span></span>. <br>  MVVM  <br>        MVVM      .           -      mocking . ,   ,        . <br> <br>   <i>INotifyPropertyChanged</i> <br>   <code>INotifyPropertyChanged</code>     ,      .      ,    ;   ,   ,     ,    ,       . <br> <br>   <br> ,       ,           <code>PropertyChanged</code>  ,         .  ,    <code>ChangeTracker</code> ,     MVVM,  ,      .      .     ,    . <br> <br> <code class="cs">var changeTracker = new PropertyChangeTracker(viewModel); viewModel.CurrentState = <span class="hljs-string"><span class="hljs-string">"newState"</span></span>; CollectionAssert.Contains(changeTracker.ChangedProperties, <span class="hljs-string"><span class="hljs-string">"CurrentState"</span></span>);</code> <br> ,     ,     <code>INotifyPropertyChanged</code> ,    ,   ,     . <br> <br>      <br>        ,   ,    <code><span class="hljs-keyword"><span class="hljs-keyword">set</span></span></code>      ,           . ,     ,     ,      ,          . <br> <br> <code class="cs">var changeTracker = new PropertyChangeTracker(viewModel); var question = viewModel.Questions.First() as OpenQuestionViewModel; question.Question.Response = <span class="hljs-string"><span class="hljs-string">"some text"</span></span>; CollectionAssert.Contains(changeTracker.ChangedProperties, <span class="hljs-string"><span class="hljs-string">"UnansweredQuestions"</span></span>);</code> <br>      <br>     <code>INotifyPropertyChanged</code> ,      <code>PropertyChanged</code>        ,  ,     , , .        ,       . <br> <br>   <i>INotifyDataErrorInfo</i> <br>   ,     ,    ,   ,   <code>IDataErrorInfo</code> ,  ( Silverlight)   <code>INotifyDataErrorInfo</code> .   <code>INotifyDataErrorInfo</code>   ,         ,    ,  ,   ,    . <br> <br>       <code>INotifyDataErrorInfo</code> : ,     ,  ,     ,     <code>ErrorsChanged</code> ,      <code>GetErrors</code> , . <br> <br>    <br>     ,      ,     .       ,         <code>GetErrors</code>       ,  ,  ,   .    , ,  ,     ,        .   ,        . <br> <br> <code class="cs">//  . var notifyErrorInfo = (INotifyDataErrorInfo)question; question.Response = -<span class="hljs-number"><span class="hljs-number">15</span></span>; Assert.IsTrue(notifyErrorInfo.GetErrors(<span class="hljs-string"><span class="hljs-string">"Response"</span></span>).Cast&lt;ValidationResult&gt;().Any()); //  . var notifyErrorInfo = (INotifyDataErrorInfo)question; question.Response = <span class="hljs-number"><span class="hljs-number">15</span></span>; Assert.IsFalse(notifyErrorInfo.GetErrors(<span class="hljs-string"><span class="hljs-string">"Response"</span></span>).Cast&lt;ValidationResult&gt;().Any());</code> <br>    ,    ,             . <br> <br>    <i>INotifyDataErrorInfo</i> <br>       <code>GetErrors</code> ,   <code>INotifyDataErrorInfo</code>  ,   <code>ErrorsChanged</code>      <code>GetErrors</code> . ,  <code>HasErrors</code>      ,  . <br> <br>       <code>INotifyDataErrorInfo</code> . , ,           ,   -  .      ,        <code>INotifyDataErrorInfo</code>         (,        ). <br> <br>     ,   ,  : <br>  <code>HasErrors</code>     .              ,       .  <code>ErrorsChanged</code> ,      ,         <code>GetErrors</code> .         ( ,  )     ,           .    <code>GetErrors</code>       <code>ErrorsChanged</code> . <br>    <code>INotifyPropertyChanged</code> ,  ,    <code>NotifyDataErrorInfoTestHelper</code>    MVVM,        <code>INotifyDataErrorInfo</code> ,       .   ,   ,      ,   .      . <br> <code class="cs">var helper = new NotifyDataErrorInfoTestHelper&lt;NumericQuestion, int?&gt;( question, q =&gt; q.Response); helper.ValidatePropertyChange( <span class="hljs-number"><span class="hljs-number">6</span></span>, NotifyDataErrorInfoBehavior.Nothing); helper.ValidatePropertyChange( <span class="hljs-number"><span class="hljs-number">20</span></span>, NotifyDataErrorInfoBehavior.FiresErrorsChanged | NotifyDataErrorInfoBehavior.HasErrors | NotifyDataErrorInfoBehavior.HasErrorsForProperty); helper.ValidatePropertyChange( null, NotifyDataErrorInfoBehavior.FiresErrorsChanged | NotifyDataErrorInfoBehavior.HasErrors | NotifyDataErrorInfoBehavior.HasErrorsForProperty); helper.ValidatePropertyChange( <span class="hljs-number"><span class="hljs-number">2</span></span>, NotifyDataErrorInfoBehavior.FiresErrorsChanged);</code> <br>     <br>   MVVM,     ,  .   ,    ,         . <br> <br>  ,     ,     ,       .   ,   , ,       ,     ,   <code>IAsyncResult</code>    ,  - ,   ,    UI. <br> <br>       , , ,    .   ,     .  ,      UI,     ,   ,          ,     ,        <span class="hljs-string"><span class="hljs-string">"   UI."</span></span> <br> <br>     ,    ,    .   ,    ,     mock-, ,   ,   ,      ,          . <br> <br>           UI,    ,    .   ,     ,   ,      .        ,   .     ,    ,     . <br> <br> <code class="cs">questionnaireRepositoryMock .Setup( r =&gt; r.SubmitQuestionnaireAsync( It.IsAny&lt;Questionnaire&gt;(), It.IsAny&lt;Action&lt;IOperationResult&gt;&gt;())) .Callback&lt;Questionnaire, Action&lt;IOperationResult&gt;&gt;( (q, a) =&gt; callback = a); uiServicemock .Setup(svc =&gt; svc.ShowView(ViewNames.QuestionnaireTemplatesList)) .Callback&lt;<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>&gt;(viewName =&gt; requestedViewName = viewName); submitResultMock .Setup(sr =&gt; sr.Error) .Returns&lt;Exception&gt;(null); CompleteQuestionnaire(viewModel); viewModel.Submit(); //      UI . callback(submitResultMock.Object); //    ‚Äì     . Assert.AreEqual(ViewNames.QuestionnaireTemplatesList, requestedViewName);</code> <br> <b></b> <br>          ,        . <br>   <br>       , . <span class="hljs-string"><span class="hljs-string">"Trees in WPF"</span></span>  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ms753391.aspx">http://msdn.microsoft.com/en-us/library/ms753391.aspx</a> <br> <br>       , . <span class="hljs-string"><span class="hljs-string">"Attached Properties Overview"</span></span>  MSDN: <a href="http://msdn.microsoft.com/en-us/library/cc265152(VS.95).aspx">http://msdn.microsoft.com/en-us/library/cc265152(VS.<span class="hljs-number"><span class="hljs-number">95</span></span>).aspx</a> <br> <br>      MEF, .<span class="hljs-string"><span class="hljs-string">"Managed Extensibility Framework Overview"</span></span>  MSDN: <a href="http://msdn.microsoft.com/en-us/library/dd460648.aspx">http://msdn.microsoft.com/en-us/library/dd460648.aspx</a> . <br> <br>      Unity, .<span class="hljs-string"><span class="hljs-string">"Unity Application Block"</span></span>  MSDN: <a href="http://www.msdn.com/unity">http://www.msdn.com/unity</a> . <br> <br>      <code>DelegateCommand</code> , .Chapter <span class="hljs-number"><span class="hljs-number">5</span></span>, <span class="hljs-string"><span class="hljs-string">" </span></span><a href="http://msdn.microsoft.com/en-us/library/gg405484(v%3DPandP.40).aspx"><span class="hljs-string"><span class="hljs-string">Implementing the MVVM Pattern</span></span></a><span class="hljs-string"><span class="hljs-string"> ."</span></span> <br> <br>        Microsoft Expression Blend, .<span class="hljs-string"><span class="hljs-string">"Working with built-in behaviors"</span></span>  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ff724013(v%3DExpression.40).aspx">http://msdn.microsoft.com/en-us/library/ff724013(v=Expression.<span class="hljs-number"><span class="hljs-number">40</span></span>).aspx</a> . <br> <br>          Microsoft Expression Blend, .<span class="hljs-string"><span class="hljs-string">"Creating Custom Behaviors"</span></span>  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ff724708(v%3DExpression.40).aspx">http://msdn.microsoft.com/en-us/library/ff724708(v=Expression.<span class="hljs-number"><span class="hljs-number">40</span></span>).aspx</a> . <br> <br>            Microsoft Expression Blend, .<span class="hljs-string"><span class="hljs-string">"Creating Custom Triggers and Actions"</span></span>  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ff724707(v%3DExpression.40).aspx">http://msdn.microsoft.com/en-us/library/ff724707(v=Expression.<span class="hljs-number"><span class="hljs-number">40</span></span>).aspx</a> . <br> <br>         WPF  Silverlight, .<span class="hljs-string"><span class="hljs-string">"Threading Model"</span></span>  <span class="hljs-string"><span class="hljs-string">"The Dispatcher Class"</span></span>  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ms741870.aspx">http://msdn.microsoft.com/en-us/library/ms741870.aspx</a> <br> <a href="http://msdn.microsoft.com/en-us/library/ms615907(v%3DVS.95).aspx">http://msdn.microsoft.com/en-us/library/ms615907(v=VS.<span class="hljs-number"><span class="hljs-number">95</span></span>).aspx</a> . <br> <br>      unit-  Silverlight, .<span class="hljs-string"><span class="hljs-string">"Unit Testing with Silverlight 2"</span></span>: <a href="http://www.jeff.wilcox.name/2008/03/silverlight2-unit-testing/">http://www.jeff.wilcox.name/<span class="hljs-number"><span class="hljs-number">2008</span></span>/<span class="hljs-number"><span class="hljs-number">03</span></span>/silverlight2-unit-testing/</a> . <br> <br>         , .  <span class="hljs-string"><span class="hljs-string">" </span></span><a href="http://msdn.microsoft.com/en-us/library/gg430861(v%3DPandP.40).aspx"><span class="hljs-string"><span class="hljs-string">View-Based Navigation</span></span></a><span class="hljs-string"><span class="hljs-string"> "</span></span> in Chapter <span class="hljs-number"><span class="hljs-number">8</span></span>, <span class="hljs-string"><span class="hljs-string">" </span></span><a href="http://msdn.microsoft.com/en-us/library/gg430861(v%3DPandP.40).aspx"><span class="hljs-string"><span class="hljs-string">Navigation</span></span></a><span class="hljs-string"><span class="hljs-string"> ."</span></span> <br> <br>       ,   , .<span class="hljs-string"><span class="hljs-string">"Event-based Asynchronous Pattern Overview"</span></span>  MSDN: <a href="http://msdn.microsoft.com/en-us/library/wewwczdw.aspx">http://msdn.microsoft.com/en-us/library/wewwczdw.aspx</a> <br> <br>        <code>IAsyncResult</code> , .<span class="hljs-string"><span class="hljs-string">"Asynchronous Programming Overview"</span></span>  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ms228963.aspx">http://msdn.microsoft.com/en-us/library/ms228963.aspx</a></code></code></code></code></code></code></code></code></code> </pre> <code><code><code><code>CommandBehaviorBase ,    ,    ICommand</code> .           <code>CanExecuteChanged</code> ,          Silverlight,    WPF. <br> <br>    ,  ,   <code>CommandBehaviorBase    ,    .         ,      .         ,    .      ButtonBaseClickCommandBehavior</code> . <br> <br> <code class="cs">public class ButtonBaseClickCommandBehavior : CommandBehaviorBase&lt;ButtonBase&gt; { public ButtonBaseClickCommandBehavior(ButtonBase clickableObject) : base(clickableObject) { clickableObject.Click += OnClick; } private void OnClick(object sender, System.Windows.RoutedEventArgs e) { ExecuteCommand(); } }</code> <br>   <code>CommandBehaviorBase ,     .     ,          ,   . ,    ,    ,      , ,    CanExecute</code>  ,     . <br> <br>          ,   .           XAML.           .       .  Prism      ,       ,  ,   .       ,    . , ,  ,      <code>Click</code> ,       <code>Command</code> .    <code>Click.Command</code> ,  . <br> <br>             .             . <br> <br> <code class="cs">public static readonly DependencyProperty CommandProperty = DependencyProperty.RegisterAttached( "Command", typeof(ICommand), typeof(Click), new PropertyMetadata(OnSetCommandCallback)); private static readonly DependencyProperty ClickCommandBehaviorProperty = DependencyProperty.RegisterAttached( "ClickCommandBehavior", typeof(ButtonBaseClickCommandBehavior), typeof(Click), null);</code> <br>    <code>Command</code>    <code>ButtonBaseClickCommandBehavior</code> ,     <code>OnSetCommandCallback</code> ,     . <br> <br> <code class="cs">private static void OnSetCommandCallback(DependencyObject dependencyObject, DependencyPropertyChangedEventArgs e) { ButtonBase buttonBase = dependencyObject as ButtonBase; if (buttonBase != null) { ButtonBaseClickCommandBehavior behavior = GetOrCreateBehavior(buttonBase); behavior.Command = e.NewValue as ICommand; } } private static void OnSetCommandParameterCallback(DependencyObject dependencyObject, DependencyPropertyChangedEventArgs e) { ButtonBase buttonBase = dependencyObject as ButtonBase; if (buttonBase != null) { ButtonBaseClickCommandBehavior behavior = GetOrCreateBehavior(buttonBase); behavior.CommandParameter = e.NewValue; } } private static ButtonBaseClickCommandBehavior GetOrCreateBehavior(ButtonBase buttonBase ) { ButtonBaseClickCommandBehavior behavior = buttonBase.GetValue(ClickCommandBehaviorProperty) as ButtonBaseClickCommandBehavior; if ( behavior == null ) { behavior = new ButtonBaseClickCommandBehavior(buttonBase); buttonBase.SetValue(ClickCommandBehaviorProperty, behavior); } return behavior; }</code> <br>        ,  <a href="http://msdn.microsoft.com/en-us/library/cc265152(VS.95).aspx">Attached Properties Overview</a>  MSDN. <br> <br>    <br>              . ,     Silverlight,    -,     ,      ,     .     ,       . <br> <br>        ,    ( )  ,  ,     .  UI       ,            UI. <br> <br>      - <br>   -     ,       <code>IAsyncResult</code> .   ,  ,   ,  <code>GetQuestionnaire</code> ,   : <code>BeginGetQuestionnaire</code>  <code>EndGetQuestionnaire</code> .    ,   <code>BeginGetQuestionnaire</code> .     ,   ,   <code>EndGetQuestionnaire</code>    . <br> <b></b> <br>  .NET Framework 4.5      <code>await</code>  <code>async</code>     <code>*Async</code> .      <a href="http://msdn.microsoft.com/en-us/library/vstudio/hh391443.aspx">"Asynchronous Programming with Async and Await (C# and Visual Basic)"</a> . <br>  ,    <code>EndGetQuestionnaire</code> ,      ,  ()      <code>BeginGetQuestionnaire</code> .     ,      ,   <code>EndGetQuestionnaire</code> ,   . <br> <br> <code class="xml">IAsyncResult asyncResult = this.service.BeginGetQuestionnaire( GetQuestionnaireCompleted, null //  ,      ); private void GetQuestionnaireCompleted(IAsyncResult result) { try { questionnaire = this.service.EndGetQuestionnaire(ar); } catch (Exception ex) { //  -   . } }</code> <br>  ,     <code>End*</code> (  , <code>EndGetQuestionnaire</code> ),    ,      .      , ,          UI.     ,   ,        . <br> <br>        UI,     -,      UI,         UI,   <code>Dispatcher</code>    <code>SynchronizationContext</code> .  WPF  Silverlight,   <code>Dispatcher</code> . <br> <br>      <code>Questionnaire</code>  ,        <code>QuestionnaireView</code> .  Silverlight    <code>CheckAccess</code> ,  ,      UI.  ,     <code>BeginInvoke</code> ,      UI. <br> <br> <code class="cs">var dispatcher = System.Windows.Deployment.Current.Dispatcher; if (dispatcher.CheckAccess()) { QuestionnaireView.DataContext = questionnaire; } else { dispatcher.BeginInvoke(() =&gt; { Questionnaire.DataContext = questionnaire; }); }</code> <br> <i>MVVM RI</i>   ,    ,   <code>IAsyncResult</code> ,   .      ,                 . ,       . <br> <br> <code class="cs">this.questionnaireRepository.GetQuestionnaireAsync( result =&gt; { this.Questionnaire = result.Result; });</code> <br>  <code>result</code>   ,     , , , .    ,     . <br> <br> <code class="cs">this.questionnaireRepository.GetQuestionnaireAsync( result =&gt; { if (result.Error == null) { this.Questionnaire = result.Result; ... } else { // Handle error. } })</code> <br>     <br>        ,      .     , ,             .        ,      ,     ,     . <br> <br>         ,      MVVM,     ,   . ,  -MVVM ,     <code>MessageBox</code>   code-behind UI,      .   MVVM     ,          . <br> <br>     MVVM,              ,          .      ,    ,   ,  ,     . <br> <br>              MVVM.      ,     ,     ,  ,     .    ,         ,     ,          .       . <br> <br>    <br>                  .        ,        .  ,         .         . <br> <br>  ,         ,         ,  .      ,     .           ,       . ,        WPF  Silverlight,        . <br> <br> <img title="Using the service to interact with the user." src="https://habrastorage.org/getpro/habr/post_images/4b5/397/f2d/4b5397f2d02e5851195b29f1893be6fc.png" alt=" ,    ."> <br> <br>  ,   <code>MessageBox</code>        ,     ,    ,     . <br> <br> <code class="cs">var result = interactionService.ShowMessageBox( "Are you sure you want to cancel this operation?", "Confirm", MessageBoxButton.OK); if (result == MessageBoxResult.Yes) { CancelRequest(); }</code> <br> ,      - ,      ,         Silverlight.         .             .     . <br> <br> <code class="cs">interactionService.ShowMessageBox( "Are you sure you want to cancel this operation?", "Confirm", MessageBoxButton.OK, result =&gt; { if (result == MessageBoxResult.Yes) { CancelRequest(); } });</code> <br>         ,      . ,  WPF    <code>MessageBox</code> ,       ;    Silverlight    ,    . <br> <br>     <br>         ‚Äì             .         ,      .     ,     .        ,        ,   ,     . <br> <br> <img title="Using interaction request objects." src="https://habrastorage.org/getpro/habr/post_images/3d0/ff0/1c5/3d0ff01c5518558c2d3c5c5f47ce0ce9.png" alt="   ."> <br> <br>    ,   ,          ‚Äì       ,      ,   ‚Äì     .   ,        ,    ,    UI            . <br> <br>       MVVM,     ,       ,         .         ,        ,    ,   . <br> <br>  Prism       <code>IInteractionRequest</code>   <code><code>InteractionRequest .  IInteractionRequest</code>  ,   .           ,   .  <code><code>InteractionRequest   IInteractionRequest</code>     <code>Raise</code> ,           , , ,   . <br> <br>       <br>  <code><code>InteractionRequest          .  Raise</code>          ( <code>T</code> )    ,    ,   .          ,       .      ,        .    ,  ,     . <br> <code class="cs">public interface IInteractionRequest { event EventHandler&lt;InteractionRequestedEventArgs&gt; Raised; } public class InteractionRequest&lt;T&gt; : IInteractionRequest { public event EventHandler&lt;InteractionRequestedEventArgs&gt; Raised; public void Raise(T context, Action&lt;T&gt; callback) { var handler = this.Raised; if (handler != null) { handler( this, new InteractionRequestedEventArgs(context, () =&gt; callback(context))); } } }</code> <br> Prism    ,      .  <code>Notification</code>       .    ,            .     ‚Äì <code>Title</code>  <code>Content</code> ,    .  ,   ,  ,  ,        . <br> <br>  <code>Confirmation</code>    <code>Notification</code>     ‚Äì <code>Confirmed</code> ,  ,  ,      .  <code>Confirmation</code> ,     <code>MessageBox</code> ,     /  .     ,     <code>Notification</code> ,     ,      . <br> <br>    <code><code><code>InteractionRequest ,       InteractionRequest      ,      .      ,    Raise</code> ,    , ,   . <br> <br> <code class="cs">public IInteractionRequest ConfirmCancelInteractionRequest { get { return this.confirmCancelInteractionRequest; } } this.confirmCancelInteractionRequest.Raise( new Confirmation("Are you sure you wish to cancel?"), confirmation =&gt; { if (confirmation.Confirmed) { this.NavigateToQuestionnaireList(); } }); }</code> <br> <i>MVVM Reference Implementation (MVVM RI)</i> ,    <code>IInteractionRequest</code>   <code><code>InteractionRequest ,          (. QuestionnaireViewModel.cs</code> ). <br> <br>        <br>       ,       .   ,       .    UI             . <br> <br>                . Microsoft Expression Blend Behaviors Framework     .  ,     ,    . <br> <br>  <code>EventTrigger</code> ,  Expression Blend,  ,      ,     ,   . , Prism   <code>EventTrigger</code> ,  <code>InteractionRequestTrigger</code> ,      <code>Raised</code>   <code>IInteractionRequest</code> .    XAML        . <br> <br>  ,   , <code>InteractionRequestTrigger</code>   .  Silverlight Prism   <code>PopupChildWindowAction</code> ,     .    ,         .   <code>ContentTemplate</code>  <code>PopupChildWindowAction</code> ,    ,    UI,      <code>Content</code>  .       <code>Title</code>  . <br> <b></b> <br>  ,    ,   <code>PopupChildWindowAction</code> ,     .    <code>Notification</code>  <code>NotificationChildWindow</code> ,        <code>Confirmation</code> ‚Äì <code>ConfirmationChildWindow</code> . <code>NotificationChildWindow</code>    ,   ,     <code>ConfirmationChildWindow</code>    <i>OK</i>  <i>Cancel</i> ,    .    ,   ,   <code>ChildWindow</code>  <code>PopupChildWindowAction</code> . <br>   ,  <code>InteractionRequestTrigger</code>  <code>PopupChildWindowAction</code> ,       <i>RI MVVM</i> . <br> <br> <code class="xml">&lt;i:Interaction.Triggers&gt; &lt;prism:InteractionRequestTrigger SourceObject="{Binding ConfirmCancelInteractionRequest}"&gt; &lt;prism:PopupChildWindowAction ContentTemplate="{StaticResource ConfirmWindowTemplate}"/&gt; &lt;/prism:InteractionRequestTrigger&gt; &lt;/i:Interaction.Triggers&gt; &lt;UserControl.Resources&gt; &lt;DataTemplate x:Key="ConfirmWindowTemplate"&gt; &lt;Grid MinWidth="250" MinHeight="100"&gt; &lt;TextBlock TextWrapping="Wrap" Grid.Row="0" Text="{Binding}"/&gt; &lt;/Grid&gt; &lt;/DataTemplate&gt; &lt;/UserControl.Resources&gt;</code> <br> <b></b> <br>      <code>ContentTemplate</code> ,   UI   <code>Content</code>  .    <code>Content</code>  ,  , <code>TextBlock</code>     <code>Content</code> . <br>      ,     ,    ,    .  ,     ,       ,     ,    .   ,   <i>RI MVVM</i> ,         <code>Confirmed</code>    <code>Confirmation</code>  <code>true</code> ,     OK. <br> <br>        ,     .  Prism <code>InteractionRequestTrigger</code>   <code>PopupChildWindowAction</code>            . <br> <br>     <br>     MVVM,       , ,    ,         .        (  , ,  ,   ).    ,  ,  ,            . <br> <br>        ,         . Managed Extensibility Framework (MEF)  Unity Application Block (Unity)      ,  ,           . <br> <br>  ,       , , ,    ( )      . ,       ,     .  ,     ,       . <br> <br>     ,  MEF <br>  MEF,       ,   <code>Import</code> ,      ,  ,   <code>Export</code> .         ,    . <br> <br> , <code>QuestionnaireView</code>   <i>RI MVVM</i> ,        ,    <code>Import</code> .   , MEF           .  <code>set</code>        ,   . <br> <br> <code class="cs">[Import] public QuestionnaireViewModel ViewModel { set { this.DataContext = value; } }</code> <br>     ,   . <br> <br> <code class="cs">[Export] public class QuestionnaireViewModel : NotificationObject { ... }</code> <br>        ,   . <br> <br> <code class="cs">public QuestionnaireView() { InitializeComponent(); } [ImportingConstructor] public QuestionnaireView(QuestionnaireViewModel viewModel) : this() { this.DataContext = viewModel; }</code> <br> <b></b> <br>          MEF,   Unity.   ,     ,        .   ,   Visual Studio  Expression Blend, ,        ,     .   ,   ,  ,      ,          <code>InitializeComponent</code> . <br>     ,  Unity <br>  Unity,    ,   MEF.     ,      .    ,         .  ,      . <br> <br>  ,      ,  ,         . ,           ,   . <br> <br> <code class="cs">public QuestionnaireView() { InitializeComponent(); } public QuestionnaireView(QuestionnaireViewModel viewModel) : this() { this.DataContext = viewModel; }</code> <br> <b></b> <br>    ,        ,   Visual Studio  Expression Blend. <br>  ,          ,   . Unity        <code>set</code>   ,   . <br> <br> <code class="cs">public QuestionnaireView() { InitializeComponent(); } [Dependency] public QuestionnaireViewModel ViewModel { set { this.DataContext = value; } }</code> <br>       Unity. <br> <br> <code class="cs">container.RegisterType&lt;QuestionnaireViewModel&gt;();</code> <br>  ,     . <br> <br> <code class="cs">var view = container.Resolve&lt;QuestionnaireView&gt;();</code> <br>     ,    <br>   ,     ,        .        ,   MEF  Unity,        . <br> <br>          .   ,         UI,           . <br> <br> , <i>RI MVVM</i>   ,   ,        .   ,    .      <code>ShowView</code>   UI. <br> <br> <code class="cs">private void NavigateToQuestionnaireList() { //     "questionnaire list". this.uiService.ShowView(ViewNames.QuestionnaireTemplatesList); }</code> <br>  UI      UI .           UI.  <code>ShowView</code>  <code>UIService</code>      (,          ),       ,   . <br> <br> <code class="cs">public void ShowView(string viewName) { var view = this.ViewFactory.GetView(viewName); this.MainWindow.CurrentView = view; }</code> <br> <b></b> <br> Prism       .   ,   ,   ,             .    ,  , " <a href="http://msdn.microsoft.com/en-us/library/gg430861(v%3DPandP.40).aspx">View-Based Navigation</a> "   8, " <a href="http://msdn.microsoft.com/en-us/library/gg430861(v%3DPandP.40).aspx">Navigation</a> ". <br>  MVVM  <br>        MVVM      .           -      mocking . ,   ,        . <br> <br>   <i>INotifyPropertyChanged</i> <br>   <code>INotifyPropertyChanged</code>     ,      .      ,    ;   ,   ,     ,    ,       . <br> <br>   <br> ,       ,           <code>PropertyChanged</code>  ,         .  ,    <code>ChangeTracker</code> ,     MVVM,  ,      .      .     ,    . <br> <br> <code class="cs">var changeTracker = new PropertyChangeTracker(viewModel); viewModel.CurrentState = "newState"; CollectionAssert.Contains(changeTracker.ChangedProperties, "CurrentState");</code> <br> ,     ,     <code>INotifyPropertyChanged</code> ,    ,   ,     . <br> <br>      <br>        ,   ,    <code>set</code>      ,           . ,     ,     ,      ,          . <br> <br> <code class="cs">var changeTracker = new PropertyChangeTracker(viewModel); var question = viewModel.Questions.First() as OpenQuestionViewModel; question.Question.Response = "some text"; CollectionAssert.Contains(changeTracker.ChangedProperties, "UnansweredQuestions");</code> <br>      <br>     <code>INotifyPropertyChanged</code> ,      <code>PropertyChanged</code>        ,  ,     , , .        ,       . <br> <br>   <i>INotifyDataErrorInfo</i> <br>   ,     ,    ,   ,   <code>IDataErrorInfo</code> ,  ( Silverlight)   <code>INotifyDataErrorInfo</code> .   <code>INotifyDataErrorInfo</code>   ,         ,    ,  ,   ,    . <br> <br>       <code>INotifyDataErrorInfo</code> : ,     ,  ,     ,     <code>ErrorsChanged</code> ,      <code>GetErrors</code> , . <br> <br>    <br>     ,      ,     .       ,         <code>GetErrors</code>       ,  ,  ,   .    , ,  ,     ,        .   ,        . <br> <br> <code class="cs">//  . var notifyErrorInfo = (INotifyDataErrorInfo)question; question.Response = -15; Assert.IsTrue(notifyErrorInfo.GetErrors("Response").Cast&lt;ValidationResult&gt;().Any()); //  . var notifyErrorInfo = (INotifyDataErrorInfo)question; question.Response = 15; Assert.IsFalse(notifyErrorInfo.GetErrors("Response").Cast&lt;ValidationResult&gt;().Any());</code> <br>    ,    ,             . <br> <br>    <i>INotifyDataErrorInfo</i> <br>       <code>GetErrors</code> ,   <code>INotifyDataErrorInfo</code>  ,   <code>ErrorsChanged</code>      <code>GetErrors</code> . ,  <code>HasErrors</code>      ,  . <br> <br>       <code>INotifyDataErrorInfo</code> . , ,           ,   -  .      ,        <code>INotifyDataErrorInfo</code>         (,        ). <br> <br>     ,   ,  : <br>  <code>HasErrors</code>     .              ,       .  <code>ErrorsChanged</code> ,      ,         <code>GetErrors</code> .         ( ,  )     ,           .    <code>GetErrors</code>       <code>ErrorsChanged</code> . <br>    <code>INotifyPropertyChanged</code> ,  ,    <code>NotifyDataErrorInfoTestHelper</code>    MVVM,        <code>INotifyDataErrorInfo</code> ,       .   ,   ,      ,   .      . <br> <code class="cs">var helper = new NotifyDataErrorInfoTestHelper&lt;NumericQuestion, int?&gt;( question, q =&gt; q.Response); helper.ValidatePropertyChange( 6, NotifyDataErrorInfoBehavior.Nothing); helper.ValidatePropertyChange( 20, NotifyDataErrorInfoBehavior.FiresErrorsChanged | NotifyDataErrorInfoBehavior.HasErrors | NotifyDataErrorInfoBehavior.HasErrorsForProperty); helper.ValidatePropertyChange( null, NotifyDataErrorInfoBehavior.FiresErrorsChanged | NotifyDataErrorInfoBehavior.HasErrors | NotifyDataErrorInfoBehavior.HasErrorsForProperty); helper.ValidatePropertyChange( 2, NotifyDataErrorInfoBehavior.FiresErrorsChanged);</code> <br>     <br>   MVVM,     ,  .   ,    ,         . <br> <br>  ,     ,     ,       .   ,   , ,       ,     ,   <code>IAsyncResult</code>    ,  - ,   ,    UI. <br> <br>       , , ,    .   ,     .  ,      UI,     ,   ,          ,     ,        "   UI." <br> <br>     ,    ,    .   ,    ,     mock-, ,   ,   ,      ,          . <br> <br>           UI,    ,    .   ,     ,   ,      .        ,   .     ,    ,     . <br> <br> <code class="cs">questionnaireRepositoryMock .Setup( r =&gt; r.SubmitQuestionnaireAsync( It.IsAny&lt;Questionnaire&gt;(), It.IsAny&lt;Action&lt;IOperationResult&gt;&gt;())) .Callback&lt;Questionnaire, Action&lt;IOperationResult&gt;&gt;( (q, a) =&gt; callback = a); uiServicemock .Setup(svc =&gt; svc.ShowView(ViewNames.QuestionnaireTemplatesList)) .Callback&lt;string&gt;(viewName =&gt; requestedViewName = viewName); submitResultMock .Setup(sr =&gt; sr.Error) .Returns&lt;Exception&gt;(null); CompleteQuestionnaire(viewModel); viewModel.Submit(); //      UI . callback(submitResultMock.Object); //    ‚Äì     . Assert.AreEqual(ViewNames.QuestionnaireTemplatesList, requestedViewName);</code> <br> <b></b> <br>          ,        . <br>   <br>       , . "Trees in WPF"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ms753391.aspx">http://msdn.microsoft.com/en-us/library/ms753391.aspx</a> <br> <br>       , . "Attached Properties Overview"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/cc265152(VS.95).aspx">http://msdn.microsoft.com/en-us/library/cc265152(VS.95).aspx</a> <br> <br>      MEF, ."Managed Extensibility Framework Overview"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/dd460648.aspx">http://msdn.microsoft.com/en-us/library/dd460648.aspx</a> . <br> <br>      Unity, ."Unity Application Block"  MSDN: <a href="http://www.msdn.com/unity">http://www.msdn.com/unity</a> . <br> <br>      <code>DelegateCommand</code> , .Chapter 5, " <a href="http://msdn.microsoft.com/en-us/library/gg405484(v%3DPandP.40).aspx">Implementing the MVVM Pattern</a> ." <br> <br>        Microsoft Expression Blend, ."Working with built-in behaviors"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ff724013(v%3DExpression.40).aspx">http://msdn.microsoft.com/en-us/library/ff724013(v=Expression.40).aspx</a> . <br> <br>          Microsoft Expression Blend, ."Creating Custom Behaviors"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ff724708(v%3DExpression.40).aspx">http://msdn.microsoft.com/en-us/library/ff724708(v=Expression.40).aspx</a> . <br> <br>            Microsoft Expression Blend, ."Creating Custom Triggers and Actions"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ff724707(v%3DExpression.40).aspx">http://msdn.microsoft.com/en-us/library/ff724707(v=Expression.40).aspx</a> . <br> <br>         WPF  Silverlight, ."Threading Model"  "The Dispatcher Class"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ms741870.aspx">http://msdn.microsoft.com/en-us/library/ms741870.aspx</a> <br> <a href="http://msdn.microsoft.com/en-us/library/ms615907(v%3DVS.95).aspx">http://msdn.microsoft.com/en-us/library/ms615907(v=VS.95).aspx</a> . <br> <br>      unit-  Silverlight, ."Unit Testing with Silverlight 2": <a href="http://www.jeff.wilcox.name/2008/03/silverlight2-unit-testing/">http://www.jeff.wilcox.name/2008/03/silverlight2-unit-testing/</a> . <br> <br>         , .  " <a href="http://msdn.microsoft.com/en-us/library/gg430861(v%3DPandP.40).aspx">View-Based Navigation</a> " in Chapter 8, " <a href="http://msdn.microsoft.com/en-us/library/gg430861(v%3DPandP.40).aspx">Navigation</a> ." <br> <br>       ,   , ."Event-based Asynchronous Pattern Overview"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/wewwczdw.aspx">http://msdn.microsoft.com/en-us/library/wewwczdw.aspx</a> <br> <br>        <code>IAsyncResult</code> , ."Asynchronous Programming Overview"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ms228963.aspx">http://msdn.microsoft.com/en-us/library/ms228963.aspx</a></code></code></code></code></code></code></code></code></code> <pre> <code class="hljs cmake"><code>CommandBehaviorBase ,    ,    ICommand</code> .           <code>CanExecuteChanged</code> ,          Silverlight,    WPF. <br> <br>    ,  ,   <code><code>CommandBehaviorBase    ,    .         ,      .         ,    .      ButtonBaseClickCommandBehavior</code> . <br> <br> <code class="cs">public class ButtonBaseClickCommandBehavior : CommandBehaviorBase&lt;ButtonBase&gt; { public ButtonBaseClickCommandBehavior(ButtonBase clickableObject) : base(clickableObject) { clickableObject.Click += OnClick; } private void OnClick(object sender, System.Windows.RoutedEventArgs e) { ExecuteCommand(); } }</code> <br>   <code><code>CommandBehaviorBase ,     .     ,          ,   . ,    ,    ,      , ,    CanExecute</code>  ,     . <br> <br>          ,   .           XAML.           .       .  Prism      ,       ,  ,   .       ,    . , ,  ,      <code>Click</code> ,       <code><span class="hljs-keyword"><span class="hljs-keyword">Command</span></span></code> .    <code>Click.<span class="hljs-keyword"><span class="hljs-keyword">Command</span></span></code> ,  . <br> <br>             .             . <br> <br> <code class="cs">public static readonly DependencyProperty CommandProperty = DependencyProperty.RegisterAttached( <span class="hljs-string"><span class="hljs-string">"Command"</span></span>, typeof(ICommand), typeof(Click), new PropertyMetadata(OnSetCommandCallback)); private static readonly DependencyProperty ClickCommandBehaviorProperty = DependencyProperty.RegisterAttached( <span class="hljs-string"><span class="hljs-string">"ClickCommandBehavior"</span></span>, typeof(ButtonBaseClickCommandBehavior), typeof(Click), null);</code> <br>    <code><span class="hljs-keyword"><span class="hljs-keyword">Command</span></span></code>    <code>ButtonBaseClickCommandBehavior</code> ,     <code>OnSetCommandCallback</code> ,     . <br> <br> <code class="cs">private static void OnSetCommandCallback(DependencyObject dependencyObject, DependencyPropertyChangedEventArgs e) { ButtonBase buttonBase = dependencyObject as ButtonBase; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (buttonBase != null) { ButtonBaseClickCommandBehavior behavior = GetOrCreateBehavior(buttonBase); behavior.<span class="hljs-keyword"><span class="hljs-keyword">Command</span></span> = e.NewValue as ICommand; } } private static void OnSetCommandParameterCallback(DependencyObject dependencyObject, DependencyPropertyChangedEventArgs e) { ButtonBase buttonBase = dependencyObject as ButtonBase; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (buttonBase != null) { ButtonBaseClickCommandBehavior behavior = GetOrCreateBehavior(buttonBase); behavior.CommandParameter = e.NewValue; } } private static ButtonBaseClickCommandBehavior GetOrCreateBehavior(ButtonBase buttonBase ) { ButtonBaseClickCommandBehavior behavior = buttonBase.GetValue(ClickCommandBehaviorProperty) as ButtonBaseClickCommandBehavior; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ( behavior == null ) { behavior = new ButtonBaseClickCommandBehavior(buttonBase); buttonBase.SetValue(ClickCommandBehaviorProperty, behavior); } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> behavior; }</code> <br>        ,  <a href="http://msdn.microsoft.com/en-us/library/cc265152(VS.95).aspx">Attached Properties Overview</a>  MSDN. <br> <br>    <br>              . ,     Silverlight,    -,     ,      ,     .     ,       . <br> <br>        ,    ( )  ,  ,     .  UI       ,            UI. <br> <br>      - <br>   -     ,       <code>IAsyncResult</code> .   ,  ,   ,  <code>GetQuestionnaire</code> ,   : <code>BeginGetQuestionnaire</code>  <code>EndGetQuestionnaire</code> .    ,   <code>BeginGetQuestionnaire</code> .     ,   ,   <code>EndGetQuestionnaire</code>    . <br> <b></b> <br>  .NET Framework <span class="hljs-number"><span class="hljs-number">4.5</span></span>      <code>await</code>  <code>async</code>     <code>*Async</code> .      <a href="http://msdn.microsoft.com/en-us/library/vstudio/hh391443.aspx"><span class="hljs-string"><span class="hljs-string">"Asynchronous Programming with Async and Await (C# and Visual Basic)"</span></span></a> . <br>  ,    <code>EndGetQuestionnaire</code> ,      ,  ()      <code>BeginGetQuestionnaire</code> .     ,      ,   <code>EndGetQuestionnaire</code> ,   . <br> <br> <code class="xml">IAsyncResult asyncResult = this.service.BeginGetQuestionnaire( GetQuestionnaireCompleted, null //  ,      ); private void GetQuestionnaireCompleted(IAsyncResult result) { try { questionnaire = this.service.EndGetQuestionnaire(ar); } catch (Exception ex) { //  -   . } }</code> <br>  ,     <code>End*</code> (  , <code>EndGetQuestionnaire</code> ),    ,      .      , ,          UI.     ,   ,        . <br> <br>        UI,     -,      UI,         UI,   <code>Dispatcher</code>    <code>SynchronizationContext</code> .  WPF  Silverlight,   <code>Dispatcher</code> . <br> <br>      <code>Questionnaire</code>  ,        <code>QuestionnaireView</code> .  Silverlight    <code>CheckAccess</code> ,  ,      UI.  ,     <code>BeginInvoke</code> ,      UI. <br> <br> <code class="cs">var dispatcher = System.Windows.Deployment.Current.Dispatcher; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (dispatcher.CheckAccess()) { QuestionnaireView.DataContext = questionnaire; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { dispatcher.BeginInvoke(() =&gt; { Questionnaire.DataContext = questionnaire; }); }</code> <br> <i>MVVM RI</i>   ,    ,   <code>IAsyncResult</code> ,   .      ,                 . ,       . <br> <br> <code class="cs">this.questionnaireRepository.GetQuestionnaireAsync( result =&gt; { this.Questionnaire = result.Result; });</code> <br>  <code>result</code>   ,     , , , .    ,     . <br> <br> <code class="cs">this.questionnaireRepository.GetQuestionnaireAsync( result =&gt; { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (result.Error == null) { this.Questionnaire = result.Result; ... } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { // Handle error. } })</code> <br>     <br>        ,      .     , ,             .        ,      ,     ,     . <br> <br>         ,      MVVM,     ,   . ,  -MVVM ,     <code>MessageBox</code>   code-behind UI,      .   MVVM     ,          . <br> <br>     MVVM,              ,          .      ,    ,   ,  ,     . <br> <br>              MVVM.      ,     ,     ,  ,     .    ,         ,     ,          .       . <br> <br>    <br>                  .        ,        .  ,         .         . <br> <br>  ,         ,         ,  .      ,     .           ,       . ,        WPF  Silverlight,        . <br> <br> <img title="Using the service to interact with the user." src="https://habrastorage.org/getpro/habr/post_images/4b5/397/f2d/4b5397f2d02e5851195b29f1893be6fc.png" alt=" ,    ."> <br> <br>  ,   <code>MessageBox</code>        ,     ,    ,     . <br> <br> <code class="cs">var result = interactionService.ShowMessageBox( <span class="hljs-string"><span class="hljs-string">"Are you sure you want to cancel this operation?"</span></span>, <span class="hljs-string"><span class="hljs-string">"Confirm"</span></span>, MessageBoxButton.OK); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (result == MessageBoxResult.Yes) { CancelRequest(); }</code> <br> ,      - ,      ,         Silverlight.         .             .     . <br> <br> <code class="cs">interactionService.ShowMessageBox( <span class="hljs-string"><span class="hljs-string">"Are you sure you want to cancel this operation?"</span></span>, <span class="hljs-string"><span class="hljs-string">"Confirm"</span></span>, MessageBoxButton.OK, result =&gt; { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (result == MessageBoxResult.Yes) { CancelRequest(); } });</code> <br>         ,      . ,  WPF    <code>MessageBox</code> ,       ;    Silverlight    ,    . <br> <br>     <br>         ‚Äì             .         ,      .     ,     .        ,        ,   ,     . <br> <br> <img title="Using interaction request objects." src="https://habrastorage.org/getpro/habr/post_images/3d0/ff0/1c5/3d0ff01c5518558c2d3c5c5f47ce0ce9.png" alt="   ."> <br> <br>    ,   ,          ‚Äì       ,      ,   ‚Äì     .   ,        ,    ,    UI            . <br> <br>       MVVM,     ,       ,         .         ,        ,    ,   . <br> <br>  Prism       <code>IInteractionRequest</code>   <code><code>InteractionRequest .  IInteractionRequest</code>  ,   .           ,   .  <code><code>InteractionRequest   IInteractionRequest</code>     <code>Raise</code> ,           , , ,   . <br> <br>       <br>  <code><code>InteractionRequest          .  Raise</code>          ( <code>T</code> )    ,    ,   .          ,       .      ,        .    ,  ,     . <br> <code class="cs">public interface IInteractionRequest { event EventHandler&lt;InteractionRequestedEventArgs&gt; Raised; } public class InteractionRequest&lt;T&gt; : IInteractionRequest { public event EventHandler&lt;InteractionRequestedEventArgs&gt; Raised; public void Raise(T context, Action&lt;T&gt; callback) { var handler = this.Raised; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (handler != null) { handler( this, new InteractionRequestedEventArgs(context, () =&gt; callback(context))); } } }</code> <br> Prism    ,      .  <code>Notification</code>       .    ,            .     ‚Äì <code>Title</code>  <code>Content</code> ,    .  ,   ,  ,  ,        . <br> <br>  <code>Confirmation</code>    <code>Notification</code>     ‚Äì <code>Confirmed</code> ,  ,  ,      .  <code>Confirmation</code> ,     <code>MessageBox</code> ,     /  .     ,     <code>Notification</code> ,     ,      . <br> <br>    <code><code><code>InteractionRequest ,       InteractionRequest      ,      .      ,    Raise</code> ,    , ,   . <br> <br> <code class="cs">public IInteractionRequest ConfirmCancelInteractionRequest { get { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> this.confirmCancelInteractionRequest; } } this.confirmCancelInteractionRequest.Raise( new Confirmation(<span class="hljs-string"><span class="hljs-string">"Are you sure you wish to cancel?"</span></span>), confirmation =&gt; { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (confirmation.Confirmed) { this.NavigateToQuestionnaireList(); } }); }</code> <br> <i>MVVM Reference Implementation (MVVM RI)</i> ,    <code>IInteractionRequest</code>   <code><code>InteractionRequest ,          (. QuestionnaireViewModel.cs</code> ). <br> <br>        <br>       ,       .   ,       .    UI             . <br> <br>                . Microsoft Expression Blend Behaviors Framework     .  ,     ,    . <br> <br>  <code>EventTrigger</code> ,  Expression Blend,  ,      ,     ,   . , Prism   <code>EventTrigger</code> ,  <code>InteractionRequestTrigger</code> ,      <code>Raised</code>   <code>IInteractionRequest</code> .    XAML        . <br> <br>  ,   , <code>InteractionRequestTrigger</code>   .  Silverlight Prism   <code>PopupChildWindowAction</code> ,     .    ,         .   <code>ContentTemplate</code>  <code>PopupChildWindowAction</code> ,    ,    UI,      <code>Content</code>  .       <code>Title</code>  . <br> <b></b> <br>  ,    ,   <code>PopupChildWindowAction</code> ,     .    <code>Notification</code>  <code>NotificationChildWindow</code> ,        <code>Confirmation</code> ‚Äì <code>ConfirmationChildWindow</code> . <code>NotificationChildWindow</code>    ,   ,     <code>ConfirmationChildWindow</code>    <i>OK</i>  <i>Cancel</i> ,    .    ,   ,   <code>ChildWindow</code>  <code>PopupChildWindowAction</code> . <br>   ,  <code>InteractionRequestTrigger</code>  <code>PopupChildWindowAction</code> ,       <i>RI MVVM</i> . <br> <br> <code class="xml">&lt;i:Interaction.Triggers&gt; &lt;prism:InteractionRequestTrigger SourceObject=<span class="hljs-string"><span class="hljs-string">"{Binding ConfirmCancelInteractionRequest}"</span></span>&gt; &lt;prism:PopupChildWindowAction ContentTemplate=<span class="hljs-string"><span class="hljs-string">"{StaticResource ConfirmWindowTemplate}"</span></span>/&gt; &lt;/prism:InteractionRequestTrigger&gt; &lt;/i:Interaction.Triggers&gt; &lt;UserControl.Resources&gt; &lt;DataTemplate x:Key=<span class="hljs-string"><span class="hljs-string">"ConfirmWindowTemplate"</span></span>&gt; &lt;Grid MinWidth=<span class="hljs-string"><span class="hljs-string">"250"</span></span> MinHeight=<span class="hljs-string"><span class="hljs-string">"100"</span></span>&gt; &lt;TextBlock TextWrapping=<span class="hljs-string"><span class="hljs-string">"Wrap"</span></span> Grid.Row=<span class="hljs-string"><span class="hljs-string">"0"</span></span> Text=<span class="hljs-string"><span class="hljs-string">"{Binding}"</span></span>/&gt; &lt;/Grid&gt; &lt;/DataTemplate&gt; &lt;/UserControl.Resources&gt;</code> <br> <b></b> <br>      <code>ContentTemplate</code> ,   UI   <code>Content</code>  .    <code>Content</code>  ,  , <code>TextBlock</code>     <code>Content</code> . <br>      ,     ,    ,    .  ,     ,       ,     ,    .   ,   <i>RI MVVM</i> ,         <code>Confirmed</code>    <code>Confirmation</code>  <code><span class="hljs-keyword"><span class="hljs-keyword">true</span></span></code> ,     OK. <br> <br>        ,     .  Prism <code>InteractionRequestTrigger</code>   <code>PopupChildWindowAction</code>            . <br> <br>     <br>     MVVM,       , ,    ,         .        (  , ,  ,   ).    ,  ,  ,            . <br> <br>        ,         . Managed Extensibility Framework (MEF)  Unity Application Block (Unity)      ,  ,           . <br> <br>  ,       , , ,    ( )      . ,       ,     .  ,     ,       . <br> <br>     ,  MEF <br>  MEF,       ,   <code>Import</code> ,      ,  ,   <code><span class="hljs-keyword"><span class="hljs-keyword">Export</span></span></code> .         ,    . <br> <br> , <code>QuestionnaireView</code>   <i>RI MVVM</i> ,        ,    <code>Import</code> .   , MEF           .  <code><span class="hljs-keyword"><span class="hljs-keyword">set</span></span></code>        ,   . <br> <br> <code class="cs">[Import] public QuestionnaireViewModel ViewModel { <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> { this.DataContext = value; } }</code> <br>     ,   . <br> <br> <code class="cs">[<span class="hljs-keyword"><span class="hljs-keyword">Export</span></span>] public class QuestionnaireViewModel : NotificationObject { ... }</code> <br>        ,   . <br> <br> <code class="cs">public QuestionnaireView() { InitializeComponent(); } [ImportingConstructor] public QuestionnaireView(QuestionnaireViewModel viewModel) : this() { this.DataContext = viewModel; }</code> <br> <b></b> <br>          MEF,   Unity.   ,     ,        .   ,   Visual Studio  Expression Blend, ,        ,     .   ,   ,  ,      ,          <code>InitializeComponent</code> . <br>     ,  Unity <br>  Unity,    ,   MEF.     ,      .    ,         .  ,      . <br> <br>  ,      ,  ,         . ,           ,   . <br> <br> <code class="cs">public QuestionnaireView() { InitializeComponent(); } public QuestionnaireView(QuestionnaireViewModel viewModel) : this() { this.DataContext = viewModel; }</code> <br> <b></b> <br>    ,        ,   Visual Studio  Expression Blend. <br>  ,          ,   . Unity        <code><span class="hljs-keyword"><span class="hljs-keyword">set</span></span></code>   ,   . <br> <br> <code class="cs">public QuestionnaireView() { InitializeComponent(); } [Dependency] public QuestionnaireViewModel ViewModel { <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> { this.DataContext = value; } }</code> <br>       Unity. <br> <br> <code class="cs">container.RegisterType&lt;QuestionnaireViewModel&gt;();</code> <br>  ,     . <br> <br> <code class="cs">var view = container.Resolve&lt;QuestionnaireView&gt;();</code> <br>     ,    <br>   ,     ,        .        ,   MEF  Unity,        . <br> <br>          .   ,         UI,           . <br> <br> , <i>RI MVVM</i>   ,   ,        .   ,    .      <code>ShowView</code>   UI. <br> <br> <code class="cs">private void NavigateToQuestionnaireList() { //     <span class="hljs-string"><span class="hljs-string">"questionnaire list"</span></span>. this.uiService.ShowView(ViewNames.QuestionnaireTemplatesList); }</code> <br>  UI      UI .           UI.  <code>ShowView</code>  <code>UIService</code>      (,          ),       ,   . <br> <br> <code class="cs">public void ShowView(<span class="hljs-keyword"><span class="hljs-keyword">string</span></span> viewName) { var view = this.ViewFactory.GetView(viewName); this.MainWindow.CurrentView = view; }</code> <br> <b></b> <br> Prism       .   ,   ,   ,             .    ,  , <span class="hljs-string"><span class="hljs-string">" </span></span><a href="http://msdn.microsoft.com/en-us/library/gg430861(v%3DPandP.40).aspx"><span class="hljs-string"><span class="hljs-string">View-Based Navigation</span></span></a><span class="hljs-string"><span class="hljs-string"> "</span></span>   <span class="hljs-number"><span class="hljs-number">8</span></span>, <span class="hljs-string"><span class="hljs-string">" </span></span><a href="http://msdn.microsoft.com/en-us/library/gg430861(v%3DPandP.40).aspx"><span class="hljs-string"><span class="hljs-string">Navigation</span></span></a><span class="hljs-string"><span class="hljs-string"> "</span></span>. <br>  MVVM  <br>        MVVM      .           -      mocking . ,   ,        . <br> <br>   <i>INotifyPropertyChanged</i> <br>   <code>INotifyPropertyChanged</code>     ,      .      ,    ;   ,   ,     ,    ,       . <br> <br>   <br> ,       ,           <code>PropertyChanged</code>  ,         .  ,    <code>ChangeTracker</code> ,     MVVM,  ,      .      .     ,    . <br> <br> <code class="cs">var changeTracker = new PropertyChangeTracker(viewModel); viewModel.CurrentState = <span class="hljs-string"><span class="hljs-string">"newState"</span></span>; CollectionAssert.Contains(changeTracker.ChangedProperties, <span class="hljs-string"><span class="hljs-string">"CurrentState"</span></span>);</code> <br> ,     ,     <code>INotifyPropertyChanged</code> ,    ,   ,     . <br> <br>      <br>        ,   ,    <code><span class="hljs-keyword"><span class="hljs-keyword">set</span></span></code>      ,           . ,     ,     ,      ,          . <br> <br> <code class="cs">var changeTracker = new PropertyChangeTracker(viewModel); var question = viewModel.Questions.First() as OpenQuestionViewModel; question.Question.Response = <span class="hljs-string"><span class="hljs-string">"some text"</span></span>; CollectionAssert.Contains(changeTracker.ChangedProperties, <span class="hljs-string"><span class="hljs-string">"UnansweredQuestions"</span></span>);</code> <br>      <br>     <code>INotifyPropertyChanged</code> ,      <code>PropertyChanged</code>        ,  ,     , , .        ,       . <br> <br>   <i>INotifyDataErrorInfo</i> <br>   ,     ,    ,   ,   <code>IDataErrorInfo</code> ,  ( Silverlight)   <code>INotifyDataErrorInfo</code> .   <code>INotifyDataErrorInfo</code>   ,         ,    ,  ,   ,    . <br> <br>       <code>INotifyDataErrorInfo</code> : ,     ,  ,     ,     <code>ErrorsChanged</code> ,      <code>GetErrors</code> , . <br> <br>    <br>     ,      ,     .       ,         <code>GetErrors</code>       ,  ,  ,   .    , ,  ,     ,        .   ,        . <br> <br> <code class="cs">//  . var notifyErrorInfo = (INotifyDataErrorInfo)question; question.Response = -<span class="hljs-number"><span class="hljs-number">15</span></span>; Assert.IsTrue(notifyErrorInfo.GetErrors(<span class="hljs-string"><span class="hljs-string">"Response"</span></span>).Cast&lt;ValidationResult&gt;().Any()); //  . var notifyErrorInfo = (INotifyDataErrorInfo)question; question.Response = <span class="hljs-number"><span class="hljs-number">15</span></span>; Assert.IsFalse(notifyErrorInfo.GetErrors(<span class="hljs-string"><span class="hljs-string">"Response"</span></span>).Cast&lt;ValidationResult&gt;().Any());</code> <br>    ,    ,             . <br> <br>    <i>INotifyDataErrorInfo</i> <br>       <code>GetErrors</code> ,   <code>INotifyDataErrorInfo</code>  ,   <code>ErrorsChanged</code>      <code>GetErrors</code> . ,  <code>HasErrors</code>      ,  . <br> <br>       <code>INotifyDataErrorInfo</code> . , ,           ,   -  .      ,        <code>INotifyDataErrorInfo</code>         (,        ). <br> <br>     ,   ,  : <br>  <code>HasErrors</code>     .              ,       .  <code>ErrorsChanged</code> ,      ,         <code>GetErrors</code> .         ( ,  )     ,           .    <code>GetErrors</code>       <code>ErrorsChanged</code> . <br>    <code>INotifyPropertyChanged</code> ,  ,    <code>NotifyDataErrorInfoTestHelper</code>    MVVM,        <code>INotifyDataErrorInfo</code> ,       .   ,   ,      ,   .      . <br> <code class="cs">var helper = new NotifyDataErrorInfoTestHelper&lt;NumericQuestion, int?&gt;( question, q =&gt; q.Response); helper.ValidatePropertyChange( <span class="hljs-number"><span class="hljs-number">6</span></span>, NotifyDataErrorInfoBehavior.Nothing); helper.ValidatePropertyChange( <span class="hljs-number"><span class="hljs-number">20</span></span>, NotifyDataErrorInfoBehavior.FiresErrorsChanged | NotifyDataErrorInfoBehavior.HasErrors | NotifyDataErrorInfoBehavior.HasErrorsForProperty); helper.ValidatePropertyChange( null, NotifyDataErrorInfoBehavior.FiresErrorsChanged | NotifyDataErrorInfoBehavior.HasErrors | NotifyDataErrorInfoBehavior.HasErrorsForProperty); helper.ValidatePropertyChange( <span class="hljs-number"><span class="hljs-number">2</span></span>, NotifyDataErrorInfoBehavior.FiresErrorsChanged);</code> <br>     <br>   MVVM,     ,  .   ,    ,         . <br> <br>  ,     ,     ,       .   ,   , ,       ,     ,   <code>IAsyncResult</code>    ,  - ,   ,    UI. <br> <br>       , , ,    .   ,     .  ,      UI,     ,   ,          ,     ,        <span class="hljs-string"><span class="hljs-string">"   UI."</span></span> <br> <br>     ,    ,    .   ,    ,     mock-, ,   ,   ,      ,          . <br> <br>           UI,    ,    .   ,     ,   ,      .        ,   .     ,    ,     . <br> <br> <code class="cs">questionnaireRepositoryMock .Setup( r =&gt; r.SubmitQuestionnaireAsync( It.IsAny&lt;Questionnaire&gt;(), It.IsAny&lt;Action&lt;IOperationResult&gt;&gt;())) .Callback&lt;Questionnaire, Action&lt;IOperationResult&gt;&gt;( (q, a) =&gt; callback = a); uiServicemock .Setup(svc =&gt; svc.ShowView(ViewNames.QuestionnaireTemplatesList)) .Callback&lt;<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>&gt;(viewName =&gt; requestedViewName = viewName); submitResultMock .Setup(sr =&gt; sr.Error) .Returns&lt;Exception&gt;(null); CompleteQuestionnaire(viewModel); viewModel.Submit(); //      UI . callback(submitResultMock.Object); //    ‚Äì     . Assert.AreEqual(ViewNames.QuestionnaireTemplatesList, requestedViewName);</code> <br> <b></b> <br>          ,        . <br>   <br>       , . <span class="hljs-string"><span class="hljs-string">"Trees in WPF"</span></span>  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ms753391.aspx">http://msdn.microsoft.com/en-us/library/ms753391.aspx</a> <br> <br>       , . <span class="hljs-string"><span class="hljs-string">"Attached Properties Overview"</span></span>  MSDN: <a href="http://msdn.microsoft.com/en-us/library/cc265152(VS.95).aspx">http://msdn.microsoft.com/en-us/library/cc265152(VS.<span class="hljs-number"><span class="hljs-number">95</span></span>).aspx</a> <br> <br>      MEF, .<span class="hljs-string"><span class="hljs-string">"Managed Extensibility Framework Overview"</span></span>  MSDN: <a href="http://msdn.microsoft.com/en-us/library/dd460648.aspx">http://msdn.microsoft.com/en-us/library/dd460648.aspx</a> . <br> <br>      Unity, .<span class="hljs-string"><span class="hljs-string">"Unity Application Block"</span></span>  MSDN: <a href="http://www.msdn.com/unity">http://www.msdn.com/unity</a> . <br> <br>      <code>DelegateCommand</code> , .Chapter <span class="hljs-number"><span class="hljs-number">5</span></span>, <span class="hljs-string"><span class="hljs-string">" </span></span><a href="http://msdn.microsoft.com/en-us/library/gg405484(v%3DPandP.40).aspx"><span class="hljs-string"><span class="hljs-string">Implementing the MVVM Pattern</span></span></a><span class="hljs-string"><span class="hljs-string"> ."</span></span> <br> <br>        Microsoft Expression Blend, .<span class="hljs-string"><span class="hljs-string">"Working with built-in behaviors"</span></span>  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ff724013(v%3DExpression.40).aspx">http://msdn.microsoft.com/en-us/library/ff724013(v=Expression.<span class="hljs-number"><span class="hljs-number">40</span></span>).aspx</a> . <br> <br>          Microsoft Expression Blend, .<span class="hljs-string"><span class="hljs-string">"Creating Custom Behaviors"</span></span>  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ff724708(v%3DExpression.40).aspx">http://msdn.microsoft.com/en-us/library/ff724708(v=Expression.<span class="hljs-number"><span class="hljs-number">40</span></span>).aspx</a> . <br> <br>            Microsoft Expression Blend, .<span class="hljs-string"><span class="hljs-string">"Creating Custom Triggers and Actions"</span></span>  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ff724707(v%3DExpression.40).aspx">http://msdn.microsoft.com/en-us/library/ff724707(v=Expression.<span class="hljs-number"><span class="hljs-number">40</span></span>).aspx</a> . <br> <br>         WPF  Silverlight, .<span class="hljs-string"><span class="hljs-string">"Threading Model"</span></span>  <span class="hljs-string"><span class="hljs-string">"The Dispatcher Class"</span></span>  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ms741870.aspx">http://msdn.microsoft.com/en-us/library/ms741870.aspx</a> <br> <a href="http://msdn.microsoft.com/en-us/library/ms615907(v%3DVS.95).aspx">http://msdn.microsoft.com/en-us/library/ms615907(v=VS.<span class="hljs-number"><span class="hljs-number">95</span></span>).aspx</a> . <br> <br>      unit-  Silverlight, .<span class="hljs-string"><span class="hljs-string">"Unit Testing with Silverlight 2"</span></span>: <a href="http://www.jeff.wilcox.name/2008/03/silverlight2-unit-testing/">http://www.jeff.wilcox.name/<span class="hljs-number"><span class="hljs-number">2008</span></span>/<span class="hljs-number"><span class="hljs-number">03</span></span>/silverlight2-unit-testing/</a> . <br> <br>         , .  <span class="hljs-string"><span class="hljs-string">" </span></span><a href="http://msdn.microsoft.com/en-us/library/gg430861(v%3DPandP.40).aspx"><span class="hljs-string"><span class="hljs-string">View-Based Navigation</span></span></a><span class="hljs-string"><span class="hljs-string"> "</span></span> in Chapter <span class="hljs-number"><span class="hljs-number">8</span></span>, <span class="hljs-string"><span class="hljs-string">" </span></span><a href="http://msdn.microsoft.com/en-us/library/gg430861(v%3DPandP.40).aspx"><span class="hljs-string"><span class="hljs-string">Navigation</span></span></a><span class="hljs-string"><span class="hljs-string"> ."</span></span> <br> <br>       ,   , .<span class="hljs-string"><span class="hljs-string">"Event-based Asynchronous Pattern Overview"</span></span>  MSDN: <a href="http://msdn.microsoft.com/en-us/library/wewwczdw.aspx">http://msdn.microsoft.com/en-us/library/wewwczdw.aspx</a> <br> <br>        <code>IAsyncResult</code> , .<span class="hljs-string"><span class="hljs-string">"Asynchronous Programming Overview"</span></span>  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ms228963.aspx">http://msdn.microsoft.com/en-us/library/ms228963.aspx</a></code></code></code></code></code></code></code></code></code> </pre> <code><code><code><code>CommandBehaviorBase ,    ,    ICommand</code> .           <code>CanExecuteChanged</code> ,          Silverlight,    WPF. <br> <br>    ,  ,   <code>CommandBehaviorBase    ,    .         ,      .         ,    .      ButtonBaseClickCommandBehavior</code> . <br> <br> <code class="cs">public class ButtonBaseClickCommandBehavior : CommandBehaviorBase&lt;ButtonBase&gt; { public ButtonBaseClickCommandBehavior(ButtonBase clickableObject) : base(clickableObject) { clickableObject.Click += OnClick; } private void OnClick(object sender, System.Windows.RoutedEventArgs e) { ExecuteCommand(); } }</code> <br>   <code>CommandBehaviorBase ,     .     ,          ,   . ,    ,    ,      , ,    CanExecute</code>  ,     . <br> <br>          ,   .           XAML.           .       .  Prism      ,       ,  ,   .       ,    . , ,  ,      <code>Click</code> ,       <code>Command</code> .    <code>Click.Command</code> ,  . <br> <br>             .             . <br> <br> <code class="cs">public static readonly DependencyProperty CommandProperty = DependencyProperty.RegisterAttached( "Command", typeof(ICommand), typeof(Click), new PropertyMetadata(OnSetCommandCallback)); private static readonly DependencyProperty ClickCommandBehaviorProperty = DependencyProperty.RegisterAttached( "ClickCommandBehavior", typeof(ButtonBaseClickCommandBehavior), typeof(Click), null);</code> <br>    <code>Command</code>    <code>ButtonBaseClickCommandBehavior</code> ,     <code>OnSetCommandCallback</code> ,     . <br> <br> <code class="cs">private static void OnSetCommandCallback(DependencyObject dependencyObject, DependencyPropertyChangedEventArgs e) { ButtonBase buttonBase = dependencyObject as ButtonBase; if (buttonBase != null) { ButtonBaseClickCommandBehavior behavior = GetOrCreateBehavior(buttonBase); behavior.Command = e.NewValue as ICommand; } } private static void OnSetCommandParameterCallback(DependencyObject dependencyObject, DependencyPropertyChangedEventArgs e) { ButtonBase buttonBase = dependencyObject as ButtonBase; if (buttonBase != null) { ButtonBaseClickCommandBehavior behavior = GetOrCreateBehavior(buttonBase); behavior.CommandParameter = e.NewValue; } } private static ButtonBaseClickCommandBehavior GetOrCreateBehavior(ButtonBase buttonBase ) { ButtonBaseClickCommandBehavior behavior = buttonBase.GetValue(ClickCommandBehaviorProperty) as ButtonBaseClickCommandBehavior; if ( behavior == null ) { behavior = new ButtonBaseClickCommandBehavior(buttonBase); buttonBase.SetValue(ClickCommandBehaviorProperty, behavior); } return behavior; }</code> <br>        ,  <a href="http://msdn.microsoft.com/en-us/library/cc265152(VS.95).aspx">Attached Properties Overview</a>  MSDN. <br> <br>    <br>              . ,     Silverlight,    -,     ,      ,     .     ,       . <br> <br>        ,    ( )  ,  ,     .  UI       ,            UI. <br> <br>      - <br>   -     ,       <code>IAsyncResult</code> .   ,  ,   ,  <code>GetQuestionnaire</code> ,   : <code>BeginGetQuestionnaire</code>  <code>EndGetQuestionnaire</code> .    ,   <code>BeginGetQuestionnaire</code> .     ,   ,   <code>EndGetQuestionnaire</code>    . <br> <b></b> <br>  .NET Framework 4.5      <code>await</code>  <code>async</code>     <code>*Async</code> .      <a href="http://msdn.microsoft.com/en-us/library/vstudio/hh391443.aspx">"Asynchronous Programming with Async and Await (C# and Visual Basic)"</a> . <br>  ,    <code>EndGetQuestionnaire</code> ,      ,  ()      <code>BeginGetQuestionnaire</code> .     ,      ,   <code>EndGetQuestionnaire</code> ,   . <br> <br> <code class="xml">IAsyncResult asyncResult = this.service.BeginGetQuestionnaire( GetQuestionnaireCompleted, null //  ,      ); private void GetQuestionnaireCompleted(IAsyncResult result) { try { questionnaire = this.service.EndGetQuestionnaire(ar); } catch (Exception ex) { //  -   . } }</code> <br>  ,     <code>End*</code> (  , <code>EndGetQuestionnaire</code> ),    ,      .      , ,          UI.     ,   ,        . <br> <br>        UI,     -,      UI,         UI,   <code>Dispatcher</code>    <code>SynchronizationContext</code> .  WPF  Silverlight,   <code>Dispatcher</code> . <br> <br>      <code>Questionnaire</code>  ,        <code>QuestionnaireView</code> .  Silverlight    <code>CheckAccess</code> ,  ,      UI.  ,     <code>BeginInvoke</code> ,      UI. <br> <br> <code class="cs">var dispatcher = System.Windows.Deployment.Current.Dispatcher; if (dispatcher.CheckAccess()) { QuestionnaireView.DataContext = questionnaire; } else { dispatcher.BeginInvoke(() =&gt; { Questionnaire.DataContext = questionnaire; }); }</code> <br> <i>MVVM RI</i>   ,    ,   <code>IAsyncResult</code> ,   .      ,                 . ,       . <br> <br> <code class="cs">this.questionnaireRepository.GetQuestionnaireAsync( result =&gt; { this.Questionnaire = result.Result; });</code> <br>  <code>result</code>   ,     , , , .    ,     . <br> <br> <code class="cs">this.questionnaireRepository.GetQuestionnaireAsync( result =&gt; { if (result.Error == null) { this.Questionnaire = result.Result; ... } else { // Handle error. } })</code> <br>     <br>        ,      .     , ,             .        ,      ,     ,     . <br> <br>         ,      MVVM,     ,   . ,  -MVVM ,     <code>MessageBox</code>   code-behind UI,      .   MVVM     ,          . <br> <br>     MVVM,              ,          .      ,    ,   ,  ,     . <br> <br>              MVVM.      ,     ,     ,  ,     .    ,         ,     ,          .       . <br> <br>    <br>                  .        ,        .  ,         .         . <br> <br>  ,         ,         ,  .      ,     .           ,       . ,        WPF  Silverlight,        . <br> <br> <img title="Using the service to interact with the user." src="https://habrastorage.org/getpro/habr/post_images/4b5/397/f2d/4b5397f2d02e5851195b29f1893be6fc.png" alt=" ,    ."> <br> <br>  ,   <code>MessageBox</code>        ,     ,    ,     . <br> <br> <code class="cs">var result = interactionService.ShowMessageBox( "Are you sure you want to cancel this operation?", "Confirm", MessageBoxButton.OK); if (result == MessageBoxResult.Yes) { CancelRequest(); }</code> <br> ,      - ,      ,         Silverlight.         .             .     . <br> <br> <code class="cs">interactionService.ShowMessageBox( "Are you sure you want to cancel this operation?", "Confirm", MessageBoxButton.OK, result =&gt; { if (result == MessageBoxResult.Yes) { CancelRequest(); } });</code> <br>         ,      . ,  WPF    <code>MessageBox</code> ,       ;    Silverlight    ,    . <br> <br>     <br>         ‚Äì             .         ,      .     ,     .        ,        ,   ,     . <br> <br> <img title="Using interaction request objects." src="https://habrastorage.org/getpro/habr/post_images/3d0/ff0/1c5/3d0ff01c5518558c2d3c5c5f47ce0ce9.png" alt="   ."> <br> <br>    ,   ,          ‚Äì       ,      ,   ‚Äì     .   ,        ,    ,    UI            . <br> <br>       MVVM,     ,       ,         .         ,        ,    ,   . <br> <br>  Prism       <code>IInteractionRequest</code>   <code><code>InteractionRequest .  IInteractionRequest</code>  ,   .           ,   .  <code><code>InteractionRequest   IInteractionRequest</code>     <code>Raise</code> ,           , , ,   . <br> <br>       <br>  <code><code>InteractionRequest          .  Raise</code>          ( <code>T</code> )    ,    ,   .          ,       .      ,        .    ,  ,     . <br> <code class="cs">public interface IInteractionRequest { event EventHandler&lt;InteractionRequestedEventArgs&gt; Raised; } public class InteractionRequest&lt;T&gt; : IInteractionRequest { public event EventHandler&lt;InteractionRequestedEventArgs&gt; Raised; public void Raise(T context, Action&lt;T&gt; callback) { var handler = this.Raised; if (handler != null) { handler( this, new InteractionRequestedEventArgs(context, () =&gt; callback(context))); } } }</code> <br> Prism    ,      .  <code>Notification</code>       .    ,            .     ‚Äì <code>Title</code>  <code>Content</code> ,    .  ,   ,  ,  ,        . <br> <br>  <code>Confirmation</code>    <code>Notification</code>     ‚Äì <code>Confirmed</code> ,  ,  ,      .  <code>Confirmation</code> ,     <code>MessageBox</code> ,     /  .     ,     <code>Notification</code> ,     ,      . <br> <br>    <code><code><code>InteractionRequest ,       InteractionRequest      ,      .      ,    Raise</code> ,    , ,   . <br> <br> <code class="cs">public IInteractionRequest ConfirmCancelInteractionRequest { get { return this.confirmCancelInteractionRequest; } } this.confirmCancelInteractionRequest.Raise( new Confirmation("Are you sure you wish to cancel?"), confirmation =&gt; { if (confirmation.Confirmed) { this.NavigateToQuestionnaireList(); } }); }</code> <br> <i>MVVM Reference Implementation (MVVM RI)</i> ,    <code>IInteractionRequest</code>   <code><code>InteractionRequest ,          (. QuestionnaireViewModel.cs</code> ). <br> <br>        <br>       ,       .   ,       .    UI             . <br> <br>                . Microsoft Expression Blend Behaviors Framework     .  ,     ,    . <br> <br>  <code>EventTrigger</code> ,  Expression Blend,  ,      ,     ,   . , Prism   <code>EventTrigger</code> ,  <code>InteractionRequestTrigger</code> ,      <code>Raised</code>   <code>IInteractionRequest</code> .    XAML        . <br> <br>  ,   , <code>InteractionRequestTrigger</code>   .  Silverlight Prism   <code>PopupChildWindowAction</code> ,     .    ,         .   <code>ContentTemplate</code>  <code>PopupChildWindowAction</code> ,    ,    UI,      <code>Content</code>  .       <code>Title</code>  . <br> <b></b> <br>  ,    ,   <code>PopupChildWindowAction</code> ,     .    <code>Notification</code>  <code>NotificationChildWindow</code> ,        <code>Confirmation</code> ‚Äì <code>ConfirmationChildWindow</code> . <code>NotificationChildWindow</code>    ,   ,     <code>ConfirmationChildWindow</code>    <i>OK</i>  <i>Cancel</i> ,    .    ,   ,   <code>ChildWindow</code>  <code>PopupChildWindowAction</code> . <br>   ,  <code>InteractionRequestTrigger</code>  <code>PopupChildWindowAction</code> ,       <i>RI MVVM</i> . <br> <br> <code class="xml">&lt;i:Interaction.Triggers&gt; &lt;prism:InteractionRequestTrigger SourceObject="{Binding ConfirmCancelInteractionRequest}"&gt; &lt;prism:PopupChildWindowAction ContentTemplate="{StaticResource ConfirmWindowTemplate}"/&gt; &lt;/prism:InteractionRequestTrigger&gt; &lt;/i:Interaction.Triggers&gt; &lt;UserControl.Resources&gt; &lt;DataTemplate x:Key="ConfirmWindowTemplate"&gt; &lt;Grid MinWidth="250" MinHeight="100"&gt; &lt;TextBlock TextWrapping="Wrap" Grid.Row="0" Text="{Binding}"/&gt; &lt;/Grid&gt; &lt;/DataTemplate&gt; &lt;/UserControl.Resources&gt;</code> <br> <b></b> <br>      <code>ContentTemplate</code> ,   UI   <code>Content</code>  .    <code>Content</code>  ,  , <code>TextBlock</code>     <code>Content</code> . <br>      ,     ,    ,    .  ,     ,       ,     ,    .   ,   <i>RI MVVM</i> ,         <code>Confirmed</code>    <code>Confirmation</code>  <code>true</code> ,     OK. <br> <br>        ,     .  Prism <code>InteractionRequestTrigger</code>   <code>PopupChildWindowAction</code>            . <br> <br>     <br>     MVVM,       , ,    ,         .        (  , ,  ,   ).    ,  ,  ,            . <br> <br>        ,         . Managed Extensibility Framework (MEF)  Unity Application Block (Unity)      ,  ,           . <br> <br>  ,       , , ,    ( )      . ,       ,     .  ,     ,       . <br> <br>     ,  MEF <br>  MEF,       ,   <code>Import</code> ,      ,  ,   <code>Export</code> .         ,    . <br> <br> , <code>QuestionnaireView</code>   <i>RI MVVM</i> ,        ,    <code>Import</code> .   , MEF           .  <code>set</code>        ,   . <br> <br> <code class="cs">[Import] public QuestionnaireViewModel ViewModel { set { this.DataContext = value; } }</code> <br>     ,   . <br> <br> <code class="cs">[Export] public class QuestionnaireViewModel : NotificationObject { ... }</code> <br>        ,   . <br> <br> <code class="cs">public QuestionnaireView() { InitializeComponent(); } [ImportingConstructor] public QuestionnaireView(QuestionnaireViewModel viewModel) : this() { this.DataContext = viewModel; }</code> <br> <b></b> <br>          MEF,   Unity.   ,     ,        .   ,   Visual Studio  Expression Blend, ,        ,     .   ,   ,  ,      ,          <code>InitializeComponent</code> . <br>     ,  Unity <br>  Unity,    ,   MEF.     ,      .    ,         .  ,      . <br> <br>  ,      ,  ,         . ,           ,   . <br> <br> <code class="cs">public QuestionnaireView() { InitializeComponent(); } public QuestionnaireView(QuestionnaireViewModel viewModel) : this() { this.DataContext = viewModel; }</code> <br> <b></b> <br>    ,        ,   Visual Studio  Expression Blend. <br>  ,          ,   . Unity        <code>set</code>   ,   . <br> <br> <code class="cs">public QuestionnaireView() { InitializeComponent(); } [Dependency] public QuestionnaireViewModel ViewModel { set { this.DataContext = value; } }</code> <br>       Unity. <br> <br> <code class="cs">container.RegisterType&lt;QuestionnaireViewModel&gt;();</code> <br>  ,     . <br> <br> <code class="cs">var view = container.Resolve&lt;QuestionnaireView&gt;();</code> <br>     ,    <br>   ,     ,        .        ,   MEF  Unity,        . <br> <br>          .   ,         UI,           . <br> <br> , <i>RI MVVM</i>   ,   ,        .   ,    .      <code>ShowView</code>   UI. <br> <br> <code class="cs">private void NavigateToQuestionnaireList() { //     "questionnaire list". this.uiService.ShowView(ViewNames.QuestionnaireTemplatesList); }</code> <br>  UI      UI .           UI.  <code>ShowView</code>  <code>UIService</code>      (,          ),       ,   . <br> <br> <code class="cs">public void ShowView(string viewName) { var view = this.ViewFactory.GetView(viewName); this.MainWindow.CurrentView = view; }</code> <br> <b></b> <br> Prism       .   ,   ,   ,             .    ,  , " <a href="http://msdn.microsoft.com/en-us/library/gg430861(v%3DPandP.40).aspx">View-Based Navigation</a> "   8, " <a href="http://msdn.microsoft.com/en-us/library/gg430861(v%3DPandP.40).aspx">Navigation</a> ". <br>  MVVM  <br>        MVVM      .           -      mocking . ,   ,        . <br> <br>   <i>INotifyPropertyChanged</i> <br>   <code>INotifyPropertyChanged</code>     ,      .      ,    ;   ,   ,     ,    ,       . <br> <br>   <br> ,       ,           <code>PropertyChanged</code>  ,         .  ,    <code>ChangeTracker</code> ,     MVVM,  ,      .      .     ,    . <br> <br> <code class="cs">var changeTracker = new PropertyChangeTracker(viewModel); viewModel.CurrentState = "newState"; CollectionAssert.Contains(changeTracker.ChangedProperties, "CurrentState");</code> <br> ,     ,     <code>INotifyPropertyChanged</code> ,    ,   ,     . <br> <br>      <br>        ,   ,    <code>set</code>      ,           . ,     ,     ,      ,          . <br> <br> <code class="cs">var changeTracker = new PropertyChangeTracker(viewModel); var question = viewModel.Questions.First() as OpenQuestionViewModel; question.Question.Response = "some text"; CollectionAssert.Contains(changeTracker.ChangedProperties, "UnansweredQuestions");</code> <br>      <br>     <code>INotifyPropertyChanged</code> ,      <code>PropertyChanged</code>        ,  ,     , , .        ,       . <br> <br>   <i>INotifyDataErrorInfo</i> <br>   ,     ,    ,   ,   <code>IDataErrorInfo</code> ,  ( Silverlight)   <code>INotifyDataErrorInfo</code> .   <code>INotifyDataErrorInfo</code>   ,         ,    ,  ,   ,    . <br> <br>       <code>INotifyDataErrorInfo</code> : ,     ,  ,     ,     <code>ErrorsChanged</code> ,      <code>GetErrors</code> , . <br> <br>    <br>     ,      ,     .       ,         <code>GetErrors</code>       ,  ,  ,   .    , ,  ,     ,        .   ,        . <br> <br> <code class="cs">//  . var notifyErrorInfo = (INotifyDataErrorInfo)question; question.Response = -15; Assert.IsTrue(notifyErrorInfo.GetErrors("Response").Cast&lt;ValidationResult&gt;().Any()); //  . var notifyErrorInfo = (INotifyDataErrorInfo)question; question.Response = 15; Assert.IsFalse(notifyErrorInfo.GetErrors("Response").Cast&lt;ValidationResult&gt;().Any());</code> <br>    ,    ,             . <br> <br>    <i>INotifyDataErrorInfo</i> <br>       <code>GetErrors</code> ,   <code>INotifyDataErrorInfo</code>  ,   <code>ErrorsChanged</code>      <code>GetErrors</code> . ,  <code>HasErrors</code>      ,  . <br> <br>       <code>INotifyDataErrorInfo</code> . , ,           ,   -  .      ,        <code>INotifyDataErrorInfo</code>         (,        ). <br> <br>     ,   ,  : <br>  <code>HasErrors</code>     .              ,       .  <code>ErrorsChanged</code> ,      ,         <code>GetErrors</code> .         ( ,  )     ,           .    <code>GetErrors</code>       <code>ErrorsChanged</code> . <br>    <code>INotifyPropertyChanged</code> ,  ,    <code>NotifyDataErrorInfoTestHelper</code>    MVVM,        <code>INotifyDataErrorInfo</code> ,       .   ,   ,      ,   .      . <br> <code class="cs">var helper = new NotifyDataErrorInfoTestHelper&lt;NumericQuestion, int?&gt;( question, q =&gt; q.Response); helper.ValidatePropertyChange( 6, NotifyDataErrorInfoBehavior.Nothing); helper.ValidatePropertyChange( 20, NotifyDataErrorInfoBehavior.FiresErrorsChanged | NotifyDataErrorInfoBehavior.HasErrors | NotifyDataErrorInfoBehavior.HasErrorsForProperty); helper.ValidatePropertyChange( null, NotifyDataErrorInfoBehavior.FiresErrorsChanged | NotifyDataErrorInfoBehavior.HasErrors | NotifyDataErrorInfoBehavior.HasErrorsForProperty); helper.ValidatePropertyChange( 2, NotifyDataErrorInfoBehavior.FiresErrorsChanged);</code> <br>     <br>   MVVM,     ,  .   ,    ,         . <br> <br>  ,     ,     ,       .   ,   , ,       ,     ,   <code>IAsyncResult</code>    ,  - ,   ,    UI. <br> <br>       , , ,    .   ,     .  ,      UI,     ,   ,          ,     ,        "   UI." <br> <br>     ,    ,    .   ,    ,     mock-, ,   ,   ,      ,          . <br> <br>           UI,    ,    .   ,     ,   ,      .        ,   .     ,    ,     . <br> <br> <code class="cs">questionnaireRepositoryMock .Setup( r =&gt; r.SubmitQuestionnaireAsync( It.IsAny&lt;Questionnaire&gt;(), It.IsAny&lt;Action&lt;IOperationResult&gt;&gt;())) .Callback&lt;Questionnaire, Action&lt;IOperationResult&gt;&gt;( (q, a) =&gt; callback = a); uiServicemock .Setup(svc =&gt; svc.ShowView(ViewNames.QuestionnaireTemplatesList)) .Callback&lt;string&gt;(viewName =&gt; requestedViewName = viewName); submitResultMock .Setup(sr =&gt; sr.Error) .Returns&lt;Exception&gt;(null); CompleteQuestionnaire(viewModel); viewModel.Submit(); //      UI . callback(submitResultMock.Object); //    ‚Äì     . Assert.AreEqual(ViewNames.QuestionnaireTemplatesList, requestedViewName);</code> <br> <b></b> <br>          ,        . <br>   <br>       , . "Trees in WPF"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ms753391.aspx">http://msdn.microsoft.com/en-us/library/ms753391.aspx</a> <br> <br>       , . "Attached Properties Overview"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/cc265152(VS.95).aspx">http://msdn.microsoft.com/en-us/library/cc265152(VS.95).aspx</a> <br> <br>      MEF, ."Managed Extensibility Framework Overview"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/dd460648.aspx">http://msdn.microsoft.com/en-us/library/dd460648.aspx</a> . <br> <br>      Unity, ."Unity Application Block"  MSDN: <a href="http://www.msdn.com/unity">http://www.msdn.com/unity</a> . <br> <br>      <code>DelegateCommand</code> , .Chapter 5, " <a href="http://msdn.microsoft.com/en-us/library/gg405484(v%3DPandP.40).aspx">Implementing the MVVM Pattern</a> ." <br> <br>        Microsoft Expression Blend, ."Working with built-in behaviors"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ff724013(v%3DExpression.40).aspx">http://msdn.microsoft.com/en-us/library/ff724013(v=Expression.40).aspx</a> . <br> <br>          Microsoft Expression Blend, ."Creating Custom Behaviors"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ff724708(v%3DExpression.40).aspx">http://msdn.microsoft.com/en-us/library/ff724708(v=Expression.40).aspx</a> . <br> <br>            Microsoft Expression Blend, ."Creating Custom Triggers and Actions"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ff724707(v%3DExpression.40).aspx">http://msdn.microsoft.com/en-us/library/ff724707(v=Expression.40).aspx</a> . <br> <br>         WPF  Silverlight, ."Threading Model"  "The Dispatcher Class"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ms741870.aspx">http://msdn.microsoft.com/en-us/library/ms741870.aspx</a> <br> <a href="http://msdn.microsoft.com/en-us/library/ms615907(v%3DVS.95).aspx">http://msdn.microsoft.com/en-us/library/ms615907(v=VS.95).aspx</a> . <br> <br>      unit-  Silverlight, ."Unit Testing with Silverlight 2": <a href="http://www.jeff.wilcox.name/2008/03/silverlight2-unit-testing/">http://www.jeff.wilcox.name/2008/03/silverlight2-unit-testing/</a> . <br> <br>         , .  " <a href="http://msdn.microsoft.com/en-us/library/gg430861(v%3DPandP.40).aspx">View-Based Navigation</a> " in Chapter 8, " <a href="http://msdn.microsoft.com/en-us/library/gg430861(v%3DPandP.40).aspx">Navigation</a> ." <br> <br>       ,   , ."Event-based Asynchronous Pattern Overview"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/wewwczdw.aspx">http://msdn.microsoft.com/en-us/library/wewwczdw.aspx</a> <br> <br>        <code>IAsyncResult</code> , ."Asynchronous Programming Overview"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ms228963.aspx">http://msdn.microsoft.com/en-us/library/ms228963.aspx</a></code></code></code></code></code></code></code></code></code> <pre> <code class="hljs cmake"><code>CommandBehaviorBase ,    ,    ICommand</code> .           <code>CanExecuteChanged</code> ,          Silverlight,    WPF. <br> <br>    ,  ,   <code><code>CommandBehaviorBase    ,    .         ,      .         ,    .      ButtonBaseClickCommandBehavior</code> . <br> <br> <code class="cs">public class ButtonBaseClickCommandBehavior : CommandBehaviorBase&lt;ButtonBase&gt; { public ButtonBaseClickCommandBehavior(ButtonBase clickableObject) : base(clickableObject) { clickableObject.Click += OnClick; } private void OnClick(object sender, System.Windows.RoutedEventArgs e) { ExecuteCommand(); } }</code> <br>   <code><code>CommandBehaviorBase ,     .     ,          ,   . ,    ,    ,      , ,    CanExecute</code>  ,     . <br> <br>          ,   .           XAML.           .       .  Prism      ,       ,  ,   .       ,    . , ,  ,      <code>Click</code> ,       <code><span class="hljs-keyword"><span class="hljs-keyword">Command</span></span></code> .    <code>Click.<span class="hljs-keyword"><span class="hljs-keyword">Command</span></span></code> ,  . <br> <br>             .             . <br> <br> <code class="cs">public static readonly DependencyProperty CommandProperty = DependencyProperty.RegisterAttached( <span class="hljs-string"><span class="hljs-string">"Command"</span></span>, typeof(ICommand), typeof(Click), new PropertyMetadata(OnSetCommandCallback)); private static readonly DependencyProperty ClickCommandBehaviorProperty = DependencyProperty.RegisterAttached( <span class="hljs-string"><span class="hljs-string">"ClickCommandBehavior"</span></span>, typeof(ButtonBaseClickCommandBehavior), typeof(Click), null);</code> <br>    <code><span class="hljs-keyword"><span class="hljs-keyword">Command</span></span></code>    <code>ButtonBaseClickCommandBehavior</code> ,     <code>OnSetCommandCallback</code> ,     . <br> <br> <code class="cs">private static void OnSetCommandCallback(DependencyObject dependencyObject, DependencyPropertyChangedEventArgs e) { ButtonBase buttonBase = dependencyObject as ButtonBase; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (buttonBase != null) { ButtonBaseClickCommandBehavior behavior = GetOrCreateBehavior(buttonBase); behavior.<span class="hljs-keyword"><span class="hljs-keyword">Command</span></span> = e.NewValue as ICommand; } } private static void OnSetCommandParameterCallback(DependencyObject dependencyObject, DependencyPropertyChangedEventArgs e) { ButtonBase buttonBase = dependencyObject as ButtonBase; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (buttonBase != null) { ButtonBaseClickCommandBehavior behavior = GetOrCreateBehavior(buttonBase); behavior.CommandParameter = e.NewValue; } } private static ButtonBaseClickCommandBehavior GetOrCreateBehavior(ButtonBase buttonBase ) { ButtonBaseClickCommandBehavior behavior = buttonBase.GetValue(ClickCommandBehaviorProperty) as ButtonBaseClickCommandBehavior; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ( behavior == null ) { behavior = new ButtonBaseClickCommandBehavior(buttonBase); buttonBase.SetValue(ClickCommandBehaviorProperty, behavior); } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> behavior; }</code> <br>        ,  <a href="http://msdn.microsoft.com/en-us/library/cc265152(VS.95).aspx">Attached Properties Overview</a>  MSDN. <br> <br>    <br>              . ,     Silverlight,    -,     ,      ,     .     ,       . <br> <br>        ,    ( )  ,  ,     .  UI       ,            UI. <br> <br>      - <br>   -     ,       <code>IAsyncResult</code> .   ,  ,   ,  <code>GetQuestionnaire</code> ,   : <code>BeginGetQuestionnaire</code>  <code>EndGetQuestionnaire</code> .    ,   <code>BeginGetQuestionnaire</code> .     ,   ,   <code>EndGetQuestionnaire</code>    . <br> <b></b> <br>  .NET Framework <span class="hljs-number"><span class="hljs-number">4.5</span></span>      <code>await</code>  <code>async</code>     <code>*Async</code> .      <a href="http://msdn.microsoft.com/en-us/library/vstudio/hh391443.aspx"><span class="hljs-string"><span class="hljs-string">"Asynchronous Programming with Async and Await (C# and Visual Basic)"</span></span></a> . <br>  ,    <code>EndGetQuestionnaire</code> ,      ,  ()      <code>BeginGetQuestionnaire</code> .     ,      ,   <code>EndGetQuestionnaire</code> ,   . <br> <br> <code class="xml">IAsyncResult asyncResult = this.service.BeginGetQuestionnaire( GetQuestionnaireCompleted, null //  ,      ); private void GetQuestionnaireCompleted(IAsyncResult result) { try { questionnaire = this.service.EndGetQuestionnaire(ar); } catch (Exception ex) { //  -   . } }</code> <br>  ,     <code>End*</code> (  , <code>EndGetQuestionnaire</code> ),    ,      .      , ,          UI.     ,   ,        . <br> <br>        UI,     -,      UI,         UI,   <code>Dispatcher</code>    <code>SynchronizationContext</code> .  WPF  Silverlight,   <code>Dispatcher</code> . <br> <br>      <code>Questionnaire</code>  ,        <code>QuestionnaireView</code> .  Silverlight    <code>CheckAccess</code> ,  ,      UI.  ,     <code>BeginInvoke</code> ,      UI. <br> <br> <code class="cs">var dispatcher = System.Windows.Deployment.Current.Dispatcher; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (dispatcher.CheckAccess()) { QuestionnaireView.DataContext = questionnaire; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { dispatcher.BeginInvoke(() =&gt; { Questionnaire.DataContext = questionnaire; }); }</code> <br> <i>MVVM RI</i>   ,    ,   <code>IAsyncResult</code> ,   .      ,                 . ,       . <br> <br> <code class="cs">this.questionnaireRepository.GetQuestionnaireAsync( result =&gt; { this.Questionnaire = result.Result; });</code> <br>  <code>result</code>   ,     , , , .    ,     . <br> <br> <code class="cs">this.questionnaireRepository.GetQuestionnaireAsync( result =&gt; { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (result.Error == null) { this.Questionnaire = result.Result; ... } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { // Handle error. } })</code> <br>     <br>        ,      .     , ,             .        ,      ,     ,     . <br> <br>         ,      MVVM,     ,   . ,  -MVVM ,     <code>MessageBox</code>   code-behind UI,      .   MVVM     ,          . <br> <br>     MVVM,              ,          .      ,    ,   ,  ,     . <br> <br>              MVVM.      ,     ,     ,  ,     .    ,         ,     ,          .       . <br> <br>    <br>                  .        ,        .  ,         .         . <br> <br>  ,         ,         ,  .      ,     .           ,       . ,        WPF  Silverlight,        . <br> <br> <img title="Using the service to interact with the user." src="https://habrastorage.org/getpro/habr/post_images/4b5/397/f2d/4b5397f2d02e5851195b29f1893be6fc.png" alt=" ,    ."> <br> <br>  ,   <code>MessageBox</code>        ,     ,    ,     . <br> <br> <code class="cs">var result = interactionService.ShowMessageBox( <span class="hljs-string"><span class="hljs-string">"Are you sure you want to cancel this operation?"</span></span>, <span class="hljs-string"><span class="hljs-string">"Confirm"</span></span>, MessageBoxButton.OK); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (result == MessageBoxResult.Yes) { CancelRequest(); }</code> <br> ,      - ,      ,         Silverlight.         .             .     . <br> <br> <code class="cs">interactionService.ShowMessageBox( <span class="hljs-string"><span class="hljs-string">"Are you sure you want to cancel this operation?"</span></span>, <span class="hljs-string"><span class="hljs-string">"Confirm"</span></span>, MessageBoxButton.OK, result =&gt; { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (result == MessageBoxResult.Yes) { CancelRequest(); } });</code> <br>         ,      . ,  WPF    <code>MessageBox</code> ,       ;    Silverlight    ,    . <br> <br>     <br>         ‚Äì             .         ,      .     ,     .        ,        ,   ,     . <br> <br> <img title="Using interaction request objects." src="https://habrastorage.org/getpro/habr/post_images/3d0/ff0/1c5/3d0ff01c5518558c2d3c5c5f47ce0ce9.png" alt="   ."> <br> <br>    ,   ,          ‚Äì       ,      ,   ‚Äì     .   ,        ,    ,    UI            . <br> <br>       MVVM,     ,       ,         .         ,        ,    ,   . <br> <br>  Prism       <code>IInteractionRequest</code>   <code><code>InteractionRequest .  IInteractionRequest</code>  ,   .           ,   .  <code><code>InteractionRequest   IInteractionRequest</code>     <code>Raise</code> ,           , , ,   . <br> <br>       <br>  <code><code>InteractionRequest          .  Raise</code>          ( <code>T</code> )    ,    ,   .          ,       .      ,        .    ,  ,     . <br> <code class="cs">public interface IInteractionRequest { event EventHandler&lt;InteractionRequestedEventArgs&gt; Raised; } public class InteractionRequest&lt;T&gt; : IInteractionRequest { public event EventHandler&lt;InteractionRequestedEventArgs&gt; Raised; public void Raise(T context, Action&lt;T&gt; callback) { var handler = this.Raised; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (handler != null) { handler( this, new InteractionRequestedEventArgs(context, () =&gt; callback(context))); } } }</code> <br> Prism    ,      .  <code>Notification</code>       .    ,            .     ‚Äì <code>Title</code>  <code>Content</code> ,    .  ,   ,  ,  ,        . <br> <br>  <code>Confirmation</code>    <code>Notification</code>     ‚Äì <code>Confirmed</code> ,  ,  ,      .  <code>Confirmation</code> ,     <code>MessageBox</code> ,     /  .     ,     <code>Notification</code> ,     ,      . <br> <br>    <code><code><code>InteractionRequest ,       InteractionRequest      ,      .      ,    Raise</code> ,    , ,   . <br> <br> <code class="cs">public IInteractionRequest ConfirmCancelInteractionRequest { get { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> this.confirmCancelInteractionRequest; } } this.confirmCancelInteractionRequest.Raise( new Confirmation(<span class="hljs-string"><span class="hljs-string">"Are you sure you wish to cancel?"</span></span>), confirmation =&gt; { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (confirmation.Confirmed) { this.NavigateToQuestionnaireList(); } }); }</code> <br> <i>MVVM Reference Implementation (MVVM RI)</i> ,    <code>IInteractionRequest</code>   <code><code>InteractionRequest ,          (. QuestionnaireViewModel.cs</code> ). <br> <br>        <br>       ,       .   ,       .    UI             . <br> <br>                . Microsoft Expression Blend Behaviors Framework     .  ,     ,    . <br> <br>  <code>EventTrigger</code> ,  Expression Blend,  ,      ,     ,   . , Prism   <code>EventTrigger</code> ,  <code>InteractionRequestTrigger</code> ,      <code>Raised</code>   <code>IInteractionRequest</code> .    XAML        . <br> <br>  ,   , <code>InteractionRequestTrigger</code>   .  Silverlight Prism   <code>PopupChildWindowAction</code> ,     .    ,         .   <code>ContentTemplate</code>  <code>PopupChildWindowAction</code> ,    ,    UI,      <code>Content</code>  .       <code>Title</code>  . <br> <b></b> <br>  ,    ,   <code>PopupChildWindowAction</code> ,     .    <code>Notification</code>  <code>NotificationChildWindow</code> ,        <code>Confirmation</code> ‚Äì <code>ConfirmationChildWindow</code> . <code>NotificationChildWindow</code>    ,   ,     <code>ConfirmationChildWindow</code>    <i>OK</i>  <i>Cancel</i> ,    .    ,   ,   <code>ChildWindow</code>  <code>PopupChildWindowAction</code> . <br>   ,  <code>InteractionRequestTrigger</code>  <code>PopupChildWindowAction</code> ,       <i>RI MVVM</i> . <br> <br> <code class="xml">&lt;i:Interaction.Triggers&gt; &lt;prism:InteractionRequestTrigger SourceObject=<span class="hljs-string"><span class="hljs-string">"{Binding ConfirmCancelInteractionRequest}"</span></span>&gt; &lt;prism:PopupChildWindowAction ContentTemplate=<span class="hljs-string"><span class="hljs-string">"{StaticResource ConfirmWindowTemplate}"</span></span>/&gt; &lt;/prism:InteractionRequestTrigger&gt; &lt;/i:Interaction.Triggers&gt; &lt;UserControl.Resources&gt; &lt;DataTemplate x:Key=<span class="hljs-string"><span class="hljs-string">"ConfirmWindowTemplate"</span></span>&gt; &lt;Grid MinWidth=<span class="hljs-string"><span class="hljs-string">"250"</span></span> MinHeight=<span class="hljs-string"><span class="hljs-string">"100"</span></span>&gt; &lt;TextBlock TextWrapping=<span class="hljs-string"><span class="hljs-string">"Wrap"</span></span> Grid.Row=<span class="hljs-string"><span class="hljs-string">"0"</span></span> Text=<span class="hljs-string"><span class="hljs-string">"{Binding}"</span></span>/&gt; &lt;/Grid&gt; &lt;/DataTemplate&gt; &lt;/UserControl.Resources&gt;</code> <br> <b></b> <br>      <code>ContentTemplate</code> ,   UI   <code>Content</code>  .    <code>Content</code>  ,  , <code>TextBlock</code>     <code>Content</code> . <br>      ,     ,    ,    .  ,     ,       ,     ,    .   ,   <i>RI MVVM</i> ,         <code>Confirmed</code>    <code>Confirmation</code>  <code><span class="hljs-keyword"><span class="hljs-keyword">true</span></span></code> ,     OK. <br> <br>        ,     .  Prism <code>InteractionRequestTrigger</code>   <code>PopupChildWindowAction</code>            . <br> <br>     <br>     MVVM,       , ,    ,         .        (  , ,  ,   ).    ,  ,  ,            . <br> <br>        ,         . Managed Extensibility Framework (MEF)  Unity Application Block (Unity)      ,  ,           . <br> <br>  ,       , , ,    ( )      . ,       ,     .  ,     ,       . <br> <br>     ,  MEF <br>  MEF,       ,   <code>Import</code> ,      ,  ,   <code><span class="hljs-keyword"><span class="hljs-keyword">Export</span></span></code> .         ,    . <br> <br> , <code>QuestionnaireView</code>   <i>RI MVVM</i> ,        ,    <code>Import</code> .   , MEF           .  <code><span class="hljs-keyword"><span class="hljs-keyword">set</span></span></code>        ,   . <br> <br> <code class="cs">[Import] public QuestionnaireViewModel ViewModel { <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> { this.DataContext = value; } }</code> <br>     ,   . <br> <br> <code class="cs">[<span class="hljs-keyword"><span class="hljs-keyword">Export</span></span>] public class QuestionnaireViewModel : NotificationObject { ... }</code> <br>        ,   . <br> <br> <code class="cs">public QuestionnaireView() { InitializeComponent(); } [ImportingConstructor] public QuestionnaireView(QuestionnaireViewModel viewModel) : this() { this.DataContext = viewModel; }</code> <br> <b></b> <br>          MEF,   Unity.   ,     ,        .   ,   Visual Studio  Expression Blend, ,        ,     .   ,   ,  ,      ,          <code>InitializeComponent</code> . <br>     ,  Unity <br>  Unity,    ,   MEF.     ,      .    ,         .  ,      . <br> <br>  ,      ,  ,         . ,           ,   . <br> <br> <code class="cs">public QuestionnaireView() { InitializeComponent(); } public QuestionnaireView(QuestionnaireViewModel viewModel) : this() { this.DataContext = viewModel; }</code> <br> <b></b> <br>    ,        ,   Visual Studio  Expression Blend. <br>  ,          ,   . Unity        <code><span class="hljs-keyword"><span class="hljs-keyword">set</span></span></code>   ,   . <br> <br> <code class="cs">public QuestionnaireView() { InitializeComponent(); } [Dependency] public QuestionnaireViewModel ViewModel { <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> { this.DataContext = value; } }</code> <br>       Unity. <br> <br> <code class="cs">container.RegisterType&lt;QuestionnaireViewModel&gt;();</code> <br>  ,     . <br> <br> <code class="cs">var view = container.Resolve&lt;QuestionnaireView&gt;();</code> <br>     ,    <br>   ,     ,        .        ,   MEF  Unity,        . <br> <br>          .   ,         UI,           . <br> <br> , <i>RI MVVM</i>   ,   ,        .   ,    .      <code>ShowView</code>   UI. <br> <br> <code class="cs">private void NavigateToQuestionnaireList() { //     <span class="hljs-string"><span class="hljs-string">"questionnaire list"</span></span>. this.uiService.ShowView(ViewNames.QuestionnaireTemplatesList); }</code> <br>  UI      UI .           UI.  <code>ShowView</code>  <code>UIService</code>      (,          ),       ,   . <br> <br> <code class="cs">public void ShowView(<span class="hljs-keyword"><span class="hljs-keyword">string</span></span> viewName) { var view = this.ViewFactory.GetView(viewName); this.MainWindow.CurrentView = view; }</code> <br> <b></b> <br> Prism       .   ,   ,   ,             .    ,  , <span class="hljs-string"><span class="hljs-string">" </span></span><a href="http://msdn.microsoft.com/en-us/library/gg430861(v%3DPandP.40).aspx"><span class="hljs-string"><span class="hljs-string">View-Based Navigation</span></span></a><span class="hljs-string"><span class="hljs-string"> "</span></span>   <span class="hljs-number"><span class="hljs-number">8</span></span>, <span class="hljs-string"><span class="hljs-string">" </span></span><a href="http://msdn.microsoft.com/en-us/library/gg430861(v%3DPandP.40).aspx"><span class="hljs-string"><span class="hljs-string">Navigation</span></span></a><span class="hljs-string"><span class="hljs-string"> "</span></span>. <br>  MVVM  <br>        MVVM      .           -      mocking . ,   ,        . <br> <br>   <i>INotifyPropertyChanged</i> <br>   <code>INotifyPropertyChanged</code>     ,      .      ,    ;   ,   ,     ,    ,       . <br> <br>   <br> ,       ,           <code>PropertyChanged</code>  ,         .  ,    <code>ChangeTracker</code> ,     MVVM,  ,      .      .     ,    . <br> <br> <code class="cs">var changeTracker = new PropertyChangeTracker(viewModel); viewModel.CurrentState = <span class="hljs-string"><span class="hljs-string">"newState"</span></span>; CollectionAssert.Contains(changeTracker.ChangedProperties, <span class="hljs-string"><span class="hljs-string">"CurrentState"</span></span>);</code> <br> ,     ,     <code>INotifyPropertyChanged</code> ,    ,   ,     . <br> <br>      <br>        ,   ,    <code><span class="hljs-keyword"><span class="hljs-keyword">set</span></span></code>      ,           . ,     ,     ,      ,          . <br> <br> <code class="cs">var changeTracker = new PropertyChangeTracker(viewModel); var question = viewModel.Questions.First() as OpenQuestionViewModel; question.Question.Response = <span class="hljs-string"><span class="hljs-string">"some text"</span></span>; CollectionAssert.Contains(changeTracker.ChangedProperties, <span class="hljs-string"><span class="hljs-string">"UnansweredQuestions"</span></span>);</code> <br>      <br>     <code>INotifyPropertyChanged</code> ,      <code>PropertyChanged</code>        ,  ,     , , .        ,       . <br> <br>   <i>INotifyDataErrorInfo</i> <br>   ,     ,    ,   ,   <code>IDataErrorInfo</code> ,  ( Silverlight)   <code>INotifyDataErrorInfo</code> .   <code>INotifyDataErrorInfo</code>   ,         ,    ,  ,   ,    . <br> <br>       <code>INotifyDataErrorInfo</code> : ,     ,  ,     ,     <code>ErrorsChanged</code> ,      <code>GetErrors</code> , . <br> <br>    <br>     ,      ,     .       ,         <code>GetErrors</code>       ,  ,  ,   .    , ,  ,     ,        .   ,        . <br> <br> <code class="cs">//  . var notifyErrorInfo = (INotifyDataErrorInfo)question; question.Response = -<span class="hljs-number"><span class="hljs-number">15</span></span>; Assert.IsTrue(notifyErrorInfo.GetErrors(<span class="hljs-string"><span class="hljs-string">"Response"</span></span>).Cast&lt;ValidationResult&gt;().Any()); //  . var notifyErrorInfo = (INotifyDataErrorInfo)question; question.Response = <span class="hljs-number"><span class="hljs-number">15</span></span>; Assert.IsFalse(notifyErrorInfo.GetErrors(<span class="hljs-string"><span class="hljs-string">"Response"</span></span>).Cast&lt;ValidationResult&gt;().Any());</code> <br>    ,    ,             . <br> <br>    <i>INotifyDataErrorInfo</i> <br>       <code>GetErrors</code> ,   <code>INotifyDataErrorInfo</code>  ,   <code>ErrorsChanged</code>      <code>GetErrors</code> . ,  <code>HasErrors</code>      ,  . <br> <br>       <code>INotifyDataErrorInfo</code> . , ,           ,   -  .      ,        <code>INotifyDataErrorInfo</code>         (,        ). <br> <br>     ,   ,  : <br>  <code>HasErrors</code>     .              ,       .  <code>ErrorsChanged</code> ,      ,         <code>GetErrors</code> .         ( ,  )     ,           .    <code>GetErrors</code>       <code>ErrorsChanged</code> . <br>    <code>INotifyPropertyChanged</code> ,  ,    <code>NotifyDataErrorInfoTestHelper</code>    MVVM,        <code>INotifyDataErrorInfo</code> ,       .   ,   ,      ,   .      . <br> <code class="cs">var helper = new NotifyDataErrorInfoTestHelper&lt;NumericQuestion, int?&gt;( question, q =&gt; q.Response); helper.ValidatePropertyChange( <span class="hljs-number"><span class="hljs-number">6</span></span>, NotifyDataErrorInfoBehavior.Nothing); helper.ValidatePropertyChange( <span class="hljs-number"><span class="hljs-number">20</span></span>, NotifyDataErrorInfoBehavior.FiresErrorsChanged | NotifyDataErrorInfoBehavior.HasErrors | NotifyDataErrorInfoBehavior.HasErrorsForProperty); helper.ValidatePropertyChange( null, NotifyDataErrorInfoBehavior.FiresErrorsChanged | NotifyDataErrorInfoBehavior.HasErrors | NotifyDataErrorInfoBehavior.HasErrorsForProperty); helper.ValidatePropertyChange( <span class="hljs-number"><span class="hljs-number">2</span></span>, NotifyDataErrorInfoBehavior.FiresErrorsChanged);</code> <br>     <br>   MVVM,     ,  .   ,    ,         . <br> <br>  ,     ,     ,       .   ,   , ,       ,     ,   <code>IAsyncResult</code>    ,  - ,   ,    UI. <br> <br>       , , ,    .   ,     .  ,      UI,     ,   ,          ,     ,        <span class="hljs-string"><span class="hljs-string">"   UI."</span></span> <br> <br>     ,    ,    .   ,    ,     mock-, ,   ,   ,      ,          . <br> <br>           UI,    ,    .   ,     ,   ,      .        ,   .     ,    ,     . <br> <br> <code class="cs">questionnaireRepositoryMock .Setup( r =&gt; r.SubmitQuestionnaireAsync( It.IsAny&lt;Questionnaire&gt;(), It.IsAny&lt;Action&lt;IOperationResult&gt;&gt;())) .Callback&lt;Questionnaire, Action&lt;IOperationResult&gt;&gt;( (q, a) =&gt; callback = a); uiServicemock .Setup(svc =&gt; svc.ShowView(ViewNames.QuestionnaireTemplatesList)) .Callback&lt;<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>&gt;(viewName =&gt; requestedViewName = viewName); submitResultMock .Setup(sr =&gt; sr.Error) .Returns&lt;Exception&gt;(null); CompleteQuestionnaire(viewModel); viewModel.Submit(); //      UI . callback(submitResultMock.Object); //    ‚Äì     . Assert.AreEqual(ViewNames.QuestionnaireTemplatesList, requestedViewName);</code> <br> <b></b> <br>          ,        . <br>   <br>       , . <span class="hljs-string"><span class="hljs-string">"Trees in WPF"</span></span>  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ms753391.aspx">http://msdn.microsoft.com/en-us/library/ms753391.aspx</a> <br> <br>       , . <span class="hljs-string"><span class="hljs-string">"Attached Properties Overview"</span></span>  MSDN: <a href="http://msdn.microsoft.com/en-us/library/cc265152(VS.95).aspx">http://msdn.microsoft.com/en-us/library/cc265152(VS.<span class="hljs-number"><span class="hljs-number">95</span></span>).aspx</a> <br> <br>      MEF, .<span class="hljs-string"><span class="hljs-string">"Managed Extensibility Framework Overview"</span></span>  MSDN: <a href="http://msdn.microsoft.com/en-us/library/dd460648.aspx">http://msdn.microsoft.com/en-us/library/dd460648.aspx</a> . <br> <br>      Unity, .<span class="hljs-string"><span class="hljs-string">"Unity Application Block"</span></span>  MSDN: <a href="http://www.msdn.com/unity">http://www.msdn.com/unity</a> . <br> <br>      <code>DelegateCommand</code> , .Chapter <span class="hljs-number"><span class="hljs-number">5</span></span>, <span class="hljs-string"><span class="hljs-string">" </span></span><a href="http://msdn.microsoft.com/en-us/library/gg405484(v%3DPandP.40).aspx"><span class="hljs-string"><span class="hljs-string">Implementing the MVVM Pattern</span></span></a><span class="hljs-string"><span class="hljs-string"> ."</span></span> <br> <br>        Microsoft Expression Blend, .<span class="hljs-string"><span class="hljs-string">"Working with built-in behaviors"</span></span>  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ff724013(v%3DExpression.40).aspx">http://msdn.microsoft.com/en-us/library/ff724013(v=Expression.<span class="hljs-number"><span class="hljs-number">40</span></span>).aspx</a> . <br> <br>          Microsoft Expression Blend, .<span class="hljs-string"><span class="hljs-string">"Creating Custom Behaviors"</span></span>  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ff724708(v%3DExpression.40).aspx">http://msdn.microsoft.com/en-us/library/ff724708(v=Expression.<span class="hljs-number"><span class="hljs-number">40</span></span>).aspx</a> . <br> <br>            Microsoft Expression Blend, .<span class="hljs-string"><span class="hljs-string">"Creating Custom Triggers and Actions"</span></span>  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ff724707(v%3DExpression.40).aspx">http://msdn.microsoft.com/en-us/library/ff724707(v=Expression.<span class="hljs-number"><span class="hljs-number">40</span></span>).aspx</a> . <br> <br>         WPF  Silverlight, .<span class="hljs-string"><span class="hljs-string">"Threading Model"</span></span>  <span class="hljs-string"><span class="hljs-string">"The Dispatcher Class"</span></span>  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ms741870.aspx">http://msdn.microsoft.com/en-us/library/ms741870.aspx</a> <br> <a href="http://msdn.microsoft.com/en-us/library/ms615907(v%3DVS.95).aspx">http://msdn.microsoft.com/en-us/library/ms615907(v=VS.<span class="hljs-number"><span class="hljs-number">95</span></span>).aspx</a> . <br> <br>      unit-  Silverlight, .<span class="hljs-string"><span class="hljs-string">"Unit Testing with Silverlight 2"</span></span>: <a href="http://www.jeff.wilcox.name/2008/03/silverlight2-unit-testing/">http://www.jeff.wilcox.name/<span class="hljs-number"><span class="hljs-number">2008</span></span>/<span class="hljs-number"><span class="hljs-number">03</span></span>/silverlight2-unit-testing/</a> . <br> <br>         , .  <span class="hljs-string"><span class="hljs-string">" </span></span><a href="http://msdn.microsoft.com/en-us/library/gg430861(v%3DPandP.40).aspx"><span class="hljs-string"><span class="hljs-string">View-Based Navigation</span></span></a><span class="hljs-string"><span class="hljs-string"> "</span></span> in Chapter <span class="hljs-number"><span class="hljs-number">8</span></span>, <span class="hljs-string"><span class="hljs-string">" </span></span><a href="http://msdn.microsoft.com/en-us/library/gg430861(v%3DPandP.40).aspx"><span class="hljs-string"><span class="hljs-string">Navigation</span></span></a><span class="hljs-string"><span class="hljs-string"> ."</span></span> <br> <br>       ,   , .<span class="hljs-string"><span class="hljs-string">"Event-based Asynchronous Pattern Overview"</span></span>  MSDN: <a href="http://msdn.microsoft.com/en-us/library/wewwczdw.aspx">http://msdn.microsoft.com/en-us/library/wewwczdw.aspx</a> <br> <br>        <code>IAsyncResult</code> , .<span class="hljs-string"><span class="hljs-string">"Asynchronous Programming Overview"</span></span>  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ms228963.aspx">http://msdn.microsoft.com/en-us/library/ms228963.aspx</a></code></code></code></code></code></code></code></code></code> </pre> <code><code><code><code>CommandBehaviorBase ,    ,    ICommand</code> .           <code>CanExecuteChanged</code> ,          Silverlight,    WPF. <br> <br>    ,  ,   <code>CommandBehaviorBase    ,    .         ,      .         ,    .      ButtonBaseClickCommandBehavior</code> . <br> <br> <code class="cs">public class ButtonBaseClickCommandBehavior : CommandBehaviorBase&lt;ButtonBase&gt; { public ButtonBaseClickCommandBehavior(ButtonBase clickableObject) : base(clickableObject) { clickableObject.Click += OnClick; } private void OnClick(object sender, System.Windows.RoutedEventArgs e) { ExecuteCommand(); } }</code> <br>   <code>CommandBehaviorBase ,     .     ,          ,   . ,    ,    ,      , ,    CanExecute</code>  ,     . <br> <br>          ,   .           XAML.           .       .  Prism      ,       ,  ,   .       ,    . , ,  ,      <code>Click</code> ,       <code>Command</code> .    <code>Click.Command</code> ,  . <br> <br>             .             . <br> <br> <code class="cs">public static readonly DependencyProperty CommandProperty = DependencyProperty.RegisterAttached( "Command", typeof(ICommand), typeof(Click), new PropertyMetadata(OnSetCommandCallback)); private static readonly DependencyProperty ClickCommandBehaviorProperty = DependencyProperty.RegisterAttached( "ClickCommandBehavior", typeof(ButtonBaseClickCommandBehavior), typeof(Click), null);</code> <br>    <code>Command</code>    <code>ButtonBaseClickCommandBehavior</code> ,     <code>OnSetCommandCallback</code> ,     . <br> <br> <code class="cs">private static void OnSetCommandCallback(DependencyObject dependencyObject, DependencyPropertyChangedEventArgs e) { ButtonBase buttonBase = dependencyObject as ButtonBase; if (buttonBase != null) { ButtonBaseClickCommandBehavior behavior = GetOrCreateBehavior(buttonBase); behavior.Command = e.NewValue as ICommand; } } private static void OnSetCommandParameterCallback(DependencyObject dependencyObject, DependencyPropertyChangedEventArgs e) { ButtonBase buttonBase = dependencyObject as ButtonBase; if (buttonBase != null) { ButtonBaseClickCommandBehavior behavior = GetOrCreateBehavior(buttonBase); behavior.CommandParameter = e.NewValue; } } private static ButtonBaseClickCommandBehavior GetOrCreateBehavior(ButtonBase buttonBase ) { ButtonBaseClickCommandBehavior behavior = buttonBase.GetValue(ClickCommandBehaviorProperty) as ButtonBaseClickCommandBehavior; if ( behavior == null ) { behavior = new ButtonBaseClickCommandBehavior(buttonBase); buttonBase.SetValue(ClickCommandBehaviorProperty, behavior); } return behavior; }</code> <br>        ,  <a href="http://msdn.microsoft.com/en-us/library/cc265152(VS.95).aspx">Attached Properties Overview</a>  MSDN. <br> <br>    <br>              . ,     Silverlight,    -,     ,      ,     .     ,       . <br> <br>        ,    ( )  ,  ,     .  UI       ,            UI. <br> <br>      - <br>   -     ,       <code>IAsyncResult</code> .   ,  ,   ,  <code>GetQuestionnaire</code> ,   : <code>BeginGetQuestionnaire</code>  <code>EndGetQuestionnaire</code> .    ,   <code>BeginGetQuestionnaire</code> .     ,   ,   <code>EndGetQuestionnaire</code>    . <br> <b></b> <br>  .NET Framework 4.5      <code>await</code>  <code>async</code>     <code>*Async</code> .      <a href="http://msdn.microsoft.com/en-us/library/vstudio/hh391443.aspx">"Asynchronous Programming with Async and Await (C# and Visual Basic)"</a> . <br>  ,    <code>EndGetQuestionnaire</code> ,      ,  ()      <code>BeginGetQuestionnaire</code> .     ,      ,   <code>EndGetQuestionnaire</code> ,   . <br> <br> <code class="xml">IAsyncResult asyncResult = this.service.BeginGetQuestionnaire( GetQuestionnaireCompleted, null //  ,      ); private void GetQuestionnaireCompleted(IAsyncResult result) { try { questionnaire = this.service.EndGetQuestionnaire(ar); } catch (Exception ex) { //  -   . } }</code> <br>  ,     <code>End*</code> (  , <code>EndGetQuestionnaire</code> ),    ,      .      , ,          UI.     ,   ,        . <br> <br>        UI,     -,      UI,         UI,   <code>Dispatcher</code>    <code>SynchronizationContext</code> .  WPF  Silverlight,   <code>Dispatcher</code> . <br> <br>      <code>Questionnaire</code>  ,        <code>QuestionnaireView</code> .  Silverlight    <code>CheckAccess</code> ,  ,      UI.  ,     <code>BeginInvoke</code> ,      UI. <br> <br> <code class="cs">var dispatcher = System.Windows.Deployment.Current.Dispatcher; if (dispatcher.CheckAccess()) { QuestionnaireView.DataContext = questionnaire; } else { dispatcher.BeginInvoke(() =&gt; { Questionnaire.DataContext = questionnaire; }); }</code> <br> <i>MVVM RI</i>   ,    ,   <code>IAsyncResult</code> ,   .      ,                 . ,       . <br> <br> <code class="cs">this.questionnaireRepository.GetQuestionnaireAsync( result =&gt; { this.Questionnaire = result.Result; });</code> <br>  <code>result</code>   ,     , , , .    ,     . <br> <br> <code class="cs">this.questionnaireRepository.GetQuestionnaireAsync( result =&gt; { if (result.Error == null) { this.Questionnaire = result.Result; ... } else { // Handle error. } })</code> <br>     <br>        ,      .     , ,             .        ,      ,     ,     . <br> <br>         ,      MVVM,     ,   . ,  -MVVM ,     <code>MessageBox</code>   code-behind UI,      .   MVVM     ,          . <br> <br>     MVVM,              ,          .      ,    ,   ,  ,     . <br> <br>              MVVM.      ,     ,     ,  ,     .    ,         ,     ,          .       . <br> <br>    <br>                  .        ,        .  ,         .         . <br> <br>  ,         ,         ,  .      ,     .           ,       . ,        WPF  Silverlight,        . <br> <br> <img title="Using the service to interact with the user." src="https://habrastorage.org/getpro/habr/post_images/4b5/397/f2d/4b5397f2d02e5851195b29f1893be6fc.png" alt=" ,    ."> <br> <br>  ,   <code>MessageBox</code>        ,     ,    ,     . <br> <br> <code class="cs">var result = interactionService.ShowMessageBox( "Are you sure you want to cancel this operation?", "Confirm", MessageBoxButton.OK); if (result == MessageBoxResult.Yes) { CancelRequest(); }</code> <br> ,      - ,      ,         Silverlight.         .             .     . <br> <br> <code class="cs">interactionService.ShowMessageBox( "Are you sure you want to cancel this operation?", "Confirm", MessageBoxButton.OK, result =&gt; { if (result == MessageBoxResult.Yes) { CancelRequest(); } });</code> <br>         ,      . ,  WPF    <code>MessageBox</code> ,       ;    Silverlight    ,    . <br> <br>     <br>         ‚Äì             .         ,      .     ,     .        ,        ,   ,     . <br> <br> <img title="Using interaction request objects." src="https://habrastorage.org/getpro/habr/post_images/3d0/ff0/1c5/3d0ff01c5518558c2d3c5c5f47ce0ce9.png" alt="   ."> <br> <br>    ,   ,          ‚Äì       ,      ,   ‚Äì     .   ,        ,    ,    UI            . <br> <br>       MVVM,     ,       ,         .         ,        ,    ,   . <br> <br>  Prism       <code>IInteractionRequest</code>   <code><code>InteractionRequest .  IInteractionRequest</code>  ,   .           ,   .  <code><code>InteractionRequest   IInteractionRequest</code>     <code>Raise</code> ,           , , ,   . <br> <br>       <br>  <code><code>InteractionRequest          .  Raise</code>          ( <code>T</code> )    ,    ,   .          ,       .      ,        .    ,  ,     . <br> <code class="cs">public interface IInteractionRequest { event EventHandler&lt;InteractionRequestedEventArgs&gt; Raised; } public class InteractionRequest&lt;T&gt; : IInteractionRequest { public event EventHandler&lt;InteractionRequestedEventArgs&gt; Raised; public void Raise(T context, Action&lt;T&gt; callback) { var handler = this.Raised; if (handler != null) { handler( this, new InteractionRequestedEventArgs(context, () =&gt; callback(context))); } } }</code> <br> Prism    ,      .  <code>Notification</code>       .    ,            .     ‚Äì <code>Title</code>  <code>Content</code> ,    .  ,   ,  ,  ,        . <br> <br>  <code>Confirmation</code>    <code>Notification</code>     ‚Äì <code>Confirmed</code> ,  ,  ,      .  <code>Confirmation</code> ,     <code>MessageBox</code> ,     /  .     ,     <code>Notification</code> ,     ,      . <br> <br>    <code><code><code>InteractionRequest ,       InteractionRequest      ,      .      ,    Raise</code> ,    , ,   . <br> <br> <code class="cs">public IInteractionRequest ConfirmCancelInteractionRequest { get { return this.confirmCancelInteractionRequest; } } this.confirmCancelInteractionRequest.Raise( new Confirmation("Are you sure you wish to cancel?"), confirmation =&gt; { if (confirmation.Confirmed) { this.NavigateToQuestionnaireList(); } }); }</code> <br> <i>MVVM Reference Implementation (MVVM RI)</i> ,    <code>IInteractionRequest</code>   <code><code>InteractionRequest ,          (. QuestionnaireViewModel.cs</code> ). <br> <br>        <br>       ,       .   ,       .    UI             . <br> <br>                . Microsoft Expression Blend Behaviors Framework     .  ,     ,    . <br> <br>  <code>EventTrigger</code> ,  Expression Blend,  ,      ,     ,   . , Prism   <code>EventTrigger</code> ,  <code>InteractionRequestTrigger</code> ,      <code>Raised</code>   <code>IInteractionRequest</code> .    XAML        . <br> <br>  ,   , <code>InteractionRequestTrigger</code>   .  Silverlight Prism   <code>PopupChildWindowAction</code> ,     .    ,         .   <code>ContentTemplate</code>  <code>PopupChildWindowAction</code> ,    ,    UI,      <code>Content</code>  .       <code>Title</code>  . <br> <b></b> <br>  ,    ,   <code>PopupChildWindowAction</code> ,     .    <code>Notification</code>  <code>NotificationChildWindow</code> ,        <code>Confirmation</code> ‚Äì <code>ConfirmationChildWindow</code> . <code>NotificationChildWindow</code>    ,   ,     <code>ConfirmationChildWindow</code>    <i>OK</i>  <i>Cancel</i> ,    .    ,   ,   <code>ChildWindow</code>  <code>PopupChildWindowAction</code> . <br>   ,  <code>InteractionRequestTrigger</code>  <code>PopupChildWindowAction</code> ,       <i>RI MVVM</i> . <br> <br> <code class="xml">&lt;i:Interaction.Triggers&gt; &lt;prism:InteractionRequestTrigger SourceObject="{Binding ConfirmCancelInteractionRequest}"&gt; &lt;prism:PopupChildWindowAction ContentTemplate="{StaticResource ConfirmWindowTemplate}"/&gt; &lt;/prism:InteractionRequestTrigger&gt; &lt;/i:Interaction.Triggers&gt; &lt;UserControl.Resources&gt; &lt;DataTemplate x:Key="ConfirmWindowTemplate"&gt; &lt;Grid MinWidth="250" MinHeight="100"&gt; &lt;TextBlock TextWrapping="Wrap" Grid.Row="0" Text="{Binding}"/&gt; &lt;/Grid&gt; &lt;/DataTemplate&gt; &lt;/UserControl.Resources&gt;</code> <br> <b></b> <br>      <code>ContentTemplate</code> ,   UI   <code>Content</code>  .    <code>Content</code>  ,  , <code>TextBlock</code>     <code>Content</code> . <br>      ,     ,    ,    .  ,     ,       ,     ,    .   ,   <i>RI MVVM</i> ,         <code>Confirmed</code>    <code>Confirmation</code>  <code>true</code> ,     OK. <br> <br>        ,     .  Prism <code>InteractionRequestTrigger</code>   <code>PopupChildWindowAction</code>            . <br> <br>     <br>     MVVM,       , ,    ,         .        (  , ,  ,   ).    ,  ,  ,            . <br> <br>        ,         . Managed Extensibility Framework (MEF)  Unity Application Block (Unity)      ,  ,           . <br> <br>  ,       , , ,    ( )      . ,       ,     .  ,     ,       . <br> <br>     ,  MEF <br>  MEF,       ,   <code>Import</code> ,      ,  ,   <code>Export</code> .         ,    . <br> <br> , <code>QuestionnaireView</code>   <i>RI MVVM</i> ,        ,    <code>Import</code> .   , MEF           .  <code>set</code>        ,   . <br> <br> <code class="cs">[Import] public QuestionnaireViewModel ViewModel { set { this.DataContext = value; } }</code> <br>     ,   . <br> <br> <code class="cs">[Export] public class QuestionnaireViewModel : NotificationObject { ... }</code> <br>        ,   . <br> <br> <code class="cs">public QuestionnaireView() { InitializeComponent(); } [ImportingConstructor] public QuestionnaireView(QuestionnaireViewModel viewModel) : this() { this.DataContext = viewModel; }</code> <br> <b></b> <br>          MEF,   Unity.   ,     ,        .   ,   Visual Studio  Expression Blend, ,        ,     .   ,   ,  ,      ,          <code>InitializeComponent</code> . <br>     ,  Unity <br>  Unity,    ,   MEF.     ,      .    ,         .  ,      . <br> <br>  ,      ,  ,         . ,           ,   . <br> <br> <code class="cs">public QuestionnaireView() { InitializeComponent(); } public QuestionnaireView(QuestionnaireViewModel viewModel) : this() { this.DataContext = viewModel; }</code> <br> <b></b> <br>    ,        ,   Visual Studio  Expression Blend. <br>  ,          ,   . Unity        <code>set</code>   ,   . <br> <br> <code class="cs">public QuestionnaireView() { InitializeComponent(); } [Dependency] public QuestionnaireViewModel ViewModel { set { this.DataContext = value; } }</code> <br>       Unity. <br> <br> <code class="cs">container.RegisterType&lt;QuestionnaireViewModel&gt;();</code> <br>  ,     . <br> <br> <code class="cs">var view = container.Resolve&lt;QuestionnaireView&gt;();</code> <br>     ,    <br>   ,     ,        .        ,   MEF  Unity,        . <br> <br>          .   ,         UI,           . <br> <br> , <i>RI MVVM</i>   ,   ,        .   ,    .      <code>ShowView</code>   UI. <br> <br> <code class="cs">private void NavigateToQuestionnaireList() { //     "questionnaire list". this.uiService.ShowView(ViewNames.QuestionnaireTemplatesList); }</code> <br>  UI      UI .           UI.  <code>ShowView</code>  <code>UIService</code>      (,          ),       ,   . <br> <br> <code class="cs">public void ShowView(string viewName) { var view = this.ViewFactory.GetView(viewName); this.MainWindow.CurrentView = view; }</code> <br> <b></b> <br> Prism       .   ,   ,   ,             .    ,  , " <a href="http://msdn.microsoft.com/en-us/library/gg430861(v%3DPandP.40).aspx">View-Based Navigation</a> "   8, " <a href="http://msdn.microsoft.com/en-us/library/gg430861(v%3DPandP.40).aspx">Navigation</a> ". <br>  MVVM  <br>        MVVM      .           -      mocking . ,   ,        . <br> <br>   <i>INotifyPropertyChanged</i> <br>   <code>INotifyPropertyChanged</code>     ,      .      ,    ;   ,   ,     ,    ,       . <br> <br>   <br> ,       ,           <code>PropertyChanged</code>  ,         .  ,    <code>ChangeTracker</code> ,     MVVM,  ,      .      .     ,    . <br> <br> <code class="cs">var changeTracker = new PropertyChangeTracker(viewModel); viewModel.CurrentState = "newState"; CollectionAssert.Contains(changeTracker.ChangedProperties, "CurrentState");</code> <br> ,     ,     <code>INotifyPropertyChanged</code> ,    ,   ,     . <br> <br>      <br>        ,   ,    <code>set</code>      ,           . ,     ,     ,      ,          . <br> <br> <code class="cs">var changeTracker = new PropertyChangeTracker(viewModel); var question = viewModel.Questions.First() as OpenQuestionViewModel; question.Question.Response = "some text"; CollectionAssert.Contains(changeTracker.ChangedProperties, "UnansweredQuestions");</code> <br>      <br>     <code>INotifyPropertyChanged</code> ,      <code>PropertyChanged</code>        ,  ,     , , .        ,       . <br> <br>   <i>INotifyDataErrorInfo</i> <br>   ,     ,    ,   ,   <code>IDataErrorInfo</code> ,  ( Silverlight)   <code>INotifyDataErrorInfo</code> .   <code>INotifyDataErrorInfo</code>   ,         ,    ,  ,   ,    . <br> <br>       <code>INotifyDataErrorInfo</code> : ,     ,  ,     ,     <code>ErrorsChanged</code> ,      <code>GetErrors</code> , . <br> <br>    <br>     ,      ,     .       ,         <code>GetErrors</code>       ,  ,  ,   .    , ,  ,     ,        .   ,        . <br> <br> <code class="cs">//  . var notifyErrorInfo = (INotifyDataErrorInfo)question; question.Response = -15; Assert.IsTrue(notifyErrorInfo.GetErrors("Response").Cast&lt;ValidationResult&gt;().Any()); //  . var notifyErrorInfo = (INotifyDataErrorInfo)question; question.Response = 15; Assert.IsFalse(notifyErrorInfo.GetErrors("Response").Cast&lt;ValidationResult&gt;().Any());</code> <br>    ,    ,             . <br> <br>    <i>INotifyDataErrorInfo</i> <br>       <code>GetErrors</code> ,   <code>INotifyDataErrorInfo</code>  ,   <code>ErrorsChanged</code>      <code>GetErrors</code> . ,  <code>HasErrors</code>      ,  . <br> <br>       <code>INotifyDataErrorInfo</code> . , ,           ,   -  .      ,        <code>INotifyDataErrorInfo</code>         (,        ). <br> <br>     ,   ,  : <br>  <code>HasErrors</code>     .              ,       .  <code>ErrorsChanged</code> ,      ,         <code>GetErrors</code> .         ( ,  )     ,           .    <code>GetErrors</code>       <code>ErrorsChanged</code> . <br>    <code>INotifyPropertyChanged</code> ,  ,    <code>NotifyDataErrorInfoTestHelper</code>    MVVM,        <code>INotifyDataErrorInfo</code> ,       .   ,   ,      ,   .      . <br> <code class="cs">var helper = new NotifyDataErrorInfoTestHelper&lt;NumericQuestion, int?&gt;( question, q =&gt; q.Response); helper.ValidatePropertyChange( 6, NotifyDataErrorInfoBehavior.Nothing); helper.ValidatePropertyChange( 20, NotifyDataErrorInfoBehavior.FiresErrorsChanged | NotifyDataErrorInfoBehavior.HasErrors | NotifyDataErrorInfoBehavior.HasErrorsForProperty); helper.ValidatePropertyChange( null, NotifyDataErrorInfoBehavior.FiresErrorsChanged | NotifyDataErrorInfoBehavior.HasErrors | NotifyDataErrorInfoBehavior.HasErrorsForProperty); helper.ValidatePropertyChange( 2, NotifyDataErrorInfoBehavior.FiresErrorsChanged);</code> <br>     <br>   MVVM,     ,  .   ,    ,         . <br> <br>  ,     ,     ,       .   ,   , ,       ,     ,   <code>IAsyncResult</code>    ,  - ,   ,    UI. <br> <br>       , , ,    .   ,     .  ,      UI,     ,   ,          ,     ,        "   UI." <br> <br>     ,    ,    .   ,    ,     mock-, ,   ,   ,      ,          . <br> <br>           UI,    ,    .   ,     ,   ,      .        ,   .     ,    ,     . <br> <br> <code class="cs">questionnaireRepositoryMock .Setup( r =&gt; r.SubmitQuestionnaireAsync( It.IsAny&lt;Questionnaire&gt;(), It.IsAny&lt;Action&lt;IOperationResult&gt;&gt;())) .Callback&lt;Questionnaire, Action&lt;IOperationResult&gt;&gt;( (q, a) =&gt; callback = a); uiServicemock .Setup(svc =&gt; svc.ShowView(ViewNames.QuestionnaireTemplatesList)) .Callback&lt;string&gt;(viewName =&gt; requestedViewName = viewName); submitResultMock .Setup(sr =&gt; sr.Error) .Returns&lt;Exception&gt;(null); CompleteQuestionnaire(viewModel); viewModel.Submit(); //      UI . callback(submitResultMock.Object); //    ‚Äì     . Assert.AreEqual(ViewNames.QuestionnaireTemplatesList, requestedViewName);</code> <br> <b></b> <br>          ,        . <br>   <br>       , . "Trees in WPF"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ms753391.aspx">http://msdn.microsoft.com/en-us/library/ms753391.aspx</a> <br> <br>       , . "Attached Properties Overview"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/cc265152(VS.95).aspx">http://msdn.microsoft.com/en-us/library/cc265152(VS.95).aspx</a> <br> <br>      MEF, ."Managed Extensibility Framework Overview"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/dd460648.aspx">http://msdn.microsoft.com/en-us/library/dd460648.aspx</a> . <br> <br>      Unity, ."Unity Application Block"  MSDN: <a href="http://www.msdn.com/unity">http://www.msdn.com/unity</a> . <br> <br>      <code>DelegateCommand</code> , .Chapter 5, " <a href="http://msdn.microsoft.com/en-us/library/gg405484(v%3DPandP.40).aspx">Implementing the MVVM Pattern</a> ." <br> <br>        Microsoft Expression Blend, ."Working with built-in behaviors"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ff724013(v%3DExpression.40).aspx">http://msdn.microsoft.com/en-us/library/ff724013(v=Expression.40).aspx</a> . <br> <br>          Microsoft Expression Blend, ."Creating Custom Behaviors"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ff724708(v%3DExpression.40).aspx">http://msdn.microsoft.com/en-us/library/ff724708(v=Expression.40).aspx</a> . <br> <br>            Microsoft Expression Blend, ."Creating Custom Triggers and Actions"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ff724707(v%3DExpression.40).aspx">http://msdn.microsoft.com/en-us/library/ff724707(v=Expression.40).aspx</a> . <br> <br>         WPF  Silverlight, ."Threading Model"  "The Dispatcher Class"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ms741870.aspx">http://msdn.microsoft.com/en-us/library/ms741870.aspx</a> <br> <a href="http://msdn.microsoft.com/en-us/library/ms615907(v%3DVS.95).aspx">http://msdn.microsoft.com/en-us/library/ms615907(v=VS.95).aspx</a> . <br> <br>      unit-  Silverlight, ."Unit Testing with Silverlight 2": <a href="http://www.jeff.wilcox.name/2008/03/silverlight2-unit-testing/">http://www.jeff.wilcox.name/2008/03/silverlight2-unit-testing/</a> . <br> <br>         , .  " <a href="http://msdn.microsoft.com/en-us/library/gg430861(v%3DPandP.40).aspx">View-Based Navigation</a> " in Chapter 8, " <a href="http://msdn.microsoft.com/en-us/library/gg430861(v%3DPandP.40).aspx">Navigation</a> ." <br> <br>       ,   , ."Event-based Asynchronous Pattern Overview"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/wewwczdw.aspx">http://msdn.microsoft.com/en-us/library/wewwczdw.aspx</a> <br> <br>        <code>IAsyncResult</code> , ."Asynchronous Programming Overview"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ms228963.aspx">http://msdn.microsoft.com/en-us/library/ms228963.aspx</a></code></code></code></code></code></code></code></code></code> <h3> <code><code><code><code>CommandBehaviorBase ,    ,    ICommand</code> .           <code>CanExecuteChanged</code> ,          Silverlight,    WPF. <br> <br>    ,  ,   <code>CommandBehaviorBase    ,    .         ,      .         ,    .      ButtonBaseClickCommandBehavior</code> . <br> <br> <code class="cs">public class ButtonBaseClickCommandBehavior : CommandBehaviorBase&lt;ButtonBase&gt; { public ButtonBaseClickCommandBehavior(ButtonBase clickableObject) : base(clickableObject) { clickableObject.Click += OnClick; } private void OnClick(object sender, System.Windows.RoutedEventArgs e) { ExecuteCommand(); } }</code> <br>   <code>CommandBehaviorBase ,     .     ,          ,   . ,    ,    ,      , ,    CanExecute</code>  ,     . <br> <br>          ,   .           XAML.           .       .  Prism      ,       ,  ,   .       ,    . , ,  ,      <code>Click</code> ,       <code>Command</code> .    <code>Click.Command</code> ,  . <br> <br>             .             . <br> <br> <code class="cs">public static readonly DependencyProperty CommandProperty = DependencyProperty.RegisterAttached( "Command", typeof(ICommand), typeof(Click), new PropertyMetadata(OnSetCommandCallback)); private static readonly DependencyProperty ClickCommandBehaviorProperty = DependencyProperty.RegisterAttached( "ClickCommandBehavior", typeof(ButtonBaseClickCommandBehavior), typeof(Click), null);</code> <br>    <code>Command</code>    <code>ButtonBaseClickCommandBehavior</code> ,     <code>OnSetCommandCallback</code> ,     . <br> <br> <code class="cs">private static void OnSetCommandCallback(DependencyObject dependencyObject, DependencyPropertyChangedEventArgs e) { ButtonBase buttonBase = dependencyObject as ButtonBase; if (buttonBase != null) { ButtonBaseClickCommandBehavior behavior = GetOrCreateBehavior(buttonBase); behavior.Command = e.NewValue as ICommand; } } private static void OnSetCommandParameterCallback(DependencyObject dependencyObject, DependencyPropertyChangedEventArgs e) { ButtonBase buttonBase = dependencyObject as ButtonBase; if (buttonBase != null) { ButtonBaseClickCommandBehavior behavior = GetOrCreateBehavior(buttonBase); behavior.CommandParameter = e.NewValue; } } private static ButtonBaseClickCommandBehavior GetOrCreateBehavior(ButtonBase buttonBase ) { ButtonBaseClickCommandBehavior behavior = buttonBase.GetValue(ClickCommandBehaviorProperty) as ButtonBaseClickCommandBehavior; if ( behavior == null ) { behavior = new ButtonBaseClickCommandBehavior(buttonBase); buttonBase.SetValue(ClickCommandBehaviorProperty, behavior); } return behavior; }</code> <br>        ,  <a href="http://msdn.microsoft.com/en-us/library/cc265152(VS.95).aspx">Attached Properties Overview</a>  MSDN. <br> <br>    <br>              . ,     Silverlight,    -,     ,      ,     .     ,       . <br> <br>        ,    ( )  ,  ,     .  UI       ,            UI. <br> <br>      - <br>   -     ,       <code>IAsyncResult</code> .   ,  ,   ,  <code>GetQuestionnaire</code> ,   : <code>BeginGetQuestionnaire</code>  <code>EndGetQuestionnaire</code> .    ,   <code>BeginGetQuestionnaire</code> .     ,   ,   <code>EndGetQuestionnaire</code>    . <br> <b></b> <br>  .NET Framework 4.5      <code>await</code>  <code>async</code>     <code>*Async</code> .      <a href="http://msdn.microsoft.com/en-us/library/vstudio/hh391443.aspx">"Asynchronous Programming with Async and Await (C# and Visual Basic)"</a> . <br>  ,    <code>EndGetQuestionnaire</code> ,      ,  ()      <code>BeginGetQuestionnaire</code> .     ,      ,   <code>EndGetQuestionnaire</code> ,   . <br> <br> <code class="xml">IAsyncResult asyncResult = this.service.BeginGetQuestionnaire( GetQuestionnaireCompleted, null //  ,      ); private void GetQuestionnaireCompleted(IAsyncResult result) { try { questionnaire = this.service.EndGetQuestionnaire(ar); } catch (Exception ex) { //  -   . } }</code> <br>  ,     <code>End*</code> (  , <code>EndGetQuestionnaire</code> ),    ,      .      , ,          UI.     ,   ,        . <br> <br>        UI,     -,      UI,         UI,   <code>Dispatcher</code>    <code>SynchronizationContext</code> .  WPF  Silverlight,   <code>Dispatcher</code> . <br> <br>      <code>Questionnaire</code>  ,        <code>QuestionnaireView</code> .  Silverlight    <code>CheckAccess</code> ,  ,      UI.  ,     <code>BeginInvoke</code> ,      UI. <br> <br> <code class="cs">var dispatcher = System.Windows.Deployment.Current.Dispatcher; if (dispatcher.CheckAccess()) { QuestionnaireView.DataContext = questionnaire; } else { dispatcher.BeginInvoke(() =&gt; { Questionnaire.DataContext = questionnaire; }); }</code> <br> <i>MVVM RI</i>   ,    ,   <code>IAsyncResult</code> ,   .      ,                 . ,       . <br> <br> <code class="cs">this.questionnaireRepository.GetQuestionnaireAsync( result =&gt; { this.Questionnaire = result.Result; });</code> <br>  <code>result</code>   ,     , , , .    ,     . <br> <br> <code class="cs">this.questionnaireRepository.GetQuestionnaireAsync( result =&gt; { if (result.Error == null) { this.Questionnaire = result.Result; ... } else { // Handle error. } })</code> <br>     <br>        ,      .     , ,             .        ,      ,     ,     . <br> <br>         ,      MVVM,     ,   . ,  -MVVM ,     <code>MessageBox</code>   code-behind UI,      .   MVVM     ,          . <br> <br>     MVVM,              ,          .      ,    ,   ,  ,     . <br> <br>              MVVM.      ,     ,     ,  ,     .    ,         ,     ,          .       . <br> <br>    <br>                  .        ,        .  ,         .         . <br> <br>  ,         ,         ,  .      ,     .           ,       . ,        WPF  Silverlight,        . <br> <br> <img title="Using the service to interact with the user." src="https://habrastorage.org/getpro/habr/post_images/4b5/397/f2d/4b5397f2d02e5851195b29f1893be6fc.png" alt=" ,    ."> <br> <br>  ,   <code>MessageBox</code>        ,     ,    ,     . <br> <br> <code class="cs">var result = interactionService.ShowMessageBox( "Are you sure you want to cancel this operation?", "Confirm", MessageBoxButton.OK); if (result == MessageBoxResult.Yes) { CancelRequest(); }</code> <br> ,      - ,      ,         Silverlight.         .             .     . <br> <br> <code class="cs">interactionService.ShowMessageBox( "Are you sure you want to cancel this operation?", "Confirm", MessageBoxButton.OK, result =&gt; { if (result == MessageBoxResult.Yes) { CancelRequest(); } });</code> <br>         ,      . ,  WPF    <code>MessageBox</code> ,       ;    Silverlight    ,    . <br> <br>     <br>         ‚Äì             .         ,      .     ,     .        ,        ,   ,     . <br> <br> <img title="Using interaction request objects." src="https://habrastorage.org/getpro/habr/post_images/3d0/ff0/1c5/3d0ff01c5518558c2d3c5c5f47ce0ce9.png" alt="   ."> <br> <br>    ,   ,          ‚Äì       ,      ,   ‚Äì     .   ,        ,    ,    UI            . <br> <br>       MVVM,     ,       ,         .         ,        ,    ,   . <br> <br>  Prism       <code>IInteractionRequest</code>   <code><code>InteractionRequest .  IInteractionRequest</code>  ,   .           ,   .  <code><code>InteractionRequest   IInteractionRequest</code>     <code>Raise</code> ,           , , ,   . <br> <br>       <br>  <code><code>InteractionRequest          .  Raise</code>          ( <code>T</code> )    ,    ,   .          ,       .      ,        .    ,  ,     . <br> <code class="cs">public interface IInteractionRequest { event EventHandler&lt;InteractionRequestedEventArgs&gt; Raised; } public class InteractionRequest&lt;T&gt; : IInteractionRequest { public event EventHandler&lt;InteractionRequestedEventArgs&gt; Raised; public void Raise(T context, Action&lt;T&gt; callback) { var handler = this.Raised; if (handler != null) { handler( this, new InteractionRequestedEventArgs(context, () =&gt; callback(context))); } } }</code> <br> Prism    ,      .  <code>Notification</code>       .    ,            .     ‚Äì <code>Title</code>  <code>Content</code> ,    .  ,   ,  ,  ,        . <br> <br>  <code>Confirmation</code>    <code>Notification</code>     ‚Äì <code>Confirmed</code> ,  ,  ,      .  <code>Confirmation</code> ,     <code>MessageBox</code> ,     /  .     ,     <code>Notification</code> ,     ,      . <br> <br>    <code><code><code>InteractionRequest ,       InteractionRequest      ,      .      ,    Raise</code> ,    , ,   . <br> <br> <code class="cs">public IInteractionRequest ConfirmCancelInteractionRequest { get { return this.confirmCancelInteractionRequest; } } this.confirmCancelInteractionRequest.Raise( new Confirmation("Are you sure you wish to cancel?"), confirmation =&gt; { if (confirmation.Confirmed) { this.NavigateToQuestionnaireList(); } }); }</code> <br> <i>MVVM Reference Implementation (MVVM RI)</i> ,    <code>IInteractionRequest</code>   <code><code>InteractionRequest ,          (. QuestionnaireViewModel.cs</code> ). <br> <br>        <br>       ,       .   ,       .    UI             . <br> <br>                . Microsoft Expression Blend Behaviors Framework     .  ,     ,    . <br> <br>  <code>EventTrigger</code> ,  Expression Blend,  ,      ,     ,   . , Prism   <code>EventTrigger</code> ,  <code>InteractionRequestTrigger</code> ,      <code>Raised</code>   <code>IInteractionRequest</code> .    XAML        . <br> <br>  ,   , <code>InteractionRequestTrigger</code>   .  Silverlight Prism   <code>PopupChildWindowAction</code> ,     .    ,         .   <code>ContentTemplate</code>  <code>PopupChildWindowAction</code> ,    ,    UI,      <code>Content</code>  .       <code>Title</code>  . <br> <b></b> <br>  ,    ,   <code>PopupChildWindowAction</code> ,     .    <code>Notification</code>  <code>NotificationChildWindow</code> ,        <code>Confirmation</code> ‚Äì <code>ConfirmationChildWindow</code> . <code>NotificationChildWindow</code>    ,   ,     <code>ConfirmationChildWindow</code>    <i>OK</i>  <i>Cancel</i> ,    .    ,   ,   <code>ChildWindow</code>  <code>PopupChildWindowAction</code> . <br>   ,  <code>InteractionRequestTrigger</code>  <code>PopupChildWindowAction</code> ,       <i>RI MVVM</i> . <br> <br> <code class="xml">&lt;i:Interaction.Triggers&gt; &lt;prism:InteractionRequestTrigger SourceObject="{Binding ConfirmCancelInteractionRequest}"&gt; &lt;prism:PopupChildWindowAction ContentTemplate="{StaticResource ConfirmWindowTemplate}"/&gt; &lt;/prism:InteractionRequestTrigger&gt; &lt;/i:Interaction.Triggers&gt; &lt;UserControl.Resources&gt; &lt;DataTemplate x:Key="ConfirmWindowTemplate"&gt; &lt;Grid MinWidth="250" MinHeight="100"&gt; &lt;TextBlock TextWrapping="Wrap" Grid.Row="0" Text="{Binding}"/&gt; &lt;/Grid&gt; &lt;/DataTemplate&gt; &lt;/UserControl.Resources&gt;</code> <br> <b></b> <br>      <code>ContentTemplate</code> ,   UI   <code>Content</code>  .    <code>Content</code>  ,  , <code>TextBlock</code>     <code>Content</code> . <br>      ,     ,    ,    .  ,     ,       ,     ,    .   ,   <i>RI MVVM</i> ,         <code>Confirmed</code>    <code>Confirmation</code>  <code>true</code> ,     OK. <br> <br>        ,     .  Prism <code>InteractionRequestTrigger</code>   <code>PopupChildWindowAction</code>            . <br> <br>     <br>     MVVM,       , ,    ,         .        (  , ,  ,   ).    ,  ,  ,            . <br> <br>        ,         . Managed Extensibility Framework (MEF)  Unity Application Block (Unity)      ,  ,           . <br> <br>  ,       , , ,    ( )      . ,       ,     .  ,     ,       . <br> <br>     ,  MEF <br>  MEF,       ,   <code>Import</code> ,      ,  ,   <code>Export</code> .         ,    . <br> <br> , <code>QuestionnaireView</code>   <i>RI MVVM</i> ,        ,    <code>Import</code> .   , MEF           .  <code>set</code>        ,   . <br> <br> <code class="cs">[Import] public QuestionnaireViewModel ViewModel { set { this.DataContext = value; } }</code> <br>     ,   . <br> <br> <code class="cs">[Export] public class QuestionnaireViewModel : NotificationObject { ... }</code> <br>        ,   . <br> <br> <code class="cs">public QuestionnaireView() { InitializeComponent(); } [ImportingConstructor] public QuestionnaireView(QuestionnaireViewModel viewModel) : this() { this.DataContext = viewModel; }</code> <br> <b></b> <br>          MEF,   Unity.   ,     ,        .   ,   Visual Studio  Expression Blend, ,        ,     .   ,   ,  ,      ,          <code>InitializeComponent</code> . <br>     ,  Unity <br>  Unity,    ,   MEF.     ,      .    ,         .  ,      . <br> <br>  ,      ,  ,         . ,           ,   . <br> <br> <code class="cs">public QuestionnaireView() { InitializeComponent(); } public QuestionnaireView(QuestionnaireViewModel viewModel) : this() { this.DataContext = viewModel; }</code> <br> <b></b> <br>    ,        ,   Visual Studio  Expression Blend. <br>  ,          ,   . Unity        <code>set</code>   ,   . <br> <br> <code class="cs">public QuestionnaireView() { InitializeComponent(); } [Dependency] public QuestionnaireViewModel ViewModel { set { this.DataContext = value; } }</code> <br>       Unity. <br> <br> <code class="cs">container.RegisterType&lt;QuestionnaireViewModel&gt;();</code> <br>  ,     . <br> <br> <code class="cs">var view = container.Resolve&lt;QuestionnaireView&gt;();</code> <br>     ,    <br>   ,     ,        .        ,   MEF  Unity,        . <br> <br>          .   ,         UI,           . <br> <br> , <i>RI MVVM</i>   ,   ,        .   ,    .      <code>ShowView</code>   UI. <br> <br> <code class="cs">private void NavigateToQuestionnaireList() { //     "questionnaire list". this.uiService.ShowView(ViewNames.QuestionnaireTemplatesList); }</code> <br>  UI      UI .           UI.  <code>ShowView</code>  <code>UIService</code>      (,          ),       ,   . <br> <br> <code class="cs">public void ShowView(string viewName) { var view = this.ViewFactory.GetView(viewName); this.MainWindow.CurrentView = view; }</code> <br> <b></b> <br> Prism       .   ,   ,   ,             .    ,  , " <a href="http://msdn.microsoft.com/en-us/library/gg430861(v%3DPandP.40).aspx">View-Based Navigation</a> "   8, " <a href="http://msdn.microsoft.com/en-us/library/gg430861(v%3DPandP.40).aspx">Navigation</a> ". <br>  MVVM  <br>        MVVM      .           -      mocking . ,   ,        . <br> <br>   <i>INotifyPropertyChanged</i> <br>   <code>INotifyPropertyChanged</code>     ,      .      ,    ;   ,   ,     ,    ,       . <br> <br>   <br> ,       ,           <code>PropertyChanged</code>  ,         .  ,    <code>ChangeTracker</code> ,     MVVM,  ,      .      .     ,    . <br> <br> <code class="cs">var changeTracker = new PropertyChangeTracker(viewModel); viewModel.CurrentState = "newState"; CollectionAssert.Contains(changeTracker.ChangedProperties, "CurrentState");</code> <br> ,     ,     <code>INotifyPropertyChanged</code> ,    ,   ,     . <br> <br>      <br>        ,   ,    <code>set</code>      ,           . ,     ,     ,      ,          . <br> <br> <code class="cs">var changeTracker = new PropertyChangeTracker(viewModel); var question = viewModel.Questions.First() as OpenQuestionViewModel; question.Question.Response = "some text"; CollectionAssert.Contains(changeTracker.ChangedProperties, "UnansweredQuestions");</code> <br>      <br>     <code>INotifyPropertyChanged</code> ,      <code>PropertyChanged</code>        ,  ,     , , .        ,       . <br> <br>   <i>INotifyDataErrorInfo</i> <br>   ,     ,    ,   ,   <code>IDataErrorInfo</code> ,  ( Silverlight)   <code>INotifyDataErrorInfo</code> .   <code>INotifyDataErrorInfo</code>   ,         ,    ,  ,   ,    . <br> <br>       <code>INotifyDataErrorInfo</code> : ,     ,  ,     ,     <code>ErrorsChanged</code> ,      <code>GetErrors</code> , . <br> <br>    <br>     ,      ,     .       ,         <code>GetErrors</code>       ,  ,  ,   .    , ,  ,     ,        .   ,        . <br> <br> <code class="cs">//  . var notifyErrorInfo = (INotifyDataErrorInfo)question; question.Response = -15; Assert.IsTrue(notifyErrorInfo.GetErrors("Response").Cast&lt;ValidationResult&gt;().Any()); //  . var notifyErrorInfo = (INotifyDataErrorInfo)question; question.Response = 15; Assert.IsFalse(notifyErrorInfo.GetErrors("Response").Cast&lt;ValidationResult&gt;().Any());</code> <br>    ,    ,             . <br> <br>    <i>INotifyDataErrorInfo</i> <br>       <code>GetErrors</code> ,   <code>INotifyDataErrorInfo</code>  ,   <code>ErrorsChanged</code>      <code>GetErrors</code> . ,  <code>HasErrors</code>      ,  . <br> <br>       <code>INotifyDataErrorInfo</code> . , ,           ,   -  .      ,        <code>INotifyDataErrorInfo</code>         (,        ). <br> <br>     ,   ,  : <br>  <code>HasErrors</code>     .              ,       .  <code>ErrorsChanged</code> ,      ,         <code>GetErrors</code> .         ( ,  )     ,           .    <code>GetErrors</code>       <code>ErrorsChanged</code> . <br>    <code>INotifyPropertyChanged</code> ,  ,    <code>NotifyDataErrorInfoTestHelper</code>    MVVM,        <code>INotifyDataErrorInfo</code> ,       .   ,   ,      ,   .      . <br> <code class="cs">var helper = new NotifyDataErrorInfoTestHelper&lt;NumericQuestion, int?&gt;( question, q =&gt; q.Response); helper.ValidatePropertyChange( 6, NotifyDataErrorInfoBehavior.Nothing); helper.ValidatePropertyChange( 20, NotifyDataErrorInfoBehavior.FiresErrorsChanged | NotifyDataErrorInfoBehavior.HasErrors | NotifyDataErrorInfoBehavior.HasErrorsForProperty); helper.ValidatePropertyChange( null, NotifyDataErrorInfoBehavior.FiresErrorsChanged | NotifyDataErrorInfoBehavior.HasErrors | NotifyDataErrorInfoBehavior.HasErrorsForProperty); helper.ValidatePropertyChange( 2, NotifyDataErrorInfoBehavior.FiresErrorsChanged);</code> <br>     <br>   MVVM,     ,  .   ,    ,         . <br> <br>  ,     ,     ,       .   ,   , ,       ,     ,   <code>IAsyncResult</code>    ,  - ,   ,    UI. <br> <br>       , , ,    .   ,     .  ,      UI,     ,   ,          ,     ,        "   UI." <br> <br>     ,    ,    .   ,    ,     mock-, ,   ,   ,      ,          . <br> <br>           UI,    ,    .   ,     ,   ,      .        ,   .     ,    ,     . <br> <br> <code class="cs">questionnaireRepositoryMock .Setup( r =&gt; r.SubmitQuestionnaireAsync( It.IsAny&lt;Questionnaire&gt;(), It.IsAny&lt;Action&lt;IOperationResult&gt;&gt;())) .Callback&lt;Questionnaire, Action&lt;IOperationResult&gt;&gt;( (q, a) =&gt; callback = a); uiServicemock .Setup(svc =&gt; svc.ShowView(ViewNames.QuestionnaireTemplatesList)) .Callback&lt;string&gt;(viewName =&gt; requestedViewName = viewName); submitResultMock .Setup(sr =&gt; sr.Error) .Returns&lt;Exception&gt;(null); CompleteQuestionnaire(viewModel); viewModel.Submit(); //      UI . callback(submitResultMock.Object); //    ‚Äì     . Assert.AreEqual(ViewNames.QuestionnaireTemplatesList, requestedViewName);</code> <br> <b></b> <br>          ,        . <br>   <br>       , . "Trees in WPF"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ms753391.aspx">http://msdn.microsoft.com/en-us/library/ms753391.aspx</a> <br> <br>       , . "Attached Properties Overview"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/cc265152(VS.95).aspx">http://msdn.microsoft.com/en-us/library/cc265152(VS.95).aspx</a> <br> <br>      MEF, ."Managed Extensibility Framework Overview"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/dd460648.aspx">http://msdn.microsoft.com/en-us/library/dd460648.aspx</a> . <br> <br>      Unity, ."Unity Application Block"  MSDN: <a href="http://www.msdn.com/unity">http://www.msdn.com/unity</a> . <br> <br>      <code>DelegateCommand</code> , .Chapter 5, " <a href="http://msdn.microsoft.com/en-us/library/gg405484(v%3DPandP.40).aspx">Implementing the MVVM Pattern</a> ." <br> <br>        Microsoft Expression Blend, ."Working with built-in behaviors"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ff724013(v%3DExpression.40).aspx">http://msdn.microsoft.com/en-us/library/ff724013(v=Expression.40).aspx</a> . <br> <br>          Microsoft Expression Blend, ."Creating Custom Behaviors"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ff724708(v%3DExpression.40).aspx">http://msdn.microsoft.com/en-us/library/ff724708(v=Expression.40).aspx</a> . <br> <br>            Microsoft Expression Blend, ."Creating Custom Triggers and Actions"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ff724707(v%3DExpression.40).aspx">http://msdn.microsoft.com/en-us/library/ff724707(v=Expression.40).aspx</a> . <br> <br>         WPF  Silverlight, ."Threading Model"  "The Dispatcher Class"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ms741870.aspx">http://msdn.microsoft.com/en-us/library/ms741870.aspx</a> <br> <a href="http://msdn.microsoft.com/en-us/library/ms615907(v%3DVS.95).aspx">http://msdn.microsoft.com/en-us/library/ms615907(v=VS.95).aspx</a> . <br> <br>      unit-  Silverlight, ."Unit Testing with Silverlight 2": <a href="http://www.jeff.wilcox.name/2008/03/silverlight2-unit-testing/">http://www.jeff.wilcox.name/2008/03/silverlight2-unit-testing/</a> . <br> <br>         , .  " <a href="http://msdn.microsoft.com/en-us/library/gg430861(v%3DPandP.40).aspx">View-Based Navigation</a> " in Chapter 8, " <a href="http://msdn.microsoft.com/en-us/library/gg430861(v%3DPandP.40).aspx">Navigation</a> ." <br> <br>       ,   , ."Event-based Asynchronous Pattern Overview"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/wewwczdw.aspx">http://msdn.microsoft.com/en-us/library/wewwczdw.aspx</a> <br> <br>        <code>IAsyncResult</code> , ."Asynchronous Programming Overview"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ms228963.aspx">http://msdn.microsoft.com/en-us/library/ms228963.aspx</a></code></code></code></code></code></code></code></code></code> </h3> <code><code><code><code>CommandBehaviorBase ,    ,    ICommand</code> .           <code>CanExecuteChanged</code> ,          Silverlight,    WPF. <br> <br>    ,  ,   <code>CommandBehaviorBase    ,    .         ,      .         ,    .      ButtonBaseClickCommandBehavior</code> . <br> <br> <code class="cs">public class ButtonBaseClickCommandBehavior : CommandBehaviorBase&lt;ButtonBase&gt; { public ButtonBaseClickCommandBehavior(ButtonBase clickableObject) : base(clickableObject) { clickableObject.Click += OnClick; } private void OnClick(object sender, System.Windows.RoutedEventArgs e) { ExecuteCommand(); } }</code> <br>   <code>CommandBehaviorBase ,     .     ,          ,   . ,    ,    ,      , ,    CanExecute</code>  ,     . <br> <br>          ,   .           XAML.           .       .  Prism      ,       ,  ,   .       ,    . , ,  ,      <code>Click</code> ,       <code>Command</code> .    <code>Click.Command</code> ,  . <br> <br>             .             . <br> <br> <code class="cs">public static readonly DependencyProperty CommandProperty = DependencyProperty.RegisterAttached( "Command", typeof(ICommand), typeof(Click), new PropertyMetadata(OnSetCommandCallback)); private static readonly DependencyProperty ClickCommandBehaviorProperty = DependencyProperty.RegisterAttached( "ClickCommandBehavior", typeof(ButtonBaseClickCommandBehavior), typeof(Click), null);</code> <br>    <code>Command</code>    <code>ButtonBaseClickCommandBehavior</code> ,     <code>OnSetCommandCallback</code> ,     . <br> <br> <code class="cs">private static void OnSetCommandCallback(DependencyObject dependencyObject, DependencyPropertyChangedEventArgs e) { ButtonBase buttonBase = dependencyObject as ButtonBase; if (buttonBase != null) { ButtonBaseClickCommandBehavior behavior = GetOrCreateBehavior(buttonBase); behavior.Command = e.NewValue as ICommand; } } private static void OnSetCommandParameterCallback(DependencyObject dependencyObject, DependencyPropertyChangedEventArgs e) { ButtonBase buttonBase = dependencyObject as ButtonBase; if (buttonBase != null) { ButtonBaseClickCommandBehavior behavior = GetOrCreateBehavior(buttonBase); behavior.CommandParameter = e.NewValue; } } private static ButtonBaseClickCommandBehavior GetOrCreateBehavior(ButtonBase buttonBase ) { ButtonBaseClickCommandBehavior behavior = buttonBase.GetValue(ClickCommandBehaviorProperty) as ButtonBaseClickCommandBehavior; if ( behavior == null ) { behavior = new ButtonBaseClickCommandBehavior(buttonBase); buttonBase.SetValue(ClickCommandBehaviorProperty, behavior); } return behavior; }</code> <br>        ,  <a href="http://msdn.microsoft.com/en-us/library/cc265152(VS.95).aspx">Attached Properties Overview</a>  MSDN. <br> <br>    <br>              . ,     Silverlight,    -,     ,      ,     .     ,       . <br> <br>        ,    ( )  ,  ,     .  UI       ,            UI. <br> <br>      - <br>   -     ,       <code>IAsyncResult</code> .   ,  ,   ,  <code>GetQuestionnaire</code> ,   : <code>BeginGetQuestionnaire</code>  <code>EndGetQuestionnaire</code> .    ,   <code>BeginGetQuestionnaire</code> .     ,   ,   <code>EndGetQuestionnaire</code>    . <br> <b></b> <br>  .NET Framework 4.5      <code>await</code>  <code>async</code>     <code>*Async</code> .      <a href="http://msdn.microsoft.com/en-us/library/vstudio/hh391443.aspx">"Asynchronous Programming with Async and Await (C# and Visual Basic)"</a> . <br>  ,    <code>EndGetQuestionnaire</code> ,      ,  ()      <code>BeginGetQuestionnaire</code> .     ,      ,   <code>EndGetQuestionnaire</code> ,   . <br> <br> <code class="xml">IAsyncResult asyncResult = this.service.BeginGetQuestionnaire( GetQuestionnaireCompleted, null //  ,      ); private void GetQuestionnaireCompleted(IAsyncResult result) { try { questionnaire = this.service.EndGetQuestionnaire(ar); } catch (Exception ex) { //  -   . } }</code> <br>  ,     <code>End*</code> (  , <code>EndGetQuestionnaire</code> ),    ,      .      , ,          UI.     ,   ,        . <br> <br>        UI,     -,      UI,         UI,   <code>Dispatcher</code>    <code>SynchronizationContext</code> .  WPF  Silverlight,   <code>Dispatcher</code> . <br> <br>      <code>Questionnaire</code>  ,        <code>QuestionnaireView</code> .  Silverlight    <code>CheckAccess</code> ,  ,      UI.  ,     <code>BeginInvoke</code> ,      UI. <br> <br> <code class="cs">var dispatcher = System.Windows.Deployment.Current.Dispatcher; if (dispatcher.CheckAccess()) { QuestionnaireView.DataContext = questionnaire; } else { dispatcher.BeginInvoke(() =&gt; { Questionnaire.DataContext = questionnaire; }); }</code> <br> <i>MVVM RI</i>   ,    ,   <code>IAsyncResult</code> ,   .      ,                 . ,       . <br> <br> <code class="cs">this.questionnaireRepository.GetQuestionnaireAsync( result =&gt; { this.Questionnaire = result.Result; });</code> <br>  <code>result</code>   ,     , , , .    ,     . <br> <br> <code class="cs">this.questionnaireRepository.GetQuestionnaireAsync( result =&gt; { if (result.Error == null) { this.Questionnaire = result.Result; ... } else { // Handle error. } })</code> <br>     <br>        ,      .     , ,             .        ,      ,     ,     . <br> <br>         ,      MVVM,     ,   . ,  -MVVM ,     <code>MessageBox</code>   code-behind UI,      .   MVVM     ,          . <br> <br>     MVVM,              ,          .      ,    ,   ,  ,     . <br> <br>              MVVM.      ,     ,     ,  ,     .    ,         ,     ,          .       . <br> <br>    <br>                  .        ,        .  ,         .         . <br> <br>  ,         ,         ,  .      ,     .           ,       . ,        WPF  Silverlight,        . <br> <br> <img title="Using the service to interact with the user." src="https://habrastorage.org/getpro/habr/post_images/4b5/397/f2d/4b5397f2d02e5851195b29f1893be6fc.png" alt=" ,    ."> <br> <br>  ,   <code>MessageBox</code>        ,     ,    ,     . <br> <br> <code class="cs">var result = interactionService.ShowMessageBox( "Are you sure you want to cancel this operation?", "Confirm", MessageBoxButton.OK); if (result == MessageBoxResult.Yes) { CancelRequest(); }</code> <br> ,      - ,      ,         Silverlight.         .             .     . <br> <br> <code class="cs">interactionService.ShowMessageBox( "Are you sure you want to cancel this operation?", "Confirm", MessageBoxButton.OK, result =&gt; { if (result == MessageBoxResult.Yes) { CancelRequest(); } });</code> <br>         ,      . ,  WPF    <code>MessageBox</code> ,       ;    Silverlight    ,    . <br> <br>     <br>         ‚Äì             .         ,      .     ,     .        ,        ,   ,     . <br> <br> <img title="Using interaction request objects." src="https://habrastorage.org/getpro/habr/post_images/3d0/ff0/1c5/3d0ff01c5518558c2d3c5c5f47ce0ce9.png" alt="   ."> <br> <br>    ,   ,          ‚Äì       ,      ,   ‚Äì     .   ,        ,    ,    UI            . <br> <br>       MVVM,     ,       ,         .         ,        ,    ,   . <br> <br>  Prism       <code>IInteractionRequest</code>   <code><code>InteractionRequest .  IInteractionRequest</code>  ,   .           ,   .  <code><code>InteractionRequest   IInteractionRequest</code>     <code>Raise</code> ,           , , ,   . <br> <br>       <br>  <code><code>InteractionRequest          .  Raise</code>          ( <code>T</code> )    ,    ,   .          ,       .      ,        .    ,  ,     . <br> <code class="cs">public interface IInteractionRequest { event EventHandler&lt;InteractionRequestedEventArgs&gt; Raised; } public class InteractionRequest&lt;T&gt; : IInteractionRequest { public event EventHandler&lt;InteractionRequestedEventArgs&gt; Raised; public void Raise(T context, Action&lt;T&gt; callback) { var handler = this.Raised; if (handler != null) { handler( this, new InteractionRequestedEventArgs(context, () =&gt; callback(context))); } } }</code> <br> Prism    ,      .  <code>Notification</code>       .    ,            .     ‚Äì <code>Title</code>  <code>Content</code> ,    .  ,   ,  ,  ,        . <br> <br>  <code>Confirmation</code>    <code>Notification</code>     ‚Äì <code>Confirmed</code> ,  ,  ,      .  <code>Confirmation</code> ,     <code>MessageBox</code> ,     /  .     ,     <code>Notification</code> ,     ,      . <br> <br>    <code><code><code>InteractionRequest ,       InteractionRequest      ,      .      ,    Raise</code> ,    , ,   . <br> <br> <code class="cs">public IInteractionRequest ConfirmCancelInteractionRequest { get { return this.confirmCancelInteractionRequest; } } this.confirmCancelInteractionRequest.Raise( new Confirmation("Are you sure you wish to cancel?"), confirmation =&gt; { if (confirmation.Confirmed) { this.NavigateToQuestionnaireList(); } }); }</code> <br> <i>MVVM Reference Implementation (MVVM RI)</i> ,    <code>IInteractionRequest</code>   <code><code>InteractionRequest ,          (. QuestionnaireViewModel.cs</code> ). <br> <br>        <br>       ,       .   ,       .    UI             . <br> <br>                . Microsoft Expression Blend Behaviors Framework     .  ,     ,    . <br> <br>  <code>EventTrigger</code> ,  Expression Blend,  ,      ,     ,   . , Prism   <code>EventTrigger</code> ,  <code>InteractionRequestTrigger</code> ,      <code>Raised</code>   <code>IInteractionRequest</code> .    XAML        . <br> <br>  ,   , <code>InteractionRequestTrigger</code>   .  Silverlight Prism   <code>PopupChildWindowAction</code> ,     .    ,         .   <code>ContentTemplate</code>  <code>PopupChildWindowAction</code> ,    ,    UI,      <code>Content</code>  .       <code>Title</code>  . <br> <b></b> <br>  ,    ,   <code>PopupChildWindowAction</code> ,     .    <code>Notification</code>  <code>NotificationChildWindow</code> ,        <code>Confirmation</code> ‚Äì <code>ConfirmationChildWindow</code> . <code>NotificationChildWindow</code>    ,   ,     <code>ConfirmationChildWindow</code>    <i>OK</i>  <i>Cancel</i> ,    .    ,   ,   <code>ChildWindow</code>  <code>PopupChildWindowAction</code> . <br>   ,  <code>InteractionRequestTrigger</code>  <code>PopupChildWindowAction</code> ,       <i>RI MVVM</i> . <br> <br> <code class="xml">&lt;i:Interaction.Triggers&gt; &lt;prism:InteractionRequestTrigger SourceObject="{Binding ConfirmCancelInteractionRequest}"&gt; &lt;prism:PopupChildWindowAction ContentTemplate="{StaticResource ConfirmWindowTemplate}"/&gt; &lt;/prism:InteractionRequestTrigger&gt; &lt;/i:Interaction.Triggers&gt; &lt;UserControl.Resources&gt; &lt;DataTemplate x:Key="ConfirmWindowTemplate"&gt; &lt;Grid MinWidth="250" MinHeight="100"&gt; &lt;TextBlock TextWrapping="Wrap" Grid.Row="0" Text="{Binding}"/&gt; &lt;/Grid&gt; &lt;/DataTemplate&gt; &lt;/UserControl.Resources&gt;</code> <br> <b></b> <br>      <code>ContentTemplate</code> ,   UI   <code>Content</code>  .    <code>Content</code>  ,  , <code>TextBlock</code>     <code>Content</code> . <br>      ,     ,    ,    .  ,     ,       ,     ,    .   ,   <i>RI MVVM</i> ,         <code>Confirmed</code>    <code>Confirmation</code>  <code>true</code> ,     OK. <br> <br>        ,     .  Prism <code>InteractionRequestTrigger</code>   <code>PopupChildWindowAction</code>            . <br> <br>     <br>     MVVM,       , ,    ,         .        (  , ,  ,   ).    ,  ,  ,            . <br> <br>        ,         . Managed Extensibility Framework (MEF)  Unity Application Block (Unity)      ,  ,           . <br> <br>  ,       , , ,    ( )      . ,       ,     .  ,     ,       . <br> <br>     ,  MEF <br>  MEF,       ,   <code>Import</code> ,      ,  ,   <code>Export</code> .         ,    . <br> <br> , <code>QuestionnaireView</code>   <i>RI MVVM</i> ,        ,    <code>Import</code> .   , MEF           .  <code>set</code>        ,   . <br> <br> <code class="cs">[Import] public QuestionnaireViewModel ViewModel { set { this.DataContext = value; } }</code> <br>     ,   . <br> <br> <code class="cs">[Export] public class QuestionnaireViewModel : NotificationObject { ... }</code> <br>        ,   . <br> <br> <code class="cs">public QuestionnaireView() { InitializeComponent(); } [ImportingConstructor] public QuestionnaireView(QuestionnaireViewModel viewModel) : this() { this.DataContext = viewModel; }</code> <br> <b></b> <br>          MEF,   Unity.   ,     ,        .   ,   Visual Studio  Expression Blend, ,        ,     .   ,   ,  ,      ,          <code>InitializeComponent</code> . <br>     ,  Unity <br>  Unity,    ,   MEF.     ,      .    ,         .  ,      . <br> <br>  ,      ,  ,         . ,           ,   . <br> <br> <code class="cs">public QuestionnaireView() { InitializeComponent(); } public QuestionnaireView(QuestionnaireViewModel viewModel) : this() { this.DataContext = viewModel; }</code> <br> <b></b> <br>    ,        ,   Visual Studio  Expression Blend. <br>  ,          ,   . Unity        <code>set</code>   ,   . <br> <br> <code class="cs">public QuestionnaireView() { InitializeComponent(); } [Dependency] public QuestionnaireViewModel ViewModel { set { this.DataContext = value; } }</code> <br>       Unity. <br> <br> <code class="cs">container.RegisterType&lt;QuestionnaireViewModel&gt;();</code> <br>  ,     . <br> <br> <code class="cs">var view = container.Resolve&lt;QuestionnaireView&gt;();</code> <br>     ,    <br>   ,     ,        .        ,   MEF  Unity,        . <br> <br>          .   ,         UI,           . <br> <br> , <i>RI MVVM</i>   ,   ,        .   ,    .      <code>ShowView</code>   UI. <br> <br> <code class="cs">private void NavigateToQuestionnaireList() { //     "questionnaire list". this.uiService.ShowView(ViewNames.QuestionnaireTemplatesList); }</code> <br>  UI      UI .           UI.  <code>ShowView</code>  <code>UIService</code>      (,          ),       ,   . <br> <br> <code class="cs">public void ShowView(string viewName) { var view = this.ViewFactory.GetView(viewName); this.MainWindow.CurrentView = view; }</code> <br> <b></b> <br> Prism       .   ,   ,   ,             .    ,  , " <a href="http://msdn.microsoft.com/en-us/library/gg430861(v%3DPandP.40).aspx">View-Based Navigation</a> "   8, " <a href="http://msdn.microsoft.com/en-us/library/gg430861(v%3DPandP.40).aspx">Navigation</a> ". <br>  MVVM  <br>        MVVM      .           -      mocking . ,   ,        . <br> <br>   <i>INotifyPropertyChanged</i> <br>   <code>INotifyPropertyChanged</code>     ,      .      ,    ;   ,   ,     ,    ,       . <br> <br>   <br> ,       ,           <code>PropertyChanged</code>  ,         .  ,    <code>ChangeTracker</code> ,     MVVM,  ,      .      .     ,    . <br> <br> <code class="cs">var changeTracker = new PropertyChangeTracker(viewModel); viewModel.CurrentState = "newState"; CollectionAssert.Contains(changeTracker.ChangedProperties, "CurrentState");</code> <br> ,     ,     <code>INotifyPropertyChanged</code> ,    ,   ,     . <br> <br>      <br>        ,   ,    <code>set</code>      ,           . ,     ,     ,      ,          . <br> <br> <code class="cs">var changeTracker = new PropertyChangeTracker(viewModel); var question = viewModel.Questions.First() as OpenQuestionViewModel; question.Question.Response = "some text"; CollectionAssert.Contains(changeTracker.ChangedProperties, "UnansweredQuestions");</code> <br>      <br>     <code>INotifyPropertyChanged</code> ,      <code>PropertyChanged</code>        ,  ,     , , .        ,       . <br> <br>   <i>INotifyDataErrorInfo</i> <br>   ,     ,    ,   ,   <code>IDataErrorInfo</code> ,  ( Silverlight)   <code>INotifyDataErrorInfo</code> .   <code>INotifyDataErrorInfo</code>   ,         ,    ,  ,   ,    . <br> <br>       <code>INotifyDataErrorInfo</code> : ,     ,  ,     ,     <code>ErrorsChanged</code> ,      <code>GetErrors</code> , . <br> <br>    <br>     ,      ,     .       ,         <code>GetErrors</code>       ,  ,  ,   .    , ,  ,     ,        .   ,        . <br> <br> <code class="cs">//  . var notifyErrorInfo = (INotifyDataErrorInfo)question; question.Response = -15; Assert.IsTrue(notifyErrorInfo.GetErrors("Response").Cast&lt;ValidationResult&gt;().Any()); //  . var notifyErrorInfo = (INotifyDataErrorInfo)question; question.Response = 15; Assert.IsFalse(notifyErrorInfo.GetErrors("Response").Cast&lt;ValidationResult&gt;().Any());</code> <br>    ,    ,             . <br> <br>    <i>INotifyDataErrorInfo</i> <br>       <code>GetErrors</code> ,   <code>INotifyDataErrorInfo</code>  ,   <code>ErrorsChanged</code>      <code>GetErrors</code> . ,  <code>HasErrors</code>      ,  . <br> <br>       <code>INotifyDataErrorInfo</code> . , ,           ,   -  .      ,        <code>INotifyDataErrorInfo</code>         (,        ). <br> <br>     ,   ,  : <br>  <code>HasErrors</code>     .              ,       .  <code>ErrorsChanged</code> ,      ,         <code>GetErrors</code> .         ( ,  )     ,           .    <code>GetErrors</code>       <code>ErrorsChanged</code> . <br>    <code>INotifyPropertyChanged</code> ,  ,    <code>NotifyDataErrorInfoTestHelper</code>    MVVM,        <code>INotifyDataErrorInfo</code> ,       .   ,   ,      ,   .      . <br> <code class="cs">var helper = new NotifyDataErrorInfoTestHelper&lt;NumericQuestion, int?&gt;( question, q =&gt; q.Response); helper.ValidatePropertyChange( 6, NotifyDataErrorInfoBehavior.Nothing); helper.ValidatePropertyChange( 20, NotifyDataErrorInfoBehavior.FiresErrorsChanged | NotifyDataErrorInfoBehavior.HasErrors | NotifyDataErrorInfoBehavior.HasErrorsForProperty); helper.ValidatePropertyChange( null, NotifyDataErrorInfoBehavior.FiresErrorsChanged | NotifyDataErrorInfoBehavior.HasErrors | NotifyDataErrorInfoBehavior.HasErrorsForProperty); helper.ValidatePropertyChange( 2, NotifyDataErrorInfoBehavior.FiresErrorsChanged);</code> <br>     <br>   MVVM,     ,  .   ,    ,         . <br> <br>  ,     ,     ,       .   ,   , ,       ,     ,   <code>IAsyncResult</code>    ,  - ,   ,    UI. <br> <br>       , , ,    .   ,     .  ,      UI,     ,   ,          ,     ,        "   UI." <br> <br>     ,    ,    .   ,    ,     mock-, ,   ,   ,      ,          . <br> <br>           UI,    ,    .   ,     ,   ,      .        ,   .     ,    ,     . <br> <br> <code class="cs">questionnaireRepositoryMock .Setup( r =&gt; r.SubmitQuestionnaireAsync( It.IsAny&lt;Questionnaire&gt;(), It.IsAny&lt;Action&lt;IOperationResult&gt;&gt;())) .Callback&lt;Questionnaire, Action&lt;IOperationResult&gt;&gt;( (q, a) =&gt; callback = a); uiServicemock .Setup(svc =&gt; svc.ShowView(ViewNames.QuestionnaireTemplatesList)) .Callback&lt;string&gt;(viewName =&gt; requestedViewName = viewName); submitResultMock .Setup(sr =&gt; sr.Error) .Returns&lt;Exception&gt;(null); CompleteQuestionnaire(viewModel); viewModel.Submit(); //      UI . callback(submitResultMock.Object); //    ‚Äì     . Assert.AreEqual(ViewNames.QuestionnaireTemplatesList, requestedViewName);</code> <br> <b></b> <br>          ,        . <br>   <br>       , . "Trees in WPF"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ms753391.aspx">http://msdn.microsoft.com/en-us/library/ms753391.aspx</a> <br> <br>       , . "Attached Properties Overview"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/cc265152(VS.95).aspx">http://msdn.microsoft.com/en-us/library/cc265152(VS.95).aspx</a> <br> <br>      MEF, ."Managed Extensibility Framework Overview"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/dd460648.aspx">http://msdn.microsoft.com/en-us/library/dd460648.aspx</a> . <br> <br>      Unity, ."Unity Application Block"  MSDN: <a href="http://www.msdn.com/unity">http://www.msdn.com/unity</a> . <br> <br>      <code>DelegateCommand</code> , .Chapter 5, " <a href="http://msdn.microsoft.com/en-us/library/gg405484(v%3DPandP.40).aspx">Implementing the MVVM Pattern</a> ." <br> <br>        Microsoft Expression Blend, ."Working with built-in behaviors"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ff724013(v%3DExpression.40).aspx">http://msdn.microsoft.com/en-us/library/ff724013(v=Expression.40).aspx</a> . <br> <br>          Microsoft Expression Blend, ."Creating Custom Behaviors"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ff724708(v%3DExpression.40).aspx">http://msdn.microsoft.com/en-us/library/ff724708(v=Expression.40).aspx</a> . <br> <br>            Microsoft Expression Blend, ."Creating Custom Triggers and Actions"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ff724707(v%3DExpression.40).aspx">http://msdn.microsoft.com/en-us/library/ff724707(v=Expression.40).aspx</a> . <br> <br>         WPF  Silverlight, ."Threading Model"  "The Dispatcher Class"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ms741870.aspx">http://msdn.microsoft.com/en-us/library/ms741870.aspx</a> <br> <a href="http://msdn.microsoft.com/en-us/library/ms615907(v%3DVS.95).aspx">http://msdn.microsoft.com/en-us/library/ms615907(v=VS.95).aspx</a> . <br> <br>      unit-  Silverlight, ."Unit Testing with Silverlight 2": <a href="http://www.jeff.wilcox.name/2008/03/silverlight2-unit-testing/">http://www.jeff.wilcox.name/2008/03/silverlight2-unit-testing/</a> . <br> <br>         , .  " <a href="http://msdn.microsoft.com/en-us/library/gg430861(v%3DPandP.40).aspx">View-Based Navigation</a> " in Chapter 8, " <a href="http://msdn.microsoft.com/en-us/library/gg430861(v%3DPandP.40).aspx">Navigation</a> ." <br> <br>       ,   , ."Event-based Asynchronous Pattern Overview"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/wewwczdw.aspx">http://msdn.microsoft.com/en-us/library/wewwczdw.aspx</a> <br> <br>        <code>IAsyncResult</code> , ."Asynchronous Programming Overview"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ms228963.aspx">http://msdn.microsoft.com/en-us/library/ms228963.aspx</a></code></code></code></code></code></code></code></code></code> <h4> <code><code><code><code>CommandBehaviorBase ,    ,    ICommand</code> .           <code>CanExecuteChanged</code> ,          Silverlight,    WPF. <br> <br>    ,  ,   <code>CommandBehaviorBase    ,    .         ,      .         ,    .      ButtonBaseClickCommandBehavior</code> . <br> <br> <code class="cs">public class ButtonBaseClickCommandBehavior : CommandBehaviorBase&lt;ButtonBase&gt; { public ButtonBaseClickCommandBehavior(ButtonBase clickableObject) : base(clickableObject) { clickableObject.Click += OnClick; } private void OnClick(object sender, System.Windows.RoutedEventArgs e) { ExecuteCommand(); } }</code> <br>   <code>CommandBehaviorBase ,     .     ,          ,   . ,    ,    ,      , ,    CanExecute</code>  ,     . <br> <br>          ,   .           XAML.           .       .  Prism      ,       ,  ,   .       ,    . , ,  ,      <code>Click</code> ,       <code>Command</code> .    <code>Click.Command</code> ,  . <br> <br>             .             . <br> <br> <code class="cs">public static readonly DependencyProperty CommandProperty = DependencyProperty.RegisterAttached( "Command", typeof(ICommand), typeof(Click), new PropertyMetadata(OnSetCommandCallback)); private static readonly DependencyProperty ClickCommandBehaviorProperty = DependencyProperty.RegisterAttached( "ClickCommandBehavior", typeof(ButtonBaseClickCommandBehavior), typeof(Click), null);</code> <br>    <code>Command</code>    <code>ButtonBaseClickCommandBehavior</code> ,     <code>OnSetCommandCallback</code> ,     . <br> <br> <code class="cs">private static void OnSetCommandCallback(DependencyObject dependencyObject, DependencyPropertyChangedEventArgs e) { ButtonBase buttonBase = dependencyObject as ButtonBase; if (buttonBase != null) { ButtonBaseClickCommandBehavior behavior = GetOrCreateBehavior(buttonBase); behavior.Command = e.NewValue as ICommand; } } private static void OnSetCommandParameterCallback(DependencyObject dependencyObject, DependencyPropertyChangedEventArgs e) { ButtonBase buttonBase = dependencyObject as ButtonBase; if (buttonBase != null) { ButtonBaseClickCommandBehavior behavior = GetOrCreateBehavior(buttonBase); behavior.CommandParameter = e.NewValue; } } private static ButtonBaseClickCommandBehavior GetOrCreateBehavior(ButtonBase buttonBase ) { ButtonBaseClickCommandBehavior behavior = buttonBase.GetValue(ClickCommandBehaviorProperty) as ButtonBaseClickCommandBehavior; if ( behavior == null ) { behavior = new ButtonBaseClickCommandBehavior(buttonBase); buttonBase.SetValue(ClickCommandBehaviorProperty, behavior); } return behavior; }</code> <br>        ,  <a href="http://msdn.microsoft.com/en-us/library/cc265152(VS.95).aspx">Attached Properties Overview</a>  MSDN. <br> <br>    <br>              . ,     Silverlight,    -,     ,      ,     .     ,       . <br> <br>        ,    ( )  ,  ,     .  UI       ,            UI. <br> <br>      - <br>   -     ,       <code>IAsyncResult</code> .   ,  ,   ,  <code>GetQuestionnaire</code> ,   : <code>BeginGetQuestionnaire</code>  <code>EndGetQuestionnaire</code> .    ,   <code>BeginGetQuestionnaire</code> .     ,   ,   <code>EndGetQuestionnaire</code>    . <br> <b></b> <br>  .NET Framework 4.5      <code>await</code>  <code>async</code>     <code>*Async</code> .      <a href="http://msdn.microsoft.com/en-us/library/vstudio/hh391443.aspx">"Asynchronous Programming with Async and Await (C# and Visual Basic)"</a> . <br>  ,    <code>EndGetQuestionnaire</code> ,      ,  ()      <code>BeginGetQuestionnaire</code> .     ,      ,   <code>EndGetQuestionnaire</code> ,   . <br> <br> <code class="xml">IAsyncResult asyncResult = this.service.BeginGetQuestionnaire( GetQuestionnaireCompleted, null //  ,      ); private void GetQuestionnaireCompleted(IAsyncResult result) { try { questionnaire = this.service.EndGetQuestionnaire(ar); } catch (Exception ex) { //  -   . } }</code> <br>  ,     <code>End*</code> (  , <code>EndGetQuestionnaire</code> ),    ,      .      , ,          UI.     ,   ,        . <br> <br>        UI,     -,      UI,         UI,   <code>Dispatcher</code>    <code>SynchronizationContext</code> .  WPF  Silverlight,   <code>Dispatcher</code> . <br> <br>      <code>Questionnaire</code>  ,        <code>QuestionnaireView</code> .  Silverlight    <code>CheckAccess</code> ,  ,      UI.  ,     <code>BeginInvoke</code> ,      UI. <br> <br> <code class="cs">var dispatcher = System.Windows.Deployment.Current.Dispatcher; if (dispatcher.CheckAccess()) { QuestionnaireView.DataContext = questionnaire; } else { dispatcher.BeginInvoke(() =&gt; { Questionnaire.DataContext = questionnaire; }); }</code> <br> <i>MVVM RI</i>   ,    ,   <code>IAsyncResult</code> ,   .      ,                 . ,       . <br> <br> <code class="cs">this.questionnaireRepository.GetQuestionnaireAsync( result =&gt; { this.Questionnaire = result.Result; });</code> <br>  <code>result</code>   ,     , , , .    ,     . <br> <br> <code class="cs">this.questionnaireRepository.GetQuestionnaireAsync( result =&gt; { if (result.Error == null) { this.Questionnaire = result.Result; ... } else { // Handle error. } })</code> <br>     <br>        ,      .     , ,             .        ,      ,     ,     . <br> <br>         ,      MVVM,     ,   . ,  -MVVM ,     <code>MessageBox</code>   code-behind UI,      .   MVVM     ,          . <br> <br>     MVVM,              ,          .      ,    ,   ,  ,     . <br> <br>              MVVM.      ,     ,     ,  ,     .    ,         ,     ,          .       . <br> <br>    <br>                  .        ,        .  ,         .         . <br> <br>  ,         ,         ,  .      ,     .           ,       . ,        WPF  Silverlight,        . <br> <br> <img title="Using the service to interact with the user." src="https://habrastorage.org/getpro/habr/post_images/4b5/397/f2d/4b5397f2d02e5851195b29f1893be6fc.png" alt=" ,    ."> <br> <br>  ,   <code>MessageBox</code>        ,     ,    ,     . <br> <br> <code class="cs">var result = interactionService.ShowMessageBox( "Are you sure you want to cancel this operation?", "Confirm", MessageBoxButton.OK); if (result == MessageBoxResult.Yes) { CancelRequest(); }</code> <br> ,      - ,      ,         Silverlight.         .             .     . <br> <br> <code class="cs">interactionService.ShowMessageBox( "Are you sure you want to cancel this operation?", "Confirm", MessageBoxButton.OK, result =&gt; { if (result == MessageBoxResult.Yes) { CancelRequest(); } });</code> <br>         ,      . ,  WPF    <code>MessageBox</code> ,       ;    Silverlight    ,    . <br> <br>     <br>         ‚Äì             .         ,      .     ,     .        ,        ,   ,     . <br> <br> <img title="Using interaction request objects." src="https://habrastorage.org/getpro/habr/post_images/3d0/ff0/1c5/3d0ff01c5518558c2d3c5c5f47ce0ce9.png" alt="   ."> <br> <br>    ,   ,          ‚Äì       ,      ,   ‚Äì     .   ,        ,    ,    UI            . <br> <br>       MVVM,     ,       ,         .         ,        ,    ,   . <br> <br>  Prism       <code>IInteractionRequest</code>   <code><code>InteractionRequest .  IInteractionRequest</code>  ,   .           ,   .  <code><code>InteractionRequest   IInteractionRequest</code>     <code>Raise</code> ,           , , ,   . <br> <br>       <br>  <code><code>InteractionRequest          .  Raise</code>          ( <code>T</code> )    ,    ,   .          ,       .      ,        .    ,  ,     . <br> <code class="cs">public interface IInteractionRequest { event EventHandler&lt;InteractionRequestedEventArgs&gt; Raised; } public class InteractionRequest&lt;T&gt; : IInteractionRequest { public event EventHandler&lt;InteractionRequestedEventArgs&gt; Raised; public void Raise(T context, Action&lt;T&gt; callback) { var handler = this.Raised; if (handler != null) { handler( this, new InteractionRequestedEventArgs(context, () =&gt; callback(context))); } } }</code> <br> Prism    ,      .  <code>Notification</code>       .    ,            .     ‚Äì <code>Title</code>  <code>Content</code> ,    .  ,   ,  ,  ,        . <br> <br>  <code>Confirmation</code>    <code>Notification</code>     ‚Äì <code>Confirmed</code> ,  ,  ,      .  <code>Confirmation</code> ,     <code>MessageBox</code> ,     /  .     ,     <code>Notification</code> ,     ,      . <br> <br>    <code><code><code>InteractionRequest ,       InteractionRequest      ,      .      ,    Raise</code> ,    , ,   . <br> <br> <code class="cs">public IInteractionRequest ConfirmCancelInteractionRequest { get { return this.confirmCancelInteractionRequest; } } this.confirmCancelInteractionRequest.Raise( new Confirmation("Are you sure you wish to cancel?"), confirmation =&gt; { if (confirmation.Confirmed) { this.NavigateToQuestionnaireList(); } }); }</code> <br> <i>MVVM Reference Implementation (MVVM RI)</i> ,    <code>IInteractionRequest</code>   <code><code>InteractionRequest ,          (. QuestionnaireViewModel.cs</code> ). <br> <br>        <br>       ,       .   ,       .    UI             . <br> <br>                . Microsoft Expression Blend Behaviors Framework     .  ,     ,    . <br> <br>  <code>EventTrigger</code> ,  Expression Blend,  ,      ,     ,   . , Prism   <code>EventTrigger</code> ,  <code>InteractionRequestTrigger</code> ,      <code>Raised</code>   <code>IInteractionRequest</code> .    XAML        . <br> <br>  ,   , <code>InteractionRequestTrigger</code>   .  Silverlight Prism   <code>PopupChildWindowAction</code> ,     .    ,         .   <code>ContentTemplate</code>  <code>PopupChildWindowAction</code> ,    ,    UI,      <code>Content</code>  .       <code>Title</code>  . <br> <b></b> <br>  ,    ,   <code>PopupChildWindowAction</code> ,     .    <code>Notification</code>  <code>NotificationChildWindow</code> ,        <code>Confirmation</code> ‚Äì <code>ConfirmationChildWindow</code> . <code>NotificationChildWindow</code>    ,   ,     <code>ConfirmationChildWindow</code>    <i>OK</i>  <i>Cancel</i> ,    .    ,   ,   <code>ChildWindow</code>  <code>PopupChildWindowAction</code> . <br>   ,  <code>InteractionRequestTrigger</code>  <code>PopupChildWindowAction</code> ,       <i>RI MVVM</i> . <br> <br> <code class="xml">&lt;i:Interaction.Triggers&gt; &lt;prism:InteractionRequestTrigger SourceObject="{Binding ConfirmCancelInteractionRequest}"&gt; &lt;prism:PopupChildWindowAction ContentTemplate="{StaticResource ConfirmWindowTemplate}"/&gt; &lt;/prism:InteractionRequestTrigger&gt; &lt;/i:Interaction.Triggers&gt; &lt;UserControl.Resources&gt; &lt;DataTemplate x:Key="ConfirmWindowTemplate"&gt; &lt;Grid MinWidth="250" MinHeight="100"&gt; &lt;TextBlock TextWrapping="Wrap" Grid.Row="0" Text="{Binding}"/&gt; &lt;/Grid&gt; &lt;/DataTemplate&gt; &lt;/UserControl.Resources&gt;</code> <br> <b></b> <br>      <code>ContentTemplate</code> ,   UI   <code>Content</code>  .    <code>Content</code>  ,  , <code>TextBlock</code>     <code>Content</code> . <br>      ,     ,    ,    .  ,     ,       ,     ,    .   ,   <i>RI MVVM</i> ,         <code>Confirmed</code>    <code>Confirmation</code>  <code>true</code> ,     OK. <br> <br>        ,     .  Prism <code>InteractionRequestTrigger</code>   <code>PopupChildWindowAction</code>            . <br> <br>     <br>     MVVM,       , ,    ,         .        (  , ,  ,   ).    ,  ,  ,            . <br> <br>        ,         . Managed Extensibility Framework (MEF)  Unity Application Block (Unity)      ,  ,           . <br> <br>  ,       , , ,    ( )      . ,       ,     .  ,     ,       . <br> <br>     ,  MEF <br>  MEF,       ,   <code>Import</code> ,      ,  ,   <code>Export</code> .         ,    . <br> <br> , <code>QuestionnaireView</code>   <i>RI MVVM</i> ,        ,    <code>Import</code> .   , MEF           .  <code>set</code>        ,   . <br> <br> <code class="cs">[Import] public QuestionnaireViewModel ViewModel { set { this.DataContext = value; } }</code> <br>     ,   . <br> <br> <code class="cs">[Export] public class QuestionnaireViewModel : NotificationObject { ... }</code> <br>        ,   . <br> <br> <code class="cs">public QuestionnaireView() { InitializeComponent(); } [ImportingConstructor] public QuestionnaireView(QuestionnaireViewModel viewModel) : this() { this.DataContext = viewModel; }</code> <br> <b></b> <br>          MEF,   Unity.   ,     ,        .   ,   Visual Studio  Expression Blend, ,        ,     .   ,   ,  ,      ,          <code>InitializeComponent</code> . <br>     ,  Unity <br>  Unity,    ,   MEF.     ,      .    ,         .  ,      . <br> <br>  ,      ,  ,         . ,           ,   . <br> <br> <code class="cs">public QuestionnaireView() { InitializeComponent(); } public QuestionnaireView(QuestionnaireViewModel viewModel) : this() { this.DataContext = viewModel; }</code> <br> <b></b> <br>    ,        ,   Visual Studio  Expression Blend. <br>  ,          ,   . Unity        <code>set</code>   ,   . <br> <br> <code class="cs">public QuestionnaireView() { InitializeComponent(); } [Dependency] public QuestionnaireViewModel ViewModel { set { this.DataContext = value; } }</code> <br>       Unity. <br> <br> <code class="cs">container.RegisterType&lt;QuestionnaireViewModel&gt;();</code> <br>  ,     . <br> <br> <code class="cs">var view = container.Resolve&lt;QuestionnaireView&gt;();</code> <br>     ,    <br>   ,     ,        .        ,   MEF  Unity,        . <br> <br>          .   ,         UI,           . <br> <br> , <i>RI MVVM</i>   ,   ,        .   ,    .      <code>ShowView</code>   UI. <br> <br> <code class="cs">private void NavigateToQuestionnaireList() { //     "questionnaire list". this.uiService.ShowView(ViewNames.QuestionnaireTemplatesList); }</code> <br>  UI      UI .           UI.  <code>ShowView</code>  <code>UIService</code>      (,          ),       ,   . <br> <br> <code class="cs">public void ShowView(string viewName) { var view = this.ViewFactory.GetView(viewName); this.MainWindow.CurrentView = view; }</code> <br> <b></b> <br> Prism       .   ,   ,   ,             .    ,  , " <a href="http://msdn.microsoft.com/en-us/library/gg430861(v%3DPandP.40).aspx">View-Based Navigation</a> "   8, " <a href="http://msdn.microsoft.com/en-us/library/gg430861(v%3DPandP.40).aspx">Navigation</a> ". <br>  MVVM  <br>        MVVM      .           -      mocking . ,   ,        . <br> <br>   <i>INotifyPropertyChanged</i> <br>   <code>INotifyPropertyChanged</code>     ,      .      ,    ;   ,   ,     ,    ,       . <br> <br>   <br> ,       ,           <code>PropertyChanged</code>  ,         .  ,    <code>ChangeTracker</code> ,     MVVM,  ,      .      .     ,    . <br> <br> <code class="cs">var changeTracker = new PropertyChangeTracker(viewModel); viewModel.CurrentState = "newState"; CollectionAssert.Contains(changeTracker.ChangedProperties, "CurrentState");</code> <br> ,     ,     <code>INotifyPropertyChanged</code> ,    ,   ,     . <br> <br>      <br>        ,   ,    <code>set</code>      ,           . ,     ,     ,      ,          . <br> <br> <code class="cs">var changeTracker = new PropertyChangeTracker(viewModel); var question = viewModel.Questions.First() as OpenQuestionViewModel; question.Question.Response = "some text"; CollectionAssert.Contains(changeTracker.ChangedProperties, "UnansweredQuestions");</code> <br>      <br>     <code>INotifyPropertyChanged</code> ,      <code>PropertyChanged</code>        ,  ,     , , .        ,       . <br> <br>   <i>INotifyDataErrorInfo</i> <br>   ,     ,    ,   ,   <code>IDataErrorInfo</code> ,  ( Silverlight)   <code>INotifyDataErrorInfo</code> .   <code>INotifyDataErrorInfo</code>   ,         ,    ,  ,   ,    . <br> <br>       <code>INotifyDataErrorInfo</code> : ,     ,  ,     ,     <code>ErrorsChanged</code> ,      <code>GetErrors</code> , . <br> <br>    <br>     ,      ,     .       ,         <code>GetErrors</code>       ,  ,  ,   .    , ,  ,     ,        .   ,        . <br> <br> <code class="cs">//  . var notifyErrorInfo = (INotifyDataErrorInfo)question; question.Response = -15; Assert.IsTrue(notifyErrorInfo.GetErrors("Response").Cast&lt;ValidationResult&gt;().Any()); //  . var notifyErrorInfo = (INotifyDataErrorInfo)question; question.Response = 15; Assert.IsFalse(notifyErrorInfo.GetErrors("Response").Cast&lt;ValidationResult&gt;().Any());</code> <br>    ,    ,             . <br> <br>    <i>INotifyDataErrorInfo</i> <br>       <code>GetErrors</code> ,   <code>INotifyDataErrorInfo</code>  ,   <code>ErrorsChanged</code>      <code>GetErrors</code> . ,  <code>HasErrors</code>      ,  . <br> <br>       <code>INotifyDataErrorInfo</code> . , ,           ,   -  .      ,        <code>INotifyDataErrorInfo</code>         (,        ). <br> <br>     ,   ,  : <br>  <code>HasErrors</code>     .              ,       .  <code>ErrorsChanged</code> ,      ,         <code>GetErrors</code> .         ( ,  )     ,           .    <code>GetErrors</code>       <code>ErrorsChanged</code> . <br>    <code>INotifyPropertyChanged</code> ,  ,    <code>NotifyDataErrorInfoTestHelper</code>    MVVM,        <code>INotifyDataErrorInfo</code> ,       .   ,   ,      ,   .      . <br> <code class="cs">var helper = new NotifyDataErrorInfoTestHelper&lt;NumericQuestion, int?&gt;( question, q =&gt; q.Response); helper.ValidatePropertyChange( 6, NotifyDataErrorInfoBehavior.Nothing); helper.ValidatePropertyChange( 20, NotifyDataErrorInfoBehavior.FiresErrorsChanged | NotifyDataErrorInfoBehavior.HasErrors | NotifyDataErrorInfoBehavior.HasErrorsForProperty); helper.ValidatePropertyChange( null, NotifyDataErrorInfoBehavior.FiresErrorsChanged | NotifyDataErrorInfoBehavior.HasErrors | NotifyDataErrorInfoBehavior.HasErrorsForProperty); helper.ValidatePropertyChange( 2, NotifyDataErrorInfoBehavior.FiresErrorsChanged);</code> <br>     <br>   MVVM,     ,  .   ,    ,         . <br> <br>  ,     ,     ,       .   ,   , ,       ,     ,   <code>IAsyncResult</code>    ,  - ,   ,    UI. <br> <br>       , , ,    .   ,     .  ,      UI,     ,   ,          ,     ,        "   UI." <br> <br>     ,    ,    .   ,    ,     mock-, ,   ,   ,      ,          . <br> <br>           UI,    ,    .   ,     ,   ,      .        ,   .     ,    ,     . <br> <br> <code class="cs">questionnaireRepositoryMock .Setup( r =&gt; r.SubmitQuestionnaireAsync( It.IsAny&lt;Questionnaire&gt;(), It.IsAny&lt;Action&lt;IOperationResult&gt;&gt;())) .Callback&lt;Questionnaire, Action&lt;IOperationResult&gt;&gt;( (q, a) =&gt; callback = a); uiServicemock .Setup(svc =&gt; svc.ShowView(ViewNames.QuestionnaireTemplatesList)) .Callback&lt;string&gt;(viewName =&gt; requestedViewName = viewName); submitResultMock .Setup(sr =&gt; sr.Error) .Returns&lt;Exception&gt;(null); CompleteQuestionnaire(viewModel); viewModel.Submit(); //      UI . callback(submitResultMock.Object); //    ‚Äì     . Assert.AreEqual(ViewNames.QuestionnaireTemplatesList, requestedViewName);</code> <br> <b></b> <br>          ,        . <br>   <br>       , . "Trees in WPF"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ms753391.aspx">http://msdn.microsoft.com/en-us/library/ms753391.aspx</a> <br> <br>       , . "Attached Properties Overview"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/cc265152(VS.95).aspx">http://msdn.microsoft.com/en-us/library/cc265152(VS.95).aspx</a> <br> <br>      MEF, ."Managed Extensibility Framework Overview"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/dd460648.aspx">http://msdn.microsoft.com/en-us/library/dd460648.aspx</a> . <br> <br>      Unity, ."Unity Application Block"  MSDN: <a href="http://www.msdn.com/unity">http://www.msdn.com/unity</a> . <br> <br>      <code>DelegateCommand</code> , .Chapter 5, " <a href="http://msdn.microsoft.com/en-us/library/gg405484(v%3DPandP.40).aspx">Implementing the MVVM Pattern</a> ." <br> <br>        Microsoft Expression Blend, ."Working with built-in behaviors"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ff724013(v%3DExpression.40).aspx">http://msdn.microsoft.com/en-us/library/ff724013(v=Expression.40).aspx</a> . <br> <br>          Microsoft Expression Blend, ."Creating Custom Behaviors"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ff724708(v%3DExpression.40).aspx">http://msdn.microsoft.com/en-us/library/ff724708(v=Expression.40).aspx</a> . <br> <br>            Microsoft Expression Blend, ."Creating Custom Triggers and Actions"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ff724707(v%3DExpression.40).aspx">http://msdn.microsoft.com/en-us/library/ff724707(v=Expression.40).aspx</a> . <br> <br>         WPF  Silverlight, ."Threading Model"  "The Dispatcher Class"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ms741870.aspx">http://msdn.microsoft.com/en-us/library/ms741870.aspx</a> <br> <a href="http://msdn.microsoft.com/en-us/library/ms615907(v%3DVS.95).aspx">http://msdn.microsoft.com/en-us/library/ms615907(v=VS.95).aspx</a> . <br> <br>      unit-  Silverlight, ."Unit Testing with Silverlight 2": <a href="http://www.jeff.wilcox.name/2008/03/silverlight2-unit-testing/">http://www.jeff.wilcox.name/2008/03/silverlight2-unit-testing/</a> . <br> <br>         , .  " <a href="http://msdn.microsoft.com/en-us/library/gg430861(v%3DPandP.40).aspx">View-Based Navigation</a> " in Chapter 8, " <a href="http://msdn.microsoft.com/en-us/library/gg430861(v%3DPandP.40).aspx">Navigation</a> ." <br> <br>       ,   , ."Event-based Asynchronous Pattern Overview"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/wewwczdw.aspx">http://msdn.microsoft.com/en-us/library/wewwczdw.aspx</a> <br> <br>        <code>IAsyncResult</code> , ."Asynchronous Programming Overview"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ms228963.aspx">http://msdn.microsoft.com/en-us/library/ms228963.aspx</a></code></code></code></code></code></code></code></code></code> </h4> <code><code><code><code>CommandBehaviorBase ,    ,    ICommand</code> .           <code>CanExecuteChanged</code> ,          Silverlight,    WPF. <br> <br>    ,  ,   <code>CommandBehaviorBase    ,    .         ,      .         ,    .      ButtonBaseClickCommandBehavior</code> . <br> <br> <code class="cs">public class ButtonBaseClickCommandBehavior : CommandBehaviorBase&lt;ButtonBase&gt; { public ButtonBaseClickCommandBehavior(ButtonBase clickableObject) : base(clickableObject) { clickableObject.Click += OnClick; } private void OnClick(object sender, System.Windows.RoutedEventArgs e) { ExecuteCommand(); } }</code> <br>   <code>CommandBehaviorBase ,     .     ,          ,   . ,    ,    ,      , ,    CanExecute</code>  ,     . <br> <br>          ,   .           XAML.           .       .  Prism      ,       ,  ,   .       ,    . , ,  ,      <code>Click</code> ,       <code>Command</code> .    <code>Click.Command</code> ,  . <br> <br>             .             . <br> <br> <code class="cs">public static readonly DependencyProperty CommandProperty = DependencyProperty.RegisterAttached( "Command", typeof(ICommand), typeof(Click), new PropertyMetadata(OnSetCommandCallback)); private static readonly DependencyProperty ClickCommandBehaviorProperty = DependencyProperty.RegisterAttached( "ClickCommandBehavior", typeof(ButtonBaseClickCommandBehavior), typeof(Click), null);</code> <br>    <code>Command</code>    <code>ButtonBaseClickCommandBehavior</code> ,     <code>OnSetCommandCallback</code> ,     . <br> <br> <code class="cs">private static void OnSetCommandCallback(DependencyObject dependencyObject, DependencyPropertyChangedEventArgs e) { ButtonBase buttonBase = dependencyObject as ButtonBase; if (buttonBase != null) { ButtonBaseClickCommandBehavior behavior = GetOrCreateBehavior(buttonBase); behavior.Command = e.NewValue as ICommand; } } private static void OnSetCommandParameterCallback(DependencyObject dependencyObject, DependencyPropertyChangedEventArgs e) { ButtonBase buttonBase = dependencyObject as ButtonBase; if (buttonBase != null) { ButtonBaseClickCommandBehavior behavior = GetOrCreateBehavior(buttonBase); behavior.CommandParameter = e.NewValue; } } private static ButtonBaseClickCommandBehavior GetOrCreateBehavior(ButtonBase buttonBase ) { ButtonBaseClickCommandBehavior behavior = buttonBase.GetValue(ClickCommandBehaviorProperty) as ButtonBaseClickCommandBehavior; if ( behavior == null ) { behavior = new ButtonBaseClickCommandBehavior(buttonBase); buttonBase.SetValue(ClickCommandBehaviorProperty, behavior); } return behavior; }</code> <br>        ,  <a href="http://msdn.microsoft.com/en-us/library/cc265152(VS.95).aspx">Attached Properties Overview</a>  MSDN. <br> <br>    <br>              . ,     Silverlight,    -,     ,      ,     .     ,       . <br> <br>        ,    ( )  ,  ,     .  UI       ,            UI. <br> <br>      - <br>   -     ,       <code>IAsyncResult</code> .   ,  ,   ,  <code>GetQuestionnaire</code> ,   : <code>BeginGetQuestionnaire</code>  <code>EndGetQuestionnaire</code> .    ,   <code>BeginGetQuestionnaire</code> .     ,   ,   <code>EndGetQuestionnaire</code>    . <br> <b></b> <br>  .NET Framework 4.5      <code>await</code>  <code>async</code>     <code>*Async</code> .      <a href="http://msdn.microsoft.com/en-us/library/vstudio/hh391443.aspx">"Asynchronous Programming with Async and Await (C# and Visual Basic)"</a> . <br>  ,    <code>EndGetQuestionnaire</code> ,      ,  ()      <code>BeginGetQuestionnaire</code> .     ,      ,   <code>EndGetQuestionnaire</code> ,   . <br> <br> <code class="xml">IAsyncResult asyncResult = this.service.BeginGetQuestionnaire( GetQuestionnaireCompleted, null //  ,      ); private void GetQuestionnaireCompleted(IAsyncResult result) { try { questionnaire = this.service.EndGetQuestionnaire(ar); } catch (Exception ex) { //  -   . } }</code> <br>  ,     <code>End*</code> (  , <code>EndGetQuestionnaire</code> ),    ,      .      , ,          UI.     ,   ,        . <br> <br>        UI,     -,      UI,         UI,   <code>Dispatcher</code>    <code>SynchronizationContext</code> .  WPF  Silverlight,   <code>Dispatcher</code> . <br> <br>      <code>Questionnaire</code>  ,        <code>QuestionnaireView</code> .  Silverlight    <code>CheckAccess</code> ,  ,      UI.  ,     <code>BeginInvoke</code> ,      UI. <br> <br> <code class="cs">var dispatcher = System.Windows.Deployment.Current.Dispatcher; if (dispatcher.CheckAccess()) { QuestionnaireView.DataContext = questionnaire; } else { dispatcher.BeginInvoke(() =&gt; { Questionnaire.DataContext = questionnaire; }); }</code> <br> <i>MVVM RI</i>   ,    ,   <code>IAsyncResult</code> ,   .      ,                 . ,       . <br> <br> <code class="cs">this.questionnaireRepository.GetQuestionnaireAsync( result =&gt; { this.Questionnaire = result.Result; });</code> <br>  <code>result</code>   ,     , , , .    ,     . <br> <br> <code class="cs">this.questionnaireRepository.GetQuestionnaireAsync( result =&gt; { if (result.Error == null) { this.Questionnaire = result.Result; ... } else { // Handle error. } })</code> <br>     <br>        ,      .     , ,             .        ,      ,     ,     . <br> <br>         ,      MVVM,     ,   . ,  -MVVM ,     <code>MessageBox</code>   code-behind UI,      .   MVVM     ,          . <br> <br>     MVVM,              ,          .      ,    ,   ,  ,     . <br> <br>              MVVM.      ,     ,     ,  ,     .    ,         ,     ,          .       . <br> <br>    <br>                  .        ,        .  ,         .         . <br> <br>  ,         ,         ,  .      ,     .           ,       . ,        WPF  Silverlight,        . <br> <br> <img title="Using the service to interact with the user." src="https://habrastorage.org/getpro/habr/post_images/4b5/397/f2d/4b5397f2d02e5851195b29f1893be6fc.png" alt=" ,    ."> <br> <br>  ,   <code>MessageBox</code>        ,     ,    ,     . <br> <br> <code class="cs">var result = interactionService.ShowMessageBox( "Are you sure you want to cancel this operation?", "Confirm", MessageBoxButton.OK); if (result == MessageBoxResult.Yes) { CancelRequest(); }</code> <br> ,      - ,      ,         Silverlight.         .             .     . <br> <br> <code class="cs">interactionService.ShowMessageBox( "Are you sure you want to cancel this operation?", "Confirm", MessageBoxButton.OK, result =&gt; { if (result == MessageBoxResult.Yes) { CancelRequest(); } });</code> <br>         ,      . ,  WPF    <code>MessageBox</code> ,       ;    Silverlight    ,    . <br> <br>     <br>         ‚Äì             .         ,      .     ,     .        ,        ,   ,     . <br> <br> <img title="Using interaction request objects." src="https://habrastorage.org/getpro/habr/post_images/3d0/ff0/1c5/3d0ff01c5518558c2d3c5c5f47ce0ce9.png" alt="   ."> <br> <br>    ,   ,          ‚Äì       ,      ,   ‚Äì     .   ,        ,    ,    UI            . <br> <br>       MVVM,     ,       ,         .         ,        ,    ,   . <br> <br>  Prism       <code>IInteractionRequest</code>   <code><code>InteractionRequest .  IInteractionRequest</code>  ,   .           ,   .  <code><code>InteractionRequest   IInteractionRequest</code>     <code>Raise</code> ,           , , ,   . <br> <br>       <br>  <code><code>InteractionRequest          .  Raise</code>          ( <code>T</code> )    ,    ,   .          ,       .      ,        .    ,  ,     . <br> <code class="cs">public interface IInteractionRequest { event EventHandler&lt;InteractionRequestedEventArgs&gt; Raised; } public class InteractionRequest&lt;T&gt; : IInteractionRequest { public event EventHandler&lt;InteractionRequestedEventArgs&gt; Raised; public void Raise(T context, Action&lt;T&gt; callback) { var handler = this.Raised; if (handler != null) { handler( this, new InteractionRequestedEventArgs(context, () =&gt; callback(context))); } } }</code> <br> Prism    ,      .  <code>Notification</code>       .    ,            .     ‚Äì <code>Title</code>  <code>Content</code> ,    .  ,   ,  ,  ,        . <br> <br>  <code>Confirmation</code>    <code>Notification</code>     ‚Äì <code>Confirmed</code> ,  ,  ,      .  <code>Confirmation</code> ,     <code>MessageBox</code> ,     /  .     ,     <code>Notification</code> ,     ,      . <br> <br>    <code><code><code>InteractionRequest ,       InteractionRequest      ,      .      ,    Raise</code> ,    , ,   . <br> <br> <code class="cs">public IInteractionRequest ConfirmCancelInteractionRequest { get { return this.confirmCancelInteractionRequest; } } this.confirmCancelInteractionRequest.Raise( new Confirmation("Are you sure you wish to cancel?"), confirmation =&gt; { if (confirmation.Confirmed) { this.NavigateToQuestionnaireList(); } }); }</code> <br> <i>MVVM Reference Implementation (MVVM RI)</i> ,    <code>IInteractionRequest</code>   <code><code>InteractionRequest ,          (. QuestionnaireViewModel.cs</code> ). <br> <br>        <br>       ,       .   ,       .    UI             . <br> <br>                . Microsoft Expression Blend Behaviors Framework     .  ,     ,    . <br> <br>  <code>EventTrigger</code> ,  Expression Blend,  ,      ,     ,   . , Prism   <code>EventTrigger</code> ,  <code>InteractionRequestTrigger</code> ,      <code>Raised</code>   <code>IInteractionRequest</code> .    XAML        . <br> <br>  ,   , <code>InteractionRequestTrigger</code>   .  Silverlight Prism   <code>PopupChildWindowAction</code> ,     .    ,         .   <code>ContentTemplate</code>  <code>PopupChildWindowAction</code> ,    ,    UI,      <code>Content</code>  .       <code>Title</code>  . <br> <b></b> <br>  ,    ,   <code>PopupChildWindowAction</code> ,     .    <code>Notification</code>  <code>NotificationChildWindow</code> ,        <code>Confirmation</code> ‚Äì <code>ConfirmationChildWindow</code> . <code>NotificationChildWindow</code>    ,   ,     <code>ConfirmationChildWindow</code>    <i>OK</i>  <i>Cancel</i> ,    .    ,   ,   <code>ChildWindow</code>  <code>PopupChildWindowAction</code> . <br>   ,  <code>InteractionRequestTrigger</code>  <code>PopupChildWindowAction</code> ,       <i>RI MVVM</i> . <br> <br> <code class="xml">&lt;i:Interaction.Triggers&gt; &lt;prism:InteractionRequestTrigger SourceObject="{Binding ConfirmCancelInteractionRequest}"&gt; &lt;prism:PopupChildWindowAction ContentTemplate="{StaticResource ConfirmWindowTemplate}"/&gt; &lt;/prism:InteractionRequestTrigger&gt; &lt;/i:Interaction.Triggers&gt; &lt;UserControl.Resources&gt; &lt;DataTemplate x:Key="ConfirmWindowTemplate"&gt; &lt;Grid MinWidth="250" MinHeight="100"&gt; &lt;TextBlock TextWrapping="Wrap" Grid.Row="0" Text="{Binding}"/&gt; &lt;/Grid&gt; &lt;/DataTemplate&gt; &lt;/UserControl.Resources&gt;</code> <br> <b></b> <br>      <code>ContentTemplate</code> ,   UI   <code>Content</code>  .    <code>Content</code>  ,  , <code>TextBlock</code>     <code>Content</code> . <br>      ,     ,    ,    .  ,     ,       ,     ,    .   ,   <i>RI MVVM</i> ,         <code>Confirmed</code>    <code>Confirmation</code>  <code>true</code> ,     OK. <br> <br>        ,     .  Prism <code>InteractionRequestTrigger</code>   <code>PopupChildWindowAction</code>            . <br> <br>     <br>     MVVM,       , ,    ,         .        (  , ,  ,   ).    ,  ,  ,            . <br> <br>        ,         . Managed Extensibility Framework (MEF)  Unity Application Block (Unity)      ,  ,           . <br> <br>  ,       , , ,    ( )      . ,       ,     .  ,     ,       . <br> <br>     ,  MEF <br>  MEF,       ,   <code>Import</code> ,      ,  ,   <code>Export</code> .         ,    . <br> <br> , <code>QuestionnaireView</code>   <i>RI MVVM</i> ,        ,    <code>Import</code> .   , MEF           .  <code>set</code>        ,   . <br> <br> <code class="cs">[Import] public QuestionnaireViewModel ViewModel { set { this.DataContext = value; } }</code> <br>     ,   . <br> <br> <code class="cs">[Export] public class QuestionnaireViewModel : NotificationObject { ... }</code> <br>        ,   . <br> <br> <code class="cs">public QuestionnaireView() { InitializeComponent(); } [ImportingConstructor] public QuestionnaireView(QuestionnaireViewModel viewModel) : this() { this.DataContext = viewModel; }</code> <br> <b></b> <br>          MEF,   Unity.   ,     ,        .   ,   Visual Studio  Expression Blend, ,        ,     .   ,   ,  ,      ,          <code>InitializeComponent</code> . <br>     ,  Unity <br>  Unity,    ,   MEF.     ,      .    ,         .  ,      . <br> <br>  ,      ,  ,         . ,           ,   . <br> <br> <code class="cs">public QuestionnaireView() { InitializeComponent(); } public QuestionnaireView(QuestionnaireViewModel viewModel) : this() { this.DataContext = viewModel; }</code> <br> <b></b> <br>    ,        ,   Visual Studio  Expression Blend. <br>  ,          ,   . Unity        <code>set</code>   ,   . <br> <br> <code class="cs">public QuestionnaireView() { InitializeComponent(); } [Dependency] public QuestionnaireViewModel ViewModel { set { this.DataContext = value; } }</code> <br>       Unity. <br> <br> <code class="cs">container.RegisterType&lt;QuestionnaireViewModel&gt;();</code> <br>  ,     . <br> <br> <code class="cs">var view = container.Resolve&lt;QuestionnaireView&gt;();</code> <br>     ,    <br>   ,     ,        .        ,   MEF  Unity,        . <br> <br>          .   ,         UI,           . <br> <br> , <i>RI MVVM</i>   ,   ,        .   ,    .      <code>ShowView</code>   UI. <br> <br> <code class="cs">private void NavigateToQuestionnaireList() { //     "questionnaire list". this.uiService.ShowView(ViewNames.QuestionnaireTemplatesList); }</code> <br>  UI      UI .           UI.  <code>ShowView</code>  <code>UIService</code>      (,          ),       ,   . <br> <br> <code class="cs">public void ShowView(string viewName) { var view = this.ViewFactory.GetView(viewName); this.MainWindow.CurrentView = view; }</code> <br> <b></b> <br> Prism       .   ,   ,   ,             .    ,  , " <a href="http://msdn.microsoft.com/en-us/library/gg430861(v%3DPandP.40).aspx">View-Based Navigation</a> "   8, " <a href="http://msdn.microsoft.com/en-us/library/gg430861(v%3DPandP.40).aspx">Navigation</a> ". <br>  MVVM  <br>        MVVM      .           -      mocking . ,   ,        . <br> <br>   <i>INotifyPropertyChanged</i> <br>   <code>INotifyPropertyChanged</code>     ,      .      ,    ;   ,   ,     ,    ,       . <br> <br>   <br> ,       ,           <code>PropertyChanged</code>  ,         .  ,    <code>ChangeTracker</code> ,     MVVM,  ,      .      .     ,    . <br> <br> <code class="cs">var changeTracker = new PropertyChangeTracker(viewModel); viewModel.CurrentState = "newState"; CollectionAssert.Contains(changeTracker.ChangedProperties, "CurrentState");</code> <br> ,     ,     <code>INotifyPropertyChanged</code> ,    ,   ,     . <br> <br>      <br>        ,   ,    <code>set</code>      ,           . ,     ,     ,      ,          . <br> <br> <code class="cs">var changeTracker = new PropertyChangeTracker(viewModel); var question = viewModel.Questions.First() as OpenQuestionViewModel; question.Question.Response = "some text"; CollectionAssert.Contains(changeTracker.ChangedProperties, "UnansweredQuestions");</code> <br>      <br>     <code>INotifyPropertyChanged</code> ,      <code>PropertyChanged</code>        ,  ,     , , .        ,       . <br> <br>   <i>INotifyDataErrorInfo</i> <br>   ,     ,    ,   ,   <code>IDataErrorInfo</code> ,  ( Silverlight)   <code>INotifyDataErrorInfo</code> .   <code>INotifyDataErrorInfo</code>   ,         ,    ,  ,   ,    . <br> <br>       <code>INotifyDataErrorInfo</code> : ,     ,  ,     ,     <code>ErrorsChanged</code> ,      <code>GetErrors</code> , . <br> <br>    <br>     ,      ,     .       ,         <code>GetErrors</code>       ,  ,  ,   .    , ,  ,     ,        .   ,        . <br> <br> <code class="cs">//  . var notifyErrorInfo = (INotifyDataErrorInfo)question; question.Response = -15; Assert.IsTrue(notifyErrorInfo.GetErrors("Response").Cast&lt;ValidationResult&gt;().Any()); //  . var notifyErrorInfo = (INotifyDataErrorInfo)question; question.Response = 15; Assert.IsFalse(notifyErrorInfo.GetErrors("Response").Cast&lt;ValidationResult&gt;().Any());</code> <br>    ,    ,             . <br> <br>    <i>INotifyDataErrorInfo</i> <br>       <code>GetErrors</code> ,   <code>INotifyDataErrorInfo</code>  ,   <code>ErrorsChanged</code>      <code>GetErrors</code> . ,  <code>HasErrors</code>      ,  . <br> <br>       <code>INotifyDataErrorInfo</code> . , ,           ,   -  .      ,        <code>INotifyDataErrorInfo</code>         (,        ). <br> <br>     ,   ,  : <br>  <code>HasErrors</code>     .              ,       .  <code>ErrorsChanged</code> ,      ,         <code>GetErrors</code> .         ( ,  )     ,           .    <code>GetErrors</code>       <code>ErrorsChanged</code> . <br>    <code>INotifyPropertyChanged</code> ,  ,    <code>NotifyDataErrorInfoTestHelper</code>    MVVM,        <code>INotifyDataErrorInfo</code> ,       .   ,   ,      ,   .      . <br> <code class="cs">var helper = new NotifyDataErrorInfoTestHelper&lt;NumericQuestion, int?&gt;( question, q =&gt; q.Response); helper.ValidatePropertyChange( 6, NotifyDataErrorInfoBehavior.Nothing); helper.ValidatePropertyChange( 20, NotifyDataErrorInfoBehavior.FiresErrorsChanged | NotifyDataErrorInfoBehavior.HasErrors | NotifyDataErrorInfoBehavior.HasErrorsForProperty); helper.ValidatePropertyChange( null, NotifyDataErrorInfoBehavior.FiresErrorsChanged | NotifyDataErrorInfoBehavior.HasErrors | NotifyDataErrorInfoBehavior.HasErrorsForProperty); helper.ValidatePropertyChange( 2, NotifyDataErrorInfoBehavior.FiresErrorsChanged);</code> <br>     <br>   MVVM,     ,  .   ,    ,         . <br> <br>  ,     ,     ,       .   ,   , ,       ,     ,   <code>IAsyncResult</code>    ,  - ,   ,    UI. <br> <br>       , , ,    .   ,     .  ,      UI,     ,   ,          ,     ,        "   UI." <br> <br>     ,    ,    .   ,    ,     mock-, ,   ,   ,      ,          . <br> <br>           UI,    ,    .   ,     ,   ,      .        ,   .     ,    ,     . <br> <br> <code class="cs">questionnaireRepositoryMock .Setup( r =&gt; r.SubmitQuestionnaireAsync( It.IsAny&lt;Questionnaire&gt;(), It.IsAny&lt;Action&lt;IOperationResult&gt;&gt;())) .Callback&lt;Questionnaire, Action&lt;IOperationResult&gt;&gt;( (q, a) =&gt; callback = a); uiServicemock .Setup(svc =&gt; svc.ShowView(ViewNames.QuestionnaireTemplatesList)) .Callback&lt;string&gt;(viewName =&gt; requestedViewName = viewName); submitResultMock .Setup(sr =&gt; sr.Error) .Returns&lt;Exception&gt;(null); CompleteQuestionnaire(viewModel); viewModel.Submit(); //      UI . callback(submitResultMock.Object); //    ‚Äì     . Assert.AreEqual(ViewNames.QuestionnaireTemplatesList, requestedViewName);</code> <br> <b></b> <br>          ,        . <br>   <br>       , . "Trees in WPF"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ms753391.aspx">http://msdn.microsoft.com/en-us/library/ms753391.aspx</a> <br> <br>       , . "Attached Properties Overview"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/cc265152(VS.95).aspx">http://msdn.microsoft.com/en-us/library/cc265152(VS.95).aspx</a> <br> <br>      MEF, ."Managed Extensibility Framework Overview"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/dd460648.aspx">http://msdn.microsoft.com/en-us/library/dd460648.aspx</a> . <br> <br>      Unity, ."Unity Application Block"  MSDN: <a href="http://www.msdn.com/unity">http://www.msdn.com/unity</a> . <br> <br>      <code>DelegateCommand</code> , .Chapter 5, " <a href="http://msdn.microsoft.com/en-us/library/gg405484(v%3DPandP.40).aspx">Implementing the MVVM Pattern</a> ." <br> <br>        Microsoft Expression Blend, ."Working with built-in behaviors"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ff724013(v%3DExpression.40).aspx">http://msdn.microsoft.com/en-us/library/ff724013(v=Expression.40).aspx</a> . <br> <br>          Microsoft Expression Blend, ."Creating Custom Behaviors"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ff724708(v%3DExpression.40).aspx">http://msdn.microsoft.com/en-us/library/ff724708(v=Expression.40).aspx</a> . <br> <br>            Microsoft Expression Blend, ."Creating Custom Triggers and Actions"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ff724707(v%3DExpression.40).aspx">http://msdn.microsoft.com/en-us/library/ff724707(v=Expression.40).aspx</a> . <br> <br>         WPF  Silverlight, ."Threading Model"  "The Dispatcher Class"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ms741870.aspx">http://msdn.microsoft.com/en-us/library/ms741870.aspx</a> <br> <a href="http://msdn.microsoft.com/en-us/library/ms615907(v%3DVS.95).aspx">http://msdn.microsoft.com/en-us/library/ms615907(v=VS.95).aspx</a> . <br> <br>      unit-  Silverlight, ."Unit Testing with Silverlight 2": <a href="http://www.jeff.wilcox.name/2008/03/silverlight2-unit-testing/">http://www.jeff.wilcox.name/2008/03/silverlight2-unit-testing/</a> . <br> <br>         , .  " <a href="http://msdn.microsoft.com/en-us/library/gg430861(v%3DPandP.40).aspx">View-Based Navigation</a> " in Chapter 8, " <a href="http://msdn.microsoft.com/en-us/library/gg430861(v%3DPandP.40).aspx">Navigation</a> ." <br> <br>       ,   , ."Event-based Asynchronous Pattern Overview"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/wewwczdw.aspx">http://msdn.microsoft.com/en-us/library/wewwczdw.aspx</a> <br> <br>        <code>IAsyncResult</code> , ."Asynchronous Programming Overview"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ms228963.aspx">http://msdn.microsoft.com/en-us/library/ms228963.aspx</a></code></code></code></code></code></code></code></code></code> <pre> <code class="hljs cmake"><code>CommandBehaviorBase ,    ,    ICommand</code> .           <code>CanExecuteChanged</code> ,          Silverlight,    WPF. <br> <br>    ,  ,   <code><code>CommandBehaviorBase    ,    .         ,      .         ,    .      ButtonBaseClickCommandBehavior</code> . <br> <br> <code class="cs">public class ButtonBaseClickCommandBehavior : CommandBehaviorBase&lt;ButtonBase&gt; { public ButtonBaseClickCommandBehavior(ButtonBase clickableObject) : base(clickableObject) { clickableObject.Click += OnClick; } private void OnClick(object sender, System.Windows.RoutedEventArgs e) { ExecuteCommand(); } }</code> <br>   <code><code>CommandBehaviorBase ,     .     ,          ,   . ,    ,    ,      , ,    CanExecute</code>  ,     . <br> <br>          ,   .           XAML.           .       .  Prism      ,       ,  ,   .       ,    . , ,  ,      <code>Click</code> ,       <code><span class="hljs-keyword"><span class="hljs-keyword">Command</span></span></code> .    <code>Click.<span class="hljs-keyword"><span class="hljs-keyword">Command</span></span></code> ,  . <br> <br>             .             . <br> <br> <code class="cs">public static readonly DependencyProperty CommandProperty = DependencyProperty.RegisterAttached( <span class="hljs-string"><span class="hljs-string">"Command"</span></span>, typeof(ICommand), typeof(Click), new PropertyMetadata(OnSetCommandCallback)); private static readonly DependencyProperty ClickCommandBehaviorProperty = DependencyProperty.RegisterAttached( <span class="hljs-string"><span class="hljs-string">"ClickCommandBehavior"</span></span>, typeof(ButtonBaseClickCommandBehavior), typeof(Click), null);</code> <br>    <code><span class="hljs-keyword"><span class="hljs-keyword">Command</span></span></code>    <code>ButtonBaseClickCommandBehavior</code> ,     <code>OnSetCommandCallback</code> ,     . <br> <br> <code class="cs">private static void OnSetCommandCallback(DependencyObject dependencyObject, DependencyPropertyChangedEventArgs e) { ButtonBase buttonBase = dependencyObject as ButtonBase; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (buttonBase != null) { ButtonBaseClickCommandBehavior behavior = GetOrCreateBehavior(buttonBase); behavior.<span class="hljs-keyword"><span class="hljs-keyword">Command</span></span> = e.NewValue as ICommand; } } private static void OnSetCommandParameterCallback(DependencyObject dependencyObject, DependencyPropertyChangedEventArgs e) { ButtonBase buttonBase = dependencyObject as ButtonBase; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (buttonBase != null) { ButtonBaseClickCommandBehavior behavior = GetOrCreateBehavior(buttonBase); behavior.CommandParameter = e.NewValue; } } private static ButtonBaseClickCommandBehavior GetOrCreateBehavior(ButtonBase buttonBase ) { ButtonBaseClickCommandBehavior behavior = buttonBase.GetValue(ClickCommandBehaviorProperty) as ButtonBaseClickCommandBehavior; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ( behavior == null ) { behavior = new ButtonBaseClickCommandBehavior(buttonBase); buttonBase.SetValue(ClickCommandBehaviorProperty, behavior); } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> behavior; }</code> <br>        ,  <a href="http://msdn.microsoft.com/en-us/library/cc265152(VS.95).aspx">Attached Properties Overview</a>  MSDN. <br> <br>    <br>              . ,     Silverlight,    -,     ,      ,     .     ,       . <br> <br>        ,    ( )  ,  ,     .  UI       ,            UI. <br> <br>      - <br>   -     ,       <code>IAsyncResult</code> .   ,  ,   ,  <code>GetQuestionnaire</code> ,   : <code>BeginGetQuestionnaire</code>  <code>EndGetQuestionnaire</code> .    ,   <code>BeginGetQuestionnaire</code> .     ,   ,   <code>EndGetQuestionnaire</code>    . <br> <b></b> <br>  .NET Framework <span class="hljs-number"><span class="hljs-number">4.5</span></span>      <code>await</code>  <code>async</code>     <code>*Async</code> .      <a href="http://msdn.microsoft.com/en-us/library/vstudio/hh391443.aspx"><span class="hljs-string"><span class="hljs-string">"Asynchronous Programming with Async and Await (C# and Visual Basic)"</span></span></a> . <br>  ,    <code>EndGetQuestionnaire</code> ,      ,  ()      <code>BeginGetQuestionnaire</code> .     ,      ,   <code>EndGetQuestionnaire</code> ,   . <br> <br> <code class="xml">IAsyncResult asyncResult = this.service.BeginGetQuestionnaire( GetQuestionnaireCompleted, null //  ,      ); private void GetQuestionnaireCompleted(IAsyncResult result) { try { questionnaire = this.service.EndGetQuestionnaire(ar); } catch (Exception ex) { //  -   . } }</code> <br>  ,     <code>End*</code> (  , <code>EndGetQuestionnaire</code> ),    ,      .      , ,          UI.     ,   ,        . <br> <br>        UI,     -,      UI,         UI,   <code>Dispatcher</code>    <code>SynchronizationContext</code> .  WPF  Silverlight,   <code>Dispatcher</code> . <br> <br>      <code>Questionnaire</code>  ,        <code>QuestionnaireView</code> .  Silverlight    <code>CheckAccess</code> ,  ,      UI.  ,     <code>BeginInvoke</code> ,      UI. <br> <br> <code class="cs">var dispatcher = System.Windows.Deployment.Current.Dispatcher; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (dispatcher.CheckAccess()) { QuestionnaireView.DataContext = questionnaire; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { dispatcher.BeginInvoke(() =&gt; { Questionnaire.DataContext = questionnaire; }); }</code> <br> <i>MVVM RI</i>   ,    ,   <code>IAsyncResult</code> ,   .      ,                 . ,       . <br> <br> <code class="cs">this.questionnaireRepository.GetQuestionnaireAsync( result =&gt; { this.Questionnaire = result.Result; });</code> <br>  <code>result</code>   ,     , , , .    ,     . <br> <br> <code class="cs">this.questionnaireRepository.GetQuestionnaireAsync( result =&gt; { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (result.Error == null) { this.Questionnaire = result.Result; ... } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { // Handle error. } })</code> <br>     <br>        ,      .     , ,             .        ,      ,     ,     . <br> <br>         ,      MVVM,     ,   . ,  -MVVM ,     <code>MessageBox</code>   code-behind UI,      .   MVVM     ,          . <br> <br>     MVVM,              ,          .      ,    ,   ,  ,     . <br> <br>              MVVM.      ,     ,     ,  ,     .    ,         ,     ,          .       . <br> <br>    <br>                  .        ,        .  ,         .         . <br> <br>  ,         ,         ,  .      ,     .           ,       . ,        WPF  Silverlight,        . <br> <br> <img title="Using the service to interact with the user." src="https://habrastorage.org/getpro/habr/post_images/4b5/397/f2d/4b5397f2d02e5851195b29f1893be6fc.png" alt=" ,    ."> <br> <br>  ,   <code>MessageBox</code>        ,     ,    ,     . <br> <br> <code class="cs">var result = interactionService.ShowMessageBox( <span class="hljs-string"><span class="hljs-string">"Are you sure you want to cancel this operation?"</span></span>, <span class="hljs-string"><span class="hljs-string">"Confirm"</span></span>, MessageBoxButton.OK); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (result == MessageBoxResult.Yes) { CancelRequest(); }</code> <br> ,      - ,      ,         Silverlight.         .             .     . <br> <br> <code class="cs">interactionService.ShowMessageBox( <span class="hljs-string"><span class="hljs-string">"Are you sure you want to cancel this operation?"</span></span>, <span class="hljs-string"><span class="hljs-string">"Confirm"</span></span>, MessageBoxButton.OK, result =&gt; { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (result == MessageBoxResult.Yes) { CancelRequest(); } });</code> <br>         ,      . ,  WPF    <code>MessageBox</code> ,       ;    Silverlight    ,    . <br> <br>     <br>         ‚Äì             .         ,      .     ,     .        ,        ,   ,     . <br> <br> <img title="Using interaction request objects." src="https://habrastorage.org/getpro/habr/post_images/3d0/ff0/1c5/3d0ff01c5518558c2d3c5c5f47ce0ce9.png" alt="   ."> <br> <br>    ,   ,          ‚Äì       ,      ,   ‚Äì     .   ,        ,    ,    UI            . <br> <br>       MVVM,     ,       ,         .         ,        ,    ,   . <br> <br>  Prism       <code>IInteractionRequest</code>   <code><code>InteractionRequest .  IInteractionRequest</code>  ,   .           ,   .  <code><code>InteractionRequest   IInteractionRequest</code>     <code>Raise</code> ,           , , ,   . <br> <br>       <br>  <code><code>InteractionRequest          .  Raise</code>          ( <code>T</code> )    ,    ,   .          ,       .      ,        .    ,  ,     . <br> <code class="cs">public interface IInteractionRequest { event EventHandler&lt;InteractionRequestedEventArgs&gt; Raised; } public class InteractionRequest&lt;T&gt; : IInteractionRequest { public event EventHandler&lt;InteractionRequestedEventArgs&gt; Raised; public void Raise(T context, Action&lt;T&gt; callback) { var handler = this.Raised; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (handler != null) { handler( this, new InteractionRequestedEventArgs(context, () =&gt; callback(context))); } } }</code> <br> Prism    ,      .  <code>Notification</code>       .    ,            .     ‚Äì <code>Title</code>  <code>Content</code> ,    .  ,   ,  ,  ,        . <br> <br>  <code>Confirmation</code>    <code>Notification</code>     ‚Äì <code>Confirmed</code> ,  ,  ,      .  <code>Confirmation</code> ,     <code>MessageBox</code> ,     /  .     ,     <code>Notification</code> ,     ,      . <br> <br>    <code><code><code>InteractionRequest ,       InteractionRequest      ,      .      ,    Raise</code> ,    , ,   . <br> <br> <code class="cs">public IInteractionRequest ConfirmCancelInteractionRequest { get { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> this.confirmCancelInteractionRequest; } } this.confirmCancelInteractionRequest.Raise( new Confirmation(<span class="hljs-string"><span class="hljs-string">"Are you sure you wish to cancel?"</span></span>), confirmation =&gt; { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (confirmation.Confirmed) { this.NavigateToQuestionnaireList(); } }); }</code> <br> <i>MVVM Reference Implementation (MVVM RI)</i> ,    <code>IInteractionRequest</code>   <code><code>InteractionRequest ,          (. QuestionnaireViewModel.cs</code> ). <br> <br>        <br>       ,       .   ,       .    UI             . <br> <br>                . Microsoft Expression Blend Behaviors Framework     .  ,     ,    . <br> <br>  <code>EventTrigger</code> ,  Expression Blend,  ,      ,     ,   . , Prism   <code>EventTrigger</code> ,  <code>InteractionRequestTrigger</code> ,      <code>Raised</code>   <code>IInteractionRequest</code> .    XAML        . <br> <br>  ,   , <code>InteractionRequestTrigger</code>   .  Silverlight Prism   <code>PopupChildWindowAction</code> ,     .    ,         .   <code>ContentTemplate</code>  <code>PopupChildWindowAction</code> ,    ,    UI,      <code>Content</code>  .       <code>Title</code>  . <br> <b></b> <br>  ,    ,   <code>PopupChildWindowAction</code> ,     .    <code>Notification</code>  <code>NotificationChildWindow</code> ,        <code>Confirmation</code> ‚Äì <code>ConfirmationChildWindow</code> . <code>NotificationChildWindow</code>    ,   ,     <code>ConfirmationChildWindow</code>    <i>OK</i>  <i>Cancel</i> ,    .    ,   ,   <code>ChildWindow</code>  <code>PopupChildWindowAction</code> . <br>   ,  <code>InteractionRequestTrigger</code>  <code>PopupChildWindowAction</code> ,       <i>RI MVVM</i> . <br> <br> <code class="xml">&lt;i:Interaction.Triggers&gt; &lt;prism:InteractionRequestTrigger SourceObject=<span class="hljs-string"><span class="hljs-string">"{Binding ConfirmCancelInteractionRequest}"</span></span>&gt; &lt;prism:PopupChildWindowAction ContentTemplate=<span class="hljs-string"><span class="hljs-string">"{StaticResource ConfirmWindowTemplate}"</span></span>/&gt; &lt;/prism:InteractionRequestTrigger&gt; &lt;/i:Interaction.Triggers&gt; &lt;UserControl.Resources&gt; &lt;DataTemplate x:Key=<span class="hljs-string"><span class="hljs-string">"ConfirmWindowTemplate"</span></span>&gt; &lt;Grid MinWidth=<span class="hljs-string"><span class="hljs-string">"250"</span></span> MinHeight=<span class="hljs-string"><span class="hljs-string">"100"</span></span>&gt; &lt;TextBlock TextWrapping=<span class="hljs-string"><span class="hljs-string">"Wrap"</span></span> Grid.Row=<span class="hljs-string"><span class="hljs-string">"0"</span></span> Text=<span class="hljs-string"><span class="hljs-string">"{Binding}"</span></span>/&gt; &lt;/Grid&gt; &lt;/DataTemplate&gt; &lt;/UserControl.Resources&gt;</code> <br> <b></b> <br>      <code>ContentTemplate</code> ,   UI   <code>Content</code>  .    <code>Content</code>  ,  , <code>TextBlock</code>     <code>Content</code> . <br>      ,     ,    ,    .  ,     ,       ,     ,    .   ,   <i>RI MVVM</i> ,         <code>Confirmed</code>    <code>Confirmation</code>  <code><span class="hljs-keyword"><span class="hljs-keyword">true</span></span></code> ,     OK. <br> <br>        ,     .  Prism <code>InteractionRequestTrigger</code>   <code>PopupChildWindowAction</code>            . <br> <br>     <br>     MVVM,       , ,    ,         .        (  , ,  ,   ).    ,  ,  ,            . <br> <br>        ,         . Managed Extensibility Framework (MEF)  Unity Application Block (Unity)      ,  ,           . <br> <br>  ,       , , ,    ( )      . ,       ,     .  ,     ,       . <br> <br>     ,  MEF <br>  MEF,       ,   <code>Import</code> ,      ,  ,   <code><span class="hljs-keyword"><span class="hljs-keyword">Export</span></span></code> .         ,    . <br> <br> , <code>QuestionnaireView</code>   <i>RI MVVM</i> ,        ,    <code>Import</code> .   , MEF           .  <code><span class="hljs-keyword"><span class="hljs-keyword">set</span></span></code>        ,   . <br> <br> <code class="cs">[Import] public QuestionnaireViewModel ViewModel { <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> { this.DataContext = value; } }</code> <br>     ,   . <br> <br> <code class="cs">[<span class="hljs-keyword"><span class="hljs-keyword">Export</span></span>] public class QuestionnaireViewModel : NotificationObject { ... }</code> <br>        ,   . <br> <br> <code class="cs">public QuestionnaireView() { InitializeComponent(); } [ImportingConstructor] public QuestionnaireView(QuestionnaireViewModel viewModel) : this() { this.DataContext = viewModel; }</code> <br> <b></b> <br>          MEF,   Unity.   ,     ,        .   ,   Visual Studio  Expression Blend, ,        ,     .   ,   ,  ,      ,          <code>InitializeComponent</code> . <br>     ,  Unity <br>  Unity,    ,   MEF.     ,      .    ,         .  ,      . <br> <br>  ,      ,  ,         . ,           ,   . <br> <br> <code class="cs">public QuestionnaireView() { InitializeComponent(); } public QuestionnaireView(QuestionnaireViewModel viewModel) : this() { this.DataContext = viewModel; }</code> <br> <b></b> <br>    ,        ,   Visual Studio  Expression Blend. <br>  ,          ,   . Unity        <code><span class="hljs-keyword"><span class="hljs-keyword">set</span></span></code>   ,   . <br> <br> <code class="cs">public QuestionnaireView() { InitializeComponent(); } [Dependency] public QuestionnaireViewModel ViewModel { <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> { this.DataContext = value; } }</code> <br>       Unity. <br> <br> <code class="cs">container.RegisterType&lt;QuestionnaireViewModel&gt;();</code> <br>  ,     . <br> <br> <code class="cs">var view = container.Resolve&lt;QuestionnaireView&gt;();</code> <br>     ,    <br>   ,     ,        .        ,   MEF  Unity,        . <br> <br>          .   ,         UI,           . <br> <br> , <i>RI MVVM</i>   ,   ,        .   ,    .      <code>ShowView</code>   UI. <br> <br> <code class="cs">private void NavigateToQuestionnaireList() { //     <span class="hljs-string"><span class="hljs-string">"questionnaire list"</span></span>. this.uiService.ShowView(ViewNames.QuestionnaireTemplatesList); }</code> <br>  UI      UI .           UI.  <code>ShowView</code>  <code>UIService</code>      (,          ),       ,   . <br> <br> <code class="cs">public void ShowView(<span class="hljs-keyword"><span class="hljs-keyword">string</span></span> viewName) { var view = this.ViewFactory.GetView(viewName); this.MainWindow.CurrentView = view; }</code> <br> <b></b> <br> Prism       .   ,   ,   ,             .    ,  , <span class="hljs-string"><span class="hljs-string">" </span></span><a href="http://msdn.microsoft.com/en-us/library/gg430861(v%3DPandP.40).aspx"><span class="hljs-string"><span class="hljs-string">View-Based Navigation</span></span></a><span class="hljs-string"><span class="hljs-string"> "</span></span>   <span class="hljs-number"><span class="hljs-number">8</span></span>, <span class="hljs-string"><span class="hljs-string">" </span></span><a href="http://msdn.microsoft.com/en-us/library/gg430861(v%3DPandP.40).aspx"><span class="hljs-string"><span class="hljs-string">Navigation</span></span></a><span class="hljs-string"><span class="hljs-string"> "</span></span>. <br>  MVVM  <br>        MVVM      .           -      mocking . ,   ,        . <br> <br>   <i>INotifyPropertyChanged</i> <br>   <code>INotifyPropertyChanged</code>     ,      .      ,    ;   ,   ,     ,    ,       . <br> <br>   <br> ,       ,           <code>PropertyChanged</code>  ,         .  ,    <code>ChangeTracker</code> ,     MVVM,  ,      .      .     ,    . <br> <br> <code class="cs">var changeTracker = new PropertyChangeTracker(viewModel); viewModel.CurrentState = <span class="hljs-string"><span class="hljs-string">"newState"</span></span>; CollectionAssert.Contains(changeTracker.ChangedProperties, <span class="hljs-string"><span class="hljs-string">"CurrentState"</span></span>);</code> <br> ,     ,     <code>INotifyPropertyChanged</code> ,    ,   ,     . <br> <br>      <br>        ,   ,    <code><span class="hljs-keyword"><span class="hljs-keyword">set</span></span></code>      ,           . ,     ,     ,      ,          . <br> <br> <code class="cs">var changeTracker = new PropertyChangeTracker(viewModel); var question = viewModel.Questions.First() as OpenQuestionViewModel; question.Question.Response = <span class="hljs-string"><span class="hljs-string">"some text"</span></span>; CollectionAssert.Contains(changeTracker.ChangedProperties, <span class="hljs-string"><span class="hljs-string">"UnansweredQuestions"</span></span>);</code> <br>      <br>     <code>INotifyPropertyChanged</code> ,      <code>PropertyChanged</code>        ,  ,     , , .        ,       . <br> <br>   <i>INotifyDataErrorInfo</i> <br>   ,     ,    ,   ,   <code>IDataErrorInfo</code> ,  ( Silverlight)   <code>INotifyDataErrorInfo</code> .   <code>INotifyDataErrorInfo</code>   ,         ,    ,  ,   ,    . <br> <br>       <code>INotifyDataErrorInfo</code> : ,     ,  ,     ,     <code>ErrorsChanged</code> ,      <code>GetErrors</code> , . <br> <br>    <br>     ,      ,     .       ,         <code>GetErrors</code>       ,  ,  ,   .    , ,  ,     ,        .   ,        . <br> <br> <code class="cs">//  . var notifyErrorInfo = (INotifyDataErrorInfo)question; question.Response = -<span class="hljs-number"><span class="hljs-number">15</span></span>; Assert.IsTrue(notifyErrorInfo.GetErrors(<span class="hljs-string"><span class="hljs-string">"Response"</span></span>).Cast&lt;ValidationResult&gt;().Any()); //  . var notifyErrorInfo = (INotifyDataErrorInfo)question; question.Response = <span class="hljs-number"><span class="hljs-number">15</span></span>; Assert.IsFalse(notifyErrorInfo.GetErrors(<span class="hljs-string"><span class="hljs-string">"Response"</span></span>).Cast&lt;ValidationResult&gt;().Any());</code> <br>    ,    ,             . <br> <br>    <i>INotifyDataErrorInfo</i> <br>       <code>GetErrors</code> ,   <code>INotifyDataErrorInfo</code>  ,   <code>ErrorsChanged</code>      <code>GetErrors</code> . ,  <code>HasErrors</code>      ,  . <br> <br>       <code>INotifyDataErrorInfo</code> . , ,           ,   -  .      ,        <code>INotifyDataErrorInfo</code>         (,        ). <br> <br>     ,   ,  : <br>  <code>HasErrors</code>     .              ,       .  <code>ErrorsChanged</code> ,      ,         <code>GetErrors</code> .         ( ,  )     ,           .    <code>GetErrors</code>       <code>ErrorsChanged</code> . <br>    <code>INotifyPropertyChanged</code> ,  ,    <code>NotifyDataErrorInfoTestHelper</code>    MVVM,        <code>INotifyDataErrorInfo</code> ,       .   ,   ,      ,   .      . <br> <code class="cs">var helper = new NotifyDataErrorInfoTestHelper&lt;NumericQuestion, int?&gt;( question, q =&gt; q.Response); helper.ValidatePropertyChange( <span class="hljs-number"><span class="hljs-number">6</span></span>, NotifyDataErrorInfoBehavior.Nothing); helper.ValidatePropertyChange( <span class="hljs-number"><span class="hljs-number">20</span></span>, NotifyDataErrorInfoBehavior.FiresErrorsChanged | NotifyDataErrorInfoBehavior.HasErrors | NotifyDataErrorInfoBehavior.HasErrorsForProperty); helper.ValidatePropertyChange( null, NotifyDataErrorInfoBehavior.FiresErrorsChanged | NotifyDataErrorInfoBehavior.HasErrors | NotifyDataErrorInfoBehavior.HasErrorsForProperty); helper.ValidatePropertyChange( <span class="hljs-number"><span class="hljs-number">2</span></span>, NotifyDataErrorInfoBehavior.FiresErrorsChanged);</code> <br>     <br>   MVVM,     ,  .   ,    ,         . <br> <br>  ,     ,     ,       .   ,   , ,       ,     ,   <code>IAsyncResult</code>    ,  - ,   ,    UI. <br> <br>       , , ,    .   ,     .  ,      UI,     ,   ,          ,     ,        <span class="hljs-string"><span class="hljs-string">"   UI."</span></span> <br> <br>     ,    ,    .   ,    ,     mock-, ,   ,   ,      ,          . <br> <br>           UI,    ,    .   ,     ,   ,      .        ,   .     ,    ,     . <br> <br> <code class="cs">questionnaireRepositoryMock .Setup( r =&gt; r.SubmitQuestionnaireAsync( It.IsAny&lt;Questionnaire&gt;(), It.IsAny&lt;Action&lt;IOperationResult&gt;&gt;())) .Callback&lt;Questionnaire, Action&lt;IOperationResult&gt;&gt;( (q, a) =&gt; callback = a); uiServicemock .Setup(svc =&gt; svc.ShowView(ViewNames.QuestionnaireTemplatesList)) .Callback&lt;<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>&gt;(viewName =&gt; requestedViewName = viewName); submitResultMock .Setup(sr =&gt; sr.Error) .Returns&lt;Exception&gt;(null); CompleteQuestionnaire(viewModel); viewModel.Submit(); //      UI . callback(submitResultMock.Object); //    ‚Äì     . Assert.AreEqual(ViewNames.QuestionnaireTemplatesList, requestedViewName);</code> <br> <b></b> <br>          ,        . <br>   <br>       , . <span class="hljs-string"><span class="hljs-string">"Trees in WPF"</span></span>  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ms753391.aspx">http://msdn.microsoft.com/en-us/library/ms753391.aspx</a> <br> <br>       , . <span class="hljs-string"><span class="hljs-string">"Attached Properties Overview"</span></span>  MSDN: <a href="http://msdn.microsoft.com/en-us/library/cc265152(VS.95).aspx">http://msdn.microsoft.com/en-us/library/cc265152(VS.<span class="hljs-number"><span class="hljs-number">95</span></span>).aspx</a> <br> <br>      MEF, .<span class="hljs-string"><span class="hljs-string">"Managed Extensibility Framework Overview"</span></span>  MSDN: <a href="http://msdn.microsoft.com/en-us/library/dd460648.aspx">http://msdn.microsoft.com/en-us/library/dd460648.aspx</a> . <br> <br>      Unity, .<span class="hljs-string"><span class="hljs-string">"Unity Application Block"</span></span>  MSDN: <a href="http://www.msdn.com/unity">http://www.msdn.com/unity</a> . <br> <br>      <code>DelegateCommand</code> , .Chapter <span class="hljs-number"><span class="hljs-number">5</span></span>, <span class="hljs-string"><span class="hljs-string">" </span></span><a href="http://msdn.microsoft.com/en-us/library/gg405484(v%3DPandP.40).aspx"><span class="hljs-string"><span class="hljs-string">Implementing the MVVM Pattern</span></span></a><span class="hljs-string"><span class="hljs-string"> ."</span></span> <br> <br>        Microsoft Expression Blend, .<span class="hljs-string"><span class="hljs-string">"Working with built-in behaviors"</span></span>  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ff724013(v%3DExpression.40).aspx">http://msdn.microsoft.com/en-us/library/ff724013(v=Expression.<span class="hljs-number"><span class="hljs-number">40</span></span>).aspx</a> . <br> <br>          Microsoft Expression Blend, .<span class="hljs-string"><span class="hljs-string">"Creating Custom Behaviors"</span></span>  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ff724708(v%3DExpression.40).aspx">http://msdn.microsoft.com/en-us/library/ff724708(v=Expression.<span class="hljs-number"><span class="hljs-number">40</span></span>).aspx</a> . <br> <br>            Microsoft Expression Blend, .<span class="hljs-string"><span class="hljs-string">"Creating Custom Triggers and Actions"</span></span>  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ff724707(v%3DExpression.40).aspx">http://msdn.microsoft.com/en-us/library/ff724707(v=Expression.<span class="hljs-number"><span class="hljs-number">40</span></span>).aspx</a> . <br> <br>         WPF  Silverlight, .<span class="hljs-string"><span class="hljs-string">"Threading Model"</span></span>  <span class="hljs-string"><span class="hljs-string">"The Dispatcher Class"</span></span>  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ms741870.aspx">http://msdn.microsoft.com/en-us/library/ms741870.aspx</a> <br> <a href="http://msdn.microsoft.com/en-us/library/ms615907(v%3DVS.95).aspx">http://msdn.microsoft.com/en-us/library/ms615907(v=VS.<span class="hljs-number"><span class="hljs-number">95</span></span>).aspx</a> . <br> <br>      unit-  Silverlight, .<span class="hljs-string"><span class="hljs-string">"Unit Testing with Silverlight 2"</span></span>: <a href="http://www.jeff.wilcox.name/2008/03/silverlight2-unit-testing/">http://www.jeff.wilcox.name/<span class="hljs-number"><span class="hljs-number">2008</span></span>/<span class="hljs-number"><span class="hljs-number">03</span></span>/silverlight2-unit-testing/</a> . <br> <br>         , .  <span class="hljs-string"><span class="hljs-string">" </span></span><a href="http://msdn.microsoft.com/en-us/library/gg430861(v%3DPandP.40).aspx"><span class="hljs-string"><span class="hljs-string">View-Based Navigation</span></span></a><span class="hljs-string"><span class="hljs-string"> "</span></span> in Chapter <span class="hljs-number"><span class="hljs-number">8</span></span>, <span class="hljs-string"><span class="hljs-string">" </span></span><a href="http://msdn.microsoft.com/en-us/library/gg430861(v%3DPandP.40).aspx"><span class="hljs-string"><span class="hljs-string">Navigation</span></span></a><span class="hljs-string"><span class="hljs-string"> ."</span></span> <br> <br>       ,   , .<span class="hljs-string"><span class="hljs-string">"Event-based Asynchronous Pattern Overview"</span></span>  MSDN: <a href="http://msdn.microsoft.com/en-us/library/wewwczdw.aspx">http://msdn.microsoft.com/en-us/library/wewwczdw.aspx</a> <br> <br>        <code>IAsyncResult</code> , .<span class="hljs-string"><span class="hljs-string">"Asynchronous Programming Overview"</span></span>  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ms228963.aspx">http://msdn.microsoft.com/en-us/library/ms228963.aspx</a></code></code></code></code></code></code></code></code></code> </pre> <code><code><code><code>CommandBehaviorBase ,    ,    ICommand</code> .           <code>CanExecuteChanged</code> ,          Silverlight,    WPF. <br> <br>    ,  ,   <code>CommandBehaviorBase    ,    .         ,      .         ,    .      ButtonBaseClickCommandBehavior</code> . <br> <br> <code class="cs">public class ButtonBaseClickCommandBehavior : CommandBehaviorBase&lt;ButtonBase&gt; { public ButtonBaseClickCommandBehavior(ButtonBase clickableObject) : base(clickableObject) { clickableObject.Click += OnClick; } private void OnClick(object sender, System.Windows.RoutedEventArgs e) { ExecuteCommand(); } }</code> <br>   <code>CommandBehaviorBase ,     .     ,          ,   . ,    ,    ,      , ,    CanExecute</code>  ,     . <br> <br>          ,   .           XAML.           .       .  Prism      ,       ,  ,   .       ,    . , ,  ,      <code>Click</code> ,       <code>Command</code> .    <code>Click.Command</code> ,  . <br> <br>             .             . <br> <br> <code class="cs">public static readonly DependencyProperty CommandProperty = DependencyProperty.RegisterAttached( "Command", typeof(ICommand), typeof(Click), new PropertyMetadata(OnSetCommandCallback)); private static readonly DependencyProperty ClickCommandBehaviorProperty = DependencyProperty.RegisterAttached( "ClickCommandBehavior", typeof(ButtonBaseClickCommandBehavior), typeof(Click), null);</code> <br>    <code>Command</code>    <code>ButtonBaseClickCommandBehavior</code> ,     <code>OnSetCommandCallback</code> ,     . <br> <br> <code class="cs">private static void OnSetCommandCallback(DependencyObject dependencyObject, DependencyPropertyChangedEventArgs e) { ButtonBase buttonBase = dependencyObject as ButtonBase; if (buttonBase != null) { ButtonBaseClickCommandBehavior behavior = GetOrCreateBehavior(buttonBase); behavior.Command = e.NewValue as ICommand; } } private static void OnSetCommandParameterCallback(DependencyObject dependencyObject, DependencyPropertyChangedEventArgs e) { ButtonBase buttonBase = dependencyObject as ButtonBase; if (buttonBase != null) { ButtonBaseClickCommandBehavior behavior = GetOrCreateBehavior(buttonBase); behavior.CommandParameter = e.NewValue; } } private static ButtonBaseClickCommandBehavior GetOrCreateBehavior(ButtonBase buttonBase ) { ButtonBaseClickCommandBehavior behavior = buttonBase.GetValue(ClickCommandBehaviorProperty) as ButtonBaseClickCommandBehavior; if ( behavior == null ) { behavior = new ButtonBaseClickCommandBehavior(buttonBase); buttonBase.SetValue(ClickCommandBehaviorProperty, behavior); } return behavior; }</code> <br>        ,  <a href="http://msdn.microsoft.com/en-us/library/cc265152(VS.95).aspx">Attached Properties Overview</a>  MSDN. <br> <br>    <br>              . ,     Silverlight,    -,     ,      ,     .     ,       . <br> <br>        ,    ( )  ,  ,     .  UI       ,            UI. <br> <br>      - <br>   -     ,       <code>IAsyncResult</code> .   ,  ,   ,  <code>GetQuestionnaire</code> ,   : <code>BeginGetQuestionnaire</code>  <code>EndGetQuestionnaire</code> .    ,   <code>BeginGetQuestionnaire</code> .     ,   ,   <code>EndGetQuestionnaire</code>    . <br> <b></b> <br>  .NET Framework 4.5      <code>await</code>  <code>async</code>     <code>*Async</code> .      <a href="http://msdn.microsoft.com/en-us/library/vstudio/hh391443.aspx">"Asynchronous Programming with Async and Await (C# and Visual Basic)"</a> . <br>  ,    <code>EndGetQuestionnaire</code> ,      ,  ()      <code>BeginGetQuestionnaire</code> .     ,      ,   <code>EndGetQuestionnaire</code> ,   . <br> <br> <code class="xml">IAsyncResult asyncResult = this.service.BeginGetQuestionnaire( GetQuestionnaireCompleted, null //  ,      ); private void GetQuestionnaireCompleted(IAsyncResult result) { try { questionnaire = this.service.EndGetQuestionnaire(ar); } catch (Exception ex) { //  -   . } }</code> <br>  ,     <code>End*</code> (  , <code>EndGetQuestionnaire</code> ),    ,      .      , ,          UI.     ,   ,        . <br> <br>        UI,     -,      UI,         UI,   <code>Dispatcher</code>    <code>SynchronizationContext</code> .  WPF  Silverlight,   <code>Dispatcher</code> . <br> <br>      <code>Questionnaire</code>  ,        <code>QuestionnaireView</code> .  Silverlight    <code>CheckAccess</code> ,  ,      UI.  ,     <code>BeginInvoke</code> ,      UI. <br> <br> <code class="cs">var dispatcher = System.Windows.Deployment.Current.Dispatcher; if (dispatcher.CheckAccess()) { QuestionnaireView.DataContext = questionnaire; } else { dispatcher.BeginInvoke(() =&gt; { Questionnaire.DataContext = questionnaire; }); }</code> <br> <i>MVVM RI</i>   ,    ,   <code>IAsyncResult</code> ,   .      ,                 . ,       . <br> <br> <code class="cs">this.questionnaireRepository.GetQuestionnaireAsync( result =&gt; { this.Questionnaire = result.Result; });</code> <br>  <code>result</code>   ,     , , , .    ,     . <br> <br> <code class="cs">this.questionnaireRepository.GetQuestionnaireAsync( result =&gt; { if (result.Error == null) { this.Questionnaire = result.Result; ... } else { // Handle error. } })</code> <br>     <br>        ,      .     , ,             .        ,      ,     ,     . <br> <br>         ,      MVVM,     ,   . ,  -MVVM ,     <code>MessageBox</code>   code-behind UI,      .   MVVM     ,          . <br> <br>     MVVM,              ,          .      ,    ,   ,  ,     . <br> <br>              MVVM.      ,     ,     ,  ,     .    ,         ,     ,          .       . <br> <br>    <br>                  .        ,        .  ,         .         . <br> <br>  ,         ,         ,  .      ,     .           ,       . ,        WPF  Silverlight,        . <br> <br> <img title="Using the service to interact with the user." src="https://habrastorage.org/getpro/habr/post_images/4b5/397/f2d/4b5397f2d02e5851195b29f1893be6fc.png" alt=" ,    ."> <br> <br>  ,   <code>MessageBox</code>        ,     ,    ,     . <br> <br> <code class="cs">var result = interactionService.ShowMessageBox( "Are you sure you want to cancel this operation?", "Confirm", MessageBoxButton.OK); if (result == MessageBoxResult.Yes) { CancelRequest(); }</code> <br> ,      - ,      ,         Silverlight.         .             .     . <br> <br> <code class="cs">interactionService.ShowMessageBox( "Are you sure you want to cancel this operation?", "Confirm", MessageBoxButton.OK, result =&gt; { if (result == MessageBoxResult.Yes) { CancelRequest(); } });</code> <br>         ,      . ,  WPF    <code>MessageBox</code> ,       ;    Silverlight    ,    . <br> <br>     <br>         ‚Äì             .         ,      .     ,     .        ,        ,   ,     . <br> <br> <img title="Using interaction request objects." src="https://habrastorage.org/getpro/habr/post_images/3d0/ff0/1c5/3d0ff01c5518558c2d3c5c5f47ce0ce9.png" alt="   ."> <br> <br>    ,   ,          ‚Äì       ,      ,   ‚Äì     .   ,        ,    ,    UI            . <br> <br>       MVVM,     ,       ,         .         ,        ,    ,   . <br> <br>  Prism       <code>IInteractionRequest</code>   <code><code>InteractionRequest .  IInteractionRequest</code>  ,   .           ,   .  <code><code>InteractionRequest   IInteractionRequest</code>     <code>Raise</code> ,           , , ,   . <br> <br>       <br>  <code><code>InteractionRequest          .  Raise</code>          ( <code>T</code> )    ,    ,   .          ,       .      ,        .    ,  ,     . <br> <code class="cs">public interface IInteractionRequest { event EventHandler&lt;InteractionRequestedEventArgs&gt; Raised; } public class InteractionRequest&lt;T&gt; : IInteractionRequest { public event EventHandler&lt;InteractionRequestedEventArgs&gt; Raised; public void Raise(T context, Action&lt;T&gt; callback) { var handler = this.Raised; if (handler != null) { handler( this, new InteractionRequestedEventArgs(context, () =&gt; callback(context))); } } }</code> <br> Prism    ,      .  <code>Notification</code>       .    ,            .     ‚Äì <code>Title</code>  <code>Content</code> ,    .  ,   ,  ,  ,        . <br> <br>  <code>Confirmation</code>    <code>Notification</code>     ‚Äì <code>Confirmed</code> ,  ,  ,      .  <code>Confirmation</code> ,     <code>MessageBox</code> ,     /  .     ,     <code>Notification</code> ,     ,      . <br> <br>    <code><code><code>InteractionRequest ,       InteractionRequest      ,      .      ,    Raise</code> ,    , ,   . <br> <br> <code class="cs">public IInteractionRequest ConfirmCancelInteractionRequest { get { return this.confirmCancelInteractionRequest; } } this.confirmCancelInteractionRequest.Raise( new Confirmation("Are you sure you wish to cancel?"), confirmation =&gt; { if (confirmation.Confirmed) { this.NavigateToQuestionnaireList(); } }); }</code> <br> <i>MVVM Reference Implementation (MVVM RI)</i> ,    <code>IInteractionRequest</code>   <code><code>InteractionRequest ,          (. QuestionnaireViewModel.cs</code> ). <br> <br>        <br>       ,       .   ,       .    UI             . <br> <br>                . Microsoft Expression Blend Behaviors Framework     .  ,     ,    . <br> <br>  <code>EventTrigger</code> ,  Expression Blend,  ,      ,     ,   . , Prism   <code>EventTrigger</code> ,  <code>InteractionRequestTrigger</code> ,      <code>Raised</code>   <code>IInteractionRequest</code> .    XAML        . <br> <br>  ,   , <code>InteractionRequestTrigger</code>   .  Silverlight Prism   <code>PopupChildWindowAction</code> ,     .    ,         .   <code>ContentTemplate</code>  <code>PopupChildWindowAction</code> ,    ,    UI,      <code>Content</code>  .       <code>Title</code>  . <br> <b></b> <br>  ,    ,   <code>PopupChildWindowAction</code> ,     .    <code>Notification</code>  <code>NotificationChildWindow</code> ,        <code>Confirmation</code> ‚Äì <code>ConfirmationChildWindow</code> . <code>NotificationChildWindow</code>    ,   ,     <code>ConfirmationChildWindow</code>    <i>OK</i>  <i>Cancel</i> ,    .    ,   ,   <code>ChildWindow</code>  <code>PopupChildWindowAction</code> . <br>   ,  <code>InteractionRequestTrigger</code>  <code>PopupChildWindowAction</code> ,       <i>RI MVVM</i> . <br> <br> <code class="xml">&lt;i:Interaction.Triggers&gt; &lt;prism:InteractionRequestTrigger SourceObject="{Binding ConfirmCancelInteractionRequest}"&gt; &lt;prism:PopupChildWindowAction ContentTemplate="{StaticResource ConfirmWindowTemplate}"/&gt; &lt;/prism:InteractionRequestTrigger&gt; &lt;/i:Interaction.Triggers&gt; &lt;UserControl.Resources&gt; &lt;DataTemplate x:Key="ConfirmWindowTemplate"&gt; &lt;Grid MinWidth="250" MinHeight="100"&gt; &lt;TextBlock TextWrapping="Wrap" Grid.Row="0" Text="{Binding}"/&gt; &lt;/Grid&gt; &lt;/DataTemplate&gt; &lt;/UserControl.Resources&gt;</code> <br> <b></b> <br>      <code>ContentTemplate</code> ,   UI   <code>Content</code>  .    <code>Content</code>  ,  , <code>TextBlock</code>     <code>Content</code> . <br>      ,     ,    ,    .  ,     ,       ,     ,    .   ,   <i>RI MVVM</i> ,         <code>Confirmed</code>    <code>Confirmation</code>  <code>true</code> ,     OK. <br> <br>        ,     .  Prism <code>InteractionRequestTrigger</code>   <code>PopupChildWindowAction</code>            . <br> <br>     <br>     MVVM,       , ,    ,         .        (  , ,  ,   ).    ,  ,  ,            . <br> <br>        ,         . Managed Extensibility Framework (MEF)  Unity Application Block (Unity)      ,  ,           . <br> <br>  ,       , , ,    ( )      . ,       ,     .  ,     ,       . <br> <br>     ,  MEF <br>  MEF,       ,   <code>Import</code> ,      ,  ,   <code>Export</code> .         ,    . <br> <br> , <code>QuestionnaireView</code>   <i>RI MVVM</i> ,        ,    <code>Import</code> .   , MEF           .  <code>set</code>        ,   . <br> <br> <code class="cs">[Import] public QuestionnaireViewModel ViewModel { set { this.DataContext = value; } }</code> <br>     ,   . <br> <br> <code class="cs">[Export] public class QuestionnaireViewModel : NotificationObject { ... }</code> <br>        ,   . <br> <br> <code class="cs">public QuestionnaireView() { InitializeComponent(); } [ImportingConstructor] public QuestionnaireView(QuestionnaireViewModel viewModel) : this() { this.DataContext = viewModel; }</code> <br> <b></b> <br>          MEF,   Unity.   ,     ,        .   ,   Visual Studio  Expression Blend, ,        ,     .   ,   ,  ,      ,          <code>InitializeComponent</code> . <br>     ,  Unity <br>  Unity,    ,   MEF.     ,      .    ,         .  ,      . <br> <br>  ,      ,  ,         . ,           ,   . <br> <br> <code class="cs">public QuestionnaireView() { InitializeComponent(); } public QuestionnaireView(QuestionnaireViewModel viewModel) : this() { this.DataContext = viewModel; }</code> <br> <b></b> <br>    ,        ,   Visual Studio  Expression Blend. <br>  ,          ,   . Unity        <code>set</code>   ,   . <br> <br> <code class="cs">public QuestionnaireView() { InitializeComponent(); } [Dependency] public QuestionnaireViewModel ViewModel { set { this.DataContext = value; } }</code> <br>       Unity. <br> <br> <code class="cs">container.RegisterType&lt;QuestionnaireViewModel&gt;();</code> <br>  ,     . <br> <br> <code class="cs">var view = container.Resolve&lt;QuestionnaireView&gt;();</code> <br>     ,    <br>   ,     ,        .        ,   MEF  Unity,        . <br> <br>          .   ,         UI,           . <br> <br> , <i>RI MVVM</i>   ,   ,        .   ,    .      <code>ShowView</code>   UI. <br> <br> <code class="cs">private void NavigateToQuestionnaireList() { //     "questionnaire list". this.uiService.ShowView(ViewNames.QuestionnaireTemplatesList); }</code> <br>  UI      UI .           UI.  <code>ShowView</code>  <code>UIService</code>      (,          ),       ,   . <br> <br> <code class="cs">public void ShowView(string viewName) { var view = this.ViewFactory.GetView(viewName); this.MainWindow.CurrentView = view; }</code> <br> <b></b> <br> Prism       .   ,   ,   ,             .    ,  , " <a href="http://msdn.microsoft.com/en-us/library/gg430861(v%3DPandP.40).aspx">View-Based Navigation</a> "   8, " <a href="http://msdn.microsoft.com/en-us/library/gg430861(v%3DPandP.40).aspx">Navigation</a> ". <br>  MVVM  <br>        MVVM      .           -      mocking . ,   ,        . <br> <br>   <i>INotifyPropertyChanged</i> <br>   <code>INotifyPropertyChanged</code>     ,      .      ,    ;   ,   ,     ,    ,       . <br> <br>   <br> ,       ,           <code>PropertyChanged</code>  ,         .  ,    <code>ChangeTracker</code> ,     MVVM,  ,      .      .     ,    . <br> <br> <code class="cs">var changeTracker = new PropertyChangeTracker(viewModel); viewModel.CurrentState = "newState"; CollectionAssert.Contains(changeTracker.ChangedProperties, "CurrentState");</code> <br> ,     ,     <code>INotifyPropertyChanged</code> ,    ,   ,     . <br> <br>      <br>        ,   ,    <code>set</code>      ,           . ,     ,     ,      ,          . <br> <br> <code class="cs">var changeTracker = new PropertyChangeTracker(viewModel); var question = viewModel.Questions.First() as OpenQuestionViewModel; question.Question.Response = "some text"; CollectionAssert.Contains(changeTracker.ChangedProperties, "UnansweredQuestions");</code> <br>      <br>     <code>INotifyPropertyChanged</code> ,      <code>PropertyChanged</code>        ,  ,     , , .        ,       . <br> <br>   <i>INotifyDataErrorInfo</i> <br>   ,     ,    ,   ,   <code>IDataErrorInfo</code> ,  ( Silverlight)   <code>INotifyDataErrorInfo</code> .   <code>INotifyDataErrorInfo</code>   ,         ,    ,  ,   ,    . <br> <br>       <code>INotifyDataErrorInfo</code> : ,     ,  ,     ,     <code>ErrorsChanged</code> ,      <code>GetErrors</code> , . <br> <br>    <br>     ,      ,     .       ,         <code>GetErrors</code>       ,  ,  ,   .    , ,  ,     ,        .   ,        . <br> <br> <code class="cs">//  . var notifyErrorInfo = (INotifyDataErrorInfo)question; question.Response = -15; Assert.IsTrue(notifyErrorInfo.GetErrors("Response").Cast&lt;ValidationResult&gt;().Any()); //  . var notifyErrorInfo = (INotifyDataErrorInfo)question; question.Response = 15; Assert.IsFalse(notifyErrorInfo.GetErrors("Response").Cast&lt;ValidationResult&gt;().Any());</code> <br>    ,    ,             . <br> <br>    <i>INotifyDataErrorInfo</i> <br>       <code>GetErrors</code> ,   <code>INotifyDataErrorInfo</code>  ,   <code>ErrorsChanged</code>      <code>GetErrors</code> . ,  <code>HasErrors</code>      ,  . <br> <br>       <code>INotifyDataErrorInfo</code> . , ,           ,   -  .      ,        <code>INotifyDataErrorInfo</code>         (,        ). <br> <br>     ,   ,  : <br>  <code>HasErrors</code>     .              ,       .  <code>ErrorsChanged</code> ,      ,         <code>GetErrors</code> .         ( ,  )     ,           .    <code>GetErrors</code>       <code>ErrorsChanged</code> . <br>    <code>INotifyPropertyChanged</code> ,  ,    <code>NotifyDataErrorInfoTestHelper</code>    MVVM,        <code>INotifyDataErrorInfo</code> ,       .   ,   ,      ,   .      . <br> <code class="cs">var helper = new NotifyDataErrorInfoTestHelper&lt;NumericQuestion, int?&gt;( question, q =&gt; q.Response); helper.ValidatePropertyChange( 6, NotifyDataErrorInfoBehavior.Nothing); helper.ValidatePropertyChange( 20, NotifyDataErrorInfoBehavior.FiresErrorsChanged | NotifyDataErrorInfoBehavior.HasErrors | NotifyDataErrorInfoBehavior.HasErrorsForProperty); helper.ValidatePropertyChange( null, NotifyDataErrorInfoBehavior.FiresErrorsChanged | NotifyDataErrorInfoBehavior.HasErrors | NotifyDataErrorInfoBehavior.HasErrorsForProperty); helper.ValidatePropertyChange( 2, NotifyDataErrorInfoBehavior.FiresErrorsChanged);</code> <br>     <br>   MVVM,     ,  .   ,    ,         . <br> <br>  ,     ,     ,       .   ,   , ,       ,     ,   <code>IAsyncResult</code>    ,  - ,   ,    UI. <br> <br>       , , ,    .   ,     .  ,      UI,     ,   ,          ,     ,        "   UI." <br> <br>     ,    ,    .   ,    ,     mock-, ,   ,   ,      ,          . <br> <br>           UI,    ,    .   ,     ,   ,      .        ,   .     ,    ,     . <br> <br> <code class="cs">questionnaireRepositoryMock .Setup( r =&gt; r.SubmitQuestionnaireAsync( It.IsAny&lt;Questionnaire&gt;(), It.IsAny&lt;Action&lt;IOperationResult&gt;&gt;())) .Callback&lt;Questionnaire, Action&lt;IOperationResult&gt;&gt;( (q, a) =&gt; callback = a); uiServicemock .Setup(svc =&gt; svc.ShowView(ViewNames.QuestionnaireTemplatesList)) .Callback&lt;string&gt;(viewName =&gt; requestedViewName = viewName); submitResultMock .Setup(sr =&gt; sr.Error) .Returns&lt;Exception&gt;(null); CompleteQuestionnaire(viewModel); viewModel.Submit(); //      UI . callback(submitResultMock.Object); //    ‚Äì     . Assert.AreEqual(ViewNames.QuestionnaireTemplatesList, requestedViewName);</code> <br> <b></b> <br>          ,        . <br>   <br>       , . "Trees in WPF"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ms753391.aspx">http://msdn.microsoft.com/en-us/library/ms753391.aspx</a> <br> <br>       , . "Attached Properties Overview"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/cc265152(VS.95).aspx">http://msdn.microsoft.com/en-us/library/cc265152(VS.95).aspx</a> <br> <br>      MEF, ."Managed Extensibility Framework Overview"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/dd460648.aspx">http://msdn.microsoft.com/en-us/library/dd460648.aspx</a> . <br> <br>      Unity, ."Unity Application Block"  MSDN: <a href="http://www.msdn.com/unity">http://www.msdn.com/unity</a> . <br> <br>      <code>DelegateCommand</code> , .Chapter 5, " <a href="http://msdn.microsoft.com/en-us/library/gg405484(v%3DPandP.40).aspx">Implementing the MVVM Pattern</a> ." <br> <br>        Microsoft Expression Blend, ."Working with built-in behaviors"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ff724013(v%3DExpression.40).aspx">http://msdn.microsoft.com/en-us/library/ff724013(v=Expression.40).aspx</a> . <br> <br>          Microsoft Expression Blend, ."Creating Custom Behaviors"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ff724708(v%3DExpression.40).aspx">http://msdn.microsoft.com/en-us/library/ff724708(v=Expression.40).aspx</a> . <br> <br>            Microsoft Expression Blend, ."Creating Custom Triggers and Actions"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ff724707(v%3DExpression.40).aspx">http://msdn.microsoft.com/en-us/library/ff724707(v=Expression.40).aspx</a> . <br> <br>         WPF  Silverlight, ."Threading Model"  "The Dispatcher Class"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ms741870.aspx">http://msdn.microsoft.com/en-us/library/ms741870.aspx</a> <br> <a href="http://msdn.microsoft.com/en-us/library/ms615907(v%3DVS.95).aspx">http://msdn.microsoft.com/en-us/library/ms615907(v=VS.95).aspx</a> . <br> <br>      unit-  Silverlight, ."Unit Testing with Silverlight 2": <a href="http://www.jeff.wilcox.name/2008/03/silverlight2-unit-testing/">http://www.jeff.wilcox.name/2008/03/silverlight2-unit-testing/</a> . <br> <br>         , .  " <a href="http://msdn.microsoft.com/en-us/library/gg430861(v%3DPandP.40).aspx">View-Based Navigation</a> " in Chapter 8, " <a href="http://msdn.microsoft.com/en-us/library/gg430861(v%3DPandP.40).aspx">Navigation</a> ." <br> <br>       ,   , ."Event-based Asynchronous Pattern Overview"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/wewwczdw.aspx">http://msdn.microsoft.com/en-us/library/wewwczdw.aspx</a> <br> <br>        <code>IAsyncResult</code> , ."Asynchronous Programming Overview"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ms228963.aspx">http://msdn.microsoft.com/en-us/library/ms228963.aspx</a></code></code></code></code></code></code></code></code></code> <pre> <code class="hljs cmake"><code>CommandBehaviorBase ,    ,    ICommand</code> .           <code>CanExecuteChanged</code> ,          Silverlight,    WPF. <br> <br>    ,  ,   <code><code>CommandBehaviorBase    ,    .         ,      .         ,    .      ButtonBaseClickCommandBehavior</code> . <br> <br> <code class="cs">public class ButtonBaseClickCommandBehavior : CommandBehaviorBase&lt;ButtonBase&gt; { public ButtonBaseClickCommandBehavior(ButtonBase clickableObject) : base(clickableObject) { clickableObject.Click += OnClick; } private void OnClick(object sender, System.Windows.RoutedEventArgs e) { ExecuteCommand(); } }</code> <br>   <code><code>CommandBehaviorBase ,     .     ,          ,   . ,    ,    ,      , ,    CanExecute</code>  ,     . <br> <br>          ,   .           XAML.           .       .  Prism      ,       ,  ,   .       ,    . , ,  ,      <code>Click</code> ,       <code><span class="hljs-keyword"><span class="hljs-keyword">Command</span></span></code> .    <code>Click.<span class="hljs-keyword"><span class="hljs-keyword">Command</span></span></code> ,  . <br> <br>             .             . <br> <br> <code class="cs">public static readonly DependencyProperty CommandProperty = DependencyProperty.RegisterAttached( <span class="hljs-string"><span class="hljs-string">"Command"</span></span>, typeof(ICommand), typeof(Click), new PropertyMetadata(OnSetCommandCallback)); private static readonly DependencyProperty ClickCommandBehaviorProperty = DependencyProperty.RegisterAttached( <span class="hljs-string"><span class="hljs-string">"ClickCommandBehavior"</span></span>, typeof(ButtonBaseClickCommandBehavior), typeof(Click), null);</code> <br>    <code><span class="hljs-keyword"><span class="hljs-keyword">Command</span></span></code>    <code>ButtonBaseClickCommandBehavior</code> ,     <code>OnSetCommandCallback</code> ,     . <br> <br> <code class="cs">private static void OnSetCommandCallback(DependencyObject dependencyObject, DependencyPropertyChangedEventArgs e) { ButtonBase buttonBase = dependencyObject as ButtonBase; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (buttonBase != null) { ButtonBaseClickCommandBehavior behavior = GetOrCreateBehavior(buttonBase); behavior.<span class="hljs-keyword"><span class="hljs-keyword">Command</span></span> = e.NewValue as ICommand; } } private static void OnSetCommandParameterCallback(DependencyObject dependencyObject, DependencyPropertyChangedEventArgs e) { ButtonBase buttonBase = dependencyObject as ButtonBase; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (buttonBase != null) { ButtonBaseClickCommandBehavior behavior = GetOrCreateBehavior(buttonBase); behavior.CommandParameter = e.NewValue; } } private static ButtonBaseClickCommandBehavior GetOrCreateBehavior(ButtonBase buttonBase ) { ButtonBaseClickCommandBehavior behavior = buttonBase.GetValue(ClickCommandBehaviorProperty) as ButtonBaseClickCommandBehavior; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ( behavior == null ) { behavior = new ButtonBaseClickCommandBehavior(buttonBase); buttonBase.SetValue(ClickCommandBehaviorProperty, behavior); } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> behavior; }</code> <br>        ,  <a href="http://msdn.microsoft.com/en-us/library/cc265152(VS.95).aspx">Attached Properties Overview</a>  MSDN. <br> <br>    <br>              . ,     Silverlight,    -,     ,      ,     .     ,       . <br> <br>        ,    ( )  ,  ,     .  UI       ,            UI. <br> <br>      - <br>   -     ,       <code>IAsyncResult</code> .   ,  ,   ,  <code>GetQuestionnaire</code> ,   : <code>BeginGetQuestionnaire</code>  <code>EndGetQuestionnaire</code> .    ,   <code>BeginGetQuestionnaire</code> .     ,   ,   <code>EndGetQuestionnaire</code>    . <br> <b></b> <br>  .NET Framework <span class="hljs-number"><span class="hljs-number">4.5</span></span>      <code>await</code>  <code>async</code>     <code>*Async</code> .      <a href="http://msdn.microsoft.com/en-us/library/vstudio/hh391443.aspx"><span class="hljs-string"><span class="hljs-string">"Asynchronous Programming with Async and Await (C# and Visual Basic)"</span></span></a> . <br>  ,    <code>EndGetQuestionnaire</code> ,      ,  ()      <code>BeginGetQuestionnaire</code> .     ,      ,   <code>EndGetQuestionnaire</code> ,   . <br> <br> <code class="xml">IAsyncResult asyncResult = this.service.BeginGetQuestionnaire( GetQuestionnaireCompleted, null //  ,      ); private void GetQuestionnaireCompleted(IAsyncResult result) { try { questionnaire = this.service.EndGetQuestionnaire(ar); } catch (Exception ex) { //  -   . } }</code> <br>  ,     <code>End*</code> (  , <code>EndGetQuestionnaire</code> ),    ,      .      , ,          UI.     ,   ,        . <br> <br>        UI,     -,      UI,         UI,   <code>Dispatcher</code>    <code>SynchronizationContext</code> .  WPF  Silverlight,   <code>Dispatcher</code> . <br> <br>      <code>Questionnaire</code>  ,        <code>QuestionnaireView</code> .  Silverlight    <code>CheckAccess</code> ,  ,      UI.  ,     <code>BeginInvoke</code> ,      UI. <br> <br> <code class="cs">var dispatcher = System.Windows.Deployment.Current.Dispatcher; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (dispatcher.CheckAccess()) { QuestionnaireView.DataContext = questionnaire; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { dispatcher.BeginInvoke(() =&gt; { Questionnaire.DataContext = questionnaire; }); }</code> <br> <i>MVVM RI</i>   ,    ,   <code>IAsyncResult</code> ,   .      ,                 . ,       . <br> <br> <code class="cs">this.questionnaireRepository.GetQuestionnaireAsync( result =&gt; { this.Questionnaire = result.Result; });</code> <br>  <code>result</code>   ,     , , , .    ,     . <br> <br> <code class="cs">this.questionnaireRepository.GetQuestionnaireAsync( result =&gt; { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (result.Error == null) { this.Questionnaire = result.Result; ... } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { // Handle error. } })</code> <br>     <br>        ,      .     , ,             .        ,      ,     ,     . <br> <br>         ,      MVVM,     ,   . ,  -MVVM ,     <code>MessageBox</code>   code-behind UI,      .   MVVM     ,          . <br> <br>     MVVM,              ,          .      ,    ,   ,  ,     . <br> <br>              MVVM.      ,     ,     ,  ,     .    ,         ,     ,          .       . <br> <br>    <br>                  .        ,        .  ,         .         . <br> <br>  ,         ,         ,  .      ,     .           ,       . ,        WPF  Silverlight,        . <br> <br> <img title="Using the service to interact with the user." src="https://habrastorage.org/getpro/habr/post_images/4b5/397/f2d/4b5397f2d02e5851195b29f1893be6fc.png" alt=" ,    ."> <br> <br>  ,   <code>MessageBox</code>        ,     ,    ,     . <br> <br> <code class="cs">var result = interactionService.ShowMessageBox( <span class="hljs-string"><span class="hljs-string">"Are you sure you want to cancel this operation?"</span></span>, <span class="hljs-string"><span class="hljs-string">"Confirm"</span></span>, MessageBoxButton.OK); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (result == MessageBoxResult.Yes) { CancelRequest(); }</code> <br> ,      - ,      ,         Silverlight.         .             .     . <br> <br> <code class="cs">interactionService.ShowMessageBox( <span class="hljs-string"><span class="hljs-string">"Are you sure you want to cancel this operation?"</span></span>, <span class="hljs-string"><span class="hljs-string">"Confirm"</span></span>, MessageBoxButton.OK, result =&gt; { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (result == MessageBoxResult.Yes) { CancelRequest(); } });</code> <br>         ,      . ,  WPF    <code>MessageBox</code> ,       ;    Silverlight    ,    . <br> <br>     <br>         ‚Äì             .         ,      .     ,     .        ,        ,   ,     . <br> <br> <img title="Using interaction request objects." src="https://habrastorage.org/getpro/habr/post_images/3d0/ff0/1c5/3d0ff01c5518558c2d3c5c5f47ce0ce9.png" alt="   ."> <br> <br>    ,   ,          ‚Äì       ,      ,   ‚Äì     .   ,        ,    ,    UI            . <br> <br>       MVVM,     ,       ,         .         ,        ,    ,   . <br> <br>  Prism       <code>IInteractionRequest</code>   <code><code>InteractionRequest .  IInteractionRequest</code>  ,   .           ,   .  <code><code>InteractionRequest   IInteractionRequest</code>     <code>Raise</code> ,           , , ,   . <br> <br>       <br>  <code><code>InteractionRequest          .  Raise</code>          ( <code>T</code> )    ,    ,   .          ,       .      ,        .    ,  ,     . <br> <code class="cs">public interface IInteractionRequest { event EventHandler&lt;InteractionRequestedEventArgs&gt; Raised; } public class InteractionRequest&lt;T&gt; : IInteractionRequest { public event EventHandler&lt;InteractionRequestedEventArgs&gt; Raised; public void Raise(T context, Action&lt;T&gt; callback) { var handler = this.Raised; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (handler != null) { handler( this, new InteractionRequestedEventArgs(context, () =&gt; callback(context))); } } }</code> <br> Prism    ,      .  <code>Notification</code>       .    ,            .     ‚Äì <code>Title</code>  <code>Content</code> ,    .  ,   ,  ,  ,        . <br> <br>  <code>Confirmation</code>    <code>Notification</code>     ‚Äì <code>Confirmed</code> ,  ,  ,      .  <code>Confirmation</code> ,     <code>MessageBox</code> ,     /  .     ,     <code>Notification</code> ,     ,      . <br> <br>    <code><code><code>InteractionRequest ,       InteractionRequest      ,      .      ,    Raise</code> ,    , ,   . <br> <br> <code class="cs">public IInteractionRequest ConfirmCancelInteractionRequest { get { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> this.confirmCancelInteractionRequest; } } this.confirmCancelInteractionRequest.Raise( new Confirmation(<span class="hljs-string"><span class="hljs-string">"Are you sure you wish to cancel?"</span></span>), confirmation =&gt; { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (confirmation.Confirmed) { this.NavigateToQuestionnaireList(); } }); }</code> <br> <i>MVVM Reference Implementation (MVVM RI)</i> ,    <code>IInteractionRequest</code>   <code><code>InteractionRequest ,          (. QuestionnaireViewModel.cs</code> ). <br> <br>        <br>       ,       .   ,       .    UI             . <br> <br>                . Microsoft Expression Blend Behaviors Framework     .  ,     ,    . <br> <br>  <code>EventTrigger</code> ,  Expression Blend,  ,      ,     ,   . , Prism   <code>EventTrigger</code> ,  <code>InteractionRequestTrigger</code> ,      <code>Raised</code>   <code>IInteractionRequest</code> .    XAML        . <br> <br>  ,   , <code>InteractionRequestTrigger</code>   .  Silverlight Prism   <code>PopupChildWindowAction</code> ,     .    ,         .   <code>ContentTemplate</code>  <code>PopupChildWindowAction</code> ,    ,    UI,      <code>Content</code>  .       <code>Title</code>  . <br> <b></b> <br>  ,    ,   <code>PopupChildWindowAction</code> ,     .    <code>Notification</code>  <code>NotificationChildWindow</code> ,        <code>Confirmation</code> ‚Äì <code>ConfirmationChildWindow</code> . <code>NotificationChildWindow</code>    ,   ,     <code>ConfirmationChildWindow</code>    <i>OK</i>  <i>Cancel</i> ,    .    ,   ,   <code>ChildWindow</code>  <code>PopupChildWindowAction</code> . <br>   ,  <code>InteractionRequestTrigger</code>  <code>PopupChildWindowAction</code> ,       <i>RI MVVM</i> . <br> <br> <code class="xml">&lt;i:Interaction.Triggers&gt; &lt;prism:InteractionRequestTrigger SourceObject=<span class="hljs-string"><span class="hljs-string">"{Binding ConfirmCancelInteractionRequest}"</span></span>&gt; &lt;prism:PopupChildWindowAction ContentTemplate=<span class="hljs-string"><span class="hljs-string">"{StaticResource ConfirmWindowTemplate}"</span></span>/&gt; &lt;/prism:InteractionRequestTrigger&gt; &lt;/i:Interaction.Triggers&gt; &lt;UserControl.Resources&gt; &lt;DataTemplate x:Key=<span class="hljs-string"><span class="hljs-string">"ConfirmWindowTemplate"</span></span>&gt; &lt;Grid MinWidth=<span class="hljs-string"><span class="hljs-string">"250"</span></span> MinHeight=<span class="hljs-string"><span class="hljs-string">"100"</span></span>&gt; &lt;TextBlock TextWrapping=<span class="hljs-string"><span class="hljs-string">"Wrap"</span></span> Grid.Row=<span class="hljs-string"><span class="hljs-string">"0"</span></span> Text=<span class="hljs-string"><span class="hljs-string">"{Binding}"</span></span>/&gt; &lt;/Grid&gt; &lt;/DataTemplate&gt; &lt;/UserControl.Resources&gt;</code> <br> <b></b> <br>      <code>ContentTemplate</code> ,   UI   <code>Content</code>  .    <code>Content</code>  ,  , <code>TextBlock</code>     <code>Content</code> . <br>      ,     ,    ,    .  ,     ,       ,     ,    .   ,   <i>RI MVVM</i> ,         <code>Confirmed</code>    <code>Confirmation</code>  <code><span class="hljs-keyword"><span class="hljs-keyword">true</span></span></code> ,     OK. <br> <br>        ,     .  Prism <code>InteractionRequestTrigger</code>   <code>PopupChildWindowAction</code>            . <br> <br>     <br>     MVVM,       , ,    ,         .        (  , ,  ,   ).    ,  ,  ,            . <br> <br>        ,         . Managed Extensibility Framework (MEF)  Unity Application Block (Unity)      ,  ,           . <br> <br>  ,       , , ,    ( )      . ,       ,     .  ,     ,       . <br> <br>     ,  MEF <br>  MEF,       ,   <code>Import</code> ,      ,  ,   <code><span class="hljs-keyword"><span class="hljs-keyword">Export</span></span></code> .         ,    . <br> <br> , <code>QuestionnaireView</code>   <i>RI MVVM</i> ,        ,    <code>Import</code> .   , MEF           .  <code><span class="hljs-keyword"><span class="hljs-keyword">set</span></span></code>        ,   . <br> <br> <code class="cs">[Import] public QuestionnaireViewModel ViewModel { <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> { this.DataContext = value; } }</code> <br>     ,   . <br> <br> <code class="cs">[<span class="hljs-keyword"><span class="hljs-keyword">Export</span></span>] public class QuestionnaireViewModel : NotificationObject { ... }</code> <br>        ,   . <br> <br> <code class="cs">public QuestionnaireView() { InitializeComponent(); } [ImportingConstructor] public QuestionnaireView(QuestionnaireViewModel viewModel) : this() { this.DataContext = viewModel; }</code> <br> <b></b> <br>          MEF,   Unity.   ,     ,        .   ,   Visual Studio  Expression Blend, ,        ,     .   ,   ,  ,      ,          <code>InitializeComponent</code> . <br>     ,  Unity <br>  Unity,    ,   MEF.     ,      .    ,         .  ,      . <br> <br>  ,      ,  ,         . ,           ,   . <br> <br> <code class="cs">public QuestionnaireView() { InitializeComponent(); } public QuestionnaireView(QuestionnaireViewModel viewModel) : this() { this.DataContext = viewModel; }</code> <br> <b></b> <br>    ,        ,   Visual Studio  Expression Blend. <br>  ,          ,   . Unity        <code><span class="hljs-keyword"><span class="hljs-keyword">set</span></span></code>   ,   . <br> <br> <code class="cs">public QuestionnaireView() { InitializeComponent(); } [Dependency] public QuestionnaireViewModel ViewModel { <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> { this.DataContext = value; } }</code> <br>       Unity. <br> <br> <code class="cs">container.RegisterType&lt;QuestionnaireViewModel&gt;();</code> <br>  ,     . <br> <br> <code class="cs">var view = container.Resolve&lt;QuestionnaireView&gt;();</code> <br>     ,    <br>   ,     ,        .        ,   MEF  Unity,        . <br> <br>          .   ,         UI,           . <br> <br> , <i>RI MVVM</i>   ,   ,        .   ,    .      <code>ShowView</code>   UI. <br> <br> <code class="cs">private void NavigateToQuestionnaireList() { //     <span class="hljs-string"><span class="hljs-string">"questionnaire list"</span></span>. this.uiService.ShowView(ViewNames.QuestionnaireTemplatesList); }</code> <br>  UI      UI .           UI.  <code>ShowView</code>  <code>UIService</code>      (,          ),       ,   . <br> <br> <code class="cs">public void ShowView(<span class="hljs-keyword"><span class="hljs-keyword">string</span></span> viewName) { var view = this.ViewFactory.GetView(viewName); this.MainWindow.CurrentView = view; }</code> <br> <b></b> <br> Prism       .   ,   ,   ,             .    ,  , <span class="hljs-string"><span class="hljs-string">" </span></span><a href="http://msdn.microsoft.com/en-us/library/gg430861(v%3DPandP.40).aspx"><span class="hljs-string"><span class="hljs-string">View-Based Navigation</span></span></a><span class="hljs-string"><span class="hljs-string"> "</span></span>   <span class="hljs-number"><span class="hljs-number">8</span></span>, <span class="hljs-string"><span class="hljs-string">" </span></span><a href="http://msdn.microsoft.com/en-us/library/gg430861(v%3DPandP.40).aspx"><span class="hljs-string"><span class="hljs-string">Navigation</span></span></a><span class="hljs-string"><span class="hljs-string"> "</span></span>. <br>  MVVM  <br>        MVVM      .           -      mocking . ,   ,        . <br> <br>   <i>INotifyPropertyChanged</i> <br>   <code>INotifyPropertyChanged</code>     ,      .      ,    ;   ,   ,     ,    ,       . <br> <br>   <br> ,       ,           <code>PropertyChanged</code>  ,         .  ,    <code>ChangeTracker</code> ,     MVVM,  ,      .      .     ,    . <br> <br> <code class="cs">var changeTracker = new PropertyChangeTracker(viewModel); viewModel.CurrentState = <span class="hljs-string"><span class="hljs-string">"newState"</span></span>; CollectionAssert.Contains(changeTracker.ChangedProperties, <span class="hljs-string"><span class="hljs-string">"CurrentState"</span></span>);</code> <br> ,     ,     <code>INotifyPropertyChanged</code> ,    ,   ,     . <br> <br>      <br>        ,   ,    <code><span class="hljs-keyword"><span class="hljs-keyword">set</span></span></code>      ,           . ,     ,     ,      ,          . <br> <br> <code class="cs">var changeTracker = new PropertyChangeTracker(viewModel); var question = viewModel.Questions.First() as OpenQuestionViewModel; question.Question.Response = <span class="hljs-string"><span class="hljs-string">"some text"</span></span>; CollectionAssert.Contains(changeTracker.ChangedProperties, <span class="hljs-string"><span class="hljs-string">"UnansweredQuestions"</span></span>);</code> <br>      <br>     <code>INotifyPropertyChanged</code> ,      <code>PropertyChanged</code>        ,  ,     , , .        ,       . <br> <br>   <i>INotifyDataErrorInfo</i> <br>   ,     ,    ,   ,   <code>IDataErrorInfo</code> ,  ( Silverlight)   <code>INotifyDataErrorInfo</code> .   <code>INotifyDataErrorInfo</code>   ,         ,    ,  ,   ,    . <br> <br>       <code>INotifyDataErrorInfo</code> : ,     ,  ,     ,     <code>ErrorsChanged</code> ,      <code>GetErrors</code> , . <br> <br>    <br>     ,      ,     .       ,         <code>GetErrors</code>       ,  ,  ,   .    , ,  ,     ,        .   ,        . <br> <br> <code class="cs">//  . var notifyErrorInfo = (INotifyDataErrorInfo)question; question.Response = -<span class="hljs-number"><span class="hljs-number">15</span></span>; Assert.IsTrue(notifyErrorInfo.GetErrors(<span class="hljs-string"><span class="hljs-string">"Response"</span></span>).Cast&lt;ValidationResult&gt;().Any()); //  . var notifyErrorInfo = (INotifyDataErrorInfo)question; question.Response = <span class="hljs-number"><span class="hljs-number">15</span></span>; Assert.IsFalse(notifyErrorInfo.GetErrors(<span class="hljs-string"><span class="hljs-string">"Response"</span></span>).Cast&lt;ValidationResult&gt;().Any());</code> <br>    ,    ,             . <br> <br>    <i>INotifyDataErrorInfo</i> <br>       <code>GetErrors</code> ,   <code>INotifyDataErrorInfo</code>  ,   <code>ErrorsChanged</code>      <code>GetErrors</code> . ,  <code>HasErrors</code>      ,  . <br> <br>       <code>INotifyDataErrorInfo</code> . , ,           ,   -  .      ,        <code>INotifyDataErrorInfo</code>         (,        ). <br> <br>     ,   ,  : <br>  <code>HasErrors</code>     .              ,       .  <code>ErrorsChanged</code> ,      ,         <code>GetErrors</code> .         ( ,  )     ,           .    <code>GetErrors</code>       <code>ErrorsChanged</code> . <br>    <code>INotifyPropertyChanged</code> ,  ,    <code>NotifyDataErrorInfoTestHelper</code>    MVVM,        <code>INotifyDataErrorInfo</code> ,       .   ,   ,      ,   .      . <br> <code class="cs">var helper = new NotifyDataErrorInfoTestHelper&lt;NumericQuestion, int?&gt;( question, q =&gt; q.Response); helper.ValidatePropertyChange( <span class="hljs-number"><span class="hljs-number">6</span></span>, NotifyDataErrorInfoBehavior.Nothing); helper.ValidatePropertyChange( <span class="hljs-number"><span class="hljs-number">20</span></span>, NotifyDataErrorInfoBehavior.FiresErrorsChanged | NotifyDataErrorInfoBehavior.HasErrors | NotifyDataErrorInfoBehavior.HasErrorsForProperty); helper.ValidatePropertyChange( null, NotifyDataErrorInfoBehavior.FiresErrorsChanged | NotifyDataErrorInfoBehavior.HasErrors | NotifyDataErrorInfoBehavior.HasErrorsForProperty); helper.ValidatePropertyChange( <span class="hljs-number"><span class="hljs-number">2</span></span>, NotifyDataErrorInfoBehavior.FiresErrorsChanged);</code> <br>     <br>   MVVM,     ,  .   ,    ,         . <br> <br>  ,     ,     ,       .   ,   , ,       ,     ,   <code>IAsyncResult</code>    ,  - ,   ,    UI. <br> <br>       , , ,    .   ,     .  ,      UI,     ,   ,          ,     ,        <span class="hljs-string"><span class="hljs-string">"   UI."</span></span> <br> <br>     ,    ,    .   ,    ,     mock-, ,   ,   ,      ,          . <br> <br>           UI,    ,    .   ,     ,   ,      .        ,   .     ,    ,     . <br> <br> <code class="cs">questionnaireRepositoryMock .Setup( r =&gt; r.SubmitQuestionnaireAsync( It.IsAny&lt;Questionnaire&gt;(), It.IsAny&lt;Action&lt;IOperationResult&gt;&gt;())) .Callback&lt;Questionnaire, Action&lt;IOperationResult&gt;&gt;( (q, a) =&gt; callback = a); uiServicemock .Setup(svc =&gt; svc.ShowView(ViewNames.QuestionnaireTemplatesList)) .Callback&lt;<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>&gt;(viewName =&gt; requestedViewName = viewName); submitResultMock .Setup(sr =&gt; sr.Error) .Returns&lt;Exception&gt;(null); CompleteQuestionnaire(viewModel); viewModel.Submit(); //      UI . callback(submitResultMock.Object); //    ‚Äì     . Assert.AreEqual(ViewNames.QuestionnaireTemplatesList, requestedViewName);</code> <br> <b></b> <br>          ,        . <br>   <br>       , . <span class="hljs-string"><span class="hljs-string">"Trees in WPF"</span></span>  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ms753391.aspx">http://msdn.microsoft.com/en-us/library/ms753391.aspx</a> <br> <br>       , . <span class="hljs-string"><span class="hljs-string">"Attached Properties Overview"</span></span>  MSDN: <a href="http://msdn.microsoft.com/en-us/library/cc265152(VS.95).aspx">http://msdn.microsoft.com/en-us/library/cc265152(VS.<span class="hljs-number"><span class="hljs-number">95</span></span>).aspx</a> <br> <br>      MEF, .<span class="hljs-string"><span class="hljs-string">"Managed Extensibility Framework Overview"</span></span>  MSDN: <a href="http://msdn.microsoft.com/en-us/library/dd460648.aspx">http://msdn.microsoft.com/en-us/library/dd460648.aspx</a> . <br> <br>      Unity, .<span class="hljs-string"><span class="hljs-string">"Unity Application Block"</span></span>  MSDN: <a href="http://www.msdn.com/unity">http://www.msdn.com/unity</a> . <br> <br>      <code>DelegateCommand</code> , .Chapter <span class="hljs-number"><span class="hljs-number">5</span></span>, <span class="hljs-string"><span class="hljs-string">" </span></span><a href="http://msdn.microsoft.com/en-us/library/gg405484(v%3DPandP.40).aspx"><span class="hljs-string"><span class="hljs-string">Implementing the MVVM Pattern</span></span></a><span class="hljs-string"><span class="hljs-string"> ."</span></span> <br> <br>        Microsoft Expression Blend, .<span class="hljs-string"><span class="hljs-string">"Working with built-in behaviors"</span></span>  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ff724013(v%3DExpression.40).aspx">http://msdn.microsoft.com/en-us/library/ff724013(v=Expression.<span class="hljs-number"><span class="hljs-number">40</span></span>).aspx</a> . <br> <br>          Microsoft Expression Blend, .<span class="hljs-string"><span class="hljs-string">"Creating Custom Behaviors"</span></span>  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ff724708(v%3DExpression.40).aspx">http://msdn.microsoft.com/en-us/library/ff724708(v=Expression.<span class="hljs-number"><span class="hljs-number">40</span></span>).aspx</a> . <br> <br>            Microsoft Expression Blend, .<span class="hljs-string"><span class="hljs-string">"Creating Custom Triggers and Actions"</span></span>  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ff724707(v%3DExpression.40).aspx">http://msdn.microsoft.com/en-us/library/ff724707(v=Expression.<span class="hljs-number"><span class="hljs-number">40</span></span>).aspx</a> . <br> <br>         WPF  Silverlight, .<span class="hljs-string"><span class="hljs-string">"Threading Model"</span></span>  <span class="hljs-string"><span class="hljs-string">"The Dispatcher Class"</span></span>  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ms741870.aspx">http://msdn.microsoft.com/en-us/library/ms741870.aspx</a> <br> <a href="http://msdn.microsoft.com/en-us/library/ms615907(v%3DVS.95).aspx">http://msdn.microsoft.com/en-us/library/ms615907(v=VS.<span class="hljs-number"><span class="hljs-number">95</span></span>).aspx</a> . <br> <br>      unit-  Silverlight, .<span class="hljs-string"><span class="hljs-string">"Unit Testing with Silverlight 2"</span></span>: <a href="http://www.jeff.wilcox.name/2008/03/silverlight2-unit-testing/">http://www.jeff.wilcox.name/<span class="hljs-number"><span class="hljs-number">2008</span></span>/<span class="hljs-number"><span class="hljs-number">03</span></span>/silverlight2-unit-testing/</a> . <br> <br>         , .  <span class="hljs-string"><span class="hljs-string">" </span></span><a href="http://msdn.microsoft.com/en-us/library/gg430861(v%3DPandP.40).aspx"><span class="hljs-string"><span class="hljs-string">View-Based Navigation</span></span></a><span class="hljs-string"><span class="hljs-string"> "</span></span> in Chapter <span class="hljs-number"><span class="hljs-number">8</span></span>, <span class="hljs-string"><span class="hljs-string">" </span></span><a href="http://msdn.microsoft.com/en-us/library/gg430861(v%3DPandP.40).aspx"><span class="hljs-string"><span class="hljs-string">Navigation</span></span></a><span class="hljs-string"><span class="hljs-string"> ."</span></span> <br> <br>       ,   , .<span class="hljs-string"><span class="hljs-string">"Event-based Asynchronous Pattern Overview"</span></span>  MSDN: <a href="http://msdn.microsoft.com/en-us/library/wewwczdw.aspx">http://msdn.microsoft.com/en-us/library/wewwczdw.aspx</a> <br> <br>        <code>IAsyncResult</code> , .<span class="hljs-string"><span class="hljs-string">"Asynchronous Programming Overview"</span></span>  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ms228963.aspx">http://msdn.microsoft.com/en-us/library/ms228963.aspx</a></code></code></code></code></code></code></code></code></code> </pre> <code><code><code><code>CommandBehaviorBase ,    ,    ICommand</code> .           <code>CanExecuteChanged</code> ,          Silverlight,    WPF. <br> <br>    ,  ,   <code>CommandBehaviorBase    ,    .         ,      .         ,    .      ButtonBaseClickCommandBehavior</code> . <br> <br> <code class="cs">public class ButtonBaseClickCommandBehavior : CommandBehaviorBase&lt;ButtonBase&gt; { public ButtonBaseClickCommandBehavior(ButtonBase clickableObject) : base(clickableObject) { clickableObject.Click += OnClick; } private void OnClick(object sender, System.Windows.RoutedEventArgs e) { ExecuteCommand(); } }</code> <br>   <code>CommandBehaviorBase ,     .     ,          ,   . ,    ,    ,      , ,    CanExecute</code>  ,     . <br> <br>          ,   .           XAML.           .       .  Prism      ,       ,  ,   .       ,    . , ,  ,      <code>Click</code> ,       <code>Command</code> .    <code>Click.Command</code> ,  . <br> <br>             .             . <br> <br> <code class="cs">public static readonly DependencyProperty CommandProperty = DependencyProperty.RegisterAttached( "Command", typeof(ICommand), typeof(Click), new PropertyMetadata(OnSetCommandCallback)); private static readonly DependencyProperty ClickCommandBehaviorProperty = DependencyProperty.RegisterAttached( "ClickCommandBehavior", typeof(ButtonBaseClickCommandBehavior), typeof(Click), null);</code> <br>    <code>Command</code>    <code>ButtonBaseClickCommandBehavior</code> ,     <code>OnSetCommandCallback</code> ,     . <br> <br> <code class="cs">private static void OnSetCommandCallback(DependencyObject dependencyObject, DependencyPropertyChangedEventArgs e) { ButtonBase buttonBase = dependencyObject as ButtonBase; if (buttonBase != null) { ButtonBaseClickCommandBehavior behavior = GetOrCreateBehavior(buttonBase); behavior.Command = e.NewValue as ICommand; } } private static void OnSetCommandParameterCallback(DependencyObject dependencyObject, DependencyPropertyChangedEventArgs e) { ButtonBase buttonBase = dependencyObject as ButtonBase; if (buttonBase != null) { ButtonBaseClickCommandBehavior behavior = GetOrCreateBehavior(buttonBase); behavior.CommandParameter = e.NewValue; } } private static ButtonBaseClickCommandBehavior GetOrCreateBehavior(ButtonBase buttonBase ) { ButtonBaseClickCommandBehavior behavior = buttonBase.GetValue(ClickCommandBehaviorProperty) as ButtonBaseClickCommandBehavior; if ( behavior == null ) { behavior = new ButtonBaseClickCommandBehavior(buttonBase); buttonBase.SetValue(ClickCommandBehaviorProperty, behavior); } return behavior; }</code> <br>        ,  <a href="http://msdn.microsoft.com/en-us/library/cc265152(VS.95).aspx">Attached Properties Overview</a>  MSDN. <br> <br>    <br>              . ,     Silverlight,    -,     ,      ,     .     ,       . <br> <br>        ,    ( )  ,  ,     .  UI       ,            UI. <br> <br>      - <br>   -     ,       <code>IAsyncResult</code> .   ,  ,   ,  <code>GetQuestionnaire</code> ,   : <code>BeginGetQuestionnaire</code>  <code>EndGetQuestionnaire</code> .    ,   <code>BeginGetQuestionnaire</code> .     ,   ,   <code>EndGetQuestionnaire</code>    . <br> <b></b> <br>  .NET Framework 4.5      <code>await</code>  <code>async</code>     <code>*Async</code> .      <a href="http://msdn.microsoft.com/en-us/library/vstudio/hh391443.aspx">"Asynchronous Programming with Async and Await (C# and Visual Basic)"</a> . <br>  ,    <code>EndGetQuestionnaire</code> ,      ,  ()      <code>BeginGetQuestionnaire</code> .     ,      ,   <code>EndGetQuestionnaire</code> ,   . <br> <br> <code class="xml">IAsyncResult asyncResult = this.service.BeginGetQuestionnaire( GetQuestionnaireCompleted, null //  ,      ); private void GetQuestionnaireCompleted(IAsyncResult result) { try { questionnaire = this.service.EndGetQuestionnaire(ar); } catch (Exception ex) { //  -   . } }</code> <br>  ,     <code>End*</code> (  , <code>EndGetQuestionnaire</code> ),    ,      .      , ,          UI.     ,   ,        . <br> <br>        UI,     -,      UI,         UI,   <code>Dispatcher</code>    <code>SynchronizationContext</code> .  WPF  Silverlight,   <code>Dispatcher</code> . <br> <br>      <code>Questionnaire</code>  ,        <code>QuestionnaireView</code> .  Silverlight    <code>CheckAccess</code> ,  ,      UI.  ,     <code>BeginInvoke</code> ,      UI. <br> <br> <code class="cs">var dispatcher = System.Windows.Deployment.Current.Dispatcher; if (dispatcher.CheckAccess()) { QuestionnaireView.DataContext = questionnaire; } else { dispatcher.BeginInvoke(() =&gt; { Questionnaire.DataContext = questionnaire; }); }</code> <br> <i>MVVM RI</i>   ,    ,   <code>IAsyncResult</code> ,   .      ,                 . ,       . <br> <br> <code class="cs">this.questionnaireRepository.GetQuestionnaireAsync( result =&gt; { this.Questionnaire = result.Result; });</code> <br>  <code>result</code>   ,     , , , .    ,     . <br> <br> <code class="cs">this.questionnaireRepository.GetQuestionnaireAsync( result =&gt; { if (result.Error == null) { this.Questionnaire = result.Result; ... } else { // Handle error. } })</code> <br>     <br>        ,      .     , ,             .        ,      ,     ,     . <br> <br>         ,      MVVM,     ,   . ,  -MVVM ,     <code>MessageBox</code>   code-behind UI,      .   MVVM     ,          . <br> <br>     MVVM,              ,          .      ,    ,   ,  ,     . <br> <br>              MVVM.      ,     ,     ,  ,     .    ,         ,     ,          .       . <br> <br>    <br>                  .        ,        .  ,         .         . <br> <br>  ,         ,         ,  .      ,     .           ,       . ,        WPF  Silverlight,        . <br> <br> <img title="Using the service to interact with the user." src="https://habrastorage.org/getpro/habr/post_images/4b5/397/f2d/4b5397f2d02e5851195b29f1893be6fc.png" alt=" ,    ."> <br> <br>  ,   <code>MessageBox</code>        ,     ,    ,     . <br> <br> <code class="cs">var result = interactionService.ShowMessageBox( "Are you sure you want to cancel this operation?", "Confirm", MessageBoxButton.OK); if (result == MessageBoxResult.Yes) { CancelRequest(); }</code> <br> ,      - ,      ,         Silverlight.         .             .     . <br> <br> <code class="cs">interactionService.ShowMessageBox( "Are you sure you want to cancel this operation?", "Confirm", MessageBoxButton.OK, result =&gt; { if (result == MessageBoxResult.Yes) { CancelRequest(); } });</code> <br>         ,      . ,  WPF    <code>MessageBox</code> ,       ;    Silverlight    ,    . <br> <br>     <br>         ‚Äì             .         ,      .     ,     .        ,        ,   ,     . <br> <br> <img title="Using interaction request objects." src="https://habrastorage.org/getpro/habr/post_images/3d0/ff0/1c5/3d0ff01c5518558c2d3c5c5f47ce0ce9.png" alt="   ."> <br> <br>    ,   ,          ‚Äì       ,      ,   ‚Äì     .   ,        ,    ,    UI            . <br> <br>       MVVM,     ,       ,         .         ,        ,    ,   . <br> <br>  Prism       <code>IInteractionRequest</code>   <code><code>InteractionRequest .  IInteractionRequest</code>  ,   .           ,   .  <code><code>InteractionRequest   IInteractionRequest</code>     <code>Raise</code> ,           , , ,   . <br> <br>       <br>  <code><code>InteractionRequest          .  Raise</code>          ( <code>T</code> )    ,    ,   .          ,       .      ,        .    ,  ,     . <br> <code class="cs">public interface IInteractionRequest { event EventHandler&lt;InteractionRequestedEventArgs&gt; Raised; } public class InteractionRequest&lt;T&gt; : IInteractionRequest { public event EventHandler&lt;InteractionRequestedEventArgs&gt; Raised; public void Raise(T context, Action&lt;T&gt; callback) { var handler = this.Raised; if (handler != null) { handler( this, new InteractionRequestedEventArgs(context, () =&gt; callback(context))); } } }</code> <br> Prism    ,      .  <code>Notification</code>       .    ,            .     ‚Äì <code>Title</code>  <code>Content</code> ,    .  ,   ,  ,  ,        . <br> <br>  <code>Confirmation</code>    <code>Notification</code>     ‚Äì <code>Confirmed</code> ,  ,  ,      .  <code>Confirmation</code> ,     <code>MessageBox</code> ,     /  .     ,     <code>Notification</code> ,     ,      . <br> <br>    <code><code><code>InteractionRequest ,       InteractionRequest      ,      .      ,    Raise</code> ,    , ,   . <br> <br> <code class="cs">public IInteractionRequest ConfirmCancelInteractionRequest { get { return this.confirmCancelInteractionRequest; } } this.confirmCancelInteractionRequest.Raise( new Confirmation("Are you sure you wish to cancel?"), confirmation =&gt; { if (confirmation.Confirmed) { this.NavigateToQuestionnaireList(); } }); }</code> <br> <i>MVVM Reference Implementation (MVVM RI)</i> ,    <code>IInteractionRequest</code>   <code><code>InteractionRequest ,          (. QuestionnaireViewModel.cs</code> ). <br> <br>        <br>       ,       .   ,       .    UI             . <br> <br>                . Microsoft Expression Blend Behaviors Framework     .  ,     ,    . <br> <br>  <code>EventTrigger</code> ,  Expression Blend,  ,      ,     ,   . , Prism   <code>EventTrigger</code> ,  <code>InteractionRequestTrigger</code> ,      <code>Raised</code>   <code>IInteractionRequest</code> .    XAML        . <br> <br>  ,   , <code>InteractionRequestTrigger</code>   .  Silverlight Prism   <code>PopupChildWindowAction</code> ,     .    ,         .   <code>ContentTemplate</code>  <code>PopupChildWindowAction</code> ,    ,    UI,      <code>Content</code>  .       <code>Title</code>  . <br> <b></b> <br>  ,    ,   <code>PopupChildWindowAction</code> ,     .    <code>Notification</code>  <code>NotificationChildWindow</code> ,        <code>Confirmation</code> ‚Äì <code>ConfirmationChildWindow</code> . <code>NotificationChildWindow</code>    ,   ,     <code>ConfirmationChildWindow</code>    <i>OK</i>  <i>Cancel</i> ,    .    ,   ,   <code>ChildWindow</code>  <code>PopupChildWindowAction</code> . <br>   ,  <code>InteractionRequestTrigger</code>  <code>PopupChildWindowAction</code> ,       <i>RI MVVM</i> . <br> <br> <code class="xml">&lt;i:Interaction.Triggers&gt; &lt;prism:InteractionRequestTrigger SourceObject="{Binding ConfirmCancelInteractionRequest}"&gt; &lt;prism:PopupChildWindowAction ContentTemplate="{StaticResource ConfirmWindowTemplate}"/&gt; &lt;/prism:InteractionRequestTrigger&gt; &lt;/i:Interaction.Triggers&gt; &lt;UserControl.Resources&gt; &lt;DataTemplate x:Key="ConfirmWindowTemplate"&gt; &lt;Grid MinWidth="250" MinHeight="100"&gt; &lt;TextBlock TextWrapping="Wrap" Grid.Row="0" Text="{Binding}"/&gt; &lt;/Grid&gt; &lt;/DataTemplate&gt; &lt;/UserControl.Resources&gt;</code> <br> <b></b> <br>      <code>ContentTemplate</code> ,   UI   <code>Content</code>  .    <code>Content</code>  ,  , <code>TextBlock</code>     <code>Content</code> . <br>      ,     ,    ,    .  ,     ,       ,     ,    .   ,   <i>RI MVVM</i> ,         <code>Confirmed</code>    <code>Confirmation</code>  <code>true</code> ,     OK. <br> <br>        ,     .  Prism <code>InteractionRequestTrigger</code>   <code>PopupChildWindowAction</code>            . <br> <br>     <br>     MVVM,       , ,    ,         .        (  , ,  ,   ).    ,  ,  ,            . <br> <br>        ,         . Managed Extensibility Framework (MEF)  Unity Application Block (Unity)      ,  ,           . <br> <br>  ,       , , ,    ( )      . ,       ,     .  ,     ,       . <br> <br>     ,  MEF <br>  MEF,       ,   <code>Import</code> ,      ,  ,   <code>Export</code> .         ,    . <br> <br> , <code>QuestionnaireView</code>   <i>RI MVVM</i> ,        ,    <code>Import</code> .   , MEF           .  <code>set</code>        ,   . <br> <br> <code class="cs">[Import] public QuestionnaireViewModel ViewModel { set { this.DataContext = value; } }</code> <br>     ,   . <br> <br> <code class="cs">[Export] public class QuestionnaireViewModel : NotificationObject { ... }</code> <br>        ,   . <br> <br> <code class="cs">public QuestionnaireView() { InitializeComponent(); } [ImportingConstructor] public QuestionnaireView(QuestionnaireViewModel viewModel) : this() { this.DataContext = viewModel; }</code> <br> <b></b> <br>          MEF,   Unity.   ,     ,        .   ,   Visual Studio  Expression Blend, ,        ,     .   ,   ,  ,      ,          <code>InitializeComponent</code> . <br>     ,  Unity <br>  Unity,    ,   MEF.     ,      .    ,         .  ,      . <br> <br>  ,      ,  ,         . ,           ,   . <br> <br> <code class="cs">public QuestionnaireView() { InitializeComponent(); } public QuestionnaireView(QuestionnaireViewModel viewModel) : this() { this.DataContext = viewModel; }</code> <br> <b></b> <br>    ,        ,   Visual Studio  Expression Blend. <br>  ,          ,   . Unity        <code>set</code>   ,   . <br> <br> <code class="cs">public QuestionnaireView() { InitializeComponent(); } [Dependency] public QuestionnaireViewModel ViewModel { set { this.DataContext = value; } }</code> <br>       Unity. <br> <br> <code class="cs">container.RegisterType&lt;QuestionnaireViewModel&gt;();</code> <br>  ,     . <br> <br> <code class="cs">var view = container.Resolve&lt;QuestionnaireView&gt;();</code> <br>     ,    <br>   ,     ,        .        ,   MEF  Unity,        . <br> <br>          .   ,         UI,           . <br> <br> , <i>RI MVVM</i>   ,   ,        .   ,    .      <code>ShowView</code>   UI. <br> <br> <code class="cs">private void NavigateToQuestionnaireList() { //     "questionnaire list". this.uiService.ShowView(ViewNames.QuestionnaireTemplatesList); }</code> <br>  UI      UI .           UI.  <code>ShowView</code>  <code>UIService</code>      (,          ),       ,   . <br> <br> <code class="cs">public void ShowView(string viewName) { var view = this.ViewFactory.GetView(viewName); this.MainWindow.CurrentView = view; }</code> <br> <b></b> <br> Prism       .   ,   ,   ,             .    ,  , " <a href="http://msdn.microsoft.com/en-us/library/gg430861(v%3DPandP.40).aspx">View-Based Navigation</a> "   8, " <a href="http://msdn.microsoft.com/en-us/library/gg430861(v%3DPandP.40).aspx">Navigation</a> ". <br>  MVVM  <br>        MVVM      .           -      mocking . ,   ,        . <br> <br>   <i>INotifyPropertyChanged</i> <br>   <code>INotifyPropertyChanged</code>     ,      .      ,    ;   ,   ,     ,    ,       . <br> <br>   <br> ,       ,           <code>PropertyChanged</code>  ,         .  ,    <code>ChangeTracker</code> ,     MVVM,  ,      .      .     ,    . <br> <br> <code class="cs">var changeTracker = new PropertyChangeTracker(viewModel); viewModel.CurrentState = "newState"; CollectionAssert.Contains(changeTracker.ChangedProperties, "CurrentState");</code> <br> ,     ,     <code>INotifyPropertyChanged</code> ,    ,   ,     . <br> <br>      <br>        ,   ,    <code>set</code>      ,           . ,     ,     ,      ,          . <br> <br> <code class="cs">var changeTracker = new PropertyChangeTracker(viewModel); var question = viewModel.Questions.First() as OpenQuestionViewModel; question.Question.Response = "some text"; CollectionAssert.Contains(changeTracker.ChangedProperties, "UnansweredQuestions");</code> <br>      <br>     <code>INotifyPropertyChanged</code> ,      <code>PropertyChanged</code>        ,  ,     , , .        ,       . <br> <br>   <i>INotifyDataErrorInfo</i> <br>   ,     ,    ,   ,   <code>IDataErrorInfo</code> ,  ( Silverlight)   <code>INotifyDataErrorInfo</code> .   <code>INotifyDataErrorInfo</code>   ,         ,    ,  ,   ,    . <br> <br>       <code>INotifyDataErrorInfo</code> : ,     ,  ,     ,     <code>ErrorsChanged</code> ,      <code>GetErrors</code> , . <br> <br>    <br>     ,      ,     .       ,         <code>GetErrors</code>       ,  ,  ,   .    , ,  ,     ,        .   ,        . <br> <br> <code class="cs">//  . var notifyErrorInfo = (INotifyDataErrorInfo)question; question.Response = -15; Assert.IsTrue(notifyErrorInfo.GetErrors("Response").Cast&lt;ValidationResult&gt;().Any()); //  . var notifyErrorInfo = (INotifyDataErrorInfo)question; question.Response = 15; Assert.IsFalse(notifyErrorInfo.GetErrors("Response").Cast&lt;ValidationResult&gt;().Any());</code> <br>    ,    ,             . <br> <br>    <i>INotifyDataErrorInfo</i> <br>       <code>GetErrors</code> ,   <code>INotifyDataErrorInfo</code>  ,   <code>ErrorsChanged</code>      <code>GetErrors</code> . ,  <code>HasErrors</code>      ,  . <br> <br>       <code>INotifyDataErrorInfo</code> . , ,           ,   -  .      ,        <code>INotifyDataErrorInfo</code>         (,        ). <br> <br>     ,   ,  : <br>  <code>HasErrors</code>     .              ,       .  <code>ErrorsChanged</code> ,      ,         <code>GetErrors</code> .         ( ,  )     ,           .    <code>GetErrors</code>       <code>ErrorsChanged</code> . <br>    <code>INotifyPropertyChanged</code> ,  ,    <code>NotifyDataErrorInfoTestHelper</code>    MVVM,        <code>INotifyDataErrorInfo</code> ,       .   ,   ,      ,   .      . <br> <code class="cs">var helper = new NotifyDataErrorInfoTestHelper&lt;NumericQuestion, int?&gt;( question, q =&gt; q.Response); helper.ValidatePropertyChange( 6, NotifyDataErrorInfoBehavior.Nothing); helper.ValidatePropertyChange( 20, NotifyDataErrorInfoBehavior.FiresErrorsChanged | NotifyDataErrorInfoBehavior.HasErrors | NotifyDataErrorInfoBehavior.HasErrorsForProperty); helper.ValidatePropertyChange( null, NotifyDataErrorInfoBehavior.FiresErrorsChanged | NotifyDataErrorInfoBehavior.HasErrors | NotifyDataErrorInfoBehavior.HasErrorsForProperty); helper.ValidatePropertyChange( 2, NotifyDataErrorInfoBehavior.FiresErrorsChanged);</code> <br>     <br>   MVVM,     ,  .   ,    ,         . <br> <br>  ,     ,     ,       .   ,   , ,       ,     ,   <code>IAsyncResult</code>    ,  - ,   ,    UI. <br> <br>       , , ,    .   ,     .  ,      UI,     ,   ,          ,     ,        "   UI." <br> <br>     ,    ,    .   ,    ,     mock-, ,   ,   ,      ,          . <br> <br>           UI,    ,    .   ,     ,   ,      .        ,   .     ,    ,     . <br> <br> <code class="cs">questionnaireRepositoryMock .Setup( r =&gt; r.SubmitQuestionnaireAsync( It.IsAny&lt;Questionnaire&gt;(), It.IsAny&lt;Action&lt;IOperationResult&gt;&gt;())) .Callback&lt;Questionnaire, Action&lt;IOperationResult&gt;&gt;( (q, a) =&gt; callback = a); uiServicemock .Setup(svc =&gt; svc.ShowView(ViewNames.QuestionnaireTemplatesList)) .Callback&lt;string&gt;(viewName =&gt; requestedViewName = viewName); submitResultMock .Setup(sr =&gt; sr.Error) .Returns&lt;Exception&gt;(null); CompleteQuestionnaire(viewModel); viewModel.Submit(); //      UI . callback(submitResultMock.Object); //    ‚Äì     . Assert.AreEqual(ViewNames.QuestionnaireTemplatesList, requestedViewName);</code> <br> <b></b> <br>          ,        . <br>   <br>       , . "Trees in WPF"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ms753391.aspx">http://msdn.microsoft.com/en-us/library/ms753391.aspx</a> <br> <br>       , . "Attached Properties Overview"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/cc265152(VS.95).aspx">http://msdn.microsoft.com/en-us/library/cc265152(VS.95).aspx</a> <br> <br>      MEF, ."Managed Extensibility Framework Overview"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/dd460648.aspx">http://msdn.microsoft.com/en-us/library/dd460648.aspx</a> . <br> <br>      Unity, ."Unity Application Block"  MSDN: <a href="http://www.msdn.com/unity">http://www.msdn.com/unity</a> . <br> <br>      <code>DelegateCommand</code> , .Chapter 5, " <a href="http://msdn.microsoft.com/en-us/library/gg405484(v%3DPandP.40).aspx">Implementing the MVVM Pattern</a> ." <br> <br>        Microsoft Expression Blend, ."Working with built-in behaviors"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ff724013(v%3DExpression.40).aspx">http://msdn.microsoft.com/en-us/library/ff724013(v=Expression.40).aspx</a> . <br> <br>          Microsoft Expression Blend, ."Creating Custom Behaviors"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ff724708(v%3DExpression.40).aspx">http://msdn.microsoft.com/en-us/library/ff724708(v=Expression.40).aspx</a> . <br> <br>            Microsoft Expression Blend, ."Creating Custom Triggers and Actions"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ff724707(v%3DExpression.40).aspx">http://msdn.microsoft.com/en-us/library/ff724707(v=Expression.40).aspx</a> . <br> <br>         WPF  Silverlight, ."Threading Model"  "The Dispatcher Class"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ms741870.aspx">http://msdn.microsoft.com/en-us/library/ms741870.aspx</a> <br> <a href="http://msdn.microsoft.com/en-us/library/ms615907(v%3DVS.95).aspx">http://msdn.microsoft.com/en-us/library/ms615907(v=VS.95).aspx</a> . <br> <br>      unit-  Silverlight, ."Unit Testing with Silverlight 2": <a href="http://www.jeff.wilcox.name/2008/03/silverlight2-unit-testing/">http://www.jeff.wilcox.name/2008/03/silverlight2-unit-testing/</a> . <br> <br>         , .  " <a href="http://msdn.microsoft.com/en-us/library/gg430861(v%3DPandP.40).aspx">View-Based Navigation</a> " in Chapter 8, " <a href="http://msdn.microsoft.com/en-us/library/gg430861(v%3DPandP.40).aspx">Navigation</a> ." <br> <br>       ,   , ."Event-based Asynchronous Pattern Overview"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/wewwczdw.aspx">http://msdn.microsoft.com/en-us/library/wewwczdw.aspx</a> <br> <br>        <code>IAsyncResult</code> , ."Asynchronous Programming Overview"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ms228963.aspx">http://msdn.microsoft.com/en-us/library/ms228963.aspx</a></code></code></code></code></code></code></code></code></code> <h4> <code><code><code><code>CommandBehaviorBase ,    ,    ICommand</code> .           <code>CanExecuteChanged</code> ,          Silverlight,    WPF. <br> <br>    ,  ,   <code>CommandBehaviorBase    ,    .         ,      .         ,    .      ButtonBaseClickCommandBehavior</code> . <br> <br> <code class="cs">public class ButtonBaseClickCommandBehavior : CommandBehaviorBase&lt;ButtonBase&gt; { public ButtonBaseClickCommandBehavior(ButtonBase clickableObject) : base(clickableObject) { clickableObject.Click += OnClick; } private void OnClick(object sender, System.Windows.RoutedEventArgs e) { ExecuteCommand(); } }</code> <br>   <code>CommandBehaviorBase ,     .     ,          ,   . ,    ,    ,      , ,    CanExecute</code>  ,     . <br> <br>          ,   .           XAML.           .       .  Prism      ,       ,  ,   .       ,    . , ,  ,      <code>Click</code> ,       <code>Command</code> .    <code>Click.Command</code> ,  . <br> <br>             .             . <br> <br> <code class="cs">public static readonly DependencyProperty CommandProperty = DependencyProperty.RegisterAttached( "Command", typeof(ICommand), typeof(Click), new PropertyMetadata(OnSetCommandCallback)); private static readonly DependencyProperty ClickCommandBehaviorProperty = DependencyProperty.RegisterAttached( "ClickCommandBehavior", typeof(ButtonBaseClickCommandBehavior), typeof(Click), null);</code> <br>    <code>Command</code>    <code>ButtonBaseClickCommandBehavior</code> ,     <code>OnSetCommandCallback</code> ,     . <br> <br> <code class="cs">private static void OnSetCommandCallback(DependencyObject dependencyObject, DependencyPropertyChangedEventArgs e) { ButtonBase buttonBase = dependencyObject as ButtonBase; if (buttonBase != null) { ButtonBaseClickCommandBehavior behavior = GetOrCreateBehavior(buttonBase); behavior.Command = e.NewValue as ICommand; } } private static void OnSetCommandParameterCallback(DependencyObject dependencyObject, DependencyPropertyChangedEventArgs e) { ButtonBase buttonBase = dependencyObject as ButtonBase; if (buttonBase != null) { ButtonBaseClickCommandBehavior behavior = GetOrCreateBehavior(buttonBase); behavior.CommandParameter = e.NewValue; } } private static ButtonBaseClickCommandBehavior GetOrCreateBehavior(ButtonBase buttonBase ) { ButtonBaseClickCommandBehavior behavior = buttonBase.GetValue(ClickCommandBehaviorProperty) as ButtonBaseClickCommandBehavior; if ( behavior == null ) { behavior = new ButtonBaseClickCommandBehavior(buttonBase); buttonBase.SetValue(ClickCommandBehaviorProperty, behavior); } return behavior; }</code> <br>        ,  <a href="http://msdn.microsoft.com/en-us/library/cc265152(VS.95).aspx">Attached Properties Overview</a>  MSDN. <br> <br>    <br>              . ,     Silverlight,    -,     ,      ,     .     ,       . <br> <br>        ,    ( )  ,  ,     .  UI       ,            UI. <br> <br>      - <br>   -     ,       <code>IAsyncResult</code> .   ,  ,   ,  <code>GetQuestionnaire</code> ,   : <code>BeginGetQuestionnaire</code>  <code>EndGetQuestionnaire</code> .    ,   <code>BeginGetQuestionnaire</code> .     ,   ,   <code>EndGetQuestionnaire</code>    . <br> <b></b> <br>  .NET Framework 4.5      <code>await</code>  <code>async</code>     <code>*Async</code> .      <a href="http://msdn.microsoft.com/en-us/library/vstudio/hh391443.aspx">"Asynchronous Programming with Async and Await (C# and Visual Basic)"</a> . <br>  ,    <code>EndGetQuestionnaire</code> ,      ,  ()      <code>BeginGetQuestionnaire</code> .     ,      ,   <code>EndGetQuestionnaire</code> ,   . <br> <br> <code class="xml">IAsyncResult asyncResult = this.service.BeginGetQuestionnaire( GetQuestionnaireCompleted, null //  ,      ); private void GetQuestionnaireCompleted(IAsyncResult result) { try { questionnaire = this.service.EndGetQuestionnaire(ar); } catch (Exception ex) { //  -   . } }</code> <br>  ,     <code>End*</code> (  , <code>EndGetQuestionnaire</code> ),    ,      .      , ,          UI.     ,   ,        . <br> <br>        UI,     -,      UI,         UI,   <code>Dispatcher</code>    <code>SynchronizationContext</code> .  WPF  Silverlight,   <code>Dispatcher</code> . <br> <br>      <code>Questionnaire</code>  ,        <code>QuestionnaireView</code> .  Silverlight    <code>CheckAccess</code> ,  ,      UI.  ,     <code>BeginInvoke</code> ,      UI. <br> <br> <code class="cs">var dispatcher = System.Windows.Deployment.Current.Dispatcher; if (dispatcher.CheckAccess()) { QuestionnaireView.DataContext = questionnaire; } else { dispatcher.BeginInvoke(() =&gt; { Questionnaire.DataContext = questionnaire; }); }</code> <br> <i>MVVM RI</i>   ,    ,   <code>IAsyncResult</code> ,   .      ,                 . ,       . <br> <br> <code class="cs">this.questionnaireRepository.GetQuestionnaireAsync( result =&gt; { this.Questionnaire = result.Result; });</code> <br>  <code>result</code>   ,     , , , .    ,     . <br> <br> <code class="cs">this.questionnaireRepository.GetQuestionnaireAsync( result =&gt; { if (result.Error == null) { this.Questionnaire = result.Result; ... } else { // Handle error. } })</code> <br>     <br>        ,      .     , ,             .        ,      ,     ,     . <br> <br>         ,      MVVM,     ,   . ,  -MVVM ,     <code>MessageBox</code>   code-behind UI,      .   MVVM     ,          . <br> <br>     MVVM,              ,          .      ,    ,   ,  ,     . <br> <br>              MVVM.      ,     ,     ,  ,     .    ,         ,     ,          .       . <br> <br>    <br>                  .        ,        .  ,         .         . <br> <br>  ,         ,         ,  .      ,     .           ,       . ,        WPF  Silverlight,        . <br> <br> <img title="Using the service to interact with the user." src="https://habrastorage.org/getpro/habr/post_images/4b5/397/f2d/4b5397f2d02e5851195b29f1893be6fc.png" alt=" ,    ."> <br> <br>  ,   <code>MessageBox</code>        ,     ,    ,     . <br> <br> <code class="cs">var result = interactionService.ShowMessageBox( "Are you sure you want to cancel this operation?", "Confirm", MessageBoxButton.OK); if (result == MessageBoxResult.Yes) { CancelRequest(); }</code> <br> ,      - ,      ,         Silverlight.         .             .     . <br> <br> <code class="cs">interactionService.ShowMessageBox( "Are you sure you want to cancel this operation?", "Confirm", MessageBoxButton.OK, result =&gt; { if (result == MessageBoxResult.Yes) { CancelRequest(); } });</code> <br>         ,      . ,  WPF    <code>MessageBox</code> ,       ;    Silverlight    ,    . <br> <br>     <br>         ‚Äì             .         ,      .     ,     .        ,        ,   ,     . <br> <br> <img title="Using interaction request objects." src="https://habrastorage.org/getpro/habr/post_images/3d0/ff0/1c5/3d0ff01c5518558c2d3c5c5f47ce0ce9.png" alt="   ."> <br> <br>    ,   ,          ‚Äì       ,      ,   ‚Äì     .   ,        ,    ,    UI            . <br> <br>       MVVM,     ,       ,         .         ,        ,    ,   . <br> <br>  Prism       <code>IInteractionRequest</code>   <code><code>InteractionRequest .  IInteractionRequest</code>  ,   .           ,   .  <code><code>InteractionRequest   IInteractionRequest</code>     <code>Raise</code> ,           , , ,   . <br> <br>       <br>  <code><code>InteractionRequest          .  Raise</code>          ( <code>T</code> )    ,    ,   .          ,       .      ,        .    ,  ,     . <br> <code class="cs">public interface IInteractionRequest { event EventHandler&lt;InteractionRequestedEventArgs&gt; Raised; } public class InteractionRequest&lt;T&gt; : IInteractionRequest { public event EventHandler&lt;InteractionRequestedEventArgs&gt; Raised; public void Raise(T context, Action&lt;T&gt; callback) { var handler = this.Raised; if (handler != null) { handler( this, new InteractionRequestedEventArgs(context, () =&gt; callback(context))); } } }</code> <br> Prism    ,      .  <code>Notification</code>       .    ,            .     ‚Äì <code>Title</code>  <code>Content</code> ,    .  ,   ,  ,  ,        . <br> <br>  <code>Confirmation</code>    <code>Notification</code>     ‚Äì <code>Confirmed</code> ,  ,  ,      .  <code>Confirmation</code> ,     <code>MessageBox</code> ,     /  .     ,     <code>Notification</code> ,     ,      . <br> <br>    <code><code><code>InteractionRequest ,       InteractionRequest      ,      .      ,    Raise</code> ,    , ,   . <br> <br> <code class="cs">public IInteractionRequest ConfirmCancelInteractionRequest { get { return this.confirmCancelInteractionRequest; } } this.confirmCancelInteractionRequest.Raise( new Confirmation("Are you sure you wish to cancel?"), confirmation =&gt; { if (confirmation.Confirmed) { this.NavigateToQuestionnaireList(); } }); }</code> <br> <i>MVVM Reference Implementation (MVVM RI)</i> ,    <code>IInteractionRequest</code>   <code><code>InteractionRequest ,          (. QuestionnaireViewModel.cs</code> ). <br> <br>        <br>       ,       .   ,       .    UI             . <br> <br>                . Microsoft Expression Blend Behaviors Framework     .  ,     ,    . <br> <br>  <code>EventTrigger</code> ,  Expression Blend,  ,      ,     ,   . , Prism   <code>EventTrigger</code> ,  <code>InteractionRequestTrigger</code> ,      <code>Raised</code>   <code>IInteractionRequest</code> .    XAML        . <br> <br>  ,   , <code>InteractionRequestTrigger</code>   .  Silverlight Prism   <code>PopupChildWindowAction</code> ,     .    ,         .   <code>ContentTemplate</code>  <code>PopupChildWindowAction</code> ,    ,    UI,      <code>Content</code>  .       <code>Title</code>  . <br> <b></b> <br>  ,    ,   <code>PopupChildWindowAction</code> ,     .    <code>Notification</code>  <code>NotificationChildWindow</code> ,        <code>Confirmation</code> ‚Äì <code>ConfirmationChildWindow</code> . <code>NotificationChildWindow</code>    ,   ,     <code>ConfirmationChildWindow</code>    <i>OK</i>  <i>Cancel</i> ,    .    ,   ,   <code>ChildWindow</code>  <code>PopupChildWindowAction</code> . <br>   ,  <code>InteractionRequestTrigger</code>  <code>PopupChildWindowAction</code> ,       <i>RI MVVM</i> . <br> <br> <code class="xml">&lt;i:Interaction.Triggers&gt; &lt;prism:InteractionRequestTrigger SourceObject="{Binding ConfirmCancelInteractionRequest}"&gt; &lt;prism:PopupChildWindowAction ContentTemplate="{StaticResource ConfirmWindowTemplate}"/&gt; &lt;/prism:InteractionRequestTrigger&gt; &lt;/i:Interaction.Triggers&gt; &lt;UserControl.Resources&gt; &lt;DataTemplate x:Key="ConfirmWindowTemplate"&gt; &lt;Grid MinWidth="250" MinHeight="100"&gt; &lt;TextBlock TextWrapping="Wrap" Grid.Row="0" Text="{Binding}"/&gt; &lt;/Grid&gt; &lt;/DataTemplate&gt; &lt;/UserControl.Resources&gt;</code> <br> <b></b> <br>      <code>ContentTemplate</code> ,   UI   <code>Content</code>  .    <code>Content</code>  ,  , <code>TextBlock</code>     <code>Content</code> . <br>      ,     ,    ,    .  ,     ,       ,     ,    .   ,   <i>RI MVVM</i> ,         <code>Confirmed</code>    <code>Confirmation</code>  <code>true</code> ,     OK. <br> <br>        ,     .  Prism <code>InteractionRequestTrigger</code>   <code>PopupChildWindowAction</code>            . <br> <br>     <br>     MVVM,       , ,    ,         .        (  , ,  ,   ).    ,  ,  ,            . <br> <br>        ,         . Managed Extensibility Framework (MEF)  Unity Application Block (Unity)      ,  ,           . <br> <br>  ,       , , ,    ( )      . ,       ,     .  ,     ,       . <br> <br>     ,  MEF <br>  MEF,       ,   <code>Import</code> ,      ,  ,   <code>Export</code> .         ,    . <br> <br> , <code>QuestionnaireView</code>   <i>RI MVVM</i> ,        ,    <code>Import</code> .   , MEF           .  <code>set</code>        ,   . <br> <br> <code class="cs">[Import] public QuestionnaireViewModel ViewModel { set { this.DataContext = value; } }</code> <br>     ,   . <br> <br> <code class="cs">[Export] public class QuestionnaireViewModel : NotificationObject { ... }</code> <br>        ,   . <br> <br> <code class="cs">public QuestionnaireView() { InitializeComponent(); } [ImportingConstructor] public QuestionnaireView(QuestionnaireViewModel viewModel) : this() { this.DataContext = viewModel; }</code> <br> <b></b> <br>          MEF,   Unity.   ,     ,        .   ,   Visual Studio  Expression Blend, ,        ,     .   ,   ,  ,      ,          <code>InitializeComponent</code> . <br>     ,  Unity <br>  Unity,    ,   MEF.     ,      .    ,         .  ,      . <br> <br>  ,      ,  ,         . ,           ,   . <br> <br> <code class="cs">public QuestionnaireView() { InitializeComponent(); } public QuestionnaireView(QuestionnaireViewModel viewModel) : this() { this.DataContext = viewModel; }</code> <br> <b></b> <br>    ,        ,   Visual Studio  Expression Blend. <br>  ,          ,   . Unity        <code>set</code>   ,   . <br> <br> <code class="cs">public QuestionnaireView() { InitializeComponent(); } [Dependency] public QuestionnaireViewModel ViewModel { set { this.DataContext = value; } }</code> <br>       Unity. <br> <br> <code class="cs">container.RegisterType&lt;QuestionnaireViewModel&gt;();</code> <br>  ,     . <br> <br> <code class="cs">var view = container.Resolve&lt;QuestionnaireView&gt;();</code> <br>     ,    <br>   ,     ,        .        ,   MEF  Unity,        . <br> <br>          .   ,         UI,           . <br> <br> , <i>RI MVVM</i>   ,   ,        .   ,    .      <code>ShowView</code>   UI. <br> <br> <code class="cs">private void NavigateToQuestionnaireList() { //     "questionnaire list". this.uiService.ShowView(ViewNames.QuestionnaireTemplatesList); }</code> <br>  UI      UI .           UI.  <code>ShowView</code>  <code>UIService</code>      (,          ),       ,   . <br> <br> <code class="cs">public void ShowView(string viewName) { var view = this.ViewFactory.GetView(viewName); this.MainWindow.CurrentView = view; }</code> <br> <b></b> <br> Prism       .   ,   ,   ,             .    ,  , " <a href="http://msdn.microsoft.com/en-us/library/gg430861(v%3DPandP.40).aspx">View-Based Navigation</a> "   8, " <a href="http://msdn.microsoft.com/en-us/library/gg430861(v%3DPandP.40).aspx">Navigation</a> ". <br>  MVVM  <br>        MVVM      .           -      mocking . ,   ,        . <br> <br>   <i>INotifyPropertyChanged</i> <br>   <code>INotifyPropertyChanged</code>     ,      .      ,    ;   ,   ,     ,    ,       . <br> <br>   <br> ,       ,           <code>PropertyChanged</code>  ,         .  ,    <code>ChangeTracker</code> ,     MVVM,  ,      .      .     ,    . <br> <br> <code class="cs">var changeTracker = new PropertyChangeTracker(viewModel); viewModel.CurrentState = "newState"; CollectionAssert.Contains(changeTracker.ChangedProperties, "CurrentState");</code> <br> ,     ,     <code>INotifyPropertyChanged</code> ,    ,   ,     . <br> <br>      <br>        ,   ,    <code>set</code>      ,           . ,     ,     ,      ,          . <br> <br> <code class="cs">var changeTracker = new PropertyChangeTracker(viewModel); var question = viewModel.Questions.First() as OpenQuestionViewModel; question.Question.Response = "some text"; CollectionAssert.Contains(changeTracker.ChangedProperties, "UnansweredQuestions");</code> <br>      <br>     <code>INotifyPropertyChanged</code> ,      <code>PropertyChanged</code>        ,  ,     , , .        ,       . <br> <br>   <i>INotifyDataErrorInfo</i> <br>   ,     ,    ,   ,   <code>IDataErrorInfo</code> ,  ( Silverlight)   <code>INotifyDataErrorInfo</code> .   <code>INotifyDataErrorInfo</code>   ,         ,    ,  ,   ,    . <br> <br>       <code>INotifyDataErrorInfo</code> : ,     ,  ,     ,     <code>ErrorsChanged</code> ,      <code>GetErrors</code> , . <br> <br>    <br>     ,      ,     .       ,         <code>GetErrors</code>       ,  ,  ,   .    , ,  ,     ,        .   ,        . <br> <br> <code class="cs">//  . var notifyErrorInfo = (INotifyDataErrorInfo)question; question.Response = -15; Assert.IsTrue(notifyErrorInfo.GetErrors("Response").Cast&lt;ValidationResult&gt;().Any()); //  . var notifyErrorInfo = (INotifyDataErrorInfo)question; question.Response = 15; Assert.IsFalse(notifyErrorInfo.GetErrors("Response").Cast&lt;ValidationResult&gt;().Any());</code> <br>    ,    ,             . <br> <br>    <i>INotifyDataErrorInfo</i> <br>       <code>GetErrors</code> ,   <code>INotifyDataErrorInfo</code>  ,   <code>ErrorsChanged</code>      <code>GetErrors</code> . ,  <code>HasErrors</code>      ,  . <br> <br>       <code>INotifyDataErrorInfo</code> . , ,           ,   -  .      ,        <code>INotifyDataErrorInfo</code>         (,        ). <br> <br>     ,   ,  : <br>  <code>HasErrors</code>     .              ,       .  <code>ErrorsChanged</code> ,      ,         <code>GetErrors</code> .         ( ,  )     ,           .    <code>GetErrors</code>       <code>ErrorsChanged</code> . <br>    <code>INotifyPropertyChanged</code> ,  ,    <code>NotifyDataErrorInfoTestHelper</code>    MVVM,        <code>INotifyDataErrorInfo</code> ,       .   ,   ,      ,   .      . <br> <code class="cs">var helper = new NotifyDataErrorInfoTestHelper&lt;NumericQuestion, int?&gt;( question, q =&gt; q.Response); helper.ValidatePropertyChange( 6, NotifyDataErrorInfoBehavior.Nothing); helper.ValidatePropertyChange( 20, NotifyDataErrorInfoBehavior.FiresErrorsChanged | NotifyDataErrorInfoBehavior.HasErrors | NotifyDataErrorInfoBehavior.HasErrorsForProperty); helper.ValidatePropertyChange( null, NotifyDataErrorInfoBehavior.FiresErrorsChanged | NotifyDataErrorInfoBehavior.HasErrors | NotifyDataErrorInfoBehavior.HasErrorsForProperty); helper.ValidatePropertyChange( 2, NotifyDataErrorInfoBehavior.FiresErrorsChanged);</code> <br>     <br>   MVVM,     ,  .   ,    ,         . <br> <br>  ,     ,     ,       .   ,   , ,       ,     ,   <code>IAsyncResult</code>    ,  - ,   ,    UI. <br> <br>       , , ,    .   ,     .  ,      UI,     ,   ,          ,     ,        "   UI." <br> <br>     ,    ,    .   ,    ,     mock-, ,   ,   ,      ,          . <br> <br>           UI,    ,    .   ,     ,   ,      .        ,   .     ,    ,     . <br> <br> <code class="cs">questionnaireRepositoryMock .Setup( r =&gt; r.SubmitQuestionnaireAsync( It.IsAny&lt;Questionnaire&gt;(), It.IsAny&lt;Action&lt;IOperationResult&gt;&gt;())) .Callback&lt;Questionnaire, Action&lt;IOperationResult&gt;&gt;( (q, a) =&gt; callback = a); uiServicemock .Setup(svc =&gt; svc.ShowView(ViewNames.QuestionnaireTemplatesList)) .Callback&lt;string&gt;(viewName =&gt; requestedViewName = viewName); submitResultMock .Setup(sr =&gt; sr.Error) .Returns&lt;Exception&gt;(null); CompleteQuestionnaire(viewModel); viewModel.Submit(); //      UI . callback(submitResultMock.Object); //    ‚Äì     . Assert.AreEqual(ViewNames.QuestionnaireTemplatesList, requestedViewName);</code> <br> <b></b> <br>          ,        . <br>   <br>       , . "Trees in WPF"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ms753391.aspx">http://msdn.microsoft.com/en-us/library/ms753391.aspx</a> <br> <br>       , . "Attached Properties Overview"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/cc265152(VS.95).aspx">http://msdn.microsoft.com/en-us/library/cc265152(VS.95).aspx</a> <br> <br>      MEF, ."Managed Extensibility Framework Overview"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/dd460648.aspx">http://msdn.microsoft.com/en-us/library/dd460648.aspx</a> . <br> <br>      Unity, ."Unity Application Block"  MSDN: <a href="http://www.msdn.com/unity">http://www.msdn.com/unity</a> . <br> <br>      <code>DelegateCommand</code> , .Chapter 5, " <a href="http://msdn.microsoft.com/en-us/library/gg405484(v%3DPandP.40).aspx">Implementing the MVVM Pattern</a> ." <br> <br>        Microsoft Expression Blend, ."Working with built-in behaviors"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ff724013(v%3DExpression.40).aspx">http://msdn.microsoft.com/en-us/library/ff724013(v=Expression.40).aspx</a> . <br> <br>          Microsoft Expression Blend, ."Creating Custom Behaviors"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ff724708(v%3DExpression.40).aspx">http://msdn.microsoft.com/en-us/library/ff724708(v=Expression.40).aspx</a> . <br> <br>            Microsoft Expression Blend, ."Creating Custom Triggers and Actions"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ff724707(v%3DExpression.40).aspx">http://msdn.microsoft.com/en-us/library/ff724707(v=Expression.40).aspx</a> . <br> <br>         WPF  Silverlight, ."Threading Model"  "The Dispatcher Class"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ms741870.aspx">http://msdn.microsoft.com/en-us/library/ms741870.aspx</a> <br> <a href="http://msdn.microsoft.com/en-us/library/ms615907(v%3DVS.95).aspx">http://msdn.microsoft.com/en-us/library/ms615907(v=VS.95).aspx</a> . <br> <br>      unit-  Silverlight, ."Unit Testing with Silverlight 2": <a href="http://www.jeff.wilcox.name/2008/03/silverlight2-unit-testing/">http://www.jeff.wilcox.name/2008/03/silverlight2-unit-testing/</a> . <br> <br>         , .  " <a href="http://msdn.microsoft.com/en-us/library/gg430861(v%3DPandP.40).aspx">View-Based Navigation</a> " in Chapter 8, " <a href="http://msdn.microsoft.com/en-us/library/gg430861(v%3DPandP.40).aspx">Navigation</a> ." <br> <br>       ,   , ."Event-based Asynchronous Pattern Overview"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/wewwczdw.aspx">http://msdn.microsoft.com/en-us/library/wewwczdw.aspx</a> <br> <br>        <code>IAsyncResult</code> , ."Asynchronous Programming Overview"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ms228963.aspx">http://msdn.microsoft.com/en-us/library/ms228963.aspx</a></code></code></code></code></code></code></code></code></code> </h4> <code><code><code><code>CommandBehaviorBase ,    ,    ICommand</code> .           <code>CanExecuteChanged</code> ,          Silverlight,    WPF. <br> <br>    ,  ,   <code>CommandBehaviorBase    ,    .         ,      .         ,    .      ButtonBaseClickCommandBehavior</code> . <br> <br> <code class="cs">public class ButtonBaseClickCommandBehavior : CommandBehaviorBase&lt;ButtonBase&gt; { public ButtonBaseClickCommandBehavior(ButtonBase clickableObject) : base(clickableObject) { clickableObject.Click += OnClick; } private void OnClick(object sender, System.Windows.RoutedEventArgs e) { ExecuteCommand(); } }</code> <br>   <code>CommandBehaviorBase ,     .     ,          ,   . ,    ,    ,      , ,    CanExecute</code>  ,     . <br> <br>          ,   .           XAML.           .       .  Prism      ,       ,  ,   .       ,    . , ,  ,      <code>Click</code> ,       <code>Command</code> .    <code>Click.Command</code> ,  . <br> <br>             .             . <br> <br> <code class="cs">public static readonly DependencyProperty CommandProperty = DependencyProperty.RegisterAttached( "Command", typeof(ICommand), typeof(Click), new PropertyMetadata(OnSetCommandCallback)); private static readonly DependencyProperty ClickCommandBehaviorProperty = DependencyProperty.RegisterAttached( "ClickCommandBehavior", typeof(ButtonBaseClickCommandBehavior), typeof(Click), null);</code> <br>    <code>Command</code>    <code>ButtonBaseClickCommandBehavior</code> ,     <code>OnSetCommandCallback</code> ,     . <br> <br> <code class="cs">private static void OnSetCommandCallback(DependencyObject dependencyObject, DependencyPropertyChangedEventArgs e) { ButtonBase buttonBase = dependencyObject as ButtonBase; if (buttonBase != null) { ButtonBaseClickCommandBehavior behavior = GetOrCreateBehavior(buttonBase); behavior.Command = e.NewValue as ICommand; } } private static void OnSetCommandParameterCallback(DependencyObject dependencyObject, DependencyPropertyChangedEventArgs e) { ButtonBase buttonBase = dependencyObject as ButtonBase; if (buttonBase != null) { ButtonBaseClickCommandBehavior behavior = GetOrCreateBehavior(buttonBase); behavior.CommandParameter = e.NewValue; } } private static ButtonBaseClickCommandBehavior GetOrCreateBehavior(ButtonBase buttonBase ) { ButtonBaseClickCommandBehavior behavior = buttonBase.GetValue(ClickCommandBehaviorProperty) as ButtonBaseClickCommandBehavior; if ( behavior == null ) { behavior = new ButtonBaseClickCommandBehavior(buttonBase); buttonBase.SetValue(ClickCommandBehaviorProperty, behavior); } return behavior; }</code> <br>        ,  <a href="http://msdn.microsoft.com/en-us/library/cc265152(VS.95).aspx">Attached Properties Overview</a>  MSDN. <br> <br>    <br>              . ,     Silverlight,    -,     ,      ,     .     ,       . <br> <br>        ,    ( )  ,  ,     .  UI       ,            UI. <br> <br>      - <br>   -     ,       <code>IAsyncResult</code> .   ,  ,   ,  <code>GetQuestionnaire</code> ,   : <code>BeginGetQuestionnaire</code>  <code>EndGetQuestionnaire</code> .    ,   <code>BeginGetQuestionnaire</code> .     ,   ,   <code>EndGetQuestionnaire</code>    . <br> <b></b> <br>  .NET Framework 4.5      <code>await</code>  <code>async</code>     <code>*Async</code> .      <a href="http://msdn.microsoft.com/en-us/library/vstudio/hh391443.aspx">"Asynchronous Programming with Async and Await (C# and Visual Basic)"</a> . <br>  ,    <code>EndGetQuestionnaire</code> ,      ,  ()      <code>BeginGetQuestionnaire</code> .     ,      ,   <code>EndGetQuestionnaire</code> ,   . <br> <br> <code class="xml">IAsyncResult asyncResult = this.service.BeginGetQuestionnaire( GetQuestionnaireCompleted, null //  ,      ); private void GetQuestionnaireCompleted(IAsyncResult result) { try { questionnaire = this.service.EndGetQuestionnaire(ar); } catch (Exception ex) { //  -   . } }</code> <br>  ,     <code>End*</code> (  , <code>EndGetQuestionnaire</code> ),    ,      .      , ,          UI.     ,   ,        . <br> <br>        UI,     -,      UI,         UI,   <code>Dispatcher</code>    <code>SynchronizationContext</code> .  WPF  Silverlight,   <code>Dispatcher</code> . <br> <br>      <code>Questionnaire</code>  ,        <code>QuestionnaireView</code> .  Silverlight    <code>CheckAccess</code> ,  ,      UI.  ,     <code>BeginInvoke</code> ,      UI. <br> <br> <code class="cs">var dispatcher = System.Windows.Deployment.Current.Dispatcher; if (dispatcher.CheckAccess()) { QuestionnaireView.DataContext = questionnaire; } else { dispatcher.BeginInvoke(() =&gt; { Questionnaire.DataContext = questionnaire; }); }</code> <br> <i>MVVM RI</i>   ,    ,   <code>IAsyncResult</code> ,   .      ,                 . ,       . <br> <br> <code class="cs">this.questionnaireRepository.GetQuestionnaireAsync( result =&gt; { this.Questionnaire = result.Result; });</code> <br>  <code>result</code>   ,     , , , .    ,     . <br> <br> <code class="cs">this.questionnaireRepository.GetQuestionnaireAsync( result =&gt; { if (result.Error == null) { this.Questionnaire = result.Result; ... } else { // Handle error. } })</code> <br>     <br>        ,      .     , ,             .        ,      ,     ,     . <br> <br>         ,      MVVM,     ,   . ,  -MVVM ,     <code>MessageBox</code>   code-behind UI,      .   MVVM     ,          . <br> <br>     MVVM,              ,          .      ,    ,   ,  ,     . <br> <br>              MVVM.      ,     ,     ,  ,     .    ,         ,     ,          .       . <br> <br>    <br>                  .        ,        .  ,         .         . <br> <br>  ,         ,         ,  .      ,     .           ,       . ,        WPF  Silverlight,        . <br> <br> <img title="Using the service to interact with the user." src="https://habrastorage.org/getpro/habr/post_images/4b5/397/f2d/4b5397f2d02e5851195b29f1893be6fc.png" alt=" ,    ."> <br> <br>  ,   <code>MessageBox</code>        ,     ,    ,     . <br> <br> <code class="cs">var result = interactionService.ShowMessageBox( "Are you sure you want to cancel this operation?", "Confirm", MessageBoxButton.OK); if (result == MessageBoxResult.Yes) { CancelRequest(); }</code> <br> ,      - ,      ,         Silverlight.         .             .     . <br> <br> <code class="cs">interactionService.ShowMessageBox( "Are you sure you want to cancel this operation?", "Confirm", MessageBoxButton.OK, result =&gt; { if (result == MessageBoxResult.Yes) { CancelRequest(); } });</code> <br>         ,      . ,  WPF    <code>MessageBox</code> ,       ;    Silverlight    ,    . <br> <br>     <br>         ‚Äì             .         ,      .     ,     .        ,        ,   ,     . <br> <br> <img title="Using interaction request objects." src="https://habrastorage.org/getpro/habr/post_images/3d0/ff0/1c5/3d0ff01c5518558c2d3c5c5f47ce0ce9.png" alt="   ."> <br> <br>    ,   ,          ‚Äì       ,      ,   ‚Äì     .   ,        ,    ,    UI            . <br> <br>       MVVM,     ,       ,         .         ,        ,    ,   . <br> <br>  Prism       <code>IInteractionRequest</code>   <code><code>InteractionRequest .  IInteractionRequest</code>  ,   .           ,   .  <code><code>InteractionRequest   IInteractionRequest</code>     <code>Raise</code> ,           , , ,   . <br> <br>       <br>  <code><code>InteractionRequest          .  Raise</code>          ( <code>T</code> )    ,    ,   .          ,       .      ,        .    ,  ,     . <br> <code class="cs">public interface IInteractionRequest { event EventHandler&lt;InteractionRequestedEventArgs&gt; Raised; } public class InteractionRequest&lt;T&gt; : IInteractionRequest { public event EventHandler&lt;InteractionRequestedEventArgs&gt; Raised; public void Raise(T context, Action&lt;T&gt; callback) { var handler = this.Raised; if (handler != null) { handler( this, new InteractionRequestedEventArgs(context, () =&gt; callback(context))); } } }</code> <br> Prism    ,      .  <code>Notification</code>       .    ,            .     ‚Äì <code>Title</code>  <code>Content</code> ,    .  ,   ,  ,  ,        . <br> <br>  <code>Confirmation</code>    <code>Notification</code>     ‚Äì <code>Confirmed</code> ,  ,  ,      .  <code>Confirmation</code> ,     <code>MessageBox</code> ,     /  .     ,     <code>Notification</code> ,     ,      . <br> <br>    <code><code><code>InteractionRequest ,       InteractionRequest      ,      .      ,    Raise</code> ,    , ,   . <br> <br> <code class="cs">public IInteractionRequest ConfirmCancelInteractionRequest { get { return this.confirmCancelInteractionRequest; } } this.confirmCancelInteractionRequest.Raise( new Confirmation("Are you sure you wish to cancel?"), confirmation =&gt; { if (confirmation.Confirmed) { this.NavigateToQuestionnaireList(); } }); }</code> <br> <i>MVVM Reference Implementation (MVVM RI)</i> ,    <code>IInteractionRequest</code>   <code><code>InteractionRequest ,          (. QuestionnaireViewModel.cs</code> ). <br> <br>        <br>       ,       .   ,       .    UI             . <br> <br>                . Microsoft Expression Blend Behaviors Framework     .  ,     ,    . <br> <br>  <code>EventTrigger</code> ,  Expression Blend,  ,      ,     ,   . , Prism   <code>EventTrigger</code> ,  <code>InteractionRequestTrigger</code> ,      <code>Raised</code>   <code>IInteractionRequest</code> .    XAML        . <br> <br>  ,   , <code>InteractionRequestTrigger</code>   .  Silverlight Prism   <code>PopupChildWindowAction</code> ,     .    ,         .   <code>ContentTemplate</code>  <code>PopupChildWindowAction</code> ,    ,    UI,      <code>Content</code>  .       <code>Title</code>  . <br> <b></b> <br>  ,    ,   <code>PopupChildWindowAction</code> ,     .    <code>Notification</code>  <code>NotificationChildWindow</code> ,        <code>Confirmation</code> ‚Äì <code>ConfirmationChildWindow</code> . <code>NotificationChildWindow</code>    ,   ,     <code>ConfirmationChildWindow</code>    <i>OK</i>  <i>Cancel</i> ,    .    ,   ,   <code>ChildWindow</code>  <code>PopupChildWindowAction</code> . <br>   ,  <code>InteractionRequestTrigger</code>  <code>PopupChildWindowAction</code> ,       <i>RI MVVM</i> . <br> <br> <code class="xml">&lt;i:Interaction.Triggers&gt; &lt;prism:InteractionRequestTrigger SourceObject="{Binding ConfirmCancelInteractionRequest}"&gt; &lt;prism:PopupChildWindowAction ContentTemplate="{StaticResource ConfirmWindowTemplate}"/&gt; &lt;/prism:InteractionRequestTrigger&gt; &lt;/i:Interaction.Triggers&gt; &lt;UserControl.Resources&gt; &lt;DataTemplate x:Key="ConfirmWindowTemplate"&gt; &lt;Grid MinWidth="250" MinHeight="100"&gt; &lt;TextBlock TextWrapping="Wrap" Grid.Row="0" Text="{Binding}"/&gt; &lt;/Grid&gt; &lt;/DataTemplate&gt; &lt;/UserControl.Resources&gt;</code> <br> <b></b> <br>      <code>ContentTemplate</code> ,   UI   <code>Content</code>  .    <code>Content</code>  ,  , <code>TextBlock</code>     <code>Content</code> . <br>      ,     ,    ,    .  ,     ,       ,     ,    .   ,   <i>RI MVVM</i> ,         <code>Confirmed</code>    <code>Confirmation</code>  <code>true</code> ,     OK. <br> <br>        ,     .  Prism <code>InteractionRequestTrigger</code>   <code>PopupChildWindowAction</code>            . <br> <br>     <br>     MVVM,       , ,    ,         .        (  , ,  ,   ).    ,  ,  ,            . <br> <br>        ,         . Managed Extensibility Framework (MEF)  Unity Application Block (Unity)      ,  ,           . <br> <br>  ,       , , ,    ( )      . ,       ,     .  ,     ,       . <br> <br>     ,  MEF <br>  MEF,       ,   <code>Import</code> ,      ,  ,   <code>Export</code> .         ,    . <br> <br> , <code>QuestionnaireView</code>   <i>RI MVVM</i> ,        ,    <code>Import</code> .   , MEF           .  <code>set</code>        ,   . <br> <br> <code class="cs">[Import] public QuestionnaireViewModel ViewModel { set { this.DataContext = value; } }</code> <br>     ,   . <br> <br> <code class="cs">[Export] public class QuestionnaireViewModel : NotificationObject { ... }</code> <br>        ,   . <br> <br> <code class="cs">public QuestionnaireView() { InitializeComponent(); } [ImportingConstructor] public QuestionnaireView(QuestionnaireViewModel viewModel) : this() { this.DataContext = viewModel; }</code> <br> <b></b> <br>          MEF,   Unity.   ,     ,        .   ,   Visual Studio  Expression Blend, ,        ,     .   ,   ,  ,      ,          <code>InitializeComponent</code> . <br>     ,  Unity <br>  Unity,    ,   MEF.     ,      .    ,         .  ,      . <br> <br>  ,      ,  ,         . ,           ,   . <br> <br> <code class="cs">public QuestionnaireView() { InitializeComponent(); } public QuestionnaireView(QuestionnaireViewModel viewModel) : this() { this.DataContext = viewModel; }</code> <br> <b></b> <br>    ,        ,   Visual Studio  Expression Blend. <br>  ,          ,   . Unity        <code>set</code>   ,   . <br> <br> <code class="cs">public QuestionnaireView() { InitializeComponent(); } [Dependency] public QuestionnaireViewModel ViewModel { set { this.DataContext = value; } }</code> <br>       Unity. <br> <br> <code class="cs">container.RegisterType&lt;QuestionnaireViewModel&gt;();</code> <br>  ,     . <br> <br> <code class="cs">var view = container.Resolve&lt;QuestionnaireView&gt;();</code> <br>     ,    <br>   ,     ,        .        ,   MEF  Unity,        . <br> <br>          .   ,         UI,           . <br> <br> , <i>RI MVVM</i>   ,   ,        .   ,    .      <code>ShowView</code>   UI. <br> <br> <code class="cs">private void NavigateToQuestionnaireList() { //     "questionnaire list". this.uiService.ShowView(ViewNames.QuestionnaireTemplatesList); }</code> <br>  UI      UI .           UI.  <code>ShowView</code>  <code>UIService</code>      (,          ),       ,   . <br> <br> <code class="cs">public void ShowView(string viewName) { var view = this.ViewFactory.GetView(viewName); this.MainWindow.CurrentView = view; }</code> <br> <b></b> <br> Prism       .   ,   ,   ,             .    ,  , " <a href="http://msdn.microsoft.com/en-us/library/gg430861(v%3DPandP.40).aspx">View-Based Navigation</a> "   8, " <a href="http://msdn.microsoft.com/en-us/library/gg430861(v%3DPandP.40).aspx">Navigation</a> ". <br>  MVVM  <br>        MVVM      .           -      mocking . ,   ,        . <br> <br>   <i>INotifyPropertyChanged</i> <br>   <code>INotifyPropertyChanged</code>     ,      .      ,    ;   ,   ,     ,    ,       . <br> <br>   <br> ,       ,           <code>PropertyChanged</code>  ,         .  ,    <code>ChangeTracker</code> ,     MVVM,  ,      .      .     ,    . <br> <br> <code class="cs">var changeTracker = new PropertyChangeTracker(viewModel); viewModel.CurrentState = "newState"; CollectionAssert.Contains(changeTracker.ChangedProperties, "CurrentState");</code> <br> ,     ,     <code>INotifyPropertyChanged</code> ,    ,   ,     . <br> <br>      <br>        ,   ,    <code>set</code>      ,           . ,     ,     ,      ,          . <br> <br> <code class="cs">var changeTracker = new PropertyChangeTracker(viewModel); var question = viewModel.Questions.First() as OpenQuestionViewModel; question.Question.Response = "some text"; CollectionAssert.Contains(changeTracker.ChangedProperties, "UnansweredQuestions");</code> <br>      <br>     <code>INotifyPropertyChanged</code> ,      <code>PropertyChanged</code>        ,  ,     , , .        ,       . <br> <br>   <i>INotifyDataErrorInfo</i> <br>   ,     ,    ,   ,   <code>IDataErrorInfo</code> ,  ( Silverlight)   <code>INotifyDataErrorInfo</code> .   <code>INotifyDataErrorInfo</code>   ,         ,    ,  ,   ,    . <br> <br>       <code>INotifyDataErrorInfo</code> : ,     ,  ,     ,     <code>ErrorsChanged</code> ,      <code>GetErrors</code> , . <br> <br>    <br>     ,      ,     .       ,         <code>GetErrors</code>       ,  ,  ,   .    , ,  ,     ,        .   ,        . <br> <br> <code class="cs">//  . var notifyErrorInfo = (INotifyDataErrorInfo)question; question.Response = -15; Assert.IsTrue(notifyErrorInfo.GetErrors("Response").Cast&lt;ValidationResult&gt;().Any()); //  . var notifyErrorInfo = (INotifyDataErrorInfo)question; question.Response = 15; Assert.IsFalse(notifyErrorInfo.GetErrors("Response").Cast&lt;ValidationResult&gt;().Any());</code> <br>    ,    ,             . <br> <br>    <i>INotifyDataErrorInfo</i> <br>       <code>GetErrors</code> ,   <code>INotifyDataErrorInfo</code>  ,   <code>ErrorsChanged</code>      <code>GetErrors</code> . ,  <code>HasErrors</code>      ,  . <br> <br>       <code>INotifyDataErrorInfo</code> . , ,           ,   -  .      ,        <code>INotifyDataErrorInfo</code>         (,        ). <br> <br>     ,   ,  : <br>  <code>HasErrors</code>     .              ,       .  <code>ErrorsChanged</code> ,      ,         <code>GetErrors</code> .         ( ,  )     ,           .    <code>GetErrors</code>       <code>ErrorsChanged</code> . <br>    <code>INotifyPropertyChanged</code> ,  ,    <code>NotifyDataErrorInfoTestHelper</code>    MVVM,        <code>INotifyDataErrorInfo</code> ,       .   ,   ,      ,   .      . <br> <code class="cs">var helper = new NotifyDataErrorInfoTestHelper&lt;NumericQuestion, int?&gt;( question, q =&gt; q.Response); helper.ValidatePropertyChange( 6, NotifyDataErrorInfoBehavior.Nothing); helper.ValidatePropertyChange( 20, NotifyDataErrorInfoBehavior.FiresErrorsChanged | NotifyDataErrorInfoBehavior.HasErrors | NotifyDataErrorInfoBehavior.HasErrorsForProperty); helper.ValidatePropertyChange( null, NotifyDataErrorInfoBehavior.FiresErrorsChanged | NotifyDataErrorInfoBehavior.HasErrors | NotifyDataErrorInfoBehavior.HasErrorsForProperty); helper.ValidatePropertyChange( 2, NotifyDataErrorInfoBehavior.FiresErrorsChanged);</code> <br>     <br>   MVVM,     ,  .   ,    ,         . <br> <br>  ,     ,     ,       .   ,   , ,       ,     ,   <code>IAsyncResult</code>    ,  - ,   ,    UI. <br> <br>       , , ,    .   ,     .  ,      UI,     ,   ,          ,     ,        "   UI." <br> <br>     ,    ,    .   ,    ,     mock-, ,   ,   ,      ,          . <br> <br>           UI,    ,    .   ,     ,   ,      .        ,   .     ,    ,     . <br> <br> <code class="cs">questionnaireRepositoryMock .Setup( r =&gt; r.SubmitQuestionnaireAsync( It.IsAny&lt;Questionnaire&gt;(), It.IsAny&lt;Action&lt;IOperationResult&gt;&gt;())) .Callback&lt;Questionnaire, Action&lt;IOperationResult&gt;&gt;( (q, a) =&gt; callback = a); uiServicemock .Setup(svc =&gt; svc.ShowView(ViewNames.QuestionnaireTemplatesList)) .Callback&lt;string&gt;(viewName =&gt; requestedViewName = viewName); submitResultMock .Setup(sr =&gt; sr.Error) .Returns&lt;Exception&gt;(null); CompleteQuestionnaire(viewModel); viewModel.Submit(); //      UI . callback(submitResultMock.Object); //    ‚Äì     . Assert.AreEqual(ViewNames.QuestionnaireTemplatesList, requestedViewName);</code> <br> <b></b> <br>          ,        . <br>   <br>       , . "Trees in WPF"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ms753391.aspx">http://msdn.microsoft.com/en-us/library/ms753391.aspx</a> <br> <br>       , . "Attached Properties Overview"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/cc265152(VS.95).aspx">http://msdn.microsoft.com/en-us/library/cc265152(VS.95).aspx</a> <br> <br>      MEF, ."Managed Extensibility Framework Overview"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/dd460648.aspx">http://msdn.microsoft.com/en-us/library/dd460648.aspx</a> . <br> <br>      Unity, ."Unity Application Block"  MSDN: <a href="http://www.msdn.com/unity">http://www.msdn.com/unity</a> . <br> <br>      <code>DelegateCommand</code> , .Chapter 5, " <a href="http://msdn.microsoft.com/en-us/library/gg405484(v%3DPandP.40).aspx">Implementing the MVVM Pattern</a> ." <br> <br>        Microsoft Expression Blend, ."Working with built-in behaviors"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ff724013(v%3DExpression.40).aspx">http://msdn.microsoft.com/en-us/library/ff724013(v=Expression.40).aspx</a> . <br> <br>          Microsoft Expression Blend, ."Creating Custom Behaviors"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ff724708(v%3DExpression.40).aspx">http://msdn.microsoft.com/en-us/library/ff724708(v=Expression.40).aspx</a> . <br> <br>            Microsoft Expression Blend, ."Creating Custom Triggers and Actions"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ff724707(v%3DExpression.40).aspx">http://msdn.microsoft.com/en-us/library/ff724707(v=Expression.40).aspx</a> . <br> <br>         WPF  Silverlight, ."Threading Model"  "The Dispatcher Class"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ms741870.aspx">http://msdn.microsoft.com/en-us/library/ms741870.aspx</a> <br> <a href="http://msdn.microsoft.com/en-us/library/ms615907(v%3DVS.95).aspx">http://msdn.microsoft.com/en-us/library/ms615907(v=VS.95).aspx</a> . <br> <br>      unit-  Silverlight, ."Unit Testing with Silverlight 2": <a href="http://www.jeff.wilcox.name/2008/03/silverlight2-unit-testing/">http://www.jeff.wilcox.name/2008/03/silverlight2-unit-testing/</a> . <br> <br>         , .  " <a href="http://msdn.microsoft.com/en-us/library/gg430861(v%3DPandP.40).aspx">View-Based Navigation</a> " in Chapter 8, " <a href="http://msdn.microsoft.com/en-us/library/gg430861(v%3DPandP.40).aspx">Navigation</a> ." <br> <br>       ,   , ."Event-based Asynchronous Pattern Overview"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/wewwczdw.aspx">http://msdn.microsoft.com/en-us/library/wewwczdw.aspx</a> <br> <br>        <code>IAsyncResult</code> , ."Asynchronous Programming Overview"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ms228963.aspx">http://msdn.microsoft.com/en-us/library/ms228963.aspx</a></code></code></code></code></code></code></code></code></code> <h5> <code><code><code><code><code><code>CommandBehaviorBase ,    ,    ICommand</code> .           <code>CanExecuteChanged</code> ,          Silverlight,    WPF. <br> <br>    ,  ,   <code>CommandBehaviorBase    ,    .         ,      .         ,    .      ButtonBaseClickCommandBehavior</code> . <br> <br> <code class="cs">public class ButtonBaseClickCommandBehavior : CommandBehaviorBase&lt;ButtonBase&gt; { public ButtonBaseClickCommandBehavior(ButtonBase clickableObject) : base(clickableObject) { clickableObject.Click += OnClick; } private void OnClick(object sender, System.Windows.RoutedEventArgs e) { ExecuteCommand(); } }</code> <br>   <code>CommandBehaviorBase ,     .     ,          ,   . ,    ,    ,      , ,    CanExecute</code>  ,     . <br> <br>          ,   .           XAML.           .       .  Prism      ,       ,  ,   .       ,    . , ,  ,      <code>Click</code> ,       <code>Command</code> .    <code>Click.Command</code> ,  . <br> <br>             .             . <br> <br> <code class="cs">public static readonly DependencyProperty CommandProperty = DependencyProperty.RegisterAttached( "Command", typeof(ICommand), typeof(Click), new PropertyMetadata(OnSetCommandCallback)); private static readonly DependencyProperty ClickCommandBehaviorProperty = DependencyProperty.RegisterAttached( "ClickCommandBehavior", typeof(ButtonBaseClickCommandBehavior), typeof(Click), null);</code> <br>    <code>Command</code>    <code>ButtonBaseClickCommandBehavior</code> ,     <code>OnSetCommandCallback</code> ,     . <br> <br> <code class="cs">private static void OnSetCommandCallback(DependencyObject dependencyObject, DependencyPropertyChangedEventArgs e) { ButtonBase buttonBase = dependencyObject as ButtonBase; if (buttonBase != null) { ButtonBaseClickCommandBehavior behavior = GetOrCreateBehavior(buttonBase); behavior.Command = e.NewValue as ICommand; } } private static void OnSetCommandParameterCallback(DependencyObject dependencyObject, DependencyPropertyChangedEventArgs e) { ButtonBase buttonBase = dependencyObject as ButtonBase; if (buttonBase != null) { ButtonBaseClickCommandBehavior behavior = GetOrCreateBehavior(buttonBase); behavior.CommandParameter = e.NewValue; } } private static ButtonBaseClickCommandBehavior GetOrCreateBehavior(ButtonBase buttonBase ) { ButtonBaseClickCommandBehavior behavior = buttonBase.GetValue(ClickCommandBehaviorProperty) as ButtonBaseClickCommandBehavior; if ( behavior == null ) { behavior = new ButtonBaseClickCommandBehavior(buttonBase); buttonBase.SetValue(ClickCommandBehaviorProperty, behavior); } return behavior; }</code> <br>        ,  <a href="http://msdn.microsoft.com/en-us/library/cc265152(VS.95).aspx">Attached Properties Overview</a>  MSDN. <br> <br>    <br>              . ,     Silverlight,    -,     ,      ,     .     ,       . <br> <br>        ,    ( )  ,  ,     .  UI       ,            UI. <br> <br>      - <br>   -     ,       <code>IAsyncResult</code> .   ,  ,   ,  <code>GetQuestionnaire</code> ,   : <code>BeginGetQuestionnaire</code>  <code>EndGetQuestionnaire</code> .    ,   <code>BeginGetQuestionnaire</code> .     ,   ,   <code>EndGetQuestionnaire</code>    . <br> <b></b> <br>  .NET Framework 4.5      <code>await</code>  <code>async</code>     <code>*Async</code> .      <a href="http://msdn.microsoft.com/en-us/library/vstudio/hh391443.aspx">"Asynchronous Programming with Async and Await (C# and Visual Basic)"</a> . <br>  ,    <code>EndGetQuestionnaire</code> ,      ,  ()      <code>BeginGetQuestionnaire</code> .     ,      ,   <code>EndGetQuestionnaire</code> ,   . <br> <br> <code class="xml">IAsyncResult asyncResult = this.service.BeginGetQuestionnaire( GetQuestionnaireCompleted, null //  ,      ); private void GetQuestionnaireCompleted(IAsyncResult result) { try { questionnaire = this.service.EndGetQuestionnaire(ar); } catch (Exception ex) { //  -   . } }</code> <br>  ,     <code>End*</code> (  , <code>EndGetQuestionnaire</code> ),    ,      .      , ,          UI.     ,   ,        . <br> <br>        UI,     -,      UI,         UI,   <code>Dispatcher</code>    <code>SynchronizationContext</code> .  WPF  Silverlight,   <code>Dispatcher</code> . <br> <br>      <code>Questionnaire</code>  ,        <code>QuestionnaireView</code> .  Silverlight    <code>CheckAccess</code> ,  ,      UI.  ,     <code>BeginInvoke</code> ,      UI. <br> <br> <code class="cs">var dispatcher = System.Windows.Deployment.Current.Dispatcher; if (dispatcher.CheckAccess()) { QuestionnaireView.DataContext = questionnaire; } else { dispatcher.BeginInvoke(() =&gt; { Questionnaire.DataContext = questionnaire; }); }</code> <br> <i>MVVM RI</i>   ,    ,   <code>IAsyncResult</code> ,   .      ,                 . ,       . <br> <br> <code class="cs">this.questionnaireRepository.GetQuestionnaireAsync( result =&gt; { this.Questionnaire = result.Result; });</code> <br>  <code>result</code>   ,     , , , .    ,     . <br> <br> <code class="cs">this.questionnaireRepository.GetQuestionnaireAsync( result =&gt; { if (result.Error == null) { this.Questionnaire = result.Result; ... } else { // Handle error. } })</code> <br>     <br>        ,      .     , ,             .        ,      ,     ,     . <br> <br>         ,      MVVM,     ,   . ,  -MVVM ,     <code>MessageBox</code>   code-behind UI,      .   MVVM     ,          . <br> <br>     MVVM,              ,          .      ,    ,   ,  ,     . <br> <br>              MVVM.      ,     ,     ,  ,     .    ,         ,     ,          .       . <br> <br>    <br>                  .        ,        .  ,         .         . <br> <br>  ,         ,         ,  .      ,     .           ,       . ,        WPF  Silverlight,        . <br> <br> <img title="Using the service to interact with the user." src="https://habrastorage.org/getpro/habr/post_images/4b5/397/f2d/4b5397f2d02e5851195b29f1893be6fc.png" alt=" ,    ."> <br> <br>  ,   <code>MessageBox</code>        ,     ,    ,     . <br> <br> <code class="cs">var result = interactionService.ShowMessageBox( "Are you sure you want to cancel this operation?", "Confirm", MessageBoxButton.OK); if (result == MessageBoxResult.Yes) { CancelRequest(); }</code> <br> ,      - ,      ,         Silverlight.         .             .     . <br> <br> <code class="cs">interactionService.ShowMessageBox( "Are you sure you want to cancel this operation?", "Confirm", MessageBoxButton.OK, result =&gt; { if (result == MessageBoxResult.Yes) { CancelRequest(); } });</code> <br>         ,      . ,  WPF    <code>MessageBox</code> ,       ;    Silverlight    ,    . <br> <br>     <br>         ‚Äì             .         ,      .     ,     .        ,        ,   ,     . <br> <br> <img title="Using interaction request objects." src="https://habrastorage.org/getpro/habr/post_images/3d0/ff0/1c5/3d0ff01c5518558c2d3c5c5f47ce0ce9.png" alt="   ."> <br> <br>    ,   ,          ‚Äì       ,      ,   ‚Äì     .   ,        ,    ,    UI            . <br> <br>       MVVM,     ,       ,         .         ,        ,    ,   . <br> <br>  Prism       <code>IInteractionRequest</code>   <code>InteractionRequest .  IInteractionRequest</code>  ,   .           ,   .  <code>InteractionRequest   IInteractionRequest</code>     <code>Raise</code> ,           , , ,   . <br> <br>       <br>  <code><code>InteractionRequest          .  Raise</code>          ( <code>T</code> )    ,    ,   .          ,       .      ,        .    ,  ,     . <br> <code class="cs">public interface IInteractionRequest { event EventHandler&lt;InteractionRequestedEventArgs&gt; Raised; } public class InteractionRequest&lt;T&gt; : IInteractionRequest { public event EventHandler&lt;InteractionRequestedEventArgs&gt; Raised; public void Raise(T context, Action&lt;T&gt; callback) { var handler = this.Raised; if (handler != null) { handler( this, new InteractionRequestedEventArgs(context, () =&gt; callback(context))); } } }</code> <br> Prism    ,      .  <code>Notification</code>       .    ,            .     ‚Äì <code>Title</code>  <code>Content</code> ,    .  ,   ,  ,  ,        . <br> <br>  <code>Confirmation</code>    <code>Notification</code>     ‚Äì <code>Confirmed</code> ,  ,  ,      .  <code>Confirmation</code> ,     <code>MessageBox</code> ,     /  .     ,     <code>Notification</code> ,     ,      . <br> <br>    <code><code><code>InteractionRequest ,       InteractionRequest      ,      .      ,    Raise</code> ,    , ,   . <br> <br> <code class="cs">public IInteractionRequest ConfirmCancelInteractionRequest { get { return this.confirmCancelInteractionRequest; } } this.confirmCancelInteractionRequest.Raise( new Confirmation("Are you sure you wish to cancel?"), confirmation =&gt; { if (confirmation.Confirmed) { this.NavigateToQuestionnaireList(); } }); }</code> <br> <i>MVVM Reference Implementation (MVVM RI)</i> ,    <code>IInteractionRequest</code>   <code><code>InteractionRequest ,          (. QuestionnaireViewModel.cs</code> ). <br> <br>        <br>       ,       .   ,       .    UI             . <br> <br>                . Microsoft Expression Blend Behaviors Framework     .  ,     ,    . <br> <br>  <code>EventTrigger</code> ,  Expression Blend,  ,      ,     ,   . , Prism   <code>EventTrigger</code> ,  <code>InteractionRequestTrigger</code> ,      <code>Raised</code>   <code>IInteractionRequest</code> .    XAML        . <br> <br>  ,   , <code>InteractionRequestTrigger</code>   .  Silverlight Prism   <code>PopupChildWindowAction</code> ,     .    ,         .   <code>ContentTemplate</code>  <code>PopupChildWindowAction</code> ,    ,    UI,      <code>Content</code>  .       <code>Title</code>  . <br> <b></b> <br>  ,    ,   <code>PopupChildWindowAction</code> ,     .    <code>Notification</code>  <code>NotificationChildWindow</code> ,        <code>Confirmation</code> ‚Äì <code>ConfirmationChildWindow</code> . <code>NotificationChildWindow</code>    ,   ,     <code>ConfirmationChildWindow</code>    <i>OK</i>  <i>Cancel</i> ,    .    ,   ,   <code>ChildWindow</code>  <code>PopupChildWindowAction</code> . <br>   ,  <code>InteractionRequestTrigger</code>  <code>PopupChildWindowAction</code> ,       <i>RI MVVM</i> . <br> <br> <code class="xml">&lt;i:Interaction.Triggers&gt; &lt;prism:InteractionRequestTrigger SourceObject="{Binding ConfirmCancelInteractionRequest}"&gt; &lt;prism:PopupChildWindowAction ContentTemplate="{StaticResource ConfirmWindowTemplate}"/&gt; &lt;/prism:InteractionRequestTrigger&gt; &lt;/i:Interaction.Triggers&gt; &lt;UserControl.Resources&gt; &lt;DataTemplate x:Key="ConfirmWindowTemplate"&gt; &lt;Grid MinWidth="250" MinHeight="100"&gt; &lt;TextBlock TextWrapping="Wrap" Grid.Row="0" Text="{Binding}"/&gt; &lt;/Grid&gt; &lt;/DataTemplate&gt; &lt;/UserControl.Resources&gt;</code> <br> <b></b> <br>      <code>ContentTemplate</code> ,   UI   <code>Content</code>  .    <code>Content</code>  ,  , <code>TextBlock</code>     <code>Content</code> . <br>      ,     ,    ,    .  ,     ,       ,     ,    .   ,   <i>RI MVVM</i> ,         <code>Confirmed</code>    <code>Confirmation</code>  <code>true</code> ,     OK. <br> <br>        ,     .  Prism <code>InteractionRequestTrigger</code>   <code>PopupChildWindowAction</code>            . <br> <br>     <br>     MVVM,       , ,    ,         .        (  , ,  ,   ).    ,  ,  ,            . <br> <br>        ,         . Managed Extensibility Framework (MEF)  Unity Application Block (Unity)      ,  ,           . <br> <br>  ,       , , ,    ( )      . ,       ,     .  ,     ,       . <br> <br>     ,  MEF <br>  MEF,       ,   <code>Import</code> ,      ,  ,   <code>Export</code> .         ,    . <br> <br> , <code>QuestionnaireView</code>   <i>RI MVVM</i> ,        ,    <code>Import</code> .   , MEF           .  <code>set</code>        ,   . <br> <br> <code class="cs">[Import] public QuestionnaireViewModel ViewModel { set { this.DataContext = value; } }</code> <br>     ,   . <br> <br> <code class="cs">[Export] public class QuestionnaireViewModel : NotificationObject { ... }</code> <br>        ,   . <br> <br> <code class="cs">public QuestionnaireView() { InitializeComponent(); } [ImportingConstructor] public QuestionnaireView(QuestionnaireViewModel viewModel) : this() { this.DataContext = viewModel; }</code> <br> <b></b> <br>          MEF,   Unity.   ,     ,        .   ,   Visual Studio  Expression Blend, ,        ,     .   ,   ,  ,      ,          <code>InitializeComponent</code> . <br>     ,  Unity <br>  Unity,    ,   MEF.     ,      .    ,         .  ,      . <br> <br>  ,      ,  ,         . ,           ,   . <br> <br> <code class="cs">public QuestionnaireView() { InitializeComponent(); } public QuestionnaireView(QuestionnaireViewModel viewModel) : this() { this.DataContext = viewModel; }</code> <br> <b></b> <br>    ,        ,   Visual Studio  Expression Blend. <br>  ,          ,   . Unity        <code>set</code>   ,   . <br> <br> <code class="cs">public QuestionnaireView() { InitializeComponent(); } [Dependency] public QuestionnaireViewModel ViewModel { set { this.DataContext = value; } }</code> <br>       Unity. <br> <br> <code class="cs">container.RegisterType&lt;QuestionnaireViewModel&gt;();</code> <br>  ,     . <br> <br> <code class="cs">var view = container.Resolve&lt;QuestionnaireView&gt;();</code> <br>     ,    <br>   ,     ,        .        ,   MEF  Unity,        . <br> <br>          .   ,         UI,           . <br> <br> , <i>RI MVVM</i>   ,   ,        .   ,    .      <code>ShowView</code>   UI. <br> <br> <code class="cs">private void NavigateToQuestionnaireList() { //     "questionnaire list". this.uiService.ShowView(ViewNames.QuestionnaireTemplatesList); }</code> <br>  UI      UI .           UI.  <code>ShowView</code>  <code>UIService</code>      (,          ),       ,   . <br> <br> <code class="cs">public void ShowView(string viewName) { var view = this.ViewFactory.GetView(viewName); this.MainWindow.CurrentView = view; }</code> <br> <b></b> <br> Prism       .   ,   ,   ,             .    ,  , " <a href="http://msdn.microsoft.com/en-us/library/gg430861(v%3DPandP.40).aspx">View-Based Navigation</a> "   8, " <a href="http://msdn.microsoft.com/en-us/library/gg430861(v%3DPandP.40).aspx">Navigation</a> ". <br>  MVVM  <br>        MVVM      .           -      mocking . ,   ,        . <br> <br>   <i>INotifyPropertyChanged</i> <br>   <code>INotifyPropertyChanged</code>     ,      .      ,    ;   ,   ,     ,    ,       . <br> <br>   <br> ,       ,           <code>PropertyChanged</code>  ,         .  ,    <code>ChangeTracker</code> ,     MVVM,  ,      .      .     ,    . <br> <br> <code class="cs">var changeTracker = new PropertyChangeTracker(viewModel); viewModel.CurrentState = "newState"; CollectionAssert.Contains(changeTracker.ChangedProperties, "CurrentState");</code> <br> ,     ,     <code>INotifyPropertyChanged</code> ,    ,   ,     . <br> <br>      <br>        ,   ,    <code>set</code>      ,           . ,     ,     ,      ,          . <br> <br> <code class="cs">var changeTracker = new PropertyChangeTracker(viewModel); var question = viewModel.Questions.First() as OpenQuestionViewModel; question.Question.Response = "some text"; CollectionAssert.Contains(changeTracker.ChangedProperties, "UnansweredQuestions");</code> <br>      <br>     <code>INotifyPropertyChanged</code> ,      <code>PropertyChanged</code>        ,  ,     , , .        ,       . <br> <br>   <i>INotifyDataErrorInfo</i> <br>   ,     ,    ,   ,   <code>IDataErrorInfo</code> ,  ( Silverlight)   <code>INotifyDataErrorInfo</code> .   <code>INotifyDataErrorInfo</code>   ,         ,    ,  ,   ,    . <br> <br>       <code>INotifyDataErrorInfo</code> : ,     ,  ,     ,     <code>ErrorsChanged</code> ,      <code>GetErrors</code> , . <br> <br>    <br>     ,      ,     .       ,         <code>GetErrors</code>       ,  ,  ,   .    , ,  ,     ,        .   ,        . <br> <br> <code class="cs">//  . var notifyErrorInfo = (INotifyDataErrorInfo)question; question.Response = -15; Assert.IsTrue(notifyErrorInfo.GetErrors("Response").Cast&lt;ValidationResult&gt;().Any()); //  . var notifyErrorInfo = (INotifyDataErrorInfo)question; question.Response = 15; Assert.IsFalse(notifyErrorInfo.GetErrors("Response").Cast&lt;ValidationResult&gt;().Any());</code> <br>    ,    ,             . <br> <br>    <i>INotifyDataErrorInfo</i> <br>       <code>GetErrors</code> ,   <code>INotifyDataErrorInfo</code>  ,   <code>ErrorsChanged</code>      <code>GetErrors</code> . ,  <code>HasErrors</code>      ,  . <br> <br>       <code>INotifyDataErrorInfo</code> . , ,           ,   -  .      ,        <code>INotifyDataErrorInfo</code>         (,        ). <br> <br>     ,   ,  : <br>  <code>HasErrors</code>     .              ,       .  <code>ErrorsChanged</code> ,      ,         <code>GetErrors</code> .         ( ,  )     ,           .    <code>GetErrors</code>       <code>ErrorsChanged</code> . <br>    <code>INotifyPropertyChanged</code> ,  ,    <code>NotifyDataErrorInfoTestHelper</code>    MVVM,        <code>INotifyDataErrorInfo</code> ,       .   ,   ,      ,   .      . <br> <code class="cs">var helper = new NotifyDataErrorInfoTestHelper&lt;NumericQuestion, int?&gt;( question, q =&gt; q.Response); helper.ValidatePropertyChange( 6, NotifyDataErrorInfoBehavior.Nothing); helper.ValidatePropertyChange( 20, NotifyDataErrorInfoBehavior.FiresErrorsChanged | NotifyDataErrorInfoBehavior.HasErrors | NotifyDataErrorInfoBehavior.HasErrorsForProperty); helper.ValidatePropertyChange( null, NotifyDataErrorInfoBehavior.FiresErrorsChanged | NotifyDataErrorInfoBehavior.HasErrors | NotifyDataErrorInfoBehavior.HasErrorsForProperty); helper.ValidatePropertyChange( 2, NotifyDataErrorInfoBehavior.FiresErrorsChanged);</code> <br>     <br>   MVVM,     ,  .   ,    ,         . <br> <br>  ,     ,     ,       .   ,   , ,       ,     ,   <code>IAsyncResult</code>    ,  - ,   ,    UI. <br> <br>       , , ,    .   ,     .  ,      UI,     ,   ,          ,     ,        "   UI." <br> <br>     ,    ,    .   ,    ,     mock-, ,   ,   ,      ,          . <br> <br>           UI,    ,    .   ,     ,   ,      .        ,   .     ,    ,     . <br> <br> <code class="cs">questionnaireRepositoryMock .Setup( r =&gt; r.SubmitQuestionnaireAsync( It.IsAny&lt;Questionnaire&gt;(), It.IsAny&lt;Action&lt;IOperationResult&gt;&gt;())) .Callback&lt;Questionnaire, Action&lt;IOperationResult&gt;&gt;( (q, a) =&gt; callback = a); uiServicemock .Setup(svc =&gt; svc.ShowView(ViewNames.QuestionnaireTemplatesList)) .Callback&lt;string&gt;(viewName =&gt; requestedViewName = viewName); submitResultMock .Setup(sr =&gt; sr.Error) .Returns&lt;Exception&gt;(null); CompleteQuestionnaire(viewModel); viewModel.Submit(); //      UI . callback(submitResultMock.Object); //    ‚Äì     . Assert.AreEqual(ViewNames.QuestionnaireTemplatesList, requestedViewName);</code> <br> <b></b> <br>          ,        . <br>   <br>       , . "Trees in WPF"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ms753391.aspx">http://msdn.microsoft.com/en-us/library/ms753391.aspx</a> <br> <br>       , . "Attached Properties Overview"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/cc265152(VS.95).aspx">http://msdn.microsoft.com/en-us/library/cc265152(VS.95).aspx</a> <br> <br>      MEF, ."Managed Extensibility Framework Overview"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/dd460648.aspx">http://msdn.microsoft.com/en-us/library/dd460648.aspx</a> . <br> <br>      Unity, ."Unity Application Block"  MSDN: <a href="http://www.msdn.com/unity">http://www.msdn.com/unity</a> . <br> <br>      <code>DelegateCommand</code> , .Chapter 5, " <a href="http://msdn.microsoft.com/en-us/library/gg405484(v%3DPandP.40).aspx">Implementing the MVVM Pattern</a> ." <br> <br>        Microsoft Expression Blend, ."Working with built-in behaviors"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ff724013(v%3DExpression.40).aspx">http://msdn.microsoft.com/en-us/library/ff724013(v=Expression.40).aspx</a> . <br> <br>          Microsoft Expression Blend, ."Creating Custom Behaviors"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ff724708(v%3DExpression.40).aspx">http://msdn.microsoft.com/en-us/library/ff724708(v=Expression.40).aspx</a> . <br> <br>            Microsoft Expression Blend, ."Creating Custom Triggers and Actions"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ff724707(v%3DExpression.40).aspx">http://msdn.microsoft.com/en-us/library/ff724707(v=Expression.40).aspx</a> . <br> <br>         WPF  Silverlight, ."Threading Model"  "The Dispatcher Class"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ms741870.aspx">http://msdn.microsoft.com/en-us/library/ms741870.aspx</a> <br> <a href="http://msdn.microsoft.com/en-us/library/ms615907(v%3DVS.95).aspx">http://msdn.microsoft.com/en-us/library/ms615907(v=VS.95).aspx</a> . <br> <br>      unit-  Silverlight, ."Unit Testing with Silverlight 2": <a href="http://www.jeff.wilcox.name/2008/03/silverlight2-unit-testing/">http://www.jeff.wilcox.name/2008/03/silverlight2-unit-testing/</a> . <br> <br>         , .  " <a href="http://msdn.microsoft.com/en-us/library/gg430861(v%3DPandP.40).aspx">View-Based Navigation</a> " in Chapter 8, " <a href="http://msdn.microsoft.com/en-us/library/gg430861(v%3DPandP.40).aspx">Navigation</a> ." <br> <br>       ,   , ."Event-based Asynchronous Pattern Overview"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/wewwczdw.aspx">http://msdn.microsoft.com/en-us/library/wewwczdw.aspx</a> <br> <br>        <code>IAsyncResult</code> , ."Asynchronous Programming Overview"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ms228963.aspx">http://msdn.microsoft.com/en-us/library/ms228963.aspx</a></code></code></code></code></code></code></code></code></code> </h5> <code><code><code><code><code><code>CommandBehaviorBase ,    ,    ICommand</code> .           <code>CanExecuteChanged</code> ,          Silverlight,    WPF. <br> <br>    ,  ,   <code>CommandBehaviorBase    ,    .         ,      .         ,    .      ButtonBaseClickCommandBehavior</code> . <br> <br> <code class="cs">public class ButtonBaseClickCommandBehavior : CommandBehaviorBase&lt;ButtonBase&gt; { public ButtonBaseClickCommandBehavior(ButtonBase clickableObject) : base(clickableObject) { clickableObject.Click += OnClick; } private void OnClick(object sender, System.Windows.RoutedEventArgs e) { ExecuteCommand(); } }</code> <br>   <code>CommandBehaviorBase ,     .     ,          ,   . ,    ,    ,      , ,    CanExecute</code>  ,     . <br> <br>          ,   .           XAML.           .       .  Prism      ,       ,  ,   .       ,    . , ,  ,      <code>Click</code> ,       <code>Command</code> .    <code>Click.Command</code> ,  . <br> <br>             .             . <br> <br> <code class="cs">public static readonly DependencyProperty CommandProperty = DependencyProperty.RegisterAttached( "Command", typeof(ICommand), typeof(Click), new PropertyMetadata(OnSetCommandCallback)); private static readonly DependencyProperty ClickCommandBehaviorProperty = DependencyProperty.RegisterAttached( "ClickCommandBehavior", typeof(ButtonBaseClickCommandBehavior), typeof(Click), null);</code> <br>    <code>Command</code>    <code>ButtonBaseClickCommandBehavior</code> ,     <code>OnSetCommandCallback</code> ,     . <br> <br> <code class="cs">private static void OnSetCommandCallback(DependencyObject dependencyObject, DependencyPropertyChangedEventArgs e) { ButtonBase buttonBase = dependencyObject as ButtonBase; if (buttonBase != null) { ButtonBaseClickCommandBehavior behavior = GetOrCreateBehavior(buttonBase); behavior.Command = e.NewValue as ICommand; } } private static void OnSetCommandParameterCallback(DependencyObject dependencyObject, DependencyPropertyChangedEventArgs e) { ButtonBase buttonBase = dependencyObject as ButtonBase; if (buttonBase != null) { ButtonBaseClickCommandBehavior behavior = GetOrCreateBehavior(buttonBase); behavior.CommandParameter = e.NewValue; } } private static ButtonBaseClickCommandBehavior GetOrCreateBehavior(ButtonBase buttonBase ) { ButtonBaseClickCommandBehavior behavior = buttonBase.GetValue(ClickCommandBehaviorProperty) as ButtonBaseClickCommandBehavior; if ( behavior == null ) { behavior = new ButtonBaseClickCommandBehavior(buttonBase); buttonBase.SetValue(ClickCommandBehaviorProperty, behavior); } return behavior; }</code> <br>        ,  <a href="http://msdn.microsoft.com/en-us/library/cc265152(VS.95).aspx">Attached Properties Overview</a>  MSDN. <br> <br>    <br>              . ,     Silverlight,    -,     ,      ,     .     ,       . <br> <br>        ,    ( )  ,  ,     .  UI       ,            UI. <br> <br>      - <br>   -     ,       <code>IAsyncResult</code> .   ,  ,   ,  <code>GetQuestionnaire</code> ,   : <code>BeginGetQuestionnaire</code>  <code>EndGetQuestionnaire</code> .    ,   <code>BeginGetQuestionnaire</code> .     ,   ,   <code>EndGetQuestionnaire</code>    . <br> <b></b> <br>  .NET Framework 4.5      <code>await</code>  <code>async</code>     <code>*Async</code> .      <a href="http://msdn.microsoft.com/en-us/library/vstudio/hh391443.aspx">"Asynchronous Programming with Async and Await (C# and Visual Basic)"</a> . <br>  ,    <code>EndGetQuestionnaire</code> ,      ,  ()      <code>BeginGetQuestionnaire</code> .     ,      ,   <code>EndGetQuestionnaire</code> ,   . <br> <br> <code class="xml">IAsyncResult asyncResult = this.service.BeginGetQuestionnaire( GetQuestionnaireCompleted, null //  ,      ); private void GetQuestionnaireCompleted(IAsyncResult result) { try { questionnaire = this.service.EndGetQuestionnaire(ar); } catch (Exception ex) { //  -   . } }</code> <br>  ,     <code>End*</code> (  , <code>EndGetQuestionnaire</code> ),    ,      .      , ,          UI.     ,   ,        . <br> <br>        UI,     -,      UI,         UI,   <code>Dispatcher</code>    <code>SynchronizationContext</code> .  WPF  Silverlight,   <code>Dispatcher</code> . <br> <br>      <code>Questionnaire</code>  ,        <code>QuestionnaireView</code> .  Silverlight    <code>CheckAccess</code> ,  ,      UI.  ,     <code>BeginInvoke</code> ,      UI. <br> <br> <code class="cs">var dispatcher = System.Windows.Deployment.Current.Dispatcher; if (dispatcher.CheckAccess()) { QuestionnaireView.DataContext = questionnaire; } else { dispatcher.BeginInvoke(() =&gt; { Questionnaire.DataContext = questionnaire; }); }</code> <br> <i>MVVM RI</i>   ,    ,   <code>IAsyncResult</code> ,   .      ,                 . ,       . <br> <br> <code class="cs">this.questionnaireRepository.GetQuestionnaireAsync( result =&gt; { this.Questionnaire = result.Result; });</code> <br>  <code>result</code>   ,     , , , .    ,     . <br> <br> <code class="cs">this.questionnaireRepository.GetQuestionnaireAsync( result =&gt; { if (result.Error == null) { this.Questionnaire = result.Result; ... } else { // Handle error. } })</code> <br>     <br>        ,      .     , ,             .        ,      ,     ,     . <br> <br>         ,      MVVM,     ,   . ,  -MVVM ,     <code>MessageBox</code>   code-behind UI,      .   MVVM     ,          . <br> <br>     MVVM,              ,          .      ,    ,   ,  ,     . <br> <br>              MVVM.      ,     ,     ,  ,     .    ,         ,     ,          .       . <br> <br>    <br>                  .        ,        .  ,         .         . <br> <br>  ,         ,         ,  .      ,     .           ,       . ,        WPF  Silverlight,        . <br> <br> <img title="Using the service to interact with the user." src="https://habrastorage.org/getpro/habr/post_images/4b5/397/f2d/4b5397f2d02e5851195b29f1893be6fc.png" alt=" ,    ."> <br> <br>  ,   <code>MessageBox</code>        ,     ,    ,     . <br> <br> <code class="cs">var result = interactionService.ShowMessageBox( "Are you sure you want to cancel this operation?", "Confirm", MessageBoxButton.OK); if (result == MessageBoxResult.Yes) { CancelRequest(); }</code> <br> ,      - ,      ,         Silverlight.         .             .     . <br> <br> <code class="cs">interactionService.ShowMessageBox( "Are you sure you want to cancel this operation?", "Confirm", MessageBoxButton.OK, result =&gt; { if (result == MessageBoxResult.Yes) { CancelRequest(); } });</code> <br>         ,      . ,  WPF    <code>MessageBox</code> ,       ;    Silverlight    ,    . <br> <br>     <br>         ‚Äì             .         ,      .     ,     .        ,        ,   ,     . <br> <br> <img title="Using interaction request objects." src="https://habrastorage.org/getpro/habr/post_images/3d0/ff0/1c5/3d0ff01c5518558c2d3c5c5f47ce0ce9.png" alt="   ."> <br> <br>    ,   ,          ‚Äì       ,      ,   ‚Äì     .   ,        ,    ,    UI            . <br> <br>       MVVM,     ,       ,         .         ,        ,    ,   . <br> <br>  Prism       <code>IInteractionRequest</code>   <code>InteractionRequest .  IInteractionRequest</code>  ,   .           ,   .  <code>InteractionRequest   IInteractionRequest</code>     <code>Raise</code> ,           , , ,   . <br> <br>       <br>  <code><code>InteractionRequest          .  Raise</code>          ( <code>T</code> )    ,    ,   .          ,       .      ,        .    ,  ,     . <br> <code class="cs">public interface IInteractionRequest { event EventHandler&lt;InteractionRequestedEventArgs&gt; Raised; } public class InteractionRequest&lt;T&gt; : IInteractionRequest { public event EventHandler&lt;InteractionRequestedEventArgs&gt; Raised; public void Raise(T context, Action&lt;T&gt; callback) { var handler = this.Raised; if (handler != null) { handler( this, new InteractionRequestedEventArgs(context, () =&gt; callback(context))); } } }</code> <br> Prism    ,      .  <code>Notification</code>       .    ,            .     ‚Äì <code>Title</code>  <code>Content</code> ,    .  ,   ,  ,  ,        . <br> <br>  <code>Confirmation</code>    <code>Notification</code>     ‚Äì <code>Confirmed</code> ,  ,  ,      .  <code>Confirmation</code> ,     <code>MessageBox</code> ,     /  .     ,     <code>Notification</code> ,     ,      . <br> <br>    <code><code><code>InteractionRequest ,       InteractionRequest      ,      .      ,    Raise</code> ,    , ,   . <br> <br> <code class="cs">public IInteractionRequest ConfirmCancelInteractionRequest { get { return this.confirmCancelInteractionRequest; } } this.confirmCancelInteractionRequest.Raise( new Confirmation("Are you sure you wish to cancel?"), confirmation =&gt; { if (confirmation.Confirmed) { this.NavigateToQuestionnaireList(); } }); }</code> <br> <i>MVVM Reference Implementation (MVVM RI)</i> ,    <code>IInteractionRequest</code>   <code><code>InteractionRequest ,          (. QuestionnaireViewModel.cs</code> ). <br> <br>        <br>       ,       .   ,       .    UI             . <br> <br>                . Microsoft Expression Blend Behaviors Framework     .  ,     ,    . <br> <br>  <code>EventTrigger</code> ,  Expression Blend,  ,      ,     ,   . , Prism   <code>EventTrigger</code> ,  <code>InteractionRequestTrigger</code> ,      <code>Raised</code>   <code>IInteractionRequest</code> .    XAML        . <br> <br>  ,   , <code>InteractionRequestTrigger</code>   .  Silverlight Prism   <code>PopupChildWindowAction</code> ,     .    ,         .   <code>ContentTemplate</code>  <code>PopupChildWindowAction</code> ,    ,    UI,      <code>Content</code>  .       <code>Title</code>  . <br> <b></b> <br>  ,    ,   <code>PopupChildWindowAction</code> ,     .    <code>Notification</code>  <code>NotificationChildWindow</code> ,        <code>Confirmation</code> ‚Äì <code>ConfirmationChildWindow</code> . <code>NotificationChildWindow</code>    ,   ,     <code>ConfirmationChildWindow</code>    <i>OK</i>  <i>Cancel</i> ,    .    ,   ,   <code>ChildWindow</code>  <code>PopupChildWindowAction</code> . <br>   ,  <code>InteractionRequestTrigger</code>  <code>PopupChildWindowAction</code> ,       <i>RI MVVM</i> . <br> <br> <code class="xml">&lt;i:Interaction.Triggers&gt; &lt;prism:InteractionRequestTrigger SourceObject="{Binding ConfirmCancelInteractionRequest}"&gt; &lt;prism:PopupChildWindowAction ContentTemplate="{StaticResource ConfirmWindowTemplate}"/&gt; &lt;/prism:InteractionRequestTrigger&gt; &lt;/i:Interaction.Triggers&gt; &lt;UserControl.Resources&gt; &lt;DataTemplate x:Key="ConfirmWindowTemplate"&gt; &lt;Grid MinWidth="250" MinHeight="100"&gt; &lt;TextBlock TextWrapping="Wrap" Grid.Row="0" Text="{Binding}"/&gt; &lt;/Grid&gt; &lt;/DataTemplate&gt; &lt;/UserControl.Resources&gt;</code> <br> <b></b> <br>      <code>ContentTemplate</code> ,   UI   <code>Content</code>  .    <code>Content</code>  ,  , <code>TextBlock</code>     <code>Content</code> . <br>      ,     ,    ,    .  ,     ,       ,     ,    .   ,   <i>RI MVVM</i> ,         <code>Confirmed</code>    <code>Confirmation</code>  <code>true</code> ,     OK. <br> <br>        ,     .  Prism <code>InteractionRequestTrigger</code>   <code>PopupChildWindowAction</code>            . <br> <br>     <br>     MVVM,       , ,    ,         .        (  , ,  ,   ).    ,  ,  ,            . <br> <br>        ,         . Managed Extensibility Framework (MEF)  Unity Application Block (Unity)      ,  ,           . <br> <br>  ,       , , ,    ( )      . ,       ,     .  ,     ,       . <br> <br>     ,  MEF <br>  MEF,       ,   <code>Import</code> ,      ,  ,   <code>Export</code> .         ,    . <br> <br> , <code>QuestionnaireView</code>   <i>RI MVVM</i> ,        ,    <code>Import</code> .   , MEF           .  <code>set</code>        ,   . <br> <br> <code class="cs">[Import] public QuestionnaireViewModel ViewModel { set { this.DataContext = value; } }</code> <br>     ,   . <br> <br> <code class="cs">[Export] public class QuestionnaireViewModel : NotificationObject { ... }</code> <br>        ,   . <br> <br> <code class="cs">public QuestionnaireView() { InitializeComponent(); } [ImportingConstructor] public QuestionnaireView(QuestionnaireViewModel viewModel) : this() { this.DataContext = viewModel; }</code> <br> <b></b> <br>          MEF,   Unity.   ,     ,        .   ,   Visual Studio  Expression Blend, ,        ,     .   ,   ,  ,      ,          <code>InitializeComponent</code> . <br>     ,  Unity <br>  Unity,    ,   MEF.     ,      .    ,         .  ,      . <br> <br>  ,      ,  ,         . ,           ,   . <br> <br> <code class="cs">public QuestionnaireView() { InitializeComponent(); } public QuestionnaireView(QuestionnaireViewModel viewModel) : this() { this.DataContext = viewModel; }</code> <br> <b></b> <br>    ,        ,   Visual Studio  Expression Blend. <br>  ,          ,   . Unity        <code>set</code>   ,   . <br> <br> <code class="cs">public QuestionnaireView() { InitializeComponent(); } [Dependency] public QuestionnaireViewModel ViewModel { set { this.DataContext = value; } }</code> <br>       Unity. <br> <br> <code class="cs">container.RegisterType&lt;QuestionnaireViewModel&gt;();</code> <br>  ,     . <br> <br> <code class="cs">var view = container.Resolve&lt;QuestionnaireView&gt;();</code> <br>     ,    <br>   ,     ,        .        ,   MEF  Unity,        . <br> <br>          .   ,         UI,           . <br> <br> , <i>RI MVVM</i>   ,   ,        .   ,    .      <code>ShowView</code>   UI. <br> <br> <code class="cs">private void NavigateToQuestionnaireList() { //     "questionnaire list". this.uiService.ShowView(ViewNames.QuestionnaireTemplatesList); }</code> <br>  UI      UI .           UI.  <code>ShowView</code>  <code>UIService</code>      (,          ),       ,   . <br> <br> <code class="cs">public void ShowView(string viewName) { var view = this.ViewFactory.GetView(viewName); this.MainWindow.CurrentView = view; }</code> <br> <b></b> <br> Prism       .   ,   ,   ,             .    ,  , " <a href="http://msdn.microsoft.com/en-us/library/gg430861(v%3DPandP.40).aspx">View-Based Navigation</a> "   8, " <a href="http://msdn.microsoft.com/en-us/library/gg430861(v%3DPandP.40).aspx">Navigation</a> ". <br>  MVVM  <br>        MVVM      .           -      mocking . ,   ,        . <br> <br>   <i>INotifyPropertyChanged</i> <br>   <code>INotifyPropertyChanged</code>     ,      .      ,    ;   ,   ,     ,    ,       . <br> <br>   <br> ,       ,           <code>PropertyChanged</code>  ,         .  ,    <code>ChangeTracker</code> ,     MVVM,  ,      .      .     ,    . <br> <br> <code class="cs">var changeTracker = new PropertyChangeTracker(viewModel); viewModel.CurrentState = "newState"; CollectionAssert.Contains(changeTracker.ChangedProperties, "CurrentState");</code> <br> ,     ,     <code>INotifyPropertyChanged</code> ,    ,   ,     . <br> <br>      <br>        ,   ,    <code>set</code>      ,           . ,     ,     ,      ,          . <br> <br> <code class="cs">var changeTracker = new PropertyChangeTracker(viewModel); var question = viewModel.Questions.First() as OpenQuestionViewModel; question.Question.Response = "some text"; CollectionAssert.Contains(changeTracker.ChangedProperties, "UnansweredQuestions");</code> <br>      <br>     <code>INotifyPropertyChanged</code> ,      <code>PropertyChanged</code>        ,  ,     , , .        ,       . <br> <br>   <i>INotifyDataErrorInfo</i> <br>   ,     ,    ,   ,   <code>IDataErrorInfo</code> ,  ( Silverlight)   <code>INotifyDataErrorInfo</code> .   <code>INotifyDataErrorInfo</code>   ,         ,    ,  ,   ,    . <br> <br>       <code>INotifyDataErrorInfo</code> : ,     ,  ,     ,     <code>ErrorsChanged</code> ,      <code>GetErrors</code> , . <br> <br>    <br>     ,      ,     .       ,         <code>GetErrors</code>       ,  ,  ,   .    , ,  ,     ,        .   ,        . <br> <br> <code class="cs">//  . var notifyErrorInfo = (INotifyDataErrorInfo)question; question.Response = -15; Assert.IsTrue(notifyErrorInfo.GetErrors("Response").Cast&lt;ValidationResult&gt;().Any()); //  . var notifyErrorInfo = (INotifyDataErrorInfo)question; question.Response = 15; Assert.IsFalse(notifyErrorInfo.GetErrors("Response").Cast&lt;ValidationResult&gt;().Any());</code> <br>    ,    ,             . <br> <br>    <i>INotifyDataErrorInfo</i> <br>       <code>GetErrors</code> ,   <code>INotifyDataErrorInfo</code>  ,   <code>ErrorsChanged</code>      <code>GetErrors</code> . ,  <code>HasErrors</code>      ,  . <br> <br>       <code>INotifyDataErrorInfo</code> . , ,           ,   -  .      ,        <code>INotifyDataErrorInfo</code>         (,        ). <br> <br>     ,   ,  : <br>  <code>HasErrors</code>     .              ,       .  <code>ErrorsChanged</code> ,      ,         <code>GetErrors</code> .         ( ,  )     ,           .    <code>GetErrors</code>       <code>ErrorsChanged</code> . <br>    <code>INotifyPropertyChanged</code> ,  ,    <code>NotifyDataErrorInfoTestHelper</code>    MVVM,        <code>INotifyDataErrorInfo</code> ,       .   ,   ,      ,   .      . <br> <code class="cs">var helper = new NotifyDataErrorInfoTestHelper&lt;NumericQuestion, int?&gt;( question, q =&gt; q.Response); helper.ValidatePropertyChange( 6, NotifyDataErrorInfoBehavior.Nothing); helper.ValidatePropertyChange( 20, NotifyDataErrorInfoBehavior.FiresErrorsChanged | NotifyDataErrorInfoBehavior.HasErrors | NotifyDataErrorInfoBehavior.HasErrorsForProperty); helper.ValidatePropertyChange( null, NotifyDataErrorInfoBehavior.FiresErrorsChanged | NotifyDataErrorInfoBehavior.HasErrors | NotifyDataErrorInfoBehavior.HasErrorsForProperty); helper.ValidatePropertyChange( 2, NotifyDataErrorInfoBehavior.FiresErrorsChanged);</code> <br>     <br>   MVVM,     ,  .   ,    ,         . <br> <br>  ,     ,     ,       .   ,   , ,       ,     ,   <code>IAsyncResult</code>    ,  - ,   ,    UI. <br> <br>       , , ,    .   ,     .  ,      UI,     ,   ,          ,     ,        "   UI." <br> <br>     ,    ,    .   ,    ,     mock-, ,   ,   ,      ,          . <br> <br>           UI,    ,    .   ,     ,   ,      .        ,   .     ,    ,     . <br> <br> <code class="cs">questionnaireRepositoryMock .Setup( r =&gt; r.SubmitQuestionnaireAsync( It.IsAny&lt;Questionnaire&gt;(), It.IsAny&lt;Action&lt;IOperationResult&gt;&gt;())) .Callback&lt;Questionnaire, Action&lt;IOperationResult&gt;&gt;( (q, a) =&gt; callback = a); uiServicemock .Setup(svc =&gt; svc.ShowView(ViewNames.QuestionnaireTemplatesList)) .Callback&lt;string&gt;(viewName =&gt; requestedViewName = viewName); submitResultMock .Setup(sr =&gt; sr.Error) .Returns&lt;Exception&gt;(null); CompleteQuestionnaire(viewModel); viewModel.Submit(); //      UI . callback(submitResultMock.Object); //    ‚Äì     . Assert.AreEqual(ViewNames.QuestionnaireTemplatesList, requestedViewName);</code> <br> <b></b> <br>          ,        . <br>   <br>       , . "Trees in WPF"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ms753391.aspx">http://msdn.microsoft.com/en-us/library/ms753391.aspx</a> <br> <br>       , . "Attached Properties Overview"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/cc265152(VS.95).aspx">http://msdn.microsoft.com/en-us/library/cc265152(VS.95).aspx</a> <br> <br>      MEF, ."Managed Extensibility Framework Overview"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/dd460648.aspx">http://msdn.microsoft.com/en-us/library/dd460648.aspx</a> . <br> <br>      Unity, ."Unity Application Block"  MSDN: <a href="http://www.msdn.com/unity">http://www.msdn.com/unity</a> . <br> <br>      <code>DelegateCommand</code> , .Chapter 5, " <a href="http://msdn.microsoft.com/en-us/library/gg405484(v%3DPandP.40).aspx">Implementing the MVVM Pattern</a> ." <br> <br>        Microsoft Expression Blend, ."Working with built-in behaviors"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ff724013(v%3DExpression.40).aspx">http://msdn.microsoft.com/en-us/library/ff724013(v=Expression.40).aspx</a> . <br> <br>          Microsoft Expression Blend, ."Creating Custom Behaviors"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ff724708(v%3DExpression.40).aspx">http://msdn.microsoft.com/en-us/library/ff724708(v=Expression.40).aspx</a> . <br> <br>            Microsoft Expression Blend, ."Creating Custom Triggers and Actions"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ff724707(v%3DExpression.40).aspx">http://msdn.microsoft.com/en-us/library/ff724707(v=Expression.40).aspx</a> . <br> <br>         WPF  Silverlight, ."Threading Model"  "The Dispatcher Class"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ms741870.aspx">http://msdn.microsoft.com/en-us/library/ms741870.aspx</a> <br> <a href="http://msdn.microsoft.com/en-us/library/ms615907(v%3DVS.95).aspx">http://msdn.microsoft.com/en-us/library/ms615907(v=VS.95).aspx</a> . <br> <br>      unit-  Silverlight, ."Unit Testing with Silverlight 2": <a href="http://www.jeff.wilcox.name/2008/03/silverlight2-unit-testing/">http://www.jeff.wilcox.name/2008/03/silverlight2-unit-testing/</a> . <br> <br>         , .  " <a href="http://msdn.microsoft.com/en-us/library/gg430861(v%3DPandP.40).aspx">View-Based Navigation</a> " in Chapter 8, " <a href="http://msdn.microsoft.com/en-us/library/gg430861(v%3DPandP.40).aspx">Navigation</a> ." <br> <br>       ,   , ."Event-based Asynchronous Pattern Overview"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/wewwczdw.aspx">http://msdn.microsoft.com/en-us/library/wewwczdw.aspx</a> <br> <br>        <code>IAsyncResult</code> , ."Asynchronous Programming Overview"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ms228963.aspx">http://msdn.microsoft.com/en-us/library/ms228963.aspx</a></code></code></code></code></code></code></code></code></code> <pre> <code class="hljs cmake"><code>CommandBehaviorBase ,    ,    ICommand</code> .           <code>CanExecuteChanged</code> ,          Silverlight,    WPF. <br> <br>    ,  ,   <code><code>CommandBehaviorBase    ,    .         ,      .         ,    .      ButtonBaseClickCommandBehavior</code> . <br> <br> <code class="cs">public class ButtonBaseClickCommandBehavior : CommandBehaviorBase&lt;ButtonBase&gt; { public ButtonBaseClickCommandBehavior(ButtonBase clickableObject) : base(clickableObject) { clickableObject.Click += OnClick; } private void OnClick(object sender, System.Windows.RoutedEventArgs e) { ExecuteCommand(); } }</code> <br>   <code><code>CommandBehaviorBase ,     .     ,          ,   . ,    ,    ,      , ,    CanExecute</code>  ,     . <br> <br>          ,   .           XAML.           .       .  Prism      ,       ,  ,   .       ,    . , ,  ,      <code>Click</code> ,       <code><span class="hljs-keyword"><span class="hljs-keyword">Command</span></span></code> .    <code>Click.<span class="hljs-keyword"><span class="hljs-keyword">Command</span></span></code> ,  . <br> <br>             .             . <br> <br> <code class="cs">public static readonly DependencyProperty CommandProperty = DependencyProperty.RegisterAttached( <span class="hljs-string"><span class="hljs-string">"Command"</span></span>, typeof(ICommand), typeof(Click), new PropertyMetadata(OnSetCommandCallback)); private static readonly DependencyProperty ClickCommandBehaviorProperty = DependencyProperty.RegisterAttached( <span class="hljs-string"><span class="hljs-string">"ClickCommandBehavior"</span></span>, typeof(ButtonBaseClickCommandBehavior), typeof(Click), null);</code> <br>    <code><span class="hljs-keyword"><span class="hljs-keyword">Command</span></span></code>    <code>ButtonBaseClickCommandBehavior</code> ,     <code>OnSetCommandCallback</code> ,     . <br> <br> <code class="cs">private static void OnSetCommandCallback(DependencyObject dependencyObject, DependencyPropertyChangedEventArgs e) { ButtonBase buttonBase = dependencyObject as ButtonBase; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (buttonBase != null) { ButtonBaseClickCommandBehavior behavior = GetOrCreateBehavior(buttonBase); behavior.<span class="hljs-keyword"><span class="hljs-keyword">Command</span></span> = e.NewValue as ICommand; } } private static void OnSetCommandParameterCallback(DependencyObject dependencyObject, DependencyPropertyChangedEventArgs e) { ButtonBase buttonBase = dependencyObject as ButtonBase; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (buttonBase != null) { ButtonBaseClickCommandBehavior behavior = GetOrCreateBehavior(buttonBase); behavior.CommandParameter = e.NewValue; } } private static ButtonBaseClickCommandBehavior GetOrCreateBehavior(ButtonBase buttonBase ) { ButtonBaseClickCommandBehavior behavior = buttonBase.GetValue(ClickCommandBehaviorProperty) as ButtonBaseClickCommandBehavior; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ( behavior == null ) { behavior = new ButtonBaseClickCommandBehavior(buttonBase); buttonBase.SetValue(ClickCommandBehaviorProperty, behavior); } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> behavior; }</code> <br>        ,  <a href="http://msdn.microsoft.com/en-us/library/cc265152(VS.95).aspx">Attached Properties Overview</a>  MSDN. <br> <br>    <br>              . ,     Silverlight,    -,     ,      ,     .     ,       . <br> <br>        ,    ( )  ,  ,     .  UI       ,            UI. <br> <br>      - <br>   -     ,       <code>IAsyncResult</code> .   ,  ,   ,  <code>GetQuestionnaire</code> ,   : <code>BeginGetQuestionnaire</code>  <code>EndGetQuestionnaire</code> .    ,   <code>BeginGetQuestionnaire</code> .     ,   ,   <code>EndGetQuestionnaire</code>    . <br> <b></b> <br>  .NET Framework <span class="hljs-number"><span class="hljs-number">4.5</span></span>      <code>await</code>  <code>async</code>     <code>*Async</code> .      <a href="http://msdn.microsoft.com/en-us/library/vstudio/hh391443.aspx"><span class="hljs-string"><span class="hljs-string">"Asynchronous Programming with Async and Await (C# and Visual Basic)"</span></span></a> . <br>  ,    <code>EndGetQuestionnaire</code> ,      ,  ()      <code>BeginGetQuestionnaire</code> .     ,      ,   <code>EndGetQuestionnaire</code> ,   . <br> <br> <code class="xml">IAsyncResult asyncResult = this.service.BeginGetQuestionnaire( GetQuestionnaireCompleted, null //  ,      ); private void GetQuestionnaireCompleted(IAsyncResult result) { try { questionnaire = this.service.EndGetQuestionnaire(ar); } catch (Exception ex) { //  -   . } }</code> <br>  ,     <code>End*</code> (  , <code>EndGetQuestionnaire</code> ),    ,      .      , ,          UI.     ,   ,        . <br> <br>        UI,     -,      UI,         UI,   <code>Dispatcher</code>    <code>SynchronizationContext</code> .  WPF  Silverlight,   <code>Dispatcher</code> . <br> <br>      <code>Questionnaire</code>  ,        <code>QuestionnaireView</code> .  Silverlight    <code>CheckAccess</code> ,  ,      UI.  ,     <code>BeginInvoke</code> ,      UI. <br> <br> <code class="cs">var dispatcher = System.Windows.Deployment.Current.Dispatcher; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (dispatcher.CheckAccess()) { QuestionnaireView.DataContext = questionnaire; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { dispatcher.BeginInvoke(() =&gt; { Questionnaire.DataContext = questionnaire; }); }</code> <br> <i>MVVM RI</i>   ,    ,   <code>IAsyncResult</code> ,   .      ,                 . ,       . <br> <br> <code class="cs">this.questionnaireRepository.GetQuestionnaireAsync( result =&gt; { this.Questionnaire = result.Result; });</code> <br>  <code>result</code>   ,     , , , .    ,     . <br> <br> <code class="cs">this.questionnaireRepository.GetQuestionnaireAsync( result =&gt; { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (result.Error == null) { this.Questionnaire = result.Result; ... } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { // Handle error. } })</code> <br>     <br>        ,      .     , ,             .        ,      ,     ,     . <br> <br>         ,      MVVM,     ,   . ,  -MVVM ,     <code>MessageBox</code>   code-behind UI,      .   MVVM     ,          . <br> <br>     MVVM,              ,          .      ,    ,   ,  ,     . <br> <br>              MVVM.      ,     ,     ,  ,     .    ,         ,     ,          .       . <br> <br>    <br>                  .        ,        .  ,         .         . <br> <br>  ,         ,         ,  .      ,     .           ,       . ,        WPF  Silverlight,        . <br> <br> <img title="Using the service to interact with the user." src="https://habrastorage.org/getpro/habr/post_images/4b5/397/f2d/4b5397f2d02e5851195b29f1893be6fc.png" alt=" ,    ."> <br> <br>  ,   <code>MessageBox</code>        ,     ,    ,     . <br> <br> <code class="cs">var result = interactionService.ShowMessageBox( <span class="hljs-string"><span class="hljs-string">"Are you sure you want to cancel this operation?"</span></span>, <span class="hljs-string"><span class="hljs-string">"Confirm"</span></span>, MessageBoxButton.OK); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (result == MessageBoxResult.Yes) { CancelRequest(); }</code> <br> ,      - ,      ,         Silverlight.         .             .     . <br> <br> <code class="cs">interactionService.ShowMessageBox( <span class="hljs-string"><span class="hljs-string">"Are you sure you want to cancel this operation?"</span></span>, <span class="hljs-string"><span class="hljs-string">"Confirm"</span></span>, MessageBoxButton.OK, result =&gt; { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (result == MessageBoxResult.Yes) { CancelRequest(); } });</code> <br>         ,      . ,  WPF    <code>MessageBox</code> ,       ;    Silverlight    ,    . <br> <br>     <br>         ‚Äì             .         ,      .     ,     .        ,        ,   ,     . <br> <br> <img title="Using interaction request objects." src="https://habrastorage.org/getpro/habr/post_images/3d0/ff0/1c5/3d0ff01c5518558c2d3c5c5f47ce0ce9.png" alt="   ."> <br> <br>    ,   ,          ‚Äì       ,      ,   ‚Äì     .   ,        ,    ,    UI            . <br> <br>       MVVM,     ,       ,         .         ,        ,    ,   . <br> <br>  Prism       <code>IInteractionRequest</code>   <code><code>InteractionRequest .  IInteractionRequest</code>  ,   .           ,   .  <code><code>InteractionRequest   IInteractionRequest</code>     <code>Raise</code> ,           , , ,   . <br> <br>       <br>  <code><code>InteractionRequest          .  Raise</code>          ( <code>T</code> )    ,    ,   .          ,       .      ,        .    ,  ,     . <br> <code class="cs">public interface IInteractionRequest { event EventHandler&lt;InteractionRequestedEventArgs&gt; Raised; } public class InteractionRequest&lt;T&gt; : IInteractionRequest { public event EventHandler&lt;InteractionRequestedEventArgs&gt; Raised; public void Raise(T context, Action&lt;T&gt; callback) { var handler = this.Raised; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (handler != null) { handler( this, new InteractionRequestedEventArgs(context, () =&gt; callback(context))); } } }</code> <br> Prism    ,      .  <code>Notification</code>       .    ,            .     ‚Äì <code>Title</code>  <code>Content</code> ,    .  ,   ,  ,  ,        . <br> <br>  <code>Confirmation</code>    <code>Notification</code>     ‚Äì <code>Confirmed</code> ,  ,  ,      .  <code>Confirmation</code> ,     <code>MessageBox</code> ,     /  .     ,     <code>Notification</code> ,     ,      . <br> <br>    <code><code><code>InteractionRequest ,       InteractionRequest      ,      .      ,    Raise</code> ,    , ,   . <br> <br> <code class="cs">public IInteractionRequest ConfirmCancelInteractionRequest { get { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> this.confirmCancelInteractionRequest; } } this.confirmCancelInteractionRequest.Raise( new Confirmation(<span class="hljs-string"><span class="hljs-string">"Are you sure you wish to cancel?"</span></span>), confirmation =&gt; { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (confirmation.Confirmed) { this.NavigateToQuestionnaireList(); } }); }</code> <br> <i>MVVM Reference Implementation (MVVM RI)</i> ,    <code>IInteractionRequest</code>   <code><code>InteractionRequest ,          (. QuestionnaireViewModel.cs</code> ). <br> <br>        <br>       ,       .   ,       .    UI             . <br> <br>                . Microsoft Expression Blend Behaviors Framework     .  ,     ,    . <br> <br>  <code>EventTrigger</code> ,  Expression Blend,  ,      ,     ,   . , Prism   <code>EventTrigger</code> ,  <code>InteractionRequestTrigger</code> ,      <code>Raised</code>   <code>IInteractionRequest</code> .    XAML        . <br> <br>  ,   , <code>InteractionRequestTrigger</code>   .  Silverlight Prism   <code>PopupChildWindowAction</code> ,     .    ,         .   <code>ContentTemplate</code>  <code>PopupChildWindowAction</code> ,    ,    UI,      <code>Content</code>  .       <code>Title</code>  . <br> <b></b> <br>  ,    ,   <code>PopupChildWindowAction</code> ,     .    <code>Notification</code>  <code>NotificationChildWindow</code> ,        <code>Confirmation</code> ‚Äì <code>ConfirmationChildWindow</code> . <code>NotificationChildWindow</code>    ,   ,     <code>ConfirmationChildWindow</code>    <i>OK</i>  <i>Cancel</i> ,    .    ,   ,   <code>ChildWindow</code>  <code>PopupChildWindowAction</code> . <br>   ,  <code>InteractionRequestTrigger</code>  <code>PopupChildWindowAction</code> ,       <i>RI MVVM</i> . <br> <br> <code class="xml">&lt;i:Interaction.Triggers&gt; &lt;prism:InteractionRequestTrigger SourceObject=<span class="hljs-string"><span class="hljs-string">"{Binding ConfirmCancelInteractionRequest}"</span></span>&gt; &lt;prism:PopupChildWindowAction ContentTemplate=<span class="hljs-string"><span class="hljs-string">"{StaticResource ConfirmWindowTemplate}"</span></span>/&gt; &lt;/prism:InteractionRequestTrigger&gt; &lt;/i:Interaction.Triggers&gt; &lt;UserControl.Resources&gt; &lt;DataTemplate x:Key=<span class="hljs-string"><span class="hljs-string">"ConfirmWindowTemplate"</span></span>&gt; &lt;Grid MinWidth=<span class="hljs-string"><span class="hljs-string">"250"</span></span> MinHeight=<span class="hljs-string"><span class="hljs-string">"100"</span></span>&gt; &lt;TextBlock TextWrapping=<span class="hljs-string"><span class="hljs-string">"Wrap"</span></span> Grid.Row=<span class="hljs-string"><span class="hljs-string">"0"</span></span> Text=<span class="hljs-string"><span class="hljs-string">"{Binding}"</span></span>/&gt; &lt;/Grid&gt; &lt;/DataTemplate&gt; &lt;/UserControl.Resources&gt;</code> <br> <b></b> <br>      <code>ContentTemplate</code> ,   UI   <code>Content</code>  .    <code>Content</code>  ,  , <code>TextBlock</code>     <code>Content</code> . <br>      ,     ,    ,    .  ,     ,       ,     ,    .   ,   <i>RI MVVM</i> ,         <code>Confirmed</code>    <code>Confirmation</code>  <code><span class="hljs-keyword"><span class="hljs-keyword">true</span></span></code> ,     OK. <br> <br>        ,     .  Prism <code>InteractionRequestTrigger</code>   <code>PopupChildWindowAction</code>            . <br> <br>     <br>     MVVM,       , ,    ,         .        (  , ,  ,   ).    ,  ,  ,            . <br> <br>        ,         . Managed Extensibility Framework (MEF)  Unity Application Block (Unity)      ,  ,           . <br> <br>  ,       , , ,    ( )      . ,       ,     .  ,     ,       . <br> <br>     ,  MEF <br>  MEF,       ,   <code>Import</code> ,      ,  ,   <code><span class="hljs-keyword"><span class="hljs-keyword">Export</span></span></code> .         ,    . <br> <br> , <code>QuestionnaireView</code>   <i>RI MVVM</i> ,        ,    <code>Import</code> .   , MEF           .  <code><span class="hljs-keyword"><span class="hljs-keyword">set</span></span></code>        ,   . <br> <br> <code class="cs">[Import] public QuestionnaireViewModel ViewModel { <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> { this.DataContext = value; } }</code> <br>     ,   . <br> <br> <code class="cs">[<span class="hljs-keyword"><span class="hljs-keyword">Export</span></span>] public class QuestionnaireViewModel : NotificationObject { ... }</code> <br>        ,   . <br> <br> <code class="cs">public QuestionnaireView() { InitializeComponent(); } [ImportingConstructor] public QuestionnaireView(QuestionnaireViewModel viewModel) : this() { this.DataContext = viewModel; }</code> <br> <b></b> <br>          MEF,   Unity.   ,     ,        .   ,   Visual Studio  Expression Blend, ,        ,     .   ,   ,  ,      ,          <code>InitializeComponent</code> . <br>     ,  Unity <br>  Unity,    ,   MEF.     ,      .    ,         .  ,      . <br> <br>  ,      ,  ,         . ,           ,   . <br> <br> <code class="cs">public QuestionnaireView() { InitializeComponent(); } public QuestionnaireView(QuestionnaireViewModel viewModel) : this() { this.DataContext = viewModel; }</code> <br> <b></b> <br>    ,        ,   Visual Studio  Expression Blend. <br>  ,          ,   . Unity        <code><span class="hljs-keyword"><span class="hljs-keyword">set</span></span></code>   ,   . <br> <br> <code class="cs">public QuestionnaireView() { InitializeComponent(); } [Dependency] public QuestionnaireViewModel ViewModel { <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> { this.DataContext = value; } }</code> <br>       Unity. <br> <br> <code class="cs">container.RegisterType&lt;QuestionnaireViewModel&gt;();</code> <br>  ,     . <br> <br> <code class="cs">var view = container.Resolve&lt;QuestionnaireView&gt;();</code> <br>     ,    <br>   ,     ,        .        ,   MEF  Unity,        . <br> <br>          .   ,         UI,           . <br> <br> , <i>RI MVVM</i>   ,   ,        .   ,    .      <code>ShowView</code>   UI. <br> <br> <code class="cs">private void NavigateToQuestionnaireList() { //     <span class="hljs-string"><span class="hljs-string">"questionnaire list"</span></span>. this.uiService.ShowView(ViewNames.QuestionnaireTemplatesList); }</code> <br>  UI      UI .           UI.  <code>ShowView</code>  <code>UIService</code>      (,          ),       ,   . <br> <br> <code class="cs">public void ShowView(<span class="hljs-keyword"><span class="hljs-keyword">string</span></span> viewName) { var view = this.ViewFactory.GetView(viewName); this.MainWindow.CurrentView = view; }</code> <br> <b></b> <br> Prism       .   ,   ,   ,             .    ,  , <span class="hljs-string"><span class="hljs-string">" </span></span><a href="http://msdn.microsoft.com/en-us/library/gg430861(v%3DPandP.40).aspx"><span class="hljs-string"><span class="hljs-string">View-Based Navigation</span></span></a><span class="hljs-string"><span class="hljs-string"> "</span></span>   <span class="hljs-number"><span class="hljs-number">8</span></span>, <span class="hljs-string"><span class="hljs-string">" </span></span><a href="http://msdn.microsoft.com/en-us/library/gg430861(v%3DPandP.40).aspx"><span class="hljs-string"><span class="hljs-string">Navigation</span></span></a><span class="hljs-string"><span class="hljs-string"> "</span></span>. <br>  MVVM  <br>        MVVM      .           -      mocking . ,   ,        . <br> <br>   <i>INotifyPropertyChanged</i> <br>   <code>INotifyPropertyChanged</code>     ,      .      ,    ;   ,   ,     ,    ,       . <br> <br>   <br> ,       ,           <code>PropertyChanged</code>  ,         .  ,    <code>ChangeTracker</code> ,     MVVM,  ,      .      .     ,    . <br> <br> <code class="cs">var changeTracker = new PropertyChangeTracker(viewModel); viewModel.CurrentState = <span class="hljs-string"><span class="hljs-string">"newState"</span></span>; CollectionAssert.Contains(changeTracker.ChangedProperties, <span class="hljs-string"><span class="hljs-string">"CurrentState"</span></span>);</code> <br> ,     ,     <code>INotifyPropertyChanged</code> ,    ,   ,     . <br> <br>      <br>        ,   ,    <code><span class="hljs-keyword"><span class="hljs-keyword">set</span></span></code>      ,           . ,     ,     ,      ,          . <br> <br> <code class="cs">var changeTracker = new PropertyChangeTracker(viewModel); var question = viewModel.Questions.First() as OpenQuestionViewModel; question.Question.Response = <span class="hljs-string"><span class="hljs-string">"some text"</span></span>; CollectionAssert.Contains(changeTracker.ChangedProperties, <span class="hljs-string"><span class="hljs-string">"UnansweredQuestions"</span></span>);</code> <br>      <br>     <code>INotifyPropertyChanged</code> ,      <code>PropertyChanged</code>        ,  ,     , , .        ,       . <br> <br>   <i>INotifyDataErrorInfo</i> <br>   ,     ,    ,   ,   <code>IDataErrorInfo</code> ,  ( Silverlight)   <code>INotifyDataErrorInfo</code> .   <code>INotifyDataErrorInfo</code>   ,         ,    ,  ,   ,    . <br> <br>       <code>INotifyDataErrorInfo</code> : ,     ,  ,     ,     <code>ErrorsChanged</code> ,      <code>GetErrors</code> , . <br> <br>    <br>     ,      ,     .       ,         <code>GetErrors</code>       ,  ,  ,   .    , ,  ,     ,        .   ,        . <br> <br> <code class="cs">//  . var notifyErrorInfo = (INotifyDataErrorInfo)question; question.Response = -<span class="hljs-number"><span class="hljs-number">15</span></span>; Assert.IsTrue(notifyErrorInfo.GetErrors(<span class="hljs-string"><span class="hljs-string">"Response"</span></span>).Cast&lt;ValidationResult&gt;().Any()); //  . var notifyErrorInfo = (INotifyDataErrorInfo)question; question.Response = <span class="hljs-number"><span class="hljs-number">15</span></span>; Assert.IsFalse(notifyErrorInfo.GetErrors(<span class="hljs-string"><span class="hljs-string">"Response"</span></span>).Cast&lt;ValidationResult&gt;().Any());</code> <br>    ,    ,             . <br> <br>    <i>INotifyDataErrorInfo</i> <br>       <code>GetErrors</code> ,   <code>INotifyDataErrorInfo</code>  ,   <code>ErrorsChanged</code>      <code>GetErrors</code> . ,  <code>HasErrors</code>      ,  . <br> <br>       <code>INotifyDataErrorInfo</code> . , ,           ,   -  .      ,        <code>INotifyDataErrorInfo</code>         (,        ). <br> <br>     ,   ,  : <br>  <code>HasErrors</code>     .              ,       .  <code>ErrorsChanged</code> ,      ,         <code>GetErrors</code> .         ( ,  )     ,           .    <code>GetErrors</code>       <code>ErrorsChanged</code> . <br>    <code>INotifyPropertyChanged</code> ,  ,    <code>NotifyDataErrorInfoTestHelper</code>    MVVM,        <code>INotifyDataErrorInfo</code> ,       .   ,   ,      ,   .      . <br> <code class="cs">var helper = new NotifyDataErrorInfoTestHelper&lt;NumericQuestion, int?&gt;( question, q =&gt; q.Response); helper.ValidatePropertyChange( <span class="hljs-number"><span class="hljs-number">6</span></span>, NotifyDataErrorInfoBehavior.Nothing); helper.ValidatePropertyChange( <span class="hljs-number"><span class="hljs-number">20</span></span>, NotifyDataErrorInfoBehavior.FiresErrorsChanged | NotifyDataErrorInfoBehavior.HasErrors | NotifyDataErrorInfoBehavior.HasErrorsForProperty); helper.ValidatePropertyChange( null, NotifyDataErrorInfoBehavior.FiresErrorsChanged | NotifyDataErrorInfoBehavior.HasErrors | NotifyDataErrorInfoBehavior.HasErrorsForProperty); helper.ValidatePropertyChange( <span class="hljs-number"><span class="hljs-number">2</span></span>, NotifyDataErrorInfoBehavior.FiresErrorsChanged);</code> <br>     <br>   MVVM,     ,  .   ,    ,         . <br> <br>  ,     ,     ,       .   ,   , ,       ,     ,   <code>IAsyncResult</code>    ,  - ,   ,    UI. <br> <br>       , , ,    .   ,     .  ,      UI,     ,   ,          ,     ,        <span class="hljs-string"><span class="hljs-string">"   UI."</span></span> <br> <br>     ,    ,    .   ,    ,     mock-, ,   ,   ,      ,          . <br> <br>           UI,    ,    .   ,     ,   ,      .        ,   .     ,    ,     . <br> <br> <code class="cs">questionnaireRepositoryMock .Setup( r =&gt; r.SubmitQuestionnaireAsync( It.IsAny&lt;Questionnaire&gt;(), It.IsAny&lt;Action&lt;IOperationResult&gt;&gt;())) .Callback&lt;Questionnaire, Action&lt;IOperationResult&gt;&gt;( (q, a) =&gt; callback = a); uiServicemock .Setup(svc =&gt; svc.ShowView(ViewNames.QuestionnaireTemplatesList)) .Callback&lt;<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>&gt;(viewName =&gt; requestedViewName = viewName); submitResultMock .Setup(sr =&gt; sr.Error) .Returns&lt;Exception&gt;(null); CompleteQuestionnaire(viewModel); viewModel.Submit(); //      UI . callback(submitResultMock.Object); //    ‚Äì     . Assert.AreEqual(ViewNames.QuestionnaireTemplatesList, requestedViewName);</code> <br> <b></b> <br>          ,        . <br>   <br>       , . <span class="hljs-string"><span class="hljs-string">"Trees in WPF"</span></span>  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ms753391.aspx">http://msdn.microsoft.com/en-us/library/ms753391.aspx</a> <br> <br>       , . <span class="hljs-string"><span class="hljs-string">"Attached Properties Overview"</span></span>  MSDN: <a href="http://msdn.microsoft.com/en-us/library/cc265152(VS.95).aspx">http://msdn.microsoft.com/en-us/library/cc265152(VS.<span class="hljs-number"><span class="hljs-number">95</span></span>).aspx</a> <br> <br>      MEF, .<span class="hljs-string"><span class="hljs-string">"Managed Extensibility Framework Overview"</span></span>  MSDN: <a href="http://msdn.microsoft.com/en-us/library/dd460648.aspx">http://msdn.microsoft.com/en-us/library/dd460648.aspx</a> . <br> <br>      Unity, .<span class="hljs-string"><span class="hljs-string">"Unity Application Block"</span></span>  MSDN: <a href="http://www.msdn.com/unity">http://www.msdn.com/unity</a> . <br> <br>      <code>DelegateCommand</code> , .Chapter <span class="hljs-number"><span class="hljs-number">5</span></span>, <span class="hljs-string"><span class="hljs-string">" </span></span><a href="http://msdn.microsoft.com/en-us/library/gg405484(v%3DPandP.40).aspx"><span class="hljs-string"><span class="hljs-string">Implementing the MVVM Pattern</span></span></a><span class="hljs-string"><span class="hljs-string"> ."</span></span> <br> <br>        Microsoft Expression Blend, .<span class="hljs-string"><span class="hljs-string">"Working with built-in behaviors"</span></span>  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ff724013(v%3DExpression.40).aspx">http://msdn.microsoft.com/en-us/library/ff724013(v=Expression.<span class="hljs-number"><span class="hljs-number">40</span></span>).aspx</a> . <br> <br>          Microsoft Expression Blend, .<span class="hljs-string"><span class="hljs-string">"Creating Custom Behaviors"</span></span>  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ff724708(v%3DExpression.40).aspx">http://msdn.microsoft.com/en-us/library/ff724708(v=Expression.<span class="hljs-number"><span class="hljs-number">40</span></span>).aspx</a> . <br> <br>            Microsoft Expression Blend, .<span class="hljs-string"><span class="hljs-string">"Creating Custom Triggers and Actions"</span></span>  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ff724707(v%3DExpression.40).aspx">http://msdn.microsoft.com/en-us/library/ff724707(v=Expression.<span class="hljs-number"><span class="hljs-number">40</span></span>).aspx</a> . <br> <br>         WPF  Silverlight, .<span class="hljs-string"><span class="hljs-string">"Threading Model"</span></span>  <span class="hljs-string"><span class="hljs-string">"The Dispatcher Class"</span></span>  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ms741870.aspx">http://msdn.microsoft.com/en-us/library/ms741870.aspx</a> <br> <a href="http://msdn.microsoft.com/en-us/library/ms615907(v%3DVS.95).aspx">http://msdn.microsoft.com/en-us/library/ms615907(v=VS.<span class="hljs-number"><span class="hljs-number">95</span></span>).aspx</a> . <br> <br>      unit-  Silverlight, .<span class="hljs-string"><span class="hljs-string">"Unit Testing with Silverlight 2"</span></span>: <a href="http://www.jeff.wilcox.name/2008/03/silverlight2-unit-testing/">http://www.jeff.wilcox.name/<span class="hljs-number"><span class="hljs-number">2008</span></span>/<span class="hljs-number"><span class="hljs-number">03</span></span>/silverlight2-unit-testing/</a> . <br> <br>         , .  <span class="hljs-string"><span class="hljs-string">" </span></span><a href="http://msdn.microsoft.com/en-us/library/gg430861(v%3DPandP.40).aspx"><span class="hljs-string"><span class="hljs-string">View-Based Navigation</span></span></a><span class="hljs-string"><span class="hljs-string"> "</span></span> in Chapter <span class="hljs-number"><span class="hljs-number">8</span></span>, <span class="hljs-string"><span class="hljs-string">" </span></span><a href="http://msdn.microsoft.com/en-us/library/gg430861(v%3DPandP.40).aspx"><span class="hljs-string"><span class="hljs-string">Navigation</span></span></a><span class="hljs-string"><span class="hljs-string"> ."</span></span> <br> <br>       ,   , .<span class="hljs-string"><span class="hljs-string">"Event-based Asynchronous Pattern Overview"</span></span>  MSDN: <a href="http://msdn.microsoft.com/en-us/library/wewwczdw.aspx">http://msdn.microsoft.com/en-us/library/wewwczdw.aspx</a> <br> <br>        <code>IAsyncResult</code> , .<span class="hljs-string"><span class="hljs-string">"Asynchronous Programming Overview"</span></span>  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ms228963.aspx">http://msdn.microsoft.com/en-us/library/ms228963.aspx</a></code></code></code></code></code></code></code></code></code> </pre> <code><code><code><code><code><code><code>CommandBehaviorBase ,    ,    ICommand</code> .           <code>CanExecuteChanged</code> ,          Silverlight,    WPF. <br> <br>    ,  ,   <code>CommandBehaviorBase    ,    .         ,      .         ,    .      ButtonBaseClickCommandBehavior</code> . <br> <br> <code class="cs">public class ButtonBaseClickCommandBehavior : CommandBehaviorBase&lt;ButtonBase&gt; { public ButtonBaseClickCommandBehavior(ButtonBase clickableObject) : base(clickableObject) { clickableObject.Click += OnClick; } private void OnClick(object sender, System.Windows.RoutedEventArgs e) { ExecuteCommand(); } }</code> <br>   <code>CommandBehaviorBase ,     .     ,          ,   . ,    ,    ,      , ,    CanExecute</code>  ,     . <br> <br>          ,   .           XAML.           .       .  Prism      ,       ,  ,   .       ,    . , ,  ,      <code>Click</code> ,       <code>Command</code> .    <code>Click.Command</code> ,  . <br> <br>             .             . <br> <br> <code class="cs">public static readonly DependencyProperty CommandProperty = DependencyProperty.RegisterAttached( "Command", typeof(ICommand), typeof(Click), new PropertyMetadata(OnSetCommandCallback)); private static readonly DependencyProperty ClickCommandBehaviorProperty = DependencyProperty.RegisterAttached( "ClickCommandBehavior", typeof(ButtonBaseClickCommandBehavior), typeof(Click), null);</code> <br>    <code>Command</code>    <code>ButtonBaseClickCommandBehavior</code> ,     <code>OnSetCommandCallback</code> ,     . <br> <br> <code class="cs">private static void OnSetCommandCallback(DependencyObject dependencyObject, DependencyPropertyChangedEventArgs e) { ButtonBase buttonBase = dependencyObject as ButtonBase; if (buttonBase != null) { ButtonBaseClickCommandBehavior behavior = GetOrCreateBehavior(buttonBase); behavior.Command = e.NewValue as ICommand; } } private static void OnSetCommandParameterCallback(DependencyObject dependencyObject, DependencyPropertyChangedEventArgs e) { ButtonBase buttonBase = dependencyObject as ButtonBase; if (buttonBase != null) { ButtonBaseClickCommandBehavior behavior = GetOrCreateBehavior(buttonBase); behavior.CommandParameter = e.NewValue; } } private static ButtonBaseClickCommandBehavior GetOrCreateBehavior(ButtonBase buttonBase ) { ButtonBaseClickCommandBehavior behavior = buttonBase.GetValue(ClickCommandBehaviorProperty) as ButtonBaseClickCommandBehavior; if ( behavior == null ) { behavior = new ButtonBaseClickCommandBehavior(buttonBase); buttonBase.SetValue(ClickCommandBehaviorProperty, behavior); } return behavior; }</code> <br>        ,  <a href="http://msdn.microsoft.com/en-us/library/cc265152(VS.95).aspx">Attached Properties Overview</a>  MSDN. <br> <br>    <br>              . ,     Silverlight,    -,     ,      ,     .     ,       . <br> <br>        ,    ( )  ,  ,     .  UI       ,            UI. <br> <br>      - <br>   -     ,       <code>IAsyncResult</code> .   ,  ,   ,  <code>GetQuestionnaire</code> ,   : <code>BeginGetQuestionnaire</code>  <code>EndGetQuestionnaire</code> .    ,   <code>BeginGetQuestionnaire</code> .     ,   ,   <code>EndGetQuestionnaire</code>    . <br> <b></b> <br>  .NET Framework 4.5      <code>await</code>  <code>async</code>     <code>*Async</code> .      <a href="http://msdn.microsoft.com/en-us/library/vstudio/hh391443.aspx">"Asynchronous Programming with Async and Await (C# and Visual Basic)"</a> . <br>  ,    <code>EndGetQuestionnaire</code> ,      ,  ()      <code>BeginGetQuestionnaire</code> .     ,      ,   <code>EndGetQuestionnaire</code> ,   . <br> <br> <code class="xml">IAsyncResult asyncResult = this.service.BeginGetQuestionnaire( GetQuestionnaireCompleted, null //  ,      ); private void GetQuestionnaireCompleted(IAsyncResult result) { try { questionnaire = this.service.EndGetQuestionnaire(ar); } catch (Exception ex) { //  -   . } }</code> <br>  ,     <code>End*</code> (  , <code>EndGetQuestionnaire</code> ),    ,      .      , ,          UI.     ,   ,        . <br> <br>        UI,     -,      UI,         UI,   <code>Dispatcher</code>    <code>SynchronizationContext</code> .  WPF  Silverlight,   <code>Dispatcher</code> . <br> <br>      <code>Questionnaire</code>  ,        <code>QuestionnaireView</code> .  Silverlight    <code>CheckAccess</code> ,  ,      UI.  ,     <code>BeginInvoke</code> ,      UI. <br> <br> <code class="cs">var dispatcher = System.Windows.Deployment.Current.Dispatcher; if (dispatcher.CheckAccess()) { QuestionnaireView.DataContext = questionnaire; } else { dispatcher.BeginInvoke(() =&gt; { Questionnaire.DataContext = questionnaire; }); }</code> <br> <i>MVVM RI</i>   ,    ,   <code>IAsyncResult</code> ,   .      ,                 . ,       . <br> <br> <code class="cs">this.questionnaireRepository.GetQuestionnaireAsync( result =&gt; { this.Questionnaire = result.Result; });</code> <br>  <code>result</code>   ,     , , , .    ,     . <br> <br> <code class="cs">this.questionnaireRepository.GetQuestionnaireAsync( result =&gt; { if (result.Error == null) { this.Questionnaire = result.Result; ... } else { // Handle error. } })</code> <br>     <br>        ,      .     , ,             .        ,      ,     ,     . <br> <br>         ,      MVVM,     ,   . ,  -MVVM ,     <code>MessageBox</code>   code-behind UI,      .   MVVM     ,          . <br> <br>     MVVM,              ,          .      ,    ,   ,  ,     . <br> <br>              MVVM.      ,     ,     ,  ,     .    ,         ,     ,          .       . <br> <br>    <br>                  .        ,        .  ,         .         . <br> <br>  ,         ,         ,  .      ,     .           ,       . ,        WPF  Silverlight,        . <br> <br> <img title="Using the service to interact with the user." src="https://habrastorage.org/getpro/habr/post_images/4b5/397/f2d/4b5397f2d02e5851195b29f1893be6fc.png" alt=" ,    ."> <br> <br>  ,   <code>MessageBox</code>        ,     ,    ,     . <br> <br> <code class="cs">var result = interactionService.ShowMessageBox( "Are you sure you want to cancel this operation?", "Confirm", MessageBoxButton.OK); if (result == MessageBoxResult.Yes) { CancelRequest(); }</code> <br> ,      - ,      ,         Silverlight.         .             .     . <br> <br> <code class="cs">interactionService.ShowMessageBox( "Are you sure you want to cancel this operation?", "Confirm", MessageBoxButton.OK, result =&gt; { if (result == MessageBoxResult.Yes) { CancelRequest(); } });</code> <br>         ,      . ,  WPF    <code>MessageBox</code> ,       ;    Silverlight    ,    . <br> <br>     <br>         ‚Äì             .         ,      .     ,     .        ,        ,   ,     . <br> <br> <img title="Using interaction request objects." src="https://habrastorage.org/getpro/habr/post_images/3d0/ff0/1c5/3d0ff01c5518558c2d3c5c5f47ce0ce9.png" alt="   ."> <br> <br>    ,   ,          ‚Äì       ,      ,   ‚Äì     .   ,        ,    ,    UI            . <br> <br>       MVVM,     ,       ,         .         ,        ,    ,   . <br> <br>  Prism       <code>IInteractionRequest</code>   <code>InteractionRequest .  IInteractionRequest</code>  ,   .           ,   .  <code>InteractionRequest   IInteractionRequest</code>     <code>Raise</code> ,           , , ,   . <br> <br>       <br>  <code>InteractionRequest          .  Raise</code>          ( <code>T</code> )    ,    ,   .          ,       .      ,        .    ,  ,     . <br> <code class="cs">public interface IInteractionRequest { event EventHandler&lt;InteractionRequestedEventArgs&gt; Raised; } public class InteractionRequest&lt;T&gt; : IInteractionRequest { public event EventHandler&lt;InteractionRequestedEventArgs&gt; Raised; public void Raise(T context, Action&lt;T&gt; callback) { var handler = this.Raised; if (handler != null) { handler( this, new InteractionRequestedEventArgs(context, () =&gt; callback(context))); } } }</code> <br> Prism    ,      .  <code>Notification</code>       .    ,            .     ‚Äì <code>Title</code>  <code>Content</code> ,    .  ,   ,  ,  ,        . <br> <br>  <code>Confirmation</code>    <code>Notification</code>     ‚Äì <code>Confirmed</code> ,  ,  ,      .  <code>Confirmation</code> ,     <code>MessageBox</code> ,     /  .     ,     <code>Notification</code> ,     ,      . <br> <br>    <code><code><code>InteractionRequest ,       InteractionRequest      ,      .      ,    Raise</code> ,    , ,   . <br> <br> <code class="cs">public IInteractionRequest ConfirmCancelInteractionRequest { get { return this.confirmCancelInteractionRequest; } } this.confirmCancelInteractionRequest.Raise( new Confirmation("Are you sure you wish to cancel?"), confirmation =&gt; { if (confirmation.Confirmed) { this.NavigateToQuestionnaireList(); } }); }</code> <br> <i>MVVM Reference Implementation (MVVM RI)</i> ,    <code>IInteractionRequest</code>   <code><code>InteractionRequest ,          (. QuestionnaireViewModel.cs</code> ). <br> <br>        <br>       ,       .   ,       .    UI             . <br> <br>                . Microsoft Expression Blend Behaviors Framework     .  ,     ,    . <br> <br>  <code>EventTrigger</code> ,  Expression Blend,  ,      ,     ,   . , Prism   <code>EventTrigger</code> ,  <code>InteractionRequestTrigger</code> ,      <code>Raised</code>   <code>IInteractionRequest</code> .    XAML        . <br> <br>  ,   , <code>InteractionRequestTrigger</code>   .  Silverlight Prism   <code>PopupChildWindowAction</code> ,     .    ,         .   <code>ContentTemplate</code>  <code>PopupChildWindowAction</code> ,    ,    UI,      <code>Content</code>  .       <code>Title</code>  . <br> <b></b> <br>  ,    ,   <code>PopupChildWindowAction</code> ,     .    <code>Notification</code>  <code>NotificationChildWindow</code> ,        <code>Confirmation</code> ‚Äì <code>ConfirmationChildWindow</code> . <code>NotificationChildWindow</code>    ,   ,     <code>ConfirmationChildWindow</code>    <i>OK</i>  <i>Cancel</i> ,    .    ,   ,   <code>ChildWindow</code>  <code>PopupChildWindowAction</code> . <br>   ,  <code>InteractionRequestTrigger</code>  <code>PopupChildWindowAction</code> ,       <i>RI MVVM</i> . <br> <br> <code class="xml">&lt;i:Interaction.Triggers&gt; &lt;prism:InteractionRequestTrigger SourceObject="{Binding ConfirmCancelInteractionRequest}"&gt; &lt;prism:PopupChildWindowAction ContentTemplate="{StaticResource ConfirmWindowTemplate}"/&gt; &lt;/prism:InteractionRequestTrigger&gt; &lt;/i:Interaction.Triggers&gt; &lt;UserControl.Resources&gt; &lt;DataTemplate x:Key="ConfirmWindowTemplate"&gt; &lt;Grid MinWidth="250" MinHeight="100"&gt; &lt;TextBlock TextWrapping="Wrap" Grid.Row="0" Text="{Binding}"/&gt; &lt;/Grid&gt; &lt;/DataTemplate&gt; &lt;/UserControl.Resources&gt;</code> <br> <b></b> <br>      <code>ContentTemplate</code> ,   UI   <code>Content</code>  .    <code>Content</code>  ,  , <code>TextBlock</code>     <code>Content</code> . <br>      ,     ,    ,    .  ,     ,       ,     ,    .   ,   <i>RI MVVM</i> ,         <code>Confirmed</code>    <code>Confirmation</code>  <code>true</code> ,     OK. <br> <br>        ,     .  Prism <code>InteractionRequestTrigger</code>   <code>PopupChildWindowAction</code>            . <br> <br>     <br>     MVVM,       , ,    ,         .        (  , ,  ,   ).    ,  ,  ,            . <br> <br>        ,         . Managed Extensibility Framework (MEF)  Unity Application Block (Unity)      ,  ,           . <br> <br>  ,       , , ,    ( )      . ,       ,     .  ,     ,       . <br> <br>     ,  MEF <br>  MEF,       ,   <code>Import</code> ,      ,  ,   <code>Export</code> .         ,    . <br> <br> , <code>QuestionnaireView</code>   <i>RI MVVM</i> ,        ,    <code>Import</code> .   , MEF           .  <code>set</code>        ,   . <br> <br> <code class="cs">[Import] public QuestionnaireViewModel ViewModel { set { this.DataContext = value; } }</code> <br>     ,   . <br> <br> <code class="cs">[Export] public class QuestionnaireViewModel : NotificationObject { ... }</code> <br>        ,   . <br> <br> <code class="cs">public QuestionnaireView() { InitializeComponent(); } [ImportingConstructor] public QuestionnaireView(QuestionnaireViewModel viewModel) : this() { this.DataContext = viewModel; }</code> <br> <b></b> <br>          MEF,   Unity.   ,     ,        .   ,   Visual Studio  Expression Blend, ,        ,     .   ,   ,  ,      ,          <code>InitializeComponent</code> . <br>     ,  Unity <br>  Unity,    ,   MEF.     ,      .    ,         .  ,      . <br> <br>  ,      ,  ,         . ,           ,   . <br> <br> <code class="cs">public QuestionnaireView() { InitializeComponent(); } public QuestionnaireView(QuestionnaireViewModel viewModel) : this() { this.DataContext = viewModel; }</code> <br> <b></b> <br>    ,        ,   Visual Studio  Expression Blend. <br>  ,          ,   . Unity        <code>set</code>   ,   . <br> <br> <code class="cs">public QuestionnaireView() { InitializeComponent(); } [Dependency] public QuestionnaireViewModel ViewModel { set { this.DataContext = value; } }</code> <br>       Unity. <br> <br> <code class="cs">container.RegisterType&lt;QuestionnaireViewModel&gt;();</code> <br>  ,     . <br> <br> <code class="cs">var view = container.Resolve&lt;QuestionnaireView&gt;();</code> <br>     ,    <br>   ,     ,        .        ,   MEF  Unity,        . <br> <br>          .   ,         UI,           . <br> <br> , <i>RI MVVM</i>   ,   ,        .   ,    .      <code>ShowView</code>   UI. <br> <br> <code class="cs">private void NavigateToQuestionnaireList() { //     "questionnaire list". this.uiService.ShowView(ViewNames.QuestionnaireTemplatesList); }</code> <br>  UI      UI .           UI.  <code>ShowView</code>  <code>UIService</code>      (,          ),       ,   . <br> <br> <code class="cs">public void ShowView(string viewName) { var view = this.ViewFactory.GetView(viewName); this.MainWindow.CurrentView = view; }</code> <br> <b></b> <br> Prism       .   ,   ,   ,             .    ,  , " <a href="http://msdn.microsoft.com/en-us/library/gg430861(v%3DPandP.40).aspx">View-Based Navigation</a> "   8, " <a href="http://msdn.microsoft.com/en-us/library/gg430861(v%3DPandP.40).aspx">Navigation</a> ". <br>  MVVM  <br>        MVVM      .           -      mocking . ,   ,        . <br> <br>   <i>INotifyPropertyChanged</i> <br>   <code>INotifyPropertyChanged</code>     ,      .      ,    ;   ,   ,     ,    ,       . <br> <br>   <br> ,       ,           <code>PropertyChanged</code>  ,         .  ,    <code>ChangeTracker</code> ,     MVVM,  ,      .      .     ,    . <br> <br> <code class="cs">var changeTracker = new PropertyChangeTracker(viewModel); viewModel.CurrentState = "newState"; CollectionAssert.Contains(changeTracker.ChangedProperties, "CurrentState");</code> <br> ,     ,     <code>INotifyPropertyChanged</code> ,    ,   ,     . <br> <br>      <br>        ,   ,    <code>set</code>      ,           . ,     ,     ,      ,          . <br> <br> <code class="cs">var changeTracker = new PropertyChangeTracker(viewModel); var question = viewModel.Questions.First() as OpenQuestionViewModel; question.Question.Response = "some text"; CollectionAssert.Contains(changeTracker.ChangedProperties, "UnansweredQuestions");</code> <br>      <br>     <code>INotifyPropertyChanged</code> ,      <code>PropertyChanged</code>        ,  ,     , , .        ,       . <br> <br>   <i>INotifyDataErrorInfo</i> <br>   ,     ,    ,   ,   <code>IDataErrorInfo</code> ,  ( Silverlight)   <code>INotifyDataErrorInfo</code> .   <code>INotifyDataErrorInfo</code>   ,         ,    ,  ,   ,    . <br> <br>       <code>INotifyDataErrorInfo</code> : ,     ,  ,     ,     <code>ErrorsChanged</code> ,      <code>GetErrors</code> , . <br> <br>    <br>     ,      ,     .       ,         <code>GetErrors</code>       ,  ,  ,   .    , ,  ,     ,        .   ,        . <br> <br> <code class="cs">//  . var notifyErrorInfo = (INotifyDataErrorInfo)question; question.Response = -15; Assert.IsTrue(notifyErrorInfo.GetErrors("Response").Cast&lt;ValidationResult&gt;().Any()); //  . var notifyErrorInfo = (INotifyDataErrorInfo)question; question.Response = 15; Assert.IsFalse(notifyErrorInfo.GetErrors("Response").Cast&lt;ValidationResult&gt;().Any());</code> <br>    ,    ,             . <br> <br>    <i>INotifyDataErrorInfo</i> <br>       <code>GetErrors</code> ,   <code>INotifyDataErrorInfo</code>  ,   <code>ErrorsChanged</code>      <code>GetErrors</code> . ,  <code>HasErrors</code>      ,  . <br> <br>       <code>INotifyDataErrorInfo</code> . , ,           ,   -  .      ,        <code>INotifyDataErrorInfo</code>         (,        ). <br> <br>     ,   ,  : <br>  <code>HasErrors</code>     .              ,       .  <code>ErrorsChanged</code> ,      ,         <code>GetErrors</code> .         ( ,  )     ,           .    <code>GetErrors</code>       <code>ErrorsChanged</code> . <br>    <code>INotifyPropertyChanged</code> ,  ,    <code>NotifyDataErrorInfoTestHelper</code>    MVVM,        <code>INotifyDataErrorInfo</code> ,       .   ,   ,      ,   .      . <br> <code class="cs">var helper = new NotifyDataErrorInfoTestHelper&lt;NumericQuestion, int?&gt;( question, q =&gt; q.Response); helper.ValidatePropertyChange( 6, NotifyDataErrorInfoBehavior.Nothing); helper.ValidatePropertyChange( 20, NotifyDataErrorInfoBehavior.FiresErrorsChanged | NotifyDataErrorInfoBehavior.HasErrors | NotifyDataErrorInfoBehavior.HasErrorsForProperty); helper.ValidatePropertyChange( null, NotifyDataErrorInfoBehavior.FiresErrorsChanged | NotifyDataErrorInfoBehavior.HasErrors | NotifyDataErrorInfoBehavior.HasErrorsForProperty); helper.ValidatePropertyChange( 2, NotifyDataErrorInfoBehavior.FiresErrorsChanged);</code> <br>     <br>   MVVM,     ,  .   ,    ,         . <br> <br>  ,     ,     ,       .   ,   , ,       ,     ,   <code>IAsyncResult</code>    ,  - ,   ,    UI. <br> <br>       , , ,    .   ,     .  ,      UI,     ,   ,          ,     ,        "   UI." <br> <br>     ,    ,    .   ,    ,     mock-, ,   ,   ,      ,          . <br> <br>           UI,    ,    .   ,     ,   ,      .        ,   .     ,    ,     . <br> <br> <code class="cs">questionnaireRepositoryMock .Setup( r =&gt; r.SubmitQuestionnaireAsync( It.IsAny&lt;Questionnaire&gt;(), It.IsAny&lt;Action&lt;IOperationResult&gt;&gt;())) .Callback&lt;Questionnaire, Action&lt;IOperationResult&gt;&gt;( (q, a) =&gt; callback = a); uiServicemock .Setup(svc =&gt; svc.ShowView(ViewNames.QuestionnaireTemplatesList)) .Callback&lt;string&gt;(viewName =&gt; requestedViewName = viewName); submitResultMock .Setup(sr =&gt; sr.Error) .Returns&lt;Exception&gt;(null); CompleteQuestionnaire(viewModel); viewModel.Submit(); //      UI . callback(submitResultMock.Object); //    ‚Äì     . Assert.AreEqual(ViewNames.QuestionnaireTemplatesList, requestedViewName);</code> <br> <b></b> <br>          ,        . <br>   <br>       , . "Trees in WPF"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ms753391.aspx">http://msdn.microsoft.com/en-us/library/ms753391.aspx</a> <br> <br>       , . "Attached Properties Overview"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/cc265152(VS.95).aspx">http://msdn.microsoft.com/en-us/library/cc265152(VS.95).aspx</a> <br> <br>      MEF, ."Managed Extensibility Framework Overview"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/dd460648.aspx">http://msdn.microsoft.com/en-us/library/dd460648.aspx</a> . <br> <br>      Unity, ."Unity Application Block"  MSDN: <a href="http://www.msdn.com/unity">http://www.msdn.com/unity</a> . <br> <br>      <code>DelegateCommand</code> , .Chapter 5, " <a href="http://msdn.microsoft.com/en-us/library/gg405484(v%3DPandP.40).aspx">Implementing the MVVM Pattern</a> ." <br> <br>        Microsoft Expression Blend, ."Working with built-in behaviors"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ff724013(v%3DExpression.40).aspx">http://msdn.microsoft.com/en-us/library/ff724013(v=Expression.40).aspx</a> . <br> <br>          Microsoft Expression Blend, ."Creating Custom Behaviors"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ff724708(v%3DExpression.40).aspx">http://msdn.microsoft.com/en-us/library/ff724708(v=Expression.40).aspx</a> . <br> <br>            Microsoft Expression Blend, ."Creating Custom Triggers and Actions"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ff724707(v%3DExpression.40).aspx">http://msdn.microsoft.com/en-us/library/ff724707(v=Expression.40).aspx</a> . <br> <br>         WPF  Silverlight, ."Threading Model"  "The Dispatcher Class"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ms741870.aspx">http://msdn.microsoft.com/en-us/library/ms741870.aspx</a> <br> <a href="http://msdn.microsoft.com/en-us/library/ms615907(v%3DVS.95).aspx">http://msdn.microsoft.com/en-us/library/ms615907(v=VS.95).aspx</a> . <br> <br>      unit-  Silverlight, ."Unit Testing with Silverlight 2": <a href="http://www.jeff.wilcox.name/2008/03/silverlight2-unit-testing/">http://www.jeff.wilcox.name/2008/03/silverlight2-unit-testing/</a> . <br> <br>         , .  " <a href="http://msdn.microsoft.com/en-us/library/gg430861(v%3DPandP.40).aspx">View-Based Navigation</a> " in Chapter 8, " <a href="http://msdn.microsoft.com/en-us/library/gg430861(v%3DPandP.40).aspx">Navigation</a> ." <br> <br>       ,   , ."Event-based Asynchronous Pattern Overview"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/wewwczdw.aspx">http://msdn.microsoft.com/en-us/library/wewwczdw.aspx</a> <br> <br>        <code>IAsyncResult</code> , ."Asynchronous Programming Overview"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ms228963.aspx">http://msdn.microsoft.com/en-us/library/ms228963.aspx</a></code></code></code></code></code></code></code></code></code> <pre> <code class="hljs cmake"><code>CommandBehaviorBase ,    ,    ICommand</code> .           <code>CanExecuteChanged</code> ,          Silverlight,    WPF. <br> <br>    ,  ,   <code><code>CommandBehaviorBase    ,    .         ,      .         ,    .      ButtonBaseClickCommandBehavior</code> . <br> <br> <code class="cs">public class ButtonBaseClickCommandBehavior : CommandBehaviorBase&lt;ButtonBase&gt; { public ButtonBaseClickCommandBehavior(ButtonBase clickableObject) : base(clickableObject) { clickableObject.Click += OnClick; } private void OnClick(object sender, System.Windows.RoutedEventArgs e) { ExecuteCommand(); } }</code> <br>   <code><code>CommandBehaviorBase ,     .     ,          ,   . ,    ,    ,      , ,    CanExecute</code>  ,     . <br> <br>          ,   .           XAML.           .       .  Prism      ,       ,  ,   .       ,    . , ,  ,      <code>Click</code> ,       <code><span class="hljs-keyword"><span class="hljs-keyword">Command</span></span></code> .    <code>Click.<span class="hljs-keyword"><span class="hljs-keyword">Command</span></span></code> ,  . <br> <br>             .             . <br> <br> <code class="cs">public static readonly DependencyProperty CommandProperty = DependencyProperty.RegisterAttached( <span class="hljs-string"><span class="hljs-string">"Command"</span></span>, typeof(ICommand), typeof(Click), new PropertyMetadata(OnSetCommandCallback)); private static readonly DependencyProperty ClickCommandBehaviorProperty = DependencyProperty.RegisterAttached( <span class="hljs-string"><span class="hljs-string">"ClickCommandBehavior"</span></span>, typeof(ButtonBaseClickCommandBehavior), typeof(Click), null);</code> <br>    <code><span class="hljs-keyword"><span class="hljs-keyword">Command</span></span></code>    <code>ButtonBaseClickCommandBehavior</code> ,     <code>OnSetCommandCallback</code> ,     . <br> <br> <code class="cs">private static void OnSetCommandCallback(DependencyObject dependencyObject, DependencyPropertyChangedEventArgs e) { ButtonBase buttonBase = dependencyObject as ButtonBase; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (buttonBase != null) { ButtonBaseClickCommandBehavior behavior = GetOrCreateBehavior(buttonBase); behavior.<span class="hljs-keyword"><span class="hljs-keyword">Command</span></span> = e.NewValue as ICommand; } } private static void OnSetCommandParameterCallback(DependencyObject dependencyObject, DependencyPropertyChangedEventArgs e) { ButtonBase buttonBase = dependencyObject as ButtonBase; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (buttonBase != null) { ButtonBaseClickCommandBehavior behavior = GetOrCreateBehavior(buttonBase); behavior.CommandParameter = e.NewValue; } } private static ButtonBaseClickCommandBehavior GetOrCreateBehavior(ButtonBase buttonBase ) { ButtonBaseClickCommandBehavior behavior = buttonBase.GetValue(ClickCommandBehaviorProperty) as ButtonBaseClickCommandBehavior; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ( behavior == null ) { behavior = new ButtonBaseClickCommandBehavior(buttonBase); buttonBase.SetValue(ClickCommandBehaviorProperty, behavior); } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> behavior; }</code> <br>        ,  <a href="http://msdn.microsoft.com/en-us/library/cc265152(VS.95).aspx">Attached Properties Overview</a>  MSDN. <br> <br>    <br>              . ,     Silverlight,    -,     ,      ,     .     ,       . <br> <br>        ,    ( )  ,  ,     .  UI       ,            UI. <br> <br>      - <br>   -     ,       <code>IAsyncResult</code> .   ,  ,   ,  <code>GetQuestionnaire</code> ,   : <code>BeginGetQuestionnaire</code>  <code>EndGetQuestionnaire</code> .    ,   <code>BeginGetQuestionnaire</code> .     ,   ,   <code>EndGetQuestionnaire</code>    . <br> <b></b> <br>  .NET Framework <span class="hljs-number"><span class="hljs-number">4.5</span></span>      <code>await</code>  <code>async</code>     <code>*Async</code> .      <a href="http://msdn.microsoft.com/en-us/library/vstudio/hh391443.aspx"><span class="hljs-string"><span class="hljs-string">"Asynchronous Programming with Async and Await (C# and Visual Basic)"</span></span></a> . <br>  ,    <code>EndGetQuestionnaire</code> ,      ,  ()      <code>BeginGetQuestionnaire</code> .     ,      ,   <code>EndGetQuestionnaire</code> ,   . <br> <br> <code class="xml">IAsyncResult asyncResult = this.service.BeginGetQuestionnaire( GetQuestionnaireCompleted, null //  ,      ); private void GetQuestionnaireCompleted(IAsyncResult result) { try { questionnaire = this.service.EndGetQuestionnaire(ar); } catch (Exception ex) { //  -   . } }</code> <br>  ,     <code>End*</code> (  , <code>EndGetQuestionnaire</code> ),    ,      .      , ,          UI.     ,   ,        . <br> <br>        UI,     -,      UI,         UI,   <code>Dispatcher</code>    <code>SynchronizationContext</code> .  WPF  Silverlight,   <code>Dispatcher</code> . <br> <br>      <code>Questionnaire</code>  ,        <code>QuestionnaireView</code> .  Silverlight    <code>CheckAccess</code> ,  ,      UI.  ,     <code>BeginInvoke</code> ,      UI. <br> <br> <code class="cs">var dispatcher = System.Windows.Deployment.Current.Dispatcher; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (dispatcher.CheckAccess()) { QuestionnaireView.DataContext = questionnaire; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { dispatcher.BeginInvoke(() =&gt; { Questionnaire.DataContext = questionnaire; }); }</code> <br> <i>MVVM RI</i>   ,    ,   <code>IAsyncResult</code> ,   .      ,                 . ,       . <br> <br> <code class="cs">this.questionnaireRepository.GetQuestionnaireAsync( result =&gt; { this.Questionnaire = result.Result; });</code> <br>  <code>result</code>   ,     , , , .    ,     . <br> <br> <code class="cs">this.questionnaireRepository.GetQuestionnaireAsync( result =&gt; { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (result.Error == null) { this.Questionnaire = result.Result; ... } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { // Handle error. } })</code> <br>     <br>        ,      .     , ,             .        ,      ,     ,     . <br> <br>         ,      MVVM,     ,   . ,  -MVVM ,     <code>MessageBox</code>   code-behind UI,      .   MVVM     ,          . <br> <br>     MVVM,              ,          .      ,    ,   ,  ,     . <br> <br>              MVVM.      ,     ,     ,  ,     .    ,         ,     ,          .       . <br> <br>    <br>                  .        ,        .  ,         .         . <br> <br>  ,         ,         ,  .      ,     .           ,       . ,        WPF  Silverlight,        . <br> <br> <img title="Using the service to interact with the user." src="https://habrastorage.org/getpro/habr/post_images/4b5/397/f2d/4b5397f2d02e5851195b29f1893be6fc.png" alt=" ,    ."> <br> <br>  ,   <code>MessageBox</code>        ,     ,    ,     . <br> <br> <code class="cs">var result = interactionService.ShowMessageBox( <span class="hljs-string"><span class="hljs-string">"Are you sure you want to cancel this operation?"</span></span>, <span class="hljs-string"><span class="hljs-string">"Confirm"</span></span>, MessageBoxButton.OK); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (result == MessageBoxResult.Yes) { CancelRequest(); }</code> <br> ,      - ,      ,         Silverlight.         .             .     . <br> <br> <code class="cs">interactionService.ShowMessageBox( <span class="hljs-string"><span class="hljs-string">"Are you sure you want to cancel this operation?"</span></span>, <span class="hljs-string"><span class="hljs-string">"Confirm"</span></span>, MessageBoxButton.OK, result =&gt; { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (result == MessageBoxResult.Yes) { CancelRequest(); } });</code> <br>         ,      . ,  WPF    <code>MessageBox</code> ,       ;    Silverlight    ,    . <br> <br>     <br>         ‚Äì             .         ,      .     ,     .        ,        ,   ,     . <br> <br> <img title="Using interaction request objects." src="https://habrastorage.org/getpro/habr/post_images/3d0/ff0/1c5/3d0ff01c5518558c2d3c5c5f47ce0ce9.png" alt="   ."> <br> <br>    ,   ,          ‚Äì       ,      ,   ‚Äì     .   ,        ,    ,    UI            . <br> <br>       MVVM,     ,       ,         .         ,        ,    ,   . <br> <br>  Prism       <code>IInteractionRequest</code>   <code><code>InteractionRequest .  IInteractionRequest</code>  ,   .           ,   .  <code><code>InteractionRequest   IInteractionRequest</code>     <code>Raise</code> ,           , , ,   . <br> <br>       <br>  <code><code>InteractionRequest          .  Raise</code>          ( <code>T</code> )    ,    ,   .          ,       .      ,        .    ,  ,     . <br> <code class="cs">public interface IInteractionRequest { event EventHandler&lt;InteractionRequestedEventArgs&gt; Raised; } public class InteractionRequest&lt;T&gt; : IInteractionRequest { public event EventHandler&lt;InteractionRequestedEventArgs&gt; Raised; public void Raise(T context, Action&lt;T&gt; callback) { var handler = this.Raised; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (handler != null) { handler( this, new InteractionRequestedEventArgs(context, () =&gt; callback(context))); } } }</code> <br> Prism    ,      .  <code>Notification</code>       .    ,            .     ‚Äì <code>Title</code>  <code>Content</code> ,    .  ,   ,  ,  ,        . <br> <br>  <code>Confirmation</code>    <code>Notification</code>     ‚Äì <code>Confirmed</code> ,  ,  ,      .  <code>Confirmation</code> ,     <code>MessageBox</code> ,     /  .     ,     <code>Notification</code> ,     ,      . <br> <br>    <code><code><code>InteractionRequest ,       InteractionRequest      ,      .      ,    Raise</code> ,    , ,   . <br> <br> <code class="cs">public IInteractionRequest ConfirmCancelInteractionRequest { get { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> this.confirmCancelInteractionRequest; } } this.confirmCancelInteractionRequest.Raise( new Confirmation(<span class="hljs-string"><span class="hljs-string">"Are you sure you wish to cancel?"</span></span>), confirmation =&gt; { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (confirmation.Confirmed) { this.NavigateToQuestionnaireList(); } }); }</code> <br> <i>MVVM Reference Implementation (MVVM RI)</i> ,    <code>IInteractionRequest</code>   <code><code>InteractionRequest ,          (. QuestionnaireViewModel.cs</code> ). <br> <br>        <br>       ,       .   ,       .    UI             . <br> <br>                . Microsoft Expression Blend Behaviors Framework     .  ,     ,    . <br> <br>  <code>EventTrigger</code> ,  Expression Blend,  ,      ,     ,   . , Prism   <code>EventTrigger</code> ,  <code>InteractionRequestTrigger</code> ,      <code>Raised</code>   <code>IInteractionRequest</code> .    XAML        . <br> <br>  ,   , <code>InteractionRequestTrigger</code>   .  Silverlight Prism   <code>PopupChildWindowAction</code> ,     .    ,         .   <code>ContentTemplate</code>  <code>PopupChildWindowAction</code> ,    ,    UI,      <code>Content</code>  .       <code>Title</code>  . <br> <b></b> <br>  ,    ,   <code>PopupChildWindowAction</code> ,     .    <code>Notification</code>  <code>NotificationChildWindow</code> ,        <code>Confirmation</code> ‚Äì <code>ConfirmationChildWindow</code> . <code>NotificationChildWindow</code>    ,   ,     <code>ConfirmationChildWindow</code>    <i>OK</i>  <i>Cancel</i> ,    .    ,   ,   <code>ChildWindow</code>  <code>PopupChildWindowAction</code> . <br>   ,  <code>InteractionRequestTrigger</code>  <code>PopupChildWindowAction</code> ,       <i>RI MVVM</i> . <br> <br> <code class="xml">&lt;i:Interaction.Triggers&gt; &lt;prism:InteractionRequestTrigger SourceObject=<span class="hljs-string"><span class="hljs-string">"{Binding ConfirmCancelInteractionRequest}"</span></span>&gt; &lt;prism:PopupChildWindowAction ContentTemplate=<span class="hljs-string"><span class="hljs-string">"{StaticResource ConfirmWindowTemplate}"</span></span>/&gt; &lt;/prism:InteractionRequestTrigger&gt; &lt;/i:Interaction.Triggers&gt; &lt;UserControl.Resources&gt; &lt;DataTemplate x:Key=<span class="hljs-string"><span class="hljs-string">"ConfirmWindowTemplate"</span></span>&gt; &lt;Grid MinWidth=<span class="hljs-string"><span class="hljs-string">"250"</span></span> MinHeight=<span class="hljs-string"><span class="hljs-string">"100"</span></span>&gt; &lt;TextBlock TextWrapping=<span class="hljs-string"><span class="hljs-string">"Wrap"</span></span> Grid.Row=<span class="hljs-string"><span class="hljs-string">"0"</span></span> Text=<span class="hljs-string"><span class="hljs-string">"{Binding}"</span></span>/&gt; &lt;/Grid&gt; &lt;/DataTemplate&gt; &lt;/UserControl.Resources&gt;</code> <br> <b></b> <br>      <code>ContentTemplate</code> ,   UI   <code>Content</code>  .    <code>Content</code>  ,  , <code>TextBlock</code>     <code>Content</code> . <br>      ,     ,    ,    .  ,     ,       ,     ,    .   ,   <i>RI MVVM</i> ,         <code>Confirmed</code>    <code>Confirmation</code>  <code><span class="hljs-keyword"><span class="hljs-keyword">true</span></span></code> ,     OK. <br> <br>        ,     .  Prism <code>InteractionRequestTrigger</code>   <code>PopupChildWindowAction</code>            . <br> <br>     <br>     MVVM,       , ,    ,         .        (  , ,  ,   ).    ,  ,  ,            . <br> <br>        ,         . Managed Extensibility Framework (MEF)  Unity Application Block (Unity)      ,  ,           . <br> <br>  ,       , , ,    ( )      . ,       ,     .  ,     ,       . <br> <br>     ,  MEF <br>  MEF,       ,   <code>Import</code> ,      ,  ,   <code><span class="hljs-keyword"><span class="hljs-keyword">Export</span></span></code> .         ,    . <br> <br> , <code>QuestionnaireView</code>   <i>RI MVVM</i> ,        ,    <code>Import</code> .   , MEF           .  <code><span class="hljs-keyword"><span class="hljs-keyword">set</span></span></code>        ,   . <br> <br> <code class="cs">[Import] public QuestionnaireViewModel ViewModel { <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> { this.DataContext = value; } }</code> <br>     ,   . <br> <br> <code class="cs">[<span class="hljs-keyword"><span class="hljs-keyword">Export</span></span>] public class QuestionnaireViewModel : NotificationObject { ... }</code> <br>        ,   . <br> <br> <code class="cs">public QuestionnaireView() { InitializeComponent(); } [ImportingConstructor] public QuestionnaireView(QuestionnaireViewModel viewModel) : this() { this.DataContext = viewModel; }</code> <br> <b></b> <br>          MEF,   Unity.   ,     ,        .   ,   Visual Studio  Expression Blend, ,        ,     .   ,   ,  ,      ,          <code>InitializeComponent</code> . <br>     ,  Unity <br>  Unity,    ,   MEF.     ,      .    ,         .  ,      . <br> <br>  ,      ,  ,         . ,           ,   . <br> <br> <code class="cs">public QuestionnaireView() { InitializeComponent(); } public QuestionnaireView(QuestionnaireViewModel viewModel) : this() { this.DataContext = viewModel; }</code> <br> <b></b> <br>    ,        ,   Visual Studio  Expression Blend. <br>  ,          ,   . Unity        <code><span class="hljs-keyword"><span class="hljs-keyword">set</span></span></code>   ,   . <br> <br> <code class="cs">public QuestionnaireView() { InitializeComponent(); } [Dependency] public QuestionnaireViewModel ViewModel { <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> { this.DataContext = value; } }</code> <br>       Unity. <br> <br> <code class="cs">container.RegisterType&lt;QuestionnaireViewModel&gt;();</code> <br>  ,     . <br> <br> <code class="cs">var view = container.Resolve&lt;QuestionnaireView&gt;();</code> <br>     ,    <br>   ,     ,        .        ,   MEF  Unity,        . <br> <br>          .   ,         UI,           . <br> <br> , <i>RI MVVM</i>   ,   ,        .   ,    .      <code>ShowView</code>   UI. <br> <br> <code class="cs">private void NavigateToQuestionnaireList() { //     <span class="hljs-string"><span class="hljs-string">"questionnaire list"</span></span>. this.uiService.ShowView(ViewNames.QuestionnaireTemplatesList); }</code> <br>  UI      UI .           UI.  <code>ShowView</code>  <code>UIService</code>      (,          ),       ,   . <br> <br> <code class="cs">public void ShowView(<span class="hljs-keyword"><span class="hljs-keyword">string</span></span> viewName) { var view = this.ViewFactory.GetView(viewName); this.MainWindow.CurrentView = view; }</code> <br> <b></b> <br> Prism       .   ,   ,   ,             .    ,  , <span class="hljs-string"><span class="hljs-string">" </span></span><a href="http://msdn.microsoft.com/en-us/library/gg430861(v%3DPandP.40).aspx"><span class="hljs-string"><span class="hljs-string">View-Based Navigation</span></span></a><span class="hljs-string"><span class="hljs-string"> "</span></span>   <span class="hljs-number"><span class="hljs-number">8</span></span>, <span class="hljs-string"><span class="hljs-string">" </span></span><a href="http://msdn.microsoft.com/en-us/library/gg430861(v%3DPandP.40).aspx"><span class="hljs-string"><span class="hljs-string">Navigation</span></span></a><span class="hljs-string"><span class="hljs-string"> "</span></span>. <br>  MVVM  <br>        MVVM      .           -      mocking . ,   ,        . <br> <br>   <i>INotifyPropertyChanged</i> <br>   <code>INotifyPropertyChanged</code>     ,      .      ,    ;   ,   ,     ,    ,       . <br> <br>   <br> ,       ,           <code>PropertyChanged</code>  ,         .  ,    <code>ChangeTracker</code> ,     MVVM,  ,      .      .     ,    . <br> <br> <code class="cs">var changeTracker = new PropertyChangeTracker(viewModel); viewModel.CurrentState = <span class="hljs-string"><span class="hljs-string">"newState"</span></span>; CollectionAssert.Contains(changeTracker.ChangedProperties, <span class="hljs-string"><span class="hljs-string">"CurrentState"</span></span>);</code> <br> ,     ,     <code>INotifyPropertyChanged</code> ,    ,   ,     . <br> <br>      <br>        ,   ,    <code><span class="hljs-keyword"><span class="hljs-keyword">set</span></span></code>      ,           . ,     ,     ,      ,          . <br> <br> <code class="cs">var changeTracker = new PropertyChangeTracker(viewModel); var question = viewModel.Questions.First() as OpenQuestionViewModel; question.Question.Response = <span class="hljs-string"><span class="hljs-string">"some text"</span></span>; CollectionAssert.Contains(changeTracker.ChangedProperties, <span class="hljs-string"><span class="hljs-string">"UnansweredQuestions"</span></span>);</code> <br>      <br>     <code>INotifyPropertyChanged</code> ,      <code>PropertyChanged</code>        ,  ,     , , .        ,       . <br> <br>   <i>INotifyDataErrorInfo</i> <br>   ,     ,    ,   ,   <code>IDataErrorInfo</code> ,  ( Silverlight)   <code>INotifyDataErrorInfo</code> .   <code>INotifyDataErrorInfo</code>   ,         ,    ,  ,   ,    . <br> <br>       <code>INotifyDataErrorInfo</code> : ,     ,  ,     ,     <code>ErrorsChanged</code> ,      <code>GetErrors</code> , . <br> <br>    <br>     ,      ,     .       ,         <code>GetErrors</code>       ,  ,  ,   .    , ,  ,     ,        .   ,        . <br> <br> <code class="cs">//  . var notifyErrorInfo = (INotifyDataErrorInfo)question; question.Response = -<span class="hljs-number"><span class="hljs-number">15</span></span>; Assert.IsTrue(notifyErrorInfo.GetErrors(<span class="hljs-string"><span class="hljs-string">"Response"</span></span>).Cast&lt;ValidationResult&gt;().Any()); //  . var notifyErrorInfo = (INotifyDataErrorInfo)question; question.Response = <span class="hljs-number"><span class="hljs-number">15</span></span>; Assert.IsFalse(notifyErrorInfo.GetErrors(<span class="hljs-string"><span class="hljs-string">"Response"</span></span>).Cast&lt;ValidationResult&gt;().Any());</code> <br>    ,    ,             . <br> <br>    <i>INotifyDataErrorInfo</i> <br>       <code>GetErrors</code> ,   <code>INotifyDataErrorInfo</code>  ,   <code>ErrorsChanged</code>      <code>GetErrors</code> . ,  <code>HasErrors</code>      ,  . <br> <br>       <code>INotifyDataErrorInfo</code> . , ,           ,   -  .      ,        <code>INotifyDataErrorInfo</code>         (,        ). <br> <br>     ,   ,  : <br>  <code>HasErrors</code>     .              ,       .  <code>ErrorsChanged</code> ,      ,         <code>GetErrors</code> .         ( ,  )     ,           .    <code>GetErrors</code>       <code>ErrorsChanged</code> . <br>    <code>INotifyPropertyChanged</code> ,  ,    <code>NotifyDataErrorInfoTestHelper</code>    MVVM,        <code>INotifyDataErrorInfo</code> ,       .   ,   ,      ,   .      . <br> <code class="cs">var helper = new NotifyDataErrorInfoTestHelper&lt;NumericQuestion, int?&gt;( question, q =&gt; q.Response); helper.ValidatePropertyChange( <span class="hljs-number"><span class="hljs-number">6</span></span>, NotifyDataErrorInfoBehavior.Nothing); helper.ValidatePropertyChange( <span class="hljs-number"><span class="hljs-number">20</span></span>, NotifyDataErrorInfoBehavior.FiresErrorsChanged | NotifyDataErrorInfoBehavior.HasErrors | NotifyDataErrorInfoBehavior.HasErrorsForProperty); helper.ValidatePropertyChange( null, NotifyDataErrorInfoBehavior.FiresErrorsChanged | NotifyDataErrorInfoBehavior.HasErrors | NotifyDataErrorInfoBehavior.HasErrorsForProperty); helper.ValidatePropertyChange( <span class="hljs-number"><span class="hljs-number">2</span></span>, NotifyDataErrorInfoBehavior.FiresErrorsChanged);</code> <br>     <br>   MVVM,     ,  .   ,    ,         . <br> <br>  ,     ,     ,       .   ,   , ,       ,     ,   <code>IAsyncResult</code>    ,  - ,   ,    UI. <br> <br>       , , ,    .   ,     .  ,      UI,     ,   ,          ,     ,        <span class="hljs-string"><span class="hljs-string">"   UI."</span></span> <br> <br>     ,    ,    .   ,    ,     mock-, ,   ,   ,      ,          . <br> <br>           UI,    ,    .   ,     ,   ,      .        ,   .     ,    ,     . <br> <br> <code class="cs">questionnaireRepositoryMock .Setup( r =&gt; r.SubmitQuestionnaireAsync( It.IsAny&lt;Questionnaire&gt;(), It.IsAny&lt;Action&lt;IOperationResult&gt;&gt;())) .Callback&lt;Questionnaire, Action&lt;IOperationResult&gt;&gt;( (q, a) =&gt; callback = a); uiServicemock .Setup(svc =&gt; svc.ShowView(ViewNames.QuestionnaireTemplatesList)) .Callback&lt;<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>&gt;(viewName =&gt; requestedViewName = viewName); submitResultMock .Setup(sr =&gt; sr.Error) .Returns&lt;Exception&gt;(null); CompleteQuestionnaire(viewModel); viewModel.Submit(); //      UI . callback(submitResultMock.Object); //    ‚Äì     . Assert.AreEqual(ViewNames.QuestionnaireTemplatesList, requestedViewName);</code> <br> <b></b> <br>          ,        . <br>   <br>       , . <span class="hljs-string"><span class="hljs-string">"Trees in WPF"</span></span>  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ms753391.aspx">http://msdn.microsoft.com/en-us/library/ms753391.aspx</a> <br> <br>       , . <span class="hljs-string"><span class="hljs-string">"Attached Properties Overview"</span></span>  MSDN: <a href="http://msdn.microsoft.com/en-us/library/cc265152(VS.95).aspx">http://msdn.microsoft.com/en-us/library/cc265152(VS.<span class="hljs-number"><span class="hljs-number">95</span></span>).aspx</a> <br> <br>      MEF, .<span class="hljs-string"><span class="hljs-string">"Managed Extensibility Framework Overview"</span></span>  MSDN: <a href="http://msdn.microsoft.com/en-us/library/dd460648.aspx">http://msdn.microsoft.com/en-us/library/dd460648.aspx</a> . <br> <br>      Unity, .<span class="hljs-string"><span class="hljs-string">"Unity Application Block"</span></span>  MSDN: <a href="http://www.msdn.com/unity">http://www.msdn.com/unity</a> . <br> <br>      <code>DelegateCommand</code> , .Chapter <span class="hljs-number"><span class="hljs-number">5</span></span>, <span class="hljs-string"><span class="hljs-string">" </span></span><a href="http://msdn.microsoft.com/en-us/library/gg405484(v%3DPandP.40).aspx"><span class="hljs-string"><span class="hljs-string">Implementing the MVVM Pattern</span></span></a><span class="hljs-string"><span class="hljs-string"> ."</span></span> <br> <br>        Microsoft Expression Blend, .<span class="hljs-string"><span class="hljs-string">"Working with built-in behaviors"</span></span>  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ff724013(v%3DExpression.40).aspx">http://msdn.microsoft.com/en-us/library/ff724013(v=Expression.<span class="hljs-number"><span class="hljs-number">40</span></span>).aspx</a> . <br> <br>          Microsoft Expression Blend, .<span class="hljs-string"><span class="hljs-string">"Creating Custom Behaviors"</span></span>  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ff724708(v%3DExpression.40).aspx">http://msdn.microsoft.com/en-us/library/ff724708(v=Expression.<span class="hljs-number"><span class="hljs-number">40</span></span>).aspx</a> . <br> <br>            Microsoft Expression Blend, .<span class="hljs-string"><span class="hljs-string">"Creating Custom Triggers and Actions"</span></span>  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ff724707(v%3DExpression.40).aspx">http://msdn.microsoft.com/en-us/library/ff724707(v=Expression.<span class="hljs-number"><span class="hljs-number">40</span></span>).aspx</a> . <br> <br>         WPF  Silverlight, .<span class="hljs-string"><span class="hljs-string">"Threading Model"</span></span>  <span class="hljs-string"><span class="hljs-string">"The Dispatcher Class"</span></span>  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ms741870.aspx">http://msdn.microsoft.com/en-us/library/ms741870.aspx</a> <br> <a href="http://msdn.microsoft.com/en-us/library/ms615907(v%3DVS.95).aspx">http://msdn.microsoft.com/en-us/library/ms615907(v=VS.<span class="hljs-number"><span class="hljs-number">95</span></span>).aspx</a> . <br> <br>      unit-  Silverlight, .<span class="hljs-string"><span class="hljs-string">"Unit Testing with Silverlight 2"</span></span>: <a href="http://www.jeff.wilcox.name/2008/03/silverlight2-unit-testing/">http://www.jeff.wilcox.name/<span class="hljs-number"><span class="hljs-number">2008</span></span>/<span class="hljs-number"><span class="hljs-number">03</span></span>/silverlight2-unit-testing/</a> . <br> <br>         , .  <span class="hljs-string"><span class="hljs-string">" </span></span><a href="http://msdn.microsoft.com/en-us/library/gg430861(v%3DPandP.40).aspx"><span class="hljs-string"><span class="hljs-string">View-Based Navigation</span></span></a><span class="hljs-string"><span class="hljs-string"> "</span></span> in Chapter <span class="hljs-number"><span class="hljs-number">8</span></span>, <span class="hljs-string"><span class="hljs-string">" </span></span><a href="http://msdn.microsoft.com/en-us/library/gg430861(v%3DPandP.40).aspx"><span class="hljs-string"><span class="hljs-string">Navigation</span></span></a><span class="hljs-string"><span class="hljs-string"> ."</span></span> <br> <br>       ,   , .<span class="hljs-string"><span class="hljs-string">"Event-based Asynchronous Pattern Overview"</span></span>  MSDN: <a href="http://msdn.microsoft.com/en-us/library/wewwczdw.aspx">http://msdn.microsoft.com/en-us/library/wewwczdw.aspx</a> <br> <br>        <code>IAsyncResult</code> , .<span class="hljs-string"><span class="hljs-string">"Asynchronous Programming Overview"</span></span>  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ms228963.aspx">http://msdn.microsoft.com/en-us/library/ms228963.aspx</a></code></code></code></code></code></code></code></code></code> </pre> <code><code><code><code><code><code><code><code><code>CommandBehaviorBase ,    ,    ICommand</code> .           <code>CanExecuteChanged</code> ,          Silverlight,    WPF. <br> <br>    ,  ,   <code>CommandBehaviorBase    ,    .         ,      .         ,    .      ButtonBaseClickCommandBehavior</code> . <br> <br> <code class="cs">public class ButtonBaseClickCommandBehavior : CommandBehaviorBase&lt;ButtonBase&gt; { public ButtonBaseClickCommandBehavior(ButtonBase clickableObject) : base(clickableObject) { clickableObject.Click += OnClick; } private void OnClick(object sender, System.Windows.RoutedEventArgs e) { ExecuteCommand(); } }</code> <br>   <code>CommandBehaviorBase ,     .     ,          ,   . ,    ,    ,      , ,    CanExecute</code>  ,     . <br> <br>          ,   .           XAML.           .       .  Prism      ,       ,  ,   .       ,    . , ,  ,      <code>Click</code> ,       <code>Command</code> .    <code>Click.Command</code> ,  . <br> <br>             .             . <br> <br> <code class="cs">public static readonly DependencyProperty CommandProperty = DependencyProperty.RegisterAttached( "Command", typeof(ICommand), typeof(Click), new PropertyMetadata(OnSetCommandCallback)); private static readonly DependencyProperty ClickCommandBehaviorProperty = DependencyProperty.RegisterAttached( "ClickCommandBehavior", typeof(ButtonBaseClickCommandBehavior), typeof(Click), null);</code> <br>    <code>Command</code>    <code>ButtonBaseClickCommandBehavior</code> ,     <code>OnSetCommandCallback</code> ,     . <br> <br> <code class="cs">private static void OnSetCommandCallback(DependencyObject dependencyObject, DependencyPropertyChangedEventArgs e) { ButtonBase buttonBase = dependencyObject as ButtonBase; if (buttonBase != null) { ButtonBaseClickCommandBehavior behavior = GetOrCreateBehavior(buttonBase); behavior.Command = e.NewValue as ICommand; } } private static void OnSetCommandParameterCallback(DependencyObject dependencyObject, DependencyPropertyChangedEventArgs e) { ButtonBase buttonBase = dependencyObject as ButtonBase; if (buttonBase != null) { ButtonBaseClickCommandBehavior behavior = GetOrCreateBehavior(buttonBase); behavior.CommandParameter = e.NewValue; } } private static ButtonBaseClickCommandBehavior GetOrCreateBehavior(ButtonBase buttonBase ) { ButtonBaseClickCommandBehavior behavior = buttonBase.GetValue(ClickCommandBehaviorProperty) as ButtonBaseClickCommandBehavior; if ( behavior == null ) { behavior = new ButtonBaseClickCommandBehavior(buttonBase); buttonBase.SetValue(ClickCommandBehaviorProperty, behavior); } return behavior; }</code> <br>        ,  <a href="http://msdn.microsoft.com/en-us/library/cc265152(VS.95).aspx">Attached Properties Overview</a>  MSDN. <br> <br>    <br>              . ,     Silverlight,    -,     ,      ,     .     ,       . <br> <br>        ,    ( )  ,  ,     .  UI       ,            UI. <br> <br>      - <br>   -     ,       <code>IAsyncResult</code> .   ,  ,   ,  <code>GetQuestionnaire</code> ,   : <code>BeginGetQuestionnaire</code>  <code>EndGetQuestionnaire</code> .    ,   <code>BeginGetQuestionnaire</code> .     ,   ,   <code>EndGetQuestionnaire</code>    . <br> <b></b> <br>  .NET Framework 4.5      <code>await</code>  <code>async</code>     <code>*Async</code> .      <a href="http://msdn.microsoft.com/en-us/library/vstudio/hh391443.aspx">"Asynchronous Programming with Async and Await (C# and Visual Basic)"</a> . <br>  ,    <code>EndGetQuestionnaire</code> ,      ,  ()      <code>BeginGetQuestionnaire</code> .     ,      ,   <code>EndGetQuestionnaire</code> ,   . <br> <br> <code class="xml">IAsyncResult asyncResult = this.service.BeginGetQuestionnaire( GetQuestionnaireCompleted, null //  ,      ); private void GetQuestionnaireCompleted(IAsyncResult result) { try { questionnaire = this.service.EndGetQuestionnaire(ar); } catch (Exception ex) { //  -   . } }</code> <br>  ,     <code>End*</code> (  , <code>EndGetQuestionnaire</code> ),    ,      .      , ,          UI.     ,   ,        . <br> <br>        UI,     -,      UI,         UI,   <code>Dispatcher</code>    <code>SynchronizationContext</code> .  WPF  Silverlight,   <code>Dispatcher</code> . <br> <br>      <code>Questionnaire</code>  ,        <code>QuestionnaireView</code> .  Silverlight    <code>CheckAccess</code> ,  ,      UI.  ,     <code>BeginInvoke</code> ,      UI. <br> <br> <code class="cs">var dispatcher = System.Windows.Deployment.Current.Dispatcher; if (dispatcher.CheckAccess()) { QuestionnaireView.DataContext = questionnaire; } else { dispatcher.BeginInvoke(() =&gt; { Questionnaire.DataContext = questionnaire; }); }</code> <br> <i>MVVM RI</i>   ,    ,   <code>IAsyncResult</code> ,   .      ,                 . ,       . <br> <br> <code class="cs">this.questionnaireRepository.GetQuestionnaireAsync( result =&gt; { this.Questionnaire = result.Result; });</code> <br>  <code>result</code>   ,     , , , .    ,     . <br> <br> <code class="cs">this.questionnaireRepository.GetQuestionnaireAsync( result =&gt; { if (result.Error == null) { this.Questionnaire = result.Result; ... } else { // Handle error. } })</code> <br>     <br>        ,      .     , ,             .        ,      ,     ,     . <br> <br>         ,      MVVM,     ,   . ,  -MVVM ,     <code>MessageBox</code>   code-behind UI,      .   MVVM     ,          . <br> <br>     MVVM,              ,          .      ,    ,   ,  ,     . <br> <br>              MVVM.      ,     ,     ,  ,     .    ,         ,     ,          .       . <br> <br>    <br>                  .        ,        .  ,         .         . <br> <br>  ,         ,         ,  .      ,     .           ,       . ,        WPF  Silverlight,        . <br> <br> <img title="Using the service to interact with the user." src="https://habrastorage.org/getpro/habr/post_images/4b5/397/f2d/4b5397f2d02e5851195b29f1893be6fc.png" alt=" ,    ."> <br> <br>  ,   <code>MessageBox</code>        ,     ,    ,     . <br> <br> <code class="cs">var result = interactionService.ShowMessageBox( "Are you sure you want to cancel this operation?", "Confirm", MessageBoxButton.OK); if (result == MessageBoxResult.Yes) { CancelRequest(); }</code> <br> ,      - ,      ,         Silverlight.         .             .     . <br> <br> <code class="cs">interactionService.ShowMessageBox( "Are you sure you want to cancel this operation?", "Confirm", MessageBoxButton.OK, result =&gt; { if (result == MessageBoxResult.Yes) { CancelRequest(); } });</code> <br>         ,      . ,  WPF    <code>MessageBox</code> ,       ;    Silverlight    ,    . <br> <br>     <br>         ‚Äì             .         ,      .     ,     .        ,        ,   ,     . <br> <br> <img title="Using interaction request objects." src="https://habrastorage.org/getpro/habr/post_images/3d0/ff0/1c5/3d0ff01c5518558c2d3c5c5f47ce0ce9.png" alt="   ."> <br> <br>    ,   ,          ‚Äì       ,      ,   ‚Äì     .   ,        ,    ,    UI            . <br> <br>       MVVM,     ,       ,         .         ,        ,    ,   . <br> <br>  Prism       <code>IInteractionRequest</code>   <code>InteractionRequest .  IInteractionRequest</code>  ,   .           ,   .  <code>InteractionRequest   IInteractionRequest</code>     <code>Raise</code> ,           , , ,   . <br> <br>       <br>  <code>InteractionRequest          .  Raise</code>          ( <code>T</code> )    ,    ,   .          ,       .      ,        .    ,  ,     . <br> <code class="cs">public interface IInteractionRequest { event EventHandler&lt;InteractionRequestedEventArgs&gt; Raised; } public class InteractionRequest&lt;T&gt; : IInteractionRequest { public event EventHandler&lt;InteractionRequestedEventArgs&gt; Raised; public void Raise(T context, Action&lt;T&gt; callback) { var handler = this.Raised; if (handler != null) { handler( this, new InteractionRequestedEventArgs(context, () =&gt; callback(context))); } } }</code> <br> Prism    ,      .  <code>Notification</code>       .    ,            .     ‚Äì <code>Title</code>  <code>Content</code> ,    .  ,   ,  ,  ,        . <br> <br>  <code>Confirmation</code>    <code>Notification</code>     ‚Äì <code>Confirmed</code> ,  ,  ,      .  <code>Confirmation</code> ,     <code>MessageBox</code> ,     /  .     ,     <code>Notification</code> ,     ,      . <br> <br>    <code>InteractionRequest ,       InteractionRequest      ,      .      ,    Raise</code> ,    , ,   . <br> <br> <code class="cs">public IInteractionRequest ConfirmCancelInteractionRequest { get { return this.confirmCancelInteractionRequest; } } this.confirmCancelInteractionRequest.Raise( new Confirmation("Are you sure you wish to cancel?"), confirmation =&gt; { if (confirmation.Confirmed) { this.NavigateToQuestionnaireList(); } }); }</code> <br> <i>MVVM Reference Implementation (MVVM RI)</i> ,    <code>IInteractionRequest</code>   <code><code>InteractionRequest ,          (. QuestionnaireViewModel.cs</code> ). <br> <br>        <br>       ,       .   ,       .    UI             . <br> <br>                . Microsoft Expression Blend Behaviors Framework     .  ,     ,    . <br> <br>  <code>EventTrigger</code> ,  Expression Blend,  ,      ,     ,   . , Prism   <code>EventTrigger</code> ,  <code>InteractionRequestTrigger</code> ,      <code>Raised</code>   <code>IInteractionRequest</code> .    XAML        . <br> <br>  ,   , <code>InteractionRequestTrigger</code>   .  Silverlight Prism   <code>PopupChildWindowAction</code> ,     .    ,         .   <code>ContentTemplate</code>  <code>PopupChildWindowAction</code> ,    ,    UI,      <code>Content</code>  .       <code>Title</code>  . <br> <b></b> <br>  ,    ,   <code>PopupChildWindowAction</code> ,     .    <code>Notification</code>  <code>NotificationChildWindow</code> ,        <code>Confirmation</code> ‚Äì <code>ConfirmationChildWindow</code> . <code>NotificationChildWindow</code>    ,   ,     <code>ConfirmationChildWindow</code>    <i>OK</i>  <i>Cancel</i> ,    .    ,   ,   <code>ChildWindow</code>  <code>PopupChildWindowAction</code> . <br>   ,  <code>InteractionRequestTrigger</code>  <code>PopupChildWindowAction</code> ,       <i>RI MVVM</i> . <br> <br> <code class="xml">&lt;i:Interaction.Triggers&gt; &lt;prism:InteractionRequestTrigger SourceObject="{Binding ConfirmCancelInteractionRequest}"&gt; &lt;prism:PopupChildWindowAction ContentTemplate="{StaticResource ConfirmWindowTemplate}"/&gt; &lt;/prism:InteractionRequestTrigger&gt; &lt;/i:Interaction.Triggers&gt; &lt;UserControl.Resources&gt; &lt;DataTemplate x:Key="ConfirmWindowTemplate"&gt; &lt;Grid MinWidth="250" MinHeight="100"&gt; &lt;TextBlock TextWrapping="Wrap" Grid.Row="0" Text="{Binding}"/&gt; &lt;/Grid&gt; &lt;/DataTemplate&gt; &lt;/UserControl.Resources&gt;</code> <br> <b></b> <br>      <code>ContentTemplate</code> ,   UI   <code>Content</code>  .    <code>Content</code>  ,  , <code>TextBlock</code>     <code>Content</code> . <br>      ,     ,    ,    .  ,     ,       ,     ,    .   ,   <i>RI MVVM</i> ,         <code>Confirmed</code>    <code>Confirmation</code>  <code>true</code> ,     OK. <br> <br>        ,     .  Prism <code>InteractionRequestTrigger</code>   <code>PopupChildWindowAction</code>            . <br> <br>     <br>     MVVM,       , ,    ,         .        (  , ,  ,   ).    ,  ,  ,            . <br> <br>        ,         . Managed Extensibility Framework (MEF)  Unity Application Block (Unity)      ,  ,           . <br> <br>  ,       , , ,    ( )      . ,       ,     .  ,     ,       . <br> <br>     ,  MEF <br>  MEF,       ,   <code>Import</code> ,      ,  ,   <code>Export</code> .         ,    . <br> <br> , <code>QuestionnaireView</code>   <i>RI MVVM</i> ,        ,    <code>Import</code> .   , MEF           .  <code>set</code>        ,   . <br> <br> <code class="cs">[Import] public QuestionnaireViewModel ViewModel { set { this.DataContext = value; } }</code> <br>     ,   . <br> <br> <code class="cs">[Export] public class QuestionnaireViewModel : NotificationObject { ... }</code> <br>        ,   . <br> <br> <code class="cs">public QuestionnaireView() { InitializeComponent(); } [ImportingConstructor] public QuestionnaireView(QuestionnaireViewModel viewModel) : this() { this.DataContext = viewModel; }</code> <br> <b></b> <br>          MEF,   Unity.   ,     ,        .   ,   Visual Studio  Expression Blend, ,        ,     .   ,   ,  ,      ,          <code>InitializeComponent</code> . <br>     ,  Unity <br>  Unity,    ,   MEF.     ,      .    ,         .  ,      . <br> <br>  ,      ,  ,         . ,           ,   . <br> <br> <code class="cs">public QuestionnaireView() { InitializeComponent(); } public QuestionnaireView(QuestionnaireViewModel viewModel) : this() { this.DataContext = viewModel; }</code> <br> <b></b> <br>    ,        ,   Visual Studio  Expression Blend. <br>  ,          ,   . Unity        <code>set</code>   ,   . <br> <br> <code class="cs">public QuestionnaireView() { InitializeComponent(); } [Dependency] public QuestionnaireViewModel ViewModel { set { this.DataContext = value; } }</code> <br>       Unity. <br> <br> <code class="cs">container.RegisterType&lt;QuestionnaireViewModel&gt;();</code> <br>  ,     . <br> <br> <code class="cs">var view = container.Resolve&lt;QuestionnaireView&gt;();</code> <br>     ,    <br>   ,     ,        .        ,   MEF  Unity,        . <br> <br>          .   ,         UI,           . <br> <br> , <i>RI MVVM</i>   ,   ,        .   ,    .      <code>ShowView</code>   UI. <br> <br> <code class="cs">private void NavigateToQuestionnaireList() { //     "questionnaire list". this.uiService.ShowView(ViewNames.QuestionnaireTemplatesList); }</code> <br>  UI      UI .           UI.  <code>ShowView</code>  <code>UIService</code>      (,          ),       ,   . <br> <br> <code class="cs">public void ShowView(string viewName) { var view = this.ViewFactory.GetView(viewName); this.MainWindow.CurrentView = view; }</code> <br> <b></b> <br> Prism       .   ,   ,   ,             .    ,  , " <a href="http://msdn.microsoft.com/en-us/library/gg430861(v%3DPandP.40).aspx">View-Based Navigation</a> "   8, " <a href="http://msdn.microsoft.com/en-us/library/gg430861(v%3DPandP.40).aspx">Navigation</a> ". <br>  MVVM  <br>        MVVM      .           -      mocking . ,   ,        . <br> <br>   <i>INotifyPropertyChanged</i> <br>   <code>INotifyPropertyChanged</code>     ,      .      ,    ;   ,   ,     ,    ,       . <br> <br>   <br> ,       ,           <code>PropertyChanged</code>  ,         .  ,    <code>ChangeTracker</code> ,     MVVM,  ,      .      .     ,    . <br> <br> <code class="cs">var changeTracker = new PropertyChangeTracker(viewModel); viewModel.CurrentState = "newState"; CollectionAssert.Contains(changeTracker.ChangedProperties, "CurrentState");</code> <br> ,     ,     <code>INotifyPropertyChanged</code> ,    ,   ,     . <br> <br>      <br>        ,   ,    <code>set</code>      ,           . ,     ,     ,      ,          . <br> <br> <code class="cs">var changeTracker = new PropertyChangeTracker(viewModel); var question = viewModel.Questions.First() as OpenQuestionViewModel; question.Question.Response = "some text"; CollectionAssert.Contains(changeTracker.ChangedProperties, "UnansweredQuestions");</code> <br>      <br>     <code>INotifyPropertyChanged</code> ,      <code>PropertyChanged</code>        ,  ,     , , .        ,       . <br> <br>   <i>INotifyDataErrorInfo</i> <br>   ,     ,    ,   ,   <code>IDataErrorInfo</code> ,  ( Silverlight)   <code>INotifyDataErrorInfo</code> .   <code>INotifyDataErrorInfo</code>   ,         ,    ,  ,   ,    . <br> <br>       <code>INotifyDataErrorInfo</code> : ,     ,  ,     ,     <code>ErrorsChanged</code> ,      <code>GetErrors</code> , . <br> <br>    <br>     ,      ,     .       ,         <code>GetErrors</code>       ,  ,  ,   .    , ,  ,     ,        .   ,        . <br> <br> <code class="cs">//  . var notifyErrorInfo = (INotifyDataErrorInfo)question; question.Response = -15; Assert.IsTrue(notifyErrorInfo.GetErrors("Response").Cast&lt;ValidationResult&gt;().Any()); //  . var notifyErrorInfo = (INotifyDataErrorInfo)question; question.Response = 15; Assert.IsFalse(notifyErrorInfo.GetErrors("Response").Cast&lt;ValidationResult&gt;().Any());</code> <br>    ,    ,             . <br> <br>    <i>INotifyDataErrorInfo</i> <br>       <code>GetErrors</code> ,   <code>INotifyDataErrorInfo</code>  ,   <code>ErrorsChanged</code>      <code>GetErrors</code> . ,  <code>HasErrors</code>      ,  . <br> <br>       <code>INotifyDataErrorInfo</code> . , ,           ,   -  .      ,        <code>INotifyDataErrorInfo</code>         (,        ). <br> <br>     ,   ,  : <br>  <code>HasErrors</code>     .              ,       .  <code>ErrorsChanged</code> ,      ,         <code>GetErrors</code> .         ( ,  )     ,           .    <code>GetErrors</code>       <code>ErrorsChanged</code> . <br>    <code>INotifyPropertyChanged</code> ,  ,    <code>NotifyDataErrorInfoTestHelper</code>    MVVM,        <code>INotifyDataErrorInfo</code> ,       .   ,   ,      ,   .      . <br> <code class="cs">var helper = new NotifyDataErrorInfoTestHelper&lt;NumericQuestion, int?&gt;( question, q =&gt; q.Response); helper.ValidatePropertyChange( 6, NotifyDataErrorInfoBehavior.Nothing); helper.ValidatePropertyChange( 20, NotifyDataErrorInfoBehavior.FiresErrorsChanged | NotifyDataErrorInfoBehavior.HasErrors | NotifyDataErrorInfoBehavior.HasErrorsForProperty); helper.ValidatePropertyChange( null, NotifyDataErrorInfoBehavior.FiresErrorsChanged | NotifyDataErrorInfoBehavior.HasErrors | NotifyDataErrorInfoBehavior.HasErrorsForProperty); helper.ValidatePropertyChange( 2, NotifyDataErrorInfoBehavior.FiresErrorsChanged);</code> <br>     <br>   MVVM,     ,  .   ,    ,         . <br> <br>  ,     ,     ,       .   ,   , ,       ,     ,   <code>IAsyncResult</code>    ,  - ,   ,    UI. <br> <br>       , , ,    .   ,     .  ,      UI,     ,   ,          ,     ,        "   UI." <br> <br>     ,    ,    .   ,    ,     mock-, ,   ,   ,      ,          . <br> <br>           UI,    ,    .   ,     ,   ,      .        ,   .     ,    ,     . <br> <br> <code class="cs">questionnaireRepositoryMock .Setup( r =&gt; r.SubmitQuestionnaireAsync( It.IsAny&lt;Questionnaire&gt;(), It.IsAny&lt;Action&lt;IOperationResult&gt;&gt;())) .Callback&lt;Questionnaire, Action&lt;IOperationResult&gt;&gt;( (q, a) =&gt; callback = a); uiServicemock .Setup(svc =&gt; svc.ShowView(ViewNames.QuestionnaireTemplatesList)) .Callback&lt;string&gt;(viewName =&gt; requestedViewName = viewName); submitResultMock .Setup(sr =&gt; sr.Error) .Returns&lt;Exception&gt;(null); CompleteQuestionnaire(viewModel); viewModel.Submit(); //      UI . callback(submitResultMock.Object); //    ‚Äì     . Assert.AreEqual(ViewNames.QuestionnaireTemplatesList, requestedViewName);</code> <br> <b></b> <br>          ,        . <br>   <br>       , . "Trees in WPF"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ms753391.aspx">http://msdn.microsoft.com/en-us/library/ms753391.aspx</a> <br> <br>       , . "Attached Properties Overview"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/cc265152(VS.95).aspx">http://msdn.microsoft.com/en-us/library/cc265152(VS.95).aspx</a> <br> <br>      MEF, ."Managed Extensibility Framework Overview"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/dd460648.aspx">http://msdn.microsoft.com/en-us/library/dd460648.aspx</a> . <br> <br>      Unity, ."Unity Application Block"  MSDN: <a href="http://www.msdn.com/unity">http://www.msdn.com/unity</a> . <br> <br>      <code>DelegateCommand</code> , .Chapter 5, " <a href="http://msdn.microsoft.com/en-us/library/gg405484(v%3DPandP.40).aspx">Implementing the MVVM Pattern</a> ." <br> <br>        Microsoft Expression Blend, ."Working with built-in behaviors"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ff724013(v%3DExpression.40).aspx">http://msdn.microsoft.com/en-us/library/ff724013(v=Expression.40).aspx</a> . <br> <br>          Microsoft Expression Blend, ."Creating Custom Behaviors"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ff724708(v%3DExpression.40).aspx">http://msdn.microsoft.com/en-us/library/ff724708(v=Expression.40).aspx</a> . <br> <br>            Microsoft Expression Blend, ."Creating Custom Triggers and Actions"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ff724707(v%3DExpression.40).aspx">http://msdn.microsoft.com/en-us/library/ff724707(v=Expression.40).aspx</a> . <br> <br>         WPF  Silverlight, ."Threading Model"  "The Dispatcher Class"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ms741870.aspx">http://msdn.microsoft.com/en-us/library/ms741870.aspx</a> <br> <a href="http://msdn.microsoft.com/en-us/library/ms615907(v%3DVS.95).aspx">http://msdn.microsoft.com/en-us/library/ms615907(v=VS.95).aspx</a> . <br> <br>      unit-  Silverlight, ."Unit Testing with Silverlight 2": <a href="http://www.jeff.wilcox.name/2008/03/silverlight2-unit-testing/">http://www.jeff.wilcox.name/2008/03/silverlight2-unit-testing/</a> . <br> <br>         , .  " <a href="http://msdn.microsoft.com/en-us/library/gg430861(v%3DPandP.40).aspx">View-Based Navigation</a> " in Chapter 8, " <a href="http://msdn.microsoft.com/en-us/library/gg430861(v%3DPandP.40).aspx">Navigation</a> ." <br> <br>       ,   , ."Event-based Asynchronous Pattern Overview"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/wewwczdw.aspx">http://msdn.microsoft.com/en-us/library/wewwczdw.aspx</a> <br> <br>        <code>IAsyncResult</code> , ."Asynchronous Programming Overview"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ms228963.aspx">http://msdn.microsoft.com/en-us/library/ms228963.aspx</a></code></code></code></code></code></code></code></code></code> <h5> <code><code><code><code><code><code><code><code><code><code>CommandBehaviorBase ,    ,    ICommand</code> .           <code>CanExecuteChanged</code> ,          Silverlight,    WPF. <br> <br>    ,  ,   <code>CommandBehaviorBase    ,    .         ,      .         ,    .      ButtonBaseClickCommandBehavior</code> . <br> <br> <code class="cs">public class ButtonBaseClickCommandBehavior : CommandBehaviorBase&lt;ButtonBase&gt; { public ButtonBaseClickCommandBehavior(ButtonBase clickableObject) : base(clickableObject) { clickableObject.Click += OnClick; } private void OnClick(object sender, System.Windows.RoutedEventArgs e) { ExecuteCommand(); } }</code> <br>   <code>CommandBehaviorBase ,     .     ,          ,   . ,    ,    ,      , ,    CanExecute</code>  ,     . <br> <br>          ,   .           XAML.           .       .  Prism      ,       ,  ,   .       ,    . , ,  ,      <code>Click</code> ,       <code>Command</code> .    <code>Click.Command</code> ,  . <br> <br>             .             . <br> <br> <code class="cs">public static readonly DependencyProperty CommandProperty = DependencyProperty.RegisterAttached( "Command", typeof(ICommand), typeof(Click), new PropertyMetadata(OnSetCommandCallback)); private static readonly DependencyProperty ClickCommandBehaviorProperty = DependencyProperty.RegisterAttached( "ClickCommandBehavior", typeof(ButtonBaseClickCommandBehavior), typeof(Click), null);</code> <br>    <code>Command</code>    <code>ButtonBaseClickCommandBehavior</code> ,     <code>OnSetCommandCallback</code> ,     . <br> <br> <code class="cs">private static void OnSetCommandCallback(DependencyObject dependencyObject, DependencyPropertyChangedEventArgs e) { ButtonBase buttonBase = dependencyObject as ButtonBase; if (buttonBase != null) { ButtonBaseClickCommandBehavior behavior = GetOrCreateBehavior(buttonBase); behavior.Command = e.NewValue as ICommand; } } private static void OnSetCommandParameterCallback(DependencyObject dependencyObject, DependencyPropertyChangedEventArgs e) { ButtonBase buttonBase = dependencyObject as ButtonBase; if (buttonBase != null) { ButtonBaseClickCommandBehavior behavior = GetOrCreateBehavior(buttonBase); behavior.CommandParameter = e.NewValue; } } private static ButtonBaseClickCommandBehavior GetOrCreateBehavior(ButtonBase buttonBase ) { ButtonBaseClickCommandBehavior behavior = buttonBase.GetValue(ClickCommandBehaviorProperty) as ButtonBaseClickCommandBehavior; if ( behavior == null ) { behavior = new ButtonBaseClickCommandBehavior(buttonBase); buttonBase.SetValue(ClickCommandBehaviorProperty, behavior); } return behavior; }</code> <br>        ,  <a href="http://msdn.microsoft.com/en-us/library/cc265152(VS.95).aspx">Attached Properties Overview</a>  MSDN. <br> <br>    <br>              . ,     Silverlight,    -,     ,      ,     .     ,       . <br> <br>        ,    ( )  ,  ,     .  UI       ,            UI. <br> <br>      - <br>   -     ,       <code>IAsyncResult</code> .   ,  ,   ,  <code>GetQuestionnaire</code> ,   : <code>BeginGetQuestionnaire</code>  <code>EndGetQuestionnaire</code> .    ,   <code>BeginGetQuestionnaire</code> .     ,   ,   <code>EndGetQuestionnaire</code>    . <br> <b></b> <br>  .NET Framework 4.5      <code>await</code>  <code>async</code>     <code>*Async</code> .      <a href="http://msdn.microsoft.com/en-us/library/vstudio/hh391443.aspx">"Asynchronous Programming with Async and Await (C# and Visual Basic)"</a> . <br>  ,    <code>EndGetQuestionnaire</code> ,      ,  ()      <code>BeginGetQuestionnaire</code> .     ,      ,   <code>EndGetQuestionnaire</code> ,   . <br> <br> <code class="xml">IAsyncResult asyncResult = this.service.BeginGetQuestionnaire( GetQuestionnaireCompleted, null //  ,      ); private void GetQuestionnaireCompleted(IAsyncResult result) { try { questionnaire = this.service.EndGetQuestionnaire(ar); } catch (Exception ex) { //  -   . } }</code> <br>  ,     <code>End*</code> (  , <code>EndGetQuestionnaire</code> ),    ,      .      , ,          UI.     ,   ,        . <br> <br>        UI,     -,      UI,         UI,   <code>Dispatcher</code>    <code>SynchronizationContext</code> .  WPF  Silverlight,   <code>Dispatcher</code> . <br> <br>      <code>Questionnaire</code>  ,        <code>QuestionnaireView</code> .  Silverlight    <code>CheckAccess</code> ,  ,      UI.  ,     <code>BeginInvoke</code> ,      UI. <br> <br> <code class="cs">var dispatcher = System.Windows.Deployment.Current.Dispatcher; if (dispatcher.CheckAccess()) { QuestionnaireView.DataContext = questionnaire; } else { dispatcher.BeginInvoke(() =&gt; { Questionnaire.DataContext = questionnaire; }); }</code> <br> <i>MVVM RI</i>   ,    ,   <code>IAsyncResult</code> ,   .      ,                 . ,       . <br> <br> <code class="cs">this.questionnaireRepository.GetQuestionnaireAsync( result =&gt; { this.Questionnaire = result.Result; });</code> <br>  <code>result</code>   ,     , , , .    ,     . <br> <br> <code class="cs">this.questionnaireRepository.GetQuestionnaireAsync( result =&gt; { if (result.Error == null) { this.Questionnaire = result.Result; ... } else { // Handle error. } })</code> <br>     <br>        ,      .     , ,             .        ,      ,     ,     . <br> <br>         ,      MVVM,     ,   . ,  -MVVM ,     <code>MessageBox</code>   code-behind UI,      .   MVVM     ,          . <br> <br>     MVVM,              ,          .      ,    ,   ,  ,     . <br> <br>              MVVM.      ,     ,     ,  ,     .    ,         ,     ,          .       . <br> <br>    <br>                  .        ,        .  ,         .         . <br> <br>  ,         ,         ,  .      ,     .           ,       . ,        WPF  Silverlight,        . <br> <br> <img title="Using the service to interact with the user." src="https://habrastorage.org/getpro/habr/post_images/4b5/397/f2d/4b5397f2d02e5851195b29f1893be6fc.png" alt=" ,    ."> <br> <br>  ,   <code>MessageBox</code>        ,     ,    ,     . <br> <br> <code class="cs">var result = interactionService.ShowMessageBox( "Are you sure you want to cancel this operation?", "Confirm", MessageBoxButton.OK); if (result == MessageBoxResult.Yes) { CancelRequest(); }</code> <br> ,      - ,      ,         Silverlight.         .             .     . <br> <br> <code class="cs">interactionService.ShowMessageBox( "Are you sure you want to cancel this operation?", "Confirm", MessageBoxButton.OK, result =&gt; { if (result == MessageBoxResult.Yes) { CancelRequest(); } });</code> <br>         ,      . ,  WPF    <code>MessageBox</code> ,       ;    Silverlight    ,    . <br> <br>     <br>         ‚Äì             .         ,      .     ,     .        ,        ,   ,     . <br> <br> <img title="Using interaction request objects." src="https://habrastorage.org/getpro/habr/post_images/3d0/ff0/1c5/3d0ff01c5518558c2d3c5c5f47ce0ce9.png" alt="   ."> <br> <br>    ,   ,          ‚Äì       ,      ,   ‚Äì     .   ,        ,    ,    UI            . <br> <br>       MVVM,     ,       ,         .         ,        ,    ,   . <br> <br>  Prism       <code>IInteractionRequest</code>   <code>InteractionRequest .  IInteractionRequest</code>  ,   .           ,   .  <code>InteractionRequest   IInteractionRequest</code>     <code>Raise</code> ,           , , ,   . <br> <br>       <br>  <code>InteractionRequest          .  Raise</code>          ( <code>T</code> )    ,    ,   .          ,       .      ,        .    ,  ,     . <br> <code class="cs">public interface IInteractionRequest { event EventHandler&lt;InteractionRequestedEventArgs&gt; Raised; } public class InteractionRequest&lt;T&gt; : IInteractionRequest { public event EventHandler&lt;InteractionRequestedEventArgs&gt; Raised; public void Raise(T context, Action&lt;T&gt; callback) { var handler = this.Raised; if (handler != null) { handler( this, new InteractionRequestedEventArgs(context, () =&gt; callback(context))); } } }</code> <br> Prism    ,      .  <code>Notification</code>       .    ,            .     ‚Äì <code>Title</code>  <code>Content</code> ,    .  ,   ,  ,  ,        . <br> <br>  <code>Confirmation</code>    <code>Notification</code>     ‚Äì <code>Confirmed</code> ,  ,  ,      .  <code>Confirmation</code> ,     <code>MessageBox</code> ,     /  .     ,     <code>Notification</code> ,     ,      . <br> <br>    <code>InteractionRequest ,       InteractionRequest      ,      .      ,    Raise</code> ,    , ,   . <br> <br> <code class="cs">public IInteractionRequest ConfirmCancelInteractionRequest { get { return this.confirmCancelInteractionRequest; } } this.confirmCancelInteractionRequest.Raise( new Confirmation("Are you sure you wish to cancel?"), confirmation =&gt; { if (confirmation.Confirmed) { this.NavigateToQuestionnaireList(); } }); }</code> <br> <i>MVVM Reference Implementation (MVVM RI)</i> ,    <code>IInteractionRequest</code>   <code>InteractionRequest ,          (. QuestionnaireViewModel.cs</code> ). <br> <br>        <br>       ,       .   ,       .    UI             . <br> <br>                . Microsoft Expression Blend Behaviors Framework     .  ,     ,    . <br> <br>  <code>EventTrigger</code> ,  Expression Blend,  ,      ,     ,   . , Prism   <code>EventTrigger</code> ,  <code>InteractionRequestTrigger</code> ,      <code>Raised</code>   <code>IInteractionRequest</code> .    XAML        . <br> <br>  ,   , <code>InteractionRequestTrigger</code>   .  Silverlight Prism   <code>PopupChildWindowAction</code> ,     .    ,         .   <code>ContentTemplate</code>  <code>PopupChildWindowAction</code> ,    ,    UI,      <code>Content</code>  .       <code>Title</code>  . <br> <b></b> <br>  ,    ,   <code>PopupChildWindowAction</code> ,     .    <code>Notification</code>  <code>NotificationChildWindow</code> ,        <code>Confirmation</code> ‚Äì <code>ConfirmationChildWindow</code> . <code>NotificationChildWindow</code>    ,   ,     <code>ConfirmationChildWindow</code>    <i>OK</i>  <i>Cancel</i> ,    .    ,   ,   <code>ChildWindow</code>  <code>PopupChildWindowAction</code> . <br>   ,  <code>InteractionRequestTrigger</code>  <code>PopupChildWindowAction</code> ,       <i>RI MVVM</i> . <br> <br> <code class="xml">&lt;i:Interaction.Triggers&gt; &lt;prism:InteractionRequestTrigger SourceObject="{Binding ConfirmCancelInteractionRequest}"&gt; &lt;prism:PopupChildWindowAction ContentTemplate="{StaticResource ConfirmWindowTemplate}"/&gt; &lt;/prism:InteractionRequestTrigger&gt; &lt;/i:Interaction.Triggers&gt; &lt;UserControl.Resources&gt; &lt;DataTemplate x:Key="ConfirmWindowTemplate"&gt; &lt;Grid MinWidth="250" MinHeight="100"&gt; &lt;TextBlock TextWrapping="Wrap" Grid.Row="0" Text="{Binding}"/&gt; &lt;/Grid&gt; &lt;/DataTemplate&gt; &lt;/UserControl.Resources&gt;</code> <br> <b></b> <br>      <code>ContentTemplate</code> ,   UI   <code>Content</code>  .    <code>Content</code>  ,  , <code>TextBlock</code>     <code>Content</code> . <br>      ,     ,    ,    .  ,     ,       ,     ,    .   ,   <i>RI MVVM</i> ,         <code>Confirmed</code>    <code>Confirmation</code>  <code>true</code> ,     OK. <br> <br>        ,     .  Prism <code>InteractionRequestTrigger</code>   <code>PopupChildWindowAction</code>            . <br> <br>     <br>     MVVM,       , ,    ,         .        (  , ,  ,   ).    ,  ,  ,            . <br> <br>        ,         . Managed Extensibility Framework (MEF)  Unity Application Block (Unity)      ,  ,           . <br> <br>  ,       , , ,    ( )      . ,       ,     .  ,     ,       . <br> <br>     ,  MEF <br>  MEF,       ,   <code>Import</code> ,      ,  ,   <code>Export</code> .         ,    . <br> <br> , <code>QuestionnaireView</code>   <i>RI MVVM</i> ,        ,    <code>Import</code> .   , MEF           .  <code>set</code>        ,   . <br> <br> <code class="cs">[Import] public QuestionnaireViewModel ViewModel { set { this.DataContext = value; } }</code> <br>     ,   . <br> <br> <code class="cs">[Export] public class QuestionnaireViewModel : NotificationObject { ... }</code> <br>        ,   . <br> <br> <code class="cs">public QuestionnaireView() { InitializeComponent(); } [ImportingConstructor] public QuestionnaireView(QuestionnaireViewModel viewModel) : this() { this.DataContext = viewModel; }</code> <br> <b></b> <br>          MEF,   Unity.   ,     ,        .   ,   Visual Studio  Expression Blend, ,        ,     .   ,   ,  ,      ,          <code>InitializeComponent</code> . <br>     ,  Unity <br>  Unity,    ,   MEF.     ,      .    ,         .  ,      . <br> <br>  ,      ,  ,         . ,           ,   . <br> <br> <code class="cs">public QuestionnaireView() { InitializeComponent(); } public QuestionnaireView(QuestionnaireViewModel viewModel) : this() { this.DataContext = viewModel; }</code> <br> <b></b> <br>    ,        ,   Visual Studio  Expression Blend. <br>  ,          ,   . Unity        <code>set</code>   ,   . <br> <br> <code class="cs">public QuestionnaireView() { InitializeComponent(); } [Dependency] public QuestionnaireViewModel ViewModel { set { this.DataContext = value; } }</code> <br>       Unity. <br> <br> <code class="cs">container.RegisterType&lt;QuestionnaireViewModel&gt;();</code> <br>  ,     . <br> <br> <code class="cs">var view = container.Resolve&lt;QuestionnaireView&gt;();</code> <br>     ,    <br>   ,     ,        .        ,   MEF  Unity,        . <br> <br>          .   ,         UI,           . <br> <br> , <i>RI MVVM</i>   ,   ,        .   ,    .      <code>ShowView</code>   UI. <br> <br> <code class="cs">private void NavigateToQuestionnaireList() { //     "questionnaire list". this.uiService.ShowView(ViewNames.QuestionnaireTemplatesList); }</code> <br>  UI      UI .           UI.  <code>ShowView</code>  <code>UIService</code>      (,          ),       ,   . <br> <br> <code class="cs">public void ShowView(string viewName) { var view = this.ViewFactory.GetView(viewName); this.MainWindow.CurrentView = view; }</code> <br> <b></b> <br> Prism       .   ,   ,   ,             .    ,  , " <a href="http://msdn.microsoft.com/en-us/library/gg430861(v%3DPandP.40).aspx">View-Based Navigation</a> "   8, " <a href="http://msdn.microsoft.com/en-us/library/gg430861(v%3DPandP.40).aspx">Navigation</a> ". <br>  MVVM  <br>        MVVM      .           -      mocking . ,   ,        . <br> <br>   <i>INotifyPropertyChanged</i> <br>   <code>INotifyPropertyChanged</code>     ,      .      ,    ;   ,   ,     ,    ,       . <br> <br>   <br> ,       ,           <code>PropertyChanged</code>  ,         .  ,    <code>ChangeTracker</code> ,     MVVM,  ,      .      .     ,    . <br> <br> <code class="cs">var changeTracker = new PropertyChangeTracker(viewModel); viewModel.CurrentState = "newState"; CollectionAssert.Contains(changeTracker.ChangedProperties, "CurrentState");</code> <br> ,     ,     <code>INotifyPropertyChanged</code> ,    ,   ,     . <br> <br>      <br>        ,   ,    <code>set</code>      ,           . ,     ,     ,      ,          . <br> <br> <code class="cs">var changeTracker = new PropertyChangeTracker(viewModel); var question = viewModel.Questions.First() as OpenQuestionViewModel; question.Question.Response = "some text"; CollectionAssert.Contains(changeTracker.ChangedProperties, "UnansweredQuestions");</code> <br>      <br>     <code>INotifyPropertyChanged</code> ,      <code>PropertyChanged</code>        ,  ,     , , .        ,       . <br> <br>   <i>INotifyDataErrorInfo</i> <br>   ,     ,    ,   ,   <code>IDataErrorInfo</code> ,  ( Silverlight)   <code>INotifyDataErrorInfo</code> .   <code>INotifyDataErrorInfo</code>   ,         ,    ,  ,   ,    . <br> <br>       <code>INotifyDataErrorInfo</code> : ,     ,  ,     ,     <code>ErrorsChanged</code> ,      <code>GetErrors</code> , . <br> <br>    <br>     ,      ,     .       ,         <code>GetErrors</code>       ,  ,  ,   .    , ,  ,     ,        .   ,        . <br> <br> <code class="cs">//  . var notifyErrorInfo = (INotifyDataErrorInfo)question; question.Response = -15; Assert.IsTrue(notifyErrorInfo.GetErrors("Response").Cast&lt;ValidationResult&gt;().Any()); //  . var notifyErrorInfo = (INotifyDataErrorInfo)question; question.Response = 15; Assert.IsFalse(notifyErrorInfo.GetErrors("Response").Cast&lt;ValidationResult&gt;().Any());</code> <br>    ,    ,             . <br> <br>    <i>INotifyDataErrorInfo</i> <br>       <code>GetErrors</code> ,   <code>INotifyDataErrorInfo</code>  ,   <code>ErrorsChanged</code>      <code>GetErrors</code> . ,  <code>HasErrors</code>      ,  . <br> <br>       <code>INotifyDataErrorInfo</code> . , ,           ,   -  .      ,        <code>INotifyDataErrorInfo</code>         (,        ). <br> <br>     ,   ,  : <br>  <code>HasErrors</code>     .              ,       .  <code>ErrorsChanged</code> ,      ,         <code>GetErrors</code> .         ( ,  )     ,           .    <code>GetErrors</code>       <code>ErrorsChanged</code> . <br>    <code>INotifyPropertyChanged</code> ,  ,    <code>NotifyDataErrorInfoTestHelper</code>    MVVM,        <code>INotifyDataErrorInfo</code> ,       .   ,   ,      ,   .      . <br> <code class="cs">var helper = new NotifyDataErrorInfoTestHelper&lt;NumericQuestion, int?&gt;( question, q =&gt; q.Response); helper.ValidatePropertyChange( 6, NotifyDataErrorInfoBehavior.Nothing); helper.ValidatePropertyChange( 20, NotifyDataErrorInfoBehavior.FiresErrorsChanged | NotifyDataErrorInfoBehavior.HasErrors | NotifyDataErrorInfoBehavior.HasErrorsForProperty); helper.ValidatePropertyChange( null, NotifyDataErrorInfoBehavior.FiresErrorsChanged | NotifyDataErrorInfoBehavior.HasErrors | NotifyDataErrorInfoBehavior.HasErrorsForProperty); helper.ValidatePropertyChange( 2, NotifyDataErrorInfoBehavior.FiresErrorsChanged);</code> <br>     <br>   MVVM,     ,  .   ,    ,         . <br> <br>  ,     ,     ,       .   ,   , ,       ,     ,   <code>IAsyncResult</code>    ,  - ,   ,    UI. <br> <br>       , , ,    .   ,     .  ,      UI,     ,   ,          ,     ,        "   UI." <br> <br>     ,    ,    .   ,    ,     mock-, ,   ,   ,      ,          . <br> <br>           UI,    ,    .   ,     ,   ,      .        ,   .     ,    ,     . <br> <br> <code class="cs">questionnaireRepositoryMock .Setup( r =&gt; r.SubmitQuestionnaireAsync( It.IsAny&lt;Questionnaire&gt;(), It.IsAny&lt;Action&lt;IOperationResult&gt;&gt;())) .Callback&lt;Questionnaire, Action&lt;IOperationResult&gt;&gt;( (q, a) =&gt; callback = a); uiServicemock .Setup(svc =&gt; svc.ShowView(ViewNames.QuestionnaireTemplatesList)) .Callback&lt;string&gt;(viewName =&gt; requestedViewName = viewName); submitResultMock .Setup(sr =&gt; sr.Error) .Returns&lt;Exception&gt;(null); CompleteQuestionnaire(viewModel); viewModel.Submit(); //      UI . callback(submitResultMock.Object); //    ‚Äì     . Assert.AreEqual(ViewNames.QuestionnaireTemplatesList, requestedViewName);</code> <br> <b></b> <br>          ,        . <br>   <br>       , . "Trees in WPF"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ms753391.aspx">http://msdn.microsoft.com/en-us/library/ms753391.aspx</a> <br> <br>       , . "Attached Properties Overview"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/cc265152(VS.95).aspx">http://msdn.microsoft.com/en-us/library/cc265152(VS.95).aspx</a> <br> <br>      MEF, ."Managed Extensibility Framework Overview"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/dd460648.aspx">http://msdn.microsoft.com/en-us/library/dd460648.aspx</a> . <br> <br>      Unity, ."Unity Application Block"  MSDN: <a href="http://www.msdn.com/unity">http://www.msdn.com/unity</a> . <br> <br>      <code>DelegateCommand</code> , .Chapter 5, " <a href="http://msdn.microsoft.com/en-us/library/gg405484(v%3DPandP.40).aspx">Implementing the MVVM Pattern</a> ." <br> <br>        Microsoft Expression Blend, ."Working with built-in behaviors"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ff724013(v%3DExpression.40).aspx">http://msdn.microsoft.com/en-us/library/ff724013(v=Expression.40).aspx</a> . <br> <br>          Microsoft Expression Blend, ."Creating Custom Behaviors"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ff724708(v%3DExpression.40).aspx">http://msdn.microsoft.com/en-us/library/ff724708(v=Expression.40).aspx</a> . <br> <br>            Microsoft Expression Blend, ."Creating Custom Triggers and Actions"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ff724707(v%3DExpression.40).aspx">http://msdn.microsoft.com/en-us/library/ff724707(v=Expression.40).aspx</a> . <br> <br>         WPF  Silverlight, ."Threading Model"  "The Dispatcher Class"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ms741870.aspx">http://msdn.microsoft.com/en-us/library/ms741870.aspx</a> <br> <a href="http://msdn.microsoft.com/en-us/library/ms615907(v%3DVS.95).aspx">http://msdn.microsoft.com/en-us/library/ms615907(v=VS.95).aspx</a> . <br> <br>      unit-  Silverlight, ."Unit Testing with Silverlight 2": <a href="http://www.jeff.wilcox.name/2008/03/silverlight2-unit-testing/">http://www.jeff.wilcox.name/2008/03/silverlight2-unit-testing/</a> . <br> <br>         , .  " <a href="http://msdn.microsoft.com/en-us/library/gg430861(v%3DPandP.40).aspx">View-Based Navigation</a> " in Chapter 8, " <a href="http://msdn.microsoft.com/en-us/library/gg430861(v%3DPandP.40).aspx">Navigation</a> ." <br> <br>       ,   , ."Event-based Asynchronous Pattern Overview"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/wewwczdw.aspx">http://msdn.microsoft.com/en-us/library/wewwczdw.aspx</a> <br> <br>        <code>IAsyncResult</code> , ."Asynchronous Programming Overview"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ms228963.aspx">http://msdn.microsoft.com/en-us/library/ms228963.aspx</a></code></code></code></code></code></code></code></code></code> </h5> <code><code><code><code><code><code><code><code><code><code>CommandBehaviorBase ,    ,    ICommand</code> .           <code>CanExecuteChanged</code> ,          Silverlight,    WPF. <br> <br>    ,  ,   <code>CommandBehaviorBase    ,    .         ,      .         ,    .      ButtonBaseClickCommandBehavior</code> . <br> <br> <code class="cs">public class ButtonBaseClickCommandBehavior : CommandBehaviorBase&lt;ButtonBase&gt; { public ButtonBaseClickCommandBehavior(ButtonBase clickableObject) : base(clickableObject) { clickableObject.Click += OnClick; } private void OnClick(object sender, System.Windows.RoutedEventArgs e) { ExecuteCommand(); } }</code> <br>   <code>CommandBehaviorBase ,     .     ,          ,   . ,    ,    ,      , ,    CanExecute</code>  ,     . <br> <br>          ,   .           XAML.           .       .  Prism      ,       ,  ,   .       ,    . , ,  ,      <code>Click</code> ,       <code>Command</code> .    <code>Click.Command</code> ,  . <br> <br>             .             . <br> <br> <code class="cs">public static readonly DependencyProperty CommandProperty = DependencyProperty.RegisterAttached( "Command", typeof(ICommand), typeof(Click), new PropertyMetadata(OnSetCommandCallback)); private static readonly DependencyProperty ClickCommandBehaviorProperty = DependencyProperty.RegisterAttached( "ClickCommandBehavior", typeof(ButtonBaseClickCommandBehavior), typeof(Click), null);</code> <br>    <code>Command</code>    <code>ButtonBaseClickCommandBehavior</code> ,     <code>OnSetCommandCallback</code> ,     . <br> <br> <code class="cs">private static void OnSetCommandCallback(DependencyObject dependencyObject, DependencyPropertyChangedEventArgs e) { ButtonBase buttonBase = dependencyObject as ButtonBase; if (buttonBase != null) { ButtonBaseClickCommandBehavior behavior = GetOrCreateBehavior(buttonBase); behavior.Command = e.NewValue as ICommand; } } private static void OnSetCommandParameterCallback(DependencyObject dependencyObject, DependencyPropertyChangedEventArgs e) { ButtonBase buttonBase = dependencyObject as ButtonBase; if (buttonBase != null) { ButtonBaseClickCommandBehavior behavior = GetOrCreateBehavior(buttonBase); behavior.CommandParameter = e.NewValue; } } private static ButtonBaseClickCommandBehavior GetOrCreateBehavior(ButtonBase buttonBase ) { ButtonBaseClickCommandBehavior behavior = buttonBase.GetValue(ClickCommandBehaviorProperty) as ButtonBaseClickCommandBehavior; if ( behavior == null ) { behavior = new ButtonBaseClickCommandBehavior(buttonBase); buttonBase.SetValue(ClickCommandBehaviorProperty, behavior); } return behavior; }</code> <br>        ,  <a href="http://msdn.microsoft.com/en-us/library/cc265152(VS.95).aspx">Attached Properties Overview</a>  MSDN. <br> <br>    <br>              . ,     Silverlight,    -,     ,      ,     .     ,       . <br> <br>        ,    ( )  ,  ,     .  UI       ,            UI. <br> <br>      - <br>   -     ,       <code>IAsyncResult</code> .   ,  ,   ,  <code>GetQuestionnaire</code> ,   : <code>BeginGetQuestionnaire</code>  <code>EndGetQuestionnaire</code> .    ,   <code>BeginGetQuestionnaire</code> .     ,   ,   <code>EndGetQuestionnaire</code>    . <br> <b></b> <br>  .NET Framework 4.5      <code>await</code>  <code>async</code>     <code>*Async</code> .      <a href="http://msdn.microsoft.com/en-us/library/vstudio/hh391443.aspx">"Asynchronous Programming with Async and Await (C# and Visual Basic)"</a> . <br>  ,    <code>EndGetQuestionnaire</code> ,      ,  ()      <code>BeginGetQuestionnaire</code> .     ,      ,   <code>EndGetQuestionnaire</code> ,   . <br> <br> <code class="xml">IAsyncResult asyncResult = this.service.BeginGetQuestionnaire( GetQuestionnaireCompleted, null //  ,      ); private void GetQuestionnaireCompleted(IAsyncResult result) { try { questionnaire = this.service.EndGetQuestionnaire(ar); } catch (Exception ex) { //  -   . } }</code> <br>  ,     <code>End*</code> (  , <code>EndGetQuestionnaire</code> ),    ,      .      , ,          UI.     ,   ,        . <br> <br>        UI,     -,      UI,         UI,   <code>Dispatcher</code>    <code>SynchronizationContext</code> .  WPF  Silverlight,   <code>Dispatcher</code> . <br> <br>      <code>Questionnaire</code>  ,        <code>QuestionnaireView</code> .  Silverlight    <code>CheckAccess</code> ,  ,      UI.  ,     <code>BeginInvoke</code> ,      UI. <br> <br> <code class="cs">var dispatcher = System.Windows.Deployment.Current.Dispatcher; if (dispatcher.CheckAccess()) { QuestionnaireView.DataContext = questionnaire; } else { dispatcher.BeginInvoke(() =&gt; { Questionnaire.DataContext = questionnaire; }); }</code> <br> <i>MVVM RI</i>   ,    ,   <code>IAsyncResult</code> ,   .      ,                 . ,       . <br> <br> <code class="cs">this.questionnaireRepository.GetQuestionnaireAsync( result =&gt; { this.Questionnaire = result.Result; });</code> <br>  <code>result</code>   ,     , , , .    ,     . <br> <br> <code class="cs">this.questionnaireRepository.GetQuestionnaireAsync( result =&gt; { if (result.Error == null) { this.Questionnaire = result.Result; ... } else { // Handle error. } })</code> <br>     <br>        ,      .     , ,             .        ,      ,     ,     . <br> <br>         ,      MVVM,     ,   . ,  -MVVM ,     <code>MessageBox</code>   code-behind UI,      .   MVVM     ,          . <br> <br>     MVVM,              ,          .      ,    ,   ,  ,     . <br> <br>              MVVM.      ,     ,     ,  ,     .    ,         ,     ,          .       . <br> <br>    <br>                  .        ,        .  ,         .         . <br> <br>  ,         ,         ,  .      ,     .           ,       . ,        WPF  Silverlight,        . <br> <br> <img title="Using the service to interact with the user." src="https://habrastorage.org/getpro/habr/post_images/4b5/397/f2d/4b5397f2d02e5851195b29f1893be6fc.png" alt=" ,    ."> <br> <br>  ,   <code>MessageBox</code>        ,     ,    ,     . <br> <br> <code class="cs">var result = interactionService.ShowMessageBox( "Are you sure you want to cancel this operation?", "Confirm", MessageBoxButton.OK); if (result == MessageBoxResult.Yes) { CancelRequest(); }</code> <br> ,      - ,      ,         Silverlight.         .             .     . <br> <br> <code class="cs">interactionService.ShowMessageBox( "Are you sure you want to cancel this operation?", "Confirm", MessageBoxButton.OK, result =&gt; { if (result == MessageBoxResult.Yes) { CancelRequest(); } });</code> <br>         ,      . ,  WPF    <code>MessageBox</code> ,       ;    Silverlight    ,    . <br> <br>     <br>         ‚Äì             .         ,      .     ,     .        ,        ,   ,     . <br> <br> <img title="Using interaction request objects." src="https://habrastorage.org/getpro/habr/post_images/3d0/ff0/1c5/3d0ff01c5518558c2d3c5c5f47ce0ce9.png" alt="   ."> <br> <br>    ,   ,          ‚Äì       ,      ,   ‚Äì     .   ,        ,    ,    UI            . <br> <br>       MVVM,     ,       ,         .         ,        ,    ,   . <br> <br>  Prism       <code>IInteractionRequest</code>   <code>InteractionRequest .  IInteractionRequest</code>  ,   .           ,   .  <code>InteractionRequest   IInteractionRequest</code>     <code>Raise</code> ,           , , ,   . <br> <br>       <br>  <code>InteractionRequest          .  Raise</code>          ( <code>T</code> )    ,    ,   .          ,       .      ,        .    ,  ,     . <br> <code class="cs">public interface IInteractionRequest { event EventHandler&lt;InteractionRequestedEventArgs&gt; Raised; } public class InteractionRequest&lt;T&gt; : IInteractionRequest { public event EventHandler&lt;InteractionRequestedEventArgs&gt; Raised; public void Raise(T context, Action&lt;T&gt; callback) { var handler = this.Raised; if (handler != null) { handler( this, new InteractionRequestedEventArgs(context, () =&gt; callback(context))); } } }</code> <br> Prism    ,      .  <code>Notification</code>       .    ,            .     ‚Äì <code>Title</code>  <code>Content</code> ,    .  ,   ,  ,  ,        . <br> <br>  <code>Confirmation</code>    <code>Notification</code>     ‚Äì <code>Confirmed</code> ,  ,  ,      .  <code>Confirmation</code> ,     <code>MessageBox</code> ,     /  .     ,     <code>Notification</code> ,     ,      . <br> <br>    <code>InteractionRequest ,       InteractionRequest      ,      .      ,    Raise</code> ,    , ,   . <br> <br> <code class="cs">public IInteractionRequest ConfirmCancelInteractionRequest { get { return this.confirmCancelInteractionRequest; } } this.confirmCancelInteractionRequest.Raise( new Confirmation("Are you sure you wish to cancel?"), confirmation =&gt; { if (confirmation.Confirmed) { this.NavigateToQuestionnaireList(); } }); }</code> <br> <i>MVVM Reference Implementation (MVVM RI)</i> ,    <code>IInteractionRequest</code>   <code>InteractionRequest ,          (. QuestionnaireViewModel.cs</code> ). <br> <br>        <br>       ,       .   ,       .    UI             . <br> <br>                . Microsoft Expression Blend Behaviors Framework     .  ,     ,    . <br> <br>  <code>EventTrigger</code> ,  Expression Blend,  ,      ,     ,   . , Prism   <code>EventTrigger</code> ,  <code>InteractionRequestTrigger</code> ,      <code>Raised</code>   <code>IInteractionRequest</code> .    XAML        . <br> <br>  ,   , <code>InteractionRequestTrigger</code>   .  Silverlight Prism   <code>PopupChildWindowAction</code> ,     .    ,         .   <code>ContentTemplate</code>  <code>PopupChildWindowAction</code> ,    ,    UI,      <code>Content</code>  .       <code>Title</code>  . <br> <b></b> <br>  ,    ,   <code>PopupChildWindowAction</code> ,     .    <code>Notification</code>  <code>NotificationChildWindow</code> ,        <code>Confirmation</code> ‚Äì <code>ConfirmationChildWindow</code> . <code>NotificationChildWindow</code>    ,   ,     <code>ConfirmationChildWindow</code>    <i>OK</i>  <i>Cancel</i> ,    .    ,   ,   <code>ChildWindow</code>  <code>PopupChildWindowAction</code> . <br>   ,  <code>InteractionRequestTrigger</code>  <code>PopupChildWindowAction</code> ,       <i>RI MVVM</i> . <br> <br> <code class="xml">&lt;i:Interaction.Triggers&gt; &lt;prism:InteractionRequestTrigger SourceObject="{Binding ConfirmCancelInteractionRequest}"&gt; &lt;prism:PopupChildWindowAction ContentTemplate="{StaticResource ConfirmWindowTemplate}"/&gt; &lt;/prism:InteractionRequestTrigger&gt; &lt;/i:Interaction.Triggers&gt; &lt;UserControl.Resources&gt; &lt;DataTemplate x:Key="ConfirmWindowTemplate"&gt; &lt;Grid MinWidth="250" MinHeight="100"&gt; &lt;TextBlock TextWrapping="Wrap" Grid.Row="0" Text="{Binding}"/&gt; &lt;/Grid&gt; &lt;/DataTemplate&gt; &lt;/UserControl.Resources&gt;</code> <br> <b></b> <br>      <code>ContentTemplate</code> ,   UI   <code>Content</code>  .    <code>Content</code>  ,  , <code>TextBlock</code>     <code>Content</code> . <br>      ,     ,    ,    .  ,     ,       ,     ,    .   ,   <i>RI MVVM</i> ,         <code>Confirmed</code>    <code>Confirmation</code>  <code>true</code> ,     OK. <br> <br>        ,     .  Prism <code>InteractionRequestTrigger</code>   <code>PopupChildWindowAction</code>            . <br> <br>     <br>     MVVM,       , ,    ,         .        (  , ,  ,   ).    ,  ,  ,            . <br> <br>        ,         . Managed Extensibility Framework (MEF)  Unity Application Block (Unity)      ,  ,           . <br> <br>  ,       , , ,    ( )      . ,       ,     .  ,     ,       . <br> <br>     ,  MEF <br>  MEF,       ,   <code>Import</code> ,      ,  ,   <code>Export</code> .         ,    . <br> <br> , <code>QuestionnaireView</code>   <i>RI MVVM</i> ,        ,    <code>Import</code> .   , MEF           .  <code>set</code>        ,   . <br> <br> <code class="cs">[Import] public QuestionnaireViewModel ViewModel { set { this.DataContext = value; } }</code> <br>     ,   . <br> <br> <code class="cs">[Export] public class QuestionnaireViewModel : NotificationObject { ... }</code> <br>        ,   . <br> <br> <code class="cs">public QuestionnaireView() { InitializeComponent(); } [ImportingConstructor] public QuestionnaireView(QuestionnaireViewModel viewModel) : this() { this.DataContext = viewModel; }</code> <br> <b></b> <br>          MEF,   Unity.   ,     ,        .   ,   Visual Studio  Expression Blend, ,        ,     .   ,   ,  ,      ,          <code>InitializeComponent</code> . <br>     ,  Unity <br>  Unity,    ,   MEF.     ,      .    ,         .  ,      . <br> <br>  ,      ,  ,         . ,           ,   . <br> <br> <code class="cs">public QuestionnaireView() { InitializeComponent(); } public QuestionnaireView(QuestionnaireViewModel viewModel) : this() { this.DataContext = viewModel; }</code> <br> <b></b> <br>    ,        ,   Visual Studio  Expression Blend. <br>  ,          ,   . Unity        <code>set</code>   ,   . <br> <br> <code class="cs">public QuestionnaireView() { InitializeComponent(); } [Dependency] public QuestionnaireViewModel ViewModel { set { this.DataContext = value; } }</code> <br>       Unity. <br> <br> <code class="cs">container.RegisterType&lt;QuestionnaireViewModel&gt;();</code> <br>  ,     . <br> <br> <code class="cs">var view = container.Resolve&lt;QuestionnaireView&gt;();</code> <br>     ,    <br>   ,     ,        .        ,   MEF  Unity,        . <br> <br>          .   ,         UI,           . <br> <br> , <i>RI MVVM</i>   ,   ,        .   ,    .      <code>ShowView</code>   UI. <br> <br> <code class="cs">private void NavigateToQuestionnaireList() { //     "questionnaire list". this.uiService.ShowView(ViewNames.QuestionnaireTemplatesList); }</code> <br>  UI      UI .           UI.  <code>ShowView</code>  <code>UIService</code>      (,          ),       ,   . <br> <br> <code class="cs">public void ShowView(string viewName) { var view = this.ViewFactory.GetView(viewName); this.MainWindow.CurrentView = view; }</code> <br> <b></b> <br> Prism       .   ,   ,   ,             .    ,  , " <a href="http://msdn.microsoft.com/en-us/library/gg430861(v%3DPandP.40).aspx">View-Based Navigation</a> "   8, " <a href="http://msdn.microsoft.com/en-us/library/gg430861(v%3DPandP.40).aspx">Navigation</a> ". <br>  MVVM  <br>        MVVM      .           -      mocking . ,   ,        . <br> <br>   <i>INotifyPropertyChanged</i> <br>   <code>INotifyPropertyChanged</code>     ,      .      ,    ;   ,   ,     ,    ,       . <br> <br>   <br> ,       ,           <code>PropertyChanged</code>  ,         .  ,    <code>ChangeTracker</code> ,     MVVM,  ,      .      .     ,    . <br> <br> <code class="cs">var changeTracker = new PropertyChangeTracker(viewModel); viewModel.CurrentState = "newState"; CollectionAssert.Contains(changeTracker.ChangedProperties, "CurrentState");</code> <br> ,     ,     <code>INotifyPropertyChanged</code> ,    ,   ,     . <br> <br>      <br>        ,   ,    <code>set</code>      ,           . ,     ,     ,      ,          . <br> <br> <code class="cs">var changeTracker = new PropertyChangeTracker(viewModel); var question = viewModel.Questions.First() as OpenQuestionViewModel; question.Question.Response = "some text"; CollectionAssert.Contains(changeTracker.ChangedProperties, "UnansweredQuestions");</code> <br>      <br>     <code>INotifyPropertyChanged</code> ,      <code>PropertyChanged</code>        ,  ,     , , .        ,       . <br> <br>   <i>INotifyDataErrorInfo</i> <br>   ,     ,    ,   ,   <code>IDataErrorInfo</code> ,  ( Silverlight)   <code>INotifyDataErrorInfo</code> .   <code>INotifyDataErrorInfo</code>   ,         ,    ,  ,   ,    . <br> <br>       <code>INotifyDataErrorInfo</code> : ,     ,  ,     ,     <code>ErrorsChanged</code> ,      <code>GetErrors</code> , . <br> <br>    <br>     ,      ,     .       ,         <code>GetErrors</code>       ,  ,  ,   .    , ,  ,     ,        .   ,        . <br> <br> <code class="cs">//  . var notifyErrorInfo = (INotifyDataErrorInfo)question; question.Response = -15; Assert.IsTrue(notifyErrorInfo.GetErrors("Response").Cast&lt;ValidationResult&gt;().Any()); //  . var notifyErrorInfo = (INotifyDataErrorInfo)question; question.Response = 15; Assert.IsFalse(notifyErrorInfo.GetErrors("Response").Cast&lt;ValidationResult&gt;().Any());</code> <br>    ,    ,             . <br> <br>    <i>INotifyDataErrorInfo</i> <br>       <code>GetErrors</code> ,   <code>INotifyDataErrorInfo</code>  ,   <code>ErrorsChanged</code>      <code>GetErrors</code> . ,  <code>HasErrors</code>      ,  . <br> <br>       <code>INotifyDataErrorInfo</code> . , ,           ,   -  .      ,        <code>INotifyDataErrorInfo</code>         (,        ). <br> <br>     ,   ,  : <br>  <code>HasErrors</code>     .              ,       .  <code>ErrorsChanged</code> ,      ,         <code>GetErrors</code> .         ( ,  )     ,           .    <code>GetErrors</code>       <code>ErrorsChanged</code> . <br>    <code>INotifyPropertyChanged</code> ,  ,    <code>NotifyDataErrorInfoTestHelper</code>    MVVM,        <code>INotifyDataErrorInfo</code> ,       .   ,   ,      ,   .      . <br> <code class="cs">var helper = new NotifyDataErrorInfoTestHelper&lt;NumericQuestion, int?&gt;( question, q =&gt; q.Response); helper.ValidatePropertyChange( 6, NotifyDataErrorInfoBehavior.Nothing); helper.ValidatePropertyChange( 20, NotifyDataErrorInfoBehavior.FiresErrorsChanged | NotifyDataErrorInfoBehavior.HasErrors | NotifyDataErrorInfoBehavior.HasErrorsForProperty); helper.ValidatePropertyChange( null, NotifyDataErrorInfoBehavior.FiresErrorsChanged | NotifyDataErrorInfoBehavior.HasErrors | NotifyDataErrorInfoBehavior.HasErrorsForProperty); helper.ValidatePropertyChange( 2, NotifyDataErrorInfoBehavior.FiresErrorsChanged);</code> <br>     <br>   MVVM,     ,  .   ,    ,         . <br> <br>  ,     ,     ,       .   ,   , ,       ,     ,   <code>IAsyncResult</code>    ,  - ,   ,    UI. <br> <br>       , , ,    .   ,     .  ,      UI,     ,   ,          ,     ,        "   UI." <br> <br>     ,    ,    .   ,    ,     mock-, ,   ,   ,      ,          . <br> <br>           UI,    ,    .   ,     ,   ,      .        ,   .     ,    ,     . <br> <br> <code class="cs">questionnaireRepositoryMock .Setup( r =&gt; r.SubmitQuestionnaireAsync( It.IsAny&lt;Questionnaire&gt;(), It.IsAny&lt;Action&lt;IOperationResult&gt;&gt;())) .Callback&lt;Questionnaire, Action&lt;IOperationResult&gt;&gt;( (q, a) =&gt; callback = a); uiServicemock .Setup(svc =&gt; svc.ShowView(ViewNames.QuestionnaireTemplatesList)) .Callback&lt;string&gt;(viewName =&gt; requestedViewName = viewName); submitResultMock .Setup(sr =&gt; sr.Error) .Returns&lt;Exception&gt;(null); CompleteQuestionnaire(viewModel); viewModel.Submit(); //      UI . callback(submitResultMock.Object); //    ‚Äì     . Assert.AreEqual(ViewNames.QuestionnaireTemplatesList, requestedViewName);</code> <br> <b></b> <br>          ,        . <br>   <br>       , . "Trees in WPF"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ms753391.aspx">http://msdn.microsoft.com/en-us/library/ms753391.aspx</a> <br> <br>       , . "Attached Properties Overview"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/cc265152(VS.95).aspx">http://msdn.microsoft.com/en-us/library/cc265152(VS.95).aspx</a> <br> <br>      MEF, ."Managed Extensibility Framework Overview"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/dd460648.aspx">http://msdn.microsoft.com/en-us/library/dd460648.aspx</a> . <br> <br>      Unity, ."Unity Application Block"  MSDN: <a href="http://www.msdn.com/unity">http://www.msdn.com/unity</a> . <br> <br>      <code>DelegateCommand</code> , .Chapter 5, " <a href="http://msdn.microsoft.com/en-us/library/gg405484(v%3DPandP.40).aspx">Implementing the MVVM Pattern</a> ." <br> <br>        Microsoft Expression Blend, ."Working with built-in behaviors"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ff724013(v%3DExpression.40).aspx">http://msdn.microsoft.com/en-us/library/ff724013(v=Expression.40).aspx</a> . <br> <br>          Microsoft Expression Blend, ."Creating Custom Behaviors"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ff724708(v%3DExpression.40).aspx">http://msdn.microsoft.com/en-us/library/ff724708(v=Expression.40).aspx</a> . <br> <br>            Microsoft Expression Blend, ."Creating Custom Triggers and Actions"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ff724707(v%3DExpression.40).aspx">http://msdn.microsoft.com/en-us/library/ff724707(v=Expression.40).aspx</a> . <br> <br>         WPF  Silverlight, ."Threading Model"  "The Dispatcher Class"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ms741870.aspx">http://msdn.microsoft.com/en-us/library/ms741870.aspx</a> <br> <a href="http://msdn.microsoft.com/en-us/library/ms615907(v%3DVS.95).aspx">http://msdn.microsoft.com/en-us/library/ms615907(v=VS.95).aspx</a> . <br> <br>      unit-  Silverlight, ."Unit Testing with Silverlight 2": <a href="http://www.jeff.wilcox.name/2008/03/silverlight2-unit-testing/">http://www.jeff.wilcox.name/2008/03/silverlight2-unit-testing/</a> . <br> <br>         , .  " <a href="http://msdn.microsoft.com/en-us/library/gg430861(v%3DPandP.40).aspx">View-Based Navigation</a> " in Chapter 8, " <a href="http://msdn.microsoft.com/en-us/library/gg430861(v%3DPandP.40).aspx">Navigation</a> ." <br> <br>       ,   , ."Event-based Asynchronous Pattern Overview"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/wewwczdw.aspx">http://msdn.microsoft.com/en-us/library/wewwczdw.aspx</a> <br> <br>        <code>IAsyncResult</code> , ."Asynchronous Programming Overview"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ms228963.aspx">http://msdn.microsoft.com/en-us/library/ms228963.aspx</a></code></code></code></code></code></code></code></code></code> <blockquote> <code><code><code><code><code><code><code><code><code><code>CommandBehaviorBase ,    ,    ICommand</code> .           <code>CanExecuteChanged</code> ,          Silverlight,    WPF. <br> <br>    ,  ,   <code>CommandBehaviorBase    ,    .         ,      .         ,    .      ButtonBaseClickCommandBehavior</code> . <br> <br> <code class="cs">public class ButtonBaseClickCommandBehavior : CommandBehaviorBase&lt;ButtonBase&gt; { public ButtonBaseClickCommandBehavior(ButtonBase clickableObject) : base(clickableObject) { clickableObject.Click += OnClick; } private void OnClick(object sender, System.Windows.RoutedEventArgs e) { ExecuteCommand(); } }</code> <br>   <code>CommandBehaviorBase ,     .     ,          ,   . ,    ,    ,      , ,    CanExecute</code>  ,     . <br> <br>          ,   .           XAML.           .       .  Prism      ,       ,  ,   .       ,    . , ,  ,      <code>Click</code> ,       <code>Command</code> .    <code>Click.Command</code> ,  . <br> <br>             .             . <br> <br> <code class="cs">public static readonly DependencyProperty CommandProperty = DependencyProperty.RegisterAttached( "Command", typeof(ICommand), typeof(Click), new PropertyMetadata(OnSetCommandCallback)); private static readonly DependencyProperty ClickCommandBehaviorProperty = DependencyProperty.RegisterAttached( "ClickCommandBehavior", typeof(ButtonBaseClickCommandBehavior), typeof(Click), null);</code> <br>    <code>Command</code>    <code>ButtonBaseClickCommandBehavior</code> ,     <code>OnSetCommandCallback</code> ,     . <br> <br> <code class="cs">private static void OnSetCommandCallback(DependencyObject dependencyObject, DependencyPropertyChangedEventArgs e) { ButtonBase buttonBase = dependencyObject as ButtonBase; if (buttonBase != null) { ButtonBaseClickCommandBehavior behavior = GetOrCreateBehavior(buttonBase); behavior.Command = e.NewValue as ICommand; } } private static void OnSetCommandParameterCallback(DependencyObject dependencyObject, DependencyPropertyChangedEventArgs e) { ButtonBase buttonBase = dependencyObject as ButtonBase; if (buttonBase != null) { ButtonBaseClickCommandBehavior behavior = GetOrCreateBehavior(buttonBase); behavior.CommandParameter = e.NewValue; } } private static ButtonBaseClickCommandBehavior GetOrCreateBehavior(ButtonBase buttonBase ) { ButtonBaseClickCommandBehavior behavior = buttonBase.GetValue(ClickCommandBehaviorProperty) as ButtonBaseClickCommandBehavior; if ( behavior == null ) { behavior = new ButtonBaseClickCommandBehavior(buttonBase); buttonBase.SetValue(ClickCommandBehaviorProperty, behavior); } return behavior; }</code> <br>        ,  <a href="http://msdn.microsoft.com/en-us/library/cc265152(VS.95).aspx">Attached Properties Overview</a>  MSDN. <br> <br>    <br>              . ,     Silverlight,    -,     ,      ,     .     ,       . <br> <br>        ,    ( )  ,  ,     .  UI       ,            UI. <br> <br>      - <br>   -     ,       <code>IAsyncResult</code> .   ,  ,   ,  <code>GetQuestionnaire</code> ,   : <code>BeginGetQuestionnaire</code>  <code>EndGetQuestionnaire</code> .    ,   <code>BeginGetQuestionnaire</code> .     ,   ,   <code>EndGetQuestionnaire</code>    . <br> <b></b> <br>  .NET Framework 4.5      <code>await</code>  <code>async</code>     <code>*Async</code> .      <a href="http://msdn.microsoft.com/en-us/library/vstudio/hh391443.aspx">"Asynchronous Programming with Async and Await (C# and Visual Basic)"</a> . <br>  ,    <code>EndGetQuestionnaire</code> ,      ,  ()      <code>BeginGetQuestionnaire</code> .     ,      ,   <code>EndGetQuestionnaire</code> ,   . <br> <br> <code class="xml">IAsyncResult asyncResult = this.service.BeginGetQuestionnaire( GetQuestionnaireCompleted, null //  ,      ); private void GetQuestionnaireCompleted(IAsyncResult result) { try { questionnaire = this.service.EndGetQuestionnaire(ar); } catch (Exception ex) { //  -   . } }</code> <br>  ,     <code>End*</code> (  , <code>EndGetQuestionnaire</code> ),    ,      .      , ,          UI.     ,   ,        . <br> <br>        UI,     -,      UI,         UI,   <code>Dispatcher</code>    <code>SynchronizationContext</code> .  WPF  Silverlight,   <code>Dispatcher</code> . <br> <br>      <code>Questionnaire</code>  ,        <code>QuestionnaireView</code> .  Silverlight    <code>CheckAccess</code> ,  ,      UI.  ,     <code>BeginInvoke</code> ,      UI. <br> <br> <code class="cs">var dispatcher = System.Windows.Deployment.Current.Dispatcher; if (dispatcher.CheckAccess()) { QuestionnaireView.DataContext = questionnaire; } else { dispatcher.BeginInvoke(() =&gt; { Questionnaire.DataContext = questionnaire; }); }</code> <br> <i>MVVM RI</i>   ,    ,   <code>IAsyncResult</code> ,   .      ,                 . ,       . <br> <br> <code class="cs">this.questionnaireRepository.GetQuestionnaireAsync( result =&gt; { this.Questionnaire = result.Result; });</code> <br>  <code>result</code>   ,     , , , .    ,     . <br> <br> <code class="cs">this.questionnaireRepository.GetQuestionnaireAsync( result =&gt; { if (result.Error == null) { this.Questionnaire = result.Result; ... } else { // Handle error. } })</code> <br>     <br>        ,      .     , ,             .        ,      ,     ,     . <br> <br>         ,      MVVM,     ,   . ,  -MVVM ,     <code>MessageBox</code>   code-behind UI,      .   MVVM     ,          . <br> <br>     MVVM,              ,          .      ,    ,   ,  ,     . <br> <br>              MVVM.      ,     ,     ,  ,     .    ,         ,     ,          .       . <br> <br>    <br>                  .        ,        .  ,         .         . <br> <br>  ,         ,         ,  .      ,     .           ,       . ,        WPF  Silverlight,        . <br> <br> <img title="Using the service to interact with the user." src="https://habrastorage.org/getpro/habr/post_images/4b5/397/f2d/4b5397f2d02e5851195b29f1893be6fc.png" alt=" ,    ."> <br> <br>  ,   <code>MessageBox</code>        ,     ,    ,     . <br> <br> <code class="cs">var result = interactionService.ShowMessageBox( "Are you sure you want to cancel this operation?", "Confirm", MessageBoxButton.OK); if (result == MessageBoxResult.Yes) { CancelRequest(); }</code> <br> ,      - ,      ,         Silverlight.         .             .     . <br> <br> <code class="cs">interactionService.ShowMessageBox( "Are you sure you want to cancel this operation?", "Confirm", MessageBoxButton.OK, result =&gt; { if (result == MessageBoxResult.Yes) { CancelRequest(); } });</code> <br>         ,      . ,  WPF    <code>MessageBox</code> ,       ;    Silverlight    ,    . <br> <br>     <br>         ‚Äì             .         ,      .     ,     .        ,        ,   ,     . <br> <br> <img title="Using interaction request objects." src="https://habrastorage.org/getpro/habr/post_images/3d0/ff0/1c5/3d0ff01c5518558c2d3c5c5f47ce0ce9.png" alt="   ."> <br> <br>    ,   ,          ‚Äì       ,      ,   ‚Äì     .   ,        ,    ,    UI            . <br> <br>       MVVM,     ,       ,         .         ,        ,    ,   . <br> <br>  Prism       <code>IInteractionRequest</code>   <code>InteractionRequest .  IInteractionRequest</code>  ,   .           ,   .  <code>InteractionRequest   IInteractionRequest</code>     <code>Raise</code> ,           , , ,   . <br> <br>       <br>  <code>InteractionRequest          .  Raise</code>          ( <code>T</code> )    ,    ,   .          ,       .      ,        .    ,  ,     . <br> <code class="cs">public interface IInteractionRequest { event EventHandler&lt;InteractionRequestedEventArgs&gt; Raised; } public class InteractionRequest&lt;T&gt; : IInteractionRequest { public event EventHandler&lt;InteractionRequestedEventArgs&gt; Raised; public void Raise(T context, Action&lt;T&gt; callback) { var handler = this.Raised; if (handler != null) { handler( this, new InteractionRequestedEventArgs(context, () =&gt; callback(context))); } } }</code> <br> Prism    ,      .  <code>Notification</code>       .    ,            .     ‚Äì <code>Title</code>  <code>Content</code> ,    .  ,   ,  ,  ,        . <br> <br>  <code>Confirmation</code>    <code>Notification</code>     ‚Äì <code>Confirmed</code> ,  ,  ,      .  <code>Confirmation</code> ,     <code>MessageBox</code> ,     /  .     ,     <code>Notification</code> ,     ,      . <br> <br>    <code>InteractionRequest ,       InteractionRequest      ,      .      ,    Raise</code> ,    , ,   . <br> <br> <code class="cs">public IInteractionRequest ConfirmCancelInteractionRequest { get { return this.confirmCancelInteractionRequest; } } this.confirmCancelInteractionRequest.Raise( new Confirmation("Are you sure you wish to cancel?"), confirmation =&gt; { if (confirmation.Confirmed) { this.NavigateToQuestionnaireList(); } }); }</code> <br> <i>MVVM Reference Implementation (MVVM RI)</i> ,    <code>IInteractionRequest</code>   <code>InteractionRequest ,          (. QuestionnaireViewModel.cs</code> ). <br> <br>        <br>       ,       .   ,       .    UI             . <br> <br>                . Microsoft Expression Blend Behaviors Framework     .  ,     ,    . <br> <br>  <code>EventTrigger</code> ,  Expression Blend,  ,      ,     ,   . , Prism   <code>EventTrigger</code> ,  <code>InteractionRequestTrigger</code> ,      <code>Raised</code>   <code>IInteractionRequest</code> .    XAML        . <br> <br>  ,   , <code>InteractionRequestTrigger</code>   .  Silverlight Prism   <code>PopupChildWindowAction</code> ,     .    ,         .   <code>ContentTemplate</code>  <code>PopupChildWindowAction</code> ,    ,    UI,      <code>Content</code>  .       <code>Title</code>  . <br> <b></b> <br>  ,    ,   <code>PopupChildWindowAction</code> ,     .    <code>Notification</code>  <code>NotificationChildWindow</code> ,        <code>Confirmation</code> ‚Äì <code>ConfirmationChildWindow</code> . <code>NotificationChildWindow</code>    ,   ,     <code>ConfirmationChildWindow</code>    <i>OK</i>  <i>Cancel</i> ,    .    ,   ,   <code>ChildWindow</code>  <code>PopupChildWindowAction</code> . <br>   ,  <code>InteractionRequestTrigger</code>  <code>PopupChildWindowAction</code> ,       <i>RI MVVM</i> . <br> <br> <code class="xml">&lt;i:Interaction.Triggers&gt; &lt;prism:InteractionRequestTrigger SourceObject="{Binding ConfirmCancelInteractionRequest}"&gt; &lt;prism:PopupChildWindowAction ContentTemplate="{StaticResource ConfirmWindowTemplate}"/&gt; &lt;/prism:InteractionRequestTrigger&gt; &lt;/i:Interaction.Triggers&gt; &lt;UserControl.Resources&gt; &lt;DataTemplate x:Key="ConfirmWindowTemplate"&gt; &lt;Grid MinWidth="250" MinHeight="100"&gt; &lt;TextBlock TextWrapping="Wrap" Grid.Row="0" Text="{Binding}"/&gt; &lt;/Grid&gt; &lt;/DataTemplate&gt; &lt;/UserControl.Resources&gt;</code> <br> <b></b> <br>      <code>ContentTemplate</code> ,   UI   <code>Content</code>  .    <code>Content</code>  ,  , <code>TextBlock</code>     <code>Content</code> . <br>      ,     ,    ,    .  ,     ,       ,     ,    .   ,   <i>RI MVVM</i> ,         <code>Confirmed</code>    <code>Confirmation</code>  <code>true</code> ,     OK. <br> <br>        ,     .  Prism <code>InteractionRequestTrigger</code>   <code>PopupChildWindowAction</code>            . <br> <br>     <br>     MVVM,       , ,    ,         .        (  , ,  ,   ).    ,  ,  ,            . <br> <br>        ,         . Managed Extensibility Framework (MEF)  Unity Application Block (Unity)      ,  ,           . <br> <br>  ,       , , ,    ( )      . ,       ,     .  ,     ,       . <br> <br>     ,  MEF <br>  MEF,       ,   <code>Import</code> ,      ,  ,   <code>Export</code> .         ,    . <br> <br> , <code>QuestionnaireView</code>   <i>RI MVVM</i> ,        ,    <code>Import</code> .   , MEF           .  <code>set</code>        ,   . <br> <br> <code class="cs">[Import] public QuestionnaireViewModel ViewModel { set { this.DataContext = value; } }</code> <br>     ,   . <br> <br> <code class="cs">[Export] public class QuestionnaireViewModel : NotificationObject { ... }</code> <br>        ,   . <br> <br> <code class="cs">public QuestionnaireView() { InitializeComponent(); } [ImportingConstructor] public QuestionnaireView(QuestionnaireViewModel viewModel) : this() { this.DataContext = viewModel; }</code> <br> <b></b> <br>          MEF,   Unity.   ,     ,        .   ,   Visual Studio  Expression Blend, ,        ,     .   ,   ,  ,      ,          <code>InitializeComponent</code> . <br>     ,  Unity <br>  Unity,    ,   MEF.     ,      .    ,         .  ,      . <br> <br>  ,      ,  ,         . ,           ,   . <br> <br> <code class="cs">public QuestionnaireView() { InitializeComponent(); } public QuestionnaireView(QuestionnaireViewModel viewModel) : this() { this.DataContext = viewModel; }</code> <br> <b></b> <br>    ,        ,   Visual Studio  Expression Blend. <br>  ,          ,   . Unity        <code>set</code>   ,   . <br> <br> <code class="cs">public QuestionnaireView() { InitializeComponent(); } [Dependency] public QuestionnaireViewModel ViewModel { set { this.DataContext = value; } }</code> <br>       Unity. <br> <br> <code class="cs">container.RegisterType&lt;QuestionnaireViewModel&gt;();</code> <br>  ,     . <br> <br> <code class="cs">var view = container.Resolve&lt;QuestionnaireView&gt;();</code> <br>     ,    <br>   ,     ,        .        ,   MEF  Unity,        . <br> <br>          .   ,         UI,           . <br> <br> , <i>RI MVVM</i>   ,   ,        .   ,    .      <code>ShowView</code>   UI. <br> <br> <code class="cs">private void NavigateToQuestionnaireList() { //     "questionnaire list". this.uiService.ShowView(ViewNames.QuestionnaireTemplatesList); }</code> <br>  UI      UI .           UI.  <code>ShowView</code>  <code>UIService</code>      (,          ),       ,   . <br> <br> <code class="cs">public void ShowView(string viewName) { var view = this.ViewFactory.GetView(viewName); this.MainWindow.CurrentView = view; }</code> <br> <b></b> <br> Prism       .   ,   ,   ,             .    ,  , " <a href="http://msdn.microsoft.com/en-us/library/gg430861(v%3DPandP.40).aspx">View-Based Navigation</a> "   8, " <a href="http://msdn.microsoft.com/en-us/library/gg430861(v%3DPandP.40).aspx">Navigation</a> ". <br>  MVVM  <br>        MVVM      .           -      mocking . ,   ,        . <br> <br>   <i>INotifyPropertyChanged</i> <br>   <code>INotifyPropertyChanged</code>     ,      .      ,    ;   ,   ,     ,    ,       . <br> <br>   <br> ,       ,           <code>PropertyChanged</code>  ,         .  ,    <code>ChangeTracker</code> ,     MVVM,  ,      .      .     ,    . <br> <br> <code class="cs">var changeTracker = new PropertyChangeTracker(viewModel); viewModel.CurrentState = "newState"; CollectionAssert.Contains(changeTracker.ChangedProperties, "CurrentState");</code> <br> ,     ,     <code>INotifyPropertyChanged</code> ,    ,   ,     . <br> <br>      <br>        ,   ,    <code>set</code>      ,           . ,     ,     ,      ,          . <br> <br> <code class="cs">var changeTracker = new PropertyChangeTracker(viewModel); var question = viewModel.Questions.First() as OpenQuestionViewModel; question.Question.Response = "some text"; CollectionAssert.Contains(changeTracker.ChangedProperties, "UnansweredQuestions");</code> <br>      <br>     <code>INotifyPropertyChanged</code> ,      <code>PropertyChanged</code>        ,  ,     , , .        ,       . <br> <br>   <i>INotifyDataErrorInfo</i> <br>   ,     ,    ,   ,   <code>IDataErrorInfo</code> ,  ( Silverlight)   <code>INotifyDataErrorInfo</code> .   <code>INotifyDataErrorInfo</code>   ,         ,    ,  ,   ,    . <br> <br>       <code>INotifyDataErrorInfo</code> : ,     ,  ,     ,     <code>ErrorsChanged</code> ,      <code>GetErrors</code> , . <br> <br>    <br>     ,      ,     .       ,         <code>GetErrors</code>       ,  ,  ,   .    , ,  ,     ,        .   ,        . <br> <br> <code class="cs">//  . var notifyErrorInfo = (INotifyDataErrorInfo)question; question.Response = -15; Assert.IsTrue(notifyErrorInfo.GetErrors("Response").Cast&lt;ValidationResult&gt;().Any()); //  . var notifyErrorInfo = (INotifyDataErrorInfo)question; question.Response = 15; Assert.IsFalse(notifyErrorInfo.GetErrors("Response").Cast&lt;ValidationResult&gt;().Any());</code> <br>    ,    ,             . <br> <br>    <i>INotifyDataErrorInfo</i> <br>       <code>GetErrors</code> ,   <code>INotifyDataErrorInfo</code>  ,   <code>ErrorsChanged</code>      <code>GetErrors</code> . ,  <code>HasErrors</code>      ,  . <br> <br>       <code>INotifyDataErrorInfo</code> . , ,           ,   -  .      ,        <code>INotifyDataErrorInfo</code>         (,        ). <br> <br>     ,   ,  : <br>  <code>HasErrors</code>     .              ,       .  <code>ErrorsChanged</code> ,      ,         <code>GetErrors</code> .         ( ,  )     ,           .    <code>GetErrors</code>       <code>ErrorsChanged</code> . <br>    <code>INotifyPropertyChanged</code> ,  ,    <code>NotifyDataErrorInfoTestHelper</code>    MVVM,        <code>INotifyDataErrorInfo</code> ,       .   ,   ,      ,   .      . <br> <code class="cs">var helper = new NotifyDataErrorInfoTestHelper&lt;NumericQuestion, int?&gt;( question, q =&gt; q.Response); helper.ValidatePropertyChange( 6, NotifyDataErrorInfoBehavior.Nothing); helper.ValidatePropertyChange( 20, NotifyDataErrorInfoBehavior.FiresErrorsChanged | NotifyDataErrorInfoBehavior.HasErrors | NotifyDataErrorInfoBehavior.HasErrorsForProperty); helper.ValidatePropertyChange( null, NotifyDataErrorInfoBehavior.FiresErrorsChanged | NotifyDataErrorInfoBehavior.HasErrors | NotifyDataErrorInfoBehavior.HasErrorsForProperty); helper.ValidatePropertyChange( 2, NotifyDataErrorInfoBehavior.FiresErrorsChanged);</code> <br>     <br>   MVVM,     ,  .   ,    ,         . <br> <br>  ,     ,     ,       .   ,   , ,       ,     ,   <code>IAsyncResult</code>    ,  - ,   ,    UI. <br> <br>       , , ,    .   ,     .  ,      UI,     ,   ,          ,     ,        "   UI." <br> <br>     ,    ,    .   ,    ,     mock-, ,   ,   ,      ,          . <br> <br>           UI,    ,    .   ,     ,   ,      .        ,   .     ,    ,     . <br> <br> <code class="cs">questionnaireRepositoryMock .Setup( r =&gt; r.SubmitQuestionnaireAsync( It.IsAny&lt;Questionnaire&gt;(), It.IsAny&lt;Action&lt;IOperationResult&gt;&gt;())) .Callback&lt;Questionnaire, Action&lt;IOperationResult&gt;&gt;( (q, a) =&gt; callback = a); uiServicemock .Setup(svc =&gt; svc.ShowView(ViewNames.QuestionnaireTemplatesList)) .Callback&lt;string&gt;(viewName =&gt; requestedViewName = viewName); submitResultMock .Setup(sr =&gt; sr.Error) .Returns&lt;Exception&gt;(null); CompleteQuestionnaire(viewModel); viewModel.Submit(); //      UI . callback(submitResultMock.Object); //    ‚Äì     . Assert.AreEqual(ViewNames.QuestionnaireTemplatesList, requestedViewName);</code> <br> <b></b> <br>          ,        . <br>   <br>       , . "Trees in WPF"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ms753391.aspx">http://msdn.microsoft.com/en-us/library/ms753391.aspx</a> <br> <br>       , . "Attached Properties Overview"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/cc265152(VS.95).aspx">http://msdn.microsoft.com/en-us/library/cc265152(VS.95).aspx</a> <br> <br>      MEF, ."Managed Extensibility Framework Overview"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/dd460648.aspx">http://msdn.microsoft.com/en-us/library/dd460648.aspx</a> . <br> <br>      Unity, ."Unity Application Block"  MSDN: <a href="http://www.msdn.com/unity">http://www.msdn.com/unity</a> . <br> <br>      <code>DelegateCommand</code> , .Chapter 5, " <a href="http://msdn.microsoft.com/en-us/library/gg405484(v%3DPandP.40).aspx">Implementing the MVVM Pattern</a> ." <br> <br>        Microsoft Expression Blend, ."Working with built-in behaviors"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ff724013(v%3DExpression.40).aspx">http://msdn.microsoft.com/en-us/library/ff724013(v=Expression.40).aspx</a> . <br> <br>          Microsoft Expression Blend, ."Creating Custom Behaviors"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ff724708(v%3DExpression.40).aspx">http://msdn.microsoft.com/en-us/library/ff724708(v=Expression.40).aspx</a> . <br> <br>            Microsoft Expression Blend, ."Creating Custom Triggers and Actions"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ff724707(v%3DExpression.40).aspx">http://msdn.microsoft.com/en-us/library/ff724707(v=Expression.40).aspx</a> . <br> <br>         WPF  Silverlight, ."Threading Model"  "The Dispatcher Class"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ms741870.aspx">http://msdn.microsoft.com/en-us/library/ms741870.aspx</a> <br> <a href="http://msdn.microsoft.com/en-us/library/ms615907(v%3DVS.95).aspx">http://msdn.microsoft.com/en-us/library/ms615907(v=VS.95).aspx</a> . <br> <br>      unit-  Silverlight, ."Unit Testing with Silverlight 2": <a href="http://www.jeff.wilcox.name/2008/03/silverlight2-unit-testing/">http://www.jeff.wilcox.name/2008/03/silverlight2-unit-testing/</a> . <br> <br>         , .  " <a href="http://msdn.microsoft.com/en-us/library/gg430861(v%3DPandP.40).aspx">View-Based Navigation</a> " in Chapter 8, " <a href="http://msdn.microsoft.com/en-us/library/gg430861(v%3DPandP.40).aspx">Navigation</a> ." <br> <br>       ,   , ."Event-based Asynchronous Pattern Overview"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/wewwczdw.aspx">http://msdn.microsoft.com/en-us/library/wewwczdw.aspx</a> <br> <br>        <code>IAsyncResult</code> , ."Asynchronous Programming Overview"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ms228963.aspx">http://msdn.microsoft.com/en-us/library/ms228963.aspx</a></code></code></code></code></code></code></code></code></code> </blockquote> <code><code><code><code><code><code><code><code><code><code>CommandBehaviorBase ,    ,    ICommand</code> .           <code>CanExecuteChanged</code> ,          Silverlight,    WPF. <br> <br>    ,  ,   <code>CommandBehaviorBase    ,    .         ,      .         ,    .      ButtonBaseClickCommandBehavior</code> . <br> <br> <code class="cs">public class ButtonBaseClickCommandBehavior : CommandBehaviorBase&lt;ButtonBase&gt; { public ButtonBaseClickCommandBehavior(ButtonBase clickableObject) : base(clickableObject) { clickableObject.Click += OnClick; } private void OnClick(object sender, System.Windows.RoutedEventArgs e) { ExecuteCommand(); } }</code> <br>   <code>CommandBehaviorBase ,     .     ,          ,   . ,    ,    ,      , ,    CanExecute</code>  ,     . <br> <br>          ,   .           XAML.           .       .  Prism      ,       ,  ,   .       ,    . , ,  ,      <code>Click</code> ,       <code>Command</code> .    <code>Click.Command</code> ,  . <br> <br>             .             . <br> <br> <code class="cs">public static readonly DependencyProperty CommandProperty = DependencyProperty.RegisterAttached( "Command", typeof(ICommand), typeof(Click), new PropertyMetadata(OnSetCommandCallback)); private static readonly DependencyProperty ClickCommandBehaviorProperty = DependencyProperty.RegisterAttached( "ClickCommandBehavior", typeof(ButtonBaseClickCommandBehavior), typeof(Click), null);</code> <br>    <code>Command</code>    <code>ButtonBaseClickCommandBehavior</code> ,     <code>OnSetCommandCallback</code> ,     . <br> <br> <code class="cs">private static void OnSetCommandCallback(DependencyObject dependencyObject, DependencyPropertyChangedEventArgs e) { ButtonBase buttonBase = dependencyObject as ButtonBase; if (buttonBase != null) { ButtonBaseClickCommandBehavior behavior = GetOrCreateBehavior(buttonBase); behavior.Command = e.NewValue as ICommand; } } private static void OnSetCommandParameterCallback(DependencyObject dependencyObject, DependencyPropertyChangedEventArgs e) { ButtonBase buttonBase = dependencyObject as ButtonBase; if (buttonBase != null) { ButtonBaseClickCommandBehavior behavior = GetOrCreateBehavior(buttonBase); behavior.CommandParameter = e.NewValue; } } private static ButtonBaseClickCommandBehavior GetOrCreateBehavior(ButtonBase buttonBase ) { ButtonBaseClickCommandBehavior behavior = buttonBase.GetValue(ClickCommandBehaviorProperty) as ButtonBaseClickCommandBehavior; if ( behavior == null ) { behavior = new ButtonBaseClickCommandBehavior(buttonBase); buttonBase.SetValue(ClickCommandBehaviorProperty, behavior); } return behavior; }</code> <br>        ,  <a href="http://msdn.microsoft.com/en-us/library/cc265152(VS.95).aspx">Attached Properties Overview</a>  MSDN. <br> <br>    <br>              . ,     Silverlight,    -,     ,      ,     .     ,       . <br> <br>        ,    ( )  ,  ,     .  UI       ,            UI. <br> <br>      - <br>   -     ,       <code>IAsyncResult</code> .   ,  ,   ,  <code>GetQuestionnaire</code> ,   : <code>BeginGetQuestionnaire</code>  <code>EndGetQuestionnaire</code> .    ,   <code>BeginGetQuestionnaire</code> .     ,   ,   <code>EndGetQuestionnaire</code>    . <br> <b></b> <br>  .NET Framework 4.5      <code>await</code>  <code>async</code>     <code>*Async</code> .      <a href="http://msdn.microsoft.com/en-us/library/vstudio/hh391443.aspx">"Asynchronous Programming with Async and Await (C# and Visual Basic)"</a> . <br>  ,    <code>EndGetQuestionnaire</code> ,      ,  ()      <code>BeginGetQuestionnaire</code> .     ,      ,   <code>EndGetQuestionnaire</code> ,   . <br> <br> <code class="xml">IAsyncResult asyncResult = this.service.BeginGetQuestionnaire( GetQuestionnaireCompleted, null //  ,      ); private void GetQuestionnaireCompleted(IAsyncResult result) { try { questionnaire = this.service.EndGetQuestionnaire(ar); } catch (Exception ex) { //  -   . } }</code> <br>  ,     <code>End*</code> (  , <code>EndGetQuestionnaire</code> ),    ,      .      , ,          UI.     ,   ,        . <br> <br>        UI,     -,      UI,         UI,   <code>Dispatcher</code>    <code>SynchronizationContext</code> .  WPF  Silverlight,   <code>Dispatcher</code> . <br> <br>      <code>Questionnaire</code>  ,        <code>QuestionnaireView</code> .  Silverlight    <code>CheckAccess</code> ,  ,      UI.  ,     <code>BeginInvoke</code> ,      UI. <br> <br> <code class="cs">var dispatcher = System.Windows.Deployment.Current.Dispatcher; if (dispatcher.CheckAccess()) { QuestionnaireView.DataContext = questionnaire; } else { dispatcher.BeginInvoke(() =&gt; { Questionnaire.DataContext = questionnaire; }); }</code> <br> <i>MVVM RI</i>   ,    ,   <code>IAsyncResult</code> ,   .      ,                 . ,       . <br> <br> <code class="cs">this.questionnaireRepository.GetQuestionnaireAsync( result =&gt; { this.Questionnaire = result.Result; });</code> <br>  <code>result</code>   ,     , , , .    ,     . <br> <br> <code class="cs">this.questionnaireRepository.GetQuestionnaireAsync( result =&gt; { if (result.Error == null) { this.Questionnaire = result.Result; ... } else { // Handle error. } })</code> <br>     <br>        ,      .     , ,             .        ,      ,     ,     . <br> <br>         ,      MVVM,     ,   . ,  -MVVM ,     <code>MessageBox</code>   code-behind UI,      .   MVVM     ,          . <br> <br>     MVVM,              ,          .      ,    ,   ,  ,     . <br> <br>              MVVM.      ,     ,     ,  ,     .    ,         ,     ,          .       . <br> <br>    <br>                  .        ,        .  ,         .         . <br> <br>  ,         ,         ,  .      ,     .           ,       . ,        WPF  Silverlight,        . <br> <br> <img title="Using the service to interact with the user." src="https://habrastorage.org/getpro/habr/post_images/4b5/397/f2d/4b5397f2d02e5851195b29f1893be6fc.png" alt=" ,    ."> <br> <br>  ,   <code>MessageBox</code>        ,     ,    ,     . <br> <br> <code class="cs">var result = interactionService.ShowMessageBox( "Are you sure you want to cancel this operation?", "Confirm", MessageBoxButton.OK); if (result == MessageBoxResult.Yes) { CancelRequest(); }</code> <br> ,      - ,      ,         Silverlight.         .             .     . <br> <br> <code class="cs">interactionService.ShowMessageBox( "Are you sure you want to cancel this operation?", "Confirm", MessageBoxButton.OK, result =&gt; { if (result == MessageBoxResult.Yes) { CancelRequest(); } });</code> <br>         ,      . ,  WPF    <code>MessageBox</code> ,       ;    Silverlight    ,    . <br> <br>     <br>         ‚Äì             .         ,      .     ,     .        ,        ,   ,     . <br> <br> <img title="Using interaction request objects." src="https://habrastorage.org/getpro/habr/post_images/3d0/ff0/1c5/3d0ff01c5518558c2d3c5c5f47ce0ce9.png" alt="   ."> <br> <br>    ,   ,          ‚Äì       ,      ,   ‚Äì     .   ,        ,    ,    UI            . <br> <br>       MVVM,     ,       ,         .         ,        ,    ,   . <br> <br>  Prism       <code>IInteractionRequest</code>   <code>InteractionRequest .  IInteractionRequest</code>  ,   .           ,   .  <code>InteractionRequest   IInteractionRequest</code>     <code>Raise</code> ,           , , ,   . <br> <br>       <br>  <code>InteractionRequest          .  Raise</code>          ( <code>T</code> )    ,    ,   .          ,       .      ,        .    ,  ,     . <br> <code class="cs">public interface IInteractionRequest { event EventHandler&lt;InteractionRequestedEventArgs&gt; Raised; } public class InteractionRequest&lt;T&gt; : IInteractionRequest { public event EventHandler&lt;InteractionRequestedEventArgs&gt; Raised; public void Raise(T context, Action&lt;T&gt; callback) { var handler = this.Raised; if (handler != null) { handler( this, new InteractionRequestedEventArgs(context, () =&gt; callback(context))); } } }</code> <br> Prism    ,      .  <code>Notification</code>       .    ,            .     ‚Äì <code>Title</code>  <code>Content</code> ,    .  ,   ,  ,  ,        . <br> <br>  <code>Confirmation</code>    <code>Notification</code>     ‚Äì <code>Confirmed</code> ,  ,  ,      .  <code>Confirmation</code> ,     <code>MessageBox</code> ,     /  .     ,     <code>Notification</code> ,     ,      . <br> <br>    <code>InteractionRequest ,       InteractionRequest      ,      .      ,    Raise</code> ,    , ,   . <br> <br> <code class="cs">public IInteractionRequest ConfirmCancelInteractionRequest { get { return this.confirmCancelInteractionRequest; } } this.confirmCancelInteractionRequest.Raise( new Confirmation("Are you sure you wish to cancel?"), confirmation =&gt; { if (confirmation.Confirmed) { this.NavigateToQuestionnaireList(); } }); }</code> <br> <i>MVVM Reference Implementation (MVVM RI)</i> ,    <code>IInteractionRequest</code>   <code>InteractionRequest ,          (. QuestionnaireViewModel.cs</code> ). <br> <br>        <br>       ,       .   ,       .    UI             . <br> <br>                . Microsoft Expression Blend Behaviors Framework     .  ,     ,    . <br> <br>  <code>EventTrigger</code> ,  Expression Blend,  ,      ,     ,   . , Prism   <code>EventTrigger</code> ,  <code>InteractionRequestTrigger</code> ,      <code>Raised</code>   <code>IInteractionRequest</code> .    XAML        . <br> <br>  ,   , <code>InteractionRequestTrigger</code>   .  Silverlight Prism   <code>PopupChildWindowAction</code> ,     .    ,         .   <code>ContentTemplate</code>  <code>PopupChildWindowAction</code> ,    ,    UI,      <code>Content</code>  .       <code>Title</code>  . <br> <b></b> <br>  ,    ,   <code>PopupChildWindowAction</code> ,     .    <code>Notification</code>  <code>NotificationChildWindow</code> ,        <code>Confirmation</code> ‚Äì <code>ConfirmationChildWindow</code> . <code>NotificationChildWindow</code>    ,   ,     <code>ConfirmationChildWindow</code>    <i>OK</i>  <i>Cancel</i> ,    .    ,   ,   <code>ChildWindow</code>  <code>PopupChildWindowAction</code> . <br>   ,  <code>InteractionRequestTrigger</code>  <code>PopupChildWindowAction</code> ,       <i>RI MVVM</i> . <br> <br> <code class="xml">&lt;i:Interaction.Triggers&gt; &lt;prism:InteractionRequestTrigger SourceObject="{Binding ConfirmCancelInteractionRequest}"&gt; &lt;prism:PopupChildWindowAction ContentTemplate="{StaticResource ConfirmWindowTemplate}"/&gt; &lt;/prism:InteractionRequestTrigger&gt; &lt;/i:Interaction.Triggers&gt; &lt;UserControl.Resources&gt; &lt;DataTemplate x:Key="ConfirmWindowTemplate"&gt; &lt;Grid MinWidth="250" MinHeight="100"&gt; &lt;TextBlock TextWrapping="Wrap" Grid.Row="0" Text="{Binding}"/&gt; &lt;/Grid&gt; &lt;/DataTemplate&gt; &lt;/UserControl.Resources&gt;</code> <br> <b></b> <br>      <code>ContentTemplate</code> ,   UI   <code>Content</code>  .    <code>Content</code>  ,  , <code>TextBlock</code>     <code>Content</code> . <br>      ,     ,    ,    .  ,     ,       ,     ,    .   ,   <i>RI MVVM</i> ,         <code>Confirmed</code>    <code>Confirmation</code>  <code>true</code> ,     OK. <br> <br>        ,     .  Prism <code>InteractionRequestTrigger</code>   <code>PopupChildWindowAction</code>            . <br> <br>     <br>     MVVM,       , ,    ,         .        (  , ,  ,   ).    ,  ,  ,            . <br> <br>        ,         . Managed Extensibility Framework (MEF)  Unity Application Block (Unity)      ,  ,           . <br> <br>  ,       , , ,    ( )      . ,       ,     .  ,     ,       . <br> <br>     ,  MEF <br>  MEF,       ,   <code>Import</code> ,      ,  ,   <code>Export</code> .         ,    . <br> <br> , <code>QuestionnaireView</code>   <i>RI MVVM</i> ,        ,    <code>Import</code> .   , MEF           .  <code>set</code>        ,   . <br> <br> <code class="cs">[Import] public QuestionnaireViewModel ViewModel { set { this.DataContext = value; } }</code> <br>     ,   . <br> <br> <code class="cs">[Export] public class QuestionnaireViewModel : NotificationObject { ... }</code> <br>        ,   . <br> <br> <code class="cs">public QuestionnaireView() { InitializeComponent(); } [ImportingConstructor] public QuestionnaireView(QuestionnaireViewModel viewModel) : this() { this.DataContext = viewModel; }</code> <br> <b></b> <br>          MEF,   Unity.   ,     ,        .   ,   Visual Studio  Expression Blend, ,        ,     .   ,   ,  ,      ,          <code>InitializeComponent</code> . <br>     ,  Unity <br>  Unity,    ,   MEF.     ,      .    ,         .  ,      . <br> <br>  ,      ,  ,         . ,           ,   . <br> <br> <code class="cs">public QuestionnaireView() { InitializeComponent(); } public QuestionnaireView(QuestionnaireViewModel viewModel) : this() { this.DataContext = viewModel; }</code> <br> <b></b> <br>    ,        ,   Visual Studio  Expression Blend. <br>  ,          ,   . Unity        <code>set</code>   ,   . <br> <br> <code class="cs">public QuestionnaireView() { InitializeComponent(); } [Dependency] public QuestionnaireViewModel ViewModel { set { this.DataContext = value; } }</code> <br>       Unity. <br> <br> <code class="cs">container.RegisterType&lt;QuestionnaireViewModel&gt;();</code> <br>  ,     . <br> <br> <code class="cs">var view = container.Resolve&lt;QuestionnaireView&gt;();</code> <br>     ,    <br>   ,     ,        .        ,   MEF  Unity,        . <br> <br>          .   ,         UI,           . <br> <br> , <i>RI MVVM</i>   ,   ,        .   ,    .      <code>ShowView</code>   UI. <br> <br> <code class="cs">private void NavigateToQuestionnaireList() { //     "questionnaire list". this.uiService.ShowView(ViewNames.QuestionnaireTemplatesList); }</code> <br>  UI      UI .           UI.  <code>ShowView</code>  <code>UIService</code>      (,          ),       ,   . <br> <br> <code class="cs">public void ShowView(string viewName) { var view = this.ViewFactory.GetView(viewName); this.MainWindow.CurrentView = view; }</code> <br> <b></b> <br> Prism       .   ,   ,   ,             .    ,  , " <a href="http://msdn.microsoft.com/en-us/library/gg430861(v%3DPandP.40).aspx">View-Based Navigation</a> "   8, " <a href="http://msdn.microsoft.com/en-us/library/gg430861(v%3DPandP.40).aspx">Navigation</a> ". <br>  MVVM  <br>        MVVM      .           -      mocking . ,   ,        . <br> <br>   <i>INotifyPropertyChanged</i> <br>   <code>INotifyPropertyChanged</code>     ,      .      ,    ;   ,   ,     ,    ,       . <br> <br>   <br> ,       ,           <code>PropertyChanged</code>  ,         .  ,    <code>ChangeTracker</code> ,     MVVM,  ,      .      .     ,    . <br> <br> <code class="cs">var changeTracker = new PropertyChangeTracker(viewModel); viewModel.CurrentState = "newState"; CollectionAssert.Contains(changeTracker.ChangedProperties, "CurrentState");</code> <br> ,     ,     <code>INotifyPropertyChanged</code> ,    ,   ,     . <br> <br>      <br>        ,   ,    <code>set</code>      ,           . ,     ,     ,      ,          . <br> <br> <code class="cs">var changeTracker = new PropertyChangeTracker(viewModel); var question = viewModel.Questions.First() as OpenQuestionViewModel; question.Question.Response = "some text"; CollectionAssert.Contains(changeTracker.ChangedProperties, "UnansweredQuestions");</code> <br>      <br>     <code>INotifyPropertyChanged</code> ,      <code>PropertyChanged</code>        ,  ,     , , .        ,       . <br> <br>   <i>INotifyDataErrorInfo</i> <br>   ,     ,    ,   ,   <code>IDataErrorInfo</code> ,  ( Silverlight)   <code>INotifyDataErrorInfo</code> .   <code>INotifyDataErrorInfo</code>   ,         ,    ,  ,   ,    . <br> <br>       <code>INotifyDataErrorInfo</code> : ,     ,  ,     ,     <code>ErrorsChanged</code> ,      <code>GetErrors</code> , . <br> <br>    <br>     ,      ,     .       ,         <code>GetErrors</code>       ,  ,  ,   .    , ,  ,     ,        .   ,        . <br> <br> <code class="cs">//  . var notifyErrorInfo = (INotifyDataErrorInfo)question; question.Response = -15; Assert.IsTrue(notifyErrorInfo.GetErrors("Response").Cast&lt;ValidationResult&gt;().Any()); //  . var notifyErrorInfo = (INotifyDataErrorInfo)question; question.Response = 15; Assert.IsFalse(notifyErrorInfo.GetErrors("Response").Cast&lt;ValidationResult&gt;().Any());</code> <br>    ,    ,             . <br> <br>    <i>INotifyDataErrorInfo</i> <br>       <code>GetErrors</code> ,   <code>INotifyDataErrorInfo</code>  ,   <code>ErrorsChanged</code>      <code>GetErrors</code> . ,  <code>HasErrors</code>      ,  . <br> <br>       <code>INotifyDataErrorInfo</code> . , ,           ,   -  .      ,        <code>INotifyDataErrorInfo</code>         (,        ). <br> <br>     ,   ,  : <br>  <code>HasErrors</code>     .              ,       .  <code>ErrorsChanged</code> ,      ,         <code>GetErrors</code> .         ( ,  )     ,           .    <code>GetErrors</code>       <code>ErrorsChanged</code> . <br>    <code>INotifyPropertyChanged</code> ,  ,    <code>NotifyDataErrorInfoTestHelper</code>    MVVM,        <code>INotifyDataErrorInfo</code> ,       .   ,   ,      ,   .      . <br> <code class="cs">var helper = new NotifyDataErrorInfoTestHelper&lt;NumericQuestion, int?&gt;( question, q =&gt; q.Response); helper.ValidatePropertyChange( 6, NotifyDataErrorInfoBehavior.Nothing); helper.ValidatePropertyChange( 20, NotifyDataErrorInfoBehavior.FiresErrorsChanged | NotifyDataErrorInfoBehavior.HasErrors | NotifyDataErrorInfoBehavior.HasErrorsForProperty); helper.ValidatePropertyChange( null, NotifyDataErrorInfoBehavior.FiresErrorsChanged | NotifyDataErrorInfoBehavior.HasErrors | NotifyDataErrorInfoBehavior.HasErrorsForProperty); helper.ValidatePropertyChange( 2, NotifyDataErrorInfoBehavior.FiresErrorsChanged);</code> <br>     <br>   MVVM,     ,  .   ,    ,         . <br> <br>  ,     ,     ,       .   ,   , ,       ,     ,   <code>IAsyncResult</code>    ,  - ,   ,    UI. <br> <br>       , , ,    .   ,     .  ,      UI,     ,   ,          ,     ,        "   UI." <br> <br>     ,    ,    .   ,    ,     mock-, ,   ,   ,      ,          . <br> <br>           UI,    ,    .   ,     ,   ,      .        ,   .     ,    ,     . <br> <br> <code class="cs">questionnaireRepositoryMock .Setup( r =&gt; r.SubmitQuestionnaireAsync( It.IsAny&lt;Questionnaire&gt;(), It.IsAny&lt;Action&lt;IOperationResult&gt;&gt;())) .Callback&lt;Questionnaire, Action&lt;IOperationResult&gt;&gt;( (q, a) =&gt; callback = a); uiServicemock .Setup(svc =&gt; svc.ShowView(ViewNames.QuestionnaireTemplatesList)) .Callback&lt;string&gt;(viewName =&gt; requestedViewName = viewName); submitResultMock .Setup(sr =&gt; sr.Error) .Returns&lt;Exception&gt;(null); CompleteQuestionnaire(viewModel); viewModel.Submit(); //      UI . callback(submitResultMock.Object); //    ‚Äì     . Assert.AreEqual(ViewNames.QuestionnaireTemplatesList, requestedViewName);</code> <br> <b></b> <br>          ,        . <br>   <br>       , . "Trees in WPF"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ms753391.aspx">http://msdn.microsoft.com/en-us/library/ms753391.aspx</a> <br> <br>       , . "Attached Properties Overview"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/cc265152(VS.95).aspx">http://msdn.microsoft.com/en-us/library/cc265152(VS.95).aspx</a> <br> <br>      MEF, ."Managed Extensibility Framework Overview"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/dd460648.aspx">http://msdn.microsoft.com/en-us/library/dd460648.aspx</a> . <br> <br>      Unity, ."Unity Application Block"  MSDN: <a href="http://www.msdn.com/unity">http://www.msdn.com/unity</a> . <br> <br>      <code>DelegateCommand</code> , .Chapter 5, " <a href="http://msdn.microsoft.com/en-us/library/gg405484(v%3DPandP.40).aspx">Implementing the MVVM Pattern</a> ." <br> <br>        Microsoft Expression Blend, ."Working with built-in behaviors"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ff724013(v%3DExpression.40).aspx">http://msdn.microsoft.com/en-us/library/ff724013(v=Expression.40).aspx</a> . <br> <br>          Microsoft Expression Blend, ."Creating Custom Behaviors"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ff724708(v%3DExpression.40).aspx">http://msdn.microsoft.com/en-us/library/ff724708(v=Expression.40).aspx</a> . <br> <br>            Microsoft Expression Blend, ."Creating Custom Triggers and Actions"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ff724707(v%3DExpression.40).aspx">http://msdn.microsoft.com/en-us/library/ff724707(v=Expression.40).aspx</a> . <br> <br>         WPF  Silverlight, ."Threading Model"  "The Dispatcher Class"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ms741870.aspx">http://msdn.microsoft.com/en-us/library/ms741870.aspx</a> <br> <a href="http://msdn.microsoft.com/en-us/library/ms615907(v%3DVS.95).aspx">http://msdn.microsoft.com/en-us/library/ms615907(v=VS.95).aspx</a> . <br> <br>      unit-  Silverlight, ."Unit Testing with Silverlight 2": <a href="http://www.jeff.wilcox.name/2008/03/silverlight2-unit-testing/">http://www.jeff.wilcox.name/2008/03/silverlight2-unit-testing/</a> . <br> <br>         , .  " <a href="http://msdn.microsoft.com/en-us/library/gg430861(v%3DPandP.40).aspx">View-Based Navigation</a> " in Chapter 8, " <a href="http://msdn.microsoft.com/en-us/library/gg430861(v%3DPandP.40).aspx">Navigation</a> ." <br> <br>       ,   , ."Event-based Asynchronous Pattern Overview"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/wewwczdw.aspx">http://msdn.microsoft.com/en-us/library/wewwczdw.aspx</a> <br> <br>        <code>IAsyncResult</code> , ."Asynchronous Programming Overview"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ms228963.aspx">http://msdn.microsoft.com/en-us/library/ms228963.aspx</a></code></code></code></code></code></code></code></code></code> <pre> <code class="hljs cmake"><code>CommandBehaviorBase ,    ,    ICommand</code> .           <code>CanExecuteChanged</code> ,          Silverlight,    WPF. <br> <br>    ,  ,   <code><code>CommandBehaviorBase    ,    .         ,      .         ,    .      ButtonBaseClickCommandBehavior</code> . <br> <br> <code class="cs">public class ButtonBaseClickCommandBehavior : CommandBehaviorBase&lt;ButtonBase&gt; { public ButtonBaseClickCommandBehavior(ButtonBase clickableObject) : base(clickableObject) { clickableObject.Click += OnClick; } private void OnClick(object sender, System.Windows.RoutedEventArgs e) { ExecuteCommand(); } }</code> <br>   <code><code>CommandBehaviorBase ,     .     ,          ,   . ,    ,    ,      , ,    CanExecute</code>  ,     . <br> <br>          ,   .           XAML.           .       .  Prism      ,       ,  ,   .       ,    . , ,  ,      <code>Click</code> ,       <code><span class="hljs-keyword"><span class="hljs-keyword">Command</span></span></code> .    <code>Click.<span class="hljs-keyword"><span class="hljs-keyword">Command</span></span></code> ,  . <br> <br>             .             . <br> <br> <code class="cs">public static readonly DependencyProperty CommandProperty = DependencyProperty.RegisterAttached( <span class="hljs-string"><span class="hljs-string">"Command"</span></span>, typeof(ICommand), typeof(Click), new PropertyMetadata(OnSetCommandCallback)); private static readonly DependencyProperty ClickCommandBehaviorProperty = DependencyProperty.RegisterAttached( <span class="hljs-string"><span class="hljs-string">"ClickCommandBehavior"</span></span>, typeof(ButtonBaseClickCommandBehavior), typeof(Click), null);</code> <br>    <code><span class="hljs-keyword"><span class="hljs-keyword">Command</span></span></code>    <code>ButtonBaseClickCommandBehavior</code> ,     <code>OnSetCommandCallback</code> ,     . <br> <br> <code class="cs">private static void OnSetCommandCallback(DependencyObject dependencyObject, DependencyPropertyChangedEventArgs e) { ButtonBase buttonBase = dependencyObject as ButtonBase; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (buttonBase != null) { ButtonBaseClickCommandBehavior behavior = GetOrCreateBehavior(buttonBase); behavior.<span class="hljs-keyword"><span class="hljs-keyword">Command</span></span> = e.NewValue as ICommand; } } private static void OnSetCommandParameterCallback(DependencyObject dependencyObject, DependencyPropertyChangedEventArgs e) { ButtonBase buttonBase = dependencyObject as ButtonBase; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (buttonBase != null) { ButtonBaseClickCommandBehavior behavior = GetOrCreateBehavior(buttonBase); behavior.CommandParameter = e.NewValue; } } private static ButtonBaseClickCommandBehavior GetOrCreateBehavior(ButtonBase buttonBase ) { ButtonBaseClickCommandBehavior behavior = buttonBase.GetValue(ClickCommandBehaviorProperty) as ButtonBaseClickCommandBehavior; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ( behavior == null ) { behavior = new ButtonBaseClickCommandBehavior(buttonBase); buttonBase.SetValue(ClickCommandBehaviorProperty, behavior); } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> behavior; }</code> <br>        ,  <a href="http://msdn.microsoft.com/en-us/library/cc265152(VS.95).aspx">Attached Properties Overview</a>  MSDN. <br> <br>    <br>              . ,     Silverlight,    -,     ,      ,     .     ,       . <br> <br>        ,    ( )  ,  ,     .  UI       ,            UI. <br> <br>      - <br>   -     ,       <code>IAsyncResult</code> .   ,  ,   ,  <code>GetQuestionnaire</code> ,   : <code>BeginGetQuestionnaire</code>  <code>EndGetQuestionnaire</code> .    ,   <code>BeginGetQuestionnaire</code> .     ,   ,   <code>EndGetQuestionnaire</code>    . <br> <b></b> <br>  .NET Framework <span class="hljs-number"><span class="hljs-number">4.5</span></span>      <code>await</code>  <code>async</code>     <code>*Async</code> .      <a href="http://msdn.microsoft.com/en-us/library/vstudio/hh391443.aspx"><span class="hljs-string"><span class="hljs-string">"Asynchronous Programming with Async and Await (C# and Visual Basic)"</span></span></a> . <br>  ,    <code>EndGetQuestionnaire</code> ,      ,  ()      <code>BeginGetQuestionnaire</code> .     ,      ,   <code>EndGetQuestionnaire</code> ,   . <br> <br> <code class="xml">IAsyncResult asyncResult = this.service.BeginGetQuestionnaire( GetQuestionnaireCompleted, null //  ,      ); private void GetQuestionnaireCompleted(IAsyncResult result) { try { questionnaire = this.service.EndGetQuestionnaire(ar); } catch (Exception ex) { //  -   . } }</code> <br>  ,     <code>End*</code> (  , <code>EndGetQuestionnaire</code> ),    ,      .      , ,          UI.     ,   ,        . <br> <br>        UI,     -,      UI,         UI,   <code>Dispatcher</code>    <code>SynchronizationContext</code> .  WPF  Silverlight,   <code>Dispatcher</code> . <br> <br>      <code>Questionnaire</code>  ,        <code>QuestionnaireView</code> .  Silverlight    <code>CheckAccess</code> ,  ,      UI.  ,     <code>BeginInvoke</code> ,      UI. <br> <br> <code class="cs">var dispatcher = System.Windows.Deployment.Current.Dispatcher; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (dispatcher.CheckAccess()) { QuestionnaireView.DataContext = questionnaire; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { dispatcher.BeginInvoke(() =&gt; { Questionnaire.DataContext = questionnaire; }); }</code> <br> <i>MVVM RI</i>   ,    ,   <code>IAsyncResult</code> ,   .      ,                 . ,       . <br> <br> <code class="cs">this.questionnaireRepository.GetQuestionnaireAsync( result =&gt; { this.Questionnaire = result.Result; });</code> <br>  <code>result</code>   ,     , , , .    ,     . <br> <br> <code class="cs">this.questionnaireRepository.GetQuestionnaireAsync( result =&gt; { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (result.Error == null) { this.Questionnaire = result.Result; ... } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { // Handle error. } })</code> <br>     <br>        ,      .     , ,             .        ,      ,     ,     . <br> <br>         ,      MVVM,     ,   . ,  -MVVM ,     <code>MessageBox</code>   code-behind UI,      .   MVVM     ,          . <br> <br>     MVVM,              ,          .      ,    ,   ,  ,     . <br> <br>              MVVM.      ,     ,     ,  ,     .    ,         ,     ,          .       . <br> <br>    <br>                  .        ,        .  ,         .         . <br> <br>  ,         ,         ,  .      ,     .           ,       . ,        WPF  Silverlight,        . <br> <br> <img title="Using the service to interact with the user." src="https://habrastorage.org/getpro/habr/post_images/4b5/397/f2d/4b5397f2d02e5851195b29f1893be6fc.png" alt=" ,    ."> <br> <br>  ,   <code>MessageBox</code>        ,     ,    ,     . <br> <br> <code class="cs">var result = interactionService.ShowMessageBox( <span class="hljs-string"><span class="hljs-string">"Are you sure you want to cancel this operation?"</span></span>, <span class="hljs-string"><span class="hljs-string">"Confirm"</span></span>, MessageBoxButton.OK); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (result == MessageBoxResult.Yes) { CancelRequest(); }</code> <br> ,      - ,      ,         Silverlight.         .             .     . <br> <br> <code class="cs">interactionService.ShowMessageBox( <span class="hljs-string"><span class="hljs-string">"Are you sure you want to cancel this operation?"</span></span>, <span class="hljs-string"><span class="hljs-string">"Confirm"</span></span>, MessageBoxButton.OK, result =&gt; { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (result == MessageBoxResult.Yes) { CancelRequest(); } });</code> <br>         ,      . ,  WPF    <code>MessageBox</code> ,       ;    Silverlight    ,    . <br> <br>     <br>         ‚Äì             .         ,      .     ,     .        ,        ,   ,     . <br> <br> <img title="Using interaction request objects." src="https://habrastorage.org/getpro/habr/post_images/3d0/ff0/1c5/3d0ff01c5518558c2d3c5c5f47ce0ce9.png" alt="   ."> <br> <br>    ,   ,          ‚Äì       ,      ,   ‚Äì     .   ,        ,    ,    UI            . <br> <br>       MVVM,     ,       ,         .         ,        ,    ,   . <br> <br>  Prism       <code>IInteractionRequest</code>   <code><code>InteractionRequest .  IInteractionRequest</code>  ,   .           ,   .  <code><code>InteractionRequest   IInteractionRequest</code>     <code>Raise</code> ,           , , ,   . <br> <br>       <br>  <code><code>InteractionRequest          .  Raise</code>          ( <code>T</code> )    ,    ,   .          ,       .      ,        .    ,  ,     . <br> <code class="cs">public interface IInteractionRequest { event EventHandler&lt;InteractionRequestedEventArgs&gt; Raised; } public class InteractionRequest&lt;T&gt; : IInteractionRequest { public event EventHandler&lt;InteractionRequestedEventArgs&gt; Raised; public void Raise(T context, Action&lt;T&gt; callback) { var handler = this.Raised; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (handler != null) { handler( this, new InteractionRequestedEventArgs(context, () =&gt; callback(context))); } } }</code> <br> Prism    ,      .  <code>Notification</code>       .    ,            .     ‚Äì <code>Title</code>  <code>Content</code> ,    .  ,   ,  ,  ,        . <br> <br>  <code>Confirmation</code>    <code>Notification</code>     ‚Äì <code>Confirmed</code> ,  ,  ,      .  <code>Confirmation</code> ,     <code>MessageBox</code> ,     /  .     ,     <code>Notification</code> ,     ,      . <br> <br>    <code><code><code>InteractionRequest ,       InteractionRequest      ,      .      ,    Raise</code> ,    , ,   . <br> <br> <code class="cs">public IInteractionRequest ConfirmCancelInteractionRequest { get { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> this.confirmCancelInteractionRequest; } } this.confirmCancelInteractionRequest.Raise( new Confirmation(<span class="hljs-string"><span class="hljs-string">"Are you sure you wish to cancel?"</span></span>), confirmation =&gt; { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (confirmation.Confirmed) { this.NavigateToQuestionnaireList(); } }); }</code> <br> <i>MVVM Reference Implementation (MVVM RI)</i> ,    <code>IInteractionRequest</code>   <code><code>InteractionRequest ,          (. QuestionnaireViewModel.cs</code> ). <br> <br>        <br>       ,       .   ,       .    UI             . <br> <br>                . Microsoft Expression Blend Behaviors Framework     .  ,     ,    . <br> <br>  <code>EventTrigger</code> ,  Expression Blend,  ,      ,     ,   . , Prism   <code>EventTrigger</code> ,  <code>InteractionRequestTrigger</code> ,      <code>Raised</code>   <code>IInteractionRequest</code> .    XAML        . <br> <br>  ,   , <code>InteractionRequestTrigger</code>   .  Silverlight Prism   <code>PopupChildWindowAction</code> ,     .    ,         .   <code>ContentTemplate</code>  <code>PopupChildWindowAction</code> ,    ,    UI,      <code>Content</code>  .       <code>Title</code>  . <br> <b></b> <br>  ,    ,   <code>PopupChildWindowAction</code> ,     .    <code>Notification</code>  <code>NotificationChildWindow</code> ,        <code>Confirmation</code> ‚Äì <code>ConfirmationChildWindow</code> . <code>NotificationChildWindow</code>    ,   ,     <code>ConfirmationChildWindow</code>    <i>OK</i>  <i>Cancel</i> ,    .    ,   ,   <code>ChildWindow</code>  <code>PopupChildWindowAction</code> . <br>   ,  <code>InteractionRequestTrigger</code>  <code>PopupChildWindowAction</code> ,       <i>RI MVVM</i> . <br> <br> <code class="xml">&lt;i:Interaction.Triggers&gt; &lt;prism:InteractionRequestTrigger SourceObject=<span class="hljs-string"><span class="hljs-string">"{Binding ConfirmCancelInteractionRequest}"</span></span>&gt; &lt;prism:PopupChildWindowAction ContentTemplate=<span class="hljs-string"><span class="hljs-string">"{StaticResource ConfirmWindowTemplate}"</span></span>/&gt; &lt;/prism:InteractionRequestTrigger&gt; &lt;/i:Interaction.Triggers&gt; &lt;UserControl.Resources&gt; &lt;DataTemplate x:Key=<span class="hljs-string"><span class="hljs-string">"ConfirmWindowTemplate"</span></span>&gt; &lt;Grid MinWidth=<span class="hljs-string"><span class="hljs-string">"250"</span></span> MinHeight=<span class="hljs-string"><span class="hljs-string">"100"</span></span>&gt; &lt;TextBlock TextWrapping=<span class="hljs-string"><span class="hljs-string">"Wrap"</span></span> Grid.Row=<span class="hljs-string"><span class="hljs-string">"0"</span></span> Text=<span class="hljs-string"><span class="hljs-string">"{Binding}"</span></span>/&gt; &lt;/Grid&gt; &lt;/DataTemplate&gt; &lt;/UserControl.Resources&gt;</code> <br> <b></b> <br>      <code>ContentTemplate</code> ,   UI   <code>Content</code>  .    <code>Content</code>  ,  , <code>TextBlock</code>     <code>Content</code> . <br>      ,     ,    ,    .  ,     ,       ,     ,    .   ,   <i>RI MVVM</i> ,         <code>Confirmed</code>    <code>Confirmation</code>  <code><span class="hljs-keyword"><span class="hljs-keyword">true</span></span></code> ,     OK. <br> <br>        ,     .  Prism <code>InteractionRequestTrigger</code>   <code>PopupChildWindowAction</code>            . <br> <br>     <br>     MVVM,       , ,    ,         .        (  , ,  ,   ).    ,  ,  ,            . <br> <br>        ,         . Managed Extensibility Framework (MEF)  Unity Application Block (Unity)      ,  ,           . <br> <br>  ,       , , ,    ( )      . ,       ,     .  ,     ,       . <br> <br>     ,  MEF <br>  MEF,       ,   <code>Import</code> ,      ,  ,   <code><span class="hljs-keyword"><span class="hljs-keyword">Export</span></span></code> .         ,    . <br> <br> , <code>QuestionnaireView</code>   <i>RI MVVM</i> ,        ,    <code>Import</code> .   , MEF           .  <code><span class="hljs-keyword"><span class="hljs-keyword">set</span></span></code>        ,   . <br> <br> <code class="cs">[Import] public QuestionnaireViewModel ViewModel { <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> { this.DataContext = value; } }</code> <br>     ,   . <br> <br> <code class="cs">[<span class="hljs-keyword"><span class="hljs-keyword">Export</span></span>] public class QuestionnaireViewModel : NotificationObject { ... }</code> <br>        ,   . <br> <br> <code class="cs">public QuestionnaireView() { InitializeComponent(); } [ImportingConstructor] public QuestionnaireView(QuestionnaireViewModel viewModel) : this() { this.DataContext = viewModel; }</code> <br> <b></b> <br>          MEF,   Unity.   ,     ,        .   ,   Visual Studio  Expression Blend, ,        ,     .   ,   ,  ,      ,          <code>InitializeComponent</code> . <br>     ,  Unity <br>  Unity,    ,   MEF.     ,      .    ,         .  ,      . <br> <br>  ,      ,  ,         . ,           ,   . <br> <br> <code class="cs">public QuestionnaireView() { InitializeComponent(); } public QuestionnaireView(QuestionnaireViewModel viewModel) : this() { this.DataContext = viewModel; }</code> <br> <b></b> <br>    ,        ,   Visual Studio  Expression Blend. <br>  ,          ,   . Unity        <code><span class="hljs-keyword"><span class="hljs-keyword">set</span></span></code>   ,   . <br> <br> <code class="cs">public QuestionnaireView() { InitializeComponent(); } [Dependency] public QuestionnaireViewModel ViewModel { <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> { this.DataContext = value; } }</code> <br>       Unity. <br> <br> <code class="cs">container.RegisterType&lt;QuestionnaireViewModel&gt;();</code> <br>  ,     . <br> <br> <code class="cs">var view = container.Resolve&lt;QuestionnaireView&gt;();</code> <br>     ,    <br>   ,     ,        .        ,   MEF  Unity,        . <br> <br>          .   ,         UI,           . <br> <br> , <i>RI MVVM</i>   ,   ,        .   ,    .      <code>ShowView</code>   UI. <br> <br> <code class="cs">private void NavigateToQuestionnaireList() { //     <span class="hljs-string"><span class="hljs-string">"questionnaire list"</span></span>. this.uiService.ShowView(ViewNames.QuestionnaireTemplatesList); }</code> <br>  UI      UI .           UI.  <code>ShowView</code>  <code>UIService</code>      (,          ),       ,   . <br> <br> <code class="cs">public void ShowView(<span class="hljs-keyword"><span class="hljs-keyword">string</span></span> viewName) { var view = this.ViewFactory.GetView(viewName); this.MainWindow.CurrentView = view; }</code> <br> <b></b> <br> Prism       .   ,   ,   ,             .    ,  , <span class="hljs-string"><span class="hljs-string">" </span></span><a href="http://msdn.microsoft.com/en-us/library/gg430861(v%3DPandP.40).aspx"><span class="hljs-string"><span class="hljs-string">View-Based Navigation</span></span></a><span class="hljs-string"><span class="hljs-string"> "</span></span>   <span class="hljs-number"><span class="hljs-number">8</span></span>, <span class="hljs-string"><span class="hljs-string">" </span></span><a href="http://msdn.microsoft.com/en-us/library/gg430861(v%3DPandP.40).aspx"><span class="hljs-string"><span class="hljs-string">Navigation</span></span></a><span class="hljs-string"><span class="hljs-string"> "</span></span>. <br>  MVVM  <br>        MVVM      .           -      mocking . ,   ,        . <br> <br>   <i>INotifyPropertyChanged</i> <br>   <code>INotifyPropertyChanged</code>     ,      .      ,    ;   ,   ,     ,    ,       . <br> <br>   <br> ,       ,           <code>PropertyChanged</code>  ,         .  ,    <code>ChangeTracker</code> ,     MVVM,  ,      .      .     ,    . <br> <br> <code class="cs">var changeTracker = new PropertyChangeTracker(viewModel); viewModel.CurrentState = <span class="hljs-string"><span class="hljs-string">"newState"</span></span>; CollectionAssert.Contains(changeTracker.ChangedProperties, <span class="hljs-string"><span class="hljs-string">"CurrentState"</span></span>);</code> <br> ,     ,     <code>INotifyPropertyChanged</code> ,    ,   ,     . <br> <br>      <br>        ,   ,    <code><span class="hljs-keyword"><span class="hljs-keyword">set</span></span></code>      ,           . ,     ,     ,      ,          . <br> <br> <code class="cs">var changeTracker = new PropertyChangeTracker(viewModel); var question = viewModel.Questions.First() as OpenQuestionViewModel; question.Question.Response = <span class="hljs-string"><span class="hljs-string">"some text"</span></span>; CollectionAssert.Contains(changeTracker.ChangedProperties, <span class="hljs-string"><span class="hljs-string">"UnansweredQuestions"</span></span>);</code> <br>      <br>     <code>INotifyPropertyChanged</code> ,      <code>PropertyChanged</code>        ,  ,     , , .        ,       . <br> <br>   <i>INotifyDataErrorInfo</i> <br>   ,     ,    ,   ,   <code>IDataErrorInfo</code> ,  ( Silverlight)   <code>INotifyDataErrorInfo</code> .   <code>INotifyDataErrorInfo</code>   ,         ,    ,  ,   ,    . <br> <br>       <code>INotifyDataErrorInfo</code> : ,     ,  ,     ,     <code>ErrorsChanged</code> ,      <code>GetErrors</code> , . <br> <br>    <br>     ,      ,     .       ,         <code>GetErrors</code>       ,  ,  ,   .    , ,  ,     ,        .   ,        . <br> <br> <code class="cs">//  . var notifyErrorInfo = (INotifyDataErrorInfo)question; question.Response = -<span class="hljs-number"><span class="hljs-number">15</span></span>; Assert.IsTrue(notifyErrorInfo.GetErrors(<span class="hljs-string"><span class="hljs-string">"Response"</span></span>).Cast&lt;ValidationResult&gt;().Any()); //  . var notifyErrorInfo = (INotifyDataErrorInfo)question; question.Response = <span class="hljs-number"><span class="hljs-number">15</span></span>; Assert.IsFalse(notifyErrorInfo.GetErrors(<span class="hljs-string"><span class="hljs-string">"Response"</span></span>).Cast&lt;ValidationResult&gt;().Any());</code> <br>    ,    ,             . <br> <br>    <i>INotifyDataErrorInfo</i> <br>       <code>GetErrors</code> ,   <code>INotifyDataErrorInfo</code>  ,   <code>ErrorsChanged</code>      <code>GetErrors</code> . ,  <code>HasErrors</code>      ,  . <br> <br>       <code>INotifyDataErrorInfo</code> . , ,           ,   -  .      ,        <code>INotifyDataErrorInfo</code>         (,        ). <br> <br>     ,   ,  : <br>  <code>HasErrors</code>     .              ,       .  <code>ErrorsChanged</code> ,      ,         <code>GetErrors</code> .         ( ,  )     ,           .    <code>GetErrors</code>       <code>ErrorsChanged</code> . <br>    <code>INotifyPropertyChanged</code> ,  ,    <code>NotifyDataErrorInfoTestHelper</code>    MVVM,        <code>INotifyDataErrorInfo</code> ,       .   ,   ,      ,   .      . <br> <code class="cs">var helper = new NotifyDataErrorInfoTestHelper&lt;NumericQuestion, int?&gt;( question, q =&gt; q.Response); helper.ValidatePropertyChange( <span class="hljs-number"><span class="hljs-number">6</span></span>, NotifyDataErrorInfoBehavior.Nothing); helper.ValidatePropertyChange( <span class="hljs-number"><span class="hljs-number">20</span></span>, NotifyDataErrorInfoBehavior.FiresErrorsChanged | NotifyDataErrorInfoBehavior.HasErrors | NotifyDataErrorInfoBehavior.HasErrorsForProperty); helper.ValidatePropertyChange( null, NotifyDataErrorInfoBehavior.FiresErrorsChanged | NotifyDataErrorInfoBehavior.HasErrors | NotifyDataErrorInfoBehavior.HasErrorsForProperty); helper.ValidatePropertyChange( <span class="hljs-number"><span class="hljs-number">2</span></span>, NotifyDataErrorInfoBehavior.FiresErrorsChanged);</code> <br>     <br>   MVVM,     ,  .   ,    ,         . <br> <br>  ,     ,     ,       .   ,   , ,       ,     ,   <code>IAsyncResult</code>    ,  - ,   ,    UI. <br> <br>       , , ,    .   ,     .  ,      UI,     ,   ,          ,     ,        <span class="hljs-string"><span class="hljs-string">"   UI."</span></span> <br> <br>     ,    ,    .   ,    ,     mock-, ,   ,   ,      ,          . <br> <br>           UI,    ,    .   ,     ,   ,      .        ,   .     ,    ,     . <br> <br> <code class="cs">questionnaireRepositoryMock .Setup( r =&gt; r.SubmitQuestionnaireAsync( It.IsAny&lt;Questionnaire&gt;(), It.IsAny&lt;Action&lt;IOperationResult&gt;&gt;())) .Callback&lt;Questionnaire, Action&lt;IOperationResult&gt;&gt;( (q, a) =&gt; callback = a); uiServicemock .Setup(svc =&gt; svc.ShowView(ViewNames.QuestionnaireTemplatesList)) .Callback&lt;<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>&gt;(viewName =&gt; requestedViewName = viewName); submitResultMock .Setup(sr =&gt; sr.Error) .Returns&lt;Exception&gt;(null); CompleteQuestionnaire(viewModel); viewModel.Submit(); //      UI . callback(submitResultMock.Object); //    ‚Äì     . Assert.AreEqual(ViewNames.QuestionnaireTemplatesList, requestedViewName);</code> <br> <b></b> <br>          ,        . <br>   <br>       , . <span class="hljs-string"><span class="hljs-string">"Trees in WPF"</span></span>  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ms753391.aspx">http://msdn.microsoft.com/en-us/library/ms753391.aspx</a> <br> <br>       , . <span class="hljs-string"><span class="hljs-string">"Attached Properties Overview"</span></span>  MSDN: <a href="http://msdn.microsoft.com/en-us/library/cc265152(VS.95).aspx">http://msdn.microsoft.com/en-us/library/cc265152(VS.<span class="hljs-number"><span class="hljs-number">95</span></span>).aspx</a> <br> <br>      MEF, .<span class="hljs-string"><span class="hljs-string">"Managed Extensibility Framework Overview"</span></span>  MSDN: <a href="http://msdn.microsoft.com/en-us/library/dd460648.aspx">http://msdn.microsoft.com/en-us/library/dd460648.aspx</a> . <br> <br>      Unity, .<span class="hljs-string"><span class="hljs-string">"Unity Application Block"</span></span>  MSDN: <a href="http://www.msdn.com/unity">http://www.msdn.com/unity</a> . <br> <br>      <code>DelegateCommand</code> , .Chapter <span class="hljs-number"><span class="hljs-number">5</span></span>, <span class="hljs-string"><span class="hljs-string">" </span></span><a href="http://msdn.microsoft.com/en-us/library/gg405484(v%3DPandP.40).aspx"><span class="hljs-string"><span class="hljs-string">Implementing the MVVM Pattern</span></span></a><span class="hljs-string"><span class="hljs-string"> ."</span></span> <br> <br>        Microsoft Expression Blend, .<span class="hljs-string"><span class="hljs-string">"Working with built-in behaviors"</span></span>  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ff724013(v%3DExpression.40).aspx">http://msdn.microsoft.com/en-us/library/ff724013(v=Expression.<span class="hljs-number"><span class="hljs-number">40</span></span>).aspx</a> . <br> <br>          Microsoft Expression Blend, .<span class="hljs-string"><span class="hljs-string">"Creating Custom Behaviors"</span></span>  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ff724708(v%3DExpression.40).aspx">http://msdn.microsoft.com/en-us/library/ff724708(v=Expression.<span class="hljs-number"><span class="hljs-number">40</span></span>).aspx</a> . <br> <br>            Microsoft Expression Blend, .<span class="hljs-string"><span class="hljs-string">"Creating Custom Triggers and Actions"</span></span>  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ff724707(v%3DExpression.40).aspx">http://msdn.microsoft.com/en-us/library/ff724707(v=Expression.<span class="hljs-number"><span class="hljs-number">40</span></span>).aspx</a> . <br> <br>         WPF  Silverlight, .<span class="hljs-string"><span class="hljs-string">"Threading Model"</span></span>  <span class="hljs-string"><span class="hljs-string">"The Dispatcher Class"</span></span>  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ms741870.aspx">http://msdn.microsoft.com/en-us/library/ms741870.aspx</a> <br> <a href="http://msdn.microsoft.com/en-us/library/ms615907(v%3DVS.95).aspx">http://msdn.microsoft.com/en-us/library/ms615907(v=VS.<span class="hljs-number"><span class="hljs-number">95</span></span>).aspx</a> . <br> <br>      unit-  Silverlight, .<span class="hljs-string"><span class="hljs-string">"Unit Testing with Silverlight 2"</span></span>: <a href="http://www.jeff.wilcox.name/2008/03/silverlight2-unit-testing/">http://www.jeff.wilcox.name/<span class="hljs-number"><span class="hljs-number">2008</span></span>/<span class="hljs-number"><span class="hljs-number">03</span></span>/silverlight2-unit-testing/</a> . <br> <br>         , .  <span class="hljs-string"><span class="hljs-string">" </span></span><a href="http://msdn.microsoft.com/en-us/library/gg430861(v%3DPandP.40).aspx"><span class="hljs-string"><span class="hljs-string">View-Based Navigation</span></span></a><span class="hljs-string"><span class="hljs-string"> "</span></span> in Chapter <span class="hljs-number"><span class="hljs-number">8</span></span>, <span class="hljs-string"><span class="hljs-string">" </span></span><a href="http://msdn.microsoft.com/en-us/library/gg430861(v%3DPandP.40).aspx"><span class="hljs-string"><span class="hljs-string">Navigation</span></span></a><span class="hljs-string"><span class="hljs-string"> ."</span></span> <br> <br>       ,   , .<span class="hljs-string"><span class="hljs-string">"Event-based Asynchronous Pattern Overview"</span></span>  MSDN: <a href="http://msdn.microsoft.com/en-us/library/wewwczdw.aspx">http://msdn.microsoft.com/en-us/library/wewwczdw.aspx</a> <br> <br>        <code>IAsyncResult</code> , .<span class="hljs-string"><span class="hljs-string">"Asynchronous Programming Overview"</span></span>  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ms228963.aspx">http://msdn.microsoft.com/en-us/library/ms228963.aspx</a></code></code></code></code></code></code></code></code></code> </pre> <code><code><code><code><code><code><code><code><code><code>CommandBehaviorBase ,    ,    ICommand</code> .           <code>CanExecuteChanged</code> ,          Silverlight,    WPF. <br> <br>    ,  ,   <code>CommandBehaviorBase    ,    .         ,      .         ,    .      ButtonBaseClickCommandBehavior</code> . <br> <br> <code class="cs">public class ButtonBaseClickCommandBehavior : CommandBehaviorBase&lt;ButtonBase&gt; { public ButtonBaseClickCommandBehavior(ButtonBase clickableObject) : base(clickableObject) { clickableObject.Click += OnClick; } private void OnClick(object sender, System.Windows.RoutedEventArgs e) { ExecuteCommand(); } }</code> <br>   <code>CommandBehaviorBase ,     .     ,          ,   . ,    ,    ,      , ,    CanExecute</code>  ,     . <br> <br>          ,   .           XAML.           .       .  Prism      ,       ,  ,   .       ,    . , ,  ,      <code>Click</code> ,       <code>Command</code> .    <code>Click.Command</code> ,  . <br> <br>             .             . <br> <br> <code class="cs">public static readonly DependencyProperty CommandProperty = DependencyProperty.RegisterAttached( "Command", typeof(ICommand), typeof(Click), new PropertyMetadata(OnSetCommandCallback)); private static readonly DependencyProperty ClickCommandBehaviorProperty = DependencyProperty.RegisterAttached( "ClickCommandBehavior", typeof(ButtonBaseClickCommandBehavior), typeof(Click), null);</code> <br>    <code>Command</code>    <code>ButtonBaseClickCommandBehavior</code> ,     <code>OnSetCommandCallback</code> ,     . <br> <br> <code class="cs">private static void OnSetCommandCallback(DependencyObject dependencyObject, DependencyPropertyChangedEventArgs e) { ButtonBase buttonBase = dependencyObject as ButtonBase; if (buttonBase != null) { ButtonBaseClickCommandBehavior behavior = GetOrCreateBehavior(buttonBase); behavior.Command = e.NewValue as ICommand; } } private static void OnSetCommandParameterCallback(DependencyObject dependencyObject, DependencyPropertyChangedEventArgs e) { ButtonBase buttonBase = dependencyObject as ButtonBase; if (buttonBase != null) { ButtonBaseClickCommandBehavior behavior = GetOrCreateBehavior(buttonBase); behavior.CommandParameter = e.NewValue; } } private static ButtonBaseClickCommandBehavior GetOrCreateBehavior(ButtonBase buttonBase ) { ButtonBaseClickCommandBehavior behavior = buttonBase.GetValue(ClickCommandBehaviorProperty) as ButtonBaseClickCommandBehavior; if ( behavior == null ) { behavior = new ButtonBaseClickCommandBehavior(buttonBase); buttonBase.SetValue(ClickCommandBehaviorProperty, behavior); } return behavior; }</code> <br>        ,  <a href="http://msdn.microsoft.com/en-us/library/cc265152(VS.95).aspx">Attached Properties Overview</a>  MSDN. <br> <br>    <br>              . ,     Silverlight,    -,     ,      ,     .     ,       . <br> <br>        ,    ( )  ,  ,     .  UI       ,            UI. <br> <br>      - <br>   -     ,       <code>IAsyncResult</code> .   ,  ,   ,  <code>GetQuestionnaire</code> ,   : <code>BeginGetQuestionnaire</code>  <code>EndGetQuestionnaire</code> .    ,   <code>BeginGetQuestionnaire</code> .     ,   ,   <code>EndGetQuestionnaire</code>    . <br> <b></b> <br>  .NET Framework 4.5      <code>await</code>  <code>async</code>     <code>*Async</code> .      <a href="http://msdn.microsoft.com/en-us/library/vstudio/hh391443.aspx">"Asynchronous Programming with Async and Await (C# and Visual Basic)"</a> . <br>  ,    <code>EndGetQuestionnaire</code> ,      ,  ()      <code>BeginGetQuestionnaire</code> .     ,      ,   <code>EndGetQuestionnaire</code> ,   . <br> <br> <code class="xml">IAsyncResult asyncResult = this.service.BeginGetQuestionnaire( GetQuestionnaireCompleted, null //  ,      ); private void GetQuestionnaireCompleted(IAsyncResult result) { try { questionnaire = this.service.EndGetQuestionnaire(ar); } catch (Exception ex) { //  -   . } }</code> <br>  ,     <code>End*</code> (  , <code>EndGetQuestionnaire</code> ),    ,      .      , ,          UI.     ,   ,        . <br> <br>        UI,     -,      UI,         UI,   <code>Dispatcher</code>    <code>SynchronizationContext</code> .  WPF  Silverlight,   <code>Dispatcher</code> . <br> <br>      <code>Questionnaire</code>  ,        <code>QuestionnaireView</code> .  Silverlight    <code>CheckAccess</code> ,  ,      UI.  ,     <code>BeginInvoke</code> ,      UI. <br> <br> <code class="cs">var dispatcher = System.Windows.Deployment.Current.Dispatcher; if (dispatcher.CheckAccess()) { QuestionnaireView.DataContext = questionnaire; } else { dispatcher.BeginInvoke(() =&gt; { Questionnaire.DataContext = questionnaire; }); }</code> <br> <i>MVVM RI</i>   ,    ,   <code>IAsyncResult</code> ,   .      ,                 . ,       . <br> <br> <code class="cs">this.questionnaireRepository.GetQuestionnaireAsync( result =&gt; { this.Questionnaire = result.Result; });</code> <br>  <code>result</code>   ,     , , , .    ,     . <br> <br> <code class="cs">this.questionnaireRepository.GetQuestionnaireAsync( result =&gt; { if (result.Error == null) { this.Questionnaire = result.Result; ... } else { // Handle error. } })</code> <br>     <br>        ,      .     , ,             .        ,      ,     ,     . <br> <br>         ,      MVVM,     ,   . ,  -MVVM ,     <code>MessageBox</code>   code-behind UI,      .   MVVM     ,          . <br> <br>     MVVM,              ,          .      ,    ,   ,  ,     . <br> <br>              MVVM.      ,     ,     ,  ,     .    ,         ,     ,          .       . <br> <br>    <br>                  .        ,        .  ,         .         . <br> <br>  ,         ,         ,  .      ,     .           ,       . ,        WPF  Silverlight,        . <br> <br> <img title="Using the service to interact with the user." src="https://habrastorage.org/getpro/habr/post_images/4b5/397/f2d/4b5397f2d02e5851195b29f1893be6fc.png" alt=" ,    ."> <br> <br>  ,   <code>MessageBox</code>        ,     ,    ,     . <br> <br> <code class="cs">var result = interactionService.ShowMessageBox( "Are you sure you want to cancel this operation?", "Confirm", MessageBoxButton.OK); if (result == MessageBoxResult.Yes) { CancelRequest(); }</code> <br> ,      - ,      ,         Silverlight.         .             .     . <br> <br> <code class="cs">interactionService.ShowMessageBox( "Are you sure you want to cancel this operation?", "Confirm", MessageBoxButton.OK, result =&gt; { if (result == MessageBoxResult.Yes) { CancelRequest(); } });</code> <br>         ,      . ,  WPF    <code>MessageBox</code> ,       ;    Silverlight    ,    . <br> <br>     <br>         ‚Äì             .         ,      .     ,     .        ,        ,   ,     . <br> <br> <img title="Using interaction request objects." src="https://habrastorage.org/getpro/habr/post_images/3d0/ff0/1c5/3d0ff01c5518558c2d3c5c5f47ce0ce9.png" alt="   ."> <br> <br>    ,   ,          ‚Äì       ,      ,   ‚Äì     .   ,        ,    ,    UI            . <br> <br>       MVVM,     ,       ,         .         ,        ,    ,   . <br> <br>  Prism       <code>IInteractionRequest</code>   <code>InteractionRequest .  IInteractionRequest</code>  ,   .           ,   .  <code>InteractionRequest   IInteractionRequest</code>     <code>Raise</code> ,           , , ,   . <br> <br>       <br>  <code>InteractionRequest          .  Raise</code>          ( <code>T</code> )    ,    ,   .          ,       .      ,        .    ,  ,     . <br> <code class="cs">public interface IInteractionRequest { event EventHandler&lt;InteractionRequestedEventArgs&gt; Raised; } public class InteractionRequest&lt;T&gt; : IInteractionRequest { public event EventHandler&lt;InteractionRequestedEventArgs&gt; Raised; public void Raise(T context, Action&lt;T&gt; callback) { var handler = this.Raised; if (handler != null) { handler( this, new InteractionRequestedEventArgs(context, () =&gt; callback(context))); } } }</code> <br> Prism    ,      .  <code>Notification</code>       .    ,            .     ‚Äì <code>Title</code>  <code>Content</code> ,    .  ,   ,  ,  ,        . <br> <br>  <code>Confirmation</code>    <code>Notification</code>     ‚Äì <code>Confirmed</code> ,  ,  ,      .  <code>Confirmation</code> ,     <code>MessageBox</code> ,     /  .     ,     <code>Notification</code> ,     ,      . <br> <br>    <code>InteractionRequest ,       InteractionRequest      ,      .      ,    Raise</code> ,    , ,   . <br> <br> <code class="cs">public IInteractionRequest ConfirmCancelInteractionRequest { get { return this.confirmCancelInteractionRequest; } } this.confirmCancelInteractionRequest.Raise( new Confirmation("Are you sure you wish to cancel?"), confirmation =&gt; { if (confirmation.Confirmed) { this.NavigateToQuestionnaireList(); } }); }</code> <br> <i>MVVM Reference Implementation (MVVM RI)</i> ,    <code>IInteractionRequest</code>   <code>InteractionRequest ,          (. QuestionnaireViewModel.cs</code> ). <br> <br>        <br>       ,       .   ,       .    UI             . <br> <br>                . Microsoft Expression Blend Behaviors Framework     .  ,     ,    . <br> <br>  <code>EventTrigger</code> ,  Expression Blend,  ,      ,     ,   . , Prism   <code>EventTrigger</code> ,  <code>InteractionRequestTrigger</code> ,      <code>Raised</code>   <code>IInteractionRequest</code> .    XAML        . <br> <br>  ,   , <code>InteractionRequestTrigger</code>   .  Silverlight Prism   <code>PopupChildWindowAction</code> ,     .    ,         .   <code>ContentTemplate</code>  <code>PopupChildWindowAction</code> ,    ,    UI,      <code>Content</code>  .       <code>Title</code>  . <br> <b></b> <br>  ,    ,   <code>PopupChildWindowAction</code> ,     .    <code>Notification</code>  <code>NotificationChildWindow</code> ,        <code>Confirmation</code> ‚Äì <code>ConfirmationChildWindow</code> . <code>NotificationChildWindow</code>    ,   ,     <code>ConfirmationChildWindow</code>    <i>OK</i>  <i>Cancel</i> ,    .    ,   ,   <code>ChildWindow</code>  <code>PopupChildWindowAction</code> . <br>   ,  <code>InteractionRequestTrigger</code>  <code>PopupChildWindowAction</code> ,       <i>RI MVVM</i> . <br> <br> <code class="xml">&lt;i:Interaction.Triggers&gt; &lt;prism:InteractionRequestTrigger SourceObject="{Binding ConfirmCancelInteractionRequest}"&gt; &lt;prism:PopupChildWindowAction ContentTemplate="{StaticResource ConfirmWindowTemplate}"/&gt; &lt;/prism:InteractionRequestTrigger&gt; &lt;/i:Interaction.Triggers&gt; &lt;UserControl.Resources&gt; &lt;DataTemplate x:Key="ConfirmWindowTemplate"&gt; &lt;Grid MinWidth="250" MinHeight="100"&gt; &lt;TextBlock TextWrapping="Wrap" Grid.Row="0" Text="{Binding}"/&gt; &lt;/Grid&gt; &lt;/DataTemplate&gt; &lt;/UserControl.Resources&gt;</code> <br> <b></b> <br>      <code>ContentTemplate</code> ,   UI   <code>Content</code>  .    <code>Content</code>  ,  , <code>TextBlock</code>     <code>Content</code> . <br>      ,     ,    ,    .  ,     ,       ,     ,    .   ,   <i>RI MVVM</i> ,         <code>Confirmed</code>    <code>Confirmation</code>  <code>true</code> ,     OK. <br> <br>        ,     .  Prism <code>InteractionRequestTrigger</code>   <code>PopupChildWindowAction</code>            . <br> <br>     <br>     MVVM,       , ,    ,         .        (  , ,  ,   ).    ,  ,  ,            . <br> <br>        ,         . Managed Extensibility Framework (MEF)  Unity Application Block (Unity)      ,  ,           . <br> <br>  ,       , , ,    ( )      . ,       ,     .  ,     ,       . <br> <br>     ,  MEF <br>  MEF,       ,   <code>Import</code> ,      ,  ,   <code>Export</code> .         ,    . <br> <br> , <code>QuestionnaireView</code>   <i>RI MVVM</i> ,        ,    <code>Import</code> .   , MEF           .  <code>set</code>        ,   . <br> <br> <code class="cs">[Import] public QuestionnaireViewModel ViewModel { set { this.DataContext = value; } }</code> <br>     ,   . <br> <br> <code class="cs">[Export] public class QuestionnaireViewModel : NotificationObject { ... }</code> <br>        ,   . <br> <br> <code class="cs">public QuestionnaireView() { InitializeComponent(); } [ImportingConstructor] public QuestionnaireView(QuestionnaireViewModel viewModel) : this() { this.DataContext = viewModel; }</code> <br> <b></b> <br>          MEF,   Unity.   ,     ,        .   ,   Visual Studio  Expression Blend, ,        ,     .   ,   ,  ,      ,          <code>InitializeComponent</code> . <br>     ,  Unity <br>  Unity,    ,   MEF.     ,      .    ,         .  ,      . <br> <br>  ,      ,  ,         . ,           ,   . <br> <br> <code class="cs">public QuestionnaireView() { InitializeComponent(); } public QuestionnaireView(QuestionnaireViewModel viewModel) : this() { this.DataContext = viewModel; }</code> <br> <b></b> <br>    ,        ,   Visual Studio  Expression Blend. <br>  ,          ,   . Unity        <code>set</code>   ,   . <br> <br> <code class="cs">public QuestionnaireView() { InitializeComponent(); } [Dependency] public QuestionnaireViewModel ViewModel { set { this.DataContext = value; } }</code> <br>       Unity. <br> <br> <code class="cs">container.RegisterType&lt;QuestionnaireViewModel&gt;();</code> <br>  ,     . <br> <br> <code class="cs">var view = container.Resolve&lt;QuestionnaireView&gt;();</code> <br>     ,    <br>   ,     ,        .        ,   MEF  Unity,        . <br> <br>          .   ,         UI,           . <br> <br> , <i>RI MVVM</i>   ,   ,        .   ,    .      <code>ShowView</code>   UI. <br> <br> <code class="cs">private void NavigateToQuestionnaireList() { //     "questionnaire list". this.uiService.ShowView(ViewNames.QuestionnaireTemplatesList); }</code> <br>  UI      UI .           UI.  <code>ShowView</code>  <code>UIService</code>      (,          ),       ,   . <br> <br> <code class="cs">public void ShowView(string viewName) { var view = this.ViewFactory.GetView(viewName); this.MainWindow.CurrentView = view; }</code> <br> <b></b> <br> Prism       .   ,   ,   ,             .    ,  , " <a href="http://msdn.microsoft.com/en-us/library/gg430861(v%3DPandP.40).aspx">View-Based Navigation</a> "   8, " <a href="http://msdn.microsoft.com/en-us/library/gg430861(v%3DPandP.40).aspx">Navigation</a> ". <br>  MVVM  <br>        MVVM      .           -      mocking . ,   ,        . <br> <br>   <i>INotifyPropertyChanged</i> <br>   <code>INotifyPropertyChanged</code>     ,      .      ,    ;   ,   ,     ,    ,       . <br> <br>   <br> ,       ,           <code>PropertyChanged</code>  ,         .  ,    <code>ChangeTracker</code> ,     MVVM,  ,      .      .     ,    . <br> <br> <code class="cs">var changeTracker = new PropertyChangeTracker(viewModel); viewModel.CurrentState = "newState"; CollectionAssert.Contains(changeTracker.ChangedProperties, "CurrentState");</code> <br> ,     ,     <code>INotifyPropertyChanged</code> ,    ,   ,     . <br> <br>      <br>        ,   ,    <code>set</code>      ,           . ,     ,     ,      ,          . <br> <br> <code class="cs">var changeTracker = new PropertyChangeTracker(viewModel); var question = viewModel.Questions.First() as OpenQuestionViewModel; question.Question.Response = "some text"; CollectionAssert.Contains(changeTracker.ChangedProperties, "UnansweredQuestions");</code> <br>      <br>     <code>INotifyPropertyChanged</code> ,      <code>PropertyChanged</code>        ,  ,     , , .        ,       . <br> <br>   <i>INotifyDataErrorInfo</i> <br>   ,     ,    ,   ,   <code>IDataErrorInfo</code> ,  ( Silverlight)   <code>INotifyDataErrorInfo</code> .   <code>INotifyDataErrorInfo</code>   ,         ,    ,  ,   ,    . <br> <br>       <code>INotifyDataErrorInfo</code> : ,     ,  ,     ,     <code>ErrorsChanged</code> ,      <code>GetErrors</code> , . <br> <br>    <br>     ,      ,     .       ,         <code>GetErrors</code>       ,  ,  ,   .    , ,  ,     ,        .   ,        . <br> <br> <code class="cs">//  . var notifyErrorInfo = (INotifyDataErrorInfo)question; question.Response = -15; Assert.IsTrue(notifyErrorInfo.GetErrors("Response").Cast&lt;ValidationResult&gt;().Any()); //  . var notifyErrorInfo = (INotifyDataErrorInfo)question; question.Response = 15; Assert.IsFalse(notifyErrorInfo.GetErrors("Response").Cast&lt;ValidationResult&gt;().Any());</code> <br>    ,    ,             . <br> <br>    <i>INotifyDataErrorInfo</i> <br>       <code>GetErrors</code> ,   <code>INotifyDataErrorInfo</code>  ,   <code>ErrorsChanged</code>      <code>GetErrors</code> . ,  <code>HasErrors</code>      ,  . <br> <br>       <code>INotifyDataErrorInfo</code> . , ,           ,   -  .      ,        <code>INotifyDataErrorInfo</code>         (,        ). <br> <br>     ,   ,  : <br>  <code>HasErrors</code>     .              ,       .  <code>ErrorsChanged</code> ,      ,         <code>GetErrors</code> .         ( ,  )     ,           .    <code>GetErrors</code>       <code>ErrorsChanged</code> . <br>    <code>INotifyPropertyChanged</code> ,  ,    <code>NotifyDataErrorInfoTestHelper</code>    MVVM,        <code>INotifyDataErrorInfo</code> ,       .   ,   ,      ,   .      . <br> <code class="cs">var helper = new NotifyDataErrorInfoTestHelper&lt;NumericQuestion, int?&gt;( question, q =&gt; q.Response); helper.ValidatePropertyChange( 6, NotifyDataErrorInfoBehavior.Nothing); helper.ValidatePropertyChange( 20, NotifyDataErrorInfoBehavior.FiresErrorsChanged | NotifyDataErrorInfoBehavior.HasErrors | NotifyDataErrorInfoBehavior.HasErrorsForProperty); helper.ValidatePropertyChange( null, NotifyDataErrorInfoBehavior.FiresErrorsChanged | NotifyDataErrorInfoBehavior.HasErrors | NotifyDataErrorInfoBehavior.HasErrorsForProperty); helper.ValidatePropertyChange( 2, NotifyDataErrorInfoBehavior.FiresErrorsChanged);</code> <br>     <br>   MVVM,     ,  .   ,    ,         . <br> <br>  ,     ,     ,       .   ,   , ,       ,     ,   <code>IAsyncResult</code>    ,  - ,   ,    UI. <br> <br>       , , ,    .   ,     .  ,      UI,     ,   ,          ,     ,        "   UI." <br> <br>     ,    ,    .   ,    ,     mock-, ,   ,   ,      ,          . <br> <br>           UI,    ,    .   ,     ,   ,      .        ,   .     ,    ,     . <br> <br> <code class="cs">questionnaireRepositoryMock .Setup( r =&gt; r.SubmitQuestionnaireAsync( It.IsAny&lt;Questionnaire&gt;(), It.IsAny&lt;Action&lt;IOperationResult&gt;&gt;())) .Callback&lt;Questionnaire, Action&lt;IOperationResult&gt;&gt;( (q, a) =&gt; callback = a); uiServicemock .Setup(svc =&gt; svc.ShowView(ViewNames.QuestionnaireTemplatesList)) .Callback&lt;string&gt;(viewName =&gt; requestedViewName = viewName); submitResultMock .Setup(sr =&gt; sr.Error) .Returns&lt;Exception&gt;(null); CompleteQuestionnaire(viewModel); viewModel.Submit(); //      UI . callback(submitResultMock.Object); //    ‚Äì     . Assert.AreEqual(ViewNames.QuestionnaireTemplatesList, requestedViewName);</code> <br> <b></b> <br>          ,        . <br>   <br>       , . "Trees in WPF"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ms753391.aspx">http://msdn.microsoft.com/en-us/library/ms753391.aspx</a> <br> <br>       , . "Attached Properties Overview"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/cc265152(VS.95).aspx">http://msdn.microsoft.com/en-us/library/cc265152(VS.95).aspx</a> <br> <br>      MEF, ."Managed Extensibility Framework Overview"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/dd460648.aspx">http://msdn.microsoft.com/en-us/library/dd460648.aspx</a> . <br> <br>      Unity, ."Unity Application Block"  MSDN: <a href="http://www.msdn.com/unity">http://www.msdn.com/unity</a> . <br> <br>      <code>DelegateCommand</code> , .Chapter 5, " <a href="http://msdn.microsoft.com/en-us/library/gg405484(v%3DPandP.40).aspx">Implementing the MVVM Pattern</a> ." <br> <br>        Microsoft Expression Blend, ."Working with built-in behaviors"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ff724013(v%3DExpression.40).aspx">http://msdn.microsoft.com/en-us/library/ff724013(v=Expression.40).aspx</a> . <br> <br>          Microsoft Expression Blend, ."Creating Custom Behaviors"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ff724708(v%3DExpression.40).aspx">http://msdn.microsoft.com/en-us/library/ff724708(v=Expression.40).aspx</a> . <br> <br>            Microsoft Expression Blend, ."Creating Custom Triggers and Actions"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ff724707(v%3DExpression.40).aspx">http://msdn.microsoft.com/en-us/library/ff724707(v=Expression.40).aspx</a> . <br> <br>         WPF  Silverlight, ."Threading Model"  "The Dispatcher Class"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ms741870.aspx">http://msdn.microsoft.com/en-us/library/ms741870.aspx</a> <br> <a href="http://msdn.microsoft.com/en-us/library/ms615907(v%3DVS.95).aspx">http://msdn.microsoft.com/en-us/library/ms615907(v=VS.95).aspx</a> . <br> <br>      unit-  Silverlight, ."Unit Testing with Silverlight 2": <a href="http://www.jeff.wilcox.name/2008/03/silverlight2-unit-testing/">http://www.jeff.wilcox.name/2008/03/silverlight2-unit-testing/</a> . <br> <br>         , .  " <a href="http://msdn.microsoft.com/en-us/library/gg430861(v%3DPandP.40).aspx">View-Based Navigation</a> " in Chapter 8, " <a href="http://msdn.microsoft.com/en-us/library/gg430861(v%3DPandP.40).aspx">Navigation</a> ." <br> <br>       ,   , ."Event-based Asynchronous Pattern Overview"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/wewwczdw.aspx">http://msdn.microsoft.com/en-us/library/wewwczdw.aspx</a> <br> <br>        <code>IAsyncResult</code> , ."Asynchronous Programming Overview"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ms228963.aspx">http://msdn.microsoft.com/en-us/library/ms228963.aspx</a></code></code></code></code></code></code></code></code></code> <blockquote> <code><code><code><code><code><code><code><code><code><code>CommandBehaviorBase ,    ,    ICommand</code> .           <code>CanExecuteChanged</code> ,          Silverlight,    WPF. <br> <br>    ,  ,   <code>CommandBehaviorBase    ,    .         ,      .         ,    .      ButtonBaseClickCommandBehavior</code> . <br> <br> <code class="cs">public class ButtonBaseClickCommandBehavior : CommandBehaviorBase&lt;ButtonBase&gt; { public ButtonBaseClickCommandBehavior(ButtonBase clickableObject) : base(clickableObject) { clickableObject.Click += OnClick; } private void OnClick(object sender, System.Windows.RoutedEventArgs e) { ExecuteCommand(); } }</code> <br>   <code>CommandBehaviorBase ,     .     ,          ,   . ,    ,    ,      , ,    CanExecute</code>  ,     . <br> <br>          ,   .           XAML.           .       .  Prism      ,       ,  ,   .       ,    . , ,  ,      <code>Click</code> ,       <code>Command</code> .    <code>Click.Command</code> ,  . <br> <br>             .             . <br> <br> <code class="cs">public static readonly DependencyProperty CommandProperty = DependencyProperty.RegisterAttached( "Command", typeof(ICommand), typeof(Click), new PropertyMetadata(OnSetCommandCallback)); private static readonly DependencyProperty ClickCommandBehaviorProperty = DependencyProperty.RegisterAttached( "ClickCommandBehavior", typeof(ButtonBaseClickCommandBehavior), typeof(Click), null);</code> <br>    <code>Command</code>    <code>ButtonBaseClickCommandBehavior</code> ,     <code>OnSetCommandCallback</code> ,     . <br> <br> <code class="cs">private static void OnSetCommandCallback(DependencyObject dependencyObject, DependencyPropertyChangedEventArgs e) { ButtonBase buttonBase = dependencyObject as ButtonBase; if (buttonBase != null) { ButtonBaseClickCommandBehavior behavior = GetOrCreateBehavior(buttonBase); behavior.Command = e.NewValue as ICommand; } } private static void OnSetCommandParameterCallback(DependencyObject dependencyObject, DependencyPropertyChangedEventArgs e) { ButtonBase buttonBase = dependencyObject as ButtonBase; if (buttonBase != null) { ButtonBaseClickCommandBehavior behavior = GetOrCreateBehavior(buttonBase); behavior.CommandParameter = e.NewValue; } } private static ButtonBaseClickCommandBehavior GetOrCreateBehavior(ButtonBase buttonBase ) { ButtonBaseClickCommandBehavior behavior = buttonBase.GetValue(ClickCommandBehaviorProperty) as ButtonBaseClickCommandBehavior; if ( behavior == null ) { behavior = new ButtonBaseClickCommandBehavior(buttonBase); buttonBase.SetValue(ClickCommandBehaviorProperty, behavior); } return behavior; }</code> <br>        ,  <a href="http://msdn.microsoft.com/en-us/library/cc265152(VS.95).aspx">Attached Properties Overview</a>  MSDN. <br> <br>    <br>              . ,     Silverlight,    -,     ,      ,     .     ,       . <br> <br>        ,    ( )  ,  ,     .  UI       ,            UI. <br> <br>      - <br>   -     ,       <code>IAsyncResult</code> .   ,  ,   ,  <code>GetQuestionnaire</code> ,   : <code>BeginGetQuestionnaire</code>  <code>EndGetQuestionnaire</code> .    ,   <code>BeginGetQuestionnaire</code> .     ,   ,   <code>EndGetQuestionnaire</code>    . <br> <b></b> <br>  .NET Framework 4.5      <code>await</code>  <code>async</code>     <code>*Async</code> .      <a href="http://msdn.microsoft.com/en-us/library/vstudio/hh391443.aspx">"Asynchronous Programming with Async and Await (C# and Visual Basic)"</a> . <br>  ,    <code>EndGetQuestionnaire</code> ,      ,  ()      <code>BeginGetQuestionnaire</code> .     ,      ,   <code>EndGetQuestionnaire</code> ,   . <br> <br> <code class="xml">IAsyncResult asyncResult = this.service.BeginGetQuestionnaire( GetQuestionnaireCompleted, null //  ,      ); private void GetQuestionnaireCompleted(IAsyncResult result) { try { questionnaire = this.service.EndGetQuestionnaire(ar); } catch (Exception ex) { //  -   . } }</code> <br>  ,     <code>End*</code> (  , <code>EndGetQuestionnaire</code> ),    ,      .      , ,          UI.     ,   ,        . <br> <br>        UI,     -,      UI,         UI,   <code>Dispatcher</code>    <code>SynchronizationContext</code> .  WPF  Silverlight,   <code>Dispatcher</code> . <br> <br>      <code>Questionnaire</code>  ,        <code>QuestionnaireView</code> .  Silverlight    <code>CheckAccess</code> ,  ,      UI.  ,     <code>BeginInvoke</code> ,      UI. <br> <br> <code class="cs">var dispatcher = System.Windows.Deployment.Current.Dispatcher; if (dispatcher.CheckAccess()) { QuestionnaireView.DataContext = questionnaire; } else { dispatcher.BeginInvoke(() =&gt; { Questionnaire.DataContext = questionnaire; }); }</code> <br> <i>MVVM RI</i>   ,    ,   <code>IAsyncResult</code> ,   .      ,                 . ,       . <br> <br> <code class="cs">this.questionnaireRepository.GetQuestionnaireAsync( result =&gt; { this.Questionnaire = result.Result; });</code> <br>  <code>result</code>   ,     , , , .    ,     . <br> <br> <code class="cs">this.questionnaireRepository.GetQuestionnaireAsync( result =&gt; { if (result.Error == null) { this.Questionnaire = result.Result; ... } else { // Handle error. } })</code> <br>     <br>        ,      .     , ,             .        ,      ,     ,     . <br> <br>         ,      MVVM,     ,   . ,  -MVVM ,     <code>MessageBox</code>   code-behind UI,      .   MVVM     ,          . <br> <br>     MVVM,              ,          .      ,    ,   ,  ,     . <br> <br>              MVVM.      ,     ,     ,  ,     .    ,         ,     ,          .       . <br> <br>    <br>                  .        ,        .  ,         .         . <br> <br>  ,         ,         ,  .      ,     .           ,       . ,        WPF  Silverlight,        . <br> <br> <img title="Using the service to interact with the user." src="https://habrastorage.org/getpro/habr/post_images/4b5/397/f2d/4b5397f2d02e5851195b29f1893be6fc.png" alt=" ,    ."> <br> <br>  ,   <code>MessageBox</code>        ,     ,    ,     . <br> <br> <code class="cs">var result = interactionService.ShowMessageBox( "Are you sure you want to cancel this operation?", "Confirm", MessageBoxButton.OK); if (result == MessageBoxResult.Yes) { CancelRequest(); }</code> <br> ,      - ,      ,         Silverlight.         .             .     . <br> <br> <code class="cs">interactionService.ShowMessageBox( "Are you sure you want to cancel this operation?", "Confirm", MessageBoxButton.OK, result =&gt; { if (result == MessageBoxResult.Yes) { CancelRequest(); } });</code> <br>         ,      . ,  WPF    <code>MessageBox</code> ,       ;    Silverlight    ,    . <br> <br>     <br>         ‚Äì             .         ,      .     ,     .        ,        ,   ,     . <br> <br> <img title="Using interaction request objects." src="https://habrastorage.org/getpro/habr/post_images/3d0/ff0/1c5/3d0ff01c5518558c2d3c5c5f47ce0ce9.png" alt="   ."> <br> <br>    ,   ,          ‚Äì       ,      ,   ‚Äì     .   ,        ,    ,    UI            . <br> <br>       MVVM,     ,       ,         .         ,        ,    ,   . <br> <br>  Prism       <code>IInteractionRequest</code>   <code>InteractionRequest .  IInteractionRequest</code>  ,   .           ,   .  <code>InteractionRequest   IInteractionRequest</code>     <code>Raise</code> ,           , , ,   . <br> <br>       <br>  <code>InteractionRequest          .  Raise</code>          ( <code>T</code> )    ,    ,   .          ,       .      ,        .    ,  ,     . <br> <code class="cs">public interface IInteractionRequest { event EventHandler&lt;InteractionRequestedEventArgs&gt; Raised; } public class InteractionRequest&lt;T&gt; : IInteractionRequest { public event EventHandler&lt;InteractionRequestedEventArgs&gt; Raised; public void Raise(T context, Action&lt;T&gt; callback) { var handler = this.Raised; if (handler != null) { handler( this, new InteractionRequestedEventArgs(context, () =&gt; callback(context))); } } }</code> <br> Prism    ,      .  <code>Notification</code>       .    ,            .     ‚Äì <code>Title</code>  <code>Content</code> ,    .  ,   ,  ,  ,        . <br> <br>  <code>Confirmation</code>    <code>Notification</code>     ‚Äì <code>Confirmed</code> ,  ,  ,      .  <code>Confirmation</code> ,     <code>MessageBox</code> ,     /  .     ,     <code>Notification</code> ,     ,      . <br> <br>    <code>InteractionRequest ,       InteractionRequest      ,      .      ,    Raise</code> ,    , ,   . <br> <br> <code class="cs">public IInteractionRequest ConfirmCancelInteractionRequest { get { return this.confirmCancelInteractionRequest; } } this.confirmCancelInteractionRequest.Raise( new Confirmation("Are you sure you wish to cancel?"), confirmation =&gt; { if (confirmation.Confirmed) { this.NavigateToQuestionnaireList(); } }); }</code> <br> <i>MVVM Reference Implementation (MVVM RI)</i> ,    <code>IInteractionRequest</code>   <code>InteractionRequest ,          (. QuestionnaireViewModel.cs</code> ). <br> <br>        <br>       ,       .   ,       .    UI             . <br> <br>                . Microsoft Expression Blend Behaviors Framework     .  ,     ,    . <br> <br>  <code>EventTrigger</code> ,  Expression Blend,  ,      ,     ,   . , Prism   <code>EventTrigger</code> ,  <code>InteractionRequestTrigger</code> ,      <code>Raised</code>   <code>IInteractionRequest</code> .    XAML        . <br> <br>  ,   , <code>InteractionRequestTrigger</code>   .  Silverlight Prism   <code>PopupChildWindowAction</code> ,     .    ,         .   <code>ContentTemplate</code>  <code>PopupChildWindowAction</code> ,    ,    UI,      <code>Content</code>  .       <code>Title</code>  . <br> <b></b> <br>  ,    ,   <code>PopupChildWindowAction</code> ,     .    <code>Notification</code>  <code>NotificationChildWindow</code> ,        <code>Confirmation</code> ‚Äì <code>ConfirmationChildWindow</code> . <code>NotificationChildWindow</code>    ,   ,     <code>ConfirmationChildWindow</code>    <i>OK</i>  <i>Cancel</i> ,    .    ,   ,   <code>ChildWindow</code>  <code>PopupChildWindowAction</code> . <br>   ,  <code>InteractionRequestTrigger</code>  <code>PopupChildWindowAction</code> ,       <i>RI MVVM</i> . <br> <br> <code class="xml">&lt;i:Interaction.Triggers&gt; &lt;prism:InteractionRequestTrigger SourceObject="{Binding ConfirmCancelInteractionRequest}"&gt; &lt;prism:PopupChildWindowAction ContentTemplate="{StaticResource ConfirmWindowTemplate}"/&gt; &lt;/prism:InteractionRequestTrigger&gt; &lt;/i:Interaction.Triggers&gt; &lt;UserControl.Resources&gt; &lt;DataTemplate x:Key="ConfirmWindowTemplate"&gt; &lt;Grid MinWidth="250" MinHeight="100"&gt; &lt;TextBlock TextWrapping="Wrap" Grid.Row="0" Text="{Binding}"/&gt; &lt;/Grid&gt; &lt;/DataTemplate&gt; &lt;/UserControl.Resources&gt;</code> <br> <b></b> <br>      <code>ContentTemplate</code> ,   UI   <code>Content</code>  .    <code>Content</code>  ,  , <code>TextBlock</code>     <code>Content</code> . <br>      ,     ,    ,    .  ,     ,       ,     ,    .   ,   <i>RI MVVM</i> ,         <code>Confirmed</code>    <code>Confirmation</code>  <code>true</code> ,     OK. <br> <br>        ,     .  Prism <code>InteractionRequestTrigger</code>   <code>PopupChildWindowAction</code>            . <br> <br>     <br>     MVVM,       , ,    ,         .        (  , ,  ,   ).    ,  ,  ,            . <br> <br>        ,         . Managed Extensibility Framework (MEF)  Unity Application Block (Unity)      ,  ,           . <br> <br>  ,       , , ,    ( )      . ,       ,     .  ,     ,       . <br> <br>     ,  MEF <br>  MEF,       ,   <code>Import</code> ,      ,  ,   <code>Export</code> .         ,    . <br> <br> , <code>QuestionnaireView</code>   <i>RI MVVM</i> ,        ,    <code>Import</code> .   , MEF           .  <code>set</code>        ,   . <br> <br> <code class="cs">[Import] public QuestionnaireViewModel ViewModel { set { this.DataContext = value; } }</code> <br>     ,   . <br> <br> <code class="cs">[Export] public class QuestionnaireViewModel : NotificationObject { ... }</code> <br>        ,   . <br> <br> <code class="cs">public QuestionnaireView() { InitializeComponent(); } [ImportingConstructor] public QuestionnaireView(QuestionnaireViewModel viewModel) : this() { this.DataContext = viewModel; }</code> <br> <b></b> <br>          MEF,   Unity.   ,     ,        .   ,   Visual Studio  Expression Blend, ,        ,     .   ,   ,  ,      ,          <code>InitializeComponent</code> . <br>     ,  Unity <br>  Unity,    ,   MEF.     ,      .    ,         .  ,      . <br> <br>  ,      ,  ,         . ,           ,   . <br> <br> <code class="cs">public QuestionnaireView() { InitializeComponent(); } public QuestionnaireView(QuestionnaireViewModel viewModel) : this() { this.DataContext = viewModel; }</code> <br> <b></b> <br>    ,        ,   Visual Studio  Expression Blend. <br>  ,          ,   . Unity        <code>set</code>   ,   . <br> <br> <code class="cs">public QuestionnaireView() { InitializeComponent(); } [Dependency] public QuestionnaireViewModel ViewModel { set { this.DataContext = value; } }</code> <br>       Unity. <br> <br> <code class="cs">container.RegisterType&lt;QuestionnaireViewModel&gt;();</code> <br>  ,     . <br> <br> <code class="cs">var view = container.Resolve&lt;QuestionnaireView&gt;();</code> <br>     ,    <br>   ,     ,        .        ,   MEF  Unity,        . <br> <br>          .   ,         UI,           . <br> <br> , <i>RI MVVM</i>   ,   ,        .   ,    .      <code>ShowView</code>   UI. <br> <br> <code class="cs">private void NavigateToQuestionnaireList() { //     "questionnaire list". this.uiService.ShowView(ViewNames.QuestionnaireTemplatesList); }</code> <br>  UI      UI .           UI.  <code>ShowView</code>  <code>UIService</code>      (,          ),       ,   . <br> <br> <code class="cs">public void ShowView(string viewName) { var view = this.ViewFactory.GetView(viewName); this.MainWindow.CurrentView = view; }</code> <br> <b></b> <br> Prism       .   ,   ,   ,             .    ,  , " <a href="http://msdn.microsoft.com/en-us/library/gg430861(v%3DPandP.40).aspx">View-Based Navigation</a> "   8, " <a href="http://msdn.microsoft.com/en-us/library/gg430861(v%3DPandP.40).aspx">Navigation</a> ". <br>  MVVM  <br>        MVVM      .           -      mocking . ,   ,        . <br> <br>   <i>INotifyPropertyChanged</i> <br>   <code>INotifyPropertyChanged</code>     ,      .      ,    ;   ,   ,     ,    ,       . <br> <br>   <br> ,       ,           <code>PropertyChanged</code>  ,         .  ,    <code>ChangeTracker</code> ,     MVVM,  ,      .      .     ,    . <br> <br> <code class="cs">var changeTracker = new PropertyChangeTracker(viewModel); viewModel.CurrentState = "newState"; CollectionAssert.Contains(changeTracker.ChangedProperties, "CurrentState");</code> <br> ,     ,     <code>INotifyPropertyChanged</code> ,    ,   ,     . <br> <br>      <br>        ,   ,    <code>set</code>      ,           . ,     ,     ,      ,          . <br> <br> <code class="cs">var changeTracker = new PropertyChangeTracker(viewModel); var question = viewModel.Questions.First() as OpenQuestionViewModel; question.Question.Response = "some text"; CollectionAssert.Contains(changeTracker.ChangedProperties, "UnansweredQuestions");</code> <br>      <br>     <code>INotifyPropertyChanged</code> ,      <code>PropertyChanged</code>        ,  ,     , , .        ,       . <br> <br>   <i>INotifyDataErrorInfo</i> <br>   ,     ,    ,   ,   <code>IDataErrorInfo</code> ,  ( Silverlight)   <code>INotifyDataErrorInfo</code> .   <code>INotifyDataErrorInfo</code>   ,         ,    ,  ,   ,    . <br> <br>       <code>INotifyDataErrorInfo</code> : ,     ,  ,     ,     <code>ErrorsChanged</code> ,      <code>GetErrors</code> , . <br> <br>    <br>     ,      ,     .       ,         <code>GetErrors</code>       ,  ,  ,   .    , ,  ,     ,        .   ,        . <br> <br> <code class="cs">//  . var notifyErrorInfo = (INotifyDataErrorInfo)question; question.Response = -15; Assert.IsTrue(notifyErrorInfo.GetErrors("Response").Cast&lt;ValidationResult&gt;().Any()); //  . var notifyErrorInfo = (INotifyDataErrorInfo)question; question.Response = 15; Assert.IsFalse(notifyErrorInfo.GetErrors("Response").Cast&lt;ValidationResult&gt;().Any());</code> <br>    ,    ,             . <br> <br>    <i>INotifyDataErrorInfo</i> <br>       <code>GetErrors</code> ,   <code>INotifyDataErrorInfo</code>  ,   <code>ErrorsChanged</code>      <code>GetErrors</code> . ,  <code>HasErrors</code>      ,  . <br> <br>       <code>INotifyDataErrorInfo</code> . , ,           ,   -  .      ,        <code>INotifyDataErrorInfo</code>         (,        ). <br> <br>     ,   ,  : <br>  <code>HasErrors</code>     .              ,       .  <code>ErrorsChanged</code> ,      ,         <code>GetErrors</code> .         ( ,  )     ,           .    <code>GetErrors</code>       <code>ErrorsChanged</code> . <br>    <code>INotifyPropertyChanged</code> ,  ,    <code>NotifyDataErrorInfoTestHelper</code>    MVVM,        <code>INotifyDataErrorInfo</code> ,       .   ,   ,      ,   .      . <br> <code class="cs">var helper = new NotifyDataErrorInfoTestHelper&lt;NumericQuestion, int?&gt;( question, q =&gt; q.Response); helper.ValidatePropertyChange( 6, NotifyDataErrorInfoBehavior.Nothing); helper.ValidatePropertyChange( 20, NotifyDataErrorInfoBehavior.FiresErrorsChanged | NotifyDataErrorInfoBehavior.HasErrors | NotifyDataErrorInfoBehavior.HasErrorsForProperty); helper.ValidatePropertyChange( null, NotifyDataErrorInfoBehavior.FiresErrorsChanged | NotifyDataErrorInfoBehavior.HasErrors | NotifyDataErrorInfoBehavior.HasErrorsForProperty); helper.ValidatePropertyChange( 2, NotifyDataErrorInfoBehavior.FiresErrorsChanged);</code> <br>     <br>   MVVM,     ,  .   ,    ,         . <br> <br>  ,     ,     ,       .   ,   , ,       ,     ,   <code>IAsyncResult</code>    ,  - ,   ,    UI. <br> <br>       , , ,    .   ,     .  ,      UI,     ,   ,          ,     ,        "   UI." <br> <br>     ,    ,    .   ,    ,     mock-, ,   ,   ,      ,          . <br> <br>           UI,    ,    .   ,     ,   ,      .        ,   .     ,    ,     . <br> <br> <code class="cs">questionnaireRepositoryMock .Setup( r =&gt; r.SubmitQuestionnaireAsync( It.IsAny&lt;Questionnaire&gt;(), It.IsAny&lt;Action&lt;IOperationResult&gt;&gt;())) .Callback&lt;Questionnaire, Action&lt;IOperationResult&gt;&gt;( (q, a) =&gt; callback = a); uiServicemock .Setup(svc =&gt; svc.ShowView(ViewNames.QuestionnaireTemplatesList)) .Callback&lt;string&gt;(viewName =&gt; requestedViewName = viewName); submitResultMock .Setup(sr =&gt; sr.Error) .Returns&lt;Exception&gt;(null); CompleteQuestionnaire(viewModel); viewModel.Submit(); //      UI . callback(submitResultMock.Object); //    ‚Äì     . Assert.AreEqual(ViewNames.QuestionnaireTemplatesList, requestedViewName);</code> <br> <b></b> <br>          ,        . <br>   <br>       , . "Trees in WPF"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ms753391.aspx">http://msdn.microsoft.com/en-us/library/ms753391.aspx</a> <br> <br>       , . "Attached Properties Overview"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/cc265152(VS.95).aspx">http://msdn.microsoft.com/en-us/library/cc265152(VS.95).aspx</a> <br> <br>      MEF, ."Managed Extensibility Framework Overview"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/dd460648.aspx">http://msdn.microsoft.com/en-us/library/dd460648.aspx</a> . <br> <br>      Unity, ."Unity Application Block"  MSDN: <a href="http://www.msdn.com/unity">http://www.msdn.com/unity</a> . <br> <br>      <code>DelegateCommand</code> , .Chapter 5, " <a href="http://msdn.microsoft.com/en-us/library/gg405484(v%3DPandP.40).aspx">Implementing the MVVM Pattern</a> ." <br> <br>        Microsoft Expression Blend, ."Working with built-in behaviors"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ff724013(v%3DExpression.40).aspx">http://msdn.microsoft.com/en-us/library/ff724013(v=Expression.40).aspx</a> . <br> <br>          Microsoft Expression Blend, ."Creating Custom Behaviors"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ff724708(v%3DExpression.40).aspx">http://msdn.microsoft.com/en-us/library/ff724708(v=Expression.40).aspx</a> . <br> <br>            Microsoft Expression Blend, ."Creating Custom Triggers and Actions"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ff724707(v%3DExpression.40).aspx">http://msdn.microsoft.com/en-us/library/ff724707(v=Expression.40).aspx</a> . <br> <br>         WPF  Silverlight, ."Threading Model"  "The Dispatcher Class"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ms741870.aspx">http://msdn.microsoft.com/en-us/library/ms741870.aspx</a> <br> <a href="http://msdn.microsoft.com/en-us/library/ms615907(v%3DVS.95).aspx">http://msdn.microsoft.com/en-us/library/ms615907(v=VS.95).aspx</a> . <br> <br>      unit-  Silverlight, ."Unit Testing with Silverlight 2": <a href="http://www.jeff.wilcox.name/2008/03/silverlight2-unit-testing/">http://www.jeff.wilcox.name/2008/03/silverlight2-unit-testing/</a> . <br> <br>         , .  " <a href="http://msdn.microsoft.com/en-us/library/gg430861(v%3DPandP.40).aspx">View-Based Navigation</a> " in Chapter 8, " <a href="http://msdn.microsoft.com/en-us/library/gg430861(v%3DPandP.40).aspx">Navigation</a> ." <br> <br>       ,   , ."Event-based Asynchronous Pattern Overview"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/wewwczdw.aspx">http://msdn.microsoft.com/en-us/library/wewwczdw.aspx</a> <br> <br>        <code>IAsyncResult</code> , ."Asynchronous Programming Overview"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ms228963.aspx">http://msdn.microsoft.com/en-us/library/ms228963.aspx</a></code></code></code></code></code></code></code></code></code> </blockquote> <code><code><code><code><code><code><code><code><code><code>CommandBehaviorBase ,    ,    ICommand</code> .           <code>CanExecuteChanged</code> ,          Silverlight,    WPF. <br> <br>    ,  ,   <code>CommandBehaviorBase    ,    .         ,      .         ,    .      ButtonBaseClickCommandBehavior</code> . <br> <br> <code class="cs">public class ButtonBaseClickCommandBehavior : CommandBehaviorBase&lt;ButtonBase&gt; { public ButtonBaseClickCommandBehavior(ButtonBase clickableObject) : base(clickableObject) { clickableObject.Click += OnClick; } private void OnClick(object sender, System.Windows.RoutedEventArgs e) { ExecuteCommand(); } }</code> <br>   <code>CommandBehaviorBase ,     .     ,          ,   . ,    ,    ,      , ,    CanExecute</code>  ,     . <br> <br>          ,   .           XAML.           .       .  Prism      ,       ,  ,   .       ,    . , ,  ,      <code>Click</code> ,       <code>Command</code> .    <code>Click.Command</code> ,  . <br> <br>             .             . <br> <br> <code class="cs">public static readonly DependencyProperty CommandProperty = DependencyProperty.RegisterAttached( "Command", typeof(ICommand), typeof(Click), new PropertyMetadata(OnSetCommandCallback)); private static readonly DependencyProperty ClickCommandBehaviorProperty = DependencyProperty.RegisterAttached( "ClickCommandBehavior", typeof(ButtonBaseClickCommandBehavior), typeof(Click), null);</code> <br>    <code>Command</code>    <code>ButtonBaseClickCommandBehavior</code> ,     <code>OnSetCommandCallback</code> ,     . <br> <br> <code class="cs">private static void OnSetCommandCallback(DependencyObject dependencyObject, DependencyPropertyChangedEventArgs e) { ButtonBase buttonBase = dependencyObject as ButtonBase; if (buttonBase != null) { ButtonBaseClickCommandBehavior behavior = GetOrCreateBehavior(buttonBase); behavior.Command = e.NewValue as ICommand; } } private static void OnSetCommandParameterCallback(DependencyObject dependencyObject, DependencyPropertyChangedEventArgs e) { ButtonBase buttonBase = dependencyObject as ButtonBase; if (buttonBase != null) { ButtonBaseClickCommandBehavior behavior = GetOrCreateBehavior(buttonBase); behavior.CommandParameter = e.NewValue; } } private static ButtonBaseClickCommandBehavior GetOrCreateBehavior(ButtonBase buttonBase ) { ButtonBaseClickCommandBehavior behavior = buttonBase.GetValue(ClickCommandBehaviorProperty) as ButtonBaseClickCommandBehavior; if ( behavior == null ) { behavior = new ButtonBaseClickCommandBehavior(buttonBase); buttonBase.SetValue(ClickCommandBehaviorProperty, behavior); } return behavior; }</code> <br>        ,  <a href="http://msdn.microsoft.com/en-us/library/cc265152(VS.95).aspx">Attached Properties Overview</a>  MSDN. <br> <br>    <br>              . ,     Silverlight,    -,     ,      ,     .     ,       . <br> <br>        ,    ( )  ,  ,     .  UI       ,            UI. <br> <br>      - <br>   -     ,       <code>IAsyncResult</code> .   ,  ,   ,  <code>GetQuestionnaire</code> ,   : <code>BeginGetQuestionnaire</code>  <code>EndGetQuestionnaire</code> .    ,   <code>BeginGetQuestionnaire</code> .     ,   ,   <code>EndGetQuestionnaire</code>    . <br> <b></b> <br>  .NET Framework 4.5      <code>await</code>  <code>async</code>     <code>*Async</code> .      <a href="http://msdn.microsoft.com/en-us/library/vstudio/hh391443.aspx">"Asynchronous Programming with Async and Await (C# and Visual Basic)"</a> . <br>  ,    <code>EndGetQuestionnaire</code> ,      ,  ()      <code>BeginGetQuestionnaire</code> .     ,      ,   <code>EndGetQuestionnaire</code> ,   . <br> <br> <code class="xml">IAsyncResult asyncResult = this.service.BeginGetQuestionnaire( GetQuestionnaireCompleted, null //  ,      ); private void GetQuestionnaireCompleted(IAsyncResult result) { try { questionnaire = this.service.EndGetQuestionnaire(ar); } catch (Exception ex) { //  -   . } }</code> <br>  ,     <code>End*</code> (  , <code>EndGetQuestionnaire</code> ),    ,      .      , ,          UI.     ,   ,        . <br> <br>        UI,     -,      UI,         UI,   <code>Dispatcher</code>    <code>SynchronizationContext</code> .  WPF  Silverlight,   <code>Dispatcher</code> . <br> <br>      <code>Questionnaire</code>  ,        <code>QuestionnaireView</code> .  Silverlight    <code>CheckAccess</code> ,  ,      UI.  ,     <code>BeginInvoke</code> ,      UI. <br> <br> <code class="cs">var dispatcher = System.Windows.Deployment.Current.Dispatcher; if (dispatcher.CheckAccess()) { QuestionnaireView.DataContext = questionnaire; } else { dispatcher.BeginInvoke(() =&gt; { Questionnaire.DataContext = questionnaire; }); }</code> <br> <i>MVVM RI</i>   ,    ,   <code>IAsyncResult</code> ,   .      ,                 . ,       . <br> <br> <code class="cs">this.questionnaireRepository.GetQuestionnaireAsync( result =&gt; { this.Questionnaire = result.Result; });</code> <br>  <code>result</code>   ,     , , , .    ,     . <br> <br> <code class="cs">this.questionnaireRepository.GetQuestionnaireAsync( result =&gt; { if (result.Error == null) { this.Questionnaire = result.Result; ... } else { // Handle error. } })</code> <br>     <br>        ,      .     , ,             .        ,      ,     ,     . <br> <br>         ,      MVVM,     ,   . ,  -MVVM ,     <code>MessageBox</code>   code-behind UI,      .   MVVM     ,          . <br> <br>     MVVM,              ,          .      ,    ,   ,  ,     . <br> <br>              MVVM.      ,     ,     ,  ,     .    ,         ,     ,          .       . <br> <br>    <br>                  .        ,        .  ,         .         . <br> <br>  ,         ,         ,  .      ,     .           ,       . ,        WPF  Silverlight,        . <br> <br> <img title="Using the service to interact with the user." src="https://habrastorage.org/getpro/habr/post_images/4b5/397/f2d/4b5397f2d02e5851195b29f1893be6fc.png" alt=" ,    ."> <br> <br>  ,   <code>MessageBox</code>        ,     ,    ,     . <br> <br> <code class="cs">var result = interactionService.ShowMessageBox( "Are you sure you want to cancel this operation?", "Confirm", MessageBoxButton.OK); if (result == MessageBoxResult.Yes) { CancelRequest(); }</code> <br> ,      - ,      ,         Silverlight.         .             .     . <br> <br> <code class="cs">interactionService.ShowMessageBox( "Are you sure you want to cancel this operation?", "Confirm", MessageBoxButton.OK, result =&gt; { if (result == MessageBoxResult.Yes) { CancelRequest(); } });</code> <br>         ,      . ,  WPF    <code>MessageBox</code> ,       ;    Silverlight    ,    . <br> <br>     <br>         ‚Äì             .         ,      .     ,     .        ,        ,   ,     . <br> <br> <img title="Using interaction request objects." src="https://habrastorage.org/getpro/habr/post_images/3d0/ff0/1c5/3d0ff01c5518558c2d3c5c5f47ce0ce9.png" alt="   ."> <br> <br>    ,   ,          ‚Äì       ,      ,   ‚Äì     .   ,        ,    ,    UI            . <br> <br>       MVVM,     ,       ,         .         ,        ,    ,   . <br> <br>  Prism       <code>IInteractionRequest</code>   <code>InteractionRequest .  IInteractionRequest</code>  ,   .           ,   .  <code>InteractionRequest   IInteractionRequest</code>     <code>Raise</code> ,           , , ,   . <br> <br>       <br>  <code>InteractionRequest          .  Raise</code>          ( <code>T</code> )    ,    ,   .          ,       .      ,        .    ,  ,     . <br> <code class="cs">public interface IInteractionRequest { event EventHandler&lt;InteractionRequestedEventArgs&gt; Raised; } public class InteractionRequest&lt;T&gt; : IInteractionRequest { public event EventHandler&lt;InteractionRequestedEventArgs&gt; Raised; public void Raise(T context, Action&lt;T&gt; callback) { var handler = this.Raised; if (handler != null) { handler( this, new InteractionRequestedEventArgs(context, () =&gt; callback(context))); } } }</code> <br> Prism    ,      .  <code>Notification</code>       .    ,            .     ‚Äì <code>Title</code>  <code>Content</code> ,    .  ,   ,  ,  ,        . <br> <br>  <code>Confirmation</code>    <code>Notification</code>     ‚Äì <code>Confirmed</code> ,  ,  ,      .  <code>Confirmation</code> ,     <code>MessageBox</code> ,     /  .     ,     <code>Notification</code> ,     ,      . <br> <br>    <code>InteractionRequest ,       InteractionRequest      ,      .      ,    Raise</code> ,    , ,   . <br> <br> <code class="cs">public IInteractionRequest ConfirmCancelInteractionRequest { get { return this.confirmCancelInteractionRequest; } } this.confirmCancelInteractionRequest.Raise( new Confirmation("Are you sure you wish to cancel?"), confirmation =&gt; { if (confirmation.Confirmed) { this.NavigateToQuestionnaireList(); } }); }</code> <br> <i>MVVM Reference Implementation (MVVM RI)</i> ,    <code>IInteractionRequest</code>   <code>InteractionRequest ,          (. QuestionnaireViewModel.cs</code> ). <br> <br>        <br>       ,       .   ,       .    UI             . <br> <br>                . Microsoft Expression Blend Behaviors Framework     .  ,     ,    . <br> <br>  <code>EventTrigger</code> ,  Expression Blend,  ,      ,     ,   . , Prism   <code>EventTrigger</code> ,  <code>InteractionRequestTrigger</code> ,      <code>Raised</code>   <code>IInteractionRequest</code> .    XAML        . <br> <br>  ,   , <code>InteractionRequestTrigger</code>   .  Silverlight Prism   <code>PopupChildWindowAction</code> ,     .    ,         .   <code>ContentTemplate</code>  <code>PopupChildWindowAction</code> ,    ,    UI,      <code>Content</code>  .       <code>Title</code>  . <br> <b></b> <br>  ,    ,   <code>PopupChildWindowAction</code> ,     .    <code>Notification</code>  <code>NotificationChildWindow</code> ,        <code>Confirmation</code> ‚Äì <code>ConfirmationChildWindow</code> . <code>NotificationChildWindow</code>    ,   ,     <code>ConfirmationChildWindow</code>    <i>OK</i>  <i>Cancel</i> ,    .    ,   ,   <code>ChildWindow</code>  <code>PopupChildWindowAction</code> . <br>   ,  <code>InteractionRequestTrigger</code>  <code>PopupChildWindowAction</code> ,       <i>RI MVVM</i> . <br> <br> <code class="xml">&lt;i:Interaction.Triggers&gt; &lt;prism:InteractionRequestTrigger SourceObject="{Binding ConfirmCancelInteractionRequest}"&gt; &lt;prism:PopupChildWindowAction ContentTemplate="{StaticResource ConfirmWindowTemplate}"/&gt; &lt;/prism:InteractionRequestTrigger&gt; &lt;/i:Interaction.Triggers&gt; &lt;UserControl.Resources&gt; &lt;DataTemplate x:Key="ConfirmWindowTemplate"&gt; &lt;Grid MinWidth="250" MinHeight="100"&gt; &lt;TextBlock TextWrapping="Wrap" Grid.Row="0" Text="{Binding}"/&gt; &lt;/Grid&gt; &lt;/DataTemplate&gt; &lt;/UserControl.Resources&gt;</code> <br> <b></b> <br>      <code>ContentTemplate</code> ,   UI   <code>Content</code>  .    <code>Content</code>  ,  , <code>TextBlock</code>     <code>Content</code> . <br>      ,     ,    ,    .  ,     ,       ,     ,    .   ,   <i>RI MVVM</i> ,         <code>Confirmed</code>    <code>Confirmation</code>  <code>true</code> ,     OK. <br> <br>        ,     .  Prism <code>InteractionRequestTrigger</code>   <code>PopupChildWindowAction</code>            . <br> <br>     <br>     MVVM,       , ,    ,         .        (  , ,  ,   ).    ,  ,  ,            . <br> <br>        ,         . Managed Extensibility Framework (MEF)  Unity Application Block (Unity)      ,  ,           . <br> <br>  ,       , , ,    ( )      . ,       ,     .  ,     ,       . <br> <br>     ,  MEF <br>  MEF,       ,   <code>Import</code> ,      ,  ,   <code>Export</code> .         ,    . <br> <br> , <code>QuestionnaireView</code>   <i>RI MVVM</i> ,        ,    <code>Import</code> .   , MEF           .  <code>set</code>        ,   . <br> <br> <code class="cs">[Import] public QuestionnaireViewModel ViewModel { set { this.DataContext = value; } }</code> <br>     ,   . <br> <br> <code class="cs">[Export] public class QuestionnaireViewModel : NotificationObject { ... }</code> <br>        ,   . <br> <br> <code class="cs">public QuestionnaireView() { InitializeComponent(); } [ImportingConstructor] public QuestionnaireView(QuestionnaireViewModel viewModel) : this() { this.DataContext = viewModel; }</code> <br> <b></b> <br>          MEF,   Unity.   ,     ,        .   ,   Visual Studio  Expression Blend, ,        ,     .   ,   ,  ,      ,          <code>InitializeComponent</code> . <br>     ,  Unity <br>  Unity,    ,   MEF.     ,      .    ,         .  ,      . <br> <br>  ,      ,  ,         . ,           ,   . <br> <br> <code class="cs">public QuestionnaireView() { InitializeComponent(); } public QuestionnaireView(QuestionnaireViewModel viewModel) : this() { this.DataContext = viewModel; }</code> <br> <b></b> <br>    ,        ,   Visual Studio  Expression Blend. <br>  ,          ,   . Unity        <code>set</code>   ,   . <br> <br> <code class="cs">public QuestionnaireView() { InitializeComponent(); } [Dependency] public QuestionnaireViewModel ViewModel { set { this.DataContext = value; } }</code> <br>       Unity. <br> <br> <code class="cs">container.RegisterType&lt;QuestionnaireViewModel&gt;();</code> <br>  ,     . <br> <br> <code class="cs">var view = container.Resolve&lt;QuestionnaireView&gt;();</code> <br>     ,    <br>   ,     ,        .        ,   MEF  Unity,        . <br> <br>          .   ,         UI,           . <br> <br> , <i>RI MVVM</i>   ,   ,        .   ,    .      <code>ShowView</code>   UI. <br> <br> <code class="cs">private void NavigateToQuestionnaireList() { //     "questionnaire list". this.uiService.ShowView(ViewNames.QuestionnaireTemplatesList); }</code> <br>  UI      UI .           UI.  <code>ShowView</code>  <code>UIService</code>      (,          ),       ,   . <br> <br> <code class="cs">public void ShowView(string viewName) { var view = this.ViewFactory.GetView(viewName); this.MainWindow.CurrentView = view; }</code> <br> <b></b> <br> Prism       .   ,   ,   ,             .    ,  , " <a href="http://msdn.microsoft.com/en-us/library/gg430861(v%3DPandP.40).aspx">View-Based Navigation</a> "   8, " <a href="http://msdn.microsoft.com/en-us/library/gg430861(v%3DPandP.40).aspx">Navigation</a> ". <br>  MVVM  <br>        MVVM      .           -      mocking . ,   ,        . <br> <br>   <i>INotifyPropertyChanged</i> <br>   <code>INotifyPropertyChanged</code>     ,      .      ,    ;   ,   ,     ,    ,       . <br> <br>   <br> ,       ,           <code>PropertyChanged</code>  ,         .  ,    <code>ChangeTracker</code> ,     MVVM,  ,      .      .     ,    . <br> <br> <code class="cs">var changeTracker = new PropertyChangeTracker(viewModel); viewModel.CurrentState = "newState"; CollectionAssert.Contains(changeTracker.ChangedProperties, "CurrentState");</code> <br> ,     ,     <code>INotifyPropertyChanged</code> ,    ,   ,     . <br> <br>      <br>        ,   ,    <code>set</code>      ,           . ,     ,     ,      ,          . <br> <br> <code class="cs">var changeTracker = new PropertyChangeTracker(viewModel); var question = viewModel.Questions.First() as OpenQuestionViewModel; question.Question.Response = "some text"; CollectionAssert.Contains(changeTracker.ChangedProperties, "UnansweredQuestions");</code> <br>      <br>     <code>INotifyPropertyChanged</code> ,      <code>PropertyChanged</code>        ,  ,     , , .        ,       . <br> <br>   <i>INotifyDataErrorInfo</i> <br>   ,     ,    ,   ,   <code>IDataErrorInfo</code> ,  ( Silverlight)   <code>INotifyDataErrorInfo</code> .   <code>INotifyDataErrorInfo</code>   ,         ,    ,  ,   ,    . <br> <br>       <code>INotifyDataErrorInfo</code> : ,     ,  ,     ,     <code>ErrorsChanged</code> ,      <code>GetErrors</code> , . <br> <br>    <br>     ,      ,     .       ,         <code>GetErrors</code>       ,  ,  ,   .    , ,  ,     ,        .   ,        . <br> <br> <code class="cs">//  . var notifyErrorInfo = (INotifyDataErrorInfo)question; question.Response = -15; Assert.IsTrue(notifyErrorInfo.GetErrors("Response").Cast&lt;ValidationResult&gt;().Any()); //  . var notifyErrorInfo = (INotifyDataErrorInfo)question; question.Response = 15; Assert.IsFalse(notifyErrorInfo.GetErrors("Response").Cast&lt;ValidationResult&gt;().Any());</code> <br>    ,    ,             . <br> <br>    <i>INotifyDataErrorInfo</i> <br>       <code>GetErrors</code> ,   <code>INotifyDataErrorInfo</code>  ,   <code>ErrorsChanged</code>      <code>GetErrors</code> . ,  <code>HasErrors</code>      ,  . <br> <br>       <code>INotifyDataErrorInfo</code> . , ,           ,   -  .      ,        <code>INotifyDataErrorInfo</code>         (,        ). <br> <br>     ,   ,  : <br>  <code>HasErrors</code>     .              ,       .  <code>ErrorsChanged</code> ,      ,         <code>GetErrors</code> .         ( ,  )     ,           .    <code>GetErrors</code>       <code>ErrorsChanged</code> . <br>    <code>INotifyPropertyChanged</code> ,  ,    <code>NotifyDataErrorInfoTestHelper</code>    MVVM,        <code>INotifyDataErrorInfo</code> ,       .   ,   ,      ,   .      . <br> <code class="cs">var helper = new NotifyDataErrorInfoTestHelper&lt;NumericQuestion, int?&gt;( question, q =&gt; q.Response); helper.ValidatePropertyChange( 6, NotifyDataErrorInfoBehavior.Nothing); helper.ValidatePropertyChange( 20, NotifyDataErrorInfoBehavior.FiresErrorsChanged | NotifyDataErrorInfoBehavior.HasErrors | NotifyDataErrorInfoBehavior.HasErrorsForProperty); helper.ValidatePropertyChange( null, NotifyDataErrorInfoBehavior.FiresErrorsChanged | NotifyDataErrorInfoBehavior.HasErrors | NotifyDataErrorInfoBehavior.HasErrorsForProperty); helper.ValidatePropertyChange( 2, NotifyDataErrorInfoBehavior.FiresErrorsChanged);</code> <br>     <br>   MVVM,     ,  .   ,    ,         . <br> <br>  ,     ,     ,       .   ,   , ,       ,     ,   <code>IAsyncResult</code>    ,  - ,   ,    UI. <br> <br>       , , ,    .   ,     .  ,      UI,     ,   ,          ,     ,        "   UI." <br> <br>     ,    ,    .   ,    ,     mock-, ,   ,   ,      ,          . <br> <br>           UI,    ,    .   ,     ,   ,      .        ,   .     ,    ,     . <br> <br> <code class="cs">questionnaireRepositoryMock .Setup( r =&gt; r.SubmitQuestionnaireAsync( It.IsAny&lt;Questionnaire&gt;(), It.IsAny&lt;Action&lt;IOperationResult&gt;&gt;())) .Callback&lt;Questionnaire, Action&lt;IOperationResult&gt;&gt;( (q, a) =&gt; callback = a); uiServicemock .Setup(svc =&gt; svc.ShowView(ViewNames.QuestionnaireTemplatesList)) .Callback&lt;string&gt;(viewName =&gt; requestedViewName = viewName); submitResultMock .Setup(sr =&gt; sr.Error) .Returns&lt;Exception&gt;(null); CompleteQuestionnaire(viewModel); viewModel.Submit(); //      UI . callback(submitResultMock.Object); //    ‚Äì     . Assert.AreEqual(ViewNames.QuestionnaireTemplatesList, requestedViewName);</code> <br> <b></b> <br>          ,        . <br>   <br>       , . "Trees in WPF"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ms753391.aspx">http://msdn.microsoft.com/en-us/library/ms753391.aspx</a> <br> <br>       , . "Attached Properties Overview"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/cc265152(VS.95).aspx">http://msdn.microsoft.com/en-us/library/cc265152(VS.95).aspx</a> <br> <br>      MEF, ."Managed Extensibility Framework Overview"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/dd460648.aspx">http://msdn.microsoft.com/en-us/library/dd460648.aspx</a> . <br> <br>      Unity, ."Unity Application Block"  MSDN: <a href="http://www.msdn.com/unity">http://www.msdn.com/unity</a> . <br> <br>      <code>DelegateCommand</code> , .Chapter 5, " <a href="http://msdn.microsoft.com/en-us/library/gg405484(v%3DPandP.40).aspx">Implementing the MVVM Pattern</a> ." <br> <br>        Microsoft Expression Blend, ."Working with built-in behaviors"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ff724013(v%3DExpression.40).aspx">http://msdn.microsoft.com/en-us/library/ff724013(v=Expression.40).aspx</a> . <br> <br>          Microsoft Expression Blend, ."Creating Custom Behaviors"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ff724708(v%3DExpression.40).aspx">http://msdn.microsoft.com/en-us/library/ff724708(v=Expression.40).aspx</a> . <br> <br>            Microsoft Expression Blend, ."Creating Custom Triggers and Actions"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ff724707(v%3DExpression.40).aspx">http://msdn.microsoft.com/en-us/library/ff724707(v=Expression.40).aspx</a> . <br> <br>         WPF  Silverlight, ."Threading Model"  "The Dispatcher Class"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ms741870.aspx">http://msdn.microsoft.com/en-us/library/ms741870.aspx</a> <br> <a href="http://msdn.microsoft.com/en-us/library/ms615907(v%3DVS.95).aspx">http://msdn.microsoft.com/en-us/library/ms615907(v=VS.95).aspx</a> . <br> <br>      unit-  Silverlight, ."Unit Testing with Silverlight 2": <a href="http://www.jeff.wilcox.name/2008/03/silverlight2-unit-testing/">http://www.jeff.wilcox.name/2008/03/silverlight2-unit-testing/</a> . <br> <br>         , .  " <a href="http://msdn.microsoft.com/en-us/library/gg430861(v%3DPandP.40).aspx">View-Based Navigation</a> " in Chapter 8, " <a href="http://msdn.microsoft.com/en-us/library/gg430861(v%3DPandP.40).aspx">Navigation</a> ." <br> <br>       ,   , ."Event-based Asynchronous Pattern Overview"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/wewwczdw.aspx">http://msdn.microsoft.com/en-us/library/wewwczdw.aspx</a> <br> <br>        <code>IAsyncResult</code> , ."Asynchronous Programming Overview"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ms228963.aspx">http://msdn.microsoft.com/en-us/library/ms228963.aspx</a></code></code></code></code></code></code></code></code></code> <h3> <code><code><code><code><code><code><code><code><code><code>CommandBehaviorBase ,    ,    ICommand</code> .           <code>CanExecuteChanged</code> ,          Silverlight,    WPF. <br> <br>    ,  ,   <code>CommandBehaviorBase    ,    .         ,      .         ,    .      ButtonBaseClickCommandBehavior</code> . <br> <br> <code class="cs">public class ButtonBaseClickCommandBehavior : CommandBehaviorBase&lt;ButtonBase&gt; { public ButtonBaseClickCommandBehavior(ButtonBase clickableObject) : base(clickableObject) { clickableObject.Click += OnClick; } private void OnClick(object sender, System.Windows.RoutedEventArgs e) { ExecuteCommand(); } }</code> <br>   <code>CommandBehaviorBase ,     .     ,          ,   . ,    ,    ,      , ,    CanExecute</code>  ,     . <br> <br>          ,   .           XAML.           .       .  Prism      ,       ,  ,   .       ,    . , ,  ,      <code>Click</code> ,       <code>Command</code> .    <code>Click.Command</code> ,  . <br> <br>             .             . <br> <br> <code class="cs">public static readonly DependencyProperty CommandProperty = DependencyProperty.RegisterAttached( "Command", typeof(ICommand), typeof(Click), new PropertyMetadata(OnSetCommandCallback)); private static readonly DependencyProperty ClickCommandBehaviorProperty = DependencyProperty.RegisterAttached( "ClickCommandBehavior", typeof(ButtonBaseClickCommandBehavior), typeof(Click), null);</code> <br>    <code>Command</code>    <code>ButtonBaseClickCommandBehavior</code> ,     <code>OnSetCommandCallback</code> ,     . <br> <br> <code class="cs">private static void OnSetCommandCallback(DependencyObject dependencyObject, DependencyPropertyChangedEventArgs e) { ButtonBase buttonBase = dependencyObject as ButtonBase; if (buttonBase != null) { ButtonBaseClickCommandBehavior behavior = GetOrCreateBehavior(buttonBase); behavior.Command = e.NewValue as ICommand; } } private static void OnSetCommandParameterCallback(DependencyObject dependencyObject, DependencyPropertyChangedEventArgs e) { ButtonBase buttonBase = dependencyObject as ButtonBase; if (buttonBase != null) { ButtonBaseClickCommandBehavior behavior = GetOrCreateBehavior(buttonBase); behavior.CommandParameter = e.NewValue; } } private static ButtonBaseClickCommandBehavior GetOrCreateBehavior(ButtonBase buttonBase ) { ButtonBaseClickCommandBehavior behavior = buttonBase.GetValue(ClickCommandBehaviorProperty) as ButtonBaseClickCommandBehavior; if ( behavior == null ) { behavior = new ButtonBaseClickCommandBehavior(buttonBase); buttonBase.SetValue(ClickCommandBehaviorProperty, behavior); } return behavior; }</code> <br>        ,  <a href="http://msdn.microsoft.com/en-us/library/cc265152(VS.95).aspx">Attached Properties Overview</a>  MSDN. <br> <br>    <br>              . ,     Silverlight,    -,     ,      ,     .     ,       . <br> <br>        ,    ( )  ,  ,     .  UI       ,            UI. <br> <br>      - <br>   -     ,       <code>IAsyncResult</code> .   ,  ,   ,  <code>GetQuestionnaire</code> ,   : <code>BeginGetQuestionnaire</code>  <code>EndGetQuestionnaire</code> .    ,   <code>BeginGetQuestionnaire</code> .     ,   ,   <code>EndGetQuestionnaire</code>    . <br> <b></b> <br>  .NET Framework 4.5      <code>await</code>  <code>async</code>     <code>*Async</code> .      <a href="http://msdn.microsoft.com/en-us/library/vstudio/hh391443.aspx">"Asynchronous Programming with Async and Await (C# and Visual Basic)"</a> . <br>  ,    <code>EndGetQuestionnaire</code> ,      ,  ()      <code>BeginGetQuestionnaire</code> .     ,      ,   <code>EndGetQuestionnaire</code> ,   . <br> <br> <code class="xml">IAsyncResult asyncResult = this.service.BeginGetQuestionnaire( GetQuestionnaireCompleted, null //  ,      ); private void GetQuestionnaireCompleted(IAsyncResult result) { try { questionnaire = this.service.EndGetQuestionnaire(ar); } catch (Exception ex) { //  -   . } }</code> <br>  ,     <code>End*</code> (  , <code>EndGetQuestionnaire</code> ),    ,      .      , ,          UI.     ,   ,        . <br> <br>        UI,     -,      UI,         UI,   <code>Dispatcher</code>    <code>SynchronizationContext</code> .  WPF  Silverlight,   <code>Dispatcher</code> . <br> <br>      <code>Questionnaire</code>  ,        <code>QuestionnaireView</code> .  Silverlight    <code>CheckAccess</code> ,  ,      UI.  ,     <code>BeginInvoke</code> ,      UI. <br> <br> <code class="cs">var dispatcher = System.Windows.Deployment.Current.Dispatcher; if (dispatcher.CheckAccess()) { QuestionnaireView.DataContext = questionnaire; } else { dispatcher.BeginInvoke(() =&gt; { Questionnaire.DataContext = questionnaire; }); }</code> <br> <i>MVVM RI</i>   ,    ,   <code>IAsyncResult</code> ,   .      ,                 . ,       . <br> <br> <code class="cs">this.questionnaireRepository.GetQuestionnaireAsync( result =&gt; { this.Questionnaire = result.Result; });</code> <br>  <code>result</code>   ,     , , , .    ,     . <br> <br> <code class="cs">this.questionnaireRepository.GetQuestionnaireAsync( result =&gt; { if (result.Error == null) { this.Questionnaire = result.Result; ... } else { // Handle error. } })</code> <br>     <br>        ,      .     , ,             .        ,      ,     ,     . <br> <br>         ,      MVVM,     ,   . ,  -MVVM ,     <code>MessageBox</code>   code-behind UI,      .   MVVM     ,          . <br> <br>     MVVM,              ,          .      ,    ,   ,  ,     . <br> <br>              MVVM.      ,     ,     ,  ,     .    ,         ,     ,          .       . <br> <br>    <br>                  .        ,        .  ,         .         . <br> <br>  ,         ,         ,  .      ,     .           ,       . ,        WPF  Silverlight,        . <br> <br> <img title="Using the service to interact with the user." src="https://habrastorage.org/getpro/habr/post_images/4b5/397/f2d/4b5397f2d02e5851195b29f1893be6fc.png" alt=" ,    ."> <br> <br>  ,   <code>MessageBox</code>        ,     ,    ,     . <br> <br> <code class="cs">var result = interactionService.ShowMessageBox( "Are you sure you want to cancel this operation?", "Confirm", MessageBoxButton.OK); if (result == MessageBoxResult.Yes) { CancelRequest(); }</code> <br> ,      - ,      ,         Silverlight.         .             .     . <br> <br> <code class="cs">interactionService.ShowMessageBox( "Are you sure you want to cancel this operation?", "Confirm", MessageBoxButton.OK, result =&gt; { if (result == MessageBoxResult.Yes) { CancelRequest(); } });</code> <br>         ,      . ,  WPF    <code>MessageBox</code> ,       ;    Silverlight    ,    . <br> <br>     <br>         ‚Äì             .         ,      .     ,     .        ,        ,   ,     . <br> <br> <img title="Using interaction request objects." src="https://habrastorage.org/getpro/habr/post_images/3d0/ff0/1c5/3d0ff01c5518558c2d3c5c5f47ce0ce9.png" alt="   ."> <br> <br>    ,   ,          ‚Äì       ,      ,   ‚Äì     .   ,        ,    ,    UI            . <br> <br>       MVVM,     ,       ,         .         ,        ,    ,   . <br> <br>  Prism       <code>IInteractionRequest</code>   <code>InteractionRequest .  IInteractionRequest</code>  ,   .           ,   .  <code>InteractionRequest   IInteractionRequest</code>     <code>Raise</code> ,           , , ,   . <br> <br>       <br>  <code>InteractionRequest          .  Raise</code>          ( <code>T</code> )    ,    ,   .          ,       .      ,        .    ,  ,     . <br> <code class="cs">public interface IInteractionRequest { event EventHandler&lt;InteractionRequestedEventArgs&gt; Raised; } public class InteractionRequest&lt;T&gt; : IInteractionRequest { public event EventHandler&lt;InteractionRequestedEventArgs&gt; Raised; public void Raise(T context, Action&lt;T&gt; callback) { var handler = this.Raised; if (handler != null) { handler( this, new InteractionRequestedEventArgs(context, () =&gt; callback(context))); } } }</code> <br> Prism    ,      .  <code>Notification</code>       .    ,            .     ‚Äì <code>Title</code>  <code>Content</code> ,    .  ,   ,  ,  ,        . <br> <br>  <code>Confirmation</code>    <code>Notification</code>     ‚Äì <code>Confirmed</code> ,  ,  ,      .  <code>Confirmation</code> ,     <code>MessageBox</code> ,     /  .     ,     <code>Notification</code> ,     ,      . <br> <br>    <code>InteractionRequest ,       InteractionRequest      ,      .      ,    Raise</code> ,    , ,   . <br> <br> <code class="cs">public IInteractionRequest ConfirmCancelInteractionRequest { get { return this.confirmCancelInteractionRequest; } } this.confirmCancelInteractionRequest.Raise( new Confirmation("Are you sure you wish to cancel?"), confirmation =&gt; { if (confirmation.Confirmed) { this.NavigateToQuestionnaireList(); } }); }</code> <br> <i>MVVM Reference Implementation (MVVM RI)</i> ,    <code>IInteractionRequest</code>   <code>InteractionRequest ,          (. QuestionnaireViewModel.cs</code> ). <br> <br>        <br>       ,       .   ,       .    UI             . <br> <br>                . Microsoft Expression Blend Behaviors Framework     .  ,     ,    . <br> <br>  <code>EventTrigger</code> ,  Expression Blend,  ,      ,     ,   . , Prism   <code>EventTrigger</code> ,  <code>InteractionRequestTrigger</code> ,      <code>Raised</code>   <code>IInteractionRequest</code> .    XAML        . <br> <br>  ,   , <code>InteractionRequestTrigger</code>   .  Silverlight Prism   <code>PopupChildWindowAction</code> ,     .    ,         .   <code>ContentTemplate</code>  <code>PopupChildWindowAction</code> ,    ,    UI,      <code>Content</code>  .       <code>Title</code>  . <br> <b></b> <br>  ,    ,   <code>PopupChildWindowAction</code> ,     .    <code>Notification</code>  <code>NotificationChildWindow</code> ,        <code>Confirmation</code> ‚Äì <code>ConfirmationChildWindow</code> . <code>NotificationChildWindow</code>    ,   ,     <code>ConfirmationChildWindow</code>    <i>OK</i>  <i>Cancel</i> ,    .    ,   ,   <code>ChildWindow</code>  <code>PopupChildWindowAction</code> . <br>   ,  <code>InteractionRequestTrigger</code>  <code>PopupChildWindowAction</code> ,       <i>RI MVVM</i> . <br> <br> <code class="xml">&lt;i:Interaction.Triggers&gt; &lt;prism:InteractionRequestTrigger SourceObject="{Binding ConfirmCancelInteractionRequest}"&gt; &lt;prism:PopupChildWindowAction ContentTemplate="{StaticResource ConfirmWindowTemplate}"/&gt; &lt;/prism:InteractionRequestTrigger&gt; &lt;/i:Interaction.Triggers&gt; &lt;UserControl.Resources&gt; &lt;DataTemplate x:Key="ConfirmWindowTemplate"&gt; &lt;Grid MinWidth="250" MinHeight="100"&gt; &lt;TextBlock TextWrapping="Wrap" Grid.Row="0" Text="{Binding}"/&gt; &lt;/Grid&gt; &lt;/DataTemplate&gt; &lt;/UserControl.Resources&gt;</code> <br> <b></b> <br>      <code>ContentTemplate</code> ,   UI   <code>Content</code>  .    <code>Content</code>  ,  , <code>TextBlock</code>     <code>Content</code> . <br>      ,     ,    ,    .  ,     ,       ,     ,    .   ,   <i>RI MVVM</i> ,         <code>Confirmed</code>    <code>Confirmation</code>  <code>true</code> ,     OK. <br> <br>        ,     .  Prism <code>InteractionRequestTrigger</code>   <code>PopupChildWindowAction</code>            . <br> <br>     <br>     MVVM,       , ,    ,         .        (  , ,  ,   ).    ,  ,  ,            . <br> <br>        ,         . Managed Extensibility Framework (MEF)  Unity Application Block (Unity)      ,  ,           . <br> <br>  ,       , , ,    ( )      . ,       ,     .  ,     ,       . <br> <br>     ,  MEF <br>  MEF,       ,   <code>Import</code> ,      ,  ,   <code>Export</code> .         ,    . <br> <br> , <code>QuestionnaireView</code>   <i>RI MVVM</i> ,        ,    <code>Import</code> .   , MEF           .  <code>set</code>        ,   . <br> <br> <code class="cs">[Import] public QuestionnaireViewModel ViewModel { set { this.DataContext = value; } }</code> <br>     ,   . <br> <br> <code class="cs">[Export] public class QuestionnaireViewModel : NotificationObject { ... }</code> <br>        ,   . <br> <br> <code class="cs">public QuestionnaireView() { InitializeComponent(); } [ImportingConstructor] public QuestionnaireView(QuestionnaireViewModel viewModel) : this() { this.DataContext = viewModel; }</code> <br> <b></b> <br>          MEF,   Unity.   ,     ,        .   ,   Visual Studio  Expression Blend, ,        ,     .   ,   ,  ,      ,          <code>InitializeComponent</code> . <br>     ,  Unity <br>  Unity,    ,   MEF.     ,      .    ,         .  ,      . <br> <br>  ,      ,  ,         . ,           ,   . <br> <br> <code class="cs">public QuestionnaireView() { InitializeComponent(); } public QuestionnaireView(QuestionnaireViewModel viewModel) : this() { this.DataContext = viewModel; }</code> <br> <b></b> <br>    ,        ,   Visual Studio  Expression Blend. <br>  ,          ,   . Unity        <code>set</code>   ,   . <br> <br> <code class="cs">public QuestionnaireView() { InitializeComponent(); } [Dependency] public QuestionnaireViewModel ViewModel { set { this.DataContext = value; } }</code> <br>       Unity. <br> <br> <code class="cs">container.RegisterType&lt;QuestionnaireViewModel&gt;();</code> <br>  ,     . <br> <br> <code class="cs">var view = container.Resolve&lt;QuestionnaireView&gt;();</code> <br>     ,    <br>   ,     ,        .        ,   MEF  Unity,        . <br> <br>          .   ,         UI,           . <br> <br> , <i>RI MVVM</i>   ,   ,        .   ,    .      <code>ShowView</code>   UI. <br> <br> <code class="cs">private void NavigateToQuestionnaireList() { //     "questionnaire list". this.uiService.ShowView(ViewNames.QuestionnaireTemplatesList); }</code> <br>  UI      UI .           UI.  <code>ShowView</code>  <code>UIService</code>      (,          ),       ,   . <br> <br> <code class="cs">public void ShowView(string viewName) { var view = this.ViewFactory.GetView(viewName); this.MainWindow.CurrentView = view; }</code> <br> <b></b> <br> Prism       .   ,   ,   ,             .    ,  , " <a href="http://msdn.microsoft.com/en-us/library/gg430861(v%3DPandP.40).aspx">View-Based Navigation</a> "   8, " <a href="http://msdn.microsoft.com/en-us/library/gg430861(v%3DPandP.40).aspx">Navigation</a> ". <br>  MVVM  <br>        MVVM      .           -      mocking . ,   ,        . <br> <br>   <i>INotifyPropertyChanged</i> <br>   <code>INotifyPropertyChanged</code>     ,      .      ,    ;   ,   ,     ,    ,       . <br> <br>   <br> ,       ,           <code>PropertyChanged</code>  ,         .  ,    <code>ChangeTracker</code> ,     MVVM,  ,      .      .     ,    . <br> <br> <code class="cs">var changeTracker = new PropertyChangeTracker(viewModel); viewModel.CurrentState = "newState"; CollectionAssert.Contains(changeTracker.ChangedProperties, "CurrentState");</code> <br> ,     ,     <code>INotifyPropertyChanged</code> ,    ,   ,     . <br> <br>      <br>        ,   ,    <code>set</code>      ,           . ,     ,     ,      ,          . <br> <br> <code class="cs">var changeTracker = new PropertyChangeTracker(viewModel); var question = viewModel.Questions.First() as OpenQuestionViewModel; question.Question.Response = "some text"; CollectionAssert.Contains(changeTracker.ChangedProperties, "UnansweredQuestions");</code> <br>      <br>     <code>INotifyPropertyChanged</code> ,      <code>PropertyChanged</code>        ,  ,     , , .        ,       . <br> <br>   <i>INotifyDataErrorInfo</i> <br>   ,     ,    ,   ,   <code>IDataErrorInfo</code> ,  ( Silverlight)   <code>INotifyDataErrorInfo</code> .   <code>INotifyDataErrorInfo</code>   ,         ,    ,  ,   ,    . <br> <br>       <code>INotifyDataErrorInfo</code> : ,     ,  ,     ,     <code>ErrorsChanged</code> ,      <code>GetErrors</code> , . <br> <br>    <br>     ,      ,     .       ,         <code>GetErrors</code>       ,  ,  ,   .    , ,  ,     ,        .   ,        . <br> <br> <code class="cs">//  . var notifyErrorInfo = (INotifyDataErrorInfo)question; question.Response = -15; Assert.IsTrue(notifyErrorInfo.GetErrors("Response").Cast&lt;ValidationResult&gt;().Any()); //  . var notifyErrorInfo = (INotifyDataErrorInfo)question; question.Response = 15; Assert.IsFalse(notifyErrorInfo.GetErrors("Response").Cast&lt;ValidationResult&gt;().Any());</code> <br>    ,    ,             . <br> <br>    <i>INotifyDataErrorInfo</i> <br>       <code>GetErrors</code> ,   <code>INotifyDataErrorInfo</code>  ,   <code>ErrorsChanged</code>      <code>GetErrors</code> . ,  <code>HasErrors</code>      ,  . <br> <br>       <code>INotifyDataErrorInfo</code> . , ,           ,   -  .      ,        <code>INotifyDataErrorInfo</code>         (,        ). <br> <br>     ,   ,  : <br>  <code>HasErrors</code>     .              ,       .  <code>ErrorsChanged</code> ,      ,         <code>GetErrors</code> .         ( ,  )     ,           .    <code>GetErrors</code>       <code>ErrorsChanged</code> . <br>    <code>INotifyPropertyChanged</code> ,  ,    <code>NotifyDataErrorInfoTestHelper</code>    MVVM,        <code>INotifyDataErrorInfo</code> ,       .   ,   ,      ,   .      . <br> <code class="cs">var helper = new NotifyDataErrorInfoTestHelper&lt;NumericQuestion, int?&gt;( question, q =&gt; q.Response); helper.ValidatePropertyChange( 6, NotifyDataErrorInfoBehavior.Nothing); helper.ValidatePropertyChange( 20, NotifyDataErrorInfoBehavior.FiresErrorsChanged | NotifyDataErrorInfoBehavior.HasErrors | NotifyDataErrorInfoBehavior.HasErrorsForProperty); helper.ValidatePropertyChange( null, NotifyDataErrorInfoBehavior.FiresErrorsChanged | NotifyDataErrorInfoBehavior.HasErrors | NotifyDataErrorInfoBehavior.HasErrorsForProperty); helper.ValidatePropertyChange( 2, NotifyDataErrorInfoBehavior.FiresErrorsChanged);</code> <br>     <br>   MVVM,     ,  .   ,    ,         . <br> <br>  ,     ,     ,       .   ,   , ,       ,     ,   <code>IAsyncResult</code>    ,  - ,   ,    UI. <br> <br>       , , ,    .   ,     .  ,      UI,     ,   ,          ,     ,        "   UI." <br> <br>     ,    ,    .   ,    ,     mock-, ,   ,   ,      ,          . <br> <br>           UI,    ,    .   ,     ,   ,      .        ,   .     ,    ,     . <br> <br> <code class="cs">questionnaireRepositoryMock .Setup( r =&gt; r.SubmitQuestionnaireAsync( It.IsAny&lt;Questionnaire&gt;(), It.IsAny&lt;Action&lt;IOperationResult&gt;&gt;())) .Callback&lt;Questionnaire, Action&lt;IOperationResult&gt;&gt;( (q, a) =&gt; callback = a); uiServicemock .Setup(svc =&gt; svc.ShowView(ViewNames.QuestionnaireTemplatesList)) .Callback&lt;string&gt;(viewName =&gt; requestedViewName = viewName); submitResultMock .Setup(sr =&gt; sr.Error) .Returns&lt;Exception&gt;(null); CompleteQuestionnaire(viewModel); viewModel.Submit(); //      UI . callback(submitResultMock.Object); //    ‚Äì     . Assert.AreEqual(ViewNames.QuestionnaireTemplatesList, requestedViewName);</code> <br> <b></b> <br>          ,        . <br>   <br>       , . "Trees in WPF"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ms753391.aspx">http://msdn.microsoft.com/en-us/library/ms753391.aspx</a> <br> <br>       , . "Attached Properties Overview"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/cc265152(VS.95).aspx">http://msdn.microsoft.com/en-us/library/cc265152(VS.95).aspx</a> <br> <br>      MEF, ."Managed Extensibility Framework Overview"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/dd460648.aspx">http://msdn.microsoft.com/en-us/library/dd460648.aspx</a> . <br> <br>      Unity, ."Unity Application Block"  MSDN: <a href="http://www.msdn.com/unity">http://www.msdn.com/unity</a> . <br> <br>      <code>DelegateCommand</code> , .Chapter 5, " <a href="http://msdn.microsoft.com/en-us/library/gg405484(v%3DPandP.40).aspx">Implementing the MVVM Pattern</a> ." <br> <br>        Microsoft Expression Blend, ."Working with built-in behaviors"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ff724013(v%3DExpression.40).aspx">http://msdn.microsoft.com/en-us/library/ff724013(v=Expression.40).aspx</a> . <br> <br>          Microsoft Expression Blend, ."Creating Custom Behaviors"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ff724708(v%3DExpression.40).aspx">http://msdn.microsoft.com/en-us/library/ff724708(v=Expression.40).aspx</a> . <br> <br>            Microsoft Expression Blend, ."Creating Custom Triggers and Actions"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ff724707(v%3DExpression.40).aspx">http://msdn.microsoft.com/en-us/library/ff724707(v=Expression.40).aspx</a> . <br> <br>         WPF  Silverlight, ."Threading Model"  "The Dispatcher Class"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ms741870.aspx">http://msdn.microsoft.com/en-us/library/ms741870.aspx</a> <br> <a href="http://msdn.microsoft.com/en-us/library/ms615907(v%3DVS.95).aspx">http://msdn.microsoft.com/en-us/library/ms615907(v=VS.95).aspx</a> . <br> <br>      unit-  Silverlight, ."Unit Testing with Silverlight 2": <a href="http://www.jeff.wilcox.name/2008/03/silverlight2-unit-testing/">http://www.jeff.wilcox.name/2008/03/silverlight2-unit-testing/</a> . <br> <br>         , .  " <a href="http://msdn.microsoft.com/en-us/library/gg430861(v%3DPandP.40).aspx">View-Based Navigation</a> " in Chapter 8, " <a href="http://msdn.microsoft.com/en-us/library/gg430861(v%3DPandP.40).aspx">Navigation</a> ." <br> <br>       ,   , ."Event-based Asynchronous Pattern Overview"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/wewwczdw.aspx">http://msdn.microsoft.com/en-us/library/wewwczdw.aspx</a> <br> <br>        <code>IAsyncResult</code> , ."Asynchronous Programming Overview"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ms228963.aspx">http://msdn.microsoft.com/en-us/library/ms228963.aspx</a></code></code></code></code></code></code></code></code></code> </h3> <code><code><code><code><code><code><code><code><code><code>CommandBehaviorBase ,    ,    ICommand</code> .           <code>CanExecuteChanged</code> ,          Silverlight,    WPF. <br> <br>    ,  ,   <code>CommandBehaviorBase    ,    .         ,      .         ,    .      ButtonBaseClickCommandBehavior</code> . <br> <br> <code class="cs">public class ButtonBaseClickCommandBehavior : CommandBehaviorBase&lt;ButtonBase&gt; { public ButtonBaseClickCommandBehavior(ButtonBase clickableObject) : base(clickableObject) { clickableObject.Click += OnClick; } private void OnClick(object sender, System.Windows.RoutedEventArgs e) { ExecuteCommand(); } }</code> <br>   <code>CommandBehaviorBase ,     .     ,          ,   . ,    ,    ,      , ,    CanExecute</code>  ,     . <br> <br>          ,   .           XAML.           .       .  Prism      ,       ,  ,   .       ,    . , ,  ,      <code>Click</code> ,       <code>Command</code> .    <code>Click.Command</code> ,  . <br> <br>             .             . <br> <br> <code class="cs">public static readonly DependencyProperty CommandProperty = DependencyProperty.RegisterAttached( "Command", typeof(ICommand), typeof(Click), new PropertyMetadata(OnSetCommandCallback)); private static readonly DependencyProperty ClickCommandBehaviorProperty = DependencyProperty.RegisterAttached( "ClickCommandBehavior", typeof(ButtonBaseClickCommandBehavior), typeof(Click), null);</code> <br>    <code>Command</code>    <code>ButtonBaseClickCommandBehavior</code> ,     <code>OnSetCommandCallback</code> ,     . <br> <br> <code class="cs">private static void OnSetCommandCallback(DependencyObject dependencyObject, DependencyPropertyChangedEventArgs e) { ButtonBase buttonBase = dependencyObject as ButtonBase; if (buttonBase != null) { ButtonBaseClickCommandBehavior behavior = GetOrCreateBehavior(buttonBase); behavior.Command = e.NewValue as ICommand; } } private static void OnSetCommandParameterCallback(DependencyObject dependencyObject, DependencyPropertyChangedEventArgs e) { ButtonBase buttonBase = dependencyObject as ButtonBase; if (buttonBase != null) { ButtonBaseClickCommandBehavior behavior = GetOrCreateBehavior(buttonBase); behavior.CommandParameter = e.NewValue; } } private static ButtonBaseClickCommandBehavior GetOrCreateBehavior(ButtonBase buttonBase ) { ButtonBaseClickCommandBehavior behavior = buttonBase.GetValue(ClickCommandBehaviorProperty) as ButtonBaseClickCommandBehavior; if ( behavior == null ) { behavior = new ButtonBaseClickCommandBehavior(buttonBase); buttonBase.SetValue(ClickCommandBehaviorProperty, behavior); } return behavior; }</code> <br>        ,  <a href="http://msdn.microsoft.com/en-us/library/cc265152(VS.95).aspx">Attached Properties Overview</a>  MSDN. <br> <br>    <br>              . ,     Silverlight,    -,     ,      ,     .     ,       . <br> <br>        ,    ( )  ,  ,     .  UI       ,            UI. <br> <br>      - <br>   -     ,       <code>IAsyncResult</code> .   ,  ,   ,  <code>GetQuestionnaire</code> ,   : <code>BeginGetQuestionnaire</code>  <code>EndGetQuestionnaire</code> .    ,   <code>BeginGetQuestionnaire</code> .     ,   ,   <code>EndGetQuestionnaire</code>    . <br> <b></b> <br>  .NET Framework 4.5      <code>await</code>  <code>async</code>     <code>*Async</code> .      <a href="http://msdn.microsoft.com/en-us/library/vstudio/hh391443.aspx">"Asynchronous Programming with Async and Await (C# and Visual Basic)"</a> . <br>  ,    <code>EndGetQuestionnaire</code> ,      ,  ()      <code>BeginGetQuestionnaire</code> .     ,      ,   <code>EndGetQuestionnaire</code> ,   . <br> <br> <code class="xml">IAsyncResult asyncResult = this.service.BeginGetQuestionnaire( GetQuestionnaireCompleted, null //  ,      ); private void GetQuestionnaireCompleted(IAsyncResult result) { try { questionnaire = this.service.EndGetQuestionnaire(ar); } catch (Exception ex) { //  -   . } }</code> <br>  ,     <code>End*</code> (  , <code>EndGetQuestionnaire</code> ),    ,      .      , ,          UI.     ,   ,        . <br> <br>        UI,     -,      UI,         UI,   <code>Dispatcher</code>    <code>SynchronizationContext</code> .  WPF  Silverlight,   <code>Dispatcher</code> . <br> <br>      <code>Questionnaire</code>  ,        <code>QuestionnaireView</code> .  Silverlight    <code>CheckAccess</code> ,  ,      UI.  ,     <code>BeginInvoke</code> ,      UI. <br> <br> <code class="cs">var dispatcher = System.Windows.Deployment.Current.Dispatcher; if (dispatcher.CheckAccess()) { QuestionnaireView.DataContext = questionnaire; } else { dispatcher.BeginInvoke(() =&gt; { Questionnaire.DataContext = questionnaire; }); }</code> <br> <i>MVVM RI</i>   ,    ,   <code>IAsyncResult</code> ,   .      ,                 . ,       . <br> <br> <code class="cs">this.questionnaireRepository.GetQuestionnaireAsync( result =&gt; { this.Questionnaire = result.Result; });</code> <br>  <code>result</code>   ,     , , , .    ,     . <br> <br> <code class="cs">this.questionnaireRepository.GetQuestionnaireAsync( result =&gt; { if (result.Error == null) { this.Questionnaire = result.Result; ... } else { // Handle error. } })</code> <br>     <br>        ,      .     , ,             .        ,      ,     ,     . <br> <br>         ,      MVVM,     ,   . ,  -MVVM ,     <code>MessageBox</code>   code-behind UI,      .   MVVM     ,          . <br> <br>     MVVM,              ,          .      ,    ,   ,  ,     . <br> <br>              MVVM.      ,     ,     ,  ,     .    ,         ,     ,          .       . <br> <br>    <br>                  .        ,        .  ,         .         . <br> <br>  ,         ,         ,  .      ,     .           ,       . ,        WPF  Silverlight,        . <br> <br> <img title="Using the service to interact with the user." src="https://habrastorage.org/getpro/habr/post_images/4b5/397/f2d/4b5397f2d02e5851195b29f1893be6fc.png" alt=" ,    ."> <br> <br>  ,   <code>MessageBox</code>        ,     ,    ,     . <br> <br> <code class="cs">var result = interactionService.ShowMessageBox( "Are you sure you want to cancel this operation?", "Confirm", MessageBoxButton.OK); if (result == MessageBoxResult.Yes) { CancelRequest(); }</code> <br> ,      - ,      ,         Silverlight.         .             .     . <br> <br> <code class="cs">interactionService.ShowMessageBox( "Are you sure you want to cancel this operation?", "Confirm", MessageBoxButton.OK, result =&gt; { if (result == MessageBoxResult.Yes) { CancelRequest(); } });</code> <br>         ,      . ,  WPF    <code>MessageBox</code> ,       ;    Silverlight    ,    . <br> <br>     <br>         ‚Äì             .         ,      .     ,     .        ,        ,   ,     . <br> <br> <img title="Using interaction request objects." src="https://habrastorage.org/getpro/habr/post_images/3d0/ff0/1c5/3d0ff01c5518558c2d3c5c5f47ce0ce9.png" alt="   ."> <br> <br>    ,   ,          ‚Äì       ,      ,   ‚Äì     .   ,        ,    ,    UI            . <br> <br>       MVVM,     ,       ,         .         ,        ,    ,   . <br> <br>  Prism       <code>IInteractionRequest</code>   <code>InteractionRequest .  IInteractionRequest</code>  ,   .           ,   .  <code>InteractionRequest   IInteractionRequest</code>     <code>Raise</code> ,           , , ,   . <br> <br>       <br>  <code>InteractionRequest          .  Raise</code>          ( <code>T</code> )    ,    ,   .          ,       .      ,        .    ,  ,     . <br> <code class="cs">public interface IInteractionRequest { event EventHandler&lt;InteractionRequestedEventArgs&gt; Raised; } public class InteractionRequest&lt;T&gt; : IInteractionRequest { public event EventHandler&lt;InteractionRequestedEventArgs&gt; Raised; public void Raise(T context, Action&lt;T&gt; callback) { var handler = this.Raised; if (handler != null) { handler( this, new InteractionRequestedEventArgs(context, () =&gt; callback(context))); } } }</code> <br> Prism    ,      .  <code>Notification</code>       .    ,            .     ‚Äì <code>Title</code>  <code>Content</code> ,    .  ,   ,  ,  ,        . <br> <br>  <code>Confirmation</code>    <code>Notification</code>     ‚Äì <code>Confirmed</code> ,  ,  ,      .  <code>Confirmation</code> ,     <code>MessageBox</code> ,     /  .     ,     <code>Notification</code> ,     ,      . <br> <br>    <code>InteractionRequest ,       InteractionRequest      ,      .      ,    Raise</code> ,    , ,   . <br> <br> <code class="cs">public IInteractionRequest ConfirmCancelInteractionRequest { get { return this.confirmCancelInteractionRequest; } } this.confirmCancelInteractionRequest.Raise( new Confirmation("Are you sure you wish to cancel?"), confirmation =&gt; { if (confirmation.Confirmed) { this.NavigateToQuestionnaireList(); } }); }</code> <br> <i>MVVM Reference Implementation (MVVM RI)</i> ,    <code>IInteractionRequest</code>   <code>InteractionRequest ,          (. QuestionnaireViewModel.cs</code> ). <br> <br>        <br>       ,       .   ,       .    UI             . <br> <br>                . Microsoft Expression Blend Behaviors Framework     .  ,     ,    . <br> <br>  <code>EventTrigger</code> ,  Expression Blend,  ,      ,     ,   . , Prism   <code>EventTrigger</code> ,  <code>InteractionRequestTrigger</code> ,      <code>Raised</code>   <code>IInteractionRequest</code> .    XAML        . <br> <br>  ,   , <code>InteractionRequestTrigger</code>   .  Silverlight Prism   <code>PopupChildWindowAction</code> ,     .    ,         .   <code>ContentTemplate</code>  <code>PopupChildWindowAction</code> ,    ,    UI,      <code>Content</code>  .       <code>Title</code>  . <br> <b></b> <br>  ,    ,   <code>PopupChildWindowAction</code> ,     .    <code>Notification</code>  <code>NotificationChildWindow</code> ,        <code>Confirmation</code> ‚Äì <code>ConfirmationChildWindow</code> . <code>NotificationChildWindow</code>    ,   ,     <code>ConfirmationChildWindow</code>    <i>OK</i>  <i>Cancel</i> ,    .    ,   ,   <code>ChildWindow</code>  <code>PopupChildWindowAction</code> . <br>   ,  <code>InteractionRequestTrigger</code>  <code>PopupChildWindowAction</code> ,       <i>RI MVVM</i> . <br> <br> <code class="xml">&lt;i:Interaction.Triggers&gt; &lt;prism:InteractionRequestTrigger SourceObject="{Binding ConfirmCancelInteractionRequest}"&gt; &lt;prism:PopupChildWindowAction ContentTemplate="{StaticResource ConfirmWindowTemplate}"/&gt; &lt;/prism:InteractionRequestTrigger&gt; &lt;/i:Interaction.Triggers&gt; &lt;UserControl.Resources&gt; &lt;DataTemplate x:Key="ConfirmWindowTemplate"&gt; &lt;Grid MinWidth="250" MinHeight="100"&gt; &lt;TextBlock TextWrapping="Wrap" Grid.Row="0" Text="{Binding}"/&gt; &lt;/Grid&gt; &lt;/DataTemplate&gt; &lt;/UserControl.Resources&gt;</code> <br> <b></b> <br>      <code>ContentTemplate</code> ,   UI   <code>Content</code>  .    <code>Content</code>  ,  , <code>TextBlock</code>     <code>Content</code> . <br>      ,     ,    ,    .  ,     ,       ,     ,    .   ,   <i>RI MVVM</i> ,         <code>Confirmed</code>    <code>Confirmation</code>  <code>true</code> ,     OK. <br> <br>        ,     .  Prism <code>InteractionRequestTrigger</code>   <code>PopupChildWindowAction</code>            . <br> <br>     <br>     MVVM,       , ,    ,         .        (  , ,  ,   ).    ,  ,  ,            . <br> <br>        ,         . Managed Extensibility Framework (MEF)  Unity Application Block (Unity)      ,  ,           . <br> <br>  ,       , , ,    ( )      . ,       ,     .  ,     ,       . <br> <br>     ,  MEF <br>  MEF,       ,   <code>Import</code> ,      ,  ,   <code>Export</code> .         ,    . <br> <br> , <code>QuestionnaireView</code>   <i>RI MVVM</i> ,        ,    <code>Import</code> .   , MEF           .  <code>set</code>        ,   . <br> <br> <code class="cs">[Import] public QuestionnaireViewModel ViewModel { set { this.DataContext = value; } }</code> <br>     ,   . <br> <br> <code class="cs">[Export] public class QuestionnaireViewModel : NotificationObject { ... }</code> <br>        ,   . <br> <br> <code class="cs">public QuestionnaireView() { InitializeComponent(); } [ImportingConstructor] public QuestionnaireView(QuestionnaireViewModel viewModel) : this() { this.DataContext = viewModel; }</code> <br> <b></b> <br>          MEF,   Unity.   ,     ,        .   ,   Visual Studio  Expression Blend, ,        ,     .   ,   ,  ,      ,          <code>InitializeComponent</code> . <br>     ,  Unity <br>  Unity,    ,   MEF.     ,      .    ,         .  ,      . <br> <br>  ,      ,  ,         . ,           ,   . <br> <br> <code class="cs">public QuestionnaireView() { InitializeComponent(); } public QuestionnaireView(QuestionnaireViewModel viewModel) : this() { this.DataContext = viewModel; }</code> <br> <b></b> <br>    ,        ,   Visual Studio  Expression Blend. <br>  ,          ,   . Unity        <code>set</code>   ,   . <br> <br> <code class="cs">public QuestionnaireView() { InitializeComponent(); } [Dependency] public QuestionnaireViewModel ViewModel { set { this.DataContext = value; } }</code> <br>       Unity. <br> <br> <code class="cs">container.RegisterType&lt;QuestionnaireViewModel&gt;();</code> <br>  ,     . <br> <br> <code class="cs">var view = container.Resolve&lt;QuestionnaireView&gt;();</code> <br>     ,    <br>   ,     ,        .        ,   MEF  Unity,        . <br> <br>          .   ,         UI,           . <br> <br> , <i>RI MVVM</i>   ,   ,        .   ,    .      <code>ShowView</code>   UI. <br> <br> <code class="cs">private void NavigateToQuestionnaireList() { //     "questionnaire list". this.uiService.ShowView(ViewNames.QuestionnaireTemplatesList); }</code> <br>  UI      UI .           UI.  <code>ShowView</code>  <code>UIService</code>      (,          ),       ,   . <br> <br> <code class="cs">public void ShowView(string viewName) { var view = this.ViewFactory.GetView(viewName); this.MainWindow.CurrentView = view; }</code> <br> <b></b> <br> Prism       .   ,   ,   ,             .    ,  , " <a href="http://msdn.microsoft.com/en-us/library/gg430861(v%3DPandP.40).aspx">View-Based Navigation</a> "   8, " <a href="http://msdn.microsoft.com/en-us/library/gg430861(v%3DPandP.40).aspx">Navigation</a> ". <br>  MVVM  <br>        MVVM      .           -      mocking . ,   ,        . <br> <br>   <i>INotifyPropertyChanged</i> <br>   <code>INotifyPropertyChanged</code>     ,      .      ,    ;   ,   ,     ,    ,       . <br> <br>   <br> ,       ,           <code>PropertyChanged</code>  ,         .  ,    <code>ChangeTracker</code> ,     MVVM,  ,      .      .     ,    . <br> <br> <code class="cs">var changeTracker = new PropertyChangeTracker(viewModel); viewModel.CurrentState = "newState"; CollectionAssert.Contains(changeTracker.ChangedProperties, "CurrentState");</code> <br> ,     ,     <code>INotifyPropertyChanged</code> ,    ,   ,     . <br> <br>      <br>        ,   ,    <code>set</code>      ,           . ,     ,     ,      ,          . <br> <br> <code class="cs">var changeTracker = new PropertyChangeTracker(viewModel); var question = viewModel.Questions.First() as OpenQuestionViewModel; question.Question.Response = "some text"; CollectionAssert.Contains(changeTracker.ChangedProperties, "UnansweredQuestions");</code> <br>      <br>     <code>INotifyPropertyChanged</code> ,      <code>PropertyChanged</code>        ,  ,     , , .        ,       . <br> <br>   <i>INotifyDataErrorInfo</i> <br>   ,     ,    ,   ,   <code>IDataErrorInfo</code> ,  ( Silverlight)   <code>INotifyDataErrorInfo</code> .   <code>INotifyDataErrorInfo</code>   ,         ,    ,  ,   ,    . <br> <br>       <code>INotifyDataErrorInfo</code> : ,     ,  ,     ,     <code>ErrorsChanged</code> ,      <code>GetErrors</code> , . <br> <br>    <br>     ,      ,     .       ,         <code>GetErrors</code>       ,  ,  ,   .    , ,  ,     ,        .   ,        . <br> <br> <code class="cs">//  . var notifyErrorInfo = (INotifyDataErrorInfo)question; question.Response = -15; Assert.IsTrue(notifyErrorInfo.GetErrors("Response").Cast&lt;ValidationResult&gt;().Any()); //  . var notifyErrorInfo = (INotifyDataErrorInfo)question; question.Response = 15; Assert.IsFalse(notifyErrorInfo.GetErrors("Response").Cast&lt;ValidationResult&gt;().Any());</code> <br>    ,    ,             . <br> <br>    <i>INotifyDataErrorInfo</i> <br>       <code>GetErrors</code> ,   <code>INotifyDataErrorInfo</code>  ,   <code>ErrorsChanged</code>      <code>GetErrors</code> . ,  <code>HasErrors</code>      ,  . <br> <br>       <code>INotifyDataErrorInfo</code> . , ,           ,   -  .      ,        <code>INotifyDataErrorInfo</code>         (,        ). <br> <br>     ,   ,  : <br>  <code>HasErrors</code>     .              ,       .  <code>ErrorsChanged</code> ,      ,         <code>GetErrors</code> .         ( ,  )     ,           .    <code>GetErrors</code>       <code>ErrorsChanged</code> . <br>    <code>INotifyPropertyChanged</code> ,  ,    <code>NotifyDataErrorInfoTestHelper</code>    MVVM,        <code>INotifyDataErrorInfo</code> ,       .   ,   ,      ,   .      . <br> <code class="cs">var helper = new NotifyDataErrorInfoTestHelper&lt;NumericQuestion, int?&gt;( question, q =&gt; q.Response); helper.ValidatePropertyChange( 6, NotifyDataErrorInfoBehavior.Nothing); helper.ValidatePropertyChange( 20, NotifyDataErrorInfoBehavior.FiresErrorsChanged | NotifyDataErrorInfoBehavior.HasErrors | NotifyDataErrorInfoBehavior.HasErrorsForProperty); helper.ValidatePropertyChange( null, NotifyDataErrorInfoBehavior.FiresErrorsChanged | NotifyDataErrorInfoBehavior.HasErrors | NotifyDataErrorInfoBehavior.HasErrorsForProperty); helper.ValidatePropertyChange( 2, NotifyDataErrorInfoBehavior.FiresErrorsChanged);</code> <br>     <br>   MVVM,     ,  .   ,    ,         . <br> <br>  ,     ,     ,       .   ,   , ,       ,     ,   <code>IAsyncResult</code>    ,  - ,   ,    UI. <br> <br>       , , ,    .   ,     .  ,      UI,     ,   ,          ,     ,        "   UI." <br> <br>     ,    ,    .   ,    ,     mock-, ,   ,   ,      ,          . <br> <br>           UI,    ,    .   ,     ,   ,      .        ,   .     ,    ,     . <br> <br> <code class="cs">questionnaireRepositoryMock .Setup( r =&gt; r.SubmitQuestionnaireAsync( It.IsAny&lt;Questionnaire&gt;(), It.IsAny&lt;Action&lt;IOperationResult&gt;&gt;())) .Callback&lt;Questionnaire, Action&lt;IOperationResult&gt;&gt;( (q, a) =&gt; callback = a); uiServicemock .Setup(svc =&gt; svc.ShowView(ViewNames.QuestionnaireTemplatesList)) .Callback&lt;string&gt;(viewName =&gt; requestedViewName = viewName); submitResultMock .Setup(sr =&gt; sr.Error) .Returns&lt;Exception&gt;(null); CompleteQuestionnaire(viewModel); viewModel.Submit(); //      UI . callback(submitResultMock.Object); //    ‚Äì     . Assert.AreEqual(ViewNames.QuestionnaireTemplatesList, requestedViewName);</code> <br> <b></b> <br>          ,        . <br>   <br>       , . "Trees in WPF"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ms753391.aspx">http://msdn.microsoft.com/en-us/library/ms753391.aspx</a> <br> <br>       , . "Attached Properties Overview"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/cc265152(VS.95).aspx">http://msdn.microsoft.com/en-us/library/cc265152(VS.95).aspx</a> <br> <br>      MEF, ."Managed Extensibility Framework Overview"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/dd460648.aspx">http://msdn.microsoft.com/en-us/library/dd460648.aspx</a> . <br> <br>      Unity, ."Unity Application Block"  MSDN: <a href="http://www.msdn.com/unity">http://www.msdn.com/unity</a> . <br> <br>      <code>DelegateCommand</code> , .Chapter 5, " <a href="http://msdn.microsoft.com/en-us/library/gg405484(v%3DPandP.40).aspx">Implementing the MVVM Pattern</a> ." <br> <br>        Microsoft Expression Blend, ."Working with built-in behaviors"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ff724013(v%3DExpression.40).aspx">http://msdn.microsoft.com/en-us/library/ff724013(v=Expression.40).aspx</a> . <br> <br>          Microsoft Expression Blend, ."Creating Custom Behaviors"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ff724708(v%3DExpression.40).aspx">http://msdn.microsoft.com/en-us/library/ff724708(v=Expression.40).aspx</a> . <br> <br>            Microsoft Expression Blend, ."Creating Custom Triggers and Actions"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ff724707(v%3DExpression.40).aspx">http://msdn.microsoft.com/en-us/library/ff724707(v=Expression.40).aspx</a> . <br> <br>         WPF  Silverlight, ."Threading Model"  "The Dispatcher Class"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ms741870.aspx">http://msdn.microsoft.com/en-us/library/ms741870.aspx</a> <br> <a href="http://msdn.microsoft.com/en-us/library/ms615907(v%3DVS.95).aspx">http://msdn.microsoft.com/en-us/library/ms615907(v=VS.95).aspx</a> . <br> <br>      unit-  Silverlight, ."Unit Testing with Silverlight 2": <a href="http://www.jeff.wilcox.name/2008/03/silverlight2-unit-testing/">http://www.jeff.wilcox.name/2008/03/silverlight2-unit-testing/</a> . <br> <br>         , .  " <a href="http://msdn.microsoft.com/en-us/library/gg430861(v%3DPandP.40).aspx">View-Based Navigation</a> " in Chapter 8, " <a href="http://msdn.microsoft.com/en-us/library/gg430861(v%3DPandP.40).aspx">Navigation</a> ." <br> <br>       ,   , ."Event-based Asynchronous Pattern Overview"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/wewwczdw.aspx">http://msdn.microsoft.com/en-us/library/wewwczdw.aspx</a> <br> <br>        <code>IAsyncResult</code> , ."Asynchronous Programming Overview"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ms228963.aspx">http://msdn.microsoft.com/en-us/library/ms228963.aspx</a></code></code></code></code></code></code></code></code></code> <h4> <code><code><code><code><code><code><code><code><code><code>CommandBehaviorBase ,    ,    ICommand</code> .           <code>CanExecuteChanged</code> ,          Silverlight,    WPF. <br> <br>    ,  ,   <code>CommandBehaviorBase    ,    .         ,      .         ,    .      ButtonBaseClickCommandBehavior</code> . <br> <br> <code class="cs">public class ButtonBaseClickCommandBehavior : CommandBehaviorBase&lt;ButtonBase&gt; { public ButtonBaseClickCommandBehavior(ButtonBase clickableObject) : base(clickableObject) { clickableObject.Click += OnClick; } private void OnClick(object sender, System.Windows.RoutedEventArgs e) { ExecuteCommand(); } }</code> <br>   <code>CommandBehaviorBase ,     .     ,          ,   . ,    ,    ,      , ,    CanExecute</code>  ,     . <br> <br>          ,   .           XAML.           .       .  Prism      ,       ,  ,   .       ,    . , ,  ,      <code>Click</code> ,       <code>Command</code> .    <code>Click.Command</code> ,  . <br> <br>             .             . <br> <br> <code class="cs">public static readonly DependencyProperty CommandProperty = DependencyProperty.RegisterAttached( "Command", typeof(ICommand), typeof(Click), new PropertyMetadata(OnSetCommandCallback)); private static readonly DependencyProperty ClickCommandBehaviorProperty = DependencyProperty.RegisterAttached( "ClickCommandBehavior", typeof(ButtonBaseClickCommandBehavior), typeof(Click), null);</code> <br>    <code>Command</code>    <code>ButtonBaseClickCommandBehavior</code> ,     <code>OnSetCommandCallback</code> ,     . <br> <br> <code class="cs">private static void OnSetCommandCallback(DependencyObject dependencyObject, DependencyPropertyChangedEventArgs e) { ButtonBase buttonBase = dependencyObject as ButtonBase; if (buttonBase != null) { ButtonBaseClickCommandBehavior behavior = GetOrCreateBehavior(buttonBase); behavior.Command = e.NewValue as ICommand; } } private static void OnSetCommandParameterCallback(DependencyObject dependencyObject, DependencyPropertyChangedEventArgs e) { ButtonBase buttonBase = dependencyObject as ButtonBase; if (buttonBase != null) { ButtonBaseClickCommandBehavior behavior = GetOrCreateBehavior(buttonBase); behavior.CommandParameter = e.NewValue; } } private static ButtonBaseClickCommandBehavior GetOrCreateBehavior(ButtonBase buttonBase ) { ButtonBaseClickCommandBehavior behavior = buttonBase.GetValue(ClickCommandBehaviorProperty) as ButtonBaseClickCommandBehavior; if ( behavior == null ) { behavior = new ButtonBaseClickCommandBehavior(buttonBase); buttonBase.SetValue(ClickCommandBehaviorProperty, behavior); } return behavior; }</code> <br>        ,  <a href="http://msdn.microsoft.com/en-us/library/cc265152(VS.95).aspx">Attached Properties Overview</a>  MSDN. <br> <br>    <br>              . ,     Silverlight,    -,     ,      ,     .     ,       . <br> <br>        ,    ( )  ,  ,     .  UI       ,            UI. <br> <br>      - <br>   -     ,       <code>IAsyncResult</code> .   ,  ,   ,  <code>GetQuestionnaire</code> ,   : <code>BeginGetQuestionnaire</code>  <code>EndGetQuestionnaire</code> .    ,   <code>BeginGetQuestionnaire</code> .     ,   ,   <code>EndGetQuestionnaire</code>    . <br> <b></b> <br>  .NET Framework 4.5      <code>await</code>  <code>async</code>     <code>*Async</code> .      <a href="http://msdn.microsoft.com/en-us/library/vstudio/hh391443.aspx">"Asynchronous Programming with Async and Await (C# and Visual Basic)"</a> . <br>  ,    <code>EndGetQuestionnaire</code> ,      ,  ()      <code>BeginGetQuestionnaire</code> .     ,      ,   <code>EndGetQuestionnaire</code> ,   . <br> <br> <code class="xml">IAsyncResult asyncResult = this.service.BeginGetQuestionnaire( GetQuestionnaireCompleted, null //  ,      ); private void GetQuestionnaireCompleted(IAsyncResult result) { try { questionnaire = this.service.EndGetQuestionnaire(ar); } catch (Exception ex) { //  -   . } }</code> <br>  ,     <code>End*</code> (  , <code>EndGetQuestionnaire</code> ),    ,      .      , ,          UI.     ,   ,        . <br> <br>        UI,     -,      UI,         UI,   <code>Dispatcher</code>    <code>SynchronizationContext</code> .  WPF  Silverlight,   <code>Dispatcher</code> . <br> <br>      <code>Questionnaire</code>  ,        <code>QuestionnaireView</code> .  Silverlight    <code>CheckAccess</code> ,  ,      UI.  ,     <code>BeginInvoke</code> ,      UI. <br> <br> <code class="cs">var dispatcher = System.Windows.Deployment.Current.Dispatcher; if (dispatcher.CheckAccess()) { QuestionnaireView.DataContext = questionnaire; } else { dispatcher.BeginInvoke(() =&gt; { Questionnaire.DataContext = questionnaire; }); }</code> <br> <i>MVVM RI</i>   ,    ,   <code>IAsyncResult</code> ,   .      ,                 . ,       . <br> <br> <code class="cs">this.questionnaireRepository.GetQuestionnaireAsync( result =&gt; { this.Questionnaire = result.Result; });</code> <br>  <code>result</code>   ,     , , , .    ,     . <br> <br> <code class="cs">this.questionnaireRepository.GetQuestionnaireAsync( result =&gt; { if (result.Error == null) { this.Questionnaire = result.Result; ... } else { // Handle error. } })</code> <br>     <br>        ,      .     , ,             .        ,      ,     ,     . <br> <br>         ,      MVVM,     ,   . ,  -MVVM ,     <code>MessageBox</code>   code-behind UI,      .   MVVM     ,          . <br> <br>     MVVM,              ,          .      ,    ,   ,  ,     . <br> <br>              MVVM.      ,     ,     ,  ,     .    ,         ,     ,          .       . <br> <br>    <br>                  .        ,        .  ,         .         . <br> <br>  ,         ,         ,  .      ,     .           ,       . ,        WPF  Silverlight,        . <br> <br> <img title="Using the service to interact with the user." src="https://habrastorage.org/getpro/habr/post_images/4b5/397/f2d/4b5397f2d02e5851195b29f1893be6fc.png" alt=" ,    ."> <br> <br>  ,   <code>MessageBox</code>        ,     ,    ,     . <br> <br> <code class="cs">var result = interactionService.ShowMessageBox( "Are you sure you want to cancel this operation?", "Confirm", MessageBoxButton.OK); if (result == MessageBoxResult.Yes) { CancelRequest(); }</code> <br> ,      - ,      ,         Silverlight.         .             .     . <br> <br> <code class="cs">interactionService.ShowMessageBox( "Are you sure you want to cancel this operation?", "Confirm", MessageBoxButton.OK, result =&gt; { if (result == MessageBoxResult.Yes) { CancelRequest(); } });</code> <br>         ,      . ,  WPF    <code>MessageBox</code> ,       ;    Silverlight    ,    . <br> <br>     <br>         ‚Äì             .         ,      .     ,     .        ,        ,   ,     . <br> <br> <img title="Using interaction request objects." src="https://habrastorage.org/getpro/habr/post_images/3d0/ff0/1c5/3d0ff01c5518558c2d3c5c5f47ce0ce9.png" alt="   ."> <br> <br>    ,   ,          ‚Äì       ,      ,   ‚Äì     .   ,        ,    ,    UI            . <br> <br>       MVVM,     ,       ,         .         ,        ,    ,   . <br> <br>  Prism       <code>IInteractionRequest</code>   <code>InteractionRequest .  IInteractionRequest</code>  ,   .           ,   .  <code>InteractionRequest   IInteractionRequest</code>     <code>Raise</code> ,           , , ,   . <br> <br>       <br>  <code>InteractionRequest          .  Raise</code>          ( <code>T</code> )    ,    ,   .          ,       .      ,        .    ,  ,     . <br> <code class="cs">public interface IInteractionRequest { event EventHandler&lt;InteractionRequestedEventArgs&gt; Raised; } public class InteractionRequest&lt;T&gt; : IInteractionRequest { public event EventHandler&lt;InteractionRequestedEventArgs&gt; Raised; public void Raise(T context, Action&lt;T&gt; callback) { var handler = this.Raised; if (handler != null) { handler( this, new InteractionRequestedEventArgs(context, () =&gt; callback(context))); } } }</code> <br> Prism    ,      .  <code>Notification</code>       .    ,            .     ‚Äì <code>Title</code>  <code>Content</code> ,    .  ,   ,  ,  ,        . <br> <br>  <code>Confirmation</code>    <code>Notification</code>     ‚Äì <code>Confirmed</code> ,  ,  ,      .  <code>Confirmation</code> ,     <code>MessageBox</code> ,     /  .     ,     <code>Notification</code> ,     ,      . <br> <br>    <code>InteractionRequest ,       InteractionRequest      ,      .      ,    Raise</code> ,    , ,   . <br> <br> <code class="cs">public IInteractionRequest ConfirmCancelInteractionRequest { get { return this.confirmCancelInteractionRequest; } } this.confirmCancelInteractionRequest.Raise( new Confirmation("Are you sure you wish to cancel?"), confirmation =&gt; { if (confirmation.Confirmed) { this.NavigateToQuestionnaireList(); } }); }</code> <br> <i>MVVM Reference Implementation (MVVM RI)</i> ,    <code>IInteractionRequest</code>   <code>InteractionRequest ,          (. QuestionnaireViewModel.cs</code> ). <br> <br>        <br>       ,       .   ,       .    UI             . <br> <br>                . Microsoft Expression Blend Behaviors Framework     .  ,     ,    . <br> <br>  <code>EventTrigger</code> ,  Expression Blend,  ,      ,     ,   . , Prism   <code>EventTrigger</code> ,  <code>InteractionRequestTrigger</code> ,      <code>Raised</code>   <code>IInteractionRequest</code> .    XAML        . <br> <br>  ,   , <code>InteractionRequestTrigger</code>   .  Silverlight Prism   <code>PopupChildWindowAction</code> ,     .    ,         .   <code>ContentTemplate</code>  <code>PopupChildWindowAction</code> ,    ,    UI,      <code>Content</code>  .       <code>Title</code>  . <br> <b></b> <br>  ,    ,   <code>PopupChildWindowAction</code> ,     .    <code>Notification</code>  <code>NotificationChildWindow</code> ,        <code>Confirmation</code> ‚Äì <code>ConfirmationChildWindow</code> . <code>NotificationChildWindow</code>    ,   ,     <code>ConfirmationChildWindow</code>    <i>OK</i>  <i>Cancel</i> ,    .    ,   ,   <code>ChildWindow</code>  <code>PopupChildWindowAction</code> . <br>   ,  <code>InteractionRequestTrigger</code>  <code>PopupChildWindowAction</code> ,       <i>RI MVVM</i> . <br> <br> <code class="xml">&lt;i:Interaction.Triggers&gt; &lt;prism:InteractionRequestTrigger SourceObject="{Binding ConfirmCancelInteractionRequest}"&gt; &lt;prism:PopupChildWindowAction ContentTemplate="{StaticResource ConfirmWindowTemplate}"/&gt; &lt;/prism:InteractionRequestTrigger&gt; &lt;/i:Interaction.Triggers&gt; &lt;UserControl.Resources&gt; &lt;DataTemplate x:Key="ConfirmWindowTemplate"&gt; &lt;Grid MinWidth="250" MinHeight="100"&gt; &lt;TextBlock TextWrapping="Wrap" Grid.Row="0" Text="{Binding}"/&gt; &lt;/Grid&gt; &lt;/DataTemplate&gt; &lt;/UserControl.Resources&gt;</code> <br> <b></b> <br>      <code>ContentTemplate</code> ,   UI   <code>Content</code>  .    <code>Content</code>  ,  , <code>TextBlock</code>     <code>Content</code> . <br>      ,     ,    ,    .  ,     ,       ,     ,    .   ,   <i>RI MVVM</i> ,         <code>Confirmed</code>    <code>Confirmation</code>  <code>true</code> ,     OK. <br> <br>        ,     .  Prism <code>InteractionRequestTrigger</code>   <code>PopupChildWindowAction</code>            . <br> <br>     <br>     MVVM,       , ,    ,         .        (  , ,  ,   ).    ,  ,  ,            . <br> <br>        ,         . Managed Extensibility Framework (MEF)  Unity Application Block (Unity)      ,  ,           . <br> <br>  ,       , , ,    ( )      . ,       ,     .  ,     ,       . <br> <br>     ,  MEF <br>  MEF,       ,   <code>Import</code> ,      ,  ,   <code>Export</code> .         ,    . <br> <br> , <code>QuestionnaireView</code>   <i>RI MVVM</i> ,        ,    <code>Import</code> .   , MEF           .  <code>set</code>        ,   . <br> <br> <code class="cs">[Import] public QuestionnaireViewModel ViewModel { set { this.DataContext = value; } }</code> <br>     ,   . <br> <br> <code class="cs">[Export] public class QuestionnaireViewModel : NotificationObject { ... }</code> <br>        ,   . <br> <br> <code class="cs">public QuestionnaireView() { InitializeComponent(); } [ImportingConstructor] public QuestionnaireView(QuestionnaireViewModel viewModel) : this() { this.DataContext = viewModel; }</code> <br> <b></b> <br>          MEF,   Unity.   ,     ,        .   ,   Visual Studio  Expression Blend, ,        ,     .   ,   ,  ,      ,          <code>InitializeComponent</code> . <br>     ,  Unity <br>  Unity,    ,   MEF.     ,      .    ,         .  ,      . <br> <br>  ,      ,  ,         . ,           ,   . <br> <br> <code class="cs">public QuestionnaireView() { InitializeComponent(); } public QuestionnaireView(QuestionnaireViewModel viewModel) : this() { this.DataContext = viewModel; }</code> <br> <b></b> <br>    ,        ,   Visual Studio  Expression Blend. <br>  ,          ,   . Unity        <code>set</code>   ,   . <br> <br> <code class="cs">public QuestionnaireView() { InitializeComponent(); } [Dependency] public QuestionnaireViewModel ViewModel { set { this.DataContext = value; } }</code> <br>       Unity. <br> <br> <code class="cs">container.RegisterType&lt;QuestionnaireViewModel&gt;();</code> <br>  ,     . <br> <br> <code class="cs">var view = container.Resolve&lt;QuestionnaireView&gt;();</code> <br>     ,    <br>   ,     ,        .        ,   MEF  Unity,        . <br> <br>          .   ,         UI,           . <br> <br> , <i>RI MVVM</i>   ,   ,        .   ,    .      <code>ShowView</code>   UI. <br> <br> <code class="cs">private void NavigateToQuestionnaireList() { //     "questionnaire list". this.uiService.ShowView(ViewNames.QuestionnaireTemplatesList); }</code> <br>  UI      UI .           UI.  <code>ShowView</code>  <code>UIService</code>      (,          ),       ,   . <br> <br> <code class="cs">public void ShowView(string viewName) { var view = this.ViewFactory.GetView(viewName); this.MainWindow.CurrentView = view; }</code> <br> <b></b> <br> Prism       .   ,   ,   ,             .    ,  , " <a href="http://msdn.microsoft.com/en-us/library/gg430861(v%3DPandP.40).aspx">View-Based Navigation</a> "   8, " <a href="http://msdn.microsoft.com/en-us/library/gg430861(v%3DPandP.40).aspx">Navigation</a> ". <br>  MVVM  <br>        MVVM      .           -      mocking . ,   ,        . <br> <br>   <i>INotifyPropertyChanged</i> <br>   <code>INotifyPropertyChanged</code>     ,      .      ,    ;   ,   ,     ,    ,       . <br> <br>   <br> ,       ,           <code>PropertyChanged</code>  ,         .  ,    <code>ChangeTracker</code> ,     MVVM,  ,      .      .     ,    . <br> <br> <code class="cs">var changeTracker = new PropertyChangeTracker(viewModel); viewModel.CurrentState = "newState"; CollectionAssert.Contains(changeTracker.ChangedProperties, "CurrentState");</code> <br> ,     ,     <code>INotifyPropertyChanged</code> ,    ,   ,     . <br> <br>      <br>        ,   ,    <code>set</code>      ,           . ,     ,     ,      ,          . <br> <br> <code class="cs">var changeTracker = new PropertyChangeTracker(viewModel); var question = viewModel.Questions.First() as OpenQuestionViewModel; question.Question.Response = "some text"; CollectionAssert.Contains(changeTracker.ChangedProperties, "UnansweredQuestions");</code> <br>      <br>     <code>INotifyPropertyChanged</code> ,      <code>PropertyChanged</code>        ,  ,     , , .        ,       . <br> <br>   <i>INotifyDataErrorInfo</i> <br>   ,     ,    ,   ,   <code>IDataErrorInfo</code> ,  ( Silverlight)   <code>INotifyDataErrorInfo</code> .   <code>INotifyDataErrorInfo</code>   ,         ,    ,  ,   ,    . <br> <br>       <code>INotifyDataErrorInfo</code> : ,     ,  ,     ,     <code>ErrorsChanged</code> ,      <code>GetErrors</code> , . <br> <br>    <br>     ,      ,     .       ,         <code>GetErrors</code>       ,  ,  ,   .    , ,  ,     ,        .   ,        . <br> <br> <code class="cs">//  . var notifyErrorInfo = (INotifyDataErrorInfo)question; question.Response = -15; Assert.IsTrue(notifyErrorInfo.GetErrors("Response").Cast&lt;ValidationResult&gt;().Any()); //  . var notifyErrorInfo = (INotifyDataErrorInfo)question; question.Response = 15; Assert.IsFalse(notifyErrorInfo.GetErrors("Response").Cast&lt;ValidationResult&gt;().Any());</code> <br>    ,    ,             . <br> <br>    <i>INotifyDataErrorInfo</i> <br>       <code>GetErrors</code> ,   <code>INotifyDataErrorInfo</code>  ,   <code>ErrorsChanged</code>      <code>GetErrors</code> . ,  <code>HasErrors</code>      ,  . <br> <br>       <code>INotifyDataErrorInfo</code> . , ,           ,   -  .      ,        <code>INotifyDataErrorInfo</code>         (,        ). <br> <br>     ,   ,  : <br>  <code>HasErrors</code>     .              ,       .  <code>ErrorsChanged</code> ,      ,         <code>GetErrors</code> .         ( ,  )     ,           .    <code>GetErrors</code>       <code>ErrorsChanged</code> . <br>    <code>INotifyPropertyChanged</code> ,  ,    <code>NotifyDataErrorInfoTestHelper</code>    MVVM,        <code>INotifyDataErrorInfo</code> ,       .   ,   ,      ,   .      . <br> <code class="cs">var helper = new NotifyDataErrorInfoTestHelper&lt;NumericQuestion, int?&gt;( question, q =&gt; q.Response); helper.ValidatePropertyChange( 6, NotifyDataErrorInfoBehavior.Nothing); helper.ValidatePropertyChange( 20, NotifyDataErrorInfoBehavior.FiresErrorsChanged | NotifyDataErrorInfoBehavior.HasErrors | NotifyDataErrorInfoBehavior.HasErrorsForProperty); helper.ValidatePropertyChange( null, NotifyDataErrorInfoBehavior.FiresErrorsChanged | NotifyDataErrorInfoBehavior.HasErrors | NotifyDataErrorInfoBehavior.HasErrorsForProperty); helper.ValidatePropertyChange( 2, NotifyDataErrorInfoBehavior.FiresErrorsChanged);</code> <br>     <br>   MVVM,     ,  .   ,    ,         . <br> <br>  ,     ,     ,       .   ,   , ,       ,     ,   <code>IAsyncResult</code>    ,  - ,   ,    UI. <br> <br>       , , ,    .   ,     .  ,      UI,     ,   ,          ,     ,        "   UI." <br> <br>     ,    ,    .   ,    ,     mock-, ,   ,   ,      ,          . <br> <br>           UI,    ,    .   ,     ,   ,      .        ,   .     ,    ,     . <br> <br> <code class="cs">questionnaireRepositoryMock .Setup( r =&gt; r.SubmitQuestionnaireAsync( It.IsAny&lt;Questionnaire&gt;(), It.IsAny&lt;Action&lt;IOperationResult&gt;&gt;())) .Callback&lt;Questionnaire, Action&lt;IOperationResult&gt;&gt;( (q, a) =&gt; callback = a); uiServicemock .Setup(svc =&gt; svc.ShowView(ViewNames.QuestionnaireTemplatesList)) .Callback&lt;string&gt;(viewName =&gt; requestedViewName = viewName); submitResultMock .Setup(sr =&gt; sr.Error) .Returns&lt;Exception&gt;(null); CompleteQuestionnaire(viewModel); viewModel.Submit(); //      UI . callback(submitResultMock.Object); //    ‚Äì     . Assert.AreEqual(ViewNames.QuestionnaireTemplatesList, requestedViewName);</code> <br> <b></b> <br>          ,        . <br>   <br>       , . "Trees in WPF"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ms753391.aspx">http://msdn.microsoft.com/en-us/library/ms753391.aspx</a> <br> <br>       , . "Attached Properties Overview"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/cc265152(VS.95).aspx">http://msdn.microsoft.com/en-us/library/cc265152(VS.95).aspx</a> <br> <br>      MEF, ."Managed Extensibility Framework Overview"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/dd460648.aspx">http://msdn.microsoft.com/en-us/library/dd460648.aspx</a> . <br> <br>      Unity, ."Unity Application Block"  MSDN: <a href="http://www.msdn.com/unity">http://www.msdn.com/unity</a> . <br> <br>      <code>DelegateCommand</code> , .Chapter 5, " <a href="http://msdn.microsoft.com/en-us/library/gg405484(v%3DPandP.40).aspx">Implementing the MVVM Pattern</a> ." <br> <br>        Microsoft Expression Blend, ."Working with built-in behaviors"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ff724013(v%3DExpression.40).aspx">http://msdn.microsoft.com/en-us/library/ff724013(v=Expression.40).aspx</a> . <br> <br>          Microsoft Expression Blend, ."Creating Custom Behaviors"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ff724708(v%3DExpression.40).aspx">http://msdn.microsoft.com/en-us/library/ff724708(v=Expression.40).aspx</a> . <br> <br>            Microsoft Expression Blend, ."Creating Custom Triggers and Actions"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ff724707(v%3DExpression.40).aspx">http://msdn.microsoft.com/en-us/library/ff724707(v=Expression.40).aspx</a> . <br> <br>         WPF  Silverlight, ."Threading Model"  "The Dispatcher Class"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ms741870.aspx">http://msdn.microsoft.com/en-us/library/ms741870.aspx</a> <br> <a href="http://msdn.microsoft.com/en-us/library/ms615907(v%3DVS.95).aspx">http://msdn.microsoft.com/en-us/library/ms615907(v=VS.95).aspx</a> . <br> <br>      unit-  Silverlight, ."Unit Testing with Silverlight 2": <a href="http://www.jeff.wilcox.name/2008/03/silverlight2-unit-testing/">http://www.jeff.wilcox.name/2008/03/silverlight2-unit-testing/</a> . <br> <br>         , .  " <a href="http://msdn.microsoft.com/en-us/library/gg430861(v%3DPandP.40).aspx">View-Based Navigation</a> " in Chapter 8, " <a href="http://msdn.microsoft.com/en-us/library/gg430861(v%3DPandP.40).aspx">Navigation</a> ." <br> <br>       ,   , ."Event-based Asynchronous Pattern Overview"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/wewwczdw.aspx">http://msdn.microsoft.com/en-us/library/wewwczdw.aspx</a> <br> <br>        <code>IAsyncResult</code> , ."Asynchronous Programming Overview"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ms228963.aspx">http://msdn.microsoft.com/en-us/library/ms228963.aspx</a></code></code></code></code></code></code></code></code></code> </h4> <code><code><code><code><code><code><code><code><code><code>CommandBehaviorBase ,    ,    ICommand</code> .           <code>CanExecuteChanged</code> ,          Silverlight,    WPF. <br> <br>    ,  ,   <code>CommandBehaviorBase    ,    .         ,      .         ,    .      ButtonBaseClickCommandBehavior</code> . <br> <br> <code class="cs">public class ButtonBaseClickCommandBehavior : CommandBehaviorBase&lt;ButtonBase&gt; { public ButtonBaseClickCommandBehavior(ButtonBase clickableObject) : base(clickableObject) { clickableObject.Click += OnClick; } private void OnClick(object sender, System.Windows.RoutedEventArgs e) { ExecuteCommand(); } }</code> <br>   <code>CommandBehaviorBase ,     .     ,          ,   . ,    ,    ,      , ,    CanExecute</code>  ,     . <br> <br>          ,   .           XAML.           .       .  Prism      ,       ,  ,   .       ,    . , ,  ,      <code>Click</code> ,       <code>Command</code> .    <code>Click.Command</code> ,  . <br> <br>             .             . <br> <br> <code class="cs">public static readonly DependencyProperty CommandProperty = DependencyProperty.RegisterAttached( "Command", typeof(ICommand), typeof(Click), new PropertyMetadata(OnSetCommandCallback)); private static readonly DependencyProperty ClickCommandBehaviorProperty = DependencyProperty.RegisterAttached( "ClickCommandBehavior", typeof(ButtonBaseClickCommandBehavior), typeof(Click), null);</code> <br>    <code>Command</code>    <code>ButtonBaseClickCommandBehavior</code> ,     <code>OnSetCommandCallback</code> ,     . <br> <br> <code class="cs">private static void OnSetCommandCallback(DependencyObject dependencyObject, DependencyPropertyChangedEventArgs e) { ButtonBase buttonBase = dependencyObject as ButtonBase; if (buttonBase != null) { ButtonBaseClickCommandBehavior behavior = GetOrCreateBehavior(buttonBase); behavior.Command = e.NewValue as ICommand; } } private static void OnSetCommandParameterCallback(DependencyObject dependencyObject, DependencyPropertyChangedEventArgs e) { ButtonBase buttonBase = dependencyObject as ButtonBase; if (buttonBase != null) { ButtonBaseClickCommandBehavior behavior = GetOrCreateBehavior(buttonBase); behavior.CommandParameter = e.NewValue; } } private static ButtonBaseClickCommandBehavior GetOrCreateBehavior(ButtonBase buttonBase ) { ButtonBaseClickCommandBehavior behavior = buttonBase.GetValue(ClickCommandBehaviorProperty) as ButtonBaseClickCommandBehavior; if ( behavior == null ) { behavior = new ButtonBaseClickCommandBehavior(buttonBase); buttonBase.SetValue(ClickCommandBehaviorProperty, behavior); } return behavior; }</code> <br>        ,  <a href="http://msdn.microsoft.com/en-us/library/cc265152(VS.95).aspx">Attached Properties Overview</a>  MSDN. <br> <br>    <br>              . ,     Silverlight,    -,     ,      ,     .     ,       . <br> <br>        ,    ( )  ,  ,     .  UI       ,            UI. <br> <br>      - <br>   -     ,       <code>IAsyncResult</code> .   ,  ,   ,  <code>GetQuestionnaire</code> ,   : <code>BeginGetQuestionnaire</code>  <code>EndGetQuestionnaire</code> .    ,   <code>BeginGetQuestionnaire</code> .     ,   ,   <code>EndGetQuestionnaire</code>    . <br> <b></b> <br>  .NET Framework 4.5      <code>await</code>  <code>async</code>     <code>*Async</code> .      <a href="http://msdn.microsoft.com/en-us/library/vstudio/hh391443.aspx">"Asynchronous Programming with Async and Await (C# and Visual Basic)"</a> . <br>  ,    <code>EndGetQuestionnaire</code> ,      ,  ()      <code>BeginGetQuestionnaire</code> .     ,      ,   <code>EndGetQuestionnaire</code> ,   . <br> <br> <code class="xml">IAsyncResult asyncResult = this.service.BeginGetQuestionnaire( GetQuestionnaireCompleted, null //  ,      ); private void GetQuestionnaireCompleted(IAsyncResult result) { try { questionnaire = this.service.EndGetQuestionnaire(ar); } catch (Exception ex) { //  -   . } }</code> <br>  ,     <code>End*</code> (  , <code>EndGetQuestionnaire</code> ),    ,      .      , ,          UI.     ,   ,        . <br> <br>        UI,     -,      UI,         UI,   <code>Dispatcher</code>    <code>SynchronizationContext</code> .  WPF  Silverlight,   <code>Dispatcher</code> . <br> <br>      <code>Questionnaire</code>  ,        <code>QuestionnaireView</code> .  Silverlight    <code>CheckAccess</code> ,  ,      UI.  ,     <code>BeginInvoke</code> ,      UI. <br> <br> <code class="cs">var dispatcher = System.Windows.Deployment.Current.Dispatcher; if (dispatcher.CheckAccess()) { QuestionnaireView.DataContext = questionnaire; } else { dispatcher.BeginInvoke(() =&gt; { Questionnaire.DataContext = questionnaire; }); }</code> <br> <i>MVVM RI</i>   ,    ,   <code>IAsyncResult</code> ,   .      ,                 . ,       . <br> <br> <code class="cs">this.questionnaireRepository.GetQuestionnaireAsync( result =&gt; { this.Questionnaire = result.Result; });</code> <br>  <code>result</code>   ,     , , , .    ,     . <br> <br> <code class="cs">this.questionnaireRepository.GetQuestionnaireAsync( result =&gt; { if (result.Error == null) { this.Questionnaire = result.Result; ... } else { // Handle error. } })</code> <br>     <br>        ,      .     , ,             .        ,      ,     ,     . <br> <br>         ,      MVVM,     ,   . ,  -MVVM ,     <code>MessageBox</code>   code-behind UI,      .   MVVM     ,          . <br> <br>     MVVM,              ,          .      ,    ,   ,  ,     . <br> <br>              MVVM.      ,     ,     ,  ,     .    ,         ,     ,          .       . <br> <br>    <br>                  .        ,        .  ,         .         . <br> <br>  ,         ,         ,  .      ,     .           ,       . ,        WPF  Silverlight,        . <br> <br> <img title="Using the service to interact with the user." src="https://habrastorage.org/getpro/habr/post_images/4b5/397/f2d/4b5397f2d02e5851195b29f1893be6fc.png" alt=" ,    ."> <br> <br>  ,   <code>MessageBox</code>        ,     ,    ,     . <br> <br> <code class="cs">var result = interactionService.ShowMessageBox( "Are you sure you want to cancel this operation?", "Confirm", MessageBoxButton.OK); if (result == MessageBoxResult.Yes) { CancelRequest(); }</code> <br> ,      - ,      ,         Silverlight.         .             .     . <br> <br> <code class="cs">interactionService.ShowMessageBox( "Are you sure you want to cancel this operation?", "Confirm", MessageBoxButton.OK, result =&gt; { if (result == MessageBoxResult.Yes) { CancelRequest(); } });</code> <br>         ,      . ,  WPF    <code>MessageBox</code> ,       ;    Silverlight    ,    . <br> <br>     <br>         ‚Äì             .         ,      .     ,     .        ,        ,   ,     . <br> <br> <img title="Using interaction request objects." src="https://habrastorage.org/getpro/habr/post_images/3d0/ff0/1c5/3d0ff01c5518558c2d3c5c5f47ce0ce9.png" alt="   ."> <br> <br>    ,   ,          ‚Äì       ,      ,   ‚Äì     .   ,        ,    ,    UI            . <br> <br>       MVVM,     ,       ,         .         ,        ,    ,   . <br> <br>  Prism       <code>IInteractionRequest</code>   <code>InteractionRequest .  IInteractionRequest</code>  ,   .           ,   .  <code>InteractionRequest   IInteractionRequest</code>     <code>Raise</code> ,           , , ,   . <br> <br>       <br>  <code>InteractionRequest          .  Raise</code>          ( <code>T</code> )    ,    ,   .          ,       .      ,        .    ,  ,     . <br> <code class="cs">public interface IInteractionRequest { event EventHandler&lt;InteractionRequestedEventArgs&gt; Raised; } public class InteractionRequest&lt;T&gt; : IInteractionRequest { public event EventHandler&lt;InteractionRequestedEventArgs&gt; Raised; public void Raise(T context, Action&lt;T&gt; callback) { var handler = this.Raised; if (handler != null) { handler( this, new InteractionRequestedEventArgs(context, () =&gt; callback(context))); } } }</code> <br> Prism    ,      .  <code>Notification</code>       .    ,            .     ‚Äì <code>Title</code>  <code>Content</code> ,    .  ,   ,  ,  ,        . <br> <br>  <code>Confirmation</code>    <code>Notification</code>     ‚Äì <code>Confirmed</code> ,  ,  ,      .  <code>Confirmation</code> ,     <code>MessageBox</code> ,     /  .     ,     <code>Notification</code> ,     ,      . <br> <br>    <code>InteractionRequest ,       InteractionRequest      ,      .      ,    Raise</code> ,    , ,   . <br> <br> <code class="cs">public IInteractionRequest ConfirmCancelInteractionRequest { get { return this.confirmCancelInteractionRequest; } } this.confirmCancelInteractionRequest.Raise( new Confirmation("Are you sure you wish to cancel?"), confirmation =&gt; { if (confirmation.Confirmed) { this.NavigateToQuestionnaireList(); } }); }</code> <br> <i>MVVM Reference Implementation (MVVM RI)</i> ,    <code>IInteractionRequest</code>   <code>InteractionRequest ,          (. QuestionnaireViewModel.cs</code> ). <br> <br>        <br>       ,       .   ,       .    UI             . <br> <br>                . Microsoft Expression Blend Behaviors Framework     .  ,     ,    . <br> <br>  <code>EventTrigger</code> ,  Expression Blend,  ,      ,     ,   . , Prism   <code>EventTrigger</code> ,  <code>InteractionRequestTrigger</code> ,      <code>Raised</code>   <code>IInteractionRequest</code> .    XAML        . <br> <br>  ,   , <code>InteractionRequestTrigger</code>   .  Silverlight Prism   <code>PopupChildWindowAction</code> ,     .    ,         .   <code>ContentTemplate</code>  <code>PopupChildWindowAction</code> ,    ,    UI,      <code>Content</code>  .       <code>Title</code>  . <br> <b></b> <br>  ,    ,   <code>PopupChildWindowAction</code> ,     .    <code>Notification</code>  <code>NotificationChildWindow</code> ,        <code>Confirmation</code> ‚Äì <code>ConfirmationChildWindow</code> . <code>NotificationChildWindow</code>    ,   ,     <code>ConfirmationChildWindow</code>    <i>OK</i>  <i>Cancel</i> ,    .    ,   ,   <code>ChildWindow</code>  <code>PopupChildWindowAction</code> . <br>   ,  <code>InteractionRequestTrigger</code>  <code>PopupChildWindowAction</code> ,       <i>RI MVVM</i> . <br> <br> <code class="xml">&lt;i:Interaction.Triggers&gt; &lt;prism:InteractionRequestTrigger SourceObject="{Binding ConfirmCancelInteractionRequest}"&gt; &lt;prism:PopupChildWindowAction ContentTemplate="{StaticResource ConfirmWindowTemplate}"/&gt; &lt;/prism:InteractionRequestTrigger&gt; &lt;/i:Interaction.Triggers&gt; &lt;UserControl.Resources&gt; &lt;DataTemplate x:Key="ConfirmWindowTemplate"&gt; &lt;Grid MinWidth="250" MinHeight="100"&gt; &lt;TextBlock TextWrapping="Wrap" Grid.Row="0" Text="{Binding}"/&gt; &lt;/Grid&gt; &lt;/DataTemplate&gt; &lt;/UserControl.Resources&gt;</code> <br> <b></b> <br>      <code>ContentTemplate</code> ,   UI   <code>Content</code>  .    <code>Content</code>  ,  , <code>TextBlock</code>     <code>Content</code> . <br>      ,     ,    ,    .  ,     ,       ,     ,    .   ,   <i>RI MVVM</i> ,         <code>Confirmed</code>    <code>Confirmation</code>  <code>true</code> ,     OK. <br> <br>        ,     .  Prism <code>InteractionRequestTrigger</code>   <code>PopupChildWindowAction</code>            . <br> <br>     <br>     MVVM,       , ,    ,         .        (  , ,  ,   ).    ,  ,  ,            . <br> <br>        ,         . Managed Extensibility Framework (MEF)  Unity Application Block (Unity)      ,  ,           . <br> <br>  ,       , , ,    ( )      . ,       ,     .  ,     ,       . <br> <br>     ,  MEF <br>  MEF,       ,   <code>Import</code> ,      ,  ,   <code>Export</code> .         ,    . <br> <br> , <code>QuestionnaireView</code>   <i>RI MVVM</i> ,        ,    <code>Import</code> .   , MEF           .  <code>set</code>        ,   . <br> <br> <code class="cs">[Import] public QuestionnaireViewModel ViewModel { set { this.DataContext = value; } }</code> <br>     ,   . <br> <br> <code class="cs">[Export] public class QuestionnaireViewModel : NotificationObject { ... }</code> <br>        ,   . <br> <br> <code class="cs">public QuestionnaireView() { InitializeComponent(); } [ImportingConstructor] public QuestionnaireView(QuestionnaireViewModel viewModel) : this() { this.DataContext = viewModel; }</code> <br> <b></b> <br>          MEF,   Unity.   ,     ,        .   ,   Visual Studio  Expression Blend, ,        ,     .   ,   ,  ,      ,          <code>InitializeComponent</code> . <br>     ,  Unity <br>  Unity,    ,   MEF.     ,      .    ,         .  ,      . <br> <br>  ,      ,  ,         . ,           ,   . <br> <br> <code class="cs">public QuestionnaireView() { InitializeComponent(); } public QuestionnaireView(QuestionnaireViewModel viewModel) : this() { this.DataContext = viewModel; }</code> <br> <b></b> <br>    ,        ,   Visual Studio  Expression Blend. <br>  ,          ,   . Unity        <code>set</code>   ,   . <br> <br> <code class="cs">public QuestionnaireView() { InitializeComponent(); } [Dependency] public QuestionnaireViewModel ViewModel { set { this.DataContext = value; } }</code> <br>       Unity. <br> <br> <code class="cs">container.RegisterType&lt;QuestionnaireViewModel&gt;();</code> <br>  ,     . <br> <br> <code class="cs">var view = container.Resolve&lt;QuestionnaireView&gt;();</code> <br>     ,    <br>   ,     ,        .        ,   MEF  Unity,        . <br> <br>          .   ,         UI,           . <br> <br> , <i>RI MVVM</i>   ,   ,        .   ,    .      <code>ShowView</code>   UI. <br> <br> <code class="cs">private void NavigateToQuestionnaireList() { //     "questionnaire list". this.uiService.ShowView(ViewNames.QuestionnaireTemplatesList); }</code> <br>  UI      UI .           UI.  <code>ShowView</code>  <code>UIService</code>      (,          ),       ,   . <br> <br> <code class="cs">public void ShowView(string viewName) { var view = this.ViewFactory.GetView(viewName); this.MainWindow.CurrentView = view; }</code> <br> <b></b> <br> Prism       .   ,   ,   ,             .    ,  , " <a href="http://msdn.microsoft.com/en-us/library/gg430861(v%3DPandP.40).aspx">View-Based Navigation</a> "   8, " <a href="http://msdn.microsoft.com/en-us/library/gg430861(v%3DPandP.40).aspx">Navigation</a> ". <br>  MVVM  <br>        MVVM      .           -      mocking . ,   ,        . <br> <br>   <i>INotifyPropertyChanged</i> <br>   <code>INotifyPropertyChanged</code>     ,      .      ,    ;   ,   ,     ,    ,       . <br> <br>   <br> ,       ,           <code>PropertyChanged</code>  ,         .  ,    <code>ChangeTracker</code> ,     MVVM,  ,      .      .     ,    . <br> <br> <code class="cs">var changeTracker = new PropertyChangeTracker(viewModel); viewModel.CurrentState = "newState"; CollectionAssert.Contains(changeTracker.ChangedProperties, "CurrentState");</code> <br> ,     ,     <code>INotifyPropertyChanged</code> ,    ,   ,     . <br> <br>      <br>        ,   ,    <code>set</code>      ,           . ,     ,     ,      ,          . <br> <br> <code class="cs">var changeTracker = new PropertyChangeTracker(viewModel); var question = viewModel.Questions.First() as OpenQuestionViewModel; question.Question.Response = "some text"; CollectionAssert.Contains(changeTracker.ChangedProperties, "UnansweredQuestions");</code> <br>      <br>     <code>INotifyPropertyChanged</code> ,      <code>PropertyChanged</code>        ,  ,     , , .        ,       . <br> <br>   <i>INotifyDataErrorInfo</i> <br>   ,     ,    ,   ,   <code>IDataErrorInfo</code> ,  ( Silverlight)   <code>INotifyDataErrorInfo</code> .   <code>INotifyDataErrorInfo</code>   ,         ,    ,  ,   ,    . <br> <br>       <code>INotifyDataErrorInfo</code> : ,     ,  ,     ,     <code>ErrorsChanged</code> ,      <code>GetErrors</code> , . <br> <br>    <br>     ,      ,     .       ,         <code>GetErrors</code>       ,  ,  ,   .    , ,  ,     ,        .   ,        . <br> <br> <code class="cs">//  . var notifyErrorInfo = (INotifyDataErrorInfo)question; question.Response = -15; Assert.IsTrue(notifyErrorInfo.GetErrors("Response").Cast&lt;ValidationResult&gt;().Any()); //  . var notifyErrorInfo = (INotifyDataErrorInfo)question; question.Response = 15; Assert.IsFalse(notifyErrorInfo.GetErrors("Response").Cast&lt;ValidationResult&gt;().Any());</code> <br>    ,    ,             . <br> <br>    <i>INotifyDataErrorInfo</i> <br>       <code>GetErrors</code> ,   <code>INotifyDataErrorInfo</code>  ,   <code>ErrorsChanged</code>      <code>GetErrors</code> . ,  <code>HasErrors</code>      ,  . <br> <br>       <code>INotifyDataErrorInfo</code> . , ,           ,   -  .      ,        <code>INotifyDataErrorInfo</code>         (,        ). <br> <br>     ,   ,  : <br>  <code>HasErrors</code>     .              ,       .  <code>ErrorsChanged</code> ,      ,         <code>GetErrors</code> .         ( ,  )     ,           .    <code>GetErrors</code>       <code>ErrorsChanged</code> . <br>    <code>INotifyPropertyChanged</code> ,  ,    <code>NotifyDataErrorInfoTestHelper</code>    MVVM,        <code>INotifyDataErrorInfo</code> ,       .   ,   ,      ,   .      . <br> <code class="cs">var helper = new NotifyDataErrorInfoTestHelper&lt;NumericQuestion, int?&gt;( question, q =&gt; q.Response); helper.ValidatePropertyChange( 6, NotifyDataErrorInfoBehavior.Nothing); helper.ValidatePropertyChange( 20, NotifyDataErrorInfoBehavior.FiresErrorsChanged | NotifyDataErrorInfoBehavior.HasErrors | NotifyDataErrorInfoBehavior.HasErrorsForProperty); helper.ValidatePropertyChange( null, NotifyDataErrorInfoBehavior.FiresErrorsChanged | NotifyDataErrorInfoBehavior.HasErrors | NotifyDataErrorInfoBehavior.HasErrorsForProperty); helper.ValidatePropertyChange( 2, NotifyDataErrorInfoBehavior.FiresErrorsChanged);</code> <br>     <br>   MVVM,     ,  .   ,    ,         . <br> <br>  ,     ,     ,       .   ,   , ,       ,     ,   <code>IAsyncResult</code>    ,  - ,   ,    UI. <br> <br>       , , ,    .   ,     .  ,      UI,     ,   ,          ,     ,        "   UI." <br> <br>     ,    ,    .   ,    ,     mock-, ,   ,   ,      ,          . <br> <br>           UI,    ,    .   ,     ,   ,      .        ,   .     ,    ,     . <br> <br> <code class="cs">questionnaireRepositoryMock .Setup( r =&gt; r.SubmitQuestionnaireAsync( It.IsAny&lt;Questionnaire&gt;(), It.IsAny&lt;Action&lt;IOperationResult&gt;&gt;())) .Callback&lt;Questionnaire, Action&lt;IOperationResult&gt;&gt;( (q, a) =&gt; callback = a); uiServicemock .Setup(svc =&gt; svc.ShowView(ViewNames.QuestionnaireTemplatesList)) .Callback&lt;string&gt;(viewName =&gt; requestedViewName = viewName); submitResultMock .Setup(sr =&gt; sr.Error) .Returns&lt;Exception&gt;(null); CompleteQuestionnaire(viewModel); viewModel.Submit(); //      UI . callback(submitResultMock.Object); //    ‚Äì     . Assert.AreEqual(ViewNames.QuestionnaireTemplatesList, requestedViewName);</code> <br> <b></b> <br>          ,        . <br>   <br>       , . "Trees in WPF"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ms753391.aspx">http://msdn.microsoft.com/en-us/library/ms753391.aspx</a> <br> <br>       , . "Attached Properties Overview"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/cc265152(VS.95).aspx">http://msdn.microsoft.com/en-us/library/cc265152(VS.95).aspx</a> <br> <br>      MEF, ."Managed Extensibility Framework Overview"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/dd460648.aspx">http://msdn.microsoft.com/en-us/library/dd460648.aspx</a> . <br> <br>      Unity, ."Unity Application Block"  MSDN: <a href="http://www.msdn.com/unity">http://www.msdn.com/unity</a> . <br> <br>      <code>DelegateCommand</code> , .Chapter 5, " <a href="http://msdn.microsoft.com/en-us/library/gg405484(v%3DPandP.40).aspx">Implementing the MVVM Pattern</a> ." <br> <br>        Microsoft Expression Blend, ."Working with built-in behaviors"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ff724013(v%3DExpression.40).aspx">http://msdn.microsoft.com/en-us/library/ff724013(v=Expression.40).aspx</a> . <br> <br>          Microsoft Expression Blend, ."Creating Custom Behaviors"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ff724708(v%3DExpression.40).aspx">http://msdn.microsoft.com/en-us/library/ff724708(v=Expression.40).aspx</a> . <br> <br>            Microsoft Expression Blend, ."Creating Custom Triggers and Actions"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ff724707(v%3DExpression.40).aspx">http://msdn.microsoft.com/en-us/library/ff724707(v=Expression.40).aspx</a> . <br> <br>         WPF  Silverlight, ."Threading Model"  "The Dispatcher Class"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ms741870.aspx">http://msdn.microsoft.com/en-us/library/ms741870.aspx</a> <br> <a href="http://msdn.microsoft.com/en-us/library/ms615907(v%3DVS.95).aspx">http://msdn.microsoft.com/en-us/library/ms615907(v=VS.95).aspx</a> . <br> <br>      unit-  Silverlight, ."Unit Testing with Silverlight 2": <a href="http://www.jeff.wilcox.name/2008/03/silverlight2-unit-testing/">http://www.jeff.wilcox.name/2008/03/silverlight2-unit-testing/</a> . <br> <br>         , .  " <a href="http://msdn.microsoft.com/en-us/library/gg430861(v%3DPandP.40).aspx">View-Based Navigation</a> " in Chapter 8, " <a href="http://msdn.microsoft.com/en-us/library/gg430861(v%3DPandP.40).aspx">Navigation</a> ." <br> <br>       ,   , ."Event-based Asynchronous Pattern Overview"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/wewwczdw.aspx">http://msdn.microsoft.com/en-us/library/wewwczdw.aspx</a> <br> <br>        <code>IAsyncResult</code> , ."Asynchronous Programming Overview"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ms228963.aspx">http://msdn.microsoft.com/en-us/library/ms228963.aspx</a></code></code></code></code></code></code></code></code></code> <pre> <code class="hljs cmake"><code>CommandBehaviorBase ,    ,    ICommand</code> .           <code>CanExecuteChanged</code> ,          Silverlight,    WPF. <br> <br>    ,  ,   <code><code>CommandBehaviorBase    ,    .         ,      .         ,    .      ButtonBaseClickCommandBehavior</code> . <br> <br> <code class="cs">public class ButtonBaseClickCommandBehavior : CommandBehaviorBase&lt;ButtonBase&gt; { public ButtonBaseClickCommandBehavior(ButtonBase clickableObject) : base(clickableObject) { clickableObject.Click += OnClick; } private void OnClick(object sender, System.Windows.RoutedEventArgs e) { ExecuteCommand(); } }</code> <br>   <code><code>CommandBehaviorBase ,     .     ,          ,   . ,    ,    ,      , ,    CanExecute</code>  ,     . <br> <br>          ,   .           XAML.           .       .  Prism      ,       ,  ,   .       ,    . , ,  ,      <code>Click</code> ,       <code><span class="hljs-keyword"><span class="hljs-keyword">Command</span></span></code> .    <code>Click.<span class="hljs-keyword"><span class="hljs-keyword">Command</span></span></code> ,  . <br> <br>             .             . <br> <br> <code class="cs">public static readonly DependencyProperty CommandProperty = DependencyProperty.RegisterAttached( <span class="hljs-string"><span class="hljs-string">"Command"</span></span>, typeof(ICommand), typeof(Click), new PropertyMetadata(OnSetCommandCallback)); private static readonly DependencyProperty ClickCommandBehaviorProperty = DependencyProperty.RegisterAttached( <span class="hljs-string"><span class="hljs-string">"ClickCommandBehavior"</span></span>, typeof(ButtonBaseClickCommandBehavior), typeof(Click), null);</code> <br>    <code><span class="hljs-keyword"><span class="hljs-keyword">Command</span></span></code>    <code>ButtonBaseClickCommandBehavior</code> ,     <code>OnSetCommandCallback</code> ,     . <br> <br> <code class="cs">private static void OnSetCommandCallback(DependencyObject dependencyObject, DependencyPropertyChangedEventArgs e) { ButtonBase buttonBase = dependencyObject as ButtonBase; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (buttonBase != null) { ButtonBaseClickCommandBehavior behavior = GetOrCreateBehavior(buttonBase); behavior.<span class="hljs-keyword"><span class="hljs-keyword">Command</span></span> = e.NewValue as ICommand; } } private static void OnSetCommandParameterCallback(DependencyObject dependencyObject, DependencyPropertyChangedEventArgs e) { ButtonBase buttonBase = dependencyObject as ButtonBase; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (buttonBase != null) { ButtonBaseClickCommandBehavior behavior = GetOrCreateBehavior(buttonBase); behavior.CommandParameter = e.NewValue; } } private static ButtonBaseClickCommandBehavior GetOrCreateBehavior(ButtonBase buttonBase ) { ButtonBaseClickCommandBehavior behavior = buttonBase.GetValue(ClickCommandBehaviorProperty) as ButtonBaseClickCommandBehavior; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ( behavior == null ) { behavior = new ButtonBaseClickCommandBehavior(buttonBase); buttonBase.SetValue(ClickCommandBehaviorProperty, behavior); } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> behavior; }</code> <br>        ,  <a href="http://msdn.microsoft.com/en-us/library/cc265152(VS.95).aspx">Attached Properties Overview</a>  MSDN. <br> <br>    <br>              . ,     Silverlight,    -,     ,      ,     .     ,       . <br> <br>        ,    ( )  ,  ,     .  UI       ,            UI. <br> <br>      - <br>   -     ,       <code>IAsyncResult</code> .   ,  ,   ,  <code>GetQuestionnaire</code> ,   : <code>BeginGetQuestionnaire</code>  <code>EndGetQuestionnaire</code> .    ,   <code>BeginGetQuestionnaire</code> .     ,   ,   <code>EndGetQuestionnaire</code>    . <br> <b></b> <br>  .NET Framework <span class="hljs-number"><span class="hljs-number">4.5</span></span>      <code>await</code>  <code>async</code>     <code>*Async</code> .      <a href="http://msdn.microsoft.com/en-us/library/vstudio/hh391443.aspx"><span class="hljs-string"><span class="hljs-string">"Asynchronous Programming with Async and Await (C# and Visual Basic)"</span></span></a> . <br>  ,    <code>EndGetQuestionnaire</code> ,      ,  ()      <code>BeginGetQuestionnaire</code> .     ,      ,   <code>EndGetQuestionnaire</code> ,   . <br> <br> <code class="xml">IAsyncResult asyncResult = this.service.BeginGetQuestionnaire( GetQuestionnaireCompleted, null //  ,      ); private void GetQuestionnaireCompleted(IAsyncResult result) { try { questionnaire = this.service.EndGetQuestionnaire(ar); } catch (Exception ex) { //  -   . } }</code> <br>  ,     <code>End*</code> (  , <code>EndGetQuestionnaire</code> ),    ,      .      , ,          UI.     ,   ,        . <br> <br>        UI,     -,      UI,         UI,   <code>Dispatcher</code>    <code>SynchronizationContext</code> .  WPF  Silverlight,   <code>Dispatcher</code> . <br> <br>      <code>Questionnaire</code>  ,        <code>QuestionnaireView</code> .  Silverlight    <code>CheckAccess</code> ,  ,      UI.  ,     <code>BeginInvoke</code> ,      UI. <br> <br> <code class="cs">var dispatcher = System.Windows.Deployment.Current.Dispatcher; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (dispatcher.CheckAccess()) { QuestionnaireView.DataContext = questionnaire; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { dispatcher.BeginInvoke(() =&gt; { Questionnaire.DataContext = questionnaire; }); }</code> <br> <i>MVVM RI</i>   ,    ,   <code>IAsyncResult</code> ,   .      ,                 . ,       . <br> <br> <code class="cs">this.questionnaireRepository.GetQuestionnaireAsync( result =&gt; { this.Questionnaire = result.Result; });</code> <br>  <code>result</code>   ,     , , , .    ,     . <br> <br> <code class="cs">this.questionnaireRepository.GetQuestionnaireAsync( result =&gt; { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (result.Error == null) { this.Questionnaire = result.Result; ... } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { // Handle error. } })</code> <br>     <br>        ,      .     , ,             .        ,      ,     ,     . <br> <br>         ,      MVVM,     ,   . ,  -MVVM ,     <code>MessageBox</code>   code-behind UI,      .   MVVM     ,          . <br> <br>     MVVM,              ,          .      ,    ,   ,  ,     . <br> <br>              MVVM.      ,     ,     ,  ,     .    ,         ,     ,          .       . <br> <br>    <br>                  .        ,        .  ,         .         . <br> <br>  ,         ,         ,  .      ,     .           ,       . ,        WPF  Silverlight,        . <br> <br> <img title="Using the service to interact with the user." src="https://habrastorage.org/getpro/habr/post_images/4b5/397/f2d/4b5397f2d02e5851195b29f1893be6fc.png" alt=" ,    ."> <br> <br>  ,   <code>MessageBox</code>        ,     ,    ,     . <br> <br> <code class="cs">var result = interactionService.ShowMessageBox( <span class="hljs-string"><span class="hljs-string">"Are you sure you want to cancel this operation?"</span></span>, <span class="hljs-string"><span class="hljs-string">"Confirm"</span></span>, MessageBoxButton.OK); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (result == MessageBoxResult.Yes) { CancelRequest(); }</code> <br> ,      - ,      ,         Silverlight.         .             .     . <br> <br> <code class="cs">interactionService.ShowMessageBox( <span class="hljs-string"><span class="hljs-string">"Are you sure you want to cancel this operation?"</span></span>, <span class="hljs-string"><span class="hljs-string">"Confirm"</span></span>, MessageBoxButton.OK, result =&gt; { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (result == MessageBoxResult.Yes) { CancelRequest(); } });</code> <br>         ,      . ,  WPF    <code>MessageBox</code> ,       ;    Silverlight    ,    . <br> <br>     <br>         ‚Äì             .         ,      .     ,     .        ,        ,   ,     . <br> <br> <img title="Using interaction request objects." src="https://habrastorage.org/getpro/habr/post_images/3d0/ff0/1c5/3d0ff01c5518558c2d3c5c5f47ce0ce9.png" alt="   ."> <br> <br>    ,   ,          ‚Äì       ,      ,   ‚Äì     .   ,        ,    ,    UI            . <br> <br>       MVVM,     ,       ,         .         ,        ,    ,   . <br> <br>  Prism       <code>IInteractionRequest</code>   <code><code>InteractionRequest .  IInteractionRequest</code>  ,   .           ,   .  <code><code>InteractionRequest   IInteractionRequest</code>     <code>Raise</code> ,           , , ,   . <br> <br>       <br>  <code><code>InteractionRequest          .  Raise</code>          ( <code>T</code> )    ,    ,   .          ,       .      ,        .    ,  ,     . <br> <code class="cs">public interface IInteractionRequest { event EventHandler&lt;InteractionRequestedEventArgs&gt; Raised; } public class InteractionRequest&lt;T&gt; : IInteractionRequest { public event EventHandler&lt;InteractionRequestedEventArgs&gt; Raised; public void Raise(T context, Action&lt;T&gt; callback) { var handler = this.Raised; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (handler != null) { handler( this, new InteractionRequestedEventArgs(context, () =&gt; callback(context))); } } }</code> <br> Prism    ,      .  <code>Notification</code>       .    ,            .     ‚Äì <code>Title</code>  <code>Content</code> ,    .  ,   ,  ,  ,        . <br> <br>  <code>Confirmation</code>    <code>Notification</code>     ‚Äì <code>Confirmed</code> ,  ,  ,      .  <code>Confirmation</code> ,     <code>MessageBox</code> ,     /  .     ,     <code>Notification</code> ,     ,      . <br> <br>    <code><code><code>InteractionRequest ,       InteractionRequest      ,      .      ,    Raise</code> ,    , ,   . <br> <br> <code class="cs">public IInteractionRequest ConfirmCancelInteractionRequest { get { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> this.confirmCancelInteractionRequest; } } this.confirmCancelInteractionRequest.Raise( new Confirmation(<span class="hljs-string"><span class="hljs-string">"Are you sure you wish to cancel?"</span></span>), confirmation =&gt; { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (confirmation.Confirmed) { this.NavigateToQuestionnaireList(); } }); }</code> <br> <i>MVVM Reference Implementation (MVVM RI)</i> ,    <code>IInteractionRequest</code>   <code><code>InteractionRequest ,          (. QuestionnaireViewModel.cs</code> ). <br> <br>        <br>       ,       .   ,       .    UI             . <br> <br>                . Microsoft Expression Blend Behaviors Framework     .  ,     ,    . <br> <br>  <code>EventTrigger</code> ,  Expression Blend,  ,      ,     ,   . , Prism   <code>EventTrigger</code> ,  <code>InteractionRequestTrigger</code> ,      <code>Raised</code>   <code>IInteractionRequest</code> .    XAML        . <br> <br>  ,   , <code>InteractionRequestTrigger</code>   .  Silverlight Prism   <code>PopupChildWindowAction</code> ,     .    ,         .   <code>ContentTemplate</code>  <code>PopupChildWindowAction</code> ,    ,    UI,      <code>Content</code>  .       <code>Title</code>  . <br> <b></b> <br>  ,    ,   <code>PopupChildWindowAction</code> ,     .    <code>Notification</code>  <code>NotificationChildWindow</code> ,        <code>Confirmation</code> ‚Äì <code>ConfirmationChildWindow</code> . <code>NotificationChildWindow</code>    ,   ,     <code>ConfirmationChildWindow</code>    <i>OK</i>  <i>Cancel</i> ,    .    ,   ,   <code>ChildWindow</code>  <code>PopupChildWindowAction</code> . <br>   ,  <code>InteractionRequestTrigger</code>  <code>PopupChildWindowAction</code> ,       <i>RI MVVM</i> . <br> <br> <code class="xml">&lt;i:Interaction.Triggers&gt; &lt;prism:InteractionRequestTrigger SourceObject=<span class="hljs-string"><span class="hljs-string">"{Binding ConfirmCancelInteractionRequest}"</span></span>&gt; &lt;prism:PopupChildWindowAction ContentTemplate=<span class="hljs-string"><span class="hljs-string">"{StaticResource ConfirmWindowTemplate}"</span></span>/&gt; &lt;/prism:InteractionRequestTrigger&gt; &lt;/i:Interaction.Triggers&gt; &lt;UserControl.Resources&gt; &lt;DataTemplate x:Key=<span class="hljs-string"><span class="hljs-string">"ConfirmWindowTemplate"</span></span>&gt; &lt;Grid MinWidth=<span class="hljs-string"><span class="hljs-string">"250"</span></span> MinHeight=<span class="hljs-string"><span class="hljs-string">"100"</span></span>&gt; &lt;TextBlock TextWrapping=<span class="hljs-string"><span class="hljs-string">"Wrap"</span></span> Grid.Row=<span class="hljs-string"><span class="hljs-string">"0"</span></span> Text=<span class="hljs-string"><span class="hljs-string">"{Binding}"</span></span>/&gt; &lt;/Grid&gt; &lt;/DataTemplate&gt; &lt;/UserControl.Resources&gt;</code> <br> <b></b> <br>      <code>ContentTemplate</code> ,   UI   <code>Content</code>  .    <code>Content</code>  ,  , <code>TextBlock</code>     <code>Content</code> . <br>      ,     ,    ,    .  ,     ,       ,     ,    .   ,   <i>RI MVVM</i> ,         <code>Confirmed</code>    <code>Confirmation</code>  <code><span class="hljs-keyword"><span class="hljs-keyword">true</span></span></code> ,     OK. <br> <br>        ,     .  Prism <code>InteractionRequestTrigger</code>   <code>PopupChildWindowAction</code>            . <br> <br>     <br>     MVVM,       , ,    ,         .        (  , ,  ,   ).    ,  ,  ,            . <br> <br>        ,         . Managed Extensibility Framework (MEF)  Unity Application Block (Unity)      ,  ,           . <br> <br>  ,       , , ,    ( )      . ,       ,     .  ,     ,       . <br> <br>     ,  MEF <br>  MEF,       ,   <code>Import</code> ,      ,  ,   <code><span class="hljs-keyword"><span class="hljs-keyword">Export</span></span></code> .         ,    . <br> <br> , <code>QuestionnaireView</code>   <i>RI MVVM</i> ,        ,    <code>Import</code> .   , MEF           .  <code><span class="hljs-keyword"><span class="hljs-keyword">set</span></span></code>        ,   . <br> <br> <code class="cs">[Import] public QuestionnaireViewModel ViewModel { <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> { this.DataContext = value; } }</code> <br>     ,   . <br> <br> <code class="cs">[<span class="hljs-keyword"><span class="hljs-keyword">Export</span></span>] public class QuestionnaireViewModel : NotificationObject { ... }</code> <br>        ,   . <br> <br> <code class="cs">public QuestionnaireView() { InitializeComponent(); } [ImportingConstructor] public QuestionnaireView(QuestionnaireViewModel viewModel) : this() { this.DataContext = viewModel; }</code> <br> <b></b> <br>          MEF,   Unity.   ,     ,        .   ,   Visual Studio  Expression Blend, ,        ,     .   ,   ,  ,      ,          <code>InitializeComponent</code> . <br>     ,  Unity <br>  Unity,    ,   MEF.     ,      .    ,         .  ,      . <br> <br>  ,      ,  ,         . ,           ,   . <br> <br> <code class="cs">public QuestionnaireView() { InitializeComponent(); } public QuestionnaireView(QuestionnaireViewModel viewModel) : this() { this.DataContext = viewModel; }</code> <br> <b></b> <br>    ,        ,   Visual Studio  Expression Blend. <br>  ,          ,   . Unity        <code><span class="hljs-keyword"><span class="hljs-keyword">set</span></span></code>   ,   . <br> <br> <code class="cs">public QuestionnaireView() { InitializeComponent(); } [Dependency] public QuestionnaireViewModel ViewModel { <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> { this.DataContext = value; } }</code> <br>       Unity. <br> <br> <code class="cs">container.RegisterType&lt;QuestionnaireViewModel&gt;();</code> <br>  ,     . <br> <br> <code class="cs">var view = container.Resolve&lt;QuestionnaireView&gt;();</code> <br>     ,    <br>   ,     ,        .        ,   MEF  Unity,        . <br> <br>          .   ,         UI,           . <br> <br> , <i>RI MVVM</i>   ,   ,        .   ,    .      <code>ShowView</code>   UI. <br> <br> <code class="cs">private void NavigateToQuestionnaireList() { //     <span class="hljs-string"><span class="hljs-string">"questionnaire list"</span></span>. this.uiService.ShowView(ViewNames.QuestionnaireTemplatesList); }</code> <br>  UI      UI .           UI.  <code>ShowView</code>  <code>UIService</code>      (,          ),       ,   . <br> <br> <code class="cs">public void ShowView(<span class="hljs-keyword"><span class="hljs-keyword">string</span></span> viewName) { var view = this.ViewFactory.GetView(viewName); this.MainWindow.CurrentView = view; }</code> <br> <b></b> <br> Prism       .   ,   ,   ,             .    ,  , <span class="hljs-string"><span class="hljs-string">" </span></span><a href="http://msdn.microsoft.com/en-us/library/gg430861(v%3DPandP.40).aspx"><span class="hljs-string"><span class="hljs-string">View-Based Navigation</span></span></a><span class="hljs-string"><span class="hljs-string"> "</span></span>   <span class="hljs-number"><span class="hljs-number">8</span></span>, <span class="hljs-string"><span class="hljs-string">" </span></span><a href="http://msdn.microsoft.com/en-us/library/gg430861(v%3DPandP.40).aspx"><span class="hljs-string"><span class="hljs-string">Navigation</span></span></a><span class="hljs-string"><span class="hljs-string"> "</span></span>. <br>  MVVM  <br>        MVVM      .           -      mocking . ,   ,        . <br> <br>   <i>INotifyPropertyChanged</i> <br>   <code>INotifyPropertyChanged</code>     ,      .      ,    ;   ,   ,     ,    ,       . <br> <br>   <br> ,       ,           <code>PropertyChanged</code>  ,         .  ,    <code>ChangeTracker</code> ,     MVVM,  ,      .      .     ,    . <br> <br> <code class="cs">var changeTracker = new PropertyChangeTracker(viewModel); viewModel.CurrentState = <span class="hljs-string"><span class="hljs-string">"newState"</span></span>; CollectionAssert.Contains(changeTracker.ChangedProperties, <span class="hljs-string"><span class="hljs-string">"CurrentState"</span></span>);</code> <br> ,     ,     <code>INotifyPropertyChanged</code> ,    ,   ,     . <br> <br>      <br>        ,   ,    <code><span class="hljs-keyword"><span class="hljs-keyword">set</span></span></code>      ,           . ,     ,     ,      ,          . <br> <br> <code class="cs">var changeTracker = new PropertyChangeTracker(viewModel); var question = viewModel.Questions.First() as OpenQuestionViewModel; question.Question.Response = <span class="hljs-string"><span class="hljs-string">"some text"</span></span>; CollectionAssert.Contains(changeTracker.ChangedProperties, <span class="hljs-string"><span class="hljs-string">"UnansweredQuestions"</span></span>);</code> <br>      <br>     <code>INotifyPropertyChanged</code> ,      <code>PropertyChanged</code>        ,  ,     , , .        ,       . <br> <br>   <i>INotifyDataErrorInfo</i> <br>   ,     ,    ,   ,   <code>IDataErrorInfo</code> ,  ( Silverlight)   <code>INotifyDataErrorInfo</code> .   <code>INotifyDataErrorInfo</code>   ,         ,    ,  ,   ,    . <br> <br>       <code>INotifyDataErrorInfo</code> : ,     ,  ,     ,     <code>ErrorsChanged</code> ,      <code>GetErrors</code> , . <br> <br>    <br>     ,      ,     .       ,         <code>GetErrors</code>       ,  ,  ,   .    , ,  ,     ,        .   ,        . <br> <br> <code class="cs">//  . var notifyErrorInfo = (INotifyDataErrorInfo)question; question.Response = -<span class="hljs-number"><span class="hljs-number">15</span></span>; Assert.IsTrue(notifyErrorInfo.GetErrors(<span class="hljs-string"><span class="hljs-string">"Response"</span></span>).Cast&lt;ValidationResult&gt;().Any()); //  . var notifyErrorInfo = (INotifyDataErrorInfo)question; question.Response = <span class="hljs-number"><span class="hljs-number">15</span></span>; Assert.IsFalse(notifyErrorInfo.GetErrors(<span class="hljs-string"><span class="hljs-string">"Response"</span></span>).Cast&lt;ValidationResult&gt;().Any());</code> <br>    ,    ,             . <br> <br>    <i>INotifyDataErrorInfo</i> <br>       <code>GetErrors</code> ,   <code>INotifyDataErrorInfo</code>  ,   <code>ErrorsChanged</code>      <code>GetErrors</code> . ,  <code>HasErrors</code>      ,  . <br> <br>       <code>INotifyDataErrorInfo</code> . , ,           ,   -  .      ,        <code>INotifyDataErrorInfo</code>         (,        ). <br> <br>     ,   ,  : <br>  <code>HasErrors</code>     .              ,       .  <code>ErrorsChanged</code> ,      ,         <code>GetErrors</code> .         ( ,  )     ,           .    <code>GetErrors</code>       <code>ErrorsChanged</code> . <br>    <code>INotifyPropertyChanged</code> ,  ,    <code>NotifyDataErrorInfoTestHelper</code>    MVVM,        <code>INotifyDataErrorInfo</code> ,       .   ,   ,      ,   .      . <br> <code class="cs">var helper = new NotifyDataErrorInfoTestHelper&lt;NumericQuestion, int?&gt;( question, q =&gt; q.Response); helper.ValidatePropertyChange( <span class="hljs-number"><span class="hljs-number">6</span></span>, NotifyDataErrorInfoBehavior.Nothing); helper.ValidatePropertyChange( <span class="hljs-number"><span class="hljs-number">20</span></span>, NotifyDataErrorInfoBehavior.FiresErrorsChanged | NotifyDataErrorInfoBehavior.HasErrors | NotifyDataErrorInfoBehavior.HasErrorsForProperty); helper.ValidatePropertyChange( null, NotifyDataErrorInfoBehavior.FiresErrorsChanged | NotifyDataErrorInfoBehavior.HasErrors | NotifyDataErrorInfoBehavior.HasErrorsForProperty); helper.ValidatePropertyChange( <span class="hljs-number"><span class="hljs-number">2</span></span>, NotifyDataErrorInfoBehavior.FiresErrorsChanged);</code> <br>     <br>   MVVM,     ,  .   ,    ,         . <br> <br>  ,     ,     ,       .   ,   , ,       ,     ,   <code>IAsyncResult</code>    ,  - ,   ,    UI. <br> <br>       , , ,    .   ,     .  ,      UI,     ,   ,          ,     ,        <span class="hljs-string"><span class="hljs-string">"   UI."</span></span> <br> <br>     ,    ,    .   ,    ,     mock-, ,   ,   ,      ,          . <br> <br>           UI,    ,    .   ,     ,   ,      .        ,   .     ,    ,     . <br> <br> <code class="cs">questionnaireRepositoryMock .Setup( r =&gt; r.SubmitQuestionnaireAsync( It.IsAny&lt;Questionnaire&gt;(), It.IsAny&lt;Action&lt;IOperationResult&gt;&gt;())) .Callback&lt;Questionnaire, Action&lt;IOperationResult&gt;&gt;( (q, a) =&gt; callback = a); uiServicemock .Setup(svc =&gt; svc.ShowView(ViewNames.QuestionnaireTemplatesList)) .Callback&lt;<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>&gt;(viewName =&gt; requestedViewName = viewName); submitResultMock .Setup(sr =&gt; sr.Error) .Returns&lt;Exception&gt;(null); CompleteQuestionnaire(viewModel); viewModel.Submit(); //      UI . callback(submitResultMock.Object); //    ‚Äì     . Assert.AreEqual(ViewNames.QuestionnaireTemplatesList, requestedViewName);</code> <br> <b></b> <br>          ,        . <br>   <br>       , . <span class="hljs-string"><span class="hljs-string">"Trees in WPF"</span></span>  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ms753391.aspx">http://msdn.microsoft.com/en-us/library/ms753391.aspx</a> <br> <br>       , . <span class="hljs-string"><span class="hljs-string">"Attached Properties Overview"</span></span>  MSDN: <a href="http://msdn.microsoft.com/en-us/library/cc265152(VS.95).aspx">http://msdn.microsoft.com/en-us/library/cc265152(VS.<span class="hljs-number"><span class="hljs-number">95</span></span>).aspx</a> <br> <br>      MEF, .<span class="hljs-string"><span class="hljs-string">"Managed Extensibility Framework Overview"</span></span>  MSDN: <a href="http://msdn.microsoft.com/en-us/library/dd460648.aspx">http://msdn.microsoft.com/en-us/library/dd460648.aspx</a> . <br> <br>      Unity, .<span class="hljs-string"><span class="hljs-string">"Unity Application Block"</span></span>  MSDN: <a href="http://www.msdn.com/unity">http://www.msdn.com/unity</a> . <br> <br>      <code>DelegateCommand</code> , .Chapter <span class="hljs-number"><span class="hljs-number">5</span></span>, <span class="hljs-string"><span class="hljs-string">" </span></span><a href="http://msdn.microsoft.com/en-us/library/gg405484(v%3DPandP.40).aspx"><span class="hljs-string"><span class="hljs-string">Implementing the MVVM Pattern</span></span></a><span class="hljs-string"><span class="hljs-string"> ."</span></span> <br> <br>        Microsoft Expression Blend, .<span class="hljs-string"><span class="hljs-string">"Working with built-in behaviors"</span></span>  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ff724013(v%3DExpression.40).aspx">http://msdn.microsoft.com/en-us/library/ff724013(v=Expression.<span class="hljs-number"><span class="hljs-number">40</span></span>).aspx</a> . <br> <br>          Microsoft Expression Blend, .<span class="hljs-string"><span class="hljs-string">"Creating Custom Behaviors"</span></span>  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ff724708(v%3DExpression.40).aspx">http://msdn.microsoft.com/en-us/library/ff724708(v=Expression.<span class="hljs-number"><span class="hljs-number">40</span></span>).aspx</a> . <br> <br>            Microsoft Expression Blend, .<span class="hljs-string"><span class="hljs-string">"Creating Custom Triggers and Actions"</span></span>  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ff724707(v%3DExpression.40).aspx">http://msdn.microsoft.com/en-us/library/ff724707(v=Expression.<span class="hljs-number"><span class="hljs-number">40</span></span>).aspx</a> . <br> <br>         WPF  Silverlight, .<span class="hljs-string"><span class="hljs-string">"Threading Model"</span></span>  <span class="hljs-string"><span class="hljs-string">"The Dispatcher Class"</span></span>  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ms741870.aspx">http://msdn.microsoft.com/en-us/library/ms741870.aspx</a> <br> <a href="http://msdn.microsoft.com/en-us/library/ms615907(v%3DVS.95).aspx">http://msdn.microsoft.com/en-us/library/ms615907(v=VS.<span class="hljs-number"><span class="hljs-number">95</span></span>).aspx</a> . <br> <br>      unit-  Silverlight, .<span class="hljs-string"><span class="hljs-string">"Unit Testing with Silverlight 2"</span></span>: <a href="http://www.jeff.wilcox.name/2008/03/silverlight2-unit-testing/">http://www.jeff.wilcox.name/<span class="hljs-number"><span class="hljs-number">2008</span></span>/<span class="hljs-number"><span class="hljs-number">03</span></span>/silverlight2-unit-testing/</a> . <br> <br>         , .  <span class="hljs-string"><span class="hljs-string">" </span></span><a href="http://msdn.microsoft.com/en-us/library/gg430861(v%3DPandP.40).aspx"><span class="hljs-string"><span class="hljs-string">View-Based Navigation</span></span></a><span class="hljs-string"><span class="hljs-string"> "</span></span> in Chapter <span class="hljs-number"><span class="hljs-number">8</span></span>, <span class="hljs-string"><span class="hljs-string">" </span></span><a href="http://msdn.microsoft.com/en-us/library/gg430861(v%3DPandP.40).aspx"><span class="hljs-string"><span class="hljs-string">Navigation</span></span></a><span class="hljs-string"><span class="hljs-string"> ."</span></span> <br> <br>       ,   , .<span class="hljs-string"><span class="hljs-string">"Event-based Asynchronous Pattern Overview"</span></span>  MSDN: <a href="http://msdn.microsoft.com/en-us/library/wewwczdw.aspx">http://msdn.microsoft.com/en-us/library/wewwczdw.aspx</a> <br> <br>        <code>IAsyncResult</code> , .<span class="hljs-string"><span class="hljs-string">"Asynchronous Programming Overview"</span></span>  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ms228963.aspx">http://msdn.microsoft.com/en-us/library/ms228963.aspx</a></code></code></code></code></code></code></code></code></code> </pre> <code><code><code><code><code><code><code><code><code><code>CommandBehaviorBase ,    ,    ICommand</code> .           <code>CanExecuteChanged</code> ,          Silverlight,    WPF. <br> <br>    ,  ,   <code>CommandBehaviorBase    ,    .         ,      .         ,    .      ButtonBaseClickCommandBehavior</code> . <br> <br> <code class="cs">public class ButtonBaseClickCommandBehavior : CommandBehaviorBase&lt;ButtonBase&gt; { public ButtonBaseClickCommandBehavior(ButtonBase clickableObject) : base(clickableObject) { clickableObject.Click += OnClick; } private void OnClick(object sender, System.Windows.RoutedEventArgs e) { ExecuteCommand(); } }</code> <br>   <code>CommandBehaviorBase ,     .     ,          ,   . ,    ,    ,      , ,    CanExecute</code>  ,     . <br> <br>          ,   .           XAML.           .       .  Prism      ,       ,  ,   .       ,    . , ,  ,      <code>Click</code> ,       <code>Command</code> .    <code>Click.Command</code> ,  . <br> <br>             .             . <br> <br> <code class="cs">public static readonly DependencyProperty CommandProperty = DependencyProperty.RegisterAttached( "Command", typeof(ICommand), typeof(Click), new PropertyMetadata(OnSetCommandCallback)); private static readonly DependencyProperty ClickCommandBehaviorProperty = DependencyProperty.RegisterAttached( "ClickCommandBehavior", typeof(ButtonBaseClickCommandBehavior), typeof(Click), null);</code> <br>    <code>Command</code>    <code>ButtonBaseClickCommandBehavior</code> ,     <code>OnSetCommandCallback</code> ,     . <br> <br> <code class="cs">private static void OnSetCommandCallback(DependencyObject dependencyObject, DependencyPropertyChangedEventArgs e) { ButtonBase buttonBase = dependencyObject as ButtonBase; if (buttonBase != null) { ButtonBaseClickCommandBehavior behavior = GetOrCreateBehavior(buttonBase); behavior.Command = e.NewValue as ICommand; } } private static void OnSetCommandParameterCallback(DependencyObject dependencyObject, DependencyPropertyChangedEventArgs e) { ButtonBase buttonBase = dependencyObject as ButtonBase; if (buttonBase != null) { ButtonBaseClickCommandBehavior behavior = GetOrCreateBehavior(buttonBase); behavior.CommandParameter = e.NewValue; } } private static ButtonBaseClickCommandBehavior GetOrCreateBehavior(ButtonBase buttonBase ) { ButtonBaseClickCommandBehavior behavior = buttonBase.GetValue(ClickCommandBehaviorProperty) as ButtonBaseClickCommandBehavior; if ( behavior == null ) { behavior = new ButtonBaseClickCommandBehavior(buttonBase); buttonBase.SetValue(ClickCommandBehaviorProperty, behavior); } return behavior; }</code> <br>        ,  <a href="http://msdn.microsoft.com/en-us/library/cc265152(VS.95).aspx">Attached Properties Overview</a>  MSDN. <br> <br>    <br>              . ,     Silverlight,    -,     ,      ,     .     ,       . <br> <br>        ,    ( )  ,  ,     .  UI       ,            UI. <br> <br>      - <br>   -     ,       <code>IAsyncResult</code> .   ,  ,   ,  <code>GetQuestionnaire</code> ,   : <code>BeginGetQuestionnaire</code>  <code>EndGetQuestionnaire</code> .    ,   <code>BeginGetQuestionnaire</code> .     ,   ,   <code>EndGetQuestionnaire</code>    . <br> <b></b> <br>  .NET Framework 4.5      <code>await</code>  <code>async</code>     <code>*Async</code> .      <a href="http://msdn.microsoft.com/en-us/library/vstudio/hh391443.aspx">"Asynchronous Programming with Async and Await (C# and Visual Basic)"</a> . <br>  ,    <code>EndGetQuestionnaire</code> ,      ,  ()      <code>BeginGetQuestionnaire</code> .     ,      ,   <code>EndGetQuestionnaire</code> ,   . <br> <br> <code class="xml">IAsyncResult asyncResult = this.service.BeginGetQuestionnaire( GetQuestionnaireCompleted, null //  ,      ); private void GetQuestionnaireCompleted(IAsyncResult result) { try { questionnaire = this.service.EndGetQuestionnaire(ar); } catch (Exception ex) { //  -   . } }</code> <br>  ,     <code>End*</code> (  , <code>EndGetQuestionnaire</code> ),    ,      .      , ,          UI.     ,   ,        . <br> <br>        UI,     -,      UI,         UI,   <code>Dispatcher</code>    <code>SynchronizationContext</code> .  WPF  Silverlight,   <code>Dispatcher</code> . <br> <br>      <code>Questionnaire</code>  ,        <code>QuestionnaireView</code> .  Silverlight    <code>CheckAccess</code> ,  ,      UI.  ,     <code>BeginInvoke</code> ,      UI. <br> <br> <code class="cs">var dispatcher = System.Windows.Deployment.Current.Dispatcher; if (dispatcher.CheckAccess()) { QuestionnaireView.DataContext = questionnaire; } else { dispatcher.BeginInvoke(() =&gt; { Questionnaire.DataContext = questionnaire; }); }</code> <br> <i>MVVM RI</i>   ,    ,   <code>IAsyncResult</code> ,   .      ,                 . ,       . <br> <br> <code class="cs">this.questionnaireRepository.GetQuestionnaireAsync( result =&gt; { this.Questionnaire = result.Result; });</code> <br>  <code>result</code>   ,     , , , .    ,     . <br> <br> <code class="cs">this.questionnaireRepository.GetQuestionnaireAsync( result =&gt; { if (result.Error == null) { this.Questionnaire = result.Result; ... } else { // Handle error. } })</code> <br>     <br>        ,      .     , ,             .        ,      ,     ,     . <br> <br>         ,      MVVM,     ,   . ,  -MVVM ,     <code>MessageBox</code>   code-behind UI,      .   MVVM     ,          . <br> <br>     MVVM,              ,          .      ,    ,   ,  ,     . <br> <br>              MVVM.      ,     ,     ,  ,     .    ,         ,     ,          .       . <br> <br>    <br>                  .        ,        .  ,         .         . <br> <br>  ,         ,         ,  .      ,     .           ,       . ,        WPF  Silverlight,        . <br> <br> <img title="Using the service to interact with the user." src="https://habrastorage.org/getpro/habr/post_images/4b5/397/f2d/4b5397f2d02e5851195b29f1893be6fc.png" alt=" ,    ."> <br> <br>  ,   <code>MessageBox</code>        ,     ,    ,     . <br> <br> <code class="cs">var result = interactionService.ShowMessageBox( "Are you sure you want to cancel this operation?", "Confirm", MessageBoxButton.OK); if (result == MessageBoxResult.Yes) { CancelRequest(); }</code> <br> ,      - ,      ,         Silverlight.         .             .     . <br> <br> <code class="cs">interactionService.ShowMessageBox( "Are you sure you want to cancel this operation?", "Confirm", MessageBoxButton.OK, result =&gt; { if (result == MessageBoxResult.Yes) { CancelRequest(); } });</code> <br>         ,      . ,  WPF    <code>MessageBox</code> ,       ;    Silverlight    ,    . <br> <br>     <br>         ‚Äì             .         ,      .     ,     .        ,        ,   ,     . <br> <br> <img title="Using interaction request objects." src="https://habrastorage.org/getpro/habr/post_images/3d0/ff0/1c5/3d0ff01c5518558c2d3c5c5f47ce0ce9.png" alt="   ."> <br> <br>    ,   ,          ‚Äì       ,      ,   ‚Äì     .   ,        ,    ,    UI            . <br> <br>       MVVM,     ,       ,         .         ,        ,    ,   . <br> <br>  Prism       <code>IInteractionRequest</code>   <code>InteractionRequest .  IInteractionRequest</code>  ,   .           ,   .  <code>InteractionRequest   IInteractionRequest</code>     <code>Raise</code> ,           , , ,   . <br> <br>       <br>  <code>InteractionRequest          .  Raise</code>          ( <code>T</code> )    ,    ,   .          ,       .      ,        .    ,  ,     . <br> <code class="cs">public interface IInteractionRequest { event EventHandler&lt;InteractionRequestedEventArgs&gt; Raised; } public class InteractionRequest&lt;T&gt; : IInteractionRequest { public event EventHandler&lt;InteractionRequestedEventArgs&gt; Raised; public void Raise(T context, Action&lt;T&gt; callback) { var handler = this.Raised; if (handler != null) { handler( this, new InteractionRequestedEventArgs(context, () =&gt; callback(context))); } } }</code> <br> Prism    ,      .  <code>Notification</code>       .    ,            .     ‚Äì <code>Title</code>  <code>Content</code> ,    .  ,   ,  ,  ,        . <br> <br>  <code>Confirmation</code>    <code>Notification</code>     ‚Äì <code>Confirmed</code> ,  ,  ,      .  <code>Confirmation</code> ,     <code>MessageBox</code> ,     /  .     ,     <code>Notification</code> ,     ,      . <br> <br>    <code>InteractionRequest ,       InteractionRequest      ,      .      ,    Raise</code> ,    , ,   . <br> <br> <code class="cs">public IInteractionRequest ConfirmCancelInteractionRequest { get { return this.confirmCancelInteractionRequest; } } this.confirmCancelInteractionRequest.Raise( new Confirmation("Are you sure you wish to cancel?"), confirmation =&gt; { if (confirmation.Confirmed) { this.NavigateToQuestionnaireList(); } }); }</code> <br> <i>MVVM Reference Implementation (MVVM RI)</i> ,    <code>IInteractionRequest</code>   <code>InteractionRequest ,          (. QuestionnaireViewModel.cs</code> ). <br> <br>        <br>       ,       .   ,       .    UI             . <br> <br>                . Microsoft Expression Blend Behaviors Framework     .  ,     ,    . <br> <br>  <code>EventTrigger</code> ,  Expression Blend,  ,      ,     ,   . , Prism   <code>EventTrigger</code> ,  <code>InteractionRequestTrigger</code> ,      <code>Raised</code>   <code>IInteractionRequest</code> .    XAML        . <br> <br>  ,   , <code>InteractionRequestTrigger</code>   .  Silverlight Prism   <code>PopupChildWindowAction</code> ,     .    ,         .   <code>ContentTemplate</code>  <code>PopupChildWindowAction</code> ,    ,    UI,      <code>Content</code>  .       <code>Title</code>  . <br> <b></b> <br>  ,    ,   <code>PopupChildWindowAction</code> ,     .    <code>Notification</code>  <code>NotificationChildWindow</code> ,        <code>Confirmation</code> ‚Äì <code>ConfirmationChildWindow</code> . <code>NotificationChildWindow</code>    ,   ,     <code>ConfirmationChildWindow</code>    <i>OK</i>  <i>Cancel</i> ,    .    ,   ,   <code>ChildWindow</code>  <code>PopupChildWindowAction</code> . <br>   ,  <code>InteractionRequestTrigger</code>  <code>PopupChildWindowAction</code> ,       <i>RI MVVM</i> . <br> <br> <code class="xml">&lt;i:Interaction.Triggers&gt; &lt;prism:InteractionRequestTrigger SourceObject="{Binding ConfirmCancelInteractionRequest}"&gt; &lt;prism:PopupChildWindowAction ContentTemplate="{StaticResource ConfirmWindowTemplate}"/&gt; &lt;/prism:InteractionRequestTrigger&gt; &lt;/i:Interaction.Triggers&gt; &lt;UserControl.Resources&gt; &lt;DataTemplate x:Key="ConfirmWindowTemplate"&gt; &lt;Grid MinWidth="250" MinHeight="100"&gt; &lt;TextBlock TextWrapping="Wrap" Grid.Row="0" Text="{Binding}"/&gt; &lt;/Grid&gt; &lt;/DataTemplate&gt; &lt;/UserControl.Resources&gt;</code> <br> <b></b> <br>      <code>ContentTemplate</code> ,   UI   <code>Content</code>  .    <code>Content</code>  ,  , <code>TextBlock</code>     <code>Content</code> . <br>      ,     ,    ,    .  ,     ,       ,     ,    .   ,   <i>RI MVVM</i> ,         <code>Confirmed</code>    <code>Confirmation</code>  <code>true</code> ,     OK. <br> <br>        ,     .  Prism <code>InteractionRequestTrigger</code>   <code>PopupChildWindowAction</code>            . <br> <br>     <br>     MVVM,       , ,    ,         .        (  , ,  ,   ).    ,  ,  ,            . <br> <br>        ,         . Managed Extensibility Framework (MEF)  Unity Application Block (Unity)      ,  ,           . <br> <br>  ,       , , ,    ( )      . ,       ,     .  ,     ,       . <br> <br>     ,  MEF <br>  MEF,       ,   <code>Import</code> ,      ,  ,   <code>Export</code> .         ,    . <br> <br> , <code>QuestionnaireView</code>   <i>RI MVVM</i> ,        ,    <code>Import</code> .   , MEF           .  <code>set</code>        ,   . <br> <br> <code class="cs">[Import] public QuestionnaireViewModel ViewModel { set { this.DataContext = value; } }</code> <br>     ,   . <br> <br> <code class="cs">[Export] public class QuestionnaireViewModel : NotificationObject { ... }</code> <br>        ,   . <br> <br> <code class="cs">public QuestionnaireView() { InitializeComponent(); } [ImportingConstructor] public QuestionnaireView(QuestionnaireViewModel viewModel) : this() { this.DataContext = viewModel; }</code> <br> <b></b> <br>          MEF,   Unity.   ,     ,        .   ,   Visual Studio  Expression Blend, ,        ,     .   ,   ,  ,      ,          <code>InitializeComponent</code> . <br>     ,  Unity <br>  Unity,    ,   MEF.     ,      .    ,         .  ,      . <br> <br>  ,      ,  ,         . ,           ,   . <br> <br> <code class="cs">public QuestionnaireView() { InitializeComponent(); } public QuestionnaireView(QuestionnaireViewModel viewModel) : this() { this.DataContext = viewModel; }</code> <br> <b></b> <br>    ,        ,   Visual Studio  Expression Blend. <br>  ,          ,   . Unity        <code>set</code>   ,   . <br> <br> <code class="cs">public QuestionnaireView() { InitializeComponent(); } [Dependency] public QuestionnaireViewModel ViewModel { set { this.DataContext = value; } }</code> <br>       Unity. <br> <br> <code class="cs">container.RegisterType&lt;QuestionnaireViewModel&gt;();</code> <br>  ,     . <br> <br> <code class="cs">var view = container.Resolve&lt;QuestionnaireView&gt;();</code> <br>     ,    <br>   ,     ,        .        ,   MEF  Unity,        . <br> <br>          .   ,         UI,           . <br> <br> , <i>RI MVVM</i>   ,   ,        .   ,    .      <code>ShowView</code>   UI. <br> <br> <code class="cs">private void NavigateToQuestionnaireList() { //     "questionnaire list". this.uiService.ShowView(ViewNames.QuestionnaireTemplatesList); }</code> <br>  UI      UI .           UI.  <code>ShowView</code>  <code>UIService</code>      (,          ),       ,   . <br> <br> <code class="cs">public void ShowView(string viewName) { var view = this.ViewFactory.GetView(viewName); this.MainWindow.CurrentView = view; }</code> <br> <b></b> <br> Prism       .   ,   ,   ,             .    ,  , " <a href="http://msdn.microsoft.com/en-us/library/gg430861(v%3DPandP.40).aspx">View-Based Navigation</a> "   8, " <a href="http://msdn.microsoft.com/en-us/library/gg430861(v%3DPandP.40).aspx">Navigation</a> ". <br>  MVVM  <br>        MVVM      .           -      mocking . ,   ,        . <br> <br>   <i>INotifyPropertyChanged</i> <br>   <code>INotifyPropertyChanged</code>     ,      .      ,    ;   ,   ,     ,    ,       . <br> <br>   <br> ,       ,           <code>PropertyChanged</code>  ,         .  ,    <code>ChangeTracker</code> ,     MVVM,  ,      .      .     ,    . <br> <br> <code class="cs">var changeTracker = new PropertyChangeTracker(viewModel); viewModel.CurrentState = "newState"; CollectionAssert.Contains(changeTracker.ChangedProperties, "CurrentState");</code> <br> ,     ,     <code>INotifyPropertyChanged</code> ,    ,   ,     . <br> <br>      <br>        ,   ,    <code>set</code>      ,           . ,     ,     ,      ,          . <br> <br> <code class="cs">var changeTracker = new PropertyChangeTracker(viewModel); var question = viewModel.Questions.First() as OpenQuestionViewModel; question.Question.Response = "some text"; CollectionAssert.Contains(changeTracker.ChangedProperties, "UnansweredQuestions");</code> <br>      <br>     <code>INotifyPropertyChanged</code> ,      <code>PropertyChanged</code>        ,  ,     , , .        ,       . <br> <br>   <i>INotifyDataErrorInfo</i> <br>   ,     ,    ,   ,   <code>IDataErrorInfo</code> ,  ( Silverlight)   <code>INotifyDataErrorInfo</code> .   <code>INotifyDataErrorInfo</code>   ,         ,    ,  ,   ,    . <br> <br>       <code>INotifyDataErrorInfo</code> : ,     ,  ,     ,     <code>ErrorsChanged</code> ,      <code>GetErrors</code> , . <br> <br>    <br>     ,      ,     .       ,         <code>GetErrors</code>       ,  ,  ,   .    , ,  ,     ,        .   ,        . <br> <br> <code class="cs">//  . var notifyErrorInfo = (INotifyDataErrorInfo)question; question.Response = -15; Assert.IsTrue(notifyErrorInfo.GetErrors("Response").Cast&lt;ValidationResult&gt;().Any()); //  . var notifyErrorInfo = (INotifyDataErrorInfo)question; question.Response = 15; Assert.IsFalse(notifyErrorInfo.GetErrors("Response").Cast&lt;ValidationResult&gt;().Any());</code> <br>    ,    ,             . <br> <br>    <i>INotifyDataErrorInfo</i> <br>       <code>GetErrors</code> ,   <code>INotifyDataErrorInfo</code>  ,   <code>ErrorsChanged</code>      <code>GetErrors</code> . ,  <code>HasErrors</code>      ,  . <br> <br>       <code>INotifyDataErrorInfo</code> . , ,           ,   -  .      ,        <code>INotifyDataErrorInfo</code>         (,        ). <br> <br>     ,   ,  : <br>  <code>HasErrors</code>     .              ,       .  <code>ErrorsChanged</code> ,      ,         <code>GetErrors</code> .         ( ,  )     ,           .    <code>GetErrors</code>       <code>ErrorsChanged</code> . <br>    <code>INotifyPropertyChanged</code> ,  ,    <code>NotifyDataErrorInfoTestHelper</code>    MVVM,        <code>INotifyDataErrorInfo</code> ,       .   ,   ,      ,   .      . <br> <code class="cs">var helper = new NotifyDataErrorInfoTestHelper&lt;NumericQuestion, int?&gt;( question, q =&gt; q.Response); helper.ValidatePropertyChange( 6, NotifyDataErrorInfoBehavior.Nothing); helper.ValidatePropertyChange( 20, NotifyDataErrorInfoBehavior.FiresErrorsChanged | NotifyDataErrorInfoBehavior.HasErrors | NotifyDataErrorInfoBehavior.HasErrorsForProperty); helper.ValidatePropertyChange( null, NotifyDataErrorInfoBehavior.FiresErrorsChanged | NotifyDataErrorInfoBehavior.HasErrors | NotifyDataErrorInfoBehavior.HasErrorsForProperty); helper.ValidatePropertyChange( 2, NotifyDataErrorInfoBehavior.FiresErrorsChanged);</code> <br>     <br>   MVVM,     ,  .   ,    ,         . <br> <br>  ,     ,     ,       .   ,   , ,       ,     ,   <code>IAsyncResult</code>    ,  - ,   ,    UI. <br> <br>       , , ,    .   ,     .  ,      UI,     ,   ,          ,     ,        "   UI." <br> <br>     ,    ,    .   ,    ,     mock-, ,   ,   ,      ,          . <br> <br>           UI,    ,    .   ,     ,   ,      .        ,   .     ,    ,     . <br> <br> <code class="cs">questionnaireRepositoryMock .Setup( r =&gt; r.SubmitQuestionnaireAsync( It.IsAny&lt;Questionnaire&gt;(), It.IsAny&lt;Action&lt;IOperationResult&gt;&gt;())) .Callback&lt;Questionnaire, Action&lt;IOperationResult&gt;&gt;( (q, a) =&gt; callback = a); uiServicemock .Setup(svc =&gt; svc.ShowView(ViewNames.QuestionnaireTemplatesList)) .Callback&lt;string&gt;(viewName =&gt; requestedViewName = viewName); submitResultMock .Setup(sr =&gt; sr.Error) .Returns&lt;Exception&gt;(null); CompleteQuestionnaire(viewModel); viewModel.Submit(); //      UI . callback(submitResultMock.Object); //    ‚Äì     . Assert.AreEqual(ViewNames.QuestionnaireTemplatesList, requestedViewName);</code> <br> <b></b> <br>          ,        . <br>   <br>       , . "Trees in WPF"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ms753391.aspx">http://msdn.microsoft.com/en-us/library/ms753391.aspx</a> <br> <br>       , . "Attached Properties Overview"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/cc265152(VS.95).aspx">http://msdn.microsoft.com/en-us/library/cc265152(VS.95).aspx</a> <br> <br>      MEF, ."Managed Extensibility Framework Overview"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/dd460648.aspx">http://msdn.microsoft.com/en-us/library/dd460648.aspx</a> . <br> <br>      Unity, ."Unity Application Block"  MSDN: <a href="http://www.msdn.com/unity">http://www.msdn.com/unity</a> . <br> <br>      <code>DelegateCommand</code> , .Chapter 5, " <a href="http://msdn.microsoft.com/en-us/library/gg405484(v%3DPandP.40).aspx">Implementing the MVVM Pattern</a> ." <br> <br>        Microsoft Expression Blend, ."Working with built-in behaviors"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ff724013(v%3DExpression.40).aspx">http://msdn.microsoft.com/en-us/library/ff724013(v=Expression.40).aspx</a> . <br> <br>          Microsoft Expression Blend, ."Creating Custom Behaviors"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ff724708(v%3DExpression.40).aspx">http://msdn.microsoft.com/en-us/library/ff724708(v=Expression.40).aspx</a> . <br> <br>            Microsoft Expression Blend, ."Creating Custom Triggers and Actions"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ff724707(v%3DExpression.40).aspx">http://msdn.microsoft.com/en-us/library/ff724707(v=Expression.40).aspx</a> . <br> <br>         WPF  Silverlight, ."Threading Model"  "The Dispatcher Class"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ms741870.aspx">http://msdn.microsoft.com/en-us/library/ms741870.aspx</a> <br> <a href="http://msdn.microsoft.com/en-us/library/ms615907(v%3DVS.95).aspx">http://msdn.microsoft.com/en-us/library/ms615907(v=VS.95).aspx</a> . <br> <br>      unit-  Silverlight, ."Unit Testing with Silverlight 2": <a href="http://www.jeff.wilcox.name/2008/03/silverlight2-unit-testing/">http://www.jeff.wilcox.name/2008/03/silverlight2-unit-testing/</a> . <br> <br>         , .  " <a href="http://msdn.microsoft.com/en-us/library/gg430861(v%3DPandP.40).aspx">View-Based Navigation</a> " in Chapter 8, " <a href="http://msdn.microsoft.com/en-us/library/gg430861(v%3DPandP.40).aspx">Navigation</a> ." <br> <br>       ,   , ."Event-based Asynchronous Pattern Overview"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/wewwczdw.aspx">http://msdn.microsoft.com/en-us/library/wewwczdw.aspx</a> <br> <br>        <code>IAsyncResult</code> , ."Asynchronous Programming Overview"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ms228963.aspx">http://msdn.microsoft.com/en-us/library/ms228963.aspx</a></code></code></code></code></code></code></code></code></code> <pre> <code class="hljs cmake"><code>CommandBehaviorBase ,    ,    ICommand</code> .           <code>CanExecuteChanged</code> ,          Silverlight,    WPF. <br> <br>    ,  ,   <code><code>CommandBehaviorBase    ,    .         ,      .         ,    .      ButtonBaseClickCommandBehavior</code> . <br> <br> <code class="cs">public class ButtonBaseClickCommandBehavior : CommandBehaviorBase&lt;ButtonBase&gt; { public ButtonBaseClickCommandBehavior(ButtonBase clickableObject) : base(clickableObject) { clickableObject.Click += OnClick; } private void OnClick(object sender, System.Windows.RoutedEventArgs e) { ExecuteCommand(); } }</code> <br>   <code><code>CommandBehaviorBase ,     .     ,          ,   . ,    ,    ,      , ,    CanExecute</code>  ,     . <br> <br>          ,   .           XAML.           .       .  Prism      ,       ,  ,   .       ,    . , ,  ,      <code>Click</code> ,       <code><span class="hljs-keyword"><span class="hljs-keyword">Command</span></span></code> .    <code>Click.<span class="hljs-keyword"><span class="hljs-keyword">Command</span></span></code> ,  . <br> <br>             .             . <br> <br> <code class="cs">public static readonly DependencyProperty CommandProperty = DependencyProperty.RegisterAttached( <span class="hljs-string"><span class="hljs-string">"Command"</span></span>, typeof(ICommand), typeof(Click), new PropertyMetadata(OnSetCommandCallback)); private static readonly DependencyProperty ClickCommandBehaviorProperty = DependencyProperty.RegisterAttached( <span class="hljs-string"><span class="hljs-string">"ClickCommandBehavior"</span></span>, typeof(ButtonBaseClickCommandBehavior), typeof(Click), null);</code> <br>    <code><span class="hljs-keyword"><span class="hljs-keyword">Command</span></span></code>    <code>ButtonBaseClickCommandBehavior</code> ,     <code>OnSetCommandCallback</code> ,     . <br> <br> <code class="cs">private static void OnSetCommandCallback(DependencyObject dependencyObject, DependencyPropertyChangedEventArgs e) { ButtonBase buttonBase = dependencyObject as ButtonBase; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (buttonBase != null) { ButtonBaseClickCommandBehavior behavior = GetOrCreateBehavior(buttonBase); behavior.<span class="hljs-keyword"><span class="hljs-keyword">Command</span></span> = e.NewValue as ICommand; } } private static void OnSetCommandParameterCallback(DependencyObject dependencyObject, DependencyPropertyChangedEventArgs e) { ButtonBase buttonBase = dependencyObject as ButtonBase; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (buttonBase != null) { ButtonBaseClickCommandBehavior behavior = GetOrCreateBehavior(buttonBase); behavior.CommandParameter = e.NewValue; } } private static ButtonBaseClickCommandBehavior GetOrCreateBehavior(ButtonBase buttonBase ) { ButtonBaseClickCommandBehavior behavior = buttonBase.GetValue(ClickCommandBehaviorProperty) as ButtonBaseClickCommandBehavior; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ( behavior == null ) { behavior = new ButtonBaseClickCommandBehavior(buttonBase); buttonBase.SetValue(ClickCommandBehaviorProperty, behavior); } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> behavior; }</code> <br>        ,  <a href="http://msdn.microsoft.com/en-us/library/cc265152(VS.95).aspx">Attached Properties Overview</a>  MSDN. <br> <br>    <br>              . ,     Silverlight,    -,     ,      ,     .     ,       . <br> <br>        ,    ( )  ,  ,     .  UI       ,            UI. <br> <br>      - <br>   -     ,       <code>IAsyncResult</code> .   ,  ,   ,  <code>GetQuestionnaire</code> ,   : <code>BeginGetQuestionnaire</code>  <code>EndGetQuestionnaire</code> .    ,   <code>BeginGetQuestionnaire</code> .     ,   ,   <code>EndGetQuestionnaire</code>    . <br> <b></b> <br>  .NET Framework <span class="hljs-number"><span class="hljs-number">4.5</span></span>      <code>await</code>  <code>async</code>     <code>*Async</code> .      <a href="http://msdn.microsoft.com/en-us/library/vstudio/hh391443.aspx"><span class="hljs-string"><span class="hljs-string">"Asynchronous Programming with Async and Await (C# and Visual Basic)"</span></span></a> . <br>  ,    <code>EndGetQuestionnaire</code> ,      ,  ()      <code>BeginGetQuestionnaire</code> .     ,      ,   <code>EndGetQuestionnaire</code> ,   . <br> <br> <code class="xml">IAsyncResult asyncResult = this.service.BeginGetQuestionnaire( GetQuestionnaireCompleted, null //  ,      ); private void GetQuestionnaireCompleted(IAsyncResult result) { try { questionnaire = this.service.EndGetQuestionnaire(ar); } catch (Exception ex) { //  -   . } }</code> <br>  ,     <code>End*</code> (  , <code>EndGetQuestionnaire</code> ),    ,      .      , ,          UI.     ,   ,        . <br> <br>        UI,     -,      UI,         UI,   <code>Dispatcher</code>    <code>SynchronizationContext</code> .  WPF  Silverlight,   <code>Dispatcher</code> . <br> <br>      <code>Questionnaire</code>  ,        <code>QuestionnaireView</code> .  Silverlight    <code>CheckAccess</code> ,  ,      UI.  ,     <code>BeginInvoke</code> ,      UI. <br> <br> <code class="cs">var dispatcher = System.Windows.Deployment.Current.Dispatcher; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (dispatcher.CheckAccess()) { QuestionnaireView.DataContext = questionnaire; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { dispatcher.BeginInvoke(() =&gt; { Questionnaire.DataContext = questionnaire; }); }</code> <br> <i>MVVM RI</i>   ,    ,   <code>IAsyncResult</code> ,   .      ,                 . ,       . <br> <br> <code class="cs">this.questionnaireRepository.GetQuestionnaireAsync( result =&gt; { this.Questionnaire = result.Result; });</code> <br>  <code>result</code>   ,     , , , .    ,     . <br> <br> <code class="cs">this.questionnaireRepository.GetQuestionnaireAsync( result =&gt; { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (result.Error == null) { this.Questionnaire = result.Result; ... } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { // Handle error. } })</code> <br>     <br>        ,      .     , ,             .        ,      ,     ,     . <br> <br>         ,      MVVM,     ,   . ,  -MVVM ,     <code>MessageBox</code>   code-behind UI,      .   MVVM     ,          . <br> <br>     MVVM,              ,          .      ,    ,   ,  ,     . <br> <br>              MVVM.      ,     ,     ,  ,     .    ,         ,     ,          .       . <br> <br>    <br>                  .        ,        .  ,         .         . <br> <br>  ,         ,         ,  .      ,     .           ,       . ,        WPF  Silverlight,        . <br> <br> <img title="Using the service to interact with the user." src="https://habrastorage.org/getpro/habr/post_images/4b5/397/f2d/4b5397f2d02e5851195b29f1893be6fc.png" alt=" ,    ."> <br> <br>  ,   <code>MessageBox</code>        ,     ,    ,     . <br> <br> <code class="cs">var result = interactionService.ShowMessageBox( <span class="hljs-string"><span class="hljs-string">"Are you sure you want to cancel this operation?"</span></span>, <span class="hljs-string"><span class="hljs-string">"Confirm"</span></span>, MessageBoxButton.OK); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (result == MessageBoxResult.Yes) { CancelRequest(); }</code> <br> ,      - ,      ,         Silverlight.         .             .     . <br> <br> <code class="cs">interactionService.ShowMessageBox( <span class="hljs-string"><span class="hljs-string">"Are you sure you want to cancel this operation?"</span></span>, <span class="hljs-string"><span class="hljs-string">"Confirm"</span></span>, MessageBoxButton.OK, result =&gt; { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (result == MessageBoxResult.Yes) { CancelRequest(); } });</code> <br>         ,      . ,  WPF    <code>MessageBox</code> ,       ;    Silverlight    ,    . <br> <br>     <br>         ‚Äì             .         ,      .     ,     .        ,        ,   ,     . <br> <br> <img title="Using interaction request objects." src="https://habrastorage.org/getpro/habr/post_images/3d0/ff0/1c5/3d0ff01c5518558c2d3c5c5f47ce0ce9.png" alt="   ."> <br> <br>    ,   ,          ‚Äì       ,      ,   ‚Äì     .   ,        ,    ,    UI            . <br> <br>       MVVM,     ,       ,         .         ,        ,    ,   . <br> <br>  Prism       <code>IInteractionRequest</code>   <code><code>InteractionRequest .  IInteractionRequest</code>  ,   .           ,   .  <code><code>InteractionRequest   IInteractionRequest</code>     <code>Raise</code> ,           , , ,   . <br> <br>       <br>  <code><code>InteractionRequest          .  Raise</code>          ( <code>T</code> )    ,    ,   .          ,       .      ,        .    ,  ,     . <br> <code class="cs">public interface IInteractionRequest { event EventHandler&lt;InteractionRequestedEventArgs&gt; Raised; } public class InteractionRequest&lt;T&gt; : IInteractionRequest { public event EventHandler&lt;InteractionRequestedEventArgs&gt; Raised; public void Raise(T context, Action&lt;T&gt; callback) { var handler = this.Raised; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (handler != null) { handler( this, new InteractionRequestedEventArgs(context, () =&gt; callback(context))); } } }</code> <br> Prism    ,      .  <code>Notification</code>       .    ,            .     ‚Äì <code>Title</code>  <code>Content</code> ,    .  ,   ,  ,  ,        . <br> <br>  <code>Confirmation</code>    <code>Notification</code>     ‚Äì <code>Confirmed</code> ,  ,  ,      .  <code>Confirmation</code> ,     <code>MessageBox</code> ,     /  .     ,     <code>Notification</code> ,     ,      . <br> <br>    <code><code><code>InteractionRequest ,       InteractionRequest      ,      .      ,    Raise</code> ,    , ,   . <br> <br> <code class="cs">public IInteractionRequest ConfirmCancelInteractionRequest { get { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> this.confirmCancelInteractionRequest; } } this.confirmCancelInteractionRequest.Raise( new Confirmation(<span class="hljs-string"><span class="hljs-string">"Are you sure you wish to cancel?"</span></span>), confirmation =&gt; { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (confirmation.Confirmed) { this.NavigateToQuestionnaireList(); } }); }</code> <br> <i>MVVM Reference Implementation (MVVM RI)</i> ,    <code>IInteractionRequest</code>   <code><code>InteractionRequest ,          (. QuestionnaireViewModel.cs</code> ). <br> <br>        <br>       ,       .   ,       .    UI             . <br> <br>                . Microsoft Expression Blend Behaviors Framework     .  ,     ,    . <br> <br>  <code>EventTrigger</code> ,  Expression Blend,  ,      ,     ,   . , Prism   <code>EventTrigger</code> ,  <code>InteractionRequestTrigger</code> ,      <code>Raised</code>   <code>IInteractionRequest</code> .    XAML        . <br> <br>  ,   , <code>InteractionRequestTrigger</code>   .  Silverlight Prism   <code>PopupChildWindowAction</code> ,     .    ,         .   <code>ContentTemplate</code>  <code>PopupChildWindowAction</code> ,    ,    UI,      <code>Content</code>  .       <code>Title</code>  . <br> <b></b> <br>  ,    ,   <code>PopupChildWindowAction</code> ,     .    <code>Notification</code>  <code>NotificationChildWindow</code> ,        <code>Confirmation</code> ‚Äì <code>ConfirmationChildWindow</code> . <code>NotificationChildWindow</code>    ,   ,     <code>ConfirmationChildWindow</code>    <i>OK</i>  <i>Cancel</i> ,    .    ,   ,   <code>ChildWindow</code>  <code>PopupChildWindowAction</code> . <br>   ,  <code>InteractionRequestTrigger</code>  <code>PopupChildWindowAction</code> ,       <i>RI MVVM</i> . <br> <br> <code class="xml">&lt;i:Interaction.Triggers&gt; &lt;prism:InteractionRequestTrigger SourceObject=<span class="hljs-string"><span class="hljs-string">"{Binding ConfirmCancelInteractionRequest}"</span></span>&gt; &lt;prism:PopupChildWindowAction ContentTemplate=<span class="hljs-string"><span class="hljs-string">"{StaticResource ConfirmWindowTemplate}"</span></span>/&gt; &lt;/prism:InteractionRequestTrigger&gt; &lt;/i:Interaction.Triggers&gt; &lt;UserControl.Resources&gt; &lt;DataTemplate x:Key=<span class="hljs-string"><span class="hljs-string">"ConfirmWindowTemplate"</span></span>&gt; &lt;Grid MinWidth=<span class="hljs-string"><span class="hljs-string">"250"</span></span> MinHeight=<span class="hljs-string"><span class="hljs-string">"100"</span></span>&gt; &lt;TextBlock TextWrapping=<span class="hljs-string"><span class="hljs-string">"Wrap"</span></span> Grid.Row=<span class="hljs-string"><span class="hljs-string">"0"</span></span> Text=<span class="hljs-string"><span class="hljs-string">"{Binding}"</span></span>/&gt; &lt;/Grid&gt; &lt;/DataTemplate&gt; &lt;/UserControl.Resources&gt;</code> <br> <b></b> <br>      <code>ContentTemplate</code> ,   UI   <code>Content</code>  .    <code>Content</code>  ,  , <code>TextBlock</code>     <code>Content</code> . <br>      ,     ,    ,    .  ,     ,       ,     ,    .   ,   <i>RI MVVM</i> ,         <code>Confirmed</code>    <code>Confirmation</code>  <code><span class="hljs-keyword"><span class="hljs-keyword">true</span></span></code> ,     OK. <br> <br>        ,     .  Prism <code>InteractionRequestTrigger</code>   <code>PopupChildWindowAction</code>            . <br> <br>     <br>     MVVM,       , ,    ,         .        (  , ,  ,   ).    ,  ,  ,            . <br> <br>        ,         . Managed Extensibility Framework (MEF)  Unity Application Block (Unity)      ,  ,           . <br> <br>  ,       , , ,    ( )      . ,       ,     .  ,     ,       . <br> <br>     ,  MEF <br>  MEF,       ,   <code>Import</code> ,      ,  ,   <code><span class="hljs-keyword"><span class="hljs-keyword">Export</span></span></code> .         ,    . <br> <br> , <code>QuestionnaireView</code>   <i>RI MVVM</i> ,        ,    <code>Import</code> .   , MEF           .  <code><span class="hljs-keyword"><span class="hljs-keyword">set</span></span></code>        ,   . <br> <br> <code class="cs">[Import] public QuestionnaireViewModel ViewModel { <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> { this.DataContext = value; } }</code> <br>     ,   . <br> <br> <code class="cs">[<span class="hljs-keyword"><span class="hljs-keyword">Export</span></span>] public class QuestionnaireViewModel : NotificationObject { ... }</code> <br>        ,   . <br> <br> <code class="cs">public QuestionnaireView() { InitializeComponent(); } [ImportingConstructor] public QuestionnaireView(QuestionnaireViewModel viewModel) : this() { this.DataContext = viewModel; }</code> <br> <b></b> <br>          MEF,   Unity.   ,     ,        .   ,   Visual Studio  Expression Blend, ,        ,     .   ,   ,  ,      ,          <code>InitializeComponent</code> . <br>     ,  Unity <br>  Unity,    ,   MEF.     ,      .    ,         .  ,      . <br> <br>  ,      ,  ,         . ,           ,   . <br> <br> <code class="cs">public QuestionnaireView() { InitializeComponent(); } public QuestionnaireView(QuestionnaireViewModel viewModel) : this() { this.DataContext = viewModel; }</code> <br> <b></b> <br>    ,        ,   Visual Studio  Expression Blend. <br>  ,          ,   . Unity        <code><span class="hljs-keyword"><span class="hljs-keyword">set</span></span></code>   ,   . <br> <br> <code class="cs">public QuestionnaireView() { InitializeComponent(); } [Dependency] public QuestionnaireViewModel ViewModel { <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> { this.DataContext = value; } }</code> <br>       Unity. <br> <br> <code class="cs">container.RegisterType&lt;QuestionnaireViewModel&gt;();</code> <br>  ,     . <br> <br> <code class="cs">var view = container.Resolve&lt;QuestionnaireView&gt;();</code> <br>     ,    <br>   ,     ,        .        ,   MEF  Unity,        . <br> <br>          .   ,         UI,           . <br> <br> , <i>RI MVVM</i>   ,   ,        .   ,    .      <code>ShowView</code>   UI. <br> <br> <code class="cs">private void NavigateToQuestionnaireList() { //     <span class="hljs-string"><span class="hljs-string">"questionnaire list"</span></span>. this.uiService.ShowView(ViewNames.QuestionnaireTemplatesList); }</code> <br>  UI      UI .           UI.  <code>ShowView</code>  <code>UIService</code>      (,          ),       ,   . <br> <br> <code class="cs">public void ShowView(<span class="hljs-keyword"><span class="hljs-keyword">string</span></span> viewName) { var view = this.ViewFactory.GetView(viewName); this.MainWindow.CurrentView = view; }</code> <br> <b></b> <br> Prism       .   ,   ,   ,             .    ,  , <span class="hljs-string"><span class="hljs-string">" </span></span><a href="http://msdn.microsoft.com/en-us/library/gg430861(v%3DPandP.40).aspx"><span class="hljs-string"><span class="hljs-string">View-Based Navigation</span></span></a><span class="hljs-string"><span class="hljs-string"> "</span></span>   <span class="hljs-number"><span class="hljs-number">8</span></span>, <span class="hljs-string"><span class="hljs-string">" </span></span><a href="http://msdn.microsoft.com/en-us/library/gg430861(v%3DPandP.40).aspx"><span class="hljs-string"><span class="hljs-string">Navigation</span></span></a><span class="hljs-string"><span class="hljs-string"> "</span></span>. <br>  MVVM  <br>        MVVM      .           -      mocking . ,   ,        . <br> <br>   <i>INotifyPropertyChanged</i> <br>   <code>INotifyPropertyChanged</code>     ,      .      ,    ;   ,   ,     ,    ,       . <br> <br>   <br> ,       ,           <code>PropertyChanged</code>  ,         .  ,    <code>ChangeTracker</code> ,     MVVM,  ,      .      .     ,    . <br> <br> <code class="cs">var changeTracker = new PropertyChangeTracker(viewModel); viewModel.CurrentState = <span class="hljs-string"><span class="hljs-string">"newState"</span></span>; CollectionAssert.Contains(changeTracker.ChangedProperties, <span class="hljs-string"><span class="hljs-string">"CurrentState"</span></span>);</code> <br> ,     ,     <code>INotifyPropertyChanged</code> ,    ,   ,     . <br> <br>      <br>        ,   ,    <code><span class="hljs-keyword"><span class="hljs-keyword">set</span></span></code>      ,           . ,     ,     ,      ,          . <br> <br> <code class="cs">var changeTracker = new PropertyChangeTracker(viewModel); var question = viewModel.Questions.First() as OpenQuestionViewModel; question.Question.Response = <span class="hljs-string"><span class="hljs-string">"some text"</span></span>; CollectionAssert.Contains(changeTracker.ChangedProperties, <span class="hljs-string"><span class="hljs-string">"UnansweredQuestions"</span></span>);</code> <br>      <br>     <code>INotifyPropertyChanged</code> ,      <code>PropertyChanged</code>        ,  ,     , , .        ,       . <br> <br>   <i>INotifyDataErrorInfo</i> <br>   ,     ,    ,   ,   <code>IDataErrorInfo</code> ,  ( Silverlight)   <code>INotifyDataErrorInfo</code> .   <code>INotifyDataErrorInfo</code>   ,         ,    ,  ,   ,    . <br> <br>       <code>INotifyDataErrorInfo</code> : ,     ,  ,     ,     <code>ErrorsChanged</code> ,      <code>GetErrors</code> , . <br> <br>    <br>     ,      ,     .       ,         <code>GetErrors</code>       ,  ,  ,   .    , ,  ,     ,        .   ,        . <br> <br> <code class="cs">//  . var notifyErrorInfo = (INotifyDataErrorInfo)question; question.Response = -<span class="hljs-number"><span class="hljs-number">15</span></span>; Assert.IsTrue(notifyErrorInfo.GetErrors(<span class="hljs-string"><span class="hljs-string">"Response"</span></span>).Cast&lt;ValidationResult&gt;().Any()); //  . var notifyErrorInfo = (INotifyDataErrorInfo)question; question.Response = <span class="hljs-number"><span class="hljs-number">15</span></span>; Assert.IsFalse(notifyErrorInfo.GetErrors(<span class="hljs-string"><span class="hljs-string">"Response"</span></span>).Cast&lt;ValidationResult&gt;().Any());</code> <br>    ,    ,             . <br> <br>    <i>INotifyDataErrorInfo</i> <br>       <code>GetErrors</code> ,   <code>INotifyDataErrorInfo</code>  ,   <code>ErrorsChanged</code>      <code>GetErrors</code> . ,  <code>HasErrors</code>      ,  . <br> <br>       <code>INotifyDataErrorInfo</code> . , ,           ,   -  .      ,        <code>INotifyDataErrorInfo</code>         (,        ). <br> <br>     ,   ,  : <br>  <code>HasErrors</code>     .              ,       .  <code>ErrorsChanged</code> ,      ,         <code>GetErrors</code> .         ( ,  )     ,           .    <code>GetErrors</code>       <code>ErrorsChanged</code> . <br>    <code>INotifyPropertyChanged</code> ,  ,    <code>NotifyDataErrorInfoTestHelper</code>    MVVM,        <code>INotifyDataErrorInfo</code> ,       .   ,   ,      ,   .      . <br> <code class="cs">var helper = new NotifyDataErrorInfoTestHelper&lt;NumericQuestion, int?&gt;( question, q =&gt; q.Response); helper.ValidatePropertyChange( <span class="hljs-number"><span class="hljs-number">6</span></span>, NotifyDataErrorInfoBehavior.Nothing); helper.ValidatePropertyChange( <span class="hljs-number"><span class="hljs-number">20</span></span>, NotifyDataErrorInfoBehavior.FiresErrorsChanged | NotifyDataErrorInfoBehavior.HasErrors | NotifyDataErrorInfoBehavior.HasErrorsForProperty); helper.ValidatePropertyChange( null, NotifyDataErrorInfoBehavior.FiresErrorsChanged | NotifyDataErrorInfoBehavior.HasErrors | NotifyDataErrorInfoBehavior.HasErrorsForProperty); helper.ValidatePropertyChange( <span class="hljs-number"><span class="hljs-number">2</span></span>, NotifyDataErrorInfoBehavior.FiresErrorsChanged);</code> <br>     <br>   MVVM,     ,  .   ,    ,         . <br> <br>  ,     ,     ,       .   ,   , ,       ,     ,   <code>IAsyncResult</code>    ,  - ,   ,    UI. <br> <br>       , , ,    .   ,     .  ,      UI,     ,   ,          ,     ,        <span class="hljs-string"><span class="hljs-string">"   UI."</span></span> <br> <br>     ,    ,    .   ,    ,     mock-, ,   ,   ,      ,          . <br> <br>           UI,    ,    .   ,     ,   ,      .        ,   .     ,    ,     . <br> <br> <code class="cs">questionnaireRepositoryMock .Setup( r =&gt; r.SubmitQuestionnaireAsync( It.IsAny&lt;Questionnaire&gt;(), It.IsAny&lt;Action&lt;IOperationResult&gt;&gt;())) .Callback&lt;Questionnaire, Action&lt;IOperationResult&gt;&gt;( (q, a) =&gt; callback = a); uiServicemock .Setup(svc =&gt; svc.ShowView(ViewNames.QuestionnaireTemplatesList)) .Callback&lt;<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>&gt;(viewName =&gt; requestedViewName = viewName); submitResultMock .Setup(sr =&gt; sr.Error) .Returns&lt;Exception&gt;(null); CompleteQuestionnaire(viewModel); viewModel.Submit(); //      UI . callback(submitResultMock.Object); //    ‚Äì     . Assert.AreEqual(ViewNames.QuestionnaireTemplatesList, requestedViewName);</code> <br> <b></b> <br>          ,        . <br>   <br>       , . <span class="hljs-string"><span class="hljs-string">"Trees in WPF"</span></span>  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ms753391.aspx">http://msdn.microsoft.com/en-us/library/ms753391.aspx</a> <br> <br>       , . <span class="hljs-string"><span class="hljs-string">"Attached Properties Overview"</span></span>  MSDN: <a href="http://msdn.microsoft.com/en-us/library/cc265152(VS.95).aspx">http://msdn.microsoft.com/en-us/library/cc265152(VS.<span class="hljs-number"><span class="hljs-number">95</span></span>).aspx</a> <br> <br>      MEF, .<span class="hljs-string"><span class="hljs-string">"Managed Extensibility Framework Overview"</span></span>  MSDN: <a href="http://msdn.microsoft.com/en-us/library/dd460648.aspx">http://msdn.microsoft.com/en-us/library/dd460648.aspx</a> . <br> <br>      Unity, .<span class="hljs-string"><span class="hljs-string">"Unity Application Block"</span></span>  MSDN: <a href="http://www.msdn.com/unity">http://www.msdn.com/unity</a> . <br> <br>      <code>DelegateCommand</code> , .Chapter <span class="hljs-number"><span class="hljs-number">5</span></span>, <span class="hljs-string"><span class="hljs-string">" </span></span><a href="http://msdn.microsoft.com/en-us/library/gg405484(v%3DPandP.40).aspx"><span class="hljs-string"><span class="hljs-string">Implementing the MVVM Pattern</span></span></a><span class="hljs-string"><span class="hljs-string"> ."</span></span> <br> <br>        Microsoft Expression Blend, .<span class="hljs-string"><span class="hljs-string">"Working with built-in behaviors"</span></span>  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ff724013(v%3DExpression.40).aspx">http://msdn.microsoft.com/en-us/library/ff724013(v=Expression.<span class="hljs-number"><span class="hljs-number">40</span></span>).aspx</a> . <br> <br>          Microsoft Expression Blend, .<span class="hljs-string"><span class="hljs-string">"Creating Custom Behaviors"</span></span>  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ff724708(v%3DExpression.40).aspx">http://msdn.microsoft.com/en-us/library/ff724708(v=Expression.<span class="hljs-number"><span class="hljs-number">40</span></span>).aspx</a> . <br> <br>            Microsoft Expression Blend, .<span class="hljs-string"><span class="hljs-string">"Creating Custom Triggers and Actions"</span></span>  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ff724707(v%3DExpression.40).aspx">http://msdn.microsoft.com/en-us/library/ff724707(v=Expression.<span class="hljs-number"><span class="hljs-number">40</span></span>).aspx</a> . <br> <br>         WPF  Silverlight, .<span class="hljs-string"><span class="hljs-string">"Threading Model"</span></span>  <span class="hljs-string"><span class="hljs-string">"The Dispatcher Class"</span></span>  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ms741870.aspx">http://msdn.microsoft.com/en-us/library/ms741870.aspx</a> <br> <a href="http://msdn.microsoft.com/en-us/library/ms615907(v%3DVS.95).aspx">http://msdn.microsoft.com/en-us/library/ms615907(v=VS.<span class="hljs-number"><span class="hljs-number">95</span></span>).aspx</a> . <br> <br>      unit-  Silverlight, .<span class="hljs-string"><span class="hljs-string">"Unit Testing with Silverlight 2"</span></span>: <a href="http://www.jeff.wilcox.name/2008/03/silverlight2-unit-testing/">http://www.jeff.wilcox.name/<span class="hljs-number"><span class="hljs-number">2008</span></span>/<span class="hljs-number"><span class="hljs-number">03</span></span>/silverlight2-unit-testing/</a> . <br> <br>         , .  <span class="hljs-string"><span class="hljs-string">" </span></span><a href="http://msdn.microsoft.com/en-us/library/gg430861(v%3DPandP.40).aspx"><span class="hljs-string"><span class="hljs-string">View-Based Navigation</span></span></a><span class="hljs-string"><span class="hljs-string"> "</span></span> in Chapter <span class="hljs-number"><span class="hljs-number">8</span></span>, <span class="hljs-string"><span class="hljs-string">" </span></span><a href="http://msdn.microsoft.com/en-us/library/gg430861(v%3DPandP.40).aspx"><span class="hljs-string"><span class="hljs-string">Navigation</span></span></a><span class="hljs-string"><span class="hljs-string"> ."</span></span> <br> <br>       ,   , .<span class="hljs-string"><span class="hljs-string">"Event-based Asynchronous Pattern Overview"</span></span>  MSDN: <a href="http://msdn.microsoft.com/en-us/library/wewwczdw.aspx">http://msdn.microsoft.com/en-us/library/wewwczdw.aspx</a> <br> <br>        <code>IAsyncResult</code> , .<span class="hljs-string"><span class="hljs-string">"Asynchronous Programming Overview"</span></span>  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ms228963.aspx">http://msdn.microsoft.com/en-us/library/ms228963.aspx</a></code></code></code></code></code></code></code></code></code> </pre> <code><code><code><code><code><code><code><code><code><code>CommandBehaviorBase ,    ,    ICommand</code> .           <code>CanExecuteChanged</code> ,          Silverlight,    WPF. <br> <br>    ,  ,   <code>CommandBehaviorBase    ,    .         ,      .         ,    .      ButtonBaseClickCommandBehavior</code> . <br> <br> <code class="cs">public class ButtonBaseClickCommandBehavior : CommandBehaviorBase&lt;ButtonBase&gt; { public ButtonBaseClickCommandBehavior(ButtonBase clickableObject) : base(clickableObject) { clickableObject.Click += OnClick; } private void OnClick(object sender, System.Windows.RoutedEventArgs e) { ExecuteCommand(); } }</code> <br>   <code>CommandBehaviorBase ,     .     ,          ,   . ,    ,    ,      , ,    CanExecute</code>  ,     . <br> <br>          ,   .           XAML.           .       .  Prism      ,       ,  ,   .       ,    . , ,  ,      <code>Click</code> ,       <code>Command</code> .    <code>Click.Command</code> ,  . <br> <br>             .             . <br> <br> <code class="cs">public static readonly DependencyProperty CommandProperty = DependencyProperty.RegisterAttached( "Command", typeof(ICommand), typeof(Click), new PropertyMetadata(OnSetCommandCallback)); private static readonly DependencyProperty ClickCommandBehaviorProperty = DependencyProperty.RegisterAttached( "ClickCommandBehavior", typeof(ButtonBaseClickCommandBehavior), typeof(Click), null);</code> <br>    <code>Command</code>    <code>ButtonBaseClickCommandBehavior</code> ,     <code>OnSetCommandCallback</code> ,     . <br> <br> <code class="cs">private static void OnSetCommandCallback(DependencyObject dependencyObject, DependencyPropertyChangedEventArgs e) { ButtonBase buttonBase = dependencyObject as ButtonBase; if (buttonBase != null) { ButtonBaseClickCommandBehavior behavior = GetOrCreateBehavior(buttonBase); behavior.Command = e.NewValue as ICommand; } } private static void OnSetCommandParameterCallback(DependencyObject dependencyObject, DependencyPropertyChangedEventArgs e) { ButtonBase buttonBase = dependencyObject as ButtonBase; if (buttonBase != null) { ButtonBaseClickCommandBehavior behavior = GetOrCreateBehavior(buttonBase); behavior.CommandParameter = e.NewValue; } } private static ButtonBaseClickCommandBehavior GetOrCreateBehavior(ButtonBase buttonBase ) { ButtonBaseClickCommandBehavior behavior = buttonBase.GetValue(ClickCommandBehaviorProperty) as ButtonBaseClickCommandBehavior; if ( behavior == null ) { behavior = new ButtonBaseClickCommandBehavior(buttonBase); buttonBase.SetValue(ClickCommandBehaviorProperty, behavior); } return behavior; }</code> <br>        ,  <a href="http://msdn.microsoft.com/en-us/library/cc265152(VS.95).aspx">Attached Properties Overview</a>  MSDN. <br> <br>    <br>              . ,     Silverlight,    -,     ,      ,     .     ,       . <br> <br>        ,    ( )  ,  ,     .  UI       ,            UI. <br> <br>      - <br>   -     ,       <code>IAsyncResult</code> .   ,  ,   ,  <code>GetQuestionnaire</code> ,   : <code>BeginGetQuestionnaire</code>  <code>EndGetQuestionnaire</code> .    ,   <code>BeginGetQuestionnaire</code> .     ,   ,   <code>EndGetQuestionnaire</code>    . <br> <b></b> <br>  .NET Framework 4.5      <code>await</code>  <code>async</code>     <code>*Async</code> .      <a href="http://msdn.microsoft.com/en-us/library/vstudio/hh391443.aspx">"Asynchronous Programming with Async and Await (C# and Visual Basic)"</a> . <br>  ,    <code>EndGetQuestionnaire</code> ,      ,  ()      <code>BeginGetQuestionnaire</code> .     ,      ,   <code>EndGetQuestionnaire</code> ,   . <br> <br> <code class="xml">IAsyncResult asyncResult = this.service.BeginGetQuestionnaire( GetQuestionnaireCompleted, null //  ,      ); private void GetQuestionnaireCompleted(IAsyncResult result) { try { questionnaire = this.service.EndGetQuestionnaire(ar); } catch (Exception ex) { //  -   . } }</code> <br>  ,     <code>End*</code> (  , <code>EndGetQuestionnaire</code> ),    ,      .      , ,          UI.     ,   ,        . <br> <br>        UI,     -,      UI,         UI,   <code>Dispatcher</code>    <code>SynchronizationContext</code> .  WPF  Silverlight,   <code>Dispatcher</code> . <br> <br>      <code>Questionnaire</code>  ,        <code>QuestionnaireView</code> .  Silverlight    <code>CheckAccess</code> ,  ,      UI.  ,     <code>BeginInvoke</code> ,      UI. <br> <br> <code class="cs">var dispatcher = System.Windows.Deployment.Current.Dispatcher; if (dispatcher.CheckAccess()) { QuestionnaireView.DataContext = questionnaire; } else { dispatcher.BeginInvoke(() =&gt; { Questionnaire.DataContext = questionnaire; }); }</code> <br> <i>MVVM RI</i>   ,    ,   <code>IAsyncResult</code> ,   .      ,                 . ,       . <br> <br> <code class="cs">this.questionnaireRepository.GetQuestionnaireAsync( result =&gt; { this.Questionnaire = result.Result; });</code> <br>  <code>result</code>   ,     , , , .    ,     . <br> <br> <code class="cs">this.questionnaireRepository.GetQuestionnaireAsync( result =&gt; { if (result.Error == null) { this.Questionnaire = result.Result; ... } else { // Handle error. } })</code> <br>     <br>        ,      .     , ,             .        ,      ,     ,     . <br> <br>         ,      MVVM,     ,   . ,  -MVVM ,     <code>MessageBox</code>   code-behind UI,      .   MVVM     ,          . <br> <br>     MVVM,              ,          .      ,    ,   ,  ,     . <br> <br>              MVVM.      ,     ,     ,  ,     .    ,         ,     ,          .       . <br> <br>    <br>                  .        ,        .  ,         .         . <br> <br>  ,         ,         ,  .      ,     .           ,       . ,        WPF  Silverlight,        . <br> <br> <img title="Using the service to interact with the user." src="https://habrastorage.org/getpro/habr/post_images/4b5/397/f2d/4b5397f2d02e5851195b29f1893be6fc.png" alt=" ,    ."> <br> <br>  ,   <code>MessageBox</code>        ,     ,    ,     . <br> <br> <code class="cs">var result = interactionService.ShowMessageBox( "Are you sure you want to cancel this operation?", "Confirm", MessageBoxButton.OK); if (result == MessageBoxResult.Yes) { CancelRequest(); }</code> <br> ,      - ,      ,         Silverlight.         .             .     . <br> <br> <code class="cs">interactionService.ShowMessageBox( "Are you sure you want to cancel this operation?", "Confirm", MessageBoxButton.OK, result =&gt; { if (result == MessageBoxResult.Yes) { CancelRequest(); } });</code> <br>         ,      . ,  WPF    <code>MessageBox</code> ,       ;    Silverlight    ,    . <br> <br>     <br>         ‚Äì             .         ,      .     ,     .        ,        ,   ,     . <br> <br> <img title="Using interaction request objects." src="https://habrastorage.org/getpro/habr/post_images/3d0/ff0/1c5/3d0ff01c5518558c2d3c5c5f47ce0ce9.png" alt="   ."> <br> <br>    ,   ,          ‚Äì       ,      ,   ‚Äì     .   ,        ,    ,    UI            . <br> <br>       MVVM,     ,       ,         .         ,        ,    ,   . <br> <br>  Prism       <code>IInteractionRequest</code>   <code>InteractionRequest .  IInteractionRequest</code>  ,   .           ,   .  <code>InteractionRequest   IInteractionRequest</code>     <code>Raise</code> ,           , , ,   . <br> <br>       <br>  <code>InteractionRequest          .  Raise</code>          ( <code>T</code> )    ,    ,   .          ,       .      ,        .    ,  ,     . <br> <code class="cs">public interface IInteractionRequest { event EventHandler&lt;InteractionRequestedEventArgs&gt; Raised; } public class InteractionRequest&lt;T&gt; : IInteractionRequest { public event EventHandler&lt;InteractionRequestedEventArgs&gt; Raised; public void Raise(T context, Action&lt;T&gt; callback) { var handler = this.Raised; if (handler != null) { handler( this, new InteractionRequestedEventArgs(context, () =&gt; callback(context))); } } }</code> <br> Prism    ,      .  <code>Notification</code>       .    ,            .     ‚Äì <code>Title</code>  <code>Content</code> ,    .  ,   ,  ,  ,        . <br> <br>  <code>Confirmation</code>    <code>Notification</code>     ‚Äì <code>Confirmed</code> ,  ,  ,      .  <code>Confirmation</code> ,     <code>MessageBox</code> ,     /  .     ,     <code>Notification</code> ,     ,      . <br> <br>    <code>InteractionRequest ,       InteractionRequest      ,      .      ,    Raise</code> ,    , ,   . <br> <br> <code class="cs">public IInteractionRequest ConfirmCancelInteractionRequest { get { return this.confirmCancelInteractionRequest; } } this.confirmCancelInteractionRequest.Raise( new Confirmation("Are you sure you wish to cancel?"), confirmation =&gt; { if (confirmation.Confirmed) { this.NavigateToQuestionnaireList(); } }); }</code> <br> <i>MVVM Reference Implementation (MVVM RI)</i> ,    <code>IInteractionRequest</code>   <code>InteractionRequest ,          (. QuestionnaireViewModel.cs</code> ). <br> <br>        <br>       ,       .   ,       .    UI             . <br> <br>                . Microsoft Expression Blend Behaviors Framework     .  ,     ,    . <br> <br>  <code>EventTrigger</code> ,  Expression Blend,  ,      ,     ,   . , Prism   <code>EventTrigger</code> ,  <code>InteractionRequestTrigger</code> ,      <code>Raised</code>   <code>IInteractionRequest</code> .    XAML        . <br> <br>  ,   , <code>InteractionRequestTrigger</code>   .  Silverlight Prism   <code>PopupChildWindowAction</code> ,     .    ,         .   <code>ContentTemplate</code>  <code>PopupChildWindowAction</code> ,    ,    UI,      <code>Content</code>  .       <code>Title</code>  . <br> <b></b> <br>  ,    ,   <code>PopupChildWindowAction</code> ,     .    <code>Notification</code>  <code>NotificationChildWindow</code> ,        <code>Confirmation</code> ‚Äì <code>ConfirmationChildWindow</code> . <code>NotificationChildWindow</code>    ,   ,     <code>ConfirmationChildWindow</code>    <i>OK</i>  <i>Cancel</i> ,    .    ,   ,   <code>ChildWindow</code>  <code>PopupChildWindowAction</code> . <br>   ,  <code>InteractionRequestTrigger</code>  <code>PopupChildWindowAction</code> ,       <i>RI MVVM</i> . <br> <br> <code class="xml">&lt;i:Interaction.Triggers&gt; &lt;prism:InteractionRequestTrigger SourceObject="{Binding ConfirmCancelInteractionRequest}"&gt; &lt;prism:PopupChildWindowAction ContentTemplate="{StaticResource ConfirmWindowTemplate}"/&gt; &lt;/prism:InteractionRequestTrigger&gt; &lt;/i:Interaction.Triggers&gt; &lt;UserControl.Resources&gt; &lt;DataTemplate x:Key="ConfirmWindowTemplate"&gt; &lt;Grid MinWidth="250" MinHeight="100"&gt; &lt;TextBlock TextWrapping="Wrap" Grid.Row="0" Text="{Binding}"/&gt; &lt;/Grid&gt; &lt;/DataTemplate&gt; &lt;/UserControl.Resources&gt;</code> <br> <b></b> <br>      <code>ContentTemplate</code> ,   UI   <code>Content</code>  .    <code>Content</code>  ,  , <code>TextBlock</code>     <code>Content</code> . <br>      ,     ,    ,    .  ,     ,       ,     ,    .   ,   <i>RI MVVM</i> ,         <code>Confirmed</code>    <code>Confirmation</code>  <code>true</code> ,     OK. <br> <br>        ,     .  Prism <code>InteractionRequestTrigger</code>   <code>PopupChildWindowAction</code>            . <br> <br>     <br>     MVVM,       , ,    ,         .        (  , ,  ,   ).    ,  ,  ,            . <br> <br>        ,         . Managed Extensibility Framework (MEF)  Unity Application Block (Unity)      ,  ,           . <br> <br>  ,       , , ,    ( )      . ,       ,     .  ,     ,       . <br> <br>     ,  MEF <br>  MEF,       ,   <code>Import</code> ,      ,  ,   <code>Export</code> .         ,    . <br> <br> , <code>QuestionnaireView</code>   <i>RI MVVM</i> ,        ,    <code>Import</code> .   , MEF           .  <code>set</code>        ,   . <br> <br> <code class="cs">[Import] public QuestionnaireViewModel ViewModel { set { this.DataContext = value; } }</code> <br>     ,   . <br> <br> <code class="cs">[Export] public class QuestionnaireViewModel : NotificationObject { ... }</code> <br>        ,   . <br> <br> <code class="cs">public QuestionnaireView() { InitializeComponent(); } [ImportingConstructor] public QuestionnaireView(QuestionnaireViewModel viewModel) : this() { this.DataContext = viewModel; }</code> <br> <b></b> <br>          MEF,   Unity.   ,     ,        .   ,   Visual Studio  Expression Blend, ,        ,     .   ,   ,  ,      ,          <code>InitializeComponent</code> . <br>     ,  Unity <br>  Unity,    ,   MEF.     ,      .    ,         .  ,      . <br> <br>  ,      ,  ,         . ,           ,   . <br> <br> <code class="cs">public QuestionnaireView() { InitializeComponent(); } public QuestionnaireView(QuestionnaireViewModel viewModel) : this() { this.DataContext = viewModel; }</code> <br> <b></b> <br>    ,        ,   Visual Studio  Expression Blend. <br>  ,          ,   . Unity        <code>set</code>   ,   . <br> <br> <code class="cs">public QuestionnaireView() { InitializeComponent(); } [Dependency] public QuestionnaireViewModel ViewModel { set { this.DataContext = value; } }</code> <br>       Unity. <br> <br> <code class="cs">container.RegisterType&lt;QuestionnaireViewModel&gt;();</code> <br>  ,     . <br> <br> <code class="cs">var view = container.Resolve&lt;QuestionnaireView&gt;();</code> <br>     ,    <br>   ,     ,        .        ,   MEF  Unity,        . <br> <br>          .   ,         UI,           . <br> <br> , <i>RI MVVM</i>   ,   ,        .   ,    .      <code>ShowView</code>   UI. <br> <br> <code class="cs">private void NavigateToQuestionnaireList() { //     "questionnaire list". this.uiService.ShowView(ViewNames.QuestionnaireTemplatesList); }</code> <br>  UI      UI .           UI.  <code>ShowView</code>  <code>UIService</code>      (,          ),       ,   . <br> <br> <code class="cs">public void ShowView(string viewName) { var view = this.ViewFactory.GetView(viewName); this.MainWindow.CurrentView = view; }</code> <br> <b></b> <br> Prism       .   ,   ,   ,             .    ,  , " <a href="http://msdn.microsoft.com/en-us/library/gg430861(v%3DPandP.40).aspx">View-Based Navigation</a> "   8, " <a href="http://msdn.microsoft.com/en-us/library/gg430861(v%3DPandP.40).aspx">Navigation</a> ". <br>  MVVM  <br>        MVVM      .           -      mocking . ,   ,        . <br> <br>   <i>INotifyPropertyChanged</i> <br>   <code>INotifyPropertyChanged</code>     ,      .      ,    ;   ,   ,     ,    ,       . <br> <br>   <br> ,       ,           <code>PropertyChanged</code>  ,         .  ,    <code>ChangeTracker</code> ,     MVVM,  ,      .      .     ,    . <br> <br> <code class="cs">var changeTracker = new PropertyChangeTracker(viewModel); viewModel.CurrentState = "newState"; CollectionAssert.Contains(changeTracker.ChangedProperties, "CurrentState");</code> <br> ,     ,     <code>INotifyPropertyChanged</code> ,    ,   ,     . <br> <br>      <br>        ,   ,    <code>set</code>      ,           . ,     ,     ,      ,          . <br> <br> <code class="cs">var changeTracker = new PropertyChangeTracker(viewModel); var question = viewModel.Questions.First() as OpenQuestionViewModel; question.Question.Response = "some text"; CollectionAssert.Contains(changeTracker.ChangedProperties, "UnansweredQuestions");</code> <br>      <br>     <code>INotifyPropertyChanged</code> ,      <code>PropertyChanged</code>        ,  ,     , , .        ,       . <br> <br>   <i>INotifyDataErrorInfo</i> <br>   ,     ,    ,   ,   <code>IDataErrorInfo</code> ,  ( Silverlight)   <code>INotifyDataErrorInfo</code> .   <code>INotifyDataErrorInfo</code>   ,         ,    ,  ,   ,    . <br> <br>       <code>INotifyDataErrorInfo</code> : ,     ,  ,     ,     <code>ErrorsChanged</code> ,      <code>GetErrors</code> , . <br> <br>    <br>     ,      ,     .       ,         <code>GetErrors</code>       ,  ,  ,   .    , ,  ,     ,        .   ,        . <br> <br> <code class="cs">//  . var notifyErrorInfo = (INotifyDataErrorInfo)question; question.Response = -15; Assert.IsTrue(notifyErrorInfo.GetErrors("Response").Cast&lt;ValidationResult&gt;().Any()); //  . var notifyErrorInfo = (INotifyDataErrorInfo)question; question.Response = 15; Assert.IsFalse(notifyErrorInfo.GetErrors("Response").Cast&lt;ValidationResult&gt;().Any());</code> <br>    ,    ,             . <br> <br>    <i>INotifyDataErrorInfo</i> <br>       <code>GetErrors</code> ,   <code>INotifyDataErrorInfo</code>  ,   <code>ErrorsChanged</code>      <code>GetErrors</code> . ,  <code>HasErrors</code>      ,  . <br> <br>       <code>INotifyDataErrorInfo</code> . , ,           ,   -  .      ,        <code>INotifyDataErrorInfo</code>         (,        ). <br> <br>     ,   ,  : <br>  <code>HasErrors</code>     .              ,       .  <code>ErrorsChanged</code> ,      ,         <code>GetErrors</code> .         ( ,  )     ,           .    <code>GetErrors</code>       <code>ErrorsChanged</code> . <br>    <code>INotifyPropertyChanged</code> ,  ,    <code>NotifyDataErrorInfoTestHelper</code>    MVVM,        <code>INotifyDataErrorInfo</code> ,       .   ,   ,      ,   .      . <br> <code class="cs">var helper = new NotifyDataErrorInfoTestHelper&lt;NumericQuestion, int?&gt;( question, q =&gt; q.Response); helper.ValidatePropertyChange( 6, NotifyDataErrorInfoBehavior.Nothing); helper.ValidatePropertyChange( 20, NotifyDataErrorInfoBehavior.FiresErrorsChanged | NotifyDataErrorInfoBehavior.HasErrors | NotifyDataErrorInfoBehavior.HasErrorsForProperty); helper.ValidatePropertyChange( null, NotifyDataErrorInfoBehavior.FiresErrorsChanged | NotifyDataErrorInfoBehavior.HasErrors | NotifyDataErrorInfoBehavior.HasErrorsForProperty); helper.ValidatePropertyChange( 2, NotifyDataErrorInfoBehavior.FiresErrorsChanged);</code> <br>     <br>   MVVM,     ,  .   ,    ,         . <br> <br>  ,     ,     ,       .   ,   , ,       ,     ,   <code>IAsyncResult</code>    ,  - ,   ,    UI. <br> <br>       , , ,    .   ,     .  ,      UI,     ,   ,          ,     ,        "   UI." <br> <br>     ,    ,    .   ,    ,     mock-, ,   ,   ,      ,          . <br> <br>           UI,    ,    .   ,     ,   ,      .        ,   .     ,    ,     . <br> <br> <code class="cs">questionnaireRepositoryMock .Setup( r =&gt; r.SubmitQuestionnaireAsync( It.IsAny&lt;Questionnaire&gt;(), It.IsAny&lt;Action&lt;IOperationResult&gt;&gt;())) .Callback&lt;Questionnaire, Action&lt;IOperationResult&gt;&gt;( (q, a) =&gt; callback = a); uiServicemock .Setup(svc =&gt; svc.ShowView(ViewNames.QuestionnaireTemplatesList)) .Callback&lt;string&gt;(viewName =&gt; requestedViewName = viewName); submitResultMock .Setup(sr =&gt; sr.Error) .Returns&lt;Exception&gt;(null); CompleteQuestionnaire(viewModel); viewModel.Submit(); //      UI . callback(submitResultMock.Object); //    ‚Äì     . Assert.AreEqual(ViewNames.QuestionnaireTemplatesList, requestedViewName);</code> <br> <b></b> <br>          ,        . <br>   <br>       , . "Trees in WPF"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ms753391.aspx">http://msdn.microsoft.com/en-us/library/ms753391.aspx</a> <br> <br>       , . "Attached Properties Overview"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/cc265152(VS.95).aspx">http://msdn.microsoft.com/en-us/library/cc265152(VS.95).aspx</a> <br> <br>      MEF, ."Managed Extensibility Framework Overview"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/dd460648.aspx">http://msdn.microsoft.com/en-us/library/dd460648.aspx</a> . <br> <br>      Unity, ."Unity Application Block"  MSDN: <a href="http://www.msdn.com/unity">http://www.msdn.com/unity</a> . <br> <br>      <code>DelegateCommand</code> , .Chapter 5, " <a href="http://msdn.microsoft.com/en-us/library/gg405484(v%3DPandP.40).aspx">Implementing the MVVM Pattern</a> ." <br> <br>        Microsoft Expression Blend, ."Working with built-in behaviors"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ff724013(v%3DExpression.40).aspx">http://msdn.microsoft.com/en-us/library/ff724013(v=Expression.40).aspx</a> . <br> <br>          Microsoft Expression Blend, ."Creating Custom Behaviors"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ff724708(v%3DExpression.40).aspx">http://msdn.microsoft.com/en-us/library/ff724708(v=Expression.40).aspx</a> . <br> <br>            Microsoft Expression Blend, ."Creating Custom Triggers and Actions"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ff724707(v%3DExpression.40).aspx">http://msdn.microsoft.com/en-us/library/ff724707(v=Expression.40).aspx</a> . <br> <br>         WPF  Silverlight, ."Threading Model"  "The Dispatcher Class"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ms741870.aspx">http://msdn.microsoft.com/en-us/library/ms741870.aspx</a> <br> <a href="http://msdn.microsoft.com/en-us/library/ms615907(v%3DVS.95).aspx">http://msdn.microsoft.com/en-us/library/ms615907(v=VS.95).aspx</a> . <br> <br>      unit-  Silverlight, ."Unit Testing with Silverlight 2": <a href="http://www.jeff.wilcox.name/2008/03/silverlight2-unit-testing/">http://www.jeff.wilcox.name/2008/03/silverlight2-unit-testing/</a> . <br> <br>         , .  " <a href="http://msdn.microsoft.com/en-us/library/gg430861(v%3DPandP.40).aspx">View-Based Navigation</a> " in Chapter 8, " <a href="http://msdn.microsoft.com/en-us/library/gg430861(v%3DPandP.40).aspx">Navigation</a> ." <br> <br>       ,   , ."Event-based Asynchronous Pattern Overview"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/wewwczdw.aspx">http://msdn.microsoft.com/en-us/library/wewwczdw.aspx</a> <br> <br>        <code>IAsyncResult</code> , ."Asynchronous Programming Overview"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ms228963.aspx">http://msdn.microsoft.com/en-us/library/ms228963.aspx</a></code></code></code></code></code></code></code></code></code> <pre> <code class="hljs cmake"><code>CommandBehaviorBase ,    ,    ICommand</code> .           <code>CanExecuteChanged</code> ,          Silverlight,    WPF. <br> <br>    ,  ,   <code><code>CommandBehaviorBase    ,    .         ,      .         ,    .      ButtonBaseClickCommandBehavior</code> . <br> <br> <code class="cs">public class ButtonBaseClickCommandBehavior : CommandBehaviorBase&lt;ButtonBase&gt; { public ButtonBaseClickCommandBehavior(ButtonBase clickableObject) : base(clickableObject) { clickableObject.Click += OnClick; } private void OnClick(object sender, System.Windows.RoutedEventArgs e) { ExecuteCommand(); } }</code> <br>   <code><code>CommandBehaviorBase ,     .     ,          ,   . ,    ,    ,      , ,    CanExecute</code>  ,     . <br> <br>          ,   .           XAML.           .       .  Prism      ,       ,  ,   .       ,    . , ,  ,      <code>Click</code> ,       <code><span class="hljs-keyword"><span class="hljs-keyword">Command</span></span></code> .    <code>Click.<span class="hljs-keyword"><span class="hljs-keyword">Command</span></span></code> ,  . <br> <br>             .             . <br> <br> <code class="cs">public static readonly DependencyProperty CommandProperty = DependencyProperty.RegisterAttached( <span class="hljs-string"><span class="hljs-string">"Command"</span></span>, typeof(ICommand), typeof(Click), new PropertyMetadata(OnSetCommandCallback)); private static readonly DependencyProperty ClickCommandBehaviorProperty = DependencyProperty.RegisterAttached( <span class="hljs-string"><span class="hljs-string">"ClickCommandBehavior"</span></span>, typeof(ButtonBaseClickCommandBehavior), typeof(Click), null);</code> <br>    <code><span class="hljs-keyword"><span class="hljs-keyword">Command</span></span></code>    <code>ButtonBaseClickCommandBehavior</code> ,     <code>OnSetCommandCallback</code> ,     . <br> <br> <code class="cs">private static void OnSetCommandCallback(DependencyObject dependencyObject, DependencyPropertyChangedEventArgs e) { ButtonBase buttonBase = dependencyObject as ButtonBase; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (buttonBase != null) { ButtonBaseClickCommandBehavior behavior = GetOrCreateBehavior(buttonBase); behavior.<span class="hljs-keyword"><span class="hljs-keyword">Command</span></span> = e.NewValue as ICommand; } } private static void OnSetCommandParameterCallback(DependencyObject dependencyObject, DependencyPropertyChangedEventArgs e) { ButtonBase buttonBase = dependencyObject as ButtonBase; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (buttonBase != null) { ButtonBaseClickCommandBehavior behavior = GetOrCreateBehavior(buttonBase); behavior.CommandParameter = e.NewValue; } } private static ButtonBaseClickCommandBehavior GetOrCreateBehavior(ButtonBase buttonBase ) { ButtonBaseClickCommandBehavior behavior = buttonBase.GetValue(ClickCommandBehaviorProperty) as ButtonBaseClickCommandBehavior; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ( behavior == null ) { behavior = new ButtonBaseClickCommandBehavior(buttonBase); buttonBase.SetValue(ClickCommandBehaviorProperty, behavior); } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> behavior; }</code> <br>        ,  <a href="http://msdn.microsoft.com/en-us/library/cc265152(VS.95).aspx">Attached Properties Overview</a>  MSDN. <br> <br>    <br>              . ,     Silverlight,    -,     ,      ,     .     ,       . <br> <br>        ,    ( )  ,  ,     .  UI       ,            UI. <br> <br>      - <br>   -     ,       <code>IAsyncResult</code> .   ,  ,   ,  <code>GetQuestionnaire</code> ,   : <code>BeginGetQuestionnaire</code>  <code>EndGetQuestionnaire</code> .    ,   <code>BeginGetQuestionnaire</code> .     ,   ,   <code>EndGetQuestionnaire</code>    . <br> <b></b> <br>  .NET Framework <span class="hljs-number"><span class="hljs-number">4.5</span></span>      <code>await</code>  <code>async</code>     <code>*Async</code> .      <a href="http://msdn.microsoft.com/en-us/library/vstudio/hh391443.aspx"><span class="hljs-string"><span class="hljs-string">"Asynchronous Programming with Async and Await (C# and Visual Basic)"</span></span></a> . <br>  ,    <code>EndGetQuestionnaire</code> ,      ,  ()      <code>BeginGetQuestionnaire</code> .     ,      ,   <code>EndGetQuestionnaire</code> ,   . <br> <br> <code class="xml">IAsyncResult asyncResult = this.service.BeginGetQuestionnaire( GetQuestionnaireCompleted, null //  ,      ); private void GetQuestionnaireCompleted(IAsyncResult result) { try { questionnaire = this.service.EndGetQuestionnaire(ar); } catch (Exception ex) { //  -   . } }</code> <br>  ,     <code>End*</code> (  , <code>EndGetQuestionnaire</code> ),    ,      .      , ,          UI.     ,   ,        . <br> <br>        UI,     -,      UI,         UI,   <code>Dispatcher</code>    <code>SynchronizationContext</code> .  WPF  Silverlight,   <code>Dispatcher</code> . <br> <br>      <code>Questionnaire</code>  ,        <code>QuestionnaireView</code> .  Silverlight    <code>CheckAccess</code> ,  ,      UI.  ,     <code>BeginInvoke</code> ,      UI. <br> <br> <code class="cs">var dispatcher = System.Windows.Deployment.Current.Dispatcher; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (dispatcher.CheckAccess()) { QuestionnaireView.DataContext = questionnaire; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { dispatcher.BeginInvoke(() =&gt; { Questionnaire.DataContext = questionnaire; }); }</code> <br> <i>MVVM RI</i>   ,    ,   <code>IAsyncResult</code> ,   .      ,                 . ,       . <br> <br> <code class="cs">this.questionnaireRepository.GetQuestionnaireAsync( result =&gt; { this.Questionnaire = result.Result; });</code> <br>  <code>result</code>   ,     , , , .    ,     . <br> <br> <code class="cs">this.questionnaireRepository.GetQuestionnaireAsync( result =&gt; { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (result.Error == null) { this.Questionnaire = result.Result; ... } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { // Handle error. } })</code> <br>     <br>        ,      .     , ,             .        ,      ,     ,     . <br> <br>         ,      MVVM,     ,   . ,  -MVVM ,     <code>MessageBox</code>   code-behind UI,      .   MVVM     ,          . <br> <br>     MVVM,              ,          .      ,    ,   ,  ,     . <br> <br>              MVVM.      ,     ,     ,  ,     .    ,         ,     ,          .       . <br> <br>    <br>                  .        ,        .  ,         .         . <br> <br>  ,         ,         ,  .      ,     .           ,       . ,        WPF  Silverlight,        . <br> <br> <img title="Using the service to interact with the user." src="https://habrastorage.org/getpro/habr/post_images/4b5/397/f2d/4b5397f2d02e5851195b29f1893be6fc.png" alt=" ,    ."> <br> <br>  ,   <code>MessageBox</code>        ,     ,    ,     . <br> <br> <code class="cs">var result = interactionService.ShowMessageBox( <span class="hljs-string"><span class="hljs-string">"Are you sure you want to cancel this operation?"</span></span>, <span class="hljs-string"><span class="hljs-string">"Confirm"</span></span>, MessageBoxButton.OK); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (result == MessageBoxResult.Yes) { CancelRequest(); }</code> <br> ,      - ,      ,         Silverlight.         .             .     . <br> <br> <code class="cs">interactionService.ShowMessageBox( <span class="hljs-string"><span class="hljs-string">"Are you sure you want to cancel this operation?"</span></span>, <span class="hljs-string"><span class="hljs-string">"Confirm"</span></span>, MessageBoxButton.OK, result =&gt; { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (result == MessageBoxResult.Yes) { CancelRequest(); } });</code> <br>         ,      . ,  WPF    <code>MessageBox</code> ,       ;    Silverlight    ,    . <br> <br>     <br>         ‚Äì             .         ,      .     ,     .        ,        ,   ,     . <br> <br> <img title="Using interaction request objects." src="https://habrastorage.org/getpro/habr/post_images/3d0/ff0/1c5/3d0ff01c5518558c2d3c5c5f47ce0ce9.png" alt="   ."> <br> <br>    ,   ,          ‚Äì       ,      ,   ‚Äì     .   ,        ,    ,    UI            . <br> <br>       MVVM,     ,       ,         .         ,        ,    ,   . <br> <br>  Prism       <code>IInteractionRequest</code>   <code><code>InteractionRequest .  IInteractionRequest</code>  ,   .           ,   .  <code><code>InteractionRequest   IInteractionRequest</code>     <code>Raise</code> ,           , , ,   . <br> <br>       <br>  <code><code>InteractionRequest          .  Raise</code>          ( <code>T</code> )    ,    ,   .          ,       .      ,        .    ,  ,     . <br> <code class="cs">public interface IInteractionRequest { event EventHandler&lt;InteractionRequestedEventArgs&gt; Raised; } public class InteractionRequest&lt;T&gt; : IInteractionRequest { public event EventHandler&lt;InteractionRequestedEventArgs&gt; Raised; public void Raise(T context, Action&lt;T&gt; callback) { var handler = this.Raised; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (handler != null) { handler( this, new InteractionRequestedEventArgs(context, () =&gt; callback(context))); } } }</code> <br> Prism    ,      .  <code>Notification</code>       .    ,            .     ‚Äì <code>Title</code>  <code>Content</code> ,    .  ,   ,  ,  ,        . <br> <br>  <code>Confirmation</code>    <code>Notification</code>     ‚Äì <code>Confirmed</code> ,  ,  ,      .  <code>Confirmation</code> ,     <code>MessageBox</code> ,     /  .     ,     <code>Notification</code> ,     ,      . <br> <br>    <code><code><code>InteractionRequest ,       InteractionRequest      ,      .      ,    Raise</code> ,    , ,   . <br> <br> <code class="cs">public IInteractionRequest ConfirmCancelInteractionRequest { get { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> this.confirmCancelInteractionRequest; } } this.confirmCancelInteractionRequest.Raise( new Confirmation(<span class="hljs-string"><span class="hljs-string">"Are you sure you wish to cancel?"</span></span>), confirmation =&gt; { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (confirmation.Confirmed) { this.NavigateToQuestionnaireList(); } }); }</code> <br> <i>MVVM Reference Implementation (MVVM RI)</i> ,    <code>IInteractionRequest</code>   <code><code>InteractionRequest ,          (. QuestionnaireViewModel.cs</code> ). <br> <br>        <br>       ,       .   ,       .    UI             . <br> <br>                . Microsoft Expression Blend Behaviors Framework     .  ,     ,    . <br> <br>  <code>EventTrigger</code> ,  Expression Blend,  ,      ,     ,   . , Prism   <code>EventTrigger</code> ,  <code>InteractionRequestTrigger</code> ,      <code>Raised</code>   <code>IInteractionRequest</code> .    XAML        . <br> <br>  ,   , <code>InteractionRequestTrigger</code>   .  Silverlight Prism   <code>PopupChildWindowAction</code> ,     .    ,         .   <code>ContentTemplate</code>  <code>PopupChildWindowAction</code> ,    ,    UI,      <code>Content</code>  .       <code>Title</code>  . <br> <b></b> <br>  ,    ,   <code>PopupChildWindowAction</code> ,     .    <code>Notification</code>  <code>NotificationChildWindow</code> ,        <code>Confirmation</code> ‚Äì <code>ConfirmationChildWindow</code> . <code>NotificationChildWindow</code>    ,   ,     <code>ConfirmationChildWindow</code>    <i>OK</i>  <i>Cancel</i> ,    .    ,   ,   <code>ChildWindow</code>  <code>PopupChildWindowAction</code> . <br>   ,  <code>InteractionRequestTrigger</code>  <code>PopupChildWindowAction</code> ,       <i>RI MVVM</i> . <br> <br> <code class="xml">&lt;i:Interaction.Triggers&gt; &lt;prism:InteractionRequestTrigger SourceObject=<span class="hljs-string"><span class="hljs-string">"{Binding ConfirmCancelInteractionRequest}"</span></span>&gt; &lt;prism:PopupChildWindowAction ContentTemplate=<span class="hljs-string"><span class="hljs-string">"{StaticResource ConfirmWindowTemplate}"</span></span>/&gt; &lt;/prism:InteractionRequestTrigger&gt; &lt;/i:Interaction.Triggers&gt; &lt;UserControl.Resources&gt; &lt;DataTemplate x:Key=<span class="hljs-string"><span class="hljs-string">"ConfirmWindowTemplate"</span></span>&gt; &lt;Grid MinWidth=<span class="hljs-string"><span class="hljs-string">"250"</span></span> MinHeight=<span class="hljs-string"><span class="hljs-string">"100"</span></span>&gt; &lt;TextBlock TextWrapping=<span class="hljs-string"><span class="hljs-string">"Wrap"</span></span> Grid.Row=<span class="hljs-string"><span class="hljs-string">"0"</span></span> Text=<span class="hljs-string"><span class="hljs-string">"{Binding}"</span></span>/&gt; &lt;/Grid&gt; &lt;/DataTemplate&gt; &lt;/UserControl.Resources&gt;</code> <br> <b></b> <br>      <code>ContentTemplate</code> ,   UI   <code>Content</code>  .    <code>Content</code>  ,  , <code>TextBlock</code>     <code>Content</code> . <br>      ,     ,    ,    .  ,     ,       ,     ,    .   ,   <i>RI MVVM</i> ,         <code>Confirmed</code>    <code>Confirmation</code>  <code><span class="hljs-keyword"><span class="hljs-keyword">true</span></span></code> ,     OK. <br> <br>        ,     .  Prism <code>InteractionRequestTrigger</code>   <code>PopupChildWindowAction</code>            . <br> <br>     <br>     MVVM,       , ,    ,         .        (  , ,  ,   ).    ,  ,  ,            . <br> <br>        ,         . Managed Extensibility Framework (MEF)  Unity Application Block (Unity)      ,  ,           . <br> <br>  ,       , , ,    ( )      . ,       ,     .  ,     ,       . <br> <br>     ,  MEF <br>  MEF,       ,   <code>Import</code> ,      ,  ,   <code><span class="hljs-keyword"><span class="hljs-keyword">Export</span></span></code> .         ,    . <br> <br> , <code>QuestionnaireView</code>   <i>RI MVVM</i> ,        ,    <code>Import</code> .   , MEF           .  <code><span class="hljs-keyword"><span class="hljs-keyword">set</span></span></code>        ,   . <br> <br> <code class="cs">[Import] public QuestionnaireViewModel ViewModel { <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> { this.DataContext = value; } }</code> <br>     ,   . <br> <br> <code class="cs">[<span class="hljs-keyword"><span class="hljs-keyword">Export</span></span>] public class QuestionnaireViewModel : NotificationObject { ... }</code> <br>        ,   . <br> <br> <code class="cs">public QuestionnaireView() { InitializeComponent(); } [ImportingConstructor] public QuestionnaireView(QuestionnaireViewModel viewModel) : this() { this.DataContext = viewModel; }</code> <br> <b></b> <br>          MEF,   Unity.   ,     ,        .   ,   Visual Studio  Expression Blend, ,        ,     .   ,   ,  ,      ,          <code>InitializeComponent</code> . <br>     ,  Unity <br>  Unity,    ,   MEF.     ,      .    ,         .  ,      . <br> <br>  ,      ,  ,         . ,           ,   . <br> <br> <code class="cs">public QuestionnaireView() { InitializeComponent(); } public QuestionnaireView(QuestionnaireViewModel viewModel) : this() { this.DataContext = viewModel; }</code> <br> <b></b> <br>    ,        ,   Visual Studio  Expression Blend. <br>  ,          ,   . Unity        <code><span class="hljs-keyword"><span class="hljs-keyword">set</span></span></code>   ,   . <br> <br> <code class="cs">public QuestionnaireView() { InitializeComponent(); } [Dependency] public QuestionnaireViewModel ViewModel { <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> { this.DataContext = value; } }</code> <br>       Unity. <br> <br> <code class="cs">container.RegisterType&lt;QuestionnaireViewModel&gt;();</code> <br>  ,     . <br> <br> <code class="cs">var view = container.Resolve&lt;QuestionnaireView&gt;();</code> <br>     ,    <br>   ,     ,        .        ,   MEF  Unity,        . <br> <br>          .   ,         UI,           . <br> <br> , <i>RI MVVM</i>   ,   ,        .   ,    .      <code>ShowView</code>   UI. <br> <br> <code class="cs">private void NavigateToQuestionnaireList() { //     <span class="hljs-string"><span class="hljs-string">"questionnaire list"</span></span>. this.uiService.ShowView(ViewNames.QuestionnaireTemplatesList); }</code> <br>  UI      UI .           UI.  <code>ShowView</code>  <code>UIService</code>      (,          ),       ,   . <br> <br> <code class="cs">public void ShowView(<span class="hljs-keyword"><span class="hljs-keyword">string</span></span> viewName) { var view = this.ViewFactory.GetView(viewName); this.MainWindow.CurrentView = view; }</code> <br> <b></b> <br> Prism       .   ,   ,   ,             .    ,  , <span class="hljs-string"><span class="hljs-string">" </span></span><a href="http://msdn.microsoft.com/en-us/library/gg430861(v%3DPandP.40).aspx"><span class="hljs-string"><span class="hljs-string">View-Based Navigation</span></span></a><span class="hljs-string"><span class="hljs-string"> "</span></span>   <span class="hljs-number"><span class="hljs-number">8</span></span>, <span class="hljs-string"><span class="hljs-string">" </span></span><a href="http://msdn.microsoft.com/en-us/library/gg430861(v%3DPandP.40).aspx"><span class="hljs-string"><span class="hljs-string">Navigation</span></span></a><span class="hljs-string"><span class="hljs-string"> "</span></span>. <br>  MVVM  <br>        MVVM      .           -      mocking . ,   ,        . <br> <br>   <i>INotifyPropertyChanged</i> <br>   <code>INotifyPropertyChanged</code>     ,      .      ,    ;   ,   ,     ,    ,       . <br> <br>   <br> ,       ,           <code>PropertyChanged</code>  ,         .  ,    <code>ChangeTracker</code> ,     MVVM,  ,      .      .     ,    . <br> <br> <code class="cs">var changeTracker = new PropertyChangeTracker(viewModel); viewModel.CurrentState = <span class="hljs-string"><span class="hljs-string">"newState"</span></span>; CollectionAssert.Contains(changeTracker.ChangedProperties, <span class="hljs-string"><span class="hljs-string">"CurrentState"</span></span>);</code> <br> ,     ,     <code>INotifyPropertyChanged</code> ,    ,   ,     . <br> <br>      <br>        ,   ,    <code><span class="hljs-keyword"><span class="hljs-keyword">set</span></span></code>      ,           . ,     ,     ,      ,          . <br> <br> <code class="cs">var changeTracker = new PropertyChangeTracker(viewModel); var question = viewModel.Questions.First() as OpenQuestionViewModel; question.Question.Response = <span class="hljs-string"><span class="hljs-string">"some text"</span></span>; CollectionAssert.Contains(changeTracker.ChangedProperties, <span class="hljs-string"><span class="hljs-string">"UnansweredQuestions"</span></span>);</code> <br>      <br>     <code>INotifyPropertyChanged</code> ,      <code>PropertyChanged</code>        ,  ,     , , .        ,       . <br> <br>   <i>INotifyDataErrorInfo</i> <br>   ,     ,    ,   ,   <code>IDataErrorInfo</code> ,  ( Silverlight)   <code>INotifyDataErrorInfo</code> .   <code>INotifyDataErrorInfo</code>   ,         ,    ,  ,   ,    . <br> <br>       <code>INotifyDataErrorInfo</code> : ,     ,  ,     ,     <code>ErrorsChanged</code> ,      <code>GetErrors</code> , . <br> <br>    <br>     ,      ,     .       ,         <code>GetErrors</code>       ,  ,  ,   .    , ,  ,     ,        .   ,        . <br> <br> <code class="cs">//  . var notifyErrorInfo = (INotifyDataErrorInfo)question; question.Response = -<span class="hljs-number"><span class="hljs-number">15</span></span>; Assert.IsTrue(notifyErrorInfo.GetErrors(<span class="hljs-string"><span class="hljs-string">"Response"</span></span>).Cast&lt;ValidationResult&gt;().Any()); //  . var notifyErrorInfo = (INotifyDataErrorInfo)question; question.Response = <span class="hljs-number"><span class="hljs-number">15</span></span>; Assert.IsFalse(notifyErrorInfo.GetErrors(<span class="hljs-string"><span class="hljs-string">"Response"</span></span>).Cast&lt;ValidationResult&gt;().Any());</code> <br>    ,    ,             . <br> <br>    <i>INotifyDataErrorInfo</i> <br>       <code>GetErrors</code> ,   <code>INotifyDataErrorInfo</code>  ,   <code>ErrorsChanged</code>      <code>GetErrors</code> . ,  <code>HasErrors</code>      ,  . <br> <br>       <code>INotifyDataErrorInfo</code> . , ,           ,   -  .      ,        <code>INotifyDataErrorInfo</code>         (,        ). <br> <br>     ,   ,  : <br>  <code>HasErrors</code>     .              ,       .  <code>ErrorsChanged</code> ,      ,         <code>GetErrors</code> .         ( ,  )     ,           .    <code>GetErrors</code>       <code>ErrorsChanged</code> . <br>    <code>INotifyPropertyChanged</code> ,  ,    <code>NotifyDataErrorInfoTestHelper</code>    MVVM,        <code>INotifyDataErrorInfo</code> ,       .   ,   ,      ,   .      . <br> <code class="cs">var helper = new NotifyDataErrorInfoTestHelper&lt;NumericQuestion, int?&gt;( question, q =&gt; q.Response); helper.ValidatePropertyChange( <span class="hljs-number"><span class="hljs-number">6</span></span>, NotifyDataErrorInfoBehavior.Nothing); helper.ValidatePropertyChange( <span class="hljs-number"><span class="hljs-number">20</span></span>, NotifyDataErrorInfoBehavior.FiresErrorsChanged | NotifyDataErrorInfoBehavior.HasErrors | NotifyDataErrorInfoBehavior.HasErrorsForProperty); helper.ValidatePropertyChange( null, NotifyDataErrorInfoBehavior.FiresErrorsChanged | NotifyDataErrorInfoBehavior.HasErrors | NotifyDataErrorInfoBehavior.HasErrorsForProperty); helper.ValidatePropertyChange( <span class="hljs-number"><span class="hljs-number">2</span></span>, NotifyDataErrorInfoBehavior.FiresErrorsChanged);</code> <br>     <br>   MVVM,     ,  .   ,    ,         . <br> <br>  ,     ,     ,       .   ,   , ,       ,     ,   <code>IAsyncResult</code>    ,  - ,   ,    UI. <br> <br>       , , ,    .   ,     .  ,      UI,     ,   ,          ,     ,        <span class="hljs-string"><span class="hljs-string">"   UI."</span></span> <br> <br>     ,    ,    .   ,    ,     mock-, ,   ,   ,      ,          . <br> <br>           UI,    ,    .   ,     ,   ,      .        ,   .     ,    ,     . <br> <br> <code class="cs">questionnaireRepositoryMock .Setup( r =&gt; r.SubmitQuestionnaireAsync( It.IsAny&lt;Questionnaire&gt;(), It.IsAny&lt;Action&lt;IOperationResult&gt;&gt;())) .Callback&lt;Questionnaire, Action&lt;IOperationResult&gt;&gt;( (q, a) =&gt; callback = a); uiServicemock .Setup(svc =&gt; svc.ShowView(ViewNames.QuestionnaireTemplatesList)) .Callback&lt;<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>&gt;(viewName =&gt; requestedViewName = viewName); submitResultMock .Setup(sr =&gt; sr.Error) .Returns&lt;Exception&gt;(null); CompleteQuestionnaire(viewModel); viewModel.Submit(); //      UI . callback(submitResultMock.Object); //    ‚Äì     . Assert.AreEqual(ViewNames.QuestionnaireTemplatesList, requestedViewName);</code> <br> <b></b> <br>          ,        . <br>   <br>       , . <span class="hljs-string"><span class="hljs-string">"Trees in WPF"</span></span>  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ms753391.aspx">http://msdn.microsoft.com/en-us/library/ms753391.aspx</a> <br> <br>       , . <span class="hljs-string"><span class="hljs-string">"Attached Properties Overview"</span></span>  MSDN: <a href="http://msdn.microsoft.com/en-us/library/cc265152(VS.95).aspx">http://msdn.microsoft.com/en-us/library/cc265152(VS.<span class="hljs-number"><span class="hljs-number">95</span></span>).aspx</a> <br> <br>      MEF, .<span class="hljs-string"><span class="hljs-string">"Managed Extensibility Framework Overview"</span></span>  MSDN: <a href="http://msdn.microsoft.com/en-us/library/dd460648.aspx">http://msdn.microsoft.com/en-us/library/dd460648.aspx</a> . <br> <br>      Unity, .<span class="hljs-string"><span class="hljs-string">"Unity Application Block"</span></span>  MSDN: <a href="http://www.msdn.com/unity">http://www.msdn.com/unity</a> . <br> <br>      <code>DelegateCommand</code> , .Chapter <span class="hljs-number"><span class="hljs-number">5</span></span>, <span class="hljs-string"><span class="hljs-string">" </span></span><a href="http://msdn.microsoft.com/en-us/library/gg405484(v%3DPandP.40).aspx"><span class="hljs-string"><span class="hljs-string">Implementing the MVVM Pattern</span></span></a><span class="hljs-string"><span class="hljs-string"> ."</span></span> <br> <br>        Microsoft Expression Blend, .<span class="hljs-string"><span class="hljs-string">"Working with built-in behaviors"</span></span>  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ff724013(v%3DExpression.40).aspx">http://msdn.microsoft.com/en-us/library/ff724013(v=Expression.<span class="hljs-number"><span class="hljs-number">40</span></span>).aspx</a> . <br> <br>          Microsoft Expression Blend, .<span class="hljs-string"><span class="hljs-string">"Creating Custom Behaviors"</span></span>  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ff724708(v%3DExpression.40).aspx">http://msdn.microsoft.com/en-us/library/ff724708(v=Expression.<span class="hljs-number"><span class="hljs-number">40</span></span>).aspx</a> . <br> <br>            Microsoft Expression Blend, .<span class="hljs-string"><span class="hljs-string">"Creating Custom Triggers and Actions"</span></span>  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ff724707(v%3DExpression.40).aspx">http://msdn.microsoft.com/en-us/library/ff724707(v=Expression.<span class="hljs-number"><span class="hljs-number">40</span></span>).aspx</a> . <br> <br>         WPF  Silverlight, .<span class="hljs-string"><span class="hljs-string">"Threading Model"</span></span>  <span class="hljs-string"><span class="hljs-string">"The Dispatcher Class"</span></span>  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ms741870.aspx">http://msdn.microsoft.com/en-us/library/ms741870.aspx</a> <br> <a href="http://msdn.microsoft.com/en-us/library/ms615907(v%3DVS.95).aspx">http://msdn.microsoft.com/en-us/library/ms615907(v=VS.<span class="hljs-number"><span class="hljs-number">95</span></span>).aspx</a> . <br> <br>      unit-  Silverlight, .<span class="hljs-string"><span class="hljs-string">"Unit Testing with Silverlight 2"</span></span>: <a href="http://www.jeff.wilcox.name/2008/03/silverlight2-unit-testing/">http://www.jeff.wilcox.name/<span class="hljs-number"><span class="hljs-number">2008</span></span>/<span class="hljs-number"><span class="hljs-number">03</span></span>/silverlight2-unit-testing/</a> . <br> <br>         , .  <span class="hljs-string"><span class="hljs-string">" </span></span><a href="http://msdn.microsoft.com/en-us/library/gg430861(v%3DPandP.40).aspx"><span class="hljs-string"><span class="hljs-string">View-Based Navigation</span></span></a><span class="hljs-string"><span class="hljs-string"> "</span></span> in Chapter <span class="hljs-number"><span class="hljs-number">8</span></span>, <span class="hljs-string"><span class="hljs-string">" </span></span><a href="http://msdn.microsoft.com/en-us/library/gg430861(v%3DPandP.40).aspx"><span class="hljs-string"><span class="hljs-string">Navigation</span></span></a><span class="hljs-string"><span class="hljs-string"> ."</span></span> <br> <br>       ,   , .<span class="hljs-string"><span class="hljs-string">"Event-based Asynchronous Pattern Overview"</span></span>  MSDN: <a href="http://msdn.microsoft.com/en-us/library/wewwczdw.aspx">http://msdn.microsoft.com/en-us/library/wewwczdw.aspx</a> <br> <br>        <code>IAsyncResult</code> , .<span class="hljs-string"><span class="hljs-string">"Asynchronous Programming Overview"</span></span>  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ms228963.aspx">http://msdn.microsoft.com/en-us/library/ms228963.aspx</a></code></code></code></code></code></code></code></code></code> </pre> <code><code><code><code><code><code><code><code><code><code>CommandBehaviorBase ,    ,    ICommand</code> .           <code>CanExecuteChanged</code> ,          Silverlight,    WPF. <br> <br>    ,  ,   <code>CommandBehaviorBase    ,    .         ,      .         ,    .      ButtonBaseClickCommandBehavior</code> . <br> <br> <code class="cs">public class ButtonBaseClickCommandBehavior : CommandBehaviorBase&lt;ButtonBase&gt; { public ButtonBaseClickCommandBehavior(ButtonBase clickableObject) : base(clickableObject) { clickableObject.Click += OnClick; } private void OnClick(object sender, System.Windows.RoutedEventArgs e) { ExecuteCommand(); } }</code> <br>   <code>CommandBehaviorBase ,     .     ,          ,   . ,    ,    ,      , ,    CanExecute</code>  ,     . <br> <br>          ,   .           XAML.           .       .  Prism      ,       ,  ,   .       ,    . , ,  ,      <code>Click</code> ,       <code>Command</code> .    <code>Click.Command</code> ,  . <br> <br>             .             . <br> <br> <code class="cs">public static readonly DependencyProperty CommandProperty = DependencyProperty.RegisterAttached( "Command", typeof(ICommand), typeof(Click), new PropertyMetadata(OnSetCommandCallback)); private static readonly DependencyProperty ClickCommandBehaviorProperty = DependencyProperty.RegisterAttached( "ClickCommandBehavior", typeof(ButtonBaseClickCommandBehavior), typeof(Click), null);</code> <br>    <code>Command</code>    <code>ButtonBaseClickCommandBehavior</code> ,     <code>OnSetCommandCallback</code> ,     . <br> <br> <code class="cs">private static void OnSetCommandCallback(DependencyObject dependencyObject, DependencyPropertyChangedEventArgs e) { ButtonBase buttonBase = dependencyObject as ButtonBase; if (buttonBase != null) { ButtonBaseClickCommandBehavior behavior = GetOrCreateBehavior(buttonBase); behavior.Command = e.NewValue as ICommand; } } private static void OnSetCommandParameterCallback(DependencyObject dependencyObject, DependencyPropertyChangedEventArgs e) { ButtonBase buttonBase = dependencyObject as ButtonBase; if (buttonBase != null) { ButtonBaseClickCommandBehavior behavior = GetOrCreateBehavior(buttonBase); behavior.CommandParameter = e.NewValue; } } private static ButtonBaseClickCommandBehavior GetOrCreateBehavior(ButtonBase buttonBase ) { ButtonBaseClickCommandBehavior behavior = buttonBase.GetValue(ClickCommandBehaviorProperty) as ButtonBaseClickCommandBehavior; if ( behavior == null ) { behavior = new ButtonBaseClickCommandBehavior(buttonBase); buttonBase.SetValue(ClickCommandBehaviorProperty, behavior); } return behavior; }</code> <br>        ,  <a href="http://msdn.microsoft.com/en-us/library/cc265152(VS.95).aspx">Attached Properties Overview</a>  MSDN. <br> <br>    <br>              . ,     Silverlight,    -,     ,      ,     .     ,       . <br> <br>        ,    ( )  ,  ,     .  UI       ,            UI. <br> <br>      - <br>   -     ,       <code>IAsyncResult</code> .   ,  ,   ,  <code>GetQuestionnaire</code> ,   : <code>BeginGetQuestionnaire</code>  <code>EndGetQuestionnaire</code> .    ,   <code>BeginGetQuestionnaire</code> .     ,   ,   <code>EndGetQuestionnaire</code>    . <br> <b></b> <br>  .NET Framework 4.5      <code>await</code>  <code>async</code>     <code>*Async</code> .      <a href="http://msdn.microsoft.com/en-us/library/vstudio/hh391443.aspx">"Asynchronous Programming with Async and Await (C# and Visual Basic)"</a> . <br>  ,    <code>EndGetQuestionnaire</code> ,      ,  ()      <code>BeginGetQuestionnaire</code> .     ,      ,   <code>EndGetQuestionnaire</code> ,   . <br> <br> <code class="xml">IAsyncResult asyncResult = this.service.BeginGetQuestionnaire( GetQuestionnaireCompleted, null //  ,      ); private void GetQuestionnaireCompleted(IAsyncResult result) { try { questionnaire = this.service.EndGetQuestionnaire(ar); } catch (Exception ex) { //  -   . } }</code> <br>  ,     <code>End*</code> (  , <code>EndGetQuestionnaire</code> ),    ,      .      , ,          UI.     ,   ,        . <br> <br>        UI,     -,      UI,         UI,   <code>Dispatcher</code>    <code>SynchronizationContext</code> .  WPF  Silverlight,   <code>Dispatcher</code> . <br> <br>      <code>Questionnaire</code>  ,        <code>QuestionnaireView</code> .  Silverlight    <code>CheckAccess</code> ,  ,      UI.  ,     <code>BeginInvoke</code> ,      UI. <br> <br> <code class="cs">var dispatcher = System.Windows.Deployment.Current.Dispatcher; if (dispatcher.CheckAccess()) { QuestionnaireView.DataContext = questionnaire; } else { dispatcher.BeginInvoke(() =&gt; { Questionnaire.DataContext = questionnaire; }); }</code> <br> <i>MVVM RI</i>   ,    ,   <code>IAsyncResult</code> ,   .      ,                 . ,       . <br> <br> <code class="cs">this.questionnaireRepository.GetQuestionnaireAsync( result =&gt; { this.Questionnaire = result.Result; });</code> <br>  <code>result</code>   ,     , , , .    ,     . <br> <br> <code class="cs">this.questionnaireRepository.GetQuestionnaireAsync( result =&gt; { if (result.Error == null) { this.Questionnaire = result.Result; ... } else { // Handle error. } })</code> <br>     <br>        ,      .     , ,             .        ,      ,     ,     . <br> <br>         ,      MVVM,     ,   . ,  -MVVM ,     <code>MessageBox</code>   code-behind UI,      .   MVVM     ,          . <br> <br>     MVVM,              ,          .      ,    ,   ,  ,     . <br> <br>              MVVM.      ,     ,     ,  ,     .    ,         ,     ,          .       . <br> <br>    <br>                  .        ,        .  ,         .         . <br> <br>  ,         ,         ,  .      ,     .           ,       . ,        WPF  Silverlight,        . <br> <br> <img title="Using the service to interact with the user." src="https://habrastorage.org/getpro/habr/post_images/4b5/397/f2d/4b5397f2d02e5851195b29f1893be6fc.png" alt=" ,    ."> <br> <br>  ,   <code>MessageBox</code>        ,     ,    ,     . <br> <br> <code class="cs">var result = interactionService.ShowMessageBox( "Are you sure you want to cancel this operation?", "Confirm", MessageBoxButton.OK); if (result == MessageBoxResult.Yes) { CancelRequest(); }</code> <br> ,      - ,      ,         Silverlight.         .             .     . <br> <br> <code class="cs">interactionService.ShowMessageBox( "Are you sure you want to cancel this operation?", "Confirm", MessageBoxButton.OK, result =&gt; { if (result == MessageBoxResult.Yes) { CancelRequest(); } });</code> <br>         ,      . ,  WPF    <code>MessageBox</code> ,       ;    Silverlight    ,    . <br> <br>     <br>         ‚Äì             .         ,      .     ,     .        ,        ,   ,     . <br> <br> <img title="Using interaction request objects." src="https://habrastorage.org/getpro/habr/post_images/3d0/ff0/1c5/3d0ff01c5518558c2d3c5c5f47ce0ce9.png" alt="   ."> <br> <br>    ,   ,          ‚Äì       ,      ,   ‚Äì     .   ,        ,    ,    UI            . <br> <br>       MVVM,     ,       ,         .         ,        ,    ,   . <br> <br>  Prism       <code>IInteractionRequest</code>   <code>InteractionRequest .  IInteractionRequest</code>  ,   .           ,   .  <code>InteractionRequest   IInteractionRequest</code>     <code>Raise</code> ,           , , ,   . <br> <br>       <br>  <code>InteractionRequest          .  Raise</code>          ( <code>T</code> )    ,    ,   .          ,       .      ,        .    ,  ,     . <br> <code class="cs">public interface IInteractionRequest { event EventHandler&lt;InteractionRequestedEventArgs&gt; Raised; } public class InteractionRequest&lt;T&gt; : IInteractionRequest { public event EventHandler&lt;InteractionRequestedEventArgs&gt; Raised; public void Raise(T context, Action&lt;T&gt; callback) { var handler = this.Raised; if (handler != null) { handler( this, new InteractionRequestedEventArgs(context, () =&gt; callback(context))); } } }</code> <br> Prism    ,      .  <code>Notification</code>       .    ,            .     ‚Äì <code>Title</code>  <code>Content</code> ,    .  ,   ,  ,  ,        . <br> <br>  <code>Confirmation</code>    <code>Notification</code>     ‚Äì <code>Confirmed</code> ,  ,  ,      .  <code>Confirmation</code> ,     <code>MessageBox</code> ,     /  .     ,     <code>Notification</code> ,     ,      . <br> <br>    <code>InteractionRequest ,       InteractionRequest      ,      .      ,    Raise</code> ,    , ,   . <br> <br> <code class="cs">public IInteractionRequest ConfirmCancelInteractionRequest { get { return this.confirmCancelInteractionRequest; } } this.confirmCancelInteractionRequest.Raise( new Confirmation("Are you sure you wish to cancel?"), confirmation =&gt; { if (confirmation.Confirmed) { this.NavigateToQuestionnaireList(); } }); }</code> <br> <i>MVVM Reference Implementation (MVVM RI)</i> ,    <code>IInteractionRequest</code>   <code>InteractionRequest ,          (. QuestionnaireViewModel.cs</code> ). <br> <br>        <br>       ,       .   ,       .    UI             . <br> <br>                . Microsoft Expression Blend Behaviors Framework     .  ,     ,    . <br> <br>  <code>EventTrigger</code> ,  Expression Blend,  ,      ,     ,   . , Prism   <code>EventTrigger</code> ,  <code>InteractionRequestTrigger</code> ,      <code>Raised</code>   <code>IInteractionRequest</code> .    XAML        . <br> <br>  ,   , <code>InteractionRequestTrigger</code>   .  Silverlight Prism   <code>PopupChildWindowAction</code> ,     .    ,         .   <code>ContentTemplate</code>  <code>PopupChildWindowAction</code> ,    ,    UI,      <code>Content</code>  .       <code>Title</code>  . <br> <b></b> <br>  ,    ,   <code>PopupChildWindowAction</code> ,     .    <code>Notification</code>  <code>NotificationChildWindow</code> ,        <code>Confirmation</code> ‚Äì <code>ConfirmationChildWindow</code> . <code>NotificationChildWindow</code>    ,   ,     <code>ConfirmationChildWindow</code>    <i>OK</i>  <i>Cancel</i> ,    .    ,   ,   <code>ChildWindow</code>  <code>PopupChildWindowAction</code> . <br>   ,  <code>InteractionRequestTrigger</code>  <code>PopupChildWindowAction</code> ,       <i>RI MVVM</i> . <br> <br> <code class="xml">&lt;i:Interaction.Triggers&gt; &lt;prism:InteractionRequestTrigger SourceObject="{Binding ConfirmCancelInteractionRequest}"&gt; &lt;prism:PopupChildWindowAction ContentTemplate="{StaticResource ConfirmWindowTemplate}"/&gt; &lt;/prism:InteractionRequestTrigger&gt; &lt;/i:Interaction.Triggers&gt; &lt;UserControl.Resources&gt; &lt;DataTemplate x:Key="ConfirmWindowTemplate"&gt; &lt;Grid MinWidth="250" MinHeight="100"&gt; &lt;TextBlock TextWrapping="Wrap" Grid.Row="0" Text="{Binding}"/&gt; &lt;/Grid&gt; &lt;/DataTemplate&gt; &lt;/UserControl.Resources&gt;</code> <br> <b></b> <br>      <code>ContentTemplate</code> ,   UI   <code>Content</code>  .    <code>Content</code>  ,  , <code>TextBlock</code>     <code>Content</code> . <br>      ,     ,    ,    .  ,     ,       ,     ,    .   ,   <i>RI MVVM</i> ,         <code>Confirmed</code>    <code>Confirmation</code>  <code>true</code> ,     OK. <br> <br>        ,     .  Prism <code>InteractionRequestTrigger</code>   <code>PopupChildWindowAction</code>            . <br> <br>     <br>     MVVM,       , ,    ,         .        (  , ,  ,   ).    ,  ,  ,            . <br> <br>        ,         . Managed Extensibility Framework (MEF)  Unity Application Block (Unity)      ,  ,           . <br> <br>  ,       , , ,    ( )      . ,       ,     .  ,     ,       . <br> <br>     ,  MEF <br>  MEF,       ,   <code>Import</code> ,      ,  ,   <code>Export</code> .         ,    . <br> <br> , <code>QuestionnaireView</code>   <i>RI MVVM</i> ,        ,    <code>Import</code> .   , MEF           .  <code>set</code>        ,   . <br> <br> <code class="cs">[Import] public QuestionnaireViewModel ViewModel { set { this.DataContext = value; } }</code> <br>     ,   . <br> <br> <code class="cs">[Export] public class QuestionnaireViewModel : NotificationObject { ... }</code> <br>        ,   . <br> <br> <code class="cs">public QuestionnaireView() { InitializeComponent(); } [ImportingConstructor] public QuestionnaireView(QuestionnaireViewModel viewModel) : this() { this.DataContext = viewModel; }</code> <br> <b></b> <br>          MEF,   Unity.   ,     ,        .   ,   Visual Studio  Expression Blend, ,        ,     .   ,   ,  ,      ,          <code>InitializeComponent</code> . <br>     ,  Unity <br>  Unity,    ,   MEF.     ,      .    ,         .  ,      . <br> <br>  ,      ,  ,         . ,           ,   . <br> <br> <code class="cs">public QuestionnaireView() { InitializeComponent(); } public QuestionnaireView(QuestionnaireViewModel viewModel) : this() { this.DataContext = viewModel; }</code> <br> <b></b> <br>    ,        ,   Visual Studio  Expression Blend. <br>  ,          ,   . Unity        <code>set</code>   ,   . <br> <br> <code class="cs">public QuestionnaireView() { InitializeComponent(); } [Dependency] public QuestionnaireViewModel ViewModel { set { this.DataContext = value; } }</code> <br>       Unity. <br> <br> <code class="cs">container.RegisterType&lt;QuestionnaireViewModel&gt;();</code> <br>  ,     . <br> <br> <code class="cs">var view = container.Resolve&lt;QuestionnaireView&gt;();</code> <br>     ,    <br>   ,     ,        .        ,   MEF  Unity,        . <br> <br>          .   ,         UI,           . <br> <br> , <i>RI MVVM</i>   ,   ,        .   ,    .      <code>ShowView</code>   UI. <br> <br> <code class="cs">private void NavigateToQuestionnaireList() { //     "questionnaire list". this.uiService.ShowView(ViewNames.QuestionnaireTemplatesList); }</code> <br>  UI      UI .           UI.  <code>ShowView</code>  <code>UIService</code>      (,          ),       ,   . <br> <br> <code class="cs">public void ShowView(string viewName) { var view = this.ViewFactory.GetView(viewName); this.MainWindow.CurrentView = view; }</code> <br> <b></b> <br> Prism       .   ,   ,   ,             .    ,  , " <a href="http://msdn.microsoft.com/en-us/library/gg430861(v%3DPandP.40).aspx">View-Based Navigation</a> "   8, " <a href="http://msdn.microsoft.com/en-us/library/gg430861(v%3DPandP.40).aspx">Navigation</a> ". <br>  MVVM  <br>        MVVM      .           -      mocking . ,   ,        . <br> <br>   <i>INotifyPropertyChanged</i> <br>   <code>INotifyPropertyChanged</code>     ,      .      ,    ;   ,   ,     ,    ,       . <br> <br>   <br> ,       ,           <code>PropertyChanged</code>  ,         .  ,    <code>ChangeTracker</code> ,     MVVM,  ,      .      .     ,    . <br> <br> <code class="cs">var changeTracker = new PropertyChangeTracker(viewModel); viewModel.CurrentState = "newState"; CollectionAssert.Contains(changeTracker.ChangedProperties, "CurrentState");</code> <br> ,     ,     <code>INotifyPropertyChanged</code> ,    ,   ,     . <br> <br>      <br>        ,   ,    <code>set</code>      ,           . ,     ,     ,      ,          . <br> <br> <code class="cs">var changeTracker = new PropertyChangeTracker(viewModel); var question = viewModel.Questions.First() as OpenQuestionViewModel; question.Question.Response = "some text"; CollectionAssert.Contains(changeTracker.ChangedProperties, "UnansweredQuestions");</code> <br>      <br>     <code>INotifyPropertyChanged</code> ,      <code>PropertyChanged</code>        ,  ,     , , .        ,       . <br> <br>   <i>INotifyDataErrorInfo</i> <br>   ,     ,    ,   ,   <code>IDataErrorInfo</code> ,  ( Silverlight)   <code>INotifyDataErrorInfo</code> .   <code>INotifyDataErrorInfo</code>   ,         ,    ,  ,   ,    . <br> <br>       <code>INotifyDataErrorInfo</code> : ,     ,  ,     ,     <code>ErrorsChanged</code> ,      <code>GetErrors</code> , . <br> <br>    <br>     ,      ,     .       ,         <code>GetErrors</code>       ,  ,  ,   .    , ,  ,     ,        .   ,        . <br> <br> <code class="cs">//  . var notifyErrorInfo = (INotifyDataErrorInfo)question; question.Response = -15; Assert.IsTrue(notifyErrorInfo.GetErrors("Response").Cast&lt;ValidationResult&gt;().Any()); //  . var notifyErrorInfo = (INotifyDataErrorInfo)question; question.Response = 15; Assert.IsFalse(notifyErrorInfo.GetErrors("Response").Cast&lt;ValidationResult&gt;().Any());</code> <br>    ,    ,             . <br> <br>    <i>INotifyDataErrorInfo</i> <br>       <code>GetErrors</code> ,   <code>INotifyDataErrorInfo</code>  ,   <code>ErrorsChanged</code>      <code>GetErrors</code> . ,  <code>HasErrors</code>      ,  . <br> <br>       <code>INotifyDataErrorInfo</code> . , ,           ,   -  .      ,        <code>INotifyDataErrorInfo</code>         (,        ). <br> <br>     ,   ,  : <br>  <code>HasErrors</code>     .              ,       .  <code>ErrorsChanged</code> ,      ,         <code>GetErrors</code> .         ( ,  )     ,           .    <code>GetErrors</code>       <code>ErrorsChanged</code> . <br>    <code>INotifyPropertyChanged</code> ,  ,    <code>NotifyDataErrorInfoTestHelper</code>    MVVM,        <code>INotifyDataErrorInfo</code> ,       .   ,   ,      ,   .      . <br> <code class="cs">var helper = new NotifyDataErrorInfoTestHelper&lt;NumericQuestion, int?&gt;( question, q =&gt; q.Response); helper.ValidatePropertyChange( 6, NotifyDataErrorInfoBehavior.Nothing); helper.ValidatePropertyChange( 20, NotifyDataErrorInfoBehavior.FiresErrorsChanged | NotifyDataErrorInfoBehavior.HasErrors | NotifyDataErrorInfoBehavior.HasErrorsForProperty); helper.ValidatePropertyChange( null, NotifyDataErrorInfoBehavior.FiresErrorsChanged | NotifyDataErrorInfoBehavior.HasErrors | NotifyDataErrorInfoBehavior.HasErrorsForProperty); helper.ValidatePropertyChange( 2, NotifyDataErrorInfoBehavior.FiresErrorsChanged);</code> <br>     <br>   MVVM,     ,  .   ,    ,         . <br> <br>  ,     ,     ,       .   ,   , ,       ,     ,   <code>IAsyncResult</code>    ,  - ,   ,    UI. <br> <br>       , , ,    .   ,     .  ,      UI,     ,   ,          ,     ,        "   UI." <br> <br>     ,    ,    .   ,    ,     mock-, ,   ,   ,      ,          . <br> <br>           UI,    ,    .   ,     ,   ,      .        ,   .     ,    ,     . <br> <br> <code class="cs">questionnaireRepositoryMock .Setup( r =&gt; r.SubmitQuestionnaireAsync( It.IsAny&lt;Questionnaire&gt;(), It.IsAny&lt;Action&lt;IOperationResult&gt;&gt;())) .Callback&lt;Questionnaire, Action&lt;IOperationResult&gt;&gt;( (q, a) =&gt; callback = a); uiServicemock .Setup(svc =&gt; svc.ShowView(ViewNames.QuestionnaireTemplatesList)) .Callback&lt;string&gt;(viewName =&gt; requestedViewName = viewName); submitResultMock .Setup(sr =&gt; sr.Error) .Returns&lt;Exception&gt;(null); CompleteQuestionnaire(viewModel); viewModel.Submit(); //      UI . callback(submitResultMock.Object); //    ‚Äì     . Assert.AreEqual(ViewNames.QuestionnaireTemplatesList, requestedViewName);</code> <br> <b></b> <br>          ,        . <br>   <br>       , . "Trees in WPF"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ms753391.aspx">http://msdn.microsoft.com/en-us/library/ms753391.aspx</a> <br> <br>       , . "Attached Properties Overview"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/cc265152(VS.95).aspx">http://msdn.microsoft.com/en-us/library/cc265152(VS.95).aspx</a> <br> <br>      MEF, ."Managed Extensibility Framework Overview"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/dd460648.aspx">http://msdn.microsoft.com/en-us/library/dd460648.aspx</a> . <br> <br>      Unity, ."Unity Application Block"  MSDN: <a href="http://www.msdn.com/unity">http://www.msdn.com/unity</a> . <br> <br>      <code>DelegateCommand</code> , .Chapter 5, " <a href="http://msdn.microsoft.com/en-us/library/gg405484(v%3DPandP.40).aspx">Implementing the MVVM Pattern</a> ." <br> <br>        Microsoft Expression Blend, ."Working with built-in behaviors"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ff724013(v%3DExpression.40).aspx">http://msdn.microsoft.com/en-us/library/ff724013(v=Expression.40).aspx</a> . <br> <br>          Microsoft Expression Blend, ."Creating Custom Behaviors"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ff724708(v%3DExpression.40).aspx">http://msdn.microsoft.com/en-us/library/ff724708(v=Expression.40).aspx</a> . <br> <br>            Microsoft Expression Blend, ."Creating Custom Triggers and Actions"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ff724707(v%3DExpression.40).aspx">http://msdn.microsoft.com/en-us/library/ff724707(v=Expression.40).aspx</a> . <br> <br>         WPF  Silverlight, ."Threading Model"  "The Dispatcher Class"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ms741870.aspx">http://msdn.microsoft.com/en-us/library/ms741870.aspx</a> <br> <a href="http://msdn.microsoft.com/en-us/library/ms615907(v%3DVS.95).aspx">http://msdn.microsoft.com/en-us/library/ms615907(v=VS.95).aspx</a> . <br> <br>      unit-  Silverlight, ."Unit Testing with Silverlight 2": <a href="http://www.jeff.wilcox.name/2008/03/silverlight2-unit-testing/">http://www.jeff.wilcox.name/2008/03/silverlight2-unit-testing/</a> . <br> <br>         , .  " <a href="http://msdn.microsoft.com/en-us/library/gg430861(v%3DPandP.40).aspx">View-Based Navigation</a> " in Chapter 8, " <a href="http://msdn.microsoft.com/en-us/library/gg430861(v%3DPandP.40).aspx">Navigation</a> ." <br> <br>       ,   , ."Event-based Asynchronous Pattern Overview"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/wewwczdw.aspx">http://msdn.microsoft.com/en-us/library/wewwczdw.aspx</a> <br> <br>        <code>IAsyncResult</code> , ."Asynchronous Programming Overview"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ms228963.aspx">http://msdn.microsoft.com/en-us/library/ms228963.aspx</a></code></code></code></code></code></code></code></code></code> <blockquote> <code><code><code><code><code><code><code><code><code><code>CommandBehaviorBase ,    ,    ICommand</code> .           <code>CanExecuteChanged</code> ,          Silverlight,    WPF. <br> <br>    ,  ,   <code>CommandBehaviorBase    ,    .         ,      .         ,    .      ButtonBaseClickCommandBehavior</code> . <br> <br> <code class="cs">public class ButtonBaseClickCommandBehavior : CommandBehaviorBase&lt;ButtonBase&gt; { public ButtonBaseClickCommandBehavior(ButtonBase clickableObject) : base(clickableObject) { clickableObject.Click += OnClick; } private void OnClick(object sender, System.Windows.RoutedEventArgs e) { ExecuteCommand(); } }</code> <br>   <code>CommandBehaviorBase ,     .     ,          ,   . ,    ,    ,      , ,    CanExecute</code>  ,     . <br> <br>          ,   .           XAML.           .       .  Prism      ,       ,  ,   .       ,    . , ,  ,      <code>Click</code> ,       <code>Command</code> .    <code>Click.Command</code> ,  . <br> <br>             .             . <br> <br> <code class="cs">public static readonly DependencyProperty CommandProperty = DependencyProperty.RegisterAttached( "Command", typeof(ICommand), typeof(Click), new PropertyMetadata(OnSetCommandCallback)); private static readonly DependencyProperty ClickCommandBehaviorProperty = DependencyProperty.RegisterAttached( "ClickCommandBehavior", typeof(ButtonBaseClickCommandBehavior), typeof(Click), null);</code> <br>    <code>Command</code>    <code>ButtonBaseClickCommandBehavior</code> ,     <code>OnSetCommandCallback</code> ,     . <br> <br> <code class="cs">private static void OnSetCommandCallback(DependencyObject dependencyObject, DependencyPropertyChangedEventArgs e) { ButtonBase buttonBase = dependencyObject as ButtonBase; if (buttonBase != null) { ButtonBaseClickCommandBehavior behavior = GetOrCreateBehavior(buttonBase); behavior.Command = e.NewValue as ICommand; } } private static void OnSetCommandParameterCallback(DependencyObject dependencyObject, DependencyPropertyChangedEventArgs e) { ButtonBase buttonBase = dependencyObject as ButtonBase; if (buttonBase != null) { ButtonBaseClickCommandBehavior behavior = GetOrCreateBehavior(buttonBase); behavior.CommandParameter = e.NewValue; } } private static ButtonBaseClickCommandBehavior GetOrCreateBehavior(ButtonBase buttonBase ) { ButtonBaseClickCommandBehavior behavior = buttonBase.GetValue(ClickCommandBehaviorProperty) as ButtonBaseClickCommandBehavior; if ( behavior == null ) { behavior = new ButtonBaseClickCommandBehavior(buttonBase); buttonBase.SetValue(ClickCommandBehaviorProperty, behavior); } return behavior; }</code> <br>        ,  <a href="http://msdn.microsoft.com/en-us/library/cc265152(VS.95).aspx">Attached Properties Overview</a>  MSDN. <br> <br>    <br>              . ,     Silverlight,    -,     ,      ,     .     ,       . <br> <br>        ,    ( )  ,  ,     .  UI       ,            UI. <br> <br>      - <br>   -     ,       <code>IAsyncResult</code> .   ,  ,   ,  <code>GetQuestionnaire</code> ,   : <code>BeginGetQuestionnaire</code>  <code>EndGetQuestionnaire</code> .    ,   <code>BeginGetQuestionnaire</code> .     ,   ,   <code>EndGetQuestionnaire</code>    . <br> <b></b> <br>  .NET Framework 4.5      <code>await</code>  <code>async</code>     <code>*Async</code> .      <a href="http://msdn.microsoft.com/en-us/library/vstudio/hh391443.aspx">"Asynchronous Programming with Async and Await (C# and Visual Basic)"</a> . <br>  ,    <code>EndGetQuestionnaire</code> ,      ,  ()      <code>BeginGetQuestionnaire</code> .     ,      ,   <code>EndGetQuestionnaire</code> ,   . <br> <br> <code class="xml">IAsyncResult asyncResult = this.service.BeginGetQuestionnaire( GetQuestionnaireCompleted, null //  ,      ); private void GetQuestionnaireCompleted(IAsyncResult result) { try { questionnaire = this.service.EndGetQuestionnaire(ar); } catch (Exception ex) { //  -   . } }</code> <br>  ,     <code>End*</code> (  , <code>EndGetQuestionnaire</code> ),    ,      .      , ,          UI.     ,   ,        . <br> <br>        UI,     -,      UI,         UI,   <code>Dispatcher</code>    <code>SynchronizationContext</code> .  WPF  Silverlight,   <code>Dispatcher</code> . <br> <br>      <code>Questionnaire</code>  ,        <code>QuestionnaireView</code> .  Silverlight    <code>CheckAccess</code> ,  ,      UI.  ,     <code>BeginInvoke</code> ,      UI. <br> <br> <code class="cs">var dispatcher = System.Windows.Deployment.Current.Dispatcher; if (dispatcher.CheckAccess()) { QuestionnaireView.DataContext = questionnaire; } else { dispatcher.BeginInvoke(() =&gt; { Questionnaire.DataContext = questionnaire; }); }</code> <br> <i>MVVM RI</i>   ,    ,   <code>IAsyncResult</code> ,   .      ,                 . ,       . <br> <br> <code class="cs">this.questionnaireRepository.GetQuestionnaireAsync( result =&gt; { this.Questionnaire = result.Result; });</code> <br>  <code>result</code>   ,     , , , .    ,     . <br> <br> <code class="cs">this.questionnaireRepository.GetQuestionnaireAsync( result =&gt; { if (result.Error == null) { this.Questionnaire = result.Result; ... } else { // Handle error. } })</code> <br>     <br>        ,      .     , ,             .        ,      ,     ,     . <br> <br>         ,      MVVM,     ,   . ,  -MVVM ,     <code>MessageBox</code>   code-behind UI,      .   MVVM     ,          . <br> <br>     MVVM,              ,          .      ,    ,   ,  ,     . <br> <br>              MVVM.      ,     ,     ,  ,     .    ,         ,     ,          .       . <br> <br>    <br>                  .        ,        .  ,         .         . <br> <br>  ,         ,         ,  .      ,     .           ,       . ,        WPF  Silverlight,        . <br> <br> <img title="Using the service to interact with the user." src="https://habrastorage.org/getpro/habr/post_images/4b5/397/f2d/4b5397f2d02e5851195b29f1893be6fc.png" alt=" ,    ."> <br> <br>  ,   <code>MessageBox</code>        ,     ,    ,     . <br> <br> <code class="cs">var result = interactionService.ShowMessageBox( "Are you sure you want to cancel this operation?", "Confirm", MessageBoxButton.OK); if (result == MessageBoxResult.Yes) { CancelRequest(); }</code> <br> ,      - ,      ,         Silverlight.         .             .     . <br> <br> <code class="cs">interactionService.ShowMessageBox( "Are you sure you want to cancel this operation?", "Confirm", MessageBoxButton.OK, result =&gt; { if (result == MessageBoxResult.Yes) { CancelRequest(); } });</code> <br>         ,      . ,  WPF    <code>MessageBox</code> ,       ;    Silverlight    ,    . <br> <br>     <br>         ‚Äì             .         ,      .     ,     .        ,        ,   ,     . <br> <br> <img title="Using interaction request objects." src="https://habrastorage.org/getpro/habr/post_images/3d0/ff0/1c5/3d0ff01c5518558c2d3c5c5f47ce0ce9.png" alt="   ."> <br> <br>    ,   ,          ‚Äì       ,      ,   ‚Äì     .   ,        ,    ,    UI            . <br> <br>       MVVM,     ,       ,         .         ,        ,    ,   . <br> <br>  Prism       <code>IInteractionRequest</code>   <code>InteractionRequest .  IInteractionRequest</code>  ,   .           ,   .  <code>InteractionRequest   IInteractionRequest</code>     <code>Raise</code> ,           , , ,   . <br> <br>       <br>  <code>InteractionRequest          .  Raise</code>          ( <code>T</code> )    ,    ,   .          ,       .      ,        .    ,  ,     . <br> <code class="cs">public interface IInteractionRequest { event EventHandler&lt;InteractionRequestedEventArgs&gt; Raised; } public class InteractionRequest&lt;T&gt; : IInteractionRequest { public event EventHandler&lt;InteractionRequestedEventArgs&gt; Raised; public void Raise(T context, Action&lt;T&gt; callback) { var handler = this.Raised; if (handler != null) { handler( this, new InteractionRequestedEventArgs(context, () =&gt; callback(context))); } } }</code> <br> Prism    ,      .  <code>Notification</code>       .    ,            .     ‚Äì <code>Title</code>  <code>Content</code> ,    .  ,   ,  ,  ,        . <br> <br>  <code>Confirmation</code>    <code>Notification</code>     ‚Äì <code>Confirmed</code> ,  ,  ,      .  <code>Confirmation</code> ,     <code>MessageBox</code> ,     /  .     ,     <code>Notification</code> ,     ,      . <br> <br>    <code>InteractionRequest ,       InteractionRequest      ,      .      ,    Raise</code> ,    , ,   . <br> <br> <code class="cs">public IInteractionRequest ConfirmCancelInteractionRequest { get { return this.confirmCancelInteractionRequest; } } this.confirmCancelInteractionRequest.Raise( new Confirmation("Are you sure you wish to cancel?"), confirmation =&gt; { if (confirmation.Confirmed) { this.NavigateToQuestionnaireList(); } }); }</code> <br> <i>MVVM Reference Implementation (MVVM RI)</i> ,    <code>IInteractionRequest</code>   <code>InteractionRequest ,          (. QuestionnaireViewModel.cs</code> ). <br> <br>        <br>       ,       .   ,       .    UI             . <br> <br>                . Microsoft Expression Blend Behaviors Framework     .  ,     ,    . <br> <br>  <code>EventTrigger</code> ,  Expression Blend,  ,      ,     ,   . , Prism   <code>EventTrigger</code> ,  <code>InteractionRequestTrigger</code> ,      <code>Raised</code>   <code>IInteractionRequest</code> .    XAML        . <br> <br>  ,   , <code>InteractionRequestTrigger</code>   .  Silverlight Prism   <code>PopupChildWindowAction</code> ,     .    ,         .   <code>ContentTemplate</code>  <code>PopupChildWindowAction</code> ,    ,    UI,      <code>Content</code>  .       <code>Title</code>  . <br> <b></b> <br>  ,    ,   <code>PopupChildWindowAction</code> ,     .    <code>Notification</code>  <code>NotificationChildWindow</code> ,        <code>Confirmation</code> ‚Äì <code>ConfirmationChildWindow</code> . <code>NotificationChildWindow</code>    ,   ,     <code>ConfirmationChildWindow</code>    <i>OK</i>  <i>Cancel</i> ,    .    ,   ,   <code>ChildWindow</code>  <code>PopupChildWindowAction</code> . <br>   ,  <code>InteractionRequestTrigger</code>  <code>PopupChildWindowAction</code> ,       <i>RI MVVM</i> . <br> <br> <code class="xml">&lt;i:Interaction.Triggers&gt; &lt;prism:InteractionRequestTrigger SourceObject="{Binding ConfirmCancelInteractionRequest}"&gt; &lt;prism:PopupChildWindowAction ContentTemplate="{StaticResource ConfirmWindowTemplate}"/&gt; &lt;/prism:InteractionRequestTrigger&gt; &lt;/i:Interaction.Triggers&gt; &lt;UserControl.Resources&gt; &lt;DataTemplate x:Key="ConfirmWindowTemplate"&gt; &lt;Grid MinWidth="250" MinHeight="100"&gt; &lt;TextBlock TextWrapping="Wrap" Grid.Row="0" Text="{Binding}"/&gt; &lt;/Grid&gt; &lt;/DataTemplate&gt; &lt;/UserControl.Resources&gt;</code> <br> <b></b> <br>      <code>ContentTemplate</code> ,   UI   <code>Content</code>  .    <code>Content</code>  ,  , <code>TextBlock</code>     <code>Content</code> . <br>      ,     ,    ,    .  ,     ,       ,     ,    .   ,   <i>RI MVVM</i> ,         <code>Confirmed</code>    <code>Confirmation</code>  <code>true</code> ,     OK. <br> <br>        ,     .  Prism <code>InteractionRequestTrigger</code>   <code>PopupChildWindowAction</code>            . <br> <br>     <br>     MVVM,       , ,    ,         .        (  , ,  ,   ).    ,  ,  ,            . <br> <br>        ,         . Managed Extensibility Framework (MEF)  Unity Application Block (Unity)      ,  ,           . <br> <br>  ,       , , ,    ( )      . ,       ,     .  ,     ,       . <br> <br>     ,  MEF <br>  MEF,       ,   <code>Import</code> ,      ,  ,   <code>Export</code> .         ,    . <br> <br> , <code>QuestionnaireView</code>   <i>RI MVVM</i> ,        ,    <code>Import</code> .   , MEF           .  <code>set</code>        ,   . <br> <br> <code class="cs">[Import] public QuestionnaireViewModel ViewModel { set { this.DataContext = value; } }</code> <br>     ,   . <br> <br> <code class="cs">[Export] public class QuestionnaireViewModel : NotificationObject { ... }</code> <br>        ,   . <br> <br> <code class="cs">public QuestionnaireView() { InitializeComponent(); } [ImportingConstructor] public QuestionnaireView(QuestionnaireViewModel viewModel) : this() { this.DataContext = viewModel; }</code> <br> <b></b> <br>          MEF,   Unity.   ,     ,        .   ,   Visual Studio  Expression Blend, ,        ,     .   ,   ,  ,      ,          <code>InitializeComponent</code> . <br>     ,  Unity <br>  Unity,    ,   MEF.     ,      .    ,         .  ,      . <br> <br>  ,      ,  ,         . ,           ,   . <br> <br> <code class="cs">public QuestionnaireView() { InitializeComponent(); } public QuestionnaireView(QuestionnaireViewModel viewModel) : this() { this.DataContext = viewModel; }</code> <br> <b></b> <br>    ,        ,   Visual Studio  Expression Blend. <br>  ,          ,   . Unity        <code>set</code>   ,   . <br> <br> <code class="cs">public QuestionnaireView() { InitializeComponent(); } [Dependency] public QuestionnaireViewModel ViewModel { set { this.DataContext = value; } }</code> <br>       Unity. <br> <br> <code class="cs">container.RegisterType&lt;QuestionnaireViewModel&gt;();</code> <br>  ,     . <br> <br> <code class="cs">var view = container.Resolve&lt;QuestionnaireView&gt;();</code> <br>     ,    <br>   ,     ,        .        ,   MEF  Unity,        . <br> <br>          .   ,         UI,           . <br> <br> , <i>RI MVVM</i>   ,   ,        .   ,    .      <code>ShowView</code>   UI. <br> <br> <code class="cs">private void NavigateToQuestionnaireList() { //     "questionnaire list". this.uiService.ShowView(ViewNames.QuestionnaireTemplatesList); }</code> <br>  UI      UI .           UI.  <code>ShowView</code>  <code>UIService</code>      (,          ),       ,   . <br> <br> <code class="cs">public void ShowView(string viewName) { var view = this.ViewFactory.GetView(viewName); this.MainWindow.CurrentView = view; }</code> <br> <b></b> <br> Prism       .   ,   ,   ,             .    ,  , " <a href="http://msdn.microsoft.com/en-us/library/gg430861(v%3DPandP.40).aspx">View-Based Navigation</a> "   8, " <a href="http://msdn.microsoft.com/en-us/library/gg430861(v%3DPandP.40).aspx">Navigation</a> ". <br>  MVVM  <br>        MVVM      .           -      mocking . ,   ,        . <br> <br>   <i>INotifyPropertyChanged</i> <br>   <code>INotifyPropertyChanged</code>     ,      .      ,    ;   ,   ,     ,    ,       . <br> <br>   <br> ,       ,           <code>PropertyChanged</code>  ,         .  ,    <code>ChangeTracker</code> ,     MVVM,  ,      .      .     ,    . <br> <br> <code class="cs">var changeTracker = new PropertyChangeTracker(viewModel); viewModel.CurrentState = "newState"; CollectionAssert.Contains(changeTracker.ChangedProperties, "CurrentState");</code> <br> ,     ,     <code>INotifyPropertyChanged</code> ,    ,   ,     . <br> <br>      <br>        ,   ,    <code>set</code>      ,           . ,     ,     ,      ,          . <br> <br> <code class="cs">var changeTracker = new PropertyChangeTracker(viewModel); var question = viewModel.Questions.First() as OpenQuestionViewModel; question.Question.Response = "some text"; CollectionAssert.Contains(changeTracker.ChangedProperties, "UnansweredQuestions");</code> <br>      <br>     <code>INotifyPropertyChanged</code> ,      <code>PropertyChanged</code>        ,  ,     , , .        ,       . <br> <br>   <i>INotifyDataErrorInfo</i> <br>   ,     ,    ,   ,   <code>IDataErrorInfo</code> ,  ( Silverlight)   <code>INotifyDataErrorInfo</code> .   <code>INotifyDataErrorInfo</code>   ,         ,    ,  ,   ,    . <br> <br>       <code>INotifyDataErrorInfo</code> : ,     ,  ,     ,     <code>ErrorsChanged</code> ,      <code>GetErrors</code> , . <br> <br>    <br>     ,      ,     .       ,         <code>GetErrors</code>       ,  ,  ,   .    , ,  ,     ,        .   ,        . <br> <br> <code class="cs">//  . var notifyErrorInfo = (INotifyDataErrorInfo)question; question.Response = -15; Assert.IsTrue(notifyErrorInfo.GetErrors("Response").Cast&lt;ValidationResult&gt;().Any()); //  . var notifyErrorInfo = (INotifyDataErrorInfo)question; question.Response = 15; Assert.IsFalse(notifyErrorInfo.GetErrors("Response").Cast&lt;ValidationResult&gt;().Any());</code> <br>    ,    ,             . <br> <br>    <i>INotifyDataErrorInfo</i> <br>       <code>GetErrors</code> ,   <code>INotifyDataErrorInfo</code>  ,   <code>ErrorsChanged</code>      <code>GetErrors</code> . ,  <code>HasErrors</code>      ,  . <br> <br>       <code>INotifyDataErrorInfo</code> . , ,           ,   -  .      ,        <code>INotifyDataErrorInfo</code>         (,        ). <br> <br>     ,   ,  : <br>  <code>HasErrors</code>     .              ,       .  <code>ErrorsChanged</code> ,      ,         <code>GetErrors</code> .         ( ,  )     ,           .    <code>GetErrors</code>       <code>ErrorsChanged</code> . <br>    <code>INotifyPropertyChanged</code> ,  ,    <code>NotifyDataErrorInfoTestHelper</code>    MVVM,        <code>INotifyDataErrorInfo</code> ,       .   ,   ,      ,   .      . <br> <code class="cs">var helper = new NotifyDataErrorInfoTestHelper&lt;NumericQuestion, int?&gt;( question, q =&gt; q.Response); helper.ValidatePropertyChange( 6, NotifyDataErrorInfoBehavior.Nothing); helper.ValidatePropertyChange( 20, NotifyDataErrorInfoBehavior.FiresErrorsChanged | NotifyDataErrorInfoBehavior.HasErrors | NotifyDataErrorInfoBehavior.HasErrorsForProperty); helper.ValidatePropertyChange( null, NotifyDataErrorInfoBehavior.FiresErrorsChanged | NotifyDataErrorInfoBehavior.HasErrors | NotifyDataErrorInfoBehavior.HasErrorsForProperty); helper.ValidatePropertyChange( 2, NotifyDataErrorInfoBehavior.FiresErrorsChanged);</code> <br>     <br>   MVVM,     ,  .   ,    ,         . <br> <br>  ,     ,     ,       .   ,   , ,       ,     ,   <code>IAsyncResult</code>    ,  - ,   ,    UI. <br> <br>       , , ,    .   ,     .  ,      UI,     ,   ,          ,     ,        "   UI." <br> <br>     ,    ,    .   ,    ,     mock-, ,   ,   ,      ,          . <br> <br>           UI,    ,    .   ,     ,   ,      .        ,   .     ,    ,     . <br> <br> <code class="cs">questionnaireRepositoryMock .Setup( r =&gt; r.SubmitQuestionnaireAsync( It.IsAny&lt;Questionnaire&gt;(), It.IsAny&lt;Action&lt;IOperationResult&gt;&gt;())) .Callback&lt;Questionnaire, Action&lt;IOperationResult&gt;&gt;( (q, a) =&gt; callback = a); uiServicemock .Setup(svc =&gt; svc.ShowView(ViewNames.QuestionnaireTemplatesList)) .Callback&lt;string&gt;(viewName =&gt; requestedViewName = viewName); submitResultMock .Setup(sr =&gt; sr.Error) .Returns&lt;Exception&gt;(null); CompleteQuestionnaire(viewModel); viewModel.Submit(); //      UI . callback(submitResultMock.Object); //    ‚Äì     . Assert.AreEqual(ViewNames.QuestionnaireTemplatesList, requestedViewName);</code> <br> <b></b> <br>          ,        . <br>   <br>       , . "Trees in WPF"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ms753391.aspx">http://msdn.microsoft.com/en-us/library/ms753391.aspx</a> <br> <br>       , . "Attached Properties Overview"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/cc265152(VS.95).aspx">http://msdn.microsoft.com/en-us/library/cc265152(VS.95).aspx</a> <br> <br>      MEF, ."Managed Extensibility Framework Overview"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/dd460648.aspx">http://msdn.microsoft.com/en-us/library/dd460648.aspx</a> . <br> <br>      Unity, ."Unity Application Block"  MSDN: <a href="http://www.msdn.com/unity">http://www.msdn.com/unity</a> . <br> <br>      <code>DelegateCommand</code> , .Chapter 5, " <a href="http://msdn.microsoft.com/en-us/library/gg405484(v%3DPandP.40).aspx">Implementing the MVVM Pattern</a> ." <br> <br>        Microsoft Expression Blend, ."Working with built-in behaviors"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ff724013(v%3DExpression.40).aspx">http://msdn.microsoft.com/en-us/library/ff724013(v=Expression.40).aspx</a> . <br> <br>          Microsoft Expression Blend, ."Creating Custom Behaviors"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ff724708(v%3DExpression.40).aspx">http://msdn.microsoft.com/en-us/library/ff724708(v=Expression.40).aspx</a> . <br> <br>            Microsoft Expression Blend, ."Creating Custom Triggers and Actions"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ff724707(v%3DExpression.40).aspx">http://msdn.microsoft.com/en-us/library/ff724707(v=Expression.40).aspx</a> . <br> <br>         WPF  Silverlight, ."Threading Model"  "The Dispatcher Class"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ms741870.aspx">http://msdn.microsoft.com/en-us/library/ms741870.aspx</a> <br> <a href="http://msdn.microsoft.com/en-us/library/ms615907(v%3DVS.95).aspx">http://msdn.microsoft.com/en-us/library/ms615907(v=VS.95).aspx</a> . <br> <br>      unit-  Silverlight, ."Unit Testing with Silverlight 2": <a href="http://www.jeff.wilcox.name/2008/03/silverlight2-unit-testing/">http://www.jeff.wilcox.name/2008/03/silverlight2-unit-testing/</a> . <br> <br>         , .  " <a href="http://msdn.microsoft.com/en-us/library/gg430861(v%3DPandP.40).aspx">View-Based Navigation</a> " in Chapter 8, " <a href="http://msdn.microsoft.com/en-us/library/gg430861(v%3DPandP.40).aspx">Navigation</a> ." <br> <br>       ,   , ."Event-based Asynchronous Pattern Overview"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/wewwczdw.aspx">http://msdn.microsoft.com/en-us/library/wewwczdw.aspx</a> <br> <br>        <code>IAsyncResult</code> , ."Asynchronous Programming Overview"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ms228963.aspx">http://msdn.microsoft.com/en-us/library/ms228963.aspx</a></code></code></code></code></code></code></code></code></code> </blockquote> <code><code><code><code><code><code><code><code><code><code>CommandBehaviorBase ,    ,    ICommand</code> .           <code>CanExecuteChanged</code> ,          Silverlight,    WPF. <br> <br>    ,  ,   <code>CommandBehaviorBase    ,    .         ,      .         ,    .      ButtonBaseClickCommandBehavior</code> . <br> <br> <code class="cs">public class ButtonBaseClickCommandBehavior : CommandBehaviorBase&lt;ButtonBase&gt; { public ButtonBaseClickCommandBehavior(ButtonBase clickableObject) : base(clickableObject) { clickableObject.Click += OnClick; } private void OnClick(object sender, System.Windows.RoutedEventArgs e) { ExecuteCommand(); } }</code> <br>   <code>CommandBehaviorBase ,     .     ,          ,   . ,    ,    ,      , ,    CanExecute</code>  ,     . <br> <br>          ,   .           XAML.           .       .  Prism      ,       ,  ,   .       ,    . , ,  ,      <code>Click</code> ,       <code>Command</code> .    <code>Click.Command</code> ,  . <br> <br>             .             . <br> <br> <code class="cs">public static readonly DependencyProperty CommandProperty = DependencyProperty.RegisterAttached( "Command", typeof(ICommand), typeof(Click), new PropertyMetadata(OnSetCommandCallback)); private static readonly DependencyProperty ClickCommandBehaviorProperty = DependencyProperty.RegisterAttached( "ClickCommandBehavior", typeof(ButtonBaseClickCommandBehavior), typeof(Click), null);</code> <br>    <code>Command</code>    <code>ButtonBaseClickCommandBehavior</code> ,     <code>OnSetCommandCallback</code> ,     . <br> <br> <code class="cs">private static void OnSetCommandCallback(DependencyObject dependencyObject, DependencyPropertyChangedEventArgs e) { ButtonBase buttonBase = dependencyObject as ButtonBase; if (buttonBase != null) { ButtonBaseClickCommandBehavior behavior = GetOrCreateBehavior(buttonBase); behavior.Command = e.NewValue as ICommand; } } private static void OnSetCommandParameterCallback(DependencyObject dependencyObject, DependencyPropertyChangedEventArgs e) { ButtonBase buttonBase = dependencyObject as ButtonBase; if (buttonBase != null) { ButtonBaseClickCommandBehavior behavior = GetOrCreateBehavior(buttonBase); behavior.CommandParameter = e.NewValue; } } private static ButtonBaseClickCommandBehavior GetOrCreateBehavior(ButtonBase buttonBase ) { ButtonBaseClickCommandBehavior behavior = buttonBase.GetValue(ClickCommandBehaviorProperty) as ButtonBaseClickCommandBehavior; if ( behavior == null ) { behavior = new ButtonBaseClickCommandBehavior(buttonBase); buttonBase.SetValue(ClickCommandBehaviorProperty, behavior); } return behavior; }</code> <br>        ,  <a href="http://msdn.microsoft.com/en-us/library/cc265152(VS.95).aspx">Attached Properties Overview</a>  MSDN. <br> <br>    <br>              . ,     Silverlight,    -,     ,      ,     .     ,       . <br> <br>        ,    ( )  ,  ,     .  UI       ,            UI. <br> <br>      - <br>   -     ,       <code>IAsyncResult</code> .   ,  ,   ,  <code>GetQuestionnaire</code> ,   : <code>BeginGetQuestionnaire</code>  <code>EndGetQuestionnaire</code> .    ,   <code>BeginGetQuestionnaire</code> .     ,   ,   <code>EndGetQuestionnaire</code>    . <br> <b></b> <br>  .NET Framework 4.5      <code>await</code>  <code>async</code>     <code>*Async</code> .      <a href="http://msdn.microsoft.com/en-us/library/vstudio/hh391443.aspx">"Asynchronous Programming with Async and Await (C# and Visual Basic)"</a> . <br>  ,    <code>EndGetQuestionnaire</code> ,      ,  ()      <code>BeginGetQuestionnaire</code> .     ,      ,   <code>EndGetQuestionnaire</code> ,   . <br> <br> <code class="xml">IAsyncResult asyncResult = this.service.BeginGetQuestionnaire( GetQuestionnaireCompleted, null //  ,      ); private void GetQuestionnaireCompleted(IAsyncResult result) { try { questionnaire = this.service.EndGetQuestionnaire(ar); } catch (Exception ex) { //  -   . } }</code> <br>  ,     <code>End*</code> (  , <code>EndGetQuestionnaire</code> ),    ,      .      , ,          UI.     ,   ,        . <br> <br>        UI,     -,      UI,         UI,   <code>Dispatcher</code>    <code>SynchronizationContext</code> .  WPF  Silverlight,   <code>Dispatcher</code> . <br> <br>      <code>Questionnaire</code>  ,        <code>QuestionnaireView</code> .  Silverlight    <code>CheckAccess</code> ,  ,      UI.  ,     <code>BeginInvoke</code> ,      UI. <br> <br> <code class="cs">var dispatcher = System.Windows.Deployment.Current.Dispatcher; if (dispatcher.CheckAccess()) { QuestionnaireView.DataContext = questionnaire; } else { dispatcher.BeginInvoke(() =&gt; { Questionnaire.DataContext = questionnaire; }); }</code> <br> <i>MVVM RI</i>   ,    ,   <code>IAsyncResult</code> ,   .      ,                 . ,       . <br> <br> <code class="cs">this.questionnaireRepository.GetQuestionnaireAsync( result =&gt; { this.Questionnaire = result.Result; });</code> <br>  <code>result</code>   ,     , , , .    ,     . <br> <br> <code class="cs">this.questionnaireRepository.GetQuestionnaireAsync( result =&gt; { if (result.Error == null) { this.Questionnaire = result.Result; ... } else { // Handle error. } })</code> <br>     <br>        ,      .     , ,             .        ,      ,     ,     . <br> <br>         ,      MVVM,     ,   . ,  -MVVM ,     <code>MessageBox</code>   code-behind UI,      .   MVVM     ,          . <br> <br>     MVVM,              ,          .      ,    ,   ,  ,     . <br> <br>              MVVM.      ,     ,     ,  ,     .    ,         ,     ,          .       . <br> <br>    <br>                  .        ,        .  ,         .         . <br> <br>  ,         ,         ,  .      ,     .           ,       . ,        WPF  Silverlight,        . <br> <br> <img title="Using the service to interact with the user." src="https://habrastorage.org/getpro/habr/post_images/4b5/397/f2d/4b5397f2d02e5851195b29f1893be6fc.png" alt=" ,    ."> <br> <br>  ,   <code>MessageBox</code>        ,     ,    ,     . <br> <br> <code class="cs">var result = interactionService.ShowMessageBox( "Are you sure you want to cancel this operation?", "Confirm", MessageBoxButton.OK); if (result == MessageBoxResult.Yes) { CancelRequest(); }</code> <br> ,      - ,      ,         Silverlight.         .             .     . <br> <br> <code class="cs">interactionService.ShowMessageBox( "Are you sure you want to cancel this operation?", "Confirm", MessageBoxButton.OK, result =&gt; { if (result == MessageBoxResult.Yes) { CancelRequest(); } });</code> <br>         ,      . ,  WPF    <code>MessageBox</code> ,       ;    Silverlight    ,    . <br> <br>     <br>         ‚Äì             .         ,      .     ,     .        ,        ,   ,     . <br> <br> <img title="Using interaction request objects." src="https://habrastorage.org/getpro/habr/post_images/3d0/ff0/1c5/3d0ff01c5518558c2d3c5c5f47ce0ce9.png" alt="   ."> <br> <br>    ,   ,          ‚Äì       ,      ,   ‚Äì     .   ,        ,    ,    UI            . <br> <br>       MVVM,     ,       ,         .         ,        ,    ,   . <br> <br>  Prism       <code>IInteractionRequest</code>   <code>InteractionRequest .  IInteractionRequest</code>  ,   .           ,   .  <code>InteractionRequest   IInteractionRequest</code>     <code>Raise</code> ,           , , ,   . <br> <br>       <br>  <code>InteractionRequest          .  Raise</code>          ( <code>T</code> )    ,    ,   .          ,       .      ,        .    ,  ,     . <br> <code class="cs">public interface IInteractionRequest { event EventHandler&lt;InteractionRequestedEventArgs&gt; Raised; } public class InteractionRequest&lt;T&gt; : IInteractionRequest { public event EventHandler&lt;InteractionRequestedEventArgs&gt; Raised; public void Raise(T context, Action&lt;T&gt; callback) { var handler = this.Raised; if (handler != null) { handler( this, new InteractionRequestedEventArgs(context, () =&gt; callback(context))); } } }</code> <br> Prism    ,      .  <code>Notification</code>       .    ,            .     ‚Äì <code>Title</code>  <code>Content</code> ,    .  ,   ,  ,  ,        . <br> <br>  <code>Confirmation</code>    <code>Notification</code>     ‚Äì <code>Confirmed</code> ,  ,  ,      .  <code>Confirmation</code> ,     <code>MessageBox</code> ,     /  .     ,     <code>Notification</code> ,     ,      . <br> <br>    <code>InteractionRequest ,       InteractionRequest      ,      .      ,    Raise</code> ,    , ,   . <br> <br> <code class="cs">public IInteractionRequest ConfirmCancelInteractionRequest { get { return this.confirmCancelInteractionRequest; } } this.confirmCancelInteractionRequest.Raise( new Confirmation("Are you sure you wish to cancel?"), confirmation =&gt; { if (confirmation.Confirmed) { this.NavigateToQuestionnaireList(); } }); }</code> <br> <i>MVVM Reference Implementation (MVVM RI)</i> ,    <code>IInteractionRequest</code>   <code>InteractionRequest ,          (. QuestionnaireViewModel.cs</code> ). <br> <br>        <br>       ,       .   ,       .    UI             . <br> <br>                . Microsoft Expression Blend Behaviors Framework     .  ,     ,    . <br> <br>  <code>EventTrigger</code> ,  Expression Blend,  ,      ,     ,   . , Prism   <code>EventTrigger</code> ,  <code>InteractionRequestTrigger</code> ,      <code>Raised</code>   <code>IInteractionRequest</code> .    XAML        . <br> <br>  ,   , <code>InteractionRequestTrigger</code>   .  Silverlight Prism   <code>PopupChildWindowAction</code> ,     .    ,         .   <code>ContentTemplate</code>  <code>PopupChildWindowAction</code> ,    ,    UI,      <code>Content</code>  .       <code>Title</code>  . <br> <b></b> <br>  ,    ,   <code>PopupChildWindowAction</code> ,     .    <code>Notification</code>  <code>NotificationChildWindow</code> ,        <code>Confirmation</code> ‚Äì <code>ConfirmationChildWindow</code> . <code>NotificationChildWindow</code>    ,   ,     <code>ConfirmationChildWindow</code>    <i>OK</i>  <i>Cancel</i> ,    .    ,   ,   <code>ChildWindow</code>  <code>PopupChildWindowAction</code> . <br>   ,  <code>InteractionRequestTrigger</code>  <code>PopupChildWindowAction</code> ,       <i>RI MVVM</i> . <br> <br> <code class="xml">&lt;i:Interaction.Triggers&gt; &lt;prism:InteractionRequestTrigger SourceObject="{Binding ConfirmCancelInteractionRequest}"&gt; &lt;prism:PopupChildWindowAction ContentTemplate="{StaticResource ConfirmWindowTemplate}"/&gt; &lt;/prism:InteractionRequestTrigger&gt; &lt;/i:Interaction.Triggers&gt; &lt;UserControl.Resources&gt; &lt;DataTemplate x:Key="ConfirmWindowTemplate"&gt; &lt;Grid MinWidth="250" MinHeight="100"&gt; &lt;TextBlock TextWrapping="Wrap" Grid.Row="0" Text="{Binding}"/&gt; &lt;/Grid&gt; &lt;/DataTemplate&gt; &lt;/UserControl.Resources&gt;</code> <br> <b></b> <br>      <code>ContentTemplate</code> ,   UI   <code>Content</code>  .    <code>Content</code>  ,  , <code>TextBlock</code>     <code>Content</code> . <br>      ,     ,    ,    .  ,     ,       ,     ,    .   ,   <i>RI MVVM</i> ,         <code>Confirmed</code>    <code>Confirmation</code>  <code>true</code> ,     OK. <br> <br>        ,     .  Prism <code>InteractionRequestTrigger</code>   <code>PopupChildWindowAction</code>            . <br> <br>     <br>     MVVM,       , ,    ,         .        (  , ,  ,   ).    ,  ,  ,            . <br> <br>        ,         . Managed Extensibility Framework (MEF)  Unity Application Block (Unity)      ,  ,           . <br> <br>  ,       , , ,    ( )      . ,       ,     .  ,     ,       . <br> <br>     ,  MEF <br>  MEF,       ,   <code>Import</code> ,      ,  ,   <code>Export</code> .         ,    . <br> <br> , <code>QuestionnaireView</code>   <i>RI MVVM</i> ,        ,    <code>Import</code> .   , MEF           .  <code>set</code>        ,   . <br> <br> <code class="cs">[Import] public QuestionnaireViewModel ViewModel { set { this.DataContext = value; } }</code> <br>     ,   . <br> <br> <code class="cs">[Export] public class QuestionnaireViewModel : NotificationObject { ... }</code> <br>        ,   . <br> <br> <code class="cs">public QuestionnaireView() { InitializeComponent(); } [ImportingConstructor] public QuestionnaireView(QuestionnaireViewModel viewModel) : this() { this.DataContext = viewModel; }</code> <br> <b></b> <br>          MEF,   Unity.   ,     ,        .   ,   Visual Studio  Expression Blend, ,        ,     .   ,   ,  ,      ,          <code>InitializeComponent</code> . <br>     ,  Unity <br>  Unity,    ,   MEF.     ,      .    ,         .  ,      . <br> <br>  ,      ,  ,         . ,           ,   . <br> <br> <code class="cs">public QuestionnaireView() { InitializeComponent(); } public QuestionnaireView(QuestionnaireViewModel viewModel) : this() { this.DataContext = viewModel; }</code> <br> <b></b> <br>    ,        ,   Visual Studio  Expression Blend. <br>  ,          ,   . Unity        <code>set</code>   ,   . <br> <br> <code class="cs">public QuestionnaireView() { InitializeComponent(); } [Dependency] public QuestionnaireViewModel ViewModel { set { this.DataContext = value; } }</code> <br>       Unity. <br> <br> <code class="cs">container.RegisterType&lt;QuestionnaireViewModel&gt;();</code> <br>  ,     . <br> <br> <code class="cs">var view = container.Resolve&lt;QuestionnaireView&gt;();</code> <br>     ,    <br>   ,     ,        .        ,   MEF  Unity,        . <br> <br>          .   ,         UI,           . <br> <br> , <i>RI MVVM</i>   ,   ,        .   ,    .      <code>ShowView</code>   UI. <br> <br> <code class="cs">private void NavigateToQuestionnaireList() { //     "questionnaire list". this.uiService.ShowView(ViewNames.QuestionnaireTemplatesList); }</code> <br>  UI      UI .           UI.  <code>ShowView</code>  <code>UIService</code>      (,          ),       ,   . <br> <br> <code class="cs">public void ShowView(string viewName) { var view = this.ViewFactory.GetView(viewName); this.MainWindow.CurrentView = view; }</code> <br> <b></b> <br> Prism       .   ,   ,   ,             .    ,  , " <a href="http://msdn.microsoft.com/en-us/library/gg430861(v%3DPandP.40).aspx">View-Based Navigation</a> "   8, " <a href="http://msdn.microsoft.com/en-us/library/gg430861(v%3DPandP.40).aspx">Navigation</a> ". <br>  MVVM  <br>        MVVM      .           -      mocking . ,   ,        . <br> <br>   <i>INotifyPropertyChanged</i> <br>   <code>INotifyPropertyChanged</code>     ,      .      ,    ;   ,   ,     ,    ,       . <br> <br>   <br> ,       ,           <code>PropertyChanged</code>  ,         .  ,    <code>ChangeTracker</code> ,     MVVM,  ,      .      .     ,    . <br> <br> <code class="cs">var changeTracker = new PropertyChangeTracker(viewModel); viewModel.CurrentState = "newState"; CollectionAssert.Contains(changeTracker.ChangedProperties, "CurrentState");</code> <br> ,     ,     <code>INotifyPropertyChanged</code> ,    ,   ,     . <br> <br>      <br>        ,   ,    <code>set</code>      ,           . ,     ,     ,      ,          . <br> <br> <code class="cs">var changeTracker = new PropertyChangeTracker(viewModel); var question = viewModel.Questions.First() as OpenQuestionViewModel; question.Question.Response = "some text"; CollectionAssert.Contains(changeTracker.ChangedProperties, "UnansweredQuestions");</code> <br>      <br>     <code>INotifyPropertyChanged</code> ,      <code>PropertyChanged</code>        ,  ,     , , .        ,       . <br> <br>   <i>INotifyDataErrorInfo</i> <br>   ,     ,    ,   ,   <code>IDataErrorInfo</code> ,  ( Silverlight)   <code>INotifyDataErrorInfo</code> .   <code>INotifyDataErrorInfo</code>   ,         ,    ,  ,   ,    . <br> <br>       <code>INotifyDataErrorInfo</code> : ,     ,  ,     ,     <code>ErrorsChanged</code> ,      <code>GetErrors</code> , . <br> <br>    <br>     ,      ,     .       ,         <code>GetErrors</code>       ,  ,  ,   .    , ,  ,     ,        .   ,        . <br> <br> <code class="cs">//  . var notifyErrorInfo = (INotifyDataErrorInfo)question; question.Response = -15; Assert.IsTrue(notifyErrorInfo.GetErrors("Response").Cast&lt;ValidationResult&gt;().Any()); //  . var notifyErrorInfo = (INotifyDataErrorInfo)question; question.Response = 15; Assert.IsFalse(notifyErrorInfo.GetErrors("Response").Cast&lt;ValidationResult&gt;().Any());</code> <br>    ,    ,             . <br> <br>    <i>INotifyDataErrorInfo</i> <br>       <code>GetErrors</code> ,   <code>INotifyDataErrorInfo</code>  ,   <code>ErrorsChanged</code>      <code>GetErrors</code> . ,  <code>HasErrors</code>      ,  . <br> <br>       <code>INotifyDataErrorInfo</code> . , ,           ,   -  .      ,        <code>INotifyDataErrorInfo</code>         (,        ). <br> <br>     ,   ,  : <br>  <code>HasErrors</code>     .              ,       .  <code>ErrorsChanged</code> ,      ,         <code>GetErrors</code> .         ( ,  )     ,           .    <code>GetErrors</code>       <code>ErrorsChanged</code> . <br>    <code>INotifyPropertyChanged</code> ,  ,    <code>NotifyDataErrorInfoTestHelper</code>    MVVM,        <code>INotifyDataErrorInfo</code> ,       .   ,   ,      ,   .      . <br> <code class="cs">var helper = new NotifyDataErrorInfoTestHelper&lt;NumericQuestion, int?&gt;( question, q =&gt; q.Response); helper.ValidatePropertyChange( 6, NotifyDataErrorInfoBehavior.Nothing); helper.ValidatePropertyChange( 20, NotifyDataErrorInfoBehavior.FiresErrorsChanged | NotifyDataErrorInfoBehavior.HasErrors | NotifyDataErrorInfoBehavior.HasErrorsForProperty); helper.ValidatePropertyChange( null, NotifyDataErrorInfoBehavior.FiresErrorsChanged | NotifyDataErrorInfoBehavior.HasErrors | NotifyDataErrorInfoBehavior.HasErrorsForProperty); helper.ValidatePropertyChange( 2, NotifyDataErrorInfoBehavior.FiresErrorsChanged);</code> <br>     <br>   MVVM,     ,  .   ,    ,         . <br> <br>  ,     ,     ,       .   ,   , ,       ,     ,   <code>IAsyncResult</code>    ,  - ,   ,    UI. <br> <br>       , , ,    .   ,     .  ,      UI,     ,   ,          ,     ,        "   UI." <br> <br>     ,    ,    .   ,    ,     mock-, ,   ,   ,      ,          . <br> <br>           UI,    ,    .   ,     ,   ,      .        ,   .     ,    ,     . <br> <br> <code class="cs">questionnaireRepositoryMock .Setup( r =&gt; r.SubmitQuestionnaireAsync( It.IsAny&lt;Questionnaire&gt;(), It.IsAny&lt;Action&lt;IOperationResult&gt;&gt;())) .Callback&lt;Questionnaire, Action&lt;IOperationResult&gt;&gt;( (q, a) =&gt; callback = a); uiServicemock .Setup(svc =&gt; svc.ShowView(ViewNames.QuestionnaireTemplatesList)) .Callback&lt;string&gt;(viewName =&gt; requestedViewName = viewName); submitResultMock .Setup(sr =&gt; sr.Error) .Returns&lt;Exception&gt;(null); CompleteQuestionnaire(viewModel); viewModel.Submit(); //      UI . callback(submitResultMock.Object); //    ‚Äì     . Assert.AreEqual(ViewNames.QuestionnaireTemplatesList, requestedViewName);</code> <br> <b></b> <br>          ,        . <br>   <br>       , . "Trees in WPF"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ms753391.aspx">http://msdn.microsoft.com/en-us/library/ms753391.aspx</a> <br> <br>       , . "Attached Properties Overview"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/cc265152(VS.95).aspx">http://msdn.microsoft.com/en-us/library/cc265152(VS.95).aspx</a> <br> <br>      MEF, ."Managed Extensibility Framework Overview"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/dd460648.aspx">http://msdn.microsoft.com/en-us/library/dd460648.aspx</a> . <br> <br>      Unity, ."Unity Application Block"  MSDN: <a href="http://www.msdn.com/unity">http://www.msdn.com/unity</a> . <br> <br>      <code>DelegateCommand</code> , .Chapter 5, " <a href="http://msdn.microsoft.com/en-us/library/gg405484(v%3DPandP.40).aspx">Implementing the MVVM Pattern</a> ." <br> <br>        Microsoft Expression Blend, ."Working with built-in behaviors"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ff724013(v%3DExpression.40).aspx">http://msdn.microsoft.com/en-us/library/ff724013(v=Expression.40).aspx</a> . <br> <br>          Microsoft Expression Blend, ."Creating Custom Behaviors"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ff724708(v%3DExpression.40).aspx">http://msdn.microsoft.com/en-us/library/ff724708(v=Expression.40).aspx</a> . <br> <br>            Microsoft Expression Blend, ."Creating Custom Triggers and Actions"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ff724707(v%3DExpression.40).aspx">http://msdn.microsoft.com/en-us/library/ff724707(v=Expression.40).aspx</a> . <br> <br>         WPF  Silverlight, ."Threading Model"  "The Dispatcher Class"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ms741870.aspx">http://msdn.microsoft.com/en-us/library/ms741870.aspx</a> <br> <a href="http://msdn.microsoft.com/en-us/library/ms615907(v%3DVS.95).aspx">http://msdn.microsoft.com/en-us/library/ms615907(v=VS.95).aspx</a> . <br> <br>      unit-  Silverlight, ."Unit Testing with Silverlight 2": <a href="http://www.jeff.wilcox.name/2008/03/silverlight2-unit-testing/">http://www.jeff.wilcox.name/2008/03/silverlight2-unit-testing/</a> . <br> <br>         , .  " <a href="http://msdn.microsoft.com/en-us/library/gg430861(v%3DPandP.40).aspx">View-Based Navigation</a> " in Chapter 8, " <a href="http://msdn.microsoft.com/en-us/library/gg430861(v%3DPandP.40).aspx">Navigation</a> ." <br> <br>       ,   , ."Event-based Asynchronous Pattern Overview"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/wewwczdw.aspx">http://msdn.microsoft.com/en-us/library/wewwczdw.aspx</a> <br> <br>        <code>IAsyncResult</code> , ."Asynchronous Programming Overview"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ms228963.aspx">http://msdn.microsoft.com/en-us/library/ms228963.aspx</a></code></code></code></code></code></code></code></code></code> <h4> <code><code><code><code><code><code><code><code><code><code>CommandBehaviorBase ,    ,    ICommand</code> .           <code>CanExecuteChanged</code> ,          Silverlight,    WPF. <br> <br>    ,  ,   <code>CommandBehaviorBase    ,    .         ,      .         ,    .      ButtonBaseClickCommandBehavior</code> . <br> <br> <code class="cs">public class ButtonBaseClickCommandBehavior : CommandBehaviorBase&lt;ButtonBase&gt; { public ButtonBaseClickCommandBehavior(ButtonBase clickableObject) : base(clickableObject) { clickableObject.Click += OnClick; } private void OnClick(object sender, System.Windows.RoutedEventArgs e) { ExecuteCommand(); } }</code> <br>   <code>CommandBehaviorBase ,     .     ,          ,   . ,    ,    ,      , ,    CanExecute</code>  ,     . <br> <br>          ,   .           XAML.           .       .  Prism      ,       ,  ,   .       ,    . , ,  ,      <code>Click</code> ,       <code>Command</code> .    <code>Click.Command</code> ,  . <br> <br>             .             . <br> <br> <code class="cs">public static readonly DependencyProperty CommandProperty = DependencyProperty.RegisterAttached( "Command", typeof(ICommand), typeof(Click), new PropertyMetadata(OnSetCommandCallback)); private static readonly DependencyProperty ClickCommandBehaviorProperty = DependencyProperty.RegisterAttached( "ClickCommandBehavior", typeof(ButtonBaseClickCommandBehavior), typeof(Click), null);</code> <br>    <code>Command</code>    <code>ButtonBaseClickCommandBehavior</code> ,     <code>OnSetCommandCallback</code> ,     . <br> <br> <code class="cs">private static void OnSetCommandCallback(DependencyObject dependencyObject, DependencyPropertyChangedEventArgs e) { ButtonBase buttonBase = dependencyObject as ButtonBase; if (buttonBase != null) { ButtonBaseClickCommandBehavior behavior = GetOrCreateBehavior(buttonBase); behavior.Command = e.NewValue as ICommand; } } private static void OnSetCommandParameterCallback(DependencyObject dependencyObject, DependencyPropertyChangedEventArgs e) { ButtonBase buttonBase = dependencyObject as ButtonBase; if (buttonBase != null) { ButtonBaseClickCommandBehavior behavior = GetOrCreateBehavior(buttonBase); behavior.CommandParameter = e.NewValue; } } private static ButtonBaseClickCommandBehavior GetOrCreateBehavior(ButtonBase buttonBase ) { ButtonBaseClickCommandBehavior behavior = buttonBase.GetValue(ClickCommandBehaviorProperty) as ButtonBaseClickCommandBehavior; if ( behavior == null ) { behavior = new ButtonBaseClickCommandBehavior(buttonBase); buttonBase.SetValue(ClickCommandBehaviorProperty, behavior); } return behavior; }</code> <br>        ,  <a href="http://msdn.microsoft.com/en-us/library/cc265152(VS.95).aspx">Attached Properties Overview</a>  MSDN. <br> <br>    <br>              . ,     Silverlight,    -,     ,      ,     .     ,       . <br> <br>        ,    ( )  ,  ,     .  UI       ,            UI. <br> <br>      - <br>   -     ,       <code>IAsyncResult</code> .   ,  ,   ,  <code>GetQuestionnaire</code> ,   : <code>BeginGetQuestionnaire</code>  <code>EndGetQuestionnaire</code> .    ,   <code>BeginGetQuestionnaire</code> .     ,   ,   <code>EndGetQuestionnaire</code>    . <br> <b></b> <br>  .NET Framework 4.5      <code>await</code>  <code>async</code>     <code>*Async</code> .      <a href="http://msdn.microsoft.com/en-us/library/vstudio/hh391443.aspx">"Asynchronous Programming with Async and Await (C# and Visual Basic)"</a> . <br>  ,    <code>EndGetQuestionnaire</code> ,      ,  ()      <code>BeginGetQuestionnaire</code> .     ,      ,   <code>EndGetQuestionnaire</code> ,   . <br> <br> <code class="xml">IAsyncResult asyncResult = this.service.BeginGetQuestionnaire( GetQuestionnaireCompleted, null //  ,      ); private void GetQuestionnaireCompleted(IAsyncResult result) { try { questionnaire = this.service.EndGetQuestionnaire(ar); } catch (Exception ex) { //  -   . } }</code> <br>  ,     <code>End*</code> (  , <code>EndGetQuestionnaire</code> ),    ,      .      , ,          UI.     ,   ,        . <br> <br>        UI,     -,      UI,         UI,   <code>Dispatcher</code>    <code>SynchronizationContext</code> .  WPF  Silverlight,   <code>Dispatcher</code> . <br> <br>      <code>Questionnaire</code>  ,        <code>QuestionnaireView</code> .  Silverlight    <code>CheckAccess</code> ,  ,      UI.  ,     <code>BeginInvoke</code> ,      UI. <br> <br> <code class="cs">var dispatcher = System.Windows.Deployment.Current.Dispatcher; if (dispatcher.CheckAccess()) { QuestionnaireView.DataContext = questionnaire; } else { dispatcher.BeginInvoke(() =&gt; { Questionnaire.DataContext = questionnaire; }); }</code> <br> <i>MVVM RI</i>   ,    ,   <code>IAsyncResult</code> ,   .      ,                 . ,       . <br> <br> <code class="cs">this.questionnaireRepository.GetQuestionnaireAsync( result =&gt; { this.Questionnaire = result.Result; });</code> <br>  <code>result</code>   ,     , , , .    ,     . <br> <br> <code class="cs">this.questionnaireRepository.GetQuestionnaireAsync( result =&gt; { if (result.Error == null) { this.Questionnaire = result.Result; ... } else { // Handle error. } })</code> <br>     <br>        ,      .     , ,             .        ,      ,     ,     . <br> <br>         ,      MVVM,     ,   . ,  -MVVM ,     <code>MessageBox</code>   code-behind UI,      .   MVVM     ,          . <br> <br>     MVVM,              ,          .      ,    ,   ,  ,     . <br> <br>              MVVM.      ,     ,     ,  ,     .    ,         ,     ,          .       . <br> <br>    <br>                  .        ,        .  ,         .         . <br> <br>  ,         ,         ,  .      ,     .           ,       . ,        WPF  Silverlight,        . <br> <br> <img title="Using the service to interact with the user." src="https://habrastorage.org/getpro/habr/post_images/4b5/397/f2d/4b5397f2d02e5851195b29f1893be6fc.png" alt=" ,    ."> <br> <br>  ,   <code>MessageBox</code>        ,     ,    ,     . <br> <br> <code class="cs">var result = interactionService.ShowMessageBox( "Are you sure you want to cancel this operation?", "Confirm", MessageBoxButton.OK); if (result == MessageBoxResult.Yes) { CancelRequest(); }</code> <br> ,      - ,      ,         Silverlight.         .             .     . <br> <br> <code class="cs">interactionService.ShowMessageBox( "Are you sure you want to cancel this operation?", "Confirm", MessageBoxButton.OK, result =&gt; { if (result == MessageBoxResult.Yes) { CancelRequest(); } });</code> <br>         ,      . ,  WPF    <code>MessageBox</code> ,       ;    Silverlight    ,    . <br> <br>     <br>         ‚Äì             .         ,      .     ,     .        ,        ,   ,     . <br> <br> <img title="Using interaction request objects." src="https://habrastorage.org/getpro/habr/post_images/3d0/ff0/1c5/3d0ff01c5518558c2d3c5c5f47ce0ce9.png" alt="   ."> <br> <br>    ,   ,          ‚Äì       ,      ,   ‚Äì     .   ,        ,    ,    UI            . <br> <br>       MVVM,     ,       ,         .         ,        ,    ,   . <br> <br>  Prism       <code>IInteractionRequest</code>   <code>InteractionRequest .  IInteractionRequest</code>  ,   .           ,   .  <code>InteractionRequest   IInteractionRequest</code>     <code>Raise</code> ,           , , ,   . <br> <br>       <br>  <code>InteractionRequest          .  Raise</code>          ( <code>T</code> )    ,    ,   .          ,       .      ,        .    ,  ,     . <br> <code class="cs">public interface IInteractionRequest { event EventHandler&lt;InteractionRequestedEventArgs&gt; Raised; } public class InteractionRequest&lt;T&gt; : IInteractionRequest { public event EventHandler&lt;InteractionRequestedEventArgs&gt; Raised; public void Raise(T context, Action&lt;T&gt; callback) { var handler = this.Raised; if (handler != null) { handler( this, new InteractionRequestedEventArgs(context, () =&gt; callback(context))); } } }</code> <br> Prism    ,      .  <code>Notification</code>       .    ,            .     ‚Äì <code>Title</code>  <code>Content</code> ,    .  ,   ,  ,  ,        . <br> <br>  <code>Confirmation</code>    <code>Notification</code>     ‚Äì <code>Confirmed</code> ,  ,  ,      .  <code>Confirmation</code> ,     <code>MessageBox</code> ,     /  .     ,     <code>Notification</code> ,     ,      . <br> <br>    <code>InteractionRequest ,       InteractionRequest      ,      .      ,    Raise</code> ,    , ,   . <br> <br> <code class="cs">public IInteractionRequest ConfirmCancelInteractionRequest { get { return this.confirmCancelInteractionRequest; } } this.confirmCancelInteractionRequest.Raise( new Confirmation("Are you sure you wish to cancel?"), confirmation =&gt; { if (confirmation.Confirmed) { this.NavigateToQuestionnaireList(); } }); }</code> <br> <i>MVVM Reference Implementation (MVVM RI)</i> ,    <code>IInteractionRequest</code>   <code>InteractionRequest ,          (. QuestionnaireViewModel.cs</code> ). <br> <br>        <br>       ,       .   ,       .    UI             . <br> <br>                . Microsoft Expression Blend Behaviors Framework     .  ,     ,    . <br> <br>  <code>EventTrigger</code> ,  Expression Blend,  ,      ,     ,   . , Prism   <code>EventTrigger</code> ,  <code>InteractionRequestTrigger</code> ,      <code>Raised</code>   <code>IInteractionRequest</code> .    XAML        . <br> <br>  ,   , <code>InteractionRequestTrigger</code>   .  Silverlight Prism   <code>PopupChildWindowAction</code> ,     .    ,         .   <code>ContentTemplate</code>  <code>PopupChildWindowAction</code> ,    ,    UI,      <code>Content</code>  .       <code>Title</code>  . <br> <b></b> <br>  ,    ,   <code>PopupChildWindowAction</code> ,     .    <code>Notification</code>  <code>NotificationChildWindow</code> ,        <code>Confirmation</code> ‚Äì <code>ConfirmationChildWindow</code> . <code>NotificationChildWindow</code>    ,   ,     <code>ConfirmationChildWindow</code>    <i>OK</i>  <i>Cancel</i> ,    .    ,   ,   <code>ChildWindow</code>  <code>PopupChildWindowAction</code> . <br>   ,  <code>InteractionRequestTrigger</code>  <code>PopupChildWindowAction</code> ,       <i>RI MVVM</i> . <br> <br> <code class="xml">&lt;i:Interaction.Triggers&gt; &lt;prism:InteractionRequestTrigger SourceObject="{Binding ConfirmCancelInteractionRequest}"&gt; &lt;prism:PopupChildWindowAction ContentTemplate="{StaticResource ConfirmWindowTemplate}"/&gt; &lt;/prism:InteractionRequestTrigger&gt; &lt;/i:Interaction.Triggers&gt; &lt;UserControl.Resources&gt; &lt;DataTemplate x:Key="ConfirmWindowTemplate"&gt; &lt;Grid MinWidth="250" MinHeight="100"&gt; &lt;TextBlock TextWrapping="Wrap" Grid.Row="0" Text="{Binding}"/&gt; &lt;/Grid&gt; &lt;/DataTemplate&gt; &lt;/UserControl.Resources&gt;</code> <br> <b></b> <br>      <code>ContentTemplate</code> ,   UI   <code>Content</code>  .    <code>Content</code>  ,  , <code>TextBlock</code>     <code>Content</code> . <br>      ,     ,    ,    .  ,     ,       ,     ,    .   ,   <i>RI MVVM</i> ,         <code>Confirmed</code>    <code>Confirmation</code>  <code>true</code> ,     OK. <br> <br>        ,     .  Prism <code>InteractionRequestTrigger</code>   <code>PopupChildWindowAction</code>            . <br> <br>     <br>     MVVM,       , ,    ,         .        (  , ,  ,   ).    ,  ,  ,            . <br> <br>        ,         . Managed Extensibility Framework (MEF)  Unity Application Block (Unity)      ,  ,           . <br> <br>  ,       , , ,    ( )      . ,       ,     .  ,     ,       . <br> <br>     ,  MEF <br>  MEF,       ,   <code>Import</code> ,      ,  ,   <code>Export</code> .         ,    . <br> <br> , <code>QuestionnaireView</code>   <i>RI MVVM</i> ,        ,    <code>Import</code> .   , MEF           .  <code>set</code>        ,   . <br> <br> <code class="cs">[Import] public QuestionnaireViewModel ViewModel { set { this.DataContext = value; } }</code> <br>     ,   . <br> <br> <code class="cs">[Export] public class QuestionnaireViewModel : NotificationObject { ... }</code> <br>        ,   . <br> <br> <code class="cs">public QuestionnaireView() { InitializeComponent(); } [ImportingConstructor] public QuestionnaireView(QuestionnaireViewModel viewModel) : this() { this.DataContext = viewModel; }</code> <br> <b></b> <br>          MEF,   Unity.   ,     ,        .   ,   Visual Studio  Expression Blend, ,        ,     .   ,   ,  ,      ,          <code>InitializeComponent</code> . <br>     ,  Unity <br>  Unity,    ,   MEF.     ,      .    ,         .  ,      . <br> <br>  ,      ,  ,         . ,           ,   . <br> <br> <code class="cs">public QuestionnaireView() { InitializeComponent(); } public QuestionnaireView(QuestionnaireViewModel viewModel) : this() { this.DataContext = viewModel; }</code> <br> <b></b> <br>    ,        ,   Visual Studio  Expression Blend. <br>  ,          ,   . Unity        <code>set</code>   ,   . <br> <br> <code class="cs">public QuestionnaireView() { InitializeComponent(); } [Dependency] public QuestionnaireViewModel ViewModel { set { this.DataContext = value; } }</code> <br>       Unity. <br> <br> <code class="cs">container.RegisterType&lt;QuestionnaireViewModel&gt;();</code> <br>  ,     . <br> <br> <code class="cs">var view = container.Resolve&lt;QuestionnaireView&gt;();</code> <br>     ,    <br>   ,     ,        .        ,   MEF  Unity,        . <br> <br>          .   ,         UI,           . <br> <br> , <i>RI MVVM</i>   ,   ,        .   ,    .      <code>ShowView</code>   UI. <br> <br> <code class="cs">private void NavigateToQuestionnaireList() { //     "questionnaire list". this.uiService.ShowView(ViewNames.QuestionnaireTemplatesList); }</code> <br>  UI      UI .           UI.  <code>ShowView</code>  <code>UIService</code>      (,          ),       ,   . <br> <br> <code class="cs">public void ShowView(string viewName) { var view = this.ViewFactory.GetView(viewName); this.MainWindow.CurrentView = view; }</code> <br> <b></b> <br> Prism       .   ,   ,   ,             .    ,  , " <a href="http://msdn.microsoft.com/en-us/library/gg430861(v%3DPandP.40).aspx">View-Based Navigation</a> "   8, " <a href="http://msdn.microsoft.com/en-us/library/gg430861(v%3DPandP.40).aspx">Navigation</a> ". <br>  MVVM  <br>        MVVM      .           -      mocking . ,   ,        . <br> <br>   <i>INotifyPropertyChanged</i> <br>   <code>INotifyPropertyChanged</code>     ,      .      ,    ;   ,   ,     ,    ,       . <br> <br>   <br> ,       ,           <code>PropertyChanged</code>  ,         .  ,    <code>ChangeTracker</code> ,     MVVM,  ,      .      .     ,    . <br> <br> <code class="cs">var changeTracker = new PropertyChangeTracker(viewModel); viewModel.CurrentState = "newState"; CollectionAssert.Contains(changeTracker.ChangedProperties, "CurrentState");</code> <br> ,     ,     <code>INotifyPropertyChanged</code> ,    ,   ,     . <br> <br>      <br>        ,   ,    <code>set</code>      ,           . ,     ,     ,      ,          . <br> <br> <code class="cs">var changeTracker = new PropertyChangeTracker(viewModel); var question = viewModel.Questions.First() as OpenQuestionViewModel; question.Question.Response = "some text"; CollectionAssert.Contains(changeTracker.ChangedProperties, "UnansweredQuestions");</code> <br>      <br>     <code>INotifyPropertyChanged</code> ,      <code>PropertyChanged</code>        ,  ,     , , .        ,       . <br> <br>   <i>INotifyDataErrorInfo</i> <br>   ,     ,    ,   ,   <code>IDataErrorInfo</code> ,  ( Silverlight)   <code>INotifyDataErrorInfo</code> .   <code>INotifyDataErrorInfo</code>   ,         ,    ,  ,   ,    . <br> <br>       <code>INotifyDataErrorInfo</code> : ,     ,  ,     ,     <code>ErrorsChanged</code> ,      <code>GetErrors</code> , . <br> <br>    <br>     ,      ,     .       ,         <code>GetErrors</code>       ,  ,  ,   .    , ,  ,     ,        .   ,        . <br> <br> <code class="cs">//  . var notifyErrorInfo = (INotifyDataErrorInfo)question; question.Response = -15; Assert.IsTrue(notifyErrorInfo.GetErrors("Response").Cast&lt;ValidationResult&gt;().Any()); //  . var notifyErrorInfo = (INotifyDataErrorInfo)question; question.Response = 15; Assert.IsFalse(notifyErrorInfo.GetErrors("Response").Cast&lt;ValidationResult&gt;().Any());</code> <br>    ,    ,             . <br> <br>    <i>INotifyDataErrorInfo</i> <br>       <code>GetErrors</code> ,   <code>INotifyDataErrorInfo</code>  ,   <code>ErrorsChanged</code>      <code>GetErrors</code> . ,  <code>HasErrors</code>      ,  . <br> <br>       <code>INotifyDataErrorInfo</code> . , ,           ,   -  .      ,        <code>INotifyDataErrorInfo</code>         (,        ). <br> <br>     ,   ,  : <br>  <code>HasErrors</code>     .              ,       .  <code>ErrorsChanged</code> ,      ,         <code>GetErrors</code> .         ( ,  )     ,           .    <code>GetErrors</code>       <code>ErrorsChanged</code> . <br>    <code>INotifyPropertyChanged</code> ,  ,    <code>NotifyDataErrorInfoTestHelper</code>    MVVM,        <code>INotifyDataErrorInfo</code> ,       .   ,   ,      ,   .      . <br> <code class="cs">var helper = new NotifyDataErrorInfoTestHelper&lt;NumericQuestion, int?&gt;( question, q =&gt; q.Response); helper.ValidatePropertyChange( 6, NotifyDataErrorInfoBehavior.Nothing); helper.ValidatePropertyChange( 20, NotifyDataErrorInfoBehavior.FiresErrorsChanged | NotifyDataErrorInfoBehavior.HasErrors | NotifyDataErrorInfoBehavior.HasErrorsForProperty); helper.ValidatePropertyChange( null, NotifyDataErrorInfoBehavior.FiresErrorsChanged | NotifyDataErrorInfoBehavior.HasErrors | NotifyDataErrorInfoBehavior.HasErrorsForProperty); helper.ValidatePropertyChange( 2, NotifyDataErrorInfoBehavior.FiresErrorsChanged);</code> <br>     <br>   MVVM,     ,  .   ,    ,         . <br> <br>  ,     ,     ,       .   ,   , ,       ,     ,   <code>IAsyncResult</code>    ,  - ,   ,    UI. <br> <br>       , , ,    .   ,     .  ,      UI,     ,   ,          ,     ,        "   UI." <br> <br>     ,    ,    .   ,    ,     mock-, ,   ,   ,      ,          . <br> <br>           UI,    ,    .   ,     ,   ,      .        ,   .     ,    ,     . <br> <br> <code class="cs">questionnaireRepositoryMock .Setup( r =&gt; r.SubmitQuestionnaireAsync( It.IsAny&lt;Questionnaire&gt;(), It.IsAny&lt;Action&lt;IOperationResult&gt;&gt;())) .Callback&lt;Questionnaire, Action&lt;IOperationResult&gt;&gt;( (q, a) =&gt; callback = a); uiServicemock .Setup(svc =&gt; svc.ShowView(ViewNames.QuestionnaireTemplatesList)) .Callback&lt;string&gt;(viewName =&gt; requestedViewName = viewName); submitResultMock .Setup(sr =&gt; sr.Error) .Returns&lt;Exception&gt;(null); CompleteQuestionnaire(viewModel); viewModel.Submit(); //      UI . callback(submitResultMock.Object); //    ‚Äì     . Assert.AreEqual(ViewNames.QuestionnaireTemplatesList, requestedViewName);</code> <br> <b></b> <br>          ,        . <br>   <br>       , . "Trees in WPF"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ms753391.aspx">http://msdn.microsoft.com/en-us/library/ms753391.aspx</a> <br> <br>       , . "Attached Properties Overview"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/cc265152(VS.95).aspx">http://msdn.microsoft.com/en-us/library/cc265152(VS.95).aspx</a> <br> <br>      MEF, ."Managed Extensibility Framework Overview"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/dd460648.aspx">http://msdn.microsoft.com/en-us/library/dd460648.aspx</a> . <br> <br>      Unity, ."Unity Application Block"  MSDN: <a href="http://www.msdn.com/unity">http://www.msdn.com/unity</a> . <br> <br>      <code>DelegateCommand</code> , .Chapter 5, " <a href="http://msdn.microsoft.com/en-us/library/gg405484(v%3DPandP.40).aspx">Implementing the MVVM Pattern</a> ." <br> <br>        Microsoft Expression Blend, ."Working with built-in behaviors"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ff724013(v%3DExpression.40).aspx">http://msdn.microsoft.com/en-us/library/ff724013(v=Expression.40).aspx</a> . <br> <br>          Microsoft Expression Blend, ."Creating Custom Behaviors"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ff724708(v%3DExpression.40).aspx">http://msdn.microsoft.com/en-us/library/ff724708(v=Expression.40).aspx</a> . <br> <br>            Microsoft Expression Blend, ."Creating Custom Triggers and Actions"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ff724707(v%3DExpression.40).aspx">http://msdn.microsoft.com/en-us/library/ff724707(v=Expression.40).aspx</a> . <br> <br>         WPF  Silverlight, ."Threading Model"  "The Dispatcher Class"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ms741870.aspx">http://msdn.microsoft.com/en-us/library/ms741870.aspx</a> <br> <a href="http://msdn.microsoft.com/en-us/library/ms615907(v%3DVS.95).aspx">http://msdn.microsoft.com/en-us/library/ms615907(v=VS.95).aspx</a> . <br> <br>      unit-  Silverlight, ."Unit Testing with Silverlight 2": <a href="http://www.jeff.wilcox.name/2008/03/silverlight2-unit-testing/">http://www.jeff.wilcox.name/2008/03/silverlight2-unit-testing/</a> . <br> <br>         , .  " <a href="http://msdn.microsoft.com/en-us/library/gg430861(v%3DPandP.40).aspx">View-Based Navigation</a> " in Chapter 8, " <a href="http://msdn.microsoft.com/en-us/library/gg430861(v%3DPandP.40).aspx">Navigation</a> ." <br> <br>       ,   , ."Event-based Asynchronous Pattern Overview"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/wewwczdw.aspx">http://msdn.microsoft.com/en-us/library/wewwczdw.aspx</a> <br> <br>        <code>IAsyncResult</code> , ."Asynchronous Programming Overview"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ms228963.aspx">http://msdn.microsoft.com/en-us/library/ms228963.aspx</a></code></code></code></code></code></code></code></code></code> </h4> <code><code><code><code><code><code><code><code><code><code>CommandBehaviorBase ,    ,    ICommand</code> .           <code>CanExecuteChanged</code> ,          Silverlight,    WPF. <br> <br>    ,  ,   <code>CommandBehaviorBase    ,    .         ,      .         ,    .      ButtonBaseClickCommandBehavior</code> . <br> <br> <code class="cs">public class ButtonBaseClickCommandBehavior : CommandBehaviorBase&lt;ButtonBase&gt; { public ButtonBaseClickCommandBehavior(ButtonBase clickableObject) : base(clickableObject) { clickableObject.Click += OnClick; } private void OnClick(object sender, System.Windows.RoutedEventArgs e) { ExecuteCommand(); } }</code> <br>   <code>CommandBehaviorBase ,     .     ,          ,   . ,    ,    ,      , ,    CanExecute</code>  ,     . <br> <br>          ,   .           XAML.           .       .  Prism      ,       ,  ,   .       ,    . , ,  ,      <code>Click</code> ,       <code>Command</code> .    <code>Click.Command</code> ,  . <br> <br>             .             . <br> <br> <code class="cs">public static readonly DependencyProperty CommandProperty = DependencyProperty.RegisterAttached( "Command", typeof(ICommand), typeof(Click), new PropertyMetadata(OnSetCommandCallback)); private static readonly DependencyProperty ClickCommandBehaviorProperty = DependencyProperty.RegisterAttached( "ClickCommandBehavior", typeof(ButtonBaseClickCommandBehavior), typeof(Click), null);</code> <br>    <code>Command</code>    <code>ButtonBaseClickCommandBehavior</code> ,     <code>OnSetCommandCallback</code> ,     . <br> <br> <code class="cs">private static void OnSetCommandCallback(DependencyObject dependencyObject, DependencyPropertyChangedEventArgs e) { ButtonBase buttonBase = dependencyObject as ButtonBase; if (buttonBase != null) { ButtonBaseClickCommandBehavior behavior = GetOrCreateBehavior(buttonBase); behavior.Command = e.NewValue as ICommand; } } private static void OnSetCommandParameterCallback(DependencyObject dependencyObject, DependencyPropertyChangedEventArgs e) { ButtonBase buttonBase = dependencyObject as ButtonBase; if (buttonBase != null) { ButtonBaseClickCommandBehavior behavior = GetOrCreateBehavior(buttonBase); behavior.CommandParameter = e.NewValue; } } private static ButtonBaseClickCommandBehavior GetOrCreateBehavior(ButtonBase buttonBase ) { ButtonBaseClickCommandBehavior behavior = buttonBase.GetValue(ClickCommandBehaviorProperty) as ButtonBaseClickCommandBehavior; if ( behavior == null ) { behavior = new ButtonBaseClickCommandBehavior(buttonBase); buttonBase.SetValue(ClickCommandBehaviorProperty, behavior); } return behavior; }</code> <br>        ,  <a href="http://msdn.microsoft.com/en-us/library/cc265152(VS.95).aspx">Attached Properties Overview</a>  MSDN. <br> <br>    <br>              . ,     Silverlight,    -,     ,      ,     .     ,       . <br> <br>        ,    ( )  ,  ,     .  UI       ,            UI. <br> <br>      - <br>   -     ,       <code>IAsyncResult</code> .   ,  ,   ,  <code>GetQuestionnaire</code> ,   : <code>BeginGetQuestionnaire</code>  <code>EndGetQuestionnaire</code> .    ,   <code>BeginGetQuestionnaire</code> .     ,   ,   <code>EndGetQuestionnaire</code>    . <br> <b></b> <br>  .NET Framework 4.5      <code>await</code>  <code>async</code>     <code>*Async</code> .      <a href="http://msdn.microsoft.com/en-us/library/vstudio/hh391443.aspx">"Asynchronous Programming with Async and Await (C# and Visual Basic)"</a> . <br>  ,    <code>EndGetQuestionnaire</code> ,      ,  ()      <code>BeginGetQuestionnaire</code> .     ,      ,   <code>EndGetQuestionnaire</code> ,   . <br> <br> <code class="xml">IAsyncResult asyncResult = this.service.BeginGetQuestionnaire( GetQuestionnaireCompleted, null //  ,      ); private void GetQuestionnaireCompleted(IAsyncResult result) { try { questionnaire = this.service.EndGetQuestionnaire(ar); } catch (Exception ex) { //  -   . } }</code> <br>  ,     <code>End*</code> (  , <code>EndGetQuestionnaire</code> ),    ,      .      , ,          UI.     ,   ,        . <br> <br>        UI,     -,      UI,         UI,   <code>Dispatcher</code>    <code>SynchronizationContext</code> .  WPF  Silverlight,   <code>Dispatcher</code> . <br> <br>      <code>Questionnaire</code>  ,        <code>QuestionnaireView</code> .  Silverlight    <code>CheckAccess</code> ,  ,      UI.  ,     <code>BeginInvoke</code> ,      UI. <br> <br> <code class="cs">var dispatcher = System.Windows.Deployment.Current.Dispatcher; if (dispatcher.CheckAccess()) { QuestionnaireView.DataContext = questionnaire; } else { dispatcher.BeginInvoke(() =&gt; { Questionnaire.DataContext = questionnaire; }); }</code> <br> <i>MVVM RI</i>   ,    ,   <code>IAsyncResult</code> ,   .      ,                 . ,       . <br> <br> <code class="cs">this.questionnaireRepository.GetQuestionnaireAsync( result =&gt; { this.Questionnaire = result.Result; });</code> <br>  <code>result</code>   ,     , , , .    ,     . <br> <br> <code class="cs">this.questionnaireRepository.GetQuestionnaireAsync( result =&gt; { if (result.Error == null) { this.Questionnaire = result.Result; ... } else { // Handle error. } })</code> <br>     <br>        ,      .     , ,             .        ,      ,     ,     . <br> <br>         ,      MVVM,     ,   . ,  -MVVM ,     <code>MessageBox</code>   code-behind UI,      .   MVVM     ,          . <br> <br>     MVVM,              ,          .      ,    ,   ,  ,     . <br> <br>              MVVM.      ,     ,     ,  ,     .    ,         ,     ,          .       . <br> <br>    <br>                  .        ,        .  ,         .         . <br> <br>  ,         ,         ,  .      ,     .           ,       . ,        WPF  Silverlight,        . <br> <br> <img title="Using the service to interact with the user." src="https://habrastorage.org/getpro/habr/post_images/4b5/397/f2d/4b5397f2d02e5851195b29f1893be6fc.png" alt=" ,    ."> <br> <br>  ,   <code>MessageBox</code>        ,     ,    ,     . <br> <br> <code class="cs">var result = interactionService.ShowMessageBox( "Are you sure you want to cancel this operation?", "Confirm", MessageBoxButton.OK); if (result == MessageBoxResult.Yes) { CancelRequest(); }</code> <br> ,      - ,      ,         Silverlight.         .             .     . <br> <br> <code class="cs">interactionService.ShowMessageBox( "Are you sure you want to cancel this operation?", "Confirm", MessageBoxButton.OK, result =&gt; { if (result == MessageBoxResult.Yes) { CancelRequest(); } });</code> <br>         ,      . ,  WPF    <code>MessageBox</code> ,       ;    Silverlight    ,    . <br> <br>     <br>         ‚Äì             .         ,      .     ,     .        ,        ,   ,     . <br> <br> <img title="Using interaction request objects." src="https://habrastorage.org/getpro/habr/post_images/3d0/ff0/1c5/3d0ff01c5518558c2d3c5c5f47ce0ce9.png" alt="   ."> <br> <br>    ,   ,          ‚Äì       ,      ,   ‚Äì     .   ,        ,    ,    UI            . <br> <br>       MVVM,     ,       ,         .         ,        ,    ,   . <br> <br>  Prism       <code>IInteractionRequest</code>   <code>InteractionRequest .  IInteractionRequest</code>  ,   .           ,   .  <code>InteractionRequest   IInteractionRequest</code>     <code>Raise</code> ,           , , ,   . <br> <br>       <br>  <code>InteractionRequest          .  Raise</code>          ( <code>T</code> )    ,    ,   .          ,       .      ,        .    ,  ,     . <br> <code class="cs">public interface IInteractionRequest { event EventHandler&lt;InteractionRequestedEventArgs&gt; Raised; } public class InteractionRequest&lt;T&gt; : IInteractionRequest { public event EventHandler&lt;InteractionRequestedEventArgs&gt; Raised; public void Raise(T context, Action&lt;T&gt; callback) { var handler = this.Raised; if (handler != null) { handler( this, new InteractionRequestedEventArgs(context, () =&gt; callback(context))); } } }</code> <br> Prism    ,      .  <code>Notification</code>       .    ,            .     ‚Äì <code>Title</code>  <code>Content</code> ,    .  ,   ,  ,  ,        . <br> <br>  <code>Confirmation</code>    <code>Notification</code>     ‚Äì <code>Confirmed</code> ,  ,  ,      .  <code>Confirmation</code> ,     <code>MessageBox</code> ,     /  .     ,     <code>Notification</code> ,     ,      . <br> <br>    <code>InteractionRequest ,       InteractionRequest      ,      .      ,    Raise</code> ,    , ,   . <br> <br> <code class="cs">public IInteractionRequest ConfirmCancelInteractionRequest { get { return this.confirmCancelInteractionRequest; } } this.confirmCancelInteractionRequest.Raise( new Confirmation("Are you sure you wish to cancel?"), confirmation =&gt; { if (confirmation.Confirmed) { this.NavigateToQuestionnaireList(); } }); }</code> <br> <i>MVVM Reference Implementation (MVVM RI)</i> ,    <code>IInteractionRequest</code>   <code>InteractionRequest ,          (. QuestionnaireViewModel.cs</code> ). <br> <br>        <br>       ,       .   ,       .    UI             . <br> <br>                . Microsoft Expression Blend Behaviors Framework     .  ,     ,    . <br> <br>  <code>EventTrigger</code> ,  Expression Blend,  ,      ,     ,   . , Prism   <code>EventTrigger</code> ,  <code>InteractionRequestTrigger</code> ,      <code>Raised</code>   <code>IInteractionRequest</code> .    XAML        . <br> <br>  ,   , <code>InteractionRequestTrigger</code>   .  Silverlight Prism   <code>PopupChildWindowAction</code> ,     .    ,         .   <code>ContentTemplate</code>  <code>PopupChildWindowAction</code> ,    ,    UI,      <code>Content</code>  .       <code>Title</code>  . <br> <b></b> <br>  ,    ,   <code>PopupChildWindowAction</code> ,     .    <code>Notification</code>  <code>NotificationChildWindow</code> ,        <code>Confirmation</code> ‚Äì <code>ConfirmationChildWindow</code> . <code>NotificationChildWindow</code>    ,   ,     <code>ConfirmationChildWindow</code>    <i>OK</i>  <i>Cancel</i> ,    .    ,   ,   <code>ChildWindow</code>  <code>PopupChildWindowAction</code> . <br>   ,  <code>InteractionRequestTrigger</code>  <code>PopupChildWindowAction</code> ,       <i>RI MVVM</i> . <br> <br> <code class="xml">&lt;i:Interaction.Triggers&gt; &lt;prism:InteractionRequestTrigger SourceObject="{Binding ConfirmCancelInteractionRequest}"&gt; &lt;prism:PopupChildWindowAction ContentTemplate="{StaticResource ConfirmWindowTemplate}"/&gt; &lt;/prism:InteractionRequestTrigger&gt; &lt;/i:Interaction.Triggers&gt; &lt;UserControl.Resources&gt; &lt;DataTemplate x:Key="ConfirmWindowTemplate"&gt; &lt;Grid MinWidth="250" MinHeight="100"&gt; &lt;TextBlock TextWrapping="Wrap" Grid.Row="0" Text="{Binding}"/&gt; &lt;/Grid&gt; &lt;/DataTemplate&gt; &lt;/UserControl.Resources&gt;</code> <br> <b></b> <br>      <code>ContentTemplate</code> ,   UI   <code>Content</code>  .    <code>Content</code>  ,  , <code>TextBlock</code>     <code>Content</code> . <br>      ,     ,    ,    .  ,     ,       ,     ,    .   ,   <i>RI MVVM</i> ,         <code>Confirmed</code>    <code>Confirmation</code>  <code>true</code> ,     OK. <br> <br>        ,     .  Prism <code>InteractionRequestTrigger</code>   <code>PopupChildWindowAction</code>            . <br> <br>     <br>     MVVM,       , ,    ,         .        (  , ,  ,   ).    ,  ,  ,            . <br> <br>        ,         . Managed Extensibility Framework (MEF)  Unity Application Block (Unity)      ,  ,           . <br> <br>  ,       , , ,    ( )      . ,       ,     .  ,     ,       . <br> <br>     ,  MEF <br>  MEF,       ,   <code>Import</code> ,      ,  ,   <code>Export</code> .         ,    . <br> <br> , <code>QuestionnaireView</code>   <i>RI MVVM</i> ,        ,    <code>Import</code> .   , MEF           .  <code>set</code>        ,   . <br> <br> <code class="cs">[Import] public QuestionnaireViewModel ViewModel { set { this.DataContext = value; } }</code> <br>     ,   . <br> <br> <code class="cs">[Export] public class QuestionnaireViewModel : NotificationObject { ... }</code> <br>        ,   . <br> <br> <code class="cs">public QuestionnaireView() { InitializeComponent(); } [ImportingConstructor] public QuestionnaireView(QuestionnaireViewModel viewModel) : this() { this.DataContext = viewModel; }</code> <br> <b></b> <br>          MEF,   Unity.   ,     ,        .   ,   Visual Studio  Expression Blend, ,        ,     .   ,   ,  ,      ,          <code>InitializeComponent</code> . <br>     ,  Unity <br>  Unity,    ,   MEF.     ,      .    ,         .  ,      . <br> <br>  ,      ,  ,         . ,           ,   . <br> <br> <code class="cs">public QuestionnaireView() { InitializeComponent(); } public QuestionnaireView(QuestionnaireViewModel viewModel) : this() { this.DataContext = viewModel; }</code> <br> <b></b> <br>    ,        ,   Visual Studio  Expression Blend. <br>  ,          ,   . Unity        <code>set</code>   ,   . <br> <br> <code class="cs">public QuestionnaireView() { InitializeComponent(); } [Dependency] public QuestionnaireViewModel ViewModel { set { this.DataContext = value; } }</code> <br>       Unity. <br> <br> <code class="cs">container.RegisterType&lt;QuestionnaireViewModel&gt;();</code> <br>  ,     . <br> <br> <code class="cs">var view = container.Resolve&lt;QuestionnaireView&gt;();</code> <br>     ,    <br>   ,     ,        .        ,   MEF  Unity,        . <br> <br>          .   ,         UI,           . <br> <br> , <i>RI MVVM</i>   ,   ,        .   ,    .      <code>ShowView</code>   UI. <br> <br> <code class="cs">private void NavigateToQuestionnaireList() { //     "questionnaire list". this.uiService.ShowView(ViewNames.QuestionnaireTemplatesList); }</code> <br>  UI      UI .           UI.  <code>ShowView</code>  <code>UIService</code>      (,          ),       ,   . <br> <br> <code class="cs">public void ShowView(string viewName) { var view = this.ViewFactory.GetView(viewName); this.MainWindow.CurrentView = view; }</code> <br> <b></b> <br> Prism       .   ,   ,   ,             .    ,  , " <a href="http://msdn.microsoft.com/en-us/library/gg430861(v%3DPandP.40).aspx">View-Based Navigation</a> "   8, " <a href="http://msdn.microsoft.com/en-us/library/gg430861(v%3DPandP.40).aspx">Navigation</a> ". <br>  MVVM  <br>        MVVM      .           -      mocking . ,   ,        . <br> <br>   <i>INotifyPropertyChanged</i> <br>   <code>INotifyPropertyChanged</code>     ,      .      ,    ;   ,   ,     ,    ,       . <br> <br>   <br> ,       ,           <code>PropertyChanged</code>  ,         .  ,    <code>ChangeTracker</code> ,     MVVM,  ,      .      .     ,    . <br> <br> <code class="cs">var changeTracker = new PropertyChangeTracker(viewModel); viewModel.CurrentState = "newState"; CollectionAssert.Contains(changeTracker.ChangedProperties, "CurrentState");</code> <br> ,     ,     <code>INotifyPropertyChanged</code> ,    ,   ,     . <br> <br>      <br>        ,   ,    <code>set</code>      ,           . ,     ,     ,      ,          . <br> <br> <code class="cs">var changeTracker = new PropertyChangeTracker(viewModel); var question = viewModel.Questions.First() as OpenQuestionViewModel; question.Question.Response = "some text"; CollectionAssert.Contains(changeTracker.ChangedProperties, "UnansweredQuestions");</code> <br>      <br>     <code>INotifyPropertyChanged</code> ,      <code>PropertyChanged</code>        ,  ,     , , .        ,       . <br> <br>   <i>INotifyDataErrorInfo</i> <br>   ,     ,    ,   ,   <code>IDataErrorInfo</code> ,  ( Silverlight)   <code>INotifyDataErrorInfo</code> .   <code>INotifyDataErrorInfo</code>   ,         ,    ,  ,   ,    . <br> <br>       <code>INotifyDataErrorInfo</code> : ,     ,  ,     ,     <code>ErrorsChanged</code> ,      <code>GetErrors</code> , . <br> <br>    <br>     ,      ,     .       ,         <code>GetErrors</code>       ,  ,  ,   .    , ,  ,     ,        .   ,        . <br> <br> <code class="cs">//  . var notifyErrorInfo = (INotifyDataErrorInfo)question; question.Response = -15; Assert.IsTrue(notifyErrorInfo.GetErrors("Response").Cast&lt;ValidationResult&gt;().Any()); //  . var notifyErrorInfo = (INotifyDataErrorInfo)question; question.Response = 15; Assert.IsFalse(notifyErrorInfo.GetErrors("Response").Cast&lt;ValidationResult&gt;().Any());</code> <br>    ,    ,             . <br> <br>    <i>INotifyDataErrorInfo</i> <br>       <code>GetErrors</code> ,   <code>INotifyDataErrorInfo</code>  ,   <code>ErrorsChanged</code>      <code>GetErrors</code> . ,  <code>HasErrors</code>      ,  . <br> <br>       <code>INotifyDataErrorInfo</code> . , ,           ,   -  .      ,        <code>INotifyDataErrorInfo</code>         (,        ). <br> <br>     ,   ,  : <br>  <code>HasErrors</code>     .              ,       .  <code>ErrorsChanged</code> ,      ,         <code>GetErrors</code> .         ( ,  )     ,           .    <code>GetErrors</code>       <code>ErrorsChanged</code> . <br>    <code>INotifyPropertyChanged</code> ,  ,    <code>NotifyDataErrorInfoTestHelper</code>    MVVM,        <code>INotifyDataErrorInfo</code> ,       .   ,   ,      ,   .      . <br> <code class="cs">var helper = new NotifyDataErrorInfoTestHelper&lt;NumericQuestion, int?&gt;( question, q =&gt; q.Response); helper.ValidatePropertyChange( 6, NotifyDataErrorInfoBehavior.Nothing); helper.ValidatePropertyChange( 20, NotifyDataErrorInfoBehavior.FiresErrorsChanged | NotifyDataErrorInfoBehavior.HasErrors | NotifyDataErrorInfoBehavior.HasErrorsForProperty); helper.ValidatePropertyChange( null, NotifyDataErrorInfoBehavior.FiresErrorsChanged | NotifyDataErrorInfoBehavior.HasErrors | NotifyDataErrorInfoBehavior.HasErrorsForProperty); helper.ValidatePropertyChange( 2, NotifyDataErrorInfoBehavior.FiresErrorsChanged);</code> <br>     <br>   MVVM,     ,  .   ,    ,         . <br> <br>  ,     ,     ,       .   ,   , ,       ,     ,   <code>IAsyncResult</code>    ,  - ,   ,    UI. <br> <br>       , , ,    .   ,     .  ,      UI,     ,   ,          ,     ,        "   UI." <br> <br>     ,    ,    .   ,    ,     mock-, ,   ,   ,      ,          . <br> <br>           UI,    ,    .   ,     ,   ,      .        ,   .     ,    ,     . <br> <br> <code class="cs">questionnaireRepositoryMock .Setup( r =&gt; r.SubmitQuestionnaireAsync( It.IsAny&lt;Questionnaire&gt;(), It.IsAny&lt;Action&lt;IOperationResult&gt;&gt;())) .Callback&lt;Questionnaire, Action&lt;IOperationResult&gt;&gt;( (q, a) =&gt; callback = a); uiServicemock .Setup(svc =&gt; svc.ShowView(ViewNames.QuestionnaireTemplatesList)) .Callback&lt;string&gt;(viewName =&gt; requestedViewName = viewName); submitResultMock .Setup(sr =&gt; sr.Error) .Returns&lt;Exception&gt;(null); CompleteQuestionnaire(viewModel); viewModel.Submit(); //      UI . callback(submitResultMock.Object); //    ‚Äì     . Assert.AreEqual(ViewNames.QuestionnaireTemplatesList, requestedViewName);</code> <br> <b></b> <br>          ,        . <br>   <br>       , . "Trees in WPF"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ms753391.aspx">http://msdn.microsoft.com/en-us/library/ms753391.aspx</a> <br> <br>       , . "Attached Properties Overview"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/cc265152(VS.95).aspx">http://msdn.microsoft.com/en-us/library/cc265152(VS.95).aspx</a> <br> <br>      MEF, ."Managed Extensibility Framework Overview"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/dd460648.aspx">http://msdn.microsoft.com/en-us/library/dd460648.aspx</a> . <br> <br>      Unity, ."Unity Application Block"  MSDN: <a href="http://www.msdn.com/unity">http://www.msdn.com/unity</a> . <br> <br>      <code>DelegateCommand</code> , .Chapter 5, " <a href="http://msdn.microsoft.com/en-us/library/gg405484(v%3DPandP.40).aspx">Implementing the MVVM Pattern</a> ." <br> <br>        Microsoft Expression Blend, ."Working with built-in behaviors"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ff724013(v%3DExpression.40).aspx">http://msdn.microsoft.com/en-us/library/ff724013(v=Expression.40).aspx</a> . <br> <br>          Microsoft Expression Blend, ."Creating Custom Behaviors"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ff724708(v%3DExpression.40).aspx">http://msdn.microsoft.com/en-us/library/ff724708(v=Expression.40).aspx</a> . <br> <br>            Microsoft Expression Blend, ."Creating Custom Triggers and Actions"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ff724707(v%3DExpression.40).aspx">http://msdn.microsoft.com/en-us/library/ff724707(v=Expression.40).aspx</a> . <br> <br>         WPF  Silverlight, ."Threading Model"  "The Dispatcher Class"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ms741870.aspx">http://msdn.microsoft.com/en-us/library/ms741870.aspx</a> <br> <a href="http://msdn.microsoft.com/en-us/library/ms615907(v%3DVS.95).aspx">http://msdn.microsoft.com/en-us/library/ms615907(v=VS.95).aspx</a> . <br> <br>      unit-  Silverlight, ."Unit Testing with Silverlight 2": <a href="http://www.jeff.wilcox.name/2008/03/silverlight2-unit-testing/">http://www.jeff.wilcox.name/2008/03/silverlight2-unit-testing/</a> . <br> <br>         , .  " <a href="http://msdn.microsoft.com/en-us/library/gg430861(v%3DPandP.40).aspx">View-Based Navigation</a> " in Chapter 8, " <a href="http://msdn.microsoft.com/en-us/library/gg430861(v%3DPandP.40).aspx">Navigation</a> ." <br> <br>       ,   , ."Event-based Asynchronous Pattern Overview"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/wewwczdw.aspx">http://msdn.microsoft.com/en-us/library/wewwczdw.aspx</a> <br> <br>        <code>IAsyncResult</code> , ."Asynchronous Programming Overview"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ms228963.aspx">http://msdn.microsoft.com/en-us/library/ms228963.aspx</a></code></code></code></code></code></code></code></code></code> <pre> <code class="hljs cmake"><code>CommandBehaviorBase ,    ,    ICommand</code> .           <code>CanExecuteChanged</code> ,          Silverlight,    WPF. <br> <br>    ,  ,   <code><code>CommandBehaviorBase    ,    .         ,      .         ,    .      ButtonBaseClickCommandBehavior</code> . <br> <br> <code class="cs">public class ButtonBaseClickCommandBehavior : CommandBehaviorBase&lt;ButtonBase&gt; { public ButtonBaseClickCommandBehavior(ButtonBase clickableObject) : base(clickableObject) { clickableObject.Click += OnClick; } private void OnClick(object sender, System.Windows.RoutedEventArgs e) { ExecuteCommand(); } }</code> <br>   <code><code>CommandBehaviorBase ,     .     ,          ,   . ,    ,    ,      , ,    CanExecute</code>  ,     . <br> <br>          ,   .           XAML.           .       .  Prism      ,       ,  ,   .       ,    . , ,  ,      <code>Click</code> ,       <code><span class="hljs-keyword"><span class="hljs-keyword">Command</span></span></code> .    <code>Click.<span class="hljs-keyword"><span class="hljs-keyword">Command</span></span></code> ,  . <br> <br>             .             . <br> <br> <code class="cs">public static readonly DependencyProperty CommandProperty = DependencyProperty.RegisterAttached( <span class="hljs-string"><span class="hljs-string">"Command"</span></span>, typeof(ICommand), typeof(Click), new PropertyMetadata(OnSetCommandCallback)); private static readonly DependencyProperty ClickCommandBehaviorProperty = DependencyProperty.RegisterAttached( <span class="hljs-string"><span class="hljs-string">"ClickCommandBehavior"</span></span>, typeof(ButtonBaseClickCommandBehavior), typeof(Click), null);</code> <br>    <code><span class="hljs-keyword"><span class="hljs-keyword">Command</span></span></code>    <code>ButtonBaseClickCommandBehavior</code> ,     <code>OnSetCommandCallback</code> ,     . <br> <br> <code class="cs">private static void OnSetCommandCallback(DependencyObject dependencyObject, DependencyPropertyChangedEventArgs e) { ButtonBase buttonBase = dependencyObject as ButtonBase; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (buttonBase != null) { ButtonBaseClickCommandBehavior behavior = GetOrCreateBehavior(buttonBase); behavior.<span class="hljs-keyword"><span class="hljs-keyword">Command</span></span> = e.NewValue as ICommand; } } private static void OnSetCommandParameterCallback(DependencyObject dependencyObject, DependencyPropertyChangedEventArgs e) { ButtonBase buttonBase = dependencyObject as ButtonBase; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (buttonBase != null) { ButtonBaseClickCommandBehavior behavior = GetOrCreateBehavior(buttonBase); behavior.CommandParameter = e.NewValue; } } private static ButtonBaseClickCommandBehavior GetOrCreateBehavior(ButtonBase buttonBase ) { ButtonBaseClickCommandBehavior behavior = buttonBase.GetValue(ClickCommandBehaviorProperty) as ButtonBaseClickCommandBehavior; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ( behavior == null ) { behavior = new ButtonBaseClickCommandBehavior(buttonBase); buttonBase.SetValue(ClickCommandBehaviorProperty, behavior); } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> behavior; }</code> <br>        ,  <a href="http://msdn.microsoft.com/en-us/library/cc265152(VS.95).aspx">Attached Properties Overview</a>  MSDN. <br> <br>    <br>              . ,     Silverlight,    -,     ,      ,     .     ,       . <br> <br>        ,    ( )  ,  ,     .  UI       ,            UI. <br> <br>      - <br>   -     ,       <code>IAsyncResult</code> .   ,  ,   ,  <code>GetQuestionnaire</code> ,   : <code>BeginGetQuestionnaire</code>  <code>EndGetQuestionnaire</code> .    ,   <code>BeginGetQuestionnaire</code> .     ,   ,   <code>EndGetQuestionnaire</code>    . <br> <b></b> <br>  .NET Framework <span class="hljs-number"><span class="hljs-number">4.5</span></span>      <code>await</code>  <code>async</code>     <code>*Async</code> .      <a href="http://msdn.microsoft.com/en-us/library/vstudio/hh391443.aspx"><span class="hljs-string"><span class="hljs-string">"Asynchronous Programming with Async and Await (C# and Visual Basic)"</span></span></a> . <br>  ,    <code>EndGetQuestionnaire</code> ,      ,  ()      <code>BeginGetQuestionnaire</code> .     ,      ,   <code>EndGetQuestionnaire</code> ,   . <br> <br> <code class="xml">IAsyncResult asyncResult = this.service.BeginGetQuestionnaire( GetQuestionnaireCompleted, null //  ,      ); private void GetQuestionnaireCompleted(IAsyncResult result) { try { questionnaire = this.service.EndGetQuestionnaire(ar); } catch (Exception ex) { //  -   . } }</code> <br>  ,     <code>End*</code> (  , <code>EndGetQuestionnaire</code> ),    ,      .      , ,          UI.     ,   ,        . <br> <br>        UI,     -,      UI,         UI,   <code>Dispatcher</code>    <code>SynchronizationContext</code> .  WPF  Silverlight,   <code>Dispatcher</code> . <br> <br>      <code>Questionnaire</code>  ,        <code>QuestionnaireView</code> .  Silverlight    <code>CheckAccess</code> ,  ,      UI.  ,     <code>BeginInvoke</code> ,      UI. <br> <br> <code class="cs">var dispatcher = System.Windows.Deployment.Current.Dispatcher; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (dispatcher.CheckAccess()) { QuestionnaireView.DataContext = questionnaire; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { dispatcher.BeginInvoke(() =&gt; { Questionnaire.DataContext = questionnaire; }); }</code> <br> <i>MVVM RI</i>   ,    ,   <code>IAsyncResult</code> ,   .      ,                 . ,       . <br> <br> <code class="cs">this.questionnaireRepository.GetQuestionnaireAsync( result =&gt; { this.Questionnaire = result.Result; });</code> <br>  <code>result</code>   ,     , , , .    ,     . <br> <br> <code class="cs">this.questionnaireRepository.GetQuestionnaireAsync( result =&gt; { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (result.Error == null) { this.Questionnaire = result.Result; ... } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { // Handle error. } })</code> <br>     <br>        ,      .     , ,             .        ,      ,     ,     . <br> <br>         ,      MVVM,     ,   . ,  -MVVM ,     <code>MessageBox</code>   code-behind UI,      .   MVVM     ,          . <br> <br>     MVVM,              ,          .      ,    ,   ,  ,     . <br> <br>              MVVM.      ,     ,     ,  ,     .    ,         ,     ,          .       . <br> <br>    <br>                  .        ,        .  ,         .         . <br> <br>  ,         ,         ,  .      ,     .           ,       . ,        WPF  Silverlight,        . <br> <br> <img title="Using the service to interact with the user." src="https://habrastorage.org/getpro/habr/post_images/4b5/397/f2d/4b5397f2d02e5851195b29f1893be6fc.png" alt=" ,    ."> <br> <br>  ,   <code>MessageBox</code>        ,     ,    ,     . <br> <br> <code class="cs">var result = interactionService.ShowMessageBox( <span class="hljs-string"><span class="hljs-string">"Are you sure you want to cancel this operation?"</span></span>, <span class="hljs-string"><span class="hljs-string">"Confirm"</span></span>, MessageBoxButton.OK); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (result == MessageBoxResult.Yes) { CancelRequest(); }</code> <br> ,      - ,      ,         Silverlight.         .             .     . <br> <br> <code class="cs">interactionService.ShowMessageBox( <span class="hljs-string"><span class="hljs-string">"Are you sure you want to cancel this operation?"</span></span>, <span class="hljs-string"><span class="hljs-string">"Confirm"</span></span>, MessageBoxButton.OK, result =&gt; { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (result == MessageBoxResult.Yes) { CancelRequest(); } });</code> <br>         ,      . ,  WPF    <code>MessageBox</code> ,       ;    Silverlight    ,    . <br> <br>     <br>         ‚Äì             .         ,      .     ,     .        ,        ,   ,     . <br> <br> <img title="Using interaction request objects." src="https://habrastorage.org/getpro/habr/post_images/3d0/ff0/1c5/3d0ff01c5518558c2d3c5c5f47ce0ce9.png" alt="   ."> <br> <br>    ,   ,          ‚Äì       ,      ,   ‚Äì     .   ,        ,    ,    UI            . <br> <br>       MVVM,     ,       ,         .         ,        ,    ,   . <br> <br>  Prism       <code>IInteractionRequest</code>   <code><code>InteractionRequest .  IInteractionRequest</code>  ,   .           ,   .  <code><code>InteractionRequest   IInteractionRequest</code>     <code>Raise</code> ,           , , ,   . <br> <br>       <br>  <code><code>InteractionRequest          .  Raise</code>          ( <code>T</code> )    ,    ,   .          ,       .      ,        .    ,  ,     . <br> <code class="cs">public interface IInteractionRequest { event EventHandler&lt;InteractionRequestedEventArgs&gt; Raised; } public class InteractionRequest&lt;T&gt; : IInteractionRequest { public event EventHandler&lt;InteractionRequestedEventArgs&gt; Raised; public void Raise(T context, Action&lt;T&gt; callback) { var handler = this.Raised; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (handler != null) { handler( this, new InteractionRequestedEventArgs(context, () =&gt; callback(context))); } } }</code> <br> Prism    ,      .  <code>Notification</code>       .    ,            .     ‚Äì <code>Title</code>  <code>Content</code> ,    .  ,   ,  ,  ,        . <br> <br>  <code>Confirmation</code>    <code>Notification</code>     ‚Äì <code>Confirmed</code> ,  ,  ,      .  <code>Confirmation</code> ,     <code>MessageBox</code> ,     /  .     ,     <code>Notification</code> ,     ,      . <br> <br>    <code><code><code>InteractionRequest ,       InteractionRequest      ,      .      ,    Raise</code> ,    , ,   . <br> <br> <code class="cs">public IInteractionRequest ConfirmCancelInteractionRequest { get { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> this.confirmCancelInteractionRequest; } } this.confirmCancelInteractionRequest.Raise( new Confirmation(<span class="hljs-string"><span class="hljs-string">"Are you sure you wish to cancel?"</span></span>), confirmation =&gt; { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (confirmation.Confirmed) { this.NavigateToQuestionnaireList(); } }); }</code> <br> <i>MVVM Reference Implementation (MVVM RI)</i> ,    <code>IInteractionRequest</code>   <code><code>InteractionRequest ,          (. QuestionnaireViewModel.cs</code> ). <br> <br>        <br>       ,       .   ,       .    UI             . <br> <br>                . Microsoft Expression Blend Behaviors Framework     .  ,     ,    . <br> <br>  <code>EventTrigger</code> ,  Expression Blend,  ,      ,     ,   . , Prism   <code>EventTrigger</code> ,  <code>InteractionRequestTrigger</code> ,      <code>Raised</code>   <code>IInteractionRequest</code> .    XAML        . <br> <br>  ,   , <code>InteractionRequestTrigger</code>   .  Silverlight Prism   <code>PopupChildWindowAction</code> ,     .    ,         .   <code>ContentTemplate</code>  <code>PopupChildWindowAction</code> ,    ,    UI,      <code>Content</code>  .       <code>Title</code>  . <br> <b></b> <br>  ,    ,   <code>PopupChildWindowAction</code> ,     .    <code>Notification</code>  <code>NotificationChildWindow</code> ,        <code>Confirmation</code> ‚Äì <code>ConfirmationChildWindow</code> . <code>NotificationChildWindow</code>    ,   ,     <code>ConfirmationChildWindow</code>    <i>OK</i>  <i>Cancel</i> ,    .    ,   ,   <code>ChildWindow</code>  <code>PopupChildWindowAction</code> . <br>   ,  <code>InteractionRequestTrigger</code>  <code>PopupChildWindowAction</code> ,       <i>RI MVVM</i> . <br> <br> <code class="xml">&lt;i:Interaction.Triggers&gt; &lt;prism:InteractionRequestTrigger SourceObject=<span class="hljs-string"><span class="hljs-string">"{Binding ConfirmCancelInteractionRequest}"</span></span>&gt; &lt;prism:PopupChildWindowAction ContentTemplate=<span class="hljs-string"><span class="hljs-string">"{StaticResource ConfirmWindowTemplate}"</span></span>/&gt; &lt;/prism:InteractionRequestTrigger&gt; &lt;/i:Interaction.Triggers&gt; &lt;UserControl.Resources&gt; &lt;DataTemplate x:Key=<span class="hljs-string"><span class="hljs-string">"ConfirmWindowTemplate"</span></span>&gt; &lt;Grid MinWidth=<span class="hljs-string"><span class="hljs-string">"250"</span></span> MinHeight=<span class="hljs-string"><span class="hljs-string">"100"</span></span>&gt; &lt;TextBlock TextWrapping=<span class="hljs-string"><span class="hljs-string">"Wrap"</span></span> Grid.Row=<span class="hljs-string"><span class="hljs-string">"0"</span></span> Text=<span class="hljs-string"><span class="hljs-string">"{Binding}"</span></span>/&gt; &lt;/Grid&gt; &lt;/DataTemplate&gt; &lt;/UserControl.Resources&gt;</code> <br> <b></b> <br>      <code>ContentTemplate</code> ,   UI   <code>Content</code>  .    <code>Content</code>  ,  , <code>TextBlock</code>     <code>Content</code> . <br>      ,     ,    ,    .  ,     ,       ,     ,    .   ,   <i>RI MVVM</i> ,         <code>Confirmed</code>    <code>Confirmation</code>  <code><span class="hljs-keyword"><span class="hljs-keyword">true</span></span></code> ,     OK. <br> <br>        ,     .  Prism <code>InteractionRequestTrigger</code>   <code>PopupChildWindowAction</code>            . <br> <br>     <br>     MVVM,       , ,    ,         .        (  , ,  ,   ).    ,  ,  ,            . <br> <br>        ,         . Managed Extensibility Framework (MEF)  Unity Application Block (Unity)      ,  ,           . <br> <br>  ,       , , ,    ( )      . ,       ,     .  ,     ,       . <br> <br>     ,  MEF <br>  MEF,       ,   <code>Import</code> ,      ,  ,   <code><span class="hljs-keyword"><span class="hljs-keyword">Export</span></span></code> .         ,    . <br> <br> , <code>QuestionnaireView</code>   <i>RI MVVM</i> ,        ,    <code>Import</code> .   , MEF           .  <code><span class="hljs-keyword"><span class="hljs-keyword">set</span></span></code>        ,   . <br> <br> <code class="cs">[Import] public QuestionnaireViewModel ViewModel { <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> { this.DataContext = value; } }</code> <br>     ,   . <br> <br> <code class="cs">[<span class="hljs-keyword"><span class="hljs-keyword">Export</span></span>] public class QuestionnaireViewModel : NotificationObject { ... }</code> <br>        ,   . <br> <br> <code class="cs">public QuestionnaireView() { InitializeComponent(); } [ImportingConstructor] public QuestionnaireView(QuestionnaireViewModel viewModel) : this() { this.DataContext = viewModel; }</code> <br> <b></b> <br>          MEF,   Unity.   ,     ,        .   ,   Visual Studio  Expression Blend, ,        ,     .   ,   ,  ,      ,          <code>InitializeComponent</code> . <br>     ,  Unity <br>  Unity,    ,   MEF.     ,      .    ,         .  ,      . <br> <br>  ,      ,  ,         . ,           ,   . <br> <br> <code class="cs">public QuestionnaireView() { InitializeComponent(); } public QuestionnaireView(QuestionnaireViewModel viewModel) : this() { this.DataContext = viewModel; }</code> <br> <b></b> <br>    ,        ,   Visual Studio  Expression Blend. <br>  ,          ,   . Unity        <code><span class="hljs-keyword"><span class="hljs-keyword">set</span></span></code>   ,   . <br> <br> <code class="cs">public QuestionnaireView() { InitializeComponent(); } [Dependency] public QuestionnaireViewModel ViewModel { <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> { this.DataContext = value; } }</code> <br>       Unity. <br> <br> <code class="cs">container.RegisterType&lt;QuestionnaireViewModel&gt;();</code> <br>  ,     . <br> <br> <code class="cs">var view = container.Resolve&lt;QuestionnaireView&gt;();</code> <br>     ,    <br>   ,     ,        .        ,   MEF  Unity,        . <br> <br>          .   ,         UI,           . <br> <br> , <i>RI MVVM</i>   ,   ,        .   ,    .      <code>ShowView</code>   UI. <br> <br> <code class="cs">private void NavigateToQuestionnaireList() { //     <span class="hljs-string"><span class="hljs-string">"questionnaire list"</span></span>. this.uiService.ShowView(ViewNames.QuestionnaireTemplatesList); }</code> <br>  UI      UI .           UI.  <code>ShowView</code>  <code>UIService</code>      (,          ),       ,   . <br> <br> <code class="cs">public void ShowView(<span class="hljs-keyword"><span class="hljs-keyword">string</span></span> viewName) { var view = this.ViewFactory.GetView(viewName); this.MainWindow.CurrentView = view; }</code> <br> <b></b> <br> Prism       .   ,   ,   ,             .    ,  , <span class="hljs-string"><span class="hljs-string">" </span></span><a href="http://msdn.microsoft.com/en-us/library/gg430861(v%3DPandP.40).aspx"><span class="hljs-string"><span class="hljs-string">View-Based Navigation</span></span></a><span class="hljs-string"><span class="hljs-string"> "</span></span>   <span class="hljs-number"><span class="hljs-number">8</span></span>, <span class="hljs-string"><span class="hljs-string">" </span></span><a href="http://msdn.microsoft.com/en-us/library/gg430861(v%3DPandP.40).aspx"><span class="hljs-string"><span class="hljs-string">Navigation</span></span></a><span class="hljs-string"><span class="hljs-string"> "</span></span>. <br>  MVVM  <br>        MVVM      .           -      mocking . ,   ,        . <br> <br>   <i>INotifyPropertyChanged</i> <br>   <code>INotifyPropertyChanged</code>     ,      .      ,    ;   ,   ,     ,    ,       . <br> <br>   <br> ,       ,           <code>PropertyChanged</code>  ,         .  ,    <code>ChangeTracker</code> ,     MVVM,  ,      .      .     ,    . <br> <br> <code class="cs">var changeTracker = new PropertyChangeTracker(viewModel); viewModel.CurrentState = <span class="hljs-string"><span class="hljs-string">"newState"</span></span>; CollectionAssert.Contains(changeTracker.ChangedProperties, <span class="hljs-string"><span class="hljs-string">"CurrentState"</span></span>);</code> <br> ,     ,     <code>INotifyPropertyChanged</code> ,    ,   ,     . <br> <br>      <br>        ,   ,    <code><span class="hljs-keyword"><span class="hljs-keyword">set</span></span></code>      ,           . ,     ,     ,      ,          . <br> <br> <code class="cs">var changeTracker = new PropertyChangeTracker(viewModel); var question = viewModel.Questions.First() as OpenQuestionViewModel; question.Question.Response = <span class="hljs-string"><span class="hljs-string">"some text"</span></span>; CollectionAssert.Contains(changeTracker.ChangedProperties, <span class="hljs-string"><span class="hljs-string">"UnansweredQuestions"</span></span>);</code> <br>      <br>     <code>INotifyPropertyChanged</code> ,      <code>PropertyChanged</code>        ,  ,     , , .        ,       . <br> <br>   <i>INotifyDataErrorInfo</i> <br>   ,     ,    ,   ,   <code>IDataErrorInfo</code> ,  ( Silverlight)   <code>INotifyDataErrorInfo</code> .   <code>INotifyDataErrorInfo</code>   ,         ,    ,  ,   ,    . <br> <br>       <code>INotifyDataErrorInfo</code> : ,     ,  ,     ,     <code>ErrorsChanged</code> ,      <code>GetErrors</code> , . <br> <br>    <br>     ,      ,     .       ,         <code>GetErrors</code>       ,  ,  ,   .    , ,  ,     ,        .   ,        . <br> <br> <code class="cs">//  . var notifyErrorInfo = (INotifyDataErrorInfo)question; question.Response = -<span class="hljs-number"><span class="hljs-number">15</span></span>; Assert.IsTrue(notifyErrorInfo.GetErrors(<span class="hljs-string"><span class="hljs-string">"Response"</span></span>).Cast&lt;ValidationResult&gt;().Any()); //  . var notifyErrorInfo = (INotifyDataErrorInfo)question; question.Response = <span class="hljs-number"><span class="hljs-number">15</span></span>; Assert.IsFalse(notifyErrorInfo.GetErrors(<span class="hljs-string"><span class="hljs-string">"Response"</span></span>).Cast&lt;ValidationResult&gt;().Any());</code> <br>    ,    ,             . <br> <br>    <i>INotifyDataErrorInfo</i> <br>       <code>GetErrors</code> ,   <code>INotifyDataErrorInfo</code>  ,   <code>ErrorsChanged</code>      <code>GetErrors</code> . ,  <code>HasErrors</code>      ,  . <br> <br>       <code>INotifyDataErrorInfo</code> . , ,           ,   -  .      ,        <code>INotifyDataErrorInfo</code>         (,        ). <br> <br>     ,   ,  : <br>  <code>HasErrors</code>     .              ,       .  <code>ErrorsChanged</code> ,      ,         <code>GetErrors</code> .         ( ,  )     ,           .    <code>GetErrors</code>       <code>ErrorsChanged</code> . <br>    <code>INotifyPropertyChanged</code> ,  ,    <code>NotifyDataErrorInfoTestHelper</code>    MVVM,        <code>INotifyDataErrorInfo</code> ,       .   ,   ,      ,   .      . <br> <code class="cs">var helper = new NotifyDataErrorInfoTestHelper&lt;NumericQuestion, int?&gt;( question, q =&gt; q.Response); helper.ValidatePropertyChange( <span class="hljs-number"><span class="hljs-number">6</span></span>, NotifyDataErrorInfoBehavior.Nothing); helper.ValidatePropertyChange( <span class="hljs-number"><span class="hljs-number">20</span></span>, NotifyDataErrorInfoBehavior.FiresErrorsChanged | NotifyDataErrorInfoBehavior.HasErrors | NotifyDataErrorInfoBehavior.HasErrorsForProperty); helper.ValidatePropertyChange( null, NotifyDataErrorInfoBehavior.FiresErrorsChanged | NotifyDataErrorInfoBehavior.HasErrors | NotifyDataErrorInfoBehavior.HasErrorsForProperty); helper.ValidatePropertyChange( <span class="hljs-number"><span class="hljs-number">2</span></span>, NotifyDataErrorInfoBehavior.FiresErrorsChanged);</code> <br>     <br>   MVVM,     ,  .   ,    ,         . <br> <br>  ,     ,     ,       .   ,   , ,       ,     ,   <code>IAsyncResult</code>    ,  - ,   ,    UI. <br> <br>       , , ,    .   ,     .  ,      UI,     ,   ,          ,     ,        <span class="hljs-string"><span class="hljs-string">"   UI."</span></span> <br> <br>     ,    ,    .   ,    ,     mock-, ,   ,   ,      ,          . <br> <br>           UI,    ,    .   ,     ,   ,      .        ,   .     ,    ,     . <br> <br> <code class="cs">questionnaireRepositoryMock .Setup( r =&gt; r.SubmitQuestionnaireAsync( It.IsAny&lt;Questionnaire&gt;(), It.IsAny&lt;Action&lt;IOperationResult&gt;&gt;())) .Callback&lt;Questionnaire, Action&lt;IOperationResult&gt;&gt;( (q, a) =&gt; callback = a); uiServicemock .Setup(svc =&gt; svc.ShowView(ViewNames.QuestionnaireTemplatesList)) .Callback&lt;<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>&gt;(viewName =&gt; requestedViewName = viewName); submitResultMock .Setup(sr =&gt; sr.Error) .Returns&lt;Exception&gt;(null); CompleteQuestionnaire(viewModel); viewModel.Submit(); //      UI . callback(submitResultMock.Object); //    ‚Äì     . Assert.AreEqual(ViewNames.QuestionnaireTemplatesList, requestedViewName);</code> <br> <b></b> <br>          ,        . <br>   <br>       , . <span class="hljs-string"><span class="hljs-string">"Trees in WPF"</span></span>  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ms753391.aspx">http://msdn.microsoft.com/en-us/library/ms753391.aspx</a> <br> <br>       , . <span class="hljs-string"><span class="hljs-string">"Attached Properties Overview"</span></span>  MSDN: <a href="http://msdn.microsoft.com/en-us/library/cc265152(VS.95).aspx">http://msdn.microsoft.com/en-us/library/cc265152(VS.<span class="hljs-number"><span class="hljs-number">95</span></span>).aspx</a> <br> <br>      MEF, .<span class="hljs-string"><span class="hljs-string">"Managed Extensibility Framework Overview"</span></span>  MSDN: <a href="http://msdn.microsoft.com/en-us/library/dd460648.aspx">http://msdn.microsoft.com/en-us/library/dd460648.aspx</a> . <br> <br>      Unity, .<span class="hljs-string"><span class="hljs-string">"Unity Application Block"</span></span>  MSDN: <a href="http://www.msdn.com/unity">http://www.msdn.com/unity</a> . <br> <br>      <code>DelegateCommand</code> , .Chapter <span class="hljs-number"><span class="hljs-number">5</span></span>, <span class="hljs-string"><span class="hljs-string">" </span></span><a href="http://msdn.microsoft.com/en-us/library/gg405484(v%3DPandP.40).aspx"><span class="hljs-string"><span class="hljs-string">Implementing the MVVM Pattern</span></span></a><span class="hljs-string"><span class="hljs-string"> ."</span></span> <br> <br>        Microsoft Expression Blend, .<span class="hljs-string"><span class="hljs-string">"Working with built-in behaviors"</span></span>  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ff724013(v%3DExpression.40).aspx">http://msdn.microsoft.com/en-us/library/ff724013(v=Expression.<span class="hljs-number"><span class="hljs-number">40</span></span>).aspx</a> . <br> <br>          Microsoft Expression Blend, .<span class="hljs-string"><span class="hljs-string">"Creating Custom Behaviors"</span></span>  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ff724708(v%3DExpression.40).aspx">http://msdn.microsoft.com/en-us/library/ff724708(v=Expression.<span class="hljs-number"><span class="hljs-number">40</span></span>).aspx</a> . <br> <br>            Microsoft Expression Blend, .<span class="hljs-string"><span class="hljs-string">"Creating Custom Triggers and Actions"</span></span>  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ff724707(v%3DExpression.40).aspx">http://msdn.microsoft.com/en-us/library/ff724707(v=Expression.<span class="hljs-number"><span class="hljs-number">40</span></span>).aspx</a> . <br> <br>         WPF  Silverlight, .<span class="hljs-string"><span class="hljs-string">"Threading Model"</span></span>  <span class="hljs-string"><span class="hljs-string">"The Dispatcher Class"</span></span>  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ms741870.aspx">http://msdn.microsoft.com/en-us/library/ms741870.aspx</a> <br> <a href="http://msdn.microsoft.com/en-us/library/ms615907(v%3DVS.95).aspx">http://msdn.microsoft.com/en-us/library/ms615907(v=VS.<span class="hljs-number"><span class="hljs-number">95</span></span>).aspx</a> . <br> <br>      unit-  Silverlight, .<span class="hljs-string"><span class="hljs-string">"Unit Testing with Silverlight 2"</span></span>: <a href="http://www.jeff.wilcox.name/2008/03/silverlight2-unit-testing/">http://www.jeff.wilcox.name/<span class="hljs-number"><span class="hljs-number">2008</span></span>/<span class="hljs-number"><span class="hljs-number">03</span></span>/silverlight2-unit-testing/</a> . <br> <br>         , .  <span class="hljs-string"><span class="hljs-string">" </span></span><a href="http://msdn.microsoft.com/en-us/library/gg430861(v%3DPandP.40).aspx"><span class="hljs-string"><span class="hljs-string">View-Based Navigation</span></span></a><span class="hljs-string"><span class="hljs-string"> "</span></span> in Chapter <span class="hljs-number"><span class="hljs-number">8</span></span>, <span class="hljs-string"><span class="hljs-string">" </span></span><a href="http://msdn.microsoft.com/en-us/library/gg430861(v%3DPandP.40).aspx"><span class="hljs-string"><span class="hljs-string">Navigation</span></span></a><span class="hljs-string"><span class="hljs-string"> ."</span></span> <br> <br>       ,   , .<span class="hljs-string"><span class="hljs-string">"Event-based Asynchronous Pattern Overview"</span></span>  MSDN: <a href="http://msdn.microsoft.com/en-us/library/wewwczdw.aspx">http://msdn.microsoft.com/en-us/library/wewwczdw.aspx</a> <br> <br>        <code>IAsyncResult</code> , .<span class="hljs-string"><span class="hljs-string">"Asynchronous Programming Overview"</span></span>  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ms228963.aspx">http://msdn.microsoft.com/en-us/library/ms228963.aspx</a></code></code></code></code></code></code></code></code></code> </pre> <code><code><code><code><code><code><code><code><code><code>CommandBehaviorBase ,    ,    ICommand</code> .           <code>CanExecuteChanged</code> ,          Silverlight,    WPF. <br> <br>    ,  ,   <code>CommandBehaviorBase    ,    .         ,      .         ,    .      ButtonBaseClickCommandBehavior</code> . <br> <br> <code class="cs">public class ButtonBaseClickCommandBehavior : CommandBehaviorBase&lt;ButtonBase&gt; { public ButtonBaseClickCommandBehavior(ButtonBase clickableObject) : base(clickableObject) { clickableObject.Click += OnClick; } private void OnClick(object sender, System.Windows.RoutedEventArgs e) { ExecuteCommand(); } }</code> <br>   <code>CommandBehaviorBase ,     .     ,          ,   . ,    ,    ,      , ,    CanExecute</code>  ,     . <br> <br>          ,   .           XAML.           .       .  Prism      ,       ,  ,   .       ,    . , ,  ,      <code>Click</code> ,       <code>Command</code> .    <code>Click.Command</code> ,  . <br> <br>             .             . <br> <br> <code class="cs">public static readonly DependencyProperty CommandProperty = DependencyProperty.RegisterAttached( "Command", typeof(ICommand), typeof(Click), new PropertyMetadata(OnSetCommandCallback)); private static readonly DependencyProperty ClickCommandBehaviorProperty = DependencyProperty.RegisterAttached( "ClickCommandBehavior", typeof(ButtonBaseClickCommandBehavior), typeof(Click), null);</code> <br>    <code>Command</code>    <code>ButtonBaseClickCommandBehavior</code> ,     <code>OnSetCommandCallback</code> ,     . <br> <br> <code class="cs">private static void OnSetCommandCallback(DependencyObject dependencyObject, DependencyPropertyChangedEventArgs e) { ButtonBase buttonBase = dependencyObject as ButtonBase; if (buttonBase != null) { ButtonBaseClickCommandBehavior behavior = GetOrCreateBehavior(buttonBase); behavior.Command = e.NewValue as ICommand; } } private static void OnSetCommandParameterCallback(DependencyObject dependencyObject, DependencyPropertyChangedEventArgs e) { ButtonBase buttonBase = dependencyObject as ButtonBase; if (buttonBase != null) { ButtonBaseClickCommandBehavior behavior = GetOrCreateBehavior(buttonBase); behavior.CommandParameter = e.NewValue; } } private static ButtonBaseClickCommandBehavior GetOrCreateBehavior(ButtonBase buttonBase ) { ButtonBaseClickCommandBehavior behavior = buttonBase.GetValue(ClickCommandBehaviorProperty) as ButtonBaseClickCommandBehavior; if ( behavior == null ) { behavior = new ButtonBaseClickCommandBehavior(buttonBase); buttonBase.SetValue(ClickCommandBehaviorProperty, behavior); } return behavior; }</code> <br>        ,  <a href="http://msdn.microsoft.com/en-us/library/cc265152(VS.95).aspx">Attached Properties Overview</a>  MSDN. <br> <br>    <br>              . ,     Silverlight,    -,     ,      ,     .     ,       . <br> <br>        ,    ( )  ,  ,     .  UI       ,            UI. <br> <br>      - <br>   -     ,       <code>IAsyncResult</code> .   ,  ,   ,  <code>GetQuestionnaire</code> ,   : <code>BeginGetQuestionnaire</code>  <code>EndGetQuestionnaire</code> .    ,   <code>BeginGetQuestionnaire</code> .     ,   ,   <code>EndGetQuestionnaire</code>    . <br> <b></b> <br>  .NET Framework 4.5      <code>await</code>  <code>async</code>     <code>*Async</code> .      <a href="http://msdn.microsoft.com/en-us/library/vstudio/hh391443.aspx">"Asynchronous Programming with Async and Await (C# and Visual Basic)"</a> . <br>  ,    <code>EndGetQuestionnaire</code> ,      ,  ()      <code>BeginGetQuestionnaire</code> .     ,      ,   <code>EndGetQuestionnaire</code> ,   . <br> <br> <code class="xml">IAsyncResult asyncResult = this.service.BeginGetQuestionnaire( GetQuestionnaireCompleted, null //  ,      ); private void GetQuestionnaireCompleted(IAsyncResult result) { try { questionnaire = this.service.EndGetQuestionnaire(ar); } catch (Exception ex) { //  -   . } }</code> <br>  ,     <code>End*</code> (  , <code>EndGetQuestionnaire</code> ),    ,      .      , ,          UI.     ,   ,        . <br> <br>        UI,     -,      UI,         UI,   <code>Dispatcher</code>    <code>SynchronizationContext</code> .  WPF  Silverlight,   <code>Dispatcher</code> . <br> <br>      <code>Questionnaire</code>  ,        <code>QuestionnaireView</code> .  Silverlight    <code>CheckAccess</code> ,  ,      UI.  ,     <code>BeginInvoke</code> ,      UI. <br> <br> <code class="cs">var dispatcher = System.Windows.Deployment.Current.Dispatcher; if (dispatcher.CheckAccess()) { QuestionnaireView.DataContext = questionnaire; } else { dispatcher.BeginInvoke(() =&gt; { Questionnaire.DataContext = questionnaire; }); }</code> <br> <i>MVVM RI</i>   ,    ,   <code>IAsyncResult</code> ,   .      ,                 . ,       . <br> <br> <code class="cs">this.questionnaireRepository.GetQuestionnaireAsync( result =&gt; { this.Questionnaire = result.Result; });</code> <br>  <code>result</code>   ,     , , , .    ,     . <br> <br> <code class="cs">this.questionnaireRepository.GetQuestionnaireAsync( result =&gt; { if (result.Error == null) { this.Questionnaire = result.Result; ... } else { // Handle error. } })</code> <br>     <br>        ,      .     , ,             .        ,      ,     ,     . <br> <br>         ,      MVVM,     ,   . ,  -MVVM ,     <code>MessageBox</code>   code-behind UI,      .   MVVM     ,          . <br> <br>     MVVM,              ,          .      ,    ,   ,  ,     . <br> <br>              MVVM.      ,     ,     ,  ,     .    ,         ,     ,          .       . <br> <br>    <br>                  .        ,        .  ,         .         . <br> <br>  ,         ,         ,  .      ,     .           ,       . ,        WPF  Silverlight,        . <br> <br> <img title="Using the service to interact with the user." src="https://habrastorage.org/getpro/habr/post_images/4b5/397/f2d/4b5397f2d02e5851195b29f1893be6fc.png" alt=" ,    ."> <br> <br>  ,   <code>MessageBox</code>        ,     ,    ,     . <br> <br> <code class="cs">var result = interactionService.ShowMessageBox( "Are you sure you want to cancel this operation?", "Confirm", MessageBoxButton.OK); if (result == MessageBoxResult.Yes) { CancelRequest(); }</code> <br> ,      - ,      ,         Silverlight.         .             .     . <br> <br> <code class="cs">interactionService.ShowMessageBox( "Are you sure you want to cancel this operation?", "Confirm", MessageBoxButton.OK, result =&gt; { if (result == MessageBoxResult.Yes) { CancelRequest(); } });</code> <br>         ,      . ,  WPF    <code>MessageBox</code> ,       ;    Silverlight    ,    . <br> <br>     <br>         ‚Äì             .         ,      .     ,     .        ,        ,   ,     . <br> <br> <img title="Using interaction request objects." src="https://habrastorage.org/getpro/habr/post_images/3d0/ff0/1c5/3d0ff01c5518558c2d3c5c5f47ce0ce9.png" alt="   ."> <br> <br>    ,   ,          ‚Äì       ,      ,   ‚Äì     .   ,        ,    ,    UI            . <br> <br>       MVVM,     ,       ,         .         ,        ,    ,   . <br> <br>  Prism       <code>IInteractionRequest</code>   <code>InteractionRequest .  IInteractionRequest</code>  ,   .           ,   .  <code>InteractionRequest   IInteractionRequest</code>     <code>Raise</code> ,           , , ,   . <br> <br>       <br>  <code>InteractionRequest          .  Raise</code>          ( <code>T</code> )    ,    ,   .          ,       .      ,        .    ,  ,     . <br> <code class="cs">public interface IInteractionRequest { event EventHandler&lt;InteractionRequestedEventArgs&gt; Raised; } public class InteractionRequest&lt;T&gt; : IInteractionRequest { public event EventHandler&lt;InteractionRequestedEventArgs&gt; Raised; public void Raise(T context, Action&lt;T&gt; callback) { var handler = this.Raised; if (handler != null) { handler( this, new InteractionRequestedEventArgs(context, () =&gt; callback(context))); } } }</code> <br> Prism    ,      .  <code>Notification</code>       .    ,            .     ‚Äì <code>Title</code>  <code>Content</code> ,    .  ,   ,  ,  ,        . <br> <br>  <code>Confirmation</code>    <code>Notification</code>     ‚Äì <code>Confirmed</code> ,  ,  ,      .  <code>Confirmation</code> ,     <code>MessageBox</code> ,     /  .     ,     <code>Notification</code> ,     ,      . <br> <br>    <code>InteractionRequest ,       InteractionRequest      ,      .      ,    Raise</code> ,    , ,   . <br> <br> <code class="cs">public IInteractionRequest ConfirmCancelInteractionRequest { get { return this.confirmCancelInteractionRequest; } } this.confirmCancelInteractionRequest.Raise( new Confirmation("Are you sure you wish to cancel?"), confirmation =&gt; { if (confirmation.Confirmed) { this.NavigateToQuestionnaireList(); } }); }</code> <br> <i>MVVM Reference Implementation (MVVM RI)</i> ,    <code>IInteractionRequest</code>   <code>InteractionRequest ,          (. QuestionnaireViewModel.cs</code> ). <br> <br>        <br>       ,       .   ,       .    UI             . <br> <br>                . Microsoft Expression Blend Behaviors Framework     .  ,     ,    . <br> <br>  <code>EventTrigger</code> ,  Expression Blend,  ,      ,     ,   . , Prism   <code>EventTrigger</code> ,  <code>InteractionRequestTrigger</code> ,      <code>Raised</code>   <code>IInteractionRequest</code> .    XAML        . <br> <br>  ,   , <code>InteractionRequestTrigger</code>   .  Silverlight Prism   <code>PopupChildWindowAction</code> ,     .    ,         .   <code>ContentTemplate</code>  <code>PopupChildWindowAction</code> ,    ,    UI,      <code>Content</code>  .       <code>Title</code>  . <br> <b></b> <br>  ,    ,   <code>PopupChildWindowAction</code> ,     .    <code>Notification</code>  <code>NotificationChildWindow</code> ,        <code>Confirmation</code> ‚Äì <code>ConfirmationChildWindow</code> . <code>NotificationChildWindow</code>    ,   ,     <code>ConfirmationChildWindow</code>    <i>OK</i>  <i>Cancel</i> ,    .    ,   ,   <code>ChildWindow</code>  <code>PopupChildWindowAction</code> . <br>   ,  <code>InteractionRequestTrigger</code>  <code>PopupChildWindowAction</code> ,       <i>RI MVVM</i> . <br> <br> <code class="xml">&lt;i:Interaction.Triggers&gt; &lt;prism:InteractionRequestTrigger SourceObject="{Binding ConfirmCancelInteractionRequest}"&gt; &lt;prism:PopupChildWindowAction ContentTemplate="{StaticResource ConfirmWindowTemplate}"/&gt; &lt;/prism:InteractionRequestTrigger&gt; &lt;/i:Interaction.Triggers&gt; &lt;UserControl.Resources&gt; &lt;DataTemplate x:Key="ConfirmWindowTemplate"&gt; &lt;Grid MinWidth="250" MinHeight="100"&gt; &lt;TextBlock TextWrapping="Wrap" Grid.Row="0" Text="{Binding}"/&gt; &lt;/Grid&gt; &lt;/DataTemplate&gt; &lt;/UserControl.Resources&gt;</code> <br> <b></b> <br>      <code>ContentTemplate</code> ,   UI   <code>Content</code>  .    <code>Content</code>  ,  , <code>TextBlock</code>     <code>Content</code> . <br>      ,     ,    ,    .  ,     ,       ,     ,    .   ,   <i>RI MVVM</i> ,         <code>Confirmed</code>    <code>Confirmation</code>  <code>true</code> ,     OK. <br> <br>        ,     .  Prism <code>InteractionRequestTrigger</code>   <code>PopupChildWindowAction</code>            . <br> <br>     <br>     MVVM,       , ,    ,         .        (  , ,  ,   ).    ,  ,  ,            . <br> <br>        ,         . Managed Extensibility Framework (MEF)  Unity Application Block (Unity)      ,  ,           . <br> <br>  ,       , , ,    ( )      . ,       ,     .  ,     ,       . <br> <br>     ,  MEF <br>  MEF,       ,   <code>Import</code> ,      ,  ,   <code>Export</code> .         ,    . <br> <br> , <code>QuestionnaireView</code>   <i>RI MVVM</i> ,        ,    <code>Import</code> .   , MEF           .  <code>set</code>        ,   . <br> <br> <code class="cs">[Import] public QuestionnaireViewModel ViewModel { set { this.DataContext = value; } }</code> <br>     ,   . <br> <br> <code class="cs">[Export] public class QuestionnaireViewModel : NotificationObject { ... }</code> <br>        ,   . <br> <br> <code class="cs">public QuestionnaireView() { InitializeComponent(); } [ImportingConstructor] public QuestionnaireView(QuestionnaireViewModel viewModel) : this() { this.DataContext = viewModel; }</code> <br> <b></b> <br>          MEF,   Unity.   ,     ,        .   ,   Visual Studio  Expression Blend, ,        ,     .   ,   ,  ,      ,          <code>InitializeComponent</code> . <br>     ,  Unity <br>  Unity,    ,   MEF.     ,      .    ,         .  ,      . <br> <br>  ,      ,  ,         . ,           ,   . <br> <br> <code class="cs">public QuestionnaireView() { InitializeComponent(); } public QuestionnaireView(QuestionnaireViewModel viewModel) : this() { this.DataContext = viewModel; }</code> <br> <b></b> <br>    ,        ,   Visual Studio  Expression Blend. <br>  ,          ,   . Unity        <code>set</code>   ,   . <br> <br> <code class="cs">public QuestionnaireView() { InitializeComponent(); } [Dependency] public QuestionnaireViewModel ViewModel { set { this.DataContext = value; } }</code> <br>       Unity. <br> <br> <code class="cs">container.RegisterType&lt;QuestionnaireViewModel&gt;();</code> <br>  ,     . <br> <br> <code class="cs">var view = container.Resolve&lt;QuestionnaireView&gt;();</code> <br>     ,    <br>   ,     ,        .        ,   MEF  Unity,        . <br> <br>          .   ,         UI,           . <br> <br> , <i>RI MVVM</i>   ,   ,        .   ,    .      <code>ShowView</code>   UI. <br> <br> <code class="cs">private void NavigateToQuestionnaireList() { //     "questionnaire list". this.uiService.ShowView(ViewNames.QuestionnaireTemplatesList); }</code> <br>  UI      UI .           UI.  <code>ShowView</code>  <code>UIService</code>      (,          ),       ,   . <br> <br> <code class="cs">public void ShowView(string viewName) { var view = this.ViewFactory.GetView(viewName); this.MainWindow.CurrentView = view; }</code> <br> <b></b> <br> Prism       .   ,   ,   ,             .    ,  , " <a href="http://msdn.microsoft.com/en-us/library/gg430861(v%3DPandP.40).aspx">View-Based Navigation</a> "   8, " <a href="http://msdn.microsoft.com/en-us/library/gg430861(v%3DPandP.40).aspx">Navigation</a> ". <br>  MVVM  <br>        MVVM      .           -      mocking . ,   ,        . <br> <br>   <i>INotifyPropertyChanged</i> <br>   <code>INotifyPropertyChanged</code>     ,      .      ,    ;   ,   ,     ,    ,       . <br> <br>   <br> ,       ,           <code>PropertyChanged</code>  ,         .  ,    <code>ChangeTracker</code> ,     MVVM,  ,      .      .     ,    . <br> <br> <code class="cs">var changeTracker = new PropertyChangeTracker(viewModel); viewModel.CurrentState = "newState"; CollectionAssert.Contains(changeTracker.ChangedProperties, "CurrentState");</code> <br> ,     ,     <code>INotifyPropertyChanged</code> ,    ,   ,     . <br> <br>      <br>        ,   ,    <code>set</code>      ,           . ,     ,     ,      ,          . <br> <br> <code class="cs">var changeTracker = new PropertyChangeTracker(viewModel); var question = viewModel.Questions.First() as OpenQuestionViewModel; question.Question.Response = "some text"; CollectionAssert.Contains(changeTracker.ChangedProperties, "UnansweredQuestions");</code> <br>      <br>     <code>INotifyPropertyChanged</code> ,      <code>PropertyChanged</code>        ,  ,     , , .        ,       . <br> <br>   <i>INotifyDataErrorInfo</i> <br>   ,     ,    ,   ,   <code>IDataErrorInfo</code> ,  ( Silverlight)   <code>INotifyDataErrorInfo</code> .   <code>INotifyDataErrorInfo</code>   ,         ,    ,  ,   ,    . <br> <br>       <code>INotifyDataErrorInfo</code> : ,     ,  ,     ,     <code>ErrorsChanged</code> ,      <code>GetErrors</code> , . <br> <br>    <br>     ,      ,     .       ,         <code>GetErrors</code>       ,  ,  ,   .    , ,  ,     ,        .   ,        . <br> <br> <code class="cs">//  . var notifyErrorInfo = (INotifyDataErrorInfo)question; question.Response = -15; Assert.IsTrue(notifyErrorInfo.GetErrors("Response").Cast&lt;ValidationResult&gt;().Any()); //  . var notifyErrorInfo = (INotifyDataErrorInfo)question; question.Response = 15; Assert.IsFalse(notifyErrorInfo.GetErrors("Response").Cast&lt;ValidationResult&gt;().Any());</code> <br>    ,    ,             . <br> <br>    <i>INotifyDataErrorInfo</i> <br>       <code>GetErrors</code> ,   <code>INotifyDataErrorInfo</code>  ,   <code>ErrorsChanged</code>      <code>GetErrors</code> . ,  <code>HasErrors</code>      ,  . <br> <br>       <code>INotifyDataErrorInfo</code> . , ,           ,   -  .      ,        <code>INotifyDataErrorInfo</code>         (,        ). <br> <br>     ,   ,  : <br>  <code>HasErrors</code>     .              ,       .  <code>ErrorsChanged</code> ,      ,         <code>GetErrors</code> .         ( ,  )     ,           .    <code>GetErrors</code>       <code>ErrorsChanged</code> . <br>    <code>INotifyPropertyChanged</code> ,  ,    <code>NotifyDataErrorInfoTestHelper</code>    MVVM,        <code>INotifyDataErrorInfo</code> ,       .   ,   ,      ,   .      . <br> <code class="cs">var helper = new NotifyDataErrorInfoTestHelper&lt;NumericQuestion, int?&gt;( question, q =&gt; q.Response); helper.ValidatePropertyChange( 6, NotifyDataErrorInfoBehavior.Nothing); helper.ValidatePropertyChange( 20, NotifyDataErrorInfoBehavior.FiresErrorsChanged | NotifyDataErrorInfoBehavior.HasErrors | NotifyDataErrorInfoBehavior.HasErrorsForProperty); helper.ValidatePropertyChange( null, NotifyDataErrorInfoBehavior.FiresErrorsChanged | NotifyDataErrorInfoBehavior.HasErrors | NotifyDataErrorInfoBehavior.HasErrorsForProperty); helper.ValidatePropertyChange( 2, NotifyDataErrorInfoBehavior.FiresErrorsChanged);</code> <br>     <br>   MVVM,     ,  .   ,    ,         . <br> <br>  ,     ,     ,       .   ,   , ,       ,     ,   <code>IAsyncResult</code>    ,  - ,   ,    UI. <br> <br>       , , ,    .   ,     .  ,      UI,     ,   ,          ,     ,        "   UI." <br> <br>     ,    ,    .   ,    ,     mock-, ,   ,   ,      ,          . <br> <br>           UI,    ,    .   ,     ,   ,      .        ,   .     ,    ,     . <br> <br> <code class="cs">questionnaireRepositoryMock .Setup( r =&gt; r.SubmitQuestionnaireAsync( It.IsAny&lt;Questionnaire&gt;(), It.IsAny&lt;Action&lt;IOperationResult&gt;&gt;())) .Callback&lt;Questionnaire, Action&lt;IOperationResult&gt;&gt;( (q, a) =&gt; callback = a); uiServicemock .Setup(svc =&gt; svc.ShowView(ViewNames.QuestionnaireTemplatesList)) .Callback&lt;string&gt;(viewName =&gt; requestedViewName = viewName); submitResultMock .Setup(sr =&gt; sr.Error) .Returns&lt;Exception&gt;(null); CompleteQuestionnaire(viewModel); viewModel.Submit(); //      UI . callback(submitResultMock.Object); //    ‚Äì     . Assert.AreEqual(ViewNames.QuestionnaireTemplatesList, requestedViewName);</code> <br> <b></b> <br>          ,        . <br>   <br>       , . "Trees in WPF"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ms753391.aspx">http://msdn.microsoft.com/en-us/library/ms753391.aspx</a> <br> <br>       , . "Attached Properties Overview"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/cc265152(VS.95).aspx">http://msdn.microsoft.com/en-us/library/cc265152(VS.95).aspx</a> <br> <br>      MEF, ."Managed Extensibility Framework Overview"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/dd460648.aspx">http://msdn.microsoft.com/en-us/library/dd460648.aspx</a> . <br> <br>      Unity, ."Unity Application Block"  MSDN: <a href="http://www.msdn.com/unity">http://www.msdn.com/unity</a> . <br> <br>      <code>DelegateCommand</code> , .Chapter 5, " <a href="http://msdn.microsoft.com/en-us/library/gg405484(v%3DPandP.40).aspx">Implementing the MVVM Pattern</a> ." <br> <br>        Microsoft Expression Blend, ."Working with built-in behaviors"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ff724013(v%3DExpression.40).aspx">http://msdn.microsoft.com/en-us/library/ff724013(v=Expression.40).aspx</a> . <br> <br>          Microsoft Expression Blend, ."Creating Custom Behaviors"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ff724708(v%3DExpression.40).aspx">http://msdn.microsoft.com/en-us/library/ff724708(v=Expression.40).aspx</a> . <br> <br>            Microsoft Expression Blend, ."Creating Custom Triggers and Actions"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ff724707(v%3DExpression.40).aspx">http://msdn.microsoft.com/en-us/library/ff724707(v=Expression.40).aspx</a> . <br> <br>         WPF  Silverlight, ."Threading Model"  "The Dispatcher Class"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ms741870.aspx">http://msdn.microsoft.com/en-us/library/ms741870.aspx</a> <br> <a href="http://msdn.microsoft.com/en-us/library/ms615907(v%3DVS.95).aspx">http://msdn.microsoft.com/en-us/library/ms615907(v=VS.95).aspx</a> . <br> <br>      unit-  Silverlight, ."Unit Testing with Silverlight 2": <a href="http://www.jeff.wilcox.name/2008/03/silverlight2-unit-testing/">http://www.jeff.wilcox.name/2008/03/silverlight2-unit-testing/</a> . <br> <br>         , .  " <a href="http://msdn.microsoft.com/en-us/library/gg430861(v%3DPandP.40).aspx">View-Based Navigation</a> " in Chapter 8, " <a href="http://msdn.microsoft.com/en-us/library/gg430861(v%3DPandP.40).aspx">Navigation</a> ." <br> <br>       ,   , ."Event-based Asynchronous Pattern Overview"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/wewwczdw.aspx">http://msdn.microsoft.com/en-us/library/wewwczdw.aspx</a> <br> <br>        <code>IAsyncResult</code> , ."Asynchronous Programming Overview"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ms228963.aspx">http://msdn.microsoft.com/en-us/library/ms228963.aspx</a></code></code></code></code></code></code></code></code></code> <blockquote> <code><code><code><code><code><code><code><code><code><code>CommandBehaviorBase ,    ,    ICommand</code> .           <code>CanExecuteChanged</code> ,          Silverlight,    WPF. <br> <br>    ,  ,   <code>CommandBehaviorBase    ,    .         ,      .         ,    .      ButtonBaseClickCommandBehavior</code> . <br> <br> <code class="cs">public class ButtonBaseClickCommandBehavior : CommandBehaviorBase&lt;ButtonBase&gt; { public ButtonBaseClickCommandBehavior(ButtonBase clickableObject) : base(clickableObject) { clickableObject.Click += OnClick; } private void OnClick(object sender, System.Windows.RoutedEventArgs e) { ExecuteCommand(); } }</code> <br>   <code>CommandBehaviorBase ,     .     ,          ,   . ,    ,    ,      , ,    CanExecute</code>  ,     . <br> <br>          ,   .           XAML.           .       .  Prism      ,       ,  ,   .       ,    . , ,  ,      <code>Click</code> ,       <code>Command</code> .    <code>Click.Command</code> ,  . <br> <br>             .             . <br> <br> <code class="cs">public static readonly DependencyProperty CommandProperty = DependencyProperty.RegisterAttached( "Command", typeof(ICommand), typeof(Click), new PropertyMetadata(OnSetCommandCallback)); private static readonly DependencyProperty ClickCommandBehaviorProperty = DependencyProperty.RegisterAttached( "ClickCommandBehavior", typeof(ButtonBaseClickCommandBehavior), typeof(Click), null);</code> <br>    <code>Command</code>    <code>ButtonBaseClickCommandBehavior</code> ,     <code>OnSetCommandCallback</code> ,     . <br> <br> <code class="cs">private static void OnSetCommandCallback(DependencyObject dependencyObject, DependencyPropertyChangedEventArgs e) { ButtonBase buttonBase = dependencyObject as ButtonBase; if (buttonBase != null) { ButtonBaseClickCommandBehavior behavior = GetOrCreateBehavior(buttonBase); behavior.Command = e.NewValue as ICommand; } } private static void OnSetCommandParameterCallback(DependencyObject dependencyObject, DependencyPropertyChangedEventArgs e) { ButtonBase buttonBase = dependencyObject as ButtonBase; if (buttonBase != null) { ButtonBaseClickCommandBehavior behavior = GetOrCreateBehavior(buttonBase); behavior.CommandParameter = e.NewValue; } } private static ButtonBaseClickCommandBehavior GetOrCreateBehavior(ButtonBase buttonBase ) { ButtonBaseClickCommandBehavior behavior = buttonBase.GetValue(ClickCommandBehaviorProperty) as ButtonBaseClickCommandBehavior; if ( behavior == null ) { behavior = new ButtonBaseClickCommandBehavior(buttonBase); buttonBase.SetValue(ClickCommandBehaviorProperty, behavior); } return behavior; }</code> <br>        ,  <a href="http://msdn.microsoft.com/en-us/library/cc265152(VS.95).aspx">Attached Properties Overview</a>  MSDN. <br> <br>    <br>              . ,     Silverlight,    -,     ,      ,     .     ,       . <br> <br>        ,    ( )  ,  ,     .  UI       ,            UI. <br> <br>      - <br>   -     ,       <code>IAsyncResult</code> .   ,  ,   ,  <code>GetQuestionnaire</code> ,   : <code>BeginGetQuestionnaire</code>  <code>EndGetQuestionnaire</code> .    ,   <code>BeginGetQuestionnaire</code> .     ,   ,   <code>EndGetQuestionnaire</code>    . <br> <b></b> <br>  .NET Framework 4.5      <code>await</code>  <code>async</code>     <code>*Async</code> .      <a href="http://msdn.microsoft.com/en-us/library/vstudio/hh391443.aspx">"Asynchronous Programming with Async and Await (C# and Visual Basic)"</a> . <br>  ,    <code>EndGetQuestionnaire</code> ,      ,  ()      <code>BeginGetQuestionnaire</code> .     ,      ,   <code>EndGetQuestionnaire</code> ,   . <br> <br> <code class="xml">IAsyncResult asyncResult = this.service.BeginGetQuestionnaire( GetQuestionnaireCompleted, null //  ,      ); private void GetQuestionnaireCompleted(IAsyncResult result) { try { questionnaire = this.service.EndGetQuestionnaire(ar); } catch (Exception ex) { //  -   . } }</code> <br>  ,     <code>End*</code> (  , <code>EndGetQuestionnaire</code> ),    ,      .      , ,          UI.     ,   ,        . <br> <br>        UI,     -,      UI,         UI,   <code>Dispatcher</code>    <code>SynchronizationContext</code> .  WPF  Silverlight,   <code>Dispatcher</code> . <br> <br>      <code>Questionnaire</code>  ,        <code>QuestionnaireView</code> .  Silverlight    <code>CheckAccess</code> ,  ,      UI.  ,     <code>BeginInvoke</code> ,      UI. <br> <br> <code class="cs">var dispatcher = System.Windows.Deployment.Current.Dispatcher; if (dispatcher.CheckAccess()) { QuestionnaireView.DataContext = questionnaire; } else { dispatcher.BeginInvoke(() =&gt; { Questionnaire.DataContext = questionnaire; }); }</code> <br> <i>MVVM RI</i>   ,    ,   <code>IAsyncResult</code> ,   .      ,                 . ,       . <br> <br> <code class="cs">this.questionnaireRepository.GetQuestionnaireAsync( result =&gt; { this.Questionnaire = result.Result; });</code> <br>  <code>result</code>   ,     , , , .    ,     . <br> <br> <code class="cs">this.questionnaireRepository.GetQuestionnaireAsync( result =&gt; { if (result.Error == null) { this.Questionnaire = result.Result; ... } else { // Handle error. } })</code> <br>     <br>        ,      .     , ,             .        ,      ,     ,     . <br> <br>         ,      MVVM,     ,   . ,  -MVVM ,     <code>MessageBox</code>   code-behind UI,      .   MVVM     ,          . <br> <br>     MVVM,              ,          .      ,    ,   ,  ,     . <br> <br>              MVVM.      ,     ,     ,  ,     .    ,         ,     ,          .       . <br> <br>    <br>                  .        ,        .  ,         .         . <br> <br>  ,         ,         ,  .      ,     .           ,       . ,        WPF  Silverlight,        . <br> <br> <img title="Using the service to interact with the user." src="https://habrastorage.org/getpro/habr/post_images/4b5/397/f2d/4b5397f2d02e5851195b29f1893be6fc.png" alt=" ,    ."> <br> <br>  ,   <code>MessageBox</code>        ,     ,    ,     . <br> <br> <code class="cs">var result = interactionService.ShowMessageBox( "Are you sure you want to cancel this operation?", "Confirm", MessageBoxButton.OK); if (result == MessageBoxResult.Yes) { CancelRequest(); }</code> <br> ,      - ,      ,         Silverlight.         .             .     . <br> <br> <code class="cs">interactionService.ShowMessageBox( "Are you sure you want to cancel this operation?", "Confirm", MessageBoxButton.OK, result =&gt; { if (result == MessageBoxResult.Yes) { CancelRequest(); } });</code> <br>         ,      . ,  WPF    <code>MessageBox</code> ,       ;    Silverlight    ,    . <br> <br>     <br>         ‚Äì             .         ,      .     ,     .        ,        ,   ,     . <br> <br> <img title="Using interaction request objects." src="https://habrastorage.org/getpro/habr/post_images/3d0/ff0/1c5/3d0ff01c5518558c2d3c5c5f47ce0ce9.png" alt="   ."> <br> <br>    ,   ,          ‚Äì       ,      ,   ‚Äì     .   ,        ,    ,    UI            . <br> <br>       MVVM,     ,       ,         .         ,        ,    ,   . <br> <br>  Prism       <code>IInteractionRequest</code>   <code>InteractionRequest .  IInteractionRequest</code>  ,   .           ,   .  <code>InteractionRequest   IInteractionRequest</code>     <code>Raise</code> ,           , , ,   . <br> <br>       <br>  <code>InteractionRequest          .  Raise</code>          ( <code>T</code> )    ,    ,   .          ,       .      ,        .    ,  ,     . <br> <code class="cs">public interface IInteractionRequest { event EventHandler&lt;InteractionRequestedEventArgs&gt; Raised; } public class InteractionRequest&lt;T&gt; : IInteractionRequest { public event EventHandler&lt;InteractionRequestedEventArgs&gt; Raised; public void Raise(T context, Action&lt;T&gt; callback) { var handler = this.Raised; if (handler != null) { handler( this, new InteractionRequestedEventArgs(context, () =&gt; callback(context))); } } }</code> <br> Prism    ,      .  <code>Notification</code>       .    ,            .     ‚Äì <code>Title</code>  <code>Content</code> ,    .  ,   ,  ,  ,        . <br> <br>  <code>Confirmation</code>    <code>Notification</code>     ‚Äì <code>Confirmed</code> ,  ,  ,      .  <code>Confirmation</code> ,     <code>MessageBox</code> ,     /  .     ,     <code>Notification</code> ,     ,      . <br> <br>    <code>InteractionRequest ,       InteractionRequest      ,      .      ,    Raise</code> ,    , ,   . <br> <br> <code class="cs">public IInteractionRequest ConfirmCancelInteractionRequest { get { return this.confirmCancelInteractionRequest; } } this.confirmCancelInteractionRequest.Raise( new Confirmation("Are you sure you wish to cancel?"), confirmation =&gt; { if (confirmation.Confirmed) { this.NavigateToQuestionnaireList(); } }); }</code> <br> <i>MVVM Reference Implementation (MVVM RI)</i> ,    <code>IInteractionRequest</code>   <code>InteractionRequest ,          (. QuestionnaireViewModel.cs</code> ). <br> <br>        <br>       ,       .   ,       .    UI             . <br> <br>                . Microsoft Expression Blend Behaviors Framework     .  ,     ,    . <br> <br>  <code>EventTrigger</code> ,  Expression Blend,  ,      ,     ,   . , Prism   <code>EventTrigger</code> ,  <code>InteractionRequestTrigger</code> ,      <code>Raised</code>   <code>IInteractionRequest</code> .    XAML        . <br> <br>  ,   , <code>InteractionRequestTrigger</code>   .  Silverlight Prism   <code>PopupChildWindowAction</code> ,     .    ,         .   <code>ContentTemplate</code>  <code>PopupChildWindowAction</code> ,    ,    UI,      <code>Content</code>  .       <code>Title</code>  . <br> <b></b> <br>  ,    ,   <code>PopupChildWindowAction</code> ,     .    <code>Notification</code>  <code>NotificationChildWindow</code> ,        <code>Confirmation</code> ‚Äì <code>ConfirmationChildWindow</code> . <code>NotificationChildWindow</code>    ,   ,     <code>ConfirmationChildWindow</code>    <i>OK</i>  <i>Cancel</i> ,    .    ,   ,   <code>ChildWindow</code>  <code>PopupChildWindowAction</code> . <br>   ,  <code>InteractionRequestTrigger</code>  <code>PopupChildWindowAction</code> ,       <i>RI MVVM</i> . <br> <br> <code class="xml">&lt;i:Interaction.Triggers&gt; &lt;prism:InteractionRequestTrigger SourceObject="{Binding ConfirmCancelInteractionRequest}"&gt; &lt;prism:PopupChildWindowAction ContentTemplate="{StaticResource ConfirmWindowTemplate}"/&gt; &lt;/prism:InteractionRequestTrigger&gt; &lt;/i:Interaction.Triggers&gt; &lt;UserControl.Resources&gt; &lt;DataTemplate x:Key="ConfirmWindowTemplate"&gt; &lt;Grid MinWidth="250" MinHeight="100"&gt; &lt;TextBlock TextWrapping="Wrap" Grid.Row="0" Text="{Binding}"/&gt; &lt;/Grid&gt; &lt;/DataTemplate&gt; &lt;/UserControl.Resources&gt;</code> <br> <b></b> <br>      <code>ContentTemplate</code> ,   UI   <code>Content</code>  .    <code>Content</code>  ,  , <code>TextBlock</code>     <code>Content</code> . <br>      ,     ,    ,    .  ,     ,       ,     ,    .   ,   <i>RI MVVM</i> ,         <code>Confirmed</code>    <code>Confirmation</code>  <code>true</code> ,     OK. <br> <br>        ,     .  Prism <code>InteractionRequestTrigger</code>   <code>PopupChildWindowAction</code>            . <br> <br>     <br>     MVVM,       , ,    ,         .        (  , ,  ,   ).    ,  ,  ,            . <br> <br>        ,         . Managed Extensibility Framework (MEF)  Unity Application Block (Unity)      ,  ,           . <br> <br>  ,       , , ,    ( )      . ,       ,     .  ,     ,       . <br> <br>     ,  MEF <br>  MEF,       ,   <code>Import</code> ,      ,  ,   <code>Export</code> .         ,    . <br> <br> , <code>QuestionnaireView</code>   <i>RI MVVM</i> ,        ,    <code>Import</code> .   , MEF           .  <code>set</code>        ,   . <br> <br> <code class="cs">[Import] public QuestionnaireViewModel ViewModel { set { this.DataContext = value; } }</code> <br>     ,   . <br> <br> <code class="cs">[Export] public class QuestionnaireViewModel : NotificationObject { ... }</code> <br>        ,   . <br> <br> <code class="cs">public QuestionnaireView() { InitializeComponent(); } [ImportingConstructor] public QuestionnaireView(QuestionnaireViewModel viewModel) : this() { this.DataContext = viewModel; }</code> <br> <b></b> <br>          MEF,   Unity.   ,     ,        .   ,   Visual Studio  Expression Blend, ,        ,     .   ,   ,  ,      ,          <code>InitializeComponent</code> . <br>     ,  Unity <br>  Unity,    ,   MEF.     ,      .    ,         .  ,      . <br> <br>  ,      ,  ,         . ,           ,   . <br> <br> <code class="cs">public QuestionnaireView() { InitializeComponent(); } public QuestionnaireView(QuestionnaireViewModel viewModel) : this() { this.DataContext = viewModel; }</code> <br> <b></b> <br>    ,        ,   Visual Studio  Expression Blend. <br>  ,          ,   . Unity        <code>set</code>   ,   . <br> <br> <code class="cs">public QuestionnaireView() { InitializeComponent(); } [Dependency] public QuestionnaireViewModel ViewModel { set { this.DataContext = value; } }</code> <br>       Unity. <br> <br> <code class="cs">container.RegisterType&lt;QuestionnaireViewModel&gt;();</code> <br>  ,     . <br> <br> <code class="cs">var view = container.Resolve&lt;QuestionnaireView&gt;();</code> <br>     ,    <br>   ,     ,        .        ,   MEF  Unity,        . <br> <br>          .   ,         UI,           . <br> <br> , <i>RI MVVM</i>   ,   ,        .   ,    .      <code>ShowView</code>   UI. <br> <br> <code class="cs">private void NavigateToQuestionnaireList() { //     "questionnaire list". this.uiService.ShowView(ViewNames.QuestionnaireTemplatesList); }</code> <br>  UI      UI .           UI.  <code>ShowView</code>  <code>UIService</code>      (,          ),       ,   . <br> <br> <code class="cs">public void ShowView(string viewName) { var view = this.ViewFactory.GetView(viewName); this.MainWindow.CurrentView = view; }</code> <br> <b></b> <br> Prism       .   ,   ,   ,             .    ,  , " <a href="http://msdn.microsoft.com/en-us/library/gg430861(v%3DPandP.40).aspx">View-Based Navigation</a> "   8, " <a href="http://msdn.microsoft.com/en-us/library/gg430861(v%3DPandP.40).aspx">Navigation</a> ". <br>  MVVM  <br>        MVVM      .           -      mocking . ,   ,        . <br> <br>   <i>INotifyPropertyChanged</i> <br>   <code>INotifyPropertyChanged</code>     ,      .      ,    ;   ,   ,     ,    ,       . <br> <br>   <br> ,       ,           <code>PropertyChanged</code>  ,         .  ,    <code>ChangeTracker</code> ,     MVVM,  ,      .      .     ,    . <br> <br> <code class="cs">var changeTracker = new PropertyChangeTracker(viewModel); viewModel.CurrentState = "newState"; CollectionAssert.Contains(changeTracker.ChangedProperties, "CurrentState");</code> <br> ,     ,     <code>INotifyPropertyChanged</code> ,    ,   ,     . <br> <br>      <br>        ,   ,    <code>set</code>      ,           . ,     ,     ,      ,          . <br> <br> <code class="cs">var changeTracker = new PropertyChangeTracker(viewModel); var question = viewModel.Questions.First() as OpenQuestionViewModel; question.Question.Response = "some text"; CollectionAssert.Contains(changeTracker.ChangedProperties, "UnansweredQuestions");</code> <br>      <br>     <code>INotifyPropertyChanged</code> ,      <code>PropertyChanged</code>        ,  ,     , , .        ,       . <br> <br>   <i>INotifyDataErrorInfo</i> <br>   ,     ,    ,   ,   <code>IDataErrorInfo</code> ,  ( Silverlight)   <code>INotifyDataErrorInfo</code> .   <code>INotifyDataErrorInfo</code>   ,         ,    ,  ,   ,    . <br> <br>       <code>INotifyDataErrorInfo</code> : ,     ,  ,     ,     <code>ErrorsChanged</code> ,      <code>GetErrors</code> , . <br> <br>    <br>     ,      ,     .       ,         <code>GetErrors</code>       ,  ,  ,   .    , ,  ,     ,        .   ,        . <br> <br> <code class="cs">//  . var notifyErrorInfo = (INotifyDataErrorInfo)question; question.Response = -15; Assert.IsTrue(notifyErrorInfo.GetErrors("Response").Cast&lt;ValidationResult&gt;().Any()); //  . var notifyErrorInfo = (INotifyDataErrorInfo)question; question.Response = 15; Assert.IsFalse(notifyErrorInfo.GetErrors("Response").Cast&lt;ValidationResult&gt;().Any());</code> <br>    ,    ,             . <br> <br>    <i>INotifyDataErrorInfo</i> <br>       <code>GetErrors</code> ,   <code>INotifyDataErrorInfo</code>  ,   <code>ErrorsChanged</code>      <code>GetErrors</code> . ,  <code>HasErrors</code>      ,  . <br> <br>       <code>INotifyDataErrorInfo</code> . , ,           ,   -  .      ,        <code>INotifyDataErrorInfo</code>         (,        ). <br> <br>     ,   ,  : <br>  <code>HasErrors</code>     .              ,       .  <code>ErrorsChanged</code> ,      ,         <code>GetErrors</code> .         ( ,  )     ,           .    <code>GetErrors</code>       <code>ErrorsChanged</code> . <br>    <code>INotifyPropertyChanged</code> ,  ,    <code>NotifyDataErrorInfoTestHelper</code>    MVVM,        <code>INotifyDataErrorInfo</code> ,       .   ,   ,      ,   .      . <br> <code class="cs">var helper = new NotifyDataErrorInfoTestHelper&lt;NumericQuestion, int?&gt;( question, q =&gt; q.Response); helper.ValidatePropertyChange( 6, NotifyDataErrorInfoBehavior.Nothing); helper.ValidatePropertyChange( 20, NotifyDataErrorInfoBehavior.FiresErrorsChanged | NotifyDataErrorInfoBehavior.HasErrors | NotifyDataErrorInfoBehavior.HasErrorsForProperty); helper.ValidatePropertyChange( null, NotifyDataErrorInfoBehavior.FiresErrorsChanged | NotifyDataErrorInfoBehavior.HasErrors | NotifyDataErrorInfoBehavior.HasErrorsForProperty); helper.ValidatePropertyChange( 2, NotifyDataErrorInfoBehavior.FiresErrorsChanged);</code> <br>     <br>   MVVM,     ,  .   ,    ,         . <br> <br>  ,     ,     ,       .   ,   , ,       ,     ,   <code>IAsyncResult</code>    ,  - ,   ,    UI. <br> <br>       , , ,    .   ,     .  ,      UI,     ,   ,          ,     ,        "   UI." <br> <br>     ,    ,    .   ,    ,     mock-, ,   ,   ,      ,          . <br> <br>           UI,    ,    .   ,     ,   ,      .        ,   .     ,    ,     . <br> <br> <code class="cs">questionnaireRepositoryMock .Setup( r =&gt; r.SubmitQuestionnaireAsync( It.IsAny&lt;Questionnaire&gt;(), It.IsAny&lt;Action&lt;IOperationResult&gt;&gt;())) .Callback&lt;Questionnaire, Action&lt;IOperationResult&gt;&gt;( (q, a) =&gt; callback = a); uiServicemock .Setup(svc =&gt; svc.ShowView(ViewNames.QuestionnaireTemplatesList)) .Callback&lt;string&gt;(viewName =&gt; requestedViewName = viewName); submitResultMock .Setup(sr =&gt; sr.Error) .Returns&lt;Exception&gt;(null); CompleteQuestionnaire(viewModel); viewModel.Submit(); //      UI . callback(submitResultMock.Object); //    ‚Äì     . Assert.AreEqual(ViewNames.QuestionnaireTemplatesList, requestedViewName);</code> <br> <b></b> <br>          ,        . <br>   <br>       , . "Trees in WPF"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ms753391.aspx">http://msdn.microsoft.com/en-us/library/ms753391.aspx</a> <br> <br>       , . "Attached Properties Overview"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/cc265152(VS.95).aspx">http://msdn.microsoft.com/en-us/library/cc265152(VS.95).aspx</a> <br> <br>      MEF, ."Managed Extensibility Framework Overview"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/dd460648.aspx">http://msdn.microsoft.com/en-us/library/dd460648.aspx</a> . <br> <br>      Unity, ."Unity Application Block"  MSDN: <a href="http://www.msdn.com/unity">http://www.msdn.com/unity</a> . <br> <br>      <code>DelegateCommand</code> , .Chapter 5, " <a href="http://msdn.microsoft.com/en-us/library/gg405484(v%3DPandP.40).aspx">Implementing the MVVM Pattern</a> ." <br> <br>        Microsoft Expression Blend, ."Working with built-in behaviors"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ff724013(v%3DExpression.40).aspx">http://msdn.microsoft.com/en-us/library/ff724013(v=Expression.40).aspx</a> . <br> <br>          Microsoft Expression Blend, ."Creating Custom Behaviors"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ff724708(v%3DExpression.40).aspx">http://msdn.microsoft.com/en-us/library/ff724708(v=Expression.40).aspx</a> . <br> <br>            Microsoft Expression Blend, ."Creating Custom Triggers and Actions"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ff724707(v%3DExpression.40).aspx">http://msdn.microsoft.com/en-us/library/ff724707(v=Expression.40).aspx</a> . <br> <br>         WPF  Silverlight, ."Threading Model"  "The Dispatcher Class"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ms741870.aspx">http://msdn.microsoft.com/en-us/library/ms741870.aspx</a> <br> <a href="http://msdn.microsoft.com/en-us/library/ms615907(v%3DVS.95).aspx">http://msdn.microsoft.com/en-us/library/ms615907(v=VS.95).aspx</a> . <br> <br>      unit-  Silverlight, ."Unit Testing with Silverlight 2": <a href="http://www.jeff.wilcox.name/2008/03/silverlight2-unit-testing/">http://www.jeff.wilcox.name/2008/03/silverlight2-unit-testing/</a> . <br> <br>         , .  " <a href="http://msdn.microsoft.com/en-us/library/gg430861(v%3DPandP.40).aspx">View-Based Navigation</a> " in Chapter 8, " <a href="http://msdn.microsoft.com/en-us/library/gg430861(v%3DPandP.40).aspx">Navigation</a> ." <br> <br>       ,   , ."Event-based Asynchronous Pattern Overview"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/wewwczdw.aspx">http://msdn.microsoft.com/en-us/library/wewwczdw.aspx</a> <br> <br>        <code>IAsyncResult</code> , ."Asynchronous Programming Overview"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ms228963.aspx">http://msdn.microsoft.com/en-us/library/ms228963.aspx</a></code></code></code></code></code></code></code></code></code> </blockquote> <code><code><code><code><code><code><code><code><code><code>CommandBehaviorBase ,    ,    ICommand</code> .           <code>CanExecuteChanged</code> ,          Silverlight,    WPF. <br> <br>    ,  ,   <code>CommandBehaviorBase    ,    .         ,      .         ,    .      ButtonBaseClickCommandBehavior</code> . <br> <br> <code class="cs">public class ButtonBaseClickCommandBehavior : CommandBehaviorBase&lt;ButtonBase&gt; { public ButtonBaseClickCommandBehavior(ButtonBase clickableObject) : base(clickableObject) { clickableObject.Click += OnClick; } private void OnClick(object sender, System.Windows.RoutedEventArgs e) { ExecuteCommand(); } }</code> <br>   <code>CommandBehaviorBase ,     .     ,          ,   . ,    ,    ,      , ,    CanExecute</code>  ,     . <br> <br>          ,   .           XAML.           .       .  Prism      ,       ,  ,   .       ,    . , ,  ,      <code>Click</code> ,       <code>Command</code> .    <code>Click.Command</code> ,  . <br> <br>             .             . <br> <br> <code class="cs">public static readonly DependencyProperty CommandProperty = DependencyProperty.RegisterAttached( "Command", typeof(ICommand), typeof(Click), new PropertyMetadata(OnSetCommandCallback)); private static readonly DependencyProperty ClickCommandBehaviorProperty = DependencyProperty.RegisterAttached( "ClickCommandBehavior", typeof(ButtonBaseClickCommandBehavior), typeof(Click), null);</code> <br>    <code>Command</code>    <code>ButtonBaseClickCommandBehavior</code> ,     <code>OnSetCommandCallback</code> ,     . <br> <br> <code class="cs">private static void OnSetCommandCallback(DependencyObject dependencyObject, DependencyPropertyChangedEventArgs e) { ButtonBase buttonBase = dependencyObject as ButtonBase; if (buttonBase != null) { ButtonBaseClickCommandBehavior behavior = GetOrCreateBehavior(buttonBase); behavior.Command = e.NewValue as ICommand; } } private static void OnSetCommandParameterCallback(DependencyObject dependencyObject, DependencyPropertyChangedEventArgs e) { ButtonBase buttonBase = dependencyObject as ButtonBase; if (buttonBase != null) { ButtonBaseClickCommandBehavior behavior = GetOrCreateBehavior(buttonBase); behavior.CommandParameter = e.NewValue; } } private static ButtonBaseClickCommandBehavior GetOrCreateBehavior(ButtonBase buttonBase ) { ButtonBaseClickCommandBehavior behavior = buttonBase.GetValue(ClickCommandBehaviorProperty) as ButtonBaseClickCommandBehavior; if ( behavior == null ) { behavior = new ButtonBaseClickCommandBehavior(buttonBase); buttonBase.SetValue(ClickCommandBehaviorProperty, behavior); } return behavior; }</code> <br>        ,  <a href="http://msdn.microsoft.com/en-us/library/cc265152(VS.95).aspx">Attached Properties Overview</a>  MSDN. <br> <br>    <br>              . ,     Silverlight,    -,     ,      ,     .     ,       . <br> <br>        ,    ( )  ,  ,     .  UI       ,            UI. <br> <br>      - <br>   -     ,       <code>IAsyncResult</code> .   ,  ,   ,  <code>GetQuestionnaire</code> ,   : <code>BeginGetQuestionnaire</code>  <code>EndGetQuestionnaire</code> .    ,   <code>BeginGetQuestionnaire</code> .     ,   ,   <code>EndGetQuestionnaire</code>    . <br> <b></b> <br>  .NET Framework 4.5      <code>await</code>  <code>async</code>     <code>*Async</code> .      <a href="http://msdn.microsoft.com/en-us/library/vstudio/hh391443.aspx">"Asynchronous Programming with Async and Await (C# and Visual Basic)"</a> . <br>  ,    <code>EndGetQuestionnaire</code> ,      ,  ()      <code>BeginGetQuestionnaire</code> .     ,      ,   <code>EndGetQuestionnaire</code> ,   . <br> <br> <code class="xml">IAsyncResult asyncResult = this.service.BeginGetQuestionnaire( GetQuestionnaireCompleted, null //  ,      ); private void GetQuestionnaireCompleted(IAsyncResult result) { try { questionnaire = this.service.EndGetQuestionnaire(ar); } catch (Exception ex) { //  -   . } }</code> <br>  ,     <code>End*</code> (  , <code>EndGetQuestionnaire</code> ),    ,      .      , ,          UI.     ,   ,        . <br> <br>        UI,     -,      UI,         UI,   <code>Dispatcher</code>    <code>SynchronizationContext</code> .  WPF  Silverlight,   <code>Dispatcher</code> . <br> <br>      <code>Questionnaire</code>  ,        <code>QuestionnaireView</code> .  Silverlight    <code>CheckAccess</code> ,  ,      UI.  ,     <code>BeginInvoke</code> ,      UI. <br> <br> <code class="cs">var dispatcher = System.Windows.Deployment.Current.Dispatcher; if (dispatcher.CheckAccess()) { QuestionnaireView.DataContext = questionnaire; } else { dispatcher.BeginInvoke(() =&gt; { Questionnaire.DataContext = questionnaire; }); }</code> <br> <i>MVVM RI</i>   ,    ,   <code>IAsyncResult</code> ,   .      ,                 . ,       . <br> <br> <code class="cs">this.questionnaireRepository.GetQuestionnaireAsync( result =&gt; { this.Questionnaire = result.Result; });</code> <br>  <code>result</code>   ,     , , , .    ,     . <br> <br> <code class="cs">this.questionnaireRepository.GetQuestionnaireAsync( result =&gt; { if (result.Error == null) { this.Questionnaire = result.Result; ... } else { // Handle error. } })</code> <br>     <br>        ,      .     , ,             .        ,      ,     ,     . <br> <br>         ,      MVVM,     ,   . ,  -MVVM ,     <code>MessageBox</code>   code-behind UI,      .   MVVM     ,          . <br> <br>     MVVM,              ,          .      ,    ,   ,  ,     . <br> <br>              MVVM.      ,     ,     ,  ,     .    ,         ,     ,          .       . <br> <br>    <br>                  .        ,        .  ,         .         . <br> <br>  ,         ,         ,  .      ,     .           ,       . ,        WPF  Silverlight,        . <br> <br> <img title="Using the service to interact with the user." src="https://habrastorage.org/getpro/habr/post_images/4b5/397/f2d/4b5397f2d02e5851195b29f1893be6fc.png" alt=" ,    ."> <br> <br>  ,   <code>MessageBox</code>        ,     ,    ,     . <br> <br> <code class="cs">var result = interactionService.ShowMessageBox( "Are you sure you want to cancel this operation?", "Confirm", MessageBoxButton.OK); if (result == MessageBoxResult.Yes) { CancelRequest(); }</code> <br> ,      - ,      ,         Silverlight.         .             .     . <br> <br> <code class="cs">interactionService.ShowMessageBox( "Are you sure you want to cancel this operation?", "Confirm", MessageBoxButton.OK, result =&gt; { if (result == MessageBoxResult.Yes) { CancelRequest(); } });</code> <br>         ,      . ,  WPF    <code>MessageBox</code> ,       ;    Silverlight    ,    . <br> <br>     <br>         ‚Äì             .         ,      .     ,     .        ,        ,   ,     . <br> <br> <img title="Using interaction request objects." src="https://habrastorage.org/getpro/habr/post_images/3d0/ff0/1c5/3d0ff01c5518558c2d3c5c5f47ce0ce9.png" alt="   ."> <br> <br>    ,   ,          ‚Äì       ,      ,   ‚Äì     .   ,        ,    ,    UI            . <br> <br>       MVVM,     ,       ,         .         ,        ,    ,   . <br> <br>  Prism       <code>IInteractionRequest</code>   <code>InteractionRequest .  IInteractionRequest</code>  ,   .           ,   .  <code>InteractionRequest   IInteractionRequest</code>     <code>Raise</code> ,           , , ,   . <br> <br>       <br>  <code>InteractionRequest          .  Raise</code>          ( <code>T</code> )    ,    ,   .          ,       .      ,        .    ,  ,     . <br> <code class="cs">public interface IInteractionRequest { event EventHandler&lt;InteractionRequestedEventArgs&gt; Raised; } public class InteractionRequest&lt;T&gt; : IInteractionRequest { public event EventHandler&lt;InteractionRequestedEventArgs&gt; Raised; public void Raise(T context, Action&lt;T&gt; callback) { var handler = this.Raised; if (handler != null) { handler( this, new InteractionRequestedEventArgs(context, () =&gt; callback(context))); } } }</code> <br> Prism    ,      .  <code>Notification</code>       .    ,            .     ‚Äì <code>Title</code>  <code>Content</code> ,    .  ,   ,  ,  ,        . <br> <br>  <code>Confirmation</code>    <code>Notification</code>     ‚Äì <code>Confirmed</code> ,  ,  ,      .  <code>Confirmation</code> ,     <code>MessageBox</code> ,     /  .     ,     <code>Notification</code> ,     ,      . <br> <br>    <code>InteractionRequest ,       InteractionRequest      ,      .      ,    Raise</code> ,    , ,   . <br> <br> <code class="cs">public IInteractionRequest ConfirmCancelInteractionRequest { get { return this.confirmCancelInteractionRequest; } } this.confirmCancelInteractionRequest.Raise( new Confirmation("Are you sure you wish to cancel?"), confirmation =&gt; { if (confirmation.Confirmed) { this.NavigateToQuestionnaireList(); } }); }</code> <br> <i>MVVM Reference Implementation (MVVM RI)</i> ,    <code>IInteractionRequest</code>   <code>InteractionRequest ,          (. QuestionnaireViewModel.cs</code> ). <br> <br>        <br>       ,       .   ,       .    UI             . <br> <br>                . Microsoft Expression Blend Behaviors Framework     .  ,     ,    . <br> <br>  <code>EventTrigger</code> ,  Expression Blend,  ,      ,     ,   . , Prism   <code>EventTrigger</code> ,  <code>InteractionRequestTrigger</code> ,      <code>Raised</code>   <code>IInteractionRequest</code> .    XAML        . <br> <br>  ,   , <code>InteractionRequestTrigger</code>   .  Silverlight Prism   <code>PopupChildWindowAction</code> ,     .    ,         .   <code>ContentTemplate</code>  <code>PopupChildWindowAction</code> ,    ,    UI,      <code>Content</code>  .       <code>Title</code>  . <br> <b></b> <br>  ,    ,   <code>PopupChildWindowAction</code> ,     .    <code>Notification</code>  <code>NotificationChildWindow</code> ,        <code>Confirmation</code> ‚Äì <code>ConfirmationChildWindow</code> . <code>NotificationChildWindow</code>    ,   ,     <code>ConfirmationChildWindow</code>    <i>OK</i>  <i>Cancel</i> ,    .    ,   ,   <code>ChildWindow</code>  <code>PopupChildWindowAction</code> . <br>   ,  <code>InteractionRequestTrigger</code>  <code>PopupChildWindowAction</code> ,       <i>RI MVVM</i> . <br> <br> <code class="xml">&lt;i:Interaction.Triggers&gt; &lt;prism:InteractionRequestTrigger SourceObject="{Binding ConfirmCancelInteractionRequest}"&gt; &lt;prism:PopupChildWindowAction ContentTemplate="{StaticResource ConfirmWindowTemplate}"/&gt; &lt;/prism:InteractionRequestTrigger&gt; &lt;/i:Interaction.Triggers&gt; &lt;UserControl.Resources&gt; &lt;DataTemplate x:Key="ConfirmWindowTemplate"&gt; &lt;Grid MinWidth="250" MinHeight="100"&gt; &lt;TextBlock TextWrapping="Wrap" Grid.Row="0" Text="{Binding}"/&gt; &lt;/Grid&gt; &lt;/DataTemplate&gt; &lt;/UserControl.Resources&gt;</code> <br> <b></b> <br>      <code>ContentTemplate</code> ,   UI   <code>Content</code>  .    <code>Content</code>  ,  , <code>TextBlock</code>     <code>Content</code> . <br>      ,     ,    ,    .  ,     ,       ,     ,    .   ,   <i>RI MVVM</i> ,         <code>Confirmed</code>    <code>Confirmation</code>  <code>true</code> ,     OK. <br> <br>        ,     .  Prism <code>InteractionRequestTrigger</code>   <code>PopupChildWindowAction</code>            . <br> <br>     <br>     MVVM,       , ,    ,         .        (  , ,  ,   ).    ,  ,  ,            . <br> <br>        ,         . Managed Extensibility Framework (MEF)  Unity Application Block (Unity)      ,  ,           . <br> <br>  ,       , , ,    ( )      . ,       ,     .  ,     ,       . <br> <br>     ,  MEF <br>  MEF,       ,   <code>Import</code> ,      ,  ,   <code>Export</code> .         ,    . <br> <br> , <code>QuestionnaireView</code>   <i>RI MVVM</i> ,        ,    <code>Import</code> .   , MEF           .  <code>set</code>        ,   . <br> <br> <code class="cs">[Import] public QuestionnaireViewModel ViewModel { set { this.DataContext = value; } }</code> <br>     ,   . <br> <br> <code class="cs">[Export] public class QuestionnaireViewModel : NotificationObject { ... }</code> <br>        ,   . <br> <br> <code class="cs">public QuestionnaireView() { InitializeComponent(); } [ImportingConstructor] public QuestionnaireView(QuestionnaireViewModel viewModel) : this() { this.DataContext = viewModel; }</code> <br> <b></b> <br>          MEF,   Unity.   ,     ,        .   ,   Visual Studio  Expression Blend, ,        ,     .   ,   ,  ,      ,          <code>InitializeComponent</code> . <br>     ,  Unity <br>  Unity,    ,   MEF.     ,      .    ,         .  ,      . <br> <br>  ,      ,  ,         . ,           ,   . <br> <br> <code class="cs">public QuestionnaireView() { InitializeComponent(); } public QuestionnaireView(QuestionnaireViewModel viewModel) : this() { this.DataContext = viewModel; }</code> <br> <b></b> <br>    ,        ,   Visual Studio  Expression Blend. <br>  ,          ,   . Unity        <code>set</code>   ,   . <br> <br> <code class="cs">public QuestionnaireView() { InitializeComponent(); } [Dependency] public QuestionnaireViewModel ViewModel { set { this.DataContext = value; } }</code> <br>       Unity. <br> <br> <code class="cs">container.RegisterType&lt;QuestionnaireViewModel&gt;();</code> <br>  ,     . <br> <br> <code class="cs">var view = container.Resolve&lt;QuestionnaireView&gt;();</code> <br>     ,    <br>   ,     ,        .        ,   MEF  Unity,        . <br> <br>          .   ,         UI,           . <br> <br> , <i>RI MVVM</i>   ,   ,        .   ,    .      <code>ShowView</code>   UI. <br> <br> <code class="cs">private void NavigateToQuestionnaireList() { //     "questionnaire list". this.uiService.ShowView(ViewNames.QuestionnaireTemplatesList); }</code> <br>  UI      UI .           UI.  <code>ShowView</code>  <code>UIService</code>      (,          ),       ,   . <br> <br> <code class="cs">public void ShowView(string viewName) { var view = this.ViewFactory.GetView(viewName); this.MainWindow.CurrentView = view; }</code> <br> <b></b> <br> Prism       .   ,   ,   ,             .    ,  , " <a href="http://msdn.microsoft.com/en-us/library/gg430861(v%3DPandP.40).aspx">View-Based Navigation</a> "   8, " <a href="http://msdn.microsoft.com/en-us/library/gg430861(v%3DPandP.40).aspx">Navigation</a> ". <br>  MVVM  <br>        MVVM      .           -      mocking . ,   ,        . <br> <br>   <i>INotifyPropertyChanged</i> <br>   <code>INotifyPropertyChanged</code>     ,      .      ,    ;   ,   ,     ,    ,       . <br> <br>   <br> ,       ,           <code>PropertyChanged</code>  ,         .  ,    <code>ChangeTracker</code> ,     MVVM,  ,      .      .     ,    . <br> <br> <code class="cs">var changeTracker = new PropertyChangeTracker(viewModel); viewModel.CurrentState = "newState"; CollectionAssert.Contains(changeTracker.ChangedProperties, "CurrentState");</code> <br> ,     ,     <code>INotifyPropertyChanged</code> ,    ,   ,     . <br> <br>      <br>        ,   ,    <code>set</code>      ,           . ,     ,     ,      ,          . <br> <br> <code class="cs">var changeTracker = new PropertyChangeTracker(viewModel); var question = viewModel.Questions.First() as OpenQuestionViewModel; question.Question.Response = "some text"; CollectionAssert.Contains(changeTracker.ChangedProperties, "UnansweredQuestions");</code> <br>      <br>     <code>INotifyPropertyChanged</code> ,      <code>PropertyChanged</code>        ,  ,     , , .        ,       . <br> <br>   <i>INotifyDataErrorInfo</i> <br>   ,     ,    ,   ,   <code>IDataErrorInfo</code> ,  ( Silverlight)   <code>INotifyDataErrorInfo</code> .   <code>INotifyDataErrorInfo</code>   ,         ,    ,  ,   ,    . <br> <br>       <code>INotifyDataErrorInfo</code> : ,     ,  ,     ,     <code>ErrorsChanged</code> ,      <code>GetErrors</code> , . <br> <br>    <br>     ,      ,     .       ,         <code>GetErrors</code>       ,  ,  ,   .    , ,  ,     ,        .   ,        . <br> <br> <code class="cs">//  . var notifyErrorInfo = (INotifyDataErrorInfo)question; question.Response = -15; Assert.IsTrue(notifyErrorInfo.GetErrors("Response").Cast&lt;ValidationResult&gt;().Any()); //  . var notifyErrorInfo = (INotifyDataErrorInfo)question; question.Response = 15; Assert.IsFalse(notifyErrorInfo.GetErrors("Response").Cast&lt;ValidationResult&gt;().Any());</code> <br>    ,    ,             . <br> <br>    <i>INotifyDataErrorInfo</i> <br>       <code>GetErrors</code> ,   <code>INotifyDataErrorInfo</code>  ,   <code>ErrorsChanged</code>      <code>GetErrors</code> . ,  <code>HasErrors</code>      ,  . <br> <br>       <code>INotifyDataErrorInfo</code> . , ,           ,   -  .      ,        <code>INotifyDataErrorInfo</code>         (,        ). <br> <br>     ,   ,  : <br>  <code>HasErrors</code>     .              ,       .  <code>ErrorsChanged</code> ,      ,         <code>GetErrors</code> .         ( ,  )     ,           .    <code>GetErrors</code>       <code>ErrorsChanged</code> . <br>    <code>INotifyPropertyChanged</code> ,  ,    <code>NotifyDataErrorInfoTestHelper</code>    MVVM,        <code>INotifyDataErrorInfo</code> ,       .   ,   ,      ,   .      . <br> <code class="cs">var helper = new NotifyDataErrorInfoTestHelper&lt;NumericQuestion, int?&gt;( question, q =&gt; q.Response); helper.ValidatePropertyChange( 6, NotifyDataErrorInfoBehavior.Nothing); helper.ValidatePropertyChange( 20, NotifyDataErrorInfoBehavior.FiresErrorsChanged | NotifyDataErrorInfoBehavior.HasErrors | NotifyDataErrorInfoBehavior.HasErrorsForProperty); helper.ValidatePropertyChange( null, NotifyDataErrorInfoBehavior.FiresErrorsChanged | NotifyDataErrorInfoBehavior.HasErrors | NotifyDataErrorInfoBehavior.HasErrorsForProperty); helper.ValidatePropertyChange( 2, NotifyDataErrorInfoBehavior.FiresErrorsChanged);</code> <br>     <br>   MVVM,     ,  .   ,    ,         . <br> <br>  ,     ,     ,       .   ,   , ,       ,     ,   <code>IAsyncResult</code>    ,  - ,   ,    UI. <br> <br>       , , ,    .   ,     .  ,      UI,     ,   ,          ,     ,        "   UI." <br> <br>     ,    ,    .   ,    ,     mock-, ,   ,   ,      ,          . <br> <br>           UI,    ,    .   ,     ,   ,      .        ,   .     ,    ,     . <br> <br> <code class="cs">questionnaireRepositoryMock .Setup( r =&gt; r.SubmitQuestionnaireAsync( It.IsAny&lt;Questionnaire&gt;(), It.IsAny&lt;Action&lt;IOperationResult&gt;&gt;())) .Callback&lt;Questionnaire, Action&lt;IOperationResult&gt;&gt;( (q, a) =&gt; callback = a); uiServicemock .Setup(svc =&gt; svc.ShowView(ViewNames.QuestionnaireTemplatesList)) .Callback&lt;string&gt;(viewName =&gt; requestedViewName = viewName); submitResultMock .Setup(sr =&gt; sr.Error) .Returns&lt;Exception&gt;(null); CompleteQuestionnaire(viewModel); viewModel.Submit(); //      UI . callback(submitResultMock.Object); //    ‚Äì     . Assert.AreEqual(ViewNames.QuestionnaireTemplatesList, requestedViewName);</code> <br> <b></b> <br>          ,        . <br>   <br>       , . "Trees in WPF"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ms753391.aspx">http://msdn.microsoft.com/en-us/library/ms753391.aspx</a> <br> <br>       , . "Attached Properties Overview"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/cc265152(VS.95).aspx">http://msdn.microsoft.com/en-us/library/cc265152(VS.95).aspx</a> <br> <br>      MEF, ."Managed Extensibility Framework Overview"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/dd460648.aspx">http://msdn.microsoft.com/en-us/library/dd460648.aspx</a> . <br> <br>      Unity, ."Unity Application Block"  MSDN: <a href="http://www.msdn.com/unity">http://www.msdn.com/unity</a> . <br> <br>      <code>DelegateCommand</code> , .Chapter 5, " <a href="http://msdn.microsoft.com/en-us/library/gg405484(v%3DPandP.40).aspx">Implementing the MVVM Pattern</a> ." <br> <br>        Microsoft Expression Blend, ."Working with built-in behaviors"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ff724013(v%3DExpression.40).aspx">http://msdn.microsoft.com/en-us/library/ff724013(v=Expression.40).aspx</a> . <br> <br>          Microsoft Expression Blend, ."Creating Custom Behaviors"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ff724708(v%3DExpression.40).aspx">http://msdn.microsoft.com/en-us/library/ff724708(v=Expression.40).aspx</a> . <br> <br>            Microsoft Expression Blend, ."Creating Custom Triggers and Actions"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ff724707(v%3DExpression.40).aspx">http://msdn.microsoft.com/en-us/library/ff724707(v=Expression.40).aspx</a> . <br> <br>         WPF  Silverlight, ."Threading Model"  "The Dispatcher Class"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ms741870.aspx">http://msdn.microsoft.com/en-us/library/ms741870.aspx</a> <br> <a href="http://msdn.microsoft.com/en-us/library/ms615907(v%3DVS.95).aspx">http://msdn.microsoft.com/en-us/library/ms615907(v=VS.95).aspx</a> . <br> <br>      unit-  Silverlight, ."Unit Testing with Silverlight 2": <a href="http://www.jeff.wilcox.name/2008/03/silverlight2-unit-testing/">http://www.jeff.wilcox.name/2008/03/silverlight2-unit-testing/</a> . <br> <br>         , .  " <a href="http://msdn.microsoft.com/en-us/library/gg430861(v%3DPandP.40).aspx">View-Based Navigation</a> " in Chapter 8, " <a href="http://msdn.microsoft.com/en-us/library/gg430861(v%3DPandP.40).aspx">Navigation</a> ." <br> <br>       ,   , ."Event-based Asynchronous Pattern Overview"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/wewwczdw.aspx">http://msdn.microsoft.com/en-us/library/wewwczdw.aspx</a> <br> <br>        <code>IAsyncResult</code> , ."Asynchronous Programming Overview"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ms228963.aspx">http://msdn.microsoft.com/en-us/library/ms228963.aspx</a></code></code></code></code></code></code></code></code></code> <pre> <code class="hljs cmake"><code>CommandBehaviorBase ,    ,    ICommand</code> .           <code>CanExecuteChanged</code> ,          Silverlight,    WPF. <br> <br>    ,  ,   <code><code>CommandBehaviorBase    ,    .         ,      .         ,    .      ButtonBaseClickCommandBehavior</code> . <br> <br> <code class="cs">public class ButtonBaseClickCommandBehavior : CommandBehaviorBase&lt;ButtonBase&gt; { public ButtonBaseClickCommandBehavior(ButtonBase clickableObject) : base(clickableObject) { clickableObject.Click += OnClick; } private void OnClick(object sender, System.Windows.RoutedEventArgs e) { ExecuteCommand(); } }</code> <br>   <code><code>CommandBehaviorBase ,     .     ,          ,   . ,    ,    ,      , ,    CanExecute</code>  ,     . <br> <br>          ,   .           XAML.           .       .  Prism      ,       ,  ,   .       ,    . , ,  ,      <code>Click</code> ,       <code><span class="hljs-keyword"><span class="hljs-keyword">Command</span></span></code> .    <code>Click.<span class="hljs-keyword"><span class="hljs-keyword">Command</span></span></code> ,  . <br> <br>             .             . <br> <br> <code class="cs">public static readonly DependencyProperty CommandProperty = DependencyProperty.RegisterAttached( <span class="hljs-string"><span class="hljs-string">"Command"</span></span>, typeof(ICommand), typeof(Click), new PropertyMetadata(OnSetCommandCallback)); private static readonly DependencyProperty ClickCommandBehaviorProperty = DependencyProperty.RegisterAttached( <span class="hljs-string"><span class="hljs-string">"ClickCommandBehavior"</span></span>, typeof(ButtonBaseClickCommandBehavior), typeof(Click), null);</code> <br>    <code><span class="hljs-keyword"><span class="hljs-keyword">Command</span></span></code>    <code>ButtonBaseClickCommandBehavior</code> ,     <code>OnSetCommandCallback</code> ,     . <br> <br> <code class="cs">private static void OnSetCommandCallback(DependencyObject dependencyObject, DependencyPropertyChangedEventArgs e) { ButtonBase buttonBase = dependencyObject as ButtonBase; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (buttonBase != null) { ButtonBaseClickCommandBehavior behavior = GetOrCreateBehavior(buttonBase); behavior.<span class="hljs-keyword"><span class="hljs-keyword">Command</span></span> = e.NewValue as ICommand; } } private static void OnSetCommandParameterCallback(DependencyObject dependencyObject, DependencyPropertyChangedEventArgs e) { ButtonBase buttonBase = dependencyObject as ButtonBase; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (buttonBase != null) { ButtonBaseClickCommandBehavior behavior = GetOrCreateBehavior(buttonBase); behavior.CommandParameter = e.NewValue; } } private static ButtonBaseClickCommandBehavior GetOrCreateBehavior(ButtonBase buttonBase ) { ButtonBaseClickCommandBehavior behavior = buttonBase.GetValue(ClickCommandBehaviorProperty) as ButtonBaseClickCommandBehavior; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ( behavior == null ) { behavior = new ButtonBaseClickCommandBehavior(buttonBase); buttonBase.SetValue(ClickCommandBehaviorProperty, behavior); } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> behavior; }</code> <br>        ,  <a href="http://msdn.microsoft.com/en-us/library/cc265152(VS.95).aspx">Attached Properties Overview</a>  MSDN. <br> <br>    <br>              . ,     Silverlight,    -,     ,      ,     .     ,       . <br> <br>        ,    ( )  ,  ,     .  UI       ,            UI. <br> <br>      - <br>   -     ,       <code>IAsyncResult</code> .   ,  ,   ,  <code>GetQuestionnaire</code> ,   : <code>BeginGetQuestionnaire</code>  <code>EndGetQuestionnaire</code> .    ,   <code>BeginGetQuestionnaire</code> .     ,   ,   <code>EndGetQuestionnaire</code>    . <br> <b></b> <br>  .NET Framework <span class="hljs-number"><span class="hljs-number">4.5</span></span>      <code>await</code>  <code>async</code>     <code>*Async</code> .      <a href="http://msdn.microsoft.com/en-us/library/vstudio/hh391443.aspx"><span class="hljs-string"><span class="hljs-string">"Asynchronous Programming with Async and Await (C# and Visual Basic)"</span></span></a> . <br>  ,    <code>EndGetQuestionnaire</code> ,      ,  ()      <code>BeginGetQuestionnaire</code> .     ,      ,   <code>EndGetQuestionnaire</code> ,   . <br> <br> <code class="xml">IAsyncResult asyncResult = this.service.BeginGetQuestionnaire( GetQuestionnaireCompleted, null //  ,      ); private void GetQuestionnaireCompleted(IAsyncResult result) { try { questionnaire = this.service.EndGetQuestionnaire(ar); } catch (Exception ex) { //  -   . } }</code> <br>  ,     <code>End*</code> (  , <code>EndGetQuestionnaire</code> ),    ,      .      , ,          UI.     ,   ,        . <br> <br>        UI,     -,      UI,         UI,   <code>Dispatcher</code>    <code>SynchronizationContext</code> .  WPF  Silverlight,   <code>Dispatcher</code> . <br> <br>      <code>Questionnaire</code>  ,        <code>QuestionnaireView</code> .  Silverlight    <code>CheckAccess</code> ,  ,      UI.  ,     <code>BeginInvoke</code> ,      UI. <br> <br> <code class="cs">var dispatcher = System.Windows.Deployment.Current.Dispatcher; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (dispatcher.CheckAccess()) { QuestionnaireView.DataContext = questionnaire; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { dispatcher.BeginInvoke(() =&gt; { Questionnaire.DataContext = questionnaire; }); }</code> <br> <i>MVVM RI</i>   ,    ,   <code>IAsyncResult</code> ,   .      ,                 . ,       . <br> <br> <code class="cs">this.questionnaireRepository.GetQuestionnaireAsync( result =&gt; { this.Questionnaire = result.Result; });</code> <br>  <code>result</code>   ,     , , , .    ,     . <br> <br> <code class="cs">this.questionnaireRepository.GetQuestionnaireAsync( result =&gt; { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (result.Error == null) { this.Questionnaire = result.Result; ... } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { // Handle error. } })</code> <br>     <br>        ,      .     , ,             .        ,      ,     ,     . <br> <br>         ,      MVVM,     ,   . ,  -MVVM ,     <code>MessageBox</code>   code-behind UI,      .   MVVM     ,          . <br> <br>     MVVM,              ,          .      ,    ,   ,  ,     . <br> <br>              MVVM.      ,     ,     ,  ,     .    ,         ,     ,          .       . <br> <br>    <br>                  .        ,        .  ,         .         . <br> <br>  ,         ,         ,  .      ,     .           ,       . ,        WPF  Silverlight,        . <br> <br> <img title="Using the service to interact with the user." src="https://habrastorage.org/getpro/habr/post_images/4b5/397/f2d/4b5397f2d02e5851195b29f1893be6fc.png" alt=" ,    ."> <br> <br>  ,   <code>MessageBox</code>        ,     ,    ,     . <br> <br> <code class="cs">var result = interactionService.ShowMessageBox( <span class="hljs-string"><span class="hljs-string">"Are you sure you want to cancel this operation?"</span></span>, <span class="hljs-string"><span class="hljs-string">"Confirm"</span></span>, MessageBoxButton.OK); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (result == MessageBoxResult.Yes) { CancelRequest(); }</code> <br> ,      - ,      ,         Silverlight.         .             .     . <br> <br> <code class="cs">interactionService.ShowMessageBox( <span class="hljs-string"><span class="hljs-string">"Are you sure you want to cancel this operation?"</span></span>, <span class="hljs-string"><span class="hljs-string">"Confirm"</span></span>, MessageBoxButton.OK, result =&gt; { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (result == MessageBoxResult.Yes) { CancelRequest(); } });</code> <br>         ,      . ,  WPF    <code>MessageBox</code> ,       ;    Silverlight    ,    . <br> <br>     <br>         ‚Äì             .         ,      .     ,     .        ,        ,   ,     . <br> <br> <img title="Using interaction request objects." src="https://habrastorage.org/getpro/habr/post_images/3d0/ff0/1c5/3d0ff01c5518558c2d3c5c5f47ce0ce9.png" alt="   ."> <br> <br>    ,   ,          ‚Äì       ,      ,   ‚Äì     .   ,        ,    ,    UI            . <br> <br>       MVVM,     ,       ,         .         ,        ,    ,   . <br> <br>  Prism       <code>IInteractionRequest</code>   <code><code>InteractionRequest .  IInteractionRequest</code>  ,   .           ,   .  <code><code>InteractionRequest   IInteractionRequest</code>     <code>Raise</code> ,           , , ,   . <br> <br>       <br>  <code><code>InteractionRequest          .  Raise</code>          ( <code>T</code> )    ,    ,   .          ,       .      ,        .    ,  ,     . <br> <code class="cs">public interface IInteractionRequest { event EventHandler&lt;InteractionRequestedEventArgs&gt; Raised; } public class InteractionRequest&lt;T&gt; : IInteractionRequest { public event EventHandler&lt;InteractionRequestedEventArgs&gt; Raised; public void Raise(T context, Action&lt;T&gt; callback) { var handler = this.Raised; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (handler != null) { handler( this, new InteractionRequestedEventArgs(context, () =&gt; callback(context))); } } }</code> <br> Prism    ,      .  <code>Notification</code>       .    ,            .     ‚Äì <code>Title</code>  <code>Content</code> ,    .  ,   ,  ,  ,        . <br> <br>  <code>Confirmation</code>    <code>Notification</code>     ‚Äì <code>Confirmed</code> ,  ,  ,      .  <code>Confirmation</code> ,     <code>MessageBox</code> ,     /  .     ,     <code>Notification</code> ,     ,      . <br> <br>    <code><code><code>InteractionRequest ,       InteractionRequest      ,      .      ,    Raise</code> ,    , ,   . <br> <br> <code class="cs">public IInteractionRequest ConfirmCancelInteractionRequest { get { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> this.confirmCancelInteractionRequest; } } this.confirmCancelInteractionRequest.Raise( new Confirmation(<span class="hljs-string"><span class="hljs-string">"Are you sure you wish to cancel?"</span></span>), confirmation =&gt; { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (confirmation.Confirmed) { this.NavigateToQuestionnaireList(); } }); }</code> <br> <i>MVVM Reference Implementation (MVVM RI)</i> ,    <code>IInteractionRequest</code>   <code><code>InteractionRequest ,          (. QuestionnaireViewModel.cs</code> ). <br> <br>        <br>       ,       .   ,       .    UI             . <br> <br>                . Microsoft Expression Blend Behaviors Framework     .  ,     ,    . <br> <br>  <code>EventTrigger</code> ,  Expression Blend,  ,      ,     ,   . , Prism   <code>EventTrigger</code> ,  <code>InteractionRequestTrigger</code> ,      <code>Raised</code>   <code>IInteractionRequest</code> .    XAML        . <br> <br>  ,   , <code>InteractionRequestTrigger</code>   .  Silverlight Prism   <code>PopupChildWindowAction</code> ,     .    ,         .   <code>ContentTemplate</code>  <code>PopupChildWindowAction</code> ,    ,    UI,      <code>Content</code>  .       <code>Title</code>  . <br> <b></b> <br>  ,    ,   <code>PopupChildWindowAction</code> ,     .    <code>Notification</code>  <code>NotificationChildWindow</code> ,        <code>Confirmation</code> ‚Äì <code>ConfirmationChildWindow</code> . <code>NotificationChildWindow</code>    ,   ,     <code>ConfirmationChildWindow</code>    <i>OK</i>  <i>Cancel</i> ,    .    ,   ,   <code>ChildWindow</code>  <code>PopupChildWindowAction</code> . <br>   ,  <code>InteractionRequestTrigger</code>  <code>PopupChildWindowAction</code> ,       <i>RI MVVM</i> . <br> <br> <code class="xml">&lt;i:Interaction.Triggers&gt; &lt;prism:InteractionRequestTrigger SourceObject=<span class="hljs-string"><span class="hljs-string">"{Binding ConfirmCancelInteractionRequest}"</span></span>&gt; &lt;prism:PopupChildWindowAction ContentTemplate=<span class="hljs-string"><span class="hljs-string">"{StaticResource ConfirmWindowTemplate}"</span></span>/&gt; &lt;/prism:InteractionRequestTrigger&gt; &lt;/i:Interaction.Triggers&gt; &lt;UserControl.Resources&gt; &lt;DataTemplate x:Key=<span class="hljs-string"><span class="hljs-string">"ConfirmWindowTemplate"</span></span>&gt; &lt;Grid MinWidth=<span class="hljs-string"><span class="hljs-string">"250"</span></span> MinHeight=<span class="hljs-string"><span class="hljs-string">"100"</span></span>&gt; &lt;TextBlock TextWrapping=<span class="hljs-string"><span class="hljs-string">"Wrap"</span></span> Grid.Row=<span class="hljs-string"><span class="hljs-string">"0"</span></span> Text=<span class="hljs-string"><span class="hljs-string">"{Binding}"</span></span>/&gt; &lt;/Grid&gt; &lt;/DataTemplate&gt; &lt;/UserControl.Resources&gt;</code> <br> <b></b> <br>      <code>ContentTemplate</code> ,   UI   <code>Content</code>  .    <code>Content</code>  ,  , <code>TextBlock</code>     <code>Content</code> . <br>      ,     ,    ,    .  ,     ,       ,     ,    .   ,   <i>RI MVVM</i> ,         <code>Confirmed</code>    <code>Confirmation</code>  <code><span class="hljs-keyword"><span class="hljs-keyword">true</span></span></code> ,     OK. <br> <br>        ,     .  Prism <code>InteractionRequestTrigger</code>   <code>PopupChildWindowAction</code>            . <br> <br>     <br>     MVVM,       , ,    ,         .        (  , ,  ,   ).    ,  ,  ,            . <br> <br>        ,         . Managed Extensibility Framework (MEF)  Unity Application Block (Unity)      ,  ,           . <br> <br>  ,       , , ,    ( )      . ,       ,     .  ,     ,       . <br> <br>     ,  MEF <br>  MEF,       ,   <code>Import</code> ,      ,  ,   <code><span class="hljs-keyword"><span class="hljs-keyword">Export</span></span></code> .         ,    . <br> <br> , <code>QuestionnaireView</code>   <i>RI MVVM</i> ,        ,    <code>Import</code> .   , MEF           .  <code><span class="hljs-keyword"><span class="hljs-keyword">set</span></span></code>        ,   . <br> <br> <code class="cs">[Import] public QuestionnaireViewModel ViewModel { <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> { this.DataContext = value; } }</code> <br>     ,   . <br> <br> <code class="cs">[<span class="hljs-keyword"><span class="hljs-keyword">Export</span></span>] public class QuestionnaireViewModel : NotificationObject { ... }</code> <br>        ,   . <br> <br> <code class="cs">public QuestionnaireView() { InitializeComponent(); } [ImportingConstructor] public QuestionnaireView(QuestionnaireViewModel viewModel) : this() { this.DataContext = viewModel; }</code> <br> <b></b> <br>          MEF,   Unity.   ,     ,        .   ,   Visual Studio  Expression Blend, ,        ,     .   ,   ,  ,      ,          <code>InitializeComponent</code> . <br>     ,  Unity <br>  Unity,    ,   MEF.     ,      .    ,         .  ,      . <br> <br>  ,      ,  ,         . ,           ,   . <br> <br> <code class="cs">public QuestionnaireView() { InitializeComponent(); } public QuestionnaireView(QuestionnaireViewModel viewModel) : this() { this.DataContext = viewModel; }</code> <br> <b></b> <br>    ,        ,   Visual Studio  Expression Blend. <br>  ,          ,   . Unity        <code><span class="hljs-keyword"><span class="hljs-keyword">set</span></span></code>   ,   . <br> <br> <code class="cs">public QuestionnaireView() { InitializeComponent(); } [Dependency] public QuestionnaireViewModel ViewModel { <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> { this.DataContext = value; } }</code> <br>       Unity. <br> <br> <code class="cs">container.RegisterType&lt;QuestionnaireViewModel&gt;();</code> <br>  ,     . <br> <br> <code class="cs">var view = container.Resolve&lt;QuestionnaireView&gt;();</code> <br>     ,    <br>   ,     ,        .        ,   MEF  Unity,        . <br> <br>          .   ,         UI,           . <br> <br> , <i>RI MVVM</i>   ,   ,        .   ,    .      <code>ShowView</code>   UI. <br> <br> <code class="cs">private void NavigateToQuestionnaireList() { //     <span class="hljs-string"><span class="hljs-string">"questionnaire list"</span></span>. this.uiService.ShowView(ViewNames.QuestionnaireTemplatesList); }</code> <br>  UI      UI .           UI.  <code>ShowView</code>  <code>UIService</code>      (,          ),       ,   . <br> <br> <code class="cs">public void ShowView(<span class="hljs-keyword"><span class="hljs-keyword">string</span></span> viewName) { var view = this.ViewFactory.GetView(viewName); this.MainWindow.CurrentView = view; }</code> <br> <b></b> <br> Prism       .   ,   ,   ,             .    ,  , <span class="hljs-string"><span class="hljs-string">" </span></span><a href="http://msdn.microsoft.com/en-us/library/gg430861(v%3DPandP.40).aspx"><span class="hljs-string"><span class="hljs-string">View-Based Navigation</span></span></a><span class="hljs-string"><span class="hljs-string"> "</span></span>   <span class="hljs-number"><span class="hljs-number">8</span></span>, <span class="hljs-string"><span class="hljs-string">" </span></span><a href="http://msdn.microsoft.com/en-us/library/gg430861(v%3DPandP.40).aspx"><span class="hljs-string"><span class="hljs-string">Navigation</span></span></a><span class="hljs-string"><span class="hljs-string"> "</span></span>. <br>  MVVM  <br>        MVVM      .           -      mocking . ,   ,        . <br> <br>   <i>INotifyPropertyChanged</i> <br>   <code>INotifyPropertyChanged</code>     ,      .      ,    ;   ,   ,     ,    ,       . <br> <br>   <br> ,       ,           <code>PropertyChanged</code>  ,         .  ,    <code>ChangeTracker</code> ,     MVVM,  ,      .      .     ,    . <br> <br> <code class="cs">var changeTracker = new PropertyChangeTracker(viewModel); viewModel.CurrentState = <span class="hljs-string"><span class="hljs-string">"newState"</span></span>; CollectionAssert.Contains(changeTracker.ChangedProperties, <span class="hljs-string"><span class="hljs-string">"CurrentState"</span></span>);</code> <br> ,     ,     <code>INotifyPropertyChanged</code> ,    ,   ,     . <br> <br>      <br>        ,   ,    <code><span class="hljs-keyword"><span class="hljs-keyword">set</span></span></code>      ,           . ,     ,     ,      ,          . <br> <br> <code class="cs">var changeTracker = new PropertyChangeTracker(viewModel); var question = viewModel.Questions.First() as OpenQuestionViewModel; question.Question.Response = <span class="hljs-string"><span class="hljs-string">"some text"</span></span>; CollectionAssert.Contains(changeTracker.ChangedProperties, <span class="hljs-string"><span class="hljs-string">"UnansweredQuestions"</span></span>);</code> <br>      <br>     <code>INotifyPropertyChanged</code> ,      <code>PropertyChanged</code>        ,  ,     , , .        ,       . <br> <br>   <i>INotifyDataErrorInfo</i> <br>   ,     ,    ,   ,   <code>IDataErrorInfo</code> ,  ( Silverlight)   <code>INotifyDataErrorInfo</code> .   <code>INotifyDataErrorInfo</code>   ,         ,    ,  ,   ,    . <br> <br>       <code>INotifyDataErrorInfo</code> : ,     ,  ,     ,     <code>ErrorsChanged</code> ,      <code>GetErrors</code> , . <br> <br>    <br>     ,      ,     .       ,         <code>GetErrors</code>       ,  ,  ,   .    , ,  ,     ,        .   ,        . <br> <br> <code class="cs">//  . var notifyErrorInfo = (INotifyDataErrorInfo)question; question.Response = -<span class="hljs-number"><span class="hljs-number">15</span></span>; Assert.IsTrue(notifyErrorInfo.GetErrors(<span class="hljs-string"><span class="hljs-string">"Response"</span></span>).Cast&lt;ValidationResult&gt;().Any()); //  . var notifyErrorInfo = (INotifyDataErrorInfo)question; question.Response = <span class="hljs-number"><span class="hljs-number">15</span></span>; Assert.IsFalse(notifyErrorInfo.GetErrors(<span class="hljs-string"><span class="hljs-string">"Response"</span></span>).Cast&lt;ValidationResult&gt;().Any());</code> <br>    ,    ,             . <br> <br>    <i>INotifyDataErrorInfo</i> <br>       <code>GetErrors</code> ,   <code>INotifyDataErrorInfo</code>  ,   <code>ErrorsChanged</code>      <code>GetErrors</code> . ,  <code>HasErrors</code>      ,  . <br> <br>       <code>INotifyDataErrorInfo</code> . , ,           ,   -  .      ,        <code>INotifyDataErrorInfo</code>         (,        ). <br> <br>     ,   ,  : <br>  <code>HasErrors</code>     .              ,       .  <code>ErrorsChanged</code> ,      ,         <code>GetErrors</code> .         ( ,  )     ,           .    <code>GetErrors</code>       <code>ErrorsChanged</code> . <br>    <code>INotifyPropertyChanged</code> ,  ,    <code>NotifyDataErrorInfoTestHelper</code>    MVVM,        <code>INotifyDataErrorInfo</code> ,       .   ,   ,      ,   .      . <br> <code class="cs">var helper = new NotifyDataErrorInfoTestHelper&lt;NumericQuestion, int?&gt;( question, q =&gt; q.Response); helper.ValidatePropertyChange( <span class="hljs-number"><span class="hljs-number">6</span></span>, NotifyDataErrorInfoBehavior.Nothing); helper.ValidatePropertyChange( <span class="hljs-number"><span class="hljs-number">20</span></span>, NotifyDataErrorInfoBehavior.FiresErrorsChanged | NotifyDataErrorInfoBehavior.HasErrors | NotifyDataErrorInfoBehavior.HasErrorsForProperty); helper.ValidatePropertyChange( null, NotifyDataErrorInfoBehavior.FiresErrorsChanged | NotifyDataErrorInfoBehavior.HasErrors | NotifyDataErrorInfoBehavior.HasErrorsForProperty); helper.ValidatePropertyChange( <span class="hljs-number"><span class="hljs-number">2</span></span>, NotifyDataErrorInfoBehavior.FiresErrorsChanged);</code> <br>     <br>   MVVM,     ,  .   ,    ,         . <br> <br>  ,     ,     ,       .   ,   , ,       ,     ,   <code>IAsyncResult</code>    ,  - ,   ,    UI. <br> <br>       , , ,    .   ,     .  ,      UI,     ,   ,          ,     ,        <span class="hljs-string"><span class="hljs-string">"   UI."</span></span> <br> <br>     ,    ,    .   ,    ,     mock-, ,   ,   ,      ,          . <br> <br>           UI,    ,    .   ,     ,   ,      .        ,   .     ,    ,     . <br> <br> <code class="cs">questionnaireRepositoryMock .Setup( r =&gt; r.SubmitQuestionnaireAsync( It.IsAny&lt;Questionnaire&gt;(), It.IsAny&lt;Action&lt;IOperationResult&gt;&gt;())) .Callback&lt;Questionnaire, Action&lt;IOperationResult&gt;&gt;( (q, a) =&gt; callback = a); uiServicemock .Setup(svc =&gt; svc.ShowView(ViewNames.QuestionnaireTemplatesList)) .Callback&lt;<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>&gt;(viewName =&gt; requestedViewName = viewName); submitResultMock .Setup(sr =&gt; sr.Error) .Returns&lt;Exception&gt;(null); CompleteQuestionnaire(viewModel); viewModel.Submit(); //      UI . callback(submitResultMock.Object); //    ‚Äì     . Assert.AreEqual(ViewNames.QuestionnaireTemplatesList, requestedViewName);</code> <br> <b></b> <br>          ,        . <br>   <br>       , . <span class="hljs-string"><span class="hljs-string">"Trees in WPF"</span></span>  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ms753391.aspx">http://msdn.microsoft.com/en-us/library/ms753391.aspx</a> <br> <br>       , . <span class="hljs-string"><span class="hljs-string">"Attached Properties Overview"</span></span>  MSDN: <a href="http://msdn.microsoft.com/en-us/library/cc265152(VS.95).aspx">http://msdn.microsoft.com/en-us/library/cc265152(VS.<span class="hljs-number"><span class="hljs-number">95</span></span>).aspx</a> <br> <br>      MEF, .<span class="hljs-string"><span class="hljs-string">"Managed Extensibility Framework Overview"</span></span>  MSDN: <a href="http://msdn.microsoft.com/en-us/library/dd460648.aspx">http://msdn.microsoft.com/en-us/library/dd460648.aspx</a> . <br> <br>      Unity, .<span class="hljs-string"><span class="hljs-string">"Unity Application Block"</span></span>  MSDN: <a href="http://www.msdn.com/unity">http://www.msdn.com/unity</a> . <br> <br>      <code>DelegateCommand</code> , .Chapter <span class="hljs-number"><span class="hljs-number">5</span></span>, <span class="hljs-string"><span class="hljs-string">" </span></span><a href="http://msdn.microsoft.com/en-us/library/gg405484(v%3DPandP.40).aspx"><span class="hljs-string"><span class="hljs-string">Implementing the MVVM Pattern</span></span></a><span class="hljs-string"><span class="hljs-string"> ."</span></span> <br> <br>        Microsoft Expression Blend, .<span class="hljs-string"><span class="hljs-string">"Working with built-in behaviors"</span></span>  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ff724013(v%3DExpression.40).aspx">http://msdn.microsoft.com/en-us/library/ff724013(v=Expression.<span class="hljs-number"><span class="hljs-number">40</span></span>).aspx</a> . <br> <br>          Microsoft Expression Blend, .<span class="hljs-string"><span class="hljs-string">"Creating Custom Behaviors"</span></span>  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ff724708(v%3DExpression.40).aspx">http://msdn.microsoft.com/en-us/library/ff724708(v=Expression.<span class="hljs-number"><span class="hljs-number">40</span></span>).aspx</a> . <br> <br>            Microsoft Expression Blend, .<span class="hljs-string"><span class="hljs-string">"Creating Custom Triggers and Actions"</span></span>  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ff724707(v%3DExpression.40).aspx">http://msdn.microsoft.com/en-us/library/ff724707(v=Expression.<span class="hljs-number"><span class="hljs-number">40</span></span>).aspx</a> . <br> <br>         WPF  Silverlight, .<span class="hljs-string"><span class="hljs-string">"Threading Model"</span></span>  <span class="hljs-string"><span class="hljs-string">"The Dispatcher Class"</span></span>  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ms741870.aspx">http://msdn.microsoft.com/en-us/library/ms741870.aspx</a> <br> <a href="http://msdn.microsoft.com/en-us/library/ms615907(v%3DVS.95).aspx">http://msdn.microsoft.com/en-us/library/ms615907(v=VS.<span class="hljs-number"><span class="hljs-number">95</span></span>).aspx</a> . <br> <br>      unit-  Silverlight, .<span class="hljs-string"><span class="hljs-string">"Unit Testing with Silverlight 2"</span></span>: <a href="http://www.jeff.wilcox.name/2008/03/silverlight2-unit-testing/">http://www.jeff.wilcox.name/<span class="hljs-number"><span class="hljs-number">2008</span></span>/<span class="hljs-number"><span class="hljs-number">03</span></span>/silverlight2-unit-testing/</a> . <br> <br>         , .  <span class="hljs-string"><span class="hljs-string">" </span></span><a href="http://msdn.microsoft.com/en-us/library/gg430861(v%3DPandP.40).aspx"><span class="hljs-string"><span class="hljs-string">View-Based Navigation</span></span></a><span class="hljs-string"><span class="hljs-string"> "</span></span> in Chapter <span class="hljs-number"><span class="hljs-number">8</span></span>, <span class="hljs-string"><span class="hljs-string">" </span></span><a href="http://msdn.microsoft.com/en-us/library/gg430861(v%3DPandP.40).aspx"><span class="hljs-string"><span class="hljs-string">Navigation</span></span></a><span class="hljs-string"><span class="hljs-string"> ."</span></span> <br> <br>       ,   , .<span class="hljs-string"><span class="hljs-string">"Event-based Asynchronous Pattern Overview"</span></span>  MSDN: <a href="http://msdn.microsoft.com/en-us/library/wewwczdw.aspx">http://msdn.microsoft.com/en-us/library/wewwczdw.aspx</a> <br> <br>        <code>IAsyncResult</code> , .<span class="hljs-string"><span class="hljs-string">"Asynchronous Programming Overview"</span></span>  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ms228963.aspx">http://msdn.microsoft.com/en-us/library/ms228963.aspx</a></code></code></code></code></code></code></code></code></code> </pre> <code><code><code><code><code><code><code><code><code><code>CommandBehaviorBase ,    ,    ICommand</code> .           <code>CanExecuteChanged</code> ,          Silverlight,    WPF. <br> <br>    ,  ,   <code>CommandBehaviorBase    ,    .         ,      .         ,    .      ButtonBaseClickCommandBehavior</code> . <br> <br> <code class="cs">public class ButtonBaseClickCommandBehavior : CommandBehaviorBase&lt;ButtonBase&gt; { public ButtonBaseClickCommandBehavior(ButtonBase clickableObject) : base(clickableObject) { clickableObject.Click += OnClick; } private void OnClick(object sender, System.Windows.RoutedEventArgs e) { ExecuteCommand(); } }</code> <br>   <code>CommandBehaviorBase ,     .     ,          ,   . ,    ,    ,      , ,    CanExecute</code>  ,     . <br> <br>          ,   .           XAML.           .       .  Prism      ,       ,  ,   .       ,    . , ,  ,      <code>Click</code> ,       <code>Command</code> .    <code>Click.Command</code> ,  . <br> <br>             .             . <br> <br> <code class="cs">public static readonly DependencyProperty CommandProperty = DependencyProperty.RegisterAttached( "Command", typeof(ICommand), typeof(Click), new PropertyMetadata(OnSetCommandCallback)); private static readonly DependencyProperty ClickCommandBehaviorProperty = DependencyProperty.RegisterAttached( "ClickCommandBehavior", typeof(ButtonBaseClickCommandBehavior), typeof(Click), null);</code> <br>    <code>Command</code>    <code>ButtonBaseClickCommandBehavior</code> ,     <code>OnSetCommandCallback</code> ,     . <br> <br> <code class="cs">private static void OnSetCommandCallback(DependencyObject dependencyObject, DependencyPropertyChangedEventArgs e) { ButtonBase buttonBase = dependencyObject as ButtonBase; if (buttonBase != null) { ButtonBaseClickCommandBehavior behavior = GetOrCreateBehavior(buttonBase); behavior.Command = e.NewValue as ICommand; } } private static void OnSetCommandParameterCallback(DependencyObject dependencyObject, DependencyPropertyChangedEventArgs e) { ButtonBase buttonBase = dependencyObject as ButtonBase; if (buttonBase != null) { ButtonBaseClickCommandBehavior behavior = GetOrCreateBehavior(buttonBase); behavior.CommandParameter = e.NewValue; } } private static ButtonBaseClickCommandBehavior GetOrCreateBehavior(ButtonBase buttonBase ) { ButtonBaseClickCommandBehavior behavior = buttonBase.GetValue(ClickCommandBehaviorProperty) as ButtonBaseClickCommandBehavior; if ( behavior == null ) { behavior = new ButtonBaseClickCommandBehavior(buttonBase); buttonBase.SetValue(ClickCommandBehaviorProperty, behavior); } return behavior; }</code> <br>        ,  <a href="http://msdn.microsoft.com/en-us/library/cc265152(VS.95).aspx">Attached Properties Overview</a>  MSDN. <br> <br>    <br>              . ,     Silverlight,    -,     ,      ,     .     ,       . <br> <br>        ,    ( )  ,  ,     .  UI       ,            UI. <br> <br>      - <br>   -     ,       <code>IAsyncResult</code> .   ,  ,   ,  <code>GetQuestionnaire</code> ,   : <code>BeginGetQuestionnaire</code>  <code>EndGetQuestionnaire</code> .    ,   <code>BeginGetQuestionnaire</code> .     ,   ,   <code>EndGetQuestionnaire</code>    . <br> <b></b> <br>  .NET Framework 4.5      <code>await</code>  <code>async</code>     <code>*Async</code> .      <a href="http://msdn.microsoft.com/en-us/library/vstudio/hh391443.aspx">"Asynchronous Programming with Async and Await (C# and Visual Basic)"</a> . <br>  ,    <code>EndGetQuestionnaire</code> ,      ,  ()      <code>BeginGetQuestionnaire</code> .     ,      ,   <code>EndGetQuestionnaire</code> ,   . <br> <br> <code class="xml">IAsyncResult asyncResult = this.service.BeginGetQuestionnaire( GetQuestionnaireCompleted, null //  ,      ); private void GetQuestionnaireCompleted(IAsyncResult result) { try { questionnaire = this.service.EndGetQuestionnaire(ar); } catch (Exception ex) { //  -   . } }</code> <br>  ,     <code>End*</code> (  , <code>EndGetQuestionnaire</code> ),    ,      .      , ,          UI.     ,   ,        . <br> <br>        UI,     -,      UI,         UI,   <code>Dispatcher</code>    <code>SynchronizationContext</code> .  WPF  Silverlight,   <code>Dispatcher</code> . <br> <br>      <code>Questionnaire</code>  ,        <code>QuestionnaireView</code> .  Silverlight    <code>CheckAccess</code> ,  ,      UI.  ,     <code>BeginInvoke</code> ,      UI. <br> <br> <code class="cs">var dispatcher = System.Windows.Deployment.Current.Dispatcher; if (dispatcher.CheckAccess()) { QuestionnaireView.DataContext = questionnaire; } else { dispatcher.BeginInvoke(() =&gt; { Questionnaire.DataContext = questionnaire; }); }</code> <br> <i>MVVM RI</i>   ,    ,   <code>IAsyncResult</code> ,   .      ,                 . ,       . <br> <br> <code class="cs">this.questionnaireRepository.GetQuestionnaireAsync( result =&gt; { this.Questionnaire = result.Result; });</code> <br>  <code>result</code>   ,     , , , .    ,     . <br> <br> <code class="cs">this.questionnaireRepository.GetQuestionnaireAsync( result =&gt; { if (result.Error == null) { this.Questionnaire = result.Result; ... } else { // Handle error. } })</code> <br>     <br>        ,      .     , ,             .        ,      ,     ,     . <br> <br>         ,      MVVM,     ,   . ,  -MVVM ,     <code>MessageBox</code>   code-behind UI,      .   MVVM     ,          . <br> <br>     MVVM,              ,          .      ,    ,   ,  ,     . <br> <br>              MVVM.      ,     ,     ,  ,     .    ,         ,     ,          .       . <br> <br>    <br>                  .        ,        .  ,         .         . <br> <br>  ,         ,         ,  .      ,     .           ,       . ,        WPF  Silverlight,        . <br> <br> <img title="Using the service to interact with the user." src="https://habrastorage.org/getpro/habr/post_images/4b5/397/f2d/4b5397f2d02e5851195b29f1893be6fc.png" alt=" ,    ."> <br> <br>  ,   <code>MessageBox</code>        ,     ,    ,     . <br> <br> <code class="cs">var result = interactionService.ShowMessageBox( "Are you sure you want to cancel this operation?", "Confirm", MessageBoxButton.OK); if (result == MessageBoxResult.Yes) { CancelRequest(); }</code> <br> ,      - ,      ,         Silverlight.         .             .     . <br> <br> <code class="cs">interactionService.ShowMessageBox( "Are you sure you want to cancel this operation?", "Confirm", MessageBoxButton.OK, result =&gt; { if (result == MessageBoxResult.Yes) { CancelRequest(); } });</code> <br>         ,      . ,  WPF    <code>MessageBox</code> ,       ;    Silverlight    ,    . <br> <br>     <br>         ‚Äì             .         ,      .     ,     .        ,        ,   ,     . <br> <br> <img title="Using interaction request objects." src="https://habrastorage.org/getpro/habr/post_images/3d0/ff0/1c5/3d0ff01c5518558c2d3c5c5f47ce0ce9.png" alt="   ."> <br> <br>    ,   ,          ‚Äì       ,      ,   ‚Äì     .   ,        ,    ,    UI            . <br> <br>       MVVM,     ,       ,         .         ,        ,    ,   . <br> <br>  Prism       <code>IInteractionRequest</code>   <code>InteractionRequest .  IInteractionRequest</code>  ,   .           ,   .  <code>InteractionRequest   IInteractionRequest</code>     <code>Raise</code> ,           , , ,   . <br> <br>       <br>  <code>InteractionRequest          .  Raise</code>          ( <code>T</code> )    ,    ,   .          ,       .      ,        .    ,  ,     . <br> <code class="cs">public interface IInteractionRequest { event EventHandler&lt;InteractionRequestedEventArgs&gt; Raised; } public class InteractionRequest&lt;T&gt; : IInteractionRequest { public event EventHandler&lt;InteractionRequestedEventArgs&gt; Raised; public void Raise(T context, Action&lt;T&gt; callback) { var handler = this.Raised; if (handler != null) { handler( this, new InteractionRequestedEventArgs(context, () =&gt; callback(context))); } } }</code> <br> Prism    ,      .  <code>Notification</code>       .    ,            .     ‚Äì <code>Title</code>  <code>Content</code> ,    .  ,   ,  ,  ,        . <br> <br>  <code>Confirmation</code>    <code>Notification</code>     ‚Äì <code>Confirmed</code> ,  ,  ,      .  <code>Confirmation</code> ,     <code>MessageBox</code> ,     /  .     ,     <code>Notification</code> ,     ,      . <br> <br>    <code>InteractionRequest ,       InteractionRequest      ,      .      ,    Raise</code> ,    , ,   . <br> <br> <code class="cs">public IInteractionRequest ConfirmCancelInteractionRequest { get { return this.confirmCancelInteractionRequest; } } this.confirmCancelInteractionRequest.Raise( new Confirmation("Are you sure you wish to cancel?"), confirmation =&gt; { if (confirmation.Confirmed) { this.NavigateToQuestionnaireList(); } }); }</code> <br> <i>MVVM Reference Implementation (MVVM RI)</i> ,    <code>IInteractionRequest</code>   <code>InteractionRequest ,          (. QuestionnaireViewModel.cs</code> ). <br> <br>        <br>       ,       .   ,       .    UI             . <br> <br>                . Microsoft Expression Blend Behaviors Framework     .  ,     ,    . <br> <br>  <code>EventTrigger</code> ,  Expression Blend,  ,      ,     ,   . , Prism   <code>EventTrigger</code> ,  <code>InteractionRequestTrigger</code> ,      <code>Raised</code>   <code>IInteractionRequest</code> .    XAML        . <br> <br>  ,   , <code>InteractionRequestTrigger</code>   .  Silverlight Prism   <code>PopupChildWindowAction</code> ,     .    ,         .   <code>ContentTemplate</code>  <code>PopupChildWindowAction</code> ,    ,    UI,      <code>Content</code>  .       <code>Title</code>  . <br> <b></b> <br>  ,    ,   <code>PopupChildWindowAction</code> ,     .    <code>Notification</code>  <code>NotificationChildWindow</code> ,        <code>Confirmation</code> ‚Äì <code>ConfirmationChildWindow</code> . <code>NotificationChildWindow</code>    ,   ,     <code>ConfirmationChildWindow</code>    <i>OK</i>  <i>Cancel</i> ,    .    ,   ,   <code>ChildWindow</code>  <code>PopupChildWindowAction</code> . <br>   ,  <code>InteractionRequestTrigger</code>  <code>PopupChildWindowAction</code> ,       <i>RI MVVM</i> . <br> <br> <code class="xml">&lt;i:Interaction.Triggers&gt; &lt;prism:InteractionRequestTrigger SourceObject="{Binding ConfirmCancelInteractionRequest}"&gt; &lt;prism:PopupChildWindowAction ContentTemplate="{StaticResource ConfirmWindowTemplate}"/&gt; &lt;/prism:InteractionRequestTrigger&gt; &lt;/i:Interaction.Triggers&gt; &lt;UserControl.Resources&gt; &lt;DataTemplate x:Key="ConfirmWindowTemplate"&gt; &lt;Grid MinWidth="250" MinHeight="100"&gt; &lt;TextBlock TextWrapping="Wrap" Grid.Row="0" Text="{Binding}"/&gt; &lt;/Grid&gt; &lt;/DataTemplate&gt; &lt;/UserControl.Resources&gt;</code> <br> <b></b> <br>      <code>ContentTemplate</code> ,   UI   <code>Content</code>  .    <code>Content</code>  ,  , <code>TextBlock</code>     <code>Content</code> . <br>      ,     ,    ,    .  ,     ,       ,     ,    .   ,   <i>RI MVVM</i> ,         <code>Confirmed</code>    <code>Confirmation</code>  <code>true</code> ,     OK. <br> <br>        ,     .  Prism <code>InteractionRequestTrigger</code>   <code>PopupChildWindowAction</code>            . <br> <br>     <br>     MVVM,       , ,    ,         .        (  , ,  ,   ).    ,  ,  ,            . <br> <br>        ,         . Managed Extensibility Framework (MEF)  Unity Application Block (Unity)      ,  ,           . <br> <br>  ,       , , ,    ( )      . ,       ,     .  ,     ,       . <br> <br>     ,  MEF <br>  MEF,       ,   <code>Import</code> ,      ,  ,   <code>Export</code> .         ,    . <br> <br> , <code>QuestionnaireView</code>   <i>RI MVVM</i> ,        ,    <code>Import</code> .   , MEF           .  <code>set</code>        ,   . <br> <br> <code class="cs">[Import] public QuestionnaireViewModel ViewModel { set { this.DataContext = value; } }</code> <br>     ,   . <br> <br> <code class="cs">[Export] public class QuestionnaireViewModel : NotificationObject { ... }</code> <br>        ,   . <br> <br> <code class="cs">public QuestionnaireView() { InitializeComponent(); } [ImportingConstructor] public QuestionnaireView(QuestionnaireViewModel viewModel) : this() { this.DataContext = viewModel; }</code> <br> <b></b> <br>          MEF,   Unity.   ,     ,        .   ,   Visual Studio  Expression Blend, ,        ,     .   ,   ,  ,      ,          <code>InitializeComponent</code> . <br>     ,  Unity <br>  Unity,    ,   MEF.     ,      .    ,         .  ,      . <br> <br>  ,      ,  ,         . ,           ,   . <br> <br> <code class="cs">public QuestionnaireView() { InitializeComponent(); } public QuestionnaireView(QuestionnaireViewModel viewModel) : this() { this.DataContext = viewModel; }</code> <br> <b></b> <br>    ,        ,   Visual Studio  Expression Blend. <br>  ,          ,   . Unity        <code>set</code>   ,   . <br> <br> <code class="cs">public QuestionnaireView() { InitializeComponent(); } [Dependency] public QuestionnaireViewModel ViewModel { set { this.DataContext = value; } }</code> <br>       Unity. <br> <br> <code class="cs">container.RegisterType&lt;QuestionnaireViewModel&gt;();</code> <br>  ,     . <br> <br> <code class="cs">var view = container.Resolve&lt;QuestionnaireView&gt;();</code> <br>     ,    <br>   ,     ,        .        ,   MEF  Unity,        . <br> <br>          .   ,         UI,           . <br> <br> , <i>RI MVVM</i>   ,   ,        .   ,    .      <code>ShowView</code>   UI. <br> <br> <code class="cs">private void NavigateToQuestionnaireList() { //     "questionnaire list". this.uiService.ShowView(ViewNames.QuestionnaireTemplatesList); }</code> <br>  UI      UI .           UI.  <code>ShowView</code>  <code>UIService</code>      (,          ),       ,   . <br> <br> <code class="cs">public void ShowView(string viewName) { var view = this.ViewFactory.GetView(viewName); this.MainWindow.CurrentView = view; }</code> <br> <b></b> <br> Prism       .   ,   ,   ,             .    ,  , " <a href="http://msdn.microsoft.com/en-us/library/gg430861(v%3DPandP.40).aspx">View-Based Navigation</a> "   8, " <a href="http://msdn.microsoft.com/en-us/library/gg430861(v%3DPandP.40).aspx">Navigation</a> ". <br>  MVVM  <br>        MVVM      .           -      mocking . ,   ,        . <br> <br>   <i>INotifyPropertyChanged</i> <br>   <code>INotifyPropertyChanged</code>     ,      .      ,    ;   ,   ,     ,    ,       . <br> <br>   <br> ,       ,           <code>PropertyChanged</code>  ,         .  ,    <code>ChangeTracker</code> ,     MVVM,  ,      .      .     ,    . <br> <br> <code class="cs">var changeTracker = new PropertyChangeTracker(viewModel); viewModel.CurrentState = "newState"; CollectionAssert.Contains(changeTracker.ChangedProperties, "CurrentState");</code> <br> ,     ,     <code>INotifyPropertyChanged</code> ,    ,   ,     . <br> <br>      <br>        ,   ,    <code>set</code>      ,           . ,     ,     ,      ,          . <br> <br> <code class="cs">var changeTracker = new PropertyChangeTracker(viewModel); var question = viewModel.Questions.First() as OpenQuestionViewModel; question.Question.Response = "some text"; CollectionAssert.Contains(changeTracker.ChangedProperties, "UnansweredQuestions");</code> <br>      <br>     <code>INotifyPropertyChanged</code> ,      <code>PropertyChanged</code>        ,  ,     , , .        ,       . <br> <br>   <i>INotifyDataErrorInfo</i> <br>   ,     ,    ,   ,   <code>IDataErrorInfo</code> ,  ( Silverlight)   <code>INotifyDataErrorInfo</code> .   <code>INotifyDataErrorInfo</code>   ,         ,    ,  ,   ,    . <br> <br>       <code>INotifyDataErrorInfo</code> : ,     ,  ,     ,     <code>ErrorsChanged</code> ,      <code>GetErrors</code> , . <br> <br>    <br>     ,      ,     .       ,         <code>GetErrors</code>       ,  ,  ,   .    , ,  ,     ,        .   ,        . <br> <br> <code class="cs">//  . var notifyErrorInfo = (INotifyDataErrorInfo)question; question.Response = -15; Assert.IsTrue(notifyErrorInfo.GetErrors("Response").Cast&lt;ValidationResult&gt;().Any()); //  . var notifyErrorInfo = (INotifyDataErrorInfo)question; question.Response = 15; Assert.IsFalse(notifyErrorInfo.GetErrors("Response").Cast&lt;ValidationResult&gt;().Any());</code> <br>    ,    ,             . <br> <br>    <i>INotifyDataErrorInfo</i> <br>       <code>GetErrors</code> ,   <code>INotifyDataErrorInfo</code>  ,   <code>ErrorsChanged</code>      <code>GetErrors</code> . ,  <code>HasErrors</code>      ,  . <br> <br>       <code>INotifyDataErrorInfo</code> . , ,           ,   -  .      ,        <code>INotifyDataErrorInfo</code>         (,        ). <br> <br>     ,   ,  : <br>  <code>HasErrors</code>     .              ,       .  <code>ErrorsChanged</code> ,      ,         <code>GetErrors</code> .         ( ,  )     ,           .    <code>GetErrors</code>       <code>ErrorsChanged</code> . <br>    <code>INotifyPropertyChanged</code> ,  ,    <code>NotifyDataErrorInfoTestHelper</code>    MVVM,        <code>INotifyDataErrorInfo</code> ,       .   ,   ,      ,   .      . <br> <code class="cs">var helper = new NotifyDataErrorInfoTestHelper&lt;NumericQuestion, int?&gt;( question, q =&gt; q.Response); helper.ValidatePropertyChange( 6, NotifyDataErrorInfoBehavior.Nothing); helper.ValidatePropertyChange( 20, NotifyDataErrorInfoBehavior.FiresErrorsChanged | NotifyDataErrorInfoBehavior.HasErrors | NotifyDataErrorInfoBehavior.HasErrorsForProperty); helper.ValidatePropertyChange( null, NotifyDataErrorInfoBehavior.FiresErrorsChanged | NotifyDataErrorInfoBehavior.HasErrors | NotifyDataErrorInfoBehavior.HasErrorsForProperty); helper.ValidatePropertyChange( 2, NotifyDataErrorInfoBehavior.FiresErrorsChanged);</code> <br>     <br>   MVVM,     ,  .   ,    ,         . <br> <br>  ,     ,     ,       .   ,   , ,       ,     ,   <code>IAsyncResult</code>    ,  - ,   ,    UI. <br> <br>       , , ,    .   ,     .  ,      UI,     ,   ,          ,     ,        "   UI." <br> <br>     ,    ,    .   ,    ,     mock-, ,   ,   ,      ,          . <br> <br>           UI,    ,    .   ,     ,   ,      .        ,   .     ,    ,     . <br> <br> <code class="cs">questionnaireRepositoryMock .Setup( r =&gt; r.SubmitQuestionnaireAsync( It.IsAny&lt;Questionnaire&gt;(), It.IsAny&lt;Action&lt;IOperationResult&gt;&gt;())) .Callback&lt;Questionnaire, Action&lt;IOperationResult&gt;&gt;( (q, a) =&gt; callback = a); uiServicemock .Setup(svc =&gt; svc.ShowView(ViewNames.QuestionnaireTemplatesList)) .Callback&lt;string&gt;(viewName =&gt; requestedViewName = viewName); submitResultMock .Setup(sr =&gt; sr.Error) .Returns&lt;Exception&gt;(null); CompleteQuestionnaire(viewModel); viewModel.Submit(); //      UI . callback(submitResultMock.Object); //    ‚Äì     . Assert.AreEqual(ViewNames.QuestionnaireTemplatesList, requestedViewName);</code> <br> <b></b> <br>          ,        . <br>   <br>       , . "Trees in WPF"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ms753391.aspx">http://msdn.microsoft.com/en-us/library/ms753391.aspx</a> <br> <br>       , . "Attached Properties Overview"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/cc265152(VS.95).aspx">http://msdn.microsoft.com/en-us/library/cc265152(VS.95).aspx</a> <br> <br>      MEF, ."Managed Extensibility Framework Overview"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/dd460648.aspx">http://msdn.microsoft.com/en-us/library/dd460648.aspx</a> . <br> <br>      Unity, ."Unity Application Block"  MSDN: <a href="http://www.msdn.com/unity">http://www.msdn.com/unity</a> . <br> <br>      <code>DelegateCommand</code> , .Chapter 5, " <a href="http://msdn.microsoft.com/en-us/library/gg405484(v%3DPandP.40).aspx">Implementing the MVVM Pattern</a> ." <br> <br>        Microsoft Expression Blend, ."Working with built-in behaviors"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ff724013(v%3DExpression.40).aspx">http://msdn.microsoft.com/en-us/library/ff724013(v=Expression.40).aspx</a> . <br> <br>          Microsoft Expression Blend, ."Creating Custom Behaviors"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ff724708(v%3DExpression.40).aspx">http://msdn.microsoft.com/en-us/library/ff724708(v=Expression.40).aspx</a> . <br> <br>            Microsoft Expression Blend, ."Creating Custom Triggers and Actions"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ff724707(v%3DExpression.40).aspx">http://msdn.microsoft.com/en-us/library/ff724707(v=Expression.40).aspx</a> . <br> <br>         WPF  Silverlight, ."Threading Model"  "The Dispatcher Class"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ms741870.aspx">http://msdn.microsoft.com/en-us/library/ms741870.aspx</a> <br> <a href="http://msdn.microsoft.com/en-us/library/ms615907(v%3DVS.95).aspx">http://msdn.microsoft.com/en-us/library/ms615907(v=VS.95).aspx</a> . <br> <br>      unit-  Silverlight, ."Unit Testing with Silverlight 2": <a href="http://www.jeff.wilcox.name/2008/03/silverlight2-unit-testing/">http://www.jeff.wilcox.name/2008/03/silverlight2-unit-testing/</a> . <br> <br>         , .  " <a href="http://msdn.microsoft.com/en-us/library/gg430861(v%3DPandP.40).aspx">View-Based Navigation</a> " in Chapter 8, " <a href="http://msdn.microsoft.com/en-us/library/gg430861(v%3DPandP.40).aspx">Navigation</a> ." <br> <br>       ,   , ."Event-based Asynchronous Pattern Overview"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/wewwczdw.aspx">http://msdn.microsoft.com/en-us/library/wewwczdw.aspx</a> <br> <br>        <code>IAsyncResult</code> , ."Asynchronous Programming Overview"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ms228963.aspx">http://msdn.microsoft.com/en-us/library/ms228963.aspx</a></code></code></code></code></code></code></code></code></code> <pre> <code class="hljs cmake"><code><code><code><code><code><code><code><code><code class="cs"><code>CommandBehaviorBase ,    ,    ICommand</code> .           <code>CanExecuteChanged</code> ,          Silverlight,    WPF. <br> <br>    ,  ,   <code>CommandBehaviorBase    ,    .         ,      .         ,    .      ButtonBaseClickCommandBehavior</code> . <br> <br> <code class="cs">public class ButtonBaseClickCommandBehavior : CommandBehaviorBase&lt;ButtonBase&gt; { public ButtonBaseClickCommandBehavior(ButtonBase clickableObject) : base(clickableObject) { clickableObject.Click += OnClick; } private void OnClick(object sender, System.Windows.RoutedEventArgs e) { ExecuteCommand(); } }</code> <br>   <code>CommandBehaviorBase ,     .     ,          ,   . ,    ,    ,      , ,    CanExecute</code>  ,     . <br> <br>          ,   .           XAML.           .       .  Prism      ,       ,  ,   .       ,    . , ,  ,      <code>Click</code> ,       <code><span class="hljs-keyword"><span class="hljs-keyword">Command</span></span></code> .    <code>Click.<span class="hljs-keyword"><span class="hljs-keyword">Command</span></span></code> ,  . <br> <br>             .             . <br> <br> <code class="cs">public static readonly DependencyProperty CommandProperty = DependencyProperty.RegisterAttached( <span class="hljs-string"><span class="hljs-string">"Command"</span></span>, typeof(ICommand), typeof(Click), new PropertyMetadata(OnSetCommandCallback)); private static readonly DependencyProperty ClickCommandBehaviorProperty = DependencyProperty.RegisterAttached( <span class="hljs-string"><span class="hljs-string">"ClickCommandBehavior"</span></span>, typeof(ButtonBaseClickCommandBehavior), typeof(Click), null);</code> <br>    <code><span class="hljs-keyword"><span class="hljs-keyword">Command</span></span></code>    <code>ButtonBaseClickCommandBehavior</code> ,     <code>OnSetCommandCallback</code> ,     . <br> <br> <code class="cs">private static void OnSetCommandCallback(DependencyObject dependencyObject, DependencyPropertyChangedEventArgs e) { ButtonBase buttonBase = dependencyObject as ButtonBase; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (buttonBase != null) { ButtonBaseClickCommandBehavior behavior = GetOrCreateBehavior(buttonBase); behavior.<span class="hljs-keyword"><span class="hljs-keyword">Command</span></span> = e.NewValue as ICommand; } } private static void OnSetCommandParameterCallback(DependencyObject dependencyObject, DependencyPropertyChangedEventArgs e) { ButtonBase buttonBase = dependencyObject as ButtonBase; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (buttonBase != null) { ButtonBaseClickCommandBehavior behavior = GetOrCreateBehavior(buttonBase); behavior.CommandParameter = e.NewValue; } } private static ButtonBaseClickCommandBehavior GetOrCreateBehavior(ButtonBase buttonBase ) { ButtonBaseClickCommandBehavior behavior = buttonBase.GetValue(ClickCommandBehaviorProperty) as ButtonBaseClickCommandBehavior; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ( behavior == null ) { behavior = new ButtonBaseClickCommandBehavior(buttonBase); buttonBase.SetValue(ClickCommandBehaviorProperty, behavior); } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> behavior; }</code> <br>        ,  <a href="http://msdn.microsoft.com/en-us/library/cc265152(VS.95).aspx">Attached Properties Overview</a>  MSDN. <br> <br>    <br>              . ,     Silverlight,    -,     ,      ,     .     ,       . <br> <br>        ,    ( )  ,  ,     .  UI       ,            UI. <br> <br>      - <br>   -     ,       <code>IAsyncResult</code> .   ,  ,   ,  <code>GetQuestionnaire</code> ,   : <code>BeginGetQuestionnaire</code>  <code>EndGetQuestionnaire</code> .    ,   <code>BeginGetQuestionnaire</code> .     ,   ,   <code>EndGetQuestionnaire</code>    . <br> <b></b> <br>  .NET Framework <span class="hljs-number"><span class="hljs-number">4.5</span></span>      <code>await</code>  <code>async</code>     <code>*Async</code> .      <a href="http://msdn.microsoft.com/en-us/library/vstudio/hh391443.aspx"><span class="hljs-string"><span class="hljs-string">"Asynchronous Programming with Async and Await (C# and Visual Basic)"</span></span></a> . <br>  ,    <code>EndGetQuestionnaire</code> ,      ,  ()      <code>BeginGetQuestionnaire</code> .     ,      ,   <code>EndGetQuestionnaire</code> ,   . <br> <br> <code class="xml">IAsyncResult asyncResult = this.service.BeginGetQuestionnaire( GetQuestionnaireCompleted, null //  ,      ); private void GetQuestionnaireCompleted(IAsyncResult result) { try { questionnaire = this.service.EndGetQuestionnaire(ar); } catch (Exception ex) { //  -   . } }</code> <br>  ,     <code>End*</code> (  , <code>EndGetQuestionnaire</code> ),    ,      .      , ,          UI.     ,   ,        . <br> <br>        UI,     -,      UI,         UI,   <code>Dispatcher</code>    <code>SynchronizationContext</code> .  WPF  Silverlight,   <code>Dispatcher</code> . <br> <br>      <code>Questionnaire</code>  ,        <code>QuestionnaireView</code> .  Silverlight    <code>CheckAccess</code> ,  ,      UI.  ,     <code>BeginInvoke</code> ,      UI. <br> <br> <code class="cs">var dispatcher = System.Windows.Deployment.Current.Dispatcher; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (dispatcher.CheckAccess()) { QuestionnaireView.DataContext = questionnaire; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { dispatcher.BeginInvoke(() =&gt; { Questionnaire.DataContext = questionnaire; }); }</code> <br> <i>MVVM RI</i>   ,    ,   <code>IAsyncResult</code> ,   .      ,                 . ,       . <br> <br> <code class="cs">this.questionnaireRepository.GetQuestionnaireAsync( result =&gt; { this.Questionnaire = result.Result; });</code> <br>  <code>result</code>   ,     , , , .    ,     . <br> <br> <code class="cs">this.questionnaireRepository.GetQuestionnaireAsync( result =&gt; { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (result.Error == null) { this.Questionnaire = result.Result; ... } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { // Handle error. } })</code> <br>     <br>        ,      .     , ,             .        ,      ,     ,     . <br> <br>         ,      MVVM,     ,   . ,  -MVVM ,     <code>MessageBox</code>   code-behind UI,      .   MVVM     ,          . <br> <br>     MVVM,              ,          .      ,    ,   ,  ,     . <br> <br>              MVVM.      ,     ,     ,  ,     .    ,         ,     ,          .       . <br> <br>    <br>                  .        ,        .  ,         .         . <br> <br>  ,         ,         ,  .      ,     .           ,       . ,        WPF  Silverlight,        . <br> <br> <img title="Using the service to interact with the user." src="https://habrastorage.org/getpro/habr/post_images/4b5/397/f2d/4b5397f2d02e5851195b29f1893be6fc.png" alt=" ,    ."> <br> <br>  ,   <code>MessageBox</code>        ,     ,    ,     . <br> <br> <code class="cs">var result = interactionService.ShowMessageBox( <span class="hljs-string"><span class="hljs-string">"Are you sure you want to cancel this operation?"</span></span>, <span class="hljs-string"><span class="hljs-string">"Confirm"</span></span>, MessageBoxButton.OK); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (result == MessageBoxResult.Yes) { CancelRequest(); }</code> <br> ,      - ,      ,         Silverlight.         .             .     . <br> <br> <code class="cs">interactionService.ShowMessageBox( <span class="hljs-string"><span class="hljs-string">"Are you sure you want to cancel this operation?"</span></span>, <span class="hljs-string"><span class="hljs-string">"Confirm"</span></span>, MessageBoxButton.OK, result =&gt; { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (result == MessageBoxResult.Yes) { CancelRequest(); } });</code> <br>         ,      . ,  WPF    <code>MessageBox</code> ,       ;    Silverlight    ,    . <br> <br>     <br>         ‚Äì             .         ,      .     ,     .        ,        ,   ,     . <br> <br> <img title="Using interaction request objects." src="https://habrastorage.org/getpro/habr/post_images/3d0/ff0/1c5/3d0ff01c5518558c2d3c5c5f47ce0ce9.png" alt="   ."> <br> <br>    ,   ,          ‚Äì       ,      ,   ‚Äì     .   ,        ,    ,    UI            . <br> <br>       MVVM,     ,       ,         .         ,        ,    ,   . <br> <br>  Prism       <code>IInteractionRequest</code>   <code>InteractionRequest .  IInteractionRequest</code>  ,   .           ,   .  <code>InteractionRequest   IInteractionRequest</code>     <code>Raise</code> ,           , , ,   . <br> <br>       <br>  <code>InteractionRequest          .  Raise</code>          ( <code>T</code> )    ,    ,   .          ,       .      ,        .    ,  ,     . <br> <code class="cs">public interface IInteractionRequest { event EventHandler&lt;InteractionRequestedEventArgs&gt; Raised; } public class InteractionRequest&lt;T&gt; : IInteractionRequest { public event EventHandler&lt;InteractionRequestedEventArgs&gt; Raised; public void Raise(T context, Action&lt;T&gt; callback) { var handler = this.Raised; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (handler != null) { handler( this, new InteractionRequestedEventArgs(context, () =&gt; callback(context))); } } }</code> <br> Prism    ,      .  <code>Notification</code>       .    ,            .     ‚Äì <code>Title</code>  <code>Content</code> ,    .  ,   ,  ,  ,        . <br> <br>  <code>Confirmation</code>    <code>Notification</code>     ‚Äì <code>Confirmed</code> ,  ,  ,      .  <code>Confirmation</code> ,     <code>MessageBox</code> ,     /  .     ,     <code>Notification</code> ,     ,      . <br> <br>    <code>InteractionRequest ,       InteractionRequest      ,      .      ,    Raise</code> ,    , ,   . <br> <br> <code class="cs">public IInteractionRequest ConfirmCancelInteractionRequest { get { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> this.confirmCancelInteractionRequest; } } this.confirmCancelInteractionRequest.Raise( new Confirmation(<span class="hljs-string"><span class="hljs-string">"Are you sure you wish to cancel?"</span></span>), confirmation =&gt; { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (confirmation.Confirmed) { this.NavigateToQuestionnaireList(); } }); }</code> <br> <i>MVVM Reference Implementation (MVVM RI)</i> ,    <code>IInteractionRequest</code>   <code>InteractionRequest ,          (. QuestionnaireViewModel.cs</code> ). <br> <br>        <br>       ,       .   ,       .    UI             . <br> <br>                . Microsoft Expression Blend Behaviors Framework     .  ,     ,    . <br> <br>  <code>EventTrigger</code> ,  Expression Blend,  ,      ,     ,   . , Prism   <code>EventTrigger</code> ,  <code>InteractionRequestTrigger</code> ,      <code>Raised</code>   <code>IInteractionRequest</code> .    XAML        . <br> <br>  ,   , <code>InteractionRequestTrigger</code>   .  Silverlight Prism   <code>PopupChildWindowAction</code> ,     .    ,         .   <code>ContentTemplate</code>  <code>PopupChildWindowAction</code> ,    ,    UI,      <code>Content</code>  .       <code>Title</code>  . <br> <b></b> <br>  ,    ,   <code>PopupChildWindowAction</code> ,     .    <code>Notification</code>  <code>NotificationChildWindow</code> ,        <code>Confirmation</code> ‚Äì <code>ConfirmationChildWindow</code> . <code>NotificationChildWindow</code>    ,   ,     <code>ConfirmationChildWindow</code>    <i>OK</i>  <i>Cancel</i> ,    .    ,   ,   <code>ChildWindow</code>  <code>PopupChildWindowAction</code> . <br>   ,  <code>InteractionRequestTrigger</code>  <code>PopupChildWindowAction</code> ,       <i>RI MVVM</i> . <br> <br> <code class="xml">&lt;i:Interaction.Triggers&gt; &lt;prism:InteractionRequestTrigger SourceObject=<span class="hljs-string"><span class="hljs-string">"{Binding ConfirmCancelInteractionRequest}"</span></span>&gt; &lt;prism:PopupChildWindowAction ContentTemplate=<span class="hljs-string"><span class="hljs-string">"{StaticResource ConfirmWindowTemplate}"</span></span>/&gt; &lt;/prism:InteractionRequestTrigger&gt; &lt;/i:Interaction.Triggers&gt; &lt;UserControl.Resources&gt; &lt;DataTemplate x:Key=<span class="hljs-string"><span class="hljs-string">"ConfirmWindowTemplate"</span></span>&gt; &lt;Grid MinWidth=<span class="hljs-string"><span class="hljs-string">"250"</span></span> MinHeight=<span class="hljs-string"><span class="hljs-string">"100"</span></span>&gt; &lt;TextBlock TextWrapping=<span class="hljs-string"><span class="hljs-string">"Wrap"</span></span> Grid.Row=<span class="hljs-string"><span class="hljs-string">"0"</span></span> Text=<span class="hljs-string"><span class="hljs-string">"{Binding}"</span></span>/&gt; &lt;/Grid&gt; &lt;/DataTemplate&gt; &lt;/UserControl.Resources&gt;</code> <br> <b></b> <br>      <code>ContentTemplate</code> ,   UI   <code>Content</code>  .    <code>Content</code>  ,  , <code>TextBlock</code>     <code>Content</code> . <br>      ,     ,    ,    .  ,     ,       ,     ,    .   ,   <i>RI MVVM</i> ,         <code>Confirmed</code>    <code>Confirmation</code>  <code><span class="hljs-keyword"><span class="hljs-keyword">true</span></span></code> ,     OK. <br> <br>        ,     .  Prism <code>InteractionRequestTrigger</code>   <code>PopupChildWindowAction</code>            . <br> <br>     <br>     MVVM,       , ,    ,         .        (  , ,  ,   ).    ,  ,  ,            . <br> <br>        ,         . Managed Extensibility Framework (MEF)  Unity Application Block (Unity)      ,  ,           . <br> <br>  ,       , , ,    ( )      . ,       ,     .  ,     ,       . <br> <br>     ,  MEF <br>  MEF,       ,   <code>Import</code> ,      ,  ,   <code><span class="hljs-keyword"><span class="hljs-keyword">Export</span></span></code> .         ,    . <br> <br> , <code>QuestionnaireView</code>   <i>RI MVVM</i> ,        ,    <code>Import</code> .   , MEF           .  <code><span class="hljs-keyword"><span class="hljs-keyword">set</span></span></code>        ,   . <br> <br> <code class="cs">[Import] public QuestionnaireViewModel ViewModel { <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> { this.DataContext = value; } }</code> <br>     ,   . <br> <br> <code class="cs">[<span class="hljs-keyword"><span class="hljs-keyword">Export</span></span>] public class QuestionnaireViewModel : NotificationObject { ... }</code> <br>        ,   . <br> <br> <code class="cs">public QuestionnaireView() { InitializeComponent(); } [ImportingConstructor] public QuestionnaireView(QuestionnaireViewModel viewModel) : this() { this.DataContext = viewModel; }</code> <br> <b></b> <br>          MEF,   Unity.   ,     ,        .   ,   Visual Studio  Expression Blend, ,        ,     .   ,   ,  ,      ,          <code>InitializeComponent</code> . <br>     ,  Unity <br>  Unity,    ,   MEF.     ,      .    ,         .  ,      . <br> <br>  ,      ,  ,         . ,           ,   . <br> <br> <code class="cs">public QuestionnaireView() { InitializeComponent(); } public QuestionnaireView(QuestionnaireViewModel viewModel) : this() { this.DataContext = viewModel; }</code> <br> <b></b> <br>    ,        ,   Visual Studio  Expression Blend. <br>  ,          ,   . Unity        <code><span class="hljs-keyword"><span class="hljs-keyword">set</span></span></code>   ,   . <br> <br> <code class="cs">public QuestionnaireView() { InitializeComponent(); } [Dependency] public QuestionnaireViewModel ViewModel { <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> { this.DataContext = value; } }</code> <br>       Unity. <br> <br> container.RegisterType&lt;QuestionnaireViewModel&gt;(); <br>  ,     . <br> <br> <code class="cs">var view = container.Resolve&lt;QuestionnaireView&gt;();</code> <br>     ,    <br>   ,     ,        .        ,   MEF  Unity,        . <br> <br>          .   ,         UI,           . <br> <br> , <i>RI MVVM</i>   ,   ,        .   ,    .      <code>ShowView</code>   UI. <br> <br> <code class="cs">private void NavigateToQuestionnaireList() { //     <span class="hljs-string"><span class="hljs-string">"questionnaire list"</span></span>. this.uiService.ShowView(ViewNames.QuestionnaireTemplatesList); }</code> <br>  UI      UI .           UI.  <code>ShowView</code>  <code>UIService</code>      (,          ),       ,   . <br> <br> <code class="cs">public void ShowView(<span class="hljs-keyword"><span class="hljs-keyword">string</span></span> viewName) { var view = this.ViewFactory.GetView(viewName); this.MainWindow.CurrentView = view; }</code> <br> <b></b> <br> Prism       .   ,   ,   ,             .    ,  , <span class="hljs-string"><span class="hljs-string">" </span></span><a href="http://msdn.microsoft.com/en-us/library/gg430861(v%3DPandP.40).aspx"><span class="hljs-string"><span class="hljs-string">View-Based Navigation</span></span></a><span class="hljs-string"><span class="hljs-string"> "</span></span>   <span class="hljs-number"><span class="hljs-number">8</span></span>, <span class="hljs-string"><span class="hljs-string">" </span></span><a href="http://msdn.microsoft.com/en-us/library/gg430861(v%3DPandP.40).aspx"><span class="hljs-string"><span class="hljs-string">Navigation</span></span></a><span class="hljs-string"><span class="hljs-string"> "</span></span>. <br>  MVVM  <br>        MVVM      .           -      mocking . ,   ,        . <br> <br>   <i>INotifyPropertyChanged</i> <br>   <code>INotifyPropertyChanged</code>     ,      .      ,    ;   ,   ,     ,    ,       . <br> <br>   <br> ,       ,           <code>PropertyChanged</code>  ,         .  ,    <code>ChangeTracker</code> ,     MVVM,  ,      .      .     ,    . <br> <br> <code class="cs">var changeTracker = new PropertyChangeTracker(viewModel); viewModel.CurrentState = <span class="hljs-string"><span class="hljs-string">"newState"</span></span>; CollectionAssert.Contains(changeTracker.ChangedProperties, <span class="hljs-string"><span class="hljs-string">"CurrentState"</span></span>);</code> <br> ,     ,     <code>INotifyPropertyChanged</code> ,    ,   ,     . <br> <br>      <br>        ,   ,    <code><span class="hljs-keyword"><span class="hljs-keyword">set</span></span></code>      ,           . ,     ,     ,      ,          . <br> <br> <code class="cs">var changeTracker = new PropertyChangeTracker(viewModel); var question = viewModel.Questions.First() as OpenQuestionViewModel; question.Question.Response = <span class="hljs-string"><span class="hljs-string">"some text"</span></span>; CollectionAssert.Contains(changeTracker.ChangedProperties, <span class="hljs-string"><span class="hljs-string">"UnansweredQuestions"</span></span>);</code> <br>      <br>     <code>INotifyPropertyChanged</code> ,      <code>PropertyChanged</code>        ,  ,     , , .        ,       . <br> <br>   <i>INotifyDataErrorInfo</i> <br>   ,     ,    ,   ,   <code>IDataErrorInfo</code> ,  ( Silverlight)   <code>INotifyDataErrorInfo</code> .   <code>INotifyDataErrorInfo</code>   ,         ,    ,  ,   ,    . <br> <br>       <code>INotifyDataErrorInfo</code> : ,     ,  ,     ,     <code>ErrorsChanged</code> ,      <code>GetErrors</code> , . <br> <br>    <br>     ,      ,     .       ,         <code>GetErrors</code>       ,  ,  ,   .    , ,  ,     ,        .   ,        . <br> <br> <code class="cs">//  . var notifyErrorInfo = (INotifyDataErrorInfo)question; question.Response = -<span class="hljs-number"><span class="hljs-number">15</span></span>; Assert.IsTrue(notifyErrorInfo.GetErrors(<span class="hljs-string"><span class="hljs-string">"Response"</span></span>).Cast&lt;ValidationResult&gt;().Any()); //  . var notifyErrorInfo = (INotifyDataErrorInfo)question; question.Response = <span class="hljs-number"><span class="hljs-number">15</span></span>; Assert.IsFalse(notifyErrorInfo.GetErrors(<span class="hljs-string"><span class="hljs-string">"Response"</span></span>).Cast&lt;ValidationResult&gt;().Any());</code> <br>    ,    ,             . <br> <br>    <i>INotifyDataErrorInfo</i> <br>       <code>GetErrors</code> ,   <code>INotifyDataErrorInfo</code>  ,   <code>ErrorsChanged</code>      <code>GetErrors</code> . ,  <code>HasErrors</code>      ,  . <br> <br>       <code>INotifyDataErrorInfo</code> . , ,           ,   -  .      ,        <code>INotifyDataErrorInfo</code>         (,        ). <br> <br>     ,   ,  : <br>  <code>HasErrors</code>     .              ,       .  <code>ErrorsChanged</code> ,      ,         <code>GetErrors</code> .         ( ,  )     ,           .    <code>GetErrors</code>       <code>ErrorsChanged</code> . <br>    <code>INotifyPropertyChanged</code> ,  ,    <code>NotifyDataErrorInfoTestHelper</code>    MVVM,        <code>INotifyDataErrorInfo</code> ,       .   ,   ,      ,   .      . <br> <code class="cs">var helper = new NotifyDataErrorInfoTestHelper&lt;NumericQuestion, int?&gt;( question, q =&gt; q.Response); helper.ValidatePropertyChange( <span class="hljs-number"><span class="hljs-number">6</span></span>, NotifyDataErrorInfoBehavior.Nothing); helper.ValidatePropertyChange( <span class="hljs-number"><span class="hljs-number">20</span></span>, NotifyDataErrorInfoBehavior.FiresErrorsChanged | NotifyDataErrorInfoBehavior.HasErrors | NotifyDataErrorInfoBehavior.HasErrorsForProperty); helper.ValidatePropertyChange( null, NotifyDataErrorInfoBehavior.FiresErrorsChanged | NotifyDataErrorInfoBehavior.HasErrors | NotifyDataErrorInfoBehavior.HasErrorsForProperty); helper.ValidatePropertyChange( <span class="hljs-number"><span class="hljs-number">2</span></span>, NotifyDataErrorInfoBehavior.FiresErrorsChanged);</code> <br>     <br>   MVVM,     ,  .   ,    ,         . <br> <br>  ,     ,     ,       .   ,   , ,       ,     ,   <code>IAsyncResult</code>    ,  - ,   ,    UI. <br> <br>       , , ,    .   ,     .  ,      UI,     ,   ,          ,     ,        <span class="hljs-string"><span class="hljs-string">"   UI."</span></span> <br> <br>     ,    ,    .   ,    ,     mock-, ,   ,   ,      ,          . <br> <br>           UI,    ,    .   ,     ,   ,      .        ,   .     ,    ,     . <br> <br> <code class="cs">questionnaireRepositoryMock .Setup( r =&gt; r.SubmitQuestionnaireAsync( It.IsAny&lt;Questionnaire&gt;(), It.IsAny&lt;Action&lt;IOperationResult&gt;&gt;())) .Callback&lt;Questionnaire, Action&lt;IOperationResult&gt;&gt;( (q, a) =&gt; callback = a); uiServicemock .Setup(svc =&gt; svc.ShowView(ViewNames.QuestionnaireTemplatesList)) .Callback&lt;<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>&gt;(viewName =&gt; requestedViewName = viewName); submitResultMock .Setup(sr =&gt; sr.Error) .Returns&lt;Exception&gt;(null); CompleteQuestionnaire(viewModel); viewModel.Submit(); //      UI . callback(submitResultMock.Object); //    ‚Äì     . Assert.AreEqual(ViewNames.QuestionnaireTemplatesList, requestedViewName);</code> <br> <b></b> <br>          ,        . <br>   <br>       , . <span class="hljs-string"><span class="hljs-string">"Trees in WPF"</span></span>  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ms753391.aspx">http://msdn.microsoft.com/en-us/library/ms753391.aspx</a> <br> <br>       , . <span class="hljs-string"><span class="hljs-string">"Attached Properties Overview"</span></span>  MSDN: <a href="http://msdn.microsoft.com/en-us/library/cc265152(VS.95).aspx">http://msdn.microsoft.com/en-us/library/cc265152(VS.<span class="hljs-number"><span class="hljs-number">95</span></span>).aspx</a> <br> <br>      MEF, .<span class="hljs-string"><span class="hljs-string">"Managed Extensibility Framework Overview"</span></span>  MSDN: <a href="http://msdn.microsoft.com/en-us/library/dd460648.aspx">http://msdn.microsoft.com/en-us/library/dd460648.aspx</a> . <br> <br>      Unity, .<span class="hljs-string"><span class="hljs-string">"Unity Application Block"</span></span>  MSDN: <a href="http://www.msdn.com/unity">http://www.msdn.com/unity</a> . <br> <br>      <code>DelegateCommand</code> , .Chapter <span class="hljs-number"><span class="hljs-number">5</span></span>, <span class="hljs-string"><span class="hljs-string">" </span></span><a href="http://msdn.microsoft.com/en-us/library/gg405484(v%3DPandP.40).aspx"><span class="hljs-string"><span class="hljs-string">Implementing the MVVM Pattern</span></span></a><span class="hljs-string"><span class="hljs-string"> ."</span></span> <br> <br>        Microsoft Expression Blend, .<span class="hljs-string"><span class="hljs-string">"Working with built-in behaviors"</span></span>  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ff724013(v%3DExpression.40).aspx">http://msdn.microsoft.com/en-us/library/ff724013(v=Expression.<span class="hljs-number"><span class="hljs-number">40</span></span>).aspx</a> . <br> <br>          Microsoft Expression Blend, .<span class="hljs-string"><span class="hljs-string">"Creating Custom Behaviors"</span></span>  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ff724708(v%3DExpression.40).aspx">http://msdn.microsoft.com/en-us/library/ff724708(v=Expression.<span class="hljs-number"><span class="hljs-number">40</span></span>).aspx</a> . <br> <br>            Microsoft Expression Blend, .<span class="hljs-string"><span class="hljs-string">"Creating Custom Triggers and Actions"</span></span>  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ff724707(v%3DExpression.40).aspx">http://msdn.microsoft.com/en-us/library/ff724707(v=Expression.<span class="hljs-number"><span class="hljs-number">40</span></span>).aspx</a> . <br> <br>         WPF  Silverlight, .<span class="hljs-string"><span class="hljs-string">"Threading Model"</span></span>  <span class="hljs-string"><span class="hljs-string">"The Dispatcher Class"</span></span>  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ms741870.aspx">http://msdn.microsoft.com/en-us/library/ms741870.aspx</a> <br> <a href="http://msdn.microsoft.com/en-us/library/ms615907(v%3DVS.95).aspx">http://msdn.microsoft.com/en-us/library/ms615907(v=VS.<span class="hljs-number"><span class="hljs-number">95</span></span>).aspx</a> . <br> <br>      unit-  Silverlight, .<span class="hljs-string"><span class="hljs-string">"Unit Testing with Silverlight 2"</span></span>: <a href="http://www.jeff.wilcox.name/2008/03/silverlight2-unit-testing/">http://www.jeff.wilcox.name/<span class="hljs-number"><span class="hljs-number">2008</span></span>/<span class="hljs-number"><span class="hljs-number">03</span></span>/silverlight2-unit-testing/</a> . <br> <br>         , .  <span class="hljs-string"><span class="hljs-string">" </span></span><a href="http://msdn.microsoft.com/en-us/library/gg430861(v%3DPandP.40).aspx"><span class="hljs-string"><span class="hljs-string">View-Based Navigation</span></span></a><span class="hljs-string"><span class="hljs-string"> "</span></span> in Chapter <span class="hljs-number"><span class="hljs-number">8</span></span>, <span class="hljs-string"><span class="hljs-string">" </span></span><a href="http://msdn.microsoft.com/en-us/library/gg430861(v%3DPandP.40).aspx"><span class="hljs-string"><span class="hljs-string">Navigation</span></span></a><span class="hljs-string"><span class="hljs-string"> ."</span></span> <br> <br>       ,   , .<span class="hljs-string"><span class="hljs-string">"Event-based Asynchronous Pattern Overview"</span></span>  MSDN: <a href="http://msdn.microsoft.com/en-us/library/wewwczdw.aspx">http://msdn.microsoft.com/en-us/library/wewwczdw.aspx</a> <br> <br>        <code>IAsyncResult</code> , .<span class="hljs-string"><span class="hljs-string">"Asynchronous Programming Overview"</span></span>  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ms228963.aspx">http://msdn.microsoft.com/en-us/library/ms228963.aspx</a></code></code></code></code></code></code></code></code></code></code> </pre> <code><code><code><code><code><code><code><code><code><code>CommandBehaviorBase ,    ,    ICommand</code> .           <code>CanExecuteChanged</code> ,          Silverlight,    WPF. <br> <br>    ,  ,   <code>CommandBehaviorBase    ,    .         ,      .         ,    .      ButtonBaseClickCommandBehavior</code> . <br> <br> <code class="cs">public class ButtonBaseClickCommandBehavior : CommandBehaviorBase&lt;ButtonBase&gt; { public ButtonBaseClickCommandBehavior(ButtonBase clickableObject) : base(clickableObject) { clickableObject.Click += OnClick; } private void OnClick(object sender, System.Windows.RoutedEventArgs e) { ExecuteCommand(); } }</code> <br>   <code>CommandBehaviorBase ,     .     ,          ,   . ,    ,    ,      , ,    CanExecute</code>  ,     . <br> <br>          ,   .           XAML.           .       .  Prism      ,       ,  ,   .       ,    . , ,  ,      <code>Click</code> ,       <code>Command</code> .    <code>Click.Command</code> ,  . <br> <br>             .             . <br> <br> <code class="cs">public static readonly DependencyProperty CommandProperty = DependencyProperty.RegisterAttached( "Command", typeof(ICommand), typeof(Click), new PropertyMetadata(OnSetCommandCallback)); private static readonly DependencyProperty ClickCommandBehaviorProperty = DependencyProperty.RegisterAttached( "ClickCommandBehavior", typeof(ButtonBaseClickCommandBehavior), typeof(Click), null);</code> <br>    <code>Command</code>    <code>ButtonBaseClickCommandBehavior</code> ,     <code>OnSetCommandCallback</code> ,     . <br> <br> <code class="cs">private static void OnSetCommandCallback(DependencyObject dependencyObject, DependencyPropertyChangedEventArgs e) { ButtonBase buttonBase = dependencyObject as ButtonBase; if (buttonBase != null) { ButtonBaseClickCommandBehavior behavior = GetOrCreateBehavior(buttonBase); behavior.Command = e.NewValue as ICommand; } } private static void OnSetCommandParameterCallback(DependencyObject dependencyObject, DependencyPropertyChangedEventArgs e) { ButtonBase buttonBase = dependencyObject as ButtonBase; if (buttonBase != null) { ButtonBaseClickCommandBehavior behavior = GetOrCreateBehavior(buttonBase); behavior.CommandParameter = e.NewValue; } } private static ButtonBaseClickCommandBehavior GetOrCreateBehavior(ButtonBase buttonBase ) { ButtonBaseClickCommandBehavior behavior = buttonBase.GetValue(ClickCommandBehaviorProperty) as ButtonBaseClickCommandBehavior; if ( behavior == null ) { behavior = new ButtonBaseClickCommandBehavior(buttonBase); buttonBase.SetValue(ClickCommandBehaviorProperty, behavior); } return behavior; }</code> <br>        ,  <a href="http://msdn.microsoft.com/en-us/library/cc265152(VS.95).aspx">Attached Properties Overview</a>  MSDN. <br> <br>    <br>              . ,     Silverlight,    -,     ,      ,     .     ,       . <br> <br>        ,    ( )  ,  ,     .  UI       ,            UI. <br> <br>      - <br>   -     ,       <code>IAsyncResult</code> .   ,  ,   ,  <code>GetQuestionnaire</code> ,   : <code>BeginGetQuestionnaire</code>  <code>EndGetQuestionnaire</code> .    ,   <code>BeginGetQuestionnaire</code> .     ,   ,   <code>EndGetQuestionnaire</code>    . <br> <b></b> <br>  .NET Framework 4.5      <code>await</code>  <code>async</code>     <code>*Async</code> .      <a href="http://msdn.microsoft.com/en-us/library/vstudio/hh391443.aspx">"Asynchronous Programming with Async and Await (C# and Visual Basic)"</a> . <br>  ,    <code>EndGetQuestionnaire</code> ,      ,  ()      <code>BeginGetQuestionnaire</code> .     ,      ,   <code>EndGetQuestionnaire</code> ,   . <br> <br> <code class="xml">IAsyncResult asyncResult = this.service.BeginGetQuestionnaire( GetQuestionnaireCompleted, null //  ,      ); private void GetQuestionnaireCompleted(IAsyncResult result) { try { questionnaire = this.service.EndGetQuestionnaire(ar); } catch (Exception ex) { //  -   . } }</code> <br>  ,     <code>End*</code> (  , <code>EndGetQuestionnaire</code> ),    ,      .      , ,          UI.     ,   ,        . <br> <br>        UI,     -,      UI,         UI,   <code>Dispatcher</code>    <code>SynchronizationContext</code> .  WPF  Silverlight,   <code>Dispatcher</code> . <br> <br>      <code>Questionnaire</code>  ,        <code>QuestionnaireView</code> .  Silverlight    <code>CheckAccess</code> ,  ,      UI.  ,     <code>BeginInvoke</code> ,      UI. <br> <br> <code class="cs">var dispatcher = System.Windows.Deployment.Current.Dispatcher; if (dispatcher.CheckAccess()) { QuestionnaireView.DataContext = questionnaire; } else { dispatcher.BeginInvoke(() =&gt; { Questionnaire.DataContext = questionnaire; }); }</code> <br> <i>MVVM RI</i>   ,    ,   <code>IAsyncResult</code> ,   .      ,                 . ,       . <br> <br> <code class="cs">this.questionnaireRepository.GetQuestionnaireAsync( result =&gt; { this.Questionnaire = result.Result; });</code> <br>  <code>result</code>   ,     , , , .    ,     . <br> <br> <code class="cs">this.questionnaireRepository.GetQuestionnaireAsync( result =&gt; { if (result.Error == null) { this.Questionnaire = result.Result; ... } else { // Handle error. } })</code> <br>     <br>        ,      .     , ,             .        ,      ,     ,     . <br> <br>         ,      MVVM,     ,   . ,  -MVVM ,     <code>MessageBox</code>   code-behind UI,      .   MVVM     ,          . <br> <br>     MVVM,              ,          .      ,    ,   ,  ,     . <br> <br>              MVVM.      ,     ,     ,  ,     .    ,         ,     ,          .       . <br> <br>    <br>                  .        ,        .  ,         .         . <br> <br>  ,         ,         ,  .      ,     .           ,       . ,        WPF  Silverlight,        . <br> <br> <img title="Using the service to interact with the user." src="https://habrastorage.org/getpro/habr/post_images/4b5/397/f2d/4b5397f2d02e5851195b29f1893be6fc.png" alt=" ,    ."> <br> <br>  ,   <code>MessageBox</code>        ,     ,    ,     . <br> <br> <code class="cs">var result = interactionService.ShowMessageBox( "Are you sure you want to cancel this operation?", "Confirm", MessageBoxButton.OK); if (result == MessageBoxResult.Yes) { CancelRequest(); }</code> <br> ,      - ,      ,         Silverlight.         .             .     . <br> <br> <code class="cs">interactionService.ShowMessageBox( "Are you sure you want to cancel this operation?", "Confirm", MessageBoxButton.OK, result =&gt; { if (result == MessageBoxResult.Yes) { CancelRequest(); } });</code> <br>         ,      . ,  WPF    <code>MessageBox</code> ,       ;    Silverlight    ,    . <br> <br>     <br>         ‚Äì             .         ,      .     ,     .        ,        ,   ,     . <br> <br> <img title="Using interaction request objects." src="https://habrastorage.org/getpro/habr/post_images/3d0/ff0/1c5/3d0ff01c5518558c2d3c5c5f47ce0ce9.png" alt="   ."> <br> <br>    ,   ,          ‚Äì       ,      ,   ‚Äì     .   ,        ,    ,    UI            . <br> <br>       MVVM,     ,       ,         .         ,        ,    ,   . <br> <br>  Prism       <code>IInteractionRequest</code>   <code>InteractionRequest .  IInteractionRequest</code>  ,   .           ,   .  <code>InteractionRequest   IInteractionRequest</code>     <code>Raise</code> ,           , , ,   . <br> <br>       <br>  <code>InteractionRequest          .  Raise</code>          ( <code>T</code> )    ,    ,   .          ,       .      ,        .    ,  ,     . <br> <code class="cs">public interface IInteractionRequest { event EventHandler&lt;InteractionRequestedEventArgs&gt; Raised; } public class InteractionRequest&lt;T&gt; : IInteractionRequest { public event EventHandler&lt;InteractionRequestedEventArgs&gt; Raised; public void Raise(T context, Action&lt;T&gt; callback) { var handler = this.Raised; if (handler != null) { handler( this, new InteractionRequestedEventArgs(context, () =&gt; callback(context))); } } }</code> <br> Prism    ,      .  <code>Notification</code>       .    ,            .     ‚Äì <code>Title</code>  <code>Content</code> ,    .  ,   ,  ,  ,        . <br> <br>  <code>Confirmation</code>    <code>Notification</code>     ‚Äì <code>Confirmed</code> ,  ,  ,      .  <code>Confirmation</code> ,     <code>MessageBox</code> ,     /  .     ,     <code>Notification</code> ,     ,      . <br> <br>    <code>InteractionRequest ,       InteractionRequest      ,      .      ,    Raise</code> ,    , ,   . <br> <br> <code class="cs">public IInteractionRequest ConfirmCancelInteractionRequest { get { return this.confirmCancelInteractionRequest; } } this.confirmCancelInteractionRequest.Raise( new Confirmation("Are you sure you wish to cancel?"), confirmation =&gt; { if (confirmation.Confirmed) { this.NavigateToQuestionnaireList(); } }); }</code> <br> <i>MVVM Reference Implementation (MVVM RI)</i> ,    <code>IInteractionRequest</code>   <code>InteractionRequest ,          (. QuestionnaireViewModel.cs</code> ). <br> <br>        <br>       ,       .   ,       .    UI             . <br> <br>                . Microsoft Expression Blend Behaviors Framework     .  ,     ,    . <br> <br>  <code>EventTrigger</code> ,  Expression Blend,  ,      ,     ,   . , Prism   <code>EventTrigger</code> ,  <code>InteractionRequestTrigger</code> ,      <code>Raised</code>   <code>IInteractionRequest</code> .    XAML        . <br> <br>  ,   , <code>InteractionRequestTrigger</code>   .  Silverlight Prism   <code>PopupChildWindowAction</code> ,     .    ,         .   <code>ContentTemplate</code>  <code>PopupChildWindowAction</code> ,    ,    UI,      <code>Content</code>  .       <code>Title</code>  . <br> <b></b> <br>  ,    ,   <code>PopupChildWindowAction</code> ,     .    <code>Notification</code>  <code>NotificationChildWindow</code> ,        <code>Confirmation</code> ‚Äì <code>ConfirmationChildWindow</code> . <code>NotificationChildWindow</code>    ,   ,     <code>ConfirmationChildWindow</code>    <i>OK</i>  <i>Cancel</i> ,    .    ,   ,   <code>ChildWindow</code>  <code>PopupChildWindowAction</code> . <br>   ,  <code>InteractionRequestTrigger</code>  <code>PopupChildWindowAction</code> ,       <i>RI MVVM</i> . <br> <br> <code class="xml">&lt;i:Interaction.Triggers&gt; &lt;prism:InteractionRequestTrigger SourceObject="{Binding ConfirmCancelInteractionRequest}"&gt; &lt;prism:PopupChildWindowAction ContentTemplate="{StaticResource ConfirmWindowTemplate}"/&gt; &lt;/prism:InteractionRequestTrigger&gt; &lt;/i:Interaction.Triggers&gt; &lt;UserControl.Resources&gt; &lt;DataTemplate x:Key="ConfirmWindowTemplate"&gt; &lt;Grid MinWidth="250" MinHeight="100"&gt; &lt;TextBlock TextWrapping="Wrap" Grid.Row="0" Text="{Binding}"/&gt; &lt;/Grid&gt; &lt;/DataTemplate&gt; &lt;/UserControl.Resources&gt;</code> <br> <b></b> <br>      <code>ContentTemplate</code> ,   UI   <code>Content</code>  .    <code>Content</code>  ,  , <code>TextBlock</code>     <code>Content</code> . <br>      ,     ,    ,    .  ,     ,       ,     ,    .   ,   <i>RI MVVM</i> ,         <code>Confirmed</code>    <code>Confirmation</code>  <code>true</code> ,     OK. <br> <br>        ,     .  Prism <code>InteractionRequestTrigger</code>   <code>PopupChildWindowAction</code>            . <br> <br>     <br>     MVVM,       , ,    ,         .        (  , ,  ,   ).    ,  ,  ,            . <br> <br>        ,         . Managed Extensibility Framework (MEF)  Unity Application Block (Unity)      ,  ,           . <br> <br>  ,       , , ,    ( )      . ,       ,     .  ,     ,       . <br> <br>     ,  MEF <br>  MEF,       ,   <code>Import</code> ,      ,  ,   <code>Export</code> .         ,    . <br> <br> , <code>QuestionnaireView</code>   <i>RI MVVM</i> ,        ,    <code>Import</code> .   , MEF           .  <code>set</code>        ,   . <br> <br> <code class="cs">[Import] public QuestionnaireViewModel ViewModel { set { this.DataContext = value; } }</code> <br>     ,   . <br> <br> <code class="cs">[Export] public class QuestionnaireViewModel : NotificationObject { ... }</code> <br>        ,   . <br> <br> <code class="cs">public QuestionnaireView() { InitializeComponent(); } [ImportingConstructor] public QuestionnaireView(QuestionnaireViewModel viewModel) : this() { this.DataContext = viewModel; }</code> <br> <b></b> <br>          MEF,   Unity.   ,     ,        .   ,   Visual Studio  Expression Blend, ,        ,     .   ,   ,  ,      ,          <code>InitializeComponent</code> . <br>     ,  Unity <br>  Unity,    ,   MEF.     ,      .    ,         .  ,      . <br> <br>  ,      ,  ,         . ,           ,   . <br> <br> <code class="cs">public QuestionnaireView() { InitializeComponent(); } public QuestionnaireView(QuestionnaireViewModel viewModel) : this() { this.DataContext = viewModel; }</code> <br> <b></b> <br>    ,        ,   Visual Studio  Expression Blend. <br>  ,          ,   . Unity        <code>set</code>   ,   . <br> <br> <code class="cs">public QuestionnaireView() { InitializeComponent(); } [Dependency] public QuestionnaireViewModel ViewModel { set { this.DataContext = value; } }</code> <br>       Unity. <br> <br> <code class="cs">container.RegisterType&lt;QuestionnaireViewModel&gt;();</code> <br>  ,     . <br> <br> <code class="cs">var view = container.Resolve&lt;QuestionnaireView&gt;();</code> <br>     ,    <br>   ,     ,        .        ,   MEF  Unity,        . <br> <br>          .   ,         UI,           . <br> <br> , <i>RI MVVM</i>   ,   ,        .   ,    .      <code>ShowView</code>   UI. <br> <br> <code class="cs">private void NavigateToQuestionnaireList() { //     "questionnaire list". this.uiService.ShowView(ViewNames.QuestionnaireTemplatesList); }</code> <br>  UI      UI .           UI.  <code>ShowView</code>  <code>UIService</code>      (,          ),       ,   . <br> <br> <code class="cs">public void ShowView(string viewName) { var view = this.ViewFactory.GetView(viewName); this.MainWindow.CurrentView = view; }</code> <br> <b></b> <br> Prism       .   ,   ,   ,             .    ,  , " <a href="http://msdn.microsoft.com/en-us/library/gg430861(v%3DPandP.40).aspx">View-Based Navigation</a> "   8, " <a href="http://msdn.microsoft.com/en-us/library/gg430861(v%3DPandP.40).aspx">Navigation</a> ". <br>  MVVM  <br>        MVVM      .           -      mocking . ,   ,        . <br> <br>   <i>INotifyPropertyChanged</i> <br>   <code>INotifyPropertyChanged</code>     ,      .      ,    ;   ,   ,     ,    ,       . <br> <br>   <br> ,       ,           <code>PropertyChanged</code>  ,         .  ,    <code>ChangeTracker</code> ,     MVVM,  ,      .      .     ,    . <br> <br> <code class="cs">var changeTracker = new PropertyChangeTracker(viewModel); viewModel.CurrentState = "newState"; CollectionAssert.Contains(changeTracker.ChangedProperties, "CurrentState");</code> <br> ,     ,     <code>INotifyPropertyChanged</code> ,    ,   ,     . <br> <br>      <br>        ,   ,    <code>set</code>      ,           . ,     ,     ,      ,          . <br> <br> <code class="cs">var changeTracker = new PropertyChangeTracker(viewModel); var question = viewModel.Questions.First() as OpenQuestionViewModel; question.Question.Response = "some text"; CollectionAssert.Contains(changeTracker.ChangedProperties, "UnansweredQuestions");</code> <br>      <br>     <code>INotifyPropertyChanged</code> ,      <code>PropertyChanged</code>        ,  ,     , , .        ,       . <br> <br>   <i>INotifyDataErrorInfo</i> <br>   ,     ,    ,   ,   <code>IDataErrorInfo</code> ,  ( Silverlight)   <code>INotifyDataErrorInfo</code> .   <code>INotifyDataErrorInfo</code>   ,         ,    ,  ,   ,    . <br> <br>       <code>INotifyDataErrorInfo</code> : ,     ,  ,     ,     <code>ErrorsChanged</code> ,      <code>GetErrors</code> , . <br> <br>    <br>     ,      ,     .       ,         <code>GetErrors</code>       ,  ,  ,   .    , ,  ,     ,        .   ,        . <br> <br> <code class="cs">//  . var notifyErrorInfo = (INotifyDataErrorInfo)question; question.Response = -15; Assert.IsTrue(notifyErrorInfo.GetErrors("Response").Cast&lt;ValidationResult&gt;().Any()); //  . var notifyErrorInfo = (INotifyDataErrorInfo)question; question.Response = 15; Assert.IsFalse(notifyErrorInfo.GetErrors("Response").Cast&lt;ValidationResult&gt;().Any());</code> <br>    ,    ,             . <br> <br>    <i>INotifyDataErrorInfo</i> <br>       <code>GetErrors</code> ,   <code>INotifyDataErrorInfo</code>  ,   <code>ErrorsChanged</code>      <code>GetErrors</code> . ,  <code>HasErrors</code>      ,  . <br> <br>       <code>INotifyDataErrorInfo</code> . , ,           ,   -  .      ,        <code>INotifyDataErrorInfo</code>         (,        ). <br> <br>     ,   ,  : <br>  <code>HasErrors</code>     .              ,       .  <code>ErrorsChanged</code> ,      ,         <code>GetErrors</code> .         ( ,  )     ,           .    <code>GetErrors</code>       <code>ErrorsChanged</code> . <br>    <code>INotifyPropertyChanged</code> ,  ,    <code>NotifyDataErrorInfoTestHelper</code>    MVVM,        <code>INotifyDataErrorInfo</code> ,       .   ,   ,      ,   .      . <br> <code class="cs">var helper = new NotifyDataErrorInfoTestHelper&lt;NumericQuestion, int?&gt;( question, q =&gt; q.Response); helper.ValidatePropertyChange( 6, NotifyDataErrorInfoBehavior.Nothing); helper.ValidatePropertyChange( 20, NotifyDataErrorInfoBehavior.FiresErrorsChanged | NotifyDataErrorInfoBehavior.HasErrors | NotifyDataErrorInfoBehavior.HasErrorsForProperty); helper.ValidatePropertyChange( null, NotifyDataErrorInfoBehavior.FiresErrorsChanged | NotifyDataErrorInfoBehavior.HasErrors | NotifyDataErrorInfoBehavior.HasErrorsForProperty); helper.ValidatePropertyChange( 2, NotifyDataErrorInfoBehavior.FiresErrorsChanged);</code> <br>     <br>   MVVM,     ,  .   ,    ,         . <br> <br>  ,     ,     ,       .   ,   , ,       ,     ,   <code>IAsyncResult</code>    ,  - ,   ,    UI. <br> <br>       , , ,    .   ,     .  ,      UI,     ,   ,          ,     ,        "   UI." <br> <br>     ,    ,    .   ,    ,     mock-, ,   ,   ,      ,          . <br> <br>           UI,    ,    .   ,     ,   ,      .        ,   .     ,    ,     . <br> <br> <code class="cs">questionnaireRepositoryMock .Setup( r =&gt; r.SubmitQuestionnaireAsync( It.IsAny&lt;Questionnaire&gt;(), It.IsAny&lt;Action&lt;IOperationResult&gt;&gt;())) .Callback&lt;Questionnaire, Action&lt;IOperationResult&gt;&gt;( (q, a) =&gt; callback = a); uiServicemock .Setup(svc =&gt; svc.ShowView(ViewNames.QuestionnaireTemplatesList)) .Callback&lt;string&gt;(viewName =&gt; requestedViewName = viewName); submitResultMock .Setup(sr =&gt; sr.Error) .Returns&lt;Exception&gt;(null); CompleteQuestionnaire(viewModel); viewModel.Submit(); //      UI . callback(submitResultMock.Object); //    ‚Äì     . Assert.AreEqual(ViewNames.QuestionnaireTemplatesList, requestedViewName);</code> <br> <b></b> <br>          ,        . <br>   <br>       , . "Trees in WPF"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ms753391.aspx">http://msdn.microsoft.com/en-us/library/ms753391.aspx</a> <br> <br>       , . "Attached Properties Overview"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/cc265152(VS.95).aspx">http://msdn.microsoft.com/en-us/library/cc265152(VS.95).aspx</a> <br> <br>      MEF, ."Managed Extensibility Framework Overview"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/dd460648.aspx">http://msdn.microsoft.com/en-us/library/dd460648.aspx</a> . <br> <br>      Unity, ."Unity Application Block"  MSDN: <a href="http://www.msdn.com/unity">http://www.msdn.com/unity</a> . <br> <br>      <code>DelegateCommand</code> , .Chapter 5, " <a href="http://msdn.microsoft.com/en-us/library/gg405484(v%3DPandP.40).aspx">Implementing the MVVM Pattern</a> ." <br> <br>        Microsoft Expression Blend, ."Working with built-in behaviors"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ff724013(v%3DExpression.40).aspx">http://msdn.microsoft.com/en-us/library/ff724013(v=Expression.40).aspx</a> . <br> <br>          Microsoft Expression Blend, ."Creating Custom Behaviors"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ff724708(v%3DExpression.40).aspx">http://msdn.microsoft.com/en-us/library/ff724708(v=Expression.40).aspx</a> . <br> <br>            Microsoft Expression Blend, ."Creating Custom Triggers and Actions"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ff724707(v%3DExpression.40).aspx">http://msdn.microsoft.com/en-us/library/ff724707(v=Expression.40).aspx</a> . <br> <br>         WPF  Silverlight, ."Threading Model"  "The Dispatcher Class"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ms741870.aspx">http://msdn.microsoft.com/en-us/library/ms741870.aspx</a> <br> <a href="http://msdn.microsoft.com/en-us/library/ms615907(v%3DVS.95).aspx">http://msdn.microsoft.com/en-us/library/ms615907(v=VS.95).aspx</a> . <br> <br>      unit-  Silverlight, ."Unit Testing with Silverlight 2": <a href="http://www.jeff.wilcox.name/2008/03/silverlight2-unit-testing/">http://www.jeff.wilcox.name/2008/03/silverlight2-unit-testing/</a> . <br> <br>         , .  " <a href="http://msdn.microsoft.com/en-us/library/gg430861(v%3DPandP.40).aspx">View-Based Navigation</a> " in Chapter 8, " <a href="http://msdn.microsoft.com/en-us/library/gg430861(v%3DPandP.40).aspx">Navigation</a> ." <br> <br>       ,   , ."Event-based Asynchronous Pattern Overview"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/wewwczdw.aspx">http://msdn.microsoft.com/en-us/library/wewwczdw.aspx</a> <br> <br>        <code>IAsyncResult</code> , ."Asynchronous Programming Overview"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ms228963.aspx">http://msdn.microsoft.com/en-us/library/ms228963.aspx</a></code></code></code></code></code></code></code></code></code> <pre> <code class="hljs cmake"><code><code><code><code><code><code><code><code><code class="cs"><code>CommandBehaviorBase ,    ,    ICommand</code> .           <code>CanExecuteChanged</code> ,          Silverlight,    WPF. <br> <br>    ,  ,   <code>CommandBehaviorBase    ,    .         ,      .         ,    .      ButtonBaseClickCommandBehavior</code> . <br> <br> <code class="cs">public class ButtonBaseClickCommandBehavior : CommandBehaviorBase&lt;ButtonBase&gt; { public ButtonBaseClickCommandBehavior(ButtonBase clickableObject) : base(clickableObject) { clickableObject.Click += OnClick; } private void OnClick(object sender, System.Windows.RoutedEventArgs e) { ExecuteCommand(); } }</code> <br>   <code>CommandBehaviorBase ,     .     ,          ,   . ,    ,    ,      , ,    CanExecute</code>  ,     . <br> <br>          ,   .           XAML.           .       .  Prism      ,       ,  ,   .       ,    . , ,  ,      <code>Click</code> ,       <code><span class="hljs-keyword"><span class="hljs-keyword">Command</span></span></code> .    <code>Click.<span class="hljs-keyword"><span class="hljs-keyword">Command</span></span></code> ,  . <br> <br>             .             . <br> <br> <code class="cs">public static readonly DependencyProperty CommandProperty = DependencyProperty.RegisterAttached( <span class="hljs-string"><span class="hljs-string">"Command"</span></span>, typeof(ICommand), typeof(Click), new PropertyMetadata(OnSetCommandCallback)); private static readonly DependencyProperty ClickCommandBehaviorProperty = DependencyProperty.RegisterAttached( <span class="hljs-string"><span class="hljs-string">"ClickCommandBehavior"</span></span>, typeof(ButtonBaseClickCommandBehavior), typeof(Click), null);</code> <br>    <code><span class="hljs-keyword"><span class="hljs-keyword">Command</span></span></code>    <code>ButtonBaseClickCommandBehavior</code> ,     <code>OnSetCommandCallback</code> ,     . <br> <br> <code class="cs">private static void OnSetCommandCallback(DependencyObject dependencyObject, DependencyPropertyChangedEventArgs e) { ButtonBase buttonBase = dependencyObject as ButtonBase; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (buttonBase != null) { ButtonBaseClickCommandBehavior behavior = GetOrCreateBehavior(buttonBase); behavior.<span class="hljs-keyword"><span class="hljs-keyword">Command</span></span> = e.NewValue as ICommand; } } private static void OnSetCommandParameterCallback(DependencyObject dependencyObject, DependencyPropertyChangedEventArgs e) { ButtonBase buttonBase = dependencyObject as ButtonBase; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (buttonBase != null) { ButtonBaseClickCommandBehavior behavior = GetOrCreateBehavior(buttonBase); behavior.CommandParameter = e.NewValue; } } private static ButtonBaseClickCommandBehavior GetOrCreateBehavior(ButtonBase buttonBase ) { ButtonBaseClickCommandBehavior behavior = buttonBase.GetValue(ClickCommandBehaviorProperty) as ButtonBaseClickCommandBehavior; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ( behavior == null ) { behavior = new ButtonBaseClickCommandBehavior(buttonBase); buttonBase.SetValue(ClickCommandBehaviorProperty, behavior); } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> behavior; }</code> <br>        ,  <a href="http://msdn.microsoft.com/en-us/library/cc265152(VS.95).aspx">Attached Properties Overview</a>  MSDN. <br> <br>    <br>              . ,     Silverlight,    -,     ,      ,     .     ,       . <br> <br>        ,    ( )  ,  ,     .  UI       ,            UI. <br> <br>      - <br>   -     ,       <code>IAsyncResult</code> .   ,  ,   ,  <code>GetQuestionnaire</code> ,   : <code>BeginGetQuestionnaire</code>  <code>EndGetQuestionnaire</code> .    ,   <code>BeginGetQuestionnaire</code> .     ,   ,   <code>EndGetQuestionnaire</code>    . <br> <b></b> <br>  .NET Framework <span class="hljs-number"><span class="hljs-number">4.5</span></span>      <code>await</code>  <code>async</code>     <code>*Async</code> .      <a href="http://msdn.microsoft.com/en-us/library/vstudio/hh391443.aspx"><span class="hljs-string"><span class="hljs-string">"Asynchronous Programming with Async and Await (C# and Visual Basic)"</span></span></a> . <br>  ,    <code>EndGetQuestionnaire</code> ,      ,  ()      <code>BeginGetQuestionnaire</code> .     ,      ,   <code>EndGetQuestionnaire</code> ,   . <br> <br> <code class="xml">IAsyncResult asyncResult = this.service.BeginGetQuestionnaire( GetQuestionnaireCompleted, null //  ,      ); private void GetQuestionnaireCompleted(IAsyncResult result) { try { questionnaire = this.service.EndGetQuestionnaire(ar); } catch (Exception ex) { //  -   . } }</code> <br>  ,     <code>End*</code> (  , <code>EndGetQuestionnaire</code> ),    ,      .      , ,          UI.     ,   ,        . <br> <br>        UI,     -,      UI,         UI,   <code>Dispatcher</code>    <code>SynchronizationContext</code> .  WPF  Silverlight,   <code>Dispatcher</code> . <br> <br>      <code>Questionnaire</code>  ,        <code>QuestionnaireView</code> .  Silverlight    <code>CheckAccess</code> ,  ,      UI.  ,     <code>BeginInvoke</code> ,      UI. <br> <br> <code class="cs">var dispatcher = System.Windows.Deployment.Current.Dispatcher; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (dispatcher.CheckAccess()) { QuestionnaireView.DataContext = questionnaire; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { dispatcher.BeginInvoke(() =&gt; { Questionnaire.DataContext = questionnaire; }); }</code> <br> <i>MVVM RI</i>   ,    ,   <code>IAsyncResult</code> ,   .      ,                 . ,       . <br> <br> <code class="cs">this.questionnaireRepository.GetQuestionnaireAsync( result =&gt; { this.Questionnaire = result.Result; });</code> <br>  <code>result</code>   ,     , , , .    ,     . <br> <br> <code class="cs">this.questionnaireRepository.GetQuestionnaireAsync( result =&gt; { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (result.Error == null) { this.Questionnaire = result.Result; ... } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { // Handle error. } })</code> <br>     <br>        ,      .     , ,             .        ,      ,     ,     . <br> <br>         ,      MVVM,     ,   . ,  -MVVM ,     <code>MessageBox</code>   code-behind UI,      .   MVVM     ,          . <br> <br>     MVVM,              ,          .      ,    ,   ,  ,     . <br> <br>              MVVM.      ,     ,     ,  ,     .    ,         ,     ,          .       . <br> <br>    <br>                  .        ,        .  ,         .         . <br> <br>  ,         ,         ,  .      ,     .           ,       . ,        WPF  Silverlight,        . <br> <br> <img title="Using the service to interact with the user." src="https://habrastorage.org/getpro/habr/post_images/4b5/397/f2d/4b5397f2d02e5851195b29f1893be6fc.png" alt=" ,    ."> <br> <br>  ,   <code>MessageBox</code>        ,     ,    ,     . <br> <br> <code class="cs">var result = interactionService.ShowMessageBox( <span class="hljs-string"><span class="hljs-string">"Are you sure you want to cancel this operation?"</span></span>, <span class="hljs-string"><span class="hljs-string">"Confirm"</span></span>, MessageBoxButton.OK); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (result == MessageBoxResult.Yes) { CancelRequest(); }</code> <br> ,      - ,      ,         Silverlight.         .             .     . <br> <br> <code class="cs">interactionService.ShowMessageBox( <span class="hljs-string"><span class="hljs-string">"Are you sure you want to cancel this operation?"</span></span>, <span class="hljs-string"><span class="hljs-string">"Confirm"</span></span>, MessageBoxButton.OK, result =&gt; { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (result == MessageBoxResult.Yes) { CancelRequest(); } });</code> <br>         ,      . ,  WPF    <code>MessageBox</code> ,       ;    Silverlight    ,    . <br> <br>     <br>         ‚Äì             .         ,      .     ,     .        ,        ,   ,     . <br> <br> <img title="Using interaction request objects." src="https://habrastorage.org/getpro/habr/post_images/3d0/ff0/1c5/3d0ff01c5518558c2d3c5c5f47ce0ce9.png" alt="   ."> <br> <br>    ,   ,          ‚Äì       ,      ,   ‚Äì     .   ,        ,    ,    UI            . <br> <br>       MVVM,     ,       ,         .         ,        ,    ,   . <br> <br>  Prism       <code>IInteractionRequest</code>   <code>InteractionRequest .  IInteractionRequest</code>  ,   .           ,   .  <code>InteractionRequest   IInteractionRequest</code>     <code>Raise</code> ,           , , ,   . <br> <br>       <br>  <code>InteractionRequest          .  Raise</code>          ( <code>T</code> )    ,    ,   .          ,       .      ,        .    ,  ,     . <br> <code class="cs">public interface IInteractionRequest { event EventHandler&lt;InteractionRequestedEventArgs&gt; Raised; } public class InteractionRequest&lt;T&gt; : IInteractionRequest { public event EventHandler&lt;InteractionRequestedEventArgs&gt; Raised; public void Raise(T context, Action&lt;T&gt; callback) { var handler = this.Raised; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (handler != null) { handler( this, new InteractionRequestedEventArgs(context, () =&gt; callback(context))); } } }</code> <br> Prism    ,      .  <code>Notification</code>       .    ,            .     ‚Äì <code>Title</code>  <code>Content</code> ,    .  ,   ,  ,  ,        . <br> <br>  <code>Confirmation</code>    <code>Notification</code>     ‚Äì <code>Confirmed</code> ,  ,  ,      .  <code>Confirmation</code> ,     <code>MessageBox</code> ,     /  .     ,     <code>Notification</code> ,     ,      . <br> <br>    <code>InteractionRequest ,       InteractionRequest      ,      .      ,    Raise</code> ,    , ,   . <br> <br> <code class="cs">public IInteractionRequest ConfirmCancelInteractionRequest { get { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> this.confirmCancelInteractionRequest; } } this.confirmCancelInteractionRequest.Raise( new Confirmation(<span class="hljs-string"><span class="hljs-string">"Are you sure you wish to cancel?"</span></span>), confirmation =&gt; { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (confirmation.Confirmed) { this.NavigateToQuestionnaireList(); } }); }</code> <br> <i>MVVM Reference Implementation (MVVM RI)</i> ,    <code>IInteractionRequest</code>   <code>InteractionRequest ,          (. QuestionnaireViewModel.cs</code> ). <br> <br>        <br>       ,       .   ,       .    UI             . <br> <br>                . Microsoft Expression Blend Behaviors Framework     .  ,     ,    . <br> <br>  <code>EventTrigger</code> ,  Expression Blend,  ,      ,     ,   . , Prism   <code>EventTrigger</code> ,  <code>InteractionRequestTrigger</code> ,      <code>Raised</code>   <code>IInteractionRequest</code> .    XAML        . <br> <br>  ,   , <code>InteractionRequestTrigger</code>   .  Silverlight Prism   <code>PopupChildWindowAction</code> ,     .    ,         .   <code>ContentTemplate</code>  <code>PopupChildWindowAction</code> ,    ,    UI,      <code>Content</code>  .       <code>Title</code>  . <br> <b></b> <br>  ,    ,   <code>PopupChildWindowAction</code> ,     .    <code>Notification</code>  <code>NotificationChildWindow</code> ,        <code>Confirmation</code> ‚Äì <code>ConfirmationChildWindow</code> . <code>NotificationChildWindow</code>    ,   ,     <code>ConfirmationChildWindow</code>    <i>OK</i>  <i>Cancel</i> ,    .    ,   ,   <code>ChildWindow</code>  <code>PopupChildWindowAction</code> . <br>   ,  <code>InteractionRequestTrigger</code>  <code>PopupChildWindowAction</code> ,       <i>RI MVVM</i> . <br> <br> <code class="xml">&lt;i:Interaction.Triggers&gt; &lt;prism:InteractionRequestTrigger SourceObject=<span class="hljs-string"><span class="hljs-string">"{Binding ConfirmCancelInteractionRequest}"</span></span>&gt; &lt;prism:PopupChildWindowAction ContentTemplate=<span class="hljs-string"><span class="hljs-string">"{StaticResource ConfirmWindowTemplate}"</span></span>/&gt; &lt;/prism:InteractionRequestTrigger&gt; &lt;/i:Interaction.Triggers&gt; &lt;UserControl.Resources&gt; &lt;DataTemplate x:Key=<span class="hljs-string"><span class="hljs-string">"ConfirmWindowTemplate"</span></span>&gt; &lt;Grid MinWidth=<span class="hljs-string"><span class="hljs-string">"250"</span></span> MinHeight=<span class="hljs-string"><span class="hljs-string">"100"</span></span>&gt; &lt;TextBlock TextWrapping=<span class="hljs-string"><span class="hljs-string">"Wrap"</span></span> Grid.Row=<span class="hljs-string"><span class="hljs-string">"0"</span></span> Text=<span class="hljs-string"><span class="hljs-string">"{Binding}"</span></span>/&gt; &lt;/Grid&gt; &lt;/DataTemplate&gt; &lt;/UserControl.Resources&gt;</code> <br> <b></b> <br>      <code>ContentTemplate</code> ,   UI   <code>Content</code>  .    <code>Content</code>  ,  , <code>TextBlock</code>     <code>Content</code> . <br>      ,     ,    ,    .  ,     ,       ,     ,    .   ,   <i>RI MVVM</i> ,         <code>Confirmed</code>    <code>Confirmation</code>  <code><span class="hljs-keyword"><span class="hljs-keyword">true</span></span></code> ,     OK. <br> <br>        ,     .  Prism <code>InteractionRequestTrigger</code>   <code>PopupChildWindowAction</code>            . <br> <br>     <br>     MVVM,       , ,    ,         .        (  , ,  ,   ).    ,  ,  ,            . <br> <br>        ,         . Managed Extensibility Framework (MEF)  Unity Application Block (Unity)      ,  ,           . <br> <br>  ,       , , ,    ( )      . ,       ,     .  ,     ,       . <br> <br>     ,  MEF <br>  MEF,       ,   <code>Import</code> ,      ,  ,   <code><span class="hljs-keyword"><span class="hljs-keyword">Export</span></span></code> .         ,    . <br> <br> , <code>QuestionnaireView</code>   <i>RI MVVM</i> ,        ,    <code>Import</code> .   , MEF           .  <code><span class="hljs-keyword"><span class="hljs-keyword">set</span></span></code>        ,   . <br> <br> <code class="cs">[Import] public QuestionnaireViewModel ViewModel { <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> { this.DataContext = value; } }</code> <br>     ,   . <br> <br> <code class="cs">[<span class="hljs-keyword"><span class="hljs-keyword">Export</span></span>] public class QuestionnaireViewModel : NotificationObject { ... }</code> <br>        ,   . <br> <br> <code class="cs">public QuestionnaireView() { InitializeComponent(); } [ImportingConstructor] public QuestionnaireView(QuestionnaireViewModel viewModel) : this() { this.DataContext = viewModel; }</code> <br> <b></b> <br>          MEF,   Unity.   ,     ,        .   ,   Visual Studio  Expression Blend, ,        ,     .   ,   ,  ,      ,          <code>InitializeComponent</code> . <br>     ,  Unity <br>  Unity,    ,   MEF.     ,      .    ,         .  ,      . <br> <br>  ,      ,  ,         . ,           ,   . <br> <br> <code class="cs">public QuestionnaireView() { InitializeComponent(); } public QuestionnaireView(QuestionnaireViewModel viewModel) : this() { this.DataContext = viewModel; }</code> <br> <b></b> <br>    ,        ,   Visual Studio  Expression Blend. <br>  ,          ,   . Unity        <code><span class="hljs-keyword"><span class="hljs-keyword">set</span></span></code>   ,   . <br> <br> <code class="cs">public QuestionnaireView() { InitializeComponent(); } [Dependency] public QuestionnaireViewModel ViewModel { <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> { this.DataContext = value; } }</code> <br>       Unity. <br> <br> <code class="cs">container.RegisterType&lt;QuestionnaireViewModel&gt;();</code> <br>  ,     . <br> <br> var view = container.Resolve&lt;QuestionnaireView&gt;(); <br>     ,    <br>   ,     ,        .        ,   MEF  Unity,        . <br> <br>          .   ,         UI,           . <br> <br> , <i>RI MVVM</i>   ,   ,        .   ,    .      <code>ShowView</code>   UI. <br> <br> <code class="cs">private void NavigateToQuestionnaireList() { //     <span class="hljs-string"><span class="hljs-string">"questionnaire list"</span></span>. this.uiService.ShowView(ViewNames.QuestionnaireTemplatesList); }</code> <br>  UI      UI .           UI.  <code>ShowView</code>  <code>UIService</code>      (,          ),       ,   . <br> <br> <code class="cs">public void ShowView(<span class="hljs-keyword"><span class="hljs-keyword">string</span></span> viewName) { var view = this.ViewFactory.GetView(viewName); this.MainWindow.CurrentView = view; }</code> <br> <b></b> <br> Prism       .   ,   ,   ,             .    ,  , <span class="hljs-string"><span class="hljs-string">" </span></span><a href="http://msdn.microsoft.com/en-us/library/gg430861(v%3DPandP.40).aspx"><span class="hljs-string"><span class="hljs-string">View-Based Navigation</span></span></a><span class="hljs-string"><span class="hljs-string"> "</span></span>   <span class="hljs-number"><span class="hljs-number">8</span></span>, <span class="hljs-string"><span class="hljs-string">" </span></span><a href="http://msdn.microsoft.com/en-us/library/gg430861(v%3DPandP.40).aspx"><span class="hljs-string"><span class="hljs-string">Navigation</span></span></a><span class="hljs-string"><span class="hljs-string"> "</span></span>. <br>  MVVM  <br>        MVVM      .           -      mocking . ,   ,        . <br> <br>   <i>INotifyPropertyChanged</i> <br>   <code>INotifyPropertyChanged</code>     ,      .      ,    ;   ,   ,     ,    ,       . <br> <br>   <br> ,       ,           <code>PropertyChanged</code>  ,         .  ,    <code>ChangeTracker</code> ,     MVVM,  ,      .      .     ,    . <br> <br> <code class="cs">var changeTracker = new PropertyChangeTracker(viewModel); viewModel.CurrentState = <span class="hljs-string"><span class="hljs-string">"newState"</span></span>; CollectionAssert.Contains(changeTracker.ChangedProperties, <span class="hljs-string"><span class="hljs-string">"CurrentState"</span></span>);</code> <br> ,     ,     <code>INotifyPropertyChanged</code> ,    ,   ,     . <br> <br>      <br>        ,   ,    <code><span class="hljs-keyword"><span class="hljs-keyword">set</span></span></code>      ,           . ,     ,     ,      ,          . <br> <br> <code class="cs">var changeTracker = new PropertyChangeTracker(viewModel); var question = viewModel.Questions.First() as OpenQuestionViewModel; question.Question.Response = <span class="hljs-string"><span class="hljs-string">"some text"</span></span>; CollectionAssert.Contains(changeTracker.ChangedProperties, <span class="hljs-string"><span class="hljs-string">"UnansweredQuestions"</span></span>);</code> <br>      <br>     <code>INotifyPropertyChanged</code> ,      <code>PropertyChanged</code>        ,  ,     , , .        ,       . <br> <br>   <i>INotifyDataErrorInfo</i> <br>   ,     ,    ,   ,   <code>IDataErrorInfo</code> ,  ( Silverlight)   <code>INotifyDataErrorInfo</code> .   <code>INotifyDataErrorInfo</code>   ,         ,    ,  ,   ,    . <br> <br>       <code>INotifyDataErrorInfo</code> : ,     ,  ,     ,     <code>ErrorsChanged</code> ,      <code>GetErrors</code> , . <br> <br>    <br>     ,      ,     .       ,         <code>GetErrors</code>       ,  ,  ,   .    , ,  ,     ,        .   ,        . <br> <br> <code class="cs">//  . var notifyErrorInfo = (INotifyDataErrorInfo)question; question.Response = -<span class="hljs-number"><span class="hljs-number">15</span></span>; Assert.IsTrue(notifyErrorInfo.GetErrors(<span class="hljs-string"><span class="hljs-string">"Response"</span></span>).Cast&lt;ValidationResult&gt;().Any()); //  . var notifyErrorInfo = (INotifyDataErrorInfo)question; question.Response = <span class="hljs-number"><span class="hljs-number">15</span></span>; Assert.IsFalse(notifyErrorInfo.GetErrors(<span class="hljs-string"><span class="hljs-string">"Response"</span></span>).Cast&lt;ValidationResult&gt;().Any());</code> <br>    ,    ,             . <br> <br>    <i>INotifyDataErrorInfo</i> <br>       <code>GetErrors</code> ,   <code>INotifyDataErrorInfo</code>  ,   <code>ErrorsChanged</code>      <code>GetErrors</code> . ,  <code>HasErrors</code>      ,  . <br> <br>       <code>INotifyDataErrorInfo</code> . , ,           ,   -  .      ,        <code>INotifyDataErrorInfo</code>         (,        ). <br> <br>     ,   ,  : <br>  <code>HasErrors</code>     .              ,       .  <code>ErrorsChanged</code> ,      ,         <code>GetErrors</code> .         ( ,  )     ,           .    <code>GetErrors</code>       <code>ErrorsChanged</code> . <br>    <code>INotifyPropertyChanged</code> ,  ,    <code>NotifyDataErrorInfoTestHelper</code>    MVVM,        <code>INotifyDataErrorInfo</code> ,       .   ,   ,      ,   .      . <br> <code class="cs">var helper = new NotifyDataErrorInfoTestHelper&lt;NumericQuestion, int?&gt;( question, q =&gt; q.Response); helper.ValidatePropertyChange( <span class="hljs-number"><span class="hljs-number">6</span></span>, NotifyDataErrorInfoBehavior.Nothing); helper.ValidatePropertyChange( <span class="hljs-number"><span class="hljs-number">20</span></span>, NotifyDataErrorInfoBehavior.FiresErrorsChanged | NotifyDataErrorInfoBehavior.HasErrors | NotifyDataErrorInfoBehavior.HasErrorsForProperty); helper.ValidatePropertyChange( null, NotifyDataErrorInfoBehavior.FiresErrorsChanged | NotifyDataErrorInfoBehavior.HasErrors | NotifyDataErrorInfoBehavior.HasErrorsForProperty); helper.ValidatePropertyChange( <span class="hljs-number"><span class="hljs-number">2</span></span>, NotifyDataErrorInfoBehavior.FiresErrorsChanged);</code> <br>     <br>   MVVM,     ,  .   ,    ,         . <br> <br>  ,     ,     ,       .   ,   , ,       ,     ,   <code>IAsyncResult</code>    ,  - ,   ,    UI. <br> <br>       , , ,    .   ,     .  ,      UI,     ,   ,          ,     ,        <span class="hljs-string"><span class="hljs-string">"   UI."</span></span> <br> <br>     ,    ,    .   ,    ,     mock-, ,   ,   ,      ,          . <br> <br>           UI,    ,    .   ,     ,   ,      .        ,   .     ,    ,     . <br> <br> <code class="cs">questionnaireRepositoryMock .Setup( r =&gt; r.SubmitQuestionnaireAsync( It.IsAny&lt;Questionnaire&gt;(), It.IsAny&lt;Action&lt;IOperationResult&gt;&gt;())) .Callback&lt;Questionnaire, Action&lt;IOperationResult&gt;&gt;( (q, a) =&gt; callback = a); uiServicemock .Setup(svc =&gt; svc.ShowView(ViewNames.QuestionnaireTemplatesList)) .Callback&lt;<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>&gt;(viewName =&gt; requestedViewName = viewName); submitResultMock .Setup(sr =&gt; sr.Error) .Returns&lt;Exception&gt;(null); CompleteQuestionnaire(viewModel); viewModel.Submit(); //      UI . callback(submitResultMock.Object); //    ‚Äì     . Assert.AreEqual(ViewNames.QuestionnaireTemplatesList, requestedViewName);</code> <br> <b></b> <br>          ,        . <br>   <br>       , . <span class="hljs-string"><span class="hljs-string">"Trees in WPF"</span></span>  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ms753391.aspx">http://msdn.microsoft.com/en-us/library/ms753391.aspx</a> <br> <br>       , . <span class="hljs-string"><span class="hljs-string">"Attached Properties Overview"</span></span>  MSDN: <a href="http://msdn.microsoft.com/en-us/library/cc265152(VS.95).aspx">http://msdn.microsoft.com/en-us/library/cc265152(VS.<span class="hljs-number"><span class="hljs-number">95</span></span>).aspx</a> <br> <br>      MEF, .<span class="hljs-string"><span class="hljs-string">"Managed Extensibility Framework Overview"</span></span>  MSDN: <a href="http://msdn.microsoft.com/en-us/library/dd460648.aspx">http://msdn.microsoft.com/en-us/library/dd460648.aspx</a> . <br> <br>      Unity, .<span class="hljs-string"><span class="hljs-string">"Unity Application Block"</span></span>  MSDN: <a href="http://www.msdn.com/unity">http://www.msdn.com/unity</a> . <br> <br>      <code>DelegateCommand</code> , .Chapter <span class="hljs-number"><span class="hljs-number">5</span></span>, <span class="hljs-string"><span class="hljs-string">" </span></span><a href="http://msdn.microsoft.com/en-us/library/gg405484(v%3DPandP.40).aspx"><span class="hljs-string"><span class="hljs-string">Implementing the MVVM Pattern</span></span></a><span class="hljs-string"><span class="hljs-string"> ."</span></span> <br> <br>        Microsoft Expression Blend, .<span class="hljs-string"><span class="hljs-string">"Working with built-in behaviors"</span></span>  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ff724013(v%3DExpression.40).aspx">http://msdn.microsoft.com/en-us/library/ff724013(v=Expression.<span class="hljs-number"><span class="hljs-number">40</span></span>).aspx</a> . <br> <br>          Microsoft Expression Blend, .<span class="hljs-string"><span class="hljs-string">"Creating Custom Behaviors"</span></span>  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ff724708(v%3DExpression.40).aspx">http://msdn.microsoft.com/en-us/library/ff724708(v=Expression.<span class="hljs-number"><span class="hljs-number">40</span></span>).aspx</a> . <br> <br>            Microsoft Expression Blend, .<span class="hljs-string"><span class="hljs-string">"Creating Custom Triggers and Actions"</span></span>  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ff724707(v%3DExpression.40).aspx">http://msdn.microsoft.com/en-us/library/ff724707(v=Expression.<span class="hljs-number"><span class="hljs-number">40</span></span>).aspx</a> . <br> <br>         WPF  Silverlight, .<span class="hljs-string"><span class="hljs-string">"Threading Model"</span></span>  <span class="hljs-string"><span class="hljs-string">"The Dispatcher Class"</span></span>  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ms741870.aspx">http://msdn.microsoft.com/en-us/library/ms741870.aspx</a> <br> <a href="http://msdn.microsoft.com/en-us/library/ms615907(v%3DVS.95).aspx">http://msdn.microsoft.com/en-us/library/ms615907(v=VS.<span class="hljs-number"><span class="hljs-number">95</span></span>).aspx</a> . <br> <br>      unit-  Silverlight, .<span class="hljs-string"><span class="hljs-string">"Unit Testing with Silverlight 2"</span></span>: <a href="http://www.jeff.wilcox.name/2008/03/silverlight2-unit-testing/">http://www.jeff.wilcox.name/<span class="hljs-number"><span class="hljs-number">2008</span></span>/<span class="hljs-number"><span class="hljs-number">03</span></span>/silverlight2-unit-testing/</a> . <br> <br>         , .  <span class="hljs-string"><span class="hljs-string">" </span></span><a href="http://msdn.microsoft.com/en-us/library/gg430861(v%3DPandP.40).aspx"><span class="hljs-string"><span class="hljs-string">View-Based Navigation</span></span></a><span class="hljs-string"><span class="hljs-string"> "</span></span> in Chapter <span class="hljs-number"><span class="hljs-number">8</span></span>, <span class="hljs-string"><span class="hljs-string">" </span></span><a href="http://msdn.microsoft.com/en-us/library/gg430861(v%3DPandP.40).aspx"><span class="hljs-string"><span class="hljs-string">Navigation</span></span></a><span class="hljs-string"><span class="hljs-string"> ."</span></span> <br> <br>       ,   , .<span class="hljs-string"><span class="hljs-string">"Event-based Asynchronous Pattern Overview"</span></span>  MSDN: <a href="http://msdn.microsoft.com/en-us/library/wewwczdw.aspx">http://msdn.microsoft.com/en-us/library/wewwczdw.aspx</a> <br> <br>        <code>IAsyncResult</code> , .<span class="hljs-string"><span class="hljs-string">"Asynchronous Programming Overview"</span></span>  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ms228963.aspx">http://msdn.microsoft.com/en-us/library/ms228963.aspx</a></code></code></code></code></code></code></code></code></code></code> </pre> <code><code><code><code><code><code><code><code><code><code>CommandBehaviorBase ,    ,    ICommand</code> .           <code>CanExecuteChanged</code> ,          Silverlight,    WPF. <br> <br>    ,  ,   <code>CommandBehaviorBase    ,    .         ,      .         ,    .      ButtonBaseClickCommandBehavior</code> . <br> <br> <code class="cs">public class ButtonBaseClickCommandBehavior : CommandBehaviorBase&lt;ButtonBase&gt; { public ButtonBaseClickCommandBehavior(ButtonBase clickableObject) : base(clickableObject) { clickableObject.Click += OnClick; } private void OnClick(object sender, System.Windows.RoutedEventArgs e) { ExecuteCommand(); } }</code> <br>   <code>CommandBehaviorBase ,     .     ,          ,   . ,    ,    ,      , ,    CanExecute</code>  ,     . <br> <br>          ,   .           XAML.           .       .  Prism      ,       ,  ,   .       ,    . , ,  ,      <code>Click</code> ,       <code>Command</code> .    <code>Click.Command</code> ,  . <br> <br>             .             . <br> <br> <code class="cs">public static readonly DependencyProperty CommandProperty = DependencyProperty.RegisterAttached( "Command", typeof(ICommand), typeof(Click), new PropertyMetadata(OnSetCommandCallback)); private static readonly DependencyProperty ClickCommandBehaviorProperty = DependencyProperty.RegisterAttached( "ClickCommandBehavior", typeof(ButtonBaseClickCommandBehavior), typeof(Click), null);</code> <br>    <code>Command</code>    <code>ButtonBaseClickCommandBehavior</code> ,     <code>OnSetCommandCallback</code> ,     . <br> <br> <code class="cs">private static void OnSetCommandCallback(DependencyObject dependencyObject, DependencyPropertyChangedEventArgs e) { ButtonBase buttonBase = dependencyObject as ButtonBase; if (buttonBase != null) { ButtonBaseClickCommandBehavior behavior = GetOrCreateBehavior(buttonBase); behavior.Command = e.NewValue as ICommand; } } private static void OnSetCommandParameterCallback(DependencyObject dependencyObject, DependencyPropertyChangedEventArgs e) { ButtonBase buttonBase = dependencyObject as ButtonBase; if (buttonBase != null) { ButtonBaseClickCommandBehavior behavior = GetOrCreateBehavior(buttonBase); behavior.CommandParameter = e.NewValue; } } private static ButtonBaseClickCommandBehavior GetOrCreateBehavior(ButtonBase buttonBase ) { ButtonBaseClickCommandBehavior behavior = buttonBase.GetValue(ClickCommandBehaviorProperty) as ButtonBaseClickCommandBehavior; if ( behavior == null ) { behavior = new ButtonBaseClickCommandBehavior(buttonBase); buttonBase.SetValue(ClickCommandBehaviorProperty, behavior); } return behavior; }</code> <br>        ,  <a href="http://msdn.microsoft.com/en-us/library/cc265152(VS.95).aspx">Attached Properties Overview</a>  MSDN. <br> <br>    <br>              . ,     Silverlight,    -,     ,      ,     .     ,       . <br> <br>        ,    ( )  ,  ,     .  UI       ,            UI. <br> <br>      - <br>   -     ,       <code>IAsyncResult</code> .   ,  ,   ,  <code>GetQuestionnaire</code> ,   : <code>BeginGetQuestionnaire</code>  <code>EndGetQuestionnaire</code> .    ,   <code>BeginGetQuestionnaire</code> .     ,   ,   <code>EndGetQuestionnaire</code>    . <br> <b></b> <br>  .NET Framework 4.5      <code>await</code>  <code>async</code>     <code>*Async</code> .      <a href="http://msdn.microsoft.com/en-us/library/vstudio/hh391443.aspx">"Asynchronous Programming with Async and Await (C# and Visual Basic)"</a> . <br>  ,    <code>EndGetQuestionnaire</code> ,      ,  ()      <code>BeginGetQuestionnaire</code> .     ,      ,   <code>EndGetQuestionnaire</code> ,   . <br> <br> <code class="xml">IAsyncResult asyncResult = this.service.BeginGetQuestionnaire( GetQuestionnaireCompleted, null //  ,      ); private void GetQuestionnaireCompleted(IAsyncResult result) { try { questionnaire = this.service.EndGetQuestionnaire(ar); } catch (Exception ex) { //  -   . } }</code> <br>  ,     <code>End*</code> (  , <code>EndGetQuestionnaire</code> ),    ,      .      , ,          UI.     ,   ,        . <br> <br>        UI,     -,      UI,         UI,   <code>Dispatcher</code>    <code>SynchronizationContext</code> .  WPF  Silverlight,   <code>Dispatcher</code> . <br> <br>      <code>Questionnaire</code>  ,        <code>QuestionnaireView</code> .  Silverlight    <code>CheckAccess</code> ,  ,      UI.  ,     <code>BeginInvoke</code> ,      UI. <br> <br> <code class="cs">var dispatcher = System.Windows.Deployment.Current.Dispatcher; if (dispatcher.CheckAccess()) { QuestionnaireView.DataContext = questionnaire; } else { dispatcher.BeginInvoke(() =&gt; { Questionnaire.DataContext = questionnaire; }); }</code> <br> <i>MVVM RI</i>   ,    ,   <code>IAsyncResult</code> ,   .      ,                 . ,       . <br> <br> <code class="cs">this.questionnaireRepository.GetQuestionnaireAsync( result =&gt; { this.Questionnaire = result.Result; });</code> <br>  <code>result</code>   ,     , , , .    ,     . <br> <br> <code class="cs">this.questionnaireRepository.GetQuestionnaireAsync( result =&gt; { if (result.Error == null) { this.Questionnaire = result.Result; ... } else { // Handle error. } })</code> <br>     <br>        ,      .     , ,             .        ,      ,     ,     . <br> <br>         ,      MVVM,     ,   . ,  -MVVM ,     <code>MessageBox</code>   code-behind UI,      .   MVVM     ,          . <br> <br>     MVVM,              ,          .      ,    ,   ,  ,     . <br> <br>              MVVM.      ,     ,     ,  ,     .    ,         ,     ,          .       . <br> <br>    <br>                  .        ,        .  ,         .         . <br> <br>  ,         ,         ,  .      ,     .           ,       . ,        WPF  Silverlight,        . <br> <br> <img title="Using the service to interact with the user." src="https://habrastorage.org/getpro/habr/post_images/4b5/397/f2d/4b5397f2d02e5851195b29f1893be6fc.png" alt=" ,    ."> <br> <br>  ,   <code>MessageBox</code>        ,     ,    ,     . <br> <br> <code class="cs">var result = interactionService.ShowMessageBox( "Are you sure you want to cancel this operation?", "Confirm", MessageBoxButton.OK); if (result == MessageBoxResult.Yes) { CancelRequest(); }</code> <br> ,      - ,      ,         Silverlight.         .             .     . <br> <br> <code class="cs">interactionService.ShowMessageBox( "Are you sure you want to cancel this operation?", "Confirm", MessageBoxButton.OK, result =&gt; { if (result == MessageBoxResult.Yes) { CancelRequest(); } });</code> <br>         ,      . ,  WPF    <code>MessageBox</code> ,       ;    Silverlight    ,    . <br> <br>     <br>         ‚Äì             .         ,      .     ,     .        ,        ,   ,     . <br> <br> <img title="Using interaction request objects." src="https://habrastorage.org/getpro/habr/post_images/3d0/ff0/1c5/3d0ff01c5518558c2d3c5c5f47ce0ce9.png" alt="   ."> <br> <br>    ,   ,          ‚Äì       ,      ,   ‚Äì     .   ,        ,    ,    UI            . <br> <br>       MVVM,     ,       ,         .         ,        ,    ,   . <br> <br>  Prism       <code>IInteractionRequest</code>   <code>InteractionRequest .  IInteractionRequest</code>  ,   .           ,   .  <code>InteractionRequest   IInteractionRequest</code>     <code>Raise</code> ,           , , ,   . <br> <br>       <br>  <code>InteractionRequest          .  Raise</code>          ( <code>T</code> )    ,    ,   .          ,       .      ,        .    ,  ,     . <br> <code class="cs">public interface IInteractionRequest { event EventHandler&lt;InteractionRequestedEventArgs&gt; Raised; } public class InteractionRequest&lt;T&gt; : IInteractionRequest { public event EventHandler&lt;InteractionRequestedEventArgs&gt; Raised; public void Raise(T context, Action&lt;T&gt; callback) { var handler = this.Raised; if (handler != null) { handler( this, new InteractionRequestedEventArgs(context, () =&gt; callback(context))); } } }</code> <br> Prism    ,      .  <code>Notification</code>       .    ,            .     ‚Äì <code>Title</code>  <code>Content</code> ,    .  ,   ,  ,  ,        . <br> <br>  <code>Confirmation</code>    <code>Notification</code>     ‚Äì <code>Confirmed</code> ,  ,  ,      .  <code>Confirmation</code> ,     <code>MessageBox</code> ,     /  .     ,     <code>Notification</code> ,     ,      . <br> <br>    <code>InteractionRequest ,       InteractionRequest      ,      .      ,    Raise</code> ,    , ,   . <br> <br> <code class="cs">public IInteractionRequest ConfirmCancelInteractionRequest { get { return this.confirmCancelInteractionRequest; } } this.confirmCancelInteractionRequest.Raise( new Confirmation("Are you sure you wish to cancel?"), confirmation =&gt; { if (confirmation.Confirmed) { this.NavigateToQuestionnaireList(); } }); }</code> <br> <i>MVVM Reference Implementation (MVVM RI)</i> ,    <code>IInteractionRequest</code>   <code>InteractionRequest ,          (. QuestionnaireViewModel.cs</code> ). <br> <br>        <br>       ,       .   ,       .    UI             . <br> <br>                . Microsoft Expression Blend Behaviors Framework     .  ,     ,    . <br> <br>  <code>EventTrigger</code> ,  Expression Blend,  ,      ,     ,   . , Prism   <code>EventTrigger</code> ,  <code>InteractionRequestTrigger</code> ,      <code>Raised</code>   <code>IInteractionRequest</code> .    XAML        . <br> <br>  ,   , <code>InteractionRequestTrigger</code>   .  Silverlight Prism   <code>PopupChildWindowAction</code> ,     .    ,         .   <code>ContentTemplate</code>  <code>PopupChildWindowAction</code> ,    ,    UI,      <code>Content</code>  .       <code>Title</code>  . <br> <b></b> <br>  ,    ,   <code>PopupChildWindowAction</code> ,     .    <code>Notification</code>  <code>NotificationChildWindow</code> ,        <code>Confirmation</code> ‚Äì <code>ConfirmationChildWindow</code> . <code>NotificationChildWindow</code>    ,   ,     <code>ConfirmationChildWindow</code>    <i>OK</i>  <i>Cancel</i> ,    .    ,   ,   <code>ChildWindow</code>  <code>PopupChildWindowAction</code> . <br>   ,  <code>InteractionRequestTrigger</code>  <code>PopupChildWindowAction</code> ,       <i>RI MVVM</i> . <br> <br> <code class="xml">&lt;i:Interaction.Triggers&gt; &lt;prism:InteractionRequestTrigger SourceObject="{Binding ConfirmCancelInteractionRequest}"&gt; &lt;prism:PopupChildWindowAction ContentTemplate="{StaticResource ConfirmWindowTemplate}"/&gt; &lt;/prism:InteractionRequestTrigger&gt; &lt;/i:Interaction.Triggers&gt; &lt;UserControl.Resources&gt; &lt;DataTemplate x:Key="ConfirmWindowTemplate"&gt; &lt;Grid MinWidth="250" MinHeight="100"&gt; &lt;TextBlock TextWrapping="Wrap" Grid.Row="0" Text="{Binding}"/&gt; &lt;/Grid&gt; &lt;/DataTemplate&gt; &lt;/UserControl.Resources&gt;</code> <br> <b></b> <br>      <code>ContentTemplate</code> ,   UI   <code>Content</code>  .    <code>Content</code>  ,  , <code>TextBlock</code>     <code>Content</code> . <br>      ,     ,    ,    .  ,     ,       ,     ,    .   ,   <i>RI MVVM</i> ,         <code>Confirmed</code>    <code>Confirmation</code>  <code>true</code> ,     OK. <br> <br>        ,     .  Prism <code>InteractionRequestTrigger</code>   <code>PopupChildWindowAction</code>            . <br> <br>     <br>     MVVM,       , ,    ,         .        (  , ,  ,   ).    ,  ,  ,            . <br> <br>        ,         . Managed Extensibility Framework (MEF)  Unity Application Block (Unity)      ,  ,           . <br> <br>  ,       , , ,    ( )      . ,       ,     .  ,     ,       . <br> <br>     ,  MEF <br>  MEF,       ,   <code>Import</code> ,      ,  ,   <code>Export</code> .         ,    . <br> <br> , <code>QuestionnaireView</code>   <i>RI MVVM</i> ,        ,    <code>Import</code> .   , MEF           .  <code>set</code>        ,   . <br> <br> <code class="cs">[Import] public QuestionnaireViewModel ViewModel { set { this.DataContext = value; } }</code> <br>     ,   . <br> <br> <code class="cs">[Export] public class QuestionnaireViewModel : NotificationObject { ... }</code> <br>        ,   . <br> <br> <code class="cs">public QuestionnaireView() { InitializeComponent(); } [ImportingConstructor] public QuestionnaireView(QuestionnaireViewModel viewModel) : this() { this.DataContext = viewModel; }</code> <br> <b></b> <br>          MEF,   Unity.   ,     ,        .   ,   Visual Studio  Expression Blend, ,        ,     .   ,   ,  ,      ,          <code>InitializeComponent</code> . <br>     ,  Unity <br>  Unity,    ,   MEF.     ,      .    ,         .  ,      . <br> <br>  ,      ,  ,         . ,           ,   . <br> <br> <code class="cs">public QuestionnaireView() { InitializeComponent(); } public QuestionnaireView(QuestionnaireViewModel viewModel) : this() { this.DataContext = viewModel; }</code> <br> <b></b> <br>    ,        ,   Visual Studio  Expression Blend. <br>  ,          ,   . Unity        <code>set</code>   ,   . <br> <br> <code class="cs">public QuestionnaireView() { InitializeComponent(); } [Dependency] public QuestionnaireViewModel ViewModel { set { this.DataContext = value; } }</code> <br>       Unity. <br> <br> <code class="cs">container.RegisterType&lt;QuestionnaireViewModel&gt;();</code> <br>  ,     . <br> <br> <code class="cs">var view = container.Resolve&lt;QuestionnaireView&gt;();</code> <br>     ,    <br>   ,     ,        .        ,   MEF  Unity,        . <br> <br>          .   ,         UI,           . <br> <br> , <i>RI MVVM</i>   ,   ,        .   ,    .      <code>ShowView</code>   UI. <br> <br> <code class="cs">private void NavigateToQuestionnaireList() { //     "questionnaire list". this.uiService.ShowView(ViewNames.QuestionnaireTemplatesList); }</code> <br>  UI      UI .           UI.  <code>ShowView</code>  <code>UIService</code>      (,          ),       ,   . <br> <br> <code class="cs">public void ShowView(string viewName) { var view = this.ViewFactory.GetView(viewName); this.MainWindow.CurrentView = view; }</code> <br> <b></b> <br> Prism       .   ,   ,   ,             .    ,  , " <a href="http://msdn.microsoft.com/en-us/library/gg430861(v%3DPandP.40).aspx">View-Based Navigation</a> "   8, " <a href="http://msdn.microsoft.com/en-us/library/gg430861(v%3DPandP.40).aspx">Navigation</a> ". <br>  MVVM  <br>        MVVM      .           -      mocking . ,   ,        . <br> <br>   <i>INotifyPropertyChanged</i> <br>   <code>INotifyPropertyChanged</code>     ,      .      ,    ;   ,   ,     ,    ,       . <br> <br>   <br> ,       ,           <code>PropertyChanged</code>  ,         .  ,    <code>ChangeTracker</code> ,     MVVM,  ,      .      .     ,    . <br> <br> <code class="cs">var changeTracker = new PropertyChangeTracker(viewModel); viewModel.CurrentState = "newState"; CollectionAssert.Contains(changeTracker.ChangedProperties, "CurrentState");</code> <br> ,     ,     <code>INotifyPropertyChanged</code> ,    ,   ,     . <br> <br>      <br>        ,   ,    <code>set</code>      ,           . ,     ,     ,      ,          . <br> <br> <code class="cs">var changeTracker = new PropertyChangeTracker(viewModel); var question = viewModel.Questions.First() as OpenQuestionViewModel; question.Question.Response = "some text"; CollectionAssert.Contains(changeTracker.ChangedProperties, "UnansweredQuestions");</code> <br>      <br>     <code>INotifyPropertyChanged</code> ,      <code>PropertyChanged</code>        ,  ,     , , .        ,       . <br> <br>   <i>INotifyDataErrorInfo</i> <br>   ,     ,    ,   ,   <code>IDataErrorInfo</code> ,  ( Silverlight)   <code>INotifyDataErrorInfo</code> .   <code>INotifyDataErrorInfo</code>   ,         ,    ,  ,   ,    . <br> <br>       <code>INotifyDataErrorInfo</code> : ,     ,  ,     ,     <code>ErrorsChanged</code> ,      <code>GetErrors</code> , . <br> <br>    <br>     ,      ,     .       ,         <code>GetErrors</code>       ,  ,  ,   .    , ,  ,     ,        .   ,        . <br> <br> <code class="cs">//  . var notifyErrorInfo = (INotifyDataErrorInfo)question; question.Response = -15; Assert.IsTrue(notifyErrorInfo.GetErrors("Response").Cast&lt;ValidationResult&gt;().Any()); //  . var notifyErrorInfo = (INotifyDataErrorInfo)question; question.Response = 15; Assert.IsFalse(notifyErrorInfo.GetErrors("Response").Cast&lt;ValidationResult&gt;().Any());</code> <br>    ,    ,             . <br> <br>    <i>INotifyDataErrorInfo</i> <br>       <code>GetErrors</code> ,   <code>INotifyDataErrorInfo</code>  ,   <code>ErrorsChanged</code>      <code>GetErrors</code> . ,  <code>HasErrors</code>      ,  . <br> <br>       <code>INotifyDataErrorInfo</code> . , ,           ,   -  .      ,        <code>INotifyDataErrorInfo</code>         (,        ). <br> <br>     ,   ,  : <br>  <code>HasErrors</code>     .              ,       .  <code>ErrorsChanged</code> ,      ,         <code>GetErrors</code> .         ( ,  )     ,           .    <code>GetErrors</code>       <code>ErrorsChanged</code> . <br>    <code>INotifyPropertyChanged</code> ,  ,    <code>NotifyDataErrorInfoTestHelper</code>    MVVM,        <code>INotifyDataErrorInfo</code> ,       .   ,   ,      ,   .      . <br> <code class="cs">var helper = new NotifyDataErrorInfoTestHelper&lt;NumericQuestion, int?&gt;( question, q =&gt; q.Response); helper.ValidatePropertyChange( 6, NotifyDataErrorInfoBehavior.Nothing); helper.ValidatePropertyChange( 20, NotifyDataErrorInfoBehavior.FiresErrorsChanged | NotifyDataErrorInfoBehavior.HasErrors | NotifyDataErrorInfoBehavior.HasErrorsForProperty); helper.ValidatePropertyChange( null, NotifyDataErrorInfoBehavior.FiresErrorsChanged | NotifyDataErrorInfoBehavior.HasErrors | NotifyDataErrorInfoBehavior.HasErrorsForProperty); helper.ValidatePropertyChange( 2, NotifyDataErrorInfoBehavior.FiresErrorsChanged);</code> <br>     <br>   MVVM,     ,  .   ,    ,         . <br> <br>  ,     ,     ,       .   ,   , ,       ,     ,   <code>IAsyncResult</code>    ,  - ,   ,    UI. <br> <br>       , , ,    .   ,     .  ,      UI,     ,   ,          ,     ,        "   UI." <br> <br>     ,    ,    .   ,    ,     mock-, ,   ,   ,      ,          . <br> <br>           UI,    ,    .   ,     ,   ,      .        ,   .     ,    ,     . <br> <br> <code class="cs">questionnaireRepositoryMock .Setup( r =&gt; r.SubmitQuestionnaireAsync( It.IsAny&lt;Questionnaire&gt;(), It.IsAny&lt;Action&lt;IOperationResult&gt;&gt;())) .Callback&lt;Questionnaire, Action&lt;IOperationResult&gt;&gt;( (q, a) =&gt; callback = a); uiServicemock .Setup(svc =&gt; svc.ShowView(ViewNames.QuestionnaireTemplatesList)) .Callback&lt;string&gt;(viewName =&gt; requestedViewName = viewName); submitResultMock .Setup(sr =&gt; sr.Error) .Returns&lt;Exception&gt;(null); CompleteQuestionnaire(viewModel); viewModel.Submit(); //      UI . callback(submitResultMock.Object); //    ‚Äì     . Assert.AreEqual(ViewNames.QuestionnaireTemplatesList, requestedViewName);</code> <br> <b></b> <br>          ,        . <br>   <br>       , . "Trees in WPF"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ms753391.aspx">http://msdn.microsoft.com/en-us/library/ms753391.aspx</a> <br> <br>       , . "Attached Properties Overview"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/cc265152(VS.95).aspx">http://msdn.microsoft.com/en-us/library/cc265152(VS.95).aspx</a> <br> <br>      MEF, ."Managed Extensibility Framework Overview"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/dd460648.aspx">http://msdn.microsoft.com/en-us/library/dd460648.aspx</a> . <br> <br>      Unity, ."Unity Application Block"  MSDN: <a href="http://www.msdn.com/unity">http://www.msdn.com/unity</a> . <br> <br>      <code>DelegateCommand</code> , .Chapter 5, " <a href="http://msdn.microsoft.com/en-us/library/gg405484(v%3DPandP.40).aspx">Implementing the MVVM Pattern</a> ." <br> <br>        Microsoft Expression Blend, ."Working with built-in behaviors"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ff724013(v%3DExpression.40).aspx">http://msdn.microsoft.com/en-us/library/ff724013(v=Expression.40).aspx</a> . <br> <br>          Microsoft Expression Blend, ."Creating Custom Behaviors"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ff724708(v%3DExpression.40).aspx">http://msdn.microsoft.com/en-us/library/ff724708(v=Expression.40).aspx</a> . <br> <br>            Microsoft Expression Blend, ."Creating Custom Triggers and Actions"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ff724707(v%3DExpression.40).aspx">http://msdn.microsoft.com/en-us/library/ff724707(v=Expression.40).aspx</a> . <br> <br>         WPF  Silverlight, ."Threading Model"  "The Dispatcher Class"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ms741870.aspx">http://msdn.microsoft.com/en-us/library/ms741870.aspx</a> <br> <a href="http://msdn.microsoft.com/en-us/library/ms615907(v%3DVS.95).aspx">http://msdn.microsoft.com/en-us/library/ms615907(v=VS.95).aspx</a> . <br> <br>      unit-  Silverlight, ."Unit Testing with Silverlight 2": <a href="http://www.jeff.wilcox.name/2008/03/silverlight2-unit-testing/">http://www.jeff.wilcox.name/2008/03/silverlight2-unit-testing/</a> . <br> <br>         , .  " <a href="http://msdn.microsoft.com/en-us/library/gg430861(v%3DPandP.40).aspx">View-Based Navigation</a> " in Chapter 8, " <a href="http://msdn.microsoft.com/en-us/library/gg430861(v%3DPandP.40).aspx">Navigation</a> ." <br> <br>       ,   , ."Event-based Asynchronous Pattern Overview"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/wewwczdw.aspx">http://msdn.microsoft.com/en-us/library/wewwczdw.aspx</a> <br> <br>        <code>IAsyncResult</code> , ."Asynchronous Programming Overview"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ms228963.aspx">http://msdn.microsoft.com/en-us/library/ms228963.aspx</a></code></code></code></code></code></code></code></code></code> <h3> <code><code><code><code><code><code><code><code><code><code>CommandBehaviorBase ,    ,    ICommand</code> .           <code>CanExecuteChanged</code> ,          Silverlight,    WPF. <br> <br>    ,  ,   <code>CommandBehaviorBase    ,    .         ,      .         ,    .      ButtonBaseClickCommandBehavior</code> . <br> <br> <code class="cs">public class ButtonBaseClickCommandBehavior : CommandBehaviorBase&lt;ButtonBase&gt; { public ButtonBaseClickCommandBehavior(ButtonBase clickableObject) : base(clickableObject) { clickableObject.Click += OnClick; } private void OnClick(object sender, System.Windows.RoutedEventArgs e) { ExecuteCommand(); } }</code> <br>   <code>CommandBehaviorBase ,     .     ,          ,   . ,    ,    ,      , ,    CanExecute</code>  ,     . <br> <br>          ,   .           XAML.           .       .  Prism      ,       ,  ,   .       ,    . , ,  ,      <code>Click</code> ,       <code>Command</code> .    <code>Click.Command</code> ,  . <br> <br>             .             . <br> <br> <code class="cs">public static readonly DependencyProperty CommandProperty = DependencyProperty.RegisterAttached( "Command", typeof(ICommand), typeof(Click), new PropertyMetadata(OnSetCommandCallback)); private static readonly DependencyProperty ClickCommandBehaviorProperty = DependencyProperty.RegisterAttached( "ClickCommandBehavior", typeof(ButtonBaseClickCommandBehavior), typeof(Click), null);</code> <br>    <code>Command</code>    <code>ButtonBaseClickCommandBehavior</code> ,     <code>OnSetCommandCallback</code> ,     . <br> <br> <code class="cs">private static void OnSetCommandCallback(DependencyObject dependencyObject, DependencyPropertyChangedEventArgs e) { ButtonBase buttonBase = dependencyObject as ButtonBase; if (buttonBase != null) { ButtonBaseClickCommandBehavior behavior = GetOrCreateBehavior(buttonBase); behavior.Command = e.NewValue as ICommand; } } private static void OnSetCommandParameterCallback(DependencyObject dependencyObject, DependencyPropertyChangedEventArgs e) { ButtonBase buttonBase = dependencyObject as ButtonBase; if (buttonBase != null) { ButtonBaseClickCommandBehavior behavior = GetOrCreateBehavior(buttonBase); behavior.CommandParameter = e.NewValue; } } private static ButtonBaseClickCommandBehavior GetOrCreateBehavior(ButtonBase buttonBase ) { ButtonBaseClickCommandBehavior behavior = buttonBase.GetValue(ClickCommandBehaviorProperty) as ButtonBaseClickCommandBehavior; if ( behavior == null ) { behavior = new ButtonBaseClickCommandBehavior(buttonBase); buttonBase.SetValue(ClickCommandBehaviorProperty, behavior); } return behavior; }</code> <br>        ,  <a href="http://msdn.microsoft.com/en-us/library/cc265152(VS.95).aspx">Attached Properties Overview</a>  MSDN. <br> <br>    <br>              . ,     Silverlight,    -,     ,      ,     .     ,       . <br> <br>        ,    ( )  ,  ,     .  UI       ,            UI. <br> <br>      - <br>   -     ,       <code>IAsyncResult</code> .   ,  ,   ,  <code>GetQuestionnaire</code> ,   : <code>BeginGetQuestionnaire</code>  <code>EndGetQuestionnaire</code> .    ,   <code>BeginGetQuestionnaire</code> .     ,   ,   <code>EndGetQuestionnaire</code>    . <br> <b></b> <br>  .NET Framework 4.5      <code>await</code>  <code>async</code>     <code>*Async</code> .      <a href="http://msdn.microsoft.com/en-us/library/vstudio/hh391443.aspx">"Asynchronous Programming with Async and Await (C# and Visual Basic)"</a> . <br>  ,    <code>EndGetQuestionnaire</code> ,      ,  ()      <code>BeginGetQuestionnaire</code> .     ,      ,   <code>EndGetQuestionnaire</code> ,   . <br> <br> <code class="xml">IAsyncResult asyncResult = this.service.BeginGetQuestionnaire( GetQuestionnaireCompleted, null //  ,      ); private void GetQuestionnaireCompleted(IAsyncResult result) { try { questionnaire = this.service.EndGetQuestionnaire(ar); } catch (Exception ex) { //  -   . } }</code> <br>  ,     <code>End*</code> (  , <code>EndGetQuestionnaire</code> ),    ,      .      , ,          UI.     ,   ,        . <br> <br>        UI,     -,      UI,         UI,   <code>Dispatcher</code>    <code>SynchronizationContext</code> .  WPF  Silverlight,   <code>Dispatcher</code> . <br> <br>      <code>Questionnaire</code>  ,        <code>QuestionnaireView</code> .  Silverlight    <code>CheckAccess</code> ,  ,      UI.  ,     <code>BeginInvoke</code> ,      UI. <br> <br> <code class="cs">var dispatcher = System.Windows.Deployment.Current.Dispatcher; if (dispatcher.CheckAccess()) { QuestionnaireView.DataContext = questionnaire; } else { dispatcher.BeginInvoke(() =&gt; { Questionnaire.DataContext = questionnaire; }); }</code> <br> <i>MVVM RI</i>   ,    ,   <code>IAsyncResult</code> ,   .      ,                 . ,       . <br> <br> <code class="cs">this.questionnaireRepository.GetQuestionnaireAsync( result =&gt; { this.Questionnaire = result.Result; });</code> <br>  <code>result</code>   ,     , , , .    ,     . <br> <br> <code class="cs">this.questionnaireRepository.GetQuestionnaireAsync( result =&gt; { if (result.Error == null) { this.Questionnaire = result.Result; ... } else { // Handle error. } })</code> <br>     <br>        ,      .     , ,             .        ,      ,     ,     . <br> <br>         ,      MVVM,     ,   . ,  -MVVM ,     <code>MessageBox</code>   code-behind UI,      .   MVVM     ,          . <br> <br>     MVVM,              ,          .      ,    ,   ,  ,     . <br> <br>              MVVM.      ,     ,     ,  ,     .    ,         ,     ,          .       . <br> <br>    <br>                  .        ,        .  ,         .         . <br> <br>  ,         ,         ,  .      ,     .           ,       . ,        WPF  Silverlight,        . <br> <br> <img title="Using the service to interact with the user." src="https://habrastorage.org/getpro/habr/post_images/4b5/397/f2d/4b5397f2d02e5851195b29f1893be6fc.png" alt=" ,    ."> <br> <br>  ,   <code>MessageBox</code>        ,     ,    ,     . <br> <br> <code class="cs">var result = interactionService.ShowMessageBox( "Are you sure you want to cancel this operation?", "Confirm", MessageBoxButton.OK); if (result == MessageBoxResult.Yes) { CancelRequest(); }</code> <br> ,      - ,      ,         Silverlight.         .             .     . <br> <br> <code class="cs">interactionService.ShowMessageBox( "Are you sure you want to cancel this operation?", "Confirm", MessageBoxButton.OK, result =&gt; { if (result == MessageBoxResult.Yes) { CancelRequest(); } });</code> <br>         ,      . ,  WPF    <code>MessageBox</code> ,       ;    Silverlight    ,    . <br> <br>     <br>         ‚Äì             .         ,      .     ,     .        ,        ,   ,     . <br> <br> <img title="Using interaction request objects." src="https://habrastorage.org/getpro/habr/post_images/3d0/ff0/1c5/3d0ff01c5518558c2d3c5c5f47ce0ce9.png" alt="   ."> <br> <br>    ,   ,          ‚Äì       ,      ,   ‚Äì     .   ,        ,    ,    UI            . <br> <br>       MVVM,     ,       ,         .         ,        ,    ,   . <br> <br>  Prism       <code>IInteractionRequest</code>   <code>InteractionRequest .  IInteractionRequest</code>  ,   .           ,   .  <code>InteractionRequest   IInteractionRequest</code>     <code>Raise</code> ,           , , ,   . <br> <br>       <br>  <code>InteractionRequest          .  Raise</code>          ( <code>T</code> )    ,    ,   .          ,       .      ,        .    ,  ,     . <br> <code class="cs">public interface IInteractionRequest { event EventHandler&lt;InteractionRequestedEventArgs&gt; Raised; } public class InteractionRequest&lt;T&gt; : IInteractionRequest { public event EventHandler&lt;InteractionRequestedEventArgs&gt; Raised; public void Raise(T context, Action&lt;T&gt; callback) { var handler = this.Raised; if (handler != null) { handler( this, new InteractionRequestedEventArgs(context, () =&gt; callback(context))); } } }</code> <br> Prism    ,      .  <code>Notification</code>       .    ,            .     ‚Äì <code>Title</code>  <code>Content</code> ,    .  ,   ,  ,  ,        . <br> <br>  <code>Confirmation</code>    <code>Notification</code>     ‚Äì <code>Confirmed</code> ,  ,  ,      .  <code>Confirmation</code> ,     <code>MessageBox</code> ,     /  .     ,     <code>Notification</code> ,     ,      . <br> <br>    <code>InteractionRequest ,       InteractionRequest      ,      .      ,    Raise</code> ,    , ,   . <br> <br> <code class="cs">public IInteractionRequest ConfirmCancelInteractionRequest { get { return this.confirmCancelInteractionRequest; } } this.confirmCancelInteractionRequest.Raise( new Confirmation("Are you sure you wish to cancel?"), confirmation =&gt; { if (confirmation.Confirmed) { this.NavigateToQuestionnaireList(); } }); }</code> <br> <i>MVVM Reference Implementation (MVVM RI)</i> ,    <code>IInteractionRequest</code>   <code>InteractionRequest ,          (. QuestionnaireViewModel.cs</code> ). <br> <br>        <br>       ,       .   ,       .    UI             . <br> <br>                . Microsoft Expression Blend Behaviors Framework     .  ,     ,    . <br> <br>  <code>EventTrigger</code> ,  Expression Blend,  ,      ,     ,   . , Prism   <code>EventTrigger</code> ,  <code>InteractionRequestTrigger</code> ,      <code>Raised</code>   <code>IInteractionRequest</code> .    XAML        . <br> <br>  ,   , <code>InteractionRequestTrigger</code>   .  Silverlight Prism   <code>PopupChildWindowAction</code> ,     .    ,         .   <code>ContentTemplate</code>  <code>PopupChildWindowAction</code> ,    ,    UI,      <code>Content</code>  .       <code>Title</code>  . <br> <b></b> <br>  ,    ,   <code>PopupChildWindowAction</code> ,     .    <code>Notification</code>  <code>NotificationChildWindow</code> ,        <code>Confirmation</code> ‚Äì <code>ConfirmationChildWindow</code> . <code>NotificationChildWindow</code>    ,   ,     <code>ConfirmationChildWindow</code>    <i>OK</i>  <i>Cancel</i> ,    .    ,   ,   <code>ChildWindow</code>  <code>PopupChildWindowAction</code> . <br>   ,  <code>InteractionRequestTrigger</code>  <code>PopupChildWindowAction</code> ,       <i>RI MVVM</i> . <br> <br> <code class="xml">&lt;i:Interaction.Triggers&gt; &lt;prism:InteractionRequestTrigger SourceObject="{Binding ConfirmCancelInteractionRequest}"&gt; &lt;prism:PopupChildWindowAction ContentTemplate="{StaticResource ConfirmWindowTemplate}"/&gt; &lt;/prism:InteractionRequestTrigger&gt; &lt;/i:Interaction.Triggers&gt; &lt;UserControl.Resources&gt; &lt;DataTemplate x:Key="ConfirmWindowTemplate"&gt; &lt;Grid MinWidth="250" MinHeight="100"&gt; &lt;TextBlock TextWrapping="Wrap" Grid.Row="0" Text="{Binding}"/&gt; &lt;/Grid&gt; &lt;/DataTemplate&gt; &lt;/UserControl.Resources&gt;</code> <br> <b></b> <br>      <code>ContentTemplate</code> ,   UI   <code>Content</code>  .    <code>Content</code>  ,  , <code>TextBlock</code>     <code>Content</code> . <br>      ,     ,    ,    .  ,     ,       ,     ,    .   ,   <i>RI MVVM</i> ,         <code>Confirmed</code>    <code>Confirmation</code>  <code>true</code> ,     OK. <br> <br>        ,     .  Prism <code>InteractionRequestTrigger</code>   <code>PopupChildWindowAction</code>            . <br> <br>     <br>     MVVM,       , ,    ,         .        (  , ,  ,   ).    ,  ,  ,            . <br> <br>        ,         . Managed Extensibility Framework (MEF)  Unity Application Block (Unity)      ,  ,           . <br> <br>  ,       , , ,    ( )      . ,       ,     .  ,     ,       . <br> <br>     ,  MEF <br>  MEF,       ,   <code>Import</code> ,      ,  ,   <code>Export</code> .         ,    . <br> <br> , <code>QuestionnaireView</code>   <i>RI MVVM</i> ,        ,    <code>Import</code> .   , MEF           .  <code>set</code>        ,   . <br> <br> <code class="cs">[Import] public QuestionnaireViewModel ViewModel { set { this.DataContext = value; } }</code> <br>     ,   . <br> <br> <code class="cs">[Export] public class QuestionnaireViewModel : NotificationObject { ... }</code> <br>        ,   . <br> <br> <code class="cs">public QuestionnaireView() { InitializeComponent(); } [ImportingConstructor] public QuestionnaireView(QuestionnaireViewModel viewModel) : this() { this.DataContext = viewModel; }</code> <br> <b></b> <br>          MEF,   Unity.   ,     ,        .   ,   Visual Studio  Expression Blend, ,        ,     .   ,   ,  ,      ,          <code>InitializeComponent</code> . <br>     ,  Unity <br>  Unity,    ,   MEF.     ,      .    ,         .  ,      . <br> <br>  ,      ,  ,         . ,           ,   . <br> <br> <code class="cs">public QuestionnaireView() { InitializeComponent(); } public QuestionnaireView(QuestionnaireViewModel viewModel) : this() { this.DataContext = viewModel; }</code> <br> <b></b> <br>    ,        ,   Visual Studio  Expression Blend. <br>  ,          ,   . Unity        <code>set</code>   ,   . <br> <br> <code class="cs">public QuestionnaireView() { InitializeComponent(); } [Dependency] public QuestionnaireViewModel ViewModel { set { this.DataContext = value; } }</code> <br>       Unity. <br> <br> <code class="cs">container.RegisterType&lt;QuestionnaireViewModel&gt;();</code> <br>  ,     . <br> <br> <code class="cs">var view = container.Resolve&lt;QuestionnaireView&gt;();</code> <br>     ,    <br>   ,     ,        .        ,   MEF  Unity,        . <br> <br>          .   ,         UI,           . <br> <br> , <i>RI MVVM</i>   ,   ,        .   ,    .      <code>ShowView</code>   UI. <br> <br> <code class="cs">private void NavigateToQuestionnaireList() { //     "questionnaire list". this.uiService.ShowView(ViewNames.QuestionnaireTemplatesList); }</code> <br>  UI      UI .           UI.  <code>ShowView</code>  <code>UIService</code>      (,          ),       ,   . <br> <br> <code class="cs">public void ShowView(string viewName) { var view = this.ViewFactory.GetView(viewName); this.MainWindow.CurrentView = view; }</code> <br> <b></b> <br> Prism       .   ,   ,   ,             .    ,  , " <a href="http://msdn.microsoft.com/en-us/library/gg430861(v%3DPandP.40).aspx">View-Based Navigation</a> "   8, " <a href="http://msdn.microsoft.com/en-us/library/gg430861(v%3DPandP.40).aspx">Navigation</a> ". <br>  MVVM  <br>        MVVM      .           -      mocking . ,   ,        . <br> <br>   <i>INotifyPropertyChanged</i> <br>   <code>INotifyPropertyChanged</code>     ,      .      ,    ;   ,   ,     ,    ,       . <br> <br>   <br> ,       ,           <code>PropertyChanged</code>  ,         .  ,    <code>ChangeTracker</code> ,     MVVM,  ,      .      .     ,    . <br> <br> <code class="cs">var changeTracker = new PropertyChangeTracker(viewModel); viewModel.CurrentState = "newState"; CollectionAssert.Contains(changeTracker.ChangedProperties, "CurrentState");</code> <br> ,     ,     <code>INotifyPropertyChanged</code> ,    ,   ,     . <br> <br>      <br>        ,   ,    <code>set</code>      ,           . ,     ,     ,      ,          . <br> <br> <code class="cs">var changeTracker = new PropertyChangeTracker(viewModel); var question = viewModel.Questions.First() as OpenQuestionViewModel; question.Question.Response = "some text"; CollectionAssert.Contains(changeTracker.ChangedProperties, "UnansweredQuestions");</code> <br>      <br>     <code>INotifyPropertyChanged</code> ,      <code>PropertyChanged</code>        ,  ,     , , .        ,       . <br> <br>   <i>INotifyDataErrorInfo</i> <br>   ,     ,    ,   ,   <code>IDataErrorInfo</code> ,  ( Silverlight)   <code>INotifyDataErrorInfo</code> .   <code>INotifyDataErrorInfo</code>   ,         ,    ,  ,   ,    . <br> <br>       <code>INotifyDataErrorInfo</code> : ,     ,  ,     ,     <code>ErrorsChanged</code> ,      <code>GetErrors</code> , . <br> <br>    <br>     ,      ,     .       ,         <code>GetErrors</code>       ,  ,  ,   .    , ,  ,     ,        .   ,        . <br> <br> <code class="cs">//  . var notifyErrorInfo = (INotifyDataErrorInfo)question; question.Response = -15; Assert.IsTrue(notifyErrorInfo.GetErrors("Response").Cast&lt;ValidationResult&gt;().Any()); //  . var notifyErrorInfo = (INotifyDataErrorInfo)question; question.Response = 15; Assert.IsFalse(notifyErrorInfo.GetErrors("Response").Cast&lt;ValidationResult&gt;().Any());</code> <br>    ,    ,             . <br> <br>    <i>INotifyDataErrorInfo</i> <br>       <code>GetErrors</code> ,   <code>INotifyDataErrorInfo</code>  ,   <code>ErrorsChanged</code>      <code>GetErrors</code> . ,  <code>HasErrors</code>      ,  . <br> <br>       <code>INotifyDataErrorInfo</code> . , ,           ,   -  .      ,        <code>INotifyDataErrorInfo</code>         (,        ). <br> <br>     ,   ,  : <br>  <code>HasErrors</code>     .              ,       .  <code>ErrorsChanged</code> ,      ,         <code>GetErrors</code> .         ( ,  )     ,           .    <code>GetErrors</code>       <code>ErrorsChanged</code> . <br>    <code>INotifyPropertyChanged</code> ,  ,    <code>NotifyDataErrorInfoTestHelper</code>    MVVM,        <code>INotifyDataErrorInfo</code> ,       .   ,   ,      ,   .      . <br> <code class="cs">var helper = new NotifyDataErrorInfoTestHelper&lt;NumericQuestion, int?&gt;( question, q =&gt; q.Response); helper.ValidatePropertyChange( 6, NotifyDataErrorInfoBehavior.Nothing); helper.ValidatePropertyChange( 20, NotifyDataErrorInfoBehavior.FiresErrorsChanged | NotifyDataErrorInfoBehavior.HasErrors | NotifyDataErrorInfoBehavior.HasErrorsForProperty); helper.ValidatePropertyChange( null, NotifyDataErrorInfoBehavior.FiresErrorsChanged | NotifyDataErrorInfoBehavior.HasErrors | NotifyDataErrorInfoBehavior.HasErrorsForProperty); helper.ValidatePropertyChange( 2, NotifyDataErrorInfoBehavior.FiresErrorsChanged);</code> <br>     <br>   MVVM,     ,  .   ,    ,         . <br> <br>  ,     ,     ,       .   ,   , ,       ,     ,   <code>IAsyncResult</code>    ,  - ,   ,    UI. <br> <br>       , , ,    .   ,     .  ,      UI,     ,   ,          ,     ,        "   UI." <br> <br>     ,    ,    .   ,    ,     mock-, ,   ,   ,      ,          . <br> <br>           UI,    ,    .   ,     ,   ,      .        ,   .     ,    ,     . <br> <br> <code class="cs">questionnaireRepositoryMock .Setup( r =&gt; r.SubmitQuestionnaireAsync( It.IsAny&lt;Questionnaire&gt;(), It.IsAny&lt;Action&lt;IOperationResult&gt;&gt;())) .Callback&lt;Questionnaire, Action&lt;IOperationResult&gt;&gt;( (q, a) =&gt; callback = a); uiServicemock .Setup(svc =&gt; svc.ShowView(ViewNames.QuestionnaireTemplatesList)) .Callback&lt;string&gt;(viewName =&gt; requestedViewName = viewName); submitResultMock .Setup(sr =&gt; sr.Error) .Returns&lt;Exception&gt;(null); CompleteQuestionnaire(viewModel); viewModel.Submit(); //      UI . callback(submitResultMock.Object); //    ‚Äì     . Assert.AreEqual(ViewNames.QuestionnaireTemplatesList, requestedViewName);</code> <br> <b></b> <br>          ,        . <br>   <br>       , . "Trees in WPF"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ms753391.aspx">http://msdn.microsoft.com/en-us/library/ms753391.aspx</a> <br> <br>       , . "Attached Properties Overview"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/cc265152(VS.95).aspx">http://msdn.microsoft.com/en-us/library/cc265152(VS.95).aspx</a> <br> <br>      MEF, ."Managed Extensibility Framework Overview"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/dd460648.aspx">http://msdn.microsoft.com/en-us/library/dd460648.aspx</a> . <br> <br>      Unity, ."Unity Application Block"  MSDN: <a href="http://www.msdn.com/unity">http://www.msdn.com/unity</a> . <br> <br>      <code>DelegateCommand</code> , .Chapter 5, " <a href="http://msdn.microsoft.com/en-us/library/gg405484(v%3DPandP.40).aspx">Implementing the MVVM Pattern</a> ." <br> <br>        Microsoft Expression Blend, ."Working with built-in behaviors"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ff724013(v%3DExpression.40).aspx">http://msdn.microsoft.com/en-us/library/ff724013(v=Expression.40).aspx</a> . <br> <br>          Microsoft Expression Blend, ."Creating Custom Behaviors"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ff724708(v%3DExpression.40).aspx">http://msdn.microsoft.com/en-us/library/ff724708(v=Expression.40).aspx</a> . <br> <br>            Microsoft Expression Blend, ."Creating Custom Triggers and Actions"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ff724707(v%3DExpression.40).aspx">http://msdn.microsoft.com/en-us/library/ff724707(v=Expression.40).aspx</a> . <br> <br>         WPF  Silverlight, ."Threading Model"  "The Dispatcher Class"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ms741870.aspx">http://msdn.microsoft.com/en-us/library/ms741870.aspx</a> <br> <a href="http://msdn.microsoft.com/en-us/library/ms615907(v%3DVS.95).aspx">http://msdn.microsoft.com/en-us/library/ms615907(v=VS.95).aspx</a> . <br> <br>      unit-  Silverlight, ."Unit Testing with Silverlight 2": <a href="http://www.jeff.wilcox.name/2008/03/silverlight2-unit-testing/">http://www.jeff.wilcox.name/2008/03/silverlight2-unit-testing/</a> . <br> <br>         , .  " <a href="http://msdn.microsoft.com/en-us/library/gg430861(v%3DPandP.40).aspx">View-Based Navigation</a> " in Chapter 8, " <a href="http://msdn.microsoft.com/en-us/library/gg430861(v%3DPandP.40).aspx">Navigation</a> ." <br> <br>       ,   , ."Event-based Asynchronous Pattern Overview"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/wewwczdw.aspx">http://msdn.microsoft.com/en-us/library/wewwczdw.aspx</a> <br> <br>        <code>IAsyncResult</code> , ."Asynchronous Programming Overview"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ms228963.aspx">http://msdn.microsoft.com/en-us/library/ms228963.aspx</a></code></code></code></code></code></code></code></code></code> </h3> <code><code><code><code><code><code><code><code><code><code>CommandBehaviorBase ,    ,    ICommand</code> .           <code>CanExecuteChanged</code> ,          Silverlight,    WPF. <br> <br>    ,  ,   <code>CommandBehaviorBase    ,    .         ,      .         ,    .      ButtonBaseClickCommandBehavior</code> . <br> <br> <code class="cs">public class ButtonBaseClickCommandBehavior : CommandBehaviorBase&lt;ButtonBase&gt; { public ButtonBaseClickCommandBehavior(ButtonBase clickableObject) : base(clickableObject) { clickableObject.Click += OnClick; } private void OnClick(object sender, System.Windows.RoutedEventArgs e) { ExecuteCommand(); } }</code> <br>   <code>CommandBehaviorBase ,     .     ,          ,   . ,    ,    ,      , ,    CanExecute</code>  ,     . <br> <br>          ,   .           XAML.           .       .  Prism      ,       ,  ,   .       ,    . , ,  ,      <code>Click</code> ,       <code>Command</code> .    <code>Click.Command</code> ,  . <br> <br>             .             . <br> <br> <code class="cs">public static readonly DependencyProperty CommandProperty = DependencyProperty.RegisterAttached( "Command", typeof(ICommand), typeof(Click), new PropertyMetadata(OnSetCommandCallback)); private static readonly DependencyProperty ClickCommandBehaviorProperty = DependencyProperty.RegisterAttached( "ClickCommandBehavior", typeof(ButtonBaseClickCommandBehavior), typeof(Click), null);</code> <br>    <code>Command</code>    <code>ButtonBaseClickCommandBehavior</code> ,     <code>OnSetCommandCallback</code> ,     . <br> <br> <code class="cs">private static void OnSetCommandCallback(DependencyObject dependencyObject, DependencyPropertyChangedEventArgs e) { ButtonBase buttonBase = dependencyObject as ButtonBase; if (buttonBase != null) { ButtonBaseClickCommandBehavior behavior = GetOrCreateBehavior(buttonBase); behavior.Command = e.NewValue as ICommand; } } private static void OnSetCommandParameterCallback(DependencyObject dependencyObject, DependencyPropertyChangedEventArgs e) { ButtonBase buttonBase = dependencyObject as ButtonBase; if (buttonBase != null) { ButtonBaseClickCommandBehavior behavior = GetOrCreateBehavior(buttonBase); behavior.CommandParameter = e.NewValue; } } private static ButtonBaseClickCommandBehavior GetOrCreateBehavior(ButtonBase buttonBase ) { ButtonBaseClickCommandBehavior behavior = buttonBase.GetValue(ClickCommandBehaviorProperty) as ButtonBaseClickCommandBehavior; if ( behavior == null ) { behavior = new ButtonBaseClickCommandBehavior(buttonBase); buttonBase.SetValue(ClickCommandBehaviorProperty, behavior); } return behavior; }</code> <br>        ,  <a href="http://msdn.microsoft.com/en-us/library/cc265152(VS.95).aspx">Attached Properties Overview</a>  MSDN. <br> <br>    <br>              . ,     Silverlight,    -,     ,      ,     .     ,       . <br> <br>        ,    ( )  ,  ,     .  UI       ,            UI. <br> <br>      - <br>   -     ,       <code>IAsyncResult</code> .   ,  ,   ,  <code>GetQuestionnaire</code> ,   : <code>BeginGetQuestionnaire</code>  <code>EndGetQuestionnaire</code> .    ,   <code>BeginGetQuestionnaire</code> .     ,   ,   <code>EndGetQuestionnaire</code>    . <br> <b></b> <br>  .NET Framework 4.5      <code>await</code>  <code>async</code>     <code>*Async</code> .      <a href="http://msdn.microsoft.com/en-us/library/vstudio/hh391443.aspx">"Asynchronous Programming with Async and Await (C# and Visual Basic)"</a> . <br>  ,    <code>EndGetQuestionnaire</code> ,      ,  ()      <code>BeginGetQuestionnaire</code> .     ,      ,   <code>EndGetQuestionnaire</code> ,   . <br> <br> <code class="xml">IAsyncResult asyncResult = this.service.BeginGetQuestionnaire( GetQuestionnaireCompleted, null //  ,      ); private void GetQuestionnaireCompleted(IAsyncResult result) { try { questionnaire = this.service.EndGetQuestionnaire(ar); } catch (Exception ex) { //  -   . } }</code> <br>  ,     <code>End*</code> (  , <code>EndGetQuestionnaire</code> ),    ,      .      , ,          UI.     ,   ,        . <br> <br>        UI,     -,      UI,         UI,   <code>Dispatcher</code>    <code>SynchronizationContext</code> .  WPF  Silverlight,   <code>Dispatcher</code> . <br> <br>      <code>Questionnaire</code>  ,        <code>QuestionnaireView</code> .  Silverlight    <code>CheckAccess</code> ,  ,      UI.  ,     <code>BeginInvoke</code> ,      UI. <br> <br> <code class="cs">var dispatcher = System.Windows.Deployment.Current.Dispatcher; if (dispatcher.CheckAccess()) { QuestionnaireView.DataContext = questionnaire; } else { dispatcher.BeginInvoke(() =&gt; { Questionnaire.DataContext = questionnaire; }); }</code> <br> <i>MVVM RI</i>   ,    ,   <code>IAsyncResult</code> ,   .      ,                 . ,       . <br> <br> <code class="cs">this.questionnaireRepository.GetQuestionnaireAsync( result =&gt; { this.Questionnaire = result.Result; });</code> <br>  <code>result</code>   ,     , , , .    ,     . <br> <br> <code class="cs">this.questionnaireRepository.GetQuestionnaireAsync( result =&gt; { if (result.Error == null) { this.Questionnaire = result.Result; ... } else { // Handle error. } })</code> <br>     <br>        ,      .     , ,             .        ,      ,     ,     . <br> <br>         ,      MVVM,     ,   . ,  -MVVM ,     <code>MessageBox</code>   code-behind UI,      .   MVVM     ,          . <br> <br>     MVVM,              ,          .      ,    ,   ,  ,     . <br> <br>              MVVM.      ,     ,     ,  ,     .    ,         ,     ,          .       . <br> <br>    <br>                  .        ,        .  ,         .         . <br> <br>  ,         ,         ,  .      ,     .           ,       . ,        WPF  Silverlight,        . <br> <br> <img title="Using the service to interact with the user." src="https://habrastorage.org/getpro/habr/post_images/4b5/397/f2d/4b5397f2d02e5851195b29f1893be6fc.png" alt=" ,    ."> <br> <br>  ,   <code>MessageBox</code>        ,     ,    ,     . <br> <br> <code class="cs">var result = interactionService.ShowMessageBox( "Are you sure you want to cancel this operation?", "Confirm", MessageBoxButton.OK); if (result == MessageBoxResult.Yes) { CancelRequest(); }</code> <br> ,      - ,      ,         Silverlight.         .             .     . <br> <br> <code class="cs">interactionService.ShowMessageBox( "Are you sure you want to cancel this operation?", "Confirm", MessageBoxButton.OK, result =&gt; { if (result == MessageBoxResult.Yes) { CancelRequest(); } });</code> <br>         ,      . ,  WPF    <code>MessageBox</code> ,       ;    Silverlight    ,    . <br> <br>     <br>         ‚Äì             .         ,      .     ,     .        ,        ,   ,     . <br> <br> <img title="Using interaction request objects." src="https://habrastorage.org/getpro/habr/post_images/3d0/ff0/1c5/3d0ff01c5518558c2d3c5c5f47ce0ce9.png" alt="   ."> <br> <br>    ,   ,          ‚Äì       ,      ,   ‚Äì     .   ,        ,    ,    UI            . <br> <br>       MVVM,     ,       ,         .         ,        ,    ,   . <br> <br>  Prism       <code>IInteractionRequest</code>   <code>InteractionRequest .  IInteractionRequest</code>  ,   .           ,   .  <code>InteractionRequest   IInteractionRequest</code>     <code>Raise</code> ,           , , ,   . <br> <br>       <br>  <code>InteractionRequest          .  Raise</code>          ( <code>T</code> )    ,    ,   .          ,       .      ,        .    ,  ,     . <br> <code class="cs">public interface IInteractionRequest { event EventHandler&lt;InteractionRequestedEventArgs&gt; Raised; } public class InteractionRequest&lt;T&gt; : IInteractionRequest { public event EventHandler&lt;InteractionRequestedEventArgs&gt; Raised; public void Raise(T context, Action&lt;T&gt; callback) { var handler = this.Raised; if (handler != null) { handler( this, new InteractionRequestedEventArgs(context, () =&gt; callback(context))); } } }</code> <br> Prism    ,      .  <code>Notification</code>       .    ,            .     ‚Äì <code>Title</code>  <code>Content</code> ,    .  ,   ,  ,  ,        . <br> <br>  <code>Confirmation</code>    <code>Notification</code>     ‚Äì <code>Confirmed</code> ,  ,  ,      .  <code>Confirmation</code> ,     <code>MessageBox</code> ,     /  .     ,     <code>Notification</code> ,     ,      . <br> <br>    <code>InteractionRequest ,       InteractionRequest      ,      .      ,    Raise</code> ,    , ,   . <br> <br> <code class="cs">public IInteractionRequest ConfirmCancelInteractionRequest { get { return this.confirmCancelInteractionRequest; } } this.confirmCancelInteractionRequest.Raise( new Confirmation("Are you sure you wish to cancel?"), confirmation =&gt; { if (confirmation.Confirmed) { this.NavigateToQuestionnaireList(); } }); }</code> <br> <i>MVVM Reference Implementation (MVVM RI)</i> ,    <code>IInteractionRequest</code>   <code>InteractionRequest ,          (. QuestionnaireViewModel.cs</code> ). <br> <br>        <br>       ,       .   ,       .    UI             . <br> <br>                . Microsoft Expression Blend Behaviors Framework     .  ,     ,    . <br> <br>  <code>EventTrigger</code> ,  Expression Blend,  ,      ,     ,   . , Prism   <code>EventTrigger</code> ,  <code>InteractionRequestTrigger</code> ,      <code>Raised</code>   <code>IInteractionRequest</code> .    XAML        . <br> <br>  ,   , <code>InteractionRequestTrigger</code>   .  Silverlight Prism   <code>PopupChildWindowAction</code> ,     .    ,         .   <code>ContentTemplate</code>  <code>PopupChildWindowAction</code> ,    ,    UI,      <code>Content</code>  .       <code>Title</code>  . <br> <b></b> <br>  ,    ,   <code>PopupChildWindowAction</code> ,     .    <code>Notification</code>  <code>NotificationChildWindow</code> ,        <code>Confirmation</code> ‚Äì <code>ConfirmationChildWindow</code> . <code>NotificationChildWindow</code>    ,   ,     <code>ConfirmationChildWindow</code>    <i>OK</i>  <i>Cancel</i> ,    .    ,   ,   <code>ChildWindow</code>  <code>PopupChildWindowAction</code> . <br>   ,  <code>InteractionRequestTrigger</code>  <code>PopupChildWindowAction</code> ,       <i>RI MVVM</i> . <br> <br> <code class="xml">&lt;i:Interaction.Triggers&gt; &lt;prism:InteractionRequestTrigger SourceObject="{Binding ConfirmCancelInteractionRequest}"&gt; &lt;prism:PopupChildWindowAction ContentTemplate="{StaticResource ConfirmWindowTemplate}"/&gt; &lt;/prism:InteractionRequestTrigger&gt; &lt;/i:Interaction.Triggers&gt; &lt;UserControl.Resources&gt; &lt;DataTemplate x:Key="ConfirmWindowTemplate"&gt; &lt;Grid MinWidth="250" MinHeight="100"&gt; &lt;TextBlock TextWrapping="Wrap" Grid.Row="0" Text="{Binding}"/&gt; &lt;/Grid&gt; &lt;/DataTemplate&gt; &lt;/UserControl.Resources&gt;</code> <br> <b></b> <br>      <code>ContentTemplate</code> ,   UI   <code>Content</code>  .    <code>Content</code>  ,  , <code>TextBlock</code>     <code>Content</code> . <br>      ,     ,    ,    .  ,     ,       ,     ,    .   ,   <i>RI MVVM</i> ,         <code>Confirmed</code>    <code>Confirmation</code>  <code>true</code> ,     OK. <br> <br>        ,     .  Prism <code>InteractionRequestTrigger</code>   <code>PopupChildWindowAction</code>            . <br> <br>     <br>     MVVM,       , ,    ,         .        (  , ,  ,   ).    ,  ,  ,            . <br> <br>        ,         . Managed Extensibility Framework (MEF)  Unity Application Block (Unity)      ,  ,           . <br> <br>  ,       , , ,    ( )      . ,       ,     .  ,     ,       . <br> <br>     ,  MEF <br>  MEF,       ,   <code>Import</code> ,      ,  ,   <code>Export</code> .         ,    . <br> <br> , <code>QuestionnaireView</code>   <i>RI MVVM</i> ,        ,    <code>Import</code> .   , MEF           .  <code>set</code>        ,   . <br> <br> <code class="cs">[Import] public QuestionnaireViewModel ViewModel { set { this.DataContext = value; } }</code> <br>     ,   . <br> <br> <code class="cs">[Export] public class QuestionnaireViewModel : NotificationObject { ... }</code> <br>        ,   . <br> <br> <code class="cs">public QuestionnaireView() { InitializeComponent(); } [ImportingConstructor] public QuestionnaireView(QuestionnaireViewModel viewModel) : this() { this.DataContext = viewModel; }</code> <br> <b></b> <br>          MEF,   Unity.   ,     ,        .   ,   Visual Studio  Expression Blend, ,        ,     .   ,   ,  ,      ,          <code>InitializeComponent</code> . <br>     ,  Unity <br>  Unity,    ,   MEF.     ,      .    ,         .  ,      . <br> <br>  ,      ,  ,         . ,           ,   . <br> <br> <code class="cs">public QuestionnaireView() { InitializeComponent(); } public QuestionnaireView(QuestionnaireViewModel viewModel) : this() { this.DataContext = viewModel; }</code> <br> <b></b> <br>    ,        ,   Visual Studio  Expression Blend. <br>  ,          ,   . Unity        <code>set</code>   ,   . <br> <br> <code class="cs">public QuestionnaireView() { InitializeComponent(); } [Dependency] public QuestionnaireViewModel ViewModel { set { this.DataContext = value; } }</code> <br>       Unity. <br> <br> <code class="cs">container.RegisterType&lt;QuestionnaireViewModel&gt;();</code> <br>  ,     . <br> <br> <code class="cs">var view = container.Resolve&lt;QuestionnaireView&gt;();</code> <br>     ,    <br>   ,     ,        .        ,   MEF  Unity,        . <br> <br>          .   ,         UI,           . <br> <br> , <i>RI MVVM</i>   ,   ,        .   ,    .      <code>ShowView</code>   UI. <br> <br> <code class="cs">private void NavigateToQuestionnaireList() { //     "questionnaire list". this.uiService.ShowView(ViewNames.QuestionnaireTemplatesList); }</code> <br>  UI      UI .           UI.  <code>ShowView</code>  <code>UIService</code>      (,          ),       ,   . <br> <br> <code class="cs">public void ShowView(string viewName) { var view = this.ViewFactory.GetView(viewName); this.MainWindow.CurrentView = view; }</code> <br> <b></b> <br> Prism       .   ,   ,   ,             .    ,  , " <a href="http://msdn.microsoft.com/en-us/library/gg430861(v%3DPandP.40).aspx">View-Based Navigation</a> "   8, " <a href="http://msdn.microsoft.com/en-us/library/gg430861(v%3DPandP.40).aspx">Navigation</a> ". <br>  MVVM  <br>        MVVM      .           -      mocking . ,   ,        . <br> <br>   <i>INotifyPropertyChanged</i> <br>   <code>INotifyPropertyChanged</code>     ,      .      ,    ;   ,   ,     ,    ,       . <br> <br>   <br> ,       ,           <code>PropertyChanged</code>  ,         .  ,    <code>ChangeTracker</code> ,     MVVM,  ,      .      .     ,    . <br> <br> <code class="cs">var changeTracker = new PropertyChangeTracker(viewModel); viewModel.CurrentState = "newState"; CollectionAssert.Contains(changeTracker.ChangedProperties, "CurrentState");</code> <br> ,     ,     <code>INotifyPropertyChanged</code> ,    ,   ,     . <br> <br>      <br>        ,   ,    <code>set</code>      ,           . ,     ,     ,      ,          . <br> <br> <code class="cs">var changeTracker = new PropertyChangeTracker(viewModel); var question = viewModel.Questions.First() as OpenQuestionViewModel; question.Question.Response = "some text"; CollectionAssert.Contains(changeTracker.ChangedProperties, "UnansweredQuestions");</code> <br>      <br>     <code>INotifyPropertyChanged</code> ,      <code>PropertyChanged</code>        ,  ,     , , .        ,       . <br> <br>   <i>INotifyDataErrorInfo</i> <br>   ,     ,    ,   ,   <code>IDataErrorInfo</code> ,  ( Silverlight)   <code>INotifyDataErrorInfo</code> .   <code>INotifyDataErrorInfo</code>   ,         ,    ,  ,   ,    . <br> <br>       <code>INotifyDataErrorInfo</code> : ,     ,  ,     ,     <code>ErrorsChanged</code> ,      <code>GetErrors</code> , . <br> <br>    <br>     ,      ,     .       ,         <code>GetErrors</code>       ,  ,  ,   .    , ,  ,     ,        .   ,        . <br> <br> <code class="cs">//  . var notifyErrorInfo = (INotifyDataErrorInfo)question; question.Response = -15; Assert.IsTrue(notifyErrorInfo.GetErrors("Response").Cast&lt;ValidationResult&gt;().Any()); //  . var notifyErrorInfo = (INotifyDataErrorInfo)question; question.Response = 15; Assert.IsFalse(notifyErrorInfo.GetErrors("Response").Cast&lt;ValidationResult&gt;().Any());</code> <br>    ,    ,             . <br> <br>    <i>INotifyDataErrorInfo</i> <br>       <code>GetErrors</code> ,   <code>INotifyDataErrorInfo</code>  ,   <code>ErrorsChanged</code>      <code>GetErrors</code> . ,  <code>HasErrors</code>      ,  . <br> <br>       <code>INotifyDataErrorInfo</code> . , ,           ,   -  .      ,        <code>INotifyDataErrorInfo</code>         (,        ). <br> <br>     ,   ,  : <br>  <code>HasErrors</code>     .              ,       .  <code>ErrorsChanged</code> ,      ,         <code>GetErrors</code> .         ( ,  )     ,           .    <code>GetErrors</code>       <code>ErrorsChanged</code> . <br>    <code>INotifyPropertyChanged</code> ,  ,    <code>NotifyDataErrorInfoTestHelper</code>    MVVM,        <code>INotifyDataErrorInfo</code> ,       .   ,   ,      ,   .      . <br> <code class="cs">var helper = new NotifyDataErrorInfoTestHelper&lt;NumericQuestion, int?&gt;( question, q =&gt; q.Response); helper.ValidatePropertyChange( 6, NotifyDataErrorInfoBehavior.Nothing); helper.ValidatePropertyChange( 20, NotifyDataErrorInfoBehavior.FiresErrorsChanged | NotifyDataErrorInfoBehavior.HasErrors | NotifyDataErrorInfoBehavior.HasErrorsForProperty); helper.ValidatePropertyChange( null, NotifyDataErrorInfoBehavior.FiresErrorsChanged | NotifyDataErrorInfoBehavior.HasErrors | NotifyDataErrorInfoBehavior.HasErrorsForProperty); helper.ValidatePropertyChange( 2, NotifyDataErrorInfoBehavior.FiresErrorsChanged);</code> <br>     <br>   MVVM,     ,  .   ,    ,         . <br> <br>  ,     ,     ,       .   ,   , ,       ,     ,   <code>IAsyncResult</code>    ,  - ,   ,    UI. <br> <br>       , , ,    .   ,     .  ,      UI,     ,   ,          ,     ,        "   UI." <br> <br>     ,    ,    .   ,    ,     mock-, ,   ,   ,      ,          . <br> <br>           UI,    ,    .   ,     ,   ,      .        ,   .     ,    ,     . <br> <br> <code class="cs">questionnaireRepositoryMock .Setup( r =&gt; r.SubmitQuestionnaireAsync( It.IsAny&lt;Questionnaire&gt;(), It.IsAny&lt;Action&lt;IOperationResult&gt;&gt;())) .Callback&lt;Questionnaire, Action&lt;IOperationResult&gt;&gt;( (q, a) =&gt; callback = a); uiServicemock .Setup(svc =&gt; svc.ShowView(ViewNames.QuestionnaireTemplatesList)) .Callback&lt;string&gt;(viewName =&gt; requestedViewName = viewName); submitResultMock .Setup(sr =&gt; sr.Error) .Returns&lt;Exception&gt;(null); CompleteQuestionnaire(viewModel); viewModel.Submit(); //      UI . callback(submitResultMock.Object); //    ‚Äì     . Assert.AreEqual(ViewNames.QuestionnaireTemplatesList, requestedViewName);</code> <br> <b></b> <br>          ,        . <br>   <br>       , . "Trees in WPF"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ms753391.aspx">http://msdn.microsoft.com/en-us/library/ms753391.aspx</a> <br> <br>       , . "Attached Properties Overview"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/cc265152(VS.95).aspx">http://msdn.microsoft.com/en-us/library/cc265152(VS.95).aspx</a> <br> <br>      MEF, ."Managed Extensibility Framework Overview"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/dd460648.aspx">http://msdn.microsoft.com/en-us/library/dd460648.aspx</a> . <br> <br>      Unity, ."Unity Application Block"  MSDN: <a href="http://www.msdn.com/unity">http://www.msdn.com/unity</a> . <br> <br>      <code>DelegateCommand</code> , .Chapter 5, " <a href="http://msdn.microsoft.com/en-us/library/gg405484(v%3DPandP.40).aspx">Implementing the MVVM Pattern</a> ." <br> <br>        Microsoft Expression Blend, ."Working with built-in behaviors"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ff724013(v%3DExpression.40).aspx">http://msdn.microsoft.com/en-us/library/ff724013(v=Expression.40).aspx</a> . <br> <br>          Microsoft Expression Blend, ."Creating Custom Behaviors"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ff724708(v%3DExpression.40).aspx">http://msdn.microsoft.com/en-us/library/ff724708(v=Expression.40).aspx</a> . <br> <br>            Microsoft Expression Blend, ."Creating Custom Triggers and Actions"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ff724707(v%3DExpression.40).aspx">http://msdn.microsoft.com/en-us/library/ff724707(v=Expression.40).aspx</a> . <br> <br>         WPF  Silverlight, ."Threading Model"  "The Dispatcher Class"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ms741870.aspx">http://msdn.microsoft.com/en-us/library/ms741870.aspx</a> <br> <a href="http://msdn.microsoft.com/en-us/library/ms615907(v%3DVS.95).aspx">http://msdn.microsoft.com/en-us/library/ms615907(v=VS.95).aspx</a> . <br> <br>      unit-  Silverlight, ."Unit Testing with Silverlight 2": <a href="http://www.jeff.wilcox.name/2008/03/silverlight2-unit-testing/">http://www.jeff.wilcox.name/2008/03/silverlight2-unit-testing/</a> . <br> <br>         , .  " <a href="http://msdn.microsoft.com/en-us/library/gg430861(v%3DPandP.40).aspx">View-Based Navigation</a> " in Chapter 8, " <a href="http://msdn.microsoft.com/en-us/library/gg430861(v%3DPandP.40).aspx">Navigation</a> ." <br> <br>       ,   , ."Event-based Asynchronous Pattern Overview"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/wewwczdw.aspx">http://msdn.microsoft.com/en-us/library/wewwczdw.aspx</a> <br> <br>        <code>IAsyncResult</code> , ."Asynchronous Programming Overview"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ms228963.aspx">http://msdn.microsoft.com/en-us/library/ms228963.aspx</a></code></code></code></code></code></code></code></code></code> <pre> <code class="hljs cmake"><code>CommandBehaviorBase ,    ,    ICommand</code> .           <code>CanExecuteChanged</code> ,          Silverlight,    WPF. <br> <br>    ,  ,   <code><code>CommandBehaviorBase    ,    .         ,      .         ,    .      ButtonBaseClickCommandBehavior</code> . <br> <br> <code class="cs">public class ButtonBaseClickCommandBehavior : CommandBehaviorBase&lt;ButtonBase&gt; { public ButtonBaseClickCommandBehavior(ButtonBase clickableObject) : base(clickableObject) { clickableObject.Click += OnClick; } private void OnClick(object sender, System.Windows.RoutedEventArgs e) { ExecuteCommand(); } }</code> <br>   <code><code>CommandBehaviorBase ,     .     ,          ,   . ,    ,    ,      , ,    CanExecute</code>  ,     . <br> <br>          ,   .           XAML.           .       .  Prism      ,       ,  ,   .       ,    . , ,  ,      <code>Click</code> ,       <code><span class="hljs-keyword"><span class="hljs-keyword">Command</span></span></code> .    <code>Click.<span class="hljs-keyword"><span class="hljs-keyword">Command</span></span></code> ,  . <br> <br>             .             . <br> <br> <code class="cs">public static readonly DependencyProperty CommandProperty = DependencyProperty.RegisterAttached( <span class="hljs-string"><span class="hljs-string">"Command"</span></span>, typeof(ICommand), typeof(Click), new PropertyMetadata(OnSetCommandCallback)); private static readonly DependencyProperty ClickCommandBehaviorProperty = DependencyProperty.RegisterAttached( <span class="hljs-string"><span class="hljs-string">"ClickCommandBehavior"</span></span>, typeof(ButtonBaseClickCommandBehavior), typeof(Click), null);</code> <br>    <code><span class="hljs-keyword"><span class="hljs-keyword">Command</span></span></code>    <code>ButtonBaseClickCommandBehavior</code> ,     <code>OnSetCommandCallback</code> ,     . <br> <br> <code class="cs">private static void OnSetCommandCallback(DependencyObject dependencyObject, DependencyPropertyChangedEventArgs e) { ButtonBase buttonBase = dependencyObject as ButtonBase; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (buttonBase != null) { ButtonBaseClickCommandBehavior behavior = GetOrCreateBehavior(buttonBase); behavior.<span class="hljs-keyword"><span class="hljs-keyword">Command</span></span> = e.NewValue as ICommand; } } private static void OnSetCommandParameterCallback(DependencyObject dependencyObject, DependencyPropertyChangedEventArgs e) { ButtonBase buttonBase = dependencyObject as ButtonBase; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (buttonBase != null) { ButtonBaseClickCommandBehavior behavior = GetOrCreateBehavior(buttonBase); behavior.CommandParameter = e.NewValue; } } private static ButtonBaseClickCommandBehavior GetOrCreateBehavior(ButtonBase buttonBase ) { ButtonBaseClickCommandBehavior behavior = buttonBase.GetValue(ClickCommandBehaviorProperty) as ButtonBaseClickCommandBehavior; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ( behavior == null ) { behavior = new ButtonBaseClickCommandBehavior(buttonBase); buttonBase.SetValue(ClickCommandBehaviorProperty, behavior); } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> behavior; }</code> <br>        ,  <a href="http://msdn.microsoft.com/en-us/library/cc265152(VS.95).aspx">Attached Properties Overview</a>  MSDN. <br> <br>    <br>              . ,     Silverlight,    -,     ,      ,     .     ,       . <br> <br>        ,    ( )  ,  ,     .  UI       ,            UI. <br> <br>      - <br>   -     ,       <code>IAsyncResult</code> .   ,  ,   ,  <code>GetQuestionnaire</code> ,   : <code>BeginGetQuestionnaire</code>  <code>EndGetQuestionnaire</code> .    ,   <code>BeginGetQuestionnaire</code> .     ,   ,   <code>EndGetQuestionnaire</code>    . <br> <b></b> <br>  .NET Framework <span class="hljs-number"><span class="hljs-number">4.5</span></span>      <code>await</code>  <code>async</code>     <code>*Async</code> .      <a href="http://msdn.microsoft.com/en-us/library/vstudio/hh391443.aspx"><span class="hljs-string"><span class="hljs-string">"Asynchronous Programming with Async and Await (C# and Visual Basic)"</span></span></a> . <br>  ,    <code>EndGetQuestionnaire</code> ,      ,  ()      <code>BeginGetQuestionnaire</code> .     ,      ,   <code>EndGetQuestionnaire</code> ,   . <br> <br> <code class="xml">IAsyncResult asyncResult = this.service.BeginGetQuestionnaire( GetQuestionnaireCompleted, null //  ,      ); private void GetQuestionnaireCompleted(IAsyncResult result) { try { questionnaire = this.service.EndGetQuestionnaire(ar); } catch (Exception ex) { //  -   . } }</code> <br>  ,     <code>End*</code> (  , <code>EndGetQuestionnaire</code> ),    ,      .      , ,          UI.     ,   ,        . <br> <br>        UI,     -,      UI,         UI,   <code>Dispatcher</code>    <code>SynchronizationContext</code> .  WPF  Silverlight,   <code>Dispatcher</code> . <br> <br>      <code>Questionnaire</code>  ,        <code>QuestionnaireView</code> .  Silverlight    <code>CheckAccess</code> ,  ,      UI.  ,     <code>BeginInvoke</code> ,      UI. <br> <br> <code class="cs">var dispatcher = System.Windows.Deployment.Current.Dispatcher; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (dispatcher.CheckAccess()) { QuestionnaireView.DataContext = questionnaire; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { dispatcher.BeginInvoke(() =&gt; { Questionnaire.DataContext = questionnaire; }); }</code> <br> <i>MVVM RI</i>   ,    ,   <code>IAsyncResult</code> ,   .      ,                 . ,       . <br> <br> <code class="cs">this.questionnaireRepository.GetQuestionnaireAsync( result =&gt; { this.Questionnaire = result.Result; });</code> <br>  <code>result</code>   ,     , , , .    ,     . <br> <br> <code class="cs">this.questionnaireRepository.GetQuestionnaireAsync( result =&gt; { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (result.Error == null) { this.Questionnaire = result.Result; ... } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { // Handle error. } })</code> <br>     <br>        ,      .     , ,             .        ,      ,     ,     . <br> <br>         ,      MVVM,     ,   . ,  -MVVM ,     <code>MessageBox</code>   code-behind UI,      .   MVVM     ,          . <br> <br>     MVVM,              ,          .      ,    ,   ,  ,     . <br> <br>              MVVM.      ,     ,     ,  ,     .    ,         ,     ,          .       . <br> <br>    <br>                  .        ,        .  ,         .         . <br> <br>  ,         ,         ,  .      ,     .           ,       . ,        WPF  Silverlight,        . <br> <br> <img title="Using the service to interact with the user." src="https://habrastorage.org/getpro/habr/post_images/4b5/397/f2d/4b5397f2d02e5851195b29f1893be6fc.png" alt=" ,    ."> <br> <br>  ,   <code>MessageBox</code>        ,     ,    ,     . <br> <br> <code class="cs">var result = interactionService.ShowMessageBox( <span class="hljs-string"><span class="hljs-string">"Are you sure you want to cancel this operation?"</span></span>, <span class="hljs-string"><span class="hljs-string">"Confirm"</span></span>, MessageBoxButton.OK); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (result == MessageBoxResult.Yes) { CancelRequest(); }</code> <br> ,      - ,      ,         Silverlight.         .             .     . <br> <br> <code class="cs">interactionService.ShowMessageBox( <span class="hljs-string"><span class="hljs-string">"Are you sure you want to cancel this operation?"</span></span>, <span class="hljs-string"><span class="hljs-string">"Confirm"</span></span>, MessageBoxButton.OK, result =&gt; { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (result == MessageBoxResult.Yes) { CancelRequest(); } });</code> <br>         ,      . ,  WPF    <code>MessageBox</code> ,       ;    Silverlight    ,    . <br> <br>     <br>         ‚Äì             .         ,      .     ,     .        ,        ,   ,     . <br> <br> <img title="Using interaction request objects." src="https://habrastorage.org/getpro/habr/post_images/3d0/ff0/1c5/3d0ff01c5518558c2d3c5c5f47ce0ce9.png" alt="   ."> <br> <br>    ,   ,          ‚Äì       ,      ,   ‚Äì     .   ,        ,    ,    UI            . <br> <br>       MVVM,     ,       ,         .         ,        ,    ,   . <br> <br>  Prism       <code>IInteractionRequest</code>   <code><code>InteractionRequest .  IInteractionRequest</code>  ,   .           ,   .  <code><code>InteractionRequest   IInteractionRequest</code>     <code>Raise</code> ,           , , ,   . <br> <br>       <br>  <code><code>InteractionRequest          .  Raise</code>          ( <code>T</code> )    ,    ,   .          ,       .      ,        .    ,  ,     . <br> <code class="cs">public interface IInteractionRequest { event EventHandler&lt;InteractionRequestedEventArgs&gt; Raised; } public class InteractionRequest&lt;T&gt; : IInteractionRequest { public event EventHandler&lt;InteractionRequestedEventArgs&gt; Raised; public void Raise(T context, Action&lt;T&gt; callback) { var handler = this.Raised; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (handler != null) { handler( this, new InteractionRequestedEventArgs(context, () =&gt; callback(context))); } } }</code> <br> Prism    ,      .  <code>Notification</code>       .    ,            .     ‚Äì <code>Title</code>  <code>Content</code> ,    .  ,   ,  ,  ,        . <br> <br>  <code>Confirmation</code>    <code>Notification</code>     ‚Äì <code>Confirmed</code> ,  ,  ,      .  <code>Confirmation</code> ,     <code>MessageBox</code> ,     /  .     ,     <code>Notification</code> ,     ,      . <br> <br>    <code><code><code>InteractionRequest ,       InteractionRequest      ,      .      ,    Raise</code> ,    , ,   . <br> <br> <code class="cs">public IInteractionRequest ConfirmCancelInteractionRequest { get { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> this.confirmCancelInteractionRequest; } } this.confirmCancelInteractionRequest.Raise( new Confirmation(<span class="hljs-string"><span class="hljs-string">"Are you sure you wish to cancel?"</span></span>), confirmation =&gt; { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (confirmation.Confirmed) { this.NavigateToQuestionnaireList(); } }); }</code> <br> <i>MVVM Reference Implementation (MVVM RI)</i> ,    <code>IInteractionRequest</code>   <code><code>InteractionRequest ,          (. QuestionnaireViewModel.cs</code> ). <br> <br>        <br>       ,       .   ,       .    UI             . <br> <br>                . Microsoft Expression Blend Behaviors Framework     .  ,     ,    . <br> <br>  <code>EventTrigger</code> ,  Expression Blend,  ,      ,     ,   . , Prism   <code>EventTrigger</code> ,  <code>InteractionRequestTrigger</code> ,      <code>Raised</code>   <code>IInteractionRequest</code> .    XAML        . <br> <br>  ,   , <code>InteractionRequestTrigger</code>   .  Silverlight Prism   <code>PopupChildWindowAction</code> ,     .    ,         .   <code>ContentTemplate</code>  <code>PopupChildWindowAction</code> ,    ,    UI,      <code>Content</code>  .       <code>Title</code>  . <br> <b></b> <br>  ,    ,   <code>PopupChildWindowAction</code> ,     .    <code>Notification</code>  <code>NotificationChildWindow</code> ,        <code>Confirmation</code> ‚Äì <code>ConfirmationChildWindow</code> . <code>NotificationChildWindow</code>    ,   ,     <code>ConfirmationChildWindow</code>    <i>OK</i>  <i>Cancel</i> ,    .    ,   ,   <code>ChildWindow</code>  <code>PopupChildWindowAction</code> . <br>   ,  <code>InteractionRequestTrigger</code>  <code>PopupChildWindowAction</code> ,       <i>RI MVVM</i> . <br> <br> <code class="xml">&lt;i:Interaction.Triggers&gt; &lt;prism:InteractionRequestTrigger SourceObject=<span class="hljs-string"><span class="hljs-string">"{Binding ConfirmCancelInteractionRequest}"</span></span>&gt; &lt;prism:PopupChildWindowAction ContentTemplate=<span class="hljs-string"><span class="hljs-string">"{StaticResource ConfirmWindowTemplate}"</span></span>/&gt; &lt;/prism:InteractionRequestTrigger&gt; &lt;/i:Interaction.Triggers&gt; &lt;UserControl.Resources&gt; &lt;DataTemplate x:Key=<span class="hljs-string"><span class="hljs-string">"ConfirmWindowTemplate"</span></span>&gt; &lt;Grid MinWidth=<span class="hljs-string"><span class="hljs-string">"250"</span></span> MinHeight=<span class="hljs-string"><span class="hljs-string">"100"</span></span>&gt; &lt;TextBlock TextWrapping=<span class="hljs-string"><span class="hljs-string">"Wrap"</span></span> Grid.Row=<span class="hljs-string"><span class="hljs-string">"0"</span></span> Text=<span class="hljs-string"><span class="hljs-string">"{Binding}"</span></span>/&gt; &lt;/Grid&gt; &lt;/DataTemplate&gt; &lt;/UserControl.Resources&gt;</code> <br> <b></b> <br>      <code>ContentTemplate</code> ,   UI   <code>Content</code>  .    <code>Content</code>  ,  , <code>TextBlock</code>     <code>Content</code> . <br>      ,     ,    ,    .  ,     ,       ,     ,    .   ,   <i>RI MVVM</i> ,         <code>Confirmed</code>    <code>Confirmation</code>  <code><span class="hljs-keyword"><span class="hljs-keyword">true</span></span></code> ,     OK. <br> <br>        ,     .  Prism <code>InteractionRequestTrigger</code>   <code>PopupChildWindowAction</code>            . <br> <br>     <br>     MVVM,       , ,    ,         .        (  , ,  ,   ).    ,  ,  ,            . <br> <br>        ,         . Managed Extensibility Framework (MEF)  Unity Application Block (Unity)      ,  ,           . <br> <br>  ,       , , ,    ( )      . ,       ,     .  ,     ,       . <br> <br>     ,  MEF <br>  MEF,       ,   <code>Import</code> ,      ,  ,   <code><span class="hljs-keyword"><span class="hljs-keyword">Export</span></span></code> .         ,    . <br> <br> , <code>QuestionnaireView</code>   <i>RI MVVM</i> ,        ,    <code>Import</code> .   , MEF           .  <code><span class="hljs-keyword"><span class="hljs-keyword">set</span></span></code>        ,   . <br> <br> <code class="cs">[Import] public QuestionnaireViewModel ViewModel { <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> { this.DataContext = value; } }</code> <br>     ,   . <br> <br> <code class="cs">[<span class="hljs-keyword"><span class="hljs-keyword">Export</span></span>] public class QuestionnaireViewModel : NotificationObject { ... }</code> <br>        ,   . <br> <br> <code class="cs">public QuestionnaireView() { InitializeComponent(); } [ImportingConstructor] public QuestionnaireView(QuestionnaireViewModel viewModel) : this() { this.DataContext = viewModel; }</code> <br> <b></b> <br>          MEF,   Unity.   ,     ,        .   ,   Visual Studio  Expression Blend, ,        ,     .   ,   ,  ,      ,          <code>InitializeComponent</code> . <br>     ,  Unity <br>  Unity,    ,   MEF.     ,      .    ,         .  ,      . <br> <br>  ,      ,  ,         . ,           ,   . <br> <br> <code class="cs">public QuestionnaireView() { InitializeComponent(); } public QuestionnaireView(QuestionnaireViewModel viewModel) : this() { this.DataContext = viewModel; }</code> <br> <b></b> <br>    ,        ,   Visual Studio  Expression Blend. <br>  ,          ,   . Unity        <code><span class="hljs-keyword"><span class="hljs-keyword">set</span></span></code>   ,   . <br> <br> <code class="cs">public QuestionnaireView() { InitializeComponent(); } [Dependency] public QuestionnaireViewModel ViewModel { <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> { this.DataContext = value; } }</code> <br>       Unity. <br> <br> <code class="cs">container.RegisterType&lt;QuestionnaireViewModel&gt;();</code> <br>  ,     . <br> <br> <code class="cs">var view = container.Resolve&lt;QuestionnaireView&gt;();</code> <br>     ,    <br>   ,     ,        .        ,   MEF  Unity,        . <br> <br>          .   ,         UI,           . <br> <br> , <i>RI MVVM</i>   ,   ,        .   ,    .      <code>ShowView</code>   UI. <br> <br> <code class="cs">private void NavigateToQuestionnaireList() { //     <span class="hljs-string"><span class="hljs-string">"questionnaire list"</span></span>. this.uiService.ShowView(ViewNames.QuestionnaireTemplatesList); }</code> <br>  UI      UI .           UI.  <code>ShowView</code>  <code>UIService</code>      (,          ),       ,   . <br> <br> <code class="cs">public void ShowView(<span class="hljs-keyword"><span class="hljs-keyword">string</span></span> viewName) { var view = this.ViewFactory.GetView(viewName); this.MainWindow.CurrentView = view; }</code> <br> <b></b> <br> Prism       .   ,   ,   ,             .    ,  , <span class="hljs-string"><span class="hljs-string">" </span></span><a href="http://msdn.microsoft.com/en-us/library/gg430861(v%3DPandP.40).aspx"><span class="hljs-string"><span class="hljs-string">View-Based Navigation</span></span></a><span class="hljs-string"><span class="hljs-string"> "</span></span>   <span class="hljs-number"><span class="hljs-number">8</span></span>, <span class="hljs-string"><span class="hljs-string">" </span></span><a href="http://msdn.microsoft.com/en-us/library/gg430861(v%3DPandP.40).aspx"><span class="hljs-string"><span class="hljs-string">Navigation</span></span></a><span class="hljs-string"><span class="hljs-string"> "</span></span>. <br>  MVVM  <br>        MVVM      .           -      mocking . ,   ,        . <br> <br>   <i>INotifyPropertyChanged</i> <br>   <code>INotifyPropertyChanged</code>     ,      .      ,    ;   ,   ,     ,    ,       . <br> <br>   <br> ,       ,           <code>PropertyChanged</code>  ,         .  ,    <code>ChangeTracker</code> ,     MVVM,  ,      .      .     ,    . <br> <br> <code class="cs">var changeTracker = new PropertyChangeTracker(viewModel); viewModel.CurrentState = <span class="hljs-string"><span class="hljs-string">"newState"</span></span>; CollectionAssert.Contains(changeTracker.ChangedProperties, <span class="hljs-string"><span class="hljs-string">"CurrentState"</span></span>);</code> <br> ,     ,     <code>INotifyPropertyChanged</code> ,    ,   ,     . <br> <br>      <br>        ,   ,    <code><span class="hljs-keyword"><span class="hljs-keyword">set</span></span></code>      ,           . ,     ,     ,      ,          . <br> <br> <code class="cs">var changeTracker = new PropertyChangeTracker(viewModel); var question = viewModel.Questions.First() as OpenQuestionViewModel; question.Question.Response = <span class="hljs-string"><span class="hljs-string">"some text"</span></span>; CollectionAssert.Contains(changeTracker.ChangedProperties, <span class="hljs-string"><span class="hljs-string">"UnansweredQuestions"</span></span>);</code> <br>      <br>     <code>INotifyPropertyChanged</code> ,      <code>PropertyChanged</code>        ,  ,     , , .        ,       . <br> <br>   <i>INotifyDataErrorInfo</i> <br>   ,     ,    ,   ,   <code>IDataErrorInfo</code> ,  ( Silverlight)   <code>INotifyDataErrorInfo</code> .   <code>INotifyDataErrorInfo</code>   ,         ,    ,  ,   ,    . <br> <br>       <code>INotifyDataErrorInfo</code> : ,     ,  ,     ,     <code>ErrorsChanged</code> ,      <code>GetErrors</code> , . <br> <br>    <br>     ,      ,     .       ,         <code>GetErrors</code>       ,  ,  ,   .    , ,  ,     ,        .   ,        . <br> <br> <code class="cs">//  . var notifyErrorInfo = (INotifyDataErrorInfo)question; question.Response = -<span class="hljs-number"><span class="hljs-number">15</span></span>; Assert.IsTrue(notifyErrorInfo.GetErrors(<span class="hljs-string"><span class="hljs-string">"Response"</span></span>).Cast&lt;ValidationResult&gt;().Any()); //  . var notifyErrorInfo = (INotifyDataErrorInfo)question; question.Response = <span class="hljs-number"><span class="hljs-number">15</span></span>; Assert.IsFalse(notifyErrorInfo.GetErrors(<span class="hljs-string"><span class="hljs-string">"Response"</span></span>).Cast&lt;ValidationResult&gt;().Any());</code> <br>    ,    ,             . <br> <br>    <i>INotifyDataErrorInfo</i> <br>       <code>GetErrors</code> ,   <code>INotifyDataErrorInfo</code>  ,   <code>ErrorsChanged</code>      <code>GetErrors</code> . ,  <code>HasErrors</code>      ,  . <br> <br>       <code>INotifyDataErrorInfo</code> . , ,           ,   -  .      ,        <code>INotifyDataErrorInfo</code>         (,        ). <br> <br>     ,   ,  : <br>  <code>HasErrors</code>     .              ,       .  <code>ErrorsChanged</code> ,      ,         <code>GetErrors</code> .         ( ,  )     ,           .    <code>GetErrors</code>       <code>ErrorsChanged</code> . <br>    <code>INotifyPropertyChanged</code> ,  ,    <code>NotifyDataErrorInfoTestHelper</code>    MVVM,        <code>INotifyDataErrorInfo</code> ,       .   ,   ,      ,   .      . <br> <code class="cs">var helper = new NotifyDataErrorInfoTestHelper&lt;NumericQuestion, int?&gt;( question, q =&gt; q.Response); helper.ValidatePropertyChange( <span class="hljs-number"><span class="hljs-number">6</span></span>, NotifyDataErrorInfoBehavior.Nothing); helper.ValidatePropertyChange( <span class="hljs-number"><span class="hljs-number">20</span></span>, NotifyDataErrorInfoBehavior.FiresErrorsChanged | NotifyDataErrorInfoBehavior.HasErrors | NotifyDataErrorInfoBehavior.HasErrorsForProperty); helper.ValidatePropertyChange( null, NotifyDataErrorInfoBehavior.FiresErrorsChanged | NotifyDataErrorInfoBehavior.HasErrors | NotifyDataErrorInfoBehavior.HasErrorsForProperty); helper.ValidatePropertyChange( <span class="hljs-number"><span class="hljs-number">2</span></span>, NotifyDataErrorInfoBehavior.FiresErrorsChanged);</code> <br>     <br>   MVVM,     ,  .   ,    ,         . <br> <br>  ,     ,     ,       .   ,   , ,       ,     ,   <code>IAsyncResult</code>    ,  - ,   ,    UI. <br> <br>       , , ,    .   ,     .  ,      UI,     ,   ,          ,     ,        <span class="hljs-string"><span class="hljs-string">"   UI."</span></span> <br> <br>     ,    ,    .   ,    ,     mock-, ,   ,   ,      ,          . <br> <br>           UI,    ,    .   ,     ,   ,      .        ,   .     ,    ,     . <br> <br> <code class="cs">questionnaireRepositoryMock .Setup( r =&gt; r.SubmitQuestionnaireAsync( It.IsAny&lt;Questionnaire&gt;(), It.IsAny&lt;Action&lt;IOperationResult&gt;&gt;())) .Callback&lt;Questionnaire, Action&lt;IOperationResult&gt;&gt;( (q, a) =&gt; callback = a); uiServicemock .Setup(svc =&gt; svc.ShowView(ViewNames.QuestionnaireTemplatesList)) .Callback&lt;<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>&gt;(viewName =&gt; requestedViewName = viewName); submitResultMock .Setup(sr =&gt; sr.Error) .Returns&lt;Exception&gt;(null); CompleteQuestionnaire(viewModel); viewModel.Submit(); //      UI . callback(submitResultMock.Object); //    ‚Äì     . Assert.AreEqual(ViewNames.QuestionnaireTemplatesList, requestedViewName);</code> <br> <b></b> <br>          ,        . <br>   <br>       , . <span class="hljs-string"><span class="hljs-string">"Trees in WPF"</span></span>  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ms753391.aspx">http://msdn.microsoft.com/en-us/library/ms753391.aspx</a> <br> <br>       , . <span class="hljs-string"><span class="hljs-string">"Attached Properties Overview"</span></span>  MSDN: <a href="http://msdn.microsoft.com/en-us/library/cc265152(VS.95).aspx">http://msdn.microsoft.com/en-us/library/cc265152(VS.<span class="hljs-number"><span class="hljs-number">95</span></span>).aspx</a> <br> <br>      MEF, .<span class="hljs-string"><span class="hljs-string">"Managed Extensibility Framework Overview"</span></span>  MSDN: <a href="http://msdn.microsoft.com/en-us/library/dd460648.aspx">http://msdn.microsoft.com/en-us/library/dd460648.aspx</a> . <br> <br>      Unity, .<span class="hljs-string"><span class="hljs-string">"Unity Application Block"</span></span>  MSDN: <a href="http://www.msdn.com/unity">http://www.msdn.com/unity</a> . <br> <br>      <code>DelegateCommand</code> , .Chapter <span class="hljs-number"><span class="hljs-number">5</span></span>, <span class="hljs-string"><span class="hljs-string">" </span></span><a href="http://msdn.microsoft.com/en-us/library/gg405484(v%3DPandP.40).aspx"><span class="hljs-string"><span class="hljs-string">Implementing the MVVM Pattern</span></span></a><span class="hljs-string"><span class="hljs-string"> ."</span></span> <br> <br>        Microsoft Expression Blend, .<span class="hljs-string"><span class="hljs-string">"Working with built-in behaviors"</span></span>  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ff724013(v%3DExpression.40).aspx">http://msdn.microsoft.com/en-us/library/ff724013(v=Expression.<span class="hljs-number"><span class="hljs-number">40</span></span>).aspx</a> . <br> <br>          Microsoft Expression Blend, .<span class="hljs-string"><span class="hljs-string">"Creating Custom Behaviors"</span></span>  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ff724708(v%3DExpression.40).aspx">http://msdn.microsoft.com/en-us/library/ff724708(v=Expression.<span class="hljs-number"><span class="hljs-number">40</span></span>).aspx</a> . <br> <br>            Microsoft Expression Blend, .<span class="hljs-string"><span class="hljs-string">"Creating Custom Triggers and Actions"</span></span>  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ff724707(v%3DExpression.40).aspx">http://msdn.microsoft.com/en-us/library/ff724707(v=Expression.<span class="hljs-number"><span class="hljs-number">40</span></span>).aspx</a> . <br> <br>         WPF  Silverlight, .<span class="hljs-string"><span class="hljs-string">"Threading Model"</span></span>  <span class="hljs-string"><span class="hljs-string">"The Dispatcher Class"</span></span>  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ms741870.aspx">http://msdn.microsoft.com/en-us/library/ms741870.aspx</a> <br> <a href="http://msdn.microsoft.com/en-us/library/ms615907(v%3DVS.95).aspx">http://msdn.microsoft.com/en-us/library/ms615907(v=VS.<span class="hljs-number"><span class="hljs-number">95</span></span>).aspx</a> . <br> <br>      unit-  Silverlight, .<span class="hljs-string"><span class="hljs-string">"Unit Testing with Silverlight 2"</span></span>: <a href="http://www.jeff.wilcox.name/2008/03/silverlight2-unit-testing/">http://www.jeff.wilcox.name/<span class="hljs-number"><span class="hljs-number">2008</span></span>/<span class="hljs-number"><span class="hljs-number">03</span></span>/silverlight2-unit-testing/</a> . <br> <br>         , .  <span class="hljs-string"><span class="hljs-string">" </span></span><a href="http://msdn.microsoft.com/en-us/library/gg430861(v%3DPandP.40).aspx"><span class="hljs-string"><span class="hljs-string">View-Based Navigation</span></span></a><span class="hljs-string"><span class="hljs-string"> "</span></span> in Chapter <span class="hljs-number"><span class="hljs-number">8</span></span>, <span class="hljs-string"><span class="hljs-string">" </span></span><a href="http://msdn.microsoft.com/en-us/library/gg430861(v%3DPandP.40).aspx"><span class="hljs-string"><span class="hljs-string">Navigation</span></span></a><span class="hljs-string"><span class="hljs-string"> ."</span></span> <br> <br>       ,   , .<span class="hljs-string"><span class="hljs-string">"Event-based Asynchronous Pattern Overview"</span></span>  MSDN: <a href="http://msdn.microsoft.com/en-us/library/wewwczdw.aspx">http://msdn.microsoft.com/en-us/library/wewwczdw.aspx</a> <br> <br>        <code>IAsyncResult</code> , .<span class="hljs-string"><span class="hljs-string">"Asynchronous Programming Overview"</span></span>  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ms228963.aspx">http://msdn.microsoft.com/en-us/library/ms228963.aspx</a></code></code></code></code></code></code></code></code></code> </pre> <code><code><code><code><code><code><code><code><code><code>CommandBehaviorBase ,    ,    ICommand</code> .           <code>CanExecuteChanged</code> ,          Silverlight,    WPF. <br> <br>    ,  ,   <code>CommandBehaviorBase    ,    .         ,      .         ,    .      ButtonBaseClickCommandBehavior</code> . <br> <br> <code class="cs">public class ButtonBaseClickCommandBehavior : CommandBehaviorBase&lt;ButtonBase&gt; { public ButtonBaseClickCommandBehavior(ButtonBase clickableObject) : base(clickableObject) { clickableObject.Click += OnClick; } private void OnClick(object sender, System.Windows.RoutedEventArgs e) { ExecuteCommand(); } }</code> <br>   <code>CommandBehaviorBase ,     .     ,          ,   . ,    ,    ,      , ,    CanExecute</code>  ,     . <br> <br>          ,   .           XAML.           .       .  Prism      ,       ,  ,   .       ,    . , ,  ,      <code>Click</code> ,       <code>Command</code> .    <code>Click.Command</code> ,  . <br> <br>             .             . <br> <br> <code class="cs">public static readonly DependencyProperty CommandProperty = DependencyProperty.RegisterAttached( "Command", typeof(ICommand), typeof(Click), new PropertyMetadata(OnSetCommandCallback)); private static readonly DependencyProperty ClickCommandBehaviorProperty = DependencyProperty.RegisterAttached( "ClickCommandBehavior", typeof(ButtonBaseClickCommandBehavior), typeof(Click), null);</code> <br>    <code>Command</code>    <code>ButtonBaseClickCommandBehavior</code> ,     <code>OnSetCommandCallback</code> ,     . <br> <br> <code class="cs">private static void OnSetCommandCallback(DependencyObject dependencyObject, DependencyPropertyChangedEventArgs e) { ButtonBase buttonBase = dependencyObject as ButtonBase; if (buttonBase != null) { ButtonBaseClickCommandBehavior behavior = GetOrCreateBehavior(buttonBase); behavior.Command = e.NewValue as ICommand; } } private static void OnSetCommandParameterCallback(DependencyObject dependencyObject, DependencyPropertyChangedEventArgs e) { ButtonBase buttonBase = dependencyObject as ButtonBase; if (buttonBase != null) { ButtonBaseClickCommandBehavior behavior = GetOrCreateBehavior(buttonBase); behavior.CommandParameter = e.NewValue; } } private static ButtonBaseClickCommandBehavior GetOrCreateBehavior(ButtonBase buttonBase ) { ButtonBaseClickCommandBehavior behavior = buttonBase.GetValue(ClickCommandBehaviorProperty) as ButtonBaseClickCommandBehavior; if ( behavior == null ) { behavior = new ButtonBaseClickCommandBehavior(buttonBase); buttonBase.SetValue(ClickCommandBehaviorProperty, behavior); } return behavior; }</code> <br>        ,  <a href="http://msdn.microsoft.com/en-us/library/cc265152(VS.95).aspx">Attached Properties Overview</a>  MSDN. <br> <br>    <br>              . ,     Silverlight,    -,     ,      ,     .     ,       . <br> <br>        ,    ( )  ,  ,     .  UI       ,            UI. <br> <br>      - <br>   -     ,       <code>IAsyncResult</code> .   ,  ,   ,  <code>GetQuestionnaire</code> ,   : <code>BeginGetQuestionnaire</code>  <code>EndGetQuestionnaire</code> .    ,   <code>BeginGetQuestionnaire</code> .     ,   ,   <code>EndGetQuestionnaire</code>    . <br> <b></b> <br>  .NET Framework 4.5      <code>await</code>  <code>async</code>     <code>*Async</code> .      <a href="http://msdn.microsoft.com/en-us/library/vstudio/hh391443.aspx">"Asynchronous Programming with Async and Await (C# and Visual Basic)"</a> . <br>  ,    <code>EndGetQuestionnaire</code> ,      ,  ()      <code>BeginGetQuestionnaire</code> .     ,      ,   <code>EndGetQuestionnaire</code> ,   . <br> <br> <code class="xml">IAsyncResult asyncResult = this.service.BeginGetQuestionnaire( GetQuestionnaireCompleted, null //  ,      ); private void GetQuestionnaireCompleted(IAsyncResult result) { try { questionnaire = this.service.EndGetQuestionnaire(ar); } catch (Exception ex) { //  -   . } }</code> <br>  ,     <code>End*</code> (  , <code>EndGetQuestionnaire</code> ),    ,      .      , ,          UI.     ,   ,        . <br> <br>        UI,     -,      UI,         UI,   <code>Dispatcher</code>    <code>SynchronizationContext</code> .  WPF  Silverlight,   <code>Dispatcher</code> . <br> <br>      <code>Questionnaire</code>  ,        <code>QuestionnaireView</code> .  Silverlight    <code>CheckAccess</code> ,  ,      UI.  ,     <code>BeginInvoke</code> ,      UI. <br> <br> <code class="cs">var dispatcher = System.Windows.Deployment.Current.Dispatcher; if (dispatcher.CheckAccess()) { QuestionnaireView.DataContext = questionnaire; } else { dispatcher.BeginInvoke(() =&gt; { Questionnaire.DataContext = questionnaire; }); }</code> <br> <i>MVVM RI</i>   ,    ,   <code>IAsyncResult</code> ,   .      ,                 . ,       . <br> <br> <code class="cs">this.questionnaireRepository.GetQuestionnaireAsync( result =&gt; { this.Questionnaire = result.Result; });</code> <br>  <code>result</code>   ,     , , , .    ,     . <br> <br> <code class="cs">this.questionnaireRepository.GetQuestionnaireAsync( result =&gt; { if (result.Error == null) { this.Questionnaire = result.Result; ... } else { // Handle error. } })</code> <br>     <br>        ,      .     , ,             .        ,      ,     ,     . <br> <br>         ,      MVVM,     ,   . ,  -MVVM ,     <code>MessageBox</code>   code-behind UI,      .   MVVM     ,          . <br> <br>     MVVM,              ,          .      ,    ,   ,  ,     . <br> <br>              MVVM.      ,     ,     ,  ,     .    ,         ,     ,          .       . <br> <br>    <br>                  .        ,        .  ,         .         . <br> <br>  ,         ,         ,  .      ,     .           ,       . ,        WPF  Silverlight,        . <br> <br> <img title="Using the service to interact with the user." src="https://habrastorage.org/getpro/habr/post_images/4b5/397/f2d/4b5397f2d02e5851195b29f1893be6fc.png" alt=" ,    ."> <br> <br>  ,   <code>MessageBox</code>        ,     ,    ,     . <br> <br> <code class="cs">var result = interactionService.ShowMessageBox( "Are you sure you want to cancel this operation?", "Confirm", MessageBoxButton.OK); if (result == MessageBoxResult.Yes) { CancelRequest(); }</code> <br> ,      - ,      ,         Silverlight.         .             .     . <br> <br> <code class="cs">interactionService.ShowMessageBox( "Are you sure you want to cancel this operation?", "Confirm", MessageBoxButton.OK, result =&gt; { if (result == MessageBoxResult.Yes) { CancelRequest(); } });</code> <br>         ,      . ,  WPF    <code>MessageBox</code> ,       ;    Silverlight    ,    . <br> <br>     <br>         ‚Äì             .         ,      .     ,     .        ,        ,   ,     . <br> <br> <img title="Using interaction request objects." src="https://habrastorage.org/getpro/habr/post_images/3d0/ff0/1c5/3d0ff01c5518558c2d3c5c5f47ce0ce9.png" alt="   ."> <br> <br>    ,   ,          ‚Äì       ,      ,   ‚Äì     .   ,        ,    ,    UI            . <br> <br>       MVVM,     ,       ,         .         ,        ,    ,   . <br> <br>  Prism       <code>IInteractionRequest</code>   <code>InteractionRequest .  IInteractionRequest</code>  ,   .           ,   .  <code>InteractionRequest   IInteractionRequest</code>     <code>Raise</code> ,           , , ,   . <br> <br>       <br>  <code>InteractionRequest          .  Raise</code>          ( <code>T</code> )    ,    ,   .          ,       .      ,        .    ,  ,     . <br> <code class="cs">public interface IInteractionRequest { event EventHandler&lt;InteractionRequestedEventArgs&gt; Raised; } public class InteractionRequest&lt;T&gt; : IInteractionRequest { public event EventHandler&lt;InteractionRequestedEventArgs&gt; Raised; public void Raise(T context, Action&lt;T&gt; callback) { var handler = this.Raised; if (handler != null) { handler( this, new InteractionRequestedEventArgs(context, () =&gt; callback(context))); } } }</code> <br> Prism    ,      .  <code>Notification</code>       .    ,            .     ‚Äì <code>Title</code>  <code>Content</code> ,    .  ,   ,  ,  ,        . <br> <br>  <code>Confirmation</code>    <code>Notification</code>     ‚Äì <code>Confirmed</code> ,  ,  ,      .  <code>Confirmation</code> ,     <code>MessageBox</code> ,     /  .     ,     <code>Notification</code> ,     ,      . <br> <br>    <code>InteractionRequest ,       InteractionRequest      ,      .      ,    Raise</code> ,    , ,   . <br> <br> <code class="cs">public IInteractionRequest ConfirmCancelInteractionRequest { get { return this.confirmCancelInteractionRequest; } } this.confirmCancelInteractionRequest.Raise( new Confirmation("Are you sure you wish to cancel?"), confirmation =&gt; { if (confirmation.Confirmed) { this.NavigateToQuestionnaireList(); } }); }</code> <br> <i>MVVM Reference Implementation (MVVM RI)</i> ,    <code>IInteractionRequest</code>   <code>InteractionRequest ,          (. QuestionnaireViewModel.cs</code> ). <br> <br>        <br>       ,       .   ,       .    UI             . <br> <br>                . Microsoft Expression Blend Behaviors Framework     .  ,     ,    . <br> <br>  <code>EventTrigger</code> ,  Expression Blend,  ,      ,     ,   . , Prism   <code>EventTrigger</code> ,  <code>InteractionRequestTrigger</code> ,      <code>Raised</code>   <code>IInteractionRequest</code> .    XAML        . <br> <br>  ,   , <code>InteractionRequestTrigger</code>   .  Silverlight Prism   <code>PopupChildWindowAction</code> ,     .    ,         .   <code>ContentTemplate</code>  <code>PopupChildWindowAction</code> ,    ,    UI,      <code>Content</code>  .       <code>Title</code>  . <br> <b></b> <br>  ,    ,   <code>PopupChildWindowAction</code> ,     .    <code>Notification</code>  <code>NotificationChildWindow</code> ,        <code>Confirmation</code> ‚Äì <code>ConfirmationChildWindow</code> . <code>NotificationChildWindow</code>    ,   ,     <code>ConfirmationChildWindow</code>    <i>OK</i>  <i>Cancel</i> ,    .    ,   ,   <code>ChildWindow</code>  <code>PopupChildWindowAction</code> . <br>   ,  <code>InteractionRequestTrigger</code>  <code>PopupChildWindowAction</code> ,       <i>RI MVVM</i> . <br> <br> <code class="xml">&lt;i:Interaction.Triggers&gt; &lt;prism:InteractionRequestTrigger SourceObject="{Binding ConfirmCancelInteractionRequest}"&gt; &lt;prism:PopupChildWindowAction ContentTemplate="{StaticResource ConfirmWindowTemplate}"/&gt; &lt;/prism:InteractionRequestTrigger&gt; &lt;/i:Interaction.Triggers&gt; &lt;UserControl.Resources&gt; &lt;DataTemplate x:Key="ConfirmWindowTemplate"&gt; &lt;Grid MinWidth="250" MinHeight="100"&gt; &lt;TextBlock TextWrapping="Wrap" Grid.Row="0" Text="{Binding}"/&gt; &lt;/Grid&gt; &lt;/DataTemplate&gt; &lt;/UserControl.Resources&gt;</code> <br> <b></b> <br>      <code>ContentTemplate</code> ,   UI   <code>Content</code>  .    <code>Content</code>  ,  , <code>TextBlock</code>     <code>Content</code> . <br>      ,     ,    ,    .  ,     ,       ,     ,    .   ,   <i>RI MVVM</i> ,         <code>Confirmed</code>    <code>Confirmation</code>  <code>true</code> ,     OK. <br> <br>        ,     .  Prism <code>InteractionRequestTrigger</code>   <code>PopupChildWindowAction</code>            . <br> <br>     <br>     MVVM,       , ,    ,         .        (  , ,  ,   ).    ,  ,  ,            . <br> <br>        ,         . Managed Extensibility Framework (MEF)  Unity Application Block (Unity)      ,  ,           . <br> <br>  ,       , , ,    ( )      . ,       ,     .  ,     ,       . <br> <br>     ,  MEF <br>  MEF,       ,   <code>Import</code> ,      ,  ,   <code>Export</code> .         ,    . <br> <br> , <code>QuestionnaireView</code>   <i>RI MVVM</i> ,        ,    <code>Import</code> .   , MEF           .  <code>set</code>        ,   . <br> <br> <code class="cs">[Import] public QuestionnaireViewModel ViewModel { set { this.DataContext = value; } }</code> <br>     ,   . <br> <br> <code class="cs">[Export] public class QuestionnaireViewModel : NotificationObject { ... }</code> <br>        ,   . <br> <br> <code class="cs">public QuestionnaireView() { InitializeComponent(); } [ImportingConstructor] public QuestionnaireView(QuestionnaireViewModel viewModel) : this() { this.DataContext = viewModel; }</code> <br> <b></b> <br>          MEF,   Unity.   ,     ,        .   ,   Visual Studio  Expression Blend, ,        ,     .   ,   ,  ,      ,          <code>InitializeComponent</code> . <br>     ,  Unity <br>  Unity,    ,   MEF.     ,      .    ,         .  ,      . <br> <br>  ,      ,  ,         . ,           ,   . <br> <br> <code class="cs">public QuestionnaireView() { InitializeComponent(); } public QuestionnaireView(QuestionnaireViewModel viewModel) : this() { this.DataContext = viewModel; }</code> <br> <b></b> <br>    ,        ,   Visual Studio  Expression Blend. <br>  ,          ,   . Unity        <code>set</code>   ,   . <br> <br> <code class="cs">public QuestionnaireView() { InitializeComponent(); } [Dependency] public QuestionnaireViewModel ViewModel { set { this.DataContext = value; } }</code> <br>       Unity. <br> <br> <code class="cs">container.RegisterType&lt;QuestionnaireViewModel&gt;();</code> <br>  ,     . <br> <br> <code class="cs">var view = container.Resolve&lt;QuestionnaireView&gt;();</code> <br>     ,    <br>   ,     ,        .        ,   MEF  Unity,        . <br> <br>          .   ,         UI,           . <br> <br> , <i>RI MVVM</i>   ,   ,        .   ,    .      <code>ShowView</code>   UI. <br> <br> <code class="cs">private void NavigateToQuestionnaireList() { //     "questionnaire list". this.uiService.ShowView(ViewNames.QuestionnaireTemplatesList); }</code> <br>  UI      UI .           UI.  <code>ShowView</code>  <code>UIService</code>      (,          ),       ,   . <br> <br> <code class="cs">public void ShowView(string viewName) { var view = this.ViewFactory.GetView(viewName); this.MainWindow.CurrentView = view; }</code> <br> <b></b> <br> Prism       .   ,   ,   ,             .    ,  , " <a href="http://msdn.microsoft.com/en-us/library/gg430861(v%3DPandP.40).aspx">View-Based Navigation</a> "   8, " <a href="http://msdn.microsoft.com/en-us/library/gg430861(v%3DPandP.40).aspx">Navigation</a> ". <br>  MVVM  <br>        MVVM      .           -      mocking . ,   ,        . <br> <br>   <i>INotifyPropertyChanged</i> <br>   <code>INotifyPropertyChanged</code>     ,      .      ,    ;   ,   ,     ,    ,       . <br> <br>   <br> ,       ,           <code>PropertyChanged</code>  ,         .  ,    <code>ChangeTracker</code> ,     MVVM,  ,      .      .     ,    . <br> <br> <code class="cs">var changeTracker = new PropertyChangeTracker(viewModel); viewModel.CurrentState = "newState"; CollectionAssert.Contains(changeTracker.ChangedProperties, "CurrentState");</code> <br> ,     ,     <code>INotifyPropertyChanged</code> ,    ,   ,     . <br> <br>      <br>        ,   ,    <code>set</code>      ,           . ,     ,     ,      ,          . <br> <br> <code class="cs">var changeTracker = new PropertyChangeTracker(viewModel); var question = viewModel.Questions.First() as OpenQuestionViewModel; question.Question.Response = "some text"; CollectionAssert.Contains(changeTracker.ChangedProperties, "UnansweredQuestions");</code> <br>      <br>     <code>INotifyPropertyChanged</code> ,      <code>PropertyChanged</code>        ,  ,     , , .        ,       . <br> <br>   <i>INotifyDataErrorInfo</i> <br>   ,     ,    ,   ,   <code>IDataErrorInfo</code> ,  ( Silverlight)   <code>INotifyDataErrorInfo</code> .   <code>INotifyDataErrorInfo</code>   ,         ,    ,  ,   ,    . <br> <br>       <code>INotifyDataErrorInfo</code> : ,     ,  ,     ,     <code>ErrorsChanged</code> ,      <code>GetErrors</code> , . <br> <br>    <br>     ,      ,     .       ,         <code>GetErrors</code>       ,  ,  ,   .    , ,  ,     ,        .   ,        . <br> <br> <code class="cs">//  . var notifyErrorInfo = (INotifyDataErrorInfo)question; question.Response = -15; Assert.IsTrue(notifyErrorInfo.GetErrors("Response").Cast&lt;ValidationResult&gt;().Any()); //  . var notifyErrorInfo = (INotifyDataErrorInfo)question; question.Response = 15; Assert.IsFalse(notifyErrorInfo.GetErrors("Response").Cast&lt;ValidationResult&gt;().Any());</code> <br>    ,    ,             . <br> <br>    <i>INotifyDataErrorInfo</i> <br>       <code>GetErrors</code> ,   <code>INotifyDataErrorInfo</code>  ,   <code>ErrorsChanged</code>      <code>GetErrors</code> . ,  <code>HasErrors</code>      ,  . <br> <br>       <code>INotifyDataErrorInfo</code> . , ,           ,   -  .      ,        <code>INotifyDataErrorInfo</code>         (,        ). <br> <br>     ,   ,  : <br>  <code>HasErrors</code>     .              ,       .  <code>ErrorsChanged</code> ,      ,         <code>GetErrors</code> .         ( ,  )     ,           .    <code>GetErrors</code>       <code>ErrorsChanged</code> . <br>    <code>INotifyPropertyChanged</code> ,  ,    <code>NotifyDataErrorInfoTestHelper</code>    MVVM,        <code>INotifyDataErrorInfo</code> ,       .   ,   ,      ,   .      . <br> <code class="cs">var helper = new NotifyDataErrorInfoTestHelper&lt;NumericQuestion, int?&gt;( question, q =&gt; q.Response); helper.ValidatePropertyChange( 6, NotifyDataErrorInfoBehavior.Nothing); helper.ValidatePropertyChange( 20, NotifyDataErrorInfoBehavior.FiresErrorsChanged | NotifyDataErrorInfoBehavior.HasErrors | NotifyDataErrorInfoBehavior.HasErrorsForProperty); helper.ValidatePropertyChange( null, NotifyDataErrorInfoBehavior.FiresErrorsChanged | NotifyDataErrorInfoBehavior.HasErrors | NotifyDataErrorInfoBehavior.HasErrorsForProperty); helper.ValidatePropertyChange( 2, NotifyDataErrorInfoBehavior.FiresErrorsChanged);</code> <br>     <br>   MVVM,     ,  .   ,    ,         . <br> <br>  ,     ,     ,       .   ,   , ,       ,     ,   <code>IAsyncResult</code>    ,  - ,   ,    UI. <br> <br>       , , ,    .   ,     .  ,      UI,     ,   ,          ,     ,        "   UI." <br> <br>     ,    ,    .   ,    ,     mock-, ,   ,   ,      ,          . <br> <br>           UI,    ,    .   ,     ,   ,      .        ,   .     ,    ,     . <br> <br> <code class="cs">questionnaireRepositoryMock .Setup( r =&gt; r.SubmitQuestionnaireAsync( It.IsAny&lt;Questionnaire&gt;(), It.IsAny&lt;Action&lt;IOperationResult&gt;&gt;())) .Callback&lt;Questionnaire, Action&lt;IOperationResult&gt;&gt;( (q, a) =&gt; callback = a); uiServicemock .Setup(svc =&gt; svc.ShowView(ViewNames.QuestionnaireTemplatesList)) .Callback&lt;string&gt;(viewName =&gt; requestedViewName = viewName); submitResultMock .Setup(sr =&gt; sr.Error) .Returns&lt;Exception&gt;(null); CompleteQuestionnaire(viewModel); viewModel.Submit(); //      UI . callback(submitResultMock.Object); //    ‚Äì     . Assert.AreEqual(ViewNames.QuestionnaireTemplatesList, requestedViewName);</code> <br> <b></b> <br>          ,        . <br>   <br>       , . "Trees in WPF"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ms753391.aspx">http://msdn.microsoft.com/en-us/library/ms753391.aspx</a> <br> <br>       , . "Attached Properties Overview"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/cc265152(VS.95).aspx">http://msdn.microsoft.com/en-us/library/cc265152(VS.95).aspx</a> <br> <br>      MEF, ."Managed Extensibility Framework Overview"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/dd460648.aspx">http://msdn.microsoft.com/en-us/library/dd460648.aspx</a> . <br> <br>      Unity, ."Unity Application Block"  MSDN: <a href="http://www.msdn.com/unity">http://www.msdn.com/unity</a> . <br> <br>      <code>DelegateCommand</code> , .Chapter 5, " <a href="http://msdn.microsoft.com/en-us/library/gg405484(v%3DPandP.40).aspx">Implementing the MVVM Pattern</a> ." <br> <br>        Microsoft Expression Blend, ."Working with built-in behaviors"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ff724013(v%3DExpression.40).aspx">http://msdn.microsoft.com/en-us/library/ff724013(v=Expression.40).aspx</a> . <br> <br>          Microsoft Expression Blend, ."Creating Custom Behaviors"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ff724708(v%3DExpression.40).aspx">http://msdn.microsoft.com/en-us/library/ff724708(v=Expression.40).aspx</a> . <br> <br>            Microsoft Expression Blend, ."Creating Custom Triggers and Actions"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ff724707(v%3DExpression.40).aspx">http://msdn.microsoft.com/en-us/library/ff724707(v=Expression.40).aspx</a> . <br> <br>         WPF  Silverlight, ."Threading Model"  "The Dispatcher Class"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ms741870.aspx">http://msdn.microsoft.com/en-us/library/ms741870.aspx</a> <br> <a href="http://msdn.microsoft.com/en-us/library/ms615907(v%3DVS.95).aspx">http://msdn.microsoft.com/en-us/library/ms615907(v=VS.95).aspx</a> . <br> <br>      unit-  Silverlight, ."Unit Testing with Silverlight 2": <a href="http://www.jeff.wilcox.name/2008/03/silverlight2-unit-testing/">http://www.jeff.wilcox.name/2008/03/silverlight2-unit-testing/</a> . <br> <br>         , .  " <a href="http://msdn.microsoft.com/en-us/library/gg430861(v%3DPandP.40).aspx">View-Based Navigation</a> " in Chapter 8, " <a href="http://msdn.microsoft.com/en-us/library/gg430861(v%3DPandP.40).aspx">Navigation</a> ." <br> <br>       ,   , ."Event-based Asynchronous Pattern Overview"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/wewwczdw.aspx">http://msdn.microsoft.com/en-us/library/wewwczdw.aspx</a> <br> <br>        <code>IAsyncResult</code> , ."Asynchronous Programming Overview"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ms228963.aspx">http://msdn.microsoft.com/en-us/library/ms228963.aspx</a></code></code></code></code></code></code></code></code></code> <pre> <code class="hljs cmake"><code>CommandBehaviorBase ,    ,    ICommand</code> .           <code>CanExecuteChanged</code> ,          Silverlight,    WPF. <br> <br>    ,  ,   <code><code>CommandBehaviorBase    ,    .         ,      .         ,    .      ButtonBaseClickCommandBehavior</code> . <br> <br> <code class="cs">public class ButtonBaseClickCommandBehavior : CommandBehaviorBase&lt;ButtonBase&gt; { public ButtonBaseClickCommandBehavior(ButtonBase clickableObject) : base(clickableObject) { clickableObject.Click += OnClick; } private void OnClick(object sender, System.Windows.RoutedEventArgs e) { ExecuteCommand(); } }</code> <br>   <code><code>CommandBehaviorBase ,     .     ,          ,   . ,    ,    ,      , ,    CanExecute</code>  ,     . <br> <br>          ,   .           XAML.           .       .  Prism      ,       ,  ,   .       ,    . , ,  ,      <code>Click</code> ,       <code><span class="hljs-keyword"><span class="hljs-keyword">Command</span></span></code> .    <code>Click.<span class="hljs-keyword"><span class="hljs-keyword">Command</span></span></code> ,  . <br> <br>             .             . <br> <br> <code class="cs">public static readonly DependencyProperty CommandProperty = DependencyProperty.RegisterAttached( <span class="hljs-string"><span class="hljs-string">"Command"</span></span>, typeof(ICommand), typeof(Click), new PropertyMetadata(OnSetCommandCallback)); private static readonly DependencyProperty ClickCommandBehaviorProperty = DependencyProperty.RegisterAttached( <span class="hljs-string"><span class="hljs-string">"ClickCommandBehavior"</span></span>, typeof(ButtonBaseClickCommandBehavior), typeof(Click), null);</code> <br>    <code><span class="hljs-keyword"><span class="hljs-keyword">Command</span></span></code>    <code>ButtonBaseClickCommandBehavior</code> ,     <code>OnSetCommandCallback</code> ,     . <br> <br> <code class="cs">private static void OnSetCommandCallback(DependencyObject dependencyObject, DependencyPropertyChangedEventArgs e) { ButtonBase buttonBase = dependencyObject as ButtonBase; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (buttonBase != null) { ButtonBaseClickCommandBehavior behavior = GetOrCreateBehavior(buttonBase); behavior.<span class="hljs-keyword"><span class="hljs-keyword">Command</span></span> = e.NewValue as ICommand; } } private static void OnSetCommandParameterCallback(DependencyObject dependencyObject, DependencyPropertyChangedEventArgs e) { ButtonBase buttonBase = dependencyObject as ButtonBase; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (buttonBase != null) { ButtonBaseClickCommandBehavior behavior = GetOrCreateBehavior(buttonBase); behavior.CommandParameter = e.NewValue; } } private static ButtonBaseClickCommandBehavior GetOrCreateBehavior(ButtonBase buttonBase ) { ButtonBaseClickCommandBehavior behavior = buttonBase.GetValue(ClickCommandBehaviorProperty) as ButtonBaseClickCommandBehavior; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ( behavior == null ) { behavior = new ButtonBaseClickCommandBehavior(buttonBase); buttonBase.SetValue(ClickCommandBehaviorProperty, behavior); } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> behavior; }</code> <br>        ,  <a href="http://msdn.microsoft.com/en-us/library/cc265152(VS.95).aspx">Attached Properties Overview</a>  MSDN. <br> <br>    <br>              . ,     Silverlight,    -,     ,      ,     .     ,       . <br> <br>        ,    ( )  ,  ,     .  UI       ,            UI. <br> <br>      - <br>   -     ,       <code>IAsyncResult</code> .   ,  ,   ,  <code>GetQuestionnaire</code> ,   : <code>BeginGetQuestionnaire</code>  <code>EndGetQuestionnaire</code> .    ,   <code>BeginGetQuestionnaire</code> .     ,   ,   <code>EndGetQuestionnaire</code>    . <br> <b></b> <br>  .NET Framework <span class="hljs-number"><span class="hljs-number">4.5</span></span>      <code>await</code>  <code>async</code>     <code>*Async</code> .      <a href="http://msdn.microsoft.com/en-us/library/vstudio/hh391443.aspx"><span class="hljs-string"><span class="hljs-string">"Asynchronous Programming with Async and Await (C# and Visual Basic)"</span></span></a> . <br>  ,    <code>EndGetQuestionnaire</code> ,      ,  ()      <code>BeginGetQuestionnaire</code> .     ,      ,   <code>EndGetQuestionnaire</code> ,   . <br> <br> <code class="xml">IAsyncResult asyncResult = this.service.BeginGetQuestionnaire( GetQuestionnaireCompleted, null //  ,      ); private void GetQuestionnaireCompleted(IAsyncResult result) { try { questionnaire = this.service.EndGetQuestionnaire(ar); } catch (Exception ex) { //  -   . } }</code> <br>  ,     <code>End*</code> (  , <code>EndGetQuestionnaire</code> ),    ,      .      , ,          UI.     ,   ,        . <br> <br>        UI,     -,      UI,         UI,   <code>Dispatcher</code>    <code>SynchronizationContext</code> .  WPF  Silverlight,   <code>Dispatcher</code> . <br> <br>      <code>Questionnaire</code>  ,        <code>QuestionnaireView</code> .  Silverlight    <code>CheckAccess</code> ,  ,      UI.  ,     <code>BeginInvoke</code> ,      UI. <br> <br> <code class="cs">var dispatcher = System.Windows.Deployment.Current.Dispatcher; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (dispatcher.CheckAccess()) { QuestionnaireView.DataContext = questionnaire; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { dispatcher.BeginInvoke(() =&gt; { Questionnaire.DataContext = questionnaire; }); }</code> <br> <i>MVVM RI</i>   ,    ,   <code>IAsyncResult</code> ,   .      ,                 . ,       . <br> <br> <code class="cs">this.questionnaireRepository.GetQuestionnaireAsync( result =&gt; { this.Questionnaire = result.Result; });</code> <br>  <code>result</code>   ,     , , , .    ,     . <br> <br> <code class="cs">this.questionnaireRepository.GetQuestionnaireAsync( result =&gt; { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (result.Error == null) { this.Questionnaire = result.Result; ... } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { // Handle error. } })</code> <br>     <br>        ,      .     , ,             .        ,      ,     ,     . <br> <br>         ,      MVVM,     ,   . ,  -MVVM ,     <code>MessageBox</code>   code-behind UI,      .   MVVM     ,          . <br> <br>     MVVM,              ,          .      ,    ,   ,  ,     . <br> <br>              MVVM.      ,     ,     ,  ,     .    ,         ,     ,          .       . <br> <br>    <br>                  .        ,        .  ,         .         . <br> <br>  ,         ,         ,  .      ,     .           ,       . ,        WPF  Silverlight,        . <br> <br> <img title="Using the service to interact with the user." src="https://habrastorage.org/getpro/habr/post_images/4b5/397/f2d/4b5397f2d02e5851195b29f1893be6fc.png" alt=" ,    ."> <br> <br>  ,   <code>MessageBox</code>        ,     ,    ,     . <br> <br> <code class="cs">var result = interactionService.ShowMessageBox( <span class="hljs-string"><span class="hljs-string">"Are you sure you want to cancel this operation?"</span></span>, <span class="hljs-string"><span class="hljs-string">"Confirm"</span></span>, MessageBoxButton.OK); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (result == MessageBoxResult.Yes) { CancelRequest(); }</code> <br> ,      - ,      ,         Silverlight.         .             .     . <br> <br> <code class="cs">interactionService.ShowMessageBox( <span class="hljs-string"><span class="hljs-string">"Are you sure you want to cancel this operation?"</span></span>, <span class="hljs-string"><span class="hljs-string">"Confirm"</span></span>, MessageBoxButton.OK, result =&gt; { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (result == MessageBoxResult.Yes) { CancelRequest(); } });</code> <br>         ,      . ,  WPF    <code>MessageBox</code> ,       ;    Silverlight    ,    . <br> <br>     <br>         ‚Äì             .         ,      .     ,     .        ,        ,   ,     . <br> <br> <img title="Using interaction request objects." src="https://habrastorage.org/getpro/habr/post_images/3d0/ff0/1c5/3d0ff01c5518558c2d3c5c5f47ce0ce9.png" alt="   ."> <br> <br>    ,   ,          ‚Äì       ,      ,   ‚Äì     .   ,        ,    ,    UI            . <br> <br>       MVVM,     ,       ,         .         ,        ,    ,   . <br> <br>  Prism       <code>IInteractionRequest</code>   <code><code>InteractionRequest .  IInteractionRequest</code>  ,   .           ,   .  <code><code>InteractionRequest   IInteractionRequest</code>     <code>Raise</code> ,           , , ,   . <br> <br>       <br>  <code><code>InteractionRequest          .  Raise</code>          ( <code>T</code> )    ,    ,   .          ,       .      ,        .    ,  ,     . <br> <code class="cs">public interface IInteractionRequest { event EventHandler&lt;InteractionRequestedEventArgs&gt; Raised; } public class InteractionRequest&lt;T&gt; : IInteractionRequest { public event EventHandler&lt;InteractionRequestedEventArgs&gt; Raised; public void Raise(T context, Action&lt;T&gt; callback) { var handler = this.Raised; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (handler != null) { handler( this, new InteractionRequestedEventArgs(context, () =&gt; callback(context))); } } }</code> <br> Prism    ,      .  <code>Notification</code>       .    ,            .     ‚Äì <code>Title</code>  <code>Content</code> ,    .  ,   ,  ,  ,        . <br> <br>  <code>Confirmation</code>    <code>Notification</code>     ‚Äì <code>Confirmed</code> ,  ,  ,      .  <code>Confirmation</code> ,     <code>MessageBox</code> ,     /  .     ,     <code>Notification</code> ,     ,      . <br> <br>    <code><code><code>InteractionRequest ,       InteractionRequest      ,      .      ,    Raise</code> ,    , ,   . <br> <br> <code class="cs">public IInteractionRequest ConfirmCancelInteractionRequest { get { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> this.confirmCancelInteractionRequest; } } this.confirmCancelInteractionRequest.Raise( new Confirmation(<span class="hljs-string"><span class="hljs-string">"Are you sure you wish to cancel?"</span></span>), confirmation =&gt; { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (confirmation.Confirmed) { this.NavigateToQuestionnaireList(); } }); }</code> <br> <i>MVVM Reference Implementation (MVVM RI)</i> ,    <code>IInteractionRequest</code>   <code><code>InteractionRequest ,          (. QuestionnaireViewModel.cs</code> ). <br> <br>        <br>       ,       .   ,       .    UI             . <br> <br>                . Microsoft Expression Blend Behaviors Framework     .  ,     ,    . <br> <br>  <code>EventTrigger</code> ,  Expression Blend,  ,      ,     ,   . , Prism   <code>EventTrigger</code> ,  <code>InteractionRequestTrigger</code> ,      <code>Raised</code>   <code>IInteractionRequest</code> .    XAML        . <br> <br>  ,   , <code>InteractionRequestTrigger</code>   .  Silverlight Prism   <code>PopupChildWindowAction</code> ,     .    ,         .   <code>ContentTemplate</code>  <code>PopupChildWindowAction</code> ,    ,    UI,      <code>Content</code>  .       <code>Title</code>  . <br> <b></b> <br>  ,    ,   <code>PopupChildWindowAction</code> ,     .    <code>Notification</code>  <code>NotificationChildWindow</code> ,        <code>Confirmation</code> ‚Äì <code>ConfirmationChildWindow</code> . <code>NotificationChildWindow</code>    ,   ,     <code>ConfirmationChildWindow</code>    <i>OK</i>  <i>Cancel</i> ,    .    ,   ,   <code>ChildWindow</code>  <code>PopupChildWindowAction</code> . <br>   ,  <code>InteractionRequestTrigger</code>  <code>PopupChildWindowAction</code> ,       <i>RI MVVM</i> . <br> <br> <code class="xml">&lt;i:Interaction.Triggers&gt; &lt;prism:InteractionRequestTrigger SourceObject=<span class="hljs-string"><span class="hljs-string">"{Binding ConfirmCancelInteractionRequest}"</span></span>&gt; &lt;prism:PopupChildWindowAction ContentTemplate=<span class="hljs-string"><span class="hljs-string">"{StaticResource ConfirmWindowTemplate}"</span></span>/&gt; &lt;/prism:InteractionRequestTrigger&gt; &lt;/i:Interaction.Triggers&gt; &lt;UserControl.Resources&gt; &lt;DataTemplate x:Key=<span class="hljs-string"><span class="hljs-string">"ConfirmWindowTemplate"</span></span>&gt; &lt;Grid MinWidth=<span class="hljs-string"><span class="hljs-string">"250"</span></span> MinHeight=<span class="hljs-string"><span class="hljs-string">"100"</span></span>&gt; &lt;TextBlock TextWrapping=<span class="hljs-string"><span class="hljs-string">"Wrap"</span></span> Grid.Row=<span class="hljs-string"><span class="hljs-string">"0"</span></span> Text=<span class="hljs-string"><span class="hljs-string">"{Binding}"</span></span>/&gt; &lt;/Grid&gt; &lt;/DataTemplate&gt; &lt;/UserControl.Resources&gt;</code> <br> <b></b> <br>      <code>ContentTemplate</code> ,   UI   <code>Content</code>  .    <code>Content</code>  ,  , <code>TextBlock</code>     <code>Content</code> . <br>      ,     ,    ,    .  ,     ,       ,     ,    .   ,   <i>RI MVVM</i> ,         <code>Confirmed</code>    <code>Confirmation</code>  <code><span class="hljs-keyword"><span class="hljs-keyword">true</span></span></code> ,     OK. <br> <br>        ,     .  Prism <code>InteractionRequestTrigger</code>   <code>PopupChildWindowAction</code>            . <br> <br>     <br>     MVVM,       , ,    ,         .        (  , ,  ,   ).    ,  ,  ,            . <br> <br>        ,         . Managed Extensibility Framework (MEF)  Unity Application Block (Unity)      ,  ,           . <br> <br>  ,       , , ,    ( )      . ,       ,     .  ,     ,       . <br> <br>     ,  MEF <br>  MEF,       ,   <code>Import</code> ,      ,  ,   <code><span class="hljs-keyword"><span class="hljs-keyword">Export</span></span></code> .         ,    . <br> <br> , <code>QuestionnaireView</code>   <i>RI MVVM</i> ,        ,    <code>Import</code> .   , MEF           .  <code><span class="hljs-keyword"><span class="hljs-keyword">set</span></span></code>        ,   . <br> <br> <code class="cs">[Import] public QuestionnaireViewModel ViewModel { <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> { this.DataContext = value; } }</code> <br>     ,   . <br> <br> <code class="cs">[<span class="hljs-keyword"><span class="hljs-keyword">Export</span></span>] public class QuestionnaireViewModel : NotificationObject { ... }</code> <br>        ,   . <br> <br> <code class="cs">public QuestionnaireView() { InitializeComponent(); } [ImportingConstructor] public QuestionnaireView(QuestionnaireViewModel viewModel) : this() { this.DataContext = viewModel; }</code> <br> <b></b> <br>          MEF,   Unity.   ,     ,        .   ,   Visual Studio  Expression Blend, ,        ,     .   ,   ,  ,      ,          <code>InitializeComponent</code> . <br>     ,  Unity <br>  Unity,    ,   MEF.     ,      .    ,         .  ,      . <br> <br>  ,      ,  ,         . ,           ,   . <br> <br> <code class="cs">public QuestionnaireView() { InitializeComponent(); } public QuestionnaireView(QuestionnaireViewModel viewModel) : this() { this.DataContext = viewModel; }</code> <br> <b></b> <br>    ,        ,   Visual Studio  Expression Blend. <br>  ,          ,   . Unity        <code><span class="hljs-keyword"><span class="hljs-keyword">set</span></span></code>   ,   . <br> <br> <code class="cs">public QuestionnaireView() { InitializeComponent(); } [Dependency] public QuestionnaireViewModel ViewModel { <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> { this.DataContext = value; } }</code> <br>       Unity. <br> <br> <code class="cs">container.RegisterType&lt;QuestionnaireViewModel&gt;();</code> <br>  ,     . <br> <br> <code class="cs">var view = container.Resolve&lt;QuestionnaireView&gt;();</code> <br>     ,    <br>   ,     ,        .        ,   MEF  Unity,        . <br> <br>          .   ,         UI,           . <br> <br> , <i>RI MVVM</i>   ,   ,        .   ,    .      <code>ShowView</code>   UI. <br> <br> <code class="cs">private void NavigateToQuestionnaireList() { //     <span class="hljs-string"><span class="hljs-string">"questionnaire list"</span></span>. this.uiService.ShowView(ViewNames.QuestionnaireTemplatesList); }</code> <br>  UI      UI .           UI.  <code>ShowView</code>  <code>UIService</code>      (,          ),       ,   . <br> <br> <code class="cs">public void ShowView(<span class="hljs-keyword"><span class="hljs-keyword">string</span></span> viewName) { var view = this.ViewFactory.GetView(viewName); this.MainWindow.CurrentView = view; }</code> <br> <b></b> <br> Prism       .   ,   ,   ,             .    ,  , <span class="hljs-string"><span class="hljs-string">" </span></span><a href="http://msdn.microsoft.com/en-us/library/gg430861(v%3DPandP.40).aspx"><span class="hljs-string"><span class="hljs-string">View-Based Navigation</span></span></a><span class="hljs-string"><span class="hljs-string"> "</span></span>   <span class="hljs-number"><span class="hljs-number">8</span></span>, <span class="hljs-string"><span class="hljs-string">" </span></span><a href="http://msdn.microsoft.com/en-us/library/gg430861(v%3DPandP.40).aspx"><span class="hljs-string"><span class="hljs-string">Navigation</span></span></a><span class="hljs-string"><span class="hljs-string"> "</span></span>. <br>  MVVM  <br>        MVVM      .           -      mocking . ,   ,        . <br> <br>   <i>INotifyPropertyChanged</i> <br>   <code>INotifyPropertyChanged</code>     ,      .      ,    ;   ,   ,     ,    ,       . <br> <br>   <br> ,       ,           <code>PropertyChanged</code>  ,         .  ,    <code>ChangeTracker</code> ,     MVVM,  ,      .      .     ,    . <br> <br> <code class="cs">var changeTracker = new PropertyChangeTracker(viewModel); viewModel.CurrentState = <span class="hljs-string"><span class="hljs-string">"newState"</span></span>; CollectionAssert.Contains(changeTracker.ChangedProperties, <span class="hljs-string"><span class="hljs-string">"CurrentState"</span></span>);</code> <br> ,     ,     <code>INotifyPropertyChanged</code> ,    ,   ,     . <br> <br>      <br>        ,   ,    <code><span class="hljs-keyword"><span class="hljs-keyword">set</span></span></code>      ,           . ,     ,     ,      ,          . <br> <br> <code class="cs">var changeTracker = new PropertyChangeTracker(viewModel); var question = viewModel.Questions.First() as OpenQuestionViewModel; question.Question.Response = <span class="hljs-string"><span class="hljs-string">"some text"</span></span>; CollectionAssert.Contains(changeTracker.ChangedProperties, <span class="hljs-string"><span class="hljs-string">"UnansweredQuestions"</span></span>);</code> <br>      <br>     <code>INotifyPropertyChanged</code> ,      <code>PropertyChanged</code>        ,  ,     , , .        ,       . <br> <br>   <i>INotifyDataErrorInfo</i> <br>   ,     ,    ,   ,   <code>IDataErrorInfo</code> ,  ( Silverlight)   <code>INotifyDataErrorInfo</code> .   <code>INotifyDataErrorInfo</code>   ,         ,    ,  ,   ,    . <br> <br>       <code>INotifyDataErrorInfo</code> : ,     ,  ,     ,     <code>ErrorsChanged</code> ,      <code>GetErrors</code> , . <br> <br>    <br>     ,      ,     .       ,         <code>GetErrors</code>       ,  ,  ,   .    , ,  ,     ,        .   ,        . <br> <br> <code class="cs">//  . var notifyErrorInfo = (INotifyDataErrorInfo)question; question.Response = -<span class="hljs-number"><span class="hljs-number">15</span></span>; Assert.IsTrue(notifyErrorInfo.GetErrors(<span class="hljs-string"><span class="hljs-string">"Response"</span></span>).Cast&lt;ValidationResult&gt;().Any()); //  . var notifyErrorInfo = (INotifyDataErrorInfo)question; question.Response = <span class="hljs-number"><span class="hljs-number">15</span></span>; Assert.IsFalse(notifyErrorInfo.GetErrors(<span class="hljs-string"><span class="hljs-string">"Response"</span></span>).Cast&lt;ValidationResult&gt;().Any());</code> <br>    ,    ,             . <br> <br>    <i>INotifyDataErrorInfo</i> <br>       <code>GetErrors</code> ,   <code>INotifyDataErrorInfo</code>  ,   <code>ErrorsChanged</code>      <code>GetErrors</code> . ,  <code>HasErrors</code>      ,  . <br> <br>       <code>INotifyDataErrorInfo</code> . , ,           ,   -  .      ,        <code>INotifyDataErrorInfo</code>         (,        ). <br> <br>     ,   ,  : <br>  <code>HasErrors</code>     .              ,       .  <code>ErrorsChanged</code> ,      ,         <code>GetErrors</code> .         ( ,  )     ,           .    <code>GetErrors</code>       <code>ErrorsChanged</code> . <br>    <code>INotifyPropertyChanged</code> ,  ,    <code>NotifyDataErrorInfoTestHelper</code>    MVVM,        <code>INotifyDataErrorInfo</code> ,       .   ,   ,      ,   .      . <br> <code class="cs">var helper = new NotifyDataErrorInfoTestHelper&lt;NumericQuestion, int?&gt;( question, q =&gt; q.Response); helper.ValidatePropertyChange( <span class="hljs-number"><span class="hljs-number">6</span></span>, NotifyDataErrorInfoBehavior.Nothing); helper.ValidatePropertyChange( <span class="hljs-number"><span class="hljs-number">20</span></span>, NotifyDataErrorInfoBehavior.FiresErrorsChanged | NotifyDataErrorInfoBehavior.HasErrors | NotifyDataErrorInfoBehavior.HasErrorsForProperty); helper.ValidatePropertyChange( null, NotifyDataErrorInfoBehavior.FiresErrorsChanged | NotifyDataErrorInfoBehavior.HasErrors | NotifyDataErrorInfoBehavior.HasErrorsForProperty); helper.ValidatePropertyChange( <span class="hljs-number"><span class="hljs-number">2</span></span>, NotifyDataErrorInfoBehavior.FiresErrorsChanged);</code> <br>     <br>   MVVM,     ,  .   ,    ,         . <br> <br>  ,     ,     ,       .   ,   , ,       ,     ,   <code>IAsyncResult</code>    ,  - ,   ,    UI. <br> <br>       , , ,    .   ,     .  ,      UI,     ,   ,          ,     ,        <span class="hljs-string"><span class="hljs-string">"   UI."</span></span> <br> <br>     ,    ,    .   ,    ,     mock-, ,   ,   ,      ,          . <br> <br>           UI,    ,    .   ,     ,   ,      .        ,   .     ,    ,     . <br> <br> <code class="cs">questionnaireRepositoryMock .Setup( r =&gt; r.SubmitQuestionnaireAsync( It.IsAny&lt;Questionnaire&gt;(), It.IsAny&lt;Action&lt;IOperationResult&gt;&gt;())) .Callback&lt;Questionnaire, Action&lt;IOperationResult&gt;&gt;( (q, a) =&gt; callback = a); uiServicemock .Setup(svc =&gt; svc.ShowView(ViewNames.QuestionnaireTemplatesList)) .Callback&lt;<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>&gt;(viewName =&gt; requestedViewName = viewName); submitResultMock .Setup(sr =&gt; sr.Error) .Returns&lt;Exception&gt;(null); CompleteQuestionnaire(viewModel); viewModel.Submit(); //      UI . callback(submitResultMock.Object); //    ‚Äì     . Assert.AreEqual(ViewNames.QuestionnaireTemplatesList, requestedViewName);</code> <br> <b></b> <br>          ,        . <br>   <br>       , . <span class="hljs-string"><span class="hljs-string">"Trees in WPF"</span></span>  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ms753391.aspx">http://msdn.microsoft.com/en-us/library/ms753391.aspx</a> <br> <br>       , . <span class="hljs-string"><span class="hljs-string">"Attached Properties Overview"</span></span>  MSDN: <a href="http://msdn.microsoft.com/en-us/library/cc265152(VS.95).aspx">http://msdn.microsoft.com/en-us/library/cc265152(VS.<span class="hljs-number"><span class="hljs-number">95</span></span>).aspx</a> <br> <br>      MEF, .<span class="hljs-string"><span class="hljs-string">"Managed Extensibility Framework Overview"</span></span>  MSDN: <a href="http://msdn.microsoft.com/en-us/library/dd460648.aspx">http://msdn.microsoft.com/en-us/library/dd460648.aspx</a> . <br> <br>      Unity, .<span class="hljs-string"><span class="hljs-string">"Unity Application Block"</span></span>  MSDN: <a href="http://www.msdn.com/unity">http://www.msdn.com/unity</a> . <br> <br>      <code>DelegateCommand</code> , .Chapter <span class="hljs-number"><span class="hljs-number">5</span></span>, <span class="hljs-string"><span class="hljs-string">" </span></span><a href="http://msdn.microsoft.com/en-us/library/gg405484(v%3DPandP.40).aspx"><span class="hljs-string"><span class="hljs-string">Implementing the MVVM Pattern</span></span></a><span class="hljs-string"><span class="hljs-string"> ."</span></span> <br> <br>        Microsoft Expression Blend, .<span class="hljs-string"><span class="hljs-string">"Working with built-in behaviors"</span></span>  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ff724013(v%3DExpression.40).aspx">http://msdn.microsoft.com/en-us/library/ff724013(v=Expression.<span class="hljs-number"><span class="hljs-number">40</span></span>).aspx</a> . <br> <br>          Microsoft Expression Blend, .<span class="hljs-string"><span class="hljs-string">"Creating Custom Behaviors"</span></span>  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ff724708(v%3DExpression.40).aspx">http://msdn.microsoft.com/en-us/library/ff724708(v=Expression.<span class="hljs-number"><span class="hljs-number">40</span></span>).aspx</a> . <br> <br>            Microsoft Expression Blend, .<span class="hljs-string"><span class="hljs-string">"Creating Custom Triggers and Actions"</span></span>  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ff724707(v%3DExpression.40).aspx">http://msdn.microsoft.com/en-us/library/ff724707(v=Expression.<span class="hljs-number"><span class="hljs-number">40</span></span>).aspx</a> . <br> <br>         WPF  Silverlight, .<span class="hljs-string"><span class="hljs-string">"Threading Model"</span></span>  <span class="hljs-string"><span class="hljs-string">"The Dispatcher Class"</span></span>  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ms741870.aspx">http://msdn.microsoft.com/en-us/library/ms741870.aspx</a> <br> <a href="http://msdn.microsoft.com/en-us/library/ms615907(v%3DVS.95).aspx">http://msdn.microsoft.com/en-us/library/ms615907(v=VS.<span class="hljs-number"><span class="hljs-number">95</span></span>).aspx</a> . <br> <br>      unit-  Silverlight, .<span class="hljs-string"><span class="hljs-string">"Unit Testing with Silverlight 2"</span></span>: <a href="http://www.jeff.wilcox.name/2008/03/silverlight2-unit-testing/">http://www.jeff.wilcox.name/<span class="hljs-number"><span class="hljs-number">2008</span></span>/<span class="hljs-number"><span class="hljs-number">03</span></span>/silverlight2-unit-testing/</a> . <br> <br>         , .  <span class="hljs-string"><span class="hljs-string">" </span></span><a href="http://msdn.microsoft.com/en-us/library/gg430861(v%3DPandP.40).aspx"><span class="hljs-string"><span class="hljs-string">View-Based Navigation</span></span></a><span class="hljs-string"><span class="hljs-string"> "</span></span> in Chapter <span class="hljs-number"><span class="hljs-number">8</span></span>, <span class="hljs-string"><span class="hljs-string">" </span></span><a href="http://msdn.microsoft.com/en-us/library/gg430861(v%3DPandP.40).aspx"><span class="hljs-string"><span class="hljs-string">Navigation</span></span></a><span class="hljs-string"><span class="hljs-string"> ."</span></span> <br> <br>       ,   , .<span class="hljs-string"><span class="hljs-string">"Event-based Asynchronous Pattern Overview"</span></span>  MSDN: <a href="http://msdn.microsoft.com/en-us/library/wewwczdw.aspx">http://msdn.microsoft.com/en-us/library/wewwczdw.aspx</a> <br> <br>        <code>IAsyncResult</code> , .<span class="hljs-string"><span class="hljs-string">"Asynchronous Programming Overview"</span></span>  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ms228963.aspx">http://msdn.microsoft.com/en-us/library/ms228963.aspx</a></code></code></code></code></code></code></code></code></code> </pre> <code><code><code><code><code><code><code><code><code><code>CommandBehaviorBase ,    ,    ICommand</code> .           <code>CanExecuteChanged</code> ,          Silverlight,    WPF. <br> <br>    ,  ,   <code>CommandBehaviorBase    ,    .         ,      .         ,    .      ButtonBaseClickCommandBehavior</code> . <br> <br> <code class="cs">public class ButtonBaseClickCommandBehavior : CommandBehaviorBase&lt;ButtonBase&gt; { public ButtonBaseClickCommandBehavior(ButtonBase clickableObject) : base(clickableObject) { clickableObject.Click += OnClick; } private void OnClick(object sender, System.Windows.RoutedEventArgs e) { ExecuteCommand(); } }</code> <br>   <code>CommandBehaviorBase ,     .     ,          ,   . ,    ,    ,      , ,    CanExecute</code>  ,     . <br> <br>          ,   .           XAML.           .       .  Prism      ,       ,  ,   .       ,    . , ,  ,      <code>Click</code> ,       <code>Command</code> .    <code>Click.Command</code> ,  . <br> <br>             .             . <br> <br> <code class="cs">public static readonly DependencyProperty CommandProperty = DependencyProperty.RegisterAttached( "Command", typeof(ICommand), typeof(Click), new PropertyMetadata(OnSetCommandCallback)); private static readonly DependencyProperty ClickCommandBehaviorProperty = DependencyProperty.RegisterAttached( "ClickCommandBehavior", typeof(ButtonBaseClickCommandBehavior), typeof(Click), null);</code> <br>    <code>Command</code>    <code>ButtonBaseClickCommandBehavior</code> ,     <code>OnSetCommandCallback</code> ,     . <br> <br> <code class="cs">private static void OnSetCommandCallback(DependencyObject dependencyObject, DependencyPropertyChangedEventArgs e) { ButtonBase buttonBase = dependencyObject as ButtonBase; if (buttonBase != null) { ButtonBaseClickCommandBehavior behavior = GetOrCreateBehavior(buttonBase); behavior.Command = e.NewValue as ICommand; } } private static void OnSetCommandParameterCallback(DependencyObject dependencyObject, DependencyPropertyChangedEventArgs e) { ButtonBase buttonBase = dependencyObject as ButtonBase; if (buttonBase != null) { ButtonBaseClickCommandBehavior behavior = GetOrCreateBehavior(buttonBase); behavior.CommandParameter = e.NewValue; } } private static ButtonBaseClickCommandBehavior GetOrCreateBehavior(ButtonBase buttonBase ) { ButtonBaseClickCommandBehavior behavior = buttonBase.GetValue(ClickCommandBehaviorProperty) as ButtonBaseClickCommandBehavior; if ( behavior == null ) { behavior = new ButtonBaseClickCommandBehavior(buttonBase); buttonBase.SetValue(ClickCommandBehaviorProperty, behavior); } return behavior; }</code> <br>        ,  <a href="http://msdn.microsoft.com/en-us/library/cc265152(VS.95).aspx">Attached Properties Overview</a>  MSDN. <br> <br>    <br>              . ,     Silverlight,    -,     ,      ,     .     ,       . <br> <br>        ,    ( )  ,  ,     .  UI       ,            UI. <br> <br>      - <br>   -     ,       <code>IAsyncResult</code> .   ,  ,   ,  <code>GetQuestionnaire</code> ,   : <code>BeginGetQuestionnaire</code>  <code>EndGetQuestionnaire</code> .    ,   <code>BeginGetQuestionnaire</code> .     ,   ,   <code>EndGetQuestionnaire</code>    . <br> <b></b> <br>  .NET Framework 4.5      <code>await</code>  <code>async</code>     <code>*Async</code> .      <a href="http://msdn.microsoft.com/en-us/library/vstudio/hh391443.aspx">"Asynchronous Programming with Async and Await (C# and Visual Basic)"</a> . <br>  ,    <code>EndGetQuestionnaire</code> ,      ,  ()      <code>BeginGetQuestionnaire</code> .     ,      ,   <code>EndGetQuestionnaire</code> ,   . <br> <br> <code class="xml">IAsyncResult asyncResult = this.service.BeginGetQuestionnaire( GetQuestionnaireCompleted, null //  ,      ); private void GetQuestionnaireCompleted(IAsyncResult result) { try { questionnaire = this.service.EndGetQuestionnaire(ar); } catch (Exception ex) { //  -   . } }</code> <br>  ,     <code>End*</code> (  , <code>EndGetQuestionnaire</code> ),    ,      .      , ,          UI.     ,   ,        . <br> <br>        UI,     -,      UI,         UI,   <code>Dispatcher</code>    <code>SynchronizationContext</code> .  WPF  Silverlight,   <code>Dispatcher</code> . <br> <br>      <code>Questionnaire</code>  ,        <code>QuestionnaireView</code> .  Silverlight    <code>CheckAccess</code> ,  ,      UI.  ,     <code>BeginInvoke</code> ,      UI. <br> <br> <code class="cs">var dispatcher = System.Windows.Deployment.Current.Dispatcher; if (dispatcher.CheckAccess()) { QuestionnaireView.DataContext = questionnaire; } else { dispatcher.BeginInvoke(() =&gt; { Questionnaire.DataContext = questionnaire; }); }</code> <br> <i>MVVM RI</i>   ,    ,   <code>IAsyncResult</code> ,   .      ,                 . ,       . <br> <br> <code class="cs">this.questionnaireRepository.GetQuestionnaireAsync( result =&gt; { this.Questionnaire = result.Result; });</code> <br>  <code>result</code>   ,     , , , .    ,     . <br> <br> <code class="cs">this.questionnaireRepository.GetQuestionnaireAsync( result =&gt; { if (result.Error == null) { this.Questionnaire = result.Result; ... } else { // Handle error. } })</code> <br>     <br>        ,      .     , ,             .        ,      ,     ,     . <br> <br>         ,      MVVM,     ,   . ,  -MVVM ,     <code>MessageBox</code>   code-behind UI,      .   MVVM     ,          . <br> <br>     MVVM,              ,          .      ,    ,   ,  ,     . <br> <br>              MVVM.      ,     ,     ,  ,     .    ,         ,     ,          .       . <br> <br>    <br>                  .        ,        .  ,         .         . <br> <br>  ,         ,         ,  .      ,     .           ,       . ,        WPF  Silverlight,        . <br> <br> <img title="Using the service to interact with the user." src="https://habrastorage.org/getpro/habr/post_images/4b5/397/f2d/4b5397f2d02e5851195b29f1893be6fc.png" alt=" ,    ."> <br> <br>  ,   <code>MessageBox</code>        ,     ,    ,     . <br> <br> <code class="cs">var result = interactionService.ShowMessageBox( "Are you sure you want to cancel this operation?", "Confirm", MessageBoxButton.OK); if (result == MessageBoxResult.Yes) { CancelRequest(); }</code> <br> ,      - ,      ,         Silverlight.         .             .     . <br> <br> <code class="cs">interactionService.ShowMessageBox( "Are you sure you want to cancel this operation?", "Confirm", MessageBoxButton.OK, result =&gt; { if (result == MessageBoxResult.Yes) { CancelRequest(); } });</code> <br>         ,      . ,  WPF    <code>MessageBox</code> ,       ;    Silverlight    ,    . <br> <br>     <br>         ‚Äì             .         ,      .     ,     .        ,        ,   ,     . <br> <br> <img title="Using interaction request objects." src="https://habrastorage.org/getpro/habr/post_images/3d0/ff0/1c5/3d0ff01c5518558c2d3c5c5f47ce0ce9.png" alt="   ."> <br> <br>    ,   ,          ‚Äì       ,      ,   ‚Äì     .   ,        ,    ,    UI            . <br> <br>       MVVM,     ,       ,         .         ,        ,    ,   . <br> <br>  Prism       <code>IInteractionRequest</code>   <code>InteractionRequest .  IInteractionRequest</code>  ,   .           ,   .  <code>InteractionRequest   IInteractionRequest</code>     <code>Raise</code> ,           , , ,   . <br> <br>       <br>  <code>InteractionRequest          .  Raise</code>          ( <code>T</code> )    ,    ,   .          ,       .      ,        .    ,  ,     . <br> <code class="cs">public interface IInteractionRequest { event EventHandler&lt;InteractionRequestedEventArgs&gt; Raised; } public class InteractionRequest&lt;T&gt; : IInteractionRequest { public event EventHandler&lt;InteractionRequestedEventArgs&gt; Raised; public void Raise(T context, Action&lt;T&gt; callback) { var handler = this.Raised; if (handler != null) { handler( this, new InteractionRequestedEventArgs(context, () =&gt; callback(context))); } } }</code> <br> Prism    ,      .  <code>Notification</code>       .    ,            .     ‚Äì <code>Title</code>  <code>Content</code> ,    .  ,   ,  ,  ,        . <br> <br>  <code>Confirmation</code>    <code>Notification</code>     ‚Äì <code>Confirmed</code> ,  ,  ,      .  <code>Confirmation</code> ,     <code>MessageBox</code> ,     /  .     ,     <code>Notification</code> ,     ,      . <br> <br>    <code>InteractionRequest ,       InteractionRequest      ,      .      ,    Raise</code> ,    , ,   . <br> <br> <code class="cs">public IInteractionRequest ConfirmCancelInteractionRequest { get { return this.confirmCancelInteractionRequest; } } this.confirmCancelInteractionRequest.Raise( new Confirmation("Are you sure you wish to cancel?"), confirmation =&gt; { if (confirmation.Confirmed) { this.NavigateToQuestionnaireList(); } }); }</code> <br> <i>MVVM Reference Implementation (MVVM RI)</i> ,    <code>IInteractionRequest</code>   <code>InteractionRequest ,          (. QuestionnaireViewModel.cs</code> ). <br> <br>        <br>       ,       .   ,       .    UI             . <br> <br>                . Microsoft Expression Blend Behaviors Framework     .  ,     ,    . <br> <br>  <code>EventTrigger</code> ,  Expression Blend,  ,      ,     ,   . , Prism   <code>EventTrigger</code> ,  <code>InteractionRequestTrigger</code> ,      <code>Raised</code>   <code>IInteractionRequest</code> .    XAML        . <br> <br>  ,   , <code>InteractionRequestTrigger</code>   .  Silverlight Prism   <code>PopupChildWindowAction</code> ,     .    ,         .   <code>ContentTemplate</code>  <code>PopupChildWindowAction</code> ,    ,    UI,      <code>Content</code>  .       <code>Title</code>  . <br> <b></b> <br>  ,    ,   <code>PopupChildWindowAction</code> ,     .    <code>Notification</code>  <code>NotificationChildWindow</code> ,        <code>Confirmation</code> ‚Äì <code>ConfirmationChildWindow</code> . <code>NotificationChildWindow</code>    ,   ,     <code>ConfirmationChildWindow</code>    <i>OK</i>  <i>Cancel</i> ,    .    ,   ,   <code>ChildWindow</code>  <code>PopupChildWindowAction</code> . <br>   ,  <code>InteractionRequestTrigger</code>  <code>PopupChildWindowAction</code> ,       <i>RI MVVM</i> . <br> <br> <code class="xml">&lt;i:Interaction.Triggers&gt; &lt;prism:InteractionRequestTrigger SourceObject="{Binding ConfirmCancelInteractionRequest}"&gt; &lt;prism:PopupChildWindowAction ContentTemplate="{StaticResource ConfirmWindowTemplate}"/&gt; &lt;/prism:InteractionRequestTrigger&gt; &lt;/i:Interaction.Triggers&gt; &lt;UserControl.Resources&gt; &lt;DataTemplate x:Key="ConfirmWindowTemplate"&gt; &lt;Grid MinWidth="250" MinHeight="100"&gt; &lt;TextBlock TextWrapping="Wrap" Grid.Row="0" Text="{Binding}"/&gt; &lt;/Grid&gt; &lt;/DataTemplate&gt; &lt;/UserControl.Resources&gt;</code> <br> <b></b> <br>      <code>ContentTemplate</code> ,   UI   <code>Content</code>  .    <code>Content</code>  ,  , <code>TextBlock</code>     <code>Content</code> . <br>      ,     ,    ,    .  ,     ,       ,     ,    .   ,   <i>RI MVVM</i> ,         <code>Confirmed</code>    <code>Confirmation</code>  <code>true</code> ,     OK. <br> <br>        ,     .  Prism <code>InteractionRequestTrigger</code>   <code>PopupChildWindowAction</code>            . <br> <br>     <br>     MVVM,       , ,    ,         .        (  , ,  ,   ).    ,  ,  ,            . <br> <br>        ,         . Managed Extensibility Framework (MEF)  Unity Application Block (Unity)      ,  ,           . <br> <br>  ,       , , ,    ( )      . ,       ,     .  ,     ,       . <br> <br>     ,  MEF <br>  MEF,       ,   <code>Import</code> ,      ,  ,   <code>Export</code> .         ,    . <br> <br> , <code>QuestionnaireView</code>   <i>RI MVVM</i> ,        ,    <code>Import</code> .   , MEF           .  <code>set</code>        ,   . <br> <br> <code class="cs">[Import] public QuestionnaireViewModel ViewModel { set { this.DataContext = value; } }</code> <br>     ,   . <br> <br> <code class="cs">[Export] public class QuestionnaireViewModel : NotificationObject { ... }</code> <br>        ,   . <br> <br> <code class="cs">public QuestionnaireView() { InitializeComponent(); } [ImportingConstructor] public QuestionnaireView(QuestionnaireViewModel viewModel) : this() { this.DataContext = viewModel; }</code> <br> <b></b> <br>          MEF,   Unity.   ,     ,        .   ,   Visual Studio  Expression Blend, ,        ,     .   ,   ,  ,      ,          <code>InitializeComponent</code> . <br>     ,  Unity <br>  Unity,    ,   MEF.     ,      .    ,         .  ,      . <br> <br>  ,      ,  ,         . ,           ,   . <br> <br> <code class="cs">public QuestionnaireView() { InitializeComponent(); } public QuestionnaireView(QuestionnaireViewModel viewModel) : this() { this.DataContext = viewModel; }</code> <br> <b></b> <br>    ,        ,   Visual Studio  Expression Blend. <br>  ,          ,   . Unity        <code>set</code>   ,   . <br> <br> <code class="cs">public QuestionnaireView() { InitializeComponent(); } [Dependency] public QuestionnaireViewModel ViewModel { set { this.DataContext = value; } }</code> <br>       Unity. <br> <br> <code class="cs">container.RegisterType&lt;QuestionnaireViewModel&gt;();</code> <br>  ,     . <br> <br> <code class="cs">var view = container.Resolve&lt;QuestionnaireView&gt;();</code> <br>     ,    <br>   ,     ,        .        ,   MEF  Unity,        . <br> <br>          .   ,         UI,           . <br> <br> , <i>RI MVVM</i>   ,   ,        .   ,    .      <code>ShowView</code>   UI. <br> <br> <code class="cs">private void NavigateToQuestionnaireList() { //     "questionnaire list". this.uiService.ShowView(ViewNames.QuestionnaireTemplatesList); }</code> <br>  UI      UI .           UI.  <code>ShowView</code>  <code>UIService</code>      (,          ),       ,   . <br> <br> <code class="cs">public void ShowView(string viewName) { var view = this.ViewFactory.GetView(viewName); this.MainWindow.CurrentView = view; }</code> <br> <b></b> <br> Prism       .   ,   ,   ,             .    ,  , " <a href="http://msdn.microsoft.com/en-us/library/gg430861(v%3DPandP.40).aspx">View-Based Navigation</a> "   8, " <a href="http://msdn.microsoft.com/en-us/library/gg430861(v%3DPandP.40).aspx">Navigation</a> ". <br>  MVVM  <br>        MVVM      .           -      mocking . ,   ,        . <br> <br>   <i>INotifyPropertyChanged</i> <br>   <code>INotifyPropertyChanged</code>     ,      .      ,    ;   ,   ,     ,    ,       . <br> <br>   <br> ,       ,           <code>PropertyChanged</code>  ,         .  ,    <code>ChangeTracker</code> ,     MVVM,  ,      .      .     ,    . <br> <br> <code class="cs">var changeTracker = new PropertyChangeTracker(viewModel); viewModel.CurrentState = "newState"; CollectionAssert.Contains(changeTracker.ChangedProperties, "CurrentState");</code> <br> ,     ,     <code>INotifyPropertyChanged</code> ,    ,   ,     . <br> <br>      <br>        ,   ,    <code>set</code>      ,           . ,     ,     ,      ,          . <br> <br> <code class="cs">var changeTracker = new PropertyChangeTracker(viewModel); var question = viewModel.Questions.First() as OpenQuestionViewModel; question.Question.Response = "some text"; CollectionAssert.Contains(changeTracker.ChangedProperties, "UnansweredQuestions");</code> <br>      <br>     <code>INotifyPropertyChanged</code> ,      <code>PropertyChanged</code>        ,  ,     , , .        ,       . <br> <br>   <i>INotifyDataErrorInfo</i> <br>   ,     ,    ,   ,   <code>IDataErrorInfo</code> ,  ( Silverlight)   <code>INotifyDataErrorInfo</code> .   <code>INotifyDataErrorInfo</code>   ,         ,    ,  ,   ,    . <br> <br>       <code>INotifyDataErrorInfo</code> : ,     ,  ,     ,     <code>ErrorsChanged</code> ,      <code>GetErrors</code> , . <br> <br>    <br>     ,      ,     .       ,         <code>GetErrors</code>       ,  ,  ,   .    , ,  ,     ,        .   ,        . <br> <br> <code class="cs">//  . var notifyErrorInfo = (INotifyDataErrorInfo)question; question.Response = -15; Assert.IsTrue(notifyErrorInfo.GetErrors("Response").Cast&lt;ValidationResult&gt;().Any()); //  . var notifyErrorInfo = (INotifyDataErrorInfo)question; question.Response = 15; Assert.IsFalse(notifyErrorInfo.GetErrors("Response").Cast&lt;ValidationResult&gt;().Any());</code> <br>    ,    ,             . <br> <br>    <i>INotifyDataErrorInfo</i> <br>       <code>GetErrors</code> ,   <code>INotifyDataErrorInfo</code>  ,   <code>ErrorsChanged</code>      <code>GetErrors</code> . ,  <code>HasErrors</code>      ,  . <br> <br>       <code>INotifyDataErrorInfo</code> . , ,           ,   -  .      ,        <code>INotifyDataErrorInfo</code>         (,        ). <br> <br>     ,   ,  : <br>  <code>HasErrors</code>     .              ,       .  <code>ErrorsChanged</code> ,      ,         <code>GetErrors</code> .         ( ,  )     ,           .    <code>GetErrors</code>       <code>ErrorsChanged</code> . <br>    <code>INotifyPropertyChanged</code> ,  ,    <code>NotifyDataErrorInfoTestHelper</code>    MVVM,        <code>INotifyDataErrorInfo</code> ,       .   ,   ,      ,   .      . <br> <code class="cs">var helper = new NotifyDataErrorInfoTestHelper&lt;NumericQuestion, int?&gt;( question, q =&gt; q.Response); helper.ValidatePropertyChange( 6, NotifyDataErrorInfoBehavior.Nothing); helper.ValidatePropertyChange( 20, NotifyDataErrorInfoBehavior.FiresErrorsChanged | NotifyDataErrorInfoBehavior.HasErrors | NotifyDataErrorInfoBehavior.HasErrorsForProperty); helper.ValidatePropertyChange( null, NotifyDataErrorInfoBehavior.FiresErrorsChanged | NotifyDataErrorInfoBehavior.HasErrors | NotifyDataErrorInfoBehavior.HasErrorsForProperty); helper.ValidatePropertyChange( 2, NotifyDataErrorInfoBehavior.FiresErrorsChanged);</code> <br>     <br>   MVVM,     ,  .   ,    ,         . <br> <br>  ,     ,     ,       .   ,   , ,       ,     ,   <code>IAsyncResult</code>    ,  - ,   ,    UI. <br> <br>       , , ,    .   ,     .  ,      UI,     ,   ,          ,     ,        "   UI." <br> <br>     ,    ,    .   ,    ,     mock-, ,   ,   ,      ,          . <br> <br>           UI,    ,    .   ,     ,   ,      .        ,   .     ,    ,     . <br> <br> <code class="cs">questionnaireRepositoryMock .Setup( r =&gt; r.SubmitQuestionnaireAsync( It.IsAny&lt;Questionnaire&gt;(), It.IsAny&lt;Action&lt;IOperationResult&gt;&gt;())) .Callback&lt;Questionnaire, Action&lt;IOperationResult&gt;&gt;( (q, a) =&gt; callback = a); uiServicemock .Setup(svc =&gt; svc.ShowView(ViewNames.QuestionnaireTemplatesList)) .Callback&lt;string&gt;(viewName =&gt; requestedViewName = viewName); submitResultMock .Setup(sr =&gt; sr.Error) .Returns&lt;Exception&gt;(null); CompleteQuestionnaire(viewModel); viewModel.Submit(); //      UI . callback(submitResultMock.Object); //    ‚Äì     . Assert.AreEqual(ViewNames.QuestionnaireTemplatesList, requestedViewName);</code> <br> <b></b> <br>          ,        . <br>   <br>       , . "Trees in WPF"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ms753391.aspx">http://msdn.microsoft.com/en-us/library/ms753391.aspx</a> <br> <br>       , . "Attached Properties Overview"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/cc265152(VS.95).aspx">http://msdn.microsoft.com/en-us/library/cc265152(VS.95).aspx</a> <br> <br>      MEF, ."Managed Extensibility Framework Overview"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/dd460648.aspx">http://msdn.microsoft.com/en-us/library/dd460648.aspx</a> . <br> <br>      Unity, ."Unity Application Block"  MSDN: <a href="http://www.msdn.com/unity">http://www.msdn.com/unity</a> . <br> <br>      <code>DelegateCommand</code> , .Chapter 5, " <a href="http://msdn.microsoft.com/en-us/library/gg405484(v%3DPandP.40).aspx">Implementing the MVVM Pattern</a> ." <br> <br>        Microsoft Expression Blend, ."Working with built-in behaviors"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ff724013(v%3DExpression.40).aspx">http://msdn.microsoft.com/en-us/library/ff724013(v=Expression.40).aspx</a> . <br> <br>          Microsoft Expression Blend, ."Creating Custom Behaviors"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ff724708(v%3DExpression.40).aspx">http://msdn.microsoft.com/en-us/library/ff724708(v=Expression.40).aspx</a> . <br> <br>            Microsoft Expression Blend, ."Creating Custom Triggers and Actions"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ff724707(v%3DExpression.40).aspx">http://msdn.microsoft.com/en-us/library/ff724707(v=Expression.40).aspx</a> . <br> <br>         WPF  Silverlight, ."Threading Model"  "The Dispatcher Class"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ms741870.aspx">http://msdn.microsoft.com/en-us/library/ms741870.aspx</a> <br> <a href="http://msdn.microsoft.com/en-us/library/ms615907(v%3DVS.95).aspx">http://msdn.microsoft.com/en-us/library/ms615907(v=VS.95).aspx</a> . <br> <br>      unit-  Silverlight, ."Unit Testing with Silverlight 2": <a href="http://www.jeff.wilcox.name/2008/03/silverlight2-unit-testing/">http://www.jeff.wilcox.name/2008/03/silverlight2-unit-testing/</a> . <br> <br>         , .  " <a href="http://msdn.microsoft.com/en-us/library/gg430861(v%3DPandP.40).aspx">View-Based Navigation</a> " in Chapter 8, " <a href="http://msdn.microsoft.com/en-us/library/gg430861(v%3DPandP.40).aspx">Navigation</a> ." <br> <br>       ,   , ."Event-based Asynchronous Pattern Overview"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/wewwczdw.aspx">http://msdn.microsoft.com/en-us/library/wewwczdw.aspx</a> <br> <br>        <code>IAsyncResult</code> , ."Asynchronous Programming Overview"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ms228963.aspx">http://msdn.microsoft.com/en-us/library/ms228963.aspx</a></code></code></code></code></code></code></code></code></code> <blockquote> <code><code><code><code><code><code><code><code><code><code>CommandBehaviorBase ,    ,    ICommand</code> .           <code>CanExecuteChanged</code> ,          Silverlight,    WPF. <br> <br>    ,  ,   <code>CommandBehaviorBase    ,    .         ,      .         ,    .      ButtonBaseClickCommandBehavior</code> . <br> <br> <code class="cs">public class ButtonBaseClickCommandBehavior : CommandBehaviorBase&lt;ButtonBase&gt; { public ButtonBaseClickCommandBehavior(ButtonBase clickableObject) : base(clickableObject) { clickableObject.Click += OnClick; } private void OnClick(object sender, System.Windows.RoutedEventArgs e) { ExecuteCommand(); } }</code> <br>   <code>CommandBehaviorBase ,     .     ,          ,   . ,    ,    ,      , ,    CanExecute</code>  ,     . <br> <br>          ,   .           XAML.           .       .  Prism      ,       ,  ,   .       ,    . , ,  ,      <code>Click</code> ,       <code>Command</code> .    <code>Click.Command</code> ,  . <br> <br>             .             . <br> <br> <code class="cs">public static readonly DependencyProperty CommandProperty = DependencyProperty.RegisterAttached( "Command", typeof(ICommand), typeof(Click), new PropertyMetadata(OnSetCommandCallback)); private static readonly DependencyProperty ClickCommandBehaviorProperty = DependencyProperty.RegisterAttached( "ClickCommandBehavior", typeof(ButtonBaseClickCommandBehavior), typeof(Click), null);</code> <br>    <code>Command</code>    <code>ButtonBaseClickCommandBehavior</code> ,     <code>OnSetCommandCallback</code> ,     . <br> <br> <code class="cs">private static void OnSetCommandCallback(DependencyObject dependencyObject, DependencyPropertyChangedEventArgs e) { ButtonBase buttonBase = dependencyObject as ButtonBase; if (buttonBase != null) { ButtonBaseClickCommandBehavior behavior = GetOrCreateBehavior(buttonBase); behavior.Command = e.NewValue as ICommand; } } private static void OnSetCommandParameterCallback(DependencyObject dependencyObject, DependencyPropertyChangedEventArgs e) { ButtonBase buttonBase = dependencyObject as ButtonBase; if (buttonBase != null) { ButtonBaseClickCommandBehavior behavior = GetOrCreateBehavior(buttonBase); behavior.CommandParameter = e.NewValue; } } private static ButtonBaseClickCommandBehavior GetOrCreateBehavior(ButtonBase buttonBase ) { ButtonBaseClickCommandBehavior behavior = buttonBase.GetValue(ClickCommandBehaviorProperty) as ButtonBaseClickCommandBehavior; if ( behavior == null ) { behavior = new ButtonBaseClickCommandBehavior(buttonBase); buttonBase.SetValue(ClickCommandBehaviorProperty, behavior); } return behavior; }</code> <br>        ,  <a href="http://msdn.microsoft.com/en-us/library/cc265152(VS.95).aspx">Attached Properties Overview</a>  MSDN. <br> <br>    <br>              . ,     Silverlight,    -,     ,      ,     .     ,       . <br> <br>        ,    ( )  ,  ,     .  UI       ,            UI. <br> <br>      - <br>   -     ,       <code>IAsyncResult</code> .   ,  ,   ,  <code>GetQuestionnaire</code> ,   : <code>BeginGetQuestionnaire</code>  <code>EndGetQuestionnaire</code> .    ,   <code>BeginGetQuestionnaire</code> .     ,   ,   <code>EndGetQuestionnaire</code>    . <br> <b></b> <br>  .NET Framework 4.5      <code>await</code>  <code>async</code>     <code>*Async</code> .      <a href="http://msdn.microsoft.com/en-us/library/vstudio/hh391443.aspx">"Asynchronous Programming with Async and Await (C# and Visual Basic)"</a> . <br>  ,    <code>EndGetQuestionnaire</code> ,      ,  ()      <code>BeginGetQuestionnaire</code> .     ,      ,   <code>EndGetQuestionnaire</code> ,   . <br> <br> <code class="xml">IAsyncResult asyncResult = this.service.BeginGetQuestionnaire( GetQuestionnaireCompleted, null //  ,      ); private void GetQuestionnaireCompleted(IAsyncResult result) { try { questionnaire = this.service.EndGetQuestionnaire(ar); } catch (Exception ex) { //  -   . } }</code> <br>  ,     <code>End*</code> (  , <code>EndGetQuestionnaire</code> ),    ,      .      , ,          UI.     ,   ,        . <br> <br>        UI,     -,      UI,         UI,   <code>Dispatcher</code>    <code>SynchronizationContext</code> .  WPF  Silverlight,   <code>Dispatcher</code> . <br> <br>      <code>Questionnaire</code>  ,        <code>QuestionnaireView</code> .  Silverlight    <code>CheckAccess</code> ,  ,      UI.  ,     <code>BeginInvoke</code> ,      UI. <br> <br> <code class="cs">var dispatcher = System.Windows.Deployment.Current.Dispatcher; if (dispatcher.CheckAccess()) { QuestionnaireView.DataContext = questionnaire; } else { dispatcher.BeginInvoke(() =&gt; { Questionnaire.DataContext = questionnaire; }); }</code> <br> <i>MVVM RI</i>   ,    ,   <code>IAsyncResult</code> ,   .      ,                 . ,       . <br> <br> <code class="cs">this.questionnaireRepository.GetQuestionnaireAsync( result =&gt; { this.Questionnaire = result.Result; });</code> <br>  <code>result</code>   ,     , , , .    ,     . <br> <br> <code class="cs">this.questionnaireRepository.GetQuestionnaireAsync( result =&gt; { if (result.Error == null) { this.Questionnaire = result.Result; ... } else { // Handle error. } })</code> <br>     <br>        ,      .     , ,             .        ,      ,     ,     . <br> <br>         ,      MVVM,     ,   . ,  -MVVM ,     <code>MessageBox</code>   code-behind UI,      .   MVVM     ,          . <br> <br>     MVVM,              ,          .      ,    ,   ,  ,     . <br> <br>              MVVM.      ,     ,     ,  ,     .    ,         ,     ,          .       . <br> <br>    <br>                  .        ,        .  ,         .         . <br> <br>  ,         ,         ,  .      ,     .           ,       . ,        WPF  Silverlight,        . <br> <br> <img title="Using the service to interact with the user." src="https://habrastorage.org/getpro/habr/post_images/4b5/397/f2d/4b5397f2d02e5851195b29f1893be6fc.png" alt=" ,    ."> <br> <br>  ,   <code>MessageBox</code>        ,     ,    ,     . <br> <br> <code class="cs">var result = interactionService.ShowMessageBox( "Are you sure you want to cancel this operation?", "Confirm", MessageBoxButton.OK); if (result == MessageBoxResult.Yes) { CancelRequest(); }</code> <br> ,      - ,      ,         Silverlight.         .             .     . <br> <br> <code class="cs">interactionService.ShowMessageBox( "Are you sure you want to cancel this operation?", "Confirm", MessageBoxButton.OK, result =&gt; { if (result == MessageBoxResult.Yes) { CancelRequest(); } });</code> <br>         ,      . ,  WPF    <code>MessageBox</code> ,       ;    Silverlight    ,    . <br> <br>     <br>         ‚Äì             .         ,      .     ,     .        ,        ,   ,     . <br> <br> <img title="Using interaction request objects." src="https://habrastorage.org/getpro/habr/post_images/3d0/ff0/1c5/3d0ff01c5518558c2d3c5c5f47ce0ce9.png" alt="   ."> <br> <br>    ,   ,          ‚Äì       ,      ,   ‚Äì     .   ,        ,    ,    UI            . <br> <br>       MVVM,     ,       ,         .         ,        ,    ,   . <br> <br>  Prism       <code>IInteractionRequest</code>   <code>InteractionRequest .  IInteractionRequest</code>  ,   .           ,   .  <code>InteractionRequest   IInteractionRequest</code>     <code>Raise</code> ,           , , ,   . <br> <br>       <br>  <code>InteractionRequest          .  Raise</code>          ( <code>T</code> )    ,    ,   .          ,       .      ,        .    ,  ,     . <br> <code class="cs">public interface IInteractionRequest { event EventHandler&lt;InteractionRequestedEventArgs&gt; Raised; } public class InteractionRequest&lt;T&gt; : IInteractionRequest { public event EventHandler&lt;InteractionRequestedEventArgs&gt; Raised; public void Raise(T context, Action&lt;T&gt; callback) { var handler = this.Raised; if (handler != null) { handler( this, new InteractionRequestedEventArgs(context, () =&gt; callback(context))); } } }</code> <br> Prism    ,      .  <code>Notification</code>       .    ,            .     ‚Äì <code>Title</code>  <code>Content</code> ,    .  ,   ,  ,  ,        . <br> <br>  <code>Confirmation</code>    <code>Notification</code>     ‚Äì <code>Confirmed</code> ,  ,  ,      .  <code>Confirmation</code> ,     <code>MessageBox</code> ,     /  .     ,     <code>Notification</code> ,     ,      . <br> <br>    <code>InteractionRequest ,       InteractionRequest      ,      .      ,    Raise</code> ,    , ,   . <br> <br> <code class="cs">public IInteractionRequest ConfirmCancelInteractionRequest { get { return this.confirmCancelInteractionRequest; } } this.confirmCancelInteractionRequest.Raise( new Confirmation("Are you sure you wish to cancel?"), confirmation =&gt; { if (confirmation.Confirmed) { this.NavigateToQuestionnaireList(); } }); }</code> <br> <i>MVVM Reference Implementation (MVVM RI)</i> ,    <code>IInteractionRequest</code>   <code>InteractionRequest ,          (. QuestionnaireViewModel.cs</code> ). <br> <br>        <br>       ,       .   ,       .    UI             . <br> <br>                . Microsoft Expression Blend Behaviors Framework     .  ,     ,    . <br> <br>  <code>EventTrigger</code> ,  Expression Blend,  ,      ,     ,   . , Prism   <code>EventTrigger</code> ,  <code>InteractionRequestTrigger</code> ,      <code>Raised</code>   <code>IInteractionRequest</code> .    XAML        . <br> <br>  ,   , <code>InteractionRequestTrigger</code>   .  Silverlight Prism   <code>PopupChildWindowAction</code> ,     .    ,         .   <code>ContentTemplate</code>  <code>PopupChildWindowAction</code> ,    ,    UI,      <code>Content</code>  .       <code>Title</code>  . <br> <b></b> <br>  ,    ,   <code>PopupChildWindowAction</code> ,     .    <code>Notification</code>  <code>NotificationChildWindow</code> ,        <code>Confirmation</code> ‚Äì <code>ConfirmationChildWindow</code> . <code>NotificationChildWindow</code>    ,   ,     <code>ConfirmationChildWindow</code>    <i>OK</i>  <i>Cancel</i> ,    .    ,   ,   <code>ChildWindow</code>  <code>PopupChildWindowAction</code> . <br>   ,  <code>InteractionRequestTrigger</code>  <code>PopupChildWindowAction</code> ,       <i>RI MVVM</i> . <br> <br> <code class="xml">&lt;i:Interaction.Triggers&gt; &lt;prism:InteractionRequestTrigger SourceObject="{Binding ConfirmCancelInteractionRequest}"&gt; &lt;prism:PopupChildWindowAction ContentTemplate="{StaticResource ConfirmWindowTemplate}"/&gt; &lt;/prism:InteractionRequestTrigger&gt; &lt;/i:Interaction.Triggers&gt; &lt;UserControl.Resources&gt; &lt;DataTemplate x:Key="ConfirmWindowTemplate"&gt; &lt;Grid MinWidth="250" MinHeight="100"&gt; &lt;TextBlock TextWrapping="Wrap" Grid.Row="0" Text="{Binding}"/&gt; &lt;/Grid&gt; &lt;/DataTemplate&gt; &lt;/UserControl.Resources&gt;</code> <br> <b></b> <br>      <code>ContentTemplate</code> ,   UI   <code>Content</code>  .    <code>Content</code>  ,  , <code>TextBlock</code>     <code>Content</code> . <br>      ,     ,    ,    .  ,     ,       ,     ,    .   ,   <i>RI MVVM</i> ,         <code>Confirmed</code>    <code>Confirmation</code>  <code>true</code> ,     OK. <br> <br>        ,     .  Prism <code>InteractionRequestTrigger</code>   <code>PopupChildWindowAction</code>            . <br> <br>     <br>     MVVM,       , ,    ,         .        (  , ,  ,   ).    ,  ,  ,            . <br> <br>        ,         . Managed Extensibility Framework (MEF)  Unity Application Block (Unity)      ,  ,           . <br> <br>  ,       , , ,    ( )      . ,       ,     .  ,     ,       . <br> <br>     ,  MEF <br>  MEF,       ,   <code>Import</code> ,      ,  ,   <code>Export</code> .         ,    . <br> <br> , <code>QuestionnaireView</code>   <i>RI MVVM</i> ,        ,    <code>Import</code> .   , MEF           .  <code>set</code>        ,   . <br> <br> <code class="cs">[Import] public QuestionnaireViewModel ViewModel { set { this.DataContext = value; } }</code> <br>     ,   . <br> <br> <code class="cs">[Export] public class QuestionnaireViewModel : NotificationObject { ... }</code> <br>        ,   . <br> <br> <code class="cs">public QuestionnaireView() { InitializeComponent(); } [ImportingConstructor] public QuestionnaireView(QuestionnaireViewModel viewModel) : this() { this.DataContext = viewModel; }</code> <br> <b></b> <br>          MEF,   Unity.   ,     ,        .   ,   Visual Studio  Expression Blend, ,        ,     .   ,   ,  ,      ,          <code>InitializeComponent</code> . <br>     ,  Unity <br>  Unity,    ,   MEF.     ,      .    ,         .  ,      . <br> <br>  ,      ,  ,         . ,           ,   . <br> <br> <code class="cs">public QuestionnaireView() { InitializeComponent(); } public QuestionnaireView(QuestionnaireViewModel viewModel) : this() { this.DataContext = viewModel; }</code> <br> <b></b> <br>    ,        ,   Visual Studio  Expression Blend. <br>  ,          ,   . Unity        <code>set</code>   ,   . <br> <br> <code class="cs">public QuestionnaireView() { InitializeComponent(); } [Dependency] public QuestionnaireViewModel ViewModel { set { this.DataContext = value; } }</code> <br>       Unity. <br> <br> <code class="cs">container.RegisterType&lt;QuestionnaireViewModel&gt;();</code> <br>  ,     . <br> <br> <code class="cs">var view = container.Resolve&lt;QuestionnaireView&gt;();</code> <br>     ,    <br>   ,     ,        .        ,   MEF  Unity,        . <br> <br>          .   ,         UI,           . <br> <br> , <i>RI MVVM</i>   ,   ,        .   ,    .      <code>ShowView</code>   UI. <br> <br> <code class="cs">private void NavigateToQuestionnaireList() { //     "questionnaire list". this.uiService.ShowView(ViewNames.QuestionnaireTemplatesList); }</code> <br>  UI      UI .           UI.  <code>ShowView</code>  <code>UIService</code>      (,          ),       ,   . <br> <br> <code class="cs">public void ShowView(string viewName) { var view = this.ViewFactory.GetView(viewName); this.MainWindow.CurrentView = view; }</code> <br> <b></b> <br> Prism       .   ,   ,   ,             .    ,  , " <a href="http://msdn.microsoft.com/en-us/library/gg430861(v%3DPandP.40).aspx">View-Based Navigation</a> "   8, " <a href="http://msdn.microsoft.com/en-us/library/gg430861(v%3DPandP.40).aspx">Navigation</a> ". <br>  MVVM  <br>        MVVM      .           -      mocking . ,   ,        . <br> <br>   <i>INotifyPropertyChanged</i> <br>   <code>INotifyPropertyChanged</code>     ,      .      ,    ;   ,   ,     ,    ,       . <br> <br>   <br> ,       ,           <code>PropertyChanged</code>  ,         .  ,    <code>ChangeTracker</code> ,     MVVM,  ,      .      .     ,    . <br> <br> <code class="cs">var changeTracker = new PropertyChangeTracker(viewModel); viewModel.CurrentState = "newState"; CollectionAssert.Contains(changeTracker.ChangedProperties, "CurrentState");</code> <br> ,     ,     <code>INotifyPropertyChanged</code> ,    ,   ,     . <br> <br>      <br>        ,   ,    <code>set</code>      ,           . ,     ,     ,      ,          . <br> <br> <code class="cs">var changeTracker = new PropertyChangeTracker(viewModel); var question = viewModel.Questions.First() as OpenQuestionViewModel; question.Question.Response = "some text"; CollectionAssert.Contains(changeTracker.ChangedProperties, "UnansweredQuestions");</code> <br>      <br>     <code>INotifyPropertyChanged</code> ,      <code>PropertyChanged</code>        ,  ,     , , .        ,       . <br> <br>   <i>INotifyDataErrorInfo</i> <br>   ,     ,    ,   ,   <code>IDataErrorInfo</code> ,  ( Silverlight)   <code>INotifyDataErrorInfo</code> .   <code>INotifyDataErrorInfo</code>   ,         ,    ,  ,   ,    . <br> <br>       <code>INotifyDataErrorInfo</code> : ,     ,  ,     ,     <code>ErrorsChanged</code> ,      <code>GetErrors</code> , . <br> <br>    <br>     ,      ,     .       ,         <code>GetErrors</code>       ,  ,  ,   .    , ,  ,     ,        .   ,        . <br> <br> <code class="cs">//  . var notifyErrorInfo = (INotifyDataErrorInfo)question; question.Response = -15; Assert.IsTrue(notifyErrorInfo.GetErrors("Response").Cast&lt;ValidationResult&gt;().Any()); //  . var notifyErrorInfo = (INotifyDataErrorInfo)question; question.Response = 15; Assert.IsFalse(notifyErrorInfo.GetErrors("Response").Cast&lt;ValidationResult&gt;().Any());</code> <br>    ,    ,             . <br> <br>    <i>INotifyDataErrorInfo</i> <br>       <code>GetErrors</code> ,   <code>INotifyDataErrorInfo</code>  ,   <code>ErrorsChanged</code>      <code>GetErrors</code> . ,  <code>HasErrors</code>      ,  . <br> <br>       <code>INotifyDataErrorInfo</code> . , ,           ,   -  .      ,        <code>INotifyDataErrorInfo</code>         (,        ). <br> <br>     ,   ,  : <br>  <code>HasErrors</code>     .              ,       .  <code>ErrorsChanged</code> ,      ,         <code>GetErrors</code> .         ( ,  )     ,           .    <code>GetErrors</code>       <code>ErrorsChanged</code> . <br>    <code>INotifyPropertyChanged</code> ,  ,    <code>NotifyDataErrorInfoTestHelper</code>    MVVM,        <code>INotifyDataErrorInfo</code> ,       .   ,   ,      ,   .      . <br> <code class="cs">var helper = new NotifyDataErrorInfoTestHelper&lt;NumericQuestion, int?&gt;( question, q =&gt; q.Response); helper.ValidatePropertyChange( 6, NotifyDataErrorInfoBehavior.Nothing); helper.ValidatePropertyChange( 20, NotifyDataErrorInfoBehavior.FiresErrorsChanged | NotifyDataErrorInfoBehavior.HasErrors | NotifyDataErrorInfoBehavior.HasErrorsForProperty); helper.ValidatePropertyChange( null, NotifyDataErrorInfoBehavior.FiresErrorsChanged | NotifyDataErrorInfoBehavior.HasErrors | NotifyDataErrorInfoBehavior.HasErrorsForProperty); helper.ValidatePropertyChange( 2, NotifyDataErrorInfoBehavior.FiresErrorsChanged);</code> <br>     <br>   MVVM,     ,  .   ,    ,         . <br> <br>  ,     ,     ,       .   ,   , ,       ,     ,   <code>IAsyncResult</code>    ,  - ,   ,    UI. <br> <br>       , , ,    .   ,     .  ,      UI,     ,   ,          ,     ,        "   UI." <br> <br>     ,    ,    .   ,    ,     mock-, ,   ,   ,      ,          . <br> <br>           UI,    ,    .   ,     ,   ,      .        ,   .     ,    ,     . <br> <br> <code class="cs">questionnaireRepositoryMock .Setup( r =&gt; r.SubmitQuestionnaireAsync( It.IsAny&lt;Questionnaire&gt;(), It.IsAny&lt;Action&lt;IOperationResult&gt;&gt;())) .Callback&lt;Questionnaire, Action&lt;IOperationResult&gt;&gt;( (q, a) =&gt; callback = a); uiServicemock .Setup(svc =&gt; svc.ShowView(ViewNames.QuestionnaireTemplatesList)) .Callback&lt;string&gt;(viewName =&gt; requestedViewName = viewName); submitResultMock .Setup(sr =&gt; sr.Error) .Returns&lt;Exception&gt;(null); CompleteQuestionnaire(viewModel); viewModel.Submit(); //      UI . callback(submitResultMock.Object); //    ‚Äì     . Assert.AreEqual(ViewNames.QuestionnaireTemplatesList, requestedViewName);</code> <br> <b></b> <br>          ,        . <br>   <br>       , . "Trees in WPF"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ms753391.aspx">http://msdn.microsoft.com/en-us/library/ms753391.aspx</a> <br> <br>       , . "Attached Properties Overview"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/cc265152(VS.95).aspx">http://msdn.microsoft.com/en-us/library/cc265152(VS.95).aspx</a> <br> <br>      MEF, ."Managed Extensibility Framework Overview"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/dd460648.aspx">http://msdn.microsoft.com/en-us/library/dd460648.aspx</a> . <br> <br>      Unity, ."Unity Application Block"  MSDN: <a href="http://www.msdn.com/unity">http://www.msdn.com/unity</a> . <br> <br>      <code>DelegateCommand</code> , .Chapter 5, " <a href="http://msdn.microsoft.com/en-us/library/gg405484(v%3DPandP.40).aspx">Implementing the MVVM Pattern</a> ." <br> <br>        Microsoft Expression Blend, ."Working with built-in behaviors"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ff724013(v%3DExpression.40).aspx">http://msdn.microsoft.com/en-us/library/ff724013(v=Expression.40).aspx</a> . <br> <br>          Microsoft Expression Blend, ."Creating Custom Behaviors"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ff724708(v%3DExpression.40).aspx">http://msdn.microsoft.com/en-us/library/ff724708(v=Expression.40).aspx</a> . <br> <br>            Microsoft Expression Blend, ."Creating Custom Triggers and Actions"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ff724707(v%3DExpression.40).aspx">http://msdn.microsoft.com/en-us/library/ff724707(v=Expression.40).aspx</a> . <br> <br>         WPF  Silverlight, ."Threading Model"  "The Dispatcher Class"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ms741870.aspx">http://msdn.microsoft.com/en-us/library/ms741870.aspx</a> <br> <a href="http://msdn.microsoft.com/en-us/library/ms615907(v%3DVS.95).aspx">http://msdn.microsoft.com/en-us/library/ms615907(v=VS.95).aspx</a> . <br> <br>      unit-  Silverlight, ."Unit Testing with Silverlight 2": <a href="http://www.jeff.wilcox.name/2008/03/silverlight2-unit-testing/">http://www.jeff.wilcox.name/2008/03/silverlight2-unit-testing/</a> . <br> <br>         , .  " <a href="http://msdn.microsoft.com/en-us/library/gg430861(v%3DPandP.40).aspx">View-Based Navigation</a> " in Chapter 8, " <a href="http://msdn.microsoft.com/en-us/library/gg430861(v%3DPandP.40).aspx">Navigation</a> ." <br> <br>       ,   , ."Event-based Asynchronous Pattern Overview"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/wewwczdw.aspx">http://msdn.microsoft.com/en-us/library/wewwczdw.aspx</a> <br> <br>        <code>IAsyncResult</code> , ."Asynchronous Programming Overview"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ms228963.aspx">http://msdn.microsoft.com/en-us/library/ms228963.aspx</a></code></code></code></code></code></code></code></code></code> </blockquote> <code><code><code><code><code><code><code><code><code><code>CommandBehaviorBase ,    ,    ICommand</code> .           <code>CanExecuteChanged</code> ,          Silverlight,    WPF. <br> <br>    ,  ,   <code>CommandBehaviorBase    ,    .         ,      .         ,    .      ButtonBaseClickCommandBehavior</code> . <br> <br> <code class="cs">public class ButtonBaseClickCommandBehavior : CommandBehaviorBase&lt;ButtonBase&gt; { public ButtonBaseClickCommandBehavior(ButtonBase clickableObject) : base(clickableObject) { clickableObject.Click += OnClick; } private void OnClick(object sender, System.Windows.RoutedEventArgs e) { ExecuteCommand(); } }</code> <br>   <code>CommandBehaviorBase ,     .     ,          ,   . ,    ,    ,      , ,    CanExecute</code>  ,     . <br> <br>          ,   .           XAML.           .       .  Prism      ,       ,  ,   .       ,    . , ,  ,      <code>Click</code> ,       <code>Command</code> .    <code>Click.Command</code> ,  . <br> <br>             .             . <br> <br> <code class="cs">public static readonly DependencyProperty CommandProperty = DependencyProperty.RegisterAttached( "Command", typeof(ICommand), typeof(Click), new PropertyMetadata(OnSetCommandCallback)); private static readonly DependencyProperty ClickCommandBehaviorProperty = DependencyProperty.RegisterAttached( "ClickCommandBehavior", typeof(ButtonBaseClickCommandBehavior), typeof(Click), null);</code> <br>    <code>Command</code>    <code>ButtonBaseClickCommandBehavior</code> ,     <code>OnSetCommandCallback</code> ,     . <br> <br> <code class="cs">private static void OnSetCommandCallback(DependencyObject dependencyObject, DependencyPropertyChangedEventArgs e) { ButtonBase buttonBase = dependencyObject as ButtonBase; if (buttonBase != null) { ButtonBaseClickCommandBehavior behavior = GetOrCreateBehavior(buttonBase); behavior.Command = e.NewValue as ICommand; } } private static void OnSetCommandParameterCallback(DependencyObject dependencyObject, DependencyPropertyChangedEventArgs e) { ButtonBase buttonBase = dependencyObject as ButtonBase; if (buttonBase != null) { ButtonBaseClickCommandBehavior behavior = GetOrCreateBehavior(buttonBase); behavior.CommandParameter = e.NewValue; } } private static ButtonBaseClickCommandBehavior GetOrCreateBehavior(ButtonBase buttonBase ) { ButtonBaseClickCommandBehavior behavior = buttonBase.GetValue(ClickCommandBehaviorProperty) as ButtonBaseClickCommandBehavior; if ( behavior == null ) { behavior = new ButtonBaseClickCommandBehavior(buttonBase); buttonBase.SetValue(ClickCommandBehaviorProperty, behavior); } return behavior; }</code> <br>        ,  <a href="http://msdn.microsoft.com/en-us/library/cc265152(VS.95).aspx">Attached Properties Overview</a>  MSDN. <br> <br>    <br>              . ,     Silverlight,    -,     ,      ,     .     ,       . <br> <br>        ,    ( )  ,  ,     .  UI       ,            UI. <br> <br>      - <br>   -     ,       <code>IAsyncResult</code> .   ,  ,   ,  <code>GetQuestionnaire</code> ,   : <code>BeginGetQuestionnaire</code>  <code>EndGetQuestionnaire</code> .    ,   <code>BeginGetQuestionnaire</code> .     ,   ,   <code>EndGetQuestionnaire</code>    . <br> <b></b> <br>  .NET Framework 4.5      <code>await</code>  <code>async</code>     <code>*Async</code> .      <a href="http://msdn.microsoft.com/en-us/library/vstudio/hh391443.aspx">"Asynchronous Programming with Async and Await (C# and Visual Basic)"</a> . <br>  ,    <code>EndGetQuestionnaire</code> ,      ,  ()      <code>BeginGetQuestionnaire</code> .     ,      ,   <code>EndGetQuestionnaire</code> ,   . <br> <br> <code class="xml">IAsyncResult asyncResult = this.service.BeginGetQuestionnaire( GetQuestionnaireCompleted, null //  ,      ); private void GetQuestionnaireCompleted(IAsyncResult result) { try { questionnaire = this.service.EndGetQuestionnaire(ar); } catch (Exception ex) { //  -   . } }</code> <br>  ,     <code>End*</code> (  , <code>EndGetQuestionnaire</code> ),    ,      .      , ,          UI.     ,   ,        . <br> <br>        UI,     -,      UI,         UI,   <code>Dispatcher</code>    <code>SynchronizationContext</code> .  WPF  Silverlight,   <code>Dispatcher</code> . <br> <br>      <code>Questionnaire</code>  ,        <code>QuestionnaireView</code> .  Silverlight    <code>CheckAccess</code> ,  ,      UI.  ,     <code>BeginInvoke</code> ,      UI. <br> <br> <code class="cs">var dispatcher = System.Windows.Deployment.Current.Dispatcher; if (dispatcher.CheckAccess()) { QuestionnaireView.DataContext = questionnaire; } else { dispatcher.BeginInvoke(() =&gt; { Questionnaire.DataContext = questionnaire; }); }</code> <br> <i>MVVM RI</i>   ,    ,   <code>IAsyncResult</code> ,   .      ,                 . ,       . <br> <br> <code class="cs">this.questionnaireRepository.GetQuestionnaireAsync( result =&gt; { this.Questionnaire = result.Result; });</code> <br>  <code>result</code>   ,     , , , .    ,     . <br> <br> <code class="cs">this.questionnaireRepository.GetQuestionnaireAsync( result =&gt; { if (result.Error == null) { this.Questionnaire = result.Result; ... } else { // Handle error. } })</code> <br>     <br>        ,      .     , ,             .        ,      ,     ,     . <br> <br>         ,      MVVM,     ,   . ,  -MVVM ,     <code>MessageBox</code>   code-behind UI,      .   MVVM     ,          . <br> <br>     MVVM,              ,          .      ,    ,   ,  ,     . <br> <br>              MVVM.      ,     ,     ,  ,     .    ,         ,     ,          .       . <br> <br>    <br>                  .        ,        .  ,         .         . <br> <br>  ,         ,         ,  .      ,     .           ,       . ,        WPF  Silverlight,        . <br> <br> <img title="Using the service to interact with the user." src="https://habrastorage.org/getpro/habr/post_images/4b5/397/f2d/4b5397f2d02e5851195b29f1893be6fc.png" alt=" ,    ."> <br> <br>  ,   <code>MessageBox</code>        ,     ,    ,     . <br> <br> <code class="cs">var result = interactionService.ShowMessageBox( "Are you sure you want to cancel this operation?", "Confirm", MessageBoxButton.OK); if (result == MessageBoxResult.Yes) { CancelRequest(); }</code> <br> ,      - ,      ,         Silverlight.         .             .     . <br> <br> <code class="cs">interactionService.ShowMessageBox( "Are you sure you want to cancel this operation?", "Confirm", MessageBoxButton.OK, result =&gt; { if (result == MessageBoxResult.Yes) { CancelRequest(); } });</code> <br>         ,      . ,  WPF    <code>MessageBox</code> ,       ;    Silverlight    ,    . <br> <br>     <br>         ‚Äì             .         ,      .     ,     .        ,        ,   ,     . <br> <br> <img title="Using interaction request objects." src="https://habrastorage.org/getpro/habr/post_images/3d0/ff0/1c5/3d0ff01c5518558c2d3c5c5f47ce0ce9.png" alt="   ."> <br> <br>    ,   ,          ‚Äì       ,      ,   ‚Äì     .   ,        ,    ,    UI            . <br> <br>       MVVM,     ,       ,         .         ,        ,    ,   . <br> <br>  Prism       <code>IInteractionRequest</code>   <code>InteractionRequest .  IInteractionRequest</code>  ,   .           ,   .  <code>InteractionRequest   IInteractionRequest</code>     <code>Raise</code> ,           , , ,   . <br> <br>       <br>  <code>InteractionRequest          .  Raise</code>          ( <code>T</code> )    ,    ,   .          ,       .      ,        .    ,  ,     . <br> <code class="cs">public interface IInteractionRequest { event EventHandler&lt;InteractionRequestedEventArgs&gt; Raised; } public class InteractionRequest&lt;T&gt; : IInteractionRequest { public event EventHandler&lt;InteractionRequestedEventArgs&gt; Raised; public void Raise(T context, Action&lt;T&gt; callback) { var handler = this.Raised; if (handler != null) { handler( this, new InteractionRequestedEventArgs(context, () =&gt; callback(context))); } } }</code> <br> Prism    ,      .  <code>Notification</code>       .    ,            .     ‚Äì <code>Title</code>  <code>Content</code> ,    .  ,   ,  ,  ,        . <br> <br>  <code>Confirmation</code>    <code>Notification</code>     ‚Äì <code>Confirmed</code> ,  ,  ,      .  <code>Confirmation</code> ,     <code>MessageBox</code> ,     /  .     ,     <code>Notification</code> ,     ,      . <br> <br>    <code>InteractionRequest ,       InteractionRequest      ,      .      ,    Raise</code> ,    , ,   . <br> <br> <code class="cs">public IInteractionRequest ConfirmCancelInteractionRequest { get { return this.confirmCancelInteractionRequest; } } this.confirmCancelInteractionRequest.Raise( new Confirmation("Are you sure you wish to cancel?"), confirmation =&gt; { if (confirmation.Confirmed) { this.NavigateToQuestionnaireList(); } }); }</code> <br> <i>MVVM Reference Implementation (MVVM RI)</i> ,    <code>IInteractionRequest</code>   <code>InteractionRequest ,          (. QuestionnaireViewModel.cs</code> ). <br> <br>        <br>       ,       .   ,       .    UI             . <br> <br>                . Microsoft Expression Blend Behaviors Framework     .  ,     ,    . <br> <br>  <code>EventTrigger</code> ,  Expression Blend,  ,      ,     ,   . , Prism   <code>EventTrigger</code> ,  <code>InteractionRequestTrigger</code> ,      <code>Raised</code>   <code>IInteractionRequest</code> .    XAML        . <br> <br>  ,   , <code>InteractionRequestTrigger</code>   .  Silverlight Prism   <code>PopupChildWindowAction</code> ,     .    ,         .   <code>ContentTemplate</code>  <code>PopupChildWindowAction</code> ,    ,    UI,      <code>Content</code>  .       <code>Title</code>  . <br> <b></b> <br>  ,    ,   <code>PopupChildWindowAction</code> ,     .    <code>Notification</code>  <code>NotificationChildWindow</code> ,        <code>Confirmation</code> ‚Äì <code>ConfirmationChildWindow</code> . <code>NotificationChildWindow</code>    ,   ,     <code>ConfirmationChildWindow</code>    <i>OK</i>  <i>Cancel</i> ,    .    ,   ,   <code>ChildWindow</code>  <code>PopupChildWindowAction</code> . <br>   ,  <code>InteractionRequestTrigger</code>  <code>PopupChildWindowAction</code> ,       <i>RI MVVM</i> . <br> <br> <code class="xml">&lt;i:Interaction.Triggers&gt; &lt;prism:InteractionRequestTrigger SourceObject="{Binding ConfirmCancelInteractionRequest}"&gt; &lt;prism:PopupChildWindowAction ContentTemplate="{StaticResource ConfirmWindowTemplate}"/&gt; &lt;/prism:InteractionRequestTrigger&gt; &lt;/i:Interaction.Triggers&gt; &lt;UserControl.Resources&gt; &lt;DataTemplate x:Key="ConfirmWindowTemplate"&gt; &lt;Grid MinWidth="250" MinHeight="100"&gt; &lt;TextBlock TextWrapping="Wrap" Grid.Row="0" Text="{Binding}"/&gt; &lt;/Grid&gt; &lt;/DataTemplate&gt; &lt;/UserControl.Resources&gt;</code> <br> <b></b> <br>      <code>ContentTemplate</code> ,   UI   <code>Content</code>  .    <code>Content</code>  ,  , <code>TextBlock</code>     <code>Content</code> . <br>      ,     ,    ,    .  ,     ,       ,     ,    .   ,   <i>RI MVVM</i> ,         <code>Confirmed</code>    <code>Confirmation</code>  <code>true</code> ,     OK. <br> <br>        ,     .  Prism <code>InteractionRequestTrigger</code>   <code>PopupChildWindowAction</code>            . <br> <br>     <br>     MVVM,       , ,    ,         .        (  , ,  ,   ).    ,  ,  ,            . <br> <br>        ,         . Managed Extensibility Framework (MEF)  Unity Application Block (Unity)      ,  ,           . <br> <br>  ,       , , ,    ( )      . ,       ,     .  ,     ,       . <br> <br>     ,  MEF <br>  MEF,       ,   <code>Import</code> ,      ,  ,   <code>Export</code> .         ,    . <br> <br> , <code>QuestionnaireView</code>   <i>RI MVVM</i> ,        ,    <code>Import</code> .   , MEF           .  <code>set</code>        ,   . <br> <br> <code class="cs">[Import] public QuestionnaireViewModel ViewModel { set { this.DataContext = value; } }</code> <br>     ,   . <br> <br> <code class="cs">[Export] public class QuestionnaireViewModel : NotificationObject { ... }</code> <br>        ,   . <br> <br> <code class="cs">public QuestionnaireView() { InitializeComponent(); } [ImportingConstructor] public QuestionnaireView(QuestionnaireViewModel viewModel) : this() { this.DataContext = viewModel; }</code> <br> <b></b> <br>          MEF,   Unity.   ,     ,        .   ,   Visual Studio  Expression Blend, ,        ,     .   ,   ,  ,      ,          <code>InitializeComponent</code> . <br>     ,  Unity <br>  Unity,    ,   MEF.     ,      .    ,         .  ,      . <br> <br>  ,      ,  ,         . ,           ,   . <br> <br> <code class="cs">public QuestionnaireView() { InitializeComponent(); } public QuestionnaireView(QuestionnaireViewModel viewModel) : this() { this.DataContext = viewModel; }</code> <br> <b></b> <br>    ,        ,   Visual Studio  Expression Blend. <br>  ,          ,   . Unity        <code>set</code>   ,   . <br> <br> <code class="cs">public QuestionnaireView() { InitializeComponent(); } [Dependency] public QuestionnaireViewModel ViewModel { set { this.DataContext = value; } }</code> <br>       Unity. <br> <br> <code class="cs">container.RegisterType&lt;QuestionnaireViewModel&gt;();</code> <br>  ,     . <br> <br> <code class="cs">var view = container.Resolve&lt;QuestionnaireView&gt;();</code> <br>     ,    <br>   ,     ,        .        ,   MEF  Unity,        . <br> <br>          .   ,         UI,           . <br> <br> , <i>RI MVVM</i>   ,   ,        .   ,    .      <code>ShowView</code>   UI. <br> <br> <code class="cs">private void NavigateToQuestionnaireList() { //     "questionnaire list". this.uiService.ShowView(ViewNames.QuestionnaireTemplatesList); }</code> <br>  UI      UI .           UI.  <code>ShowView</code>  <code>UIService</code>      (,          ),       ,   . <br> <br> <code class="cs">public void ShowView(string viewName) { var view = this.ViewFactory.GetView(viewName); this.MainWindow.CurrentView = view; }</code> <br> <b></b> <br> Prism       .   ,   ,   ,             .    ,  , " <a href="http://msdn.microsoft.com/en-us/library/gg430861(v%3DPandP.40).aspx">View-Based Navigation</a> "   8, " <a href="http://msdn.microsoft.com/en-us/library/gg430861(v%3DPandP.40).aspx">Navigation</a> ". <br>  MVVM  <br>        MVVM      .           -      mocking . ,   ,        . <br> <br>   <i>INotifyPropertyChanged</i> <br>   <code>INotifyPropertyChanged</code>     ,      .      ,    ;   ,   ,     ,    ,       . <br> <br>   <br> ,       ,           <code>PropertyChanged</code>  ,         .  ,    <code>ChangeTracker</code> ,     MVVM,  ,      .      .     ,    . <br> <br> <code class="cs">var changeTracker = new PropertyChangeTracker(viewModel); viewModel.CurrentState = "newState"; CollectionAssert.Contains(changeTracker.ChangedProperties, "CurrentState");</code> <br> ,     ,     <code>INotifyPropertyChanged</code> ,    ,   ,     . <br> <br>      <br>        ,   ,    <code>set</code>      ,           . ,     ,     ,      ,          . <br> <br> <code class="cs">var changeTracker = new PropertyChangeTracker(viewModel); var question = viewModel.Questions.First() as OpenQuestionViewModel; question.Question.Response = "some text"; CollectionAssert.Contains(changeTracker.ChangedProperties, "UnansweredQuestions");</code> <br>      <br>     <code>INotifyPropertyChanged</code> ,      <code>PropertyChanged</code>        ,  ,     , , .        ,       . <br> <br>   <i>INotifyDataErrorInfo</i> <br>   ,     ,    ,   ,   <code>IDataErrorInfo</code> ,  ( Silverlight)   <code>INotifyDataErrorInfo</code> .   <code>INotifyDataErrorInfo</code>   ,         ,    ,  ,   ,    . <br> <br>       <code>INotifyDataErrorInfo</code> : ,     ,  ,     ,     <code>ErrorsChanged</code> ,      <code>GetErrors</code> , . <br> <br>    <br>     ,      ,     .       ,         <code>GetErrors</code>       ,  ,  ,   .    , ,  ,     ,        .   ,        . <br> <br> <code class="cs">//  . var notifyErrorInfo = (INotifyDataErrorInfo)question; question.Response = -15; Assert.IsTrue(notifyErrorInfo.GetErrors("Response").Cast&lt;ValidationResult&gt;().Any()); //  . var notifyErrorInfo = (INotifyDataErrorInfo)question; question.Response = 15; Assert.IsFalse(notifyErrorInfo.GetErrors("Response").Cast&lt;ValidationResult&gt;().Any());</code> <br>    ,    ,             . <br> <br>    <i>INotifyDataErrorInfo</i> <br>       <code>GetErrors</code> ,   <code>INotifyDataErrorInfo</code>  ,   <code>ErrorsChanged</code>      <code>GetErrors</code> . ,  <code>HasErrors</code>      ,  . <br> <br>       <code>INotifyDataErrorInfo</code> . , ,           ,   -  .      ,        <code>INotifyDataErrorInfo</code>         (,        ). <br> <br>     ,   ,  : <br>  <code>HasErrors</code>     .              ,       .  <code>ErrorsChanged</code> ,      ,         <code>GetErrors</code> .         ( ,  )     ,           .    <code>GetErrors</code>       <code>ErrorsChanged</code> . <br>    <code>INotifyPropertyChanged</code> ,  ,    <code>NotifyDataErrorInfoTestHelper</code>    MVVM,        <code>INotifyDataErrorInfo</code> ,       .   ,   ,      ,   .      . <br> <code class="cs">var helper = new NotifyDataErrorInfoTestHelper&lt;NumericQuestion, int?&gt;( question, q =&gt; q.Response); helper.ValidatePropertyChange( 6, NotifyDataErrorInfoBehavior.Nothing); helper.ValidatePropertyChange( 20, NotifyDataErrorInfoBehavior.FiresErrorsChanged | NotifyDataErrorInfoBehavior.HasErrors | NotifyDataErrorInfoBehavior.HasErrorsForProperty); helper.ValidatePropertyChange( null, NotifyDataErrorInfoBehavior.FiresErrorsChanged | NotifyDataErrorInfoBehavior.HasErrors | NotifyDataErrorInfoBehavior.HasErrorsForProperty); helper.ValidatePropertyChange( 2, NotifyDataErrorInfoBehavior.FiresErrorsChanged);</code> <br>     <br>   MVVM,     ,  .   ,    ,         . <br> <br>  ,     ,     ,       .   ,   , ,       ,     ,   <code>IAsyncResult</code>    ,  - ,   ,    UI. <br> <br>       , , ,    .   ,     .  ,      UI,     ,   ,          ,     ,        "   UI." <br> <br>     ,    ,    .   ,    ,     mock-, ,   ,   ,      ,          . <br> <br>           UI,    ,    .   ,     ,   ,      .        ,   .     ,    ,     . <br> <br> <code class="cs">questionnaireRepositoryMock .Setup( r =&gt; r.SubmitQuestionnaireAsync( It.IsAny&lt;Questionnaire&gt;(), It.IsAny&lt;Action&lt;IOperationResult&gt;&gt;())) .Callback&lt;Questionnaire, Action&lt;IOperationResult&gt;&gt;( (q, a) =&gt; callback = a); uiServicemock .Setup(svc =&gt; svc.ShowView(ViewNames.QuestionnaireTemplatesList)) .Callback&lt;string&gt;(viewName =&gt; requestedViewName = viewName); submitResultMock .Setup(sr =&gt; sr.Error) .Returns&lt;Exception&gt;(null); CompleteQuestionnaire(viewModel); viewModel.Submit(); //      UI . callback(submitResultMock.Object); //    ‚Äì     . Assert.AreEqual(ViewNames.QuestionnaireTemplatesList, requestedViewName);</code> <br> <b></b> <br>          ,        . <br>   <br>       , . "Trees in WPF"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ms753391.aspx">http://msdn.microsoft.com/en-us/library/ms753391.aspx</a> <br> <br>       , . "Attached Properties Overview"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/cc265152(VS.95).aspx">http://msdn.microsoft.com/en-us/library/cc265152(VS.95).aspx</a> <br> <br>      MEF, ."Managed Extensibility Framework Overview"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/dd460648.aspx">http://msdn.microsoft.com/en-us/library/dd460648.aspx</a> . <br> <br>      Unity, ."Unity Application Block"  MSDN: <a href="http://www.msdn.com/unity">http://www.msdn.com/unity</a> . <br> <br>      <code>DelegateCommand</code> , .Chapter 5, " <a href="http://msdn.microsoft.com/en-us/library/gg405484(v%3DPandP.40).aspx">Implementing the MVVM Pattern</a> ." <br> <br>        Microsoft Expression Blend, ."Working with built-in behaviors"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ff724013(v%3DExpression.40).aspx">http://msdn.microsoft.com/en-us/library/ff724013(v=Expression.40).aspx</a> . <br> <br>          Microsoft Expression Blend, ."Creating Custom Behaviors"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ff724708(v%3DExpression.40).aspx">http://msdn.microsoft.com/en-us/library/ff724708(v=Expression.40).aspx</a> . <br> <br>            Microsoft Expression Blend, ."Creating Custom Triggers and Actions"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ff724707(v%3DExpression.40).aspx">http://msdn.microsoft.com/en-us/library/ff724707(v=Expression.40).aspx</a> . <br> <br>         WPF  Silverlight, ."Threading Model"  "The Dispatcher Class"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ms741870.aspx">http://msdn.microsoft.com/en-us/library/ms741870.aspx</a> <br> <a href="http://msdn.microsoft.com/en-us/library/ms615907(v%3DVS.95).aspx">http://msdn.microsoft.com/en-us/library/ms615907(v=VS.95).aspx</a> . <br> <br>      unit-  Silverlight, ."Unit Testing with Silverlight 2": <a href="http://www.jeff.wilcox.name/2008/03/silverlight2-unit-testing/">http://www.jeff.wilcox.name/2008/03/silverlight2-unit-testing/</a> . <br> <br>         , .  " <a href="http://msdn.microsoft.com/en-us/library/gg430861(v%3DPandP.40).aspx">View-Based Navigation</a> " in Chapter 8, " <a href="http://msdn.microsoft.com/en-us/library/gg430861(v%3DPandP.40).aspx">Navigation</a> ." <br> <br>       ,   , ."Event-based Asynchronous Pattern Overview"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/wewwczdw.aspx">http://msdn.microsoft.com/en-us/library/wewwczdw.aspx</a> <br> <br>        <code>IAsyncResult</code> , ."Asynchronous Programming Overview"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ms228963.aspx">http://msdn.microsoft.com/en-us/library/ms228963.aspx</a></code></code></code></code></code></code></code></code></code> <h3> <code><code><code><code><code><code><code><code><code><code>CommandBehaviorBase ,    ,    ICommand</code> .           <code>CanExecuteChanged</code> ,          Silverlight,    WPF. <br> <br>    ,  ,   <code>CommandBehaviorBase    ,    .         ,      .         ,    .      ButtonBaseClickCommandBehavior</code> . <br> <br> <code class="cs">public class ButtonBaseClickCommandBehavior : CommandBehaviorBase&lt;ButtonBase&gt; { public ButtonBaseClickCommandBehavior(ButtonBase clickableObject) : base(clickableObject) { clickableObject.Click += OnClick; } private void OnClick(object sender, System.Windows.RoutedEventArgs e) { ExecuteCommand(); } }</code> <br>   <code>CommandBehaviorBase ,     .     ,          ,   . ,    ,    ,      , ,    CanExecute</code>  ,     . <br> <br>          ,   .           XAML.           .       .  Prism      ,       ,  ,   .       ,    . , ,  ,      <code>Click</code> ,       <code>Command</code> .    <code>Click.Command</code> ,  . <br> <br>             .             . <br> <br> <code class="cs">public static readonly DependencyProperty CommandProperty = DependencyProperty.RegisterAttached( "Command", typeof(ICommand), typeof(Click), new PropertyMetadata(OnSetCommandCallback)); private static readonly DependencyProperty ClickCommandBehaviorProperty = DependencyProperty.RegisterAttached( "ClickCommandBehavior", typeof(ButtonBaseClickCommandBehavior), typeof(Click), null);</code> <br>    <code>Command</code>    <code>ButtonBaseClickCommandBehavior</code> ,     <code>OnSetCommandCallback</code> ,     . <br> <br> <code class="cs">private static void OnSetCommandCallback(DependencyObject dependencyObject, DependencyPropertyChangedEventArgs e) { ButtonBase buttonBase = dependencyObject as ButtonBase; if (buttonBase != null) { ButtonBaseClickCommandBehavior behavior = GetOrCreateBehavior(buttonBase); behavior.Command = e.NewValue as ICommand; } } private static void OnSetCommandParameterCallback(DependencyObject dependencyObject, DependencyPropertyChangedEventArgs e) { ButtonBase buttonBase = dependencyObject as ButtonBase; if (buttonBase != null) { ButtonBaseClickCommandBehavior behavior = GetOrCreateBehavior(buttonBase); behavior.CommandParameter = e.NewValue; } } private static ButtonBaseClickCommandBehavior GetOrCreateBehavior(ButtonBase buttonBase ) { ButtonBaseClickCommandBehavior behavior = buttonBase.GetValue(ClickCommandBehaviorProperty) as ButtonBaseClickCommandBehavior; if ( behavior == null ) { behavior = new ButtonBaseClickCommandBehavior(buttonBase); buttonBase.SetValue(ClickCommandBehaviorProperty, behavior); } return behavior; }</code> <br>        ,  <a href="http://msdn.microsoft.com/en-us/library/cc265152(VS.95).aspx">Attached Properties Overview</a>  MSDN. <br> <br>    <br>              . ,     Silverlight,    -,     ,      ,     .     ,       . <br> <br>        ,    ( )  ,  ,     .  UI       ,            UI. <br> <br>      - <br>   -     ,       <code>IAsyncResult</code> .   ,  ,   ,  <code>GetQuestionnaire</code> ,   : <code>BeginGetQuestionnaire</code>  <code>EndGetQuestionnaire</code> .    ,   <code>BeginGetQuestionnaire</code> .     ,   ,   <code>EndGetQuestionnaire</code>    . <br> <b></b> <br>  .NET Framework 4.5      <code>await</code>  <code>async</code>     <code>*Async</code> .      <a href="http://msdn.microsoft.com/en-us/library/vstudio/hh391443.aspx">"Asynchronous Programming with Async and Await (C# and Visual Basic)"</a> . <br>  ,    <code>EndGetQuestionnaire</code> ,      ,  ()      <code>BeginGetQuestionnaire</code> .     ,      ,   <code>EndGetQuestionnaire</code> ,   . <br> <br> <code class="xml">IAsyncResult asyncResult = this.service.BeginGetQuestionnaire( GetQuestionnaireCompleted, null //  ,      ); private void GetQuestionnaireCompleted(IAsyncResult result) { try { questionnaire = this.service.EndGetQuestionnaire(ar); } catch (Exception ex) { //  -   . } }</code> <br>  ,     <code>End*</code> (  , <code>EndGetQuestionnaire</code> ),    ,      .      , ,          UI.     ,   ,        . <br> <br>        UI,     -,      UI,         UI,   <code>Dispatcher</code>    <code>SynchronizationContext</code> .  WPF  Silverlight,   <code>Dispatcher</code> . <br> <br>      <code>Questionnaire</code>  ,        <code>QuestionnaireView</code> .  Silverlight    <code>CheckAccess</code> ,  ,      UI.  ,     <code>BeginInvoke</code> ,      UI. <br> <br> <code class="cs">var dispatcher = System.Windows.Deployment.Current.Dispatcher; if (dispatcher.CheckAccess()) { QuestionnaireView.DataContext = questionnaire; } else { dispatcher.BeginInvoke(() =&gt; { Questionnaire.DataContext = questionnaire; }); }</code> <br> <i>MVVM RI</i>   ,    ,   <code>IAsyncResult</code> ,   .      ,                 . ,       . <br> <br> <code class="cs">this.questionnaireRepository.GetQuestionnaireAsync( result =&gt; { this.Questionnaire = result.Result; });</code> <br>  <code>result</code>   ,     , , , .    ,     . <br> <br> <code class="cs">this.questionnaireRepository.GetQuestionnaireAsync( result =&gt; { if (result.Error == null) { this.Questionnaire = result.Result; ... } else { // Handle error. } })</code> <br>     <br>        ,      .     , ,             .        ,      ,     ,     . <br> <br>         ,      MVVM,     ,   . ,  -MVVM ,     <code>MessageBox</code>   code-behind UI,      .   MVVM     ,          . <br> <br>     MVVM,              ,          .      ,    ,   ,  ,     . <br> <br>              MVVM.      ,     ,     ,  ,     .    ,         ,     ,          .       . <br> <br>    <br>                  .        ,        .  ,         .         . <br> <br>  ,         ,         ,  .      ,     .           ,       . ,        WPF  Silverlight,        . <br> <br> <img title="Using the service to interact with the user." src="https://habrastorage.org/getpro/habr/post_images/4b5/397/f2d/4b5397f2d02e5851195b29f1893be6fc.png" alt=" ,    ."> <br> <br>  ,   <code>MessageBox</code>        ,     ,    ,     . <br> <br> <code class="cs">var result = interactionService.ShowMessageBox( "Are you sure you want to cancel this operation?", "Confirm", MessageBoxButton.OK); if (result == MessageBoxResult.Yes) { CancelRequest(); }</code> <br> ,      - ,      ,         Silverlight.         .             .     . <br> <br> <code class="cs">interactionService.ShowMessageBox( "Are you sure you want to cancel this operation?", "Confirm", MessageBoxButton.OK, result =&gt; { if (result == MessageBoxResult.Yes) { CancelRequest(); } });</code> <br>         ,      . ,  WPF    <code>MessageBox</code> ,       ;    Silverlight    ,    . <br> <br>     <br>         ‚Äì             .         ,      .     ,     .        ,        ,   ,     . <br> <br> <img title="Using interaction request objects." src="https://habrastorage.org/getpro/habr/post_images/3d0/ff0/1c5/3d0ff01c5518558c2d3c5c5f47ce0ce9.png" alt="   ."> <br> <br>    ,   ,          ‚Äì       ,      ,   ‚Äì     .   ,        ,    ,    UI            . <br> <br>       MVVM,     ,       ,         .         ,        ,    ,   . <br> <br>  Prism       <code>IInteractionRequest</code>   <code>InteractionRequest .  IInteractionRequest</code>  ,   .           ,   .  <code>InteractionRequest   IInteractionRequest</code>     <code>Raise</code> ,           , , ,   . <br> <br>       <br>  <code>InteractionRequest          .  Raise</code>          ( <code>T</code> )    ,    ,   .          ,       .      ,        .    ,  ,     . <br> <code class="cs">public interface IInteractionRequest { event EventHandler&lt;InteractionRequestedEventArgs&gt; Raised; } public class InteractionRequest&lt;T&gt; : IInteractionRequest { public event EventHandler&lt;InteractionRequestedEventArgs&gt; Raised; public void Raise(T context, Action&lt;T&gt; callback) { var handler = this.Raised; if (handler != null) { handler( this, new InteractionRequestedEventArgs(context, () =&gt; callback(context))); } } }</code> <br> Prism    ,      .  <code>Notification</code>       .    ,            .     ‚Äì <code>Title</code>  <code>Content</code> ,    .  ,   ,  ,  ,        . <br> <br>  <code>Confirmation</code>    <code>Notification</code>     ‚Äì <code>Confirmed</code> ,  ,  ,      .  <code>Confirmation</code> ,     <code>MessageBox</code> ,     /  .     ,     <code>Notification</code> ,     ,      . <br> <br>    <code>InteractionRequest ,       InteractionRequest      ,      .      ,    Raise</code> ,    , ,   . <br> <br> <code class="cs">public IInteractionRequest ConfirmCancelInteractionRequest { get { return this.confirmCancelInteractionRequest; } } this.confirmCancelInteractionRequest.Raise( new Confirmation("Are you sure you wish to cancel?"), confirmation =&gt; { if (confirmation.Confirmed) { this.NavigateToQuestionnaireList(); } }); }</code> <br> <i>MVVM Reference Implementation (MVVM RI)</i> ,    <code>IInteractionRequest</code>   <code>InteractionRequest ,          (. QuestionnaireViewModel.cs</code> ). <br> <br>        <br>       ,       .   ,       .    UI             . <br> <br>                . Microsoft Expression Blend Behaviors Framework     .  ,     ,    . <br> <br>  <code>EventTrigger</code> ,  Expression Blend,  ,      ,     ,   . , Prism   <code>EventTrigger</code> ,  <code>InteractionRequestTrigger</code> ,      <code>Raised</code>   <code>IInteractionRequest</code> .    XAML        . <br> <br>  ,   , <code>InteractionRequestTrigger</code>   .  Silverlight Prism   <code>PopupChildWindowAction</code> ,     .    ,         .   <code>ContentTemplate</code>  <code>PopupChildWindowAction</code> ,    ,    UI,      <code>Content</code>  .       <code>Title</code>  . <br> <b></b> <br>  ,    ,   <code>PopupChildWindowAction</code> ,     .    <code>Notification</code>  <code>NotificationChildWindow</code> ,        <code>Confirmation</code> ‚Äì <code>ConfirmationChildWindow</code> . <code>NotificationChildWindow</code>    ,   ,     <code>ConfirmationChildWindow</code>    <i>OK</i>  <i>Cancel</i> ,    .    ,   ,   <code>ChildWindow</code>  <code>PopupChildWindowAction</code> . <br>   ,  <code>InteractionRequestTrigger</code>  <code>PopupChildWindowAction</code> ,       <i>RI MVVM</i> . <br> <br> <code class="xml">&lt;i:Interaction.Triggers&gt; &lt;prism:InteractionRequestTrigger SourceObject="{Binding ConfirmCancelInteractionRequest}"&gt; &lt;prism:PopupChildWindowAction ContentTemplate="{StaticResource ConfirmWindowTemplate}"/&gt; &lt;/prism:InteractionRequestTrigger&gt; &lt;/i:Interaction.Triggers&gt; &lt;UserControl.Resources&gt; &lt;DataTemplate x:Key="ConfirmWindowTemplate"&gt; &lt;Grid MinWidth="250" MinHeight="100"&gt; &lt;TextBlock TextWrapping="Wrap" Grid.Row="0" Text="{Binding}"/&gt; &lt;/Grid&gt; &lt;/DataTemplate&gt; &lt;/UserControl.Resources&gt;</code> <br> <b></b> <br>      <code>ContentTemplate</code> ,   UI   <code>Content</code>  .    <code>Content</code>  ,  , <code>TextBlock</code>     <code>Content</code> . <br>      ,     ,    ,    .  ,     ,       ,     ,    .   ,   <i>RI MVVM</i> ,         <code>Confirmed</code>    <code>Confirmation</code>  <code>true</code> ,     OK. <br> <br>        ,     .  Prism <code>InteractionRequestTrigger</code>   <code>PopupChildWindowAction</code>            . <br> <br>     <br>     MVVM,       , ,    ,         .        (  , ,  ,   ).    ,  ,  ,            . <br> <br>        ,         . Managed Extensibility Framework (MEF)  Unity Application Block (Unity)      ,  ,           . <br> <br>  ,       , , ,    ( )      . ,       ,     .  ,     ,       . <br> <br>     ,  MEF <br>  MEF,       ,   <code>Import</code> ,      ,  ,   <code>Export</code> .         ,    . <br> <br> , <code>QuestionnaireView</code>   <i>RI MVVM</i> ,        ,    <code>Import</code> .   , MEF           .  <code>set</code>        ,   . <br> <br> <code class="cs">[Import] public QuestionnaireViewModel ViewModel { set { this.DataContext = value; } }</code> <br>     ,   . <br> <br> <code class="cs">[Export] public class QuestionnaireViewModel : NotificationObject { ... }</code> <br>        ,   . <br> <br> <code class="cs">public QuestionnaireView() { InitializeComponent(); } [ImportingConstructor] public QuestionnaireView(QuestionnaireViewModel viewModel) : this() { this.DataContext = viewModel; }</code> <br> <b></b> <br>          MEF,   Unity.   ,     ,        .   ,   Visual Studio  Expression Blend, ,        ,     .   ,   ,  ,      ,          <code>InitializeComponent</code> . <br>     ,  Unity <br>  Unity,    ,   MEF.     ,      .    ,         .  ,      . <br> <br>  ,      ,  ,         . ,           ,   . <br> <br> <code class="cs">public QuestionnaireView() { InitializeComponent(); } public QuestionnaireView(QuestionnaireViewModel viewModel) : this() { this.DataContext = viewModel; }</code> <br> <b></b> <br>    ,        ,   Visual Studio  Expression Blend. <br>  ,          ,   . Unity        <code>set</code>   ,   . <br> <br> <code class="cs">public QuestionnaireView() { InitializeComponent(); } [Dependency] public QuestionnaireViewModel ViewModel { set { this.DataContext = value; } }</code> <br>       Unity. <br> <br> <code class="cs">container.RegisterType&lt;QuestionnaireViewModel&gt;();</code> <br>  ,     . <br> <br> <code class="cs">var view = container.Resolve&lt;QuestionnaireView&gt;();</code> <br>     ,    <br>   ,     ,        .        ,   MEF  Unity,        . <br> <br>          .   ,         UI,           . <br> <br> , <i>RI MVVM</i>   ,   ,        .   ,    .      <code>ShowView</code>   UI. <br> <br> <code class="cs">private void NavigateToQuestionnaireList() { //     "questionnaire list". this.uiService.ShowView(ViewNames.QuestionnaireTemplatesList); }</code> <br>  UI      UI .           UI.  <code>ShowView</code>  <code>UIService</code>      (,          ),       ,   . <br> <br> <code class="cs">public void ShowView(string viewName) { var view = this.ViewFactory.GetView(viewName); this.MainWindow.CurrentView = view; }</code> <br> <b></b> <br> Prism       .   ,   ,   ,             .    ,  , " <a href="http://msdn.microsoft.com/en-us/library/gg430861(v%3DPandP.40).aspx">View-Based Navigation</a> "   8, " <a href="http://msdn.microsoft.com/en-us/library/gg430861(v%3DPandP.40).aspx">Navigation</a> ". <br>  MVVM  <br>        MVVM      .           -      mocking . ,   ,        . <br> <br>   <i>INotifyPropertyChanged</i> <br>   <code>INotifyPropertyChanged</code>     ,      .      ,    ;   ,   ,     ,    ,       . <br> <br>   <br> ,       ,           <code>PropertyChanged</code>  ,         .  ,    <code>ChangeTracker</code> ,     MVVM,  ,      .      .     ,    . <br> <br> <code class="cs">var changeTracker = new PropertyChangeTracker(viewModel); viewModel.CurrentState = "newState"; CollectionAssert.Contains(changeTracker.ChangedProperties, "CurrentState");</code> <br> ,     ,     <code>INotifyPropertyChanged</code> ,    ,   ,     . <br> <br>      <br>        ,   ,    <code>set</code>      ,           . ,     ,     ,      ,          . <br> <br> <code class="cs">var changeTracker = new PropertyChangeTracker(viewModel); var question = viewModel.Questions.First() as OpenQuestionViewModel; question.Question.Response = "some text"; CollectionAssert.Contains(changeTracker.ChangedProperties, "UnansweredQuestions");</code> <br>      <br>     <code>INotifyPropertyChanged</code> ,      <code>PropertyChanged</code>        ,  ,     , , .        ,       . <br> <br>   <i>INotifyDataErrorInfo</i> <br>   ,     ,    ,   ,   <code>IDataErrorInfo</code> ,  ( Silverlight)   <code>INotifyDataErrorInfo</code> .   <code>INotifyDataErrorInfo</code>   ,         ,    ,  ,   ,    . <br> <br>       <code>INotifyDataErrorInfo</code> : ,     ,  ,     ,     <code>ErrorsChanged</code> ,      <code>GetErrors</code> , . <br> <br>    <br>     ,      ,     .       ,         <code>GetErrors</code>       ,  ,  ,   .    , ,  ,     ,        .   ,        . <br> <br> <code class="cs">//  . var notifyErrorInfo = (INotifyDataErrorInfo)question; question.Response = -15; Assert.IsTrue(notifyErrorInfo.GetErrors("Response").Cast&lt;ValidationResult&gt;().Any()); //  . var notifyErrorInfo = (INotifyDataErrorInfo)question; question.Response = 15; Assert.IsFalse(notifyErrorInfo.GetErrors("Response").Cast&lt;ValidationResult&gt;().Any());</code> <br>    ,    ,             . <br> <br>    <i>INotifyDataErrorInfo</i> <br>       <code>GetErrors</code> ,   <code>INotifyDataErrorInfo</code>  ,   <code>ErrorsChanged</code>      <code>GetErrors</code> . ,  <code>HasErrors</code>      ,  . <br> <br>       <code>INotifyDataErrorInfo</code> . , ,           ,   -  .      ,        <code>INotifyDataErrorInfo</code>         (,        ). <br> <br>     ,   ,  : <br>  <code>HasErrors</code>     .              ,       .  <code>ErrorsChanged</code> ,      ,         <code>GetErrors</code> .         ( ,  )     ,           .    <code>GetErrors</code>       <code>ErrorsChanged</code> . <br>    <code>INotifyPropertyChanged</code> ,  ,    <code>NotifyDataErrorInfoTestHelper</code>    MVVM,        <code>INotifyDataErrorInfo</code> ,       .   ,   ,      ,   .      . <br> <code class="cs">var helper = new NotifyDataErrorInfoTestHelper&lt;NumericQuestion, int?&gt;( question, q =&gt; q.Response); helper.ValidatePropertyChange( 6, NotifyDataErrorInfoBehavior.Nothing); helper.ValidatePropertyChange( 20, NotifyDataErrorInfoBehavior.FiresErrorsChanged | NotifyDataErrorInfoBehavior.HasErrors | NotifyDataErrorInfoBehavior.HasErrorsForProperty); helper.ValidatePropertyChange( null, NotifyDataErrorInfoBehavior.FiresErrorsChanged | NotifyDataErrorInfoBehavior.HasErrors | NotifyDataErrorInfoBehavior.HasErrorsForProperty); helper.ValidatePropertyChange( 2, NotifyDataErrorInfoBehavior.FiresErrorsChanged);</code> <br>     <br>   MVVM,     ,  .   ,    ,         . <br> <br>  ,     ,     ,       .   ,   , ,       ,     ,   <code>IAsyncResult</code>    ,  - ,   ,    UI. <br> <br>       , , ,    .   ,     .  ,      UI,     ,   ,          ,     ,        "   UI." <br> <br>     ,    ,    .   ,    ,     mock-, ,   ,   ,      ,          . <br> <br>           UI,    ,    .   ,     ,   ,      .        ,   .     ,    ,     . <br> <br> <code class="cs">questionnaireRepositoryMock .Setup( r =&gt; r.SubmitQuestionnaireAsync( It.IsAny&lt;Questionnaire&gt;(), It.IsAny&lt;Action&lt;IOperationResult&gt;&gt;())) .Callback&lt;Questionnaire, Action&lt;IOperationResult&gt;&gt;( (q, a) =&gt; callback = a); uiServicemock .Setup(svc =&gt; svc.ShowView(ViewNames.QuestionnaireTemplatesList)) .Callback&lt;string&gt;(viewName =&gt; requestedViewName = viewName); submitResultMock .Setup(sr =&gt; sr.Error) .Returns&lt;Exception&gt;(null); CompleteQuestionnaire(viewModel); viewModel.Submit(); //      UI . callback(submitResultMock.Object); //    ‚Äì     . Assert.AreEqual(ViewNames.QuestionnaireTemplatesList, requestedViewName);</code> <br> <b></b> <br>          ,        . <br>   <br>       , . "Trees in WPF"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ms753391.aspx">http://msdn.microsoft.com/en-us/library/ms753391.aspx</a> <br> <br>       , . "Attached Properties Overview"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/cc265152(VS.95).aspx">http://msdn.microsoft.com/en-us/library/cc265152(VS.95).aspx</a> <br> <br>      MEF, ."Managed Extensibility Framework Overview"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/dd460648.aspx">http://msdn.microsoft.com/en-us/library/dd460648.aspx</a> . <br> <br>      Unity, ."Unity Application Block"  MSDN: <a href="http://www.msdn.com/unity">http://www.msdn.com/unity</a> . <br> <br>      <code>DelegateCommand</code> , .Chapter 5, " <a href="http://msdn.microsoft.com/en-us/library/gg405484(v%3DPandP.40).aspx">Implementing the MVVM Pattern</a> ." <br> <br>        Microsoft Expression Blend, ."Working with built-in behaviors"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ff724013(v%3DExpression.40).aspx">http://msdn.microsoft.com/en-us/library/ff724013(v=Expression.40).aspx</a> . <br> <br>          Microsoft Expression Blend, ."Creating Custom Behaviors"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ff724708(v%3DExpression.40).aspx">http://msdn.microsoft.com/en-us/library/ff724708(v=Expression.40).aspx</a> . <br> <br>            Microsoft Expression Blend, ."Creating Custom Triggers and Actions"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ff724707(v%3DExpression.40).aspx">http://msdn.microsoft.com/en-us/library/ff724707(v=Expression.40).aspx</a> . <br> <br>         WPF  Silverlight, ."Threading Model"  "The Dispatcher Class"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ms741870.aspx">http://msdn.microsoft.com/en-us/library/ms741870.aspx</a> <br> <a href="http://msdn.microsoft.com/en-us/library/ms615907(v%3DVS.95).aspx">http://msdn.microsoft.com/en-us/library/ms615907(v=VS.95).aspx</a> . <br> <br>      unit-  Silverlight, ."Unit Testing with Silverlight 2": <a href="http://www.jeff.wilcox.name/2008/03/silverlight2-unit-testing/">http://www.jeff.wilcox.name/2008/03/silverlight2-unit-testing/</a> . <br> <br>         , .  " <a href="http://msdn.microsoft.com/en-us/library/gg430861(v%3DPandP.40).aspx">View-Based Navigation</a> " in Chapter 8, " <a href="http://msdn.microsoft.com/en-us/library/gg430861(v%3DPandP.40).aspx">Navigation</a> ." <br> <br>       ,   , ."Event-based Asynchronous Pattern Overview"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/wewwczdw.aspx">http://msdn.microsoft.com/en-us/library/wewwczdw.aspx</a> <br> <br>        <code>IAsyncResult</code> , ."Asynchronous Programming Overview"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ms228963.aspx">http://msdn.microsoft.com/en-us/library/ms228963.aspx</a></code></code></code></code></code></code></code></code></code> </h3> <code><code><code><code><code><code><code><code><code><code>CommandBehaviorBase ,    ,    ICommand</code> .           <code>CanExecuteChanged</code> ,          Silverlight,    WPF. <br> <br>    ,  ,   <code>CommandBehaviorBase    ,    .         ,      .         ,    .      ButtonBaseClickCommandBehavior</code> . <br> <br> <code class="cs">public class ButtonBaseClickCommandBehavior : CommandBehaviorBase&lt;ButtonBase&gt; { public ButtonBaseClickCommandBehavior(ButtonBase clickableObject) : base(clickableObject) { clickableObject.Click += OnClick; } private void OnClick(object sender, System.Windows.RoutedEventArgs e) { ExecuteCommand(); } }</code> <br>   <code>CommandBehaviorBase ,     .     ,          ,   . ,    ,    ,      , ,    CanExecute</code>  ,     . <br> <br>          ,   .           XAML.           .       .  Prism      ,       ,  ,   .       ,    . , ,  ,      <code>Click</code> ,       <code>Command</code> .    <code>Click.Command</code> ,  . <br> <br>             .             . <br> <br> <code class="cs">public static readonly DependencyProperty CommandProperty = DependencyProperty.RegisterAttached( "Command", typeof(ICommand), typeof(Click), new PropertyMetadata(OnSetCommandCallback)); private static readonly DependencyProperty ClickCommandBehaviorProperty = DependencyProperty.RegisterAttached( "ClickCommandBehavior", typeof(ButtonBaseClickCommandBehavior), typeof(Click), null);</code> <br>    <code>Command</code>    <code>ButtonBaseClickCommandBehavior</code> ,     <code>OnSetCommandCallback</code> ,     . <br> <br> <code class="cs">private static void OnSetCommandCallback(DependencyObject dependencyObject, DependencyPropertyChangedEventArgs e) { ButtonBase buttonBase = dependencyObject as ButtonBase; if (buttonBase != null) { ButtonBaseClickCommandBehavior behavior = GetOrCreateBehavior(buttonBase); behavior.Command = e.NewValue as ICommand; } } private static void OnSetCommandParameterCallback(DependencyObject dependencyObject, DependencyPropertyChangedEventArgs e) { ButtonBase buttonBase = dependencyObject as ButtonBase; if (buttonBase != null) { ButtonBaseClickCommandBehavior behavior = GetOrCreateBehavior(buttonBase); behavior.CommandParameter = e.NewValue; } } private static ButtonBaseClickCommandBehavior GetOrCreateBehavior(ButtonBase buttonBase ) { ButtonBaseClickCommandBehavior behavior = buttonBase.GetValue(ClickCommandBehaviorProperty) as ButtonBaseClickCommandBehavior; if ( behavior == null ) { behavior = new ButtonBaseClickCommandBehavior(buttonBase); buttonBase.SetValue(ClickCommandBehaviorProperty, behavior); } return behavior; }</code> <br>        ,  <a href="http://msdn.microsoft.com/en-us/library/cc265152(VS.95).aspx">Attached Properties Overview</a>  MSDN. <br> <br>    <br>              . ,     Silverlight,    -,     ,      ,     .     ,       . <br> <br>        ,    ( )  ,  ,     .  UI       ,            UI. <br> <br>      - <br>   -     ,       <code>IAsyncResult</code> .   ,  ,   ,  <code>GetQuestionnaire</code> ,   : <code>BeginGetQuestionnaire</code>  <code>EndGetQuestionnaire</code> .    ,   <code>BeginGetQuestionnaire</code> .     ,   ,   <code>EndGetQuestionnaire</code>    . <br> <b></b> <br>  .NET Framework 4.5      <code>await</code>  <code>async</code>     <code>*Async</code> .      <a href="http://msdn.microsoft.com/en-us/library/vstudio/hh391443.aspx">"Asynchronous Programming with Async and Await (C# and Visual Basic)"</a> . <br>  ,    <code>EndGetQuestionnaire</code> ,      ,  ()      <code>BeginGetQuestionnaire</code> .     ,      ,   <code>EndGetQuestionnaire</code> ,   . <br> <br> <code class="xml">IAsyncResult asyncResult = this.service.BeginGetQuestionnaire( GetQuestionnaireCompleted, null //  ,      ); private void GetQuestionnaireCompleted(IAsyncResult result) { try { questionnaire = this.service.EndGetQuestionnaire(ar); } catch (Exception ex) { //  -   . } }</code> <br>  ,     <code>End*</code> (  , <code>EndGetQuestionnaire</code> ),    ,      .      , ,          UI.     ,   ,        . <br> <br>        UI,     -,      UI,         UI,   <code>Dispatcher</code>    <code>SynchronizationContext</code> .  WPF  Silverlight,   <code>Dispatcher</code> . <br> <br>      <code>Questionnaire</code>  ,        <code>QuestionnaireView</code> .  Silverlight    <code>CheckAccess</code> ,  ,      UI.  ,     <code>BeginInvoke</code> ,      UI. <br> <br> <code class="cs">var dispatcher = System.Windows.Deployment.Current.Dispatcher; if (dispatcher.CheckAccess()) { QuestionnaireView.DataContext = questionnaire; } else { dispatcher.BeginInvoke(() =&gt; { Questionnaire.DataContext = questionnaire; }); }</code> <br> <i>MVVM RI</i>   ,    ,   <code>IAsyncResult</code> ,   .      ,                 . ,       . <br> <br> <code class="cs">this.questionnaireRepository.GetQuestionnaireAsync( result =&gt; { this.Questionnaire = result.Result; });</code> <br>  <code>result</code>   ,     , , , .    ,     . <br> <br> <code class="cs">this.questionnaireRepository.GetQuestionnaireAsync( result =&gt; { if (result.Error == null) { this.Questionnaire = result.Result; ... } else { // Handle error. } })</code> <br>     <br>        ,      .     , ,             .        ,      ,     ,     . <br> <br>         ,      MVVM,     ,   . ,  -MVVM ,     <code>MessageBox</code>   code-behind UI,      .   MVVM     ,          . <br> <br>     MVVM,              ,          .      ,    ,   ,  ,     . <br> <br>              MVVM.      ,     ,     ,  ,     .    ,         ,     ,          .       . <br> <br>    <br>                  .        ,        .  ,         .         . <br> <br>  ,         ,         ,  .      ,     .           ,       . ,        WPF  Silverlight,        . <br> <br> <img title="Using the service to interact with the user." src="https://habrastorage.org/getpro/habr/post_images/4b5/397/f2d/4b5397f2d02e5851195b29f1893be6fc.png" alt=" ,    ."> <br> <br>  ,   <code>MessageBox</code>        ,     ,    ,     . <br> <br> <code class="cs">var result = interactionService.ShowMessageBox( "Are you sure you want to cancel this operation?", "Confirm", MessageBoxButton.OK); if (result == MessageBoxResult.Yes) { CancelRequest(); }</code> <br> ,      - ,      ,         Silverlight.         .             .     . <br> <br> <code class="cs">interactionService.ShowMessageBox( "Are you sure you want to cancel this operation?", "Confirm", MessageBoxButton.OK, result =&gt; { if (result == MessageBoxResult.Yes) { CancelRequest(); } });</code> <br>         ,      . ,  WPF    <code>MessageBox</code> ,       ;    Silverlight    ,    . <br> <br>     <br>         ‚Äì             .         ,      .     ,     .        ,        ,   ,     . <br> <br> <img title="Using interaction request objects." src="https://habrastorage.org/getpro/habr/post_images/3d0/ff0/1c5/3d0ff01c5518558c2d3c5c5f47ce0ce9.png" alt="   ."> <br> <br>    ,   ,          ‚Äì       ,      ,   ‚Äì     .   ,        ,    ,    UI            . <br> <br>       MVVM,     ,       ,         .         ,        ,    ,   . <br> <br>  Prism       <code>IInteractionRequest</code>   <code>InteractionRequest .  IInteractionRequest</code>  ,   .           ,   .  <code>InteractionRequest   IInteractionRequest</code>     <code>Raise</code> ,           , , ,   . <br> <br>       <br>  <code>InteractionRequest          .  Raise</code>          ( <code>T</code> )    ,    ,   .          ,       .      ,        .    ,  ,     . <br> <code class="cs">public interface IInteractionRequest { event EventHandler&lt;InteractionRequestedEventArgs&gt; Raised; } public class InteractionRequest&lt;T&gt; : IInteractionRequest { public event EventHandler&lt;InteractionRequestedEventArgs&gt; Raised; public void Raise(T context, Action&lt;T&gt; callback) { var handler = this.Raised; if (handler != null) { handler( this, new InteractionRequestedEventArgs(context, () =&gt; callback(context))); } } }</code> <br> Prism    ,      .  <code>Notification</code>       .    ,            .     ‚Äì <code>Title</code>  <code>Content</code> ,    .  ,   ,  ,  ,        . <br> <br>  <code>Confirmation</code>    <code>Notification</code>     ‚Äì <code>Confirmed</code> ,  ,  ,      .  <code>Confirmation</code> ,     <code>MessageBox</code> ,     /  .     ,     <code>Notification</code> ,     ,      . <br> <br>    <code>InteractionRequest ,       InteractionRequest      ,      .      ,    Raise</code> ,    , ,   . <br> <br> <code class="cs">public IInteractionRequest ConfirmCancelInteractionRequest { get { return this.confirmCancelInteractionRequest; } } this.confirmCancelInteractionRequest.Raise( new Confirmation("Are you sure you wish to cancel?"), confirmation =&gt; { if (confirmation.Confirmed) { this.NavigateToQuestionnaireList(); } }); }</code> <br> <i>MVVM Reference Implementation (MVVM RI)</i> ,    <code>IInteractionRequest</code>   <code>InteractionRequest ,          (. QuestionnaireViewModel.cs</code> ). <br> <br>        <br>       ,       .   ,       .    UI             . <br> <br>                . Microsoft Expression Blend Behaviors Framework     .  ,     ,    . <br> <br>  <code>EventTrigger</code> ,  Expression Blend,  ,      ,     ,   . , Prism   <code>EventTrigger</code> ,  <code>InteractionRequestTrigger</code> ,      <code>Raised</code>   <code>IInteractionRequest</code> .    XAML        . <br> <br>  ,   , <code>InteractionRequestTrigger</code>   .  Silverlight Prism   <code>PopupChildWindowAction</code> ,     .    ,         .   <code>ContentTemplate</code>  <code>PopupChildWindowAction</code> ,    ,    UI,      <code>Content</code>  .       <code>Title</code>  . <br> <b></b> <br>  ,    ,   <code>PopupChildWindowAction</code> ,     .    <code>Notification</code>  <code>NotificationChildWindow</code> ,        <code>Confirmation</code> ‚Äì <code>ConfirmationChildWindow</code> . <code>NotificationChildWindow</code>    ,   ,     <code>ConfirmationChildWindow</code>    <i>OK</i>  <i>Cancel</i> ,    .    ,   ,   <code>ChildWindow</code>  <code>PopupChildWindowAction</code> . <br>   ,  <code>InteractionRequestTrigger</code>  <code>PopupChildWindowAction</code> ,       <i>RI MVVM</i> . <br> <br> <code class="xml">&lt;i:Interaction.Triggers&gt; &lt;prism:InteractionRequestTrigger SourceObject="{Binding ConfirmCancelInteractionRequest}"&gt; &lt;prism:PopupChildWindowAction ContentTemplate="{StaticResource ConfirmWindowTemplate}"/&gt; &lt;/prism:InteractionRequestTrigger&gt; &lt;/i:Interaction.Triggers&gt; &lt;UserControl.Resources&gt; &lt;DataTemplate x:Key="ConfirmWindowTemplate"&gt; &lt;Grid MinWidth="250" MinHeight="100"&gt; &lt;TextBlock TextWrapping="Wrap" Grid.Row="0" Text="{Binding}"/&gt; &lt;/Grid&gt; &lt;/DataTemplate&gt; &lt;/UserControl.Resources&gt;</code> <br> <b></b> <br>      <code>ContentTemplate</code> ,   UI   <code>Content</code>  .    <code>Content</code>  ,  , <code>TextBlock</code>     <code>Content</code> . <br>      ,     ,    ,    .  ,     ,       ,     ,    .   ,   <i>RI MVVM</i> ,         <code>Confirmed</code>    <code>Confirmation</code>  <code>true</code> ,     OK. <br> <br>        ,     .  Prism <code>InteractionRequestTrigger</code>   <code>PopupChildWindowAction</code>            . <br> <br>     <br>     MVVM,       , ,    ,         .        (  , ,  ,   ).    ,  ,  ,            . <br> <br>        ,         . Managed Extensibility Framework (MEF)  Unity Application Block (Unity)      ,  ,           . <br> <br>  ,       , , ,    ( )      . ,       ,     .  ,     ,       . <br> <br>     ,  MEF <br>  MEF,       ,   <code>Import</code> ,      ,  ,   <code>Export</code> .         ,    . <br> <br> , <code>QuestionnaireView</code>   <i>RI MVVM</i> ,        ,    <code>Import</code> .   , MEF           .  <code>set</code>        ,   . <br> <br> <code class="cs">[Import] public QuestionnaireViewModel ViewModel { set { this.DataContext = value; } }</code> <br>     ,   . <br> <br> <code class="cs">[Export] public class QuestionnaireViewModel : NotificationObject { ... }</code> <br>        ,   . <br> <br> <code class="cs">public QuestionnaireView() { InitializeComponent(); } [ImportingConstructor] public QuestionnaireView(QuestionnaireViewModel viewModel) : this() { this.DataContext = viewModel; }</code> <br> <b></b> <br>          MEF,   Unity.   ,     ,        .   ,   Visual Studio  Expression Blend, ,        ,     .   ,   ,  ,      ,          <code>InitializeComponent</code> . <br>     ,  Unity <br>  Unity,    ,   MEF.     ,      .    ,         .  ,      . <br> <br>  ,      ,  ,         . ,           ,   . <br> <br> <code class="cs">public QuestionnaireView() { InitializeComponent(); } public QuestionnaireView(QuestionnaireViewModel viewModel) : this() { this.DataContext = viewModel; }</code> <br> <b></b> <br>    ,        ,   Visual Studio  Expression Blend. <br>  ,          ,   . Unity        <code>set</code>   ,   . <br> <br> <code class="cs">public QuestionnaireView() { InitializeComponent(); } [Dependency] public QuestionnaireViewModel ViewModel { set { this.DataContext = value; } }</code> <br>       Unity. <br> <br> <code class="cs">container.RegisterType&lt;QuestionnaireViewModel&gt;();</code> <br>  ,     . <br> <br> <code class="cs">var view = container.Resolve&lt;QuestionnaireView&gt;();</code> <br>     ,    <br>   ,     ,        .        ,   MEF  Unity,        . <br> <br>          .   ,         UI,           . <br> <br> , <i>RI MVVM</i>   ,   ,        .   ,    .      <code>ShowView</code>   UI. <br> <br> <code class="cs">private void NavigateToQuestionnaireList() { //     "questionnaire list". this.uiService.ShowView(ViewNames.QuestionnaireTemplatesList); }</code> <br>  UI      UI .           UI.  <code>ShowView</code>  <code>UIService</code>      (,          ),       ,   . <br> <br> <code class="cs">public void ShowView(string viewName) { var view = this.ViewFactory.GetView(viewName); this.MainWindow.CurrentView = view; }</code> <br> <b></b> <br> Prism       .   ,   ,   ,             .    ,  , " <a href="http://msdn.microsoft.com/en-us/library/gg430861(v%3DPandP.40).aspx">View-Based Navigation</a> "   8, " <a href="http://msdn.microsoft.com/en-us/library/gg430861(v%3DPandP.40).aspx">Navigation</a> ". <br>  MVVM  <br>        MVVM      .           -      mocking . ,   ,        . <br> <br>   <i>INotifyPropertyChanged</i> <br>   <code>INotifyPropertyChanged</code>     ,      .      ,    ;   ,   ,     ,    ,       . <br> <br>   <br> ,       ,           <code>PropertyChanged</code>  ,         .  ,    <code>ChangeTracker</code> ,     MVVM,  ,      .      .     ,    . <br> <br> <code class="cs">var changeTracker = new PropertyChangeTracker(viewModel); viewModel.CurrentState = "newState"; CollectionAssert.Contains(changeTracker.ChangedProperties, "CurrentState");</code> <br> ,     ,     <code>INotifyPropertyChanged</code> ,    ,   ,     . <br> <br>      <br>        ,   ,    <code>set</code>      ,           . ,     ,     ,      ,          . <br> <br> <code class="cs">var changeTracker = new PropertyChangeTracker(viewModel); var question = viewModel.Questions.First() as OpenQuestionViewModel; question.Question.Response = "some text"; CollectionAssert.Contains(changeTracker.ChangedProperties, "UnansweredQuestions");</code> <br>      <br>     <code>INotifyPropertyChanged</code> ,      <code>PropertyChanged</code>        ,  ,     , , .        ,       . <br> <br>   <i>INotifyDataErrorInfo</i> <br>   ,     ,    ,   ,   <code>IDataErrorInfo</code> ,  ( Silverlight)   <code>INotifyDataErrorInfo</code> .   <code>INotifyDataErrorInfo</code>   ,         ,    ,  ,   ,    . <br> <br>       <code>INotifyDataErrorInfo</code> : ,     ,  ,     ,     <code>ErrorsChanged</code> ,      <code>GetErrors</code> , . <br> <br>    <br>     ,      ,     .       ,         <code>GetErrors</code>       ,  ,  ,   .    , ,  ,     ,        .   ,        . <br> <br> <code class="cs">//  . var notifyErrorInfo = (INotifyDataErrorInfo)question; question.Response = -15; Assert.IsTrue(notifyErrorInfo.GetErrors("Response").Cast&lt;ValidationResult&gt;().Any()); //  . var notifyErrorInfo = (INotifyDataErrorInfo)question; question.Response = 15; Assert.IsFalse(notifyErrorInfo.GetErrors("Response").Cast&lt;ValidationResult&gt;().Any());</code> <br>    ,    ,             . <br> <br>    <i>INotifyDataErrorInfo</i> <br>       <code>GetErrors</code> ,   <code>INotifyDataErrorInfo</code>  ,   <code>ErrorsChanged</code>      <code>GetErrors</code> . ,  <code>HasErrors</code>      ,  . <br> <br>       <code>INotifyDataErrorInfo</code> . , ,           ,   -  .      ,        <code>INotifyDataErrorInfo</code>         (,        ). <br> <br>     ,   ,  : <br>  <code>HasErrors</code>     .              ,       .  <code>ErrorsChanged</code> ,      ,         <code>GetErrors</code> .         ( ,  )     ,           .    <code>GetErrors</code>       <code>ErrorsChanged</code> . <br>    <code>INotifyPropertyChanged</code> ,  ,    <code>NotifyDataErrorInfoTestHelper</code>    MVVM,        <code>INotifyDataErrorInfo</code> ,       .   ,   ,      ,   .      . <br> <code class="cs">var helper = new NotifyDataErrorInfoTestHelper&lt;NumericQuestion, int?&gt;( question, q =&gt; q.Response); helper.ValidatePropertyChange( 6, NotifyDataErrorInfoBehavior.Nothing); helper.ValidatePropertyChange( 20, NotifyDataErrorInfoBehavior.FiresErrorsChanged | NotifyDataErrorInfoBehavior.HasErrors | NotifyDataErrorInfoBehavior.HasErrorsForProperty); helper.ValidatePropertyChange( null, NotifyDataErrorInfoBehavior.FiresErrorsChanged | NotifyDataErrorInfoBehavior.HasErrors | NotifyDataErrorInfoBehavior.HasErrorsForProperty); helper.ValidatePropertyChange( 2, NotifyDataErrorInfoBehavior.FiresErrorsChanged);</code> <br>     <br>   MVVM,     ,  .   ,    ,         . <br> <br>  ,     ,     ,       .   ,   , ,       ,     ,   <code>IAsyncResult</code>    ,  - ,   ,    UI. <br> <br>       , , ,    .   ,     .  ,      UI,     ,   ,          ,     ,        "   UI." <br> <br>     ,    ,    .   ,    ,     mock-, ,   ,   ,      ,          . <br> <br>           UI,    ,    .   ,     ,   ,      .        ,   .     ,    ,     . <br> <br> <code class="cs">questionnaireRepositoryMock .Setup( r =&gt; r.SubmitQuestionnaireAsync( It.IsAny&lt;Questionnaire&gt;(), It.IsAny&lt;Action&lt;IOperationResult&gt;&gt;())) .Callback&lt;Questionnaire, Action&lt;IOperationResult&gt;&gt;( (q, a) =&gt; callback = a); uiServicemock .Setup(svc =&gt; svc.ShowView(ViewNames.QuestionnaireTemplatesList)) .Callback&lt;string&gt;(viewName =&gt; requestedViewName = viewName); submitResultMock .Setup(sr =&gt; sr.Error) .Returns&lt;Exception&gt;(null); CompleteQuestionnaire(viewModel); viewModel.Submit(); //      UI . callback(submitResultMock.Object); //    ‚Äì     . Assert.AreEqual(ViewNames.QuestionnaireTemplatesList, requestedViewName);</code> <br> <b></b> <br>          ,        . <br>   <br>       , . "Trees in WPF"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ms753391.aspx">http://msdn.microsoft.com/en-us/library/ms753391.aspx</a> <br> <br>       , . "Attached Properties Overview"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/cc265152(VS.95).aspx">http://msdn.microsoft.com/en-us/library/cc265152(VS.95).aspx</a> <br> <br>      MEF, ."Managed Extensibility Framework Overview"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/dd460648.aspx">http://msdn.microsoft.com/en-us/library/dd460648.aspx</a> . <br> <br>      Unity, ."Unity Application Block"  MSDN: <a href="http://www.msdn.com/unity">http://www.msdn.com/unity</a> . <br> <br>      <code>DelegateCommand</code> , .Chapter 5, " <a href="http://msdn.microsoft.com/en-us/library/gg405484(v%3DPandP.40).aspx">Implementing the MVVM Pattern</a> ." <br> <br>        Microsoft Expression Blend, ."Working with built-in behaviors"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ff724013(v%3DExpression.40).aspx">http://msdn.microsoft.com/en-us/library/ff724013(v=Expression.40).aspx</a> . <br> <br>          Microsoft Expression Blend, ."Creating Custom Behaviors"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ff724708(v%3DExpression.40).aspx">http://msdn.microsoft.com/en-us/library/ff724708(v=Expression.40).aspx</a> . <br> <br>            Microsoft Expression Blend, ."Creating Custom Triggers and Actions"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ff724707(v%3DExpression.40).aspx">http://msdn.microsoft.com/en-us/library/ff724707(v=Expression.40).aspx</a> . <br> <br>         WPF  Silverlight, ."Threading Model"  "The Dispatcher Class"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ms741870.aspx">http://msdn.microsoft.com/en-us/library/ms741870.aspx</a> <br> <a href="http://msdn.microsoft.com/en-us/library/ms615907(v%3DVS.95).aspx">http://msdn.microsoft.com/en-us/library/ms615907(v=VS.95).aspx</a> . <br> <br>      unit-  Silverlight, ."Unit Testing with Silverlight 2": <a href="http://www.jeff.wilcox.name/2008/03/silverlight2-unit-testing/">http://www.jeff.wilcox.name/2008/03/silverlight2-unit-testing/</a> . <br> <br>         , .  " <a href="http://msdn.microsoft.com/en-us/library/gg430861(v%3DPandP.40).aspx">View-Based Navigation</a> " in Chapter 8, " <a href="http://msdn.microsoft.com/en-us/library/gg430861(v%3DPandP.40).aspx">Navigation</a> ." <br> <br>       ,   , ."Event-based Asynchronous Pattern Overview"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/wewwczdw.aspx">http://msdn.microsoft.com/en-us/library/wewwczdw.aspx</a> <br> <br>        <code>IAsyncResult</code> , ."Asynchronous Programming Overview"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ms228963.aspx">http://msdn.microsoft.com/en-us/library/ms228963.aspx</a></code></code></code></code></code></code></code></code></code> <h4> <code><code><code><code><code><code><code><code><code><code>CommandBehaviorBase ,    ,    ICommand</code> .           <code>CanExecuteChanged</code> ,          Silverlight,    WPF. <br> <br>    ,  ,   <code>CommandBehaviorBase    ,    .         ,      .         ,    .      ButtonBaseClickCommandBehavior</code> . <br> <br> <code class="cs">public class ButtonBaseClickCommandBehavior : CommandBehaviorBase&lt;ButtonBase&gt; { public ButtonBaseClickCommandBehavior(ButtonBase clickableObject) : base(clickableObject) { clickableObject.Click += OnClick; } private void OnClick(object sender, System.Windows.RoutedEventArgs e) { ExecuteCommand(); } }</code> <br>   <code>CommandBehaviorBase ,     .     ,          ,   . ,    ,    ,      , ,    CanExecute</code>  ,     . <br> <br>          ,   .           XAML.           .       .  Prism      ,       ,  ,   .       ,    . , ,  ,      <code>Click</code> ,       <code>Command</code> .    <code>Click.Command</code> ,  . <br> <br>             .             . <br> <br> <code class="cs">public static readonly DependencyProperty CommandProperty = DependencyProperty.RegisterAttached( "Command", typeof(ICommand), typeof(Click), new PropertyMetadata(OnSetCommandCallback)); private static readonly DependencyProperty ClickCommandBehaviorProperty = DependencyProperty.RegisterAttached( "ClickCommandBehavior", typeof(ButtonBaseClickCommandBehavior), typeof(Click), null);</code> <br>    <code>Command</code>    <code>ButtonBaseClickCommandBehavior</code> ,     <code>OnSetCommandCallback</code> ,     . <br> <br> <code class="cs">private static void OnSetCommandCallback(DependencyObject dependencyObject, DependencyPropertyChangedEventArgs e) { ButtonBase buttonBase = dependencyObject as ButtonBase; if (buttonBase != null) { ButtonBaseClickCommandBehavior behavior = GetOrCreateBehavior(buttonBase); behavior.Command = e.NewValue as ICommand; } } private static void OnSetCommandParameterCallback(DependencyObject dependencyObject, DependencyPropertyChangedEventArgs e) { ButtonBase buttonBase = dependencyObject as ButtonBase; if (buttonBase != null) { ButtonBaseClickCommandBehavior behavior = GetOrCreateBehavior(buttonBase); behavior.CommandParameter = e.NewValue; } } private static ButtonBaseClickCommandBehavior GetOrCreateBehavior(ButtonBase buttonBase ) { ButtonBaseClickCommandBehavior behavior = buttonBase.GetValue(ClickCommandBehaviorProperty) as ButtonBaseClickCommandBehavior; if ( behavior == null ) { behavior = new ButtonBaseClickCommandBehavior(buttonBase); buttonBase.SetValue(ClickCommandBehaviorProperty, behavior); } return behavior; }</code> <br>        ,  <a href="http://msdn.microsoft.com/en-us/library/cc265152(VS.95).aspx">Attached Properties Overview</a>  MSDN. <br> <br>    <br>              . ,     Silverlight,    -,     ,      ,     .     ,       . <br> <br>        ,    ( )  ,  ,     .  UI       ,            UI. <br> <br>      - <br>   -     ,       <code>IAsyncResult</code> .   ,  ,   ,  <code>GetQuestionnaire</code> ,   : <code>BeginGetQuestionnaire</code>  <code>EndGetQuestionnaire</code> .    ,   <code>BeginGetQuestionnaire</code> .     ,   ,   <code>EndGetQuestionnaire</code>    . <br> <b></b> <br>  .NET Framework 4.5      <code>await</code>  <code>async</code>     <code>*Async</code> .      <a href="http://msdn.microsoft.com/en-us/library/vstudio/hh391443.aspx">"Asynchronous Programming with Async and Await (C# and Visual Basic)"</a> . <br>  ,    <code>EndGetQuestionnaire</code> ,      ,  ()      <code>BeginGetQuestionnaire</code> .     ,      ,   <code>EndGetQuestionnaire</code> ,   . <br> <br> <code class="xml">IAsyncResult asyncResult = this.service.BeginGetQuestionnaire( GetQuestionnaireCompleted, null //  ,      ); private void GetQuestionnaireCompleted(IAsyncResult result) { try { questionnaire = this.service.EndGetQuestionnaire(ar); } catch (Exception ex) { //  -   . } }</code> <br>  ,     <code>End*</code> (  , <code>EndGetQuestionnaire</code> ),    ,      .      , ,          UI.     ,   ,        . <br> <br>        UI,     -,      UI,         UI,   <code>Dispatcher</code>    <code>SynchronizationContext</code> .  WPF  Silverlight,   <code>Dispatcher</code> . <br> <br>      <code>Questionnaire</code>  ,        <code>QuestionnaireView</code> .  Silverlight    <code>CheckAccess</code> ,  ,      UI.  ,     <code>BeginInvoke</code> ,      UI. <br> <br> <code class="cs">var dispatcher = System.Windows.Deployment.Current.Dispatcher; if (dispatcher.CheckAccess()) { QuestionnaireView.DataContext = questionnaire; } else { dispatcher.BeginInvoke(() =&gt; { Questionnaire.DataContext = questionnaire; }); }</code> <br> <i>MVVM RI</i>   ,    ,   <code>IAsyncResult</code> ,   .      ,                 . ,       . <br> <br> <code class="cs">this.questionnaireRepository.GetQuestionnaireAsync( result =&gt; { this.Questionnaire = result.Result; });</code> <br>  <code>result</code>   ,     , , , .    ,     . <br> <br> <code class="cs">this.questionnaireRepository.GetQuestionnaireAsync( result =&gt; { if (result.Error == null) { this.Questionnaire = result.Result; ... } else { // Handle error. } })</code> <br>     <br>        ,      .     , ,             .        ,      ,     ,     . <br> <br>         ,      MVVM,     ,   . ,  -MVVM ,     <code>MessageBox</code>   code-behind UI,      .   MVVM     ,          . <br> <br>     MVVM,              ,          .      ,    ,   ,  ,     . <br> <br>              MVVM.      ,     ,     ,  ,     .    ,         ,     ,          .       . <br> <br>    <br>                  .        ,        .  ,         .         . <br> <br>  ,         ,         ,  .      ,     .           ,       . ,        WPF  Silverlight,        . <br> <br> <img title="Using the service to interact with the user." src="https://habrastorage.org/getpro/habr/post_images/4b5/397/f2d/4b5397f2d02e5851195b29f1893be6fc.png" alt=" ,    ."> <br> <br>  ,   <code>MessageBox</code>        ,     ,    ,     . <br> <br> <code class="cs">var result = interactionService.ShowMessageBox( "Are you sure you want to cancel this operation?", "Confirm", MessageBoxButton.OK); if (result == MessageBoxResult.Yes) { CancelRequest(); }</code> <br> ,      - ,      ,         Silverlight.         .             .     . <br> <br> <code class="cs">interactionService.ShowMessageBox( "Are you sure you want to cancel this operation?", "Confirm", MessageBoxButton.OK, result =&gt; { if (result == MessageBoxResult.Yes) { CancelRequest(); } });</code> <br>         ,      . ,  WPF    <code>MessageBox</code> ,       ;    Silverlight    ,    . <br> <br>     <br>         ‚Äì             .         ,      .     ,     .        ,        ,   ,     . <br> <br> <img title="Using interaction request objects." src="https://habrastorage.org/getpro/habr/post_images/3d0/ff0/1c5/3d0ff01c5518558c2d3c5c5f47ce0ce9.png" alt="   ."> <br> <br>    ,   ,          ‚Äì       ,      ,   ‚Äì     .   ,        ,    ,    UI            . <br> <br>       MVVM,     ,       ,         .         ,        ,    ,   . <br> <br>  Prism       <code>IInteractionRequest</code>   <code>InteractionRequest .  IInteractionRequest</code>  ,   .           ,   .  <code>InteractionRequest   IInteractionRequest</code>     <code>Raise</code> ,           , , ,   . <br> <br>       <br>  <code>InteractionRequest          .  Raise</code>          ( <code>T</code> )    ,    ,   .          ,       .      ,        .    ,  ,     . <br> <code class="cs">public interface IInteractionRequest { event EventHandler&lt;InteractionRequestedEventArgs&gt; Raised; } public class InteractionRequest&lt;T&gt; : IInteractionRequest { public event EventHandler&lt;InteractionRequestedEventArgs&gt; Raised; public void Raise(T context, Action&lt;T&gt; callback) { var handler = this.Raised; if (handler != null) { handler( this, new InteractionRequestedEventArgs(context, () =&gt; callback(context))); } } }</code> <br> Prism    ,      .  <code>Notification</code>       .    ,            .     ‚Äì <code>Title</code>  <code>Content</code> ,    .  ,   ,  ,  ,        . <br> <br>  <code>Confirmation</code>    <code>Notification</code>     ‚Äì <code>Confirmed</code> ,  ,  ,      .  <code>Confirmation</code> ,     <code>MessageBox</code> ,     /  .     ,     <code>Notification</code> ,     ,      . <br> <br>    <code>InteractionRequest ,       InteractionRequest      ,      .      ,    Raise</code> ,    , ,   . <br> <br> <code class="cs">public IInteractionRequest ConfirmCancelInteractionRequest { get { return this.confirmCancelInteractionRequest; } } this.confirmCancelInteractionRequest.Raise( new Confirmation("Are you sure you wish to cancel?"), confirmation =&gt; { if (confirmation.Confirmed) { this.NavigateToQuestionnaireList(); } }); }</code> <br> <i>MVVM Reference Implementation (MVVM RI)</i> ,    <code>IInteractionRequest</code>   <code>InteractionRequest ,          (. QuestionnaireViewModel.cs</code> ). <br> <br>        <br>       ,       .   ,       .    UI             . <br> <br>                . Microsoft Expression Blend Behaviors Framework     .  ,     ,    . <br> <br>  <code>EventTrigger</code> ,  Expression Blend,  ,      ,     ,   . , Prism   <code>EventTrigger</code> ,  <code>InteractionRequestTrigger</code> ,      <code>Raised</code>   <code>IInteractionRequest</code> .    XAML        . <br> <br>  ,   , <code>InteractionRequestTrigger</code>   .  Silverlight Prism   <code>PopupChildWindowAction</code> ,     .    ,         .   <code>ContentTemplate</code>  <code>PopupChildWindowAction</code> ,    ,    UI,      <code>Content</code>  .       <code>Title</code>  . <br> <b></b> <br>  ,    ,   <code>PopupChildWindowAction</code> ,     .    <code>Notification</code>  <code>NotificationChildWindow</code> ,        <code>Confirmation</code> ‚Äì <code>ConfirmationChildWindow</code> . <code>NotificationChildWindow</code>    ,   ,     <code>ConfirmationChildWindow</code>    <i>OK</i>  <i>Cancel</i> ,    .    ,   ,   <code>ChildWindow</code>  <code>PopupChildWindowAction</code> . <br>   ,  <code>InteractionRequestTrigger</code>  <code>PopupChildWindowAction</code> ,       <i>RI MVVM</i> . <br> <br> <code class="xml">&lt;i:Interaction.Triggers&gt; &lt;prism:InteractionRequestTrigger SourceObject="{Binding ConfirmCancelInteractionRequest}"&gt; &lt;prism:PopupChildWindowAction ContentTemplate="{StaticResource ConfirmWindowTemplate}"/&gt; &lt;/prism:InteractionRequestTrigger&gt; &lt;/i:Interaction.Triggers&gt; &lt;UserControl.Resources&gt; &lt;DataTemplate x:Key="ConfirmWindowTemplate"&gt; &lt;Grid MinWidth="250" MinHeight="100"&gt; &lt;TextBlock TextWrapping="Wrap" Grid.Row="0" Text="{Binding}"/&gt; &lt;/Grid&gt; &lt;/DataTemplate&gt; &lt;/UserControl.Resources&gt;</code> <br> <b></b> <br>      <code>ContentTemplate</code> ,   UI   <code>Content</code>  .    <code>Content</code>  ,  , <code>TextBlock</code>     <code>Content</code> . <br>      ,     ,    ,    .  ,     ,       ,     ,    .   ,   <i>RI MVVM</i> ,         <code>Confirmed</code>    <code>Confirmation</code>  <code>true</code> ,     OK. <br> <br>        ,     .  Prism <code>InteractionRequestTrigger</code>   <code>PopupChildWindowAction</code>            . <br> <br>     <br>     MVVM,       , ,    ,         .        (  , ,  ,   ).    ,  ,  ,            . <br> <br>        ,         . Managed Extensibility Framework (MEF)  Unity Application Block (Unity)      ,  ,           . <br> <br>  ,       , , ,    ( )      . ,       ,     .  ,     ,       . <br> <br>     ,  MEF <br>  MEF,       ,   <code>Import</code> ,      ,  ,   <code>Export</code> .         ,    . <br> <br> , <code>QuestionnaireView</code>   <i>RI MVVM</i> ,        ,    <code>Import</code> .   , MEF           .  <code>set</code>        ,   . <br> <br> <code class="cs">[Import] public QuestionnaireViewModel ViewModel { set { this.DataContext = value; } }</code> <br>     ,   . <br> <br> <code class="cs">[Export] public class QuestionnaireViewModel : NotificationObject { ... }</code> <br>        ,   . <br> <br> <code class="cs">public QuestionnaireView() { InitializeComponent(); } [ImportingConstructor] public QuestionnaireView(QuestionnaireViewModel viewModel) : this() { this.DataContext = viewModel; }</code> <br> <b></b> <br>          MEF,   Unity.   ,     ,        .   ,   Visual Studio  Expression Blend, ,        ,     .   ,   ,  ,      ,          <code>InitializeComponent</code> . <br>     ,  Unity <br>  Unity,    ,   MEF.     ,      .    ,         .  ,      . <br> <br>  ,      ,  ,         . ,           ,   . <br> <br> <code class="cs">public QuestionnaireView() { InitializeComponent(); } public QuestionnaireView(QuestionnaireViewModel viewModel) : this() { this.DataContext = viewModel; }</code> <br> <b></b> <br>    ,        ,   Visual Studio  Expression Blend. <br>  ,          ,   . Unity        <code>set</code>   ,   . <br> <br> <code class="cs">public QuestionnaireView() { InitializeComponent(); } [Dependency] public QuestionnaireViewModel ViewModel { set { this.DataContext = value; } }</code> <br>       Unity. <br> <br> <code class="cs">container.RegisterType&lt;QuestionnaireViewModel&gt;();</code> <br>  ,     . <br> <br> <code class="cs">var view = container.Resolve&lt;QuestionnaireView&gt;();</code> <br>     ,    <br>   ,     ,        .        ,   MEF  Unity,        . <br> <br>          .   ,         UI,           . <br> <br> , <i>RI MVVM</i>   ,   ,        .   ,    .      <code>ShowView</code>   UI. <br> <br> <code class="cs">private void NavigateToQuestionnaireList() { //     "questionnaire list". this.uiService.ShowView(ViewNames.QuestionnaireTemplatesList); }</code> <br>  UI      UI .           UI.  <code>ShowView</code>  <code>UIService</code>      (,          ),       ,   . <br> <br> <code class="cs">public void ShowView(string viewName) { var view = this.ViewFactory.GetView(viewName); this.MainWindow.CurrentView = view; }</code> <br> <b></b> <br> Prism       .   ,   ,   ,             .    ,  , " <a href="http://msdn.microsoft.com/en-us/library/gg430861(v%3DPandP.40).aspx">View-Based Navigation</a> "   8, " <a href="http://msdn.microsoft.com/en-us/library/gg430861(v%3DPandP.40).aspx">Navigation</a> ". <br>  MVVM  <br>        MVVM      .           -      mocking . ,   ,        . <br> <br>   <i>INotifyPropertyChanged</i> <br>   <code>INotifyPropertyChanged</code>     ,      .      ,    ;   ,   ,     ,    ,       . <br> <br>   <br> ,       ,           <code>PropertyChanged</code>  ,         .  ,    <code>ChangeTracker</code> ,     MVVM,  ,      .      .     ,    . <br> <br> <code class="cs">var changeTracker = new PropertyChangeTracker(viewModel); viewModel.CurrentState = "newState"; CollectionAssert.Contains(changeTracker.ChangedProperties, "CurrentState");</code> <br> ,     ,     <code>INotifyPropertyChanged</code> ,    ,   ,     . <br> <br>      <br>        ,   ,    <code>set</code>      ,           . ,     ,     ,      ,          . <br> <br> <code class="cs">var changeTracker = new PropertyChangeTracker(viewModel); var question = viewModel.Questions.First() as OpenQuestionViewModel; question.Question.Response = "some text"; CollectionAssert.Contains(changeTracker.ChangedProperties, "UnansweredQuestions");</code> <br>      <br>     <code>INotifyPropertyChanged</code> ,      <code>PropertyChanged</code>        ,  ,     , , .        ,       . <br> <br>   <i>INotifyDataErrorInfo</i> <br>   ,     ,    ,   ,   <code>IDataErrorInfo</code> ,  ( Silverlight)   <code>INotifyDataErrorInfo</code> .   <code>INotifyDataErrorInfo</code>   ,         ,    ,  ,   ,    . <br> <br>       <code>INotifyDataErrorInfo</code> : ,     ,  ,     ,     <code>ErrorsChanged</code> ,      <code>GetErrors</code> , . <br> <br>    <br>     ,      ,     .       ,         <code>GetErrors</code>       ,  ,  ,   .    , ,  ,     ,        .   ,        . <br> <br> <code class="cs">//  . var notifyErrorInfo = (INotifyDataErrorInfo)question; question.Response = -15; Assert.IsTrue(notifyErrorInfo.GetErrors("Response").Cast&lt;ValidationResult&gt;().Any()); //  . var notifyErrorInfo = (INotifyDataErrorInfo)question; question.Response = 15; Assert.IsFalse(notifyErrorInfo.GetErrors("Response").Cast&lt;ValidationResult&gt;().Any());</code> <br>    ,    ,             . <br> <br>    <i>INotifyDataErrorInfo</i> <br>       <code>GetErrors</code> ,   <code>INotifyDataErrorInfo</code>  ,   <code>ErrorsChanged</code>      <code>GetErrors</code> . ,  <code>HasErrors</code>      ,  . <br> <br>       <code>INotifyDataErrorInfo</code> . , ,           ,   -  .      ,        <code>INotifyDataErrorInfo</code>         (,        ). <br> <br>     ,   ,  : <br>  <code>HasErrors</code>     .              ,       .  <code>ErrorsChanged</code> ,      ,         <code>GetErrors</code> .         ( ,  )     ,           .    <code>GetErrors</code>       <code>ErrorsChanged</code> . <br>    <code>INotifyPropertyChanged</code> ,  ,    <code>NotifyDataErrorInfoTestHelper</code>    MVVM,        <code>INotifyDataErrorInfo</code> ,       .   ,   ,      ,   .      . <br> <code class="cs">var helper = new NotifyDataErrorInfoTestHelper&lt;NumericQuestion, int?&gt;( question, q =&gt; q.Response); helper.ValidatePropertyChange( 6, NotifyDataErrorInfoBehavior.Nothing); helper.ValidatePropertyChange( 20, NotifyDataErrorInfoBehavior.FiresErrorsChanged | NotifyDataErrorInfoBehavior.HasErrors | NotifyDataErrorInfoBehavior.HasErrorsForProperty); helper.ValidatePropertyChange( null, NotifyDataErrorInfoBehavior.FiresErrorsChanged | NotifyDataErrorInfoBehavior.HasErrors | NotifyDataErrorInfoBehavior.HasErrorsForProperty); helper.ValidatePropertyChange( 2, NotifyDataErrorInfoBehavior.FiresErrorsChanged);</code> <br>     <br>   MVVM,     ,  .   ,    ,         . <br> <br>  ,     ,     ,       .   ,   , ,       ,     ,   <code>IAsyncResult</code>    ,  - ,   ,    UI. <br> <br>       , , ,    .   ,     .  ,      UI,     ,   ,          ,     ,        "   UI." <br> <br>     ,    ,    .   ,    ,     mock-, ,   ,   ,      ,          . <br> <br>           UI,    ,    .   ,     ,   ,      .        ,   .     ,    ,     . <br> <br> <code class="cs">questionnaireRepositoryMock .Setup( r =&gt; r.SubmitQuestionnaireAsync( It.IsAny&lt;Questionnaire&gt;(), It.IsAny&lt;Action&lt;IOperationResult&gt;&gt;())) .Callback&lt;Questionnaire, Action&lt;IOperationResult&gt;&gt;( (q, a) =&gt; callback = a); uiServicemock .Setup(svc =&gt; svc.ShowView(ViewNames.QuestionnaireTemplatesList)) .Callback&lt;string&gt;(viewName =&gt; requestedViewName = viewName); submitResultMock .Setup(sr =&gt; sr.Error) .Returns&lt;Exception&gt;(null); CompleteQuestionnaire(viewModel); viewModel.Submit(); //      UI . callback(submitResultMock.Object); //    ‚Äì     . Assert.AreEqual(ViewNames.QuestionnaireTemplatesList, requestedViewName);</code> <br> <b></b> <br>          ,        . <br>   <br>       , . "Trees in WPF"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ms753391.aspx">http://msdn.microsoft.com/en-us/library/ms753391.aspx</a> <br> <br>       , . "Attached Properties Overview"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/cc265152(VS.95).aspx">http://msdn.microsoft.com/en-us/library/cc265152(VS.95).aspx</a> <br> <br>      MEF, ."Managed Extensibility Framework Overview"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/dd460648.aspx">http://msdn.microsoft.com/en-us/library/dd460648.aspx</a> . <br> <br>      Unity, ."Unity Application Block"  MSDN: <a href="http://www.msdn.com/unity">http://www.msdn.com/unity</a> . <br> <br>      <code>DelegateCommand</code> , .Chapter 5, " <a href="http://msdn.microsoft.com/en-us/library/gg405484(v%3DPandP.40).aspx">Implementing the MVVM Pattern</a> ." <br> <br>        Microsoft Expression Blend, ."Working with built-in behaviors"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ff724013(v%3DExpression.40).aspx">http://msdn.microsoft.com/en-us/library/ff724013(v=Expression.40).aspx</a> . <br> <br>          Microsoft Expression Blend, ."Creating Custom Behaviors"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ff724708(v%3DExpression.40).aspx">http://msdn.microsoft.com/en-us/library/ff724708(v=Expression.40).aspx</a> . <br> <br>            Microsoft Expression Blend, ."Creating Custom Triggers and Actions"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ff724707(v%3DExpression.40).aspx">http://msdn.microsoft.com/en-us/library/ff724707(v=Expression.40).aspx</a> . <br> <br>         WPF  Silverlight, ."Threading Model"  "The Dispatcher Class"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ms741870.aspx">http://msdn.microsoft.com/en-us/library/ms741870.aspx</a> <br> <a href="http://msdn.microsoft.com/en-us/library/ms615907(v%3DVS.95).aspx">http://msdn.microsoft.com/en-us/library/ms615907(v=VS.95).aspx</a> . <br> <br>      unit-  Silverlight, ."Unit Testing with Silverlight 2": <a href="http://www.jeff.wilcox.name/2008/03/silverlight2-unit-testing/">http://www.jeff.wilcox.name/2008/03/silverlight2-unit-testing/</a> . <br> <br>         , .  " <a href="http://msdn.microsoft.com/en-us/library/gg430861(v%3DPandP.40).aspx">View-Based Navigation</a> " in Chapter 8, " <a href="http://msdn.microsoft.com/en-us/library/gg430861(v%3DPandP.40).aspx">Navigation</a> ." <br> <br>       ,   , ."Event-based Asynchronous Pattern Overview"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/wewwczdw.aspx">http://msdn.microsoft.com/en-us/library/wewwczdw.aspx</a> <br> <br>        <code>IAsyncResult</code> , ."Asynchronous Programming Overview"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ms228963.aspx">http://msdn.microsoft.com/en-us/library/ms228963.aspx</a></code></code></code></code></code></code></code></code></code> </h4> <code><code><code><code><code><code><code><code><code><code>CommandBehaviorBase ,    ,    ICommand</code> .           <code>CanExecuteChanged</code> ,          Silverlight,    WPF. <br> <br>    ,  ,   <code>CommandBehaviorBase    ,    .         ,      .         ,    .      ButtonBaseClickCommandBehavior</code> . <br> <br> <code class="cs">public class ButtonBaseClickCommandBehavior : CommandBehaviorBase&lt;ButtonBase&gt; { public ButtonBaseClickCommandBehavior(ButtonBase clickableObject) : base(clickableObject) { clickableObject.Click += OnClick; } private void OnClick(object sender, System.Windows.RoutedEventArgs e) { ExecuteCommand(); } }</code> <br>   <code>CommandBehaviorBase ,     .     ,          ,   . ,    ,    ,      , ,    CanExecute</code>  ,     . <br> <br>          ,   .           XAML.           .       .  Prism      ,       ,  ,   .       ,    . , ,  ,      <code>Click</code> ,       <code>Command</code> .    <code>Click.Command</code> ,  . <br> <br>             .             . <br> <br> <code class="cs">public static readonly DependencyProperty CommandProperty = DependencyProperty.RegisterAttached( "Command", typeof(ICommand), typeof(Click), new PropertyMetadata(OnSetCommandCallback)); private static readonly DependencyProperty ClickCommandBehaviorProperty = DependencyProperty.RegisterAttached( "ClickCommandBehavior", typeof(ButtonBaseClickCommandBehavior), typeof(Click), null);</code> <br>    <code>Command</code>    <code>ButtonBaseClickCommandBehavior</code> ,     <code>OnSetCommandCallback</code> ,     . <br> <br> <code class="cs">private static void OnSetCommandCallback(DependencyObject dependencyObject, DependencyPropertyChangedEventArgs e) { ButtonBase buttonBase = dependencyObject as ButtonBase; if (buttonBase != null) { ButtonBaseClickCommandBehavior behavior = GetOrCreateBehavior(buttonBase); behavior.Command = e.NewValue as ICommand; } } private static void OnSetCommandParameterCallback(DependencyObject dependencyObject, DependencyPropertyChangedEventArgs e) { ButtonBase buttonBase = dependencyObject as ButtonBase; if (buttonBase != null) { ButtonBaseClickCommandBehavior behavior = GetOrCreateBehavior(buttonBase); behavior.CommandParameter = e.NewValue; } } private static ButtonBaseClickCommandBehavior GetOrCreateBehavior(ButtonBase buttonBase ) { ButtonBaseClickCommandBehavior behavior = buttonBase.GetValue(ClickCommandBehaviorProperty) as ButtonBaseClickCommandBehavior; if ( behavior == null ) { behavior = new ButtonBaseClickCommandBehavior(buttonBase); buttonBase.SetValue(ClickCommandBehaviorProperty, behavior); } return behavior; }</code> <br>        ,  <a href="http://msdn.microsoft.com/en-us/library/cc265152(VS.95).aspx">Attached Properties Overview</a>  MSDN. <br> <br>    <br>              . ,     Silverlight,    -,     ,      ,     .     ,       . <br> <br>        ,    ( )  ,  ,     .  UI       ,            UI. <br> <br>      - <br>   -     ,       <code>IAsyncResult</code> .   ,  ,   ,  <code>GetQuestionnaire</code> ,   : <code>BeginGetQuestionnaire</code>  <code>EndGetQuestionnaire</code> .    ,   <code>BeginGetQuestionnaire</code> .     ,   ,   <code>EndGetQuestionnaire</code>    . <br> <b></b> <br>  .NET Framework 4.5      <code>await</code>  <code>async</code>     <code>*Async</code> .      <a href="http://msdn.microsoft.com/en-us/library/vstudio/hh391443.aspx">"Asynchronous Programming with Async and Await (C# and Visual Basic)"</a> . <br>  ,    <code>EndGetQuestionnaire</code> ,      ,  ()      <code>BeginGetQuestionnaire</code> .     ,      ,   <code>EndGetQuestionnaire</code> ,   . <br> <br> <code class="xml">IAsyncResult asyncResult = this.service.BeginGetQuestionnaire( GetQuestionnaireCompleted, null //  ,      ); private void GetQuestionnaireCompleted(IAsyncResult result) { try { questionnaire = this.service.EndGetQuestionnaire(ar); } catch (Exception ex) { //  -   . } }</code> <br>  ,     <code>End*</code> (  , <code>EndGetQuestionnaire</code> ),    ,      .      , ,          UI.     ,   ,        . <br> <br>        UI,     -,      UI,         UI,   <code>Dispatcher</code>    <code>SynchronizationContext</code> .  WPF  Silverlight,   <code>Dispatcher</code> . <br> <br>      <code>Questionnaire</code>  ,        <code>QuestionnaireView</code> .  Silverlight    <code>CheckAccess</code> ,  ,      UI.  ,     <code>BeginInvoke</code> ,      UI. <br> <br> <code class="cs">var dispatcher = System.Windows.Deployment.Current.Dispatcher; if (dispatcher.CheckAccess()) { QuestionnaireView.DataContext = questionnaire; } else { dispatcher.BeginInvoke(() =&gt; { Questionnaire.DataContext = questionnaire; }); }</code> <br> <i>MVVM RI</i>   ,    ,   <code>IAsyncResult</code> ,   .      ,                 . ,       . <br> <br> <code class="cs">this.questionnaireRepository.GetQuestionnaireAsync( result =&gt; { this.Questionnaire = result.Result; });</code> <br>  <code>result</code>   ,     , , , .    ,     . <br> <br> <code class="cs">this.questionnaireRepository.GetQuestionnaireAsync( result =&gt; { if (result.Error == null) { this.Questionnaire = result.Result; ... } else { // Handle error. } })</code> <br>     <br>        ,      .     , ,             .        ,      ,     ,     . <br> <br>         ,      MVVM,     ,   . ,  -MVVM ,     <code>MessageBox</code>   code-behind UI,      .   MVVM     ,          . <br> <br>     MVVM,              ,          .      ,    ,   ,  ,     . <br> <br>              MVVM.      ,     ,     ,  ,     .    ,         ,     ,          .       . <br> <br>    <br>                  .        ,        .  ,         .         . <br> <br>  ,         ,         ,  .      ,     .           ,       . ,        WPF  Silverlight,        . <br> <br> <img title="Using the service to interact with the user." src="https://habrastorage.org/getpro/habr/post_images/4b5/397/f2d/4b5397f2d02e5851195b29f1893be6fc.png" alt=" ,    ."> <br> <br>  ,   <code>MessageBox</code>        ,     ,    ,     . <br> <br> <code class="cs">var result = interactionService.ShowMessageBox( "Are you sure you want to cancel this operation?", "Confirm", MessageBoxButton.OK); if (result == MessageBoxResult.Yes) { CancelRequest(); }</code> <br> ,      - ,      ,         Silverlight.         .             .     . <br> <br> <code class="cs">interactionService.ShowMessageBox( "Are you sure you want to cancel this operation?", "Confirm", MessageBoxButton.OK, result =&gt; { if (result == MessageBoxResult.Yes) { CancelRequest(); } });</code> <br>         ,      . ,  WPF    <code>MessageBox</code> ,       ;    Silverlight    ,    . <br> <br>     <br>         ‚Äì             .         ,      .     ,     .        ,        ,   ,     . <br> <br> <img title="Using interaction request objects." src="https://habrastorage.org/getpro/habr/post_images/3d0/ff0/1c5/3d0ff01c5518558c2d3c5c5f47ce0ce9.png" alt="   ."> <br> <br>    ,   ,          ‚Äì       ,      ,   ‚Äì     .   ,        ,    ,    UI            . <br> <br>       MVVM,     ,       ,         .         ,        ,    ,   . <br> <br>  Prism       <code>IInteractionRequest</code>   <code>InteractionRequest .  IInteractionRequest</code>  ,   .           ,   .  <code>InteractionRequest   IInteractionRequest</code>     <code>Raise</code> ,           , , ,   . <br> <br>       <br>  <code>InteractionRequest          .  Raise</code>          ( <code>T</code> )    ,    ,   .          ,       .      ,        .    ,  ,     . <br> <code class="cs">public interface IInteractionRequest { event EventHandler&lt;InteractionRequestedEventArgs&gt; Raised; } public class InteractionRequest&lt;T&gt; : IInteractionRequest { public event EventHandler&lt;InteractionRequestedEventArgs&gt; Raised; public void Raise(T context, Action&lt;T&gt; callback) { var handler = this.Raised; if (handler != null) { handler( this, new InteractionRequestedEventArgs(context, () =&gt; callback(context))); } } }</code> <br> Prism    ,      .  <code>Notification</code>       .    ,            .     ‚Äì <code>Title</code>  <code>Content</code> ,    .  ,   ,  ,  ,        . <br> <br>  <code>Confirmation</code>    <code>Notification</code>     ‚Äì <code>Confirmed</code> ,  ,  ,      .  <code>Confirmation</code> ,     <code>MessageBox</code> ,     /  .     ,     <code>Notification</code> ,     ,      . <br> <br>    <code>InteractionRequest ,       InteractionRequest      ,      .      ,    Raise</code> ,    , ,   . <br> <br> <code class="cs">public IInteractionRequest ConfirmCancelInteractionRequest { get { return this.confirmCancelInteractionRequest; } } this.confirmCancelInteractionRequest.Raise( new Confirmation("Are you sure you wish to cancel?"), confirmation =&gt; { if (confirmation.Confirmed) { this.NavigateToQuestionnaireList(); } }); }</code> <br> <i>MVVM Reference Implementation (MVVM RI)</i> ,    <code>IInteractionRequest</code>   <code>InteractionRequest ,          (. QuestionnaireViewModel.cs</code> ). <br> <br>        <br>       ,       .   ,       .    UI             . <br> <br>                . Microsoft Expression Blend Behaviors Framework     .  ,     ,    . <br> <br>  <code>EventTrigger</code> ,  Expression Blend,  ,      ,     ,   . , Prism   <code>EventTrigger</code> ,  <code>InteractionRequestTrigger</code> ,      <code>Raised</code>   <code>IInteractionRequest</code> .    XAML        . <br> <br>  ,   , <code>InteractionRequestTrigger</code>   .  Silverlight Prism   <code>PopupChildWindowAction</code> ,     .    ,         .   <code>ContentTemplate</code>  <code>PopupChildWindowAction</code> ,    ,    UI,      <code>Content</code>  .       <code>Title</code>  . <br> <b></b> <br>  ,    ,   <code>PopupChildWindowAction</code> ,     .    <code>Notification</code>  <code>NotificationChildWindow</code> ,        <code>Confirmation</code> ‚Äì <code>ConfirmationChildWindow</code> . <code>NotificationChildWindow</code>    ,   ,     <code>ConfirmationChildWindow</code>    <i>OK</i>  <i>Cancel</i> ,    .    ,   ,   <code>ChildWindow</code>  <code>PopupChildWindowAction</code> . <br>   ,  <code>InteractionRequestTrigger</code>  <code>PopupChildWindowAction</code> ,       <i>RI MVVM</i> . <br> <br> <code class="xml">&lt;i:Interaction.Triggers&gt; &lt;prism:InteractionRequestTrigger SourceObject="{Binding ConfirmCancelInteractionRequest}"&gt; &lt;prism:PopupChildWindowAction ContentTemplate="{StaticResource ConfirmWindowTemplate}"/&gt; &lt;/prism:InteractionRequestTrigger&gt; &lt;/i:Interaction.Triggers&gt; &lt;UserControl.Resources&gt; &lt;DataTemplate x:Key="ConfirmWindowTemplate"&gt; &lt;Grid MinWidth="250" MinHeight="100"&gt; &lt;TextBlock TextWrapping="Wrap" Grid.Row="0" Text="{Binding}"/&gt; &lt;/Grid&gt; &lt;/DataTemplate&gt; &lt;/UserControl.Resources&gt;</code> <br> <b></b> <br>      <code>ContentTemplate</code> ,   UI   <code>Content</code>  .    <code>Content</code>  ,  , <code>TextBlock</code>     <code>Content</code> . <br>      ,     ,    ,    .  ,     ,       ,     ,    .   ,   <i>RI MVVM</i> ,         <code>Confirmed</code>    <code>Confirmation</code>  <code>true</code> ,     OK. <br> <br>        ,     .  Prism <code>InteractionRequestTrigger</code>   <code>PopupChildWindowAction</code>            . <br> <br>     <br>     MVVM,       , ,    ,         .        (  , ,  ,   ).    ,  ,  ,            . <br> <br>        ,         . Managed Extensibility Framework (MEF)  Unity Application Block (Unity)      ,  ,           . <br> <br>  ,       , , ,    ( )      . ,       ,     .  ,     ,       . <br> <br>     ,  MEF <br>  MEF,       ,   <code>Import</code> ,      ,  ,   <code>Export</code> .         ,    . <br> <br> , <code>QuestionnaireView</code>   <i>RI MVVM</i> ,        ,    <code>Import</code> .   , MEF           .  <code>set</code>        ,   . <br> <br> <code class="cs">[Import] public QuestionnaireViewModel ViewModel { set { this.DataContext = value; } }</code> <br>     ,   . <br> <br> <code class="cs">[Export] public class QuestionnaireViewModel : NotificationObject { ... }</code> <br>        ,   . <br> <br> <code class="cs">public QuestionnaireView() { InitializeComponent(); } [ImportingConstructor] public QuestionnaireView(QuestionnaireViewModel viewModel) : this() { this.DataContext = viewModel; }</code> <br> <b></b> <br>          MEF,   Unity.   ,     ,        .   ,   Visual Studio  Expression Blend, ,        ,     .   ,   ,  ,      ,          <code>InitializeComponent</code> . <br>     ,  Unity <br>  Unity,    ,   MEF.     ,      .    ,         .  ,      . <br> <br>  ,      ,  ,         . ,           ,   . <br> <br> <code class="cs">public QuestionnaireView() { InitializeComponent(); } public QuestionnaireView(QuestionnaireViewModel viewModel) : this() { this.DataContext = viewModel; }</code> <br> <b></b> <br>    ,        ,   Visual Studio  Expression Blend. <br>  ,          ,   . Unity        <code>set</code>   ,   . <br> <br> <code class="cs">public QuestionnaireView() { InitializeComponent(); } [Dependency] public QuestionnaireViewModel ViewModel { set { this.DataContext = value; } }</code> <br>       Unity. <br> <br> <code class="cs">container.RegisterType&lt;QuestionnaireViewModel&gt;();</code> <br>  ,     . <br> <br> <code class="cs">var view = container.Resolve&lt;QuestionnaireView&gt;();</code> <br>     ,    <br>   ,     ,        .        ,   MEF  Unity,        . <br> <br>          .   ,         UI,           . <br> <br> , <i>RI MVVM</i>   ,   ,        .   ,    .      <code>ShowView</code>   UI. <br> <br> <code class="cs">private void NavigateToQuestionnaireList() { //     "questionnaire list". this.uiService.ShowView(ViewNames.QuestionnaireTemplatesList); }</code> <br>  UI      UI .           UI.  <code>ShowView</code>  <code>UIService</code>      (,          ),       ,   . <br> <br> <code class="cs">public void ShowView(string viewName) { var view = this.ViewFactory.GetView(viewName); this.MainWindow.CurrentView = view; }</code> <br> <b></b> <br> Prism       .   ,   ,   ,             .    ,  , " <a href="http://msdn.microsoft.com/en-us/library/gg430861(v%3DPandP.40).aspx">View-Based Navigation</a> "   8, " <a href="http://msdn.microsoft.com/en-us/library/gg430861(v%3DPandP.40).aspx">Navigation</a> ". <br>  MVVM  <br>        MVVM      .           -      mocking . ,   ,        . <br> <br>   <i>INotifyPropertyChanged</i> <br>   <code>INotifyPropertyChanged</code>     ,      .      ,    ;   ,   ,     ,    ,       . <br> <br>   <br> ,       ,           <code>PropertyChanged</code>  ,         .  ,    <code>ChangeTracker</code> ,     MVVM,  ,      .      .     ,    . <br> <br> <code class="cs">var changeTracker = new PropertyChangeTracker(viewModel); viewModel.CurrentState = "newState"; CollectionAssert.Contains(changeTracker.ChangedProperties, "CurrentState");</code> <br> ,     ,     <code>INotifyPropertyChanged</code> ,    ,   ,     . <br> <br>      <br>        ,   ,    <code>set</code>      ,           . ,     ,     ,      ,          . <br> <br> <code class="cs">var changeTracker = new PropertyChangeTracker(viewModel); var question = viewModel.Questions.First() as OpenQuestionViewModel; question.Question.Response = "some text"; CollectionAssert.Contains(changeTracker.ChangedProperties, "UnansweredQuestions");</code> <br>      <br>     <code>INotifyPropertyChanged</code> ,      <code>PropertyChanged</code>        ,  ,     , , .        ,       . <br> <br>   <i>INotifyDataErrorInfo</i> <br>   ,     ,    ,   ,   <code>IDataErrorInfo</code> ,  ( Silverlight)   <code>INotifyDataErrorInfo</code> .   <code>INotifyDataErrorInfo</code>   ,         ,    ,  ,   ,    . <br> <br>       <code>INotifyDataErrorInfo</code> : ,     ,  ,     ,     <code>ErrorsChanged</code> ,      <code>GetErrors</code> , . <br> <br>    <br>     ,      ,     .       ,         <code>GetErrors</code>       ,  ,  ,   .    , ,  ,     ,        .   ,        . <br> <br> <code class="cs">//  . var notifyErrorInfo = (INotifyDataErrorInfo)question; question.Response = -15; Assert.IsTrue(notifyErrorInfo.GetErrors("Response").Cast&lt;ValidationResult&gt;().Any()); //  . var notifyErrorInfo = (INotifyDataErrorInfo)question; question.Response = 15; Assert.IsFalse(notifyErrorInfo.GetErrors("Response").Cast&lt;ValidationResult&gt;().Any());</code> <br>    ,    ,             . <br> <br>    <i>INotifyDataErrorInfo</i> <br>       <code>GetErrors</code> ,   <code>INotifyDataErrorInfo</code>  ,   <code>ErrorsChanged</code>      <code>GetErrors</code> . ,  <code>HasErrors</code>      ,  . <br> <br>       <code>INotifyDataErrorInfo</code> . , ,           ,   -  .      ,        <code>INotifyDataErrorInfo</code>         (,        ). <br> <br>     ,   ,  : <br>  <code>HasErrors</code>     .              ,       .  <code>ErrorsChanged</code> ,      ,         <code>GetErrors</code> .         ( ,  )     ,           .    <code>GetErrors</code>       <code>ErrorsChanged</code> . <br>    <code>INotifyPropertyChanged</code> ,  ,    <code>NotifyDataErrorInfoTestHelper</code>    MVVM,        <code>INotifyDataErrorInfo</code> ,       .   ,   ,      ,   .      . <br> <code class="cs">var helper = new NotifyDataErrorInfoTestHelper&lt;NumericQuestion, int?&gt;( question, q =&gt; q.Response); helper.ValidatePropertyChange( 6, NotifyDataErrorInfoBehavior.Nothing); helper.ValidatePropertyChange( 20, NotifyDataErrorInfoBehavior.FiresErrorsChanged | NotifyDataErrorInfoBehavior.HasErrors | NotifyDataErrorInfoBehavior.HasErrorsForProperty); helper.ValidatePropertyChange( null, NotifyDataErrorInfoBehavior.FiresErrorsChanged | NotifyDataErrorInfoBehavior.HasErrors | NotifyDataErrorInfoBehavior.HasErrorsForProperty); helper.ValidatePropertyChange( 2, NotifyDataErrorInfoBehavior.FiresErrorsChanged);</code> <br>     <br>   MVVM,     ,  .   ,    ,         . <br> <br>  ,     ,     ,       .   ,   , ,       ,     ,   <code>IAsyncResult</code>    ,  - ,   ,    UI. <br> <br>       , , ,    .   ,     .  ,      UI,     ,   ,          ,     ,        "   UI." <br> <br>     ,    ,    .   ,    ,     mock-, ,   ,   ,      ,          . <br> <br>           UI,    ,    .   ,     ,   ,      .        ,   .     ,    ,     . <br> <br> <code class="cs">questionnaireRepositoryMock .Setup( r =&gt; r.SubmitQuestionnaireAsync( It.IsAny&lt;Questionnaire&gt;(), It.IsAny&lt;Action&lt;IOperationResult&gt;&gt;())) .Callback&lt;Questionnaire, Action&lt;IOperationResult&gt;&gt;( (q, a) =&gt; callback = a); uiServicemock .Setup(svc =&gt; svc.ShowView(ViewNames.QuestionnaireTemplatesList)) .Callback&lt;string&gt;(viewName =&gt; requestedViewName = viewName); submitResultMock .Setup(sr =&gt; sr.Error) .Returns&lt;Exception&gt;(null); CompleteQuestionnaire(viewModel); viewModel.Submit(); //      UI . callback(submitResultMock.Object); //    ‚Äì     . Assert.AreEqual(ViewNames.QuestionnaireTemplatesList, requestedViewName);</code> <br> <b></b> <br>          ,        . <br>   <br>       , . "Trees in WPF"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ms753391.aspx">http://msdn.microsoft.com/en-us/library/ms753391.aspx</a> <br> <br>       , . "Attached Properties Overview"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/cc265152(VS.95).aspx">http://msdn.microsoft.com/en-us/library/cc265152(VS.95).aspx</a> <br> <br>      MEF, ."Managed Extensibility Framework Overview"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/dd460648.aspx">http://msdn.microsoft.com/en-us/library/dd460648.aspx</a> . <br> <br>      Unity, ."Unity Application Block"  MSDN: <a href="http://www.msdn.com/unity">http://www.msdn.com/unity</a> . <br> <br>      <code>DelegateCommand</code> , .Chapter 5, " <a href="http://msdn.microsoft.com/en-us/library/gg405484(v%3DPandP.40).aspx">Implementing the MVVM Pattern</a> ." <br> <br>        Microsoft Expression Blend, ."Working with built-in behaviors"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ff724013(v%3DExpression.40).aspx">http://msdn.microsoft.com/en-us/library/ff724013(v=Expression.40).aspx</a> . <br> <br>          Microsoft Expression Blend, ."Creating Custom Behaviors"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ff724708(v%3DExpression.40).aspx">http://msdn.microsoft.com/en-us/library/ff724708(v=Expression.40).aspx</a> . <br> <br>            Microsoft Expression Blend, ."Creating Custom Triggers and Actions"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ff724707(v%3DExpression.40).aspx">http://msdn.microsoft.com/en-us/library/ff724707(v=Expression.40).aspx</a> . <br> <br>         WPF  Silverlight, ."Threading Model"  "The Dispatcher Class"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ms741870.aspx">http://msdn.microsoft.com/en-us/library/ms741870.aspx</a> <br> <a href="http://msdn.microsoft.com/en-us/library/ms615907(v%3DVS.95).aspx">http://msdn.microsoft.com/en-us/library/ms615907(v=VS.95).aspx</a> . <br> <br>      unit-  Silverlight, ."Unit Testing with Silverlight 2": <a href="http://www.jeff.wilcox.name/2008/03/silverlight2-unit-testing/">http://www.jeff.wilcox.name/2008/03/silverlight2-unit-testing/</a> . <br> <br>         , .  " <a href="http://msdn.microsoft.com/en-us/library/gg430861(v%3DPandP.40).aspx">View-Based Navigation</a> " in Chapter 8, " <a href="http://msdn.microsoft.com/en-us/library/gg430861(v%3DPandP.40).aspx">Navigation</a> ." <br> <br>       ,   , ."Event-based Asynchronous Pattern Overview"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/wewwczdw.aspx">http://msdn.microsoft.com/en-us/library/wewwczdw.aspx</a> <br> <br>        <code>IAsyncResult</code> , ."Asynchronous Programming Overview"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ms228963.aspx">http://msdn.microsoft.com/en-us/library/ms228963.aspx</a></code></code></code></code></code></code></code></code></code> <h5> <code><code><code><code><code><code><code><code><code><code>CommandBehaviorBase ,    ,    ICommand</code> .           <code>CanExecuteChanged</code> ,          Silverlight,    WPF. <br> <br>    ,  ,   <code>CommandBehaviorBase    ,    .         ,      .         ,    .      ButtonBaseClickCommandBehavior</code> . <br> <br> <code class="cs">public class ButtonBaseClickCommandBehavior : CommandBehaviorBase&lt;ButtonBase&gt; { public ButtonBaseClickCommandBehavior(ButtonBase clickableObject) : base(clickableObject) { clickableObject.Click += OnClick; } private void OnClick(object sender, System.Windows.RoutedEventArgs e) { ExecuteCommand(); } }</code> <br>   <code>CommandBehaviorBase ,     .     ,          ,   . ,    ,    ,      , ,    CanExecute</code>  ,     . <br> <br>          ,   .           XAML.           .       .  Prism      ,       ,  ,   .       ,    . , ,  ,      <code>Click</code> ,       <code>Command</code> .    <code>Click.Command</code> ,  . <br> <br>             .             . <br> <br> <code class="cs">public static readonly DependencyProperty CommandProperty = DependencyProperty.RegisterAttached( "Command", typeof(ICommand), typeof(Click), new PropertyMetadata(OnSetCommandCallback)); private static readonly DependencyProperty ClickCommandBehaviorProperty = DependencyProperty.RegisterAttached( "ClickCommandBehavior", typeof(ButtonBaseClickCommandBehavior), typeof(Click), null);</code> <br>    <code>Command</code>    <code>ButtonBaseClickCommandBehavior</code> ,     <code>OnSetCommandCallback</code> ,     . <br> <br> <code class="cs">private static void OnSetCommandCallback(DependencyObject dependencyObject, DependencyPropertyChangedEventArgs e) { ButtonBase buttonBase = dependencyObject as ButtonBase; if (buttonBase != null) { ButtonBaseClickCommandBehavior behavior = GetOrCreateBehavior(buttonBase); behavior.Command = e.NewValue as ICommand; } } private static void OnSetCommandParameterCallback(DependencyObject dependencyObject, DependencyPropertyChangedEventArgs e) { ButtonBase buttonBase = dependencyObject as ButtonBase; if (buttonBase != null) { ButtonBaseClickCommandBehavior behavior = GetOrCreateBehavior(buttonBase); behavior.CommandParameter = e.NewValue; } } private static ButtonBaseClickCommandBehavior GetOrCreateBehavior(ButtonBase buttonBase ) { ButtonBaseClickCommandBehavior behavior = buttonBase.GetValue(ClickCommandBehaviorProperty) as ButtonBaseClickCommandBehavior; if ( behavior == null ) { behavior = new ButtonBaseClickCommandBehavior(buttonBase); buttonBase.SetValue(ClickCommandBehaviorProperty, behavior); } return behavior; }</code> <br>        ,  <a href="http://msdn.microsoft.com/en-us/library/cc265152(VS.95).aspx">Attached Properties Overview</a>  MSDN. <br> <br>    <br>              . ,     Silverlight,    -,     ,      ,     .     ,       . <br> <br>        ,    ( )  ,  ,     .  UI       ,            UI. <br> <br>      - <br>   -     ,       <code>IAsyncResult</code> .   ,  ,   ,  <code>GetQuestionnaire</code> ,   : <code>BeginGetQuestionnaire</code>  <code>EndGetQuestionnaire</code> .    ,   <code>BeginGetQuestionnaire</code> .     ,   ,   <code>EndGetQuestionnaire</code>    . <br> <b></b> <br>  .NET Framework 4.5      <code>await</code>  <code>async</code>     <code>*Async</code> .      <a href="http://msdn.microsoft.com/en-us/library/vstudio/hh391443.aspx">"Asynchronous Programming with Async and Await (C# and Visual Basic)"</a> . <br>  ,    <code>EndGetQuestionnaire</code> ,      ,  ()      <code>BeginGetQuestionnaire</code> .     ,      ,   <code>EndGetQuestionnaire</code> ,   . <br> <br> <code class="xml">IAsyncResult asyncResult = this.service.BeginGetQuestionnaire( GetQuestionnaireCompleted, null //  ,      ); private void GetQuestionnaireCompleted(IAsyncResult result) { try { questionnaire = this.service.EndGetQuestionnaire(ar); } catch (Exception ex) { //  -   . } }</code> <br>  ,     <code>End*</code> (  , <code>EndGetQuestionnaire</code> ),    ,      .      , ,          UI.     ,   ,        . <br> <br>        UI,     -,      UI,         UI,   <code>Dispatcher</code>    <code>SynchronizationContext</code> .  WPF  Silverlight,   <code>Dispatcher</code> . <br> <br>      <code>Questionnaire</code>  ,        <code>QuestionnaireView</code> .  Silverlight    <code>CheckAccess</code> ,  ,      UI.  ,     <code>BeginInvoke</code> ,      UI. <br> <br> <code class="cs">var dispatcher = System.Windows.Deployment.Current.Dispatcher; if (dispatcher.CheckAccess()) { QuestionnaireView.DataContext = questionnaire; } else { dispatcher.BeginInvoke(() =&gt; { Questionnaire.DataContext = questionnaire; }); }</code> <br> <i>MVVM RI</i>   ,    ,   <code>IAsyncResult</code> ,   .      ,                 . ,       . <br> <br> <code class="cs">this.questionnaireRepository.GetQuestionnaireAsync( result =&gt; { this.Questionnaire = result.Result; });</code> <br>  <code>result</code>   ,     , , , .    ,     . <br> <br> <code class="cs">this.questionnaireRepository.GetQuestionnaireAsync( result =&gt; { if (result.Error == null) { this.Questionnaire = result.Result; ... } else { // Handle error. } })</code> <br>     <br>        ,      .     , ,             .        ,      ,     ,     . <br> <br>         ,      MVVM,     ,   . ,  -MVVM ,     <code>MessageBox</code>   code-behind UI,      .   MVVM     ,          . <br> <br>     MVVM,              ,          .      ,    ,   ,  ,     . <br> <br>              MVVM.      ,     ,     ,  ,     .    ,         ,     ,          .       . <br> <br>    <br>                  .        ,        .  ,         .         . <br> <br>  ,         ,         ,  .      ,     .           ,       . ,        WPF  Silverlight,        . <br> <br> <img title="Using the service to interact with the user." src="https://habrastorage.org/getpro/habr/post_images/4b5/397/f2d/4b5397f2d02e5851195b29f1893be6fc.png" alt=" ,    ."> <br> <br>  ,   <code>MessageBox</code>        ,     ,    ,     . <br> <br> <code class="cs">var result = interactionService.ShowMessageBox( "Are you sure you want to cancel this operation?", "Confirm", MessageBoxButton.OK); if (result == MessageBoxResult.Yes) { CancelRequest(); }</code> <br> ,      - ,      ,         Silverlight.         .             .     . <br> <br> <code class="cs">interactionService.ShowMessageBox( "Are you sure you want to cancel this operation?", "Confirm", MessageBoxButton.OK, result =&gt; { if (result == MessageBoxResult.Yes) { CancelRequest(); } });</code> <br>         ,      . ,  WPF    <code>MessageBox</code> ,       ;    Silverlight    ,    . <br> <br>     <br>         ‚Äì             .         ,      .     ,     .        ,        ,   ,     . <br> <br> <img title="Using interaction request objects." src="https://habrastorage.org/getpro/habr/post_images/3d0/ff0/1c5/3d0ff01c5518558c2d3c5c5f47ce0ce9.png" alt="   ."> <br> <br>    ,   ,          ‚Äì       ,      ,   ‚Äì     .   ,        ,    ,    UI            . <br> <br>       MVVM,     ,       ,         .         ,        ,    ,   . <br> <br>  Prism       <code>IInteractionRequest</code>   <code>InteractionRequest .  IInteractionRequest</code>  ,   .           ,   .  <code>InteractionRequest   IInteractionRequest</code>     <code>Raise</code> ,           , , ,   . <br> <br>       <br>  <code>InteractionRequest          .  Raise</code>          ( <code>T</code> )    ,    ,   .          ,       .      ,        .    ,  ,     . <br> <code class="cs">public interface IInteractionRequest { event EventHandler&lt;InteractionRequestedEventArgs&gt; Raised; } public class InteractionRequest&lt;T&gt; : IInteractionRequest { public event EventHandler&lt;InteractionRequestedEventArgs&gt; Raised; public void Raise(T context, Action&lt;T&gt; callback) { var handler = this.Raised; if (handler != null) { handler( this, new InteractionRequestedEventArgs(context, () =&gt; callback(context))); } } }</code> <br> Prism    ,      .  <code>Notification</code>       .    ,            .     ‚Äì <code>Title</code>  <code>Content</code> ,    .  ,   ,  ,  ,        . <br> <br>  <code>Confirmation</code>    <code>Notification</code>     ‚Äì <code>Confirmed</code> ,  ,  ,      .  <code>Confirmation</code> ,     <code>MessageBox</code> ,     /  .     ,     <code>Notification</code> ,     ,      . <br> <br>    <code>InteractionRequest ,       InteractionRequest      ,      .      ,    Raise</code> ,    , ,   . <br> <br> <code class="cs">public IInteractionRequest ConfirmCancelInteractionRequest { get { return this.confirmCancelInteractionRequest; } } this.confirmCancelInteractionRequest.Raise( new Confirmation("Are you sure you wish to cancel?"), confirmation =&gt; { if (confirmation.Confirmed) { this.NavigateToQuestionnaireList(); } }); }</code> <br> <i>MVVM Reference Implementation (MVVM RI)</i> ,    <code>IInteractionRequest</code>   <code>InteractionRequest ,          (. QuestionnaireViewModel.cs</code> ). <br> <br>        <br>       ,       .   ,       .    UI             . <br> <br>                . Microsoft Expression Blend Behaviors Framework     .  ,     ,    . <br> <br>  <code>EventTrigger</code> ,  Expression Blend,  ,      ,     ,   . , Prism   <code>EventTrigger</code> ,  <code>InteractionRequestTrigger</code> ,      <code>Raised</code>   <code>IInteractionRequest</code> .    XAML        . <br> <br>  ,   , <code>InteractionRequestTrigger</code>   .  Silverlight Prism   <code>PopupChildWindowAction</code> ,     .    ,         .   <code>ContentTemplate</code>  <code>PopupChildWindowAction</code> ,    ,    UI,      <code>Content</code>  .       <code>Title</code>  . <br> <b></b> <br>  ,    ,   <code>PopupChildWindowAction</code> ,     .    <code>Notification</code>  <code>NotificationChildWindow</code> ,        <code>Confirmation</code> ‚Äì <code>ConfirmationChildWindow</code> . <code>NotificationChildWindow</code>    ,   ,     <code>ConfirmationChildWindow</code>    <i>OK</i>  <i>Cancel</i> ,    .    ,   ,   <code>ChildWindow</code>  <code>PopupChildWindowAction</code> . <br>   ,  <code>InteractionRequestTrigger</code>  <code>PopupChildWindowAction</code> ,       <i>RI MVVM</i> . <br> <br> <code class="xml">&lt;i:Interaction.Triggers&gt; &lt;prism:InteractionRequestTrigger SourceObject="{Binding ConfirmCancelInteractionRequest}"&gt; &lt;prism:PopupChildWindowAction ContentTemplate="{StaticResource ConfirmWindowTemplate}"/&gt; &lt;/prism:InteractionRequestTrigger&gt; &lt;/i:Interaction.Triggers&gt; &lt;UserControl.Resources&gt; &lt;DataTemplate x:Key="ConfirmWindowTemplate"&gt; &lt;Grid MinWidth="250" MinHeight="100"&gt; &lt;TextBlock TextWrapping="Wrap" Grid.Row="0" Text="{Binding}"/&gt; &lt;/Grid&gt; &lt;/DataTemplate&gt; &lt;/UserControl.Resources&gt;</code> <br> <b></b> <br>      <code>ContentTemplate</code> ,   UI   <code>Content</code>  .    <code>Content</code>  ,  , <code>TextBlock</code>     <code>Content</code> . <br>      ,     ,    ,    .  ,     ,       ,     ,    .   ,   <i>RI MVVM</i> ,         <code>Confirmed</code>    <code>Confirmation</code>  <code>true</code> ,     OK. <br> <br>        ,     .  Prism <code>InteractionRequestTrigger</code>   <code>PopupChildWindowAction</code>            . <br> <br>     <br>     MVVM,       , ,    ,         .        (  , ,  ,   ).    ,  ,  ,            . <br> <br>        ,         . Managed Extensibility Framework (MEF)  Unity Application Block (Unity)      ,  ,           . <br> <br>  ,       , , ,    ( )      . ,       ,     .  ,     ,       . <br> <br>     ,  MEF <br>  MEF,       ,   <code>Import</code> ,      ,  ,   <code>Export</code> .         ,    . <br> <br> , <code>QuestionnaireView</code>   <i>RI MVVM</i> ,        ,    <code>Import</code> .   , MEF           .  <code>set</code>        ,   . <br> <br> <code class="cs">[Import] public QuestionnaireViewModel ViewModel { set { this.DataContext = value; } }</code> <br>     ,   . <br> <br> <code class="cs">[Export] public class QuestionnaireViewModel : NotificationObject { ... }</code> <br>        ,   . <br> <br> <code class="cs">public QuestionnaireView() { InitializeComponent(); } [ImportingConstructor] public QuestionnaireView(QuestionnaireViewModel viewModel) : this() { this.DataContext = viewModel; }</code> <br> <b></b> <br>          MEF,   Unity.   ,     ,        .   ,   Visual Studio  Expression Blend, ,        ,     .   ,   ,  ,      ,          <code>InitializeComponent</code> . <br>     ,  Unity <br>  Unity,    ,   MEF.     ,      .    ,         .  ,      . <br> <br>  ,      ,  ,         . ,           ,   . <br> <br> <code class="cs">public QuestionnaireView() { InitializeComponent(); } public QuestionnaireView(QuestionnaireViewModel viewModel) : this() { this.DataContext = viewModel; }</code> <br> <b></b> <br>    ,        ,   Visual Studio  Expression Blend. <br>  ,          ,   . Unity        <code>set</code>   ,   . <br> <br> <code class="cs">public QuestionnaireView() { InitializeComponent(); } [Dependency] public QuestionnaireViewModel ViewModel { set { this.DataContext = value; } }</code> <br>       Unity. <br> <br> <code class="cs">container.RegisterType&lt;QuestionnaireViewModel&gt;();</code> <br>  ,     . <br> <br> <code class="cs">var view = container.Resolve&lt;QuestionnaireView&gt;();</code> <br>     ,    <br>   ,     ,        .        ,   MEF  Unity,        . <br> <br>          .   ,         UI,           . <br> <br> , <i>RI MVVM</i>   ,   ,        .   ,    .      <code>ShowView</code>   UI. <br> <br> <code class="cs">private void NavigateToQuestionnaireList() { //     "questionnaire list". this.uiService.ShowView(ViewNames.QuestionnaireTemplatesList); }</code> <br>  UI      UI .           UI.  <code>ShowView</code>  <code>UIService</code>      (,          ),       ,   . <br> <br> <code class="cs">public void ShowView(string viewName) { var view = this.ViewFactory.GetView(viewName); this.MainWindow.CurrentView = view; }</code> <br> <b></b> <br> Prism       .   ,   ,   ,             .    ,  , " <a href="http://msdn.microsoft.com/en-us/library/gg430861(v%3DPandP.40).aspx">View-Based Navigation</a> "   8, " <a href="http://msdn.microsoft.com/en-us/library/gg430861(v%3DPandP.40).aspx">Navigation</a> ". <br>  MVVM  <br>        MVVM      .           -      mocking . ,   ,        . <br> <br>   <i>INotifyPropertyChanged</i> <br>   <code>INotifyPropertyChanged</code>     ,      .      ,    ;   ,   ,     ,    ,       . <br> <br>   <br> ,       ,           <code>PropertyChanged</code>  ,         .  ,    <code>ChangeTracker</code> ,     MVVM,  ,      .      .     ,    . <br> <br> <code class="cs">var changeTracker = new PropertyChangeTracker(viewModel); viewModel.CurrentState = "newState"; CollectionAssert.Contains(changeTracker.ChangedProperties, "CurrentState");</code> <br> ,     ,     <code>INotifyPropertyChanged</code> ,    ,   ,     . <br> <br>      <br>        ,   ,    <code>set</code>      ,           . ,     ,     ,      ,          . <br> <br> <code class="cs">var changeTracker = new PropertyChangeTracker(viewModel); var question = viewModel.Questions.First() as OpenQuestionViewModel; question.Question.Response = "some text"; CollectionAssert.Contains(changeTracker.ChangedProperties, "UnansweredQuestions");</code> <br>      <br>     <code>INotifyPropertyChanged</code> ,      <code>PropertyChanged</code>        ,  ,     , , .        ,       . <br> <br>   <i>INotifyDataErrorInfo</i> <br>   ,     ,    ,   ,   <code>IDataErrorInfo</code> ,  ( Silverlight)   <code>INotifyDataErrorInfo</code> .   <code>INotifyDataErrorInfo</code>   ,         ,    ,  ,   ,    . <br> <br>       <code>INotifyDataErrorInfo</code> : ,     ,  ,     ,     <code>ErrorsChanged</code> ,      <code>GetErrors</code> , . <br> <br>    <br>     ,      ,     .       ,         <code>GetErrors</code>       ,  ,  ,   .    , ,  ,     ,        .   ,        . <br> <br> <code class="cs">//  . var notifyErrorInfo = (INotifyDataErrorInfo)question; question.Response = -15; Assert.IsTrue(notifyErrorInfo.GetErrors("Response").Cast&lt;ValidationResult&gt;().Any()); //  . var notifyErrorInfo = (INotifyDataErrorInfo)question; question.Response = 15; Assert.IsFalse(notifyErrorInfo.GetErrors("Response").Cast&lt;ValidationResult&gt;().Any());</code> <br>    ,    ,             . <br> <br>    <i>INotifyDataErrorInfo</i> <br>       <code>GetErrors</code> ,   <code>INotifyDataErrorInfo</code>  ,   <code>ErrorsChanged</code>      <code>GetErrors</code> . ,  <code>HasErrors</code>      ,  . <br> <br>       <code>INotifyDataErrorInfo</code> . , ,           ,   -  .      ,        <code>INotifyDataErrorInfo</code>         (,        ). <br> <br>     ,   ,  : <br>  <code>HasErrors</code>     .              ,       .  <code>ErrorsChanged</code> ,      ,         <code>GetErrors</code> .         ( ,  )     ,           .    <code>GetErrors</code>       <code>ErrorsChanged</code> . <br>    <code>INotifyPropertyChanged</code> ,  ,    <code>NotifyDataErrorInfoTestHelper</code>    MVVM,        <code>INotifyDataErrorInfo</code> ,       .   ,   ,      ,   .      . <br> <code class="cs">var helper = new NotifyDataErrorInfoTestHelper&lt;NumericQuestion, int?&gt;( question, q =&gt; q.Response); helper.ValidatePropertyChange( 6, NotifyDataErrorInfoBehavior.Nothing); helper.ValidatePropertyChange( 20, NotifyDataErrorInfoBehavior.FiresErrorsChanged | NotifyDataErrorInfoBehavior.HasErrors | NotifyDataErrorInfoBehavior.HasErrorsForProperty); helper.ValidatePropertyChange( null, NotifyDataErrorInfoBehavior.FiresErrorsChanged | NotifyDataErrorInfoBehavior.HasErrors | NotifyDataErrorInfoBehavior.HasErrorsForProperty); helper.ValidatePropertyChange( 2, NotifyDataErrorInfoBehavior.FiresErrorsChanged);</code> <br>     <br>   MVVM,     ,  .   ,    ,         . <br> <br>  ,     ,     ,       .   ,   , ,       ,     ,   <code>IAsyncResult</code>    ,  - ,   ,    UI. <br> <br>       , , ,    .   ,     .  ,      UI,     ,   ,          ,     ,        "   UI." <br> <br>     ,    ,    .   ,    ,     mock-, ,   ,   ,      ,          . <br> <br>           UI,    ,    .   ,     ,   ,      .        ,   .     ,    ,     . <br> <br> <code class="cs">questionnaireRepositoryMock .Setup( r =&gt; r.SubmitQuestionnaireAsync( It.IsAny&lt;Questionnaire&gt;(), It.IsAny&lt;Action&lt;IOperationResult&gt;&gt;())) .Callback&lt;Questionnaire, Action&lt;IOperationResult&gt;&gt;( (q, a) =&gt; callback = a); uiServicemock .Setup(svc =&gt; svc.ShowView(ViewNames.QuestionnaireTemplatesList)) .Callback&lt;string&gt;(viewName =&gt; requestedViewName = viewName); submitResultMock .Setup(sr =&gt; sr.Error) .Returns&lt;Exception&gt;(null); CompleteQuestionnaire(viewModel); viewModel.Submit(); //      UI . callback(submitResultMock.Object); //    ‚Äì     . Assert.AreEqual(ViewNames.QuestionnaireTemplatesList, requestedViewName);</code> <br> <b></b> <br>          ,        . <br>   <br>       , . "Trees in WPF"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ms753391.aspx">http://msdn.microsoft.com/en-us/library/ms753391.aspx</a> <br> <br>       , . "Attached Properties Overview"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/cc265152(VS.95).aspx">http://msdn.microsoft.com/en-us/library/cc265152(VS.95).aspx</a> <br> <br>      MEF, ."Managed Extensibility Framework Overview"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/dd460648.aspx">http://msdn.microsoft.com/en-us/library/dd460648.aspx</a> . <br> <br>      Unity, ."Unity Application Block"  MSDN: <a href="http://www.msdn.com/unity">http://www.msdn.com/unity</a> . <br> <br>      <code>DelegateCommand</code> , .Chapter 5, " <a href="http://msdn.microsoft.com/en-us/library/gg405484(v%3DPandP.40).aspx">Implementing the MVVM Pattern</a> ." <br> <br>        Microsoft Expression Blend, ."Working with built-in behaviors"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ff724013(v%3DExpression.40).aspx">http://msdn.microsoft.com/en-us/library/ff724013(v=Expression.40).aspx</a> . <br> <br>          Microsoft Expression Blend, ."Creating Custom Behaviors"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ff724708(v%3DExpression.40).aspx">http://msdn.microsoft.com/en-us/library/ff724708(v=Expression.40).aspx</a> . <br> <br>            Microsoft Expression Blend, ."Creating Custom Triggers and Actions"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ff724707(v%3DExpression.40).aspx">http://msdn.microsoft.com/en-us/library/ff724707(v=Expression.40).aspx</a> . <br> <br>         WPF  Silverlight, ."Threading Model"  "The Dispatcher Class"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ms741870.aspx">http://msdn.microsoft.com/en-us/library/ms741870.aspx</a> <br> <a href="http://msdn.microsoft.com/en-us/library/ms615907(v%3DVS.95).aspx">http://msdn.microsoft.com/en-us/library/ms615907(v=VS.95).aspx</a> . <br> <br>      unit-  Silverlight, ."Unit Testing with Silverlight 2": <a href="http://www.jeff.wilcox.name/2008/03/silverlight2-unit-testing/">http://www.jeff.wilcox.name/2008/03/silverlight2-unit-testing/</a> . <br> <br>         , .  " <a href="http://msdn.microsoft.com/en-us/library/gg430861(v%3DPandP.40).aspx">View-Based Navigation</a> " in Chapter 8, " <a href="http://msdn.microsoft.com/en-us/library/gg430861(v%3DPandP.40).aspx">Navigation</a> ." <br> <br>       ,   , ."Event-based Asynchronous Pattern Overview"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/wewwczdw.aspx">http://msdn.microsoft.com/en-us/library/wewwczdw.aspx</a> <br> <br>        <code>IAsyncResult</code> , ."Asynchronous Programming Overview"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ms228963.aspx">http://msdn.microsoft.com/en-us/library/ms228963.aspx</a></code></code></code></code></code></code></code></code></code> </h5> <code><code><code><code><code><code><code><code><code><code>CommandBehaviorBase ,    ,    ICommand</code> .           <code>CanExecuteChanged</code> ,          Silverlight,    WPF. <br> <br>    ,  ,   <code>CommandBehaviorBase    ,    .         ,      .         ,    .      ButtonBaseClickCommandBehavior</code> . <br> <br> <code class="cs">public class ButtonBaseClickCommandBehavior : CommandBehaviorBase&lt;ButtonBase&gt; { public ButtonBaseClickCommandBehavior(ButtonBase clickableObject) : base(clickableObject) { clickableObject.Click += OnClick; } private void OnClick(object sender, System.Windows.RoutedEventArgs e) { ExecuteCommand(); } }</code> <br>   <code>CommandBehaviorBase ,     .     ,          ,   . ,    ,    ,      , ,    CanExecute</code>  ,     . <br> <br>          ,   .           XAML.           .       .  Prism      ,       ,  ,   .       ,    . , ,  ,      <code>Click</code> ,       <code>Command</code> .    <code>Click.Command</code> ,  . <br> <br>             .             . <br> <br> <code class="cs">public static readonly DependencyProperty CommandProperty = DependencyProperty.RegisterAttached( "Command", typeof(ICommand), typeof(Click), new PropertyMetadata(OnSetCommandCallback)); private static readonly DependencyProperty ClickCommandBehaviorProperty = DependencyProperty.RegisterAttached( "ClickCommandBehavior", typeof(ButtonBaseClickCommandBehavior), typeof(Click), null);</code> <br>    <code>Command</code>    <code>ButtonBaseClickCommandBehavior</code> ,     <code>OnSetCommandCallback</code> ,     . <br> <br> <code class="cs">private static void OnSetCommandCallback(DependencyObject dependencyObject, DependencyPropertyChangedEventArgs e) { ButtonBase buttonBase = dependencyObject as ButtonBase; if (buttonBase != null) { ButtonBaseClickCommandBehavior behavior = GetOrCreateBehavior(buttonBase); behavior.Command = e.NewValue as ICommand; } } private static void OnSetCommandParameterCallback(DependencyObject dependencyObject, DependencyPropertyChangedEventArgs e) { ButtonBase buttonBase = dependencyObject as ButtonBase; if (buttonBase != null) { ButtonBaseClickCommandBehavior behavior = GetOrCreateBehavior(buttonBase); behavior.CommandParameter = e.NewValue; } } private static ButtonBaseClickCommandBehavior GetOrCreateBehavior(ButtonBase buttonBase ) { ButtonBaseClickCommandBehavior behavior = buttonBase.GetValue(ClickCommandBehaviorProperty) as ButtonBaseClickCommandBehavior; if ( behavior == null ) { behavior = new ButtonBaseClickCommandBehavior(buttonBase); buttonBase.SetValue(ClickCommandBehaviorProperty, behavior); } return behavior; }</code> <br>        ,  <a href="http://msdn.microsoft.com/en-us/library/cc265152(VS.95).aspx">Attached Properties Overview</a>  MSDN. <br> <br>    <br>              . ,     Silverlight,    -,     ,      ,     .     ,       . <br> <br>        ,    ( )  ,  ,     .  UI       ,            UI. <br> <br>      - <br>   -     ,       <code>IAsyncResult</code> .   ,  ,   ,  <code>GetQuestionnaire</code> ,   : <code>BeginGetQuestionnaire</code>  <code>EndGetQuestionnaire</code> .    ,   <code>BeginGetQuestionnaire</code> .     ,   ,   <code>EndGetQuestionnaire</code>    . <br> <b></b> <br>  .NET Framework 4.5      <code>await</code>  <code>async</code>     <code>*Async</code> .      <a href="http://msdn.microsoft.com/en-us/library/vstudio/hh391443.aspx">"Asynchronous Programming with Async and Await (C# and Visual Basic)"</a> . <br>  ,    <code>EndGetQuestionnaire</code> ,      ,  ()      <code>BeginGetQuestionnaire</code> .     ,      ,   <code>EndGetQuestionnaire</code> ,   . <br> <br> <code class="xml">IAsyncResult asyncResult = this.service.BeginGetQuestionnaire( GetQuestionnaireCompleted, null //  ,      ); private void GetQuestionnaireCompleted(IAsyncResult result) { try { questionnaire = this.service.EndGetQuestionnaire(ar); } catch (Exception ex) { //  -   . } }</code> <br>  ,     <code>End*</code> (  , <code>EndGetQuestionnaire</code> ),    ,      .      , ,          UI.     ,   ,        . <br> <br>        UI,     -,      UI,         UI,   <code>Dispatcher</code>    <code>SynchronizationContext</code> .  WPF  Silverlight,   <code>Dispatcher</code> . <br> <br>      <code>Questionnaire</code>  ,        <code>QuestionnaireView</code> .  Silverlight    <code>CheckAccess</code> ,  ,      UI.  ,     <code>BeginInvoke</code> ,      UI. <br> <br> <code class="cs">var dispatcher = System.Windows.Deployment.Current.Dispatcher; if (dispatcher.CheckAccess()) { QuestionnaireView.DataContext = questionnaire; } else { dispatcher.BeginInvoke(() =&gt; { Questionnaire.DataContext = questionnaire; }); }</code> <br> <i>MVVM RI</i>   ,    ,   <code>IAsyncResult</code> ,   .      ,                 . ,       . <br> <br> <code class="cs">this.questionnaireRepository.GetQuestionnaireAsync( result =&gt; { this.Questionnaire = result.Result; });</code> <br>  <code>result</code>   ,     , , , .    ,     . <br> <br> <code class="cs">this.questionnaireRepository.GetQuestionnaireAsync( result =&gt; { if (result.Error == null) { this.Questionnaire = result.Result; ... } else { // Handle error. } })</code> <br>     <br>        ,      .     , ,             .        ,      ,     ,     . <br> <br>         ,      MVVM,     ,   . ,  -MVVM ,     <code>MessageBox</code>   code-behind UI,      .   MVVM     ,          . <br> <br>     MVVM,              ,          .      ,    ,   ,  ,     . <br> <br>              MVVM.      ,     ,     ,  ,     .    ,         ,     ,          .       . <br> <br>    <br>                  .        ,        .  ,         .         . <br> <br>  ,         ,         ,  .      ,     .           ,       . ,        WPF  Silverlight,        . <br> <br> <img title="Using the service to interact with the user." src="https://habrastorage.org/getpro/habr/post_images/4b5/397/f2d/4b5397f2d02e5851195b29f1893be6fc.png" alt=" ,    ."> <br> <br>  ,   <code>MessageBox</code>        ,     ,    ,     . <br> <br> <code class="cs">var result = interactionService.ShowMessageBox( "Are you sure you want to cancel this operation?", "Confirm", MessageBoxButton.OK); if (result == MessageBoxResult.Yes) { CancelRequest(); }</code> <br> ,      - ,      ,         Silverlight.         .             .     . <br> <br> <code class="cs">interactionService.ShowMessageBox( "Are you sure you want to cancel this operation?", "Confirm", MessageBoxButton.OK, result =&gt; { if (result == MessageBoxResult.Yes) { CancelRequest(); } });</code> <br>         ,      . ,  WPF    <code>MessageBox</code> ,       ;    Silverlight    ,    . <br> <br>     <br>         ‚Äì             .         ,      .     ,     .        ,        ,   ,     . <br> <br> <img title="Using interaction request objects." src="https://habrastorage.org/getpro/habr/post_images/3d0/ff0/1c5/3d0ff01c5518558c2d3c5c5f47ce0ce9.png" alt="   ."> <br> <br>    ,   ,          ‚Äì       ,      ,   ‚Äì     .   ,        ,    ,    UI            . <br> <br>       MVVM,     ,       ,         .         ,        ,    ,   . <br> <br>  Prism       <code>IInteractionRequest</code>   <code>InteractionRequest .  IInteractionRequest</code>  ,   .           ,   .  <code>InteractionRequest   IInteractionRequest</code>     <code>Raise</code> ,           , , ,   . <br> <br>       <br>  <code>InteractionRequest          .  Raise</code>          ( <code>T</code> )    ,    ,   .          ,       .      ,        .    ,  ,     . <br> <code class="cs">public interface IInteractionRequest { event EventHandler&lt;InteractionRequestedEventArgs&gt; Raised; } public class InteractionRequest&lt;T&gt; : IInteractionRequest { public event EventHandler&lt;InteractionRequestedEventArgs&gt; Raised; public void Raise(T context, Action&lt;T&gt; callback) { var handler = this.Raised; if (handler != null) { handler( this, new InteractionRequestedEventArgs(context, () =&gt; callback(context))); } } }</code> <br> Prism    ,      .  <code>Notification</code>       .    ,            .     ‚Äì <code>Title</code>  <code>Content</code> ,    .  ,   ,  ,  ,        . <br> <br>  <code>Confirmation</code>    <code>Notification</code>     ‚Äì <code>Confirmed</code> ,  ,  ,      .  <code>Confirmation</code> ,     <code>MessageBox</code> ,     /  .     ,     <code>Notification</code> ,     ,      . <br> <br>    <code>InteractionRequest ,       InteractionRequest      ,      .      ,    Raise</code> ,    , ,   . <br> <br> <code class="cs">public IInteractionRequest ConfirmCancelInteractionRequest { get { return this.confirmCancelInteractionRequest; } } this.confirmCancelInteractionRequest.Raise( new Confirmation("Are you sure you wish to cancel?"), confirmation =&gt; { if (confirmation.Confirmed) { this.NavigateToQuestionnaireList(); } }); }</code> <br> <i>MVVM Reference Implementation (MVVM RI)</i> ,    <code>IInteractionRequest</code>   <code>InteractionRequest ,          (. QuestionnaireViewModel.cs</code> ). <br> <br>        <br>       ,       .   ,       .    UI             . <br> <br>                . Microsoft Expression Blend Behaviors Framework     .  ,     ,    . <br> <br>  <code>EventTrigger</code> ,  Expression Blend,  ,      ,     ,   . , Prism   <code>EventTrigger</code> ,  <code>InteractionRequestTrigger</code> ,      <code>Raised</code>   <code>IInteractionRequest</code> .    XAML        . <br> <br>  ,   , <code>InteractionRequestTrigger</code>   .  Silverlight Prism   <code>PopupChildWindowAction</code> ,     .    ,         .   <code>ContentTemplate</code>  <code>PopupChildWindowAction</code> ,    ,    UI,      <code>Content</code>  .       <code>Title</code>  . <br> <b></b> <br>  ,    ,   <code>PopupChildWindowAction</code> ,     .    <code>Notification</code>  <code>NotificationChildWindow</code> ,        <code>Confirmation</code> ‚Äì <code>ConfirmationChildWindow</code> . <code>NotificationChildWindow</code>    ,   ,     <code>ConfirmationChildWindow</code>    <i>OK</i>  <i>Cancel</i> ,    .    ,   ,   <code>ChildWindow</code>  <code>PopupChildWindowAction</code> . <br>   ,  <code>InteractionRequestTrigger</code>  <code>PopupChildWindowAction</code> ,       <i>RI MVVM</i> . <br> <br> <code class="xml">&lt;i:Interaction.Triggers&gt; &lt;prism:InteractionRequestTrigger SourceObject="{Binding ConfirmCancelInteractionRequest}"&gt; &lt;prism:PopupChildWindowAction ContentTemplate="{StaticResource ConfirmWindowTemplate}"/&gt; &lt;/prism:InteractionRequestTrigger&gt; &lt;/i:Interaction.Triggers&gt; &lt;UserControl.Resources&gt; &lt;DataTemplate x:Key="ConfirmWindowTemplate"&gt; &lt;Grid MinWidth="250" MinHeight="100"&gt; &lt;TextBlock TextWrapping="Wrap" Grid.Row="0" Text="{Binding}"/&gt; &lt;/Grid&gt; &lt;/DataTemplate&gt; &lt;/UserControl.Resources&gt;</code> <br> <b></b> <br>      <code>ContentTemplate</code> ,   UI   <code>Content</code>  .    <code>Content</code>  ,  , <code>TextBlock</code>     <code>Content</code> . <br>      ,     ,    ,    .  ,     ,       ,     ,    .   ,   <i>RI MVVM</i> ,         <code>Confirmed</code>    <code>Confirmation</code>  <code>true</code> ,     OK. <br> <br>        ,     .  Prism <code>InteractionRequestTrigger</code>   <code>PopupChildWindowAction</code>            . <br> <br>     <br>     MVVM,       , ,    ,         .        (  , ,  ,   ).    ,  ,  ,            . <br> <br>        ,         . Managed Extensibility Framework (MEF)  Unity Application Block (Unity)      ,  ,           . <br> <br>  ,       , , ,    ( )      . ,       ,     .  ,     ,       . <br> <br>     ,  MEF <br>  MEF,       ,   <code>Import</code> ,      ,  ,   <code>Export</code> .         ,    . <br> <br> , <code>QuestionnaireView</code>   <i>RI MVVM</i> ,        ,    <code>Import</code> .   , MEF           .  <code>set</code>        ,   . <br> <br> <code class="cs">[Import] public QuestionnaireViewModel ViewModel { set { this.DataContext = value; } }</code> <br>     ,   . <br> <br> <code class="cs">[Export] public class QuestionnaireViewModel : NotificationObject { ... }</code> <br>        ,   . <br> <br> <code class="cs">public QuestionnaireView() { InitializeComponent(); } [ImportingConstructor] public QuestionnaireView(QuestionnaireViewModel viewModel) : this() { this.DataContext = viewModel; }</code> <br> <b></b> <br>          MEF,   Unity.   ,     ,        .   ,   Visual Studio  Expression Blend, ,        ,     .   ,   ,  ,      ,          <code>InitializeComponent</code> . <br>     ,  Unity <br>  Unity,    ,   MEF.     ,      .    ,         .  ,      . <br> <br>  ,      ,  ,         . ,           ,   . <br> <br> <code class="cs">public QuestionnaireView() { InitializeComponent(); } public QuestionnaireView(QuestionnaireViewModel viewModel) : this() { this.DataContext = viewModel; }</code> <br> <b></b> <br>    ,        ,   Visual Studio  Expression Blend. <br>  ,          ,   . Unity        <code>set</code>   ,   . <br> <br> <code class="cs">public QuestionnaireView() { InitializeComponent(); } [Dependency] public QuestionnaireViewModel ViewModel { set { this.DataContext = value; } }</code> <br>       Unity. <br> <br> <code class="cs">container.RegisterType&lt;QuestionnaireViewModel&gt;();</code> <br>  ,     . <br> <br> <code class="cs">var view = container.Resolve&lt;QuestionnaireView&gt;();</code> <br>     ,    <br>   ,     ,        .        ,   MEF  Unity,        . <br> <br>          .   ,         UI,           . <br> <br> , <i>RI MVVM</i>   ,   ,        .   ,    .      <code>ShowView</code>   UI. <br> <br> <code class="cs">private void NavigateToQuestionnaireList() { //     "questionnaire list". this.uiService.ShowView(ViewNames.QuestionnaireTemplatesList); }</code> <br>  UI      UI .           UI.  <code>ShowView</code>  <code>UIService</code>      (,          ),       ,   . <br> <br> <code class="cs">public void ShowView(string viewName) { var view = this.ViewFactory.GetView(viewName); this.MainWindow.CurrentView = view; }</code> <br> <b></b> <br> Prism       .   ,   ,   ,             .    ,  , " <a href="http://msdn.microsoft.com/en-us/library/gg430861(v%3DPandP.40).aspx">View-Based Navigation</a> "   8, " <a href="http://msdn.microsoft.com/en-us/library/gg430861(v%3DPandP.40).aspx">Navigation</a> ". <br>  MVVM  <br>        MVVM      .           -      mocking . ,   ,        . <br> <br>   <i>INotifyPropertyChanged</i> <br>   <code>INotifyPropertyChanged</code>     ,      .      ,    ;   ,   ,     ,    ,       . <br> <br>   <br> ,       ,           <code>PropertyChanged</code>  ,         .  ,    <code>ChangeTracker</code> ,     MVVM,  ,      .      .     ,    . <br> <br> <code class="cs">var changeTracker = new PropertyChangeTracker(viewModel); viewModel.CurrentState = "newState"; CollectionAssert.Contains(changeTracker.ChangedProperties, "CurrentState");</code> <br> ,     ,     <code>INotifyPropertyChanged</code> ,    ,   ,     . <br> <br>      <br>        ,   ,    <code>set</code>      ,           . ,     ,     ,      ,          . <br> <br> <code class="cs">var changeTracker = new PropertyChangeTracker(viewModel); var question = viewModel.Questions.First() as OpenQuestionViewModel; question.Question.Response = "some text"; CollectionAssert.Contains(changeTracker.ChangedProperties, "UnansweredQuestions");</code> <br>      <br>     <code>INotifyPropertyChanged</code> ,      <code>PropertyChanged</code>        ,  ,     , , .        ,       . <br> <br>   <i>INotifyDataErrorInfo</i> <br>   ,     ,    ,   ,   <code>IDataErrorInfo</code> ,  ( Silverlight)   <code>INotifyDataErrorInfo</code> .   <code>INotifyDataErrorInfo</code>   ,         ,    ,  ,   ,    . <br> <br>       <code>INotifyDataErrorInfo</code> : ,     ,  ,     ,     <code>ErrorsChanged</code> ,      <code>GetErrors</code> , . <br> <br>    <br>     ,      ,     .       ,         <code>GetErrors</code>       ,  ,  ,   .    , ,  ,     ,        .   ,        . <br> <br> <code class="cs">//  . var notifyErrorInfo = (INotifyDataErrorInfo)question; question.Response = -15; Assert.IsTrue(notifyErrorInfo.GetErrors("Response").Cast&lt;ValidationResult&gt;().Any()); //  . var notifyErrorInfo = (INotifyDataErrorInfo)question; question.Response = 15; Assert.IsFalse(notifyErrorInfo.GetErrors("Response").Cast&lt;ValidationResult&gt;().Any());</code> <br>    ,    ,             . <br> <br>    <i>INotifyDataErrorInfo</i> <br>       <code>GetErrors</code> ,   <code>INotifyDataErrorInfo</code>  ,   <code>ErrorsChanged</code>      <code>GetErrors</code> . ,  <code>HasErrors</code>      ,  . <br> <br>       <code>INotifyDataErrorInfo</code> . , ,           ,   -  .      ,        <code>INotifyDataErrorInfo</code>         (,        ). <br> <br>     ,   ,  : <br>  <code>HasErrors</code>     .              ,       .  <code>ErrorsChanged</code> ,      ,         <code>GetErrors</code> .         ( ,  )     ,           .    <code>GetErrors</code>       <code>ErrorsChanged</code> . <br>    <code>INotifyPropertyChanged</code> ,  ,    <code>NotifyDataErrorInfoTestHelper</code>    MVVM,        <code>INotifyDataErrorInfo</code> ,       .   ,   ,      ,   .      . <br> <code class="cs">var helper = new NotifyDataErrorInfoTestHelper&lt;NumericQuestion, int?&gt;( question, q =&gt; q.Response); helper.ValidatePropertyChange( 6, NotifyDataErrorInfoBehavior.Nothing); helper.ValidatePropertyChange( 20, NotifyDataErrorInfoBehavior.FiresErrorsChanged | NotifyDataErrorInfoBehavior.HasErrors | NotifyDataErrorInfoBehavior.HasErrorsForProperty); helper.ValidatePropertyChange( null, NotifyDataErrorInfoBehavior.FiresErrorsChanged | NotifyDataErrorInfoBehavior.HasErrors | NotifyDataErrorInfoBehavior.HasErrorsForProperty); helper.ValidatePropertyChange( 2, NotifyDataErrorInfoBehavior.FiresErrorsChanged);</code> <br>     <br>   MVVM,     ,  .   ,    ,         . <br> <br>  ,     ,     ,       .   ,   , ,       ,     ,   <code>IAsyncResult</code>    ,  - ,   ,    UI. <br> <br>       , , ,    .   ,     .  ,      UI,     ,   ,          ,     ,        "   UI." <br> <br>     ,    ,    .   ,    ,     mock-, ,   ,   ,      ,          . <br> <br>           UI,    ,    .   ,     ,   ,      .        ,   .     ,    ,     . <br> <br> <code class="cs">questionnaireRepositoryMock .Setup( r =&gt; r.SubmitQuestionnaireAsync( It.IsAny&lt;Questionnaire&gt;(), It.IsAny&lt;Action&lt;IOperationResult&gt;&gt;())) .Callback&lt;Questionnaire, Action&lt;IOperationResult&gt;&gt;( (q, a) =&gt; callback = a); uiServicemock .Setup(svc =&gt; svc.ShowView(ViewNames.QuestionnaireTemplatesList)) .Callback&lt;string&gt;(viewName =&gt; requestedViewName = viewName); submitResultMock .Setup(sr =&gt; sr.Error) .Returns&lt;Exception&gt;(null); CompleteQuestionnaire(viewModel); viewModel.Submit(); //      UI . callback(submitResultMock.Object); //    ‚Äì     . Assert.AreEqual(ViewNames.QuestionnaireTemplatesList, requestedViewName);</code> <br> <b></b> <br>          ,        . <br>   <br>       , . "Trees in WPF"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ms753391.aspx">http://msdn.microsoft.com/en-us/library/ms753391.aspx</a> <br> <br>       , . "Attached Properties Overview"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/cc265152(VS.95).aspx">http://msdn.microsoft.com/en-us/library/cc265152(VS.95).aspx</a> <br> <br>      MEF, ."Managed Extensibility Framework Overview"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/dd460648.aspx">http://msdn.microsoft.com/en-us/library/dd460648.aspx</a> . <br> <br>      Unity, ."Unity Application Block"  MSDN: <a href="http://www.msdn.com/unity">http://www.msdn.com/unity</a> . <br> <br>      <code>DelegateCommand</code> , .Chapter 5, " <a href="http://msdn.microsoft.com/en-us/library/gg405484(v%3DPandP.40).aspx">Implementing the MVVM Pattern</a> ." <br> <br>        Microsoft Expression Blend, ."Working with built-in behaviors"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ff724013(v%3DExpression.40).aspx">http://msdn.microsoft.com/en-us/library/ff724013(v=Expression.40).aspx</a> . <br> <br>          Microsoft Expression Blend, ."Creating Custom Behaviors"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ff724708(v%3DExpression.40).aspx">http://msdn.microsoft.com/en-us/library/ff724708(v=Expression.40).aspx</a> . <br> <br>            Microsoft Expression Blend, ."Creating Custom Triggers and Actions"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ff724707(v%3DExpression.40).aspx">http://msdn.microsoft.com/en-us/library/ff724707(v=Expression.40).aspx</a> . <br> <br>         WPF  Silverlight, ."Threading Model"  "The Dispatcher Class"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ms741870.aspx">http://msdn.microsoft.com/en-us/library/ms741870.aspx</a> <br> <a href="http://msdn.microsoft.com/en-us/library/ms615907(v%3DVS.95).aspx">http://msdn.microsoft.com/en-us/library/ms615907(v=VS.95).aspx</a> . <br> <br>      unit-  Silverlight, ."Unit Testing with Silverlight 2": <a href="http://www.jeff.wilcox.name/2008/03/silverlight2-unit-testing/">http://www.jeff.wilcox.name/2008/03/silverlight2-unit-testing/</a> . <br> <br>         , .  " <a href="http://msdn.microsoft.com/en-us/library/gg430861(v%3DPandP.40).aspx">View-Based Navigation</a> " in Chapter 8, " <a href="http://msdn.microsoft.com/en-us/library/gg430861(v%3DPandP.40).aspx">Navigation</a> ." <br> <br>       ,   , ."Event-based Asynchronous Pattern Overview"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/wewwczdw.aspx">http://msdn.microsoft.com/en-us/library/wewwczdw.aspx</a> <br> <br>        <code>IAsyncResult</code> , ."Asynchronous Programming Overview"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ms228963.aspx">http://msdn.microsoft.com/en-us/library/ms228963.aspx</a></code></code></code></code></code></code></code></code></code> <pre> <code class="hljs cmake"><code>CommandBehaviorBase ,    ,    ICommand</code> .           <code>CanExecuteChanged</code> ,          Silverlight,    WPF. <br> <br>    ,  ,   <code><code>CommandBehaviorBase    ,    .         ,      .         ,    .      ButtonBaseClickCommandBehavior</code> . <br> <br> <code class="cs">public class ButtonBaseClickCommandBehavior : CommandBehaviorBase&lt;ButtonBase&gt; { public ButtonBaseClickCommandBehavior(ButtonBase clickableObject) : base(clickableObject) { clickableObject.Click += OnClick; } private void OnClick(object sender, System.Windows.RoutedEventArgs e) { ExecuteCommand(); } }</code> <br>   <code><code>CommandBehaviorBase ,     .     ,          ,   . ,    ,    ,      , ,    CanExecute</code>  ,     . <br> <br>          ,   .           XAML.           .       .  Prism      ,       ,  ,   .       ,    . , ,  ,      <code>Click</code> ,       <code><span class="hljs-keyword"><span class="hljs-keyword">Command</span></span></code> .    <code>Click.<span class="hljs-keyword"><span class="hljs-keyword">Command</span></span></code> ,  . <br> <br>             .             . <br> <br> <code class="cs">public static readonly DependencyProperty CommandProperty = DependencyProperty.RegisterAttached( <span class="hljs-string"><span class="hljs-string">"Command"</span></span>, typeof(ICommand), typeof(Click), new PropertyMetadata(OnSetCommandCallback)); private static readonly DependencyProperty ClickCommandBehaviorProperty = DependencyProperty.RegisterAttached( <span class="hljs-string"><span class="hljs-string">"ClickCommandBehavior"</span></span>, typeof(ButtonBaseClickCommandBehavior), typeof(Click), null);</code> <br>    <code><span class="hljs-keyword"><span class="hljs-keyword">Command</span></span></code>    <code>ButtonBaseClickCommandBehavior</code> ,     <code>OnSetCommandCallback</code> ,     . <br> <br> <code class="cs">private static void OnSetCommandCallback(DependencyObject dependencyObject, DependencyPropertyChangedEventArgs e) { ButtonBase buttonBase = dependencyObject as ButtonBase; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (buttonBase != null) { ButtonBaseClickCommandBehavior behavior = GetOrCreateBehavior(buttonBase); behavior.<span class="hljs-keyword"><span class="hljs-keyword">Command</span></span> = e.NewValue as ICommand; } } private static void OnSetCommandParameterCallback(DependencyObject dependencyObject, DependencyPropertyChangedEventArgs e) { ButtonBase buttonBase = dependencyObject as ButtonBase; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (buttonBase != null) { ButtonBaseClickCommandBehavior behavior = GetOrCreateBehavior(buttonBase); behavior.CommandParameter = e.NewValue; } } private static ButtonBaseClickCommandBehavior GetOrCreateBehavior(ButtonBase buttonBase ) { ButtonBaseClickCommandBehavior behavior = buttonBase.GetValue(ClickCommandBehaviorProperty) as ButtonBaseClickCommandBehavior; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ( behavior == null ) { behavior = new ButtonBaseClickCommandBehavior(buttonBase); buttonBase.SetValue(ClickCommandBehaviorProperty, behavior); } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> behavior; }</code> <br>        ,  <a href="http://msdn.microsoft.com/en-us/library/cc265152(VS.95).aspx">Attached Properties Overview</a>  MSDN. <br> <br>    <br>              . ,     Silverlight,    -,     ,      ,     .     ,       . <br> <br>        ,    ( )  ,  ,     .  UI       ,            UI. <br> <br>      - <br>   -     ,       <code>IAsyncResult</code> .   ,  ,   ,  <code>GetQuestionnaire</code> ,   : <code>BeginGetQuestionnaire</code>  <code>EndGetQuestionnaire</code> .    ,   <code>BeginGetQuestionnaire</code> .     ,   ,   <code>EndGetQuestionnaire</code>    . <br> <b></b> <br>  .NET Framework <span class="hljs-number"><span class="hljs-number">4.5</span></span>      <code>await</code>  <code>async</code>     <code>*Async</code> .      <a href="http://msdn.microsoft.com/en-us/library/vstudio/hh391443.aspx"><span class="hljs-string"><span class="hljs-string">"Asynchronous Programming with Async and Await (C# and Visual Basic)"</span></span></a> . <br>  ,    <code>EndGetQuestionnaire</code> ,      ,  ()      <code>BeginGetQuestionnaire</code> .     ,      ,   <code>EndGetQuestionnaire</code> ,   . <br> <br> <code class="xml">IAsyncResult asyncResult = this.service.BeginGetQuestionnaire( GetQuestionnaireCompleted, null //  ,      ); private void GetQuestionnaireCompleted(IAsyncResult result) { try { questionnaire = this.service.EndGetQuestionnaire(ar); } catch (Exception ex) { //  -   . } }</code> <br>  ,     <code>End*</code> (  , <code>EndGetQuestionnaire</code> ),    ,      .      , ,          UI.     ,   ,        . <br> <br>        UI,     -,      UI,         UI,   <code>Dispatcher</code>    <code>SynchronizationContext</code> .  WPF  Silverlight,   <code>Dispatcher</code> . <br> <br>      <code>Questionnaire</code>  ,        <code>QuestionnaireView</code> .  Silverlight    <code>CheckAccess</code> ,  ,      UI.  ,     <code>BeginInvoke</code> ,      UI. <br> <br> <code class="cs">var dispatcher = System.Windows.Deployment.Current.Dispatcher; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (dispatcher.CheckAccess()) { QuestionnaireView.DataContext = questionnaire; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { dispatcher.BeginInvoke(() =&gt; { Questionnaire.DataContext = questionnaire; }); }</code> <br> <i>MVVM RI</i>   ,    ,   <code>IAsyncResult</code> ,   .      ,                 . ,       . <br> <br> <code class="cs">this.questionnaireRepository.GetQuestionnaireAsync( result =&gt; { this.Questionnaire = result.Result; });</code> <br>  <code>result</code>   ,     , , , .    ,     . <br> <br> <code class="cs">this.questionnaireRepository.GetQuestionnaireAsync( result =&gt; { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (result.Error == null) { this.Questionnaire = result.Result; ... } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { // Handle error. } })</code> <br>     <br>        ,      .     , ,             .        ,      ,     ,     . <br> <br>         ,      MVVM,     ,   . ,  -MVVM ,     <code>MessageBox</code>   code-behind UI,      .   MVVM     ,          . <br> <br>     MVVM,              ,          .      ,    ,   ,  ,     . <br> <br>              MVVM.      ,     ,     ,  ,     .    ,         ,     ,          .       . <br> <br>    <br>                  .        ,        .  ,         .         . <br> <br>  ,         ,         ,  .      ,     .           ,       . ,        WPF  Silverlight,        . <br> <br> <img title="Using the service to interact with the user." src="https://habrastorage.org/getpro/habr/post_images/4b5/397/f2d/4b5397f2d02e5851195b29f1893be6fc.png" alt=" ,    ."> <br> <br>  ,   <code>MessageBox</code>        ,     ,    ,     . <br> <br> <code class="cs">var result = interactionService.ShowMessageBox( <span class="hljs-string"><span class="hljs-string">"Are you sure you want to cancel this operation?"</span></span>, <span class="hljs-string"><span class="hljs-string">"Confirm"</span></span>, MessageBoxButton.OK); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (result == MessageBoxResult.Yes) { CancelRequest(); }</code> <br> ,      - ,      ,         Silverlight.         .             .     . <br> <br> <code class="cs">interactionService.ShowMessageBox( <span class="hljs-string"><span class="hljs-string">"Are you sure you want to cancel this operation?"</span></span>, <span class="hljs-string"><span class="hljs-string">"Confirm"</span></span>, MessageBoxButton.OK, result =&gt; { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (result == MessageBoxResult.Yes) { CancelRequest(); } });</code> <br>         ,      . ,  WPF    <code>MessageBox</code> ,       ;    Silverlight    ,    . <br> <br>     <br>         ‚Äì             .         ,      .     ,     .        ,        ,   ,     . <br> <br> <img title="Using interaction request objects." src="https://habrastorage.org/getpro/habr/post_images/3d0/ff0/1c5/3d0ff01c5518558c2d3c5c5f47ce0ce9.png" alt="   ."> <br> <br>    ,   ,          ‚Äì       ,      ,   ‚Äì     .   ,        ,    ,    UI            . <br> <br>       MVVM,     ,       ,         .         ,        ,    ,   . <br> <br>  Prism       <code>IInteractionRequest</code>   <code><code>InteractionRequest .  IInteractionRequest</code>  ,   .           ,   .  <code><code>InteractionRequest   IInteractionRequest</code>     <code>Raise</code> ,           , , ,   . <br> <br>       <br>  <code><code>InteractionRequest          .  Raise</code>          ( <code>T</code> )    ,    ,   .          ,       .      ,        .    ,  ,     . <br> <code class="cs">public interface IInteractionRequest { event EventHandler&lt;InteractionRequestedEventArgs&gt; Raised; } public class InteractionRequest&lt;T&gt; : IInteractionRequest { public event EventHandler&lt;InteractionRequestedEventArgs&gt; Raised; public void Raise(T context, Action&lt;T&gt; callback) { var handler = this.Raised; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (handler != null) { handler( this, new InteractionRequestedEventArgs(context, () =&gt; callback(context))); } } }</code> <br> Prism    ,      .  <code>Notification</code>       .    ,            .     ‚Äì <code>Title</code>  <code>Content</code> ,    .  ,   ,  ,  ,        . <br> <br>  <code>Confirmation</code>    <code>Notification</code>     ‚Äì <code>Confirmed</code> ,  ,  ,      .  <code>Confirmation</code> ,     <code>MessageBox</code> ,     /  .     ,     <code>Notification</code> ,     ,      . <br> <br>    <code><code><code>InteractionRequest ,       InteractionRequest      ,      .      ,    Raise</code> ,    , ,   . <br> <br> <code class="cs">public IInteractionRequest ConfirmCancelInteractionRequest { get { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> this.confirmCancelInteractionRequest; } } this.confirmCancelInteractionRequest.Raise( new Confirmation(<span class="hljs-string"><span class="hljs-string">"Are you sure you wish to cancel?"</span></span>), confirmation =&gt; { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (confirmation.Confirmed) { this.NavigateToQuestionnaireList(); } }); }</code> <br> <i>MVVM Reference Implementation (MVVM RI)</i> ,    <code>IInteractionRequest</code>   <code><code>InteractionRequest ,          (. QuestionnaireViewModel.cs</code> ). <br> <br>        <br>       ,       .   ,       .    UI             . <br> <br>                . Microsoft Expression Blend Behaviors Framework     .  ,     ,    . <br> <br>  <code>EventTrigger</code> ,  Expression Blend,  ,      ,     ,   . , Prism   <code>EventTrigger</code> ,  <code>InteractionRequestTrigger</code> ,      <code>Raised</code>   <code>IInteractionRequest</code> .    XAML        . <br> <br>  ,   , <code>InteractionRequestTrigger</code>   .  Silverlight Prism   <code>PopupChildWindowAction</code> ,     .    ,         .   <code>ContentTemplate</code>  <code>PopupChildWindowAction</code> ,    ,    UI,      <code>Content</code>  .       <code>Title</code>  . <br> <b></b> <br>  ,    ,   <code>PopupChildWindowAction</code> ,     .    <code>Notification</code>  <code>NotificationChildWindow</code> ,        <code>Confirmation</code> ‚Äì <code>ConfirmationChildWindow</code> . <code>NotificationChildWindow</code>    ,   ,     <code>ConfirmationChildWindow</code>    <i>OK</i>  <i>Cancel</i> ,    .    ,   ,   <code>ChildWindow</code>  <code>PopupChildWindowAction</code> . <br>   ,  <code>InteractionRequestTrigger</code>  <code>PopupChildWindowAction</code> ,       <i>RI MVVM</i> . <br> <br> <code class="xml">&lt;i:Interaction.Triggers&gt; &lt;prism:InteractionRequestTrigger SourceObject=<span class="hljs-string"><span class="hljs-string">"{Binding ConfirmCancelInteractionRequest}"</span></span>&gt; &lt;prism:PopupChildWindowAction ContentTemplate=<span class="hljs-string"><span class="hljs-string">"{StaticResource ConfirmWindowTemplate}"</span></span>/&gt; &lt;/prism:InteractionRequestTrigger&gt; &lt;/i:Interaction.Triggers&gt; &lt;UserControl.Resources&gt; &lt;DataTemplate x:Key=<span class="hljs-string"><span class="hljs-string">"ConfirmWindowTemplate"</span></span>&gt; &lt;Grid MinWidth=<span class="hljs-string"><span class="hljs-string">"250"</span></span> MinHeight=<span class="hljs-string"><span class="hljs-string">"100"</span></span>&gt; &lt;TextBlock TextWrapping=<span class="hljs-string"><span class="hljs-string">"Wrap"</span></span> Grid.Row=<span class="hljs-string"><span class="hljs-string">"0"</span></span> Text=<span class="hljs-string"><span class="hljs-string">"{Binding}"</span></span>/&gt; &lt;/Grid&gt; &lt;/DataTemplate&gt; &lt;/UserControl.Resources&gt;</code> <br> <b></b> <br>      <code>ContentTemplate</code> ,   UI   <code>Content</code>  .    <code>Content</code>  ,  , <code>TextBlock</code>     <code>Content</code> . <br>      ,     ,    ,    .  ,     ,       ,     ,    .   ,   <i>RI MVVM</i> ,         <code>Confirmed</code>    <code>Confirmation</code>  <code><span class="hljs-keyword"><span class="hljs-keyword">true</span></span></code> ,     OK. <br> <br>        ,     .  Prism <code>InteractionRequestTrigger</code>   <code>PopupChildWindowAction</code>            . <br> <br>     <br>     MVVM,       , ,    ,         .        (  , ,  ,   ).    ,  ,  ,            . <br> <br>        ,         . Managed Extensibility Framework (MEF)  Unity Application Block (Unity)      ,  ,           . <br> <br>  ,       , , ,    ( )      . ,       ,     .  ,     ,       . <br> <br>     ,  MEF <br>  MEF,       ,   <code>Import</code> ,      ,  ,   <code><span class="hljs-keyword"><span class="hljs-keyword">Export</span></span></code> .         ,    . <br> <br> , <code>QuestionnaireView</code>   <i>RI MVVM</i> ,        ,    <code>Import</code> .   , MEF           .  <code><span class="hljs-keyword"><span class="hljs-keyword">set</span></span></code>        ,   . <br> <br> <code class="cs">[Import] public QuestionnaireViewModel ViewModel { <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> { this.DataContext = value; } }</code> <br>     ,   . <br> <br> <code class="cs">[<span class="hljs-keyword"><span class="hljs-keyword">Export</span></span>] public class QuestionnaireViewModel : NotificationObject { ... }</code> <br>        ,   . <br> <br> <code class="cs">public QuestionnaireView() { InitializeComponent(); } [ImportingConstructor] public QuestionnaireView(QuestionnaireViewModel viewModel) : this() { this.DataContext = viewModel; }</code> <br> <b></b> <br>          MEF,   Unity.   ,     ,        .   ,   Visual Studio  Expression Blend, ,        ,     .   ,   ,  ,      ,          <code>InitializeComponent</code> . <br>     ,  Unity <br>  Unity,    ,   MEF.     ,      .    ,         .  ,      . <br> <br>  ,      ,  ,         . ,           ,   . <br> <br> <code class="cs">public QuestionnaireView() { InitializeComponent(); } public QuestionnaireView(QuestionnaireViewModel viewModel) : this() { this.DataContext = viewModel; }</code> <br> <b></b> <br>    ,        ,   Visual Studio  Expression Blend. <br>  ,          ,   . Unity        <code><span class="hljs-keyword"><span class="hljs-keyword">set</span></span></code>   ,   . <br> <br> <code class="cs">public QuestionnaireView() { InitializeComponent(); } [Dependency] public QuestionnaireViewModel ViewModel { <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> { this.DataContext = value; } }</code> <br>       Unity. <br> <br> <code class="cs">container.RegisterType&lt;QuestionnaireViewModel&gt;();</code> <br>  ,     . <br> <br> <code class="cs">var view = container.Resolve&lt;QuestionnaireView&gt;();</code> <br>     ,    <br>   ,     ,        .        ,   MEF  Unity,        . <br> <br>          .   ,         UI,           . <br> <br> , <i>RI MVVM</i>   ,   ,        .   ,    .      <code>ShowView</code>   UI. <br> <br> <code class="cs">private void NavigateToQuestionnaireList() { //     <span class="hljs-string"><span class="hljs-string">"questionnaire list"</span></span>. this.uiService.ShowView(ViewNames.QuestionnaireTemplatesList); }</code> <br>  UI      UI .           UI.  <code>ShowView</code>  <code>UIService</code>      (,          ),       ,   . <br> <br> <code class="cs">public void ShowView(<span class="hljs-keyword"><span class="hljs-keyword">string</span></span> viewName) { var view = this.ViewFactory.GetView(viewName); this.MainWindow.CurrentView = view; }</code> <br> <b></b> <br> Prism       .   ,   ,   ,             .    ,  , <span class="hljs-string"><span class="hljs-string">" </span></span><a href="http://msdn.microsoft.com/en-us/library/gg430861(v%3DPandP.40).aspx"><span class="hljs-string"><span class="hljs-string">View-Based Navigation</span></span></a><span class="hljs-string"><span class="hljs-string"> "</span></span>   <span class="hljs-number"><span class="hljs-number">8</span></span>, <span class="hljs-string"><span class="hljs-string">" </span></span><a href="http://msdn.microsoft.com/en-us/library/gg430861(v%3DPandP.40).aspx"><span class="hljs-string"><span class="hljs-string">Navigation</span></span></a><span class="hljs-string"><span class="hljs-string"> "</span></span>. <br>  MVVM  <br>        MVVM      .           -      mocking . ,   ,        . <br> <br>   <i>INotifyPropertyChanged</i> <br>   <code>INotifyPropertyChanged</code>     ,      .      ,    ;   ,   ,     ,    ,       . <br> <br>   <br> ,       ,           <code>PropertyChanged</code>  ,         .  ,    <code>ChangeTracker</code> ,     MVVM,  ,      .      .     ,    . <br> <br> <code class="cs">var changeTracker = new PropertyChangeTracker(viewModel); viewModel.CurrentState = <span class="hljs-string"><span class="hljs-string">"newState"</span></span>; CollectionAssert.Contains(changeTracker.ChangedProperties, <span class="hljs-string"><span class="hljs-string">"CurrentState"</span></span>);</code> <br> ,     ,     <code>INotifyPropertyChanged</code> ,    ,   ,     . <br> <br>      <br>        ,   ,    <code><span class="hljs-keyword"><span class="hljs-keyword">set</span></span></code>      ,           . ,     ,     ,      ,          . <br> <br> <code class="cs">var changeTracker = new PropertyChangeTracker(viewModel); var question = viewModel.Questions.First() as OpenQuestionViewModel; question.Question.Response = <span class="hljs-string"><span class="hljs-string">"some text"</span></span>; CollectionAssert.Contains(changeTracker.ChangedProperties, <span class="hljs-string"><span class="hljs-string">"UnansweredQuestions"</span></span>);</code> <br>      <br>     <code>INotifyPropertyChanged</code> ,      <code>PropertyChanged</code>        ,  ,     , , .        ,       . <br> <br>   <i>INotifyDataErrorInfo</i> <br>   ,     ,    ,   ,   <code>IDataErrorInfo</code> ,  ( Silverlight)   <code>INotifyDataErrorInfo</code> .   <code>INotifyDataErrorInfo</code>   ,         ,    ,  ,   ,    . <br> <br>       <code>INotifyDataErrorInfo</code> : ,     ,  ,     ,     <code>ErrorsChanged</code> ,      <code>GetErrors</code> , . <br> <br>    <br>     ,      ,     .       ,         <code>GetErrors</code>       ,  ,  ,   .    , ,  ,     ,        .   ,        . <br> <br> <code class="cs">//  . var notifyErrorInfo = (INotifyDataErrorInfo)question; question.Response = -<span class="hljs-number"><span class="hljs-number">15</span></span>; Assert.IsTrue(notifyErrorInfo.GetErrors(<span class="hljs-string"><span class="hljs-string">"Response"</span></span>).Cast&lt;ValidationResult&gt;().Any()); //  . var notifyErrorInfo = (INotifyDataErrorInfo)question; question.Response = <span class="hljs-number"><span class="hljs-number">15</span></span>; Assert.IsFalse(notifyErrorInfo.GetErrors(<span class="hljs-string"><span class="hljs-string">"Response"</span></span>).Cast&lt;ValidationResult&gt;().Any());</code> <br>    ,    ,             . <br> <br>    <i>INotifyDataErrorInfo</i> <br>       <code>GetErrors</code> ,   <code>INotifyDataErrorInfo</code>  ,   <code>ErrorsChanged</code>      <code>GetErrors</code> . ,  <code>HasErrors</code>      ,  . <br> <br>       <code>INotifyDataErrorInfo</code> . , ,           ,   -  .      ,        <code>INotifyDataErrorInfo</code>         (,        ). <br> <br>     ,   ,  : <br>  <code>HasErrors</code>     .              ,       .  <code>ErrorsChanged</code> ,      ,         <code>GetErrors</code> .         ( ,  )     ,           .    <code>GetErrors</code>       <code>ErrorsChanged</code> . <br>    <code>INotifyPropertyChanged</code> ,  ,    <code>NotifyDataErrorInfoTestHelper</code>    MVVM,        <code>INotifyDataErrorInfo</code> ,       .   ,   ,      ,   .      . <br> <code class="cs">var helper = new NotifyDataErrorInfoTestHelper&lt;NumericQuestion, int?&gt;( question, q =&gt; q.Response); helper.ValidatePropertyChange( <span class="hljs-number"><span class="hljs-number">6</span></span>, NotifyDataErrorInfoBehavior.Nothing); helper.ValidatePropertyChange( <span class="hljs-number"><span class="hljs-number">20</span></span>, NotifyDataErrorInfoBehavior.FiresErrorsChanged | NotifyDataErrorInfoBehavior.HasErrors | NotifyDataErrorInfoBehavior.HasErrorsForProperty); helper.ValidatePropertyChange( null, NotifyDataErrorInfoBehavior.FiresErrorsChanged | NotifyDataErrorInfoBehavior.HasErrors | NotifyDataErrorInfoBehavior.HasErrorsForProperty); helper.ValidatePropertyChange( <span class="hljs-number"><span class="hljs-number">2</span></span>, NotifyDataErrorInfoBehavior.FiresErrorsChanged);</code> <br>     <br>   MVVM,     ,  .   ,    ,         . <br> <br>  ,     ,     ,       .   ,   , ,       ,     ,   <code>IAsyncResult</code>    ,  - ,   ,    UI. <br> <br>       , , ,    .   ,     .  ,      UI,     ,   ,          ,     ,        <span class="hljs-string"><span class="hljs-string">"   UI."</span></span> <br> <br>     ,    ,    .   ,    ,     mock-, ,   ,   ,      ,          . <br> <br>           UI,    ,    .   ,     ,   ,      .        ,   .     ,    ,     . <br> <br> <code class="cs">questionnaireRepositoryMock .Setup( r =&gt; r.SubmitQuestionnaireAsync( It.IsAny&lt;Questionnaire&gt;(), It.IsAny&lt;Action&lt;IOperationResult&gt;&gt;())) .Callback&lt;Questionnaire, Action&lt;IOperationResult&gt;&gt;( (q, a) =&gt; callback = a); uiServicemock .Setup(svc =&gt; svc.ShowView(ViewNames.QuestionnaireTemplatesList)) .Callback&lt;<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>&gt;(viewName =&gt; requestedViewName = viewName); submitResultMock .Setup(sr =&gt; sr.Error) .Returns&lt;Exception&gt;(null); CompleteQuestionnaire(viewModel); viewModel.Submit(); //      UI . callback(submitResultMock.Object); //    ‚Äì     . Assert.AreEqual(ViewNames.QuestionnaireTemplatesList, requestedViewName);</code> <br> <b></b> <br>          ,        . <br>   <br>       , . <span class="hljs-string"><span class="hljs-string">"Trees in WPF"</span></span>  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ms753391.aspx">http://msdn.microsoft.com/en-us/library/ms753391.aspx</a> <br> <br>       , . <span class="hljs-string"><span class="hljs-string">"Attached Properties Overview"</span></span>  MSDN: <a href="http://msdn.microsoft.com/en-us/library/cc265152(VS.95).aspx">http://msdn.microsoft.com/en-us/library/cc265152(VS.<span class="hljs-number"><span class="hljs-number">95</span></span>).aspx</a> <br> <br>      MEF, .<span class="hljs-string"><span class="hljs-string">"Managed Extensibility Framework Overview"</span></span>  MSDN: <a href="http://msdn.microsoft.com/en-us/library/dd460648.aspx">http://msdn.microsoft.com/en-us/library/dd460648.aspx</a> . <br> <br>      Unity, .<span class="hljs-string"><span class="hljs-string">"Unity Application Block"</span></span>  MSDN: <a href="http://www.msdn.com/unity">http://www.msdn.com/unity</a> . <br> <br>      <code>DelegateCommand</code> , .Chapter <span class="hljs-number"><span class="hljs-number">5</span></span>, <span class="hljs-string"><span class="hljs-string">" </span></span><a href="http://msdn.microsoft.com/en-us/library/gg405484(v%3DPandP.40).aspx"><span class="hljs-string"><span class="hljs-string">Implementing the MVVM Pattern</span></span></a><span class="hljs-string"><span class="hljs-string"> ."</span></span> <br> <br>        Microsoft Expression Blend, .<span class="hljs-string"><span class="hljs-string">"Working with built-in behaviors"</span></span>  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ff724013(v%3DExpression.40).aspx">http://msdn.microsoft.com/en-us/library/ff724013(v=Expression.<span class="hljs-number"><span class="hljs-number">40</span></span>).aspx</a> . <br> <br>          Microsoft Expression Blend, .<span class="hljs-string"><span class="hljs-string">"Creating Custom Behaviors"</span></span>  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ff724708(v%3DExpression.40).aspx">http://msdn.microsoft.com/en-us/library/ff724708(v=Expression.<span class="hljs-number"><span class="hljs-number">40</span></span>).aspx</a> . <br> <br>            Microsoft Expression Blend, .<span class="hljs-string"><span class="hljs-string">"Creating Custom Triggers and Actions"</span></span>  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ff724707(v%3DExpression.40).aspx">http://msdn.microsoft.com/en-us/library/ff724707(v=Expression.<span class="hljs-number"><span class="hljs-number">40</span></span>).aspx</a> . <br> <br>         WPF  Silverlight, .<span class="hljs-string"><span class="hljs-string">"Threading Model"</span></span>  <span class="hljs-string"><span class="hljs-string">"The Dispatcher Class"</span></span>  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ms741870.aspx">http://msdn.microsoft.com/en-us/library/ms741870.aspx</a> <br> <a href="http://msdn.microsoft.com/en-us/library/ms615907(v%3DVS.95).aspx">http://msdn.microsoft.com/en-us/library/ms615907(v=VS.<span class="hljs-number"><span class="hljs-number">95</span></span>).aspx</a> . <br> <br>      unit-  Silverlight, .<span class="hljs-string"><span class="hljs-string">"Unit Testing with Silverlight 2"</span></span>: <a href="http://www.jeff.wilcox.name/2008/03/silverlight2-unit-testing/">http://www.jeff.wilcox.name/<span class="hljs-number"><span class="hljs-number">2008</span></span>/<span class="hljs-number"><span class="hljs-number">03</span></span>/silverlight2-unit-testing/</a> . <br> <br>         , .  <span class="hljs-string"><span class="hljs-string">" </span></span><a href="http://msdn.microsoft.com/en-us/library/gg430861(v%3DPandP.40).aspx"><span class="hljs-string"><span class="hljs-string">View-Based Navigation</span></span></a><span class="hljs-string"><span class="hljs-string"> "</span></span> in Chapter <span class="hljs-number"><span class="hljs-number">8</span></span>, <span class="hljs-string"><span class="hljs-string">" </span></span><a href="http://msdn.microsoft.com/en-us/library/gg430861(v%3DPandP.40).aspx"><span class="hljs-string"><span class="hljs-string">Navigation</span></span></a><span class="hljs-string"><span class="hljs-string"> ."</span></span> <br> <br>       ,   , .<span class="hljs-string"><span class="hljs-string">"Event-based Asynchronous Pattern Overview"</span></span>  MSDN: <a href="http://msdn.microsoft.com/en-us/library/wewwczdw.aspx">http://msdn.microsoft.com/en-us/library/wewwczdw.aspx</a> <br> <br>        <code>IAsyncResult</code> , .<span class="hljs-string"><span class="hljs-string">"Asynchronous Programming Overview"</span></span>  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ms228963.aspx">http://msdn.microsoft.com/en-us/library/ms228963.aspx</a></code></code></code></code></code></code></code></code></code> </pre> <code><code><code><code><code><code><code><code><code><code>CommandBehaviorBase ,    ,    ICommand</code> .           <code>CanExecuteChanged</code> ,          Silverlight,    WPF. <br> <br>    ,  ,   <code>CommandBehaviorBase    ,    .         ,      .         ,    .      ButtonBaseClickCommandBehavior</code> . <br> <br> <code class="cs">public class ButtonBaseClickCommandBehavior : CommandBehaviorBase&lt;ButtonBase&gt; { public ButtonBaseClickCommandBehavior(ButtonBase clickableObject) : base(clickableObject) { clickableObject.Click += OnClick; } private void OnClick(object sender, System.Windows.RoutedEventArgs e) { ExecuteCommand(); } }</code> <br>   <code>CommandBehaviorBase ,     .     ,          ,   . ,    ,    ,      , ,    CanExecute</code>  ,     . <br> <br>          ,   .           XAML.           .       .  Prism      ,       ,  ,   .       ,    . , ,  ,      <code>Click</code> ,       <code>Command</code> .    <code>Click.Command</code> ,  . <br> <br>             .             . <br> <br> <code class="cs">public static readonly DependencyProperty CommandProperty = DependencyProperty.RegisterAttached( "Command", typeof(ICommand), typeof(Click), new PropertyMetadata(OnSetCommandCallback)); private static readonly DependencyProperty ClickCommandBehaviorProperty = DependencyProperty.RegisterAttached( "ClickCommandBehavior", typeof(ButtonBaseClickCommandBehavior), typeof(Click), null);</code> <br>    <code>Command</code>    <code>ButtonBaseClickCommandBehavior</code> ,     <code>OnSetCommandCallback</code> ,     . <br> <br> <code class="cs">private static void OnSetCommandCallback(DependencyObject dependencyObject, DependencyPropertyChangedEventArgs e) { ButtonBase buttonBase = dependencyObject as ButtonBase; if (buttonBase != null) { ButtonBaseClickCommandBehavior behavior = GetOrCreateBehavior(buttonBase); behavior.Command = e.NewValue as ICommand; } } private static void OnSetCommandParameterCallback(DependencyObject dependencyObject, DependencyPropertyChangedEventArgs e) { ButtonBase buttonBase = dependencyObject as ButtonBase; if (buttonBase != null) { ButtonBaseClickCommandBehavior behavior = GetOrCreateBehavior(buttonBase); behavior.CommandParameter = e.NewValue; } } private static ButtonBaseClickCommandBehavior GetOrCreateBehavior(ButtonBase buttonBase ) { ButtonBaseClickCommandBehavior behavior = buttonBase.GetValue(ClickCommandBehaviorProperty) as ButtonBaseClickCommandBehavior; if ( behavior == null ) { behavior = new ButtonBaseClickCommandBehavior(buttonBase); buttonBase.SetValue(ClickCommandBehaviorProperty, behavior); } return behavior; }</code> <br>        ,  <a href="http://msdn.microsoft.com/en-us/library/cc265152(VS.95).aspx">Attached Properties Overview</a>  MSDN. <br> <br>    <br>              . ,     Silverlight,    -,     ,      ,     .     ,       . <br> <br>        ,    ( )  ,  ,     .  UI       ,            UI. <br> <br>      - <br>   -     ,       <code>IAsyncResult</code> .   ,  ,   ,  <code>GetQuestionnaire</code> ,   : <code>BeginGetQuestionnaire</code>  <code>EndGetQuestionnaire</code> .    ,   <code>BeginGetQuestionnaire</code> .     ,   ,   <code>EndGetQuestionnaire</code>    . <br> <b></b> <br>  .NET Framework 4.5      <code>await</code>  <code>async</code>     <code>*Async</code> .      <a href="http://msdn.microsoft.com/en-us/library/vstudio/hh391443.aspx">"Asynchronous Programming with Async and Await (C# and Visual Basic)"</a> . <br>  ,    <code>EndGetQuestionnaire</code> ,      ,  ()      <code>BeginGetQuestionnaire</code> .     ,      ,   <code>EndGetQuestionnaire</code> ,   . <br> <br> <code class="xml">IAsyncResult asyncResult = this.service.BeginGetQuestionnaire( GetQuestionnaireCompleted, null //  ,      ); private void GetQuestionnaireCompleted(IAsyncResult result) { try { questionnaire = this.service.EndGetQuestionnaire(ar); } catch (Exception ex) { //  -   . } }</code> <br>  ,     <code>End*</code> (  , <code>EndGetQuestionnaire</code> ),    ,      .      , ,          UI.     ,   ,        . <br> <br>        UI,     -,      UI,         UI,   <code>Dispatcher</code>    <code>SynchronizationContext</code> .  WPF  Silverlight,   <code>Dispatcher</code> . <br> <br>      <code>Questionnaire</code>  ,        <code>QuestionnaireView</code> .  Silverlight    <code>CheckAccess</code> ,  ,      UI.  ,     <code>BeginInvoke</code> ,      UI. <br> <br> <code class="cs">var dispatcher = System.Windows.Deployment.Current.Dispatcher; if (dispatcher.CheckAccess()) { QuestionnaireView.DataContext = questionnaire; } else { dispatcher.BeginInvoke(() =&gt; { Questionnaire.DataContext = questionnaire; }); }</code> <br> <i>MVVM RI</i>   ,    ,   <code>IAsyncResult</code> ,   .      ,                 . ,       . <br> <br> <code class="cs">this.questionnaireRepository.GetQuestionnaireAsync( result =&gt; { this.Questionnaire = result.Result; });</code> <br>  <code>result</code>   ,     , , , .    ,     . <br> <br> <code class="cs">this.questionnaireRepository.GetQuestionnaireAsync( result =&gt; { if (result.Error == null) { this.Questionnaire = result.Result; ... } else { // Handle error. } })</code> <br>     <br>        ,      .     , ,             .        ,      ,     ,     . <br> <br>         ,      MVVM,     ,   . ,  -MVVM ,     <code>MessageBox</code>   code-behind UI,      .   MVVM     ,          . <br> <br>     MVVM,              ,          .      ,    ,   ,  ,     . <br> <br>              MVVM.      ,     ,     ,  ,     .    ,         ,     ,          .       . <br> <br>    <br>                  .        ,        .  ,         .         . <br> <br>  ,         ,         ,  .      ,     .           ,       . ,        WPF  Silverlight,        . <br> <br> <img title="Using the service to interact with the user." src="https://habrastorage.org/getpro/habr/post_images/4b5/397/f2d/4b5397f2d02e5851195b29f1893be6fc.png" alt=" ,    ."> <br> <br>  ,   <code>MessageBox</code>        ,     ,    ,     . <br> <br> <code class="cs">var result = interactionService.ShowMessageBox( "Are you sure you want to cancel this operation?", "Confirm", MessageBoxButton.OK); if (result == MessageBoxResult.Yes) { CancelRequest(); }</code> <br> ,      - ,      ,         Silverlight.         .             .     . <br> <br> <code class="cs">interactionService.ShowMessageBox( "Are you sure you want to cancel this operation?", "Confirm", MessageBoxButton.OK, result =&gt; { if (result == MessageBoxResult.Yes) { CancelRequest(); } });</code> <br>         ,      . ,  WPF    <code>MessageBox</code> ,       ;    Silverlight    ,    . <br> <br>     <br>         ‚Äì             .         ,      .     ,     .        ,        ,   ,     . <br> <br> <img title="Using interaction request objects." src="https://habrastorage.org/getpro/habr/post_images/3d0/ff0/1c5/3d0ff01c5518558c2d3c5c5f47ce0ce9.png" alt="   ."> <br> <br>    ,   ,          ‚Äì       ,      ,   ‚Äì     .   ,        ,    ,    UI            . <br> <br>       MVVM,     ,       ,         .         ,        ,    ,   . <br> <br>  Prism       <code>IInteractionRequest</code>   <code>InteractionRequest .  IInteractionRequest</code>  ,   .           ,   .  <code>InteractionRequest   IInteractionRequest</code>     <code>Raise</code> ,           , , ,   . <br> <br>       <br>  <code>InteractionRequest          .  Raise</code>          ( <code>T</code> )    ,    ,   .          ,       .      ,        .    ,  ,     . <br> <code class="cs">public interface IInteractionRequest { event EventHandler&lt;InteractionRequestedEventArgs&gt; Raised; } public class InteractionRequest&lt;T&gt; : IInteractionRequest { public event EventHandler&lt;InteractionRequestedEventArgs&gt; Raised; public void Raise(T context, Action&lt;T&gt; callback) { var handler = this.Raised; if (handler != null) { handler( this, new InteractionRequestedEventArgs(context, () =&gt; callback(context))); } } }</code> <br> Prism    ,      .  <code>Notification</code>       .    ,            .     ‚Äì <code>Title</code>  <code>Content</code> ,    .  ,   ,  ,  ,        . <br> <br>  <code>Confirmation</code>    <code>Notification</code>     ‚Äì <code>Confirmed</code> ,  ,  ,      .  <code>Confirmation</code> ,     <code>MessageBox</code> ,     /  .     ,     <code>Notification</code> ,     ,      . <br> <br>    <code>InteractionRequest ,       InteractionRequest      ,      .      ,    Raise</code> ,    , ,   . <br> <br> <code class="cs">public IInteractionRequest ConfirmCancelInteractionRequest { get { return this.confirmCancelInteractionRequest; } } this.confirmCancelInteractionRequest.Raise( new Confirmation("Are you sure you wish to cancel?"), confirmation =&gt; { if (confirmation.Confirmed) { this.NavigateToQuestionnaireList(); } }); }</code> <br> <i>MVVM Reference Implementation (MVVM RI)</i> ,    <code>IInteractionRequest</code>   <code>InteractionRequest ,          (. QuestionnaireViewModel.cs</code> ). <br> <br>        <br>       ,       .   ,       .    UI             . <br> <br>                . Microsoft Expression Blend Behaviors Framework     .  ,     ,    . <br> <br>  <code>EventTrigger</code> ,  Expression Blend,  ,      ,     ,   . , Prism   <code>EventTrigger</code> ,  <code>InteractionRequestTrigger</code> ,      <code>Raised</code>   <code>IInteractionRequest</code> .    XAML        . <br> <br>  ,   , <code>InteractionRequestTrigger</code>   .  Silverlight Prism   <code>PopupChildWindowAction</code> ,     .    ,         .   <code>ContentTemplate</code>  <code>PopupChildWindowAction</code> ,    ,    UI,      <code>Content</code>  .       <code>Title</code>  . <br> <b></b> <br>  ,    ,   <code>PopupChildWindowAction</code> ,     .    <code>Notification</code>  <code>NotificationChildWindow</code> ,        <code>Confirmation</code> ‚Äì <code>ConfirmationChildWindow</code> . <code>NotificationChildWindow</code>    ,   ,     <code>ConfirmationChildWindow</code>    <i>OK</i>  <i>Cancel</i> ,    .    ,   ,   <code>ChildWindow</code>  <code>PopupChildWindowAction</code> . <br>   ,  <code>InteractionRequestTrigger</code>  <code>PopupChildWindowAction</code> ,       <i>RI MVVM</i> . <br> <br> <code class="xml">&lt;i:Interaction.Triggers&gt; &lt;prism:InteractionRequestTrigger SourceObject="{Binding ConfirmCancelInteractionRequest}"&gt; &lt;prism:PopupChildWindowAction ContentTemplate="{StaticResource ConfirmWindowTemplate}"/&gt; &lt;/prism:InteractionRequestTrigger&gt; &lt;/i:Interaction.Triggers&gt; &lt;UserControl.Resources&gt; &lt;DataTemplate x:Key="ConfirmWindowTemplate"&gt; &lt;Grid MinWidth="250" MinHeight="100"&gt; &lt;TextBlock TextWrapping="Wrap" Grid.Row="0" Text="{Binding}"/&gt; &lt;/Grid&gt; &lt;/DataTemplate&gt; &lt;/UserControl.Resources&gt;</code> <br> <b></b> <br>      <code>ContentTemplate</code> ,   UI   <code>Content</code>  .    <code>Content</code>  ,  , <code>TextBlock</code>     <code>Content</code> . <br>      ,     ,    ,    .  ,     ,       ,     ,    .   ,   <i>RI MVVM</i> ,         <code>Confirmed</code>    <code>Confirmation</code>  <code>true</code> ,     OK. <br> <br>        ,     .  Prism <code>InteractionRequestTrigger</code>   <code>PopupChildWindowAction</code>            . <br> <br>     <br>     MVVM,       , ,    ,         .        (  , ,  ,   ).    ,  ,  ,            . <br> <br>        ,         . Managed Extensibility Framework (MEF)  Unity Application Block (Unity)      ,  ,           . <br> <br>  ,       , , ,    ( )      . ,       ,     .  ,     ,       . <br> <br>     ,  MEF <br>  MEF,       ,   <code>Import</code> ,      ,  ,   <code>Export</code> .         ,    . <br> <br> , <code>QuestionnaireView</code>   <i>RI MVVM</i> ,        ,    <code>Import</code> .   , MEF           .  <code>set</code>        ,   . <br> <br> <code class="cs">[Import] public QuestionnaireViewModel ViewModel { set { this.DataContext = value; } }</code> <br>     ,   . <br> <br> <code class="cs">[Export] public class QuestionnaireViewModel : NotificationObject { ... }</code> <br>        ,   . <br> <br> <code class="cs">public QuestionnaireView() { InitializeComponent(); } [ImportingConstructor] public QuestionnaireView(QuestionnaireViewModel viewModel) : this() { this.DataContext = viewModel; }</code> <br> <b></b> <br>          MEF,   Unity.   ,     ,        .   ,   Visual Studio  Expression Blend, ,        ,     .   ,   ,  ,      ,          <code>InitializeComponent</code> . <br>     ,  Unity <br>  Unity,    ,   MEF.     ,      .    ,         .  ,      . <br> <br>  ,      ,  ,         . ,           ,   . <br> <br> <code class="cs">public QuestionnaireView() { InitializeComponent(); } public QuestionnaireView(QuestionnaireViewModel viewModel) : this() { this.DataContext = viewModel; }</code> <br> <b></b> <br>    ,        ,   Visual Studio  Expression Blend. <br>  ,          ,   . Unity        <code>set</code>   ,   . <br> <br> <code class="cs">public QuestionnaireView() { InitializeComponent(); } [Dependency] public QuestionnaireViewModel ViewModel { set { this.DataContext = value; } }</code> <br>       Unity. <br> <br> <code class="cs">container.RegisterType&lt;QuestionnaireViewModel&gt;();</code> <br>  ,     . <br> <br> <code class="cs">var view = container.Resolve&lt;QuestionnaireView&gt;();</code> <br>     ,    <br>   ,     ,        .        ,   MEF  Unity,        . <br> <br>          .   ,         UI,           . <br> <br> , <i>RI MVVM</i>   ,   ,        .   ,    .      <code>ShowView</code>   UI. <br> <br> <code class="cs">private void NavigateToQuestionnaireList() { //     "questionnaire list". this.uiService.ShowView(ViewNames.QuestionnaireTemplatesList); }</code> <br>  UI      UI .           UI.  <code>ShowView</code>  <code>UIService</code>      (,          ),       ,   . <br> <br> <code class="cs">public void ShowView(string viewName) { var view = this.ViewFactory.GetView(viewName); this.MainWindow.CurrentView = view; }</code> <br> <b></b> <br> Prism       .   ,   ,   ,             .    ,  , " <a href="http://msdn.microsoft.com/en-us/library/gg430861(v%3DPandP.40).aspx">View-Based Navigation</a> "   8, " <a href="http://msdn.microsoft.com/en-us/library/gg430861(v%3DPandP.40).aspx">Navigation</a> ". <br>  MVVM  <br>        MVVM      .           -      mocking . ,   ,        . <br> <br>   <i>INotifyPropertyChanged</i> <br>   <code>INotifyPropertyChanged</code>     ,      .      ,    ;   ,   ,     ,    ,       . <br> <br>   <br> ,       ,           <code>PropertyChanged</code>  ,         .  ,    <code>ChangeTracker</code> ,     MVVM,  ,      .      .     ,    . <br> <br> <code class="cs">var changeTracker = new PropertyChangeTracker(viewModel); viewModel.CurrentState = "newState"; CollectionAssert.Contains(changeTracker.ChangedProperties, "CurrentState");</code> <br> ,     ,     <code>INotifyPropertyChanged</code> ,    ,   ,     . <br> <br>      <br>        ,   ,    <code>set</code>      ,           . ,     ,     ,      ,          . <br> <br> <code class="cs">var changeTracker = new PropertyChangeTracker(viewModel); var question = viewModel.Questions.First() as OpenQuestionViewModel; question.Question.Response = "some text"; CollectionAssert.Contains(changeTracker.ChangedProperties, "UnansweredQuestions");</code> <br>      <br>     <code>INotifyPropertyChanged</code> ,      <code>PropertyChanged</code>        ,  ,     , , .        ,       . <br> <br>   <i>INotifyDataErrorInfo</i> <br>   ,     ,    ,   ,   <code>IDataErrorInfo</code> ,  ( Silverlight)   <code>INotifyDataErrorInfo</code> .   <code>INotifyDataErrorInfo</code>   ,         ,    ,  ,   ,    . <br> <br>       <code>INotifyDataErrorInfo</code> : ,     ,  ,     ,     <code>ErrorsChanged</code> ,      <code>GetErrors</code> , . <br> <br>    <br>     ,      ,     .       ,         <code>GetErrors</code>       ,  ,  ,   .    , ,  ,     ,        .   ,        . <br> <br> <code class="cs">//  . var notifyErrorInfo = (INotifyDataErrorInfo)question; question.Response = -15; Assert.IsTrue(notifyErrorInfo.GetErrors("Response").Cast&lt;ValidationResult&gt;().Any()); //  . var notifyErrorInfo = (INotifyDataErrorInfo)question; question.Response = 15; Assert.IsFalse(notifyErrorInfo.GetErrors("Response").Cast&lt;ValidationResult&gt;().Any());</code> <br>    ,    ,             . <br> <br>    <i>INotifyDataErrorInfo</i> <br>       <code>GetErrors</code> ,   <code>INotifyDataErrorInfo</code>  ,   <code>ErrorsChanged</code>      <code>GetErrors</code> . ,  <code>HasErrors</code>      ,  . <br> <br>       <code>INotifyDataErrorInfo</code> . , ,           ,   -  .      ,        <code>INotifyDataErrorInfo</code>         (,        ). <br> <br>     ,   ,  : <br>  <code>HasErrors</code>     .              ,       .  <code>ErrorsChanged</code> ,      ,         <code>GetErrors</code> .         ( ,  )     ,           .    <code>GetErrors</code>       <code>ErrorsChanged</code> . <br>    <code>INotifyPropertyChanged</code> ,  ,    <code>NotifyDataErrorInfoTestHelper</code>    MVVM,        <code>INotifyDataErrorInfo</code> ,       .   ,   ,      ,   .      . <br> <code class="cs">var helper = new NotifyDataErrorInfoTestHelper&lt;NumericQuestion, int?&gt;( question, q =&gt; q.Response); helper.ValidatePropertyChange( 6, NotifyDataErrorInfoBehavior.Nothing); helper.ValidatePropertyChange( 20, NotifyDataErrorInfoBehavior.FiresErrorsChanged | NotifyDataErrorInfoBehavior.HasErrors | NotifyDataErrorInfoBehavior.HasErrorsForProperty); helper.ValidatePropertyChange( null, NotifyDataErrorInfoBehavior.FiresErrorsChanged | NotifyDataErrorInfoBehavior.HasErrors | NotifyDataErrorInfoBehavior.HasErrorsForProperty); helper.ValidatePropertyChange( 2, NotifyDataErrorInfoBehavior.FiresErrorsChanged);</code> <br>     <br>   MVVM,     ,  .   ,    ,         . <br> <br>  ,     ,     ,       .   ,   , ,       ,     ,   <code>IAsyncResult</code>    ,  - ,   ,    UI. <br> <br>       , , ,    .   ,     .  ,      UI,     ,   ,          ,     ,        "   UI." <br> <br>     ,    ,    .   ,    ,     mock-, ,   ,   ,      ,          . <br> <br>           UI,    ,    .   ,     ,   ,      .        ,   .     ,    ,     . <br> <br> <code class="cs">questionnaireRepositoryMock .Setup( r =&gt; r.SubmitQuestionnaireAsync( It.IsAny&lt;Questionnaire&gt;(), It.IsAny&lt;Action&lt;IOperationResult&gt;&gt;())) .Callback&lt;Questionnaire, Action&lt;IOperationResult&gt;&gt;( (q, a) =&gt; callback = a); uiServicemock .Setup(svc =&gt; svc.ShowView(ViewNames.QuestionnaireTemplatesList)) .Callback&lt;string&gt;(viewName =&gt; requestedViewName = viewName); submitResultMock .Setup(sr =&gt; sr.Error) .Returns&lt;Exception&gt;(null); CompleteQuestionnaire(viewModel); viewModel.Submit(); //      UI . callback(submitResultMock.Object); //    ‚Äì     . Assert.AreEqual(ViewNames.QuestionnaireTemplatesList, requestedViewName);</code> <br> <b></b> <br>          ,        . <br>   <br>       , . "Trees in WPF"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ms753391.aspx">http://msdn.microsoft.com/en-us/library/ms753391.aspx</a> <br> <br>       , . "Attached Properties Overview"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/cc265152(VS.95).aspx">http://msdn.microsoft.com/en-us/library/cc265152(VS.95).aspx</a> <br> <br>      MEF, ."Managed Extensibility Framework Overview"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/dd460648.aspx">http://msdn.microsoft.com/en-us/library/dd460648.aspx</a> . <br> <br>      Unity, ."Unity Application Block"  MSDN: <a href="http://www.msdn.com/unity">http://www.msdn.com/unity</a> . <br> <br>      <code>DelegateCommand</code> , .Chapter 5, " <a href="http://msdn.microsoft.com/en-us/library/gg405484(v%3DPandP.40).aspx">Implementing the MVVM Pattern</a> ." <br> <br>        Microsoft Expression Blend, ."Working with built-in behaviors"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ff724013(v%3DExpression.40).aspx">http://msdn.microsoft.com/en-us/library/ff724013(v=Expression.40).aspx</a> . <br> <br>          Microsoft Expression Blend, ."Creating Custom Behaviors"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ff724708(v%3DExpression.40).aspx">http://msdn.microsoft.com/en-us/library/ff724708(v=Expression.40).aspx</a> . <br> <br>            Microsoft Expression Blend, ."Creating Custom Triggers and Actions"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ff724707(v%3DExpression.40).aspx">http://msdn.microsoft.com/en-us/library/ff724707(v=Expression.40).aspx</a> . <br> <br>         WPF  Silverlight, ."Threading Model"  "The Dispatcher Class"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ms741870.aspx">http://msdn.microsoft.com/en-us/library/ms741870.aspx</a> <br> <a href="http://msdn.microsoft.com/en-us/library/ms615907(v%3DVS.95).aspx">http://msdn.microsoft.com/en-us/library/ms615907(v=VS.95).aspx</a> . <br> <br>      unit-  Silverlight, ."Unit Testing with Silverlight 2": <a href="http://www.jeff.wilcox.name/2008/03/silverlight2-unit-testing/">http://www.jeff.wilcox.name/2008/03/silverlight2-unit-testing/</a> . <br> <br>         , .  " <a href="http://msdn.microsoft.com/en-us/library/gg430861(v%3DPandP.40).aspx">View-Based Navigation</a> " in Chapter 8, " <a href="http://msdn.microsoft.com/en-us/library/gg430861(v%3DPandP.40).aspx">Navigation</a> ." <br> <br>       ,   , ."Event-based Asynchronous Pattern Overview"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/wewwczdw.aspx">http://msdn.microsoft.com/en-us/library/wewwczdw.aspx</a> <br> <br>        <code>IAsyncResult</code> , ."Asynchronous Programming Overview"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ms228963.aspx">http://msdn.microsoft.com/en-us/library/ms228963.aspx</a></code></code></code></code></code></code></code></code></code> <h5> <code><code><code><code><code><code><code><code><code><code>CommandBehaviorBase ,    ,    ICommand</code> .           <code>CanExecuteChanged</code> ,          Silverlight,    WPF. <br> <br>    ,  ,   <code>CommandBehaviorBase    ,    .         ,      .         ,    .      ButtonBaseClickCommandBehavior</code> . <br> <br> <code class="cs">public class ButtonBaseClickCommandBehavior : CommandBehaviorBase&lt;ButtonBase&gt; { public ButtonBaseClickCommandBehavior(ButtonBase clickableObject) : base(clickableObject) { clickableObject.Click += OnClick; } private void OnClick(object sender, System.Windows.RoutedEventArgs e) { ExecuteCommand(); } }</code> <br>   <code>CommandBehaviorBase ,     .     ,          ,   . ,    ,    ,      , ,    CanExecute</code>  ,     . <br> <br>          ,   .           XAML.           .       .  Prism      ,       ,  ,   .       ,    . , ,  ,      <code>Click</code> ,       <code>Command</code> .    <code>Click.Command</code> ,  . <br> <br>             .             . <br> <br> <code class="cs">public static readonly DependencyProperty CommandProperty = DependencyProperty.RegisterAttached( "Command", typeof(ICommand), typeof(Click), new PropertyMetadata(OnSetCommandCallback)); private static readonly DependencyProperty ClickCommandBehaviorProperty = DependencyProperty.RegisterAttached( "ClickCommandBehavior", typeof(ButtonBaseClickCommandBehavior), typeof(Click), null);</code> <br>    <code>Command</code>    <code>ButtonBaseClickCommandBehavior</code> ,     <code>OnSetCommandCallback</code> ,     . <br> <br> <code class="cs">private static void OnSetCommandCallback(DependencyObject dependencyObject, DependencyPropertyChangedEventArgs e) { ButtonBase buttonBase = dependencyObject as ButtonBase; if (buttonBase != null) { ButtonBaseClickCommandBehavior behavior = GetOrCreateBehavior(buttonBase); behavior.Command = e.NewValue as ICommand; } } private static void OnSetCommandParameterCallback(DependencyObject dependencyObject, DependencyPropertyChangedEventArgs e) { ButtonBase buttonBase = dependencyObject as ButtonBase; if (buttonBase != null) { ButtonBaseClickCommandBehavior behavior = GetOrCreateBehavior(buttonBase); behavior.CommandParameter = e.NewValue; } } private static ButtonBaseClickCommandBehavior GetOrCreateBehavior(ButtonBase buttonBase ) { ButtonBaseClickCommandBehavior behavior = buttonBase.GetValue(ClickCommandBehaviorProperty) as ButtonBaseClickCommandBehavior; if ( behavior == null ) { behavior = new ButtonBaseClickCommandBehavior(buttonBase); buttonBase.SetValue(ClickCommandBehaviorProperty, behavior); } return behavior; }</code> <br>        ,  <a href="http://msdn.microsoft.com/en-us/library/cc265152(VS.95).aspx">Attached Properties Overview</a>  MSDN. <br> <br>    <br>              . ,     Silverlight,    -,     ,      ,     .     ,       . <br> <br>        ,    ( )  ,  ,     .  UI       ,            UI. <br> <br>      - <br>   -     ,       <code>IAsyncResult</code> .   ,  ,   ,  <code>GetQuestionnaire</code> ,   : <code>BeginGetQuestionnaire</code>  <code>EndGetQuestionnaire</code> .    ,   <code>BeginGetQuestionnaire</code> .     ,   ,   <code>EndGetQuestionnaire</code>    . <br> <b></b> <br>  .NET Framework 4.5      <code>await</code>  <code>async</code>     <code>*Async</code> .      <a href="http://msdn.microsoft.com/en-us/library/vstudio/hh391443.aspx">"Asynchronous Programming with Async and Await (C# and Visual Basic)"</a> . <br>  ,    <code>EndGetQuestionnaire</code> ,      ,  ()      <code>BeginGetQuestionnaire</code> .     ,      ,   <code>EndGetQuestionnaire</code> ,   . <br> <br> <code class="xml">IAsyncResult asyncResult = this.service.BeginGetQuestionnaire( GetQuestionnaireCompleted, null //  ,      ); private void GetQuestionnaireCompleted(IAsyncResult result) { try { questionnaire = this.service.EndGetQuestionnaire(ar); } catch (Exception ex) { //  -   . } }</code> <br>  ,     <code>End*</code> (  , <code>EndGetQuestionnaire</code> ),    ,      .      , ,          UI.     ,   ,        . <br> <br>        UI,     -,      UI,         UI,   <code>Dispatcher</code>    <code>SynchronizationContext</code> .  WPF  Silverlight,   <code>Dispatcher</code> . <br> <br>      <code>Questionnaire</code>  ,        <code>QuestionnaireView</code> .  Silverlight    <code>CheckAccess</code> ,  ,      UI.  ,     <code>BeginInvoke</code> ,      UI. <br> <br> <code class="cs">var dispatcher = System.Windows.Deployment.Current.Dispatcher; if (dispatcher.CheckAccess()) { QuestionnaireView.DataContext = questionnaire; } else { dispatcher.BeginInvoke(() =&gt; { Questionnaire.DataContext = questionnaire; }); }</code> <br> <i>MVVM RI</i>   ,    ,   <code>IAsyncResult</code> ,   .      ,                 . ,       . <br> <br> <code class="cs">this.questionnaireRepository.GetQuestionnaireAsync( result =&gt; { this.Questionnaire = result.Result; });</code> <br>  <code>result</code>   ,     , , , .    ,     . <br> <br> <code class="cs">this.questionnaireRepository.GetQuestionnaireAsync( result =&gt; { if (result.Error == null) { this.Questionnaire = result.Result; ... } else { // Handle error. } })</code> <br>     <br>        ,      .     , ,             .        ,      ,     ,     . <br> <br>         ,      MVVM,     ,   . ,  -MVVM ,     <code>MessageBox</code>   code-behind UI,      .   MVVM     ,          . <br> <br>     MVVM,              ,          .      ,    ,   ,  ,     . <br> <br>              MVVM.      ,     ,     ,  ,     .    ,         ,     ,          .       . <br> <br>    <br>                  .        ,        .  ,         .         . <br> <br>  ,         ,         ,  .      ,     .           ,       . ,        WPF  Silverlight,        . <br> <br> <img title="Using the service to interact with the user." src="https://habrastorage.org/getpro/habr/post_images/4b5/397/f2d/4b5397f2d02e5851195b29f1893be6fc.png" alt=" ,    ."> <br> <br>  ,   <code>MessageBox</code>        ,     ,    ,     . <br> <br> <code class="cs">var result = interactionService.ShowMessageBox( "Are you sure you want to cancel this operation?", "Confirm", MessageBoxButton.OK); if (result == MessageBoxResult.Yes) { CancelRequest(); }</code> <br> ,      - ,      ,         Silverlight.         .             .     . <br> <br> <code class="cs">interactionService.ShowMessageBox( "Are you sure you want to cancel this operation?", "Confirm", MessageBoxButton.OK, result =&gt; { if (result == MessageBoxResult.Yes) { CancelRequest(); } });</code> <br>         ,      . ,  WPF    <code>MessageBox</code> ,       ;    Silverlight    ,    . <br> <br>     <br>         ‚Äì             .         ,      .     ,     .        ,        ,   ,     . <br> <br> <img title="Using interaction request objects." src="https://habrastorage.org/getpro/habr/post_images/3d0/ff0/1c5/3d0ff01c5518558c2d3c5c5f47ce0ce9.png" alt="   ."> <br> <br>    ,   ,          ‚Äì       ,      ,   ‚Äì     .   ,        ,    ,    UI            . <br> <br>       MVVM,     ,       ,         .         ,        ,    ,   . <br> <br>  Prism       <code>IInteractionRequest</code>   <code>InteractionRequest .  IInteractionRequest</code>  ,   .           ,   .  <code>InteractionRequest   IInteractionRequest</code>     <code>Raise</code> ,           , , ,   . <br> <br>       <br>  <code>InteractionRequest          .  Raise</code>          ( <code>T</code> )    ,    ,   .          ,       .      ,        .    ,  ,     . <br> <code class="cs">public interface IInteractionRequest { event EventHandler&lt;InteractionRequestedEventArgs&gt; Raised; } public class InteractionRequest&lt;T&gt; : IInteractionRequest { public event EventHandler&lt;InteractionRequestedEventArgs&gt; Raised; public void Raise(T context, Action&lt;T&gt; callback) { var handler = this.Raised; if (handler != null) { handler( this, new InteractionRequestedEventArgs(context, () =&gt; callback(context))); } } }</code> <br> Prism    ,      .  <code>Notification</code>       .    ,            .     ‚Äì <code>Title</code>  <code>Content</code> ,    .  ,   ,  ,  ,        . <br> <br>  <code>Confirmation</code>    <code>Notification</code>     ‚Äì <code>Confirmed</code> ,  ,  ,      .  <code>Confirmation</code> ,     <code>MessageBox</code> ,     /  .     ,     <code>Notification</code> ,     ,      . <br> <br>    <code>InteractionRequest ,       InteractionRequest      ,      .      ,    Raise</code> ,    , ,   . <br> <br> <code class="cs">public IInteractionRequest ConfirmCancelInteractionRequest { get { return this.confirmCancelInteractionRequest; } } this.confirmCancelInteractionRequest.Raise( new Confirmation("Are you sure you wish to cancel?"), confirmation =&gt; { if (confirmation.Confirmed) { this.NavigateToQuestionnaireList(); } }); }</code> <br> <i>MVVM Reference Implementation (MVVM RI)</i> ,    <code>IInteractionRequest</code>   <code>InteractionRequest ,          (. QuestionnaireViewModel.cs</code> ). <br> <br>        <br>       ,       .   ,       .    UI             . <br> <br>                . Microsoft Expression Blend Behaviors Framework     .  ,     ,    . <br> <br>  <code>EventTrigger</code> ,  Expression Blend,  ,      ,     ,   . , Prism   <code>EventTrigger</code> ,  <code>InteractionRequestTrigger</code> ,      <code>Raised</code>   <code>IInteractionRequest</code> .    XAML        . <br> <br>  ,   , <code>InteractionRequestTrigger</code>   .  Silverlight Prism   <code>PopupChildWindowAction</code> ,     .    ,         .   <code>ContentTemplate</code>  <code>PopupChildWindowAction</code> ,    ,    UI,      <code>Content</code>  .       <code>Title</code>  . <br> <b></b> <br>  ,    ,   <code>PopupChildWindowAction</code> ,     .    <code>Notification</code>  <code>NotificationChildWindow</code> ,        <code>Confirmation</code> ‚Äì <code>ConfirmationChildWindow</code> . <code>NotificationChildWindow</code>    ,   ,     <code>ConfirmationChildWindow</code>    <i>OK</i>  <i>Cancel</i> ,    .    ,   ,   <code>ChildWindow</code>  <code>PopupChildWindowAction</code> . <br>   ,  <code>InteractionRequestTrigger</code>  <code>PopupChildWindowAction</code> ,       <i>RI MVVM</i> . <br> <br> <code class="xml">&lt;i:Interaction.Triggers&gt; &lt;prism:InteractionRequestTrigger SourceObject="{Binding ConfirmCancelInteractionRequest}"&gt; &lt;prism:PopupChildWindowAction ContentTemplate="{StaticResource ConfirmWindowTemplate}"/&gt; &lt;/prism:InteractionRequestTrigger&gt; &lt;/i:Interaction.Triggers&gt; &lt;UserControl.Resources&gt; &lt;DataTemplate x:Key="ConfirmWindowTemplate"&gt; &lt;Grid MinWidth="250" MinHeight="100"&gt; &lt;TextBlock TextWrapping="Wrap" Grid.Row="0" Text="{Binding}"/&gt; &lt;/Grid&gt; &lt;/DataTemplate&gt; &lt;/UserControl.Resources&gt;</code> <br> <b></b> <br>      <code>ContentTemplate</code> ,   UI   <code>Content</code>  .    <code>Content</code>  ,  , <code>TextBlock</code>     <code>Content</code> . <br>      ,     ,    ,    .  ,     ,       ,     ,    .   ,   <i>RI MVVM</i> ,         <code>Confirmed</code>    <code>Confirmation</code>  <code>true</code> ,     OK. <br> <br>        ,     .  Prism <code>InteractionRequestTrigger</code>   <code>PopupChildWindowAction</code>            . <br> <br>     <br>     MVVM,       , ,    ,         .        (  , ,  ,   ).    ,  ,  ,            . <br> <br>        ,         . Managed Extensibility Framework (MEF)  Unity Application Block (Unity)      ,  ,           . <br> <br>  ,       , , ,    ( )      . ,       ,     .  ,     ,       . <br> <br>     ,  MEF <br>  MEF,       ,   <code>Import</code> ,      ,  ,   <code>Export</code> .         ,    . <br> <br> , <code>QuestionnaireView</code>   <i>RI MVVM</i> ,        ,    <code>Import</code> .   , MEF           .  <code>set</code>        ,   . <br> <br> <code class="cs">[Import] public QuestionnaireViewModel ViewModel { set { this.DataContext = value; } }</code> <br>     ,   . <br> <br> <code class="cs">[Export] public class QuestionnaireViewModel : NotificationObject { ... }</code> <br>        ,   . <br> <br> <code class="cs">public QuestionnaireView() { InitializeComponent(); } [ImportingConstructor] public QuestionnaireView(QuestionnaireViewModel viewModel) : this() { this.DataContext = viewModel; }</code> <br> <b></b> <br>          MEF,   Unity.   ,     ,        .   ,   Visual Studio  Expression Blend, ,        ,     .   ,   ,  ,      ,          <code>InitializeComponent</code> . <br>     ,  Unity <br>  Unity,    ,   MEF.     ,      .    ,         .  ,      . <br> <br>  ,      ,  ,         . ,           ,   . <br> <br> <code class="cs">public QuestionnaireView() { InitializeComponent(); } public QuestionnaireView(QuestionnaireViewModel viewModel) : this() { this.DataContext = viewModel; }</code> <br> <b></b> <br>    ,        ,   Visual Studio  Expression Blend. <br>  ,          ,   . Unity        <code>set</code>   ,   . <br> <br> <code class="cs">public QuestionnaireView() { InitializeComponent(); } [Dependency] public QuestionnaireViewModel ViewModel { set { this.DataContext = value; } }</code> <br>       Unity. <br> <br> <code class="cs">container.RegisterType&lt;QuestionnaireViewModel&gt;();</code> <br>  ,     . <br> <br> <code class="cs">var view = container.Resolve&lt;QuestionnaireView&gt;();</code> <br>     ,    <br>   ,     ,        .        ,   MEF  Unity,        . <br> <br>          .   ,         UI,           . <br> <br> , <i>RI MVVM</i>   ,   ,        .   ,    .      <code>ShowView</code>   UI. <br> <br> <code class="cs">private void NavigateToQuestionnaireList() { //     "questionnaire list". this.uiService.ShowView(ViewNames.QuestionnaireTemplatesList); }</code> <br>  UI      UI .           UI.  <code>ShowView</code>  <code>UIService</code>      (,          ),       ,   . <br> <br> <code class="cs">public void ShowView(string viewName) { var view = this.ViewFactory.GetView(viewName); this.MainWindow.CurrentView = view; }</code> <br> <b></b> <br> Prism       .   ,   ,   ,             .    ,  , " <a href="http://msdn.microsoft.com/en-us/library/gg430861(v%3DPandP.40).aspx">View-Based Navigation</a> "   8, " <a href="http://msdn.microsoft.com/en-us/library/gg430861(v%3DPandP.40).aspx">Navigation</a> ". <br>  MVVM  <br>        MVVM      .           -      mocking . ,   ,        . <br> <br>   <i>INotifyPropertyChanged</i> <br>   <code>INotifyPropertyChanged</code>     ,      .      ,    ;   ,   ,     ,    ,       . <br> <br>   <br> ,       ,           <code>PropertyChanged</code>  ,         .  ,    <code>ChangeTracker</code> ,     MVVM,  ,      .      .     ,    . <br> <br> <code class="cs">var changeTracker = new PropertyChangeTracker(viewModel); viewModel.CurrentState = "newState"; CollectionAssert.Contains(changeTracker.ChangedProperties, "CurrentState");</code> <br> ,     ,     <code>INotifyPropertyChanged</code> ,    ,   ,     . <br> <br>      <br>        ,   ,    <code>set</code>      ,           . ,     ,     ,      ,          . <br> <br> <code class="cs">var changeTracker = new PropertyChangeTracker(viewModel); var question = viewModel.Questions.First() as OpenQuestionViewModel; question.Question.Response = "some text"; CollectionAssert.Contains(changeTracker.ChangedProperties, "UnansweredQuestions");</code> <br>      <br>     <code>INotifyPropertyChanged</code> ,      <code>PropertyChanged</code>        ,  ,     , , .        ,       . <br> <br>   <i>INotifyDataErrorInfo</i> <br>   ,     ,    ,   ,   <code>IDataErrorInfo</code> ,  ( Silverlight)   <code>INotifyDataErrorInfo</code> .   <code>INotifyDataErrorInfo</code>   ,         ,    ,  ,   ,    . <br> <br>       <code>INotifyDataErrorInfo</code> : ,     ,  ,     ,     <code>ErrorsChanged</code> ,      <code>GetErrors</code> , . <br> <br>    <br>     ,      ,     .       ,         <code>GetErrors</code>       ,  ,  ,   .    , ,  ,     ,        .   ,        . <br> <br> <code class="cs">//  . var notifyErrorInfo = (INotifyDataErrorInfo)question; question.Response = -15; Assert.IsTrue(notifyErrorInfo.GetErrors("Response").Cast&lt;ValidationResult&gt;().Any()); //  . var notifyErrorInfo = (INotifyDataErrorInfo)question; question.Response = 15; Assert.IsFalse(notifyErrorInfo.GetErrors("Response").Cast&lt;ValidationResult&gt;().Any());</code> <br>    ,    ,             . <br> <br>    <i>INotifyDataErrorInfo</i> <br>       <code>GetErrors</code> ,   <code>INotifyDataErrorInfo</code>  ,   <code>ErrorsChanged</code>      <code>GetErrors</code> . ,  <code>HasErrors</code>      ,  . <br> <br>       <code>INotifyDataErrorInfo</code> . , ,           ,   -  .      ,        <code>INotifyDataErrorInfo</code>         (,        ). <br> <br>     ,   ,  : <br>  <code>HasErrors</code>     .              ,       .  <code>ErrorsChanged</code> ,      ,         <code>GetErrors</code> .         ( ,  )     ,           .    <code>GetErrors</code>       <code>ErrorsChanged</code> . <br>    <code>INotifyPropertyChanged</code> ,  ,    <code>NotifyDataErrorInfoTestHelper</code>    MVVM,        <code>INotifyDataErrorInfo</code> ,       .   ,   ,      ,   .      . <br> <code class="cs">var helper = new NotifyDataErrorInfoTestHelper&lt;NumericQuestion, int?&gt;( question, q =&gt; q.Response); helper.ValidatePropertyChange( 6, NotifyDataErrorInfoBehavior.Nothing); helper.ValidatePropertyChange( 20, NotifyDataErrorInfoBehavior.FiresErrorsChanged | NotifyDataErrorInfoBehavior.HasErrors | NotifyDataErrorInfoBehavior.HasErrorsForProperty); helper.ValidatePropertyChange( null, NotifyDataErrorInfoBehavior.FiresErrorsChanged | NotifyDataErrorInfoBehavior.HasErrors | NotifyDataErrorInfoBehavior.HasErrorsForProperty); helper.ValidatePropertyChange( 2, NotifyDataErrorInfoBehavior.FiresErrorsChanged);</code> <br>     <br>   MVVM,     ,  .   ,    ,         . <br> <br>  ,     ,     ,       .   ,   , ,       ,     ,   <code>IAsyncResult</code>    ,  - ,   ,    UI. <br> <br>       , , ,    .   ,     .  ,      UI,     ,   ,          ,     ,        "   UI." <br> <br>     ,    ,    .   ,    ,     mock-, ,   ,   ,      ,          . <br> <br>           UI,    ,    .   ,     ,   ,      .        ,   .     ,    ,     . <br> <br> <code class="cs">questionnaireRepositoryMock .Setup( r =&gt; r.SubmitQuestionnaireAsync( It.IsAny&lt;Questionnaire&gt;(), It.IsAny&lt;Action&lt;IOperationResult&gt;&gt;())) .Callback&lt;Questionnaire, Action&lt;IOperationResult&gt;&gt;( (q, a) =&gt; callback = a); uiServicemock .Setup(svc =&gt; svc.ShowView(ViewNames.QuestionnaireTemplatesList)) .Callback&lt;string&gt;(viewName =&gt; requestedViewName = viewName); submitResultMock .Setup(sr =&gt; sr.Error) .Returns&lt;Exception&gt;(null); CompleteQuestionnaire(viewModel); viewModel.Submit(); //      UI . callback(submitResultMock.Object); //    ‚Äì     . Assert.AreEqual(ViewNames.QuestionnaireTemplatesList, requestedViewName);</code> <br> <b></b> <br>          ,        . <br>   <br>       , . "Trees in WPF"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ms753391.aspx">http://msdn.microsoft.com/en-us/library/ms753391.aspx</a> <br> <br>       , . "Attached Properties Overview"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/cc265152(VS.95).aspx">http://msdn.microsoft.com/en-us/library/cc265152(VS.95).aspx</a> <br> <br>      MEF, ."Managed Extensibility Framework Overview"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/dd460648.aspx">http://msdn.microsoft.com/en-us/library/dd460648.aspx</a> . <br> <br>      Unity, ."Unity Application Block"  MSDN: <a href="http://www.msdn.com/unity">http://www.msdn.com/unity</a> . <br> <br>      <code>DelegateCommand</code> , .Chapter 5, " <a href="http://msdn.microsoft.com/en-us/library/gg405484(v%3DPandP.40).aspx">Implementing the MVVM Pattern</a> ." <br> <br>        Microsoft Expression Blend, ."Working with built-in behaviors"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ff724013(v%3DExpression.40).aspx">http://msdn.microsoft.com/en-us/library/ff724013(v=Expression.40).aspx</a> . <br> <br>          Microsoft Expression Blend, ."Creating Custom Behaviors"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ff724708(v%3DExpression.40).aspx">http://msdn.microsoft.com/en-us/library/ff724708(v=Expression.40).aspx</a> . <br> <br>            Microsoft Expression Blend, ."Creating Custom Triggers and Actions"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ff724707(v%3DExpression.40).aspx">http://msdn.microsoft.com/en-us/library/ff724707(v=Expression.40).aspx</a> . <br> <br>         WPF  Silverlight, ."Threading Model"  "The Dispatcher Class"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ms741870.aspx">http://msdn.microsoft.com/en-us/library/ms741870.aspx</a> <br> <a href="http://msdn.microsoft.com/en-us/library/ms615907(v%3DVS.95).aspx">http://msdn.microsoft.com/en-us/library/ms615907(v=VS.95).aspx</a> . <br> <br>      unit-  Silverlight, ."Unit Testing with Silverlight 2": <a href="http://www.jeff.wilcox.name/2008/03/silverlight2-unit-testing/">http://www.jeff.wilcox.name/2008/03/silverlight2-unit-testing/</a> . <br> <br>         , .  " <a href="http://msdn.microsoft.com/en-us/library/gg430861(v%3DPandP.40).aspx">View-Based Navigation</a> " in Chapter 8, " <a href="http://msdn.microsoft.com/en-us/library/gg430861(v%3DPandP.40).aspx">Navigation</a> ." <br> <br>       ,   , ."Event-based Asynchronous Pattern Overview"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/wewwczdw.aspx">http://msdn.microsoft.com/en-us/library/wewwczdw.aspx</a> <br> <br>        <code>IAsyncResult</code> , ."Asynchronous Programming Overview"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ms228963.aspx">http://msdn.microsoft.com/en-us/library/ms228963.aspx</a></code></code></code></code></code></code></code></code></code> </h5> <code><code><code><code><code><code><code><code><code><code>CommandBehaviorBase ,    ,    ICommand</code> .           <code>CanExecuteChanged</code> ,          Silverlight,    WPF. <br> <br>    ,  ,   <code>CommandBehaviorBase    ,    .         ,      .         ,    .      ButtonBaseClickCommandBehavior</code> . <br> <br> <code class="cs">public class ButtonBaseClickCommandBehavior : CommandBehaviorBase&lt;ButtonBase&gt; { public ButtonBaseClickCommandBehavior(ButtonBase clickableObject) : base(clickableObject) { clickableObject.Click += OnClick; } private void OnClick(object sender, System.Windows.RoutedEventArgs e) { ExecuteCommand(); } }</code> <br>   <code>CommandBehaviorBase ,     .     ,          ,   . ,    ,    ,      , ,    CanExecute</code>  ,     . <br> <br>          ,   .           XAML.           .       .  Prism      ,       ,  ,   .       ,    . , ,  ,      <code>Click</code> ,       <code>Command</code> .    <code>Click.Command</code> ,  . <br> <br>             .             . <br> <br> <code class="cs">public static readonly DependencyProperty CommandProperty = DependencyProperty.RegisterAttached( "Command", typeof(ICommand), typeof(Click), new PropertyMetadata(OnSetCommandCallback)); private static readonly DependencyProperty ClickCommandBehaviorProperty = DependencyProperty.RegisterAttached( "ClickCommandBehavior", typeof(ButtonBaseClickCommandBehavior), typeof(Click), null);</code> <br>    <code>Command</code>    <code>ButtonBaseClickCommandBehavior</code> ,     <code>OnSetCommandCallback</code> ,     . <br> <br> <code class="cs">private static void OnSetCommandCallback(DependencyObject dependencyObject, DependencyPropertyChangedEventArgs e) { ButtonBase buttonBase = dependencyObject as ButtonBase; if (buttonBase != null) { ButtonBaseClickCommandBehavior behavior = GetOrCreateBehavior(buttonBase); behavior.Command = e.NewValue as ICommand; } } private static void OnSetCommandParameterCallback(DependencyObject dependencyObject, DependencyPropertyChangedEventArgs e) { ButtonBase buttonBase = dependencyObject as ButtonBase; if (buttonBase != null) { ButtonBaseClickCommandBehavior behavior = GetOrCreateBehavior(buttonBase); behavior.CommandParameter = e.NewValue; } } private static ButtonBaseClickCommandBehavior GetOrCreateBehavior(ButtonBase buttonBase ) { ButtonBaseClickCommandBehavior behavior = buttonBase.GetValue(ClickCommandBehaviorProperty) as ButtonBaseClickCommandBehavior; if ( behavior == null ) { behavior = new ButtonBaseClickCommandBehavior(buttonBase); buttonBase.SetValue(ClickCommandBehaviorProperty, behavior); } return behavior; }</code> <br>        ,  <a href="http://msdn.microsoft.com/en-us/library/cc265152(VS.95).aspx">Attached Properties Overview</a>  MSDN. <br> <br>    <br>              . ,     Silverlight,    -,     ,      ,     .     ,       . <br> <br>        ,    ( )  ,  ,     .  UI       ,            UI. <br> <br>      - <br>   -     ,       <code>IAsyncResult</code> .   ,  ,   ,  <code>GetQuestionnaire</code> ,   : <code>BeginGetQuestionnaire</code>  <code>EndGetQuestionnaire</code> .    ,   <code>BeginGetQuestionnaire</code> .     ,   ,   <code>EndGetQuestionnaire</code>    . <br> <b></b> <br>  .NET Framework 4.5      <code>await</code>  <code>async</code>     <code>*Async</code> .      <a href="http://msdn.microsoft.com/en-us/library/vstudio/hh391443.aspx">"Asynchronous Programming with Async and Await (C# and Visual Basic)"</a> . <br>  ,    <code>EndGetQuestionnaire</code> ,      ,  ()      <code>BeginGetQuestionnaire</code> .     ,      ,   <code>EndGetQuestionnaire</code> ,   . <br> <br> <code class="xml">IAsyncResult asyncResult = this.service.BeginGetQuestionnaire( GetQuestionnaireCompleted, null //  ,      ); private void GetQuestionnaireCompleted(IAsyncResult result) { try { questionnaire = this.service.EndGetQuestionnaire(ar); } catch (Exception ex) { //  -   . } }</code> <br>  ,     <code>End*</code> (  , <code>EndGetQuestionnaire</code> ),    ,      .      , ,          UI.     ,   ,        . <br> <br>        UI,     -,      UI,         UI,   <code>Dispatcher</code>    <code>SynchronizationContext</code> .  WPF  Silverlight,   <code>Dispatcher</code> . <br> <br>      <code>Questionnaire</code>  ,        <code>QuestionnaireView</code> .  Silverlight    <code>CheckAccess</code> ,  ,      UI.  ,     <code>BeginInvoke</code> ,      UI. <br> <br> <code class="cs">var dispatcher = System.Windows.Deployment.Current.Dispatcher; if (dispatcher.CheckAccess()) { QuestionnaireView.DataContext = questionnaire; } else { dispatcher.BeginInvoke(() =&gt; { Questionnaire.DataContext = questionnaire; }); }</code> <br> <i>MVVM RI</i>   ,    ,   <code>IAsyncResult</code> ,   .      ,                 . ,       . <br> <br> <code class="cs">this.questionnaireRepository.GetQuestionnaireAsync( result =&gt; { this.Questionnaire = result.Result; });</code> <br>  <code>result</code>   ,     , , , .    ,     . <br> <br> <code class="cs">this.questionnaireRepository.GetQuestionnaireAsync( result =&gt; { if (result.Error == null) { this.Questionnaire = result.Result; ... } else { // Handle error. } })</code> <br>     <br>        ,      .     , ,             .        ,      ,     ,     . <br> <br>         ,      MVVM,     ,   . ,  -MVVM ,     <code>MessageBox</code>   code-behind UI,      .   MVVM     ,          . <br> <br>     MVVM,              ,          .      ,    ,   ,  ,     . <br> <br>              MVVM.      ,     ,     ,  ,     .    ,         ,     ,          .       . <br> <br>    <br>                  .        ,        .  ,         .         . <br> <br>  ,         ,         ,  .      ,     .           ,       . ,        WPF  Silverlight,        . <br> <br> <img title="Using the service to interact with the user." src="https://habrastorage.org/getpro/habr/post_images/4b5/397/f2d/4b5397f2d02e5851195b29f1893be6fc.png" alt=" ,    ."> <br> <br>  ,   <code>MessageBox</code>        ,     ,    ,     . <br> <br> <code class="cs">var result = interactionService.ShowMessageBox( "Are you sure you want to cancel this operation?", "Confirm", MessageBoxButton.OK); if (result == MessageBoxResult.Yes) { CancelRequest(); }</code> <br> ,      - ,      ,         Silverlight.         .             .     . <br> <br> <code class="cs">interactionService.ShowMessageBox( "Are you sure you want to cancel this operation?", "Confirm", MessageBoxButton.OK, result =&gt; { if (result == MessageBoxResult.Yes) { CancelRequest(); } });</code> <br>         ,      . ,  WPF    <code>MessageBox</code> ,       ;    Silverlight    ,    . <br> <br>     <br>         ‚Äì             .         ,      .     ,     .        ,        ,   ,     . <br> <br> <img title="Using interaction request objects." src="https://habrastorage.org/getpro/habr/post_images/3d0/ff0/1c5/3d0ff01c5518558c2d3c5c5f47ce0ce9.png" alt="   ."> <br> <br>    ,   ,          ‚Äì       ,      ,   ‚Äì     .   ,        ,    ,    UI            . <br> <br>       MVVM,     ,       ,         .         ,        ,    ,   . <br> <br>  Prism       <code>IInteractionRequest</code>   <code>InteractionRequest .  IInteractionRequest</code>  ,   .           ,   .  <code>InteractionRequest   IInteractionRequest</code>     <code>Raise</code> ,           , , ,   . <br> <br>       <br>  <code>InteractionRequest          .  Raise</code>          ( <code>T</code> )    ,    ,   .          ,       .      ,        .    ,  ,     . <br> <code class="cs">public interface IInteractionRequest { event EventHandler&lt;InteractionRequestedEventArgs&gt; Raised; } public class InteractionRequest&lt;T&gt; : IInteractionRequest { public event EventHandler&lt;InteractionRequestedEventArgs&gt; Raised; public void Raise(T context, Action&lt;T&gt; callback) { var handler = this.Raised; if (handler != null) { handler( this, new InteractionRequestedEventArgs(context, () =&gt; callback(context))); } } }</code> <br> Prism    ,      .  <code>Notification</code>       .    ,            .     ‚Äì <code>Title</code>  <code>Content</code> ,    .  ,   ,  ,  ,        . <br> <br>  <code>Confirmation</code>    <code>Notification</code>     ‚Äì <code>Confirmed</code> ,  ,  ,      .  <code>Confirmation</code> ,     <code>MessageBox</code> ,     /  .     ,     <code>Notification</code> ,     ,      . <br> <br>    <code>InteractionRequest ,       InteractionRequest      ,      .      ,    Raise</code> ,    , ,   . <br> <br> <code class="cs">public IInteractionRequest ConfirmCancelInteractionRequest { get { return this.confirmCancelInteractionRequest; } } this.confirmCancelInteractionRequest.Raise( new Confirmation("Are you sure you wish to cancel?"), confirmation =&gt; { if (confirmation.Confirmed) { this.NavigateToQuestionnaireList(); } }); }</code> <br> <i>MVVM Reference Implementation (MVVM RI)</i> ,    <code>IInteractionRequest</code>   <code>InteractionRequest ,          (. QuestionnaireViewModel.cs</code> ). <br> <br>        <br>       ,       .   ,       .    UI             . <br> <br>                . Microsoft Expression Blend Behaviors Framework     .  ,     ,    . <br> <br>  <code>EventTrigger</code> ,  Expression Blend,  ,      ,     ,   . , Prism   <code>EventTrigger</code> ,  <code>InteractionRequestTrigger</code> ,      <code>Raised</code>   <code>IInteractionRequest</code> .    XAML        . <br> <br>  ,   , <code>InteractionRequestTrigger</code>   .  Silverlight Prism   <code>PopupChildWindowAction</code> ,     .    ,         .   <code>ContentTemplate</code>  <code>PopupChildWindowAction</code> ,    ,    UI,      <code>Content</code>  .       <code>Title</code>  . <br> <b></b> <br>  ,    ,   <code>PopupChildWindowAction</code> ,     .    <code>Notification</code>  <code>NotificationChildWindow</code> ,        <code>Confirmation</code> ‚Äì <code>ConfirmationChildWindow</code> . <code>NotificationChildWindow</code>    ,   ,     <code>ConfirmationChildWindow</code>    <i>OK</i>  <i>Cancel</i> ,    .    ,   ,   <code>ChildWindow</code>  <code>PopupChildWindowAction</code> . <br>   ,  <code>InteractionRequestTrigger</code>  <code>PopupChildWindowAction</code> ,       <i>RI MVVM</i> . <br> <br> <code class="xml">&lt;i:Interaction.Triggers&gt; &lt;prism:InteractionRequestTrigger SourceObject="{Binding ConfirmCancelInteractionRequest}"&gt; &lt;prism:PopupChildWindowAction ContentTemplate="{StaticResource ConfirmWindowTemplate}"/&gt; &lt;/prism:InteractionRequestTrigger&gt; &lt;/i:Interaction.Triggers&gt; &lt;UserControl.Resources&gt; &lt;DataTemplate x:Key="ConfirmWindowTemplate"&gt; &lt;Grid MinWidth="250" MinHeight="100"&gt; &lt;TextBlock TextWrapping="Wrap" Grid.Row="0" Text="{Binding}"/&gt; &lt;/Grid&gt; &lt;/DataTemplate&gt; &lt;/UserControl.Resources&gt;</code> <br> <b></b> <br>      <code>ContentTemplate</code> ,   UI   <code>Content</code>  .    <code>Content</code>  ,  , <code>TextBlock</code>     <code>Content</code> . <br>      ,     ,    ,    .  ,     ,       ,     ,    .   ,   <i>RI MVVM</i> ,         <code>Confirmed</code>    <code>Confirmation</code>  <code>true</code> ,     OK. <br> <br>        ,     .  Prism <code>InteractionRequestTrigger</code>   <code>PopupChildWindowAction</code>            . <br> <br>     <br>     MVVM,       , ,    ,         .        (  , ,  ,   ).    ,  ,  ,            . <br> <br>        ,         . Managed Extensibility Framework (MEF)  Unity Application Block (Unity)      ,  ,           . <br> <br>  ,       , , ,    ( )      . ,       ,     .  ,     ,       . <br> <br>     ,  MEF <br>  MEF,       ,   <code>Import</code> ,      ,  ,   <code>Export</code> .         ,    . <br> <br> , <code>QuestionnaireView</code>   <i>RI MVVM</i> ,        ,    <code>Import</code> .   , MEF           .  <code>set</code>        ,   . <br> <br> <code class="cs">[Import] public QuestionnaireViewModel ViewModel { set { this.DataContext = value; } }</code> <br>     ,   . <br> <br> <code class="cs">[Export] public class QuestionnaireViewModel : NotificationObject { ... }</code> <br>        ,   . <br> <br> <code class="cs">public QuestionnaireView() { InitializeComponent(); } [ImportingConstructor] public QuestionnaireView(QuestionnaireViewModel viewModel) : this() { this.DataContext = viewModel; }</code> <br> <b></b> <br>          MEF,   Unity.   ,     ,        .   ,   Visual Studio  Expression Blend, ,        ,     .   ,   ,  ,      ,          <code>InitializeComponent</code> . <br>     ,  Unity <br>  Unity,    ,   MEF.     ,      .    ,         .  ,      . <br> <br>  ,      ,  ,         . ,           ,   . <br> <br> <code class="cs">public QuestionnaireView() { InitializeComponent(); } public QuestionnaireView(QuestionnaireViewModel viewModel) : this() { this.DataContext = viewModel; }</code> <br> <b></b> <br>    ,        ,   Visual Studio  Expression Blend. <br>  ,          ,   . Unity        <code>set</code>   ,   . <br> <br> <code class="cs">public QuestionnaireView() { InitializeComponent(); } [Dependency] public QuestionnaireViewModel ViewModel { set { this.DataContext = value; } }</code> <br>       Unity. <br> <br> <code class="cs">container.RegisterType&lt;QuestionnaireViewModel&gt;();</code> <br>  ,     . <br> <br> <code class="cs">var view = container.Resolve&lt;QuestionnaireView&gt;();</code> <br>     ,    <br>   ,     ,        .        ,   MEF  Unity,        . <br> <br>          .   ,         UI,           . <br> <br> , <i>RI MVVM</i>   ,   ,        .   ,    .      <code>ShowView</code>   UI. <br> <br> <code class="cs">private void NavigateToQuestionnaireList() { //     "questionnaire list". this.uiService.ShowView(ViewNames.QuestionnaireTemplatesList); }</code> <br>  UI      UI .           UI.  <code>ShowView</code>  <code>UIService</code>      (,          ),       ,   . <br> <br> <code class="cs">public void ShowView(string viewName) { var view = this.ViewFactory.GetView(viewName); this.MainWindow.CurrentView = view; }</code> <br> <b></b> <br> Prism       .   ,   ,   ,             .    ,  , " <a href="http://msdn.microsoft.com/en-us/library/gg430861(v%3DPandP.40).aspx">View-Based Navigation</a> "   8, " <a href="http://msdn.microsoft.com/en-us/library/gg430861(v%3DPandP.40).aspx">Navigation</a> ". <br>  MVVM  <br>        MVVM      .           -      mocking . ,   ,        . <br> <br>   <i>INotifyPropertyChanged</i> <br>   <code>INotifyPropertyChanged</code>     ,      .      ,    ;   ,   ,     ,    ,       . <br> <br>   <br> ,       ,           <code>PropertyChanged</code>  ,         .  ,    <code>ChangeTracker</code> ,     MVVM,  ,      .      .     ,    . <br> <br> <code class="cs">var changeTracker = new PropertyChangeTracker(viewModel); viewModel.CurrentState = "newState"; CollectionAssert.Contains(changeTracker.ChangedProperties, "CurrentState");</code> <br> ,     ,     <code>INotifyPropertyChanged</code> ,    ,   ,     . <br> <br>      <br>        ,   ,    <code>set</code>      ,           . ,     ,     ,      ,          . <br> <br> <code class="cs">var changeTracker = new PropertyChangeTracker(viewModel); var question = viewModel.Questions.First() as OpenQuestionViewModel; question.Question.Response = "some text"; CollectionAssert.Contains(changeTracker.ChangedProperties, "UnansweredQuestions");</code> <br>      <br>     <code>INotifyPropertyChanged</code> ,      <code>PropertyChanged</code>        ,  ,     , , .        ,       . <br> <br>   <i>INotifyDataErrorInfo</i> <br>   ,     ,    ,   ,   <code>IDataErrorInfo</code> ,  ( Silverlight)   <code>INotifyDataErrorInfo</code> .   <code>INotifyDataErrorInfo</code>   ,         ,    ,  ,   ,    . <br> <br>       <code>INotifyDataErrorInfo</code> : ,     ,  ,     ,     <code>ErrorsChanged</code> ,      <code>GetErrors</code> , . <br> <br>    <br>     ,      ,     .       ,         <code>GetErrors</code>       ,  ,  ,   .    , ,  ,     ,        .   ,        . <br> <br> <code class="cs">//  . var notifyErrorInfo = (INotifyDataErrorInfo)question; question.Response = -15; Assert.IsTrue(notifyErrorInfo.GetErrors("Response").Cast&lt;ValidationResult&gt;().Any()); //  . var notifyErrorInfo = (INotifyDataErrorInfo)question; question.Response = 15; Assert.IsFalse(notifyErrorInfo.GetErrors("Response").Cast&lt;ValidationResult&gt;().Any());</code> <br>    ,    ,             . <br> <br>    <i>INotifyDataErrorInfo</i> <br>       <code>GetErrors</code> ,   <code>INotifyDataErrorInfo</code>  ,   <code>ErrorsChanged</code>      <code>GetErrors</code> . ,  <code>HasErrors</code>      ,  . <br> <br>       <code>INotifyDataErrorInfo</code> . , ,           ,   -  .      ,        <code>INotifyDataErrorInfo</code>         (,        ). <br> <br>     ,   ,  : <br>  <code>HasErrors</code>     .              ,       .  <code>ErrorsChanged</code> ,      ,         <code>GetErrors</code> .         ( ,  )     ,           .    <code>GetErrors</code>       <code>ErrorsChanged</code> . <br>    <code>INotifyPropertyChanged</code> ,  ,    <code>NotifyDataErrorInfoTestHelper</code>    MVVM,        <code>INotifyDataErrorInfo</code> ,       .   ,   ,      ,   .      . <br> <code class="cs">var helper = new NotifyDataErrorInfoTestHelper&lt;NumericQuestion, int?&gt;( question, q =&gt; q.Response); helper.ValidatePropertyChange( 6, NotifyDataErrorInfoBehavior.Nothing); helper.ValidatePropertyChange( 20, NotifyDataErrorInfoBehavior.FiresErrorsChanged | NotifyDataErrorInfoBehavior.HasErrors | NotifyDataErrorInfoBehavior.HasErrorsForProperty); helper.ValidatePropertyChange( null, NotifyDataErrorInfoBehavior.FiresErrorsChanged | NotifyDataErrorInfoBehavior.HasErrors | NotifyDataErrorInfoBehavior.HasErrorsForProperty); helper.ValidatePropertyChange( 2, NotifyDataErrorInfoBehavior.FiresErrorsChanged);</code> <br>     <br>   MVVM,     ,  .   ,    ,         . <br> <br>  ,     ,     ,       .   ,   , ,       ,     ,   <code>IAsyncResult</code>    ,  - ,   ,    UI. <br> <br>       , , ,    .   ,     .  ,      UI,     ,   ,          ,     ,        "   UI." <br> <br>     ,    ,    .   ,    ,     mock-, ,   ,   ,      ,          . <br> <br>           UI,    ,    .   ,     ,   ,      .        ,   .     ,    ,     . <br> <br> <code class="cs">questionnaireRepositoryMock .Setup( r =&gt; r.SubmitQuestionnaireAsync( It.IsAny&lt;Questionnaire&gt;(), It.IsAny&lt;Action&lt;IOperationResult&gt;&gt;())) .Callback&lt;Questionnaire, Action&lt;IOperationResult&gt;&gt;( (q, a) =&gt; callback = a); uiServicemock .Setup(svc =&gt; svc.ShowView(ViewNames.QuestionnaireTemplatesList)) .Callback&lt;string&gt;(viewName =&gt; requestedViewName = viewName); submitResultMock .Setup(sr =&gt; sr.Error) .Returns&lt;Exception&gt;(null); CompleteQuestionnaire(viewModel); viewModel.Submit(); //      UI . callback(submitResultMock.Object); //    ‚Äì     . Assert.AreEqual(ViewNames.QuestionnaireTemplatesList, requestedViewName);</code> <br> <b></b> <br>          ,        . <br>   <br>       , . "Trees in WPF"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ms753391.aspx">http://msdn.microsoft.com/en-us/library/ms753391.aspx</a> <br> <br>       , . "Attached Properties Overview"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/cc265152(VS.95).aspx">http://msdn.microsoft.com/en-us/library/cc265152(VS.95).aspx</a> <br> <br>      MEF, ."Managed Extensibility Framework Overview"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/dd460648.aspx">http://msdn.microsoft.com/en-us/library/dd460648.aspx</a> . <br> <br>      Unity, ."Unity Application Block"  MSDN: <a href="http://www.msdn.com/unity">http://www.msdn.com/unity</a> . <br> <br>      <code>DelegateCommand</code> , .Chapter 5, " <a href="http://msdn.microsoft.com/en-us/library/gg405484(v%3DPandP.40).aspx">Implementing the MVVM Pattern</a> ." <br> <br>        Microsoft Expression Blend, ."Working with built-in behaviors"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ff724013(v%3DExpression.40).aspx">http://msdn.microsoft.com/en-us/library/ff724013(v=Expression.40).aspx</a> . <br> <br>          Microsoft Expression Blend, ."Creating Custom Behaviors"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ff724708(v%3DExpression.40).aspx">http://msdn.microsoft.com/en-us/library/ff724708(v=Expression.40).aspx</a> . <br> <br>            Microsoft Expression Blend, ."Creating Custom Triggers and Actions"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ff724707(v%3DExpression.40).aspx">http://msdn.microsoft.com/en-us/library/ff724707(v=Expression.40).aspx</a> . <br> <br>         WPF  Silverlight, ."Threading Model"  "The Dispatcher Class"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ms741870.aspx">http://msdn.microsoft.com/en-us/library/ms741870.aspx</a> <br> <a href="http://msdn.microsoft.com/en-us/library/ms615907(v%3DVS.95).aspx">http://msdn.microsoft.com/en-us/library/ms615907(v=VS.95).aspx</a> . <br> <br>      unit-  Silverlight, ."Unit Testing with Silverlight 2": <a href="http://www.jeff.wilcox.name/2008/03/silverlight2-unit-testing/">http://www.jeff.wilcox.name/2008/03/silverlight2-unit-testing/</a> . <br> <br>         , .  " <a href="http://msdn.microsoft.com/en-us/library/gg430861(v%3DPandP.40).aspx">View-Based Navigation</a> " in Chapter 8, " <a href="http://msdn.microsoft.com/en-us/library/gg430861(v%3DPandP.40).aspx">Navigation</a> ." <br> <br>       ,   , ."Event-based Asynchronous Pattern Overview"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/wewwczdw.aspx">http://msdn.microsoft.com/en-us/library/wewwczdw.aspx</a> <br> <br>        <code>IAsyncResult</code> , ."Asynchronous Programming Overview"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ms228963.aspx">http://msdn.microsoft.com/en-us/library/ms228963.aspx</a></code></code></code></code></code></code></code></code></code> <pre> <code class="hljs cmake"><code>CommandBehaviorBase ,    ,    ICommand</code> .           <code>CanExecuteChanged</code> ,          Silverlight,    WPF. <br> <br>    ,  ,   <code><code>CommandBehaviorBase    ,    .         ,      .         ,    .      ButtonBaseClickCommandBehavior</code> . <br> <br> <code class="cs">public class ButtonBaseClickCommandBehavior : CommandBehaviorBase&lt;ButtonBase&gt; { public ButtonBaseClickCommandBehavior(ButtonBase clickableObject) : base(clickableObject) { clickableObject.Click += OnClick; } private void OnClick(object sender, System.Windows.RoutedEventArgs e) { ExecuteCommand(); } }</code> <br>   <code><code>CommandBehaviorBase ,     .     ,          ,   . ,    ,    ,      , ,    CanExecute</code>  ,     . <br> <br>          ,   .           XAML.           .       .  Prism      ,       ,  ,   .       ,    . , ,  ,      <code>Click</code> ,       <code><span class="hljs-keyword"><span class="hljs-keyword">Command</span></span></code> .    <code>Click.<span class="hljs-keyword"><span class="hljs-keyword">Command</span></span></code> ,  . <br> <br>             .             . <br> <br> <code class="cs">public static readonly DependencyProperty CommandProperty = DependencyProperty.RegisterAttached( <span class="hljs-string"><span class="hljs-string">"Command"</span></span>, typeof(ICommand), typeof(Click), new PropertyMetadata(OnSetCommandCallback)); private static readonly DependencyProperty ClickCommandBehaviorProperty = DependencyProperty.RegisterAttached( <span class="hljs-string"><span class="hljs-string">"ClickCommandBehavior"</span></span>, typeof(ButtonBaseClickCommandBehavior), typeof(Click), null);</code> <br>    <code><span class="hljs-keyword"><span class="hljs-keyword">Command</span></span></code>    <code>ButtonBaseClickCommandBehavior</code> ,     <code>OnSetCommandCallback</code> ,     . <br> <br> <code class="cs">private static void OnSetCommandCallback(DependencyObject dependencyObject, DependencyPropertyChangedEventArgs e) { ButtonBase buttonBase = dependencyObject as ButtonBase; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (buttonBase != null) { ButtonBaseClickCommandBehavior behavior = GetOrCreateBehavior(buttonBase); behavior.<span class="hljs-keyword"><span class="hljs-keyword">Command</span></span> = e.NewValue as ICommand; } } private static void OnSetCommandParameterCallback(DependencyObject dependencyObject, DependencyPropertyChangedEventArgs e) { ButtonBase buttonBase = dependencyObject as ButtonBase; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (buttonBase != null) { ButtonBaseClickCommandBehavior behavior = GetOrCreateBehavior(buttonBase); behavior.CommandParameter = e.NewValue; } } private static ButtonBaseClickCommandBehavior GetOrCreateBehavior(ButtonBase buttonBase ) { ButtonBaseClickCommandBehavior behavior = buttonBase.GetValue(ClickCommandBehaviorProperty) as ButtonBaseClickCommandBehavior; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ( behavior == null ) { behavior = new ButtonBaseClickCommandBehavior(buttonBase); buttonBase.SetValue(ClickCommandBehaviorProperty, behavior); } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> behavior; }</code> <br>        ,  <a href="http://msdn.microsoft.com/en-us/library/cc265152(VS.95).aspx">Attached Properties Overview</a>  MSDN. <br> <br>    <br>              . ,     Silverlight,    -,     ,      ,     .     ,       . <br> <br>        ,    ( )  ,  ,     .  UI       ,            UI. <br> <br>      - <br>   -     ,       <code>IAsyncResult</code> .   ,  ,   ,  <code>GetQuestionnaire</code> ,   : <code>BeginGetQuestionnaire</code>  <code>EndGetQuestionnaire</code> .    ,   <code>BeginGetQuestionnaire</code> .     ,   ,   <code>EndGetQuestionnaire</code>    . <br> <b></b> <br>  .NET Framework <span class="hljs-number"><span class="hljs-number">4.5</span></span>      <code>await</code>  <code>async</code>     <code>*Async</code> .      <a href="http://msdn.microsoft.com/en-us/library/vstudio/hh391443.aspx"><span class="hljs-string"><span class="hljs-string">"Asynchronous Programming with Async and Await (C# and Visual Basic)"</span></span></a> . <br>  ,    <code>EndGetQuestionnaire</code> ,      ,  ()      <code>BeginGetQuestionnaire</code> .     ,      ,   <code>EndGetQuestionnaire</code> ,   . <br> <br> <code class="xml">IAsyncResult asyncResult = this.service.BeginGetQuestionnaire( GetQuestionnaireCompleted, null //  ,      ); private void GetQuestionnaireCompleted(IAsyncResult result) { try { questionnaire = this.service.EndGetQuestionnaire(ar); } catch (Exception ex) { //  -   . } }</code> <br>  ,     <code>End*</code> (  , <code>EndGetQuestionnaire</code> ),    ,      .      , ,          UI.     ,   ,        . <br> <br>        UI,     -,      UI,         UI,   <code>Dispatcher</code>    <code>SynchronizationContext</code> .  WPF  Silverlight,   <code>Dispatcher</code> . <br> <br>      <code>Questionnaire</code>  ,        <code>QuestionnaireView</code> .  Silverlight    <code>CheckAccess</code> ,  ,      UI.  ,     <code>BeginInvoke</code> ,      UI. <br> <br> <code class="cs">var dispatcher = System.Windows.Deployment.Current.Dispatcher; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (dispatcher.CheckAccess()) { QuestionnaireView.DataContext = questionnaire; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { dispatcher.BeginInvoke(() =&gt; { Questionnaire.DataContext = questionnaire; }); }</code> <br> <i>MVVM RI</i>   ,    ,   <code>IAsyncResult</code> ,   .      ,                 . ,       . <br> <br> <code class="cs">this.questionnaireRepository.GetQuestionnaireAsync( result =&gt; { this.Questionnaire = result.Result; });</code> <br>  <code>result</code>   ,     , , , .    ,     . <br> <br> <code class="cs">this.questionnaireRepository.GetQuestionnaireAsync( result =&gt; { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (result.Error == null) { this.Questionnaire = result.Result; ... } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { // Handle error. } })</code> <br>     <br>        ,      .     , ,             .        ,      ,     ,     . <br> <br>         ,      MVVM,     ,   . ,  -MVVM ,     <code>MessageBox</code>   code-behind UI,      .   MVVM     ,          . <br> <br>     MVVM,              ,          .      ,    ,   ,  ,     . <br> <br>              MVVM.      ,     ,     ,  ,     .    ,         ,     ,          .       . <br> <br>    <br>                  .        ,        .  ,         .         . <br> <br>  ,         ,         ,  .      ,     .           ,       . ,        WPF  Silverlight,        . <br> <br> <img title="Using the service to interact with the user." src="https://habrastorage.org/getpro/habr/post_images/4b5/397/f2d/4b5397f2d02e5851195b29f1893be6fc.png" alt=" ,    ."> <br> <br>  ,   <code>MessageBox</code>        ,     ,    ,     . <br> <br> <code class="cs">var result = interactionService.ShowMessageBox( <span class="hljs-string"><span class="hljs-string">"Are you sure you want to cancel this operation?"</span></span>, <span class="hljs-string"><span class="hljs-string">"Confirm"</span></span>, MessageBoxButton.OK); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (result == MessageBoxResult.Yes) { CancelRequest(); }</code> <br> ,      - ,      ,         Silverlight.         .             .     . <br> <br> <code class="cs">interactionService.ShowMessageBox( <span class="hljs-string"><span class="hljs-string">"Are you sure you want to cancel this operation?"</span></span>, <span class="hljs-string"><span class="hljs-string">"Confirm"</span></span>, MessageBoxButton.OK, result =&gt; { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (result == MessageBoxResult.Yes) { CancelRequest(); } });</code> <br>         ,      . ,  WPF    <code>MessageBox</code> ,       ;    Silverlight    ,    . <br> <br>     <br>         ‚Äì             .         ,      .     ,     .        ,        ,   ,     . <br> <br> <img title="Using interaction request objects." src="https://habrastorage.org/getpro/habr/post_images/3d0/ff0/1c5/3d0ff01c5518558c2d3c5c5f47ce0ce9.png" alt="   ."> <br> <br>    ,   ,          ‚Äì       ,      ,   ‚Äì     .   ,        ,    ,    UI            . <br> <br>       MVVM,     ,       ,         .         ,        ,    ,   . <br> <br>  Prism       <code>IInteractionRequest</code>   <code><code>InteractionRequest .  IInteractionRequest</code>  ,   .           ,   .  <code><code>InteractionRequest   IInteractionRequest</code>     <code>Raise</code> ,           , , ,   . <br> <br>       <br>  <code><code>InteractionRequest          .  Raise</code>          ( <code>T</code> )    ,    ,   .          ,       .      ,        .    ,  ,     . <br> <code class="cs">public interface IInteractionRequest { event EventHandler&lt;InteractionRequestedEventArgs&gt; Raised; } public class InteractionRequest&lt;T&gt; : IInteractionRequest { public event EventHandler&lt;InteractionRequestedEventArgs&gt; Raised; public void Raise(T context, Action&lt;T&gt; callback) { var handler = this.Raised; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (handler != null) { handler( this, new InteractionRequestedEventArgs(context, () =&gt; callback(context))); } } }</code> <br> Prism    ,      .  <code>Notification</code>       .    ,            .     ‚Äì <code>Title</code>  <code>Content</code> ,    .  ,   ,  ,  ,        . <br> <br>  <code>Confirmation</code>    <code>Notification</code>     ‚Äì <code>Confirmed</code> ,  ,  ,      .  <code>Confirmation</code> ,     <code>MessageBox</code> ,     /  .     ,     <code>Notification</code> ,     ,      . <br> <br>    <code><code><code>InteractionRequest ,       InteractionRequest      ,      .      ,    Raise</code> ,    , ,   . <br> <br> <code class="cs">public IInteractionRequest ConfirmCancelInteractionRequest { get { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> this.confirmCancelInteractionRequest; } } this.confirmCancelInteractionRequest.Raise( new Confirmation(<span class="hljs-string"><span class="hljs-string">"Are you sure you wish to cancel?"</span></span>), confirmation =&gt; { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (confirmation.Confirmed) { this.NavigateToQuestionnaireList(); } }); }</code> <br> <i>MVVM Reference Implementation (MVVM RI)</i> ,    <code>IInteractionRequest</code>   <code><code>InteractionRequest ,          (. QuestionnaireViewModel.cs</code> ). <br> <br>        <br>       ,       .   ,       .    UI             . <br> <br>                . Microsoft Expression Blend Behaviors Framework     .  ,     ,    . <br> <br>  <code>EventTrigger</code> ,  Expression Blend,  ,      ,     ,   . , Prism   <code>EventTrigger</code> ,  <code>InteractionRequestTrigger</code> ,      <code>Raised</code>   <code>IInteractionRequest</code> .    XAML        . <br> <br>  ,   , <code>InteractionRequestTrigger</code>   .  Silverlight Prism   <code>PopupChildWindowAction</code> ,     .    ,         .   <code>ContentTemplate</code>  <code>PopupChildWindowAction</code> ,    ,    UI,      <code>Content</code>  .       <code>Title</code>  . <br> <b></b> <br>  ,    ,   <code>PopupChildWindowAction</code> ,     .    <code>Notification</code>  <code>NotificationChildWindow</code> ,        <code>Confirmation</code> ‚Äì <code>ConfirmationChildWindow</code> . <code>NotificationChildWindow</code>    ,   ,     <code>ConfirmationChildWindow</code>    <i>OK</i>  <i>Cancel</i> ,    .    ,   ,   <code>ChildWindow</code>  <code>PopupChildWindowAction</code> . <br>   ,  <code>InteractionRequestTrigger</code>  <code>PopupChildWindowAction</code> ,       <i>RI MVVM</i> . <br> <br> <code class="xml">&lt;i:Interaction.Triggers&gt; &lt;prism:InteractionRequestTrigger SourceObject=<span class="hljs-string"><span class="hljs-string">"{Binding ConfirmCancelInteractionRequest}"</span></span>&gt; &lt;prism:PopupChildWindowAction ContentTemplate=<span class="hljs-string"><span class="hljs-string">"{StaticResource ConfirmWindowTemplate}"</span></span>/&gt; &lt;/prism:InteractionRequestTrigger&gt; &lt;/i:Interaction.Triggers&gt; &lt;UserControl.Resources&gt; &lt;DataTemplate x:Key=<span class="hljs-string"><span class="hljs-string">"ConfirmWindowTemplate"</span></span>&gt; &lt;Grid MinWidth=<span class="hljs-string"><span class="hljs-string">"250"</span></span> MinHeight=<span class="hljs-string"><span class="hljs-string">"100"</span></span>&gt; &lt;TextBlock TextWrapping=<span class="hljs-string"><span class="hljs-string">"Wrap"</span></span> Grid.Row=<span class="hljs-string"><span class="hljs-string">"0"</span></span> Text=<span class="hljs-string"><span class="hljs-string">"{Binding}"</span></span>/&gt; &lt;/Grid&gt; &lt;/DataTemplate&gt; &lt;/UserControl.Resources&gt;</code> <br> <b></b> <br>      <code>ContentTemplate</code> ,   UI   <code>Content</code>  .    <code>Content</code>  ,  , <code>TextBlock</code>     <code>Content</code> . <br>      ,     ,    ,    .  ,     ,       ,     ,    .   ,   <i>RI MVVM</i> ,         <code>Confirmed</code>    <code>Confirmation</code>  <code><span class="hljs-keyword"><span class="hljs-keyword">true</span></span></code> ,     OK. <br> <br>        ,     .  Prism <code>InteractionRequestTrigger</code>   <code>PopupChildWindowAction</code>            . <br> <br>     <br>     MVVM,       , ,    ,         .        (  , ,  ,   ).    ,  ,  ,            . <br> <br>        ,         . Managed Extensibility Framework (MEF)  Unity Application Block (Unity)      ,  ,           . <br> <br>  ,       , , ,    ( )      . ,       ,     .  ,     ,       . <br> <br>     ,  MEF <br>  MEF,       ,   <code>Import</code> ,      ,  ,   <code><span class="hljs-keyword"><span class="hljs-keyword">Export</span></span></code> .         ,    . <br> <br> , <code>QuestionnaireView</code>   <i>RI MVVM</i> ,        ,    <code>Import</code> .   , MEF           .  <code><span class="hljs-keyword"><span class="hljs-keyword">set</span></span></code>        ,   . <br> <br> <code class="cs">[Import] public QuestionnaireViewModel ViewModel { <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> { this.DataContext = value; } }</code> <br>     ,   . <br> <br> <code class="cs">[<span class="hljs-keyword"><span class="hljs-keyword">Export</span></span>] public class QuestionnaireViewModel : NotificationObject { ... }</code> <br>        ,   . <br> <br> <code class="cs">public QuestionnaireView() { InitializeComponent(); } [ImportingConstructor] public QuestionnaireView(QuestionnaireViewModel viewModel) : this() { this.DataContext = viewModel; }</code> <br> <b></b> <br>          MEF,   Unity.   ,     ,        .   ,   Visual Studio  Expression Blend, ,        ,     .   ,   ,  ,      ,          <code>InitializeComponent</code> . <br>     ,  Unity <br>  Unity,    ,   MEF.     ,      .    ,         .  ,      . <br> <br>  ,      ,  ,         . ,           ,   . <br> <br> <code class="cs">public QuestionnaireView() { InitializeComponent(); } public QuestionnaireView(QuestionnaireViewModel viewModel) : this() { this.DataContext = viewModel; }</code> <br> <b></b> <br>    ,        ,   Visual Studio  Expression Blend. <br>  ,          ,   . Unity        <code><span class="hljs-keyword"><span class="hljs-keyword">set</span></span></code>   ,   . <br> <br> <code class="cs">public QuestionnaireView() { InitializeComponent(); } [Dependency] public QuestionnaireViewModel ViewModel { <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> { this.DataContext = value; } }</code> <br>       Unity. <br> <br> <code class="cs">container.RegisterType&lt;QuestionnaireViewModel&gt;();</code> <br>  ,     . <br> <br> <code class="cs">var view = container.Resolve&lt;QuestionnaireView&gt;();</code> <br>     ,    <br>   ,     ,        .        ,   MEF  Unity,        . <br> <br>          .   ,         UI,           . <br> <br> , <i>RI MVVM</i>   ,   ,        .   ,    .      <code>ShowView</code>   UI. <br> <br> <code class="cs">private void NavigateToQuestionnaireList() { //     <span class="hljs-string"><span class="hljs-string">"questionnaire list"</span></span>. this.uiService.ShowView(ViewNames.QuestionnaireTemplatesList); }</code> <br>  UI      UI .           UI.  <code>ShowView</code>  <code>UIService</code>      (,          ),       ,   . <br> <br> <code class="cs">public void ShowView(<span class="hljs-keyword"><span class="hljs-keyword">string</span></span> viewName) { var view = this.ViewFactory.GetView(viewName); this.MainWindow.CurrentView = view; }</code> <br> <b></b> <br> Prism       .   ,   ,   ,             .    ,  , <span class="hljs-string"><span class="hljs-string">" </span></span><a href="http://msdn.microsoft.com/en-us/library/gg430861(v%3DPandP.40).aspx"><span class="hljs-string"><span class="hljs-string">View-Based Navigation</span></span></a><span class="hljs-string"><span class="hljs-string"> "</span></span>   <span class="hljs-number"><span class="hljs-number">8</span></span>, <span class="hljs-string"><span class="hljs-string">" </span></span><a href="http://msdn.microsoft.com/en-us/library/gg430861(v%3DPandP.40).aspx"><span class="hljs-string"><span class="hljs-string">Navigation</span></span></a><span class="hljs-string"><span class="hljs-string"> "</span></span>. <br>  MVVM  <br>        MVVM      .           -      mocking . ,   ,        . <br> <br>   <i>INotifyPropertyChanged</i> <br>   <code>INotifyPropertyChanged</code>     ,      .      ,    ;   ,   ,     ,    ,       . <br> <br>   <br> ,       ,           <code>PropertyChanged</code>  ,         .  ,    <code>ChangeTracker</code> ,     MVVM,  ,      .      .     ,    . <br> <br> <code class="cs">var changeTracker = new PropertyChangeTracker(viewModel); viewModel.CurrentState = <span class="hljs-string"><span class="hljs-string">"newState"</span></span>; CollectionAssert.Contains(changeTracker.ChangedProperties, <span class="hljs-string"><span class="hljs-string">"CurrentState"</span></span>);</code> <br> ,     ,     <code>INotifyPropertyChanged</code> ,    ,   ,     . <br> <br>      <br>        ,   ,    <code><span class="hljs-keyword"><span class="hljs-keyword">set</span></span></code>      ,           . ,     ,     ,      ,          . <br> <br> <code class="cs">var changeTracker = new PropertyChangeTracker(viewModel); var question = viewModel.Questions.First() as OpenQuestionViewModel; question.Question.Response = <span class="hljs-string"><span class="hljs-string">"some text"</span></span>; CollectionAssert.Contains(changeTracker.ChangedProperties, <span class="hljs-string"><span class="hljs-string">"UnansweredQuestions"</span></span>);</code> <br>      <br>     <code>INotifyPropertyChanged</code> ,      <code>PropertyChanged</code>        ,  ,     , , .        ,       . <br> <br>   <i>INotifyDataErrorInfo</i> <br>   ,     ,    ,   ,   <code>IDataErrorInfo</code> ,  ( Silverlight)   <code>INotifyDataErrorInfo</code> .   <code>INotifyDataErrorInfo</code>   ,         ,    ,  ,   ,    . <br> <br>       <code>INotifyDataErrorInfo</code> : ,     ,  ,     ,     <code>ErrorsChanged</code> ,      <code>GetErrors</code> , . <br> <br>    <br>     ,      ,     .       ,         <code>GetErrors</code>       ,  ,  ,   .    , ,  ,     ,        .   ,        . <br> <br> <code class="cs">//  . var notifyErrorInfo = (INotifyDataErrorInfo)question; question.Response = -<span class="hljs-number"><span class="hljs-number">15</span></span>; Assert.IsTrue(notifyErrorInfo.GetErrors(<span class="hljs-string"><span class="hljs-string">"Response"</span></span>).Cast&lt;ValidationResult&gt;().Any()); //  . var notifyErrorInfo = (INotifyDataErrorInfo)question; question.Response = <span class="hljs-number"><span class="hljs-number">15</span></span>; Assert.IsFalse(notifyErrorInfo.GetErrors(<span class="hljs-string"><span class="hljs-string">"Response"</span></span>).Cast&lt;ValidationResult&gt;().Any());</code> <br>    ,    ,             . <br> <br>    <i>INotifyDataErrorInfo</i> <br>       <code>GetErrors</code> ,   <code>INotifyDataErrorInfo</code>  ,   <code>ErrorsChanged</code>      <code>GetErrors</code> . ,  <code>HasErrors</code>      ,  . <br> <br>       <code>INotifyDataErrorInfo</code> . , ,           ,   -  .      ,        <code>INotifyDataErrorInfo</code>         (,        ). <br> <br>     ,   ,  : <br>  <code>HasErrors</code>     .              ,       .  <code>ErrorsChanged</code> ,      ,         <code>GetErrors</code> .         ( ,  )     ,           .    <code>GetErrors</code>       <code>ErrorsChanged</code> . <br>    <code>INotifyPropertyChanged</code> ,  ,    <code>NotifyDataErrorInfoTestHelper</code>    MVVM,        <code>INotifyDataErrorInfo</code> ,       .   ,   ,      ,   .      . <br> <code class="cs">var helper = new NotifyDataErrorInfoTestHelper&lt;NumericQuestion, int?&gt;( question, q =&gt; q.Response); helper.ValidatePropertyChange( <span class="hljs-number"><span class="hljs-number">6</span></span>, NotifyDataErrorInfoBehavior.Nothing); helper.ValidatePropertyChange( <span class="hljs-number"><span class="hljs-number">20</span></span>, NotifyDataErrorInfoBehavior.FiresErrorsChanged | NotifyDataErrorInfoBehavior.HasErrors | NotifyDataErrorInfoBehavior.HasErrorsForProperty); helper.ValidatePropertyChange( null, NotifyDataErrorInfoBehavior.FiresErrorsChanged | NotifyDataErrorInfoBehavior.HasErrors | NotifyDataErrorInfoBehavior.HasErrorsForProperty); helper.ValidatePropertyChange( <span class="hljs-number"><span class="hljs-number">2</span></span>, NotifyDataErrorInfoBehavior.FiresErrorsChanged);</code> <br>     <br>   MVVM,     ,  .   ,    ,         . <br> <br>  ,     ,     ,       .   ,   , ,       ,     ,   <code>IAsyncResult</code>    ,  - ,   ,    UI. <br> <br>       , , ,    .   ,     .  ,      UI,     ,   ,          ,     ,        <span class="hljs-string"><span class="hljs-string">"   UI."</span></span> <br> <br>     ,    ,    .   ,    ,     mock-, ,   ,   ,      ,          . <br> <br>           UI,    ,    .   ,     ,   ,      .        ,   .     ,    ,     . <br> <br> <code class="cs">questionnaireRepositoryMock .Setup( r =&gt; r.SubmitQuestionnaireAsync( It.IsAny&lt;Questionnaire&gt;(), It.IsAny&lt;Action&lt;IOperationResult&gt;&gt;())) .Callback&lt;Questionnaire, Action&lt;IOperationResult&gt;&gt;( (q, a) =&gt; callback = a); uiServicemock .Setup(svc =&gt; svc.ShowView(ViewNames.QuestionnaireTemplatesList)) .Callback&lt;<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>&gt;(viewName =&gt; requestedViewName = viewName); submitResultMock .Setup(sr =&gt; sr.Error) .Returns&lt;Exception&gt;(null); CompleteQuestionnaire(viewModel); viewModel.Submit(); //      UI . callback(submitResultMock.Object); //    ‚Äì     . Assert.AreEqual(ViewNames.QuestionnaireTemplatesList, requestedViewName);</code> <br> <b></b> <br>          ,        . <br>   <br>       , . <span class="hljs-string"><span class="hljs-string">"Trees in WPF"</span></span>  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ms753391.aspx">http://msdn.microsoft.com/en-us/library/ms753391.aspx</a> <br> <br>       , . <span class="hljs-string"><span class="hljs-string">"Attached Properties Overview"</span></span>  MSDN: <a href="http://msdn.microsoft.com/en-us/library/cc265152(VS.95).aspx">http://msdn.microsoft.com/en-us/library/cc265152(VS.<span class="hljs-number"><span class="hljs-number">95</span></span>).aspx</a> <br> <br>      MEF, .<span class="hljs-string"><span class="hljs-string">"Managed Extensibility Framework Overview"</span></span>  MSDN: <a href="http://msdn.microsoft.com/en-us/library/dd460648.aspx">http://msdn.microsoft.com/en-us/library/dd460648.aspx</a> . <br> <br>      Unity, .<span class="hljs-string"><span class="hljs-string">"Unity Application Block"</span></span>  MSDN: <a href="http://www.msdn.com/unity">http://www.msdn.com/unity</a> . <br> <br>      <code>DelegateCommand</code> , .Chapter <span class="hljs-number"><span class="hljs-number">5</span></span>, <span class="hljs-string"><span class="hljs-string">" </span></span><a href="http://msdn.microsoft.com/en-us/library/gg405484(v%3DPandP.40).aspx"><span class="hljs-string"><span class="hljs-string">Implementing the MVVM Pattern</span></span></a><span class="hljs-string"><span class="hljs-string"> ."</span></span> <br> <br>        Microsoft Expression Blend, .<span class="hljs-string"><span class="hljs-string">"Working with built-in behaviors"</span></span>  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ff724013(v%3DExpression.40).aspx">http://msdn.microsoft.com/en-us/library/ff724013(v=Expression.<span class="hljs-number"><span class="hljs-number">40</span></span>).aspx</a> . <br> <br>          Microsoft Expression Blend, .<span class="hljs-string"><span class="hljs-string">"Creating Custom Behaviors"</span></span>  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ff724708(v%3DExpression.40).aspx">http://msdn.microsoft.com/en-us/library/ff724708(v=Expression.<span class="hljs-number"><span class="hljs-number">40</span></span>).aspx</a> . <br> <br>            Microsoft Expression Blend, .<span class="hljs-string"><span class="hljs-string">"Creating Custom Triggers and Actions"</span></span>  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ff724707(v%3DExpression.40).aspx">http://msdn.microsoft.com/en-us/library/ff724707(v=Expression.<span class="hljs-number"><span class="hljs-number">40</span></span>).aspx</a> . <br> <br>         WPF  Silverlight, .<span class="hljs-string"><span class="hljs-string">"Threading Model"</span></span>  <span class="hljs-string"><span class="hljs-string">"The Dispatcher Class"</span></span>  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ms741870.aspx">http://msdn.microsoft.com/en-us/library/ms741870.aspx</a> <br> <a href="http://msdn.microsoft.com/en-us/library/ms615907(v%3DVS.95).aspx">http://msdn.microsoft.com/en-us/library/ms615907(v=VS.<span class="hljs-number"><span class="hljs-number">95</span></span>).aspx</a> . <br> <br>      unit-  Silverlight, .<span class="hljs-string"><span class="hljs-string">"Unit Testing with Silverlight 2"</span></span>: <a href="http://www.jeff.wilcox.name/2008/03/silverlight2-unit-testing/">http://www.jeff.wilcox.name/<span class="hljs-number"><span class="hljs-number">2008</span></span>/<span class="hljs-number"><span class="hljs-number">03</span></span>/silverlight2-unit-testing/</a> . <br> <br>         , .  <span class="hljs-string"><span class="hljs-string">" </span></span><a href="http://msdn.microsoft.com/en-us/library/gg430861(v%3DPandP.40).aspx"><span class="hljs-string"><span class="hljs-string">View-Based Navigation</span></span></a><span class="hljs-string"><span class="hljs-string"> "</span></span> in Chapter <span class="hljs-number"><span class="hljs-number">8</span></span>, <span class="hljs-string"><span class="hljs-string">" </span></span><a href="http://msdn.microsoft.com/en-us/library/gg430861(v%3DPandP.40).aspx"><span class="hljs-string"><span class="hljs-string">Navigation</span></span></a><span class="hljs-string"><span class="hljs-string"> ."</span></span> <br> <br>       ,   , .<span class="hljs-string"><span class="hljs-string">"Event-based Asynchronous Pattern Overview"</span></span>  MSDN: <a href="http://msdn.microsoft.com/en-us/library/wewwczdw.aspx">http://msdn.microsoft.com/en-us/library/wewwczdw.aspx</a> <br> <br>        <code>IAsyncResult</code> , .<span class="hljs-string"><span class="hljs-string">"Asynchronous Programming Overview"</span></span>  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ms228963.aspx">http://msdn.microsoft.com/en-us/library/ms228963.aspx</a></code></code></code></code></code></code></code></code></code> </pre> <code><code><code><code><code><code><code><code><code><code>CommandBehaviorBase ,    ,    ICommand</code> .           <code>CanExecuteChanged</code> ,          Silverlight,    WPF. <br> <br>    ,  ,   <code>CommandBehaviorBase    ,    .         ,      .         ,    .      ButtonBaseClickCommandBehavior</code> . <br> <br> <code class="cs">public class ButtonBaseClickCommandBehavior : CommandBehaviorBase&lt;ButtonBase&gt; { public ButtonBaseClickCommandBehavior(ButtonBase clickableObject) : base(clickableObject) { clickableObject.Click += OnClick; } private void OnClick(object sender, System.Windows.RoutedEventArgs e) { ExecuteCommand(); } }</code> <br>   <code>CommandBehaviorBase ,     .     ,          ,   . ,    ,    ,      , ,    CanExecute</code>  ,     . <br> <br>          ,   .           XAML.           .       .  Prism      ,       ,  ,   .       ,    . , ,  ,      <code>Click</code> ,       <code>Command</code> .    <code>Click.Command</code> ,  . <br> <br>             .             . <br> <br> <code class="cs">public static readonly DependencyProperty CommandProperty = DependencyProperty.RegisterAttached( "Command", typeof(ICommand), typeof(Click), new PropertyMetadata(OnSetCommandCallback)); private static readonly DependencyProperty ClickCommandBehaviorProperty = DependencyProperty.RegisterAttached( "ClickCommandBehavior", typeof(ButtonBaseClickCommandBehavior), typeof(Click), null);</code> <br>    <code>Command</code>    <code>ButtonBaseClickCommandBehavior</code> ,     <code>OnSetCommandCallback</code> ,     . <br> <br> <code class="cs">private static void OnSetCommandCallback(DependencyObject dependencyObject, DependencyPropertyChangedEventArgs e) { ButtonBase buttonBase = dependencyObject as ButtonBase; if (buttonBase != null) { ButtonBaseClickCommandBehavior behavior = GetOrCreateBehavior(buttonBase); behavior.Command = e.NewValue as ICommand; } } private static void OnSetCommandParameterCallback(DependencyObject dependencyObject, DependencyPropertyChangedEventArgs e) { ButtonBase buttonBase = dependencyObject as ButtonBase; if (buttonBase != null) { ButtonBaseClickCommandBehavior behavior = GetOrCreateBehavior(buttonBase); behavior.CommandParameter = e.NewValue; } } private static ButtonBaseClickCommandBehavior GetOrCreateBehavior(ButtonBase buttonBase ) { ButtonBaseClickCommandBehavior behavior = buttonBase.GetValue(ClickCommandBehaviorProperty) as ButtonBaseClickCommandBehavior; if ( behavior == null ) { behavior = new ButtonBaseClickCommandBehavior(buttonBase); buttonBase.SetValue(ClickCommandBehaviorProperty, behavior); } return behavior; }</code> <br>        ,  <a href="http://msdn.microsoft.com/en-us/library/cc265152(VS.95).aspx">Attached Properties Overview</a>  MSDN. <br> <br>    <br>              . ,     Silverlight,    -,     ,      ,     .     ,       . <br> <br>        ,    ( )  ,  ,     .  UI       ,            UI. <br> <br>      - <br>   -     ,       <code>IAsyncResult</code> .   ,  ,   ,  <code>GetQuestionnaire</code> ,   : <code>BeginGetQuestionnaire</code>  <code>EndGetQuestionnaire</code> .    ,   <code>BeginGetQuestionnaire</code> .     ,   ,   <code>EndGetQuestionnaire</code>    . <br> <b></b> <br>  .NET Framework 4.5      <code>await</code>  <code>async</code>     <code>*Async</code> .      <a href="http://msdn.microsoft.com/en-us/library/vstudio/hh391443.aspx">"Asynchronous Programming with Async and Await (C# and Visual Basic)"</a> . <br>  ,    <code>EndGetQuestionnaire</code> ,      ,  ()      <code>BeginGetQuestionnaire</code> .     ,      ,   <code>EndGetQuestionnaire</code> ,   . <br> <br> <code class="xml">IAsyncResult asyncResult = this.service.BeginGetQuestionnaire( GetQuestionnaireCompleted, null //  ,      ); private void GetQuestionnaireCompleted(IAsyncResult result) { try { questionnaire = this.service.EndGetQuestionnaire(ar); } catch (Exception ex) { //  -   . } }</code> <br>  ,     <code>End*</code> (  , <code>EndGetQuestionnaire</code> ),    ,      .      , ,          UI.     ,   ,        . <br> <br>        UI,     -,      UI,         UI,   <code>Dispatcher</code>    <code>SynchronizationContext</code> .  WPF  Silverlight,   <code>Dispatcher</code> . <br> <br>      <code>Questionnaire</code>  ,        <code>QuestionnaireView</code> .  Silverlight    <code>CheckAccess</code> ,  ,      UI.  ,     <code>BeginInvoke</code> ,      UI. <br> <br> <code class="cs">var dispatcher = System.Windows.Deployment.Current.Dispatcher; if (dispatcher.CheckAccess()) { QuestionnaireView.DataContext = questionnaire; } else { dispatcher.BeginInvoke(() =&gt; { Questionnaire.DataContext = questionnaire; }); }</code> <br> <i>MVVM RI</i>   ,    ,   <code>IAsyncResult</code> ,   .      ,                 . ,       . <br> <br> <code class="cs">this.questionnaireRepository.GetQuestionnaireAsync( result =&gt; { this.Questionnaire = result.Result; });</code> <br>  <code>result</code>   ,     , , , .    ,     . <br> <br> <code class="cs">this.questionnaireRepository.GetQuestionnaireAsync( result =&gt; { if (result.Error == null) { this.Questionnaire = result.Result; ... } else { // Handle error. } })</code> <br>     <br>        ,      .     , ,             .        ,      ,     ,     . <br> <br>         ,      MVVM,     ,   . ,  -MVVM ,     <code>MessageBox</code>   code-behind UI,      .   MVVM     ,          . <br> <br>     MVVM,              ,          .      ,    ,   ,  ,     . <br> <br>              MVVM.      ,     ,     ,  ,     .    ,         ,     ,          .       . <br> <br>    <br>                  .        ,        .  ,         .         . <br> <br>  ,         ,         ,  .      ,     .           ,       . ,        WPF  Silverlight,        . <br> <br> <img title="Using the service to interact with the user." src="https://habrastorage.org/getpro/habr/post_images/4b5/397/f2d/4b5397f2d02e5851195b29f1893be6fc.png" alt=" ,    ."> <br> <br>  ,   <code>MessageBox</code>        ,     ,    ,     . <br> <br> <code class="cs">var result = interactionService.ShowMessageBox( "Are you sure you want to cancel this operation?", "Confirm", MessageBoxButton.OK); if (result == MessageBoxResult.Yes) { CancelRequest(); }</code> <br> ,      - ,      ,         Silverlight.         .             .     . <br> <br> <code class="cs">interactionService.ShowMessageBox( "Are you sure you want to cancel this operation?", "Confirm", MessageBoxButton.OK, result =&gt; { if (result == MessageBoxResult.Yes) { CancelRequest(); } });</code> <br>         ,      . ,  WPF    <code>MessageBox</code> ,       ;    Silverlight    ,    . <br> <br>     <br>         ‚Äì             .         ,      .     ,     .        ,        ,   ,     . <br> <br> <img title="Using interaction request objects." src="https://habrastorage.org/getpro/habr/post_images/3d0/ff0/1c5/3d0ff01c5518558c2d3c5c5f47ce0ce9.png" alt="   ."> <br> <br>    ,   ,          ‚Äì       ,      ,   ‚Äì     .   ,        ,    ,    UI            . <br> <br>       MVVM,     ,       ,         .         ,        ,    ,   . <br> <br>  Prism       <code>IInteractionRequest</code>   <code>InteractionRequest .  IInteractionRequest</code>  ,   .           ,   .  <code>InteractionRequest   IInteractionRequest</code>     <code>Raise</code> ,           , , ,   . <br> <br>       <br>  <code>InteractionRequest          .  Raise</code>          ( <code>T</code> )    ,    ,   .          ,       .      ,        .    ,  ,     . <br> <code class="cs">public interface IInteractionRequest { event EventHandler&lt;InteractionRequestedEventArgs&gt; Raised; } public class InteractionRequest&lt;T&gt; : IInteractionRequest { public event EventHandler&lt;InteractionRequestedEventArgs&gt; Raised; public void Raise(T context, Action&lt;T&gt; callback) { var handler = this.Raised; if (handler != null) { handler( this, new InteractionRequestedEventArgs(context, () =&gt; callback(context))); } } }</code> <br> Prism    ,      .  <code>Notification</code>       .    ,            .     ‚Äì <code>Title</code>  <code>Content</code> ,    .  ,   ,  ,  ,        . <br> <br>  <code>Confirmation</code>    <code>Notification</code>     ‚Äì <code>Confirmed</code> ,  ,  ,      .  <code>Confirmation</code> ,     <code>MessageBox</code> ,     /  .     ,     <code>Notification</code> ,     ,      . <br> <br>    <code>InteractionRequest ,       InteractionRequest      ,      .      ,    Raise</code> ,    , ,   . <br> <br> <code class="cs">public IInteractionRequest ConfirmCancelInteractionRequest { get { return this.confirmCancelInteractionRequest; } } this.confirmCancelInteractionRequest.Raise( new Confirmation("Are you sure you wish to cancel?"), confirmation =&gt; { if (confirmation.Confirmed) { this.NavigateToQuestionnaireList(); } }); }</code> <br> <i>MVVM Reference Implementation (MVVM RI)</i> ,    <code>IInteractionRequest</code>   <code>InteractionRequest ,          (. QuestionnaireViewModel.cs</code> ). <br> <br>        <br>       ,       .   ,       .    UI             . <br> <br>                . Microsoft Expression Blend Behaviors Framework     .  ,     ,    . <br> <br>  <code>EventTrigger</code> ,  Expression Blend,  ,      ,     ,   . , Prism   <code>EventTrigger</code> ,  <code>InteractionRequestTrigger</code> ,      <code>Raised</code>   <code>IInteractionRequest</code> .    XAML        . <br> <br>  ,   , <code>InteractionRequestTrigger</code>   .  Silverlight Prism   <code>PopupChildWindowAction</code> ,     .    ,         .   <code>ContentTemplate</code>  <code>PopupChildWindowAction</code> ,    ,    UI,      <code>Content</code>  .       <code>Title</code>  . <br> <b></b> <br>  ,    ,   <code>PopupChildWindowAction</code> ,     .    <code>Notification</code>  <code>NotificationChildWindow</code> ,        <code>Confirmation</code> ‚Äì <code>ConfirmationChildWindow</code> . <code>NotificationChildWindow</code>    ,   ,     <code>ConfirmationChildWindow</code>    <i>OK</i>  <i>Cancel</i> ,    .    ,   ,   <code>ChildWindow</code>  <code>PopupChildWindowAction</code> . <br>   ,  <code>InteractionRequestTrigger</code>  <code>PopupChildWindowAction</code> ,       <i>RI MVVM</i> . <br> <br> <code class="xml">&lt;i:Interaction.Triggers&gt; &lt;prism:InteractionRequestTrigger SourceObject="{Binding ConfirmCancelInteractionRequest}"&gt; &lt;prism:PopupChildWindowAction ContentTemplate="{StaticResource ConfirmWindowTemplate}"/&gt; &lt;/prism:InteractionRequestTrigger&gt; &lt;/i:Interaction.Triggers&gt; &lt;UserControl.Resources&gt; &lt;DataTemplate x:Key="ConfirmWindowTemplate"&gt; &lt;Grid MinWidth="250" MinHeight="100"&gt; &lt;TextBlock TextWrapping="Wrap" Grid.Row="0" Text="{Binding}"/&gt; &lt;/Grid&gt; &lt;/DataTemplate&gt; &lt;/UserControl.Resources&gt;</code> <br> <b></b> <br>      <code>ContentTemplate</code> ,   UI   <code>Content</code>  .    <code>Content</code>  ,  , <code>TextBlock</code>     <code>Content</code> . <br>      ,     ,    ,    .  ,     ,       ,     ,    .   ,   <i>RI MVVM</i> ,         <code>Confirmed</code>    <code>Confirmation</code>  <code>true</code> ,     OK. <br> <br>        ,     .  Prism <code>InteractionRequestTrigger</code>   <code>PopupChildWindowAction</code>            . <br> <br>     <br>     MVVM,       , ,    ,         .        (  , ,  ,   ).    ,  ,  ,            . <br> <br>        ,         . Managed Extensibility Framework (MEF)  Unity Application Block (Unity)      ,  ,           . <br> <br>  ,       , , ,    ( )      . ,       ,     .  ,     ,       . <br> <br>     ,  MEF <br>  MEF,       ,   <code>Import</code> ,      ,  ,   <code>Export</code> .         ,    . <br> <br> , <code>QuestionnaireView</code>   <i>RI MVVM</i> ,        ,    <code>Import</code> .   , MEF           .  <code>set</code>        ,   . <br> <br> <code class="cs">[Import] public QuestionnaireViewModel ViewModel { set { this.DataContext = value; } }</code> <br>     ,   . <br> <br> <code class="cs">[Export] public class QuestionnaireViewModel : NotificationObject { ... }</code> <br>        ,   . <br> <br> <code class="cs">public QuestionnaireView() { InitializeComponent(); } [ImportingConstructor] public QuestionnaireView(QuestionnaireViewModel viewModel) : this() { this.DataContext = viewModel; }</code> <br> <b></b> <br>          MEF,   Unity.   ,     ,        .   ,   Visual Studio  Expression Blend, ,        ,     .   ,   ,  ,      ,          <code>InitializeComponent</code> . <br>     ,  Unity <br>  Unity,    ,   MEF.     ,      .    ,         .  ,      . <br> <br>  ,      ,  ,         . ,           ,   . <br> <br> <code class="cs">public QuestionnaireView() { InitializeComponent(); } public QuestionnaireView(QuestionnaireViewModel viewModel) : this() { this.DataContext = viewModel; }</code> <br> <b></b> <br>    ,        ,   Visual Studio  Expression Blend. <br>  ,          ,   . Unity        <code>set</code>   ,   . <br> <br> <code class="cs">public QuestionnaireView() { InitializeComponent(); } [Dependency] public QuestionnaireViewModel ViewModel { set { this.DataContext = value; } }</code> <br>       Unity. <br> <br> <code class="cs">container.RegisterType&lt;QuestionnaireViewModel&gt;();</code> <br>  ,     . <br> <br> <code class="cs">var view = container.Resolve&lt;QuestionnaireView&gt;();</code> <br>     ,    <br>   ,     ,        .        ,   MEF  Unity,        . <br> <br>          .   ,         UI,           . <br> <br> , <i>RI MVVM</i>   ,   ,        .   ,    .      <code>ShowView</code>   UI. <br> <br> <code class="cs">private void NavigateToQuestionnaireList() { //     "questionnaire list". this.uiService.ShowView(ViewNames.QuestionnaireTemplatesList); }</code> <br>  UI      UI .           UI.  <code>ShowView</code>  <code>UIService</code>      (,          ),       ,   . <br> <br> <code class="cs">public void ShowView(string viewName) { var view = this.ViewFactory.GetView(viewName); this.MainWindow.CurrentView = view; }</code> <br> <b></b> <br> Prism       .   ,   ,   ,             .    ,  , " <a href="http://msdn.microsoft.com/en-us/library/gg430861(v%3DPandP.40).aspx">View-Based Navigation</a> "   8, " <a href="http://msdn.microsoft.com/en-us/library/gg430861(v%3DPandP.40).aspx">Navigation</a> ". <br>  MVVM  <br>        MVVM      .           -      mocking . ,   ,        . <br> <br>   <i>INotifyPropertyChanged</i> <br>   <code>INotifyPropertyChanged</code>     ,      .      ,    ;   ,   ,     ,    ,       . <br> <br>   <br> ,       ,           <code>PropertyChanged</code>  ,         .  ,    <code>ChangeTracker</code> ,     MVVM,  ,      .      .     ,    . <br> <br> <code class="cs">var changeTracker = new PropertyChangeTracker(viewModel); viewModel.CurrentState = "newState"; CollectionAssert.Contains(changeTracker.ChangedProperties, "CurrentState");</code> <br> ,     ,     <code>INotifyPropertyChanged</code> ,    ,   ,     . <br> <br>      <br>        ,   ,    <code>set</code>      ,           . ,     ,     ,      ,          . <br> <br> <code class="cs">var changeTracker = new PropertyChangeTracker(viewModel); var question = viewModel.Questions.First() as OpenQuestionViewModel; question.Question.Response = "some text"; CollectionAssert.Contains(changeTracker.ChangedProperties, "UnansweredQuestions");</code> <br>      <br>     <code>INotifyPropertyChanged</code> ,      <code>PropertyChanged</code>        ,  ,     , , .        ,       . <br> <br>   <i>INotifyDataErrorInfo</i> <br>   ,     ,    ,   ,   <code>IDataErrorInfo</code> ,  ( Silverlight)   <code>INotifyDataErrorInfo</code> .   <code>INotifyDataErrorInfo</code>   ,         ,    ,  ,   ,    . <br> <br>       <code>INotifyDataErrorInfo</code> : ,     ,  ,     ,     <code>ErrorsChanged</code> ,      <code>GetErrors</code> , . <br> <br>    <br>     ,      ,     .       ,         <code>GetErrors</code>       ,  ,  ,   .    , ,  ,     ,        .   ,        . <br> <br> <code class="cs">//  . var notifyErrorInfo = (INotifyDataErrorInfo)question; question.Response = -15; Assert.IsTrue(notifyErrorInfo.GetErrors("Response").Cast&lt;ValidationResult&gt;().Any()); //  . var notifyErrorInfo = (INotifyDataErrorInfo)question; question.Response = 15; Assert.IsFalse(notifyErrorInfo.GetErrors("Response").Cast&lt;ValidationResult&gt;().Any());</code> <br>    ,    ,             . <br> <br>    <i>INotifyDataErrorInfo</i> <br>       <code>GetErrors</code> ,   <code>INotifyDataErrorInfo</code>  ,   <code>ErrorsChanged</code>      <code>GetErrors</code> . ,  <code>HasErrors</code>      ,  . <br> <br>       <code>INotifyDataErrorInfo</code> . , ,           ,   -  .      ,        <code>INotifyDataErrorInfo</code>         (,        ). <br> <br>     ,   ,  : <br>  <code>HasErrors</code>     .              ,       .  <code>ErrorsChanged</code> ,      ,         <code>GetErrors</code> .         ( ,  )     ,           .    <code>GetErrors</code>       <code>ErrorsChanged</code> . <br>    <code>INotifyPropertyChanged</code> ,  ,    <code>NotifyDataErrorInfoTestHelper</code>    MVVM,        <code>INotifyDataErrorInfo</code> ,       .   ,   ,      ,   .      . <br> <code class="cs">var helper = new NotifyDataErrorInfoTestHelper&lt;NumericQuestion, int?&gt;( question, q =&gt; q.Response); helper.ValidatePropertyChange( 6, NotifyDataErrorInfoBehavior.Nothing); helper.ValidatePropertyChange( 20, NotifyDataErrorInfoBehavior.FiresErrorsChanged | NotifyDataErrorInfoBehavior.HasErrors | NotifyDataErrorInfoBehavior.HasErrorsForProperty); helper.ValidatePropertyChange( null, NotifyDataErrorInfoBehavior.FiresErrorsChanged | NotifyDataErrorInfoBehavior.HasErrors | NotifyDataErrorInfoBehavior.HasErrorsForProperty); helper.ValidatePropertyChange( 2, NotifyDataErrorInfoBehavior.FiresErrorsChanged);</code> <br>     <br>   MVVM,     ,  .   ,    ,         . <br> <br>  ,     ,     ,       .   ,   , ,       ,     ,   <code>IAsyncResult</code>    ,  - ,   ,    UI. <br> <br>       , , ,    .   ,     .  ,      UI,     ,   ,          ,     ,        "   UI." <br> <br>     ,    ,    .   ,    ,     mock-, ,   ,   ,      ,          . <br> <br>           UI,    ,    .   ,     ,   ,      .        ,   .     ,    ,     . <br> <br> <code class="cs">questionnaireRepositoryMock .Setup( r =&gt; r.SubmitQuestionnaireAsync( It.IsAny&lt;Questionnaire&gt;(), It.IsAny&lt;Action&lt;IOperationResult&gt;&gt;())) .Callback&lt;Questionnaire, Action&lt;IOperationResult&gt;&gt;( (q, a) =&gt; callback = a); uiServicemock .Setup(svc =&gt; svc.ShowView(ViewNames.QuestionnaireTemplatesList)) .Callback&lt;string&gt;(viewName =&gt; requestedViewName = viewName); submitResultMock .Setup(sr =&gt; sr.Error) .Returns&lt;Exception&gt;(null); CompleteQuestionnaire(viewModel); viewModel.Submit(); //      UI . callback(submitResultMock.Object); //    ‚Äì     . Assert.AreEqual(ViewNames.QuestionnaireTemplatesList, requestedViewName);</code> <br> <b></b> <br>          ,        . <br>   <br>       , . "Trees in WPF"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ms753391.aspx">http://msdn.microsoft.com/en-us/library/ms753391.aspx</a> <br> <br>       , . "Attached Properties Overview"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/cc265152(VS.95).aspx">http://msdn.microsoft.com/en-us/library/cc265152(VS.95).aspx</a> <br> <br>      MEF, ."Managed Extensibility Framework Overview"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/dd460648.aspx">http://msdn.microsoft.com/en-us/library/dd460648.aspx</a> . <br> <br>      Unity, ."Unity Application Block"  MSDN: <a href="http://www.msdn.com/unity">http://www.msdn.com/unity</a> . <br> <br>      <code>DelegateCommand</code> , .Chapter 5, " <a href="http://msdn.microsoft.com/en-us/library/gg405484(v%3DPandP.40).aspx">Implementing the MVVM Pattern</a> ." <br> <br>        Microsoft Expression Blend, ."Working with built-in behaviors"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ff724013(v%3DExpression.40).aspx">http://msdn.microsoft.com/en-us/library/ff724013(v=Expression.40).aspx</a> . <br> <br>          Microsoft Expression Blend, ."Creating Custom Behaviors"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ff724708(v%3DExpression.40).aspx">http://msdn.microsoft.com/en-us/library/ff724708(v=Expression.40).aspx</a> . <br> <br>            Microsoft Expression Blend, ."Creating Custom Triggers and Actions"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ff724707(v%3DExpression.40).aspx">http://msdn.microsoft.com/en-us/library/ff724707(v=Expression.40).aspx</a> . <br> <br>         WPF  Silverlight, ."Threading Model"  "The Dispatcher Class"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ms741870.aspx">http://msdn.microsoft.com/en-us/library/ms741870.aspx</a> <br> <a href="http://msdn.microsoft.com/en-us/library/ms615907(v%3DVS.95).aspx">http://msdn.microsoft.com/en-us/library/ms615907(v=VS.95).aspx</a> . <br> <br>      unit-  Silverlight, ."Unit Testing with Silverlight 2": <a href="http://www.jeff.wilcox.name/2008/03/silverlight2-unit-testing/">http://www.jeff.wilcox.name/2008/03/silverlight2-unit-testing/</a> . <br> <br>         , .  " <a href="http://msdn.microsoft.com/en-us/library/gg430861(v%3DPandP.40).aspx">View-Based Navigation</a> " in Chapter 8, " <a href="http://msdn.microsoft.com/en-us/library/gg430861(v%3DPandP.40).aspx">Navigation</a> ." <br> <br>       ,   , ."Event-based Asynchronous Pattern Overview"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/wewwczdw.aspx">http://msdn.microsoft.com/en-us/library/wewwczdw.aspx</a> <br> <br>        <code>IAsyncResult</code> , ."Asynchronous Programming Overview"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ms228963.aspx">http://msdn.microsoft.com/en-us/library/ms228963.aspx</a></code></code></code></code></code></code></code></code></code> <h5> <code><code><code><code><code><code><code><code><code><code>CommandBehaviorBase ,    ,    ICommand</code> .           <code>CanExecuteChanged</code> ,          Silverlight,    WPF. <br> <br>    ,  ,   <code>CommandBehaviorBase    ,    .         ,      .         ,    .      ButtonBaseClickCommandBehavior</code> . <br> <br> <code class="cs">public class ButtonBaseClickCommandBehavior : CommandBehaviorBase&lt;ButtonBase&gt; { public ButtonBaseClickCommandBehavior(ButtonBase clickableObject) : base(clickableObject) { clickableObject.Click += OnClick; } private void OnClick(object sender, System.Windows.RoutedEventArgs e) { ExecuteCommand(); } }</code> <br>   <code>CommandBehaviorBase ,     .     ,          ,   . ,    ,    ,      , ,    CanExecute</code>  ,     . <br> <br>          ,   .           XAML.           .       .  Prism      ,       ,  ,   .       ,    . , ,  ,      <code>Click</code> ,       <code>Command</code> .    <code>Click.Command</code> ,  . <br> <br>             .             . <br> <br> <code class="cs">public static readonly DependencyProperty CommandProperty = DependencyProperty.RegisterAttached( "Command", typeof(ICommand), typeof(Click), new PropertyMetadata(OnSetCommandCallback)); private static readonly DependencyProperty ClickCommandBehaviorProperty = DependencyProperty.RegisterAttached( "ClickCommandBehavior", typeof(ButtonBaseClickCommandBehavior), typeof(Click), null);</code> <br>    <code>Command</code>    <code>ButtonBaseClickCommandBehavior</code> ,     <code>OnSetCommandCallback</code> ,     . <br> <br> <code class="cs">private static void OnSetCommandCallback(DependencyObject dependencyObject, DependencyPropertyChangedEventArgs e) { ButtonBase buttonBase = dependencyObject as ButtonBase; if (buttonBase != null) { ButtonBaseClickCommandBehavior behavior = GetOrCreateBehavior(buttonBase); behavior.Command = e.NewValue as ICommand; } } private static void OnSetCommandParameterCallback(DependencyObject dependencyObject, DependencyPropertyChangedEventArgs e) { ButtonBase buttonBase = dependencyObject as ButtonBase; if (buttonBase != null) { ButtonBaseClickCommandBehavior behavior = GetOrCreateBehavior(buttonBase); behavior.CommandParameter = e.NewValue; } } private static ButtonBaseClickCommandBehavior GetOrCreateBehavior(ButtonBase buttonBase ) { ButtonBaseClickCommandBehavior behavior = buttonBase.GetValue(ClickCommandBehaviorProperty) as ButtonBaseClickCommandBehavior; if ( behavior == null ) { behavior = new ButtonBaseClickCommandBehavior(buttonBase); buttonBase.SetValue(ClickCommandBehaviorProperty, behavior); } return behavior; }</code> <br>        ,  <a href="http://msdn.microsoft.com/en-us/library/cc265152(VS.95).aspx">Attached Properties Overview</a>  MSDN. <br> <br>    <br>              . ,     Silverlight,    -,     ,      ,     .     ,       . <br> <br>        ,    ( )  ,  ,     .  UI       ,            UI. <br> <br>      - <br>   -     ,       <code>IAsyncResult</code> .   ,  ,   ,  <code>GetQuestionnaire</code> ,   : <code>BeginGetQuestionnaire</code>  <code>EndGetQuestionnaire</code> .    ,   <code>BeginGetQuestionnaire</code> .     ,   ,   <code>EndGetQuestionnaire</code>    . <br> <b></b> <br>  .NET Framework 4.5      <code>await</code>  <code>async</code>     <code>*Async</code> .      <a href="http://msdn.microsoft.com/en-us/library/vstudio/hh391443.aspx">"Asynchronous Programming with Async and Await (C# and Visual Basic)"</a> . <br>  ,    <code>EndGetQuestionnaire</code> ,      ,  ()      <code>BeginGetQuestionnaire</code> .     ,      ,   <code>EndGetQuestionnaire</code> ,   . <br> <br> <code class="xml">IAsyncResult asyncResult = this.service.BeginGetQuestionnaire( GetQuestionnaireCompleted, null //  ,      ); private void GetQuestionnaireCompleted(IAsyncResult result) { try { questionnaire = this.service.EndGetQuestionnaire(ar); } catch (Exception ex) { //  -   . } }</code> <br>  ,     <code>End*</code> (  , <code>EndGetQuestionnaire</code> ),    ,      .      , ,          UI.     ,   ,        . <br> <br>        UI,     -,      UI,         UI,   <code>Dispatcher</code>    <code>SynchronizationContext</code> .  WPF  Silverlight,   <code>Dispatcher</code> . <br> <br>      <code>Questionnaire</code>  ,        <code>QuestionnaireView</code> .  Silverlight    <code>CheckAccess</code> ,  ,      UI.  ,     <code>BeginInvoke</code> ,      UI. <br> <br> <code class="cs">var dispatcher = System.Windows.Deployment.Current.Dispatcher; if (dispatcher.CheckAccess()) { QuestionnaireView.DataContext = questionnaire; } else { dispatcher.BeginInvoke(() =&gt; { Questionnaire.DataContext = questionnaire; }); }</code> <br> <i>MVVM RI</i>   ,    ,   <code>IAsyncResult</code> ,   .      ,                 . ,       . <br> <br> <code class="cs">this.questionnaireRepository.GetQuestionnaireAsync( result =&gt; { this.Questionnaire = result.Result; });</code> <br>  <code>result</code>   ,     , , , .    ,     . <br> <br> <code class="cs">this.questionnaireRepository.GetQuestionnaireAsync( result =&gt; { if (result.Error == null) { this.Questionnaire = result.Result; ... } else { // Handle error. } })</code> <br>     <br>        ,      .     , ,             .        ,      ,     ,     . <br> <br>         ,      MVVM,     ,   . ,  -MVVM ,     <code>MessageBox</code>   code-behind UI,      .   MVVM     ,          . <br> <br>     MVVM,              ,          .      ,    ,   ,  ,     . <br> <br>              MVVM.      ,     ,     ,  ,     .    ,         ,     ,          .       . <br> <br>    <br>                  .        ,        .  ,         .         . <br> <br>  ,         ,         ,  .      ,     .           ,       . ,        WPF  Silverlight,        . <br> <br> <img title="Using the service to interact with the user." src="https://habrastorage.org/getpro/habr/post_images/4b5/397/f2d/4b5397f2d02e5851195b29f1893be6fc.png" alt=" ,    ."> <br> <br>  ,   <code>MessageBox</code>        ,     ,    ,     . <br> <br> <code class="cs">var result = interactionService.ShowMessageBox( "Are you sure you want to cancel this operation?", "Confirm", MessageBoxButton.OK); if (result == MessageBoxResult.Yes) { CancelRequest(); }</code> <br> ,      - ,      ,         Silverlight.         .             .     . <br> <br> <code class="cs">interactionService.ShowMessageBox( "Are you sure you want to cancel this operation?", "Confirm", MessageBoxButton.OK, result =&gt; { if (result == MessageBoxResult.Yes) { CancelRequest(); } });</code> <br>         ,      . ,  WPF    <code>MessageBox</code> ,       ;    Silverlight    ,    . <br> <br>     <br>         ‚Äì             .         ,      .     ,     .        ,        ,   ,     . <br> <br> <img title="Using interaction request objects." src="https://habrastorage.org/getpro/habr/post_images/3d0/ff0/1c5/3d0ff01c5518558c2d3c5c5f47ce0ce9.png" alt="   ."> <br> <br>    ,   ,          ‚Äì       ,      ,   ‚Äì     .   ,        ,    ,    UI            . <br> <br>       MVVM,     ,       ,         .         ,        ,    ,   . <br> <br>  Prism       <code>IInteractionRequest</code>   <code>InteractionRequest .  IInteractionRequest</code>  ,   .           ,   .  <code>InteractionRequest   IInteractionRequest</code>     <code>Raise</code> ,           , , ,   . <br> <br>       <br>  <code>InteractionRequest          .  Raise</code>          ( <code>T</code> )    ,    ,   .          ,       .      ,        .    ,  ,     . <br> <code class="cs">public interface IInteractionRequest { event EventHandler&lt;InteractionRequestedEventArgs&gt; Raised; } public class InteractionRequest&lt;T&gt; : IInteractionRequest { public event EventHandler&lt;InteractionRequestedEventArgs&gt; Raised; public void Raise(T context, Action&lt;T&gt; callback) { var handler = this.Raised; if (handler != null) { handler( this, new InteractionRequestedEventArgs(context, () =&gt; callback(context))); } } }</code> <br> Prism    ,      .  <code>Notification</code>       .    ,            .     ‚Äì <code>Title</code>  <code>Content</code> ,    .  ,   ,  ,  ,        . <br> <br>  <code>Confirmation</code>    <code>Notification</code>     ‚Äì <code>Confirmed</code> ,  ,  ,      .  <code>Confirmation</code> ,     <code>MessageBox</code> ,     /  .     ,     <code>Notification</code> ,     ,      . <br> <br>    <code>InteractionRequest ,       InteractionRequest      ,      .      ,    Raise</code> ,    , ,   . <br> <br> <code class="cs">public IInteractionRequest ConfirmCancelInteractionRequest { get { return this.confirmCancelInteractionRequest; } } this.confirmCancelInteractionRequest.Raise( new Confirmation("Are you sure you wish to cancel?"), confirmation =&gt; { if (confirmation.Confirmed) { this.NavigateToQuestionnaireList(); } }); }</code> <br> <i>MVVM Reference Implementation (MVVM RI)</i> ,    <code>IInteractionRequest</code>   <code>InteractionRequest ,          (. QuestionnaireViewModel.cs</code> ). <br> <br>        <br>       ,       .   ,       .    UI             . <br> <br>                . Microsoft Expression Blend Behaviors Framework     .  ,     ,    . <br> <br>  <code>EventTrigger</code> ,  Expression Blend,  ,      ,     ,   . , Prism   <code>EventTrigger</code> ,  <code>InteractionRequestTrigger</code> ,      <code>Raised</code>   <code>IInteractionRequest</code> .    XAML        . <br> <br>  ,   , <code>InteractionRequestTrigger</code>   .  Silverlight Prism   <code>PopupChildWindowAction</code> ,     .    ,         .   <code>ContentTemplate</code>  <code>PopupChildWindowAction</code> ,    ,    UI,      <code>Content</code>  .       <code>Title</code>  . <br> <b></b> <br>  ,    ,   <code>PopupChildWindowAction</code> ,     .    <code>Notification</code>  <code>NotificationChildWindow</code> ,        <code>Confirmation</code> ‚Äì <code>ConfirmationChildWindow</code> . <code>NotificationChildWindow</code>    ,   ,     <code>ConfirmationChildWindow</code>    <i>OK</i>  <i>Cancel</i> ,    .    ,   ,   <code>ChildWindow</code>  <code>PopupChildWindowAction</code> . <br>   ,  <code>InteractionRequestTrigger</code>  <code>PopupChildWindowAction</code> ,       <i>RI MVVM</i> . <br> <br> <code class="xml">&lt;i:Interaction.Triggers&gt; &lt;prism:InteractionRequestTrigger SourceObject="{Binding ConfirmCancelInteractionRequest}"&gt; &lt;prism:PopupChildWindowAction ContentTemplate="{StaticResource ConfirmWindowTemplate}"/&gt; &lt;/prism:InteractionRequestTrigger&gt; &lt;/i:Interaction.Triggers&gt; &lt;UserControl.Resources&gt; &lt;DataTemplate x:Key="ConfirmWindowTemplate"&gt; &lt;Grid MinWidth="250" MinHeight="100"&gt; &lt;TextBlock TextWrapping="Wrap" Grid.Row="0" Text="{Binding}"/&gt; &lt;/Grid&gt; &lt;/DataTemplate&gt; &lt;/UserControl.Resources&gt;</code> <br> <b></b> <br>      <code>ContentTemplate</code> ,   UI   <code>Content</code>  .    <code>Content</code>  ,  , <code>TextBlock</code>     <code>Content</code> . <br>      ,     ,    ,    .  ,     ,       ,     ,    .   ,   <i>RI MVVM</i> ,         <code>Confirmed</code>    <code>Confirmation</code>  <code>true</code> ,     OK. <br> <br>        ,     .  Prism <code>InteractionRequestTrigger</code>   <code>PopupChildWindowAction</code>            . <br> <br>     <br>     MVVM,       , ,    ,         .        (  , ,  ,   ).    ,  ,  ,            . <br> <br>        ,         . Managed Extensibility Framework (MEF)  Unity Application Block (Unity)      ,  ,           . <br> <br>  ,       , , ,    ( )      . ,       ,     .  ,     ,       . <br> <br>     ,  MEF <br>  MEF,       ,   <code>Import</code> ,      ,  ,   <code>Export</code> .         ,    . <br> <br> , <code>QuestionnaireView</code>   <i>RI MVVM</i> ,        ,    <code>Import</code> .   , MEF           .  <code>set</code>        ,   . <br> <br> <code class="cs">[Import] public QuestionnaireViewModel ViewModel { set { this.DataContext = value; } }</code> <br>     ,   . <br> <br> <code class="cs">[Export] public class QuestionnaireViewModel : NotificationObject { ... }</code> <br>        ,   . <br> <br> <code class="cs">public QuestionnaireView() { InitializeComponent(); } [ImportingConstructor] public QuestionnaireView(QuestionnaireViewModel viewModel) : this() { this.DataContext = viewModel; }</code> <br> <b></b> <br>          MEF,   Unity.   ,     ,        .   ,   Visual Studio  Expression Blend, ,        ,     .   ,   ,  ,      ,          <code>InitializeComponent</code> . <br>     ,  Unity <br>  Unity,    ,   MEF.     ,      .    ,         .  ,      . <br> <br>  ,      ,  ,         . ,           ,   . <br> <br> <code class="cs">public QuestionnaireView() { InitializeComponent(); } public QuestionnaireView(QuestionnaireViewModel viewModel) : this() { this.DataContext = viewModel; }</code> <br> <b></b> <br>    ,        ,   Visual Studio  Expression Blend. <br>  ,          ,   . Unity        <code>set</code>   ,   . <br> <br> <code class="cs">public QuestionnaireView() { InitializeComponent(); } [Dependency] public QuestionnaireViewModel ViewModel { set { this.DataContext = value; } }</code> <br>       Unity. <br> <br> <code class="cs">container.RegisterType&lt;QuestionnaireViewModel&gt;();</code> <br>  ,     . <br> <br> <code class="cs">var view = container.Resolve&lt;QuestionnaireView&gt;();</code> <br>     ,    <br>   ,     ,        .        ,   MEF  Unity,        . <br> <br>          .   ,         UI,           . <br> <br> , <i>RI MVVM</i>   ,   ,        .   ,    .      <code>ShowView</code>   UI. <br> <br> <code class="cs">private void NavigateToQuestionnaireList() { //     "questionnaire list". this.uiService.ShowView(ViewNames.QuestionnaireTemplatesList); }</code> <br>  UI      UI .           UI.  <code>ShowView</code>  <code>UIService</code>      (,          ),       ,   . <br> <br> <code class="cs">public void ShowView(string viewName) { var view = this.ViewFactory.GetView(viewName); this.MainWindow.CurrentView = view; }</code> <br> <b></b> <br> Prism       .   ,   ,   ,             .    ,  , " <a href="http://msdn.microsoft.com/en-us/library/gg430861(v%3DPandP.40).aspx">View-Based Navigation</a> "   8, " <a href="http://msdn.microsoft.com/en-us/library/gg430861(v%3DPandP.40).aspx">Navigation</a> ". <br>  MVVM  <br>        MVVM      .           -      mocking . ,   ,        . <br> <br>   <i>INotifyPropertyChanged</i> <br>   <code>INotifyPropertyChanged</code>     ,      .      ,    ;   ,   ,     ,    ,       . <br> <br>   <br> ,       ,           <code>PropertyChanged</code>  ,         .  ,    <code>ChangeTracker</code> ,     MVVM,  ,      .      .     ,    . <br> <br> <code class="cs">var changeTracker = new PropertyChangeTracker(viewModel); viewModel.CurrentState = "newState"; CollectionAssert.Contains(changeTracker.ChangedProperties, "CurrentState");</code> <br> ,     ,     <code>INotifyPropertyChanged</code> ,    ,   ,     . <br> <br>      <br>        ,   ,    <code>set</code>      ,           . ,     ,     ,      ,          . <br> <br> <code class="cs">var changeTracker = new PropertyChangeTracker(viewModel); var question = viewModel.Questions.First() as OpenQuestionViewModel; question.Question.Response = "some text"; CollectionAssert.Contains(changeTracker.ChangedProperties, "UnansweredQuestions");</code> <br>      <br>     <code>INotifyPropertyChanged</code> ,      <code>PropertyChanged</code>        ,  ,     , , .        ,       . <br> <br>   <i>INotifyDataErrorInfo</i> <br>   ,     ,    ,   ,   <code>IDataErrorInfo</code> ,  ( Silverlight)   <code>INotifyDataErrorInfo</code> .   <code>INotifyDataErrorInfo</code>   ,         ,    ,  ,   ,    . <br> <br>       <code>INotifyDataErrorInfo</code> : ,     ,  ,     ,     <code>ErrorsChanged</code> ,      <code>GetErrors</code> , . <br> <br>    <br>     ,      ,     .       ,         <code>GetErrors</code>       ,  ,  ,   .    , ,  ,     ,        .   ,        . <br> <br> <code class="cs">//  . var notifyErrorInfo = (INotifyDataErrorInfo)question; question.Response = -15; Assert.IsTrue(notifyErrorInfo.GetErrors("Response").Cast&lt;ValidationResult&gt;().Any()); //  . var notifyErrorInfo = (INotifyDataErrorInfo)question; question.Response = 15; Assert.IsFalse(notifyErrorInfo.GetErrors("Response").Cast&lt;ValidationResult&gt;().Any());</code> <br>    ,    ,             . <br> <br>    <i>INotifyDataErrorInfo</i> <br>       <code>GetErrors</code> ,   <code>INotifyDataErrorInfo</code>  ,   <code>ErrorsChanged</code>      <code>GetErrors</code> . ,  <code>HasErrors</code>      ,  . <br> <br>       <code>INotifyDataErrorInfo</code> . , ,           ,   -  .      ,        <code>INotifyDataErrorInfo</code>         (,        ). <br> <br>     ,   ,  : <br>  <code>HasErrors</code>     .              ,       .  <code>ErrorsChanged</code> ,      ,         <code>GetErrors</code> .         ( ,  )     ,           .    <code>GetErrors</code>       <code>ErrorsChanged</code> . <br>    <code>INotifyPropertyChanged</code> ,  ,    <code>NotifyDataErrorInfoTestHelper</code>    MVVM,        <code>INotifyDataErrorInfo</code> ,       .   ,   ,      ,   .      . <br> <code class="cs">var helper = new NotifyDataErrorInfoTestHelper&lt;NumericQuestion, int?&gt;( question, q =&gt; q.Response); helper.ValidatePropertyChange( 6, NotifyDataErrorInfoBehavior.Nothing); helper.ValidatePropertyChange( 20, NotifyDataErrorInfoBehavior.FiresErrorsChanged | NotifyDataErrorInfoBehavior.HasErrors | NotifyDataErrorInfoBehavior.HasErrorsForProperty); helper.ValidatePropertyChange( null, NotifyDataErrorInfoBehavior.FiresErrorsChanged | NotifyDataErrorInfoBehavior.HasErrors | NotifyDataErrorInfoBehavior.HasErrorsForProperty); helper.ValidatePropertyChange( 2, NotifyDataErrorInfoBehavior.FiresErrorsChanged);</code> <br>     <br>   MVVM,     ,  .   ,    ,         . <br> <br>  ,     ,     ,       .   ,   , ,       ,     ,   <code>IAsyncResult</code>    ,  - ,   ,    UI. <br> <br>       , , ,    .   ,     .  ,      UI,     ,   ,          ,     ,        "   UI." <br> <br>     ,    ,    .   ,    ,     mock-, ,   ,   ,      ,          . <br> <br>           UI,    ,    .   ,     ,   ,      .        ,   .     ,    ,     . <br> <br> <code class="cs">questionnaireRepositoryMock .Setup( r =&gt; r.SubmitQuestionnaireAsync( It.IsAny&lt;Questionnaire&gt;(), It.IsAny&lt;Action&lt;IOperationResult&gt;&gt;())) .Callback&lt;Questionnaire, Action&lt;IOperationResult&gt;&gt;( (q, a) =&gt; callback = a); uiServicemock .Setup(svc =&gt; svc.ShowView(ViewNames.QuestionnaireTemplatesList)) .Callback&lt;string&gt;(viewName =&gt; requestedViewName = viewName); submitResultMock .Setup(sr =&gt; sr.Error) .Returns&lt;Exception&gt;(null); CompleteQuestionnaire(viewModel); viewModel.Submit(); //      UI . callback(submitResultMock.Object); //    ‚Äì     . Assert.AreEqual(ViewNames.QuestionnaireTemplatesList, requestedViewName);</code> <br> <b></b> <br>          ,        . <br>   <br>       , . "Trees in WPF"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ms753391.aspx">http://msdn.microsoft.com/en-us/library/ms753391.aspx</a> <br> <br>       , . "Attached Properties Overview"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/cc265152(VS.95).aspx">http://msdn.microsoft.com/en-us/library/cc265152(VS.95).aspx</a> <br> <br>      MEF, ."Managed Extensibility Framework Overview"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/dd460648.aspx">http://msdn.microsoft.com/en-us/library/dd460648.aspx</a> . <br> <br>      Unity, ."Unity Application Block"  MSDN: <a href="http://www.msdn.com/unity">http://www.msdn.com/unity</a> . <br> <br>      <code>DelegateCommand</code> , .Chapter 5, " <a href="http://msdn.microsoft.com/en-us/library/gg405484(v%3DPandP.40).aspx">Implementing the MVVM Pattern</a> ." <br> <br>        Microsoft Expression Blend, ."Working with built-in behaviors"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ff724013(v%3DExpression.40).aspx">http://msdn.microsoft.com/en-us/library/ff724013(v=Expression.40).aspx</a> . <br> <br>          Microsoft Expression Blend, ."Creating Custom Behaviors"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ff724708(v%3DExpression.40).aspx">http://msdn.microsoft.com/en-us/library/ff724708(v=Expression.40).aspx</a> . <br> <br>            Microsoft Expression Blend, ."Creating Custom Triggers and Actions"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ff724707(v%3DExpression.40).aspx">http://msdn.microsoft.com/en-us/library/ff724707(v=Expression.40).aspx</a> . <br> <br>         WPF  Silverlight, ."Threading Model"  "The Dispatcher Class"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ms741870.aspx">http://msdn.microsoft.com/en-us/library/ms741870.aspx</a> <br> <a href="http://msdn.microsoft.com/en-us/library/ms615907(v%3DVS.95).aspx">http://msdn.microsoft.com/en-us/library/ms615907(v=VS.95).aspx</a> . <br> <br>      unit-  Silverlight, ."Unit Testing with Silverlight 2": <a href="http://www.jeff.wilcox.name/2008/03/silverlight2-unit-testing/">http://www.jeff.wilcox.name/2008/03/silverlight2-unit-testing/</a> . <br> <br>         , .  " <a href="http://msdn.microsoft.com/en-us/library/gg430861(v%3DPandP.40).aspx">View-Based Navigation</a> " in Chapter 8, " <a href="http://msdn.microsoft.com/en-us/library/gg430861(v%3DPandP.40).aspx">Navigation</a> ." <br> <br>       ,   , ."Event-based Asynchronous Pattern Overview"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/wewwczdw.aspx">http://msdn.microsoft.com/en-us/library/wewwczdw.aspx</a> <br> <br>        <code>IAsyncResult</code> , ."Asynchronous Programming Overview"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ms228963.aspx">http://msdn.microsoft.com/en-us/library/ms228963.aspx</a></code></code></code></code></code></code></code></code></code> </h5> <code><code><code><code><code><code><code><code><code><code>CommandBehaviorBase ,    ,    ICommand</code> .           <code>CanExecuteChanged</code> ,          Silverlight,    WPF. <br> <br>    ,  ,   <code>CommandBehaviorBase    ,    .         ,      .         ,    .      ButtonBaseClickCommandBehavior</code> . <br> <br> <code class="cs">public class ButtonBaseClickCommandBehavior : CommandBehaviorBase&lt;ButtonBase&gt; { public ButtonBaseClickCommandBehavior(ButtonBase clickableObject) : base(clickableObject) { clickableObject.Click += OnClick; } private void OnClick(object sender, System.Windows.RoutedEventArgs e) { ExecuteCommand(); } }</code> <br>   <code>CommandBehaviorBase ,     .     ,          ,   . ,    ,    ,      , ,    CanExecute</code>  ,     . <br> <br>          ,   .           XAML.           .       .  Prism      ,       ,  ,   .       ,    . , ,  ,      <code>Click</code> ,       <code>Command</code> .    <code>Click.Command</code> ,  . <br> <br>             .             . <br> <br> <code class="cs">public static readonly DependencyProperty CommandProperty = DependencyProperty.RegisterAttached( "Command", typeof(ICommand), typeof(Click), new PropertyMetadata(OnSetCommandCallback)); private static readonly DependencyProperty ClickCommandBehaviorProperty = DependencyProperty.RegisterAttached( "ClickCommandBehavior", typeof(ButtonBaseClickCommandBehavior), typeof(Click), null);</code> <br>    <code>Command</code>    <code>ButtonBaseClickCommandBehavior</code> ,     <code>OnSetCommandCallback</code> ,     . <br> <br> <code class="cs">private static void OnSetCommandCallback(DependencyObject dependencyObject, DependencyPropertyChangedEventArgs e) { ButtonBase buttonBase = dependencyObject as ButtonBase; if (buttonBase != null) { ButtonBaseClickCommandBehavior behavior = GetOrCreateBehavior(buttonBase); behavior.Command = e.NewValue as ICommand; } } private static void OnSetCommandParameterCallback(DependencyObject dependencyObject, DependencyPropertyChangedEventArgs e) { ButtonBase buttonBase = dependencyObject as ButtonBase; if (buttonBase != null) { ButtonBaseClickCommandBehavior behavior = GetOrCreateBehavior(buttonBase); behavior.CommandParameter = e.NewValue; } } private static ButtonBaseClickCommandBehavior GetOrCreateBehavior(ButtonBase buttonBase ) { ButtonBaseClickCommandBehavior behavior = buttonBase.GetValue(ClickCommandBehaviorProperty) as ButtonBaseClickCommandBehavior; if ( behavior == null ) { behavior = new ButtonBaseClickCommandBehavior(buttonBase); buttonBase.SetValue(ClickCommandBehaviorProperty, behavior); } return behavior; }</code> <br>        ,  <a href="http://msdn.microsoft.com/en-us/library/cc265152(VS.95).aspx">Attached Properties Overview</a>  MSDN. <br> <br>    <br>              . ,     Silverlight,    -,     ,      ,     .     ,       . <br> <br>        ,    ( )  ,  ,     .  UI       ,            UI. <br> <br>      - <br>   -     ,       <code>IAsyncResult</code> .   ,  ,   ,  <code>GetQuestionnaire</code> ,   : <code>BeginGetQuestionnaire</code>  <code>EndGetQuestionnaire</code> .    ,   <code>BeginGetQuestionnaire</code> .     ,   ,   <code>EndGetQuestionnaire</code>    . <br> <b></b> <br>  .NET Framework 4.5      <code>await</code>  <code>async</code>     <code>*Async</code> .      <a href="http://msdn.microsoft.com/en-us/library/vstudio/hh391443.aspx">"Asynchronous Programming with Async and Await (C# and Visual Basic)"</a> . <br>  ,    <code>EndGetQuestionnaire</code> ,      ,  ()      <code>BeginGetQuestionnaire</code> .     ,      ,   <code>EndGetQuestionnaire</code> ,   . <br> <br> <code class="xml">IAsyncResult asyncResult = this.service.BeginGetQuestionnaire( GetQuestionnaireCompleted, null //  ,      ); private void GetQuestionnaireCompleted(IAsyncResult result) { try { questionnaire = this.service.EndGetQuestionnaire(ar); } catch (Exception ex) { //  -   . } }</code> <br>  ,     <code>End*</code> (  , <code>EndGetQuestionnaire</code> ),    ,      .      , ,          UI.     ,   ,        . <br> <br>        UI,     -,      UI,         UI,   <code>Dispatcher</code>    <code>SynchronizationContext</code> .  WPF  Silverlight,   <code>Dispatcher</code> . <br> <br>      <code>Questionnaire</code>  ,        <code>QuestionnaireView</code> .  Silverlight    <code>CheckAccess</code> ,  ,      UI.  ,     <code>BeginInvoke</code> ,      UI. <br> <br> <code class="cs">var dispatcher = System.Windows.Deployment.Current.Dispatcher; if (dispatcher.CheckAccess()) { QuestionnaireView.DataContext = questionnaire; } else { dispatcher.BeginInvoke(() =&gt; { Questionnaire.DataContext = questionnaire; }); }</code> <br> <i>MVVM RI</i>   ,    ,   <code>IAsyncResult</code> ,   .      ,                 . ,       . <br> <br> <code class="cs">this.questionnaireRepository.GetQuestionnaireAsync( result =&gt; { this.Questionnaire = result.Result; });</code> <br>  <code>result</code>   ,     , , , .    ,     . <br> <br> <code class="cs">this.questionnaireRepository.GetQuestionnaireAsync( result =&gt; { if (result.Error == null) { this.Questionnaire = result.Result; ... } else { // Handle error. } })</code> <br>     <br>        ,      .     , ,             .        ,      ,     ,     . <br> <br>         ,      MVVM,     ,   . ,  -MVVM ,     <code>MessageBox</code>   code-behind UI,      .   MVVM     ,          . <br> <br>     MVVM,              ,          .      ,    ,   ,  ,     . <br> <br>              MVVM.      ,     ,     ,  ,     .    ,         ,     ,          .       . <br> <br>    <br>                  .        ,        .  ,         .         . <br> <br>  ,         ,         ,  .      ,     .           ,       . ,        WPF  Silverlight,        . <br> <br> <img title="Using the service to interact with the user." src="https://habrastorage.org/getpro/habr/post_images/4b5/397/f2d/4b5397f2d02e5851195b29f1893be6fc.png" alt=" ,    ."> <br> <br>  ,   <code>MessageBox</code>        ,     ,    ,     . <br> <br> <code class="cs">var result = interactionService.ShowMessageBox( "Are you sure you want to cancel this operation?", "Confirm", MessageBoxButton.OK); if (result == MessageBoxResult.Yes) { CancelRequest(); }</code> <br> ,      - ,      ,         Silverlight.         .             .     . <br> <br> <code class="cs">interactionService.ShowMessageBox( "Are you sure you want to cancel this operation?", "Confirm", MessageBoxButton.OK, result =&gt; { if (result == MessageBoxResult.Yes) { CancelRequest(); } });</code> <br>         ,      . ,  WPF    <code>MessageBox</code> ,       ;    Silverlight    ,    . <br> <br>     <br>         ‚Äì             .         ,      .     ,     .        ,        ,   ,     . <br> <br> <img title="Using interaction request objects." src="https://habrastorage.org/getpro/habr/post_images/3d0/ff0/1c5/3d0ff01c5518558c2d3c5c5f47ce0ce9.png" alt="   ."> <br> <br>    ,   ,          ‚Äì       ,      ,   ‚Äì     .   ,        ,    ,    UI            . <br> <br>       MVVM,     ,       ,         .         ,        ,    ,   . <br> <br>  Prism       <code>IInteractionRequest</code>   <code>InteractionRequest .  IInteractionRequest</code>  ,   .           ,   .  <code>InteractionRequest   IInteractionRequest</code>     <code>Raise</code> ,           , , ,   . <br> <br>       <br>  <code>InteractionRequest          .  Raise</code>          ( <code>T</code> )    ,    ,   .          ,       .      ,        .    ,  ,     . <br> <code class="cs">public interface IInteractionRequest { event EventHandler&lt;InteractionRequestedEventArgs&gt; Raised; } public class InteractionRequest&lt;T&gt; : IInteractionRequest { public event EventHandler&lt;InteractionRequestedEventArgs&gt; Raised; public void Raise(T context, Action&lt;T&gt; callback) { var handler = this.Raised; if (handler != null) { handler( this, new InteractionRequestedEventArgs(context, () =&gt; callback(context))); } } }</code> <br> Prism    ,      .  <code>Notification</code>       .    ,            .     ‚Äì <code>Title</code>  <code>Content</code> ,    .  ,   ,  ,  ,        . <br> <br>  <code>Confirmation</code>    <code>Notification</code>     ‚Äì <code>Confirmed</code> ,  ,  ,      .  <code>Confirmation</code> ,     <code>MessageBox</code> ,     /  .     ,     <code>Notification</code> ,     ,      . <br> <br>    <code>InteractionRequest ,       InteractionRequest      ,      .      ,    Raise</code> ,    , ,   . <br> <br> <code class="cs">public IInteractionRequest ConfirmCancelInteractionRequest { get { return this.confirmCancelInteractionRequest; } } this.confirmCancelInteractionRequest.Raise( new Confirmation("Are you sure you wish to cancel?"), confirmation =&gt; { if (confirmation.Confirmed) { this.NavigateToQuestionnaireList(); } }); }</code> <br> <i>MVVM Reference Implementation (MVVM RI)</i> ,    <code>IInteractionRequest</code>   <code>InteractionRequest ,          (. QuestionnaireViewModel.cs</code> ). <br> <br>        <br>       ,       .   ,       .    UI             . <br> <br>                . Microsoft Expression Blend Behaviors Framework     .  ,     ,    . <br> <br>  <code>EventTrigger</code> ,  Expression Blend,  ,      ,     ,   . , Prism   <code>EventTrigger</code> ,  <code>InteractionRequestTrigger</code> ,      <code>Raised</code>   <code>IInteractionRequest</code> .    XAML        . <br> <br>  ,   , <code>InteractionRequestTrigger</code>   .  Silverlight Prism   <code>PopupChildWindowAction</code> ,     .    ,         .   <code>ContentTemplate</code>  <code>PopupChildWindowAction</code> ,    ,    UI,      <code>Content</code>  .       <code>Title</code>  . <br> <b></b> <br>  ,    ,   <code>PopupChildWindowAction</code> ,     .    <code>Notification</code>  <code>NotificationChildWindow</code> ,        <code>Confirmation</code> ‚Äì <code>ConfirmationChildWindow</code> . <code>NotificationChildWindow</code>    ,   ,     <code>ConfirmationChildWindow</code>    <i>OK</i>  <i>Cancel</i> ,    .    ,   ,   <code>ChildWindow</code>  <code>PopupChildWindowAction</code> . <br>   ,  <code>InteractionRequestTrigger</code>  <code>PopupChildWindowAction</code> ,       <i>RI MVVM</i> . <br> <br> <code class="xml">&lt;i:Interaction.Triggers&gt; &lt;prism:InteractionRequestTrigger SourceObject="{Binding ConfirmCancelInteractionRequest}"&gt; &lt;prism:PopupChildWindowAction ContentTemplate="{StaticResource ConfirmWindowTemplate}"/&gt; &lt;/prism:InteractionRequestTrigger&gt; &lt;/i:Interaction.Triggers&gt; &lt;UserControl.Resources&gt; &lt;DataTemplate x:Key="ConfirmWindowTemplate"&gt; &lt;Grid MinWidth="250" MinHeight="100"&gt; &lt;TextBlock TextWrapping="Wrap" Grid.Row="0" Text="{Binding}"/&gt; &lt;/Grid&gt; &lt;/DataTemplate&gt; &lt;/UserControl.Resources&gt;</code> <br> <b></b> <br>      <code>ContentTemplate</code> ,   UI   <code>Content</code>  .    <code>Content</code>  ,  , <code>TextBlock</code>     <code>Content</code> . <br>      ,     ,    ,    .  ,     ,       ,     ,    .   ,   <i>RI MVVM</i> ,         <code>Confirmed</code>    <code>Confirmation</code>  <code>true</code> ,     OK. <br> <br>        ,     .  Prism <code>InteractionRequestTrigger</code>   <code>PopupChildWindowAction</code>            . <br> <br>     <br>     MVVM,       , ,    ,         .        (  , ,  ,   ).    ,  ,  ,            . <br> <br>        ,         . Managed Extensibility Framework (MEF)  Unity Application Block (Unity)      ,  ,           . <br> <br>  ,       , , ,    ( )      . ,       ,     .  ,     ,       . <br> <br>     ,  MEF <br>  MEF,       ,   <code>Import</code> ,      ,  ,   <code>Export</code> .         ,    . <br> <br> , <code>QuestionnaireView</code>   <i>RI MVVM</i> ,        ,    <code>Import</code> .   , MEF           .  <code>set</code>        ,   . <br> <br> <code class="cs">[Import] public QuestionnaireViewModel ViewModel { set { this.DataContext = value; } }</code> <br>     ,   . <br> <br> <code class="cs">[Export] public class QuestionnaireViewModel : NotificationObject { ... }</code> <br>        ,   . <br> <br> <code class="cs">public QuestionnaireView() { InitializeComponent(); } [ImportingConstructor] public QuestionnaireView(QuestionnaireViewModel viewModel) : this() { this.DataContext = viewModel; }</code> <br> <b></b> <br>          MEF,   Unity.   ,     ,        .   ,   Visual Studio  Expression Blend, ,        ,     .   ,   ,  ,      ,          <code>InitializeComponent</code> . <br>     ,  Unity <br>  Unity,    ,   MEF.     ,      .    ,         .  ,      . <br> <br>  ,      ,  ,         . ,           ,   . <br> <br> <code class="cs">public QuestionnaireView() { InitializeComponent(); } public QuestionnaireView(QuestionnaireViewModel viewModel) : this() { this.DataContext = viewModel; }</code> <br> <b></b> <br>    ,        ,   Visual Studio  Expression Blend. <br>  ,          ,   . Unity        <code>set</code>   ,   . <br> <br> <code class="cs">public QuestionnaireView() { InitializeComponent(); } [Dependency] public QuestionnaireViewModel ViewModel { set { this.DataContext = value; } }</code> <br>       Unity. <br> <br> <code class="cs">container.RegisterType&lt;QuestionnaireViewModel&gt;();</code> <br>  ,     . <br> <br> <code class="cs">var view = container.Resolve&lt;QuestionnaireView&gt;();</code> <br>     ,    <br>   ,     ,        .        ,   MEF  Unity,        . <br> <br>          .   ,         UI,           . <br> <br> , <i>RI MVVM</i>   ,   ,        .   ,    .      <code>ShowView</code>   UI. <br> <br> <code class="cs">private void NavigateToQuestionnaireList() { //     "questionnaire list". this.uiService.ShowView(ViewNames.QuestionnaireTemplatesList); }</code> <br>  UI      UI .           UI.  <code>ShowView</code>  <code>UIService</code>      (,          ),       ,   . <br> <br> <code class="cs">public void ShowView(string viewName) { var view = this.ViewFactory.GetView(viewName); this.MainWindow.CurrentView = view; }</code> <br> <b></b> <br> Prism       .   ,   ,   ,             .    ,  , " <a href="http://msdn.microsoft.com/en-us/library/gg430861(v%3DPandP.40).aspx">View-Based Navigation</a> "   8, " <a href="http://msdn.microsoft.com/en-us/library/gg430861(v%3DPandP.40).aspx">Navigation</a> ". <br>  MVVM  <br>        MVVM      .           -      mocking . ,   ,        . <br> <br>   <i>INotifyPropertyChanged</i> <br>   <code>INotifyPropertyChanged</code>     ,      .      ,    ;   ,   ,     ,    ,       . <br> <br>   <br> ,       ,           <code>PropertyChanged</code>  ,         .  ,    <code>ChangeTracker</code> ,     MVVM,  ,      .      .     ,    . <br> <br> <code class="cs">var changeTracker = new PropertyChangeTracker(viewModel); viewModel.CurrentState = "newState"; CollectionAssert.Contains(changeTracker.ChangedProperties, "CurrentState");</code> <br> ,     ,     <code>INotifyPropertyChanged</code> ,    ,   ,     . <br> <br>      <br>        ,   ,    <code>set</code>      ,           . ,     ,     ,      ,          . <br> <br> <code class="cs">var changeTracker = new PropertyChangeTracker(viewModel); var question = viewModel.Questions.First() as OpenQuestionViewModel; question.Question.Response = "some text"; CollectionAssert.Contains(changeTracker.ChangedProperties, "UnansweredQuestions");</code> <br>      <br>     <code>INotifyPropertyChanged</code> ,      <code>PropertyChanged</code>        ,  ,     , , .        ,       . <br> <br>   <i>INotifyDataErrorInfo</i> <br>   ,     ,    ,   ,   <code>IDataErrorInfo</code> ,  ( Silverlight)   <code>INotifyDataErrorInfo</code> .   <code>INotifyDataErrorInfo</code>   ,         ,    ,  ,   ,    . <br> <br>       <code>INotifyDataErrorInfo</code> : ,     ,  ,     ,     <code>ErrorsChanged</code> ,      <code>GetErrors</code> , . <br> <br>    <br>     ,      ,     .       ,         <code>GetErrors</code>       ,  ,  ,   .    , ,  ,     ,        .   ,        . <br> <br> <code class="cs">//  . var notifyErrorInfo = (INotifyDataErrorInfo)question; question.Response = -15; Assert.IsTrue(notifyErrorInfo.GetErrors("Response").Cast&lt;ValidationResult&gt;().Any()); //  . var notifyErrorInfo = (INotifyDataErrorInfo)question; question.Response = 15; Assert.IsFalse(notifyErrorInfo.GetErrors("Response").Cast&lt;ValidationResult&gt;().Any());</code> <br>    ,    ,             . <br> <br>    <i>INotifyDataErrorInfo</i> <br>       <code>GetErrors</code> ,   <code>INotifyDataErrorInfo</code>  ,   <code>ErrorsChanged</code>      <code>GetErrors</code> . ,  <code>HasErrors</code>      ,  . <br> <br>       <code>INotifyDataErrorInfo</code> . , ,           ,   -  .      ,        <code>INotifyDataErrorInfo</code>         (,        ). <br> <br>     ,   ,  : <br>  <code>HasErrors</code>     .              ,       .  <code>ErrorsChanged</code> ,      ,         <code>GetErrors</code> .         ( ,  )     ,           .    <code>GetErrors</code>       <code>ErrorsChanged</code> . <br>    <code>INotifyPropertyChanged</code> ,  ,    <code>NotifyDataErrorInfoTestHelper</code>    MVVM,        <code>INotifyDataErrorInfo</code> ,       .   ,   ,      ,   .      . <br> <code class="cs">var helper = new NotifyDataErrorInfoTestHelper&lt;NumericQuestion, int?&gt;( question, q =&gt; q.Response); helper.ValidatePropertyChange( 6, NotifyDataErrorInfoBehavior.Nothing); helper.ValidatePropertyChange( 20, NotifyDataErrorInfoBehavior.FiresErrorsChanged | NotifyDataErrorInfoBehavior.HasErrors | NotifyDataErrorInfoBehavior.HasErrorsForProperty); helper.ValidatePropertyChange( null, NotifyDataErrorInfoBehavior.FiresErrorsChanged | NotifyDataErrorInfoBehavior.HasErrors | NotifyDataErrorInfoBehavior.HasErrorsForProperty); helper.ValidatePropertyChange( 2, NotifyDataErrorInfoBehavior.FiresErrorsChanged);</code> <br>     <br>   MVVM,     ,  .   ,    ,         . <br> <br>  ,     ,     ,       .   ,   , ,       ,     ,   <code>IAsyncResult</code>    ,  - ,   ,    UI. <br> <br>       , , ,    .   ,     .  ,      UI,     ,   ,          ,     ,        "   UI." <br> <br>     ,    ,    .   ,    ,     mock-, ,   ,   ,      ,          . <br> <br>           UI,    ,    .   ,     ,   ,      .        ,   .     ,    ,     . <br> <br> <code class="cs">questionnaireRepositoryMock .Setup( r =&gt; r.SubmitQuestionnaireAsync( It.IsAny&lt;Questionnaire&gt;(), It.IsAny&lt;Action&lt;IOperationResult&gt;&gt;())) .Callback&lt;Questionnaire, Action&lt;IOperationResult&gt;&gt;( (q, a) =&gt; callback = a); uiServicemock .Setup(svc =&gt; svc.ShowView(ViewNames.QuestionnaireTemplatesList)) .Callback&lt;string&gt;(viewName =&gt; requestedViewName = viewName); submitResultMock .Setup(sr =&gt; sr.Error) .Returns&lt;Exception&gt;(null); CompleteQuestionnaire(viewModel); viewModel.Submit(); //      UI . callback(submitResultMock.Object); //    ‚Äì     . Assert.AreEqual(ViewNames.QuestionnaireTemplatesList, requestedViewName);</code> <br> <b></b> <br>          ,        . <br>   <br>       , . "Trees in WPF"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ms753391.aspx">http://msdn.microsoft.com/en-us/library/ms753391.aspx</a> <br> <br>       , . "Attached Properties Overview"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/cc265152(VS.95).aspx">http://msdn.microsoft.com/en-us/library/cc265152(VS.95).aspx</a> <br> <br>      MEF, ."Managed Extensibility Framework Overview"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/dd460648.aspx">http://msdn.microsoft.com/en-us/library/dd460648.aspx</a> . <br> <br>      Unity, ."Unity Application Block"  MSDN: <a href="http://www.msdn.com/unity">http://www.msdn.com/unity</a> . <br> <br>      <code>DelegateCommand</code> , .Chapter 5, " <a href="http://msdn.microsoft.com/en-us/library/gg405484(v%3DPandP.40).aspx">Implementing the MVVM Pattern</a> ." <br> <br>        Microsoft Expression Blend, ."Working with built-in behaviors"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ff724013(v%3DExpression.40).aspx">http://msdn.microsoft.com/en-us/library/ff724013(v=Expression.40).aspx</a> . <br> <br>          Microsoft Expression Blend, ."Creating Custom Behaviors"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ff724708(v%3DExpression.40).aspx">http://msdn.microsoft.com/en-us/library/ff724708(v=Expression.40).aspx</a> . <br> <br>            Microsoft Expression Blend, ."Creating Custom Triggers and Actions"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ff724707(v%3DExpression.40).aspx">http://msdn.microsoft.com/en-us/library/ff724707(v=Expression.40).aspx</a> . <br> <br>         WPF  Silverlight, ."Threading Model"  "The Dispatcher Class"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ms741870.aspx">http://msdn.microsoft.com/en-us/library/ms741870.aspx</a> <br> <a href="http://msdn.microsoft.com/en-us/library/ms615907(v%3DVS.95).aspx">http://msdn.microsoft.com/en-us/library/ms615907(v=VS.95).aspx</a> . <br> <br>      unit-  Silverlight, ."Unit Testing with Silverlight 2": <a href="http://www.jeff.wilcox.name/2008/03/silverlight2-unit-testing/">http://www.jeff.wilcox.name/2008/03/silverlight2-unit-testing/</a> . <br> <br>         , .  " <a href="http://msdn.microsoft.com/en-us/library/gg430861(v%3DPandP.40).aspx">View-Based Navigation</a> " in Chapter 8, " <a href="http://msdn.microsoft.com/en-us/library/gg430861(v%3DPandP.40).aspx">Navigation</a> ." <br> <br>       ,   , ."Event-based Asynchronous Pattern Overview"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/wewwczdw.aspx">http://msdn.microsoft.com/en-us/library/wewwczdw.aspx</a> <br> <br>        <code>IAsyncResult</code> , ."Asynchronous Programming Overview"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ms228963.aspx">http://msdn.microsoft.com/en-us/library/ms228963.aspx</a></code></code></code></code></code></code></code></code></code> <h4> <code><code><code><code><code><code><code><code><code><code>CommandBehaviorBase ,    ,    ICommand</code> .           <code>CanExecuteChanged</code> ,          Silverlight,    WPF. <br> <br>    ,  ,   <code>CommandBehaviorBase    ,    .         ,      .         ,    .      ButtonBaseClickCommandBehavior</code> . <br> <br> <code class="cs">public class ButtonBaseClickCommandBehavior : CommandBehaviorBase&lt;ButtonBase&gt; { public ButtonBaseClickCommandBehavior(ButtonBase clickableObject) : base(clickableObject) { clickableObject.Click += OnClick; } private void OnClick(object sender, System.Windows.RoutedEventArgs e) { ExecuteCommand(); } }</code> <br>   <code>CommandBehaviorBase ,     .     ,          ,   . ,    ,    ,      , ,    CanExecute</code>  ,     . <br> <br>          ,   .           XAML.           .       .  Prism      ,       ,  ,   .       ,    . , ,  ,      <code>Click</code> ,       <code>Command</code> .    <code>Click.Command</code> ,  . <br> <br>             .             . <br> <br> <code class="cs">public static readonly DependencyProperty CommandProperty = DependencyProperty.RegisterAttached( "Command", typeof(ICommand), typeof(Click), new PropertyMetadata(OnSetCommandCallback)); private static readonly DependencyProperty ClickCommandBehaviorProperty = DependencyProperty.RegisterAttached( "ClickCommandBehavior", typeof(ButtonBaseClickCommandBehavior), typeof(Click), null);</code> <br>    <code>Command</code>    <code>ButtonBaseClickCommandBehavior</code> ,     <code>OnSetCommandCallback</code> ,     . <br> <br> <code class="cs">private static void OnSetCommandCallback(DependencyObject dependencyObject, DependencyPropertyChangedEventArgs e) { ButtonBase buttonBase = dependencyObject as ButtonBase; if (buttonBase != null) { ButtonBaseClickCommandBehavior behavior = GetOrCreateBehavior(buttonBase); behavior.Command = e.NewValue as ICommand; } } private static void OnSetCommandParameterCallback(DependencyObject dependencyObject, DependencyPropertyChangedEventArgs e) { ButtonBase buttonBase = dependencyObject as ButtonBase; if (buttonBase != null) { ButtonBaseClickCommandBehavior behavior = GetOrCreateBehavior(buttonBase); behavior.CommandParameter = e.NewValue; } } private static ButtonBaseClickCommandBehavior GetOrCreateBehavior(ButtonBase buttonBase ) { ButtonBaseClickCommandBehavior behavior = buttonBase.GetValue(ClickCommandBehaviorProperty) as ButtonBaseClickCommandBehavior; if ( behavior == null ) { behavior = new ButtonBaseClickCommandBehavior(buttonBase); buttonBase.SetValue(ClickCommandBehaviorProperty, behavior); } return behavior; }</code> <br>        ,  <a href="http://msdn.microsoft.com/en-us/library/cc265152(VS.95).aspx">Attached Properties Overview</a>  MSDN. <br> <br>    <br>              . ,     Silverlight,    -,     ,      ,     .     ,       . <br> <br>        ,    ( )  ,  ,     .  UI       ,            UI. <br> <br>      - <br>   -     ,       <code>IAsyncResult</code> .   ,  ,   ,  <code>GetQuestionnaire</code> ,   : <code>BeginGetQuestionnaire</code>  <code>EndGetQuestionnaire</code> .    ,   <code>BeginGetQuestionnaire</code> .     ,   ,   <code>EndGetQuestionnaire</code>    . <br> <b></b> <br>  .NET Framework 4.5      <code>await</code>  <code>async</code>     <code>*Async</code> .      <a href="http://msdn.microsoft.com/en-us/library/vstudio/hh391443.aspx">"Asynchronous Programming with Async and Await (C# and Visual Basic)"</a> . <br>  ,    <code>EndGetQuestionnaire</code> ,      ,  ()      <code>BeginGetQuestionnaire</code> .     ,      ,   <code>EndGetQuestionnaire</code> ,   . <br> <br> <code class="xml">IAsyncResult asyncResult = this.service.BeginGetQuestionnaire( GetQuestionnaireCompleted, null //  ,      ); private void GetQuestionnaireCompleted(IAsyncResult result) { try { questionnaire = this.service.EndGetQuestionnaire(ar); } catch (Exception ex) { //  -   . } }</code> <br>  ,     <code>End*</code> (  , <code>EndGetQuestionnaire</code> ),    ,      .      , ,          UI.     ,   ,        . <br> <br>        UI,     -,      UI,         UI,   <code>Dispatcher</code>    <code>SynchronizationContext</code> .  WPF  Silverlight,   <code>Dispatcher</code> . <br> <br>      <code>Questionnaire</code>  ,        <code>QuestionnaireView</code> .  Silverlight    <code>CheckAccess</code> ,  ,      UI.  ,     <code>BeginInvoke</code> ,      UI. <br> <br> <code class="cs">var dispatcher = System.Windows.Deployment.Current.Dispatcher; if (dispatcher.CheckAccess()) { QuestionnaireView.DataContext = questionnaire; } else { dispatcher.BeginInvoke(() =&gt; { Questionnaire.DataContext = questionnaire; }); }</code> <br> <i>MVVM RI</i>   ,    ,   <code>IAsyncResult</code> ,   .      ,                 . ,       . <br> <br> <code class="cs">this.questionnaireRepository.GetQuestionnaireAsync( result =&gt; { this.Questionnaire = result.Result; });</code> <br>  <code>result</code>   ,     , , , .    ,     . <br> <br> <code class="cs">this.questionnaireRepository.GetQuestionnaireAsync( result =&gt; { if (result.Error == null) { this.Questionnaire = result.Result; ... } else { // Handle error. } })</code> <br>     <br>        ,      .     , ,             .        ,      ,     ,     . <br> <br>         ,      MVVM,     ,   . ,  -MVVM ,     <code>MessageBox</code>   code-behind UI,      .   MVVM     ,          . <br> <br>     MVVM,              ,          .      ,    ,   ,  ,     . <br> <br>              MVVM.      ,     ,     ,  ,     .    ,         ,     ,          .       . <br> <br>    <br>                  .        ,        .  ,         .         . <br> <br>  ,         ,         ,  .      ,     .           ,       . ,        WPF  Silverlight,        . <br> <br> <img title="Using the service to interact with the user." src="https://habrastorage.org/getpro/habr/post_images/4b5/397/f2d/4b5397f2d02e5851195b29f1893be6fc.png" alt=" ,    ."> <br> <br>  ,   <code>MessageBox</code>        ,     ,    ,     . <br> <br> <code class="cs">var result = interactionService.ShowMessageBox( "Are you sure you want to cancel this operation?", "Confirm", MessageBoxButton.OK); if (result == MessageBoxResult.Yes) { CancelRequest(); }</code> <br> ,      - ,      ,         Silverlight.         .             .     . <br> <br> <code class="cs">interactionService.ShowMessageBox( "Are you sure you want to cancel this operation?", "Confirm", MessageBoxButton.OK, result =&gt; { if (result == MessageBoxResult.Yes) { CancelRequest(); } });</code> <br>         ,      . ,  WPF    <code>MessageBox</code> ,       ;    Silverlight    ,    . <br> <br>     <br>         ‚Äì             .         ,      .     ,     .        ,        ,   ,     . <br> <br> <img title="Using interaction request objects." src="https://habrastorage.org/getpro/habr/post_images/3d0/ff0/1c5/3d0ff01c5518558c2d3c5c5f47ce0ce9.png" alt="   ."> <br> <br>    ,   ,          ‚Äì       ,      ,   ‚Äì     .   ,        ,    ,    UI            . <br> <br>       MVVM,     ,       ,         .         ,        ,    ,   . <br> <br>  Prism       <code>IInteractionRequest</code>   <code>InteractionRequest .  IInteractionRequest</code>  ,   .           ,   .  <code>InteractionRequest   IInteractionRequest</code>     <code>Raise</code> ,           , , ,   . <br> <br>       <br>  <code>InteractionRequest          .  Raise</code>          ( <code>T</code> )    ,    ,   .          ,       .      ,        .    ,  ,     . <br> <code class="cs">public interface IInteractionRequest { event EventHandler&lt;InteractionRequestedEventArgs&gt; Raised; } public class InteractionRequest&lt;T&gt; : IInteractionRequest { public event EventHandler&lt;InteractionRequestedEventArgs&gt; Raised; public void Raise(T context, Action&lt;T&gt; callback) { var handler = this.Raised; if (handler != null) { handler( this, new InteractionRequestedEventArgs(context, () =&gt; callback(context))); } } }</code> <br> Prism    ,      .  <code>Notification</code>       .    ,            .     ‚Äì <code>Title</code>  <code>Content</code> ,    .  ,   ,  ,  ,        . <br> <br>  <code>Confirmation</code>    <code>Notification</code>     ‚Äì <code>Confirmed</code> ,  ,  ,      .  <code>Confirmation</code> ,     <code>MessageBox</code> ,     /  .     ,     <code>Notification</code> ,     ,      . <br> <br>    <code>InteractionRequest ,       InteractionRequest      ,      .      ,    Raise</code> ,    , ,   . <br> <br> <code class="cs">public IInteractionRequest ConfirmCancelInteractionRequest { get { return this.confirmCancelInteractionRequest; } } this.confirmCancelInteractionRequest.Raise( new Confirmation("Are you sure you wish to cancel?"), confirmation =&gt; { if (confirmation.Confirmed) { this.NavigateToQuestionnaireList(); } }); }</code> <br> <i>MVVM Reference Implementation (MVVM RI)</i> ,    <code>IInteractionRequest</code>   <code>InteractionRequest ,          (. QuestionnaireViewModel.cs</code> ). <br> <br>        <br>       ,       .   ,       .    UI             . <br> <br>                . Microsoft Expression Blend Behaviors Framework     .  ,     ,    . <br> <br>  <code>EventTrigger</code> ,  Expression Blend,  ,      ,     ,   . , Prism   <code>EventTrigger</code> ,  <code>InteractionRequestTrigger</code> ,      <code>Raised</code>   <code>IInteractionRequest</code> .    XAML        . <br> <br>  ,   , <code>InteractionRequestTrigger</code>   .  Silverlight Prism   <code>PopupChildWindowAction</code> ,     .    ,         .   <code>ContentTemplate</code>  <code>PopupChildWindowAction</code> ,    ,    UI,      <code>Content</code>  .       <code>Title</code>  . <br> <b></b> <br>  ,    ,   <code>PopupChildWindowAction</code> ,     .    <code>Notification</code>  <code>NotificationChildWindow</code> ,        <code>Confirmation</code> ‚Äì <code>ConfirmationChildWindow</code> . <code>NotificationChildWindow</code>    ,   ,     <code>ConfirmationChildWindow</code>    <i>OK</i>  <i>Cancel</i> ,    .    ,   ,   <code>ChildWindow</code>  <code>PopupChildWindowAction</code> . <br>   ,  <code>InteractionRequestTrigger</code>  <code>PopupChildWindowAction</code> ,       <i>RI MVVM</i> . <br> <br> <code class="xml">&lt;i:Interaction.Triggers&gt; &lt;prism:InteractionRequestTrigger SourceObject="{Binding ConfirmCancelInteractionRequest}"&gt; &lt;prism:PopupChildWindowAction ContentTemplate="{StaticResource ConfirmWindowTemplate}"/&gt; &lt;/prism:InteractionRequestTrigger&gt; &lt;/i:Interaction.Triggers&gt; &lt;UserControl.Resources&gt; &lt;DataTemplate x:Key="ConfirmWindowTemplate"&gt; &lt;Grid MinWidth="250" MinHeight="100"&gt; &lt;TextBlock TextWrapping="Wrap" Grid.Row="0" Text="{Binding}"/&gt; &lt;/Grid&gt; &lt;/DataTemplate&gt; &lt;/UserControl.Resources&gt;</code> <br> <b></b> <br>      <code>ContentTemplate</code> ,   UI   <code>Content</code>  .    <code>Content</code>  ,  , <code>TextBlock</code>     <code>Content</code> . <br>      ,     ,    ,    .  ,     ,       ,     ,    .   ,   <i>RI MVVM</i> ,         <code>Confirmed</code>    <code>Confirmation</code>  <code>true</code> ,     OK. <br> <br>        ,     .  Prism <code>InteractionRequestTrigger</code>   <code>PopupChildWindowAction</code>            . <br> <br>     <br>     MVVM,       , ,    ,         .        (  , ,  ,   ).    ,  ,  ,            . <br> <br>        ,         . Managed Extensibility Framework (MEF)  Unity Application Block (Unity)      ,  ,           . <br> <br>  ,       , , ,    ( )      . ,       ,     .  ,     ,       . <br> <br>     ,  MEF <br>  MEF,       ,   <code>Import</code> ,      ,  ,   <code>Export</code> .         ,    . <br> <br> , <code>QuestionnaireView</code>   <i>RI MVVM</i> ,        ,    <code>Import</code> .   , MEF           .  <code>set</code>        ,   . <br> <br> <code class="cs">[Import] public QuestionnaireViewModel ViewModel { set { this.DataContext = value; } }</code> <br>     ,   . <br> <br> <code class="cs">[Export] public class QuestionnaireViewModel : NotificationObject { ... }</code> <br>        ,   . <br> <br> <code class="cs">public QuestionnaireView() { InitializeComponent(); } [ImportingConstructor] public QuestionnaireView(QuestionnaireViewModel viewModel) : this() { this.DataContext = viewModel; }</code> <br> <b></b> <br>          MEF,   Unity.   ,     ,        .   ,   Visual Studio  Expression Blend, ,        ,     .   ,   ,  ,      ,          <code>InitializeComponent</code> . <br>     ,  Unity <br>  Unity,    ,   MEF.     ,      .    ,         .  ,      . <br> <br>  ,      ,  ,         . ,           ,   . <br> <br> <code class="cs">public QuestionnaireView() { InitializeComponent(); } public QuestionnaireView(QuestionnaireViewModel viewModel) : this() { this.DataContext = viewModel; }</code> <br> <b></b> <br>    ,        ,   Visual Studio  Expression Blend. <br>  ,          ,   . Unity        <code>set</code>   ,   . <br> <br> <code class="cs">public QuestionnaireView() { InitializeComponent(); } [Dependency] public QuestionnaireViewModel ViewModel { set { this.DataContext = value; } }</code> <br>       Unity. <br> <br> <code class="cs">container.RegisterType&lt;QuestionnaireViewModel&gt;();</code> <br>  ,     . <br> <br> <code class="cs">var view = container.Resolve&lt;QuestionnaireView&gt;();</code> <br>     ,    <br>   ,     ,        .        ,   MEF  Unity,        . <br> <br>          .   ,         UI,           . <br> <br> , <i>RI MVVM</i>   ,   ,        .   ,    .      <code>ShowView</code>   UI. <br> <br> <code class="cs">private void NavigateToQuestionnaireList() { //     "questionnaire list". this.uiService.ShowView(ViewNames.QuestionnaireTemplatesList); }</code> <br>  UI      UI .           UI.  <code>ShowView</code>  <code>UIService</code>      (,          ),       ,   . <br> <br> <code class="cs">public void ShowView(string viewName) { var view = this.ViewFactory.GetView(viewName); this.MainWindow.CurrentView = view; }</code> <br> <b></b> <br> Prism       .   ,   ,   ,             .    ,  , " <a href="http://msdn.microsoft.com/en-us/library/gg430861(v%3DPandP.40).aspx">View-Based Navigation</a> "   8, " <a href="http://msdn.microsoft.com/en-us/library/gg430861(v%3DPandP.40).aspx">Navigation</a> ". <br>  MVVM  <br>        MVVM      .           -      mocking . ,   ,        . <br> <br>   <i>INotifyPropertyChanged</i> <br>   <code>INotifyPropertyChanged</code>     ,      .      ,    ;   ,   ,     ,    ,       . <br> <br>   <br> ,       ,           <code>PropertyChanged</code>  ,         .  ,    <code>ChangeTracker</code> ,     MVVM,  ,      .      .     ,    . <br> <br> <code class="cs">var changeTracker = new PropertyChangeTracker(viewModel); viewModel.CurrentState = "newState"; CollectionAssert.Contains(changeTracker.ChangedProperties, "CurrentState");</code> <br> ,     ,     <code>INotifyPropertyChanged</code> ,    ,   ,     . <br> <br>      <br>        ,   ,    <code>set</code>      ,           . ,     ,     ,      ,          . <br> <br> <code class="cs">var changeTracker = new PropertyChangeTracker(viewModel); var question = viewModel.Questions.First() as OpenQuestionViewModel; question.Question.Response = "some text"; CollectionAssert.Contains(changeTracker.ChangedProperties, "UnansweredQuestions");</code> <br>      <br>     <code>INotifyPropertyChanged</code> ,      <code>PropertyChanged</code>        ,  ,     , , .        ,       . <br> <br>   <i>INotifyDataErrorInfo</i> <br>   ,     ,    ,   ,   <code>IDataErrorInfo</code> ,  ( Silverlight)   <code>INotifyDataErrorInfo</code> .   <code>INotifyDataErrorInfo</code>   ,         ,    ,  ,   ,    . <br> <br>       <code>INotifyDataErrorInfo</code> : ,     ,  ,     ,     <code>ErrorsChanged</code> ,      <code>GetErrors</code> , . <br> <br>    <br>     ,      ,     .       ,         <code>GetErrors</code>       ,  ,  ,   .    , ,  ,     ,        .   ,        . <br> <br> <code class="cs">//  . var notifyErrorInfo = (INotifyDataErrorInfo)question; question.Response = -15; Assert.IsTrue(notifyErrorInfo.GetErrors("Response").Cast&lt;ValidationResult&gt;().Any()); //  . var notifyErrorInfo = (INotifyDataErrorInfo)question; question.Response = 15; Assert.IsFalse(notifyErrorInfo.GetErrors("Response").Cast&lt;ValidationResult&gt;().Any());</code> <br>    ,    ,             . <br> <br>    <i>INotifyDataErrorInfo</i> <br>       <code>GetErrors</code> ,   <code>INotifyDataErrorInfo</code>  ,   <code>ErrorsChanged</code>      <code>GetErrors</code> . ,  <code>HasErrors</code>      ,  . <br> <br>       <code>INotifyDataErrorInfo</code> . , ,           ,   -  .      ,        <code>INotifyDataErrorInfo</code>         (,        ). <br> <br>     ,   ,  : <br>  <code>HasErrors</code>     .              ,       .  <code>ErrorsChanged</code> ,      ,         <code>GetErrors</code> .         ( ,  )     ,           .    <code>GetErrors</code>       <code>ErrorsChanged</code> . <br>    <code>INotifyPropertyChanged</code> ,  ,    <code>NotifyDataErrorInfoTestHelper</code>    MVVM,        <code>INotifyDataErrorInfo</code> ,       .   ,   ,      ,   .      . <br> <code class="cs">var helper = new NotifyDataErrorInfoTestHelper&lt;NumericQuestion, int?&gt;( question, q =&gt; q.Response); helper.ValidatePropertyChange( 6, NotifyDataErrorInfoBehavior.Nothing); helper.ValidatePropertyChange( 20, NotifyDataErrorInfoBehavior.FiresErrorsChanged | NotifyDataErrorInfoBehavior.HasErrors | NotifyDataErrorInfoBehavior.HasErrorsForProperty); helper.ValidatePropertyChange( null, NotifyDataErrorInfoBehavior.FiresErrorsChanged | NotifyDataErrorInfoBehavior.HasErrors | NotifyDataErrorInfoBehavior.HasErrorsForProperty); helper.ValidatePropertyChange( 2, NotifyDataErrorInfoBehavior.FiresErrorsChanged);</code> <br>     <br>   MVVM,     ,  .   ,    ,         . <br> <br>  ,     ,     ,       .   ,   , ,       ,     ,   <code>IAsyncResult</code>    ,  - ,   ,    UI. <br> <br>       , , ,    .   ,     .  ,      UI,     ,   ,          ,     ,        "   UI." <br> <br>     ,    ,    .   ,    ,     mock-, ,   ,   ,      ,          . <br> <br>           UI,    ,    .   ,     ,   ,      .        ,   .     ,    ,     . <br> <br> <code class="cs">questionnaireRepositoryMock .Setup( r =&gt; r.SubmitQuestionnaireAsync( It.IsAny&lt;Questionnaire&gt;(), It.IsAny&lt;Action&lt;IOperationResult&gt;&gt;())) .Callback&lt;Questionnaire, Action&lt;IOperationResult&gt;&gt;( (q, a) =&gt; callback = a); uiServicemock .Setup(svc =&gt; svc.ShowView(ViewNames.QuestionnaireTemplatesList)) .Callback&lt;string&gt;(viewName =&gt; requestedViewName = viewName); submitResultMock .Setup(sr =&gt; sr.Error) .Returns&lt;Exception&gt;(null); CompleteQuestionnaire(viewModel); viewModel.Submit(); //      UI . callback(submitResultMock.Object); //    ‚Äì     . Assert.AreEqual(ViewNames.QuestionnaireTemplatesList, requestedViewName);</code> <br> <b></b> <br>          ,        . <br>   <br>       , . "Trees in WPF"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ms753391.aspx">http://msdn.microsoft.com/en-us/library/ms753391.aspx</a> <br> <br>       , . "Attached Properties Overview"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/cc265152(VS.95).aspx">http://msdn.microsoft.com/en-us/library/cc265152(VS.95).aspx</a> <br> <br>      MEF, ."Managed Extensibility Framework Overview"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/dd460648.aspx">http://msdn.microsoft.com/en-us/library/dd460648.aspx</a> . <br> <br>      Unity, ."Unity Application Block"  MSDN: <a href="http://www.msdn.com/unity">http://www.msdn.com/unity</a> . <br> <br>      <code>DelegateCommand</code> , .Chapter 5, " <a href="http://msdn.microsoft.com/en-us/library/gg405484(v%3DPandP.40).aspx">Implementing the MVVM Pattern</a> ." <br> <br>        Microsoft Expression Blend, ."Working with built-in behaviors"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ff724013(v%3DExpression.40).aspx">http://msdn.microsoft.com/en-us/library/ff724013(v=Expression.40).aspx</a> . <br> <br>          Microsoft Expression Blend, ."Creating Custom Behaviors"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ff724708(v%3DExpression.40).aspx">http://msdn.microsoft.com/en-us/library/ff724708(v=Expression.40).aspx</a> . <br> <br>            Microsoft Expression Blend, ."Creating Custom Triggers and Actions"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ff724707(v%3DExpression.40).aspx">http://msdn.microsoft.com/en-us/library/ff724707(v=Expression.40).aspx</a> . <br> <br>         WPF  Silverlight, ."Threading Model"  "The Dispatcher Class"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ms741870.aspx">http://msdn.microsoft.com/en-us/library/ms741870.aspx</a> <br> <a href="http://msdn.microsoft.com/en-us/library/ms615907(v%3DVS.95).aspx">http://msdn.microsoft.com/en-us/library/ms615907(v=VS.95).aspx</a> . <br> <br>      unit-  Silverlight, ."Unit Testing with Silverlight 2": <a href="http://www.jeff.wilcox.name/2008/03/silverlight2-unit-testing/">http://www.jeff.wilcox.name/2008/03/silverlight2-unit-testing/</a> . <br> <br>         , .  " <a href="http://msdn.microsoft.com/en-us/library/gg430861(v%3DPandP.40).aspx">View-Based Navigation</a> " in Chapter 8, " <a href="http://msdn.microsoft.com/en-us/library/gg430861(v%3DPandP.40).aspx">Navigation</a> ." <br> <br>       ,   , ."Event-based Asynchronous Pattern Overview"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/wewwczdw.aspx">http://msdn.microsoft.com/en-us/library/wewwczdw.aspx</a> <br> <br>        <code>IAsyncResult</code> , ."Asynchronous Programming Overview"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ms228963.aspx">http://msdn.microsoft.com/en-us/library/ms228963.aspx</a></code></code></code></code></code></code></code></code></code> </h4> <code><code><code><code><code><code><code><code><code><code>CommandBehaviorBase ,    ,    ICommand</code> .           <code>CanExecuteChanged</code> ,          Silverlight,    WPF. <br> <br>    ,  ,   <code>CommandBehaviorBase    ,    .         ,      .         ,    .      ButtonBaseClickCommandBehavior</code> . <br> <br> <code class="cs">public class ButtonBaseClickCommandBehavior : CommandBehaviorBase&lt;ButtonBase&gt; { public ButtonBaseClickCommandBehavior(ButtonBase clickableObject) : base(clickableObject) { clickableObject.Click += OnClick; } private void OnClick(object sender, System.Windows.RoutedEventArgs e) { ExecuteCommand(); } }</code> <br>   <code>CommandBehaviorBase ,     .     ,          ,   . ,    ,    ,      , ,    CanExecute</code>  ,     . <br> <br>          ,   .           XAML.           .       .  Prism      ,       ,  ,   .       ,    . , ,  ,      <code>Click</code> ,       <code>Command</code> .    <code>Click.Command</code> ,  . <br> <br>             .             . <br> <br> <code class="cs">public static readonly DependencyProperty CommandProperty = DependencyProperty.RegisterAttached( "Command", typeof(ICommand), typeof(Click), new PropertyMetadata(OnSetCommandCallback)); private static readonly DependencyProperty ClickCommandBehaviorProperty = DependencyProperty.RegisterAttached( "ClickCommandBehavior", typeof(ButtonBaseClickCommandBehavior), typeof(Click), null);</code> <br>    <code>Command</code>    <code>ButtonBaseClickCommandBehavior</code> ,     <code>OnSetCommandCallback</code> ,     . <br> <br> <code class="cs">private static void OnSetCommandCallback(DependencyObject dependencyObject, DependencyPropertyChangedEventArgs e) { ButtonBase buttonBase = dependencyObject as ButtonBase; if (buttonBase != null) { ButtonBaseClickCommandBehavior behavior = GetOrCreateBehavior(buttonBase); behavior.Command = e.NewValue as ICommand; } } private static void OnSetCommandParameterCallback(DependencyObject dependencyObject, DependencyPropertyChangedEventArgs e) { ButtonBase buttonBase = dependencyObject as ButtonBase; if (buttonBase != null) { ButtonBaseClickCommandBehavior behavior = GetOrCreateBehavior(buttonBase); behavior.CommandParameter = e.NewValue; } } private static ButtonBaseClickCommandBehavior GetOrCreateBehavior(ButtonBase buttonBase ) { ButtonBaseClickCommandBehavior behavior = buttonBase.GetValue(ClickCommandBehaviorProperty) as ButtonBaseClickCommandBehavior; if ( behavior == null ) { behavior = new ButtonBaseClickCommandBehavior(buttonBase); buttonBase.SetValue(ClickCommandBehaviorProperty, behavior); } return behavior; }</code> <br>        ,  <a href="http://msdn.microsoft.com/en-us/library/cc265152(VS.95).aspx">Attached Properties Overview</a>  MSDN. <br> <br>    <br>              . ,     Silverlight,    -,     ,      ,     .     ,       . <br> <br>        ,    ( )  ,  ,     .  UI       ,            UI. <br> <br>      - <br>   -     ,       <code>IAsyncResult</code> .   ,  ,   ,  <code>GetQuestionnaire</code> ,   : <code>BeginGetQuestionnaire</code>  <code>EndGetQuestionnaire</code> .    ,   <code>BeginGetQuestionnaire</code> .     ,   ,   <code>EndGetQuestionnaire</code>    . <br> <b></b> <br>  .NET Framework 4.5      <code>await</code>  <code>async</code>     <code>*Async</code> .      <a href="http://msdn.microsoft.com/en-us/library/vstudio/hh391443.aspx">"Asynchronous Programming with Async and Await (C# and Visual Basic)"</a> . <br>  ,    <code>EndGetQuestionnaire</code> ,      ,  ()      <code>BeginGetQuestionnaire</code> .     ,      ,   <code>EndGetQuestionnaire</code> ,   . <br> <br> <code class="xml">IAsyncResult asyncResult = this.service.BeginGetQuestionnaire( GetQuestionnaireCompleted, null //  ,      ); private void GetQuestionnaireCompleted(IAsyncResult result) { try { questionnaire = this.service.EndGetQuestionnaire(ar); } catch (Exception ex) { //  -   . } }</code> <br>  ,     <code>End*</code> (  , <code>EndGetQuestionnaire</code> ),    ,      .      , ,          UI.     ,   ,        . <br> <br>        UI,     -,      UI,         UI,   <code>Dispatcher</code>    <code>SynchronizationContext</code> .  WPF  Silverlight,   <code>Dispatcher</code> . <br> <br>      <code>Questionnaire</code>  ,        <code>QuestionnaireView</code> .  Silverlight    <code>CheckAccess</code> ,  ,      UI.  ,     <code>BeginInvoke</code> ,      UI. <br> <br> <code class="cs">var dispatcher = System.Windows.Deployment.Current.Dispatcher; if (dispatcher.CheckAccess()) { QuestionnaireView.DataContext = questionnaire; } else { dispatcher.BeginInvoke(() =&gt; { Questionnaire.DataContext = questionnaire; }); }</code> <br> <i>MVVM RI</i>   ,    ,   <code>IAsyncResult</code> ,   .      ,                 . ,       . <br> <br> <code class="cs">this.questionnaireRepository.GetQuestionnaireAsync( result =&gt; { this.Questionnaire = result.Result; });</code> <br>  <code>result</code>   ,     , , , .    ,     . <br> <br> <code class="cs">this.questionnaireRepository.GetQuestionnaireAsync( result =&gt; { if (result.Error == null) { this.Questionnaire = result.Result; ... } else { // Handle error. } })</code> <br>     <br>        ,      .     , ,             .        ,      ,     ,     . <br> <br>         ,      MVVM,     ,   . ,  -MVVM ,     <code>MessageBox</code>   code-behind UI,      .   MVVM     ,          . <br> <br>     MVVM,              ,          .      ,    ,   ,  ,     . <br> <br>              MVVM.      ,     ,     ,  ,     .    ,         ,     ,          .       . <br> <br>    <br>                  .        ,        .  ,         .         . <br> <br>  ,         ,         ,  .      ,     .           ,       . ,        WPF  Silverlight,        . <br> <br> <img title="Using the service to interact with the user." src="https://habrastorage.org/getpro/habr/post_images/4b5/397/f2d/4b5397f2d02e5851195b29f1893be6fc.png" alt=" ,    ."> <br> <br>  ,   <code>MessageBox</code>        ,     ,    ,     . <br> <br> <code class="cs">var result = interactionService.ShowMessageBox( "Are you sure you want to cancel this operation?", "Confirm", MessageBoxButton.OK); if (result == MessageBoxResult.Yes) { CancelRequest(); }</code> <br> ,      - ,      ,         Silverlight.         .             .     . <br> <br> <code class="cs">interactionService.ShowMessageBox( "Are you sure you want to cancel this operation?", "Confirm", MessageBoxButton.OK, result =&gt; { if (result == MessageBoxResult.Yes) { CancelRequest(); } });</code> <br>         ,      . ,  WPF    <code>MessageBox</code> ,       ;    Silverlight    ,    . <br> <br>     <br>         ‚Äì             .         ,      .     ,     .        ,        ,   ,     . <br> <br> <img title="Using interaction request objects." src="https://habrastorage.org/getpro/habr/post_images/3d0/ff0/1c5/3d0ff01c5518558c2d3c5c5f47ce0ce9.png" alt="   ."> <br> <br>    ,   ,          ‚Äì       ,      ,   ‚Äì     .   ,        ,    ,    UI            . <br> <br>       MVVM,     ,       ,         .         ,        ,    ,   . <br> <br>  Prism       <code>IInteractionRequest</code>   <code>InteractionRequest .  IInteractionRequest</code>  ,   .           ,   .  <code>InteractionRequest   IInteractionRequest</code>     <code>Raise</code> ,           , , ,   . <br> <br>       <br>  <code>InteractionRequest          .  Raise</code>          ( <code>T</code> )    ,    ,   .          ,       .      ,        .    ,  ,     . <br> <code class="cs">public interface IInteractionRequest { event EventHandler&lt;InteractionRequestedEventArgs&gt; Raised; } public class InteractionRequest&lt;T&gt; : IInteractionRequest { public event EventHandler&lt;InteractionRequestedEventArgs&gt; Raised; public void Raise(T context, Action&lt;T&gt; callback) { var handler = this.Raised; if (handler != null) { handler( this, new InteractionRequestedEventArgs(context, () =&gt; callback(context))); } } }</code> <br> Prism    ,      .  <code>Notification</code>       .    ,            .     ‚Äì <code>Title</code>  <code>Content</code> ,    .  ,   ,  ,  ,        . <br> <br>  <code>Confirmation</code>    <code>Notification</code>     ‚Äì <code>Confirmed</code> ,  ,  ,      .  <code>Confirmation</code> ,     <code>MessageBox</code> ,     /  .     ,     <code>Notification</code> ,     ,      . <br> <br>    <code>InteractionRequest ,       InteractionRequest      ,      .      ,    Raise</code> ,    , ,   . <br> <br> <code class="cs">public IInteractionRequest ConfirmCancelInteractionRequest { get { return this.confirmCancelInteractionRequest; } } this.confirmCancelInteractionRequest.Raise( new Confirmation("Are you sure you wish to cancel?"), confirmation =&gt; { if (confirmation.Confirmed) { this.NavigateToQuestionnaireList(); } }); }</code> <br> <i>MVVM Reference Implementation (MVVM RI)</i> ,    <code>IInteractionRequest</code>   <code>InteractionRequest ,          (. QuestionnaireViewModel.cs</code> ). <br> <br>        <br>       ,       .   ,       .    UI             . <br> <br>                . Microsoft Expression Blend Behaviors Framework     .  ,     ,    . <br> <br>  <code>EventTrigger</code> ,  Expression Blend,  ,      ,     ,   . , Prism   <code>EventTrigger</code> ,  <code>InteractionRequestTrigger</code> ,      <code>Raised</code>   <code>IInteractionRequest</code> .    XAML        . <br> <br>  ,   , <code>InteractionRequestTrigger</code>   .  Silverlight Prism   <code>PopupChildWindowAction</code> ,     .    ,         .   <code>ContentTemplate</code>  <code>PopupChildWindowAction</code> ,    ,    UI,      <code>Content</code>  .       <code>Title</code>  . <br> <b></b> <br>  ,    ,   <code>PopupChildWindowAction</code> ,     .    <code>Notification</code>  <code>NotificationChildWindow</code> ,        <code>Confirmation</code> ‚Äì <code>ConfirmationChildWindow</code> . <code>NotificationChildWindow</code>    ,   ,     <code>ConfirmationChildWindow</code>    <i>OK</i>  <i>Cancel</i> ,    .    ,   ,   <code>ChildWindow</code>  <code>PopupChildWindowAction</code> . <br>   ,  <code>InteractionRequestTrigger</code>  <code>PopupChildWindowAction</code> ,       <i>RI MVVM</i> . <br> <br> <code class="xml">&lt;i:Interaction.Triggers&gt; &lt;prism:InteractionRequestTrigger SourceObject="{Binding ConfirmCancelInteractionRequest}"&gt; &lt;prism:PopupChildWindowAction ContentTemplate="{StaticResource ConfirmWindowTemplate}"/&gt; &lt;/prism:InteractionRequestTrigger&gt; &lt;/i:Interaction.Triggers&gt; &lt;UserControl.Resources&gt; &lt;DataTemplate x:Key="ConfirmWindowTemplate"&gt; &lt;Grid MinWidth="250" MinHeight="100"&gt; &lt;TextBlock TextWrapping="Wrap" Grid.Row="0" Text="{Binding}"/&gt; &lt;/Grid&gt; &lt;/DataTemplate&gt; &lt;/UserControl.Resources&gt;</code> <br> <b></b> <br>      <code>ContentTemplate</code> ,   UI   <code>Content</code>  .    <code>Content</code>  ,  , <code>TextBlock</code>     <code>Content</code> . <br>      ,     ,    ,    .  ,     ,       ,     ,    .   ,   <i>RI MVVM</i> ,         <code>Confirmed</code>    <code>Confirmation</code>  <code>true</code> ,     OK. <br> <br>        ,     .  Prism <code>InteractionRequestTrigger</code>   <code>PopupChildWindowAction</code>            . <br> <br>     <br>     MVVM,       , ,    ,         .        (  , ,  ,   ).    ,  ,  ,            . <br> <br>        ,         . Managed Extensibility Framework (MEF)  Unity Application Block (Unity)      ,  ,           . <br> <br>  ,       , , ,    ( )      . ,       ,     .  ,     ,       . <br> <br>     ,  MEF <br>  MEF,       ,   <code>Import</code> ,      ,  ,   <code>Export</code> .         ,    . <br> <br> , <code>QuestionnaireView</code>   <i>RI MVVM</i> ,        ,    <code>Import</code> .   , MEF           .  <code>set</code>        ,   . <br> <br> <code class="cs">[Import] public QuestionnaireViewModel ViewModel { set { this.DataContext = value; } }</code> <br>     ,   . <br> <br> <code class="cs">[Export] public class QuestionnaireViewModel : NotificationObject { ... }</code> <br>        ,   . <br> <br> <code class="cs">public QuestionnaireView() { InitializeComponent(); } [ImportingConstructor] public QuestionnaireView(QuestionnaireViewModel viewModel) : this() { this.DataContext = viewModel; }</code> <br> <b></b> <br>          MEF,   Unity.   ,     ,        .   ,   Visual Studio  Expression Blend, ,        ,     .   ,   ,  ,      ,          <code>InitializeComponent</code> . <br>     ,  Unity <br>  Unity,    ,   MEF.     ,      .    ,         .  ,      . <br> <br>  ,      ,  ,         . ,           ,   . <br> <br> <code class="cs">public QuestionnaireView() { InitializeComponent(); } public QuestionnaireView(QuestionnaireViewModel viewModel) : this() { this.DataContext = viewModel; }</code> <br> <b></b> <br>    ,        ,   Visual Studio  Expression Blend. <br>  ,          ,   . Unity        <code>set</code>   ,   . <br> <br> <code class="cs">public QuestionnaireView() { InitializeComponent(); } [Dependency] public QuestionnaireViewModel ViewModel { set { this.DataContext = value; } }</code> <br>       Unity. <br> <br> <code class="cs">container.RegisterType&lt;QuestionnaireViewModel&gt;();</code> <br>  ,     . <br> <br> <code class="cs">var view = container.Resolve&lt;QuestionnaireView&gt;();</code> <br>     ,    <br>   ,     ,        .        ,   MEF  Unity,        . <br> <br>          .   ,         UI,           . <br> <br> , <i>RI MVVM</i>   ,   ,        .   ,    .      <code>ShowView</code>   UI. <br> <br> <code class="cs">private void NavigateToQuestionnaireList() { //     "questionnaire list". this.uiService.ShowView(ViewNames.QuestionnaireTemplatesList); }</code> <br>  UI      UI .           UI.  <code>ShowView</code>  <code>UIService</code>      (,          ),       ,   . <br> <br> <code class="cs">public void ShowView(string viewName) { var view = this.ViewFactory.GetView(viewName); this.MainWindow.CurrentView = view; }</code> <br> <b></b> <br> Prism       .   ,   ,   ,             .    ,  , " <a href="http://msdn.microsoft.com/en-us/library/gg430861(v%3DPandP.40).aspx">View-Based Navigation</a> "   8, " <a href="http://msdn.microsoft.com/en-us/library/gg430861(v%3DPandP.40).aspx">Navigation</a> ". <br>  MVVM  <br>        MVVM      .           -      mocking . ,   ,        . <br> <br>   <i>INotifyPropertyChanged</i> <br>   <code>INotifyPropertyChanged</code>     ,      .      ,    ;   ,   ,     ,    ,       . <br> <br>   <br> ,       ,           <code>PropertyChanged</code>  ,         .  ,    <code>ChangeTracker</code> ,     MVVM,  ,      .      .     ,    . <br> <br> <code class="cs">var changeTracker = new PropertyChangeTracker(viewModel); viewModel.CurrentState = "newState"; CollectionAssert.Contains(changeTracker.ChangedProperties, "CurrentState");</code> <br> ,     ,     <code>INotifyPropertyChanged</code> ,    ,   ,     . <br> <br>      <br>        ,   ,    <code>set</code>      ,           . ,     ,     ,      ,          . <br> <br> <code class="cs">var changeTracker = new PropertyChangeTracker(viewModel); var question = viewModel.Questions.First() as OpenQuestionViewModel; question.Question.Response = "some text"; CollectionAssert.Contains(changeTracker.ChangedProperties, "UnansweredQuestions");</code> <br>      <br>     <code>INotifyPropertyChanged</code> ,      <code>PropertyChanged</code>        ,  ,     , , .        ,       . <br> <br>   <i>INotifyDataErrorInfo</i> <br>   ,     ,    ,   ,   <code>IDataErrorInfo</code> ,  ( Silverlight)   <code>INotifyDataErrorInfo</code> .   <code>INotifyDataErrorInfo</code>   ,         ,    ,  ,   ,    . <br> <br>       <code>INotifyDataErrorInfo</code> : ,     ,  ,     ,     <code>ErrorsChanged</code> ,      <code>GetErrors</code> , . <br> <br>    <br>     ,      ,     .       ,         <code>GetErrors</code>       ,  ,  ,   .    , ,  ,     ,        .   ,        . <br> <br> <code class="cs">//  . var notifyErrorInfo = (INotifyDataErrorInfo)question; question.Response = -15; Assert.IsTrue(notifyErrorInfo.GetErrors("Response").Cast&lt;ValidationResult&gt;().Any()); //  . var notifyErrorInfo = (INotifyDataErrorInfo)question; question.Response = 15; Assert.IsFalse(notifyErrorInfo.GetErrors("Response").Cast&lt;ValidationResult&gt;().Any());</code> <br>    ,    ,             . <br> <br>    <i>INotifyDataErrorInfo</i> <br>       <code>GetErrors</code> ,   <code>INotifyDataErrorInfo</code>  ,   <code>ErrorsChanged</code>      <code>GetErrors</code> . ,  <code>HasErrors</code>      ,  . <br> <br>       <code>INotifyDataErrorInfo</code> . , ,           ,   -  .      ,        <code>INotifyDataErrorInfo</code>         (,        ). <br> <br>     ,   ,  : <br>  <code>HasErrors</code>     .              ,       .  <code>ErrorsChanged</code> ,      ,         <code>GetErrors</code> .         ( ,  )     ,           .    <code>GetErrors</code>       <code>ErrorsChanged</code> . <br>    <code>INotifyPropertyChanged</code> ,  ,    <code>NotifyDataErrorInfoTestHelper</code>    MVVM,        <code>INotifyDataErrorInfo</code> ,       .   ,   ,      ,   .      . <br> <code class="cs">var helper = new NotifyDataErrorInfoTestHelper&lt;NumericQuestion, int?&gt;( question, q =&gt; q.Response); helper.ValidatePropertyChange( 6, NotifyDataErrorInfoBehavior.Nothing); helper.ValidatePropertyChange( 20, NotifyDataErrorInfoBehavior.FiresErrorsChanged | NotifyDataErrorInfoBehavior.HasErrors | NotifyDataErrorInfoBehavior.HasErrorsForProperty); helper.ValidatePropertyChange( null, NotifyDataErrorInfoBehavior.FiresErrorsChanged | NotifyDataErrorInfoBehavior.HasErrors | NotifyDataErrorInfoBehavior.HasErrorsForProperty); helper.ValidatePropertyChange( 2, NotifyDataErrorInfoBehavior.FiresErrorsChanged);</code> <br>     <br>   MVVM,     ,  .   ,    ,         . <br> <br>  ,     ,     ,       .   ,   , ,       ,     ,   <code>IAsyncResult</code>    ,  - ,   ,    UI. <br> <br>       , , ,    .   ,     .  ,      UI,     ,   ,          ,     ,        "   UI." <br> <br>     ,    ,    .   ,    ,     mock-, ,   ,   ,      ,          . <br> <br>           UI,    ,    .   ,     ,   ,      .        ,   .     ,    ,     . <br> <br> <code class="cs">questionnaireRepositoryMock .Setup( r =&gt; r.SubmitQuestionnaireAsync( It.IsAny&lt;Questionnaire&gt;(), It.IsAny&lt;Action&lt;IOperationResult&gt;&gt;())) .Callback&lt;Questionnaire, Action&lt;IOperationResult&gt;&gt;( (q, a) =&gt; callback = a); uiServicemock .Setup(svc =&gt; svc.ShowView(ViewNames.QuestionnaireTemplatesList)) .Callback&lt;string&gt;(viewName =&gt; requestedViewName = viewName); submitResultMock .Setup(sr =&gt; sr.Error) .Returns&lt;Exception&gt;(null); CompleteQuestionnaire(viewModel); viewModel.Submit(); //      UI . callback(submitResultMock.Object); //    ‚Äì     . Assert.AreEqual(ViewNames.QuestionnaireTemplatesList, requestedViewName);</code> <br> <b></b> <br>          ,        . <br>   <br>       , . "Trees in WPF"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ms753391.aspx">http://msdn.microsoft.com/en-us/library/ms753391.aspx</a> <br> <br>       , . "Attached Properties Overview"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/cc265152(VS.95).aspx">http://msdn.microsoft.com/en-us/library/cc265152(VS.95).aspx</a> <br> <br>      MEF, ."Managed Extensibility Framework Overview"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/dd460648.aspx">http://msdn.microsoft.com/en-us/library/dd460648.aspx</a> . <br> <br>      Unity, ."Unity Application Block"  MSDN: <a href="http://www.msdn.com/unity">http://www.msdn.com/unity</a> . <br> <br>      <code>DelegateCommand</code> , .Chapter 5, " <a href="http://msdn.microsoft.com/en-us/library/gg405484(v%3DPandP.40).aspx">Implementing the MVVM Pattern</a> ." <br> <br>        Microsoft Expression Blend, ."Working with built-in behaviors"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ff724013(v%3DExpression.40).aspx">http://msdn.microsoft.com/en-us/library/ff724013(v=Expression.40).aspx</a> . <br> <br>          Microsoft Expression Blend, ."Creating Custom Behaviors"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ff724708(v%3DExpression.40).aspx">http://msdn.microsoft.com/en-us/library/ff724708(v=Expression.40).aspx</a> . <br> <br>            Microsoft Expression Blend, ."Creating Custom Triggers and Actions"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ff724707(v%3DExpression.40).aspx">http://msdn.microsoft.com/en-us/library/ff724707(v=Expression.40).aspx</a> . <br> <br>         WPF  Silverlight, ."Threading Model"  "The Dispatcher Class"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ms741870.aspx">http://msdn.microsoft.com/en-us/library/ms741870.aspx</a> <br> <a href="http://msdn.microsoft.com/en-us/library/ms615907(v%3DVS.95).aspx">http://msdn.microsoft.com/en-us/library/ms615907(v=VS.95).aspx</a> . <br> <br>      unit-  Silverlight, ."Unit Testing with Silverlight 2": <a href="http://www.jeff.wilcox.name/2008/03/silverlight2-unit-testing/">http://www.jeff.wilcox.name/2008/03/silverlight2-unit-testing/</a> . <br> <br>         , .  " <a href="http://msdn.microsoft.com/en-us/library/gg430861(v%3DPandP.40).aspx">View-Based Navigation</a> " in Chapter 8, " <a href="http://msdn.microsoft.com/en-us/library/gg430861(v%3DPandP.40).aspx">Navigation</a> ." <br> <br>       ,   , ."Event-based Asynchronous Pattern Overview"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/wewwczdw.aspx">http://msdn.microsoft.com/en-us/library/wewwczdw.aspx</a> <br> <br>        <code>IAsyncResult</code> , ."Asynchronous Programming Overview"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ms228963.aspx">http://msdn.microsoft.com/en-us/library/ms228963.aspx</a></code></code></code></code></code></code></code></code></code> <h4> <code><code><code><code><code><code><code><code><code><code>CommandBehaviorBase ,    ,    ICommand</code> .           <code>CanExecuteChanged</code> ,          Silverlight,    WPF. <br> <br>    ,  ,   <code>CommandBehaviorBase    ,    .         ,      .         ,    .      ButtonBaseClickCommandBehavior</code> . <br> <br> <code class="cs">public class ButtonBaseClickCommandBehavior : CommandBehaviorBase&lt;ButtonBase&gt; { public ButtonBaseClickCommandBehavior(ButtonBase clickableObject) : base(clickableObject) { clickableObject.Click += OnClick; } private void OnClick(object sender, System.Windows.RoutedEventArgs e) { ExecuteCommand(); } }</code> <br>   <code>CommandBehaviorBase ,     .     ,          ,   . ,    ,    ,      , ,    CanExecute</code>  ,     . <br> <br>          ,   .           XAML.           .       .  Prism      ,       ,  ,   .       ,    . , ,  ,      <code>Click</code> ,       <code>Command</code> .    <code>Click.Command</code> ,  . <br> <br>             .             . <br> <br> <code class="cs">public static readonly DependencyProperty CommandProperty = DependencyProperty.RegisterAttached( "Command", typeof(ICommand), typeof(Click), new PropertyMetadata(OnSetCommandCallback)); private static readonly DependencyProperty ClickCommandBehaviorProperty = DependencyProperty.RegisterAttached( "ClickCommandBehavior", typeof(ButtonBaseClickCommandBehavior), typeof(Click), null);</code> <br>    <code>Command</code>    <code>ButtonBaseClickCommandBehavior</code> ,     <code>OnSetCommandCallback</code> ,     . <br> <br> <code class="cs">private static void OnSetCommandCallback(DependencyObject dependencyObject, DependencyPropertyChangedEventArgs e) { ButtonBase buttonBase = dependencyObject as ButtonBase; if (buttonBase != null) { ButtonBaseClickCommandBehavior behavior = GetOrCreateBehavior(buttonBase); behavior.Command = e.NewValue as ICommand; } } private static void OnSetCommandParameterCallback(DependencyObject dependencyObject, DependencyPropertyChangedEventArgs e) { ButtonBase buttonBase = dependencyObject as ButtonBase; if (buttonBase != null) { ButtonBaseClickCommandBehavior behavior = GetOrCreateBehavior(buttonBase); behavior.CommandParameter = e.NewValue; } } private static ButtonBaseClickCommandBehavior GetOrCreateBehavior(ButtonBase buttonBase ) { ButtonBaseClickCommandBehavior behavior = buttonBase.GetValue(ClickCommandBehaviorProperty) as ButtonBaseClickCommandBehavior; if ( behavior == null ) { behavior = new ButtonBaseClickCommandBehavior(buttonBase); buttonBase.SetValue(ClickCommandBehaviorProperty, behavior); } return behavior; }</code> <br>        ,  <a href="http://msdn.microsoft.com/en-us/library/cc265152(VS.95).aspx">Attached Properties Overview</a>  MSDN. <br> <br>    <br>              . ,     Silverlight,    -,     ,      ,     .     ,       . <br> <br>        ,    ( )  ,  ,     .  UI       ,            UI. <br> <br>      - <br>   -     ,       <code>IAsyncResult</code> .   ,  ,   ,  <code>GetQuestionnaire</code> ,   : <code>BeginGetQuestionnaire</code>  <code>EndGetQuestionnaire</code> .    ,   <code>BeginGetQuestionnaire</code> .     ,   ,   <code>EndGetQuestionnaire</code>    . <br> <b></b> <br>  .NET Framework 4.5      <code>await</code>  <code>async</code>     <code>*Async</code> .      <a href="http://msdn.microsoft.com/en-us/library/vstudio/hh391443.aspx">"Asynchronous Programming with Async and Await (C# and Visual Basic)"</a> . <br>  ,    <code>EndGetQuestionnaire</code> ,      ,  ()      <code>BeginGetQuestionnaire</code> .     ,      ,   <code>EndGetQuestionnaire</code> ,   . <br> <br> <code class="xml">IAsyncResult asyncResult = this.service.BeginGetQuestionnaire( GetQuestionnaireCompleted, null //  ,      ); private void GetQuestionnaireCompleted(IAsyncResult result) { try { questionnaire = this.service.EndGetQuestionnaire(ar); } catch (Exception ex) { //  -   . } }</code> <br>  ,     <code>End*</code> (  , <code>EndGetQuestionnaire</code> ),    ,      .      , ,          UI.     ,   ,        . <br> <br>        UI,     -,      UI,         UI,   <code>Dispatcher</code>    <code>SynchronizationContext</code> .  WPF  Silverlight,   <code>Dispatcher</code> . <br> <br>      <code>Questionnaire</code>  ,        <code>QuestionnaireView</code> .  Silverlight    <code>CheckAccess</code> ,  ,      UI.  ,     <code>BeginInvoke</code> ,      UI. <br> <br> <code class="cs">var dispatcher = System.Windows.Deployment.Current.Dispatcher; if (dispatcher.CheckAccess()) { QuestionnaireView.DataContext = questionnaire; } else { dispatcher.BeginInvoke(() =&gt; { Questionnaire.DataContext = questionnaire; }); }</code> <br> <i>MVVM RI</i>   ,    ,   <code>IAsyncResult</code> ,   .      ,                 . ,       . <br> <br> <code class="cs">this.questionnaireRepository.GetQuestionnaireAsync( result =&gt; { this.Questionnaire = result.Result; });</code> <br>  <code>result</code>   ,     , , , .    ,     . <br> <br> <code class="cs">this.questionnaireRepository.GetQuestionnaireAsync( result =&gt; { if (result.Error == null) { this.Questionnaire = result.Result; ... } else { // Handle error. } })</code> <br>     <br>        ,      .     , ,             .        ,      ,     ,     . <br> <br>         ,      MVVM,     ,   . ,  -MVVM ,     <code>MessageBox</code>   code-behind UI,      .   MVVM     ,          . <br> <br>     MVVM,              ,          .      ,    ,   ,  ,     . <br> <br>              MVVM.      ,     ,     ,  ,     .    ,         ,     ,          .       . <br> <br>    <br>                  .        ,        .  ,         .         . <br> <br>  ,         ,         ,  .      ,     .           ,       . ,        WPF  Silverlight,        . <br> <br> <img title="Using the service to interact with the user." src="https://habrastorage.org/getpro/habr/post_images/4b5/397/f2d/4b5397f2d02e5851195b29f1893be6fc.png" alt=" ,    ."> <br> <br>  ,   <code>MessageBox</code>        ,     ,    ,     . <br> <br> <code class="cs">var result = interactionService.ShowMessageBox( "Are you sure you want to cancel this operation?", "Confirm", MessageBoxButton.OK); if (result == MessageBoxResult.Yes) { CancelRequest(); }</code> <br> ,      - ,      ,         Silverlight.         .             .     . <br> <br> <code class="cs">interactionService.ShowMessageBox( "Are you sure you want to cancel this operation?", "Confirm", MessageBoxButton.OK, result =&gt; { if (result == MessageBoxResult.Yes) { CancelRequest(); } });</code> <br>         ,      . ,  WPF    <code>MessageBox</code> ,       ;    Silverlight    ,    . <br> <br>     <br>         ‚Äì             .         ,      .     ,     .        ,        ,   ,     . <br> <br> <img title="Using interaction request objects." src="https://habrastorage.org/getpro/habr/post_images/3d0/ff0/1c5/3d0ff01c5518558c2d3c5c5f47ce0ce9.png" alt="   ."> <br> <br>    ,   ,          ‚Äì       ,      ,   ‚Äì     .   ,        ,    ,    UI            . <br> <br>       MVVM,     ,       ,         .         ,        ,    ,   . <br> <br>  Prism       <code>IInteractionRequest</code>   <code>InteractionRequest .  IInteractionRequest</code>  ,   .           ,   .  <code>InteractionRequest   IInteractionRequest</code>     <code>Raise</code> ,           , , ,   . <br> <br>       <br>  <code>InteractionRequest          .  Raise</code>          ( <code>T</code> )    ,    ,   .          ,       .      ,        .    ,  ,     . <br> <code class="cs">public interface IInteractionRequest { event EventHandler&lt;InteractionRequestedEventArgs&gt; Raised; } public class InteractionRequest&lt;T&gt; : IInteractionRequest { public event EventHandler&lt;InteractionRequestedEventArgs&gt; Raised; public void Raise(T context, Action&lt;T&gt; callback) { var handler = this.Raised; if (handler != null) { handler( this, new InteractionRequestedEventArgs(context, () =&gt; callback(context))); } } }</code> <br> Prism    ,      .  <code>Notification</code>       .    ,            .     ‚Äì <code>Title</code>  <code>Content</code> ,    .  ,   ,  ,  ,        . <br> <br>  <code>Confirmation</code>    <code>Notification</code>     ‚Äì <code>Confirmed</code> ,  ,  ,      .  <code>Confirmation</code> ,     <code>MessageBox</code> ,     /  .     ,     <code>Notification</code> ,     ,      . <br> <br>    <code>InteractionRequest ,       InteractionRequest      ,      .      ,    Raise</code> ,    , ,   . <br> <br> <code class="cs">public IInteractionRequest ConfirmCancelInteractionRequest { get { return this.confirmCancelInteractionRequest; } } this.confirmCancelInteractionRequest.Raise( new Confirmation("Are you sure you wish to cancel?"), confirmation =&gt; { if (confirmation.Confirmed) { this.NavigateToQuestionnaireList(); } }); }</code> <br> <i>MVVM Reference Implementation (MVVM RI)</i> ,    <code>IInteractionRequest</code>   <code>InteractionRequest ,          (. QuestionnaireViewModel.cs</code> ). <br> <br>        <br>       ,       .   ,       .    UI             . <br> <br>                . Microsoft Expression Blend Behaviors Framework     .  ,     ,    . <br> <br>  <code>EventTrigger</code> ,  Expression Blend,  ,      ,     ,   . , Prism   <code>EventTrigger</code> ,  <code>InteractionRequestTrigger</code> ,      <code>Raised</code>   <code>IInteractionRequest</code> .    XAML        . <br> <br>  ,   , <code>InteractionRequestTrigger</code>   .  Silverlight Prism   <code>PopupChildWindowAction</code> ,     .    ,         .   <code>ContentTemplate</code>  <code>PopupChildWindowAction</code> ,    ,    UI,      <code>Content</code>  .       <code>Title</code>  . <br> <b></b> <br>  ,    ,   <code>PopupChildWindowAction</code> ,     .    <code>Notification</code>  <code>NotificationChildWindow</code> ,        <code>Confirmation</code> ‚Äì <code>ConfirmationChildWindow</code> . <code>NotificationChildWindow</code>    ,   ,     <code>ConfirmationChildWindow</code>    <i>OK</i>  <i>Cancel</i> ,    .    ,   ,   <code>ChildWindow</code>  <code>PopupChildWindowAction</code> . <br>   ,  <code>InteractionRequestTrigger</code>  <code>PopupChildWindowAction</code> ,       <i>RI MVVM</i> . <br> <br> <code class="xml">&lt;i:Interaction.Triggers&gt; &lt;prism:InteractionRequestTrigger SourceObject="{Binding ConfirmCancelInteractionRequest}"&gt; &lt;prism:PopupChildWindowAction ContentTemplate="{StaticResource ConfirmWindowTemplate}"/&gt; &lt;/prism:InteractionRequestTrigger&gt; &lt;/i:Interaction.Triggers&gt; &lt;UserControl.Resources&gt; &lt;DataTemplate x:Key="ConfirmWindowTemplate"&gt; &lt;Grid MinWidth="250" MinHeight="100"&gt; &lt;TextBlock TextWrapping="Wrap" Grid.Row="0" Text="{Binding}"/&gt; &lt;/Grid&gt; &lt;/DataTemplate&gt; &lt;/UserControl.Resources&gt;</code> <br> <b></b> <br>      <code>ContentTemplate</code> ,   UI   <code>Content</code>  .    <code>Content</code>  ,  , <code>TextBlock</code>     <code>Content</code> . <br>      ,     ,    ,    .  ,     ,       ,     ,    .   ,   <i>RI MVVM</i> ,         <code>Confirmed</code>    <code>Confirmation</code>  <code>true</code> ,     OK. <br> <br>        ,     .  Prism <code>InteractionRequestTrigger</code>   <code>PopupChildWindowAction</code>            . <br> <br>     <br>     MVVM,       , ,    ,         .        (  , ,  ,   ).    ,  ,  ,            . <br> <br>        ,         . Managed Extensibility Framework (MEF)  Unity Application Block (Unity)      ,  ,           . <br> <br>  ,       , , ,    ( )      . ,       ,     .  ,     ,       . <br> <br>     ,  MEF <br>  MEF,       ,   <code>Import</code> ,      ,  ,   <code>Export</code> .         ,    . <br> <br> , <code>QuestionnaireView</code>   <i>RI MVVM</i> ,        ,    <code>Import</code> .   , MEF           .  <code>set</code>        ,   . <br> <br> <code class="cs">[Import] public QuestionnaireViewModel ViewModel { set { this.DataContext = value; } }</code> <br>     ,   . <br> <br> <code class="cs">[Export] public class QuestionnaireViewModel : NotificationObject { ... }</code> <br>        ,   . <br> <br> <code class="cs">public QuestionnaireView() { InitializeComponent(); } [ImportingConstructor] public QuestionnaireView(QuestionnaireViewModel viewModel) : this() { this.DataContext = viewModel; }</code> <br> <b></b> <br>          MEF,   Unity.   ,     ,        .   ,   Visual Studio  Expression Blend, ,        ,     .   ,   ,  ,      ,          <code>InitializeComponent</code> . <br>     ,  Unity <br>  Unity,    ,   MEF.     ,      .    ,         .  ,      . <br> <br>  ,      ,  ,         . ,           ,   . <br> <br> <code class="cs">public QuestionnaireView() { InitializeComponent(); } public QuestionnaireView(QuestionnaireViewModel viewModel) : this() { this.DataContext = viewModel; }</code> <br> <b></b> <br>    ,        ,   Visual Studio  Expression Blend. <br>  ,          ,   . Unity        <code>set</code>   ,   . <br> <br> <code class="cs">public QuestionnaireView() { InitializeComponent(); } [Dependency] public QuestionnaireViewModel ViewModel { set { this.DataContext = value; } }</code> <br>       Unity. <br> <br> <code class="cs">container.RegisterType&lt;QuestionnaireViewModel&gt;();</code> <br>  ,     . <br> <br> <code class="cs">var view = container.Resolve&lt;QuestionnaireView&gt;();</code> <br>     ,    <br>   ,     ,        .        ,   MEF  Unity,        . <br> <br>          .   ,         UI,           . <br> <br> , <i>RI MVVM</i>   ,   ,        .   ,    .      <code>ShowView</code>   UI. <br> <br> <code class="cs">private void NavigateToQuestionnaireList() { //     "questionnaire list". this.uiService.ShowView(ViewNames.QuestionnaireTemplatesList); }</code> <br>  UI      UI .           UI.  <code>ShowView</code>  <code>UIService</code>      (,          ),       ,   . <br> <br> <code class="cs">public void ShowView(string viewName) { var view = this.ViewFactory.GetView(viewName); this.MainWindow.CurrentView = view; }</code> <br> <b></b> <br> Prism       .   ,   ,   ,             .    ,  , " <a href="http://msdn.microsoft.com/en-us/library/gg430861(v%3DPandP.40).aspx">View-Based Navigation</a> "   8, " <a href="http://msdn.microsoft.com/en-us/library/gg430861(v%3DPandP.40).aspx">Navigation</a> ". <br>  MVVM  <br>        MVVM      .           -      mocking . ,   ,        . <br> <br>   <i>INotifyPropertyChanged</i> <br>   <code>INotifyPropertyChanged</code>     ,      .      ,    ;   ,   ,     ,    ,       . <br> <br>   <br> ,       ,           <code>PropertyChanged</code>  ,         .  ,    <code>ChangeTracker</code> ,     MVVM,  ,      .      .     ,    . <br> <br> <code class="cs">var changeTracker = new PropertyChangeTracker(viewModel); viewModel.CurrentState = "newState"; CollectionAssert.Contains(changeTracker.ChangedProperties, "CurrentState");</code> <br> ,     ,     <code>INotifyPropertyChanged</code> ,    ,   ,     . <br> <br>      <br>        ,   ,    <code>set</code>      ,           . ,     ,     ,      ,          . <br> <br> <code class="cs">var changeTracker = new PropertyChangeTracker(viewModel); var question = viewModel.Questions.First() as OpenQuestionViewModel; question.Question.Response = "some text"; CollectionAssert.Contains(changeTracker.ChangedProperties, "UnansweredQuestions");</code> <br>      <br>     <code>INotifyPropertyChanged</code> ,      <code>PropertyChanged</code>        ,  ,     , , .        ,       . <br> <br>   <i>INotifyDataErrorInfo</i> <br>   ,     ,    ,   ,   <code>IDataErrorInfo</code> ,  ( Silverlight)   <code>INotifyDataErrorInfo</code> .   <code>INotifyDataErrorInfo</code>   ,         ,    ,  ,   ,    . <br> <br>       <code>INotifyDataErrorInfo</code> : ,     ,  ,     ,     <code>ErrorsChanged</code> ,      <code>GetErrors</code> , . <br> <br>    <br>     ,      ,     .       ,         <code>GetErrors</code>       ,  ,  ,   .    , ,  ,     ,        .   ,        . <br> <br> <code class="cs">//  . var notifyErrorInfo = (INotifyDataErrorInfo)question; question.Response = -15; Assert.IsTrue(notifyErrorInfo.GetErrors("Response").Cast&lt;ValidationResult&gt;().Any()); //  . var notifyErrorInfo = (INotifyDataErrorInfo)question; question.Response = 15; Assert.IsFalse(notifyErrorInfo.GetErrors("Response").Cast&lt;ValidationResult&gt;().Any());</code> <br>    ,    ,             . <br> <br>    <i>INotifyDataErrorInfo</i> <br>       <code>GetErrors</code> ,   <code>INotifyDataErrorInfo</code>  ,   <code>ErrorsChanged</code>      <code>GetErrors</code> . ,  <code>HasErrors</code>      ,  . <br> <br>       <code>INotifyDataErrorInfo</code> . , ,           ,   -  .      ,        <code>INotifyDataErrorInfo</code>         (,        ). <br> <br>     ,   ,  : <br>  <code>HasErrors</code>     .              ,       .  <code>ErrorsChanged</code> ,      ,         <code>GetErrors</code> .         ( ,  )     ,           .    <code>GetErrors</code>       <code>ErrorsChanged</code> . <br>    <code>INotifyPropertyChanged</code> ,  ,    <code>NotifyDataErrorInfoTestHelper</code>    MVVM,        <code>INotifyDataErrorInfo</code> ,       .   ,   ,      ,   .      . <br> <code class="cs">var helper = new NotifyDataErrorInfoTestHelper&lt;NumericQuestion, int?&gt;( question, q =&gt; q.Response); helper.ValidatePropertyChange( 6, NotifyDataErrorInfoBehavior.Nothing); helper.ValidatePropertyChange( 20, NotifyDataErrorInfoBehavior.FiresErrorsChanged | NotifyDataErrorInfoBehavior.HasErrors | NotifyDataErrorInfoBehavior.HasErrorsForProperty); helper.ValidatePropertyChange( null, NotifyDataErrorInfoBehavior.FiresErrorsChanged | NotifyDataErrorInfoBehavior.HasErrors | NotifyDataErrorInfoBehavior.HasErrorsForProperty); helper.ValidatePropertyChange( 2, NotifyDataErrorInfoBehavior.FiresErrorsChanged);</code> <br>     <br>   MVVM,     ,  .   ,    ,         . <br> <br>  ,     ,     ,       .   ,   , ,       ,     ,   <code>IAsyncResult</code>    ,  - ,   ,    UI. <br> <br>       , , ,    .   ,     .  ,      UI,     ,   ,          ,     ,        "   UI." <br> <br>     ,    ,    .   ,    ,     mock-, ,   ,   ,      ,          . <br> <br>           UI,    ,    .   ,     ,   ,      .        ,   .     ,    ,     . <br> <br> <code class="cs">questionnaireRepositoryMock .Setup( r =&gt; r.SubmitQuestionnaireAsync( It.IsAny&lt;Questionnaire&gt;(), It.IsAny&lt;Action&lt;IOperationResult&gt;&gt;())) .Callback&lt;Questionnaire, Action&lt;IOperationResult&gt;&gt;( (q, a) =&gt; callback = a); uiServicemock .Setup(svc =&gt; svc.ShowView(ViewNames.QuestionnaireTemplatesList)) .Callback&lt;string&gt;(viewName =&gt; requestedViewName = viewName); submitResultMock .Setup(sr =&gt; sr.Error) .Returns&lt;Exception&gt;(null); CompleteQuestionnaire(viewModel); viewModel.Submit(); //      UI . callback(submitResultMock.Object); //    ‚Äì     . Assert.AreEqual(ViewNames.QuestionnaireTemplatesList, requestedViewName);</code> <br> <b></b> <br>          ,        . <br>   <br>       , . "Trees in WPF"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ms753391.aspx">http://msdn.microsoft.com/en-us/library/ms753391.aspx</a> <br> <br>       , . "Attached Properties Overview"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/cc265152(VS.95).aspx">http://msdn.microsoft.com/en-us/library/cc265152(VS.95).aspx</a> <br> <br>      MEF, ."Managed Extensibility Framework Overview"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/dd460648.aspx">http://msdn.microsoft.com/en-us/library/dd460648.aspx</a> . <br> <br>      Unity, ."Unity Application Block"  MSDN: <a href="http://www.msdn.com/unity">http://www.msdn.com/unity</a> . <br> <br>      <code>DelegateCommand</code> , .Chapter 5, " <a href="http://msdn.microsoft.com/en-us/library/gg405484(v%3DPandP.40).aspx">Implementing the MVVM Pattern</a> ." <br> <br>        Microsoft Expression Blend, ."Working with built-in behaviors"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ff724013(v%3DExpression.40).aspx">http://msdn.microsoft.com/en-us/library/ff724013(v=Expression.40).aspx</a> . <br> <br>          Microsoft Expression Blend, ."Creating Custom Behaviors"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ff724708(v%3DExpression.40).aspx">http://msdn.microsoft.com/en-us/library/ff724708(v=Expression.40).aspx</a> . <br> <br>            Microsoft Expression Blend, ."Creating Custom Triggers and Actions"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ff724707(v%3DExpression.40).aspx">http://msdn.microsoft.com/en-us/library/ff724707(v=Expression.40).aspx</a> . <br> <br>         WPF  Silverlight, ."Threading Model"  "The Dispatcher Class"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ms741870.aspx">http://msdn.microsoft.com/en-us/library/ms741870.aspx</a> <br> <a href="http://msdn.microsoft.com/en-us/library/ms615907(v%3DVS.95).aspx">http://msdn.microsoft.com/en-us/library/ms615907(v=VS.95).aspx</a> . <br> <br>      unit-  Silverlight, ."Unit Testing with Silverlight 2": <a href="http://www.jeff.wilcox.name/2008/03/silverlight2-unit-testing/">http://www.jeff.wilcox.name/2008/03/silverlight2-unit-testing/</a> . <br> <br>         , .  " <a href="http://msdn.microsoft.com/en-us/library/gg430861(v%3DPandP.40).aspx">View-Based Navigation</a> " in Chapter 8, " <a href="http://msdn.microsoft.com/en-us/library/gg430861(v%3DPandP.40).aspx">Navigation</a> ." <br> <br>       ,   , ."Event-based Asynchronous Pattern Overview"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/wewwczdw.aspx">http://msdn.microsoft.com/en-us/library/wewwczdw.aspx</a> <br> <br>        <code>IAsyncResult</code> , ."Asynchronous Programming Overview"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ms228963.aspx">http://msdn.microsoft.com/en-us/library/ms228963.aspx</a></code></code></code></code></code></code></code></code></code> </h4> <code><code><code><code><code><code><code><code><code><code>CommandBehaviorBase ,    ,    ICommand</code> .           <code>CanExecuteChanged</code> ,          Silverlight,    WPF. <br> <br>    ,  ,   <code>CommandBehaviorBase    ,    .         ,      .         ,    .      ButtonBaseClickCommandBehavior</code> . <br> <br> <code class="cs">public class ButtonBaseClickCommandBehavior : CommandBehaviorBase&lt;ButtonBase&gt; { public ButtonBaseClickCommandBehavior(ButtonBase clickableObject) : base(clickableObject) { clickableObject.Click += OnClick; } private void OnClick(object sender, System.Windows.RoutedEventArgs e) { ExecuteCommand(); } }</code> <br>   <code>CommandBehaviorBase ,     .     ,          ,   . ,    ,    ,      , ,    CanExecute</code>  ,     . <br> <br>          ,   .           XAML.           .       .  Prism      ,       ,  ,   .       ,    . , ,  ,      <code>Click</code> ,       <code>Command</code> .    <code>Click.Command</code> ,  . <br> <br>             .             . <br> <br> <code class="cs">public static readonly DependencyProperty CommandProperty = DependencyProperty.RegisterAttached( "Command", typeof(ICommand), typeof(Click), new PropertyMetadata(OnSetCommandCallback)); private static readonly DependencyProperty ClickCommandBehaviorProperty = DependencyProperty.RegisterAttached( "ClickCommandBehavior", typeof(ButtonBaseClickCommandBehavior), typeof(Click), null);</code> <br>    <code>Command</code>    <code>ButtonBaseClickCommandBehavior</code> ,     <code>OnSetCommandCallback</code> ,     . <br> <br> <code class="cs">private static void OnSetCommandCallback(DependencyObject dependencyObject, DependencyPropertyChangedEventArgs e) { ButtonBase buttonBase = dependencyObject as ButtonBase; if (buttonBase != null) { ButtonBaseClickCommandBehavior behavior = GetOrCreateBehavior(buttonBase); behavior.Command = e.NewValue as ICommand; } } private static void OnSetCommandParameterCallback(DependencyObject dependencyObject, DependencyPropertyChangedEventArgs e) { ButtonBase buttonBase = dependencyObject as ButtonBase; if (buttonBase != null) { ButtonBaseClickCommandBehavior behavior = GetOrCreateBehavior(buttonBase); behavior.CommandParameter = e.NewValue; } } private static ButtonBaseClickCommandBehavior GetOrCreateBehavior(ButtonBase buttonBase ) { ButtonBaseClickCommandBehavior behavior = buttonBase.GetValue(ClickCommandBehaviorProperty) as ButtonBaseClickCommandBehavior; if ( behavior == null ) { behavior = new ButtonBaseClickCommandBehavior(buttonBase); buttonBase.SetValue(ClickCommandBehaviorProperty, behavior); } return behavior; }</code> <br>        ,  <a href="http://msdn.microsoft.com/en-us/library/cc265152(VS.95).aspx">Attached Properties Overview</a>  MSDN. <br> <br>    <br>              . ,     Silverlight,    -,     ,      ,     .     ,       . <br> <br>        ,    ( )  ,  ,     .  UI       ,            UI. <br> <br>      - <br>   -     ,       <code>IAsyncResult</code> .   ,  ,   ,  <code>GetQuestionnaire</code> ,   : <code>BeginGetQuestionnaire</code>  <code>EndGetQuestionnaire</code> .    ,   <code>BeginGetQuestionnaire</code> .     ,   ,   <code>EndGetQuestionnaire</code>    . <br> <b></b> <br>  .NET Framework 4.5      <code>await</code>  <code>async</code>     <code>*Async</code> .      <a href="http://msdn.microsoft.com/en-us/library/vstudio/hh391443.aspx">"Asynchronous Programming with Async and Await (C# and Visual Basic)"</a> . <br>  ,    <code>EndGetQuestionnaire</code> ,      ,  ()      <code>BeginGetQuestionnaire</code> .     ,      ,   <code>EndGetQuestionnaire</code> ,   . <br> <br> <code class="xml">IAsyncResult asyncResult = this.service.BeginGetQuestionnaire( GetQuestionnaireCompleted, null //  ,      ); private void GetQuestionnaireCompleted(IAsyncResult result) { try { questionnaire = this.service.EndGetQuestionnaire(ar); } catch (Exception ex) { //  -   . } }</code> <br>  ,     <code>End*</code> (  , <code>EndGetQuestionnaire</code> ),    ,      .      , ,          UI.     ,   ,        . <br> <br>        UI,     -,      UI,         UI,   <code>Dispatcher</code>    <code>SynchronizationContext</code> .  WPF  Silverlight,   <code>Dispatcher</code> . <br> <br>      <code>Questionnaire</code>  ,        <code>QuestionnaireView</code> .  Silverlight    <code>CheckAccess</code> ,  ,      UI.  ,     <code>BeginInvoke</code> ,      UI. <br> <br> <code class="cs">var dispatcher = System.Windows.Deployment.Current.Dispatcher; if (dispatcher.CheckAccess()) { QuestionnaireView.DataContext = questionnaire; } else { dispatcher.BeginInvoke(() =&gt; { Questionnaire.DataContext = questionnaire; }); }</code> <br> <i>MVVM RI</i>   ,    ,   <code>IAsyncResult</code> ,   .      ,                 . ,       . <br> <br> <code class="cs">this.questionnaireRepository.GetQuestionnaireAsync( result =&gt; { this.Questionnaire = result.Result; });</code> <br>  <code>result</code>   ,     , , , .    ,     . <br> <br> <code class="cs">this.questionnaireRepository.GetQuestionnaireAsync( result =&gt; { if (result.Error == null) { this.Questionnaire = result.Result; ... } else { // Handle error. } })</code> <br>     <br>        ,      .     , ,             .        ,      ,     ,     . <br> <br>         ,      MVVM,     ,   . ,  -MVVM ,     <code>MessageBox</code>   code-behind UI,      .   MVVM     ,          . <br> <br>     MVVM,              ,          .      ,    ,   ,  ,     . <br> <br>              MVVM.      ,     ,     ,  ,     .    ,         ,     ,          .       . <br> <br>    <br>                  .        ,        .  ,         .         . <br> <br>  ,         ,         ,  .      ,     .           ,       . ,        WPF  Silverlight,        . <br> <br> <img title="Using the service to interact with the user." src="https://habrastorage.org/getpro/habr/post_images/4b5/397/f2d/4b5397f2d02e5851195b29f1893be6fc.png" alt=" ,    ."> <br> <br>  ,   <code>MessageBox</code>        ,     ,    ,     . <br> <br> <code class="cs">var result = interactionService.ShowMessageBox( "Are you sure you want to cancel this operation?", "Confirm", MessageBoxButton.OK); if (result == MessageBoxResult.Yes) { CancelRequest(); }</code> <br> ,      - ,      ,         Silverlight.         .             .     . <br> <br> <code class="cs">interactionService.ShowMessageBox( "Are you sure you want to cancel this operation?", "Confirm", MessageBoxButton.OK, result =&gt; { if (result == MessageBoxResult.Yes) { CancelRequest(); } });</code> <br>         ,      . ,  WPF    <code>MessageBox</code> ,       ;    Silverlight    ,    . <br> <br>     <br>         ‚Äì             .         ,      .     ,     .        ,        ,   ,     . <br> <br> <img title="Using interaction request objects." src="https://habrastorage.org/getpro/habr/post_images/3d0/ff0/1c5/3d0ff01c5518558c2d3c5c5f47ce0ce9.png" alt="   ."> <br> <br>    ,   ,          ‚Äì       ,      ,   ‚Äì     .   ,        ,    ,    UI            . <br> <br>       MVVM,     ,       ,         .         ,        ,    ,   . <br> <br>  Prism       <code>IInteractionRequest</code>   <code>InteractionRequest .  IInteractionRequest</code>  ,   .           ,   .  <code>InteractionRequest   IInteractionRequest</code>     <code>Raise</code> ,           , , ,   . <br> <br>       <br>  <code>InteractionRequest          .  Raise</code>          ( <code>T</code> )    ,    ,   .          ,       .      ,        .    ,  ,     . <br> <code class="cs">public interface IInteractionRequest { event EventHandler&lt;InteractionRequestedEventArgs&gt; Raised; } public class InteractionRequest&lt;T&gt; : IInteractionRequest { public event EventHandler&lt;InteractionRequestedEventArgs&gt; Raised; public void Raise(T context, Action&lt;T&gt; callback) { var handler = this.Raised; if (handler != null) { handler( this, new InteractionRequestedEventArgs(context, () =&gt; callback(context))); } } }</code> <br> Prism    ,      .  <code>Notification</code>       .    ,            .     ‚Äì <code>Title</code>  <code>Content</code> ,    .  ,   ,  ,  ,        . <br> <br>  <code>Confirmation</code>    <code>Notification</code>     ‚Äì <code>Confirmed</code> ,  ,  ,      .  <code>Confirmation</code> ,     <code>MessageBox</code> ,     /  .     ,     <code>Notification</code> ,     ,      . <br> <br>    <code>InteractionRequest ,       InteractionRequest      ,      .      ,    Raise</code> ,    , ,   . <br> <br> <code class="cs">public IInteractionRequest ConfirmCancelInteractionRequest { get { return this.confirmCancelInteractionRequest; } } this.confirmCancelInteractionRequest.Raise( new Confirmation("Are you sure you wish to cancel?"), confirmation =&gt; { if (confirmation.Confirmed) { this.NavigateToQuestionnaireList(); } }); }</code> <br> <i>MVVM Reference Implementation (MVVM RI)</i> ,    <code>IInteractionRequest</code>   <code>InteractionRequest ,          (. QuestionnaireViewModel.cs</code> ). <br> <br>        <br>       ,       .   ,       .    UI             . <br> <br>                . Microsoft Expression Blend Behaviors Framework     .  ,     ,    . <br> <br>  <code>EventTrigger</code> ,  Expression Blend,  ,      ,     ,   . , Prism   <code>EventTrigger</code> ,  <code>InteractionRequestTrigger</code> ,      <code>Raised</code>   <code>IInteractionRequest</code> .    XAML        . <br> <br>  ,   , <code>InteractionRequestTrigger</code>   .  Silverlight Prism   <code>PopupChildWindowAction</code> ,     .    ,         .   <code>ContentTemplate</code>  <code>PopupChildWindowAction</code> ,    ,    UI,      <code>Content</code>  .       <code>Title</code>  . <br> <b></b> <br>  ,    ,   <code>PopupChildWindowAction</code> ,     .    <code>Notification</code>  <code>NotificationChildWindow</code> ,        <code>Confirmation</code> ‚Äì <code>ConfirmationChildWindow</code> . <code>NotificationChildWindow</code>    ,   ,     <code>ConfirmationChildWindow</code>    <i>OK</i>  <i>Cancel</i> ,    .    ,   ,   <code>ChildWindow</code>  <code>PopupChildWindowAction</code> . <br>   ,  <code>InteractionRequestTrigger</code>  <code>PopupChildWindowAction</code> ,       <i>RI MVVM</i> . <br> <br> <code class="xml">&lt;i:Interaction.Triggers&gt; &lt;prism:InteractionRequestTrigger SourceObject="{Binding ConfirmCancelInteractionRequest}"&gt; &lt;prism:PopupChildWindowAction ContentTemplate="{StaticResource ConfirmWindowTemplate}"/&gt; &lt;/prism:InteractionRequestTrigger&gt; &lt;/i:Interaction.Triggers&gt; &lt;UserControl.Resources&gt; &lt;DataTemplate x:Key="ConfirmWindowTemplate"&gt; &lt;Grid MinWidth="250" MinHeight="100"&gt; &lt;TextBlock TextWrapping="Wrap" Grid.Row="0" Text="{Binding}"/&gt; &lt;/Grid&gt; &lt;/DataTemplate&gt; &lt;/UserControl.Resources&gt;</code> <br> <b></b> <br>      <code>ContentTemplate</code> ,   UI   <code>Content</code>  .    <code>Content</code>  ,  , <code>TextBlock</code>     <code>Content</code> . <br>      ,     ,    ,    .  ,     ,       ,     ,    .   ,   <i>RI MVVM</i> ,         <code>Confirmed</code>    <code>Confirmation</code>  <code>true</code> ,     OK. <br> <br>        ,     .  Prism <code>InteractionRequestTrigger</code>   <code>PopupChildWindowAction</code>            . <br> <br>     <br>     MVVM,       , ,    ,         .        (  , ,  ,   ).    ,  ,  ,            . <br> <br>        ,         . Managed Extensibility Framework (MEF)  Unity Application Block (Unity)      ,  ,           . <br> <br>  ,       , , ,    ( )      . ,       ,     .  ,     ,       . <br> <br>     ,  MEF <br>  MEF,       ,   <code>Import</code> ,      ,  ,   <code>Export</code> .         ,    . <br> <br> , <code>QuestionnaireView</code>   <i>RI MVVM</i> ,        ,    <code>Import</code> .   , MEF           .  <code>set</code>        ,   . <br> <br> <code class="cs">[Import] public QuestionnaireViewModel ViewModel { set { this.DataContext = value; } }</code> <br>     ,   . <br> <br> <code class="cs">[Export] public class QuestionnaireViewModel : NotificationObject { ... }</code> <br>        ,   . <br> <br> <code class="cs">public QuestionnaireView() { InitializeComponent(); } [ImportingConstructor] public QuestionnaireView(QuestionnaireViewModel viewModel) : this() { this.DataContext = viewModel; }</code> <br> <b></b> <br>          MEF,   Unity.   ,     ,        .   ,   Visual Studio  Expression Blend, ,        ,     .   ,   ,  ,      ,          <code>InitializeComponent</code> . <br>     ,  Unity <br>  Unity,    ,   MEF.     ,      .    ,         .  ,      . <br> <br>  ,      ,  ,         . ,           ,   . <br> <br> <code class="cs">public QuestionnaireView() { InitializeComponent(); } public QuestionnaireView(QuestionnaireViewModel viewModel) : this() { this.DataContext = viewModel; }</code> <br> <b></b> <br>    ,        ,   Visual Studio  Expression Blend. <br>  ,          ,   . Unity        <code>set</code>   ,   . <br> <br> <code class="cs">public QuestionnaireView() { InitializeComponent(); } [Dependency] public QuestionnaireViewModel ViewModel { set { this.DataContext = value; } }</code> <br>       Unity. <br> <br> <code class="cs">container.RegisterType&lt;QuestionnaireViewModel&gt;();</code> <br>  ,     . <br> <br> <code class="cs">var view = container.Resolve&lt;QuestionnaireView&gt;();</code> <br>     ,    <br>   ,     ,        .        ,   MEF  Unity,        . <br> <br>          .   ,         UI,           . <br> <br> , <i>RI MVVM</i>   ,   ,        .   ,    .      <code>ShowView</code>   UI. <br> <br> <code class="cs">private void NavigateToQuestionnaireList() { //     "questionnaire list". this.uiService.ShowView(ViewNames.QuestionnaireTemplatesList); }</code> <br>  UI      UI .           UI.  <code>ShowView</code>  <code>UIService</code>      (,          ),       ,   . <br> <br> <code class="cs">public void ShowView(string viewName) { var view = this.ViewFactory.GetView(viewName); this.MainWindow.CurrentView = view; }</code> <br> <b></b> <br> Prism       .   ,   ,   ,             .    ,  , " <a href="http://msdn.microsoft.com/en-us/library/gg430861(v%3DPandP.40).aspx">View-Based Navigation</a> "   8, " <a href="http://msdn.microsoft.com/en-us/library/gg430861(v%3DPandP.40).aspx">Navigation</a> ". <br>  MVVM  <br>        MVVM      .           -      mocking . ,   ,        . <br> <br>   <i>INotifyPropertyChanged</i> <br>   <code>INotifyPropertyChanged</code>     ,      .      ,    ;   ,   ,     ,    ,       . <br> <br>   <br> ,       ,           <code>PropertyChanged</code>  ,         .  ,    <code>ChangeTracker</code> ,     MVVM,  ,      .      .     ,    . <br> <br> <code class="cs">var changeTracker = new PropertyChangeTracker(viewModel); viewModel.CurrentState = "newState"; CollectionAssert.Contains(changeTracker.ChangedProperties, "CurrentState");</code> <br> ,     ,     <code>INotifyPropertyChanged</code> ,    ,   ,     . <br> <br>      <br>        ,   ,    <code>set</code>      ,           . ,     ,     ,      ,          . <br> <br> <code class="cs">var changeTracker = new PropertyChangeTracker(viewModel); var question = viewModel.Questions.First() as OpenQuestionViewModel; question.Question.Response = "some text"; CollectionAssert.Contains(changeTracker.ChangedProperties, "UnansweredQuestions");</code> <br>      <br>     <code>INotifyPropertyChanged</code> ,      <code>PropertyChanged</code>        ,  ,     , , .        ,       . <br> <br>   <i>INotifyDataErrorInfo</i> <br>   ,     ,    ,   ,   <code>IDataErrorInfo</code> ,  ( Silverlight)   <code>INotifyDataErrorInfo</code> .   <code>INotifyDataErrorInfo</code>   ,         ,    ,  ,   ,    . <br> <br>       <code>INotifyDataErrorInfo</code> : ,     ,  ,     ,     <code>ErrorsChanged</code> ,      <code>GetErrors</code> , . <br> <br>    <br>     ,      ,     .       ,         <code>GetErrors</code>       ,  ,  ,   .    , ,  ,     ,        .   ,        . <br> <br> <code class="cs">//  . var notifyErrorInfo = (INotifyDataErrorInfo)question; question.Response = -15; Assert.IsTrue(notifyErrorInfo.GetErrors("Response").Cast&lt;ValidationResult&gt;().Any()); //  . var notifyErrorInfo = (INotifyDataErrorInfo)question; question.Response = 15; Assert.IsFalse(notifyErrorInfo.GetErrors("Response").Cast&lt;ValidationResult&gt;().Any());</code> <br>    ,    ,             . <br> <br>    <i>INotifyDataErrorInfo</i> <br>       <code>GetErrors</code> ,   <code>INotifyDataErrorInfo</code>  ,   <code>ErrorsChanged</code>      <code>GetErrors</code> . ,  <code>HasErrors</code>      ,  . <br> <br>       <code>INotifyDataErrorInfo</code> . , ,           ,   -  .      ,        <code>INotifyDataErrorInfo</code>         (,        ). <br> <br>     ,   ,  : <br>  <code>HasErrors</code>     .              ,       .  <code>ErrorsChanged</code> ,      ,         <code>GetErrors</code> .         ( ,  )     ,           .    <code>GetErrors</code>       <code>ErrorsChanged</code> . <br>    <code>INotifyPropertyChanged</code> ,  ,    <code>NotifyDataErrorInfoTestHelper</code>    MVVM,        <code>INotifyDataErrorInfo</code> ,       .   ,   ,      ,   .      . <br> <code class="cs">var helper = new NotifyDataErrorInfoTestHelper&lt;NumericQuestion, int?&gt;( question, q =&gt; q.Response); helper.ValidatePropertyChange( 6, NotifyDataErrorInfoBehavior.Nothing); helper.ValidatePropertyChange( 20, NotifyDataErrorInfoBehavior.FiresErrorsChanged | NotifyDataErrorInfoBehavior.HasErrors | NotifyDataErrorInfoBehavior.HasErrorsForProperty); helper.ValidatePropertyChange( null, NotifyDataErrorInfoBehavior.FiresErrorsChanged | NotifyDataErrorInfoBehavior.HasErrors | NotifyDataErrorInfoBehavior.HasErrorsForProperty); helper.ValidatePropertyChange( 2, NotifyDataErrorInfoBehavior.FiresErrorsChanged);</code> <br>     <br>   MVVM,     ,  .   ,    ,         . <br> <br>  ,     ,     ,       .   ,   , ,       ,     ,   <code>IAsyncResult</code>    ,  - ,   ,    UI. <br> <br>       , , ,    .   ,     .  ,      UI,     ,   ,          ,     ,        "   UI." <br> <br>     ,    ,    .   ,    ,     mock-, ,   ,   ,      ,          . <br> <br>           UI,    ,    .   ,     ,   ,      .        ,   .     ,    ,     . <br> <br> <code class="cs">questionnaireRepositoryMock .Setup( r =&gt; r.SubmitQuestionnaireAsync( It.IsAny&lt;Questionnaire&gt;(), It.IsAny&lt;Action&lt;IOperationResult&gt;&gt;())) .Callback&lt;Questionnaire, Action&lt;IOperationResult&gt;&gt;( (q, a) =&gt; callback = a); uiServicemock .Setup(svc =&gt; svc.ShowView(ViewNames.QuestionnaireTemplatesList)) .Callback&lt;string&gt;(viewName =&gt; requestedViewName = viewName); submitResultMock .Setup(sr =&gt; sr.Error) .Returns&lt;Exception&gt;(null); CompleteQuestionnaire(viewModel); viewModel.Submit(); //      UI . callback(submitResultMock.Object); //    ‚Äì     . Assert.AreEqual(ViewNames.QuestionnaireTemplatesList, requestedViewName);</code> <br> <b></b> <br>          ,        . <br>   <br>       , . "Trees in WPF"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ms753391.aspx">http://msdn.microsoft.com/en-us/library/ms753391.aspx</a> <br> <br>       , . "Attached Properties Overview"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/cc265152(VS.95).aspx">http://msdn.microsoft.com/en-us/library/cc265152(VS.95).aspx</a> <br> <br>      MEF, ."Managed Extensibility Framework Overview"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/dd460648.aspx">http://msdn.microsoft.com/en-us/library/dd460648.aspx</a> . <br> <br>      Unity, ."Unity Application Block"  MSDN: <a href="http://www.msdn.com/unity">http://www.msdn.com/unity</a> . <br> <br>      <code>DelegateCommand</code> , .Chapter 5, " <a href="http://msdn.microsoft.com/en-us/library/gg405484(v%3DPandP.40).aspx">Implementing the MVVM Pattern</a> ." <br> <br>        Microsoft Expression Blend, ."Working with built-in behaviors"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ff724013(v%3DExpression.40).aspx">http://msdn.microsoft.com/en-us/library/ff724013(v=Expression.40).aspx</a> . <br> <br>          Microsoft Expression Blend, ."Creating Custom Behaviors"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ff724708(v%3DExpression.40).aspx">http://msdn.microsoft.com/en-us/library/ff724708(v=Expression.40).aspx</a> . <br> <br>            Microsoft Expression Blend, ."Creating Custom Triggers and Actions"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ff724707(v%3DExpression.40).aspx">http://msdn.microsoft.com/en-us/library/ff724707(v=Expression.40).aspx</a> . <br> <br>         WPF  Silverlight, ."Threading Model"  "The Dispatcher Class"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ms741870.aspx">http://msdn.microsoft.com/en-us/library/ms741870.aspx</a> <br> <a href="http://msdn.microsoft.com/en-us/library/ms615907(v%3DVS.95).aspx">http://msdn.microsoft.com/en-us/library/ms615907(v=VS.95).aspx</a> . <br> <br>      unit-  Silverlight, ."Unit Testing with Silverlight 2": <a href="http://www.jeff.wilcox.name/2008/03/silverlight2-unit-testing/">http://www.jeff.wilcox.name/2008/03/silverlight2-unit-testing/</a> . <br> <br>         , .  " <a href="http://msdn.microsoft.com/en-us/library/gg430861(v%3DPandP.40).aspx">View-Based Navigation</a> " in Chapter 8, " <a href="http://msdn.microsoft.com/en-us/library/gg430861(v%3DPandP.40).aspx">Navigation</a> ." <br> <br>       ,   , ."Event-based Asynchronous Pattern Overview"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/wewwczdw.aspx">http://msdn.microsoft.com/en-us/library/wewwczdw.aspx</a> <br> <br>        <code>IAsyncResult</code> , ."Asynchronous Programming Overview"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ms228963.aspx">http://msdn.microsoft.com/en-us/library/ms228963.aspx</a></code></code></code></code></code></code></code></code></code> <pre> <code class="hljs cmake"><code>CommandBehaviorBase ,    ,    ICommand</code> .           <code>CanExecuteChanged</code> ,          Silverlight,    WPF. <br> <br>    ,  ,   <code><code>CommandBehaviorBase    ,    .         ,      .         ,    .      ButtonBaseClickCommandBehavior</code> . <br> <br> <code class="cs">public class ButtonBaseClickCommandBehavior : CommandBehaviorBase&lt;ButtonBase&gt; { public ButtonBaseClickCommandBehavior(ButtonBase clickableObject) : base(clickableObject) { clickableObject.Click += OnClick; } private void OnClick(object sender, System.Windows.RoutedEventArgs e) { ExecuteCommand(); } }</code> <br>   <code><code>CommandBehaviorBase ,     .     ,          ,   . ,    ,    ,      , ,    CanExecute</code>  ,     . <br> <br>          ,   .           XAML.           .       .  Prism      ,       ,  ,   .       ,    . , ,  ,      <code>Click</code> ,       <code><span class="hljs-keyword"><span class="hljs-keyword">Command</span></span></code> .    <code>Click.<span class="hljs-keyword"><span class="hljs-keyword">Command</span></span></code> ,  . <br> <br>             .             . <br> <br> <code class="cs">public static readonly DependencyProperty CommandProperty = DependencyProperty.RegisterAttached( <span class="hljs-string"><span class="hljs-string">"Command"</span></span>, typeof(ICommand), typeof(Click), new PropertyMetadata(OnSetCommandCallback)); private static readonly DependencyProperty ClickCommandBehaviorProperty = DependencyProperty.RegisterAttached( <span class="hljs-string"><span class="hljs-string">"ClickCommandBehavior"</span></span>, typeof(ButtonBaseClickCommandBehavior), typeof(Click), null);</code> <br>    <code><span class="hljs-keyword"><span class="hljs-keyword">Command</span></span></code>    <code>ButtonBaseClickCommandBehavior</code> ,     <code>OnSetCommandCallback</code> ,     . <br> <br> <code class="cs">private static void OnSetCommandCallback(DependencyObject dependencyObject, DependencyPropertyChangedEventArgs e) { ButtonBase buttonBase = dependencyObject as ButtonBase; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (buttonBase != null) { ButtonBaseClickCommandBehavior behavior = GetOrCreateBehavior(buttonBase); behavior.<span class="hljs-keyword"><span class="hljs-keyword">Command</span></span> = e.NewValue as ICommand; } } private static void OnSetCommandParameterCallback(DependencyObject dependencyObject, DependencyPropertyChangedEventArgs e) { ButtonBase buttonBase = dependencyObject as ButtonBase; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (buttonBase != null) { ButtonBaseClickCommandBehavior behavior = GetOrCreateBehavior(buttonBase); behavior.CommandParameter = e.NewValue; } } private static ButtonBaseClickCommandBehavior GetOrCreateBehavior(ButtonBase buttonBase ) { ButtonBaseClickCommandBehavior behavior = buttonBase.GetValue(ClickCommandBehaviorProperty) as ButtonBaseClickCommandBehavior; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ( behavior == null ) { behavior = new ButtonBaseClickCommandBehavior(buttonBase); buttonBase.SetValue(ClickCommandBehaviorProperty, behavior); } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> behavior; }</code> <br>        ,  <a href="http://msdn.microsoft.com/en-us/library/cc265152(VS.95).aspx">Attached Properties Overview</a>  MSDN. <br> <br>    <br>              . ,     Silverlight,    -,     ,      ,     .     ,       . <br> <br>        ,    ( )  ,  ,     .  UI       ,            UI. <br> <br>      - <br>   -     ,       <code>IAsyncResult</code> .   ,  ,   ,  <code>GetQuestionnaire</code> ,   : <code>BeginGetQuestionnaire</code>  <code>EndGetQuestionnaire</code> .    ,   <code>BeginGetQuestionnaire</code> .     ,   ,   <code>EndGetQuestionnaire</code>    . <br> <b></b> <br>  .NET Framework <span class="hljs-number"><span class="hljs-number">4.5</span></span>      <code>await</code>  <code>async</code>     <code>*Async</code> .      <a href="http://msdn.microsoft.com/en-us/library/vstudio/hh391443.aspx"><span class="hljs-string"><span class="hljs-string">"Asynchronous Programming with Async and Await (C# and Visual Basic)"</span></span></a> . <br>  ,    <code>EndGetQuestionnaire</code> ,      ,  ()      <code>BeginGetQuestionnaire</code> .     ,      ,   <code>EndGetQuestionnaire</code> ,   . <br> <br> <code class="xml">IAsyncResult asyncResult = this.service.BeginGetQuestionnaire( GetQuestionnaireCompleted, null //  ,      ); private void GetQuestionnaireCompleted(IAsyncResult result) { try { questionnaire = this.service.EndGetQuestionnaire(ar); } catch (Exception ex) { //  -   . } }</code> <br>  ,     <code>End*</code> (  , <code>EndGetQuestionnaire</code> ),    ,      .      , ,          UI.     ,   ,        . <br> <br>        UI,     -,      UI,         UI,   <code>Dispatcher</code>    <code>SynchronizationContext</code> .  WPF  Silverlight,   <code>Dispatcher</code> . <br> <br>      <code>Questionnaire</code>  ,        <code>QuestionnaireView</code> .  Silverlight    <code>CheckAccess</code> ,  ,      UI.  ,     <code>BeginInvoke</code> ,      UI. <br> <br> <code class="cs">var dispatcher = System.Windows.Deployment.Current.Dispatcher; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (dispatcher.CheckAccess()) { QuestionnaireView.DataContext = questionnaire; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { dispatcher.BeginInvoke(() =&gt; { Questionnaire.DataContext = questionnaire; }); }</code> <br> <i>MVVM RI</i>   ,    ,   <code>IAsyncResult</code> ,   .      ,                 . ,       . <br> <br> <code class="cs">this.questionnaireRepository.GetQuestionnaireAsync( result =&gt; { this.Questionnaire = result.Result; });</code> <br>  <code>result</code>   ,     , , , .    ,     . <br> <br> <code class="cs">this.questionnaireRepository.GetQuestionnaireAsync( result =&gt; { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (result.Error == null) { this.Questionnaire = result.Result; ... } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { // Handle error. } })</code> <br>     <br>        ,      .     , ,             .        ,      ,     ,     . <br> <br>         ,      MVVM,     ,   . ,  -MVVM ,     <code>MessageBox</code>   code-behind UI,      .   MVVM     ,          . <br> <br>     MVVM,              ,          .      ,    ,   ,  ,     . <br> <br>              MVVM.      ,     ,     ,  ,     .    ,         ,     ,          .       . <br> <br>    <br>                  .        ,        .  ,         .         . <br> <br>  ,         ,         ,  .      ,     .           ,       . ,        WPF  Silverlight,        . <br> <br> <img title="Using the service to interact with the user." src="https://habrastorage.org/getpro/habr/post_images/4b5/397/f2d/4b5397f2d02e5851195b29f1893be6fc.png" alt=" ,    ."> <br> <br>  ,   <code>MessageBox</code>        ,     ,    ,     . <br> <br> <code class="cs">var result = interactionService.ShowMessageBox( <span class="hljs-string"><span class="hljs-string">"Are you sure you want to cancel this operation?"</span></span>, <span class="hljs-string"><span class="hljs-string">"Confirm"</span></span>, MessageBoxButton.OK); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (result == MessageBoxResult.Yes) { CancelRequest(); }</code> <br> ,      - ,      ,         Silverlight.         .             .     . <br> <br> <code class="cs">interactionService.ShowMessageBox( <span class="hljs-string"><span class="hljs-string">"Are you sure you want to cancel this operation?"</span></span>, <span class="hljs-string"><span class="hljs-string">"Confirm"</span></span>, MessageBoxButton.OK, result =&gt; { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (result == MessageBoxResult.Yes) { CancelRequest(); } });</code> <br>         ,      . ,  WPF    <code>MessageBox</code> ,       ;    Silverlight    ,    . <br> <br>     <br>         ‚Äì             .         ,      .     ,     .        ,        ,   ,     . <br> <br> <img title="Using interaction request objects." src="https://habrastorage.org/getpro/habr/post_images/3d0/ff0/1c5/3d0ff01c5518558c2d3c5c5f47ce0ce9.png" alt="   ."> <br> <br>    ,   ,          ‚Äì       ,      ,   ‚Äì     .   ,        ,    ,    UI            . <br> <br>       MVVM,     ,       ,         .         ,        ,    ,   . <br> <br>  Prism       <code>IInteractionRequest</code>   <code><code>InteractionRequest .  IInteractionRequest</code>  ,   .           ,   .  <code><code>InteractionRequest   IInteractionRequest</code>     <code>Raise</code> ,           , , ,   . <br> <br>       <br>  <code><code>InteractionRequest          .  Raise</code>          ( <code>T</code> )    ,    ,   .          ,       .      ,        .    ,  ,     . <br> <code class="cs">public interface IInteractionRequest { event EventHandler&lt;InteractionRequestedEventArgs&gt; Raised; } public class InteractionRequest&lt;T&gt; : IInteractionRequest { public event EventHandler&lt;InteractionRequestedEventArgs&gt; Raised; public void Raise(T context, Action&lt;T&gt; callback) { var handler = this.Raised; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (handler != null) { handler( this, new InteractionRequestedEventArgs(context, () =&gt; callback(context))); } } }</code> <br> Prism    ,      .  <code>Notification</code>       .    ,            .     ‚Äì <code>Title</code>  <code>Content</code> ,    .  ,   ,  ,  ,        . <br> <br>  <code>Confirmation</code>    <code>Notification</code>     ‚Äì <code>Confirmed</code> ,  ,  ,      .  <code>Confirmation</code> ,     <code>MessageBox</code> ,     /  .     ,     <code>Notification</code> ,     ,      . <br> <br>    <code><code><code>InteractionRequest ,       InteractionRequest      ,      .      ,    Raise</code> ,    , ,   . <br> <br> <code class="cs">public IInteractionRequest ConfirmCancelInteractionRequest { get { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> this.confirmCancelInteractionRequest; } } this.confirmCancelInteractionRequest.Raise( new Confirmation(<span class="hljs-string"><span class="hljs-string">"Are you sure you wish to cancel?"</span></span>), confirmation =&gt; { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (confirmation.Confirmed) { this.NavigateToQuestionnaireList(); } }); }</code> <br> <i>MVVM Reference Implementation (MVVM RI)</i> ,    <code>IInteractionRequest</code>   <code><code>InteractionRequest ,          (. QuestionnaireViewModel.cs</code> ). <br> <br>        <br>       ,       .   ,       .    UI             . <br> <br>                . Microsoft Expression Blend Behaviors Framework     .  ,     ,    . <br> <br>  <code>EventTrigger</code> ,  Expression Blend,  ,      ,     ,   . , Prism   <code>EventTrigger</code> ,  <code>InteractionRequestTrigger</code> ,      <code>Raised</code>   <code>IInteractionRequest</code> .    XAML        . <br> <br>  ,   , <code>InteractionRequestTrigger</code>   .  Silverlight Prism   <code>PopupChildWindowAction</code> ,     .    ,         .   <code>ContentTemplate</code>  <code>PopupChildWindowAction</code> ,    ,    UI,      <code>Content</code>  .       <code>Title</code>  . <br> <b></b> <br>  ,    ,   <code>PopupChildWindowAction</code> ,     .    <code>Notification</code>  <code>NotificationChildWindow</code> ,        <code>Confirmation</code> ‚Äì <code>ConfirmationChildWindow</code> . <code>NotificationChildWindow</code>    ,   ,     <code>ConfirmationChildWindow</code>    <i>OK</i>  <i>Cancel</i> ,    .    ,   ,   <code>ChildWindow</code>  <code>PopupChildWindowAction</code> . <br>   ,  <code>InteractionRequestTrigger</code>  <code>PopupChildWindowAction</code> ,       <i>RI MVVM</i> . <br> <br> <code class="xml">&lt;i:Interaction.Triggers&gt; &lt;prism:InteractionRequestTrigger SourceObject=<span class="hljs-string"><span class="hljs-string">"{Binding ConfirmCancelInteractionRequest}"</span></span>&gt; &lt;prism:PopupChildWindowAction ContentTemplate=<span class="hljs-string"><span class="hljs-string">"{StaticResource ConfirmWindowTemplate}"</span></span>/&gt; &lt;/prism:InteractionRequestTrigger&gt; &lt;/i:Interaction.Triggers&gt; &lt;UserControl.Resources&gt; &lt;DataTemplate x:Key=<span class="hljs-string"><span class="hljs-string">"ConfirmWindowTemplate"</span></span>&gt; &lt;Grid MinWidth=<span class="hljs-string"><span class="hljs-string">"250"</span></span> MinHeight=<span class="hljs-string"><span class="hljs-string">"100"</span></span>&gt; &lt;TextBlock TextWrapping=<span class="hljs-string"><span class="hljs-string">"Wrap"</span></span> Grid.Row=<span class="hljs-string"><span class="hljs-string">"0"</span></span> Text=<span class="hljs-string"><span class="hljs-string">"{Binding}"</span></span>/&gt; &lt;/Grid&gt; &lt;/DataTemplate&gt; &lt;/UserControl.Resources&gt;</code> <br> <b></b> <br>      <code>ContentTemplate</code> ,   UI   <code>Content</code>  .    <code>Content</code>  ,  , <code>TextBlock</code>     <code>Content</code> . <br>      ,     ,    ,    .  ,     ,       ,     ,    .   ,   <i>RI MVVM</i> ,         <code>Confirmed</code>    <code>Confirmation</code>  <code><span class="hljs-keyword"><span class="hljs-keyword">true</span></span></code> ,     OK. <br> <br>        ,     .  Prism <code>InteractionRequestTrigger</code>   <code>PopupChildWindowAction</code>            . <br> <br>     <br>     MVVM,       , ,    ,         .        (  , ,  ,   ).    ,  ,  ,            . <br> <br>        ,         . Managed Extensibility Framework (MEF)  Unity Application Block (Unity)      ,  ,           . <br> <br>  ,       , , ,    ( )      . ,       ,     .  ,     ,       . <br> <br>     ,  MEF <br>  MEF,       ,   <code>Import</code> ,      ,  ,   <code><span class="hljs-keyword"><span class="hljs-keyword">Export</span></span></code> .         ,    . <br> <br> , <code>QuestionnaireView</code>   <i>RI MVVM</i> ,        ,    <code>Import</code> .   , MEF           .  <code><span class="hljs-keyword"><span class="hljs-keyword">set</span></span></code>        ,   . <br> <br> <code class="cs">[Import] public QuestionnaireViewModel ViewModel { <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> { this.DataContext = value; } }</code> <br>     ,   . <br> <br> <code class="cs">[<span class="hljs-keyword"><span class="hljs-keyword">Export</span></span>] public class QuestionnaireViewModel : NotificationObject { ... }</code> <br>        ,   . <br> <br> <code class="cs">public QuestionnaireView() { InitializeComponent(); } [ImportingConstructor] public QuestionnaireView(QuestionnaireViewModel viewModel) : this() { this.DataContext = viewModel; }</code> <br> <b></b> <br>          MEF,   Unity.   ,     ,        .   ,   Visual Studio  Expression Blend, ,        ,     .   ,   ,  ,      ,          <code>InitializeComponent</code> . <br>     ,  Unity <br>  Unity,    ,   MEF.     ,      .    ,         .  ,      . <br> <br>  ,      ,  ,         . ,           ,   . <br> <br> <code class="cs">public QuestionnaireView() { InitializeComponent(); } public QuestionnaireView(QuestionnaireViewModel viewModel) : this() { this.DataContext = viewModel; }</code> <br> <b></b> <br>    ,        ,   Visual Studio  Expression Blend. <br>  ,          ,   . Unity        <code><span class="hljs-keyword"><span class="hljs-keyword">set</span></span></code>   ,   . <br> <br> <code class="cs">public QuestionnaireView() { InitializeComponent(); } [Dependency] public QuestionnaireViewModel ViewModel { <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> { this.DataContext = value; } }</code> <br>       Unity. <br> <br> <code class="cs">container.RegisterType&lt;QuestionnaireViewModel&gt;();</code> <br>  ,     . <br> <br> <code class="cs">var view = container.Resolve&lt;QuestionnaireView&gt;();</code> <br>     ,    <br>   ,     ,        .        ,   MEF  Unity,        . <br> <br>          .   ,         UI,           . <br> <br> , <i>RI MVVM</i>   ,   ,        .   ,    .      <code>ShowView</code>   UI. <br> <br> <code class="cs">private void NavigateToQuestionnaireList() { //     <span class="hljs-string"><span class="hljs-string">"questionnaire list"</span></span>. this.uiService.ShowView(ViewNames.QuestionnaireTemplatesList); }</code> <br>  UI      UI .           UI.  <code>ShowView</code>  <code>UIService</code>      (,          ),       ,   . <br> <br> <code class="cs">public void ShowView(<span class="hljs-keyword"><span class="hljs-keyword">string</span></span> viewName) { var view = this.ViewFactory.GetView(viewName); this.MainWindow.CurrentView = view; }</code> <br> <b></b> <br> Prism       .   ,   ,   ,             .    ,  , <span class="hljs-string"><span class="hljs-string">" </span></span><a href="http://msdn.microsoft.com/en-us/library/gg430861(v%3DPandP.40).aspx"><span class="hljs-string"><span class="hljs-string">View-Based Navigation</span></span></a><span class="hljs-string"><span class="hljs-string"> "</span></span>   <span class="hljs-number"><span class="hljs-number">8</span></span>, <span class="hljs-string"><span class="hljs-string">" </span></span><a href="http://msdn.microsoft.com/en-us/library/gg430861(v%3DPandP.40).aspx"><span class="hljs-string"><span class="hljs-string">Navigation</span></span></a><span class="hljs-string"><span class="hljs-string"> "</span></span>. <br>  MVVM  <br>        MVVM      .           -      mocking . ,   ,        . <br> <br>   <i>INotifyPropertyChanged</i> <br>   <code>INotifyPropertyChanged</code>     ,      .      ,    ;   ,   ,     ,    ,       . <br> <br>   <br> ,       ,           <code>PropertyChanged</code>  ,         .  ,    <code>ChangeTracker</code> ,     MVVM,  ,      .      .     ,    . <br> <br> <code class="cs">var changeTracker = new PropertyChangeTracker(viewModel); viewModel.CurrentState = <span class="hljs-string"><span class="hljs-string">"newState"</span></span>; CollectionAssert.Contains(changeTracker.ChangedProperties, <span class="hljs-string"><span class="hljs-string">"CurrentState"</span></span>);</code> <br> ,     ,     <code>INotifyPropertyChanged</code> ,    ,   ,     . <br> <br>      <br>        ,   ,    <code><span class="hljs-keyword"><span class="hljs-keyword">set</span></span></code>      ,           . ,     ,     ,      ,          . <br> <br> <code class="cs">var changeTracker = new PropertyChangeTracker(viewModel); var question = viewModel.Questions.First() as OpenQuestionViewModel; question.Question.Response = <span class="hljs-string"><span class="hljs-string">"some text"</span></span>; CollectionAssert.Contains(changeTracker.ChangedProperties, <span class="hljs-string"><span class="hljs-string">"UnansweredQuestions"</span></span>);</code> <br>      <br>     <code>INotifyPropertyChanged</code> ,      <code>PropertyChanged</code>        ,  ,     , , .        ,       . <br> <br>   <i>INotifyDataErrorInfo</i> <br>   ,     ,    ,   ,   <code>IDataErrorInfo</code> ,  ( Silverlight)   <code>INotifyDataErrorInfo</code> .   <code>INotifyDataErrorInfo</code>   ,         ,    ,  ,   ,    . <br> <br>       <code>INotifyDataErrorInfo</code> : ,     ,  ,     ,     <code>ErrorsChanged</code> ,      <code>GetErrors</code> , . <br> <br>    <br>     ,      ,     .       ,         <code>GetErrors</code>       ,  ,  ,   .    , ,  ,     ,        .   ,        . <br> <br> <code class="cs">//  . var notifyErrorInfo = (INotifyDataErrorInfo)question; question.Response = -<span class="hljs-number"><span class="hljs-number">15</span></span>; Assert.IsTrue(notifyErrorInfo.GetErrors(<span class="hljs-string"><span class="hljs-string">"Response"</span></span>).Cast&lt;ValidationResult&gt;().Any()); //  . var notifyErrorInfo = (INotifyDataErrorInfo)question; question.Response = <span class="hljs-number"><span class="hljs-number">15</span></span>; Assert.IsFalse(notifyErrorInfo.GetErrors(<span class="hljs-string"><span class="hljs-string">"Response"</span></span>).Cast&lt;ValidationResult&gt;().Any());</code> <br>    ,    ,             . <br> <br>    <i>INotifyDataErrorInfo</i> <br>       <code>GetErrors</code> ,   <code>INotifyDataErrorInfo</code>  ,   <code>ErrorsChanged</code>      <code>GetErrors</code> . ,  <code>HasErrors</code>      ,  . <br> <br>       <code>INotifyDataErrorInfo</code> . , ,           ,   -  .      ,        <code>INotifyDataErrorInfo</code>         (,        ). <br> <br>     ,   ,  : <br>  <code>HasErrors</code>     .              ,       .  <code>ErrorsChanged</code> ,      ,         <code>GetErrors</code> .         ( ,  )     ,           .    <code>GetErrors</code>       <code>ErrorsChanged</code> . <br>    <code>INotifyPropertyChanged</code> ,  ,    <code>NotifyDataErrorInfoTestHelper</code>    MVVM,        <code>INotifyDataErrorInfo</code> ,       .   ,   ,      ,   .      . <br> <code class="cs">var helper = new NotifyDataErrorInfoTestHelper&lt;NumericQuestion, int?&gt;( question, q =&gt; q.Response); helper.ValidatePropertyChange( <span class="hljs-number"><span class="hljs-number">6</span></span>, NotifyDataErrorInfoBehavior.Nothing); helper.ValidatePropertyChange( <span class="hljs-number"><span class="hljs-number">20</span></span>, NotifyDataErrorInfoBehavior.FiresErrorsChanged | NotifyDataErrorInfoBehavior.HasErrors | NotifyDataErrorInfoBehavior.HasErrorsForProperty); helper.ValidatePropertyChange( null, NotifyDataErrorInfoBehavior.FiresErrorsChanged | NotifyDataErrorInfoBehavior.HasErrors | NotifyDataErrorInfoBehavior.HasErrorsForProperty); helper.ValidatePropertyChange( <span class="hljs-number"><span class="hljs-number">2</span></span>, NotifyDataErrorInfoBehavior.FiresErrorsChanged);</code> <br>     <br>   MVVM,     ,  .   ,    ,         . <br> <br>  ,     ,     ,       .   ,   , ,       ,     ,   <code>IAsyncResult</code>    ,  - ,   ,    UI. <br> <br>       , , ,    .   ,     .  ,      UI,     ,   ,          ,     ,        <span class="hljs-string"><span class="hljs-string">"   UI."</span></span> <br> <br>     ,    ,    .   ,    ,     mock-, ,   ,   ,      ,          . <br> <br>           UI,    ,    .   ,     ,   ,      .        ,   .     ,    ,     . <br> <br> <code class="cs">questionnaireRepositoryMock .Setup( r =&gt; r.SubmitQuestionnaireAsync( It.IsAny&lt;Questionnaire&gt;(), It.IsAny&lt;Action&lt;IOperationResult&gt;&gt;())) .Callback&lt;Questionnaire, Action&lt;IOperationResult&gt;&gt;( (q, a) =&gt; callback = a); uiServicemock .Setup(svc =&gt; svc.ShowView(ViewNames.QuestionnaireTemplatesList)) .Callback&lt;<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>&gt;(viewName =&gt; requestedViewName = viewName); submitResultMock .Setup(sr =&gt; sr.Error) .Returns&lt;Exception&gt;(null); CompleteQuestionnaire(viewModel); viewModel.Submit(); //      UI . callback(submitResultMock.Object); //    ‚Äì     . Assert.AreEqual(ViewNames.QuestionnaireTemplatesList, requestedViewName);</code> <br> <b></b> <br>          ,        . <br>   <br>       , . <span class="hljs-string"><span class="hljs-string">"Trees in WPF"</span></span>  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ms753391.aspx">http://msdn.microsoft.com/en-us/library/ms753391.aspx</a> <br> <br>       , . <span class="hljs-string"><span class="hljs-string">"Attached Properties Overview"</span></span>  MSDN: <a href="http://msdn.microsoft.com/en-us/library/cc265152(VS.95).aspx">http://msdn.microsoft.com/en-us/library/cc265152(VS.<span class="hljs-number"><span class="hljs-number">95</span></span>).aspx</a> <br> <br>      MEF, .<span class="hljs-string"><span class="hljs-string">"Managed Extensibility Framework Overview"</span></span>  MSDN: <a href="http://msdn.microsoft.com/en-us/library/dd460648.aspx">http://msdn.microsoft.com/en-us/library/dd460648.aspx</a> . <br> <br>      Unity, .<span class="hljs-string"><span class="hljs-string">"Unity Application Block"</span></span>  MSDN: <a href="http://www.msdn.com/unity">http://www.msdn.com/unity</a> . <br> <br>      <code>DelegateCommand</code> , .Chapter <span class="hljs-number"><span class="hljs-number">5</span></span>, <span class="hljs-string"><span class="hljs-string">" </span></span><a href="http://msdn.microsoft.com/en-us/library/gg405484(v%3DPandP.40).aspx"><span class="hljs-string"><span class="hljs-string">Implementing the MVVM Pattern</span></span></a><span class="hljs-string"><span class="hljs-string"> ."</span></span> <br> <br>        Microsoft Expression Blend, .<span class="hljs-string"><span class="hljs-string">"Working with built-in behaviors"</span></span>  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ff724013(v%3DExpression.40).aspx">http://msdn.microsoft.com/en-us/library/ff724013(v=Expression.<span class="hljs-number"><span class="hljs-number">40</span></span>).aspx</a> . <br> <br>          Microsoft Expression Blend, .<span class="hljs-string"><span class="hljs-string">"Creating Custom Behaviors"</span></span>  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ff724708(v%3DExpression.40).aspx">http://msdn.microsoft.com/en-us/library/ff724708(v=Expression.<span class="hljs-number"><span class="hljs-number">40</span></span>).aspx</a> . <br> <br>            Microsoft Expression Blend, .<span class="hljs-string"><span class="hljs-string">"Creating Custom Triggers and Actions"</span></span>  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ff724707(v%3DExpression.40).aspx">http://msdn.microsoft.com/en-us/library/ff724707(v=Expression.<span class="hljs-number"><span class="hljs-number">40</span></span>).aspx</a> . <br> <br>         WPF  Silverlight, .<span class="hljs-string"><span class="hljs-string">"Threading Model"</span></span>  <span class="hljs-string"><span class="hljs-string">"The Dispatcher Class"</span></span>  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ms741870.aspx">http://msdn.microsoft.com/en-us/library/ms741870.aspx</a> <br> <a href="http://msdn.microsoft.com/en-us/library/ms615907(v%3DVS.95).aspx">http://msdn.microsoft.com/en-us/library/ms615907(v=VS.<span class="hljs-number"><span class="hljs-number">95</span></span>).aspx</a> . <br> <br>      unit-  Silverlight, .<span class="hljs-string"><span class="hljs-string">"Unit Testing with Silverlight 2"</span></span>: <a href="http://www.jeff.wilcox.name/2008/03/silverlight2-unit-testing/">http://www.jeff.wilcox.name/<span class="hljs-number"><span class="hljs-number">2008</span></span>/<span class="hljs-number"><span class="hljs-number">03</span></span>/silverlight2-unit-testing/</a> . <br> <br>         , .  <span class="hljs-string"><span class="hljs-string">" </span></span><a href="http://msdn.microsoft.com/en-us/library/gg430861(v%3DPandP.40).aspx"><span class="hljs-string"><span class="hljs-string">View-Based Navigation</span></span></a><span class="hljs-string"><span class="hljs-string"> "</span></span> in Chapter <span class="hljs-number"><span class="hljs-number">8</span></span>, <span class="hljs-string"><span class="hljs-string">" </span></span><a href="http://msdn.microsoft.com/en-us/library/gg430861(v%3DPandP.40).aspx"><span class="hljs-string"><span class="hljs-string">Navigation</span></span></a><span class="hljs-string"><span class="hljs-string"> ."</span></span> <br> <br>       ,   , .<span class="hljs-string"><span class="hljs-string">"Event-based Asynchronous Pattern Overview"</span></span>  MSDN: <a href="http://msdn.microsoft.com/en-us/library/wewwczdw.aspx">http://msdn.microsoft.com/en-us/library/wewwczdw.aspx</a> <br> <br>        <code>IAsyncResult</code> , .<span class="hljs-string"><span class="hljs-string">"Asynchronous Programming Overview"</span></span>  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ms228963.aspx">http://msdn.microsoft.com/en-us/library/ms228963.aspx</a></code></code></code></code></code></code></code></code></code> </pre> <code><code><code><code><code><code><code><code><code><code>CommandBehaviorBase ,    ,    ICommand</code> .           <code>CanExecuteChanged</code> ,          Silverlight,    WPF. <br> <br>    ,  ,   <code>CommandBehaviorBase    ,    .         ,      .         ,    .      ButtonBaseClickCommandBehavior</code> . <br> <br> <code class="cs">public class ButtonBaseClickCommandBehavior : CommandBehaviorBase&lt;ButtonBase&gt; { public ButtonBaseClickCommandBehavior(ButtonBase clickableObject) : base(clickableObject) { clickableObject.Click += OnClick; } private void OnClick(object sender, System.Windows.RoutedEventArgs e) { ExecuteCommand(); } }</code> <br>   <code>CommandBehaviorBase ,     .     ,          ,   . ,    ,    ,      , ,    CanExecute</code>  ,     . <br> <br>          ,   .           XAML.           .       .  Prism      ,       ,  ,   .       ,    . , ,  ,      <code>Click</code> ,       <code>Command</code> .    <code>Click.Command</code> ,  . <br> <br>             .             . <br> <br> <code class="cs">public static readonly DependencyProperty CommandProperty = DependencyProperty.RegisterAttached( "Command", typeof(ICommand), typeof(Click), new PropertyMetadata(OnSetCommandCallback)); private static readonly DependencyProperty ClickCommandBehaviorProperty = DependencyProperty.RegisterAttached( "ClickCommandBehavior", typeof(ButtonBaseClickCommandBehavior), typeof(Click), null);</code> <br>    <code>Command</code>    <code>ButtonBaseClickCommandBehavior</code> ,     <code>OnSetCommandCallback</code> ,     . <br> <br> <code class="cs">private static void OnSetCommandCallback(DependencyObject dependencyObject, DependencyPropertyChangedEventArgs e) { ButtonBase buttonBase = dependencyObject as ButtonBase; if (buttonBase != null) { ButtonBaseClickCommandBehavior behavior = GetOrCreateBehavior(buttonBase); behavior.Command = e.NewValue as ICommand; } } private static void OnSetCommandParameterCallback(DependencyObject dependencyObject, DependencyPropertyChangedEventArgs e) { ButtonBase buttonBase = dependencyObject as ButtonBase; if (buttonBase != null) { ButtonBaseClickCommandBehavior behavior = GetOrCreateBehavior(buttonBase); behavior.CommandParameter = e.NewValue; } } private static ButtonBaseClickCommandBehavior GetOrCreateBehavior(ButtonBase buttonBase ) { ButtonBaseClickCommandBehavior behavior = buttonBase.GetValue(ClickCommandBehaviorProperty) as ButtonBaseClickCommandBehavior; if ( behavior == null ) { behavior = new ButtonBaseClickCommandBehavior(buttonBase); buttonBase.SetValue(ClickCommandBehaviorProperty, behavior); } return behavior; }</code> <br>        ,  <a href="http://msdn.microsoft.com/en-us/library/cc265152(VS.95).aspx">Attached Properties Overview</a>  MSDN. <br> <br>    <br>              . ,     Silverlight,    -,     ,      ,     .     ,       . <br> <br>        ,    ( )  ,  ,     .  UI       ,            UI. <br> <br>      - <br>   -     ,       <code>IAsyncResult</code> .   ,  ,   ,  <code>GetQuestionnaire</code> ,   : <code>BeginGetQuestionnaire</code>  <code>EndGetQuestionnaire</code> .    ,   <code>BeginGetQuestionnaire</code> .     ,   ,   <code>EndGetQuestionnaire</code>    . <br> <b></b> <br>  .NET Framework 4.5      <code>await</code>  <code>async</code>     <code>*Async</code> .      <a href="http://msdn.microsoft.com/en-us/library/vstudio/hh391443.aspx">"Asynchronous Programming with Async and Await (C# and Visual Basic)"</a> . <br>  ,    <code>EndGetQuestionnaire</code> ,      ,  ()      <code>BeginGetQuestionnaire</code> .     ,      ,   <code>EndGetQuestionnaire</code> ,   . <br> <br> <code class="xml">IAsyncResult asyncResult = this.service.BeginGetQuestionnaire( GetQuestionnaireCompleted, null //  ,      ); private void GetQuestionnaireCompleted(IAsyncResult result) { try { questionnaire = this.service.EndGetQuestionnaire(ar); } catch (Exception ex) { //  -   . } }</code> <br>  ,     <code>End*</code> (  , <code>EndGetQuestionnaire</code> ),    ,      .      , ,          UI.     ,   ,        . <br> <br>        UI,     -,      UI,         UI,   <code>Dispatcher</code>    <code>SynchronizationContext</code> .  WPF  Silverlight,   <code>Dispatcher</code> . <br> <br>      <code>Questionnaire</code>  ,        <code>QuestionnaireView</code> .  Silverlight    <code>CheckAccess</code> ,  ,      UI.  ,     <code>BeginInvoke</code> ,      UI. <br> <br> <code class="cs">var dispatcher = System.Windows.Deployment.Current.Dispatcher; if (dispatcher.CheckAccess()) { QuestionnaireView.DataContext = questionnaire; } else { dispatcher.BeginInvoke(() =&gt; { Questionnaire.DataContext = questionnaire; }); }</code> <br> <i>MVVM RI</i>   ,    ,   <code>IAsyncResult</code> ,   .      ,                 . ,       . <br> <br> <code class="cs">this.questionnaireRepository.GetQuestionnaireAsync( result =&gt; { this.Questionnaire = result.Result; });</code> <br>  <code>result</code>   ,     , , , .    ,     . <br> <br> <code class="cs">this.questionnaireRepository.GetQuestionnaireAsync( result =&gt; { if (result.Error == null) { this.Questionnaire = result.Result; ... } else { // Handle error. } })</code> <br>     <br>        ,      .     , ,             .        ,      ,     ,     . <br> <br>         ,      MVVM,     ,   . ,  -MVVM ,     <code>MessageBox</code>   code-behind UI,      .   MVVM     ,          . <br> <br>     MVVM,              ,          .      ,    ,   ,  ,     . <br> <br>              MVVM.      ,     ,     ,  ,     .    ,         ,     ,          .       . <br> <br>    <br>                  .        ,        .  ,         .         . <br> <br>  ,         ,         ,  .      ,     .           ,       . ,        WPF  Silverlight,        . <br> <br> <img title="Using the service to interact with the user." src="https://habrastorage.org/getpro/habr/post_images/4b5/397/f2d/4b5397f2d02e5851195b29f1893be6fc.png" alt=" ,    ."> <br> <br>  ,   <code>MessageBox</code>        ,     ,    ,     . <br> <br> <code class="cs">var result = interactionService.ShowMessageBox( "Are you sure you want to cancel this operation?", "Confirm", MessageBoxButton.OK); if (result == MessageBoxResult.Yes) { CancelRequest(); }</code> <br> ,      - ,      ,         Silverlight.         .             .     . <br> <br> <code class="cs">interactionService.ShowMessageBox( "Are you sure you want to cancel this operation?", "Confirm", MessageBoxButton.OK, result =&gt; { if (result == MessageBoxResult.Yes) { CancelRequest(); } });</code> <br>         ,      . ,  WPF    <code>MessageBox</code> ,       ;    Silverlight    ,    . <br> <br>     <br>         ‚Äì             .         ,      .     ,     .        ,        ,   ,     . <br> <br> <img title="Using interaction request objects." src="https://habrastorage.org/getpro/habr/post_images/3d0/ff0/1c5/3d0ff01c5518558c2d3c5c5f47ce0ce9.png" alt="   ."> <br> <br>    ,   ,          ‚Äì       ,      ,   ‚Äì     .   ,        ,    ,    UI            . <br> <br>       MVVM,     ,       ,         .         ,        ,    ,   . <br> <br>  Prism       <code>IInteractionRequest</code>   <code>InteractionRequest .  IInteractionRequest</code>  ,   .           ,   .  <code>InteractionRequest   IInteractionRequest</code>     <code>Raise</code> ,           , , ,   . <br> <br>       <br>  <code>InteractionRequest          .  Raise</code>          ( <code>T</code> )    ,    ,   .          ,       .      ,        .    ,  ,     . <br> <code class="cs">public interface IInteractionRequest { event EventHandler&lt;InteractionRequestedEventArgs&gt; Raised; } public class InteractionRequest&lt;T&gt; : IInteractionRequest { public event EventHandler&lt;InteractionRequestedEventArgs&gt; Raised; public void Raise(T context, Action&lt;T&gt; callback) { var handler = this.Raised; if (handler != null) { handler( this, new InteractionRequestedEventArgs(context, () =&gt; callback(context))); } } }</code> <br> Prism    ,      .  <code>Notification</code>       .    ,            .     ‚Äì <code>Title</code>  <code>Content</code> ,    .  ,   ,  ,  ,        . <br> <br>  <code>Confirmation</code>    <code>Notification</code>     ‚Äì <code>Confirmed</code> ,  ,  ,      .  <code>Confirmation</code> ,     <code>MessageBox</code> ,     /  .     ,     <code>Notification</code> ,     ,      . <br> <br>    <code>InteractionRequest ,       InteractionRequest      ,      .      ,    Raise</code> ,    , ,   . <br> <br> <code class="cs">public IInteractionRequest ConfirmCancelInteractionRequest { get { return this.confirmCancelInteractionRequest; } } this.confirmCancelInteractionRequest.Raise( new Confirmation("Are you sure you wish to cancel?"), confirmation =&gt; { if (confirmation.Confirmed) { this.NavigateToQuestionnaireList(); } }); }</code> <br> <i>MVVM Reference Implementation (MVVM RI)</i> ,    <code>IInteractionRequest</code>   <code>InteractionRequest ,          (. QuestionnaireViewModel.cs</code> ). <br> <br>        <br>       ,       .   ,       .    UI             . <br> <br>                . Microsoft Expression Blend Behaviors Framework     .  ,     ,    . <br> <br>  <code>EventTrigger</code> ,  Expression Blend,  ,      ,     ,   . , Prism   <code>EventTrigger</code> ,  <code>InteractionRequestTrigger</code> ,      <code>Raised</code>   <code>IInteractionRequest</code> .    XAML        . <br> <br>  ,   , <code>InteractionRequestTrigger</code>   .  Silverlight Prism   <code>PopupChildWindowAction</code> ,     .    ,         .   <code>ContentTemplate</code>  <code>PopupChildWindowAction</code> ,    ,    UI,      <code>Content</code>  .       <code>Title</code>  . <br> <b></b> <br>  ,    ,   <code>PopupChildWindowAction</code> ,     .    <code>Notification</code>  <code>NotificationChildWindow</code> ,        <code>Confirmation</code> ‚Äì <code>ConfirmationChildWindow</code> . <code>NotificationChildWindow</code>    ,   ,     <code>ConfirmationChildWindow</code>    <i>OK</i>  <i>Cancel</i> ,    .    ,   ,   <code>ChildWindow</code>  <code>PopupChildWindowAction</code> . <br>   ,  <code>InteractionRequestTrigger</code>  <code>PopupChildWindowAction</code> ,       <i>RI MVVM</i> . <br> <br> <code class="xml">&lt;i:Interaction.Triggers&gt; &lt;prism:InteractionRequestTrigger SourceObject="{Binding ConfirmCancelInteractionRequest}"&gt; &lt;prism:PopupChildWindowAction ContentTemplate="{StaticResource ConfirmWindowTemplate}"/&gt; &lt;/prism:InteractionRequestTrigger&gt; &lt;/i:Interaction.Triggers&gt; &lt;UserControl.Resources&gt; &lt;DataTemplate x:Key="ConfirmWindowTemplate"&gt; &lt;Grid MinWidth="250" MinHeight="100"&gt; &lt;TextBlock TextWrapping="Wrap" Grid.Row="0" Text="{Binding}"/&gt; &lt;/Grid&gt; &lt;/DataTemplate&gt; &lt;/UserControl.Resources&gt;</code> <br> <b></b> <br>      <code>ContentTemplate</code> ,   UI   <code>Content</code>  .    <code>Content</code>  ,  , <code>TextBlock</code>     <code>Content</code> . <br>      ,     ,    ,    .  ,     ,       ,     ,    .   ,   <i>RI MVVM</i> ,         <code>Confirmed</code>    <code>Confirmation</code>  <code>true</code> ,     OK. <br> <br>        ,     .  Prism <code>InteractionRequestTrigger</code>   <code>PopupChildWindowAction</code>            . <br> <br>     <br>     MVVM,       , ,    ,         .        (  , ,  ,   ).    ,  ,  ,            . <br> <br>        ,         . Managed Extensibility Framework (MEF)  Unity Application Block (Unity)      ,  ,           . <br> <br>  ,       , , ,    ( )      . ,       ,     .  ,     ,       . <br> <br>     ,  MEF <br>  MEF,       ,   <code>Import</code> ,      ,  ,   <code>Export</code> .         ,    . <br> <br> , <code>QuestionnaireView</code>   <i>RI MVVM</i> ,        ,    <code>Import</code> .   , MEF           .  <code>set</code>        ,   . <br> <br> <code class="cs">[Import] public QuestionnaireViewModel ViewModel { set { this.DataContext = value; } }</code> <br>     ,   . <br> <br> <code class="cs">[Export] public class QuestionnaireViewModel : NotificationObject { ... }</code> <br>        ,   . <br> <br> <code class="cs">public QuestionnaireView() { InitializeComponent(); } [ImportingConstructor] public QuestionnaireView(QuestionnaireViewModel viewModel) : this() { this.DataContext = viewModel; }</code> <br> <b></b> <br>          MEF,   Unity.   ,     ,        .   ,   Visual Studio  Expression Blend, ,        ,     .   ,   ,  ,      ,          <code>InitializeComponent</code> . <br>     ,  Unity <br>  Unity,    ,   MEF.     ,      .    ,         .  ,      . <br> <br>  ,      ,  ,         . ,           ,   . <br> <br> <code class="cs">public QuestionnaireView() { InitializeComponent(); } public QuestionnaireView(QuestionnaireViewModel viewModel) : this() { this.DataContext = viewModel; }</code> <br> <b></b> <br>    ,        ,   Visual Studio  Expression Blend. <br>  ,          ,   . Unity        <code>set</code>   ,   . <br> <br> <code class="cs">public QuestionnaireView() { InitializeComponent(); } [Dependency] public QuestionnaireViewModel ViewModel { set { this.DataContext = value; } }</code> <br>       Unity. <br> <br> <code class="cs">container.RegisterType&lt;QuestionnaireViewModel&gt;();</code> <br>  ,     . <br> <br> <code class="cs">var view = container.Resolve&lt;QuestionnaireView&gt;();</code> <br>     ,    <br>   ,     ,        .        ,   MEF  Unity,        . <br> <br>          .   ,         UI,           . <br> <br> , <i>RI MVVM</i>   ,   ,        .   ,    .      <code>ShowView</code>   UI. <br> <br> <code class="cs">private void NavigateToQuestionnaireList() { //     "questionnaire list". this.uiService.ShowView(ViewNames.QuestionnaireTemplatesList); }</code> <br>  UI      UI .           UI.  <code>ShowView</code>  <code>UIService</code>      (,          ),       ,   . <br> <br> <code class="cs">public void ShowView(string viewName) { var view = this.ViewFactory.GetView(viewName); this.MainWindow.CurrentView = view; }</code> <br> <b></b> <br> Prism       .   ,   ,   ,             .    ,  , " <a href="http://msdn.microsoft.com/en-us/library/gg430861(v%3DPandP.40).aspx">View-Based Navigation</a> "   8, " <a href="http://msdn.microsoft.com/en-us/library/gg430861(v%3DPandP.40).aspx">Navigation</a> ". <br>  MVVM  <br>        MVVM      .           -      mocking . ,   ,        . <br> <br>   <i>INotifyPropertyChanged</i> <br>   <code>INotifyPropertyChanged</code>     ,      .      ,    ;   ,   ,     ,    ,       . <br> <br>   <br> ,       ,           <code>PropertyChanged</code>  ,         .  ,    <code>ChangeTracker</code> ,     MVVM,  ,      .      .     ,    . <br> <br> <code class="cs">var changeTracker = new PropertyChangeTracker(viewModel); viewModel.CurrentState = "newState"; CollectionAssert.Contains(changeTracker.ChangedProperties, "CurrentState");</code> <br> ,     ,     <code>INotifyPropertyChanged</code> ,    ,   ,     . <br> <br>      <br>        ,   ,    <code>set</code>      ,           . ,     ,     ,      ,          . <br> <br> <code class="cs">var changeTracker = new PropertyChangeTracker(viewModel); var question = viewModel.Questions.First() as OpenQuestionViewModel; question.Question.Response = "some text"; CollectionAssert.Contains(changeTracker.ChangedProperties, "UnansweredQuestions");</code> <br>      <br>     <code>INotifyPropertyChanged</code> ,      <code>PropertyChanged</code>        ,  ,     , , .        ,       . <br> <br>   <i>INotifyDataErrorInfo</i> <br>   ,     ,    ,   ,   <code>IDataErrorInfo</code> ,  ( Silverlight)   <code>INotifyDataErrorInfo</code> .   <code>INotifyDataErrorInfo</code>   ,         ,    ,  ,   ,    . <br> <br>       <code>INotifyDataErrorInfo</code> : ,     ,  ,     ,     <code>ErrorsChanged</code> ,      <code>GetErrors</code> , . <br> <br>    <br>     ,      ,     .       ,         <code>GetErrors</code>       ,  ,  ,   .    , ,  ,     ,        .   ,        . <br> <br> <code class="cs">//  . var notifyErrorInfo = (INotifyDataErrorInfo)question; question.Response = -15; Assert.IsTrue(notifyErrorInfo.GetErrors("Response").Cast&lt;ValidationResult&gt;().Any()); //  . var notifyErrorInfo = (INotifyDataErrorInfo)question; question.Response = 15; Assert.IsFalse(notifyErrorInfo.GetErrors("Response").Cast&lt;ValidationResult&gt;().Any());</code> <br>    ,    ,             . <br> <br>    <i>INotifyDataErrorInfo</i> <br>       <code>GetErrors</code> ,   <code>INotifyDataErrorInfo</code>  ,   <code>ErrorsChanged</code>      <code>GetErrors</code> . ,  <code>HasErrors</code>      ,  . <br> <br>       <code>INotifyDataErrorInfo</code> . , ,           ,   -  .      ,        <code>INotifyDataErrorInfo</code>         (,        ). <br> <br>     ,   ,  : <br>  <code>HasErrors</code>     .              ,       .  <code>ErrorsChanged</code> ,      ,         <code>GetErrors</code> .         ( ,  )     ,           .    <code>GetErrors</code>       <code>ErrorsChanged</code> . <br>    <code>INotifyPropertyChanged</code> ,  ,    <code>NotifyDataErrorInfoTestHelper</code>    MVVM,        <code>INotifyDataErrorInfo</code> ,       .   ,   ,      ,   .      . <br> <code class="cs">var helper = new NotifyDataErrorInfoTestHelper&lt;NumericQuestion, int?&gt;( question, q =&gt; q.Response); helper.ValidatePropertyChange( 6, NotifyDataErrorInfoBehavior.Nothing); helper.ValidatePropertyChange( 20, NotifyDataErrorInfoBehavior.FiresErrorsChanged | NotifyDataErrorInfoBehavior.HasErrors | NotifyDataErrorInfoBehavior.HasErrorsForProperty); helper.ValidatePropertyChange( null, NotifyDataErrorInfoBehavior.FiresErrorsChanged | NotifyDataErrorInfoBehavior.HasErrors | NotifyDataErrorInfoBehavior.HasErrorsForProperty); helper.ValidatePropertyChange( 2, NotifyDataErrorInfoBehavior.FiresErrorsChanged);</code> <br>     <br>   MVVM,     ,  .   ,    ,         . <br> <br>  ,     ,     ,       .   ,   , ,       ,     ,   <code>IAsyncResult</code>    ,  - ,   ,    UI. <br> <br>       , , ,    .   ,     .  ,      UI,     ,   ,          ,     ,        "   UI." <br> <br>     ,    ,    .   ,    ,     mock-, ,   ,   ,      ,          . <br> <br>           UI,    ,    .   ,     ,   ,      .        ,   .     ,    ,     . <br> <br> <code class="cs">questionnaireRepositoryMock .Setup( r =&gt; r.SubmitQuestionnaireAsync( It.IsAny&lt;Questionnaire&gt;(), It.IsAny&lt;Action&lt;IOperationResult&gt;&gt;())) .Callback&lt;Questionnaire, Action&lt;IOperationResult&gt;&gt;( (q, a) =&gt; callback = a); uiServicemock .Setup(svc =&gt; svc.ShowView(ViewNames.QuestionnaireTemplatesList)) .Callback&lt;string&gt;(viewName =&gt; requestedViewName = viewName); submitResultMock .Setup(sr =&gt; sr.Error) .Returns&lt;Exception&gt;(null); CompleteQuestionnaire(viewModel); viewModel.Submit(); //      UI . callback(submitResultMock.Object); //    ‚Äì     . Assert.AreEqual(ViewNames.QuestionnaireTemplatesList, requestedViewName);</code> <br> <b></b> <br>          ,        . <br>   <br>       , . "Trees in WPF"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ms753391.aspx">http://msdn.microsoft.com/en-us/library/ms753391.aspx</a> <br> <br>       , . "Attached Properties Overview"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/cc265152(VS.95).aspx">http://msdn.microsoft.com/en-us/library/cc265152(VS.95).aspx</a> <br> <br>      MEF, ."Managed Extensibility Framework Overview"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/dd460648.aspx">http://msdn.microsoft.com/en-us/library/dd460648.aspx</a> . <br> <br>      Unity, ."Unity Application Block"  MSDN: <a href="http://www.msdn.com/unity">http://www.msdn.com/unity</a> . <br> <br>      <code>DelegateCommand</code> , .Chapter 5, " <a href="http://msdn.microsoft.com/en-us/library/gg405484(v%3DPandP.40).aspx">Implementing the MVVM Pattern</a> ." <br> <br>        Microsoft Expression Blend, ."Working with built-in behaviors"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ff724013(v%3DExpression.40).aspx">http://msdn.microsoft.com/en-us/library/ff724013(v=Expression.40).aspx</a> . <br> <br>          Microsoft Expression Blend, ."Creating Custom Behaviors"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ff724708(v%3DExpression.40).aspx">http://msdn.microsoft.com/en-us/library/ff724708(v=Expression.40).aspx</a> . <br> <br>            Microsoft Expression Blend, ."Creating Custom Triggers and Actions"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ff724707(v%3DExpression.40).aspx">http://msdn.microsoft.com/en-us/library/ff724707(v=Expression.40).aspx</a> . <br> <br>         WPF  Silverlight, ."Threading Model"  "The Dispatcher Class"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ms741870.aspx">http://msdn.microsoft.com/en-us/library/ms741870.aspx</a> <br> <a href="http://msdn.microsoft.com/en-us/library/ms615907(v%3DVS.95).aspx">http://msdn.microsoft.com/en-us/library/ms615907(v=VS.95).aspx</a> . <br> <br>      unit-  Silverlight, ."Unit Testing with Silverlight 2": <a href="http://www.jeff.wilcox.name/2008/03/silverlight2-unit-testing/">http://www.jeff.wilcox.name/2008/03/silverlight2-unit-testing/</a> . <br> <br>         , .  " <a href="http://msdn.microsoft.com/en-us/library/gg430861(v%3DPandP.40).aspx">View-Based Navigation</a> " in Chapter 8, " <a href="http://msdn.microsoft.com/en-us/library/gg430861(v%3DPandP.40).aspx">Navigation</a> ." <br> <br>       ,   , ."Event-based Asynchronous Pattern Overview"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/wewwczdw.aspx">http://msdn.microsoft.com/en-us/library/wewwczdw.aspx</a> <br> <br>        <code>IAsyncResult</code> , ."Asynchronous Programming Overview"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ms228963.aspx">http://msdn.microsoft.com/en-us/library/ms228963.aspx</a></code></code></code></code></code></code></code></code></code> <h4> <code><code><code><code><code><code><code><code><code><code>CommandBehaviorBase ,    ,    ICommand</code> .           <code>CanExecuteChanged</code> ,          Silverlight,    WPF. <br> <br>    ,  ,   <code>CommandBehaviorBase    ,    .         ,      .         ,    .      ButtonBaseClickCommandBehavior</code> . <br> <br> <code class="cs">public class ButtonBaseClickCommandBehavior : CommandBehaviorBase&lt;ButtonBase&gt; { public ButtonBaseClickCommandBehavior(ButtonBase clickableObject) : base(clickableObject) { clickableObject.Click += OnClick; } private void OnClick(object sender, System.Windows.RoutedEventArgs e) { ExecuteCommand(); } }</code> <br>   <code>CommandBehaviorBase ,     .     ,          ,   . ,    ,    ,      , ,    CanExecute</code>  ,     . <br> <br>          ,   .           XAML.           .       .  Prism      ,       ,  ,   .       ,    . , ,  ,      <code>Click</code> ,       <code>Command</code> .    <code>Click.Command</code> ,  . <br> <br>             .             . <br> <br> <code class="cs">public static readonly DependencyProperty CommandProperty = DependencyProperty.RegisterAttached( "Command", typeof(ICommand), typeof(Click), new PropertyMetadata(OnSetCommandCallback)); private static readonly DependencyProperty ClickCommandBehaviorProperty = DependencyProperty.RegisterAttached( "ClickCommandBehavior", typeof(ButtonBaseClickCommandBehavior), typeof(Click), null);</code> <br>    <code>Command</code>    <code>ButtonBaseClickCommandBehavior</code> ,     <code>OnSetCommandCallback</code> ,     . <br> <br> <code class="cs">private static void OnSetCommandCallback(DependencyObject dependencyObject, DependencyPropertyChangedEventArgs e) { ButtonBase buttonBase = dependencyObject as ButtonBase; if (buttonBase != null) { ButtonBaseClickCommandBehavior behavior = GetOrCreateBehavior(buttonBase); behavior.Command = e.NewValue as ICommand; } } private static void OnSetCommandParameterCallback(DependencyObject dependencyObject, DependencyPropertyChangedEventArgs e) { ButtonBase buttonBase = dependencyObject as ButtonBase; if (buttonBase != null) { ButtonBaseClickCommandBehavior behavior = GetOrCreateBehavior(buttonBase); behavior.CommandParameter = e.NewValue; } } private static ButtonBaseClickCommandBehavior GetOrCreateBehavior(ButtonBase buttonBase ) { ButtonBaseClickCommandBehavior behavior = buttonBase.GetValue(ClickCommandBehaviorProperty) as ButtonBaseClickCommandBehavior; if ( behavior == null ) { behavior = new ButtonBaseClickCommandBehavior(buttonBase); buttonBase.SetValue(ClickCommandBehaviorProperty, behavior); } return behavior; }</code> <br>        ,  <a href="http://msdn.microsoft.com/en-us/library/cc265152(VS.95).aspx">Attached Properties Overview</a>  MSDN. <br> <br>    <br>              . ,     Silverlight,    -,     ,      ,     .     ,       . <br> <br>        ,    ( )  ,  ,     .  UI       ,            UI. <br> <br>      - <br>   -     ,       <code>IAsyncResult</code> .   ,  ,   ,  <code>GetQuestionnaire</code> ,   : <code>BeginGetQuestionnaire</code>  <code>EndGetQuestionnaire</code> .    ,   <code>BeginGetQuestionnaire</code> .     ,   ,   <code>EndGetQuestionnaire</code>    . <br> <b></b> <br>  .NET Framework 4.5      <code>await</code>  <code>async</code>     <code>*Async</code> .      <a href="http://msdn.microsoft.com/en-us/library/vstudio/hh391443.aspx">"Asynchronous Programming with Async and Await (C# and Visual Basic)"</a> . <br>  ,    <code>EndGetQuestionnaire</code> ,      ,  ()      <code>BeginGetQuestionnaire</code> .     ,      ,   <code>EndGetQuestionnaire</code> ,   . <br> <br> <code class="xml">IAsyncResult asyncResult = this.service.BeginGetQuestionnaire( GetQuestionnaireCompleted, null //  ,      ); private void GetQuestionnaireCompleted(IAsyncResult result) { try { questionnaire = this.service.EndGetQuestionnaire(ar); } catch (Exception ex) { //  -   . } }</code> <br>  ,     <code>End*</code> (  , <code>EndGetQuestionnaire</code> ),    ,      .      , ,          UI.     ,   ,        . <br> <br>        UI,     -,      UI,         UI,   <code>Dispatcher</code>    <code>SynchronizationContext</code> .  WPF  Silverlight,   <code>Dispatcher</code> . <br> <br>      <code>Questionnaire</code>  ,        <code>QuestionnaireView</code> .  Silverlight    <code>CheckAccess</code> ,  ,      UI.  ,     <code>BeginInvoke</code> ,      UI. <br> <br> <code class="cs">var dispatcher = System.Windows.Deployment.Current.Dispatcher; if (dispatcher.CheckAccess()) { QuestionnaireView.DataContext = questionnaire; } else { dispatcher.BeginInvoke(() =&gt; { Questionnaire.DataContext = questionnaire; }); }</code> <br> <i>MVVM RI</i>   ,    ,   <code>IAsyncResult</code> ,   .      ,                 . ,       . <br> <br> <code class="cs">this.questionnaireRepository.GetQuestionnaireAsync( result =&gt; { this.Questionnaire = result.Result; });</code> <br>  <code>result</code>   ,     , , , .    ,     . <br> <br> <code class="cs">this.questionnaireRepository.GetQuestionnaireAsync( result =&gt; { if (result.Error == null) { this.Questionnaire = result.Result; ... } else { // Handle error. } })</code> <br>     <br>        ,      .     , ,             .        ,      ,     ,     . <br> <br>         ,      MVVM,     ,   . ,  -MVVM ,     <code>MessageBox</code>   code-behind UI,      .   MVVM     ,          . <br> <br>     MVVM,              ,          .      ,    ,   ,  ,     . <br> <br>              MVVM.      ,     ,     ,  ,     .    ,         ,     ,          .       . <br> <br>    <br>                  .        ,        .  ,         .         . <br> <br>  ,         ,         ,  .      ,     .           ,       . ,        WPF  Silverlight,        . <br> <br> <img title="Using the service to interact with the user." src="https://habrastorage.org/getpro/habr/post_images/4b5/397/f2d/4b5397f2d02e5851195b29f1893be6fc.png" alt=" ,    ."> <br> <br>  ,   <code>MessageBox</code>        ,     ,    ,     . <br> <br> <code class="cs">var result = interactionService.ShowMessageBox( "Are you sure you want to cancel this operation?", "Confirm", MessageBoxButton.OK); if (result == MessageBoxResult.Yes) { CancelRequest(); }</code> <br> ,      - ,      ,         Silverlight.         .             .     . <br> <br> <code class="cs">interactionService.ShowMessageBox( "Are you sure you want to cancel this operation?", "Confirm", MessageBoxButton.OK, result =&gt; { if (result == MessageBoxResult.Yes) { CancelRequest(); } });</code> <br>         ,      . ,  WPF    <code>MessageBox</code> ,       ;    Silverlight    ,    . <br> <br>     <br>         ‚Äì             .         ,      .     ,     .        ,        ,   ,     . <br> <br> <img title="Using interaction request objects." src="https://habrastorage.org/getpro/habr/post_images/3d0/ff0/1c5/3d0ff01c5518558c2d3c5c5f47ce0ce9.png" alt="   ."> <br> <br>    ,   ,          ‚Äì       ,      ,   ‚Äì     .   ,        ,    ,    UI            . <br> <br>       MVVM,     ,       ,         .         ,        ,    ,   . <br> <br>  Prism       <code>IInteractionRequest</code>   <code>InteractionRequest .  IInteractionRequest</code>  ,   .           ,   .  <code>InteractionRequest   IInteractionRequest</code>     <code>Raise</code> ,           , , ,   . <br> <br>       <br>  <code>InteractionRequest          .  Raise</code>          ( <code>T</code> )    ,    ,   .          ,       .      ,        .    ,  ,     . <br> <code class="cs">public interface IInteractionRequest { event EventHandler&lt;InteractionRequestedEventArgs&gt; Raised; } public class InteractionRequest&lt;T&gt; : IInteractionRequest { public event EventHandler&lt;InteractionRequestedEventArgs&gt; Raised; public void Raise(T context, Action&lt;T&gt; callback) { var handler = this.Raised; if (handler != null) { handler( this, new InteractionRequestedEventArgs(context, () =&gt; callback(context))); } } }</code> <br> Prism    ,      .  <code>Notification</code>       .    ,            .     ‚Äì <code>Title</code>  <code>Content</code> ,    .  ,   ,  ,  ,        . <br> <br>  <code>Confirmation</code>    <code>Notification</code>     ‚Äì <code>Confirmed</code> ,  ,  ,      .  <code>Confirmation</code> ,     <code>MessageBox</code> ,     /  .     ,     <code>Notification</code> ,     ,      . <br> <br>    <code>InteractionRequest ,       InteractionRequest      ,      .      ,    Raise</code> ,    , ,   . <br> <br> <code class="cs">public IInteractionRequest ConfirmCancelInteractionRequest { get { return this.confirmCancelInteractionRequest; } } this.confirmCancelInteractionRequest.Raise( new Confirmation("Are you sure you wish to cancel?"), confirmation =&gt; { if (confirmation.Confirmed) { this.NavigateToQuestionnaireList(); } }); }</code> <br> <i>MVVM Reference Implementation (MVVM RI)</i> ,    <code>IInteractionRequest</code>   <code>InteractionRequest ,          (. QuestionnaireViewModel.cs</code> ). <br> <br>        <br>       ,       .   ,       .    UI             . <br> <br>                . Microsoft Expression Blend Behaviors Framework     .  ,     ,    . <br> <br>  <code>EventTrigger</code> ,  Expression Blend,  ,      ,     ,   . , Prism   <code>EventTrigger</code> ,  <code>InteractionRequestTrigger</code> ,      <code>Raised</code>   <code>IInteractionRequest</code> .    XAML        . <br> <br>  ,   , <code>InteractionRequestTrigger</code>   .  Silverlight Prism   <code>PopupChildWindowAction</code> ,     .    ,         .   <code>ContentTemplate</code>  <code>PopupChildWindowAction</code> ,    ,    UI,      <code>Content</code>  .       <code>Title</code>  . <br> <b></b> <br>  ,    ,   <code>PopupChildWindowAction</code> ,     .    <code>Notification</code>  <code>NotificationChildWindow</code> ,        <code>Confirmation</code> ‚Äì <code>ConfirmationChildWindow</code> . <code>NotificationChildWindow</code>    ,   ,     <code>ConfirmationChildWindow</code>    <i>OK</i>  <i>Cancel</i> ,    .    ,   ,   <code>ChildWindow</code>  <code>PopupChildWindowAction</code> . <br>   ,  <code>InteractionRequestTrigger</code>  <code>PopupChildWindowAction</code> ,       <i>RI MVVM</i> . <br> <br> <code class="xml">&lt;i:Interaction.Triggers&gt; &lt;prism:InteractionRequestTrigger SourceObject="{Binding ConfirmCancelInteractionRequest}"&gt; &lt;prism:PopupChildWindowAction ContentTemplate="{StaticResource ConfirmWindowTemplate}"/&gt; &lt;/prism:InteractionRequestTrigger&gt; &lt;/i:Interaction.Triggers&gt; &lt;UserControl.Resources&gt; &lt;DataTemplate x:Key="ConfirmWindowTemplate"&gt; &lt;Grid MinWidth="250" MinHeight="100"&gt; &lt;TextBlock TextWrapping="Wrap" Grid.Row="0" Text="{Binding}"/&gt; &lt;/Grid&gt; &lt;/DataTemplate&gt; &lt;/UserControl.Resources&gt;</code> <br> <b></b> <br>      <code>ContentTemplate</code> ,   UI   <code>Content</code>  .    <code>Content</code>  ,  , <code>TextBlock</code>     <code>Content</code> . <br>      ,     ,    ,    .  ,     ,       ,     ,    .   ,   <i>RI MVVM</i> ,         <code>Confirmed</code>    <code>Confirmation</code>  <code>true</code> ,     OK. <br> <br>        ,     .  Prism <code>InteractionRequestTrigger</code>   <code>PopupChildWindowAction</code>            . <br> <br>     <br>     MVVM,       , ,    ,         .        (  , ,  ,   ).    ,  ,  ,            . <br> <br>        ,         . Managed Extensibility Framework (MEF)  Unity Application Block (Unity)      ,  ,           . <br> <br>  ,       , , ,    ( )      . ,       ,     .  ,     ,       . <br> <br>     ,  MEF <br>  MEF,       ,   <code>Import</code> ,      ,  ,   <code>Export</code> .         ,    . <br> <br> , <code>QuestionnaireView</code>   <i>RI MVVM</i> ,        ,    <code>Import</code> .   , MEF           .  <code>set</code>        ,   . <br> <br> <code class="cs">[Import] public QuestionnaireViewModel ViewModel { set { this.DataContext = value; } }</code> <br>     ,   . <br> <br> <code class="cs">[Export] public class QuestionnaireViewModel : NotificationObject { ... }</code> <br>        ,   . <br> <br> <code class="cs">public QuestionnaireView() { InitializeComponent(); } [ImportingConstructor] public QuestionnaireView(QuestionnaireViewModel viewModel) : this() { this.DataContext = viewModel; }</code> <br> <b></b> <br>          MEF,   Unity.   ,     ,        .   ,   Visual Studio  Expression Blend, ,        ,     .   ,   ,  ,      ,          <code>InitializeComponent</code> . <br>     ,  Unity <br>  Unity,    ,   MEF.     ,      .    ,         .  ,      . <br> <br>  ,      ,  ,         . ,           ,   . <br> <br> <code class="cs">public QuestionnaireView() { InitializeComponent(); } public QuestionnaireView(QuestionnaireViewModel viewModel) : this() { this.DataContext = viewModel; }</code> <br> <b></b> <br>    ,        ,   Visual Studio  Expression Blend. <br>  ,          ,   . Unity        <code>set</code>   ,   . <br> <br> <code class="cs">public QuestionnaireView() { InitializeComponent(); } [Dependency] public QuestionnaireViewModel ViewModel { set { this.DataContext = value; } }</code> <br>       Unity. <br> <br> <code class="cs">container.RegisterType&lt;QuestionnaireViewModel&gt;();</code> <br>  ,     . <br> <br> <code class="cs">var view = container.Resolve&lt;QuestionnaireView&gt;();</code> <br>     ,    <br>   ,     ,        .        ,   MEF  Unity,        . <br> <br>          .   ,         UI,           . <br> <br> , <i>RI MVVM</i>   ,   ,        .   ,    .      <code>ShowView</code>   UI. <br> <br> <code class="cs">private void NavigateToQuestionnaireList() { //     "questionnaire list". this.uiService.ShowView(ViewNames.QuestionnaireTemplatesList); }</code> <br>  UI      UI .           UI.  <code>ShowView</code>  <code>UIService</code>      (,          ),       ,   . <br> <br> <code class="cs">public void ShowView(string viewName) { var view = this.ViewFactory.GetView(viewName); this.MainWindow.CurrentView = view; }</code> <br> <b></b> <br> Prism       .   ,   ,   ,             .    ,  , " <a href="http://msdn.microsoft.com/en-us/library/gg430861(v%3DPandP.40).aspx">View-Based Navigation</a> "   8, " <a href="http://msdn.microsoft.com/en-us/library/gg430861(v%3DPandP.40).aspx">Navigation</a> ". <br>  MVVM  <br>        MVVM      .           -      mocking . ,   ,        . <br> <br>   <i>INotifyPropertyChanged</i> <br>   <code>INotifyPropertyChanged</code>     ,      .      ,    ;   ,   ,     ,    ,       . <br> <br>   <br> ,       ,           <code>PropertyChanged</code>  ,         .  ,    <code>ChangeTracker</code> ,     MVVM,  ,      .      .     ,    . <br> <br> <code class="cs">var changeTracker = new PropertyChangeTracker(viewModel); viewModel.CurrentState = "newState"; CollectionAssert.Contains(changeTracker.ChangedProperties, "CurrentState");</code> <br> ,     ,     <code>INotifyPropertyChanged</code> ,    ,   ,     . <br> <br>      <br>        ,   ,    <code>set</code>      ,           . ,     ,     ,      ,          . <br> <br> <code class="cs">var changeTracker = new PropertyChangeTracker(viewModel); var question = viewModel.Questions.First() as OpenQuestionViewModel; question.Question.Response = "some text"; CollectionAssert.Contains(changeTracker.ChangedProperties, "UnansweredQuestions");</code> <br>      <br>     <code>INotifyPropertyChanged</code> ,      <code>PropertyChanged</code>        ,  ,     , , .        ,       . <br> <br>   <i>INotifyDataErrorInfo</i> <br>   ,     ,    ,   ,   <code>IDataErrorInfo</code> ,  ( Silverlight)   <code>INotifyDataErrorInfo</code> .   <code>INotifyDataErrorInfo</code>   ,         ,    ,  ,   ,    . <br> <br>       <code>INotifyDataErrorInfo</code> : ,     ,  ,     ,     <code>ErrorsChanged</code> ,      <code>GetErrors</code> , . <br> <br>    <br>     ,      ,     .       ,         <code>GetErrors</code>       ,  ,  ,   .    , ,  ,     ,        .   ,        . <br> <br> <code class="cs">//  . var notifyErrorInfo = (INotifyDataErrorInfo)question; question.Response = -15; Assert.IsTrue(notifyErrorInfo.GetErrors("Response").Cast&lt;ValidationResult&gt;().Any()); //  . var notifyErrorInfo = (INotifyDataErrorInfo)question; question.Response = 15; Assert.IsFalse(notifyErrorInfo.GetErrors("Response").Cast&lt;ValidationResult&gt;().Any());</code> <br>    ,    ,             . <br> <br>    <i>INotifyDataErrorInfo</i> <br>       <code>GetErrors</code> ,   <code>INotifyDataErrorInfo</code>  ,   <code>ErrorsChanged</code>      <code>GetErrors</code> . ,  <code>HasErrors</code>      ,  . <br> <br>       <code>INotifyDataErrorInfo</code> . , ,           ,   -  .      ,        <code>INotifyDataErrorInfo</code>         (,        ). <br> <br>     ,   ,  : <br>  <code>HasErrors</code>     .              ,       .  <code>ErrorsChanged</code> ,      ,         <code>GetErrors</code> .         ( ,  )     ,           .    <code>GetErrors</code>       <code>ErrorsChanged</code> . <br>    <code>INotifyPropertyChanged</code> ,  ,    <code>NotifyDataErrorInfoTestHelper</code>    MVVM,        <code>INotifyDataErrorInfo</code> ,       .   ,   ,      ,   .      . <br> <code class="cs">var helper = new NotifyDataErrorInfoTestHelper&lt;NumericQuestion, int?&gt;( question, q =&gt; q.Response); helper.ValidatePropertyChange( 6, NotifyDataErrorInfoBehavior.Nothing); helper.ValidatePropertyChange( 20, NotifyDataErrorInfoBehavior.FiresErrorsChanged | NotifyDataErrorInfoBehavior.HasErrors | NotifyDataErrorInfoBehavior.HasErrorsForProperty); helper.ValidatePropertyChange( null, NotifyDataErrorInfoBehavior.FiresErrorsChanged | NotifyDataErrorInfoBehavior.HasErrors | NotifyDataErrorInfoBehavior.HasErrorsForProperty); helper.ValidatePropertyChange( 2, NotifyDataErrorInfoBehavior.FiresErrorsChanged);</code> <br>     <br>   MVVM,     ,  .   ,    ,         . <br> <br>  ,     ,     ,       .   ,   , ,       ,     ,   <code>IAsyncResult</code>    ,  - ,   ,    UI. <br> <br>       , , ,    .   ,     .  ,      UI,     ,   ,          ,     ,        "   UI." <br> <br>     ,    ,    .   ,    ,     mock-, ,   ,   ,      ,          . <br> <br>           UI,    ,    .   ,     ,   ,      .        ,   .     ,    ,     . <br> <br> <code class="cs">questionnaireRepositoryMock .Setup( r =&gt; r.SubmitQuestionnaireAsync( It.IsAny&lt;Questionnaire&gt;(), It.IsAny&lt;Action&lt;IOperationResult&gt;&gt;())) .Callback&lt;Questionnaire, Action&lt;IOperationResult&gt;&gt;( (q, a) =&gt; callback = a); uiServicemock .Setup(svc =&gt; svc.ShowView(ViewNames.QuestionnaireTemplatesList)) .Callback&lt;string&gt;(viewName =&gt; requestedViewName = viewName); submitResultMock .Setup(sr =&gt; sr.Error) .Returns&lt;Exception&gt;(null); CompleteQuestionnaire(viewModel); viewModel.Submit(); //      UI . callback(submitResultMock.Object); //    ‚Äì     . Assert.AreEqual(ViewNames.QuestionnaireTemplatesList, requestedViewName);</code> <br> <b></b> <br>          ,        . <br>   <br>       , . "Trees in WPF"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ms753391.aspx">http://msdn.microsoft.com/en-us/library/ms753391.aspx</a> <br> <br>       , . "Attached Properties Overview"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/cc265152(VS.95).aspx">http://msdn.microsoft.com/en-us/library/cc265152(VS.95).aspx</a> <br> <br>      MEF, ."Managed Extensibility Framework Overview"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/dd460648.aspx">http://msdn.microsoft.com/en-us/library/dd460648.aspx</a> . <br> <br>      Unity, ."Unity Application Block"  MSDN: <a href="http://www.msdn.com/unity">http://www.msdn.com/unity</a> . <br> <br>      <code>DelegateCommand</code> , .Chapter 5, " <a href="http://msdn.microsoft.com/en-us/library/gg405484(v%3DPandP.40).aspx">Implementing the MVVM Pattern</a> ." <br> <br>        Microsoft Expression Blend, ."Working with built-in behaviors"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ff724013(v%3DExpression.40).aspx">http://msdn.microsoft.com/en-us/library/ff724013(v=Expression.40).aspx</a> . <br> <br>          Microsoft Expression Blend, ."Creating Custom Behaviors"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ff724708(v%3DExpression.40).aspx">http://msdn.microsoft.com/en-us/library/ff724708(v=Expression.40).aspx</a> . <br> <br>            Microsoft Expression Blend, ."Creating Custom Triggers and Actions"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ff724707(v%3DExpression.40).aspx">http://msdn.microsoft.com/en-us/library/ff724707(v=Expression.40).aspx</a> . <br> <br>         WPF  Silverlight, ."Threading Model"  "The Dispatcher Class"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ms741870.aspx">http://msdn.microsoft.com/en-us/library/ms741870.aspx</a> <br> <a href="http://msdn.microsoft.com/en-us/library/ms615907(v%3DVS.95).aspx">http://msdn.microsoft.com/en-us/library/ms615907(v=VS.95).aspx</a> . <br> <br>      unit-  Silverlight, ."Unit Testing with Silverlight 2": <a href="http://www.jeff.wilcox.name/2008/03/silverlight2-unit-testing/">http://www.jeff.wilcox.name/2008/03/silverlight2-unit-testing/</a> . <br> <br>         , .  " <a href="http://msdn.microsoft.com/en-us/library/gg430861(v%3DPandP.40).aspx">View-Based Navigation</a> " in Chapter 8, " <a href="http://msdn.microsoft.com/en-us/library/gg430861(v%3DPandP.40).aspx">Navigation</a> ." <br> <br>       ,   , ."Event-based Asynchronous Pattern Overview"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/wewwczdw.aspx">http://msdn.microsoft.com/en-us/library/wewwczdw.aspx</a> <br> <br>        <code>IAsyncResult</code> , ."Asynchronous Programming Overview"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ms228963.aspx">http://msdn.microsoft.com/en-us/library/ms228963.aspx</a></code></code></code></code></code></code></code></code></code> </h4> <code><code><code><code><code><code><code><code><code><code>CommandBehaviorBase ,    ,    ICommand</code> .           <code>CanExecuteChanged</code> ,          Silverlight,    WPF. <br> <br>    ,  ,   <code>CommandBehaviorBase    ,    .         ,      .         ,    .      ButtonBaseClickCommandBehavior</code> . <br> <br> <code class="cs">public class ButtonBaseClickCommandBehavior : CommandBehaviorBase&lt;ButtonBase&gt; { public ButtonBaseClickCommandBehavior(ButtonBase clickableObject) : base(clickableObject) { clickableObject.Click += OnClick; } private void OnClick(object sender, System.Windows.RoutedEventArgs e) { ExecuteCommand(); } }</code> <br>   <code>CommandBehaviorBase ,     .     ,          ,   . ,    ,    ,      , ,    CanExecute</code>  ,     . <br> <br>          ,   .           XAML.           .       .  Prism      ,       ,  ,   .       ,    . , ,  ,      <code>Click</code> ,       <code>Command</code> .    <code>Click.Command</code> ,  . <br> <br>             .             . <br> <br> <code class="cs">public static readonly DependencyProperty CommandProperty = DependencyProperty.RegisterAttached( "Command", typeof(ICommand), typeof(Click), new PropertyMetadata(OnSetCommandCallback)); private static readonly DependencyProperty ClickCommandBehaviorProperty = DependencyProperty.RegisterAttached( "ClickCommandBehavior", typeof(ButtonBaseClickCommandBehavior), typeof(Click), null);</code> <br>    <code>Command</code>    <code>ButtonBaseClickCommandBehavior</code> ,     <code>OnSetCommandCallback</code> ,     . <br> <br> <code class="cs">private static void OnSetCommandCallback(DependencyObject dependencyObject, DependencyPropertyChangedEventArgs e) { ButtonBase buttonBase = dependencyObject as ButtonBase; if (buttonBase != null) { ButtonBaseClickCommandBehavior behavior = GetOrCreateBehavior(buttonBase); behavior.Command = e.NewValue as ICommand; } } private static void OnSetCommandParameterCallback(DependencyObject dependencyObject, DependencyPropertyChangedEventArgs e) { ButtonBase buttonBase = dependencyObject as ButtonBase; if (buttonBase != null) { ButtonBaseClickCommandBehavior behavior = GetOrCreateBehavior(buttonBase); behavior.CommandParameter = e.NewValue; } } private static ButtonBaseClickCommandBehavior GetOrCreateBehavior(ButtonBase buttonBase ) { ButtonBaseClickCommandBehavior behavior = buttonBase.GetValue(ClickCommandBehaviorProperty) as ButtonBaseClickCommandBehavior; if ( behavior == null ) { behavior = new ButtonBaseClickCommandBehavior(buttonBase); buttonBase.SetValue(ClickCommandBehaviorProperty, behavior); } return behavior; }</code> <br>        ,  <a href="http://msdn.microsoft.com/en-us/library/cc265152(VS.95).aspx">Attached Properties Overview</a>  MSDN. <br> <br>    <br>              . ,     Silverlight,    -,     ,      ,     .     ,       . <br> <br>        ,    ( )  ,  ,     .  UI       ,            UI. <br> <br>      - <br>   -     ,       <code>IAsyncResult</code> .   ,  ,   ,  <code>GetQuestionnaire</code> ,   : <code>BeginGetQuestionnaire</code>  <code>EndGetQuestionnaire</code> .    ,   <code>BeginGetQuestionnaire</code> .     ,   ,   <code>EndGetQuestionnaire</code>    . <br> <b></b> <br>  .NET Framework 4.5      <code>await</code>  <code>async</code>     <code>*Async</code> .      <a href="http://msdn.microsoft.com/en-us/library/vstudio/hh391443.aspx">"Asynchronous Programming with Async and Await (C# and Visual Basic)"</a> . <br>  ,    <code>EndGetQuestionnaire</code> ,      ,  ()      <code>BeginGetQuestionnaire</code> .     ,      ,   <code>EndGetQuestionnaire</code> ,   . <br> <br> <code class="xml">IAsyncResult asyncResult = this.service.BeginGetQuestionnaire( GetQuestionnaireCompleted, null //  ,      ); private void GetQuestionnaireCompleted(IAsyncResult result) { try { questionnaire = this.service.EndGetQuestionnaire(ar); } catch (Exception ex) { //  -   . } }</code> <br>  ,     <code>End*</code> (  , <code>EndGetQuestionnaire</code> ),    ,      .      , ,          UI.     ,   ,        . <br> <br>        UI,     -,      UI,         UI,   <code>Dispatcher</code>    <code>SynchronizationContext</code> .  WPF  Silverlight,   <code>Dispatcher</code> . <br> <br>      <code>Questionnaire</code>  ,        <code>QuestionnaireView</code> .  Silverlight    <code>CheckAccess</code> ,  ,      UI.  ,     <code>BeginInvoke</code> ,      UI. <br> <br> <code class="cs">var dispatcher = System.Windows.Deployment.Current.Dispatcher; if (dispatcher.CheckAccess()) { QuestionnaireView.DataContext = questionnaire; } else { dispatcher.BeginInvoke(() =&gt; { Questionnaire.DataContext = questionnaire; }); }</code> <br> <i>MVVM RI</i>   ,    ,   <code>IAsyncResult</code> ,   .      ,                 . ,       . <br> <br> <code class="cs">this.questionnaireRepository.GetQuestionnaireAsync( result =&gt; { this.Questionnaire = result.Result; });</code> <br>  <code>result</code>   ,     , , , .    ,     . <br> <br> <code class="cs">this.questionnaireRepository.GetQuestionnaireAsync( result =&gt; { if (result.Error == null) { this.Questionnaire = result.Result; ... } else { // Handle error. } })</code> <br>     <br>        ,      .     , ,             .        ,      ,     ,     . <br> <br>         ,      MVVM,     ,   . ,  -MVVM ,     <code>MessageBox</code>   code-behind UI,      .   MVVM     ,          . <br> <br>     MVVM,              ,          .      ,    ,   ,  ,     . <br> <br>              MVVM.      ,     ,     ,  ,     .    ,         ,     ,          .       . <br> <br>    <br>                  .        ,        .  ,         .         . <br> <br>  ,         ,         ,  .      ,     .           ,       . ,        WPF  Silverlight,        . <br> <br> <img title="Using the service to interact with the user." src="https://habrastorage.org/getpro/habr/post_images/4b5/397/f2d/4b5397f2d02e5851195b29f1893be6fc.png" alt=" ,    ."> <br> <br>  ,   <code>MessageBox</code>        ,     ,    ,     . <br> <br> <code class="cs">var result = interactionService.ShowMessageBox( "Are you sure you want to cancel this operation?", "Confirm", MessageBoxButton.OK); if (result == MessageBoxResult.Yes) { CancelRequest(); }</code> <br> ,      - ,      ,         Silverlight.         .             .     . <br> <br> <code class="cs">interactionService.ShowMessageBox( "Are you sure you want to cancel this operation?", "Confirm", MessageBoxButton.OK, result =&gt; { if (result == MessageBoxResult.Yes) { CancelRequest(); } });</code> <br>         ,      . ,  WPF    <code>MessageBox</code> ,       ;    Silverlight    ,    . <br> <br>     <br>         ‚Äì             .         ,      .     ,     .        ,        ,   ,     . <br> <br> <img title="Using interaction request objects." src="https://habrastorage.org/getpro/habr/post_images/3d0/ff0/1c5/3d0ff01c5518558c2d3c5c5f47ce0ce9.png" alt="   ."> <br> <br>    ,   ,          ‚Äì       ,      ,   ‚Äì     .   ,        ,    ,    UI            . <br> <br>       MVVM,     ,       ,         .         ,        ,    ,   . <br> <br>  Prism       <code>IInteractionRequest</code>   <code>InteractionRequest .  IInteractionRequest</code>  ,   .           ,   .  <code>InteractionRequest   IInteractionRequest</code>     <code>Raise</code> ,           , , ,   . <br> <br>       <br>  <code>InteractionRequest          .  Raise</code>          ( <code>T</code> )    ,    ,   .          ,       .      ,        .    ,  ,     . <br> <code class="cs">public interface IInteractionRequest { event EventHandler&lt;InteractionRequestedEventArgs&gt; Raised; } public class InteractionRequest&lt;T&gt; : IInteractionRequest { public event EventHandler&lt;InteractionRequestedEventArgs&gt; Raised; public void Raise(T context, Action&lt;T&gt; callback) { var handler = this.Raised; if (handler != null) { handler( this, new InteractionRequestedEventArgs(context, () =&gt; callback(context))); } } }</code> <br> Prism    ,      .  <code>Notification</code>       .    ,            .     ‚Äì <code>Title</code>  <code>Content</code> ,    .  ,   ,  ,  ,        . <br> <br>  <code>Confirmation</code>    <code>Notification</code>     ‚Äì <code>Confirmed</code> ,  ,  ,      .  <code>Confirmation</code> ,     <code>MessageBox</code> ,     /  .     ,     <code>Notification</code> ,     ,      . <br> <br>    <code>InteractionRequest ,       InteractionRequest      ,      .      ,    Raise</code> ,    , ,   . <br> <br> <code class="cs">public IInteractionRequest ConfirmCancelInteractionRequest { get { return this.confirmCancelInteractionRequest; } } this.confirmCancelInteractionRequest.Raise( new Confirmation("Are you sure you wish to cancel?"), confirmation =&gt; { if (confirmation.Confirmed) { this.NavigateToQuestionnaireList(); } }); }</code> <br> <i>MVVM Reference Implementation (MVVM RI)</i> ,    <code>IInteractionRequest</code>   <code>InteractionRequest ,          (. QuestionnaireViewModel.cs</code> ). <br> <br>        <br>       ,       .   ,       .    UI             . <br> <br>                . Microsoft Expression Blend Behaviors Framework     .  ,     ,    . <br> <br>  <code>EventTrigger</code> ,  Expression Blend,  ,      ,     ,   . , Prism   <code>EventTrigger</code> ,  <code>InteractionRequestTrigger</code> ,      <code>Raised</code>   <code>IInteractionRequest</code> .    XAML        . <br> <br>  ,   , <code>InteractionRequestTrigger</code>   .  Silverlight Prism   <code>PopupChildWindowAction</code> ,     .    ,         .   <code>ContentTemplate</code>  <code>PopupChildWindowAction</code> ,    ,    UI,      <code>Content</code>  .       <code>Title</code>  . <br> <b></b> <br>  ,    ,   <code>PopupChildWindowAction</code> ,     .    <code>Notification</code>  <code>NotificationChildWindow</code> ,        <code>Confirmation</code> ‚Äì <code>ConfirmationChildWindow</code> . <code>NotificationChildWindow</code>    ,   ,     <code>ConfirmationChildWindow</code>    <i>OK</i>  <i>Cancel</i> ,    .    ,   ,   <code>ChildWindow</code>  <code>PopupChildWindowAction</code> . <br>   ,  <code>InteractionRequestTrigger</code>  <code>PopupChildWindowAction</code> ,       <i>RI MVVM</i> . <br> <br> <code class="xml">&lt;i:Interaction.Triggers&gt; &lt;prism:InteractionRequestTrigger SourceObject="{Binding ConfirmCancelInteractionRequest}"&gt; &lt;prism:PopupChildWindowAction ContentTemplate="{StaticResource ConfirmWindowTemplate}"/&gt; &lt;/prism:InteractionRequestTrigger&gt; &lt;/i:Interaction.Triggers&gt; &lt;UserControl.Resources&gt; &lt;DataTemplate x:Key="ConfirmWindowTemplate"&gt; &lt;Grid MinWidth="250" MinHeight="100"&gt; &lt;TextBlock TextWrapping="Wrap" Grid.Row="0" Text="{Binding}"/&gt; &lt;/Grid&gt; &lt;/DataTemplate&gt; &lt;/UserControl.Resources&gt;</code> <br> <b></b> <br>      <code>ContentTemplate</code> ,   UI   <code>Content</code>  .    <code>Content</code>  ,  , <code>TextBlock</code>     <code>Content</code> . <br>      ,     ,    ,    .  ,     ,       ,     ,    .   ,   <i>RI MVVM</i> ,         <code>Confirmed</code>    <code>Confirmation</code>  <code>true</code> ,     OK. <br> <br>        ,     .  Prism <code>InteractionRequestTrigger</code>   <code>PopupChildWindowAction</code>            . <br> <br>     <br>     MVVM,       , ,    ,         .        (  , ,  ,   ).    ,  ,  ,            . <br> <br>        ,         . Managed Extensibility Framework (MEF)  Unity Application Block (Unity)      ,  ,           . <br> <br>  ,       , , ,    ( )      . ,       ,     .  ,     ,       . <br> <br>     ,  MEF <br>  MEF,       ,   <code>Import</code> ,      ,  ,   <code>Export</code> .         ,    . <br> <br> , <code>QuestionnaireView</code>   <i>RI MVVM</i> ,        ,    <code>Import</code> .   , MEF           .  <code>set</code>        ,   . <br> <br> <code class="cs">[Import] public QuestionnaireViewModel ViewModel { set { this.DataContext = value; } }</code> <br>     ,   . <br> <br> <code class="cs">[Export] public class QuestionnaireViewModel : NotificationObject { ... }</code> <br>        ,   . <br> <br> <code class="cs">public QuestionnaireView() { InitializeComponent(); } [ImportingConstructor] public QuestionnaireView(QuestionnaireViewModel viewModel) : this() { this.DataContext = viewModel; }</code> <br> <b></b> <br>          MEF,   Unity.   ,     ,        .   ,   Visual Studio  Expression Blend, ,        ,     .   ,   ,  ,      ,          <code>InitializeComponent</code> . <br>     ,  Unity <br>  Unity,    ,   MEF.     ,      .    ,         .  ,      . <br> <br>  ,      ,  ,         . ,           ,   . <br> <br> <code class="cs">public QuestionnaireView() { InitializeComponent(); } public QuestionnaireView(QuestionnaireViewModel viewModel) : this() { this.DataContext = viewModel; }</code> <br> <b></b> <br>    ,        ,   Visual Studio  Expression Blend. <br>  ,          ,   . Unity        <code>set</code>   ,   . <br> <br> <code class="cs">public QuestionnaireView() { InitializeComponent(); } [Dependency] public QuestionnaireViewModel ViewModel { set { this.DataContext = value; } }</code> <br>       Unity. <br> <br> <code class="cs">container.RegisterType&lt;QuestionnaireViewModel&gt;();</code> <br>  ,     . <br> <br> <code class="cs">var view = container.Resolve&lt;QuestionnaireView&gt;();</code> <br>     ,    <br>   ,     ,        .        ,   MEF  Unity,        . <br> <br>          .   ,         UI,           . <br> <br> , <i>RI MVVM</i>   ,   ,        .   ,    .      <code>ShowView</code>   UI. <br> <br> <code class="cs">private void NavigateToQuestionnaireList() { //     "questionnaire list". this.uiService.ShowView(ViewNames.QuestionnaireTemplatesList); }</code> <br>  UI      UI .           UI.  <code>ShowView</code>  <code>UIService</code>      (,          ),       ,   . <br> <br> <code class="cs">public void ShowView(string viewName) { var view = this.ViewFactory.GetView(viewName); this.MainWindow.CurrentView = view; }</code> <br> <b></b> <br> Prism       .   ,   ,   ,             .    ,  , " <a href="http://msdn.microsoft.com/en-us/library/gg430861(v%3DPandP.40).aspx">View-Based Navigation</a> "   8, " <a href="http://msdn.microsoft.com/en-us/library/gg430861(v%3DPandP.40).aspx">Navigation</a> ". <br>  MVVM  <br>        MVVM      .           -      mocking . ,   ,        . <br> <br>   <i>INotifyPropertyChanged</i> <br>   <code>INotifyPropertyChanged</code>     ,      .      ,    ;   ,   ,     ,    ,       . <br> <br>   <br> ,       ,           <code>PropertyChanged</code>  ,         .  ,    <code>ChangeTracker</code> ,     MVVM,  ,      .      .     ,    . <br> <br> <code class="cs">var changeTracker = new PropertyChangeTracker(viewModel); viewModel.CurrentState = "newState"; CollectionAssert.Contains(changeTracker.ChangedProperties, "CurrentState");</code> <br> ,     ,     <code>INotifyPropertyChanged</code> ,    ,   ,     . <br> <br>      <br>        ,   ,    <code>set</code>      ,           . ,     ,     ,      ,          . <br> <br> <code class="cs">var changeTracker = new PropertyChangeTracker(viewModel); var question = viewModel.Questions.First() as OpenQuestionViewModel; question.Question.Response = "some text"; CollectionAssert.Contains(changeTracker.ChangedProperties, "UnansweredQuestions");</code> <br>      <br>     <code>INotifyPropertyChanged</code> ,      <code>PropertyChanged</code>        ,  ,     , , .        ,       . <br> <br>   <i>INotifyDataErrorInfo</i> <br>   ,     ,    ,   ,   <code>IDataErrorInfo</code> ,  ( Silverlight)   <code>INotifyDataErrorInfo</code> .   <code>INotifyDataErrorInfo</code>   ,         ,    ,  ,   ,    . <br> <br>       <code>INotifyDataErrorInfo</code> : ,     ,  ,     ,     <code>ErrorsChanged</code> ,      <code>GetErrors</code> , . <br> <br>    <br>     ,      ,     .       ,         <code>GetErrors</code>       ,  ,  ,   .    , ,  ,     ,        .   ,        . <br> <br> <code class="cs">//  . var notifyErrorInfo = (INotifyDataErrorInfo)question; question.Response = -15; Assert.IsTrue(notifyErrorInfo.GetErrors("Response").Cast&lt;ValidationResult&gt;().Any()); //  . var notifyErrorInfo = (INotifyDataErrorInfo)question; question.Response = 15; Assert.IsFalse(notifyErrorInfo.GetErrors("Response").Cast&lt;ValidationResult&gt;().Any());</code> <br>    ,    ,             . <br> <br>    <i>INotifyDataErrorInfo</i> <br>       <code>GetErrors</code> ,   <code>INotifyDataErrorInfo</code>  ,   <code>ErrorsChanged</code>      <code>GetErrors</code> . ,  <code>HasErrors</code>      ,  . <br> <br>       <code>INotifyDataErrorInfo</code> . , ,           ,   -  .      ,        <code>INotifyDataErrorInfo</code>         (,        ). <br> <br>     ,   ,  : <br>  <code>HasErrors</code>     .              ,       .  <code>ErrorsChanged</code> ,      ,         <code>GetErrors</code> .         ( ,  )     ,           .    <code>GetErrors</code>       <code>ErrorsChanged</code> . <br>    <code>INotifyPropertyChanged</code> ,  ,    <code>NotifyDataErrorInfoTestHelper</code>    MVVM,        <code>INotifyDataErrorInfo</code> ,       .   ,   ,      ,   .      . <br> <code class="cs">var helper = new NotifyDataErrorInfoTestHelper&lt;NumericQuestion, int?&gt;( question, q =&gt; q.Response); helper.ValidatePropertyChange( 6, NotifyDataErrorInfoBehavior.Nothing); helper.ValidatePropertyChange( 20, NotifyDataErrorInfoBehavior.FiresErrorsChanged | NotifyDataErrorInfoBehavior.HasErrors | NotifyDataErrorInfoBehavior.HasErrorsForProperty); helper.ValidatePropertyChange( null, NotifyDataErrorInfoBehavior.FiresErrorsChanged | NotifyDataErrorInfoBehavior.HasErrors | NotifyDataErrorInfoBehavior.HasErrorsForProperty); helper.ValidatePropertyChange( 2, NotifyDataErrorInfoBehavior.FiresErrorsChanged);</code> <br>     <br>   MVVM,     ,  .   ,    ,         . <br> <br>  ,     ,     ,       .   ,   , ,       ,     ,   <code>IAsyncResult</code>    ,  - ,   ,    UI. <br> <br>       , , ,    .   ,     .  ,      UI,     ,   ,          ,     ,        "   UI." <br> <br>     ,    ,    .   ,    ,     mock-, ,   ,   ,      ,          . <br> <br>           UI,    ,    .   ,     ,   ,      .        ,   .     ,    ,     . <br> <br> <code class="cs">questionnaireRepositoryMock .Setup( r =&gt; r.SubmitQuestionnaireAsync( It.IsAny&lt;Questionnaire&gt;(), It.IsAny&lt;Action&lt;IOperationResult&gt;&gt;())) .Callback&lt;Questionnaire, Action&lt;IOperationResult&gt;&gt;( (q, a) =&gt; callback = a); uiServicemock .Setup(svc =&gt; svc.ShowView(ViewNames.QuestionnaireTemplatesList)) .Callback&lt;string&gt;(viewName =&gt; requestedViewName = viewName); submitResultMock .Setup(sr =&gt; sr.Error) .Returns&lt;Exception&gt;(null); CompleteQuestionnaire(viewModel); viewModel.Submit(); //      UI . callback(submitResultMock.Object); //    ‚Äì     . Assert.AreEqual(ViewNames.QuestionnaireTemplatesList, requestedViewName);</code> <br> <b></b> <br>          ,        . <br>   <br>       , . "Trees in WPF"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ms753391.aspx">http://msdn.microsoft.com/en-us/library/ms753391.aspx</a> <br> <br>       , . "Attached Properties Overview"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/cc265152(VS.95).aspx">http://msdn.microsoft.com/en-us/library/cc265152(VS.95).aspx</a> <br> <br>      MEF, ."Managed Extensibility Framework Overview"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/dd460648.aspx">http://msdn.microsoft.com/en-us/library/dd460648.aspx</a> . <br> <br>      Unity, ."Unity Application Block"  MSDN: <a href="http://www.msdn.com/unity">http://www.msdn.com/unity</a> . <br> <br>      <code>DelegateCommand</code> , .Chapter 5, " <a href="http://msdn.microsoft.com/en-us/library/gg405484(v%3DPandP.40).aspx">Implementing the MVVM Pattern</a> ." <br> <br>        Microsoft Expression Blend, ."Working with built-in behaviors"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ff724013(v%3DExpression.40).aspx">http://msdn.microsoft.com/en-us/library/ff724013(v=Expression.40).aspx</a> . <br> <br>          Microsoft Expression Blend, ."Creating Custom Behaviors"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ff724708(v%3DExpression.40).aspx">http://msdn.microsoft.com/en-us/library/ff724708(v=Expression.40).aspx</a> . <br> <br>            Microsoft Expression Blend, ."Creating Custom Triggers and Actions"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ff724707(v%3DExpression.40).aspx">http://msdn.microsoft.com/en-us/library/ff724707(v=Expression.40).aspx</a> . <br> <br>         WPF  Silverlight, ."Threading Model"  "The Dispatcher Class"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ms741870.aspx">http://msdn.microsoft.com/en-us/library/ms741870.aspx</a> <br> <a href="http://msdn.microsoft.com/en-us/library/ms615907(v%3DVS.95).aspx">http://msdn.microsoft.com/en-us/library/ms615907(v=VS.95).aspx</a> . <br> <br>      unit-  Silverlight, ."Unit Testing with Silverlight 2": <a href="http://www.jeff.wilcox.name/2008/03/silverlight2-unit-testing/">http://www.jeff.wilcox.name/2008/03/silverlight2-unit-testing/</a> . <br> <br>         , .  " <a href="http://msdn.microsoft.com/en-us/library/gg430861(v%3DPandP.40).aspx">View-Based Navigation</a> " in Chapter 8, " <a href="http://msdn.microsoft.com/en-us/library/gg430861(v%3DPandP.40).aspx">Navigation</a> ." <br> <br>       ,   , ."Event-based Asynchronous Pattern Overview"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/wewwczdw.aspx">http://msdn.microsoft.com/en-us/library/wewwczdw.aspx</a> <br> <br>        <code>IAsyncResult</code> , ."Asynchronous Programming Overview"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ms228963.aspx">http://msdn.microsoft.com/en-us/library/ms228963.aspx</a></code></code></code></code></code></code></code></code></code> <ul><li> <code><code><code><code><code><code><code><code><code><code>CommandBehaviorBase ,    ,    ICommand</code> .           <code>CanExecuteChanged</code> ,          Silverlight,    WPF. <br> <br>    ,  ,   <code>CommandBehaviorBase    ,    .         ,      .         ,    .      ButtonBaseClickCommandBehavior</code> . <br> <br> <code class="cs">public class ButtonBaseClickCommandBehavior : CommandBehaviorBase&lt;ButtonBase&gt; { public ButtonBaseClickCommandBehavior(ButtonBase clickableObject) : base(clickableObject) { clickableObject.Click += OnClick; } private void OnClick(object sender, System.Windows.RoutedEventArgs e) { ExecuteCommand(); } }</code> <br>   <code>CommandBehaviorBase ,     .     ,          ,   . ,    ,    ,      , ,    CanExecute</code>  ,     . <br> <br>          ,   .           XAML.           .       .  Prism      ,       ,  ,   .       ,    . , ,  ,      <code>Click</code> ,       <code>Command</code> .    <code>Click.Command</code> ,  . <br> <br>             .             . <br> <br> <code class="cs">public static readonly DependencyProperty CommandProperty = DependencyProperty.RegisterAttached( "Command", typeof(ICommand), typeof(Click), new PropertyMetadata(OnSetCommandCallback)); private static readonly DependencyProperty ClickCommandBehaviorProperty = DependencyProperty.RegisterAttached( "ClickCommandBehavior", typeof(ButtonBaseClickCommandBehavior), typeof(Click), null);</code> <br>    <code>Command</code>    <code>ButtonBaseClickCommandBehavior</code> ,     <code>OnSetCommandCallback</code> ,     . <br> <br> <code class="cs">private static void OnSetCommandCallback(DependencyObject dependencyObject, DependencyPropertyChangedEventArgs e) { ButtonBase buttonBase = dependencyObject as ButtonBase; if (buttonBase != null) { ButtonBaseClickCommandBehavior behavior = GetOrCreateBehavior(buttonBase); behavior.Command = e.NewValue as ICommand; } } private static void OnSetCommandParameterCallback(DependencyObject dependencyObject, DependencyPropertyChangedEventArgs e) { ButtonBase buttonBase = dependencyObject as ButtonBase; if (buttonBase != null) { ButtonBaseClickCommandBehavior behavior = GetOrCreateBehavior(buttonBase); behavior.CommandParameter = e.NewValue; } } private static ButtonBaseClickCommandBehavior GetOrCreateBehavior(ButtonBase buttonBase ) { ButtonBaseClickCommandBehavior behavior = buttonBase.GetValue(ClickCommandBehaviorProperty) as ButtonBaseClickCommandBehavior; if ( behavior == null ) { behavior = new ButtonBaseClickCommandBehavior(buttonBase); buttonBase.SetValue(ClickCommandBehaviorProperty, behavior); } return behavior; }</code> <br>        ,  <a href="http://msdn.microsoft.com/en-us/library/cc265152(VS.95).aspx">Attached Properties Overview</a>  MSDN. <br> <br>    <br>              . ,     Silverlight,    -,     ,      ,     .     ,       . <br> <br>        ,    ( )  ,  ,     .  UI       ,            UI. <br> <br>      - <br>   -     ,       <code>IAsyncResult</code> .   ,  ,   ,  <code>GetQuestionnaire</code> ,   : <code>BeginGetQuestionnaire</code>  <code>EndGetQuestionnaire</code> .    ,   <code>BeginGetQuestionnaire</code> .     ,   ,   <code>EndGetQuestionnaire</code>    . <br> <b></b> <br>  .NET Framework 4.5      <code>await</code>  <code>async</code>     <code>*Async</code> .      <a href="http://msdn.microsoft.com/en-us/library/vstudio/hh391443.aspx">"Asynchronous Programming with Async and Await (C# and Visual Basic)"</a> . <br>  ,    <code>EndGetQuestionnaire</code> ,      ,  ()      <code>BeginGetQuestionnaire</code> .     ,      ,   <code>EndGetQuestionnaire</code> ,   . <br> <br> <code class="xml">IAsyncResult asyncResult = this.service.BeginGetQuestionnaire( GetQuestionnaireCompleted, null //  ,      ); private void GetQuestionnaireCompleted(IAsyncResult result) { try { questionnaire = this.service.EndGetQuestionnaire(ar); } catch (Exception ex) { //  -   . } }</code> <br>  ,     <code>End*</code> (  , <code>EndGetQuestionnaire</code> ),    ,      .      , ,          UI.     ,   ,        . <br> <br>        UI,     -,      UI,         UI,   <code>Dispatcher</code>    <code>SynchronizationContext</code> .  WPF  Silverlight,   <code>Dispatcher</code> . <br> <br>      <code>Questionnaire</code>  ,        <code>QuestionnaireView</code> .  Silverlight    <code>CheckAccess</code> ,  ,      UI.  ,     <code>BeginInvoke</code> ,      UI. <br> <br> <code class="cs">var dispatcher = System.Windows.Deployment.Current.Dispatcher; if (dispatcher.CheckAccess()) { QuestionnaireView.DataContext = questionnaire; } else { dispatcher.BeginInvoke(() =&gt; { Questionnaire.DataContext = questionnaire; }); }</code> <br> <i>MVVM RI</i>   ,    ,   <code>IAsyncResult</code> ,   .      ,                 . ,       . <br> <br> <code class="cs">this.questionnaireRepository.GetQuestionnaireAsync( result =&gt; { this.Questionnaire = result.Result; });</code> <br>  <code>result</code>   ,     , , , .    ,     . <br> <br> <code class="cs">this.questionnaireRepository.GetQuestionnaireAsync( result =&gt; { if (result.Error == null) { this.Questionnaire = result.Result; ... } else { // Handle error. } })</code> <br>     <br>        ,      .     , ,             .        ,      ,     ,     . <br> <br>         ,      MVVM,     ,   . ,  -MVVM ,     <code>MessageBox</code>   code-behind UI,      .   MVVM     ,          . <br> <br>     MVVM,              ,          .      ,    ,   ,  ,     . <br> <br>              MVVM.      ,     ,     ,  ,     .    ,         ,     ,          .       . <br> <br>    <br>                  .        ,        .  ,         .         . <br> <br>  ,         ,         ,  .      ,     .           ,       . ,        WPF  Silverlight,        . <br> <br> <img title="Using the service to interact with the user." src="https://habrastorage.org/getpro/habr/post_images/4b5/397/f2d/4b5397f2d02e5851195b29f1893be6fc.png" alt=" ,    ."> <br> <br>  ,   <code>MessageBox</code>        ,     ,    ,     . <br> <br> <code class="cs">var result = interactionService.ShowMessageBox( "Are you sure you want to cancel this operation?", "Confirm", MessageBoxButton.OK); if (result == MessageBoxResult.Yes) { CancelRequest(); }</code> <br> ,      - ,      ,         Silverlight.         .             .     . <br> <br> <code class="cs">interactionService.ShowMessageBox( "Are you sure you want to cancel this operation?", "Confirm", MessageBoxButton.OK, result =&gt; { if (result == MessageBoxResult.Yes) { CancelRequest(); } });</code> <br>         ,      . ,  WPF    <code>MessageBox</code> ,       ;    Silverlight    ,    . <br> <br>     <br>         ‚Äì             .         ,      .     ,     .        ,        ,   ,     . <br> <br> <img title="Using interaction request objects." src="https://habrastorage.org/getpro/habr/post_images/3d0/ff0/1c5/3d0ff01c5518558c2d3c5c5f47ce0ce9.png" alt="   ."> <br> <br>    ,   ,          ‚Äì       ,      ,   ‚Äì     .   ,        ,    ,    UI            . <br> <br>       MVVM,     ,       ,         .         ,        ,    ,   . <br> <br>  Prism       <code>IInteractionRequest</code>   <code>InteractionRequest .  IInteractionRequest</code>  ,   .           ,   .  <code>InteractionRequest   IInteractionRequest</code>     <code>Raise</code> ,           , , ,   . <br> <br>       <br>  <code>InteractionRequest          .  Raise</code>          ( <code>T</code> )    ,    ,   .          ,       .      ,        .    ,  ,     . <br> <code class="cs">public interface IInteractionRequest { event EventHandler&lt;InteractionRequestedEventArgs&gt; Raised; } public class InteractionRequest&lt;T&gt; : IInteractionRequest { public event EventHandler&lt;InteractionRequestedEventArgs&gt; Raised; public void Raise(T context, Action&lt;T&gt; callback) { var handler = this.Raised; if (handler != null) { handler( this, new InteractionRequestedEventArgs(context, () =&gt; callback(context))); } } }</code> <br> Prism    ,      .  <code>Notification</code>       .    ,            .     ‚Äì <code>Title</code>  <code>Content</code> ,    .  ,   ,  ,  ,        . <br> <br>  <code>Confirmation</code>    <code>Notification</code>     ‚Äì <code>Confirmed</code> ,  ,  ,      .  <code>Confirmation</code> ,     <code>MessageBox</code> ,     /  .     ,     <code>Notification</code> ,     ,      . <br> <br>    <code>InteractionRequest ,       InteractionRequest      ,      .      ,    Raise</code> ,    , ,   . <br> <br> <code class="cs">public IInteractionRequest ConfirmCancelInteractionRequest { get { return this.confirmCancelInteractionRequest; } } this.confirmCancelInteractionRequest.Raise( new Confirmation("Are you sure you wish to cancel?"), confirmation =&gt; { if (confirmation.Confirmed) { this.NavigateToQuestionnaireList(); } }); }</code> <br> <i>MVVM Reference Implementation (MVVM RI)</i> ,    <code>IInteractionRequest</code>   <code>InteractionRequest ,          (. QuestionnaireViewModel.cs</code> ). <br> <br>        <br>       ,       .   ,       .    UI             . <br> <br>                . Microsoft Expression Blend Behaviors Framework     .  ,     ,    . <br> <br>  <code>EventTrigger</code> ,  Expression Blend,  ,      ,     ,   . , Prism   <code>EventTrigger</code> ,  <code>InteractionRequestTrigger</code> ,      <code>Raised</code>   <code>IInteractionRequest</code> .    XAML        . <br> <br>  ,   , <code>InteractionRequestTrigger</code>   .  Silverlight Prism   <code>PopupChildWindowAction</code> ,     .    ,         .   <code>ContentTemplate</code>  <code>PopupChildWindowAction</code> ,    ,    UI,      <code>Content</code>  .       <code>Title</code>  . <br> <b></b> <br>  ,    ,   <code>PopupChildWindowAction</code> ,     .    <code>Notification</code>  <code>NotificationChildWindow</code> ,        <code>Confirmation</code> ‚Äì <code>ConfirmationChildWindow</code> . <code>NotificationChildWindow</code>    ,   ,     <code>ConfirmationChildWindow</code>    <i>OK</i>  <i>Cancel</i> ,    .    ,   ,   <code>ChildWindow</code>  <code>PopupChildWindowAction</code> . <br>   ,  <code>InteractionRequestTrigger</code>  <code>PopupChildWindowAction</code> ,       <i>RI MVVM</i> . <br> <br> <code class="xml">&lt;i:Interaction.Triggers&gt; &lt;prism:InteractionRequestTrigger SourceObject="{Binding ConfirmCancelInteractionRequest}"&gt; &lt;prism:PopupChildWindowAction ContentTemplate="{StaticResource ConfirmWindowTemplate}"/&gt; &lt;/prism:InteractionRequestTrigger&gt; &lt;/i:Interaction.Triggers&gt; &lt;UserControl.Resources&gt; &lt;DataTemplate x:Key="ConfirmWindowTemplate"&gt; &lt;Grid MinWidth="250" MinHeight="100"&gt; &lt;TextBlock TextWrapping="Wrap" Grid.Row="0" Text="{Binding}"/&gt; &lt;/Grid&gt; &lt;/DataTemplate&gt; &lt;/UserControl.Resources&gt;</code> <br> <b></b> <br>      <code>ContentTemplate</code> ,   UI   <code>Content</code>  .    <code>Content</code>  ,  , <code>TextBlock</code>     <code>Content</code> . <br>      ,     ,    ,    .  ,     ,       ,     ,    .   ,   <i>RI MVVM</i> ,         <code>Confirmed</code>    <code>Confirmation</code>  <code>true</code> ,     OK. <br> <br>        ,     .  Prism <code>InteractionRequestTrigger</code>   <code>PopupChildWindowAction</code>            . <br> <br>     <br>     MVVM,       , ,    ,         .        (  , ,  ,   ).    ,  ,  ,            . <br> <br>        ,         . Managed Extensibility Framework (MEF)  Unity Application Block (Unity)      ,  ,           . <br> <br>  ,       , , ,    ( )      . ,       ,     .  ,     ,       . <br> <br>     ,  MEF <br>  MEF,       ,   <code>Import</code> ,      ,  ,   <code>Export</code> .         ,    . <br> <br> , <code>QuestionnaireView</code>   <i>RI MVVM</i> ,        ,    <code>Import</code> .   , MEF           .  <code>set</code>        ,   . <br> <br> <code class="cs">[Import] public QuestionnaireViewModel ViewModel { set { this.DataContext = value; } }</code> <br>     ,   . <br> <br> <code class="cs">[Export] public class QuestionnaireViewModel : NotificationObject { ... }</code> <br>        ,   . <br> <br> <code class="cs">public QuestionnaireView() { InitializeComponent(); } [ImportingConstructor] public QuestionnaireView(QuestionnaireViewModel viewModel) : this() { this.DataContext = viewModel; }</code> <br> <b></b> <br>          MEF,   Unity.   ,     ,        .   ,   Visual Studio  Expression Blend, ,        ,     .   ,   ,  ,      ,          <code>InitializeComponent</code> . <br>     ,  Unity <br>  Unity,    ,   MEF.     ,      .    ,         .  ,      . <br> <br>  ,      ,  ,         . ,           ,   . <br> <br> <code class="cs">public QuestionnaireView() { InitializeComponent(); } public QuestionnaireView(QuestionnaireViewModel viewModel) : this() { this.DataContext = viewModel; }</code> <br> <b></b> <br>    ,        ,   Visual Studio  Expression Blend. <br>  ,          ,   . Unity        <code>set</code>   ,   . <br> <br> <code class="cs">public QuestionnaireView() { InitializeComponent(); } [Dependency] public QuestionnaireViewModel ViewModel { set { this.DataContext = value; } }</code> <br>       Unity. <br> <br> <code class="cs">container.RegisterType&lt;QuestionnaireViewModel&gt;();</code> <br>  ,     . <br> <br> <code class="cs">var view = container.Resolve&lt;QuestionnaireView&gt;();</code> <br>     ,    <br>   ,     ,        .        ,   MEF  Unity,        . <br> <br>          .   ,         UI,           . <br> <br> , <i>RI MVVM</i>   ,   ,        .   ,    .      <code>ShowView</code>   UI. <br> <br> <code class="cs">private void NavigateToQuestionnaireList() { //     "questionnaire list". this.uiService.ShowView(ViewNames.QuestionnaireTemplatesList); }</code> <br>  UI      UI .           UI.  <code>ShowView</code>  <code>UIService</code>      (,          ),       ,   . <br> <br> <code class="cs">public void ShowView(string viewName) { var view = this.ViewFactory.GetView(viewName); this.MainWindow.CurrentView = view; }</code> <br> <b></b> <br> Prism       .   ,   ,   ,             .    ,  , " <a href="http://msdn.microsoft.com/en-us/library/gg430861(v%3DPandP.40).aspx">View-Based Navigation</a> "   8, " <a href="http://msdn.microsoft.com/en-us/library/gg430861(v%3DPandP.40).aspx">Navigation</a> ". <br>  MVVM  <br>        MVVM      .           -      mocking . ,   ,        . <br> <br>   <i>INotifyPropertyChanged</i> <br>   <code>INotifyPropertyChanged</code>     ,      .      ,    ;   ,   ,     ,    ,       . <br> <br>   <br> ,       ,           <code>PropertyChanged</code>  ,         .  ,    <code>ChangeTracker</code> ,     MVVM,  ,      .      .     ,    . <br> <br> <code class="cs">var changeTracker = new PropertyChangeTracker(viewModel); viewModel.CurrentState = "newState"; CollectionAssert.Contains(changeTracker.ChangedProperties, "CurrentState");</code> <br> ,     ,     <code>INotifyPropertyChanged</code> ,    ,   ,     . <br> <br>      <br>        ,   ,    <code>set</code>      ,           . ,     ,     ,      ,          . <br> <br> <code class="cs">var changeTracker = new PropertyChangeTracker(viewModel); var question = viewModel.Questions.First() as OpenQuestionViewModel; question.Question.Response = "some text"; CollectionAssert.Contains(changeTracker.ChangedProperties, "UnansweredQuestions");</code> <br>      <br>     <code>INotifyPropertyChanged</code> ,      <code>PropertyChanged</code>        ,  ,     , , .        ,       . <br> <br>   <i>INotifyDataErrorInfo</i> <br>   ,     ,    ,   ,   <code>IDataErrorInfo</code> ,  ( Silverlight)   <code>INotifyDataErrorInfo</code> .   <code>INotifyDataErrorInfo</code>   ,         ,    ,  ,   ,    . <br> <br>       <code>INotifyDataErrorInfo</code> : ,     ,  ,     ,     <code>ErrorsChanged</code> ,      <code>GetErrors</code> , . <br> <br>    <br>     ,      ,     .       ,         <code>GetErrors</code>       ,  ,  ,   .    , ,  ,     ,        .   ,        . <br> <br> <code class="cs">//  . var notifyErrorInfo = (INotifyDataErrorInfo)question; question.Response = -15; Assert.IsTrue(notifyErrorInfo.GetErrors("Response").Cast&lt;ValidationResult&gt;().Any()); //  . var notifyErrorInfo = (INotifyDataErrorInfo)question; question.Response = 15; Assert.IsFalse(notifyErrorInfo.GetErrors("Response").Cast&lt;ValidationResult&gt;().Any());</code> <br>    ,    ,             . <br> <br>    <i>INotifyDataErrorInfo</i> <br>       <code>GetErrors</code> ,   <code>INotifyDataErrorInfo</code>  ,   <code>ErrorsChanged</code>      <code>GetErrors</code> . ,  <code>HasErrors</code>      ,  . <br> <br>       <code>INotifyDataErrorInfo</code> . , ,           ,   -  .      ,        <code>INotifyDataErrorInfo</code>         (,        ). <br> <br>     ,   ,  : <br>  <code>HasErrors</code>     .              ,       .  <code>ErrorsChanged</code> ,      ,         <code>GetErrors</code> .         ( ,  )     ,           .    <code>GetErrors</code>       <code>ErrorsChanged</code> . <br>    <code>INotifyPropertyChanged</code> ,  ,    <code>NotifyDataErrorInfoTestHelper</code>    MVVM,        <code>INotifyDataErrorInfo</code> ,       .   ,   ,      ,   .      . <br> <code class="cs">var helper = new NotifyDataErrorInfoTestHelper&lt;NumericQuestion, int?&gt;( question, q =&gt; q.Response); helper.ValidatePropertyChange( 6, NotifyDataErrorInfoBehavior.Nothing); helper.ValidatePropertyChange( 20, NotifyDataErrorInfoBehavior.FiresErrorsChanged | NotifyDataErrorInfoBehavior.HasErrors | NotifyDataErrorInfoBehavior.HasErrorsForProperty); helper.ValidatePropertyChange( null, NotifyDataErrorInfoBehavior.FiresErrorsChanged | NotifyDataErrorInfoBehavior.HasErrors | NotifyDataErrorInfoBehavior.HasErrorsForProperty); helper.ValidatePropertyChange( 2, NotifyDataErrorInfoBehavior.FiresErrorsChanged);</code> <br>     <br>   MVVM,     ,  .   ,    ,         . <br> <br>  ,     ,     ,       .   ,   , ,       ,     ,   <code>IAsyncResult</code>    ,  - ,   ,    UI. <br> <br>       , , ,    .   ,     .  ,      UI,     ,   ,          ,     ,        "   UI." <br> <br>     ,    ,    .   ,    ,     mock-, ,   ,   ,      ,          . <br> <br>           UI,    ,    .   ,     ,   ,      .        ,   .     ,    ,     . <br> <br> <code class="cs">questionnaireRepositoryMock .Setup( r =&gt; r.SubmitQuestionnaireAsync( It.IsAny&lt;Questionnaire&gt;(), It.IsAny&lt;Action&lt;IOperationResult&gt;&gt;())) .Callback&lt;Questionnaire, Action&lt;IOperationResult&gt;&gt;( (q, a) =&gt; callback = a); uiServicemock .Setup(svc =&gt; svc.ShowView(ViewNames.QuestionnaireTemplatesList)) .Callback&lt;string&gt;(viewName =&gt; requestedViewName = viewName); submitResultMock .Setup(sr =&gt; sr.Error) .Returns&lt;Exception&gt;(null); CompleteQuestionnaire(viewModel); viewModel.Submit(); //      UI . callback(submitResultMock.Object); //    ‚Äì     . Assert.AreEqual(ViewNames.QuestionnaireTemplatesList, requestedViewName);</code> <br> <b></b> <br>          ,        . <br>   <br>       , . "Trees in WPF"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ms753391.aspx">http://msdn.microsoft.com/en-us/library/ms753391.aspx</a> <br> <br>       , . "Attached Properties Overview"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/cc265152(VS.95).aspx">http://msdn.microsoft.com/en-us/library/cc265152(VS.95).aspx</a> <br> <br>      MEF, ."Managed Extensibility Framework Overview"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/dd460648.aspx">http://msdn.microsoft.com/en-us/library/dd460648.aspx</a> . <br> <br>      Unity, ."Unity Application Block"  MSDN: <a href="http://www.msdn.com/unity">http://www.msdn.com/unity</a> . <br> <br>      <code>DelegateCommand</code> , .Chapter 5, " <a href="http://msdn.microsoft.com/en-us/library/gg405484(v%3DPandP.40).aspx">Implementing the MVVM Pattern</a> ." <br> <br>        Microsoft Expression Blend, ."Working with built-in behaviors"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ff724013(v%3DExpression.40).aspx">http://msdn.microsoft.com/en-us/library/ff724013(v=Expression.40).aspx</a> . <br> <br>          Microsoft Expression Blend, ."Creating Custom Behaviors"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ff724708(v%3DExpression.40).aspx">http://msdn.microsoft.com/en-us/library/ff724708(v=Expression.40).aspx</a> . <br> <br>            Microsoft Expression Blend, ."Creating Custom Triggers and Actions"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ff724707(v%3DExpression.40).aspx">http://msdn.microsoft.com/en-us/library/ff724707(v=Expression.40).aspx</a> . <br> <br>         WPF  Silverlight, ."Threading Model"  "The Dispatcher Class"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ms741870.aspx">http://msdn.microsoft.com/en-us/library/ms741870.aspx</a> <br> <a href="http://msdn.microsoft.com/en-us/library/ms615907(v%3DVS.95).aspx">http://msdn.microsoft.com/en-us/library/ms615907(v=VS.95).aspx</a> . <br> <br>      unit-  Silverlight, ."Unit Testing with Silverlight 2": <a href="http://www.jeff.wilcox.name/2008/03/silverlight2-unit-testing/">http://www.jeff.wilcox.name/2008/03/silverlight2-unit-testing/</a> . <br> <br>         , .  " <a href="http://msdn.microsoft.com/en-us/library/gg430861(v%3DPandP.40).aspx">View-Based Navigation</a> " in Chapter 8, " <a href="http://msdn.microsoft.com/en-us/library/gg430861(v%3DPandP.40).aspx">Navigation</a> ." <br> <br>       ,   , ."Event-based Asynchronous Pattern Overview"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/wewwczdw.aspx">http://msdn.microsoft.com/en-us/library/wewwczdw.aspx</a> <br> <br>        <code>IAsyncResult</code> , ."Asynchronous Programming Overview"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ms228963.aspx">http://msdn.microsoft.com/en-us/library/ms228963.aspx</a></code></code></code></code></code></code></code></code></code> </li> <li> <code><code><code><code><code><code><code><code><code><code>CommandBehaviorBase ,    ,    ICommand</code> .           <code>CanExecuteChanged</code> ,          Silverlight,    WPF. <br> <br>    ,  ,   <code>CommandBehaviorBase    ,    .         ,      .         ,    .      ButtonBaseClickCommandBehavior</code> . <br> <br> <code class="cs">public class ButtonBaseClickCommandBehavior : CommandBehaviorBase&lt;ButtonBase&gt; { public ButtonBaseClickCommandBehavior(ButtonBase clickableObject) : base(clickableObject) { clickableObject.Click += OnClick; } private void OnClick(object sender, System.Windows.RoutedEventArgs e) { ExecuteCommand(); } }</code> <br>   <code>CommandBehaviorBase ,     .     ,          ,   . ,    ,    ,      , ,    CanExecute</code>  ,     . <br> <br>          ,   .           XAML.           .       .  Prism      ,       ,  ,   .       ,    . , ,  ,      <code>Click</code> ,       <code>Command</code> .    <code>Click.Command</code> ,  . <br> <br>             .             . <br> <br> <code class="cs">public static readonly DependencyProperty CommandProperty = DependencyProperty.RegisterAttached( "Command", typeof(ICommand), typeof(Click), new PropertyMetadata(OnSetCommandCallback)); private static readonly DependencyProperty ClickCommandBehaviorProperty = DependencyProperty.RegisterAttached( "ClickCommandBehavior", typeof(ButtonBaseClickCommandBehavior), typeof(Click), null);</code> <br>    <code>Command</code>    <code>ButtonBaseClickCommandBehavior</code> ,     <code>OnSetCommandCallback</code> ,     . <br> <br> <code class="cs">private static void OnSetCommandCallback(DependencyObject dependencyObject, DependencyPropertyChangedEventArgs e) { ButtonBase buttonBase = dependencyObject as ButtonBase; if (buttonBase != null) { ButtonBaseClickCommandBehavior behavior = GetOrCreateBehavior(buttonBase); behavior.Command = e.NewValue as ICommand; } } private static void OnSetCommandParameterCallback(DependencyObject dependencyObject, DependencyPropertyChangedEventArgs e) { ButtonBase buttonBase = dependencyObject as ButtonBase; if (buttonBase != null) { ButtonBaseClickCommandBehavior behavior = GetOrCreateBehavior(buttonBase); behavior.CommandParameter = e.NewValue; } } private static ButtonBaseClickCommandBehavior GetOrCreateBehavior(ButtonBase buttonBase ) { ButtonBaseClickCommandBehavior behavior = buttonBase.GetValue(ClickCommandBehaviorProperty) as ButtonBaseClickCommandBehavior; if ( behavior == null ) { behavior = new ButtonBaseClickCommandBehavior(buttonBase); buttonBase.SetValue(ClickCommandBehaviorProperty, behavior); } return behavior; }</code> <br>        ,  <a href="http://msdn.microsoft.com/en-us/library/cc265152(VS.95).aspx">Attached Properties Overview</a>  MSDN. <br> <br>    <br>              . ,     Silverlight,    -,     ,      ,     .     ,       . <br> <br>        ,    ( )  ,  ,     .  UI       ,            UI. <br> <br>      - <br>   -     ,       <code>IAsyncResult</code> .   ,  ,   ,  <code>GetQuestionnaire</code> ,   : <code>BeginGetQuestionnaire</code>  <code>EndGetQuestionnaire</code> .    ,   <code>BeginGetQuestionnaire</code> .     ,   ,   <code>EndGetQuestionnaire</code>    . <br> <b></b> <br>  .NET Framework 4.5      <code>await</code>  <code>async</code>     <code>*Async</code> .      <a href="http://msdn.microsoft.com/en-us/library/vstudio/hh391443.aspx">"Asynchronous Programming with Async and Await (C# and Visual Basic)"</a> . <br>  ,    <code>EndGetQuestionnaire</code> ,      ,  ()      <code>BeginGetQuestionnaire</code> .     ,      ,   <code>EndGetQuestionnaire</code> ,   . <br> <br> <code class="xml">IAsyncResult asyncResult = this.service.BeginGetQuestionnaire( GetQuestionnaireCompleted, null //  ,      ); private void GetQuestionnaireCompleted(IAsyncResult result) { try { questionnaire = this.service.EndGetQuestionnaire(ar); } catch (Exception ex) { //  -   . } }</code> <br>  ,     <code>End*</code> (  , <code>EndGetQuestionnaire</code> ),    ,      .      , ,          UI.     ,   ,        . <br> <br>        UI,     -,      UI,         UI,   <code>Dispatcher</code>    <code>SynchronizationContext</code> .  WPF  Silverlight,   <code>Dispatcher</code> . <br> <br>      <code>Questionnaire</code>  ,        <code>QuestionnaireView</code> .  Silverlight    <code>CheckAccess</code> ,  ,      UI.  ,     <code>BeginInvoke</code> ,      UI. <br> <br> <code class="cs">var dispatcher = System.Windows.Deployment.Current.Dispatcher; if (dispatcher.CheckAccess()) { QuestionnaireView.DataContext = questionnaire; } else { dispatcher.BeginInvoke(() =&gt; { Questionnaire.DataContext = questionnaire; }); }</code> <br> <i>MVVM RI</i>   ,    ,   <code>IAsyncResult</code> ,   .      ,                 . ,       . <br> <br> <code class="cs">this.questionnaireRepository.GetQuestionnaireAsync( result =&gt; { this.Questionnaire = result.Result; });</code> <br>  <code>result</code>   ,     , , , .    ,     . <br> <br> <code class="cs">this.questionnaireRepository.GetQuestionnaireAsync( result =&gt; { if (result.Error == null) { this.Questionnaire = result.Result; ... } else { // Handle error. } })</code> <br>     <br>        ,      .     , ,             .        ,      ,     ,     . <br> <br>         ,      MVVM,     ,   . ,  -MVVM ,     <code>MessageBox</code>   code-behind UI,      .   MVVM     ,          . <br> <br>     MVVM,              ,          .      ,    ,   ,  ,     . <br> <br>              MVVM.      ,     ,     ,  ,     .    ,         ,     ,          .       . <br> <br>    <br>                  .        ,        .  ,         .         . <br> <br>  ,         ,         ,  .      ,     .           ,       . ,        WPF  Silverlight,        . <br> <br> <img title="Using the service to interact with the user." src="https://habrastorage.org/getpro/habr/post_images/4b5/397/f2d/4b5397f2d02e5851195b29f1893be6fc.png" alt=" ,    ."> <br> <br>  ,   <code>MessageBox</code>        ,     ,    ,     . <br> <br> <code class="cs">var result = interactionService.ShowMessageBox( "Are you sure you want to cancel this operation?", "Confirm", MessageBoxButton.OK); if (result == MessageBoxResult.Yes) { CancelRequest(); }</code> <br> ,      - ,      ,         Silverlight.         .             .     . <br> <br> <code class="cs">interactionService.ShowMessageBox( "Are you sure you want to cancel this operation?", "Confirm", MessageBoxButton.OK, result =&gt; { if (result == MessageBoxResult.Yes) { CancelRequest(); } });</code> <br>         ,      . ,  WPF    <code>MessageBox</code> ,       ;    Silverlight    ,    . <br> <br>     <br>         ‚Äì             .         ,      .     ,     .        ,        ,   ,     . <br> <br> <img title="Using interaction request objects." src="https://habrastorage.org/getpro/habr/post_images/3d0/ff0/1c5/3d0ff01c5518558c2d3c5c5f47ce0ce9.png" alt="   ."> <br> <br>    ,   ,          ‚Äì       ,      ,   ‚Äì     .   ,        ,    ,    UI            . <br> <br>       MVVM,     ,       ,         .         ,        ,    ,   . <br> <br>  Prism       <code>IInteractionRequest</code>   <code>InteractionRequest .  IInteractionRequest</code>  ,   .           ,   .  <code>InteractionRequest   IInteractionRequest</code>     <code>Raise</code> ,           , , ,   . <br> <br>       <br>  <code>InteractionRequest          .  Raise</code>          ( <code>T</code> )    ,    ,   .          ,       .      ,        .    ,  ,     . <br> <code class="cs">public interface IInteractionRequest { event EventHandler&lt;InteractionRequestedEventArgs&gt; Raised; } public class InteractionRequest&lt;T&gt; : IInteractionRequest { public event EventHandler&lt;InteractionRequestedEventArgs&gt; Raised; public void Raise(T context, Action&lt;T&gt; callback) { var handler = this.Raised; if (handler != null) { handler( this, new InteractionRequestedEventArgs(context, () =&gt; callback(context))); } } }</code> <br> Prism    ,      .  <code>Notification</code>       .    ,            .     ‚Äì <code>Title</code>  <code>Content</code> ,    .  ,   ,  ,  ,        . <br> <br>  <code>Confirmation</code>    <code>Notification</code>     ‚Äì <code>Confirmed</code> ,  ,  ,      .  <code>Confirmation</code> ,     <code>MessageBox</code> ,     /  .     ,     <code>Notification</code> ,     ,      . <br> <br>    <code>InteractionRequest ,       InteractionRequest      ,      .      ,    Raise</code> ,    , ,   . <br> <br> <code class="cs">public IInteractionRequest ConfirmCancelInteractionRequest { get { return this.confirmCancelInteractionRequest; } } this.confirmCancelInteractionRequest.Raise( new Confirmation("Are you sure you wish to cancel?"), confirmation =&gt; { if (confirmation.Confirmed) { this.NavigateToQuestionnaireList(); } }); }</code> <br> <i>MVVM Reference Implementation (MVVM RI)</i> ,    <code>IInteractionRequest</code>   <code>InteractionRequest ,          (. QuestionnaireViewModel.cs</code> ). <br> <br>        <br>       ,       .   ,       .    UI             . <br> <br>                . Microsoft Expression Blend Behaviors Framework     .  ,     ,    . <br> <br>  <code>EventTrigger</code> ,  Expression Blend,  ,      ,     ,   . , Prism   <code>EventTrigger</code> ,  <code>InteractionRequestTrigger</code> ,      <code>Raised</code>   <code>IInteractionRequest</code> .    XAML        . <br> <br>  ,   , <code>InteractionRequestTrigger</code>   .  Silverlight Prism   <code>PopupChildWindowAction</code> ,     .    ,         .   <code>ContentTemplate</code>  <code>PopupChildWindowAction</code> ,    ,    UI,      <code>Content</code>  .       <code>Title</code>  . <br> <b></b> <br>  ,    ,   <code>PopupChildWindowAction</code> ,     .    <code>Notification</code>  <code>NotificationChildWindow</code> ,        <code>Confirmation</code> ‚Äì <code>ConfirmationChildWindow</code> . <code>NotificationChildWindow</code>    ,   ,     <code>ConfirmationChildWindow</code>    <i>OK</i>  <i>Cancel</i> ,    .    ,   ,   <code>ChildWindow</code>  <code>PopupChildWindowAction</code> . <br>   ,  <code>InteractionRequestTrigger</code>  <code>PopupChildWindowAction</code> ,       <i>RI MVVM</i> . <br> <br> <code class="xml">&lt;i:Interaction.Triggers&gt; &lt;prism:InteractionRequestTrigger SourceObject="{Binding ConfirmCancelInteractionRequest}"&gt; &lt;prism:PopupChildWindowAction ContentTemplate="{StaticResource ConfirmWindowTemplate}"/&gt; &lt;/prism:InteractionRequestTrigger&gt; &lt;/i:Interaction.Triggers&gt; &lt;UserControl.Resources&gt; &lt;DataTemplate x:Key="ConfirmWindowTemplate"&gt; &lt;Grid MinWidth="250" MinHeight="100"&gt; &lt;TextBlock TextWrapping="Wrap" Grid.Row="0" Text="{Binding}"/&gt; &lt;/Grid&gt; &lt;/DataTemplate&gt; &lt;/UserControl.Resources&gt;</code> <br> <b></b> <br>      <code>ContentTemplate</code> ,   UI   <code>Content</code>  .    <code>Content</code>  ,  , <code>TextBlock</code>     <code>Content</code> . <br>      ,     ,    ,    .  ,     ,       ,     ,    .   ,   <i>RI MVVM</i> ,         <code>Confirmed</code>    <code>Confirmation</code>  <code>true</code> ,     OK. <br> <br>        ,     .  Prism <code>InteractionRequestTrigger</code>   <code>PopupChildWindowAction</code>            . <br> <br>     <br>     MVVM,       , ,    ,         .        (  , ,  ,   ).    ,  ,  ,            . <br> <br>        ,         . Managed Extensibility Framework (MEF)  Unity Application Block (Unity)      ,  ,           . <br> <br>  ,       , , ,    ( )      . ,       ,     .  ,     ,       . <br> <br>     ,  MEF <br>  MEF,       ,   <code>Import</code> ,      ,  ,   <code>Export</code> .         ,    . <br> <br> , <code>QuestionnaireView</code>   <i>RI MVVM</i> ,        ,    <code>Import</code> .   , MEF           .  <code>set</code>        ,   . <br> <br> <code class="cs">[Import] public QuestionnaireViewModel ViewModel { set { this.DataContext = value; } }</code> <br>     ,   . <br> <br> <code class="cs">[Export] public class QuestionnaireViewModel : NotificationObject { ... }</code> <br>        ,   . <br> <br> <code class="cs">public QuestionnaireView() { InitializeComponent(); } [ImportingConstructor] public QuestionnaireView(QuestionnaireViewModel viewModel) : this() { this.DataContext = viewModel; }</code> <br> <b></b> <br>          MEF,   Unity.   ,     ,        .   ,   Visual Studio  Expression Blend, ,        ,     .   ,   ,  ,      ,          <code>InitializeComponent</code> . <br>     ,  Unity <br>  Unity,    ,   MEF.     ,      .    ,         .  ,      . <br> <br>  ,      ,  ,         . ,           ,   . <br> <br> <code class="cs">public QuestionnaireView() { InitializeComponent(); } public QuestionnaireView(QuestionnaireViewModel viewModel) : this() { this.DataContext = viewModel; }</code> <br> <b></b> <br>    ,        ,   Visual Studio  Expression Blend. <br>  ,          ,   . Unity        <code>set</code>   ,   . <br> <br> <code class="cs">public QuestionnaireView() { InitializeComponent(); } [Dependency] public QuestionnaireViewModel ViewModel { set { this.DataContext = value; } }</code> <br>       Unity. <br> <br> <code class="cs">container.RegisterType&lt;QuestionnaireViewModel&gt;();</code> <br>  ,     . <br> <br> <code class="cs">var view = container.Resolve&lt;QuestionnaireView&gt;();</code> <br>     ,    <br>   ,     ,        .        ,   MEF  Unity,        . <br> <br>          .   ,         UI,           . <br> <br> , <i>RI MVVM</i>   ,   ,        .   ,    .      <code>ShowView</code>   UI. <br> <br> <code class="cs">private void NavigateToQuestionnaireList() { //     "questionnaire list". this.uiService.ShowView(ViewNames.QuestionnaireTemplatesList); }</code> <br>  UI      UI .           UI.  <code>ShowView</code>  <code>UIService</code>      (,          ),       ,   . <br> <br> <code class="cs">public void ShowView(string viewName) { var view = this.ViewFactory.GetView(viewName); this.MainWindow.CurrentView = view; }</code> <br> <b></b> <br> Prism       .   ,   ,   ,             .    ,  , " <a href="http://msdn.microsoft.com/en-us/library/gg430861(v%3DPandP.40).aspx">View-Based Navigation</a> "   8, " <a href="http://msdn.microsoft.com/en-us/library/gg430861(v%3DPandP.40).aspx">Navigation</a> ". <br>  MVVM  <br>        MVVM      .           -      mocking . ,   ,        . <br> <br>   <i>INotifyPropertyChanged</i> <br>   <code>INotifyPropertyChanged</code>     ,      .      ,    ;   ,   ,     ,    ,       . <br> <br>   <br> ,       ,           <code>PropertyChanged</code>  ,         .  ,    <code>ChangeTracker</code> ,     MVVM,  ,      .      .     ,    . <br> <br> <code class="cs">var changeTracker = new PropertyChangeTracker(viewModel); viewModel.CurrentState = "newState"; CollectionAssert.Contains(changeTracker.ChangedProperties, "CurrentState");</code> <br> ,     ,     <code>INotifyPropertyChanged</code> ,    ,   ,     . <br> <br>      <br>        ,   ,    <code>set</code>      ,           . ,     ,     ,      ,          . <br> <br> <code class="cs">var changeTracker = new PropertyChangeTracker(viewModel); var question = viewModel.Questions.First() as OpenQuestionViewModel; question.Question.Response = "some text"; CollectionAssert.Contains(changeTracker.ChangedProperties, "UnansweredQuestions");</code> <br>      <br>     <code>INotifyPropertyChanged</code> ,      <code>PropertyChanged</code>        ,  ,     , , .        ,       . <br> <br>   <i>INotifyDataErrorInfo</i> <br>   ,     ,    ,   ,   <code>IDataErrorInfo</code> ,  ( Silverlight)   <code>INotifyDataErrorInfo</code> .   <code>INotifyDataErrorInfo</code>   ,         ,    ,  ,   ,    . <br> <br>       <code>INotifyDataErrorInfo</code> : ,     ,  ,     ,     <code>ErrorsChanged</code> ,      <code>GetErrors</code> , . <br> <br>    <br>     ,      ,     .       ,         <code>GetErrors</code>       ,  ,  ,   .    , ,  ,     ,        .   ,        . <br> <br> <code class="cs">//  . var notifyErrorInfo = (INotifyDataErrorInfo)question; question.Response = -15; Assert.IsTrue(notifyErrorInfo.GetErrors("Response").Cast&lt;ValidationResult&gt;().Any()); //  . var notifyErrorInfo = (INotifyDataErrorInfo)question; question.Response = 15; Assert.IsFalse(notifyErrorInfo.GetErrors("Response").Cast&lt;ValidationResult&gt;().Any());</code> <br>    ,    ,             . <br> <br>    <i>INotifyDataErrorInfo</i> <br>       <code>GetErrors</code> ,   <code>INotifyDataErrorInfo</code>  ,   <code>ErrorsChanged</code>      <code>GetErrors</code> . ,  <code>HasErrors</code>      ,  . <br> <br>       <code>INotifyDataErrorInfo</code> . , ,           ,   -  .      ,        <code>INotifyDataErrorInfo</code>         (,        ). <br> <br>     ,   ,  : <br>  <code>HasErrors</code>     .              ,       .  <code>ErrorsChanged</code> ,      ,         <code>GetErrors</code> .         ( ,  )     ,           .    <code>GetErrors</code>       <code>ErrorsChanged</code> . <br>    <code>INotifyPropertyChanged</code> ,  ,    <code>NotifyDataErrorInfoTestHelper</code>    MVVM,        <code>INotifyDataErrorInfo</code> ,       .   ,   ,      ,   .      . <br> <code class="cs">var helper = new NotifyDataErrorInfoTestHelper&lt;NumericQuestion, int?&gt;( question, q =&gt; q.Response); helper.ValidatePropertyChange( 6, NotifyDataErrorInfoBehavior.Nothing); helper.ValidatePropertyChange( 20, NotifyDataErrorInfoBehavior.FiresErrorsChanged | NotifyDataErrorInfoBehavior.HasErrors | NotifyDataErrorInfoBehavior.HasErrorsForProperty); helper.ValidatePropertyChange( null, NotifyDataErrorInfoBehavior.FiresErrorsChanged | NotifyDataErrorInfoBehavior.HasErrors | NotifyDataErrorInfoBehavior.HasErrorsForProperty); helper.ValidatePropertyChange( 2, NotifyDataErrorInfoBehavior.FiresErrorsChanged);</code> <br>     <br>   MVVM,     ,  .   ,    ,         . <br> <br>  ,     ,     ,       .   ,   , ,       ,     ,   <code>IAsyncResult</code>    ,  - ,   ,    UI. <br> <br>       , , ,    .   ,     .  ,      UI,     ,   ,          ,     ,        "   UI." <br> <br>     ,    ,    .   ,    ,     mock-, ,   ,   ,      ,          . <br> <br>           UI,    ,    .   ,     ,   ,      .        ,   .     ,    ,     . <br> <br> <code class="cs">questionnaireRepositoryMock .Setup( r =&gt; r.SubmitQuestionnaireAsync( It.IsAny&lt;Questionnaire&gt;(), It.IsAny&lt;Action&lt;IOperationResult&gt;&gt;())) .Callback&lt;Questionnaire, Action&lt;IOperationResult&gt;&gt;( (q, a) =&gt; callback = a); uiServicemock .Setup(svc =&gt; svc.ShowView(ViewNames.QuestionnaireTemplatesList)) .Callback&lt;string&gt;(viewName =&gt; requestedViewName = viewName); submitResultMock .Setup(sr =&gt; sr.Error) .Returns&lt;Exception&gt;(null); CompleteQuestionnaire(viewModel); viewModel.Submit(); //      UI . callback(submitResultMock.Object); //    ‚Äì     . Assert.AreEqual(ViewNames.QuestionnaireTemplatesList, requestedViewName);</code> <br> <b></b> <br>          ,        . <br>   <br>       , . "Trees in WPF"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ms753391.aspx">http://msdn.microsoft.com/en-us/library/ms753391.aspx</a> <br> <br>       , . "Attached Properties Overview"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/cc265152(VS.95).aspx">http://msdn.microsoft.com/en-us/library/cc265152(VS.95).aspx</a> <br> <br>      MEF, ."Managed Extensibility Framework Overview"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/dd460648.aspx">http://msdn.microsoft.com/en-us/library/dd460648.aspx</a> . <br> <br>      Unity, ."Unity Application Block"  MSDN: <a href="http://www.msdn.com/unity">http://www.msdn.com/unity</a> . <br> <br>      <code>DelegateCommand</code> , .Chapter 5, " <a href="http://msdn.microsoft.com/en-us/library/gg405484(v%3DPandP.40).aspx">Implementing the MVVM Pattern</a> ." <br> <br>        Microsoft Expression Blend, ."Working with built-in behaviors"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ff724013(v%3DExpression.40).aspx">http://msdn.microsoft.com/en-us/library/ff724013(v=Expression.40).aspx</a> . <br> <br>          Microsoft Expression Blend, ."Creating Custom Behaviors"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ff724708(v%3DExpression.40).aspx">http://msdn.microsoft.com/en-us/library/ff724708(v=Expression.40).aspx</a> . <br> <br>            Microsoft Expression Blend, ."Creating Custom Triggers and Actions"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ff724707(v%3DExpression.40).aspx">http://msdn.microsoft.com/en-us/library/ff724707(v=Expression.40).aspx</a> . <br> <br>         WPF  Silverlight, ."Threading Model"  "The Dispatcher Class"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ms741870.aspx">http://msdn.microsoft.com/en-us/library/ms741870.aspx</a> <br> <a href="http://msdn.microsoft.com/en-us/library/ms615907(v%3DVS.95).aspx">http://msdn.microsoft.com/en-us/library/ms615907(v=VS.95).aspx</a> . <br> <br>      unit-  Silverlight, ."Unit Testing with Silverlight 2": <a href="http://www.jeff.wilcox.name/2008/03/silverlight2-unit-testing/">http://www.jeff.wilcox.name/2008/03/silverlight2-unit-testing/</a> . <br> <br>         , .  " <a href="http://msdn.microsoft.com/en-us/library/gg430861(v%3DPandP.40).aspx">View-Based Navigation</a> " in Chapter 8, " <a href="http://msdn.microsoft.com/en-us/library/gg430861(v%3DPandP.40).aspx">Navigation</a> ." <br> <br>       ,   , ."Event-based Asynchronous Pattern Overview"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/wewwczdw.aspx">http://msdn.microsoft.com/en-us/library/wewwczdw.aspx</a> <br> <br>        <code>IAsyncResult</code> , ."Asynchronous Programming Overview"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ms228963.aspx">http://msdn.microsoft.com/en-us/library/ms228963.aspx</a></code></code></code></code></code></code></code></code></code> </li> </ul> <code><code><code><code><code><code><code><code><code><code>CommandBehaviorBase ,    ,    ICommand</code> .           <code>CanExecuteChanged</code> ,          Silverlight,    WPF. <br> <br>    ,  ,   <code>CommandBehaviorBase    ,    .         ,      .         ,    .      ButtonBaseClickCommandBehavior</code> . <br> <br> <code class="cs">public class ButtonBaseClickCommandBehavior : CommandBehaviorBase&lt;ButtonBase&gt; { public ButtonBaseClickCommandBehavior(ButtonBase clickableObject) : base(clickableObject) { clickableObject.Click += OnClick; } private void OnClick(object sender, System.Windows.RoutedEventArgs e) { ExecuteCommand(); } }</code> <br>   <code>CommandBehaviorBase ,     .     ,          ,   . ,    ,    ,      , ,    CanExecute</code>  ,     . <br> <br>          ,   .           XAML.           .       .  Prism      ,       ,  ,   .       ,    . , ,  ,      <code>Click</code> ,       <code>Command</code> .    <code>Click.Command</code> ,  . <br> <br>             .             . <br> <br> <code class="cs">public static readonly DependencyProperty CommandProperty = DependencyProperty.RegisterAttached( "Command", typeof(ICommand), typeof(Click), new PropertyMetadata(OnSetCommandCallback)); private static readonly DependencyProperty ClickCommandBehaviorProperty = DependencyProperty.RegisterAttached( "ClickCommandBehavior", typeof(ButtonBaseClickCommandBehavior), typeof(Click), null);</code> <br>    <code>Command</code>    <code>ButtonBaseClickCommandBehavior</code> ,     <code>OnSetCommandCallback</code> ,     . <br> <br> <code class="cs">private static void OnSetCommandCallback(DependencyObject dependencyObject, DependencyPropertyChangedEventArgs e) { ButtonBase buttonBase = dependencyObject as ButtonBase; if (buttonBase != null) { ButtonBaseClickCommandBehavior behavior = GetOrCreateBehavior(buttonBase); behavior.Command = e.NewValue as ICommand; } } private static void OnSetCommandParameterCallback(DependencyObject dependencyObject, DependencyPropertyChangedEventArgs e) { ButtonBase buttonBase = dependencyObject as ButtonBase; if (buttonBase != null) { ButtonBaseClickCommandBehavior behavior = GetOrCreateBehavior(buttonBase); behavior.CommandParameter = e.NewValue; } } private static ButtonBaseClickCommandBehavior GetOrCreateBehavior(ButtonBase buttonBase ) { ButtonBaseClickCommandBehavior behavior = buttonBase.GetValue(ClickCommandBehaviorProperty) as ButtonBaseClickCommandBehavior; if ( behavior == null ) { behavior = new ButtonBaseClickCommandBehavior(buttonBase); buttonBase.SetValue(ClickCommandBehaviorProperty, behavior); } return behavior; }</code> <br>        ,  <a href="http://msdn.microsoft.com/en-us/library/cc265152(VS.95).aspx">Attached Properties Overview</a>  MSDN. <br> <br>    <br>              . ,     Silverlight,    -,     ,      ,     .     ,       . <br> <br>        ,    ( )  ,  ,     .  UI       ,            UI. <br> <br>      - <br>   -     ,       <code>IAsyncResult</code> .   ,  ,   ,  <code>GetQuestionnaire</code> ,   : <code>BeginGetQuestionnaire</code>  <code>EndGetQuestionnaire</code> .    ,   <code>BeginGetQuestionnaire</code> .     ,   ,   <code>EndGetQuestionnaire</code>    . <br> <b></b> <br>  .NET Framework 4.5      <code>await</code>  <code>async</code>     <code>*Async</code> .      <a href="http://msdn.microsoft.com/en-us/library/vstudio/hh391443.aspx">"Asynchronous Programming with Async and Await (C# and Visual Basic)"</a> . <br>  ,    <code>EndGetQuestionnaire</code> ,      ,  ()      <code>BeginGetQuestionnaire</code> .     ,      ,   <code>EndGetQuestionnaire</code> ,   . <br> <br> <code class="xml">IAsyncResult asyncResult = this.service.BeginGetQuestionnaire( GetQuestionnaireCompleted, null //  ,      ); private void GetQuestionnaireCompleted(IAsyncResult result) { try { questionnaire = this.service.EndGetQuestionnaire(ar); } catch (Exception ex) { //  -   . } }</code> <br>  ,     <code>End*</code> (  , <code>EndGetQuestionnaire</code> ),    ,      .      , ,          UI.     ,   ,        . <br> <br>        UI,     -,      UI,         UI,   <code>Dispatcher</code>    <code>SynchronizationContext</code> .  WPF  Silverlight,   <code>Dispatcher</code> . <br> <br>      <code>Questionnaire</code>  ,        <code>QuestionnaireView</code> .  Silverlight    <code>CheckAccess</code> ,  ,      UI.  ,     <code>BeginInvoke</code> ,      UI. <br> <br> <code class="cs">var dispatcher = System.Windows.Deployment.Current.Dispatcher; if (dispatcher.CheckAccess()) { QuestionnaireView.DataContext = questionnaire; } else { dispatcher.BeginInvoke(() =&gt; { Questionnaire.DataContext = questionnaire; }); }</code> <br> <i>MVVM RI</i>   ,    ,   <code>IAsyncResult</code> ,   .      ,                 . ,       . <br> <br> <code class="cs">this.questionnaireRepository.GetQuestionnaireAsync( result =&gt; { this.Questionnaire = result.Result; });</code> <br>  <code>result</code>   ,     , , , .    ,     . <br> <br> <code class="cs">this.questionnaireRepository.GetQuestionnaireAsync( result =&gt; { if (result.Error == null) { this.Questionnaire = result.Result; ... } else { // Handle error. } })</code> <br>     <br>        ,      .     , ,             .        ,      ,     ,     . <br> <br>         ,      MVVM,     ,   . ,  -MVVM ,     <code>MessageBox</code>   code-behind UI,      .   MVVM     ,          . <br> <br>     MVVM,              ,          .      ,    ,   ,  ,     . <br> <br>              MVVM.      ,     ,     ,  ,     .    ,         ,     ,          .       . <br> <br>    <br>                  .        ,        .  ,         .         . <br> <br>  ,         ,         ,  .      ,     .           ,       . ,        WPF  Silverlight,        . <br> <br> <img title="Using the service to interact with the user." src="https://habrastorage.org/getpro/habr/post_images/4b5/397/f2d/4b5397f2d02e5851195b29f1893be6fc.png" alt=" ,    ."> <br> <br>  ,   <code>MessageBox</code>        ,     ,    ,     . <br> <br> <code class="cs">var result = interactionService.ShowMessageBox( "Are you sure you want to cancel this operation?", "Confirm", MessageBoxButton.OK); if (result == MessageBoxResult.Yes) { CancelRequest(); }</code> <br> ,      - ,      ,         Silverlight.         .             .     . <br> <br> <code class="cs">interactionService.ShowMessageBox( "Are you sure you want to cancel this operation?", "Confirm", MessageBoxButton.OK, result =&gt; { if (result == MessageBoxResult.Yes) { CancelRequest(); } });</code> <br>         ,      . ,  WPF    <code>MessageBox</code> ,       ;    Silverlight    ,    . <br> <br>     <br>         ‚Äì             .         ,      .     ,     .        ,        ,   ,     . <br> <br> <img title="Using interaction request objects." src="https://habrastorage.org/getpro/habr/post_images/3d0/ff0/1c5/3d0ff01c5518558c2d3c5c5f47ce0ce9.png" alt="   ."> <br> <br>    ,   ,          ‚Äì       ,      ,   ‚Äì     .   ,        ,    ,    UI            . <br> <br>       MVVM,     ,       ,         .         ,        ,    ,   . <br> <br>  Prism       <code>IInteractionRequest</code>   <code>InteractionRequest .  IInteractionRequest</code>  ,   .           ,   .  <code>InteractionRequest   IInteractionRequest</code>     <code>Raise</code> ,           , , ,   . <br> <br>       <br>  <code>InteractionRequest          .  Raise</code>          ( <code>T</code> )    ,    ,   .          ,       .      ,        .    ,  ,     . <br> <code class="cs">public interface IInteractionRequest { event EventHandler&lt;InteractionRequestedEventArgs&gt; Raised; } public class InteractionRequest&lt;T&gt; : IInteractionRequest { public event EventHandler&lt;InteractionRequestedEventArgs&gt; Raised; public void Raise(T context, Action&lt;T&gt; callback) { var handler = this.Raised; if (handler != null) { handler( this, new InteractionRequestedEventArgs(context, () =&gt; callback(context))); } } }</code> <br> Prism    ,      .  <code>Notification</code>       .    ,            .     ‚Äì <code>Title</code>  <code>Content</code> ,    .  ,   ,  ,  ,        . <br> <br>  <code>Confirmation</code>    <code>Notification</code>     ‚Äì <code>Confirmed</code> ,  ,  ,      .  <code>Confirmation</code> ,     <code>MessageBox</code> ,     /  .     ,     <code>Notification</code> ,     ,      . <br> <br>    <code>InteractionRequest ,       InteractionRequest      ,      .      ,    Raise</code> ,    , ,   . <br> <br> <code class="cs">public IInteractionRequest ConfirmCancelInteractionRequest { get { return this.confirmCancelInteractionRequest; } } this.confirmCancelInteractionRequest.Raise( new Confirmation("Are you sure you wish to cancel?"), confirmation =&gt; { if (confirmation.Confirmed) { this.NavigateToQuestionnaireList(); } }); }</code> <br> <i>MVVM Reference Implementation (MVVM RI)</i> ,    <code>IInteractionRequest</code>   <code>InteractionRequest ,          (. QuestionnaireViewModel.cs</code> ). <br> <br>        <br>       ,       .   ,       .    UI             . <br> <br>                . Microsoft Expression Blend Behaviors Framework     .  ,     ,    . <br> <br>  <code>EventTrigger</code> ,  Expression Blend,  ,      ,     ,   . , Prism   <code>EventTrigger</code> ,  <code>InteractionRequestTrigger</code> ,      <code>Raised</code>   <code>IInteractionRequest</code> .    XAML        . <br> <br>  ,   , <code>InteractionRequestTrigger</code>   .  Silverlight Prism   <code>PopupChildWindowAction</code> ,     .    ,         .   <code>ContentTemplate</code>  <code>PopupChildWindowAction</code> ,    ,    UI,      <code>Content</code>  .       <code>Title</code>  . <br> <b></b> <br>  ,    ,   <code>PopupChildWindowAction</code> ,     .    <code>Notification</code>  <code>NotificationChildWindow</code> ,        <code>Confirmation</code> ‚Äì <code>ConfirmationChildWindow</code> . <code>NotificationChildWindow</code>    ,   ,     <code>ConfirmationChildWindow</code>    <i>OK</i>  <i>Cancel</i> ,    .    ,   ,   <code>ChildWindow</code>  <code>PopupChildWindowAction</code> . <br>   ,  <code>InteractionRequestTrigger</code>  <code>PopupChildWindowAction</code> ,       <i>RI MVVM</i> . <br> <br> <code class="xml">&lt;i:Interaction.Triggers&gt; &lt;prism:InteractionRequestTrigger SourceObject="{Binding ConfirmCancelInteractionRequest}"&gt; &lt;prism:PopupChildWindowAction ContentTemplate="{StaticResource ConfirmWindowTemplate}"/&gt; &lt;/prism:InteractionRequestTrigger&gt; &lt;/i:Interaction.Triggers&gt; &lt;UserControl.Resources&gt; &lt;DataTemplate x:Key="ConfirmWindowTemplate"&gt; &lt;Grid MinWidth="250" MinHeight="100"&gt; &lt;TextBlock TextWrapping="Wrap" Grid.Row="0" Text="{Binding}"/&gt; &lt;/Grid&gt; &lt;/DataTemplate&gt; &lt;/UserControl.Resources&gt;</code> <br> <b></b> <br>      <code>ContentTemplate</code> ,   UI   <code>Content</code>  .    <code>Content</code>  ,  , <code>TextBlock</code>     <code>Content</code> . <br>      ,     ,    ,    .  ,     ,       ,     ,    .   ,   <i>RI MVVM</i> ,         <code>Confirmed</code>    <code>Confirmation</code>  <code>true</code> ,     OK. <br> <br>        ,     .  Prism <code>InteractionRequestTrigger</code>   <code>PopupChildWindowAction</code>            . <br> <br>     <br>     MVVM,       , ,    ,         .        (  , ,  ,   ).    ,  ,  ,            . <br> <br>        ,         . Managed Extensibility Framework (MEF)  Unity Application Block (Unity)      ,  ,           . <br> <br>  ,       , , ,    ( )      . ,       ,     .  ,     ,       . <br> <br>     ,  MEF <br>  MEF,       ,   <code>Import</code> ,      ,  ,   <code>Export</code> .         ,    . <br> <br> , <code>QuestionnaireView</code>   <i>RI MVVM</i> ,        ,    <code>Import</code> .   , MEF           .  <code>set</code>        ,   . <br> <br> <code class="cs">[Import] public QuestionnaireViewModel ViewModel { set { this.DataContext = value; } }</code> <br>     ,   . <br> <br> <code class="cs">[Export] public class QuestionnaireViewModel : NotificationObject { ... }</code> <br>        ,   . <br> <br> <code class="cs">public QuestionnaireView() { InitializeComponent(); } [ImportingConstructor] public QuestionnaireView(QuestionnaireViewModel viewModel) : this() { this.DataContext = viewModel; }</code> <br> <b></b> <br>          MEF,   Unity.   ,     ,        .   ,   Visual Studio  Expression Blend, ,        ,     .   ,   ,  ,      ,          <code>InitializeComponent</code> . <br>     ,  Unity <br>  Unity,    ,   MEF.     ,      .    ,         .  ,      . <br> <br>  ,      ,  ,         . ,           ,   . <br> <br> <code class="cs">public QuestionnaireView() { InitializeComponent(); } public QuestionnaireView(QuestionnaireViewModel viewModel) : this() { this.DataContext = viewModel; }</code> <br> <b></b> <br>    ,        ,   Visual Studio  Expression Blend. <br>  ,          ,   . Unity        <code>set</code>   ,   . <br> <br> <code class="cs">public QuestionnaireView() { InitializeComponent(); } [Dependency] public QuestionnaireViewModel ViewModel { set { this.DataContext = value; } }</code> <br>       Unity. <br> <br> <code class="cs">container.RegisterType&lt;QuestionnaireViewModel&gt;();</code> <br>  ,     . <br> <br> <code class="cs">var view = container.Resolve&lt;QuestionnaireView&gt;();</code> <br>     ,    <br>   ,     ,        .        ,   MEF  Unity,        . <br> <br>          .   ,         UI,           . <br> <br> , <i>RI MVVM</i>   ,   ,        .   ,    .      <code>ShowView</code>   UI. <br> <br> <code class="cs">private void NavigateToQuestionnaireList() { //     "questionnaire list". this.uiService.ShowView(ViewNames.QuestionnaireTemplatesList); }</code> <br>  UI      UI .           UI.  <code>ShowView</code>  <code>UIService</code>      (,          ),       ,   . <br> <br> <code class="cs">public void ShowView(string viewName) { var view = this.ViewFactory.GetView(viewName); this.MainWindow.CurrentView = view; }</code> <br> <b></b> <br> Prism       .   ,   ,   ,             .    ,  , " <a href="http://msdn.microsoft.com/en-us/library/gg430861(v%3DPandP.40).aspx">View-Based Navigation</a> "   8, " <a href="http://msdn.microsoft.com/en-us/library/gg430861(v%3DPandP.40).aspx">Navigation</a> ". <br>  MVVM  <br>        MVVM      .           -      mocking . ,   ,        . <br> <br>   <i>INotifyPropertyChanged</i> <br>   <code>INotifyPropertyChanged</code>     ,      .      ,    ;   ,   ,     ,    ,       . <br> <br>   <br> ,       ,           <code>PropertyChanged</code>  ,         .  ,    <code>ChangeTracker</code> ,     MVVM,  ,      .      .     ,    . <br> <br> <code class="cs">var changeTracker = new PropertyChangeTracker(viewModel); viewModel.CurrentState = "newState"; CollectionAssert.Contains(changeTracker.ChangedProperties, "CurrentState");</code> <br> ,     ,     <code>INotifyPropertyChanged</code> ,    ,   ,     . <br> <br>      <br>        ,   ,    <code>set</code>      ,           . ,     ,     ,      ,          . <br> <br> <code class="cs">var changeTracker = new PropertyChangeTracker(viewModel); var question = viewModel.Questions.First() as OpenQuestionViewModel; question.Question.Response = "some text"; CollectionAssert.Contains(changeTracker.ChangedProperties, "UnansweredQuestions");</code> <br>      <br>     <code>INotifyPropertyChanged</code> ,      <code>PropertyChanged</code>        ,  ,     , , .        ,       . <br> <br>   <i>INotifyDataErrorInfo</i> <br>   ,     ,    ,   ,   <code>IDataErrorInfo</code> ,  ( Silverlight)   <code>INotifyDataErrorInfo</code> .   <code>INotifyDataErrorInfo</code>   ,         ,    ,  ,   ,    . <br> <br>       <code>INotifyDataErrorInfo</code> : ,     ,  ,     ,     <code>ErrorsChanged</code> ,      <code>GetErrors</code> , . <br> <br>    <br>     ,      ,     .       ,         <code>GetErrors</code>       ,  ,  ,   .    , ,  ,     ,        .   ,        . <br> <br> <code class="cs">//  . var notifyErrorInfo = (INotifyDataErrorInfo)question; question.Response = -15; Assert.IsTrue(notifyErrorInfo.GetErrors("Response").Cast&lt;ValidationResult&gt;().Any()); //  . var notifyErrorInfo = (INotifyDataErrorInfo)question; question.Response = 15; Assert.IsFalse(notifyErrorInfo.GetErrors("Response").Cast&lt;ValidationResult&gt;().Any());</code> <br>    ,    ,             . <br> <br>    <i>INotifyDataErrorInfo</i> <br>       <code>GetErrors</code> ,   <code>INotifyDataErrorInfo</code>  ,   <code>ErrorsChanged</code>      <code>GetErrors</code> . ,  <code>HasErrors</code>      ,  . <br> <br>       <code>INotifyDataErrorInfo</code> . , ,           ,   -  .      ,        <code>INotifyDataErrorInfo</code>         (,        ). <br> <br>     ,   ,  : <br>  <code>HasErrors</code>     .              ,       .  <code>ErrorsChanged</code> ,      ,         <code>GetErrors</code> .         ( ,  )     ,           .    <code>GetErrors</code>       <code>ErrorsChanged</code> . <br>    <code>INotifyPropertyChanged</code> ,  ,    <code>NotifyDataErrorInfoTestHelper</code>    MVVM,        <code>INotifyDataErrorInfo</code> ,       .   ,   ,      ,   .      . <br> <code class="cs">var helper = new NotifyDataErrorInfoTestHelper&lt;NumericQuestion, int?&gt;( question, q =&gt; q.Response); helper.ValidatePropertyChange( 6, NotifyDataErrorInfoBehavior.Nothing); helper.ValidatePropertyChange( 20, NotifyDataErrorInfoBehavior.FiresErrorsChanged | NotifyDataErrorInfoBehavior.HasErrors | NotifyDataErrorInfoBehavior.HasErrorsForProperty); helper.ValidatePropertyChange( null, NotifyDataErrorInfoBehavior.FiresErrorsChanged | NotifyDataErrorInfoBehavior.HasErrors | NotifyDataErrorInfoBehavior.HasErrorsForProperty); helper.ValidatePropertyChange( 2, NotifyDataErrorInfoBehavior.FiresErrorsChanged);</code> <br>     <br>   MVVM,     ,  .   ,    ,         . <br> <br>  ,     ,     ,       .   ,   , ,       ,     ,   <code>IAsyncResult</code>    ,  - ,   ,    UI. <br> <br>       , , ,    .   ,     .  ,      UI,     ,   ,          ,     ,        "   UI." <br> <br>     ,    ,    .   ,    ,     mock-, ,   ,   ,      ,          . <br> <br>           UI,    ,    .   ,     ,   ,      .        ,   .     ,    ,     . <br> <br> <code class="cs">questionnaireRepositoryMock .Setup( r =&gt; r.SubmitQuestionnaireAsync( It.IsAny&lt;Questionnaire&gt;(), It.IsAny&lt;Action&lt;IOperationResult&gt;&gt;())) .Callback&lt;Questionnaire, Action&lt;IOperationResult&gt;&gt;( (q, a) =&gt; callback = a); uiServicemock .Setup(svc =&gt; svc.ShowView(ViewNames.QuestionnaireTemplatesList)) .Callback&lt;string&gt;(viewName =&gt; requestedViewName = viewName); submitResultMock .Setup(sr =&gt; sr.Error) .Returns&lt;Exception&gt;(null); CompleteQuestionnaire(viewModel); viewModel.Submit(); //      UI . callback(submitResultMock.Object); //    ‚Äì     . Assert.AreEqual(ViewNames.QuestionnaireTemplatesList, requestedViewName);</code> <br> <b></b> <br>          ,        . <br>   <br>       , . "Trees in WPF"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ms753391.aspx">http://msdn.microsoft.com/en-us/library/ms753391.aspx</a> <br> <br>       , . "Attached Properties Overview"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/cc265152(VS.95).aspx">http://msdn.microsoft.com/en-us/library/cc265152(VS.95).aspx</a> <br> <br>      MEF, ."Managed Extensibility Framework Overview"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/dd460648.aspx">http://msdn.microsoft.com/en-us/library/dd460648.aspx</a> . <br> <br>      Unity, ."Unity Application Block"  MSDN: <a href="http://www.msdn.com/unity">http://www.msdn.com/unity</a> . <br> <br>      <code>DelegateCommand</code> , .Chapter 5, " <a href="http://msdn.microsoft.com/en-us/library/gg405484(v%3DPandP.40).aspx">Implementing the MVVM Pattern</a> ." <br> <br>        Microsoft Expression Blend, ."Working with built-in behaviors"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ff724013(v%3DExpression.40).aspx">http://msdn.microsoft.com/en-us/library/ff724013(v=Expression.40).aspx</a> . <br> <br>          Microsoft Expression Blend, ."Creating Custom Behaviors"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ff724708(v%3DExpression.40).aspx">http://msdn.microsoft.com/en-us/library/ff724708(v=Expression.40).aspx</a> . <br> <br>            Microsoft Expression Blend, ."Creating Custom Triggers and Actions"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ff724707(v%3DExpression.40).aspx">http://msdn.microsoft.com/en-us/library/ff724707(v=Expression.40).aspx</a> . <br> <br>         WPF  Silverlight, ."Threading Model"  "The Dispatcher Class"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ms741870.aspx">http://msdn.microsoft.com/en-us/library/ms741870.aspx</a> <br> <a href="http://msdn.microsoft.com/en-us/library/ms615907(v%3DVS.95).aspx">http://msdn.microsoft.com/en-us/library/ms615907(v=VS.95).aspx</a> . <br> <br>      unit-  Silverlight, ."Unit Testing with Silverlight 2": <a href="http://www.jeff.wilcox.name/2008/03/silverlight2-unit-testing/">http://www.jeff.wilcox.name/2008/03/silverlight2-unit-testing/</a> . <br> <br>         , .  " <a href="http://msdn.microsoft.com/en-us/library/gg430861(v%3DPandP.40).aspx">View-Based Navigation</a> " in Chapter 8, " <a href="http://msdn.microsoft.com/en-us/library/gg430861(v%3DPandP.40).aspx">Navigation</a> ." <br> <br>       ,   , ."Event-based Asynchronous Pattern Overview"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/wewwczdw.aspx">http://msdn.microsoft.com/en-us/library/wewwczdw.aspx</a> <br> <br>        <code>IAsyncResult</code> , ."Asynchronous Programming Overview"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ms228963.aspx">http://msdn.microsoft.com/en-us/library/ms228963.aspx</a></code></code></code></code></code></code></code></code></code> <pre> <code class="hljs cmake"><code><code><code><code><code><code><code><code><code class="cs"><code>CommandBehaviorBase ,    ,    ICommand</code> .           <code>CanExecuteChanged</code> ,          Silverlight,    WPF. <br> <br>    ,  ,   <code>CommandBehaviorBase    ,    .         ,      .         ,    .      ButtonBaseClickCommandBehavior</code> . <br> <br> <code class="cs">public class ButtonBaseClickCommandBehavior : CommandBehaviorBase&lt;ButtonBase&gt; { public ButtonBaseClickCommandBehavior(ButtonBase clickableObject) : base(clickableObject) { clickableObject.Click += OnClick; } private void OnClick(object sender, System.Windows.RoutedEventArgs e) { ExecuteCommand(); } }</code> <br>   <code>CommandBehaviorBase ,     .     ,          ,   . ,    ,    ,      , ,    CanExecute</code>  ,     . <br> <br>          ,   .           XAML.           .       .  Prism      ,       ,  ,   .       ,    . , ,  ,      <code>Click</code> ,       <code><span class="hljs-keyword"><span class="hljs-keyword">Command</span></span></code> .    <code>Click.<span class="hljs-keyword"><span class="hljs-keyword">Command</span></span></code> ,  . <br> <br>             .             . <br> <br> <code class="cs">public static readonly DependencyProperty CommandProperty = DependencyProperty.RegisterAttached( <span class="hljs-string"><span class="hljs-string">"Command"</span></span>, typeof(ICommand), typeof(Click), new PropertyMetadata(OnSetCommandCallback)); private static readonly DependencyProperty ClickCommandBehaviorProperty = DependencyProperty.RegisterAttached( <span class="hljs-string"><span class="hljs-string">"ClickCommandBehavior"</span></span>, typeof(ButtonBaseClickCommandBehavior), typeof(Click), null);</code> <br>    <code><span class="hljs-keyword"><span class="hljs-keyword">Command</span></span></code>    <code>ButtonBaseClickCommandBehavior</code> ,     <code>OnSetCommandCallback</code> ,     . <br> <br> <code class="cs">private static void OnSetCommandCallback(DependencyObject dependencyObject, DependencyPropertyChangedEventArgs e) { ButtonBase buttonBase = dependencyObject as ButtonBase; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (buttonBase != null) { ButtonBaseClickCommandBehavior behavior = GetOrCreateBehavior(buttonBase); behavior.<span class="hljs-keyword"><span class="hljs-keyword">Command</span></span> = e.NewValue as ICommand; } } private static void OnSetCommandParameterCallback(DependencyObject dependencyObject, DependencyPropertyChangedEventArgs e) { ButtonBase buttonBase = dependencyObject as ButtonBase; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (buttonBase != null) { ButtonBaseClickCommandBehavior behavior = GetOrCreateBehavior(buttonBase); behavior.CommandParameter = e.NewValue; } } private static ButtonBaseClickCommandBehavior GetOrCreateBehavior(ButtonBase buttonBase ) { ButtonBaseClickCommandBehavior behavior = buttonBase.GetValue(ClickCommandBehaviorProperty) as ButtonBaseClickCommandBehavior; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ( behavior == null ) { behavior = new ButtonBaseClickCommandBehavior(buttonBase); buttonBase.SetValue(ClickCommandBehaviorProperty, behavior); } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> behavior; }</code> <br>        ,  <a href="http://msdn.microsoft.com/en-us/library/cc265152(VS.95).aspx">Attached Properties Overview</a>  MSDN. <br> <br>    <br>              . ,     Silverlight,    -,     ,      ,     .     ,       . <br> <br>        ,    ( )  ,  ,     .  UI       ,            UI. <br> <br>      - <br>   -     ,       <code>IAsyncResult</code> .   ,  ,   ,  <code>GetQuestionnaire</code> ,   : <code>BeginGetQuestionnaire</code>  <code>EndGetQuestionnaire</code> .    ,   <code>BeginGetQuestionnaire</code> .     ,   ,   <code>EndGetQuestionnaire</code>    . <br> <b></b> <br>  .NET Framework <span class="hljs-number"><span class="hljs-number">4.5</span></span>      <code>await</code>  <code>async</code>     <code>*Async</code> .      <a href="http://msdn.microsoft.com/en-us/library/vstudio/hh391443.aspx"><span class="hljs-string"><span class="hljs-string">"Asynchronous Programming with Async and Await (C# and Visual Basic)"</span></span></a> . <br>  ,    <code>EndGetQuestionnaire</code> ,      ,  ()      <code>BeginGetQuestionnaire</code> .     ,      ,   <code>EndGetQuestionnaire</code> ,   . <br> <br> <code class="xml">IAsyncResult asyncResult = this.service.BeginGetQuestionnaire( GetQuestionnaireCompleted, null //  ,      ); private void GetQuestionnaireCompleted(IAsyncResult result) { try { questionnaire = this.service.EndGetQuestionnaire(ar); } catch (Exception ex) { //  -   . } }</code> <br>  ,     <code>End*</code> (  , <code>EndGetQuestionnaire</code> ),    ,      .      , ,          UI.     ,   ,        . <br> <br>        UI,     -,      UI,         UI,   <code>Dispatcher</code>    <code>SynchronizationContext</code> .  WPF  Silverlight,   <code>Dispatcher</code> . <br> <br>      <code>Questionnaire</code>  ,        <code>QuestionnaireView</code> .  Silverlight    <code>CheckAccess</code> ,  ,      UI.  ,     <code>BeginInvoke</code> ,      UI. <br> <br> <code class="cs">var dispatcher = System.Windows.Deployment.Current.Dispatcher; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (dispatcher.CheckAccess()) { QuestionnaireView.DataContext = questionnaire; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { dispatcher.BeginInvoke(() =&gt; { Questionnaire.DataContext = questionnaire; }); }</code> <br> <i>MVVM RI</i>   ,    ,   <code>IAsyncResult</code> ,   .      ,                 . ,       . <br> <br> <code class="cs">this.questionnaireRepository.GetQuestionnaireAsync( result =&gt; { this.Questionnaire = result.Result; });</code> <br>  <code>result</code>   ,     , , , .    ,     . <br> <br> <code class="cs">this.questionnaireRepository.GetQuestionnaireAsync( result =&gt; { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (result.Error == null) { this.Questionnaire = result.Result; ... } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { // Handle error. } })</code> <br>     <br>        ,      .     , ,             .        ,      ,     ,     . <br> <br>         ,      MVVM,     ,   . ,  -MVVM ,     <code>MessageBox</code>   code-behind UI,      .   MVVM     ,          . <br> <br>     MVVM,              ,          .      ,    ,   ,  ,     . <br> <br>              MVVM.      ,     ,     ,  ,     .    ,         ,     ,          .       . <br> <br>    <br>                  .        ,        .  ,         .         . <br> <br>  ,         ,         ,  .      ,     .           ,       . ,        WPF  Silverlight,        . <br> <br> <img title="Using the service to interact with the user." src="https://habrastorage.org/getpro/habr/post_images/4b5/397/f2d/4b5397f2d02e5851195b29f1893be6fc.png" alt=" ,    ."> <br> <br>  ,   <code>MessageBox</code>        ,     ,    ,     . <br> <br> <code class="cs">var result = interactionService.ShowMessageBox( <span class="hljs-string"><span class="hljs-string">"Are you sure you want to cancel this operation?"</span></span>, <span class="hljs-string"><span class="hljs-string">"Confirm"</span></span>, MessageBoxButton.OK); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (result == MessageBoxResult.Yes) { CancelRequest(); }</code> <br> ,      - ,      ,         Silverlight.         .             .     . <br> <br> <code class="cs">interactionService.ShowMessageBox( <span class="hljs-string"><span class="hljs-string">"Are you sure you want to cancel this operation?"</span></span>, <span class="hljs-string"><span class="hljs-string">"Confirm"</span></span>, MessageBoxButton.OK, result =&gt; { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (result == MessageBoxResult.Yes) { CancelRequest(); } });</code> <br>         ,      . ,  WPF    <code>MessageBox</code> ,       ;    Silverlight    ,    . <br> <br>     <br>         ‚Äì             .         ,      .     ,     .        ,        ,   ,     . <br> <br> <img title="Using interaction request objects." src="https://habrastorage.org/getpro/habr/post_images/3d0/ff0/1c5/3d0ff01c5518558c2d3c5c5f47ce0ce9.png" alt="   ."> <br> <br>    ,   ,          ‚Äì       ,      ,   ‚Äì     .   ,        ,    ,    UI            . <br> <br>       MVVM,     ,       ,         .         ,        ,    ,   . <br> <br>  Prism       <code>IInteractionRequest</code>   <code>InteractionRequest .  IInteractionRequest</code>  ,   .           ,   .  <code>InteractionRequest   IInteractionRequest</code>     <code>Raise</code> ,           , , ,   . <br> <br>       <br>  <code>InteractionRequest          .  Raise</code>          ( <code>T</code> )    ,    ,   .          ,       .      ,        .    ,  ,     . <br> <code class="cs">public interface IInteractionRequest { event EventHandler&lt;InteractionRequestedEventArgs&gt; Raised; } public class InteractionRequest&lt;T&gt; : IInteractionRequest { public event EventHandler&lt;InteractionRequestedEventArgs&gt; Raised; public void Raise(T context, Action&lt;T&gt; callback) { var handler = this.Raised; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (handler != null) { handler( this, new InteractionRequestedEventArgs(context, () =&gt; callback(context))); } } }</code> <br> Prism    ,      .  <code>Notification</code>       .    ,            .     ‚Äì <code>Title</code>  <code>Content</code> ,    .  ,   ,  ,  ,        . <br> <br>  <code>Confirmation</code>    <code>Notification</code>     ‚Äì <code>Confirmed</code> ,  ,  ,      .  <code>Confirmation</code> ,     <code>MessageBox</code> ,     /  .     ,     <code>Notification</code> ,     ,      . <br> <br>    <code>InteractionRequest ,       InteractionRequest      ,      .      ,    Raise</code> ,    , ,   . <br> <br> <code class="cs">public IInteractionRequest ConfirmCancelInteractionRequest { get { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> this.confirmCancelInteractionRequest; } } this.confirmCancelInteractionRequest.Raise( new Confirmation(<span class="hljs-string"><span class="hljs-string">"Are you sure you wish to cancel?"</span></span>), confirmation =&gt; { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (confirmation.Confirmed) { this.NavigateToQuestionnaireList(); } }); }</code> <br> <i>MVVM Reference Implementation (MVVM RI)</i> ,    <code>IInteractionRequest</code>   <code>InteractionRequest ,          (. QuestionnaireViewModel.cs</code> ). <br> <br>        <br>       ,       .   ,       .    UI             . <br> <br>                . Microsoft Expression Blend Behaviors Framework     .  ,     ,    . <br> <br>  <code>EventTrigger</code> ,  Expression Blend,  ,      ,     ,   . , Prism   <code>EventTrigger</code> ,  <code>InteractionRequestTrigger</code> ,      <code>Raised</code>   <code>IInteractionRequest</code> .    XAML        . <br> <br>  ,   , <code>InteractionRequestTrigger</code>   .  Silverlight Prism   <code>PopupChildWindowAction</code> ,     .    ,         .   <code>ContentTemplate</code>  <code>PopupChildWindowAction</code> ,    ,    UI,      <code>Content</code>  .       <code>Title</code>  . <br> <b></b> <br>  ,    ,   <code>PopupChildWindowAction</code> ,     .    <code>Notification</code>  <code>NotificationChildWindow</code> ,        <code>Confirmation</code> ‚Äì <code>ConfirmationChildWindow</code> . <code>NotificationChildWindow</code>    ,   ,     <code>ConfirmationChildWindow</code>    <i>OK</i>  <i>Cancel</i> ,    .    ,   ,   <code>ChildWindow</code>  <code>PopupChildWindowAction</code> . <br>   ,  <code>InteractionRequestTrigger</code>  <code>PopupChildWindowAction</code> ,       <i>RI MVVM</i> . <br> <br> <code class="xml">&lt;i:Interaction.Triggers&gt; &lt;prism:InteractionRequestTrigger SourceObject=<span class="hljs-string"><span class="hljs-string">"{Binding ConfirmCancelInteractionRequest}"</span></span>&gt; &lt;prism:PopupChildWindowAction ContentTemplate=<span class="hljs-string"><span class="hljs-string">"{StaticResource ConfirmWindowTemplate}"</span></span>/&gt; &lt;/prism:InteractionRequestTrigger&gt; &lt;/i:Interaction.Triggers&gt; &lt;UserControl.Resources&gt; &lt;DataTemplate x:Key=<span class="hljs-string"><span class="hljs-string">"ConfirmWindowTemplate"</span></span>&gt; &lt;Grid MinWidth=<span class="hljs-string"><span class="hljs-string">"250"</span></span> MinHeight=<span class="hljs-string"><span class="hljs-string">"100"</span></span>&gt; &lt;TextBlock TextWrapping=<span class="hljs-string"><span class="hljs-string">"Wrap"</span></span> Grid.Row=<span class="hljs-string"><span class="hljs-string">"0"</span></span> Text=<span class="hljs-string"><span class="hljs-string">"{Binding}"</span></span>/&gt; &lt;/Grid&gt; &lt;/DataTemplate&gt; &lt;/UserControl.Resources&gt;</code> <br> <b></b> <br>      <code>ContentTemplate</code> ,   UI   <code>Content</code>  .    <code>Content</code>  ,  , <code>TextBlock</code>     <code>Content</code> . <br>      ,     ,    ,    .  ,     ,       ,     ,    .   ,   <i>RI MVVM</i> ,         <code>Confirmed</code>    <code>Confirmation</code>  <code><span class="hljs-keyword"><span class="hljs-keyword">true</span></span></code> ,     OK. <br> <br>        ,     .  Prism <code>InteractionRequestTrigger</code>   <code>PopupChildWindowAction</code>            . <br> <br>     <br>     MVVM,       , ,    ,         .        (  , ,  ,   ).    ,  ,  ,            . <br> <br>        ,         . Managed Extensibility Framework (MEF)  Unity Application Block (Unity)      ,  ,           . <br> <br>  ,       , , ,    ( )      . ,       ,     .  ,     ,       . <br> <br>     ,  MEF <br>  MEF,       ,   <code>Import</code> ,      ,  ,   <code><span class="hljs-keyword"><span class="hljs-keyword">Export</span></span></code> .         ,    . <br> <br> , <code>QuestionnaireView</code>   <i>RI MVVM</i> ,        ,    <code>Import</code> .   , MEF           .  <code><span class="hljs-keyword"><span class="hljs-keyword">set</span></span></code>        ,   . <br> <br> <code class="cs">[Import] public QuestionnaireViewModel ViewModel { <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> { this.DataContext = value; } }</code> <br>     ,   . <br> <br> <code class="cs">[<span class="hljs-keyword"><span class="hljs-keyword">Export</span></span>] public class QuestionnaireViewModel : NotificationObject { ... }</code> <br>        ,   . <br> <br> <code class="cs">public QuestionnaireView() { InitializeComponent(); } [ImportingConstructor] public QuestionnaireView(QuestionnaireViewModel viewModel) : this() { this.DataContext = viewModel; }</code> <br> <b></b> <br>          MEF,   Unity.   ,     ,        .   ,   Visual Studio  Expression Blend, ,        ,     .   ,   ,  ,      ,          <code>InitializeComponent</code> . <br>     ,  Unity <br>  Unity,    ,   MEF.     ,      .    ,         .  ,      . <br> <br>  ,      ,  ,         . ,           ,   . <br> <br> <code class="cs">public QuestionnaireView() { InitializeComponent(); } public QuestionnaireView(QuestionnaireViewModel viewModel) : this() { this.DataContext = viewModel; }</code> <br> <b></b> <br>    ,        ,   Visual Studio  Expression Blend. <br>  ,          ,   . Unity        <code><span class="hljs-keyword"><span class="hljs-keyword">set</span></span></code>   ,   . <br> <br> <code class="cs">public QuestionnaireView() { InitializeComponent(); } [Dependency] public QuestionnaireViewModel ViewModel { <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> { this.DataContext = value; } }</code> <br>       Unity. <br> <br> <code class="cs">container.RegisterType&lt;QuestionnaireViewModel&gt;();</code> <br>  ,     . <br> <br> <code class="cs">var view = container.Resolve&lt;QuestionnaireView&gt;();</code> <br>     ,    <br>   ,     ,        .        ,   MEF  Unity,        . <br> <br>          .   ,         UI,           . <br> <br> , <i>RI MVVM</i>   ,   ,        .   ,    .      <code>ShowView</code>   UI. <br> <br> <code class="cs">private void NavigateToQuestionnaireList() { //     <span class="hljs-string"><span class="hljs-string">"questionnaire list"</span></span>. this.uiService.ShowView(ViewNames.QuestionnaireTemplatesList); }</code> <br>  UI      UI .           UI.  <code>ShowView</code>  <code>UIService</code>      (,          ),       ,   . <br> <br> <code class="cs">public void ShowView(<span class="hljs-keyword"><span class="hljs-keyword">string</span></span> viewName) { var view = this.ViewFactory.GetView(viewName); this.MainWindow.CurrentView = view; }</code> <br> <b></b> <br> Prism       .   ,   ,   ,             .    ,  , <span class="hljs-string"><span class="hljs-string">" </span></span><a href="http://msdn.microsoft.com/en-us/library/gg430861(v%3DPandP.40).aspx"><span class="hljs-string"><span class="hljs-string">View-Based Navigation</span></span></a><span class="hljs-string"><span class="hljs-string"> "</span></span>   <span class="hljs-number"><span class="hljs-number">8</span></span>, <span class="hljs-string"><span class="hljs-string">" </span></span><a href="http://msdn.microsoft.com/en-us/library/gg430861(v%3DPandP.40).aspx"><span class="hljs-string"><span class="hljs-string">Navigation</span></span></a><span class="hljs-string"><span class="hljs-string"> "</span></span>. <br>  MVVM  <br>        MVVM      .           -      mocking . ,   ,        . <br> <br>   <i>INotifyPropertyChanged</i> <br>   <code>INotifyPropertyChanged</code>     ,      .      ,    ;   ,   ,     ,    ,       . <br> <br>   <br> ,       ,           <code>PropertyChanged</code>  ,         .  ,    <code>ChangeTracker</code> ,     MVVM,  ,      .      .     ,    . <br> <br> <code class="cs">var changeTracker = new PropertyChangeTracker(viewModel); viewModel.CurrentState = <span class="hljs-string"><span class="hljs-string">"newState"</span></span>; CollectionAssert.Contains(changeTracker.ChangedProperties, <span class="hljs-string"><span class="hljs-string">"CurrentState"</span></span>);</code> <br> ,     ,     <code>INotifyPropertyChanged</code> ,    ,   ,     . <br> <br>      <br>        ,   ,    <code><span class="hljs-keyword"><span class="hljs-keyword">set</span></span></code>      ,           . ,     ,     ,      ,          . <br> <br> <code class="cs">var changeTracker = new PropertyChangeTracker(viewModel); var question = viewModel.Questions.First() as OpenQuestionViewModel; question.Question.Response = <span class="hljs-string"><span class="hljs-string">"some text"</span></span>; CollectionAssert.Contains(changeTracker.ChangedProperties, <span class="hljs-string"><span class="hljs-string">"UnansweredQuestions"</span></span>);</code> <br>      <br>     <code>INotifyPropertyChanged</code> ,      <code>PropertyChanged</code>        ,  ,     , , .        ,       . <br> <br>   <i>INotifyDataErrorInfo</i> <br>   ,     ,    ,   ,   <code>IDataErrorInfo</code> ,  ( Silverlight)   <code>INotifyDataErrorInfo</code> .   <code>INotifyDataErrorInfo</code>   ,         ,    ,  ,   ,    . <br> <br>       <code>INotifyDataErrorInfo</code> : ,     ,  ,     ,     <code>ErrorsChanged</code> ,      <code>GetErrors</code> , . <br> <br>    <br>     ,      ,     .       ,         <code>GetErrors</code>       ,  ,  ,   .    , ,  ,     ,        .   ,        . <br> <br> <code class="cs">//  . var notifyErrorInfo = (INotifyDataErrorInfo)question; question.Response = -<span class="hljs-number"><span class="hljs-number">15</span></span>; Assert.IsTrue(notifyErrorInfo.GetErrors(<span class="hljs-string"><span class="hljs-string">"Response"</span></span>).Cast&lt;ValidationResult&gt;().Any()); //  . var notifyErrorInfo = (INotifyDataErrorInfo)question; question.Response = <span class="hljs-number"><span class="hljs-number">15</span></span>; Assert.IsFalse(notifyErrorInfo.GetErrors(<span class="hljs-string"><span class="hljs-string">"Response"</span></span>).Cast&lt;ValidationResult&gt;().Any());</code> <br>    ,    ,             . <br> <br>    <i>INotifyDataErrorInfo</i> <br>       <code>GetErrors</code> ,   <code>INotifyDataErrorInfo</code>  ,   <code>ErrorsChanged</code>      <code>GetErrors</code> . ,  <code>HasErrors</code>      ,  . <br> <br>       <code>INotifyDataErrorInfo</code> . , ,           ,   -  .      ,        <code>INotifyDataErrorInfo</code>         (,        ). <br> <br>     ,   ,  : <br>  <code>HasErrors</code>     .              ,       .  <code>ErrorsChanged</code> ,      ,         <code>GetErrors</code> .         ( ,  )     ,           .    <code>GetErrors</code>       <code>ErrorsChanged</code> . <br>    <code>INotifyPropertyChanged</code> ,  ,    <code>NotifyDataErrorInfoTestHelper</code>    MVVM,        <code>INotifyDataErrorInfo</code> ,       .   ,   ,      ,   .      . <br> var helper = new NotifyDataErrorInfoTestHelper&lt;NumericQuestion, int?&gt;( question, q =&gt; q.Response); helper.ValidatePropertyChange( <span class="hljs-number"><span class="hljs-number">6</span></span>, NotifyDataErrorInfoBehavior.Nothing); helper.ValidatePropertyChange( <span class="hljs-number"><span class="hljs-number">20</span></span>, NotifyDataErrorInfoBehavior.FiresErrorsChanged | NotifyDataErrorInfoBehavior.HasErrors | NotifyDataErrorInfoBehavior.HasErrorsForProperty); helper.ValidatePropertyChange( null, NotifyDataErrorInfoBehavior.FiresErrorsChanged | NotifyDataErrorInfoBehavior.HasErrors | NotifyDataErrorInfoBehavior.HasErrorsForProperty); helper.ValidatePropertyChange( <span class="hljs-number"><span class="hljs-number">2</span></span>, NotifyDataErrorInfoBehavior.FiresErrorsChanged); <br>     <br>   MVVM,     ,  .   ,    ,         . <br> <br>  ,     ,     ,       .   ,   , ,       ,     ,   <code>IAsyncResult</code>    ,  - ,   ,    UI. <br> <br>       , , ,    .   ,     .  ,      UI,     ,   ,          ,     ,        <span class="hljs-string"><span class="hljs-string">"   UI."</span></span> <br> <br>     ,    ,    .   ,    ,     mock-, ,   ,   ,      ,          . <br> <br>           UI,    ,    .   ,     ,   ,      .        ,   .     ,    ,     . <br> <br> <code class="cs">questionnaireRepositoryMock .Setup( r =&gt; r.SubmitQuestionnaireAsync( It.IsAny&lt;Questionnaire&gt;(), It.IsAny&lt;Action&lt;IOperationResult&gt;&gt;())) .Callback&lt;Questionnaire, Action&lt;IOperationResult&gt;&gt;( (q, a) =&gt; callback = a); uiServicemock .Setup(svc =&gt; svc.ShowView(ViewNames.QuestionnaireTemplatesList)) .Callback&lt;<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>&gt;(viewName =&gt; requestedViewName = viewName); submitResultMock .Setup(sr =&gt; sr.Error) .Returns&lt;Exception&gt;(null); CompleteQuestionnaire(viewModel); viewModel.Submit(); //      UI . callback(submitResultMock.Object); //    ‚Äì     . Assert.AreEqual(ViewNames.QuestionnaireTemplatesList, requestedViewName);</code> <br> <b></b> <br>          ,        . <br>   <br>       , . <span class="hljs-string"><span class="hljs-string">"Trees in WPF"</span></span>  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ms753391.aspx">http://msdn.microsoft.com/en-us/library/ms753391.aspx</a> <br> <br>       , . <span class="hljs-string"><span class="hljs-string">"Attached Properties Overview"</span></span>  MSDN: <a href="http://msdn.microsoft.com/en-us/library/cc265152(VS.95).aspx">http://msdn.microsoft.com/en-us/library/cc265152(VS.<span class="hljs-number"><span class="hljs-number">95</span></span>).aspx</a> <br> <br>      MEF, .<span class="hljs-string"><span class="hljs-string">"Managed Extensibility Framework Overview"</span></span>  MSDN: <a href="http://msdn.microsoft.com/en-us/library/dd460648.aspx">http://msdn.microsoft.com/en-us/library/dd460648.aspx</a> . <br> <br>      Unity, .<span class="hljs-string"><span class="hljs-string">"Unity Application Block"</span></span>  MSDN: <a href="http://www.msdn.com/unity">http://www.msdn.com/unity</a> . <br> <br>      <code>DelegateCommand</code> , .Chapter <span class="hljs-number"><span class="hljs-number">5</span></span>, <span class="hljs-string"><span class="hljs-string">" </span></span><a href="http://msdn.microsoft.com/en-us/library/gg405484(v%3DPandP.40).aspx"><span class="hljs-string"><span class="hljs-string">Implementing the MVVM Pattern</span></span></a><span class="hljs-string"><span class="hljs-string"> ."</span></span> <br> <br>        Microsoft Expression Blend, .<span class="hljs-string"><span class="hljs-string">"Working with built-in behaviors"</span></span>  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ff724013(v%3DExpression.40).aspx">http://msdn.microsoft.com/en-us/library/ff724013(v=Expression.<span class="hljs-number"><span class="hljs-number">40</span></span>).aspx</a> . <br> <br>          Microsoft Expression Blend, .<span class="hljs-string"><span class="hljs-string">"Creating Custom Behaviors"</span></span>  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ff724708(v%3DExpression.40).aspx">http://msdn.microsoft.com/en-us/library/ff724708(v=Expression.<span class="hljs-number"><span class="hljs-number">40</span></span>).aspx</a> . <br> <br>            Microsoft Expression Blend, .<span class="hljs-string"><span class="hljs-string">"Creating Custom Triggers and Actions"</span></span>  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ff724707(v%3DExpression.40).aspx">http://msdn.microsoft.com/en-us/library/ff724707(v=Expression.<span class="hljs-number"><span class="hljs-number">40</span></span>).aspx</a> . <br> <br>         WPF  Silverlight, .<span class="hljs-string"><span class="hljs-string">"Threading Model"</span></span>  <span class="hljs-string"><span class="hljs-string">"The Dispatcher Class"</span></span>  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ms741870.aspx">http://msdn.microsoft.com/en-us/library/ms741870.aspx</a> <br> <a href="http://msdn.microsoft.com/en-us/library/ms615907(v%3DVS.95).aspx">http://msdn.microsoft.com/en-us/library/ms615907(v=VS.<span class="hljs-number"><span class="hljs-number">95</span></span>).aspx</a> . <br> <br>      unit-  Silverlight, .<span class="hljs-string"><span class="hljs-string">"Unit Testing with Silverlight 2"</span></span>: <a href="http://www.jeff.wilcox.name/2008/03/silverlight2-unit-testing/">http://www.jeff.wilcox.name/<span class="hljs-number"><span class="hljs-number">2008</span></span>/<span class="hljs-number"><span class="hljs-number">03</span></span>/silverlight2-unit-testing/</a> . <br> <br>         , .  <span class="hljs-string"><span class="hljs-string">" </span></span><a href="http://msdn.microsoft.com/en-us/library/gg430861(v%3DPandP.40).aspx"><span class="hljs-string"><span class="hljs-string">View-Based Navigation</span></span></a><span class="hljs-string"><span class="hljs-string"> "</span></span> in Chapter <span class="hljs-number"><span class="hljs-number">8</span></span>, <span class="hljs-string"><span class="hljs-string">" </span></span><a href="http://msdn.microsoft.com/en-us/library/gg430861(v%3DPandP.40).aspx"><span class="hljs-string"><span class="hljs-string">Navigation</span></span></a><span class="hljs-string"><span class="hljs-string"> ."</span></span> <br> <br>       ,   , .<span class="hljs-string"><span class="hljs-string">"Event-based Asynchronous Pattern Overview"</span></span>  MSDN: <a href="http://msdn.microsoft.com/en-us/library/wewwczdw.aspx">http://msdn.microsoft.com/en-us/library/wewwczdw.aspx</a> <br> <br>        <code>IAsyncResult</code> , .<span class="hljs-string"><span class="hljs-string">"Asynchronous Programming Overview"</span></span>  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ms228963.aspx">http://msdn.microsoft.com/en-us/library/ms228963.aspx</a></code></code></code></code></code></code></code></code></code></code> </pre> <code><code><code><code><code><code><code><code><code><code>CommandBehaviorBase ,    ,    ICommand</code> .           <code>CanExecuteChanged</code> ,          Silverlight,    WPF. <br> <br>    ,  ,   <code>CommandBehaviorBase    ,    .         ,      .         ,    .      ButtonBaseClickCommandBehavior</code> . <br> <br> <code class="cs">public class ButtonBaseClickCommandBehavior : CommandBehaviorBase&lt;ButtonBase&gt; { public ButtonBaseClickCommandBehavior(ButtonBase clickableObject) : base(clickableObject) { clickableObject.Click += OnClick; } private void OnClick(object sender, System.Windows.RoutedEventArgs e) { ExecuteCommand(); } }</code> <br>   <code>CommandBehaviorBase ,     .     ,          ,   . ,    ,    ,      , ,    CanExecute</code>  ,     . <br> <br>          ,   .           XAML.           .       .  Prism      ,       ,  ,   .       ,    . , ,  ,      <code>Click</code> ,       <code>Command</code> .    <code>Click.Command</code> ,  . <br> <br>             .             . <br> <br> <code class="cs">public static readonly DependencyProperty CommandProperty = DependencyProperty.RegisterAttached( "Command", typeof(ICommand), typeof(Click), new PropertyMetadata(OnSetCommandCallback)); private static readonly DependencyProperty ClickCommandBehaviorProperty = DependencyProperty.RegisterAttached( "ClickCommandBehavior", typeof(ButtonBaseClickCommandBehavior), typeof(Click), null);</code> <br>    <code>Command</code>    <code>ButtonBaseClickCommandBehavior</code> ,     <code>OnSetCommandCallback</code> ,     . <br> <br> <code class="cs">private static void OnSetCommandCallback(DependencyObject dependencyObject, DependencyPropertyChangedEventArgs e) { ButtonBase buttonBase = dependencyObject as ButtonBase; if (buttonBase != null) { ButtonBaseClickCommandBehavior behavior = GetOrCreateBehavior(buttonBase); behavior.Command = e.NewValue as ICommand; } } private static void OnSetCommandParameterCallback(DependencyObject dependencyObject, DependencyPropertyChangedEventArgs e) { ButtonBase buttonBase = dependencyObject as ButtonBase; if (buttonBase != null) { ButtonBaseClickCommandBehavior behavior = GetOrCreateBehavior(buttonBase); behavior.CommandParameter = e.NewValue; } } private static ButtonBaseClickCommandBehavior GetOrCreateBehavior(ButtonBase buttonBase ) { ButtonBaseClickCommandBehavior behavior = buttonBase.GetValue(ClickCommandBehaviorProperty) as ButtonBaseClickCommandBehavior; if ( behavior == null ) { behavior = new ButtonBaseClickCommandBehavior(buttonBase); buttonBase.SetValue(ClickCommandBehaviorProperty, behavior); } return behavior; }</code> <br>        ,  <a href="http://msdn.microsoft.com/en-us/library/cc265152(VS.95).aspx">Attached Properties Overview</a>  MSDN. <br> <br>    <br>              . ,     Silverlight,    -,     ,      ,     .     ,       . <br> <br>        ,    ( )  ,  ,     .  UI       ,            UI. <br> <br>      - <br>   -     ,       <code>IAsyncResult</code> .   ,  ,   ,  <code>GetQuestionnaire</code> ,   : <code>BeginGetQuestionnaire</code>  <code>EndGetQuestionnaire</code> .    ,   <code>BeginGetQuestionnaire</code> .     ,   ,   <code>EndGetQuestionnaire</code>    . <br> <b></b> <br>  .NET Framework 4.5      <code>await</code>  <code>async</code>     <code>*Async</code> .      <a href="http://msdn.microsoft.com/en-us/library/vstudio/hh391443.aspx">"Asynchronous Programming with Async and Await (C# and Visual Basic)"</a> . <br>  ,    <code>EndGetQuestionnaire</code> ,      ,  ()      <code>BeginGetQuestionnaire</code> .     ,      ,   <code>EndGetQuestionnaire</code> ,   . <br> <br> <code class="xml">IAsyncResult asyncResult = this.service.BeginGetQuestionnaire( GetQuestionnaireCompleted, null //  ,      ); private void GetQuestionnaireCompleted(IAsyncResult result) { try { questionnaire = this.service.EndGetQuestionnaire(ar); } catch (Exception ex) { //  -   . } }</code> <br>  ,     <code>End*</code> (  , <code>EndGetQuestionnaire</code> ),    ,      .      , ,          UI.     ,   ,        . <br> <br>        UI,     -,      UI,         UI,   <code>Dispatcher</code>    <code>SynchronizationContext</code> .  WPF  Silverlight,   <code>Dispatcher</code> . <br> <br>      <code>Questionnaire</code>  ,        <code>QuestionnaireView</code> .  Silverlight    <code>CheckAccess</code> ,  ,      UI.  ,     <code>BeginInvoke</code> ,      UI. <br> <br> <code class="cs">var dispatcher = System.Windows.Deployment.Current.Dispatcher; if (dispatcher.CheckAccess()) { QuestionnaireView.DataContext = questionnaire; } else { dispatcher.BeginInvoke(() =&gt; { Questionnaire.DataContext = questionnaire; }); }</code> <br> <i>MVVM RI</i>   ,    ,   <code>IAsyncResult</code> ,   .      ,                 . ,       . <br> <br> <code class="cs">this.questionnaireRepository.GetQuestionnaireAsync( result =&gt; { this.Questionnaire = result.Result; });</code> <br>  <code>result</code>   ,     , , , .    ,     . <br> <br> <code class="cs">this.questionnaireRepository.GetQuestionnaireAsync( result =&gt; { if (result.Error == null) { this.Questionnaire = result.Result; ... } else { // Handle error. } })</code> <br>     <br>        ,      .     , ,             .        ,      ,     ,     . <br> <br>         ,      MVVM,     ,   . ,  -MVVM ,     <code>MessageBox</code>   code-behind UI,      .   MVVM     ,          . <br> <br>     MVVM,              ,          .      ,    ,   ,  ,     . <br> <br>              MVVM.      ,     ,     ,  ,     .    ,         ,     ,          .       . <br> <br>    <br>                  .        ,        .  ,         .         . <br> <br>  ,         ,         ,  .      ,     .           ,       . ,        WPF  Silverlight,        . <br> <br> <img title="Using the service to interact with the user." src="https://habrastorage.org/getpro/habr/post_images/4b5/397/f2d/4b5397f2d02e5851195b29f1893be6fc.png" alt=" ,    ."> <br> <br>  ,   <code>MessageBox</code>        ,     ,    ,     . <br> <br> <code class="cs">var result = interactionService.ShowMessageBox( "Are you sure you want to cancel this operation?", "Confirm", MessageBoxButton.OK); if (result == MessageBoxResult.Yes) { CancelRequest(); }</code> <br> ,      - ,      ,         Silverlight.         .             .     . <br> <br> <code class="cs">interactionService.ShowMessageBox( "Are you sure you want to cancel this operation?", "Confirm", MessageBoxButton.OK, result =&gt; { if (result == MessageBoxResult.Yes) { CancelRequest(); } });</code> <br>         ,      . ,  WPF    <code>MessageBox</code> ,       ;    Silverlight    ,    . <br> <br>     <br>         ‚Äì             .         ,      .     ,     .        ,        ,   ,     . <br> <br> <img title="Using interaction request objects." src="https://habrastorage.org/getpro/habr/post_images/3d0/ff0/1c5/3d0ff01c5518558c2d3c5c5f47ce0ce9.png" alt="   ."> <br> <br>    ,   ,          ‚Äì       ,      ,   ‚Äì     .   ,        ,    ,    UI            . <br> <br>       MVVM,     ,       ,         .         ,        ,    ,   . <br> <br>  Prism       <code>IInteractionRequest</code>   <code>InteractionRequest .  IInteractionRequest</code>  ,   .           ,   .  <code>InteractionRequest   IInteractionRequest</code>     <code>Raise</code> ,           , , ,   . <br> <br>       <br>  <code>InteractionRequest          .  Raise</code>          ( <code>T</code> )    ,    ,   .          ,       .      ,        .    ,  ,     . <br> <code class="cs">public interface IInteractionRequest { event EventHandler&lt;InteractionRequestedEventArgs&gt; Raised; } public class InteractionRequest&lt;T&gt; : IInteractionRequest { public event EventHandler&lt;InteractionRequestedEventArgs&gt; Raised; public void Raise(T context, Action&lt;T&gt; callback) { var handler = this.Raised; if (handler != null) { handler( this, new InteractionRequestedEventArgs(context, () =&gt; callback(context))); } } }</code> <br> Prism    ,      .  <code>Notification</code>       .    ,            .     ‚Äì <code>Title</code>  <code>Content</code> ,    .  ,   ,  ,  ,        . <br> <br>  <code>Confirmation</code>    <code>Notification</code>     ‚Äì <code>Confirmed</code> ,  ,  ,      .  <code>Confirmation</code> ,     <code>MessageBox</code> ,     /  .     ,     <code>Notification</code> ,     ,      . <br> <br>    <code>InteractionRequest ,       InteractionRequest      ,      .      ,    Raise</code> ,    , ,   . <br> <br> <code class="cs">public IInteractionRequest ConfirmCancelInteractionRequest { get { return this.confirmCancelInteractionRequest; } } this.confirmCancelInteractionRequest.Raise( new Confirmation("Are you sure you wish to cancel?"), confirmation =&gt; { if (confirmation.Confirmed) { this.NavigateToQuestionnaireList(); } }); }</code> <br> <i>MVVM Reference Implementation (MVVM RI)</i> ,    <code>IInteractionRequest</code>   <code>InteractionRequest ,          (. QuestionnaireViewModel.cs</code> ). <br> <br>        <br>       ,       .   ,       .    UI             . <br> <br>                . Microsoft Expression Blend Behaviors Framework     .  ,     ,    . <br> <br>  <code>EventTrigger</code> ,  Expression Blend,  ,      ,     ,   . , Prism   <code>EventTrigger</code> ,  <code>InteractionRequestTrigger</code> ,      <code>Raised</code>   <code>IInteractionRequest</code> .    XAML        . <br> <br>  ,   , <code>InteractionRequestTrigger</code>   .  Silverlight Prism   <code>PopupChildWindowAction</code> ,     .    ,         .   <code>ContentTemplate</code>  <code>PopupChildWindowAction</code> ,    ,    UI,      <code>Content</code>  .       <code>Title</code>  . <br> <b></b> <br>  ,    ,   <code>PopupChildWindowAction</code> ,     .    <code>Notification</code>  <code>NotificationChildWindow</code> ,        <code>Confirmation</code> ‚Äì <code>ConfirmationChildWindow</code> . <code>NotificationChildWindow</code>    ,   ,     <code>ConfirmationChildWindow</code>    <i>OK</i>  <i>Cancel</i> ,    .    ,   ,   <code>ChildWindow</code>  <code>PopupChildWindowAction</code> . <br>   ,  <code>InteractionRequestTrigger</code>  <code>PopupChildWindowAction</code> ,       <i>RI MVVM</i> . <br> <br> <code class="xml">&lt;i:Interaction.Triggers&gt; &lt;prism:InteractionRequestTrigger SourceObject="{Binding ConfirmCancelInteractionRequest}"&gt; &lt;prism:PopupChildWindowAction ContentTemplate="{StaticResource ConfirmWindowTemplate}"/&gt; &lt;/prism:InteractionRequestTrigger&gt; &lt;/i:Interaction.Triggers&gt; &lt;UserControl.Resources&gt; &lt;DataTemplate x:Key="ConfirmWindowTemplate"&gt; &lt;Grid MinWidth="250" MinHeight="100"&gt; &lt;TextBlock TextWrapping="Wrap" Grid.Row="0" Text="{Binding}"/&gt; &lt;/Grid&gt; &lt;/DataTemplate&gt; &lt;/UserControl.Resources&gt;</code> <br> <b></b> <br>      <code>ContentTemplate</code> ,   UI   <code>Content</code>  .    <code>Content</code>  ,  , <code>TextBlock</code>     <code>Content</code> . <br>      ,     ,    ,    .  ,     ,       ,     ,    .   ,   <i>RI MVVM</i> ,         <code>Confirmed</code>    <code>Confirmation</code>  <code>true</code> ,     OK. <br> <br>        ,     .  Prism <code>InteractionRequestTrigger</code>   <code>PopupChildWindowAction</code>            . <br> <br>     <br>     MVVM,       , ,    ,         .        (  , ,  ,   ).    ,  ,  ,            . <br> <br>        ,         . Managed Extensibility Framework (MEF)  Unity Application Block (Unity)      ,  ,           . <br> <br>  ,       , , ,    ( )      . ,       ,     .  ,     ,       . <br> <br>     ,  MEF <br>  MEF,       ,   <code>Import</code> ,      ,  ,   <code>Export</code> .         ,    . <br> <br> , <code>QuestionnaireView</code>   <i>RI MVVM</i> ,        ,    <code>Import</code> .   , MEF           .  <code>set</code>        ,   . <br> <br> <code class="cs">[Import] public QuestionnaireViewModel ViewModel { set { this.DataContext = value; } }</code> <br>     ,   . <br> <br> <code class="cs">[Export] public class QuestionnaireViewModel : NotificationObject { ... }</code> <br>        ,   . <br> <br> <code class="cs">public QuestionnaireView() { InitializeComponent(); } [ImportingConstructor] public QuestionnaireView(QuestionnaireViewModel viewModel) : this() { this.DataContext = viewModel; }</code> <br> <b></b> <br>          MEF,   Unity.   ,     ,        .   ,   Visual Studio  Expression Blend, ,        ,     .   ,   ,  ,      ,          <code>InitializeComponent</code> . <br>     ,  Unity <br>  Unity,    ,   MEF.     ,      .    ,         .  ,      . <br> <br>  ,      ,  ,         . ,           ,   . <br> <br> <code class="cs">public QuestionnaireView() { InitializeComponent(); } public QuestionnaireView(QuestionnaireViewModel viewModel) : this() { this.DataContext = viewModel; }</code> <br> <b></b> <br>    ,        ,   Visual Studio  Expression Blend. <br>  ,          ,   . Unity        <code>set</code>   ,   . <br> <br> <code class="cs">public QuestionnaireView() { InitializeComponent(); } [Dependency] public QuestionnaireViewModel ViewModel { set { this.DataContext = value; } }</code> <br>       Unity. <br> <br> <code class="cs">container.RegisterType&lt;QuestionnaireViewModel&gt;();</code> <br>  ,     . <br> <br> <code class="cs">var view = container.Resolve&lt;QuestionnaireView&gt;();</code> <br>     ,    <br>   ,     ,        .        ,   MEF  Unity,        . <br> <br>          .   ,         UI,           . <br> <br> , <i>RI MVVM</i>   ,   ,        .   ,    .      <code>ShowView</code>   UI. <br> <br> <code class="cs">private void NavigateToQuestionnaireList() { //     "questionnaire list". this.uiService.ShowView(ViewNames.QuestionnaireTemplatesList); }</code> <br>  UI      UI .           UI.  <code>ShowView</code>  <code>UIService</code>      (,          ),       ,   . <br> <br> <code class="cs">public void ShowView(string viewName) { var view = this.ViewFactory.GetView(viewName); this.MainWindow.CurrentView = view; }</code> <br> <b></b> <br> Prism       .   ,   ,   ,             .    ,  , " <a href="http://msdn.microsoft.com/en-us/library/gg430861(v%3DPandP.40).aspx">View-Based Navigation</a> "   8, " <a href="http://msdn.microsoft.com/en-us/library/gg430861(v%3DPandP.40).aspx">Navigation</a> ". <br>  MVVM  <br>        MVVM      .           -      mocking . ,   ,        . <br> <br>   <i>INotifyPropertyChanged</i> <br>   <code>INotifyPropertyChanged</code>     ,      .      ,    ;   ,   ,     ,    ,       . <br> <br>   <br> ,       ,           <code>PropertyChanged</code>  ,         .  ,    <code>ChangeTracker</code> ,     MVVM,  ,      .      .     ,    . <br> <br> <code class="cs">var changeTracker = new PropertyChangeTracker(viewModel); viewModel.CurrentState = "newState"; CollectionAssert.Contains(changeTracker.ChangedProperties, "CurrentState");</code> <br> ,     ,     <code>INotifyPropertyChanged</code> ,    ,   ,     . <br> <br>      <br>        ,   ,    <code>set</code>      ,           . ,     ,     ,      ,          . <br> <br> <code class="cs">var changeTracker = new PropertyChangeTracker(viewModel); var question = viewModel.Questions.First() as OpenQuestionViewModel; question.Question.Response = "some text"; CollectionAssert.Contains(changeTracker.ChangedProperties, "UnansweredQuestions");</code> <br>      <br>     <code>INotifyPropertyChanged</code> ,      <code>PropertyChanged</code>        ,  ,     , , .        ,       . <br> <br>   <i>INotifyDataErrorInfo</i> <br>   ,     ,    ,   ,   <code>IDataErrorInfo</code> ,  ( Silverlight)   <code>INotifyDataErrorInfo</code> .   <code>INotifyDataErrorInfo</code>   ,         ,    ,  ,   ,    . <br> <br>       <code>INotifyDataErrorInfo</code> : ,     ,  ,     ,     <code>ErrorsChanged</code> ,      <code>GetErrors</code> , . <br> <br>    <br>     ,      ,     .       ,         <code>GetErrors</code>       ,  ,  ,   .    , ,  ,     ,        .   ,        . <br> <br> <code class="cs">//  . var notifyErrorInfo = (INotifyDataErrorInfo)question; question.Response = -15; Assert.IsTrue(notifyErrorInfo.GetErrors("Response").Cast&lt;ValidationResult&gt;().Any()); //  . var notifyErrorInfo = (INotifyDataErrorInfo)question; question.Response = 15; Assert.IsFalse(notifyErrorInfo.GetErrors("Response").Cast&lt;ValidationResult&gt;().Any());</code> <br>    ,    ,             . <br> <br>    <i>INotifyDataErrorInfo</i> <br>       <code>GetErrors</code> ,   <code>INotifyDataErrorInfo</code>  ,   <code>ErrorsChanged</code>      <code>GetErrors</code> . ,  <code>HasErrors</code>      ,  . <br> <br>       <code>INotifyDataErrorInfo</code> . , ,           ,   -  .      ,        <code>INotifyDataErrorInfo</code>         (,        ). <br> <br>     ,   ,  : <br>  <code>HasErrors</code>     .              ,       .  <code>ErrorsChanged</code> ,      ,         <code>GetErrors</code> .         ( ,  )     ,           .    <code>GetErrors</code>       <code>ErrorsChanged</code> . <br>    <code>INotifyPropertyChanged</code> ,  ,    <code>NotifyDataErrorInfoTestHelper</code>    MVVM,        <code>INotifyDataErrorInfo</code> ,       .   ,   ,      ,   .      . <br> <code class="cs">var helper = new NotifyDataErrorInfoTestHelper&lt;NumericQuestion, int?&gt;( question, q =&gt; q.Response); helper.ValidatePropertyChange( 6, NotifyDataErrorInfoBehavior.Nothing); helper.ValidatePropertyChange( 20, NotifyDataErrorInfoBehavior.FiresErrorsChanged | NotifyDataErrorInfoBehavior.HasErrors | NotifyDataErrorInfoBehavior.HasErrorsForProperty); helper.ValidatePropertyChange( null, NotifyDataErrorInfoBehavior.FiresErrorsChanged | NotifyDataErrorInfoBehavior.HasErrors | NotifyDataErrorInfoBehavior.HasErrorsForProperty); helper.ValidatePropertyChange( 2, NotifyDataErrorInfoBehavior.FiresErrorsChanged);</code> <br>     <br>   MVVM,     ,  .   ,    ,         . <br> <br>  ,     ,     ,       .   ,   , ,       ,     ,   <code>IAsyncResult</code>    ,  - ,   ,    UI. <br> <br>       , , ,    .   ,     .  ,      UI,     ,   ,          ,     ,        "   UI." <br> <br>     ,    ,    .   ,    ,     mock-, ,   ,   ,      ,          . <br> <br>           UI,    ,    .   ,     ,   ,      .        ,   .     ,    ,     . <br> <br> <code class="cs">questionnaireRepositoryMock .Setup( r =&gt; r.SubmitQuestionnaireAsync( It.IsAny&lt;Questionnaire&gt;(), It.IsAny&lt;Action&lt;IOperationResult&gt;&gt;())) .Callback&lt;Questionnaire, Action&lt;IOperationResult&gt;&gt;( (q, a) =&gt; callback = a); uiServicemock .Setup(svc =&gt; svc.ShowView(ViewNames.QuestionnaireTemplatesList)) .Callback&lt;string&gt;(viewName =&gt; requestedViewName = viewName); submitResultMock .Setup(sr =&gt; sr.Error) .Returns&lt;Exception&gt;(null); CompleteQuestionnaire(viewModel); viewModel.Submit(); //      UI . callback(submitResultMock.Object); //    ‚Äì     . Assert.AreEqual(ViewNames.QuestionnaireTemplatesList, requestedViewName);</code> <br> <b></b> <br>          ,        . <br>   <br>       , . "Trees in WPF"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ms753391.aspx">http://msdn.microsoft.com/en-us/library/ms753391.aspx</a> <br> <br>       , . "Attached Properties Overview"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/cc265152(VS.95).aspx">http://msdn.microsoft.com/en-us/library/cc265152(VS.95).aspx</a> <br> <br>      MEF, ."Managed Extensibility Framework Overview"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/dd460648.aspx">http://msdn.microsoft.com/en-us/library/dd460648.aspx</a> . <br> <br>      Unity, ."Unity Application Block"  MSDN: <a href="http://www.msdn.com/unity">http://www.msdn.com/unity</a> . <br> <br>      <code>DelegateCommand</code> , .Chapter 5, " <a href="http://msdn.microsoft.com/en-us/library/gg405484(v%3DPandP.40).aspx">Implementing the MVVM Pattern</a> ." <br> <br>        Microsoft Expression Blend, ."Working with built-in behaviors"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ff724013(v%3DExpression.40).aspx">http://msdn.microsoft.com/en-us/library/ff724013(v=Expression.40).aspx</a> . <br> <br>          Microsoft Expression Blend, ."Creating Custom Behaviors"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ff724708(v%3DExpression.40).aspx">http://msdn.microsoft.com/en-us/library/ff724708(v=Expression.40).aspx</a> . <br> <br>            Microsoft Expression Blend, ."Creating Custom Triggers and Actions"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ff724707(v%3DExpression.40).aspx">http://msdn.microsoft.com/en-us/library/ff724707(v=Expression.40).aspx</a> . <br> <br>         WPF  Silverlight, ."Threading Model"  "The Dispatcher Class"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ms741870.aspx">http://msdn.microsoft.com/en-us/library/ms741870.aspx</a> <br> <a href="http://msdn.microsoft.com/en-us/library/ms615907(v%3DVS.95).aspx">http://msdn.microsoft.com/en-us/library/ms615907(v=VS.95).aspx</a> . <br> <br>      unit-  Silverlight, ."Unit Testing with Silverlight 2": <a href="http://www.jeff.wilcox.name/2008/03/silverlight2-unit-testing/">http://www.jeff.wilcox.name/2008/03/silverlight2-unit-testing/</a> . <br> <br>         , .  " <a href="http://msdn.microsoft.com/en-us/library/gg430861(v%3DPandP.40).aspx">View-Based Navigation</a> " in Chapter 8, " <a href="http://msdn.microsoft.com/en-us/library/gg430861(v%3DPandP.40).aspx">Navigation</a> ." <br> <br>       ,   , ."Event-based Asynchronous Pattern Overview"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/wewwczdw.aspx">http://msdn.microsoft.com/en-us/library/wewwczdw.aspx</a> <br> <br>        <code>IAsyncResult</code> , ."Asynchronous Programming Overview"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ms228963.aspx">http://msdn.microsoft.com/en-us/library/ms228963.aspx</a></code></code></code></code></code></code></code></code></code> <h4> <code><code><code><code><code><code><code><code><code><code>CommandBehaviorBase ,    ,    ICommand</code> .           <code>CanExecuteChanged</code> ,          Silverlight,    WPF. <br> <br>    ,  ,   <code>CommandBehaviorBase    ,    .         ,      .         ,    .      ButtonBaseClickCommandBehavior</code> . <br> <br> <code class="cs">public class ButtonBaseClickCommandBehavior : CommandBehaviorBase&lt;ButtonBase&gt; { public ButtonBaseClickCommandBehavior(ButtonBase clickableObject) : base(clickableObject) { clickableObject.Click += OnClick; } private void OnClick(object sender, System.Windows.RoutedEventArgs e) { ExecuteCommand(); } }</code> <br>   <code>CommandBehaviorBase ,     .     ,          ,   . ,    ,    ,      , ,    CanExecute</code>  ,     . <br> <br>          ,   .           XAML.           .       .  Prism      ,       ,  ,   .       ,    . , ,  ,      <code>Click</code> ,       <code>Command</code> .    <code>Click.Command</code> ,  . <br> <br>             .             . <br> <br> <code class="cs">public static readonly DependencyProperty CommandProperty = DependencyProperty.RegisterAttached( "Command", typeof(ICommand), typeof(Click), new PropertyMetadata(OnSetCommandCallback)); private static readonly DependencyProperty ClickCommandBehaviorProperty = DependencyProperty.RegisterAttached( "ClickCommandBehavior", typeof(ButtonBaseClickCommandBehavior), typeof(Click), null);</code> <br>    <code>Command</code>    <code>ButtonBaseClickCommandBehavior</code> ,     <code>OnSetCommandCallback</code> ,     . <br> <br> <code class="cs">private static void OnSetCommandCallback(DependencyObject dependencyObject, DependencyPropertyChangedEventArgs e) { ButtonBase buttonBase = dependencyObject as ButtonBase; if (buttonBase != null) { ButtonBaseClickCommandBehavior behavior = GetOrCreateBehavior(buttonBase); behavior.Command = e.NewValue as ICommand; } } private static void OnSetCommandParameterCallback(DependencyObject dependencyObject, DependencyPropertyChangedEventArgs e) { ButtonBase buttonBase = dependencyObject as ButtonBase; if (buttonBase != null) { ButtonBaseClickCommandBehavior behavior = GetOrCreateBehavior(buttonBase); behavior.CommandParameter = e.NewValue; } } private static ButtonBaseClickCommandBehavior GetOrCreateBehavior(ButtonBase buttonBase ) { ButtonBaseClickCommandBehavior behavior = buttonBase.GetValue(ClickCommandBehaviorProperty) as ButtonBaseClickCommandBehavior; if ( behavior == null ) { behavior = new ButtonBaseClickCommandBehavior(buttonBase); buttonBase.SetValue(ClickCommandBehaviorProperty, behavior); } return behavior; }</code> <br>        ,  <a href="http://msdn.microsoft.com/en-us/library/cc265152(VS.95).aspx">Attached Properties Overview</a>  MSDN. <br> <br>    <br>              . ,     Silverlight,    -,     ,      ,     .     ,       . <br> <br>        ,    ( )  ,  ,     .  UI       ,            UI. <br> <br>      - <br>   -     ,       <code>IAsyncResult</code> .   ,  ,   ,  <code>GetQuestionnaire</code> ,   : <code>BeginGetQuestionnaire</code>  <code>EndGetQuestionnaire</code> .    ,   <code>BeginGetQuestionnaire</code> .     ,   ,   <code>EndGetQuestionnaire</code>    . <br> <b></b> <br>  .NET Framework 4.5      <code>await</code>  <code>async</code>     <code>*Async</code> .      <a href="http://msdn.microsoft.com/en-us/library/vstudio/hh391443.aspx">"Asynchronous Programming with Async and Await (C# and Visual Basic)"</a> . <br>  ,    <code>EndGetQuestionnaire</code> ,      ,  ()      <code>BeginGetQuestionnaire</code> .     ,      ,   <code>EndGetQuestionnaire</code> ,   . <br> <br> <code class="xml">IAsyncResult asyncResult = this.service.BeginGetQuestionnaire( GetQuestionnaireCompleted, null //  ,      ); private void GetQuestionnaireCompleted(IAsyncResult result) { try { questionnaire = this.service.EndGetQuestionnaire(ar); } catch (Exception ex) { //  -   . } }</code> <br>  ,     <code>End*</code> (  , <code>EndGetQuestionnaire</code> ),    ,      .      , ,          UI.     ,   ,        . <br> <br>        UI,     -,      UI,         UI,   <code>Dispatcher</code>    <code>SynchronizationContext</code> .  WPF  Silverlight,   <code>Dispatcher</code> . <br> <br>      <code>Questionnaire</code>  ,        <code>QuestionnaireView</code> .  Silverlight    <code>CheckAccess</code> ,  ,      UI.  ,     <code>BeginInvoke</code> ,      UI. <br> <br> <code class="cs">var dispatcher = System.Windows.Deployment.Current.Dispatcher; if (dispatcher.CheckAccess()) { QuestionnaireView.DataContext = questionnaire; } else { dispatcher.BeginInvoke(() =&gt; { Questionnaire.DataContext = questionnaire; }); }</code> <br> <i>MVVM RI</i>   ,    ,   <code>IAsyncResult</code> ,   .      ,                 . ,       . <br> <br> <code class="cs">this.questionnaireRepository.GetQuestionnaireAsync( result =&gt; { this.Questionnaire = result.Result; });</code> <br>  <code>result</code>   ,     , , , .    ,     . <br> <br> <code class="cs">this.questionnaireRepository.GetQuestionnaireAsync( result =&gt; { if (result.Error == null) { this.Questionnaire = result.Result; ... } else { // Handle error. } })</code> <br>     <br>        ,      .     , ,             .        ,      ,     ,     . <br> <br>         ,      MVVM,     ,   . ,  -MVVM ,     <code>MessageBox</code>   code-behind UI,      .   MVVM     ,          . <br> <br>     MVVM,              ,          .      ,    ,   ,  ,     . <br> <br>              MVVM.      ,     ,     ,  ,     .    ,         ,     ,          .       . <br> <br>    <br>                  .        ,        .  ,         .         . <br> <br>  ,         ,         ,  .      ,     .           ,       . ,        WPF  Silverlight,        . <br> <br> <img title="Using the service to interact with the user." src="https://habrastorage.org/getpro/habr/post_images/4b5/397/f2d/4b5397f2d02e5851195b29f1893be6fc.png" alt=" ,    ."> <br> <br>  ,   <code>MessageBox</code>        ,     ,    ,     . <br> <br> <code class="cs">var result = interactionService.ShowMessageBox( "Are you sure you want to cancel this operation?", "Confirm", MessageBoxButton.OK); if (result == MessageBoxResult.Yes) { CancelRequest(); }</code> <br> ,      - ,      ,         Silverlight.         .             .     . <br> <br> <code class="cs">interactionService.ShowMessageBox( "Are you sure you want to cancel this operation?", "Confirm", MessageBoxButton.OK, result =&gt; { if (result == MessageBoxResult.Yes) { CancelRequest(); } });</code> <br>         ,      . ,  WPF    <code>MessageBox</code> ,       ;    Silverlight    ,    . <br> <br>     <br>         ‚Äì             .         ,      .     ,     .        ,        ,   ,     . <br> <br> <img title="Using interaction request objects." src="https://habrastorage.org/getpro/habr/post_images/3d0/ff0/1c5/3d0ff01c5518558c2d3c5c5f47ce0ce9.png" alt="   ."> <br> <br>    ,   ,          ‚Äì       ,      ,   ‚Äì     .   ,        ,    ,    UI            . <br> <br>       MVVM,     ,       ,         .         ,        ,    ,   . <br> <br>  Prism       <code>IInteractionRequest</code>   <code>InteractionRequest .  IInteractionRequest</code>  ,   .           ,   .  <code>InteractionRequest   IInteractionRequest</code>     <code>Raise</code> ,           , , ,   . <br> <br>       <br>  <code>InteractionRequest          .  Raise</code>          ( <code>T</code> )    ,    ,   .          ,       .      ,        .    ,  ,     . <br> <code class="cs">public interface IInteractionRequest { event EventHandler&lt;InteractionRequestedEventArgs&gt; Raised; } public class InteractionRequest&lt;T&gt; : IInteractionRequest { public event EventHandler&lt;InteractionRequestedEventArgs&gt; Raised; public void Raise(T context, Action&lt;T&gt; callback) { var handler = this.Raised; if (handler != null) { handler( this, new InteractionRequestedEventArgs(context, () =&gt; callback(context))); } } }</code> <br> Prism    ,      .  <code>Notification</code>       .    ,            .     ‚Äì <code>Title</code>  <code>Content</code> ,    .  ,   ,  ,  ,        . <br> <br>  <code>Confirmation</code>    <code>Notification</code>     ‚Äì <code>Confirmed</code> ,  ,  ,      .  <code>Confirmation</code> ,     <code>MessageBox</code> ,     /  .     ,     <code>Notification</code> ,     ,      . <br> <br>    <code>InteractionRequest ,       InteractionRequest      ,      .      ,    Raise</code> ,    , ,   . <br> <br> <code class="cs">public IInteractionRequest ConfirmCancelInteractionRequest { get { return this.confirmCancelInteractionRequest; } } this.confirmCancelInteractionRequest.Raise( new Confirmation("Are you sure you wish to cancel?"), confirmation =&gt; { if (confirmation.Confirmed) { this.NavigateToQuestionnaireList(); } }); }</code> <br> <i>MVVM Reference Implementation (MVVM RI)</i> ,    <code>IInteractionRequest</code>   <code>InteractionRequest ,          (. QuestionnaireViewModel.cs</code> ). <br> <br>        <br>       ,       .   ,       .    UI             . <br> <br>                . Microsoft Expression Blend Behaviors Framework     .  ,     ,    . <br> <br>  <code>EventTrigger</code> ,  Expression Blend,  ,      ,     ,   . , Prism   <code>EventTrigger</code> ,  <code>InteractionRequestTrigger</code> ,      <code>Raised</code>   <code>IInteractionRequest</code> .    XAML        . <br> <br>  ,   , <code>InteractionRequestTrigger</code>   .  Silverlight Prism   <code>PopupChildWindowAction</code> ,     .    ,         .   <code>ContentTemplate</code>  <code>PopupChildWindowAction</code> ,    ,    UI,      <code>Content</code>  .       <code>Title</code>  . <br> <b></b> <br>  ,    ,   <code>PopupChildWindowAction</code> ,     .    <code>Notification</code>  <code>NotificationChildWindow</code> ,        <code>Confirmation</code> ‚Äì <code>ConfirmationChildWindow</code> . <code>NotificationChildWindow</code>    ,   ,     <code>ConfirmationChildWindow</code>    <i>OK</i>  <i>Cancel</i> ,    .    ,   ,   <code>ChildWindow</code>  <code>PopupChildWindowAction</code> . <br>   ,  <code>InteractionRequestTrigger</code>  <code>PopupChildWindowAction</code> ,       <i>RI MVVM</i> . <br> <br> <code class="xml">&lt;i:Interaction.Triggers&gt; &lt;prism:InteractionRequestTrigger SourceObject="{Binding ConfirmCancelInteractionRequest}"&gt; &lt;prism:PopupChildWindowAction ContentTemplate="{StaticResource ConfirmWindowTemplate}"/&gt; &lt;/prism:InteractionRequestTrigger&gt; &lt;/i:Interaction.Triggers&gt; &lt;UserControl.Resources&gt; &lt;DataTemplate x:Key="ConfirmWindowTemplate"&gt; &lt;Grid MinWidth="250" MinHeight="100"&gt; &lt;TextBlock TextWrapping="Wrap" Grid.Row="0" Text="{Binding}"/&gt; &lt;/Grid&gt; &lt;/DataTemplate&gt; &lt;/UserControl.Resources&gt;</code> <br> <b></b> <br>      <code>ContentTemplate</code> ,   UI   <code>Content</code>  .    <code>Content</code>  ,  , <code>TextBlock</code>     <code>Content</code> . <br>      ,     ,    ,    .  ,     ,       ,     ,    .   ,   <i>RI MVVM</i> ,         <code>Confirmed</code>    <code>Confirmation</code>  <code>true</code> ,     OK. <br> <br>        ,     .  Prism <code>InteractionRequestTrigger</code>   <code>PopupChildWindowAction</code>            . <br> <br>     <br>     MVVM,       , ,    ,         .        (  , ,  ,   ).    ,  ,  ,            . <br> <br>        ,         . Managed Extensibility Framework (MEF)  Unity Application Block (Unity)      ,  ,           . <br> <br>  ,       , , ,    ( )      . ,       ,     .  ,     ,       . <br> <br>     ,  MEF <br>  MEF,       ,   <code>Import</code> ,      ,  ,   <code>Export</code> .         ,    . <br> <br> , <code>QuestionnaireView</code>   <i>RI MVVM</i> ,        ,    <code>Import</code> .   , MEF           .  <code>set</code>        ,   . <br> <br> <code class="cs">[Import] public QuestionnaireViewModel ViewModel { set { this.DataContext = value; } }</code> <br>     ,   . <br> <br> <code class="cs">[Export] public class QuestionnaireViewModel : NotificationObject { ... }</code> <br>        ,   . <br> <br> <code class="cs">public QuestionnaireView() { InitializeComponent(); } [ImportingConstructor] public QuestionnaireView(QuestionnaireViewModel viewModel) : this() { this.DataContext = viewModel; }</code> <br> <b></b> <br>          MEF,   Unity.   ,     ,        .   ,   Visual Studio  Expression Blend, ,        ,     .   ,   ,  ,      ,          <code>InitializeComponent</code> . <br>     ,  Unity <br>  Unity,    ,   MEF.     ,      .    ,         .  ,      . <br> <br>  ,      ,  ,         . ,           ,   . <br> <br> <code class="cs">public QuestionnaireView() { InitializeComponent(); } public QuestionnaireView(QuestionnaireViewModel viewModel) : this() { this.DataContext = viewModel; }</code> <br> <b></b> <br>    ,        ,   Visual Studio  Expression Blend. <br>  ,          ,   . Unity        <code>set</code>   ,   . <br> <br> <code class="cs">public QuestionnaireView() { InitializeComponent(); } [Dependency] public QuestionnaireViewModel ViewModel { set { this.DataContext = value; } }</code> <br>       Unity. <br> <br> <code class="cs">container.RegisterType&lt;QuestionnaireViewModel&gt;();</code> <br>  ,     . <br> <br> <code class="cs">var view = container.Resolve&lt;QuestionnaireView&gt;();</code> <br>     ,    <br>   ,     ,        .        ,   MEF  Unity,        . <br> <br>          .   ,         UI,           . <br> <br> , <i>RI MVVM</i>   ,   ,        .   ,    .      <code>ShowView</code>   UI. <br> <br> <code class="cs">private void NavigateToQuestionnaireList() { //     "questionnaire list". this.uiService.ShowView(ViewNames.QuestionnaireTemplatesList); }</code> <br>  UI      UI .           UI.  <code>ShowView</code>  <code>UIService</code>      (,          ),       ,   . <br> <br> <code class="cs">public void ShowView(string viewName) { var view = this.ViewFactory.GetView(viewName); this.MainWindow.CurrentView = view; }</code> <br> <b></b> <br> Prism       .   ,   ,   ,             .    ,  , " <a href="http://msdn.microsoft.com/en-us/library/gg430861(v%3DPandP.40).aspx">View-Based Navigation</a> "   8, " <a href="http://msdn.microsoft.com/en-us/library/gg430861(v%3DPandP.40).aspx">Navigation</a> ". <br>  MVVM  <br>        MVVM      .           -      mocking . ,   ,        . <br> <br>   <i>INotifyPropertyChanged</i> <br>   <code>INotifyPropertyChanged</code>     ,      .      ,    ;   ,   ,     ,    ,       . <br> <br>   <br> ,       ,           <code>PropertyChanged</code>  ,         .  ,    <code>ChangeTracker</code> ,     MVVM,  ,      .      .     ,    . <br> <br> <code class="cs">var changeTracker = new PropertyChangeTracker(viewModel); viewModel.CurrentState = "newState"; CollectionAssert.Contains(changeTracker.ChangedProperties, "CurrentState");</code> <br> ,     ,     <code>INotifyPropertyChanged</code> ,    ,   ,     . <br> <br>      <br>        ,   ,    <code>set</code>      ,           . ,     ,     ,      ,          . <br> <br> <code class="cs">var changeTracker = new PropertyChangeTracker(viewModel); var question = viewModel.Questions.First() as OpenQuestionViewModel; question.Question.Response = "some text"; CollectionAssert.Contains(changeTracker.ChangedProperties, "UnansweredQuestions");</code> <br>      <br>     <code>INotifyPropertyChanged</code> ,      <code>PropertyChanged</code>        ,  ,     , , .        ,       . <br> <br>   <i>INotifyDataErrorInfo</i> <br>   ,     ,    ,   ,   <code>IDataErrorInfo</code> ,  ( Silverlight)   <code>INotifyDataErrorInfo</code> .   <code>INotifyDataErrorInfo</code>   ,         ,    ,  ,   ,    . <br> <br>       <code>INotifyDataErrorInfo</code> : ,     ,  ,     ,     <code>ErrorsChanged</code> ,      <code>GetErrors</code> , . <br> <br>    <br>     ,      ,     .       ,         <code>GetErrors</code>       ,  ,  ,   .    , ,  ,     ,        .   ,        . <br> <br> <code class="cs">//  . var notifyErrorInfo = (INotifyDataErrorInfo)question; question.Response = -15; Assert.IsTrue(notifyErrorInfo.GetErrors("Response").Cast&lt;ValidationResult&gt;().Any()); //  . var notifyErrorInfo = (INotifyDataErrorInfo)question; question.Response = 15; Assert.IsFalse(notifyErrorInfo.GetErrors("Response").Cast&lt;ValidationResult&gt;().Any());</code> <br>    ,    ,             . <br> <br>    <i>INotifyDataErrorInfo</i> <br>       <code>GetErrors</code> ,   <code>INotifyDataErrorInfo</code>  ,   <code>ErrorsChanged</code>      <code>GetErrors</code> . ,  <code>HasErrors</code>      ,  . <br> <br>       <code>INotifyDataErrorInfo</code> . , ,           ,   -  .      ,        <code>INotifyDataErrorInfo</code>         (,        ). <br> <br>     ,   ,  : <br>  <code>HasErrors</code>     .              ,       .  <code>ErrorsChanged</code> ,      ,         <code>GetErrors</code> .         ( ,  )     ,           .    <code>GetErrors</code>       <code>ErrorsChanged</code> . <br>    <code>INotifyPropertyChanged</code> ,  ,    <code>NotifyDataErrorInfoTestHelper</code>    MVVM,        <code>INotifyDataErrorInfo</code> ,       .   ,   ,      ,   .      . <br> <code class="cs">var helper = new NotifyDataErrorInfoTestHelper&lt;NumericQuestion, int?&gt;( question, q =&gt; q.Response); helper.ValidatePropertyChange( 6, NotifyDataErrorInfoBehavior.Nothing); helper.ValidatePropertyChange( 20, NotifyDataErrorInfoBehavior.FiresErrorsChanged | NotifyDataErrorInfoBehavior.HasErrors | NotifyDataErrorInfoBehavior.HasErrorsForProperty); helper.ValidatePropertyChange( null, NotifyDataErrorInfoBehavior.FiresErrorsChanged | NotifyDataErrorInfoBehavior.HasErrors | NotifyDataErrorInfoBehavior.HasErrorsForProperty); helper.ValidatePropertyChange( 2, NotifyDataErrorInfoBehavior.FiresErrorsChanged);</code> <br>     <br>   MVVM,     ,  .   ,    ,         . <br> <br>  ,     ,     ,       .   ,   , ,       ,     ,   <code>IAsyncResult</code>    ,  - ,   ,    UI. <br> <br>       , , ,    .   ,     .  ,      UI,     ,   ,          ,     ,        "   UI." <br> <br>     ,    ,    .   ,    ,     mock-, ,   ,   ,      ,          . <br> <br>           UI,    ,    .   ,     ,   ,      .        ,   .     ,    ,     . <br> <br> <code class="cs">questionnaireRepositoryMock .Setup( r =&gt; r.SubmitQuestionnaireAsync( It.IsAny&lt;Questionnaire&gt;(), It.IsAny&lt;Action&lt;IOperationResult&gt;&gt;())) .Callback&lt;Questionnaire, Action&lt;IOperationResult&gt;&gt;( (q, a) =&gt; callback = a); uiServicemock .Setup(svc =&gt; svc.ShowView(ViewNames.QuestionnaireTemplatesList)) .Callback&lt;string&gt;(viewName =&gt; requestedViewName = viewName); submitResultMock .Setup(sr =&gt; sr.Error) .Returns&lt;Exception&gt;(null); CompleteQuestionnaire(viewModel); viewModel.Submit(); //      UI . callback(submitResultMock.Object); //    ‚Äì     . Assert.AreEqual(ViewNames.QuestionnaireTemplatesList, requestedViewName);</code> <br> <b></b> <br>          ,        . <br>   <br>       , . "Trees in WPF"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ms753391.aspx">http://msdn.microsoft.com/en-us/library/ms753391.aspx</a> <br> <br>       , . "Attached Properties Overview"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/cc265152(VS.95).aspx">http://msdn.microsoft.com/en-us/library/cc265152(VS.95).aspx</a> <br> <br>      MEF, ."Managed Extensibility Framework Overview"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/dd460648.aspx">http://msdn.microsoft.com/en-us/library/dd460648.aspx</a> . <br> <br>      Unity, ."Unity Application Block"  MSDN: <a href="http://www.msdn.com/unity">http://www.msdn.com/unity</a> . <br> <br>      <code>DelegateCommand</code> , .Chapter 5, " <a href="http://msdn.microsoft.com/en-us/library/gg405484(v%3DPandP.40).aspx">Implementing the MVVM Pattern</a> ." <br> <br>        Microsoft Expression Blend, ."Working with built-in behaviors"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ff724013(v%3DExpression.40).aspx">http://msdn.microsoft.com/en-us/library/ff724013(v=Expression.40).aspx</a> . <br> <br>          Microsoft Expression Blend, ."Creating Custom Behaviors"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ff724708(v%3DExpression.40).aspx">http://msdn.microsoft.com/en-us/library/ff724708(v=Expression.40).aspx</a> . <br> <br>            Microsoft Expression Blend, ."Creating Custom Triggers and Actions"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ff724707(v%3DExpression.40).aspx">http://msdn.microsoft.com/en-us/library/ff724707(v=Expression.40).aspx</a> . <br> <br>         WPF  Silverlight, ."Threading Model"  "The Dispatcher Class"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ms741870.aspx">http://msdn.microsoft.com/en-us/library/ms741870.aspx</a> <br> <a href="http://msdn.microsoft.com/en-us/library/ms615907(v%3DVS.95).aspx">http://msdn.microsoft.com/en-us/library/ms615907(v=VS.95).aspx</a> . <br> <br>      unit-  Silverlight, ."Unit Testing with Silverlight 2": <a href="http://www.jeff.wilcox.name/2008/03/silverlight2-unit-testing/">http://www.jeff.wilcox.name/2008/03/silverlight2-unit-testing/</a> . <br> <br>         , .  " <a href="http://msdn.microsoft.com/en-us/library/gg430861(v%3DPandP.40).aspx">View-Based Navigation</a> " in Chapter 8, " <a href="http://msdn.microsoft.com/en-us/library/gg430861(v%3DPandP.40).aspx">Navigation</a> ." <br> <br>       ,   , ."Event-based Asynchronous Pattern Overview"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/wewwczdw.aspx">http://msdn.microsoft.com/en-us/library/wewwczdw.aspx</a> <br> <br>        <code>IAsyncResult</code> , ."Asynchronous Programming Overview"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ms228963.aspx">http://msdn.microsoft.com/en-us/library/ms228963.aspx</a></code></code></code></code></code></code></code></code></code> </h4> <code><code><code><code><code><code><code><code><code><code>CommandBehaviorBase ,    ,    ICommand</code> .           <code>CanExecuteChanged</code> ,          Silverlight,    WPF. <br> <br>    ,  ,   <code>CommandBehaviorBase    ,    .         ,      .         ,    .      ButtonBaseClickCommandBehavior</code> . <br> <br> <code class="cs">public class ButtonBaseClickCommandBehavior : CommandBehaviorBase&lt;ButtonBase&gt; { public ButtonBaseClickCommandBehavior(ButtonBase clickableObject) : base(clickableObject) { clickableObject.Click += OnClick; } private void OnClick(object sender, System.Windows.RoutedEventArgs e) { ExecuteCommand(); } }</code> <br>   <code>CommandBehaviorBase ,     .     ,          ,   . ,    ,    ,      , ,    CanExecute</code>  ,     . <br> <br>          ,   .           XAML.           .       .  Prism      ,       ,  ,   .       ,    . , ,  ,      <code>Click</code> ,       <code>Command</code> .    <code>Click.Command</code> ,  . <br> <br>             .             . <br> <br> <code class="cs">public static readonly DependencyProperty CommandProperty = DependencyProperty.RegisterAttached( "Command", typeof(ICommand), typeof(Click), new PropertyMetadata(OnSetCommandCallback)); private static readonly DependencyProperty ClickCommandBehaviorProperty = DependencyProperty.RegisterAttached( "ClickCommandBehavior", typeof(ButtonBaseClickCommandBehavior), typeof(Click), null);</code> <br>    <code>Command</code>    <code>ButtonBaseClickCommandBehavior</code> ,     <code>OnSetCommandCallback</code> ,     . <br> <br> <code class="cs">private static void OnSetCommandCallback(DependencyObject dependencyObject, DependencyPropertyChangedEventArgs e) { ButtonBase buttonBase = dependencyObject as ButtonBase; if (buttonBase != null) { ButtonBaseClickCommandBehavior behavior = GetOrCreateBehavior(buttonBase); behavior.Command = e.NewValue as ICommand; } } private static void OnSetCommandParameterCallback(DependencyObject dependencyObject, DependencyPropertyChangedEventArgs e) { ButtonBase buttonBase = dependencyObject as ButtonBase; if (buttonBase != null) { ButtonBaseClickCommandBehavior behavior = GetOrCreateBehavior(buttonBase); behavior.CommandParameter = e.NewValue; } } private static ButtonBaseClickCommandBehavior GetOrCreateBehavior(ButtonBase buttonBase ) { ButtonBaseClickCommandBehavior behavior = buttonBase.GetValue(ClickCommandBehaviorProperty) as ButtonBaseClickCommandBehavior; if ( behavior == null ) { behavior = new ButtonBaseClickCommandBehavior(buttonBase); buttonBase.SetValue(ClickCommandBehaviorProperty, behavior); } return behavior; }</code> <br>        ,  <a href="http://msdn.microsoft.com/en-us/library/cc265152(VS.95).aspx">Attached Properties Overview</a>  MSDN. <br> <br>    <br>              . ,     Silverlight,    -,     ,      ,     .     ,       . <br> <br>        ,    ( )  ,  ,     .  UI       ,            UI. <br> <br>      - <br>   -     ,       <code>IAsyncResult</code> .   ,  ,   ,  <code>GetQuestionnaire</code> ,   : <code>BeginGetQuestionnaire</code>  <code>EndGetQuestionnaire</code> .    ,   <code>BeginGetQuestionnaire</code> .     ,   ,   <code>EndGetQuestionnaire</code>    . <br> <b></b> <br>  .NET Framework 4.5      <code>await</code>  <code>async</code>     <code>*Async</code> .      <a href="http://msdn.microsoft.com/en-us/library/vstudio/hh391443.aspx">"Asynchronous Programming with Async and Await (C# and Visual Basic)"</a> . <br>  ,    <code>EndGetQuestionnaire</code> ,      ,  ()      <code>BeginGetQuestionnaire</code> .     ,      ,   <code>EndGetQuestionnaire</code> ,   . <br> <br> <code class="xml">IAsyncResult asyncResult = this.service.BeginGetQuestionnaire( GetQuestionnaireCompleted, null //  ,      ); private void GetQuestionnaireCompleted(IAsyncResult result) { try { questionnaire = this.service.EndGetQuestionnaire(ar); } catch (Exception ex) { //  -   . } }</code> <br>  ,     <code>End*</code> (  , <code>EndGetQuestionnaire</code> ),    ,      .      , ,          UI.     ,   ,        . <br> <br>        UI,     -,      UI,         UI,   <code>Dispatcher</code>    <code>SynchronizationContext</code> .  WPF  Silverlight,   <code>Dispatcher</code> . <br> <br>      <code>Questionnaire</code>  ,        <code>QuestionnaireView</code> .  Silverlight    <code>CheckAccess</code> ,  ,      UI.  ,     <code>BeginInvoke</code> ,      UI. <br> <br> <code class="cs">var dispatcher = System.Windows.Deployment.Current.Dispatcher; if (dispatcher.CheckAccess()) { QuestionnaireView.DataContext = questionnaire; } else { dispatcher.BeginInvoke(() =&gt; { Questionnaire.DataContext = questionnaire; }); }</code> <br> <i>MVVM RI</i>   ,    ,   <code>IAsyncResult</code> ,   .      ,                 . ,       . <br> <br> <code class="cs">this.questionnaireRepository.GetQuestionnaireAsync( result =&gt; { this.Questionnaire = result.Result; });</code> <br>  <code>result</code>   ,     , , , .    ,     . <br> <br> <code class="cs">this.questionnaireRepository.GetQuestionnaireAsync( result =&gt; { if (result.Error == null) { this.Questionnaire = result.Result; ... } else { // Handle error. } })</code> <br>     <br>        ,      .     , ,             .        ,      ,     ,     . <br> <br>         ,      MVVM,     ,   . ,  -MVVM ,     <code>MessageBox</code>   code-behind UI,      .   MVVM     ,          . <br> <br>     MVVM,              ,          .      ,    ,   ,  ,     . <br> <br>              MVVM.      ,     ,     ,  ,     .    ,         ,     ,          .       . <br> <br>    <br>                  .        ,        .  ,         .         . <br> <br>  ,         ,         ,  .      ,     .           ,       . ,        WPF  Silverlight,        . <br> <br> <img title="Using the service to interact with the user." src="https://habrastorage.org/getpro/habr/post_images/4b5/397/f2d/4b5397f2d02e5851195b29f1893be6fc.png" alt=" ,    ."> <br> <br>  ,   <code>MessageBox</code>        ,     ,    ,     . <br> <br> <code class="cs">var result = interactionService.ShowMessageBox( "Are you sure you want to cancel this operation?", "Confirm", MessageBoxButton.OK); if (result == MessageBoxResult.Yes) { CancelRequest(); }</code> <br> ,      - ,      ,         Silverlight.         .             .     . <br> <br> <code class="cs">interactionService.ShowMessageBox( "Are you sure you want to cancel this operation?", "Confirm", MessageBoxButton.OK, result =&gt; { if (result == MessageBoxResult.Yes) { CancelRequest(); } });</code> <br>         ,      . ,  WPF    <code>MessageBox</code> ,       ;    Silverlight    ,    . <br> <br>     <br>         ‚Äì             .         ,      .     ,     .        ,        ,   ,     . <br> <br> <img title="Using interaction request objects." src="https://habrastorage.org/getpro/habr/post_images/3d0/ff0/1c5/3d0ff01c5518558c2d3c5c5f47ce0ce9.png" alt="   ."> <br> <br>    ,   ,          ‚Äì       ,      ,   ‚Äì     .   ,        ,    ,    UI            . <br> <br>       MVVM,     ,       ,         .         ,        ,    ,   . <br> <br>  Prism       <code>IInteractionRequest</code>   <code>InteractionRequest .  IInteractionRequest</code>  ,   .           ,   .  <code>InteractionRequest   IInteractionRequest</code>     <code>Raise</code> ,           , , ,   . <br> <br>       <br>  <code>InteractionRequest          .  Raise</code>          ( <code>T</code> )    ,    ,   .          ,       .      ,        .    ,  ,     . <br> <code class="cs">public interface IInteractionRequest { event EventHandler&lt;InteractionRequestedEventArgs&gt; Raised; } public class InteractionRequest&lt;T&gt; : IInteractionRequest { public event EventHandler&lt;InteractionRequestedEventArgs&gt; Raised; public void Raise(T context, Action&lt;T&gt; callback) { var handler = this.Raised; if (handler != null) { handler( this, new InteractionRequestedEventArgs(context, () =&gt; callback(context))); } } }</code> <br> Prism    ,      .  <code>Notification</code>       .    ,            .     ‚Äì <code>Title</code>  <code>Content</code> ,    .  ,   ,  ,  ,        . <br> <br>  <code>Confirmation</code>    <code>Notification</code>     ‚Äì <code>Confirmed</code> ,  ,  ,      .  <code>Confirmation</code> ,     <code>MessageBox</code> ,     /  .     ,     <code>Notification</code> ,     ,      . <br> <br>    <code>InteractionRequest ,       InteractionRequest      ,      .      ,    Raise</code> ,    , ,   . <br> <br> <code class="cs">public IInteractionRequest ConfirmCancelInteractionRequest { get { return this.confirmCancelInteractionRequest; } } this.confirmCancelInteractionRequest.Raise( new Confirmation("Are you sure you wish to cancel?"), confirmation =&gt; { if (confirmation.Confirmed) { this.NavigateToQuestionnaireList(); } }); }</code> <br> <i>MVVM Reference Implementation (MVVM RI)</i> ,    <code>IInteractionRequest</code>   <code>InteractionRequest ,          (. QuestionnaireViewModel.cs</code> ). <br> <br>        <br>       ,       .   ,       .    UI             . <br> <br>                . Microsoft Expression Blend Behaviors Framework     .  ,     ,    . <br> <br>  <code>EventTrigger</code> ,  Expression Blend,  ,      ,     ,   . , Prism   <code>EventTrigger</code> ,  <code>InteractionRequestTrigger</code> ,      <code>Raised</code>   <code>IInteractionRequest</code> .    XAML        . <br> <br>  ,   , <code>InteractionRequestTrigger</code>   .  Silverlight Prism   <code>PopupChildWindowAction</code> ,     .    ,         .   <code>ContentTemplate</code>  <code>PopupChildWindowAction</code> ,    ,    UI,      <code>Content</code>  .       <code>Title</code>  . <br> <b></b> <br>  ,    ,   <code>PopupChildWindowAction</code> ,     .    <code>Notification</code>  <code>NotificationChildWindow</code> ,        <code>Confirmation</code> ‚Äì <code>ConfirmationChildWindow</code> . <code>NotificationChildWindow</code>    ,   ,     <code>ConfirmationChildWindow</code>    <i>OK</i>  <i>Cancel</i> ,    .    ,   ,   <code>ChildWindow</code>  <code>PopupChildWindowAction</code> . <br>   ,  <code>InteractionRequestTrigger</code>  <code>PopupChildWindowAction</code> ,       <i>RI MVVM</i> . <br> <br> <code class="xml">&lt;i:Interaction.Triggers&gt; &lt;prism:InteractionRequestTrigger SourceObject="{Binding ConfirmCancelInteractionRequest}"&gt; &lt;prism:PopupChildWindowAction ContentTemplate="{StaticResource ConfirmWindowTemplate}"/&gt; &lt;/prism:InteractionRequestTrigger&gt; &lt;/i:Interaction.Triggers&gt; &lt;UserControl.Resources&gt; &lt;DataTemplate x:Key="ConfirmWindowTemplate"&gt; &lt;Grid MinWidth="250" MinHeight="100"&gt; &lt;TextBlock TextWrapping="Wrap" Grid.Row="0" Text="{Binding}"/&gt; &lt;/Grid&gt; &lt;/DataTemplate&gt; &lt;/UserControl.Resources&gt;</code> <br> <b></b> <br>      <code>ContentTemplate</code> ,   UI   <code>Content</code>  .    <code>Content</code>  ,  , <code>TextBlock</code>     <code>Content</code> . <br>      ,     ,    ,    .  ,     ,       ,     ,    .   ,   <i>RI MVVM</i> ,         <code>Confirmed</code>    <code>Confirmation</code>  <code>true</code> ,     OK. <br> <br>        ,     .  Prism <code>InteractionRequestTrigger</code>   <code>PopupChildWindowAction</code>            . <br> <br>     <br>     MVVM,       , ,    ,         .        (  , ,  ,   ).    ,  ,  ,            . <br> <br>        ,         . Managed Extensibility Framework (MEF)  Unity Application Block (Unity)      ,  ,           . <br> <br>  ,       , , ,    ( )      . ,       ,     .  ,     ,       . <br> <br>     ,  MEF <br>  MEF,       ,   <code>Import</code> ,      ,  ,   <code>Export</code> .         ,    . <br> <br> , <code>QuestionnaireView</code>   <i>RI MVVM</i> ,        ,    <code>Import</code> .   , MEF           .  <code>set</code>        ,   . <br> <br> <code class="cs">[Import] public QuestionnaireViewModel ViewModel { set { this.DataContext = value; } }</code> <br>     ,   . <br> <br> <code class="cs">[Export] public class QuestionnaireViewModel : NotificationObject { ... }</code> <br>        ,   . <br> <br> <code class="cs">public QuestionnaireView() { InitializeComponent(); } [ImportingConstructor] public QuestionnaireView(QuestionnaireViewModel viewModel) : this() { this.DataContext = viewModel; }</code> <br> <b></b> <br>          MEF,   Unity.   ,     ,        .   ,   Visual Studio  Expression Blend, ,        ,     .   ,   ,  ,      ,          <code>InitializeComponent</code> . <br>     ,  Unity <br>  Unity,    ,   MEF.     ,      .    ,         .  ,      . <br> <br>  ,      ,  ,         . ,           ,   . <br> <br> <code class="cs">public QuestionnaireView() { InitializeComponent(); } public QuestionnaireView(QuestionnaireViewModel viewModel) : this() { this.DataContext = viewModel; }</code> <br> <b></b> <br>    ,        ,   Visual Studio  Expression Blend. <br>  ,          ,   . Unity        <code>set</code>   ,   . <br> <br> <code class="cs">public QuestionnaireView() { InitializeComponent(); } [Dependency] public QuestionnaireViewModel ViewModel { set { this.DataContext = value; } }</code> <br>       Unity. <br> <br> <code class="cs">container.RegisterType&lt;QuestionnaireViewModel&gt;();</code> <br>  ,     . <br> <br> <code class="cs">var view = container.Resolve&lt;QuestionnaireView&gt;();</code> <br>     ,    <br>   ,     ,        .        ,   MEF  Unity,        . <br> <br>          .   ,         UI,           . <br> <br> , <i>RI MVVM</i>   ,   ,        .   ,    .      <code>ShowView</code>   UI. <br> <br> <code class="cs">private void NavigateToQuestionnaireList() { //     "questionnaire list". this.uiService.ShowView(ViewNames.QuestionnaireTemplatesList); }</code> <br>  UI      UI .           UI.  <code>ShowView</code>  <code>UIService</code>      (,          ),       ,   . <br> <br> <code class="cs">public void ShowView(string viewName) { var view = this.ViewFactory.GetView(viewName); this.MainWindow.CurrentView = view; }</code> <br> <b></b> <br> Prism       .   ,   ,   ,             .    ,  , " <a href="http://msdn.microsoft.com/en-us/library/gg430861(v%3DPandP.40).aspx">View-Based Navigation</a> "   8, " <a href="http://msdn.microsoft.com/en-us/library/gg430861(v%3DPandP.40).aspx">Navigation</a> ". <br>  MVVM  <br>        MVVM      .           -      mocking . ,   ,        . <br> <br>   <i>INotifyPropertyChanged</i> <br>   <code>INotifyPropertyChanged</code>     ,      .      ,    ;   ,   ,     ,    ,       . <br> <br>   <br> ,       ,           <code>PropertyChanged</code>  ,         .  ,    <code>ChangeTracker</code> ,     MVVM,  ,      .      .     ,    . <br> <br> <code class="cs">var changeTracker = new PropertyChangeTracker(viewModel); viewModel.CurrentState = "newState"; CollectionAssert.Contains(changeTracker.ChangedProperties, "CurrentState");</code> <br> ,     ,     <code>INotifyPropertyChanged</code> ,    ,   ,     . <br> <br>      <br>        ,   ,    <code>set</code>      ,           . ,     ,     ,      ,          . <br> <br> <code class="cs">var changeTracker = new PropertyChangeTracker(viewModel); var question = viewModel.Questions.First() as OpenQuestionViewModel; question.Question.Response = "some text"; CollectionAssert.Contains(changeTracker.ChangedProperties, "UnansweredQuestions");</code> <br>      <br>     <code>INotifyPropertyChanged</code> ,      <code>PropertyChanged</code>        ,  ,     , , .        ,       . <br> <br>   <i>INotifyDataErrorInfo</i> <br>   ,     ,    ,   ,   <code>IDataErrorInfo</code> ,  ( Silverlight)   <code>INotifyDataErrorInfo</code> .   <code>INotifyDataErrorInfo</code>   ,         ,    ,  ,   ,    . <br> <br>       <code>INotifyDataErrorInfo</code> : ,     ,  ,     ,     <code>ErrorsChanged</code> ,      <code>GetErrors</code> , . <br> <br>    <br>     ,      ,     .       ,         <code>GetErrors</code>       ,  ,  ,   .    , ,  ,     ,        .   ,        . <br> <br> <code class="cs">//  . var notifyErrorInfo = (INotifyDataErrorInfo)question; question.Response = -15; Assert.IsTrue(notifyErrorInfo.GetErrors("Response").Cast&lt;ValidationResult&gt;().Any()); //  . var notifyErrorInfo = (INotifyDataErrorInfo)question; question.Response = 15; Assert.IsFalse(notifyErrorInfo.GetErrors("Response").Cast&lt;ValidationResult&gt;().Any());</code> <br>    ,    ,             . <br> <br>    <i>INotifyDataErrorInfo</i> <br>       <code>GetErrors</code> ,   <code>INotifyDataErrorInfo</code>  ,   <code>ErrorsChanged</code>      <code>GetErrors</code> . ,  <code>HasErrors</code>      ,  . <br> <br>       <code>INotifyDataErrorInfo</code> . , ,           ,   -  .      ,        <code>INotifyDataErrorInfo</code>         (,        ). <br> <br>     ,   ,  : <br>  <code>HasErrors</code>     .              ,       .  <code>ErrorsChanged</code> ,      ,         <code>GetErrors</code> .         ( ,  )     ,           .    <code>GetErrors</code>       <code>ErrorsChanged</code> . <br>    <code>INotifyPropertyChanged</code> ,  ,    <code>NotifyDataErrorInfoTestHelper</code>    MVVM,        <code>INotifyDataErrorInfo</code> ,       .   ,   ,      ,   .      . <br> <code class="cs">var helper = new NotifyDataErrorInfoTestHelper&lt;NumericQuestion, int?&gt;( question, q =&gt; q.Response); helper.ValidatePropertyChange( 6, NotifyDataErrorInfoBehavior.Nothing); helper.ValidatePropertyChange( 20, NotifyDataErrorInfoBehavior.FiresErrorsChanged | NotifyDataErrorInfoBehavior.HasErrors | NotifyDataErrorInfoBehavior.HasErrorsForProperty); helper.ValidatePropertyChange( null, NotifyDataErrorInfoBehavior.FiresErrorsChanged | NotifyDataErrorInfoBehavior.HasErrors | NotifyDataErrorInfoBehavior.HasErrorsForProperty); helper.ValidatePropertyChange( 2, NotifyDataErrorInfoBehavior.FiresErrorsChanged);</code> <br>     <br>   MVVM,     ,  .   ,    ,         . <br> <br>  ,     ,     ,       .   ,   , ,       ,     ,   <code>IAsyncResult</code>    ,  - ,   ,    UI. <br> <br>       , , ,    .   ,     .  ,      UI,     ,   ,          ,     ,        "   UI." <br> <br>     ,    ,    .   ,    ,     mock-, ,   ,   ,      ,          . <br> <br>           UI,    ,    .   ,     ,   ,      .        ,   .     ,    ,     . <br> <br> <code class="cs">questionnaireRepositoryMock .Setup( r =&gt; r.SubmitQuestionnaireAsync( It.IsAny&lt;Questionnaire&gt;(), It.IsAny&lt;Action&lt;IOperationResult&gt;&gt;())) .Callback&lt;Questionnaire, Action&lt;IOperationResult&gt;&gt;( (q, a) =&gt; callback = a); uiServicemock .Setup(svc =&gt; svc.ShowView(ViewNames.QuestionnaireTemplatesList)) .Callback&lt;string&gt;(viewName =&gt; requestedViewName = viewName); submitResultMock .Setup(sr =&gt; sr.Error) .Returns&lt;Exception&gt;(null); CompleteQuestionnaire(viewModel); viewModel.Submit(); //      UI . callback(submitResultMock.Object); //    ‚Äì     . Assert.AreEqual(ViewNames.QuestionnaireTemplatesList, requestedViewName);</code> <br> <b></b> <br>          ,        . <br>   <br>       , . "Trees in WPF"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ms753391.aspx">http://msdn.microsoft.com/en-us/library/ms753391.aspx</a> <br> <br>       , . "Attached Properties Overview"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/cc265152(VS.95).aspx">http://msdn.microsoft.com/en-us/library/cc265152(VS.95).aspx</a> <br> <br>      MEF, ."Managed Extensibility Framework Overview"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/dd460648.aspx">http://msdn.microsoft.com/en-us/library/dd460648.aspx</a> . <br> <br>      Unity, ."Unity Application Block"  MSDN: <a href="http://www.msdn.com/unity">http://www.msdn.com/unity</a> . <br> <br>      <code>DelegateCommand</code> , .Chapter 5, " <a href="http://msdn.microsoft.com/en-us/library/gg405484(v%3DPandP.40).aspx">Implementing the MVVM Pattern</a> ." <br> <br>        Microsoft Expression Blend, ."Working with built-in behaviors"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ff724013(v%3DExpression.40).aspx">http://msdn.microsoft.com/en-us/library/ff724013(v=Expression.40).aspx</a> . <br> <br>          Microsoft Expression Blend, ."Creating Custom Behaviors"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ff724708(v%3DExpression.40).aspx">http://msdn.microsoft.com/en-us/library/ff724708(v=Expression.40).aspx</a> . <br> <br>            Microsoft Expression Blend, ."Creating Custom Triggers and Actions"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ff724707(v%3DExpression.40).aspx">http://msdn.microsoft.com/en-us/library/ff724707(v=Expression.40).aspx</a> . <br> <br>         WPF  Silverlight, ."Threading Model"  "The Dispatcher Class"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ms741870.aspx">http://msdn.microsoft.com/en-us/library/ms741870.aspx</a> <br> <a href="http://msdn.microsoft.com/en-us/library/ms615907(v%3DVS.95).aspx">http://msdn.microsoft.com/en-us/library/ms615907(v=VS.95).aspx</a> . <br> <br>      unit-  Silverlight, ."Unit Testing with Silverlight 2": <a href="http://www.jeff.wilcox.name/2008/03/silverlight2-unit-testing/">http://www.jeff.wilcox.name/2008/03/silverlight2-unit-testing/</a> . <br> <br>         , .  " <a href="http://msdn.microsoft.com/en-us/library/gg430861(v%3DPandP.40).aspx">View-Based Navigation</a> " in Chapter 8, " <a href="http://msdn.microsoft.com/en-us/library/gg430861(v%3DPandP.40).aspx">Navigation</a> ." <br> <br>       ,   , ."Event-based Asynchronous Pattern Overview"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/wewwczdw.aspx">http://msdn.microsoft.com/en-us/library/wewwczdw.aspx</a> <br> <br>        <code>IAsyncResult</code> , ."Asynchronous Programming Overview"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ms228963.aspx">http://msdn.microsoft.com/en-us/library/ms228963.aspx</a></code></code></code></code></code></code></code></code></code> <pre> <code class="hljs cmake"><code><code><code><code><code><code><code><code><code class="cs"><code>CommandBehaviorBase ,    ,    ICommand</code> .           <code>CanExecuteChanged</code> ,          Silverlight,    WPF. <br> <br>    ,  ,   <code>CommandBehaviorBase    ,    .         ,      .         ,    .      ButtonBaseClickCommandBehavior</code> . <br> <br> <code class="cs">public class ButtonBaseClickCommandBehavior : CommandBehaviorBase&lt;ButtonBase&gt; { public ButtonBaseClickCommandBehavior(ButtonBase clickableObject) : base(clickableObject) { clickableObject.Click += OnClick; } private void OnClick(object sender, System.Windows.RoutedEventArgs e) { ExecuteCommand(); } }</code> <br>   <code>CommandBehaviorBase ,     .     ,          ,   . ,    ,    ,      , ,    CanExecute</code>  ,     . <br> <br>          ,   .           XAML.           .       .  Prism      ,       ,  ,   .       ,    . , ,  ,      <code>Click</code> ,       <code><span class="hljs-keyword"><span class="hljs-keyword">Command</span></span></code> .    <code>Click.<span class="hljs-keyword"><span class="hljs-keyword">Command</span></span></code> ,  . <br> <br>             .             . <br> <br> <code class="cs">public static readonly DependencyProperty CommandProperty = DependencyProperty.RegisterAttached( <span class="hljs-string"><span class="hljs-string">"Command"</span></span>, typeof(ICommand), typeof(Click), new PropertyMetadata(OnSetCommandCallback)); private static readonly DependencyProperty ClickCommandBehaviorProperty = DependencyProperty.RegisterAttached( <span class="hljs-string"><span class="hljs-string">"ClickCommandBehavior"</span></span>, typeof(ButtonBaseClickCommandBehavior), typeof(Click), null);</code> <br>    <code><span class="hljs-keyword"><span class="hljs-keyword">Command</span></span></code>    <code>ButtonBaseClickCommandBehavior</code> ,     <code>OnSetCommandCallback</code> ,     . <br> <br> <code class="cs">private static void OnSetCommandCallback(DependencyObject dependencyObject, DependencyPropertyChangedEventArgs e) { ButtonBase buttonBase = dependencyObject as ButtonBase; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (buttonBase != null) { ButtonBaseClickCommandBehavior behavior = GetOrCreateBehavior(buttonBase); behavior.<span class="hljs-keyword"><span class="hljs-keyword">Command</span></span> = e.NewValue as ICommand; } } private static void OnSetCommandParameterCallback(DependencyObject dependencyObject, DependencyPropertyChangedEventArgs e) { ButtonBase buttonBase = dependencyObject as ButtonBase; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (buttonBase != null) { ButtonBaseClickCommandBehavior behavior = GetOrCreateBehavior(buttonBase); behavior.CommandParameter = e.NewValue; } } private static ButtonBaseClickCommandBehavior GetOrCreateBehavior(ButtonBase buttonBase ) { ButtonBaseClickCommandBehavior behavior = buttonBase.GetValue(ClickCommandBehaviorProperty) as ButtonBaseClickCommandBehavior; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ( behavior == null ) { behavior = new ButtonBaseClickCommandBehavior(buttonBase); buttonBase.SetValue(ClickCommandBehaviorProperty, behavior); } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> behavior; }</code> <br>        ,  <a href="http://msdn.microsoft.com/en-us/library/cc265152(VS.95).aspx">Attached Properties Overview</a>  MSDN. <br> <br>    <br>              . ,     Silverlight,    -,     ,      ,     .     ,       . <br> <br>        ,    ( )  ,  ,     .  UI       ,            UI. <br> <br>      - <br>   -     ,       <code>IAsyncResult</code> .   ,  ,   ,  <code>GetQuestionnaire</code> ,   : <code>BeginGetQuestionnaire</code>  <code>EndGetQuestionnaire</code> .    ,   <code>BeginGetQuestionnaire</code> .     ,   ,   <code>EndGetQuestionnaire</code>    . <br> <b></b> <br>  .NET Framework <span class="hljs-number"><span class="hljs-number">4.5</span></span>      <code>await</code>  <code>async</code>     <code>*Async</code> .      <a href="http://msdn.microsoft.com/en-us/library/vstudio/hh391443.aspx"><span class="hljs-string"><span class="hljs-string">"Asynchronous Programming with Async and Await (C# and Visual Basic)"</span></span></a> . <br>  ,    <code>EndGetQuestionnaire</code> ,      ,  ()      <code>BeginGetQuestionnaire</code> .     ,      ,   <code>EndGetQuestionnaire</code> ,   . <br> <br> <code class="xml">IAsyncResult asyncResult = this.service.BeginGetQuestionnaire( GetQuestionnaireCompleted, null //  ,      ); private void GetQuestionnaireCompleted(IAsyncResult result) { try { questionnaire = this.service.EndGetQuestionnaire(ar); } catch (Exception ex) { //  -   . } }</code> <br>  ,     <code>End*</code> (  , <code>EndGetQuestionnaire</code> ),    ,      .      , ,          UI.     ,   ,        . <br> <br>        UI,     -,      UI,         UI,   <code>Dispatcher</code>    <code>SynchronizationContext</code> .  WPF  Silverlight,   <code>Dispatcher</code> . <br> <br>      <code>Questionnaire</code>  ,        <code>QuestionnaireView</code> .  Silverlight    <code>CheckAccess</code> ,  ,      UI.  ,     <code>BeginInvoke</code> ,      UI. <br> <br> <code class="cs">var dispatcher = System.Windows.Deployment.Current.Dispatcher; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (dispatcher.CheckAccess()) { QuestionnaireView.DataContext = questionnaire; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { dispatcher.BeginInvoke(() =&gt; { Questionnaire.DataContext = questionnaire; }); }</code> <br> <i>MVVM RI</i>   ,    ,   <code>IAsyncResult</code> ,   .      ,                 . ,       . <br> <br> <code class="cs">this.questionnaireRepository.GetQuestionnaireAsync( result =&gt; { this.Questionnaire = result.Result; });</code> <br>  <code>result</code>   ,     , , , .    ,     . <br> <br> <code class="cs">this.questionnaireRepository.GetQuestionnaireAsync( result =&gt; { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (result.Error == null) { this.Questionnaire = result.Result; ... } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { // Handle error. } })</code> <br>     <br>        ,      .     , ,             .        ,      ,     ,     . <br> <br>         ,      MVVM,     ,   . ,  -MVVM ,     <code>MessageBox</code>   code-behind UI,      .   MVVM     ,          . <br> <br>     MVVM,              ,          .      ,    ,   ,  ,     . <br> <br>              MVVM.      ,     ,     ,  ,     .    ,         ,     ,          .       . <br> <br>    <br>                  .        ,        .  ,         .         . <br> <br>  ,         ,         ,  .      ,     .           ,       . ,        WPF  Silverlight,        . <br> <br> <img title="Using the service to interact with the user." src="https://habrastorage.org/getpro/habr/post_images/4b5/397/f2d/4b5397f2d02e5851195b29f1893be6fc.png" alt=" ,    ."> <br> <br>  ,   <code>MessageBox</code>        ,     ,    ,     . <br> <br> <code class="cs">var result = interactionService.ShowMessageBox( <span class="hljs-string"><span class="hljs-string">"Are you sure you want to cancel this operation?"</span></span>, <span class="hljs-string"><span class="hljs-string">"Confirm"</span></span>, MessageBoxButton.OK); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (result == MessageBoxResult.Yes) { CancelRequest(); }</code> <br> ,      - ,      ,         Silverlight.         .             .     . <br> <br> <code class="cs">interactionService.ShowMessageBox( <span class="hljs-string"><span class="hljs-string">"Are you sure you want to cancel this operation?"</span></span>, <span class="hljs-string"><span class="hljs-string">"Confirm"</span></span>, MessageBoxButton.OK, result =&gt; { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (result == MessageBoxResult.Yes) { CancelRequest(); } });</code> <br>         ,      . ,  WPF    <code>MessageBox</code> ,       ;    Silverlight    ,    . <br> <br>     <br>         ‚Äì             .         ,      .     ,     .        ,        ,   ,     . <br> <br> <img title="Using interaction request objects." src="https://habrastorage.org/getpro/habr/post_images/3d0/ff0/1c5/3d0ff01c5518558c2d3c5c5f47ce0ce9.png" alt="   ."> <br> <br>    ,   ,          ‚Äì       ,      ,   ‚Äì     .   ,        ,    ,    UI            . <br> <br>       MVVM,     ,       ,         .         ,        ,    ,   . <br> <br>  Prism       <code>IInteractionRequest</code>   <code>InteractionRequest .  IInteractionRequest</code>  ,   .           ,   .  <code>InteractionRequest   IInteractionRequest</code>     <code>Raise</code> ,           , , ,   . <br> <br>       <br>  <code>InteractionRequest          .  Raise</code>          ( <code>T</code> )    ,    ,   .          ,       .      ,        .    ,  ,     . <br> <code class="cs">public interface IInteractionRequest { event EventHandler&lt;InteractionRequestedEventArgs&gt; Raised; } public class InteractionRequest&lt;T&gt; : IInteractionRequest { public event EventHandler&lt;InteractionRequestedEventArgs&gt; Raised; public void Raise(T context, Action&lt;T&gt; callback) { var handler = this.Raised; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (handler != null) { handler( this, new InteractionRequestedEventArgs(context, () =&gt; callback(context))); } } }</code> <br> Prism    ,      .  <code>Notification</code>       .    ,            .     ‚Äì <code>Title</code>  <code>Content</code> ,    .  ,   ,  ,  ,        . <br> <br>  <code>Confirmation</code>    <code>Notification</code>     ‚Äì <code>Confirmed</code> ,  ,  ,      .  <code>Confirmation</code> ,     <code>MessageBox</code> ,     /  .     ,     <code>Notification</code> ,     ,      . <br> <br>    <code>InteractionRequest ,       InteractionRequest      ,      .      ,    Raise</code> ,    , ,   . <br> <br> <code class="cs">public IInteractionRequest ConfirmCancelInteractionRequest { get { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> this.confirmCancelInteractionRequest; } } this.confirmCancelInteractionRequest.Raise( new Confirmation(<span class="hljs-string"><span class="hljs-string">"Are you sure you wish to cancel?"</span></span>), confirmation =&gt; { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (confirmation.Confirmed) { this.NavigateToQuestionnaireList(); } }); }</code> <br> <i>MVVM Reference Implementation (MVVM RI)</i> ,    <code>IInteractionRequest</code>   <code>InteractionRequest ,          (. QuestionnaireViewModel.cs</code> ). <br> <br>        <br>       ,       .   ,       .    UI             . <br> <br>                . Microsoft Expression Blend Behaviors Framework     .  ,     ,    . <br> <br>  <code>EventTrigger</code> ,  Expression Blend,  ,      ,     ,   . , Prism   <code>EventTrigger</code> ,  <code>InteractionRequestTrigger</code> ,      <code>Raised</code>   <code>IInteractionRequest</code> .    XAML        . <br> <br>  ,   , <code>InteractionRequestTrigger</code>   .  Silverlight Prism   <code>PopupChildWindowAction</code> ,     .    ,         .   <code>ContentTemplate</code>  <code>PopupChildWindowAction</code> ,    ,    UI,      <code>Content</code>  .       <code>Title</code>  . <br> <b></b> <br>  ,    ,   <code>PopupChildWindowAction</code> ,     .    <code>Notification</code>  <code>NotificationChildWindow</code> ,        <code>Confirmation</code> ‚Äì <code>ConfirmationChildWindow</code> . <code>NotificationChildWindow</code>    ,   ,     <code>ConfirmationChildWindow</code>    <i>OK</i>  <i>Cancel</i> ,    .    ,   ,   <code>ChildWindow</code>  <code>PopupChildWindowAction</code> . <br>   ,  <code>InteractionRequestTrigger</code>  <code>PopupChildWindowAction</code> ,       <i>RI MVVM</i> . <br> <br> <code class="xml">&lt;i:Interaction.Triggers&gt; &lt;prism:InteractionRequestTrigger SourceObject=<span class="hljs-string"><span class="hljs-string">"{Binding ConfirmCancelInteractionRequest}"</span></span>&gt; &lt;prism:PopupChildWindowAction ContentTemplate=<span class="hljs-string"><span class="hljs-string">"{StaticResource ConfirmWindowTemplate}"</span></span>/&gt; &lt;/prism:InteractionRequestTrigger&gt; &lt;/i:Interaction.Triggers&gt; &lt;UserControl.Resources&gt; &lt;DataTemplate x:Key=<span class="hljs-string"><span class="hljs-string">"ConfirmWindowTemplate"</span></span>&gt; &lt;Grid MinWidth=<span class="hljs-string"><span class="hljs-string">"250"</span></span> MinHeight=<span class="hljs-string"><span class="hljs-string">"100"</span></span>&gt; &lt;TextBlock TextWrapping=<span class="hljs-string"><span class="hljs-string">"Wrap"</span></span> Grid.Row=<span class="hljs-string"><span class="hljs-string">"0"</span></span> Text=<span class="hljs-string"><span class="hljs-string">"{Binding}"</span></span>/&gt; &lt;/Grid&gt; &lt;/DataTemplate&gt; &lt;/UserControl.Resources&gt;</code> <br> <b></b> <br>      <code>ContentTemplate</code> ,   UI   <code>Content</code>  .    <code>Content</code>  ,  , <code>TextBlock</code>     <code>Content</code> . <br>      ,     ,    ,    .  ,     ,       ,     ,    .   ,   <i>RI MVVM</i> ,         <code>Confirmed</code>    <code>Confirmation</code>  <code><span class="hljs-keyword"><span class="hljs-keyword">true</span></span></code> ,     OK. <br> <br>        ,     .  Prism <code>InteractionRequestTrigger</code>   <code>PopupChildWindowAction</code>            . <br> <br>     <br>     MVVM,       , ,    ,         .        (  , ,  ,   ).    ,  ,  ,            . <br> <br>        ,         . Managed Extensibility Framework (MEF)  Unity Application Block (Unity)      ,  ,           . <br> <br>  ,       , , ,    ( )      . ,       ,     .  ,     ,       . <br> <br>     ,  MEF <br>  MEF,       ,   <code>Import</code> ,      ,  ,   <code><span class="hljs-keyword"><span class="hljs-keyword">Export</span></span></code> .         ,    . <br> <br> , <code>QuestionnaireView</code>   <i>RI MVVM</i> ,        ,    <code>Import</code> .   , MEF           .  <code><span class="hljs-keyword"><span class="hljs-keyword">set</span></span></code>        ,   . <br> <br> <code class="cs">[Import] public QuestionnaireViewModel ViewModel { <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> { this.DataContext = value; } }</code> <br>     ,   . <br> <br> <code class="cs">[<span class="hljs-keyword"><span class="hljs-keyword">Export</span></span>] public class QuestionnaireViewModel : NotificationObject { ... }</code> <br>        ,   . <br> <br> <code class="cs">public QuestionnaireView() { InitializeComponent(); } [ImportingConstructor] public QuestionnaireView(QuestionnaireViewModel viewModel) : this() { this.DataContext = viewModel; }</code> <br> <b></b> <br>          MEF,   Unity.   ,     ,        .   ,   Visual Studio  Expression Blend, ,        ,     .   ,   ,  ,      ,          <code>InitializeComponent</code> . <br>     ,  Unity <br>  Unity,    ,   MEF.     ,      .    ,         .  ,      . <br> <br>  ,      ,  ,         . ,           ,   . <br> <br> <code class="cs">public QuestionnaireView() { InitializeComponent(); } public QuestionnaireView(QuestionnaireViewModel viewModel) : this() { this.DataContext = viewModel; }</code> <br> <b></b> <br>    ,        ,   Visual Studio  Expression Blend. <br>  ,          ,   . Unity        <code><span class="hljs-keyword"><span class="hljs-keyword">set</span></span></code>   ,   . <br> <br> <code class="cs">public QuestionnaireView() { InitializeComponent(); } [Dependency] public QuestionnaireViewModel ViewModel { <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> { this.DataContext = value; } }</code> <br>       Unity. <br> <br> <code class="cs">container.RegisterType&lt;QuestionnaireViewModel&gt;();</code> <br>  ,     . <br> <br> <code class="cs">var view = container.Resolve&lt;QuestionnaireView&gt;();</code> <br>     ,    <br>   ,     ,        .        ,   MEF  Unity,        . <br> <br>          .   ,         UI,           . <br> <br> , <i>RI MVVM</i>   ,   ,        .   ,    .      <code>ShowView</code>   UI. <br> <br> <code class="cs">private void NavigateToQuestionnaireList() { //     <span class="hljs-string"><span class="hljs-string">"questionnaire list"</span></span>. this.uiService.ShowView(ViewNames.QuestionnaireTemplatesList); }</code> <br>  UI      UI .           UI.  <code>ShowView</code>  <code>UIService</code>      (,          ),       ,   . <br> <br> <code class="cs">public void ShowView(<span class="hljs-keyword"><span class="hljs-keyword">string</span></span> viewName) { var view = this.ViewFactory.GetView(viewName); this.MainWindow.CurrentView = view; }</code> <br> <b></b> <br> Prism       .   ,   ,   ,             .    ,  , <span class="hljs-string"><span class="hljs-string">" </span></span><a href="http://msdn.microsoft.com/en-us/library/gg430861(v%3DPandP.40).aspx"><span class="hljs-string"><span class="hljs-string">View-Based Navigation</span></span></a><span class="hljs-string"><span class="hljs-string"> "</span></span>   <span class="hljs-number"><span class="hljs-number">8</span></span>, <span class="hljs-string"><span class="hljs-string">" </span></span><a href="http://msdn.microsoft.com/en-us/library/gg430861(v%3DPandP.40).aspx"><span class="hljs-string"><span class="hljs-string">Navigation</span></span></a><span class="hljs-string"><span class="hljs-string"> "</span></span>. <br>  MVVM  <br>        MVVM      .           -      mocking . ,   ,        . <br> <br>   <i>INotifyPropertyChanged</i> <br>   <code>INotifyPropertyChanged</code>     ,      .      ,    ;   ,   ,     ,    ,       . <br> <br>   <br> ,       ,           <code>PropertyChanged</code>  ,         .  ,    <code>ChangeTracker</code> ,     MVVM,  ,      .      .     ,    . <br> <br> <code class="cs">var changeTracker = new PropertyChangeTracker(viewModel); viewModel.CurrentState = <span class="hljs-string"><span class="hljs-string">"newState"</span></span>; CollectionAssert.Contains(changeTracker.ChangedProperties, <span class="hljs-string"><span class="hljs-string">"CurrentState"</span></span>);</code> <br> ,     ,     <code>INotifyPropertyChanged</code> ,    ,   ,     . <br> <br>      <br>        ,   ,    <code><span class="hljs-keyword"><span class="hljs-keyword">set</span></span></code>      ,           . ,     ,     ,      ,          . <br> <br> <code class="cs">var changeTracker = new PropertyChangeTracker(viewModel); var question = viewModel.Questions.First() as OpenQuestionViewModel; question.Question.Response = <span class="hljs-string"><span class="hljs-string">"some text"</span></span>; CollectionAssert.Contains(changeTracker.ChangedProperties, <span class="hljs-string"><span class="hljs-string">"UnansweredQuestions"</span></span>);</code> <br>      <br>     <code>INotifyPropertyChanged</code> ,      <code>PropertyChanged</code>        ,  ,     , , .        ,       . <br> <br>   <i>INotifyDataErrorInfo</i> <br>   ,     ,    ,   ,   <code>IDataErrorInfo</code> ,  ( Silverlight)   <code>INotifyDataErrorInfo</code> .   <code>INotifyDataErrorInfo</code>   ,         ,    ,  ,   ,    . <br> <br>       <code>INotifyDataErrorInfo</code> : ,     ,  ,     ,     <code>ErrorsChanged</code> ,      <code>GetErrors</code> , . <br> <br>    <br>     ,      ,     .       ,         <code>GetErrors</code>       ,  ,  ,   .    , ,  ,     ,        .   ,        . <br> <br> <code class="cs">//  . var notifyErrorInfo = (INotifyDataErrorInfo)question; question.Response = -<span class="hljs-number"><span class="hljs-number">15</span></span>; Assert.IsTrue(notifyErrorInfo.GetErrors(<span class="hljs-string"><span class="hljs-string">"Response"</span></span>).Cast&lt;ValidationResult&gt;().Any()); //  . var notifyErrorInfo = (INotifyDataErrorInfo)question; question.Response = <span class="hljs-number"><span class="hljs-number">15</span></span>; Assert.IsFalse(notifyErrorInfo.GetErrors(<span class="hljs-string"><span class="hljs-string">"Response"</span></span>).Cast&lt;ValidationResult&gt;().Any());</code> <br>    ,    ,             . <br> <br>    <i>INotifyDataErrorInfo</i> <br>       <code>GetErrors</code> ,   <code>INotifyDataErrorInfo</code>  ,   <code>ErrorsChanged</code>      <code>GetErrors</code> . ,  <code>HasErrors</code>      ,  . <br> <br>       <code>INotifyDataErrorInfo</code> . , ,           ,   -  .      ,        <code>INotifyDataErrorInfo</code>         (,        ). <br> <br>     ,   ,  : <br>  <code>HasErrors</code>     .              ,       .  <code>ErrorsChanged</code> ,      ,         <code>GetErrors</code> .         ( ,  )     ,           .    <code>GetErrors</code>       <code>ErrorsChanged</code> . <br>    <code>INotifyPropertyChanged</code> ,  ,    <code>NotifyDataErrorInfoTestHelper</code>    MVVM,        <code>INotifyDataErrorInfo</code> ,       .   ,   ,      ,   .      . <br> <code class="cs">var helper = new NotifyDataErrorInfoTestHelper&lt;NumericQuestion, int?&gt;( question, q =&gt; q.Response); helper.ValidatePropertyChange( <span class="hljs-number"><span class="hljs-number">6</span></span>, NotifyDataErrorInfoBehavior.Nothing); helper.ValidatePropertyChange( <span class="hljs-number"><span class="hljs-number">20</span></span>, NotifyDataErrorInfoBehavior.FiresErrorsChanged | NotifyDataErrorInfoBehavior.HasErrors | NotifyDataErrorInfoBehavior.HasErrorsForProperty); helper.ValidatePropertyChange( null, NotifyDataErrorInfoBehavior.FiresErrorsChanged | NotifyDataErrorInfoBehavior.HasErrors | NotifyDataErrorInfoBehavior.HasErrorsForProperty); helper.ValidatePropertyChange( <span class="hljs-number"><span class="hljs-number">2</span></span>, NotifyDataErrorInfoBehavior.FiresErrorsChanged);</code> <br>     <br>   MVVM,     ,  .   ,    ,         . <br> <br>  ,     ,     ,       .   ,   , ,       ,     ,   <code>IAsyncResult</code>    ,  - ,   ,    UI. <br> <br>       , , ,    .   ,     .  ,      UI,     ,   ,          ,     ,        <span class="hljs-string"><span class="hljs-string">"   UI."</span></span> <br> <br>     ,    ,    .   ,    ,     mock-, ,   ,   ,      ,          . <br> <br>           UI,    ,    .   ,     ,   ,      .        ,   .     ,    ,     . <br> <br> questionnaireRepositoryMock .Setup( r =&gt; r.SubmitQuestionnaireAsync( It.IsAny&lt;Questionnaire&gt;(), It.IsAny&lt;Action&lt;IOperationResult&gt;&gt;())) .Callback&lt;Questionnaire, Action&lt;IOperationResult&gt;&gt;( (q, a) =&gt; callback = a); uiServicemock .Setup(svc =&gt; svc.ShowView(ViewNames.QuestionnaireTemplatesList)) .Callback&lt;<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>&gt;(viewName =&gt; requestedViewName = viewName); submitResultMock .Setup(sr =&gt; sr.Error) .Returns&lt;Exception&gt;(null); CompleteQuestionnaire(viewModel); viewModel.Submit(); //      UI . callback(submitResultMock.Object); //    ‚Äì     . Assert.AreEqual(ViewNames.QuestionnaireTemplatesList, requestedViewName); <br> <b></b> <br>          ,        . <br>   <br>       , . <span class="hljs-string"><span class="hljs-string">"Trees in WPF"</span></span>  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ms753391.aspx">http://msdn.microsoft.com/en-us/library/ms753391.aspx</a> <br> <br>       , . <span class="hljs-string"><span class="hljs-string">"Attached Properties Overview"</span></span>  MSDN: <a href="http://msdn.microsoft.com/en-us/library/cc265152(VS.95).aspx">http://msdn.microsoft.com/en-us/library/cc265152(VS.<span class="hljs-number"><span class="hljs-number">95</span></span>).aspx</a> <br> <br>      MEF, .<span class="hljs-string"><span class="hljs-string">"Managed Extensibility Framework Overview"</span></span>  MSDN: <a href="http://msdn.microsoft.com/en-us/library/dd460648.aspx">http://msdn.microsoft.com/en-us/library/dd460648.aspx</a> . <br> <br>      Unity, .<span class="hljs-string"><span class="hljs-string">"Unity Application Block"</span></span>  MSDN: <a href="http://www.msdn.com/unity">http://www.msdn.com/unity</a> . <br> <br>      <code>DelegateCommand</code> , .Chapter <span class="hljs-number"><span class="hljs-number">5</span></span>, <span class="hljs-string"><span class="hljs-string">" </span></span><a href="http://msdn.microsoft.com/en-us/library/gg405484(v%3DPandP.40).aspx"><span class="hljs-string"><span class="hljs-string">Implementing the MVVM Pattern</span></span></a><span class="hljs-string"><span class="hljs-string"> ."</span></span> <br> <br>        Microsoft Expression Blend, .<span class="hljs-string"><span class="hljs-string">"Working with built-in behaviors"</span></span>  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ff724013(v%3DExpression.40).aspx">http://msdn.microsoft.com/en-us/library/ff724013(v=Expression.<span class="hljs-number"><span class="hljs-number">40</span></span>).aspx</a> . <br> <br>          Microsoft Expression Blend, .<span class="hljs-string"><span class="hljs-string">"Creating Custom Behaviors"</span></span>  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ff724708(v%3DExpression.40).aspx">http://msdn.microsoft.com/en-us/library/ff724708(v=Expression.<span class="hljs-number"><span class="hljs-number">40</span></span>).aspx</a> . <br> <br>            Microsoft Expression Blend, .<span class="hljs-string"><span class="hljs-string">"Creating Custom Triggers and Actions"</span></span>  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ff724707(v%3DExpression.40).aspx">http://msdn.microsoft.com/en-us/library/ff724707(v=Expression.<span class="hljs-number"><span class="hljs-number">40</span></span>).aspx</a> . <br> <br>         WPF  Silverlight, .<span class="hljs-string"><span class="hljs-string">"Threading Model"</span></span>  <span class="hljs-string"><span class="hljs-string">"The Dispatcher Class"</span></span>  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ms741870.aspx">http://msdn.microsoft.com/en-us/library/ms741870.aspx</a> <br> <a href="http://msdn.microsoft.com/en-us/library/ms615907(v%3DVS.95).aspx">http://msdn.microsoft.com/en-us/library/ms615907(v=VS.<span class="hljs-number"><span class="hljs-number">95</span></span>).aspx</a> . <br> <br>      unit-  Silverlight, .<span class="hljs-string"><span class="hljs-string">"Unit Testing with Silverlight 2"</span></span>: <a href="http://www.jeff.wilcox.name/2008/03/silverlight2-unit-testing/">http://www.jeff.wilcox.name/<span class="hljs-number"><span class="hljs-number">2008</span></span>/<span class="hljs-number"><span class="hljs-number">03</span></span>/silverlight2-unit-testing/</a> . <br> <br>         , .  <span class="hljs-string"><span class="hljs-string">" </span></span><a href="http://msdn.microsoft.com/en-us/library/gg430861(v%3DPandP.40).aspx"><span class="hljs-string"><span class="hljs-string">View-Based Navigation</span></span></a><span class="hljs-string"><span class="hljs-string"> "</span></span> in Chapter <span class="hljs-number"><span class="hljs-number">8</span></span>, <span class="hljs-string"><span class="hljs-string">" </span></span><a href="http://msdn.microsoft.com/en-us/library/gg430861(v%3DPandP.40).aspx"><span class="hljs-string"><span class="hljs-string">Navigation</span></span></a><span class="hljs-string"><span class="hljs-string"> ."</span></span> <br> <br>       ,   , .<span class="hljs-string"><span class="hljs-string">"Event-based Asynchronous Pattern Overview"</span></span>  MSDN: <a href="http://msdn.microsoft.com/en-us/library/wewwczdw.aspx">http://msdn.microsoft.com/en-us/library/wewwczdw.aspx</a> <br> <br>        <code>IAsyncResult</code> , .<span class="hljs-string"><span class="hljs-string">"Asynchronous Programming Overview"</span></span>  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ms228963.aspx">http://msdn.microsoft.com/en-us/library/ms228963.aspx</a></code></code></code></code></code></code></code></code></code></code> </pre> <code><code><code><code><code><code><code><code><code><code>CommandBehaviorBase ,    ,    ICommand</code> .           <code>CanExecuteChanged</code> ,          Silverlight,    WPF. <br> <br>    ,  ,   <code>CommandBehaviorBase    ,    .         ,      .         ,    .      ButtonBaseClickCommandBehavior</code> . <br> <br> <code class="cs">public class ButtonBaseClickCommandBehavior : CommandBehaviorBase&lt;ButtonBase&gt; { public ButtonBaseClickCommandBehavior(ButtonBase clickableObject) : base(clickableObject) { clickableObject.Click += OnClick; } private void OnClick(object sender, System.Windows.RoutedEventArgs e) { ExecuteCommand(); } }</code> <br>   <code>CommandBehaviorBase ,     .     ,          ,   . ,    ,    ,      , ,    CanExecute</code>  ,     . <br> <br>          ,   .           XAML.           .       .  Prism      ,       ,  ,   .       ,    . , ,  ,      <code>Click</code> ,       <code>Command</code> .    <code>Click.Command</code> ,  . <br> <br>             .             . <br> <br> <code class="cs">public static readonly DependencyProperty CommandProperty = DependencyProperty.RegisterAttached( "Command", typeof(ICommand), typeof(Click), new PropertyMetadata(OnSetCommandCallback)); private static readonly DependencyProperty ClickCommandBehaviorProperty = DependencyProperty.RegisterAttached( "ClickCommandBehavior", typeof(ButtonBaseClickCommandBehavior), typeof(Click), null);</code> <br>    <code>Command</code>    <code>ButtonBaseClickCommandBehavior</code> ,     <code>OnSetCommandCallback</code> ,     . <br> <br> <code class="cs">private static void OnSetCommandCallback(DependencyObject dependencyObject, DependencyPropertyChangedEventArgs e) { ButtonBase buttonBase = dependencyObject as ButtonBase; if (buttonBase != null) { ButtonBaseClickCommandBehavior behavior = GetOrCreateBehavior(buttonBase); behavior.Command = e.NewValue as ICommand; } } private static void OnSetCommandParameterCallback(DependencyObject dependencyObject, DependencyPropertyChangedEventArgs e) { ButtonBase buttonBase = dependencyObject as ButtonBase; if (buttonBase != null) { ButtonBaseClickCommandBehavior behavior = GetOrCreateBehavior(buttonBase); behavior.CommandParameter = e.NewValue; } } private static ButtonBaseClickCommandBehavior GetOrCreateBehavior(ButtonBase buttonBase ) { ButtonBaseClickCommandBehavior behavior = buttonBase.GetValue(ClickCommandBehaviorProperty) as ButtonBaseClickCommandBehavior; if ( behavior == null ) { behavior = new ButtonBaseClickCommandBehavior(buttonBase); buttonBase.SetValue(ClickCommandBehaviorProperty, behavior); } return behavior; }</code> <br>        ,  <a href="http://msdn.microsoft.com/en-us/library/cc265152(VS.95).aspx">Attached Properties Overview</a>  MSDN. <br> <br>    <br>              . ,     Silverlight,    -,     ,      ,     .     ,       . <br> <br>        ,    ( )  ,  ,     .  UI       ,            UI. <br> <br>      - <br>   -     ,       <code>IAsyncResult</code> .   ,  ,   ,  <code>GetQuestionnaire</code> ,   : <code>BeginGetQuestionnaire</code>  <code>EndGetQuestionnaire</code> .    ,   <code>BeginGetQuestionnaire</code> .     ,   ,   <code>EndGetQuestionnaire</code>    . <br> <b></b> <br>  .NET Framework 4.5      <code>await</code>  <code>async</code>     <code>*Async</code> .      <a href="http://msdn.microsoft.com/en-us/library/vstudio/hh391443.aspx">"Asynchronous Programming with Async and Await (C# and Visual Basic)"</a> . <br>  ,    <code>EndGetQuestionnaire</code> ,      ,  ()      <code>BeginGetQuestionnaire</code> .     ,      ,   <code>EndGetQuestionnaire</code> ,   . <br> <br> <code class="xml">IAsyncResult asyncResult = this.service.BeginGetQuestionnaire( GetQuestionnaireCompleted, null //  ,      ); private void GetQuestionnaireCompleted(IAsyncResult result) { try { questionnaire = this.service.EndGetQuestionnaire(ar); } catch (Exception ex) { //  -   . } }</code> <br>  ,     <code>End*</code> (  , <code>EndGetQuestionnaire</code> ),    ,      .      , ,          UI.     ,   ,        . <br> <br>        UI,     -,      UI,         UI,   <code>Dispatcher</code>    <code>SynchronizationContext</code> .  WPF  Silverlight,   <code>Dispatcher</code> . <br> <br>      <code>Questionnaire</code>  ,        <code>QuestionnaireView</code> .  Silverlight    <code>CheckAccess</code> ,  ,      UI.  ,     <code>BeginInvoke</code> ,      UI. <br> <br> <code class="cs">var dispatcher = System.Windows.Deployment.Current.Dispatcher; if (dispatcher.CheckAccess()) { QuestionnaireView.DataContext = questionnaire; } else { dispatcher.BeginInvoke(() =&gt; { Questionnaire.DataContext = questionnaire; }); }</code> <br> <i>MVVM RI</i>   ,    ,   <code>IAsyncResult</code> ,   .      ,                 . ,       . <br> <br> <code class="cs">this.questionnaireRepository.GetQuestionnaireAsync( result =&gt; { this.Questionnaire = result.Result; });</code> <br>  <code>result</code>   ,     , , , .    ,     . <br> <br> <code class="cs">this.questionnaireRepository.GetQuestionnaireAsync( result =&gt; { if (result.Error == null) { this.Questionnaire = result.Result; ... } else { // Handle error. } })</code> <br>     <br>        ,      .     , ,             .        ,      ,     ,     . <br> <br>         ,      MVVM,     ,   . ,  -MVVM ,     <code>MessageBox</code>   code-behind UI,      .   MVVM     ,          . <br> <br>     MVVM,              ,          .      ,    ,   ,  ,     . <br> <br>              MVVM.      ,     ,     ,  ,     .    ,         ,     ,          .       . <br> <br>    <br>                  .        ,        .  ,         .         . <br> <br>  ,         ,         ,  .      ,     .           ,       . ,        WPF  Silverlight,        . <br> <br> <img title="Using the service to interact with the user." src="https://habrastorage.org/getpro/habr/post_images/4b5/397/f2d/4b5397f2d02e5851195b29f1893be6fc.png" alt=" ,    ."> <br> <br>  ,   <code>MessageBox</code>        ,     ,    ,     . <br> <br> <code class="cs">var result = interactionService.ShowMessageBox( "Are you sure you want to cancel this operation?", "Confirm", MessageBoxButton.OK); if (result == MessageBoxResult.Yes) { CancelRequest(); }</code> <br> ,      - ,      ,         Silverlight.         .             .     . <br> <br> <code class="cs">interactionService.ShowMessageBox( "Are you sure you want to cancel this operation?", "Confirm", MessageBoxButton.OK, result =&gt; { if (result == MessageBoxResult.Yes) { CancelRequest(); } });</code> <br>         ,      . ,  WPF    <code>MessageBox</code> ,       ;    Silverlight    ,    . <br> <br>     <br>         ‚Äì             .         ,      .     ,     .        ,        ,   ,     . <br> <br> <img title="Using interaction request objects." src="https://habrastorage.org/getpro/habr/post_images/3d0/ff0/1c5/3d0ff01c5518558c2d3c5c5f47ce0ce9.png" alt="   ."> <br> <br>    ,   ,          ‚Äì       ,      ,   ‚Äì     .   ,        ,    ,    UI            . <br> <br>       MVVM,     ,       ,         .         ,        ,    ,   . <br> <br>  Prism       <code>IInteractionRequest</code>   <code>InteractionRequest .  IInteractionRequest</code>  ,   .           ,   .  <code>InteractionRequest   IInteractionRequest</code>     <code>Raise</code> ,           , , ,   . <br> <br>       <br>  <code>InteractionRequest          .  Raise</code>          ( <code>T</code> )    ,    ,   .          ,       .      ,        .    ,  ,     . <br> <code class="cs">public interface IInteractionRequest { event EventHandler&lt;InteractionRequestedEventArgs&gt; Raised; } public class InteractionRequest&lt;T&gt; : IInteractionRequest { public event EventHandler&lt;InteractionRequestedEventArgs&gt; Raised; public void Raise(T context, Action&lt;T&gt; callback) { var handler = this.Raised; if (handler != null) { handler( this, new InteractionRequestedEventArgs(context, () =&gt; callback(context))); } } }</code> <br> Prism    ,      .  <code>Notification</code>       .    ,            .     ‚Äì <code>Title</code>  <code>Content</code> ,    .  ,   ,  ,  ,        . <br> <br>  <code>Confirmation</code>    <code>Notification</code>     ‚Äì <code>Confirmed</code> ,  ,  ,      .  <code>Confirmation</code> ,     <code>MessageBox</code> ,     /  .     ,     <code>Notification</code> ,     ,      . <br> <br>    <code>InteractionRequest ,       InteractionRequest      ,      .      ,    Raise</code> ,    , ,   . <br> <br> <code class="cs">public IInteractionRequest ConfirmCancelInteractionRequest { get { return this.confirmCancelInteractionRequest; } } this.confirmCancelInteractionRequest.Raise( new Confirmation("Are you sure you wish to cancel?"), confirmation =&gt; { if (confirmation.Confirmed) { this.NavigateToQuestionnaireList(); } }); }</code> <br> <i>MVVM Reference Implementation (MVVM RI)</i> ,    <code>IInteractionRequest</code>   <code>InteractionRequest ,          (. QuestionnaireViewModel.cs</code> ). <br> <br>        <br>       ,       .   ,       .    UI             . <br> <br>                . Microsoft Expression Blend Behaviors Framework     .  ,     ,    . <br> <br>  <code>EventTrigger</code> ,  Expression Blend,  ,      ,     ,   . , Prism   <code>EventTrigger</code> ,  <code>InteractionRequestTrigger</code> ,      <code>Raised</code>   <code>IInteractionRequest</code> .    XAML        . <br> <br>  ,   , <code>InteractionRequestTrigger</code>   .  Silverlight Prism   <code>PopupChildWindowAction</code> ,     .    ,         .   <code>ContentTemplate</code>  <code>PopupChildWindowAction</code> ,    ,    UI,      <code>Content</code>  .       <code>Title</code>  . <br> <b></b> <br>  ,    ,   <code>PopupChildWindowAction</code> ,     .    <code>Notification</code>  <code>NotificationChildWindow</code> ,        <code>Confirmation</code> ‚Äì <code>ConfirmationChildWindow</code> . <code>NotificationChildWindow</code>    ,   ,     <code>ConfirmationChildWindow</code>    <i>OK</i>  <i>Cancel</i> ,    .    ,   ,   <code>ChildWindow</code>  <code>PopupChildWindowAction</code> . <br>   ,  <code>InteractionRequestTrigger</code>  <code>PopupChildWindowAction</code> ,       <i>RI MVVM</i> . <br> <br> <code class="xml">&lt;i:Interaction.Triggers&gt; &lt;prism:InteractionRequestTrigger SourceObject="{Binding ConfirmCancelInteractionRequest}"&gt; &lt;prism:PopupChildWindowAction ContentTemplate="{StaticResource ConfirmWindowTemplate}"/&gt; &lt;/prism:InteractionRequestTrigger&gt; &lt;/i:Interaction.Triggers&gt; &lt;UserControl.Resources&gt; &lt;DataTemplate x:Key="ConfirmWindowTemplate"&gt; &lt;Grid MinWidth="250" MinHeight="100"&gt; &lt;TextBlock TextWrapping="Wrap" Grid.Row="0" Text="{Binding}"/&gt; &lt;/Grid&gt; &lt;/DataTemplate&gt; &lt;/UserControl.Resources&gt;</code> <br> <b></b> <br>      <code>ContentTemplate</code> ,   UI   <code>Content</code>  .    <code>Content</code>  ,  , <code>TextBlock</code>     <code>Content</code> . <br>      ,     ,    ,    .  ,     ,       ,     ,    .   ,   <i>RI MVVM</i> ,         <code>Confirmed</code>    <code>Confirmation</code>  <code>true</code> ,     OK. <br> <br>        ,     .  Prism <code>InteractionRequestTrigger</code>   <code>PopupChildWindowAction</code>            . <br> <br>     <br>     MVVM,       , ,    ,         .        (  , ,  ,   ).    ,  ,  ,            . <br> <br>        ,         . Managed Extensibility Framework (MEF)  Unity Application Block (Unity)      ,  ,           . <br> <br>  ,       , , ,    ( )      . ,       ,     .  ,     ,       . <br> <br>     ,  MEF <br>  MEF,       ,   <code>Import</code> ,      ,  ,   <code>Export</code> .         ,    . <br> <br> , <code>QuestionnaireView</code>   <i>RI MVVM</i> ,        ,    <code>Import</code> .   , MEF           .  <code>set</code>        ,   . <br> <br> <code class="cs">[Import] public QuestionnaireViewModel ViewModel { set { this.DataContext = value; } }</code> <br>     ,   . <br> <br> <code class="cs">[Export] public class QuestionnaireViewModel : NotificationObject { ... }</code> <br>        ,   . <br> <br> <code class="cs">public QuestionnaireView() { InitializeComponent(); } [ImportingConstructor] public QuestionnaireView(QuestionnaireViewModel viewModel) : this() { this.DataContext = viewModel; }</code> <br> <b></b> <br>          MEF,   Unity.   ,     ,        .   ,   Visual Studio  Expression Blend, ,        ,     .   ,   ,  ,      ,          <code>InitializeComponent</code> . <br>     ,  Unity <br>  Unity,    ,   MEF.     ,      .    ,         .  ,      . <br> <br>  ,      ,  ,         . ,           ,   . <br> <br> <code class="cs">public QuestionnaireView() { InitializeComponent(); } public QuestionnaireView(QuestionnaireViewModel viewModel) : this() { this.DataContext = viewModel; }</code> <br> <b></b> <br>    ,        ,   Visual Studio  Expression Blend. <br>  ,          ,   . Unity        <code>set</code>   ,   . <br> <br> <code class="cs">public QuestionnaireView() { InitializeComponent(); } [Dependency] public QuestionnaireViewModel ViewModel { set { this.DataContext = value; } }</code> <br>       Unity. <br> <br> <code class="cs">container.RegisterType&lt;QuestionnaireViewModel&gt;();</code> <br>  ,     . <br> <br> <code class="cs">var view = container.Resolve&lt;QuestionnaireView&gt;();</code> <br>     ,    <br>   ,     ,        .        ,   MEF  Unity,        . <br> <br>          .   ,         UI,           . <br> <br> , <i>RI MVVM</i>   ,   ,        .   ,    .      <code>ShowView</code>   UI. <br> <br> <code class="cs">private void NavigateToQuestionnaireList() { //     "questionnaire list". this.uiService.ShowView(ViewNames.QuestionnaireTemplatesList); }</code> <br>  UI      UI .           UI.  <code>ShowView</code>  <code>UIService</code>      (,          ),       ,   . <br> <br> <code class="cs">public void ShowView(string viewName) { var view = this.ViewFactory.GetView(viewName); this.MainWindow.CurrentView = view; }</code> <br> <b></b> <br> Prism       .   ,   ,   ,             .    ,  , " <a href="http://msdn.microsoft.com/en-us/library/gg430861(v%3DPandP.40).aspx">View-Based Navigation</a> "   8, " <a href="http://msdn.microsoft.com/en-us/library/gg430861(v%3DPandP.40).aspx">Navigation</a> ". <br>  MVVM  <br>        MVVM      .           -      mocking . ,   ,        . <br> <br>   <i>INotifyPropertyChanged</i> <br>   <code>INotifyPropertyChanged</code>     ,      .      ,    ;   ,   ,     ,    ,       . <br> <br>   <br> ,       ,           <code>PropertyChanged</code>  ,         .  ,    <code>ChangeTracker</code> ,     MVVM,  ,      .      .     ,    . <br> <br> <code class="cs">var changeTracker = new PropertyChangeTracker(viewModel); viewModel.CurrentState = "newState"; CollectionAssert.Contains(changeTracker.ChangedProperties, "CurrentState");</code> <br> ,     ,     <code>INotifyPropertyChanged</code> ,    ,   ,     . <br> <br>      <br>        ,   ,    <code>set</code>      ,           . ,     ,     ,      ,          . <br> <br> <code class="cs">var changeTracker = new PropertyChangeTracker(viewModel); var question = viewModel.Questions.First() as OpenQuestionViewModel; question.Question.Response = "some text"; CollectionAssert.Contains(changeTracker.ChangedProperties, "UnansweredQuestions");</code> <br>      <br>     <code>INotifyPropertyChanged</code> ,      <code>PropertyChanged</code>        ,  ,     , , .        ,       . <br> <br>   <i>INotifyDataErrorInfo</i> <br>   ,     ,    ,   ,   <code>IDataErrorInfo</code> ,  ( Silverlight)   <code>INotifyDataErrorInfo</code> .   <code>INotifyDataErrorInfo</code>   ,         ,    ,  ,   ,    . <br> <br>       <code>INotifyDataErrorInfo</code> : ,     ,  ,     ,     <code>ErrorsChanged</code> ,      <code>GetErrors</code> , . <br> <br>    <br>     ,      ,     .       ,         <code>GetErrors</code>       ,  ,  ,   .    , ,  ,     ,        .   ,        . <br> <br> <code class="cs">//  . var notifyErrorInfo = (INotifyDataErrorInfo)question; question.Response = -15; Assert.IsTrue(notifyErrorInfo.GetErrors("Response").Cast&lt;ValidationResult&gt;().Any()); //  . var notifyErrorInfo = (INotifyDataErrorInfo)question; question.Response = 15; Assert.IsFalse(notifyErrorInfo.GetErrors("Response").Cast&lt;ValidationResult&gt;().Any());</code> <br>    ,    ,             . <br> <br>    <i>INotifyDataErrorInfo</i> <br>       <code>GetErrors</code> ,   <code>INotifyDataErrorInfo</code>  ,   <code>ErrorsChanged</code>      <code>GetErrors</code> . ,  <code>HasErrors</code>      ,  . <br> <br>       <code>INotifyDataErrorInfo</code> . , ,           ,   -  .      ,        <code>INotifyDataErrorInfo</code>         (,        ). <br> <br>     ,   ,  : <br>  <code>HasErrors</code>     .              ,       .  <code>ErrorsChanged</code> ,      ,         <code>GetErrors</code> .         ( ,  )     ,           .    <code>GetErrors</code>       <code>ErrorsChanged</code> . <br>    <code>INotifyPropertyChanged</code> ,  ,    <code>NotifyDataErrorInfoTestHelper</code>    MVVM,        <code>INotifyDataErrorInfo</code> ,       .   ,   ,      ,   .      . <br> <code class="cs">var helper = new NotifyDataErrorInfoTestHelper&lt;NumericQuestion, int?&gt;( question, q =&gt; q.Response); helper.ValidatePropertyChange( 6, NotifyDataErrorInfoBehavior.Nothing); helper.ValidatePropertyChange( 20, NotifyDataErrorInfoBehavior.FiresErrorsChanged | NotifyDataErrorInfoBehavior.HasErrors | NotifyDataErrorInfoBehavior.HasErrorsForProperty); helper.ValidatePropertyChange( null, NotifyDataErrorInfoBehavior.FiresErrorsChanged | NotifyDataErrorInfoBehavior.HasErrors | NotifyDataErrorInfoBehavior.HasErrorsForProperty); helper.ValidatePropertyChange( 2, NotifyDataErrorInfoBehavior.FiresErrorsChanged);</code> <br>     <br>   MVVM,     ,  .   ,    ,         . <br> <br>  ,     ,     ,       .   ,   , ,       ,     ,   <code>IAsyncResult</code>    ,  - ,   ,    UI. <br> <br>       , , ,    .   ,     .  ,      UI,     ,   ,          ,     ,        "   UI." <br> <br>     ,    ,    .   ,    ,     mock-, ,   ,   ,      ,          . <br> <br>           UI,    ,    .   ,     ,   ,      .        ,   .     ,    ,     . <br> <br> <code class="cs">questionnaireRepositoryMock .Setup( r =&gt; r.SubmitQuestionnaireAsync( It.IsAny&lt;Questionnaire&gt;(), It.IsAny&lt;Action&lt;IOperationResult&gt;&gt;())) .Callback&lt;Questionnaire, Action&lt;IOperationResult&gt;&gt;( (q, a) =&gt; callback = a); uiServicemock .Setup(svc =&gt; svc.ShowView(ViewNames.QuestionnaireTemplatesList)) .Callback&lt;string&gt;(viewName =&gt; requestedViewName = viewName); submitResultMock .Setup(sr =&gt; sr.Error) .Returns&lt;Exception&gt;(null); CompleteQuestionnaire(viewModel); viewModel.Submit(); //      UI . callback(submitResultMock.Object); //    ‚Äì     . Assert.AreEqual(ViewNames.QuestionnaireTemplatesList, requestedViewName);</code> <br> <b></b> <br>          ,        . <br>   <br>       , . "Trees in WPF"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ms753391.aspx">http://msdn.microsoft.com/en-us/library/ms753391.aspx</a> <br> <br>       , . "Attached Properties Overview"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/cc265152(VS.95).aspx">http://msdn.microsoft.com/en-us/library/cc265152(VS.95).aspx</a> <br> <br>      MEF, ."Managed Extensibility Framework Overview"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/dd460648.aspx">http://msdn.microsoft.com/en-us/library/dd460648.aspx</a> . <br> <br>      Unity, ."Unity Application Block"  MSDN: <a href="http://www.msdn.com/unity">http://www.msdn.com/unity</a> . <br> <br>      <code>DelegateCommand</code> , .Chapter 5, " <a href="http://msdn.microsoft.com/en-us/library/gg405484(v%3DPandP.40).aspx">Implementing the MVVM Pattern</a> ." <br> <br>        Microsoft Expression Blend, ."Working with built-in behaviors"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ff724013(v%3DExpression.40).aspx">http://msdn.microsoft.com/en-us/library/ff724013(v=Expression.40).aspx</a> . <br> <br>          Microsoft Expression Blend, ."Creating Custom Behaviors"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ff724708(v%3DExpression.40).aspx">http://msdn.microsoft.com/en-us/library/ff724708(v=Expression.40).aspx</a> . <br> <br>            Microsoft Expression Blend, ."Creating Custom Triggers and Actions"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ff724707(v%3DExpression.40).aspx">http://msdn.microsoft.com/en-us/library/ff724707(v=Expression.40).aspx</a> . <br> <br>         WPF  Silverlight, ."Threading Model"  "The Dispatcher Class"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ms741870.aspx">http://msdn.microsoft.com/en-us/library/ms741870.aspx</a> <br> <a href="http://msdn.microsoft.com/en-us/library/ms615907(v%3DVS.95).aspx">http://msdn.microsoft.com/en-us/library/ms615907(v=VS.95).aspx</a> . <br> <br>      unit-  Silverlight, ."Unit Testing with Silverlight 2": <a href="http://www.jeff.wilcox.name/2008/03/silverlight2-unit-testing/">http://www.jeff.wilcox.name/2008/03/silverlight2-unit-testing/</a> . <br> <br>         , .  " <a href="http://msdn.microsoft.com/en-us/library/gg430861(v%3DPandP.40).aspx">View-Based Navigation</a> " in Chapter 8, " <a href="http://msdn.microsoft.com/en-us/library/gg430861(v%3DPandP.40).aspx">Navigation</a> ." <br> <br>       ,   , ."Event-based Asynchronous Pattern Overview"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/wewwczdw.aspx">http://msdn.microsoft.com/en-us/library/wewwczdw.aspx</a> <br> <br>        <code>IAsyncResult</code> , ."Asynchronous Programming Overview"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ms228963.aspx">http://msdn.microsoft.com/en-us/library/ms228963.aspx</a></code></code></code></code></code></code></code></code></code> <blockquote> <code><code><code><code><code><code><code><code><code><code>CommandBehaviorBase ,    ,    ICommand</code> .           <code>CanExecuteChanged</code> ,          Silverlight,    WPF. <br> <br>    ,  ,   <code>CommandBehaviorBase    ,    .         ,      .         ,    .      ButtonBaseClickCommandBehavior</code> . <br> <br> <code class="cs">public class ButtonBaseClickCommandBehavior : CommandBehaviorBase&lt;ButtonBase&gt; { public ButtonBaseClickCommandBehavior(ButtonBase clickableObject) : base(clickableObject) { clickableObject.Click += OnClick; } private void OnClick(object sender, System.Windows.RoutedEventArgs e) { ExecuteCommand(); } }</code> <br>   <code>CommandBehaviorBase ,     .     ,          ,   . ,    ,    ,      , ,    CanExecute</code>  ,     . <br> <br>          ,   .           XAML.           .       .  Prism      ,       ,  ,   .       ,    . , ,  ,      <code>Click</code> ,       <code>Command</code> .    <code>Click.Command</code> ,  . <br> <br>             .             . <br> <br> <code class="cs">public static readonly DependencyProperty CommandProperty = DependencyProperty.RegisterAttached( "Command", typeof(ICommand), typeof(Click), new PropertyMetadata(OnSetCommandCallback)); private static readonly DependencyProperty ClickCommandBehaviorProperty = DependencyProperty.RegisterAttached( "ClickCommandBehavior", typeof(ButtonBaseClickCommandBehavior), typeof(Click), null);</code> <br>    <code>Command</code>    <code>ButtonBaseClickCommandBehavior</code> ,     <code>OnSetCommandCallback</code> ,     . <br> <br> <code class="cs">private static void OnSetCommandCallback(DependencyObject dependencyObject, DependencyPropertyChangedEventArgs e) { ButtonBase buttonBase = dependencyObject as ButtonBase; if (buttonBase != null) { ButtonBaseClickCommandBehavior behavior = GetOrCreateBehavior(buttonBase); behavior.Command = e.NewValue as ICommand; } } private static void OnSetCommandParameterCallback(DependencyObject dependencyObject, DependencyPropertyChangedEventArgs e) { ButtonBase buttonBase = dependencyObject as ButtonBase; if (buttonBase != null) { ButtonBaseClickCommandBehavior behavior = GetOrCreateBehavior(buttonBase); behavior.CommandParameter = e.NewValue; } } private static ButtonBaseClickCommandBehavior GetOrCreateBehavior(ButtonBase buttonBase ) { ButtonBaseClickCommandBehavior behavior = buttonBase.GetValue(ClickCommandBehaviorProperty) as ButtonBaseClickCommandBehavior; if ( behavior == null ) { behavior = new ButtonBaseClickCommandBehavior(buttonBase); buttonBase.SetValue(ClickCommandBehaviorProperty, behavior); } return behavior; }</code> <br>        ,  <a href="http://msdn.microsoft.com/en-us/library/cc265152(VS.95).aspx">Attached Properties Overview</a>  MSDN. <br> <br>    <br>              . ,     Silverlight,    -,     ,      ,     .     ,       . <br> <br>        ,    ( )  ,  ,     .  UI       ,            UI. <br> <br>      - <br>   -     ,       <code>IAsyncResult</code> .   ,  ,   ,  <code>GetQuestionnaire</code> ,   : <code>BeginGetQuestionnaire</code>  <code>EndGetQuestionnaire</code> .    ,   <code>BeginGetQuestionnaire</code> .     ,   ,   <code>EndGetQuestionnaire</code>    . <br> <b></b> <br>  .NET Framework 4.5      <code>await</code>  <code>async</code>     <code>*Async</code> .      <a href="http://msdn.microsoft.com/en-us/library/vstudio/hh391443.aspx">"Asynchronous Programming with Async and Await (C# and Visual Basic)"</a> . <br>  ,    <code>EndGetQuestionnaire</code> ,      ,  ()      <code>BeginGetQuestionnaire</code> .     ,      ,   <code>EndGetQuestionnaire</code> ,   . <br> <br> <code class="xml">IAsyncResult asyncResult = this.service.BeginGetQuestionnaire( GetQuestionnaireCompleted, null //  ,      ); private void GetQuestionnaireCompleted(IAsyncResult result) { try { questionnaire = this.service.EndGetQuestionnaire(ar); } catch (Exception ex) { //  -   . } }</code> <br>  ,     <code>End*</code> (  , <code>EndGetQuestionnaire</code> ),    ,      .      , ,          UI.     ,   ,        . <br> <br>        UI,     -,      UI,         UI,   <code>Dispatcher</code>    <code>SynchronizationContext</code> .  WPF  Silverlight,   <code>Dispatcher</code> . <br> <br>      <code>Questionnaire</code>  ,        <code>QuestionnaireView</code> .  Silverlight    <code>CheckAccess</code> ,  ,      UI.  ,     <code>BeginInvoke</code> ,      UI. <br> <br> <code class="cs">var dispatcher = System.Windows.Deployment.Current.Dispatcher; if (dispatcher.CheckAccess()) { QuestionnaireView.DataContext = questionnaire; } else { dispatcher.BeginInvoke(() =&gt; { Questionnaire.DataContext = questionnaire; }); }</code> <br> <i>MVVM RI</i>   ,    ,   <code>IAsyncResult</code> ,   .      ,                 . ,       . <br> <br> <code class="cs">this.questionnaireRepository.GetQuestionnaireAsync( result =&gt; { this.Questionnaire = result.Result; });</code> <br>  <code>result</code>   ,     , , , .    ,     . <br> <br> <code class="cs">this.questionnaireRepository.GetQuestionnaireAsync( result =&gt; { if (result.Error == null) { this.Questionnaire = result.Result; ... } else { // Handle error. } })</code> <br>     <br>        ,      .     , ,             .        ,      ,     ,     . <br> <br>         ,      MVVM,     ,   . ,  -MVVM ,     <code>MessageBox</code>   code-behind UI,      .   MVVM     ,          . <br> <br>     MVVM,              ,          .      ,    ,   ,  ,     . <br> <br>              MVVM.      ,     ,     ,  ,     .    ,         ,     ,          .       . <br> <br>    <br>                  .        ,        .  ,         .         . <br> <br>  ,         ,         ,  .      ,     .           ,       . ,        WPF  Silverlight,        . <br> <br> <img title="Using the service to interact with the user." src="https://habrastorage.org/getpro/habr/post_images/4b5/397/f2d/4b5397f2d02e5851195b29f1893be6fc.png" alt=" ,    ."> <br> <br>  ,   <code>MessageBox</code>        ,     ,    ,     . <br> <br> <code class="cs">var result = interactionService.ShowMessageBox( "Are you sure you want to cancel this operation?", "Confirm", MessageBoxButton.OK); if (result == MessageBoxResult.Yes) { CancelRequest(); }</code> <br> ,      - ,      ,         Silverlight.         .             .     . <br> <br> <code class="cs">interactionService.ShowMessageBox( "Are you sure you want to cancel this operation?", "Confirm", MessageBoxButton.OK, result =&gt; { if (result == MessageBoxResult.Yes) { CancelRequest(); } });</code> <br>         ,      . ,  WPF    <code>MessageBox</code> ,       ;    Silverlight    ,    . <br> <br>     <br>         ‚Äì             .         ,      .     ,     .        ,        ,   ,     . <br> <br> <img title="Using interaction request objects." src="https://habrastorage.org/getpro/habr/post_images/3d0/ff0/1c5/3d0ff01c5518558c2d3c5c5f47ce0ce9.png" alt="   ."> <br> <br>    ,   ,          ‚Äì       ,      ,   ‚Äì     .   ,        ,    ,    UI            . <br> <br>       MVVM,     ,       ,         .         ,        ,    ,   . <br> <br>  Prism       <code>IInteractionRequest</code>   <code>InteractionRequest .  IInteractionRequest</code>  ,   .           ,   .  <code>InteractionRequest   IInteractionRequest</code>     <code>Raise</code> ,           , , ,   . <br> <br>       <br>  <code>InteractionRequest          .  Raise</code>          ( <code>T</code> )    ,    ,   .          ,       .      ,        .    ,  ,     . <br> <code class="cs">public interface IInteractionRequest { event EventHandler&lt;InteractionRequestedEventArgs&gt; Raised; } public class InteractionRequest&lt;T&gt; : IInteractionRequest { public event EventHandler&lt;InteractionRequestedEventArgs&gt; Raised; public void Raise(T context, Action&lt;T&gt; callback) { var handler = this.Raised; if (handler != null) { handler( this, new InteractionRequestedEventArgs(context, () =&gt; callback(context))); } } }</code> <br> Prism    ,      .  <code>Notification</code>       .    ,            .     ‚Äì <code>Title</code>  <code>Content</code> ,    .  ,   ,  ,  ,        . <br> <br>  <code>Confirmation</code>    <code>Notification</code>     ‚Äì <code>Confirmed</code> ,  ,  ,      .  <code>Confirmation</code> ,     <code>MessageBox</code> ,     /  .     ,     <code>Notification</code> ,     ,      . <br> <br>    <code>InteractionRequest ,       InteractionRequest      ,      .      ,    Raise</code> ,    , ,   . <br> <br> <code class="cs">public IInteractionRequest ConfirmCancelInteractionRequest { get { return this.confirmCancelInteractionRequest; } } this.confirmCancelInteractionRequest.Raise( new Confirmation("Are you sure you wish to cancel?"), confirmation =&gt; { if (confirmation.Confirmed) { this.NavigateToQuestionnaireList(); } }); }</code> <br> <i>MVVM Reference Implementation (MVVM RI)</i> ,    <code>IInteractionRequest</code>   <code>InteractionRequest ,          (. QuestionnaireViewModel.cs</code> ). <br> <br>        <br>       ,       .   ,       .    UI             . <br> <br>                . Microsoft Expression Blend Behaviors Framework     .  ,     ,    . <br> <br>  <code>EventTrigger</code> ,  Expression Blend,  ,      ,     ,   . , Prism   <code>EventTrigger</code> ,  <code>InteractionRequestTrigger</code> ,      <code>Raised</code>   <code>IInteractionRequest</code> .    XAML        . <br> <br>  ,   , <code>InteractionRequestTrigger</code>   .  Silverlight Prism   <code>PopupChildWindowAction</code> ,     .    ,         .   <code>ContentTemplate</code>  <code>PopupChildWindowAction</code> ,    ,    UI,      <code>Content</code>  .       <code>Title</code>  . <br> <b></b> <br>  ,    ,   <code>PopupChildWindowAction</code> ,     .    <code>Notification</code>  <code>NotificationChildWindow</code> ,        <code>Confirmation</code> ‚Äì <code>ConfirmationChildWindow</code> . <code>NotificationChildWindow</code>    ,   ,     <code>ConfirmationChildWindow</code>    <i>OK</i>  <i>Cancel</i> ,    .    ,   ,   <code>ChildWindow</code>  <code>PopupChildWindowAction</code> . <br>   ,  <code>InteractionRequestTrigger</code>  <code>PopupChildWindowAction</code> ,       <i>RI MVVM</i> . <br> <br> <code class="xml">&lt;i:Interaction.Triggers&gt; &lt;prism:InteractionRequestTrigger SourceObject="{Binding ConfirmCancelInteractionRequest}"&gt; &lt;prism:PopupChildWindowAction ContentTemplate="{StaticResource ConfirmWindowTemplate}"/&gt; &lt;/prism:InteractionRequestTrigger&gt; &lt;/i:Interaction.Triggers&gt; &lt;UserControl.Resources&gt; &lt;DataTemplate x:Key="ConfirmWindowTemplate"&gt; &lt;Grid MinWidth="250" MinHeight="100"&gt; &lt;TextBlock TextWrapping="Wrap" Grid.Row="0" Text="{Binding}"/&gt; &lt;/Grid&gt; &lt;/DataTemplate&gt; &lt;/UserControl.Resources&gt;</code> <br> <b></b> <br>      <code>ContentTemplate</code> ,   UI   <code>Content</code>  .    <code>Content</code>  ,  , <code>TextBlock</code>     <code>Content</code> . <br>      ,     ,    ,    .  ,     ,       ,     ,    .   ,   <i>RI MVVM</i> ,         <code>Confirmed</code>    <code>Confirmation</code>  <code>true</code> ,     OK. <br> <br>        ,     .  Prism <code>InteractionRequestTrigger</code>   <code>PopupChildWindowAction</code>            . <br> <br>     <br>     MVVM,       , ,    ,         .        (  , ,  ,   ).    ,  ,  ,            . <br> <br>        ,         . Managed Extensibility Framework (MEF)  Unity Application Block (Unity)      ,  ,           . <br> <br>  ,       , , ,    ( )      . ,       ,     .  ,     ,       . <br> <br>     ,  MEF <br>  MEF,       ,   <code>Import</code> ,      ,  ,   <code>Export</code> .         ,    . <br> <br> , <code>QuestionnaireView</code>   <i>RI MVVM</i> ,        ,    <code>Import</code> .   , MEF           .  <code>set</code>        ,   . <br> <br> <code class="cs">[Import] public QuestionnaireViewModel ViewModel { set { this.DataContext = value; } }</code> <br>     ,   . <br> <br> <code class="cs">[Export] public class QuestionnaireViewModel : NotificationObject { ... }</code> <br>        ,   . <br> <br> <code class="cs">public QuestionnaireView() { InitializeComponent(); } [ImportingConstructor] public QuestionnaireView(QuestionnaireViewModel viewModel) : this() { this.DataContext = viewModel; }</code> <br> <b></b> <br>          MEF,   Unity.   ,     ,        .   ,   Visual Studio  Expression Blend, ,        ,     .   ,   ,  ,      ,          <code>InitializeComponent</code> . <br>     ,  Unity <br>  Unity,    ,   MEF.     ,      .    ,         .  ,      . <br> <br>  ,      ,  ,         . ,           ,   . <br> <br> <code class="cs">public QuestionnaireView() { InitializeComponent(); } public QuestionnaireView(QuestionnaireViewModel viewModel) : this() { this.DataContext = viewModel; }</code> <br> <b></b> <br>    ,        ,   Visual Studio  Expression Blend. <br>  ,          ,   . Unity        <code>set</code>   ,   . <br> <br> <code class="cs">public QuestionnaireView() { InitializeComponent(); } [Dependency] public QuestionnaireViewModel ViewModel { set { this.DataContext = value; } }</code> <br>       Unity. <br> <br> <code class="cs">container.RegisterType&lt;QuestionnaireViewModel&gt;();</code> <br>  ,     . <br> <br> <code class="cs">var view = container.Resolve&lt;QuestionnaireView&gt;();</code> <br>     ,    <br>   ,     ,        .        ,   MEF  Unity,        . <br> <br>          .   ,         UI,           . <br> <br> , <i>RI MVVM</i>   ,   ,        .   ,    .      <code>ShowView</code>   UI. <br> <br> <code class="cs">private void NavigateToQuestionnaireList() { //     "questionnaire list". this.uiService.ShowView(ViewNames.QuestionnaireTemplatesList); }</code> <br>  UI      UI .           UI.  <code>ShowView</code>  <code>UIService</code>      (,          ),       ,   . <br> <br> <code class="cs">public void ShowView(string viewName) { var view = this.ViewFactory.GetView(viewName); this.MainWindow.CurrentView = view; }</code> <br> <b></b> <br> Prism       .   ,   ,   ,             .    ,  , " <a href="http://msdn.microsoft.com/en-us/library/gg430861(v%3DPandP.40).aspx">View-Based Navigation</a> "   8, " <a href="http://msdn.microsoft.com/en-us/library/gg430861(v%3DPandP.40).aspx">Navigation</a> ". <br>  MVVM  <br>        MVVM      .           -      mocking . ,   ,        . <br> <br>   <i>INotifyPropertyChanged</i> <br>   <code>INotifyPropertyChanged</code>     ,      .      ,    ;   ,   ,     ,    ,       . <br> <br>   <br> ,       ,           <code>PropertyChanged</code>  ,         .  ,    <code>ChangeTracker</code> ,     MVVM,  ,      .      .     ,    . <br> <br> <code class="cs">var changeTracker = new PropertyChangeTracker(viewModel); viewModel.CurrentState = "newState"; CollectionAssert.Contains(changeTracker.ChangedProperties, "CurrentState");</code> <br> ,     ,     <code>INotifyPropertyChanged</code> ,    ,   ,     . <br> <br>      <br>        ,   ,    <code>set</code>      ,           . ,     ,     ,      ,          . <br> <br> <code class="cs">var changeTracker = new PropertyChangeTracker(viewModel); var question = viewModel.Questions.First() as OpenQuestionViewModel; question.Question.Response = "some text"; CollectionAssert.Contains(changeTracker.ChangedProperties, "UnansweredQuestions");</code> <br>      <br>     <code>INotifyPropertyChanged</code> ,      <code>PropertyChanged</code>        ,  ,     , , .        ,       . <br> <br>   <i>INotifyDataErrorInfo</i> <br>   ,     ,    ,   ,   <code>IDataErrorInfo</code> ,  ( Silverlight)   <code>INotifyDataErrorInfo</code> .   <code>INotifyDataErrorInfo</code>   ,         ,    ,  ,   ,    . <br> <br>       <code>INotifyDataErrorInfo</code> : ,     ,  ,     ,     <code>ErrorsChanged</code> ,      <code>GetErrors</code> , . <br> <br>    <br>     ,      ,     .       ,         <code>GetErrors</code>       ,  ,  ,   .    , ,  ,     ,        .   ,        . <br> <br> <code class="cs">//  . var notifyErrorInfo = (INotifyDataErrorInfo)question; question.Response = -15; Assert.IsTrue(notifyErrorInfo.GetErrors("Response").Cast&lt;ValidationResult&gt;().Any()); //  . var notifyErrorInfo = (INotifyDataErrorInfo)question; question.Response = 15; Assert.IsFalse(notifyErrorInfo.GetErrors("Response").Cast&lt;ValidationResult&gt;().Any());</code> <br>    ,    ,             . <br> <br>    <i>INotifyDataErrorInfo</i> <br>       <code>GetErrors</code> ,   <code>INotifyDataErrorInfo</code>  ,   <code>ErrorsChanged</code>      <code>GetErrors</code> . ,  <code>HasErrors</code>      ,  . <br> <br>       <code>INotifyDataErrorInfo</code> . , ,           ,   -  .      ,        <code>INotifyDataErrorInfo</code>         (,        ). <br> <br>     ,   ,  : <br>  <code>HasErrors</code>     .              ,       .  <code>ErrorsChanged</code> ,      ,         <code>GetErrors</code> .         ( ,  )     ,           .    <code>GetErrors</code>       <code>ErrorsChanged</code> . <br>    <code>INotifyPropertyChanged</code> ,  ,    <code>NotifyDataErrorInfoTestHelper</code>    MVVM,        <code>INotifyDataErrorInfo</code> ,       .   ,   ,      ,   .      . <br> <code class="cs">var helper = new NotifyDataErrorInfoTestHelper&lt;NumericQuestion, int?&gt;( question, q =&gt; q.Response); helper.ValidatePropertyChange( 6, NotifyDataErrorInfoBehavior.Nothing); helper.ValidatePropertyChange( 20, NotifyDataErrorInfoBehavior.FiresErrorsChanged | NotifyDataErrorInfoBehavior.HasErrors | NotifyDataErrorInfoBehavior.HasErrorsForProperty); helper.ValidatePropertyChange( null, NotifyDataErrorInfoBehavior.FiresErrorsChanged | NotifyDataErrorInfoBehavior.HasErrors | NotifyDataErrorInfoBehavior.HasErrorsForProperty); helper.ValidatePropertyChange( 2, NotifyDataErrorInfoBehavior.FiresErrorsChanged);</code> <br>     <br>   MVVM,     ,  .   ,    ,         . <br> <br>  ,     ,     ,       .   ,   , ,       ,     ,   <code>IAsyncResult</code>    ,  - ,   ,    UI. <br> <br>       , , ,    .   ,     .  ,      UI,     ,   ,          ,     ,        "   UI." <br> <br>     ,    ,    .   ,    ,     mock-, ,   ,   ,      ,          . <br> <br>           UI,    ,    .   ,     ,   ,      .        ,   .     ,    ,     . <br> <br> <code class="cs">questionnaireRepositoryMock .Setup( r =&gt; r.SubmitQuestionnaireAsync( It.IsAny&lt;Questionnaire&gt;(), It.IsAny&lt;Action&lt;IOperationResult&gt;&gt;())) .Callback&lt;Questionnaire, Action&lt;IOperationResult&gt;&gt;( (q, a) =&gt; callback = a); uiServicemock .Setup(svc =&gt; svc.ShowView(ViewNames.QuestionnaireTemplatesList)) .Callback&lt;string&gt;(viewName =&gt; requestedViewName = viewName); submitResultMock .Setup(sr =&gt; sr.Error) .Returns&lt;Exception&gt;(null); CompleteQuestionnaire(viewModel); viewModel.Submit(); //      UI . callback(submitResultMock.Object); //    ‚Äì     . Assert.AreEqual(ViewNames.QuestionnaireTemplatesList, requestedViewName);</code> <br> <b></b> <br>          ,        . <br>   <br>       , . "Trees in WPF"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ms753391.aspx">http://msdn.microsoft.com/en-us/library/ms753391.aspx</a> <br> <br>       , . "Attached Properties Overview"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/cc265152(VS.95).aspx">http://msdn.microsoft.com/en-us/library/cc265152(VS.95).aspx</a> <br> <br>      MEF, ."Managed Extensibility Framework Overview"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/dd460648.aspx">http://msdn.microsoft.com/en-us/library/dd460648.aspx</a> . <br> <br>      Unity, ."Unity Application Block"  MSDN: <a href="http://www.msdn.com/unity">http://www.msdn.com/unity</a> . <br> <br>      <code>DelegateCommand</code> , .Chapter 5, " <a href="http://msdn.microsoft.com/en-us/library/gg405484(v%3DPandP.40).aspx">Implementing the MVVM Pattern</a> ." <br> <br>        Microsoft Expression Blend, ."Working with built-in behaviors"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ff724013(v%3DExpression.40).aspx">http://msdn.microsoft.com/en-us/library/ff724013(v=Expression.40).aspx</a> . <br> <br>          Microsoft Expression Blend, ."Creating Custom Behaviors"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ff724708(v%3DExpression.40).aspx">http://msdn.microsoft.com/en-us/library/ff724708(v=Expression.40).aspx</a> . <br> <br>            Microsoft Expression Blend, ."Creating Custom Triggers and Actions"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ff724707(v%3DExpression.40).aspx">http://msdn.microsoft.com/en-us/library/ff724707(v=Expression.40).aspx</a> . <br> <br>         WPF  Silverlight, ."Threading Model"  "The Dispatcher Class"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ms741870.aspx">http://msdn.microsoft.com/en-us/library/ms741870.aspx</a> <br> <a href="http://msdn.microsoft.com/en-us/library/ms615907(v%3DVS.95).aspx">http://msdn.microsoft.com/en-us/library/ms615907(v=VS.95).aspx</a> . <br> <br>      unit-  Silverlight, ."Unit Testing with Silverlight 2": <a href="http://www.jeff.wilcox.name/2008/03/silverlight2-unit-testing/">http://www.jeff.wilcox.name/2008/03/silverlight2-unit-testing/</a> . <br> <br>         , .  " <a href="http://msdn.microsoft.com/en-us/library/gg430861(v%3DPandP.40).aspx">View-Based Navigation</a> " in Chapter 8, " <a href="http://msdn.microsoft.com/en-us/library/gg430861(v%3DPandP.40).aspx">Navigation</a> ." <br> <br>       ,   , ."Event-based Asynchronous Pattern Overview"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/wewwczdw.aspx">http://msdn.microsoft.com/en-us/library/wewwczdw.aspx</a> <br> <br>        <code>IAsyncResult</code> , ."Asynchronous Programming Overview"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ms228963.aspx">http://msdn.microsoft.com/en-us/library/ms228963.aspx</a></code></code></code></code></code></code></code></code></code> </blockquote> <code><code><code><code><code><code><code><code><code><code>CommandBehaviorBase ,    ,    ICommand</code> .           <code>CanExecuteChanged</code> ,          Silverlight,    WPF. <br> <br>    ,  ,   <code>CommandBehaviorBase    ,    .         ,      .         ,    .      ButtonBaseClickCommandBehavior</code> . <br> <br> <code class="cs">public class ButtonBaseClickCommandBehavior : CommandBehaviorBase&lt;ButtonBase&gt; { public ButtonBaseClickCommandBehavior(ButtonBase clickableObject) : base(clickableObject) { clickableObject.Click += OnClick; } private void OnClick(object sender, System.Windows.RoutedEventArgs e) { ExecuteCommand(); } }</code> <br>   <code>CommandBehaviorBase ,     .     ,          ,   . ,    ,    ,      , ,    CanExecute</code>  ,     . <br> <br>          ,   .           XAML.           .       .  Prism      ,       ,  ,   .       ,    . , ,  ,      <code>Click</code> ,       <code>Command</code> .    <code>Click.Command</code> ,  . <br> <br>             .             . <br> <br> <code class="cs">public static readonly DependencyProperty CommandProperty = DependencyProperty.RegisterAttached( "Command", typeof(ICommand), typeof(Click), new PropertyMetadata(OnSetCommandCallback)); private static readonly DependencyProperty ClickCommandBehaviorProperty = DependencyProperty.RegisterAttached( "ClickCommandBehavior", typeof(ButtonBaseClickCommandBehavior), typeof(Click), null);</code> <br>    <code>Command</code>    <code>ButtonBaseClickCommandBehavior</code> ,     <code>OnSetCommandCallback</code> ,     . <br> <br> <code class="cs">private static void OnSetCommandCallback(DependencyObject dependencyObject, DependencyPropertyChangedEventArgs e) { ButtonBase buttonBase = dependencyObject as ButtonBase; if (buttonBase != null) { ButtonBaseClickCommandBehavior behavior = GetOrCreateBehavior(buttonBase); behavior.Command = e.NewValue as ICommand; } } private static void OnSetCommandParameterCallback(DependencyObject dependencyObject, DependencyPropertyChangedEventArgs e) { ButtonBase buttonBase = dependencyObject as ButtonBase; if (buttonBase != null) { ButtonBaseClickCommandBehavior behavior = GetOrCreateBehavior(buttonBase); behavior.CommandParameter = e.NewValue; } } private static ButtonBaseClickCommandBehavior GetOrCreateBehavior(ButtonBase buttonBase ) { ButtonBaseClickCommandBehavior behavior = buttonBase.GetValue(ClickCommandBehaviorProperty) as ButtonBaseClickCommandBehavior; if ( behavior == null ) { behavior = new ButtonBaseClickCommandBehavior(buttonBase); buttonBase.SetValue(ClickCommandBehaviorProperty, behavior); } return behavior; }</code> <br>        ,  <a href="http://msdn.microsoft.com/en-us/library/cc265152(VS.95).aspx">Attached Properties Overview</a>  MSDN. <br> <br>    <br>              . ,     Silverlight,    -,     ,      ,     .     ,       . <br> <br>        ,    ( )  ,  ,     .  UI       ,            UI. <br> <br>      - <br>   -     ,       <code>IAsyncResult</code> .   ,  ,   ,  <code>GetQuestionnaire</code> ,   : <code>BeginGetQuestionnaire</code>  <code>EndGetQuestionnaire</code> .    ,   <code>BeginGetQuestionnaire</code> .     ,   ,   <code>EndGetQuestionnaire</code>    . <br> <b></b> <br>  .NET Framework 4.5      <code>await</code>  <code>async</code>     <code>*Async</code> .      <a href="http://msdn.microsoft.com/en-us/library/vstudio/hh391443.aspx">"Asynchronous Programming with Async and Await (C# and Visual Basic)"</a> . <br>  ,    <code>EndGetQuestionnaire</code> ,      ,  ()      <code>BeginGetQuestionnaire</code> .     ,      ,   <code>EndGetQuestionnaire</code> ,   . <br> <br> <code class="xml">IAsyncResult asyncResult = this.service.BeginGetQuestionnaire( GetQuestionnaireCompleted, null //  ,      ); private void GetQuestionnaireCompleted(IAsyncResult result) { try { questionnaire = this.service.EndGetQuestionnaire(ar); } catch (Exception ex) { //  -   . } }</code> <br>  ,     <code>End*</code> (  , <code>EndGetQuestionnaire</code> ),    ,      .      , ,          UI.     ,   ,        . <br> <br>        UI,     -,      UI,         UI,   <code>Dispatcher</code>    <code>SynchronizationContext</code> .  WPF  Silverlight,   <code>Dispatcher</code> . <br> <br>      <code>Questionnaire</code>  ,        <code>QuestionnaireView</code> .  Silverlight    <code>CheckAccess</code> ,  ,      UI.  ,     <code>BeginInvoke</code> ,      UI. <br> <br> <code class="cs">var dispatcher = System.Windows.Deployment.Current.Dispatcher; if (dispatcher.CheckAccess()) { QuestionnaireView.DataContext = questionnaire; } else { dispatcher.BeginInvoke(() =&gt; { Questionnaire.DataContext = questionnaire; }); }</code> <br> <i>MVVM RI</i>   ,    ,   <code>IAsyncResult</code> ,   .      ,                 . ,       . <br> <br> <code class="cs">this.questionnaireRepository.GetQuestionnaireAsync( result =&gt; { this.Questionnaire = result.Result; });</code> <br>  <code>result</code>   ,     , , , .    ,     . <br> <br> <code class="cs">this.questionnaireRepository.GetQuestionnaireAsync( result =&gt; { if (result.Error == null) { this.Questionnaire = result.Result; ... } else { // Handle error. } })</code> <br>     <br>        ,      .     , ,             .        ,      ,     ,     . <br> <br>         ,      MVVM,     ,   . ,  -MVVM ,     <code>MessageBox</code>   code-behind UI,      .   MVVM     ,          . <br> <br>     MVVM,              ,          .      ,    ,   ,  ,     . <br> <br>              MVVM.      ,     ,     ,  ,     .    ,         ,     ,          .       . <br> <br>    <br>                  .        ,        .  ,         .         . <br> <br>  ,         ,         ,  .      ,     .           ,       . ,        WPF  Silverlight,        . <br> <br> <img title="Using the service to interact with the user." src="https://habrastorage.org/getpro/habr/post_images/4b5/397/f2d/4b5397f2d02e5851195b29f1893be6fc.png" alt=" ,    ."> <br> <br>  ,   <code>MessageBox</code>        ,     ,    ,     . <br> <br> <code class="cs">var result = interactionService.ShowMessageBox( "Are you sure you want to cancel this operation?", "Confirm", MessageBoxButton.OK); if (result == MessageBoxResult.Yes) { CancelRequest(); }</code> <br> ,      - ,      ,         Silverlight.         .             .     . <br> <br> <code class="cs">interactionService.ShowMessageBox( "Are you sure you want to cancel this operation?", "Confirm", MessageBoxButton.OK, result =&gt; { if (result == MessageBoxResult.Yes) { CancelRequest(); } });</code> <br>         ,      . ,  WPF    <code>MessageBox</code> ,       ;    Silverlight    ,    . <br> <br>     <br>         ‚Äì             .         ,      .     ,     .        ,        ,   ,     . <br> <br> <img title="Using interaction request objects." src="https://habrastorage.org/getpro/habr/post_images/3d0/ff0/1c5/3d0ff01c5518558c2d3c5c5f47ce0ce9.png" alt="   ."> <br> <br>    ,   ,          ‚Äì       ,      ,   ‚Äì     .   ,        ,    ,    UI            . <br> <br>       MVVM,     ,       ,         .         ,        ,    ,   . <br> <br>  Prism       <code>IInteractionRequest</code>   <code>InteractionRequest .  IInteractionRequest</code>  ,   .           ,   .  <code>InteractionRequest   IInteractionRequest</code>     <code>Raise</code> ,           , , ,   . <br> <br>       <br>  <code>InteractionRequest          .  Raise</code>          ( <code>T</code> )    ,    ,   .          ,       .      ,        .    ,  ,     . <br> <code class="cs">public interface IInteractionRequest { event EventHandler&lt;InteractionRequestedEventArgs&gt; Raised; } public class InteractionRequest&lt;T&gt; : IInteractionRequest { public event EventHandler&lt;InteractionRequestedEventArgs&gt; Raised; public void Raise(T context, Action&lt;T&gt; callback) { var handler = this.Raised; if (handler != null) { handler( this, new InteractionRequestedEventArgs(context, () =&gt; callback(context))); } } }</code> <br> Prism    ,      .  <code>Notification</code>       .    ,            .     ‚Äì <code>Title</code>  <code>Content</code> ,    .  ,   ,  ,  ,        . <br> <br>  <code>Confirmation</code>    <code>Notification</code>     ‚Äì <code>Confirmed</code> ,  ,  ,      .  <code>Confirmation</code> ,     <code>MessageBox</code> ,     /  .     ,     <code>Notification</code> ,     ,      . <br> <br>    <code>InteractionRequest ,       InteractionRequest      ,      .      ,    Raise</code> ,    , ,   . <br> <br> <code class="cs">public IInteractionRequest ConfirmCancelInteractionRequest { get { return this.confirmCancelInteractionRequest; } } this.confirmCancelInteractionRequest.Raise( new Confirmation("Are you sure you wish to cancel?"), confirmation =&gt; { if (confirmation.Confirmed) { this.NavigateToQuestionnaireList(); } }); }</code> <br> <i>MVVM Reference Implementation (MVVM RI)</i> ,    <code>IInteractionRequest</code>   <code>InteractionRequest ,          (. QuestionnaireViewModel.cs</code> ). <br> <br>        <br>       ,       .   ,       .    UI             . <br> <br>                . Microsoft Expression Blend Behaviors Framework     .  ,     ,    . <br> <br>  <code>EventTrigger</code> ,  Expression Blend,  ,      ,     ,   . , Prism   <code>EventTrigger</code> ,  <code>InteractionRequestTrigger</code> ,      <code>Raised</code>   <code>IInteractionRequest</code> .    XAML        . <br> <br>  ,   , <code>InteractionRequestTrigger</code>   .  Silverlight Prism   <code>PopupChildWindowAction</code> ,     .    ,         .   <code>ContentTemplate</code>  <code>PopupChildWindowAction</code> ,    ,    UI,      <code>Content</code>  .       <code>Title</code>  . <br> <b></b> <br>  ,    ,   <code>PopupChildWindowAction</code> ,     .    <code>Notification</code>  <code>NotificationChildWindow</code> ,        <code>Confirmation</code> ‚Äì <code>ConfirmationChildWindow</code> . <code>NotificationChildWindow</code>    ,   ,     <code>ConfirmationChildWindow</code>    <i>OK</i>  <i>Cancel</i> ,    .    ,   ,   <code>ChildWindow</code>  <code>PopupChildWindowAction</code> . <br>   ,  <code>InteractionRequestTrigger</code>  <code>PopupChildWindowAction</code> ,       <i>RI MVVM</i> . <br> <br> <code class="xml">&lt;i:Interaction.Triggers&gt; &lt;prism:InteractionRequestTrigger SourceObject="{Binding ConfirmCancelInteractionRequest}"&gt; &lt;prism:PopupChildWindowAction ContentTemplate="{StaticResource ConfirmWindowTemplate}"/&gt; &lt;/prism:InteractionRequestTrigger&gt; &lt;/i:Interaction.Triggers&gt; &lt;UserControl.Resources&gt; &lt;DataTemplate x:Key="ConfirmWindowTemplate"&gt; &lt;Grid MinWidth="250" MinHeight="100"&gt; &lt;TextBlock TextWrapping="Wrap" Grid.Row="0" Text="{Binding}"/&gt; &lt;/Grid&gt; &lt;/DataTemplate&gt; &lt;/UserControl.Resources&gt;</code> <br> <b></b> <br>      <code>ContentTemplate</code> ,   UI   <code>Content</code>  .    <code>Content</code>  ,  , <code>TextBlock</code>     <code>Content</code> . <br>      ,     ,    ,    .  ,     ,       ,     ,    .   ,   <i>RI MVVM</i> ,         <code>Confirmed</code>    <code>Confirmation</code>  <code>true</code> ,     OK. <br> <br>        ,     .  Prism <code>InteractionRequestTrigger</code>   <code>PopupChildWindowAction</code>            . <br> <br>     <br>     MVVM,       , ,    ,         .        (  , ,  ,   ).    ,  ,  ,            . <br> <br>        ,         . Managed Extensibility Framework (MEF)  Unity Application Block (Unity)      ,  ,           . <br> <br>  ,       , , ,    ( )      . ,       ,     .  ,     ,       . <br> <br>     ,  MEF <br>  MEF,       ,   <code>Import</code> ,      ,  ,   <code>Export</code> .         ,    . <br> <br> , <code>QuestionnaireView</code>   <i>RI MVVM</i> ,        ,    <code>Import</code> .   , MEF           .  <code>set</code>        ,   . <br> <br> <code class="cs">[Import] public QuestionnaireViewModel ViewModel { set { this.DataContext = value; } }</code> <br>     ,   . <br> <br> <code class="cs">[Export] public class QuestionnaireViewModel : NotificationObject { ... }</code> <br>        ,   . <br> <br> <code class="cs">public QuestionnaireView() { InitializeComponent(); } [ImportingConstructor] public QuestionnaireView(QuestionnaireViewModel viewModel) : this() { this.DataContext = viewModel; }</code> <br> <b></b> <br>          MEF,   Unity.   ,     ,        .   ,   Visual Studio  Expression Blend, ,        ,     .   ,   ,  ,      ,          <code>InitializeComponent</code> . <br>     ,  Unity <br>  Unity,    ,   MEF.     ,      .    ,         .  ,      . <br> <br>  ,      ,  ,         . ,           ,   . <br> <br> <code class="cs">public QuestionnaireView() { InitializeComponent(); } public QuestionnaireView(QuestionnaireViewModel viewModel) : this() { this.DataContext = viewModel; }</code> <br> <b></b> <br>    ,        ,   Visual Studio  Expression Blend. <br>  ,          ,   . Unity        <code>set</code>   ,   . <br> <br> <code class="cs">public QuestionnaireView() { InitializeComponent(); } [Dependency] public QuestionnaireViewModel ViewModel { set { this.DataContext = value; } }</code> <br>       Unity. <br> <br> <code class="cs">container.RegisterType&lt;QuestionnaireViewModel&gt;();</code> <br>  ,     . <br> <br> <code class="cs">var view = container.Resolve&lt;QuestionnaireView&gt;();</code> <br>     ,    <br>   ,     ,        .        ,   MEF  Unity,        . <br> <br>          .   ,         UI,           . <br> <br> , <i>RI MVVM</i>   ,   ,        .   ,    .      <code>ShowView</code>   UI. <br> <br> <code class="cs">private void NavigateToQuestionnaireList() { //     "questionnaire list". this.uiService.ShowView(ViewNames.QuestionnaireTemplatesList); }</code> <br>  UI      UI .           UI.  <code>ShowView</code>  <code>UIService</code>      (,          ),       ,   . <br> <br> <code class="cs">public void ShowView(string viewName) { var view = this.ViewFactory.GetView(viewName); this.MainWindow.CurrentView = view; }</code> <br> <b></b> <br> Prism       .   ,   ,   ,             .    ,  , " <a href="http://msdn.microsoft.com/en-us/library/gg430861(v%3DPandP.40).aspx">View-Based Navigation</a> "   8, " <a href="http://msdn.microsoft.com/en-us/library/gg430861(v%3DPandP.40).aspx">Navigation</a> ". <br>  MVVM  <br>        MVVM      .           -      mocking . ,   ,        . <br> <br>   <i>INotifyPropertyChanged</i> <br>   <code>INotifyPropertyChanged</code>     ,      .      ,    ;   ,   ,     ,    ,       . <br> <br>   <br> ,       ,           <code>PropertyChanged</code>  ,         .  ,    <code>ChangeTracker</code> ,     MVVM,  ,      .      .     ,    . <br> <br> <code class="cs">var changeTracker = new PropertyChangeTracker(viewModel); viewModel.CurrentState = "newState"; CollectionAssert.Contains(changeTracker.ChangedProperties, "CurrentState");</code> <br> ,     ,     <code>INotifyPropertyChanged</code> ,    ,   ,     . <br> <br>      <br>        ,   ,    <code>set</code>      ,           . ,     ,     ,      ,          . <br> <br> <code class="cs">var changeTracker = new PropertyChangeTracker(viewModel); var question = viewModel.Questions.First() as OpenQuestionViewModel; question.Question.Response = "some text"; CollectionAssert.Contains(changeTracker.ChangedProperties, "UnansweredQuestions");</code> <br>      <br>     <code>INotifyPropertyChanged</code> ,      <code>PropertyChanged</code>        ,  ,     , , .        ,       . <br> <br>   <i>INotifyDataErrorInfo</i> <br>   ,     ,    ,   ,   <code>IDataErrorInfo</code> ,  ( Silverlight)   <code>INotifyDataErrorInfo</code> .   <code>INotifyDataErrorInfo</code>   ,         ,    ,  ,   ,    . <br> <br>       <code>INotifyDataErrorInfo</code> : ,     ,  ,     ,     <code>ErrorsChanged</code> ,      <code>GetErrors</code> , . <br> <br>    <br>     ,      ,     .       ,         <code>GetErrors</code>       ,  ,  ,   .    , ,  ,     ,        .   ,        . <br> <br> <code class="cs">//  . var notifyErrorInfo = (INotifyDataErrorInfo)question; question.Response = -15; Assert.IsTrue(notifyErrorInfo.GetErrors("Response").Cast&lt;ValidationResult&gt;().Any()); //  . var notifyErrorInfo = (INotifyDataErrorInfo)question; question.Response = 15; Assert.IsFalse(notifyErrorInfo.GetErrors("Response").Cast&lt;ValidationResult&gt;().Any());</code> <br>    ,    ,             . <br> <br>    <i>INotifyDataErrorInfo</i> <br>       <code>GetErrors</code> ,   <code>INotifyDataErrorInfo</code>  ,   <code>ErrorsChanged</code>      <code>GetErrors</code> . ,  <code>HasErrors</code>      ,  . <br> <br>       <code>INotifyDataErrorInfo</code> . , ,           ,   -  .      ,        <code>INotifyDataErrorInfo</code>         (,        ). <br> <br>     ,   ,  : <br>  <code>HasErrors</code>     .              ,       .  <code>ErrorsChanged</code> ,      ,         <code>GetErrors</code> .         ( ,  )     ,           .    <code>GetErrors</code>       <code>ErrorsChanged</code> . <br>    <code>INotifyPropertyChanged</code> ,  ,    <code>NotifyDataErrorInfoTestHelper</code>    MVVM,        <code>INotifyDataErrorInfo</code> ,       .   ,   ,      ,   .      . <br> <code class="cs">var helper = new NotifyDataErrorInfoTestHelper&lt;NumericQuestion, int?&gt;( question, q =&gt; q.Response); helper.ValidatePropertyChange( 6, NotifyDataErrorInfoBehavior.Nothing); helper.ValidatePropertyChange( 20, NotifyDataErrorInfoBehavior.FiresErrorsChanged | NotifyDataErrorInfoBehavior.HasErrors | NotifyDataErrorInfoBehavior.HasErrorsForProperty); helper.ValidatePropertyChange( null, NotifyDataErrorInfoBehavior.FiresErrorsChanged | NotifyDataErrorInfoBehavior.HasErrors | NotifyDataErrorInfoBehavior.HasErrorsForProperty); helper.ValidatePropertyChange( 2, NotifyDataErrorInfoBehavior.FiresErrorsChanged);</code> <br>     <br>   MVVM,     ,  .   ,    ,         . <br> <br>  ,     ,     ,       .   ,   , ,       ,     ,   <code>IAsyncResult</code>    ,  - ,   ,    UI. <br> <br>       , , ,    .   ,     .  ,      UI,     ,   ,          ,     ,        "   UI." <br> <br>     ,    ,    .   ,    ,     mock-, ,   ,   ,      ,          . <br> <br>           UI,    ,    .   ,     ,   ,      .        ,   .     ,    ,     . <br> <br> <code class="cs">questionnaireRepositoryMock .Setup( r =&gt; r.SubmitQuestionnaireAsync( It.IsAny&lt;Questionnaire&gt;(), It.IsAny&lt;Action&lt;IOperationResult&gt;&gt;())) .Callback&lt;Questionnaire, Action&lt;IOperationResult&gt;&gt;( (q, a) =&gt; callback = a); uiServicemock .Setup(svc =&gt; svc.ShowView(ViewNames.QuestionnaireTemplatesList)) .Callback&lt;string&gt;(viewName =&gt; requestedViewName = viewName); submitResultMock .Setup(sr =&gt; sr.Error) .Returns&lt;Exception&gt;(null); CompleteQuestionnaire(viewModel); viewModel.Submit(); //      UI . callback(submitResultMock.Object); //    ‚Äì     . Assert.AreEqual(ViewNames.QuestionnaireTemplatesList, requestedViewName);</code> <br> <b></b> <br>          ,        . <br>   <br>       , . "Trees in WPF"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ms753391.aspx">http://msdn.microsoft.com/en-us/library/ms753391.aspx</a> <br> <br>       , . "Attached Properties Overview"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/cc265152(VS.95).aspx">http://msdn.microsoft.com/en-us/library/cc265152(VS.95).aspx</a> <br> <br>      MEF, ."Managed Extensibility Framework Overview"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/dd460648.aspx">http://msdn.microsoft.com/en-us/library/dd460648.aspx</a> . <br> <br>      Unity, ."Unity Application Block"  MSDN: <a href="http://www.msdn.com/unity">http://www.msdn.com/unity</a> . <br> <br>      <code>DelegateCommand</code> , .Chapter 5, " <a href="http://msdn.microsoft.com/en-us/library/gg405484(v%3DPandP.40).aspx">Implementing the MVVM Pattern</a> ." <br> <br>        Microsoft Expression Blend, ."Working with built-in behaviors"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ff724013(v%3DExpression.40).aspx">http://msdn.microsoft.com/en-us/library/ff724013(v=Expression.40).aspx</a> . <br> <br>          Microsoft Expression Blend, ."Creating Custom Behaviors"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ff724708(v%3DExpression.40).aspx">http://msdn.microsoft.com/en-us/library/ff724708(v=Expression.40).aspx</a> . <br> <br>            Microsoft Expression Blend, ."Creating Custom Triggers and Actions"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ff724707(v%3DExpression.40).aspx">http://msdn.microsoft.com/en-us/library/ff724707(v=Expression.40).aspx</a> . <br> <br>         WPF  Silverlight, ."Threading Model"  "The Dispatcher Class"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ms741870.aspx">http://msdn.microsoft.com/en-us/library/ms741870.aspx</a> <br> <a href="http://msdn.microsoft.com/en-us/library/ms615907(v%3DVS.95).aspx">http://msdn.microsoft.com/en-us/library/ms615907(v=VS.95).aspx</a> . <br> <br>      unit-  Silverlight, ."Unit Testing with Silverlight 2": <a href="http://www.jeff.wilcox.name/2008/03/silverlight2-unit-testing/">http://www.jeff.wilcox.name/2008/03/silverlight2-unit-testing/</a> . <br> <br>         , .  " <a href="http://msdn.microsoft.com/en-us/library/gg430861(v%3DPandP.40).aspx">View-Based Navigation</a> " in Chapter 8, " <a href="http://msdn.microsoft.com/en-us/library/gg430861(v%3DPandP.40).aspx">Navigation</a> ." <br> <br>       ,   , ."Event-based Asynchronous Pattern Overview"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/wewwczdw.aspx">http://msdn.microsoft.com/en-us/library/wewwczdw.aspx</a> <br> <br>        <code>IAsyncResult</code> , ."Asynchronous Programming Overview"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ms228963.aspx">http://msdn.microsoft.com/en-us/library/ms228963.aspx</a></code></code></code></code></code></code></code></code></code> <h3> <code><code><code><code><code><code><code><code><code><code>CommandBehaviorBase ,    ,    ICommand</code> .           <code>CanExecuteChanged</code> ,          Silverlight,    WPF. <br> <br>    ,  ,   <code>CommandBehaviorBase    ,    .         ,      .         ,    .      ButtonBaseClickCommandBehavior</code> . <br> <br> <code class="cs">public class ButtonBaseClickCommandBehavior : CommandBehaviorBase&lt;ButtonBase&gt; { public ButtonBaseClickCommandBehavior(ButtonBase clickableObject) : base(clickableObject) { clickableObject.Click += OnClick; } private void OnClick(object sender, System.Windows.RoutedEventArgs e) { ExecuteCommand(); } }</code> <br>   <code>CommandBehaviorBase ,     .     ,          ,   . ,    ,    ,      , ,    CanExecute</code>  ,     . <br> <br>          ,   .           XAML.           .       .  Prism      ,       ,  ,   .       ,    . , ,  ,      <code>Click</code> ,       <code>Command</code> .    <code>Click.Command</code> ,  . <br> <br>             .             . <br> <br> <code class="cs">public static readonly DependencyProperty CommandProperty = DependencyProperty.RegisterAttached( "Command", typeof(ICommand), typeof(Click), new PropertyMetadata(OnSetCommandCallback)); private static readonly DependencyProperty ClickCommandBehaviorProperty = DependencyProperty.RegisterAttached( "ClickCommandBehavior", typeof(ButtonBaseClickCommandBehavior), typeof(Click), null);</code> <br>    <code>Command</code>    <code>ButtonBaseClickCommandBehavior</code> ,     <code>OnSetCommandCallback</code> ,     . <br> <br> <code class="cs">private static void OnSetCommandCallback(DependencyObject dependencyObject, DependencyPropertyChangedEventArgs e) { ButtonBase buttonBase = dependencyObject as ButtonBase; if (buttonBase != null) { ButtonBaseClickCommandBehavior behavior = GetOrCreateBehavior(buttonBase); behavior.Command = e.NewValue as ICommand; } } private static void OnSetCommandParameterCallback(DependencyObject dependencyObject, DependencyPropertyChangedEventArgs e) { ButtonBase buttonBase = dependencyObject as ButtonBase; if (buttonBase != null) { ButtonBaseClickCommandBehavior behavior = GetOrCreateBehavior(buttonBase); behavior.CommandParameter = e.NewValue; } } private static ButtonBaseClickCommandBehavior GetOrCreateBehavior(ButtonBase buttonBase ) { ButtonBaseClickCommandBehavior behavior = buttonBase.GetValue(ClickCommandBehaviorProperty) as ButtonBaseClickCommandBehavior; if ( behavior == null ) { behavior = new ButtonBaseClickCommandBehavior(buttonBase); buttonBase.SetValue(ClickCommandBehaviorProperty, behavior); } return behavior; }</code> <br>        ,  <a href="http://msdn.microsoft.com/en-us/library/cc265152(VS.95).aspx">Attached Properties Overview</a>  MSDN. <br> <br>    <br>              . ,     Silverlight,    -,     ,      ,     .     ,       . <br> <br>        ,    ( )  ,  ,     .  UI       ,            UI. <br> <br>      - <br>   -     ,       <code>IAsyncResult</code> .   ,  ,   ,  <code>GetQuestionnaire</code> ,   : <code>BeginGetQuestionnaire</code>  <code>EndGetQuestionnaire</code> .    ,   <code>BeginGetQuestionnaire</code> .     ,   ,   <code>EndGetQuestionnaire</code>    . <br> <b></b> <br>  .NET Framework 4.5      <code>await</code>  <code>async</code>     <code>*Async</code> .      <a href="http://msdn.microsoft.com/en-us/library/vstudio/hh391443.aspx">"Asynchronous Programming with Async and Await (C# and Visual Basic)"</a> . <br>  ,    <code>EndGetQuestionnaire</code> ,      ,  ()      <code>BeginGetQuestionnaire</code> .     ,      ,   <code>EndGetQuestionnaire</code> ,   . <br> <br> <code class="xml">IAsyncResult asyncResult = this.service.BeginGetQuestionnaire( GetQuestionnaireCompleted, null //  ,      ); private void GetQuestionnaireCompleted(IAsyncResult result) { try { questionnaire = this.service.EndGetQuestionnaire(ar); } catch (Exception ex) { //  -   . } }</code> <br>  ,     <code>End*</code> (  , <code>EndGetQuestionnaire</code> ),    ,      .      , ,          UI.     ,   ,        . <br> <br>        UI,     -,      UI,         UI,   <code>Dispatcher</code>    <code>SynchronizationContext</code> .  WPF  Silverlight,   <code>Dispatcher</code> . <br> <br>      <code>Questionnaire</code>  ,        <code>QuestionnaireView</code> .  Silverlight    <code>CheckAccess</code> ,  ,      UI.  ,     <code>BeginInvoke</code> ,      UI. <br> <br> <code class="cs">var dispatcher = System.Windows.Deployment.Current.Dispatcher; if (dispatcher.CheckAccess()) { QuestionnaireView.DataContext = questionnaire; } else { dispatcher.BeginInvoke(() =&gt; { Questionnaire.DataContext = questionnaire; }); }</code> <br> <i>MVVM RI</i>   ,    ,   <code>IAsyncResult</code> ,   .      ,                 . ,       . <br> <br> <code class="cs">this.questionnaireRepository.GetQuestionnaireAsync( result =&gt; { this.Questionnaire = result.Result; });</code> <br>  <code>result</code>   ,     , , , .    ,     . <br> <br> <code class="cs">this.questionnaireRepository.GetQuestionnaireAsync( result =&gt; { if (result.Error == null) { this.Questionnaire = result.Result; ... } else { // Handle error. } })</code> <br>     <br>        ,      .     , ,             .        ,      ,     ,     . <br> <br>         ,      MVVM,     ,   . ,  -MVVM ,     <code>MessageBox</code>   code-behind UI,      .   MVVM     ,          . <br> <br>     MVVM,              ,          .      ,    ,   ,  ,     . <br> <br>              MVVM.      ,     ,     ,  ,     .    ,         ,     ,          .       . <br> <br>    <br>                  .        ,        .  ,         .         . <br> <br>  ,         ,         ,  .      ,     .           ,       . ,        WPF  Silverlight,        . <br> <br> <img title="Using the service to interact with the user." src="https://habrastorage.org/getpro/habr/post_images/4b5/397/f2d/4b5397f2d02e5851195b29f1893be6fc.png" alt=" ,    ."> <br> <br>  ,   <code>MessageBox</code>        ,     ,    ,     . <br> <br> <code class="cs">var result = interactionService.ShowMessageBox( "Are you sure you want to cancel this operation?", "Confirm", MessageBoxButton.OK); if (result == MessageBoxResult.Yes) { CancelRequest(); }</code> <br> ,      - ,      ,         Silverlight.         .             .     . <br> <br> <code class="cs">interactionService.ShowMessageBox( "Are you sure you want to cancel this operation?", "Confirm", MessageBoxButton.OK, result =&gt; { if (result == MessageBoxResult.Yes) { CancelRequest(); } });</code> <br>         ,      . ,  WPF    <code>MessageBox</code> ,       ;    Silverlight    ,    . <br> <br>     <br>         ‚Äì             .         ,      .     ,     .        ,        ,   ,     . <br> <br> <img title="Using interaction request objects." src="https://habrastorage.org/getpro/habr/post_images/3d0/ff0/1c5/3d0ff01c5518558c2d3c5c5f47ce0ce9.png" alt="   ."> <br> <br>    ,   ,          ‚Äì       ,      ,   ‚Äì     .   ,        ,    ,    UI            . <br> <br>       MVVM,     ,       ,         .         ,        ,    ,   . <br> <br>  Prism       <code>IInteractionRequest</code>   <code>InteractionRequest .  IInteractionRequest</code>  ,   .           ,   .  <code>InteractionRequest   IInteractionRequest</code>     <code>Raise</code> ,           , , ,   . <br> <br>       <br>  <code>InteractionRequest          .  Raise</code>          ( <code>T</code> )    ,    ,   .          ,       .      ,        .    ,  ,     . <br> <code class="cs">public interface IInteractionRequest { event EventHandler&lt;InteractionRequestedEventArgs&gt; Raised; } public class InteractionRequest&lt;T&gt; : IInteractionRequest { public event EventHandler&lt;InteractionRequestedEventArgs&gt; Raised; public void Raise(T context, Action&lt;T&gt; callback) { var handler = this.Raised; if (handler != null) { handler( this, new InteractionRequestedEventArgs(context, () =&gt; callback(context))); } } }</code> <br> Prism    ,      .  <code>Notification</code>       .    ,            .     ‚Äì <code>Title</code>  <code>Content</code> ,    .  ,   ,  ,  ,        . <br> <br>  <code>Confirmation</code>    <code>Notification</code>     ‚Äì <code>Confirmed</code> ,  ,  ,      .  <code>Confirmation</code> ,     <code>MessageBox</code> ,     /  .     ,     <code>Notification</code> ,     ,      . <br> <br>    <code>InteractionRequest ,       InteractionRequest      ,      .      ,    Raise</code> ,    , ,   . <br> <br> <code class="cs">public IInteractionRequest ConfirmCancelInteractionRequest { get { return this.confirmCancelInteractionRequest; } } this.confirmCancelInteractionRequest.Raise( new Confirmation("Are you sure you wish to cancel?"), confirmation =&gt; { if (confirmation.Confirmed) { this.NavigateToQuestionnaireList(); } }); }</code> <br> <i>MVVM Reference Implementation (MVVM RI)</i> ,    <code>IInteractionRequest</code>   <code>InteractionRequest ,          (. QuestionnaireViewModel.cs</code> ). <br> <br>        <br>       ,       .   ,       .    UI             . <br> <br>                . Microsoft Expression Blend Behaviors Framework     .  ,     ,    . <br> <br>  <code>EventTrigger</code> ,  Expression Blend,  ,      ,     ,   . , Prism   <code>EventTrigger</code> ,  <code>InteractionRequestTrigger</code> ,      <code>Raised</code>   <code>IInteractionRequest</code> .    XAML        . <br> <br>  ,   , <code>InteractionRequestTrigger</code>   .  Silverlight Prism   <code>PopupChildWindowAction</code> ,     .    ,         .   <code>ContentTemplate</code>  <code>PopupChildWindowAction</code> ,    ,    UI,      <code>Content</code>  .       <code>Title</code>  . <br> <b></b> <br>  ,    ,   <code>PopupChildWindowAction</code> ,     .    <code>Notification</code>  <code>NotificationChildWindow</code> ,        <code>Confirmation</code> ‚Äì <code>ConfirmationChildWindow</code> . <code>NotificationChildWindow</code>    ,   ,     <code>ConfirmationChildWindow</code>    <i>OK</i>  <i>Cancel</i> ,    .    ,   ,   <code>ChildWindow</code>  <code>PopupChildWindowAction</code> . <br>   ,  <code>InteractionRequestTrigger</code>  <code>PopupChildWindowAction</code> ,       <i>RI MVVM</i> . <br> <br> <code class="xml">&lt;i:Interaction.Triggers&gt; &lt;prism:InteractionRequestTrigger SourceObject="{Binding ConfirmCancelInteractionRequest}"&gt; &lt;prism:PopupChildWindowAction ContentTemplate="{StaticResource ConfirmWindowTemplate}"/&gt; &lt;/prism:InteractionRequestTrigger&gt; &lt;/i:Interaction.Triggers&gt; &lt;UserControl.Resources&gt; &lt;DataTemplate x:Key="ConfirmWindowTemplate"&gt; &lt;Grid MinWidth="250" MinHeight="100"&gt; &lt;TextBlock TextWrapping="Wrap" Grid.Row="0" Text="{Binding}"/&gt; &lt;/Grid&gt; &lt;/DataTemplate&gt; &lt;/UserControl.Resources&gt;</code> <br> <b></b> <br>      <code>ContentTemplate</code> ,   UI   <code>Content</code>  .    <code>Content</code>  ,  , <code>TextBlock</code>     <code>Content</code> . <br>      ,     ,    ,    .  ,     ,       ,     ,    .   ,   <i>RI MVVM</i> ,         <code>Confirmed</code>    <code>Confirmation</code>  <code>true</code> ,     OK. <br> <br>        ,     .  Prism <code>InteractionRequestTrigger</code>   <code>PopupChildWindowAction</code>            . <br> <br>     <br>     MVVM,       , ,    ,         .        (  , ,  ,   ).    ,  ,  ,            . <br> <br>        ,         . Managed Extensibility Framework (MEF)  Unity Application Block (Unity)      ,  ,           . <br> <br>  ,       , , ,    ( )      . ,       ,     .  ,     ,       . <br> <br>     ,  MEF <br>  MEF,       ,   <code>Import</code> ,      ,  ,   <code>Export</code> .         ,    . <br> <br> , <code>QuestionnaireView</code>   <i>RI MVVM</i> ,        ,    <code>Import</code> .   , MEF           .  <code>set</code>        ,   . <br> <br> <code class="cs">[Import] public QuestionnaireViewModel ViewModel { set { this.DataContext = value; } }</code> <br>     ,   . <br> <br> <code class="cs">[Export] public class QuestionnaireViewModel : NotificationObject { ... }</code> <br>        ,   . <br> <br> <code class="cs">public QuestionnaireView() { InitializeComponent(); } [ImportingConstructor] public QuestionnaireView(QuestionnaireViewModel viewModel) : this() { this.DataContext = viewModel; }</code> <br> <b></b> <br>          MEF,   Unity.   ,     ,        .   ,   Visual Studio  Expression Blend, ,        ,     .   ,   ,  ,      ,          <code>InitializeComponent</code> . <br>     ,  Unity <br>  Unity,    ,   MEF.     ,      .    ,         .  ,      . <br> <br>  ,      ,  ,         . ,           ,   . <br> <br> <code class="cs">public QuestionnaireView() { InitializeComponent(); } public QuestionnaireView(QuestionnaireViewModel viewModel) : this() { this.DataContext = viewModel; }</code> <br> <b></b> <br>    ,        ,   Visual Studio  Expression Blend. <br>  ,          ,   . Unity        <code>set</code>   ,   . <br> <br> <code class="cs">public QuestionnaireView() { InitializeComponent(); } [Dependency] public QuestionnaireViewModel ViewModel { set { this.DataContext = value; } }</code> <br>       Unity. <br> <br> <code class="cs">container.RegisterType&lt;QuestionnaireViewModel&gt;();</code> <br>  ,     . <br> <br> <code class="cs">var view = container.Resolve&lt;QuestionnaireView&gt;();</code> <br>     ,    <br>   ,     ,        .        ,   MEF  Unity,        . <br> <br>          .   ,         UI,           . <br> <br> , <i>RI MVVM</i>   ,   ,        .   ,    .      <code>ShowView</code>   UI. <br> <br> <code class="cs">private void NavigateToQuestionnaireList() { //     "questionnaire list". this.uiService.ShowView(ViewNames.QuestionnaireTemplatesList); }</code> <br>  UI      UI .           UI.  <code>ShowView</code>  <code>UIService</code>      (,          ),       ,   . <br> <br> <code class="cs">public void ShowView(string viewName) { var view = this.ViewFactory.GetView(viewName); this.MainWindow.CurrentView = view; }</code> <br> <b></b> <br> Prism       .   ,   ,   ,             .    ,  , " <a href="http://msdn.microsoft.com/en-us/library/gg430861(v%3DPandP.40).aspx">View-Based Navigation</a> "   8, " <a href="http://msdn.microsoft.com/en-us/library/gg430861(v%3DPandP.40).aspx">Navigation</a> ". <br>  MVVM  <br>        MVVM      .           -      mocking . ,   ,        . <br> <br>   <i>INotifyPropertyChanged</i> <br>   <code>INotifyPropertyChanged</code>     ,      .      ,    ;   ,   ,     ,    ,       . <br> <br>   <br> ,       ,           <code>PropertyChanged</code>  ,         .  ,    <code>ChangeTracker</code> ,     MVVM,  ,      .      .     ,    . <br> <br> <code class="cs">var changeTracker = new PropertyChangeTracker(viewModel); viewModel.CurrentState = "newState"; CollectionAssert.Contains(changeTracker.ChangedProperties, "CurrentState");</code> <br> ,     ,     <code>INotifyPropertyChanged</code> ,    ,   ,     . <br> <br>      <br>        ,   ,    <code>set</code>      ,           . ,     ,     ,      ,          . <br> <br> <code class="cs">var changeTracker = new PropertyChangeTracker(viewModel); var question = viewModel.Questions.First() as OpenQuestionViewModel; question.Question.Response = "some text"; CollectionAssert.Contains(changeTracker.ChangedProperties, "UnansweredQuestions");</code> <br>      <br>     <code>INotifyPropertyChanged</code> ,      <code>PropertyChanged</code>        ,  ,     , , .        ,       . <br> <br>   <i>INotifyDataErrorInfo</i> <br>   ,     ,    ,   ,   <code>IDataErrorInfo</code> ,  ( Silverlight)   <code>INotifyDataErrorInfo</code> .   <code>INotifyDataErrorInfo</code>   ,         ,    ,  ,   ,    . <br> <br>       <code>INotifyDataErrorInfo</code> : ,     ,  ,     ,     <code>ErrorsChanged</code> ,      <code>GetErrors</code> , . <br> <br>    <br>     ,      ,     .       ,         <code>GetErrors</code>       ,  ,  ,   .    , ,  ,     ,        .   ,        . <br> <br> <code class="cs">//  . var notifyErrorInfo = (INotifyDataErrorInfo)question; question.Response = -15; Assert.IsTrue(notifyErrorInfo.GetErrors("Response").Cast&lt;ValidationResult&gt;().Any()); //  . var notifyErrorInfo = (INotifyDataErrorInfo)question; question.Response = 15; Assert.IsFalse(notifyErrorInfo.GetErrors("Response").Cast&lt;ValidationResult&gt;().Any());</code> <br>    ,    ,             . <br> <br>    <i>INotifyDataErrorInfo</i> <br>       <code>GetErrors</code> ,   <code>INotifyDataErrorInfo</code>  ,   <code>ErrorsChanged</code>      <code>GetErrors</code> . ,  <code>HasErrors</code>      ,  . <br> <br>       <code>INotifyDataErrorInfo</code> . , ,           ,   -  .      ,        <code>INotifyDataErrorInfo</code>         (,        ). <br> <br>     ,   ,  : <br>  <code>HasErrors</code>     .              ,       .  <code>ErrorsChanged</code> ,      ,         <code>GetErrors</code> .         ( ,  )     ,           .    <code>GetErrors</code>       <code>ErrorsChanged</code> . <br>    <code>INotifyPropertyChanged</code> ,  ,    <code>NotifyDataErrorInfoTestHelper</code>    MVVM,        <code>INotifyDataErrorInfo</code> ,       .   ,   ,      ,   .      . <br> <code class="cs">var helper = new NotifyDataErrorInfoTestHelper&lt;NumericQuestion, int?&gt;( question, q =&gt; q.Response); helper.ValidatePropertyChange( 6, NotifyDataErrorInfoBehavior.Nothing); helper.ValidatePropertyChange( 20, NotifyDataErrorInfoBehavior.FiresErrorsChanged | NotifyDataErrorInfoBehavior.HasErrors | NotifyDataErrorInfoBehavior.HasErrorsForProperty); helper.ValidatePropertyChange( null, NotifyDataErrorInfoBehavior.FiresErrorsChanged | NotifyDataErrorInfoBehavior.HasErrors | NotifyDataErrorInfoBehavior.HasErrorsForProperty); helper.ValidatePropertyChange( 2, NotifyDataErrorInfoBehavior.FiresErrorsChanged);</code> <br>     <br>   MVVM,     ,  .   ,    ,         . <br> <br>  ,     ,     ,       .   ,   , ,       ,     ,   <code>IAsyncResult</code>    ,  - ,   ,    UI. <br> <br>       , , ,    .   ,     .  ,      UI,     ,   ,          ,     ,        "   UI." <br> <br>     ,    ,    .   ,    ,     mock-, ,   ,   ,      ,          . <br> <br>           UI,    ,    .   ,     ,   ,      .        ,   .     ,    ,     . <br> <br> <code class="cs">questionnaireRepositoryMock .Setup( r =&gt; r.SubmitQuestionnaireAsync( It.IsAny&lt;Questionnaire&gt;(), It.IsAny&lt;Action&lt;IOperationResult&gt;&gt;())) .Callback&lt;Questionnaire, Action&lt;IOperationResult&gt;&gt;( (q, a) =&gt; callback = a); uiServicemock .Setup(svc =&gt; svc.ShowView(ViewNames.QuestionnaireTemplatesList)) .Callback&lt;string&gt;(viewName =&gt; requestedViewName = viewName); submitResultMock .Setup(sr =&gt; sr.Error) .Returns&lt;Exception&gt;(null); CompleteQuestionnaire(viewModel); viewModel.Submit(); //      UI . callback(submitResultMock.Object); //    ‚Äì     . Assert.AreEqual(ViewNames.QuestionnaireTemplatesList, requestedViewName);</code> <br> <b></b> <br>          ,        . <br>   <br>       , . "Trees in WPF"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ms753391.aspx">http://msdn.microsoft.com/en-us/library/ms753391.aspx</a> <br> <br>       , . "Attached Properties Overview"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/cc265152(VS.95).aspx">http://msdn.microsoft.com/en-us/library/cc265152(VS.95).aspx</a> <br> <br>      MEF, ."Managed Extensibility Framework Overview"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/dd460648.aspx">http://msdn.microsoft.com/en-us/library/dd460648.aspx</a> . <br> <br>      Unity, ."Unity Application Block"  MSDN: <a href="http://www.msdn.com/unity">http://www.msdn.com/unity</a> . <br> <br>      <code>DelegateCommand</code> , .Chapter 5, " <a href="http://msdn.microsoft.com/en-us/library/gg405484(v%3DPandP.40).aspx">Implementing the MVVM Pattern</a> ." <br> <br>        Microsoft Expression Blend, ."Working with built-in behaviors"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ff724013(v%3DExpression.40).aspx">http://msdn.microsoft.com/en-us/library/ff724013(v=Expression.40).aspx</a> . <br> <br>          Microsoft Expression Blend, ."Creating Custom Behaviors"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ff724708(v%3DExpression.40).aspx">http://msdn.microsoft.com/en-us/library/ff724708(v=Expression.40).aspx</a> . <br> <br>            Microsoft Expression Blend, ."Creating Custom Triggers and Actions"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ff724707(v%3DExpression.40).aspx">http://msdn.microsoft.com/en-us/library/ff724707(v=Expression.40).aspx</a> . <br> <br>         WPF  Silverlight, ."Threading Model"  "The Dispatcher Class"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ms741870.aspx">http://msdn.microsoft.com/en-us/library/ms741870.aspx</a> <br> <a href="http://msdn.microsoft.com/en-us/library/ms615907(v%3DVS.95).aspx">http://msdn.microsoft.com/en-us/library/ms615907(v=VS.95).aspx</a> . <br> <br>      unit-  Silverlight, ."Unit Testing with Silverlight 2": <a href="http://www.jeff.wilcox.name/2008/03/silverlight2-unit-testing/">http://www.jeff.wilcox.name/2008/03/silverlight2-unit-testing/</a> . <br> <br>         , .  " <a href="http://msdn.microsoft.com/en-us/library/gg430861(v%3DPandP.40).aspx">View-Based Navigation</a> " in Chapter 8, " <a href="http://msdn.microsoft.com/en-us/library/gg430861(v%3DPandP.40).aspx">Navigation</a> ." <br> <br>       ,   , ."Event-based Asynchronous Pattern Overview"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/wewwczdw.aspx">http://msdn.microsoft.com/en-us/library/wewwczdw.aspx</a> <br> <br>        <code>IAsyncResult</code> , ."Asynchronous Programming Overview"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ms228963.aspx">http://msdn.microsoft.com/en-us/library/ms228963.aspx</a></code></code></code></code></code></code></code></code></code> </h3> <code><code><code><code><code><code><code><code><code><code>CommandBehaviorBase ,    ,    ICommand</code> .           <code>CanExecuteChanged</code> ,          Silverlight,    WPF. <br> <br>    ,  ,   <code>CommandBehaviorBase    ,    .         ,      .         ,    .      ButtonBaseClickCommandBehavior</code> . <br> <br> <code class="cs">public class ButtonBaseClickCommandBehavior : CommandBehaviorBase&lt;ButtonBase&gt; { public ButtonBaseClickCommandBehavior(ButtonBase clickableObject) : base(clickableObject) { clickableObject.Click += OnClick; } private void OnClick(object sender, System.Windows.RoutedEventArgs e) { ExecuteCommand(); } }</code> <br>   <code>CommandBehaviorBase ,     .     ,          ,   . ,    ,    ,      , ,    CanExecute</code>  ,     . <br> <br>          ,   .           XAML.           .       .  Prism      ,       ,  ,   .       ,    . , ,  ,      <code>Click</code> ,       <code>Command</code> .    <code>Click.Command</code> ,  . <br> <br>             .             . <br> <br> <code class="cs">public static readonly DependencyProperty CommandProperty = DependencyProperty.RegisterAttached( "Command", typeof(ICommand), typeof(Click), new PropertyMetadata(OnSetCommandCallback)); private static readonly DependencyProperty ClickCommandBehaviorProperty = DependencyProperty.RegisterAttached( "ClickCommandBehavior", typeof(ButtonBaseClickCommandBehavior), typeof(Click), null);</code> <br>    <code>Command</code>    <code>ButtonBaseClickCommandBehavior</code> ,     <code>OnSetCommandCallback</code> ,     . <br> <br> <code class="cs">private static void OnSetCommandCallback(DependencyObject dependencyObject, DependencyPropertyChangedEventArgs e) { ButtonBase buttonBase = dependencyObject as ButtonBase; if (buttonBase != null) { ButtonBaseClickCommandBehavior behavior = GetOrCreateBehavior(buttonBase); behavior.Command = e.NewValue as ICommand; } } private static void OnSetCommandParameterCallback(DependencyObject dependencyObject, DependencyPropertyChangedEventArgs e) { ButtonBase buttonBase = dependencyObject as ButtonBase; if (buttonBase != null) { ButtonBaseClickCommandBehavior behavior = GetOrCreateBehavior(buttonBase); behavior.CommandParameter = e.NewValue; } } private static ButtonBaseClickCommandBehavior GetOrCreateBehavior(ButtonBase buttonBase ) { ButtonBaseClickCommandBehavior behavior = buttonBase.GetValue(ClickCommandBehaviorProperty) as ButtonBaseClickCommandBehavior; if ( behavior == null ) { behavior = new ButtonBaseClickCommandBehavior(buttonBase); buttonBase.SetValue(ClickCommandBehaviorProperty, behavior); } return behavior; }</code> <br>        ,  <a href="http://msdn.microsoft.com/en-us/library/cc265152(VS.95).aspx">Attached Properties Overview</a>  MSDN. <br> <br>    <br>              . ,     Silverlight,    -,     ,      ,     .     ,       . <br> <br>        ,    ( )  ,  ,     .  UI       ,            UI. <br> <br>      - <br>   -     ,       <code>IAsyncResult</code> .   ,  ,   ,  <code>GetQuestionnaire</code> ,   : <code>BeginGetQuestionnaire</code>  <code>EndGetQuestionnaire</code> .    ,   <code>BeginGetQuestionnaire</code> .     ,   ,   <code>EndGetQuestionnaire</code>    . <br> <b></b> <br>  .NET Framework 4.5      <code>await</code>  <code>async</code>     <code>*Async</code> .      <a href="http://msdn.microsoft.com/en-us/library/vstudio/hh391443.aspx">"Asynchronous Programming with Async and Await (C# and Visual Basic)"</a> . <br>  ,    <code>EndGetQuestionnaire</code> ,      ,  ()      <code>BeginGetQuestionnaire</code> .     ,      ,   <code>EndGetQuestionnaire</code> ,   . <br> <br> <code class="xml">IAsyncResult asyncResult = this.service.BeginGetQuestionnaire( GetQuestionnaireCompleted, null //  ,      ); private void GetQuestionnaireCompleted(IAsyncResult result) { try { questionnaire = this.service.EndGetQuestionnaire(ar); } catch (Exception ex) { //  -   . } }</code> <br>  ,     <code>End*</code> (  , <code>EndGetQuestionnaire</code> ),    ,      .      , ,          UI.     ,   ,        . <br> <br>        UI,     -,      UI,         UI,   <code>Dispatcher</code>    <code>SynchronizationContext</code> .  WPF  Silverlight,   <code>Dispatcher</code> . <br> <br>      <code>Questionnaire</code>  ,        <code>QuestionnaireView</code> .  Silverlight    <code>CheckAccess</code> ,  ,      UI.  ,     <code>BeginInvoke</code> ,      UI. <br> <br> <code class="cs">var dispatcher = System.Windows.Deployment.Current.Dispatcher; if (dispatcher.CheckAccess()) { QuestionnaireView.DataContext = questionnaire; } else { dispatcher.BeginInvoke(() =&gt; { Questionnaire.DataContext = questionnaire; }); }</code> <br> <i>MVVM RI</i>   ,    ,   <code>IAsyncResult</code> ,   .      ,                 . ,       . <br> <br> <code class="cs">this.questionnaireRepository.GetQuestionnaireAsync( result =&gt; { this.Questionnaire = result.Result; });</code> <br>  <code>result</code>   ,     , , , .    ,     . <br> <br> <code class="cs">this.questionnaireRepository.GetQuestionnaireAsync( result =&gt; { if (result.Error == null) { this.Questionnaire = result.Result; ... } else { // Handle error. } })</code> <br>     <br>        ,      .     , ,             .        ,      ,     ,     . <br> <br>         ,      MVVM,     ,   . ,  -MVVM ,     <code>MessageBox</code>   code-behind UI,      .   MVVM     ,          . <br> <br>     MVVM,              ,          .      ,    ,   ,  ,     . <br> <br>              MVVM.      ,     ,     ,  ,     .    ,         ,     ,          .       . <br> <br>    <br>                  .        ,        .  ,         .         . <br> <br>  ,         ,         ,  .      ,     .           ,       . ,        WPF  Silverlight,        . <br> <br> <img title="Using the service to interact with the user." src="https://habrastorage.org/getpro/habr/post_images/4b5/397/f2d/4b5397f2d02e5851195b29f1893be6fc.png" alt=" ,    ."> <br> <br>  ,   <code>MessageBox</code>        ,     ,    ,     . <br> <br> <code class="cs">var result = interactionService.ShowMessageBox( "Are you sure you want to cancel this operation?", "Confirm", MessageBoxButton.OK); if (result == MessageBoxResult.Yes) { CancelRequest(); }</code> <br> ,      - ,      ,         Silverlight.         .             .     . <br> <br> <code class="cs">interactionService.ShowMessageBox( "Are you sure you want to cancel this operation?", "Confirm", MessageBoxButton.OK, result =&gt; { if (result == MessageBoxResult.Yes) { CancelRequest(); } });</code> <br>         ,      . ,  WPF    <code>MessageBox</code> ,       ;    Silverlight    ,    . <br> <br>     <br>         ‚Äì             .         ,      .     ,     .        ,        ,   ,     . <br> <br> <img title="Using interaction request objects." src="https://habrastorage.org/getpro/habr/post_images/3d0/ff0/1c5/3d0ff01c5518558c2d3c5c5f47ce0ce9.png" alt="   ."> <br> <br>    ,   ,          ‚Äì       ,      ,   ‚Äì     .   ,        ,    ,    UI            . <br> <br>       MVVM,     ,       ,         .         ,        ,    ,   . <br> <br>  Prism       <code>IInteractionRequest</code>   <code>InteractionRequest .  IInteractionRequest</code>  ,   .           ,   .  <code>InteractionRequest   IInteractionRequest</code>     <code>Raise</code> ,           , , ,   . <br> <br>       <br>  <code>InteractionRequest          .  Raise</code>          ( <code>T</code> )    ,    ,   .          ,       .      ,        .    ,  ,     . <br> <code class="cs">public interface IInteractionRequest { event EventHandler&lt;InteractionRequestedEventArgs&gt; Raised; } public class InteractionRequest&lt;T&gt; : IInteractionRequest { public event EventHandler&lt;InteractionRequestedEventArgs&gt; Raised; public void Raise(T context, Action&lt;T&gt; callback) { var handler = this.Raised; if (handler != null) { handler( this, new InteractionRequestedEventArgs(context, () =&gt; callback(context))); } } }</code> <br> Prism    ,      .  <code>Notification</code>       .    ,            .     ‚Äì <code>Title</code>  <code>Content</code> ,    .  ,   ,  ,  ,        . <br> <br>  <code>Confirmation</code>    <code>Notification</code>     ‚Äì <code>Confirmed</code> ,  ,  ,      .  <code>Confirmation</code> ,     <code>MessageBox</code> ,     /  .     ,     <code>Notification</code> ,     ,      . <br> <br>    <code>InteractionRequest ,       InteractionRequest      ,      .      ,    Raise</code> ,    , ,   . <br> <br> <code class="cs">public IInteractionRequest ConfirmCancelInteractionRequest { get { return this.confirmCancelInteractionRequest; } } this.confirmCancelInteractionRequest.Raise( new Confirmation("Are you sure you wish to cancel?"), confirmation =&gt; { if (confirmation.Confirmed) { this.NavigateToQuestionnaireList(); } }); }</code> <br> <i>MVVM Reference Implementation (MVVM RI)</i> ,    <code>IInteractionRequest</code>   <code>InteractionRequest ,          (. QuestionnaireViewModel.cs</code> ). <br> <br>        <br>       ,       .   ,       .    UI             . <br> <br>                . Microsoft Expression Blend Behaviors Framework     .  ,     ,    . <br> <br>  <code>EventTrigger</code> ,  Expression Blend,  ,      ,     ,   . , Prism   <code>EventTrigger</code> ,  <code>InteractionRequestTrigger</code> ,      <code>Raised</code>   <code>IInteractionRequest</code> .    XAML        . <br> <br>  ,   , <code>InteractionRequestTrigger</code>   .  Silverlight Prism   <code>PopupChildWindowAction</code> ,     .    ,         .   <code>ContentTemplate</code>  <code>PopupChildWindowAction</code> ,    ,    UI,      <code>Content</code>  .       <code>Title</code>  . <br> <b></b> <br>  ,    ,   <code>PopupChildWindowAction</code> ,     .    <code>Notification</code>  <code>NotificationChildWindow</code> ,        <code>Confirmation</code> ‚Äì <code>ConfirmationChildWindow</code> . <code>NotificationChildWindow</code>    ,   ,     <code>ConfirmationChildWindow</code>    <i>OK</i>  <i>Cancel</i> ,    .    ,   ,   <code>ChildWindow</code>  <code>PopupChildWindowAction</code> . <br>   ,  <code>InteractionRequestTrigger</code>  <code>PopupChildWindowAction</code> ,       <i>RI MVVM</i> . <br> <br> <code class="xml">&lt;i:Interaction.Triggers&gt; &lt;prism:InteractionRequestTrigger SourceObject="{Binding ConfirmCancelInteractionRequest}"&gt; &lt;prism:PopupChildWindowAction ContentTemplate="{StaticResource ConfirmWindowTemplate}"/&gt; &lt;/prism:InteractionRequestTrigger&gt; &lt;/i:Interaction.Triggers&gt; &lt;UserControl.Resources&gt; &lt;DataTemplate x:Key="ConfirmWindowTemplate"&gt; &lt;Grid MinWidth="250" MinHeight="100"&gt; &lt;TextBlock TextWrapping="Wrap" Grid.Row="0" Text="{Binding}"/&gt; &lt;/Grid&gt; &lt;/DataTemplate&gt; &lt;/UserControl.Resources&gt;</code> <br> <b></b> <br>      <code>ContentTemplate</code> ,   UI   <code>Content</code>  .    <code>Content</code>  ,  , <code>TextBlock</code>     <code>Content</code> . <br>      ,     ,    ,    .  ,     ,       ,     ,    .   ,   <i>RI MVVM</i> ,         <code>Confirmed</code>    <code>Confirmation</code>  <code>true</code> ,     OK. <br> <br>        ,     .  Prism <code>InteractionRequestTrigger</code>   <code>PopupChildWindowAction</code>            . <br> <br>     <br>     MVVM,       , ,    ,         .        (  , ,  ,   ).    ,  ,  ,            . <br> <br>        ,         . Managed Extensibility Framework (MEF)  Unity Application Block (Unity)      ,  ,           . <br> <br>  ,       , , ,    ( )      . ,       ,     .  ,     ,       . <br> <br>     ,  MEF <br>  MEF,       ,   <code>Import</code> ,      ,  ,   <code>Export</code> .         ,    . <br> <br> , <code>QuestionnaireView</code>   <i>RI MVVM</i> ,        ,    <code>Import</code> .   , MEF           .  <code>set</code>        ,   . <br> <br> <code class="cs">[Import] public QuestionnaireViewModel ViewModel { set { this.DataContext = value; } }</code> <br>     ,   . <br> <br> <code class="cs">[Export] public class QuestionnaireViewModel : NotificationObject { ... }</code> <br>        ,   . <br> <br> <code class="cs">public QuestionnaireView() { InitializeComponent(); } [ImportingConstructor] public QuestionnaireView(QuestionnaireViewModel viewModel) : this() { this.DataContext = viewModel; }</code> <br> <b></b> <br>          MEF,   Unity.   ,     ,        .   ,   Visual Studio  Expression Blend, ,        ,     .   ,   ,  ,      ,          <code>InitializeComponent</code> . <br>     ,  Unity <br>  Unity,    ,   MEF.     ,      .    ,         .  ,      . <br> <br>  ,      ,  ,         . ,           ,   . <br> <br> <code class="cs">public QuestionnaireView() { InitializeComponent(); } public QuestionnaireView(QuestionnaireViewModel viewModel) : this() { this.DataContext = viewModel; }</code> <br> <b></b> <br>    ,        ,   Visual Studio  Expression Blend. <br>  ,          ,   . Unity        <code>set</code>   ,   . <br> <br> <code class="cs">public QuestionnaireView() { InitializeComponent(); } [Dependency] public QuestionnaireViewModel ViewModel { set { this.DataContext = value; } }</code> <br>       Unity. <br> <br> <code class="cs">container.RegisterType&lt;QuestionnaireViewModel&gt;();</code> <br>  ,     . <br> <br> <code class="cs">var view = container.Resolve&lt;QuestionnaireView&gt;();</code> <br>     ,    <br>   ,     ,        .        ,   MEF  Unity,        . <br> <br>          .   ,         UI,           . <br> <br> , <i>RI MVVM</i>   ,   ,        .   ,    .      <code>ShowView</code>   UI. <br> <br> <code class="cs">private void NavigateToQuestionnaireList() { //     "questionnaire list". this.uiService.ShowView(ViewNames.QuestionnaireTemplatesList); }</code> <br>  UI      UI .           UI.  <code>ShowView</code>  <code>UIService</code>      (,          ),       ,   . <br> <br> <code class="cs">public void ShowView(string viewName) { var view = this.ViewFactory.GetView(viewName); this.MainWindow.CurrentView = view; }</code> <br> <b></b> <br> Prism       .   ,   ,   ,             .    ,  , " <a href="http://msdn.microsoft.com/en-us/library/gg430861(v%3DPandP.40).aspx">View-Based Navigation</a> "   8, " <a href="http://msdn.microsoft.com/en-us/library/gg430861(v%3DPandP.40).aspx">Navigation</a> ". <br>  MVVM  <br>        MVVM      .           -      mocking . ,   ,        . <br> <br>   <i>INotifyPropertyChanged</i> <br>   <code>INotifyPropertyChanged</code>     ,      .      ,    ;   ,   ,     ,    ,       . <br> <br>   <br> ,       ,           <code>PropertyChanged</code>  ,         .  ,    <code>ChangeTracker</code> ,     MVVM,  ,      .      .     ,    . <br> <br> <code class="cs">var changeTracker = new PropertyChangeTracker(viewModel); viewModel.CurrentState = "newState"; CollectionAssert.Contains(changeTracker.ChangedProperties, "CurrentState");</code> <br> ,     ,     <code>INotifyPropertyChanged</code> ,    ,   ,     . <br> <br>      <br>        ,   ,    <code>set</code>      ,           . ,     ,     ,      ,          . <br> <br> <code class="cs">var changeTracker = new PropertyChangeTracker(viewModel); var question = viewModel.Questions.First() as OpenQuestionViewModel; question.Question.Response = "some text"; CollectionAssert.Contains(changeTracker.ChangedProperties, "UnansweredQuestions");</code> <br>      <br>     <code>INotifyPropertyChanged</code> ,      <code>PropertyChanged</code>        ,  ,     , , .        ,       . <br> <br>   <i>INotifyDataErrorInfo</i> <br>   ,     ,    ,   ,   <code>IDataErrorInfo</code> ,  ( Silverlight)   <code>INotifyDataErrorInfo</code> .   <code>INotifyDataErrorInfo</code>   ,         ,    ,  ,   ,    . <br> <br>       <code>INotifyDataErrorInfo</code> : ,     ,  ,     ,     <code>ErrorsChanged</code> ,      <code>GetErrors</code> , . <br> <br>    <br>     ,      ,     .       ,         <code>GetErrors</code>       ,  ,  ,   .    , ,  ,     ,        .   ,        . <br> <br> <code class="cs">//  . var notifyErrorInfo = (INotifyDataErrorInfo)question; question.Response = -15; Assert.IsTrue(notifyErrorInfo.GetErrors("Response").Cast&lt;ValidationResult&gt;().Any()); //  . var notifyErrorInfo = (INotifyDataErrorInfo)question; question.Response = 15; Assert.IsFalse(notifyErrorInfo.GetErrors("Response").Cast&lt;ValidationResult&gt;().Any());</code> <br>    ,    ,             . <br> <br>    <i>INotifyDataErrorInfo</i> <br>       <code>GetErrors</code> ,   <code>INotifyDataErrorInfo</code>  ,   <code>ErrorsChanged</code>      <code>GetErrors</code> . ,  <code>HasErrors</code>      ,  . <br> <br>       <code>INotifyDataErrorInfo</code> . , ,           ,   -  .      ,        <code>INotifyDataErrorInfo</code>         (,        ). <br> <br>     ,   ,  : <br>  <code>HasErrors</code>     .              ,       .  <code>ErrorsChanged</code> ,      ,         <code>GetErrors</code> .         ( ,  )     ,           .    <code>GetErrors</code>       <code>ErrorsChanged</code> . <br>    <code>INotifyPropertyChanged</code> ,  ,    <code>NotifyDataErrorInfoTestHelper</code>    MVVM,        <code>INotifyDataErrorInfo</code> ,       .   ,   ,      ,   .      . <br> <code class="cs">var helper = new NotifyDataErrorInfoTestHelper&lt;NumericQuestion, int?&gt;( question, q =&gt; q.Response); helper.ValidatePropertyChange( 6, NotifyDataErrorInfoBehavior.Nothing); helper.ValidatePropertyChange( 20, NotifyDataErrorInfoBehavior.FiresErrorsChanged | NotifyDataErrorInfoBehavior.HasErrors | NotifyDataErrorInfoBehavior.HasErrorsForProperty); helper.ValidatePropertyChange( null, NotifyDataErrorInfoBehavior.FiresErrorsChanged | NotifyDataErrorInfoBehavior.HasErrors | NotifyDataErrorInfoBehavior.HasErrorsForProperty); helper.ValidatePropertyChange( 2, NotifyDataErrorInfoBehavior.FiresErrorsChanged);</code> <br>     <br>   MVVM,     ,  .   ,    ,         . <br> <br>  ,     ,     ,       .   ,   , ,       ,     ,   <code>IAsyncResult</code>    ,  - ,   ,    UI. <br> <br>       , , ,    .   ,     .  ,      UI,     ,   ,          ,     ,        "   UI." <br> <br>     ,    ,    .   ,    ,     mock-, ,   ,   ,      ,          . <br> <br>           UI,    ,    .   ,     ,   ,      .        ,   .     ,    ,     . <br> <br> <code class="cs">questionnaireRepositoryMock .Setup( r =&gt; r.SubmitQuestionnaireAsync( It.IsAny&lt;Questionnaire&gt;(), It.IsAny&lt;Action&lt;IOperationResult&gt;&gt;())) .Callback&lt;Questionnaire, Action&lt;IOperationResult&gt;&gt;( (q, a) =&gt; callback = a); uiServicemock .Setup(svc =&gt; svc.ShowView(ViewNames.QuestionnaireTemplatesList)) .Callback&lt;string&gt;(viewName =&gt; requestedViewName = viewName); submitResultMock .Setup(sr =&gt; sr.Error) .Returns&lt;Exception&gt;(null); CompleteQuestionnaire(viewModel); viewModel.Submit(); //      UI . callback(submitResultMock.Object); //    ‚Äì     . Assert.AreEqual(ViewNames.QuestionnaireTemplatesList, requestedViewName);</code> <br> <b></b> <br>          ,        . <br>   <br>       , . "Trees in WPF"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ms753391.aspx">http://msdn.microsoft.com/en-us/library/ms753391.aspx</a> <br> <br>       , . "Attached Properties Overview"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/cc265152(VS.95).aspx">http://msdn.microsoft.com/en-us/library/cc265152(VS.95).aspx</a> <br> <br>      MEF, ."Managed Extensibility Framework Overview"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/dd460648.aspx">http://msdn.microsoft.com/en-us/library/dd460648.aspx</a> . <br> <br>      Unity, ."Unity Application Block"  MSDN: <a href="http://www.msdn.com/unity">http://www.msdn.com/unity</a> . <br> <br>      <code>DelegateCommand</code> , .Chapter 5, " <a href="http://msdn.microsoft.com/en-us/library/gg405484(v%3DPandP.40).aspx">Implementing the MVVM Pattern</a> ." <br> <br>        Microsoft Expression Blend, ."Working with built-in behaviors"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ff724013(v%3DExpression.40).aspx">http://msdn.microsoft.com/en-us/library/ff724013(v=Expression.40).aspx</a> . <br> <br>          Microsoft Expression Blend, ."Creating Custom Behaviors"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ff724708(v%3DExpression.40).aspx">http://msdn.microsoft.com/en-us/library/ff724708(v=Expression.40).aspx</a> . <br> <br>            Microsoft Expression Blend, ."Creating Custom Triggers and Actions"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ff724707(v%3DExpression.40).aspx">http://msdn.microsoft.com/en-us/library/ff724707(v=Expression.40).aspx</a> . <br> <br>         WPF  Silverlight, ."Threading Model"  "The Dispatcher Class"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ms741870.aspx">http://msdn.microsoft.com/en-us/library/ms741870.aspx</a> <br> <a href="http://msdn.microsoft.com/en-us/library/ms615907(v%3DVS.95).aspx">http://msdn.microsoft.com/en-us/library/ms615907(v=VS.95).aspx</a> . <br> <br>      unit-  Silverlight, ."Unit Testing with Silverlight 2": <a href="http://www.jeff.wilcox.name/2008/03/silverlight2-unit-testing/">http://www.jeff.wilcox.name/2008/03/silverlight2-unit-testing/</a> . <br> <br>         , .  " <a href="http://msdn.microsoft.com/en-us/library/gg430861(v%3DPandP.40).aspx">View-Based Navigation</a> " in Chapter 8, " <a href="http://msdn.microsoft.com/en-us/library/gg430861(v%3DPandP.40).aspx">Navigation</a> ." <br> <br>       ,   , ."Event-based Asynchronous Pattern Overview"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/wewwczdw.aspx">http://msdn.microsoft.com/en-us/library/wewwczdw.aspx</a> <br> <br>        <code>IAsyncResult</code> , ."Asynchronous Programming Overview"  MSDN: <a href="http://msdn.microsoft.com/en-us/library/ms228963.aspx">http://msdn.microsoft.com/en-us/library/ms228963.aspx</a></code></code></code></code></code></code></code></code></code> </div><p>Source: <a href="https://habr.com/ru/post/176869/">https://habr.com/ru/post/176869/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../176857/index.html">Stanford invented a fully passive air conditioner</a></li>
<li><a href="../176859/index.html">Chronicles of LinguaLeo: how we did ‚ÄúDialogues in English‚Äù with Node.js and DynamoDB</a></li>
<li><a href="../176861/index.html">Prism Developer Guide - Part 3, managing dependencies between components</a></li>
<li><a href="../176863/index.html">Prism Developer Guide - Part 4, Modular Application Development</a></li>
<li><a href="../176867/index.html">Prism Developer Guide - Part 5, MVVM Pattern Implementation</a></li>
<li><a href="../176877/index.html">How we did the Rubens Pipe</a></li>
<li><a href="../176879/index.html">ePayService at RIF + CIB 2013</a></li>
<li><a href="../176881/index.html">Mitap-group ‚ÄúMoscow Cassandra Users‚Äù starts</a></li>
<li><a href="../176883/index.html">Metric # 4 - Podcast on technologies and design of interfaces and services</a></li>
<li><a href="../176885/index.html">Electronic universe (a look at computer science from the 80s)</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>