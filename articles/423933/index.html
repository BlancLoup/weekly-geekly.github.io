<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Microsoft Office Security: Embedded Objects</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Initially, Microsoft Office architecture was based on the concept of composite documents, they are also OLE documents , actively promoted by Microsoft...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Microsoft Office Security: Embedded Objects</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/webt/os/-z/yx/os-zyx2ayrnxagtecn42u4spxke.jpeg"><br><br>  Initially, Microsoft Office architecture was based on the concept of composite documents, they are also <b>OLE documents</b> , actively promoted by Microsoft at the dawn of 32-bit Windows.  In those days, the idea of ‚Äã‚Äã‚Äúseamless‚Äù merging in one document of data of various formats seemed attractive and fascinating, and before identifying the first problems, had time to firmly grow into many large-scale products. <br><br>  The ‚Äúbad news‚Äù was that the universal way of adding data (and the processing code of this data) to documents became a universal way of introducing vulnerabilities in the product, which even today constantly surprises <s>the malware creators of</s> security researchers. <a name="habracut"></a>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Subsequently, the applications of the package received a fairly rich set of tools for adding images, charts and diagrams to documents, controls that are created and processed by the application itself and are part of it.  From a security point of view, these elements are somewhat less interesting than the elements that (mostly) are discussed in the article - elements that use external application code added to documents using OLE. <br><br>  The ‚Äúdisk‚Äù representation of the <a href="https://habr.com/company/dsec/blog/349450/">master</a> document is a <a href="https://habr.com/company/dsec/blog/349450/">CFBF file</a> .  This article will look at embedding objects in Microsoft Office documents (or rather, only the security aspect) in the context of the <b>data and code loaded into memory</b> at runtime. <br><br>  Formally embedded objects in Microsoft Office documents can be divided into the following groups: <br><br><ul><li>  ActiveX Controls </li><li>  <b>OLE Embedded Objects</b> ( <b>OLE Embedded Objects</b> ) </li><li>  Injected files ( <b>Packages</b> ) </li><li>  <b>Non-ole</b> embedded elements </li></ul><br><h3>  ActiveX controls </h3><br>  ActiveX controls can be thought of as elements of the program window ‚Äî say, buttons, switches, lists, input fields, and other forms ‚Äî designed to produce some events or respond to events.  Once a good idea seemed to create such controls universal, with the possibility of use in any application, and put them for this purpose in the <b>components of COM</b> . <br><br>  The embedded ActiveX web pages represented a well-known security hole in Internet Explorer, and security measures increased over time.  Browsers from other manufacturers almost immediately abandoned support for ActiveX.  New browser Microsoft Edge finally broke up with this relic of the past.  Embedding in Office documents, however, is still possible. <br><br>  ActiveX documents are intended to be used in conjunction with <a href="https://habr.com/company/dsec/blog/353800/"><b>Visual Basic for Applications</b></a> .  However, VBA is not required to load and activate them, and user permission is not required to load <b>items from the white list</b> . <br><br>  Vulnerabilities in the latter are especially dangerous - the default settings that are set when the application is installed do not imply any protection against downloading these elements or a warning to the user.  The administrator must forcibly tighten the settings by prohibiting the download of any ActiveX controls (note, however, that in the safe viewing mode, ActiveX is not loaded). <br><blockquote>  Example: CVE-2012-0158 <br><br>  One of the most dangerous vulnerabilities in Office documents in 2012 was <a href="https://www.sophos.com/en-us/medialibrary/PDFs/technical%2520papers/CVE-2012-0158-An-Anatomy-of-a-Prolific-Exploit.PDF">CVE-2012-0158</a> .  The download code for the Microsoft ListView Control 6.0 item from the MSCOMCTL.OCX library contained the possibility of a buffer overflow, which made it possible to replace the return address and execute arbitrary code.  Since the item was in the ActiveX whitelist, the download started immediately when the document was opened.  The vulnerability has now been fixed; the ListView Control element is still considered ‚Äúsecure‚Äù. </blockquote><h4>  Adding ActiveX to a document </h4><br>  To add a control item to a Microsoft Office document (take Word for simplicity) using the user interface, open the Developer tab (its visibility is configured in the Word Options menu) and select Controls -&gt; Tools from previous versions -&gt; ActiveX controls.  The menu will show a set of icons corresponding to Microsoft Forms elements, as well as the ability to select ActiveX from a list made up of elements available in the system, selected by a number of criteria. <br><br><img src="https://habrastorage.org/webt/nn/wt/jt/nnwtjte9nabt8rriqxotr4f7is4.jpeg"><br><br>  The displayed list does not correspond to the set of elements that can actually be loaded into the document, so it cannot be guided by it when searching for vulnerable elements.  Complicated multi-level verification of downloadable ActiveX has several stages, it differs for Office versions and changes from update to update, so the most accurate way to check the download ability is to ‚Äúmanually‚Äù compose the document file with the element of interest and try to open it in Office.  Possible document formats are described below. <br><br><h4>  Software presentation </h4><br>  Each ActiveX control is essentially an object of one of the COM classes that meets certain requirements.  The element is loaded using the COM subsystem, and the executable code is contained in one of the modules, as a rule, ‚Äúexternal‚Äù to the container application.  Like any COM object, an ActiveX control can be implemented as a DLL, or as an executable EXE file.  In the first case, the library will be loaded into the address space of the container, in the second, the element will be processed in a separate process, with data transfer between the container and the object via COM marshaling. <br><br>  Like any COM object, ActiveX has <b>Interfaces</b> , <b>Properties,</b> and <b>Methods</b> . <br><br>  Interfaces are primarily a set of standard interfaces that must have an ActiveX class for full loading and interacting with a container, in particular, IOleControl and IOleObject. <br><br>  The absence of any necessary interfaces can reduce the functionality of the element or interrupt its loading at some stage. <br><blockquote>  Example: CVE-2015-2424 <br>  The vulnerability <a href="https://www.trustwave.com/Resources/SpiderLabs-Blog/Tsar-Team-Microsoft-Office-Zero-Day-CVE-2015-2424/">CVE-2015-2424</a> was related to the TaskSymbol Class element from the mmcndmgr.dll library.  The item was not intended for use in documents, and did not export the IDispatch interface.  During the element loading process, the procedure that requested this interface received an error and destroyed the internal structure of the element, which led to a use-after-free vulnerability.  At the moment, the item is forbidden to download (despite this, it can still be found in the list to be added to the Developer menu).  The vulnerability itself is not fixed. <br></blockquote>  In addition to the standard, each ActiveX class exports the ‚Äúmain‚Äù interface, representing its own unique functionality.  For example, for the Forms.CommandButton.1 class, this is ICommandButton. <br><br>  You can view the ActiveX interfaces using the <b>OleView</b> tool included in the Microsoft Visual Studio package. <br><br><img src="https://habrastorage.org/webt/um/cc/zm/umcczmybv5voo3c6bbde66zxdmq.png"><br><br>  The element interface defines its <b>Methods</b> and <b>Properties</b> .  Properties represent some data that determines the appearance and operation of an element.  The developer of the ActiveX element assigns each property a specific name, say BackColor or GridLineWidth, and a type, for example, a string, an integer, or a real double precision.  For bitmap images and icons, there is a type of property like a picture.  The client program can set individual properties of the control, setting their integer indices and values. <br><br>  From the point of view of a low-level implementation, the division into methods and properties is formal, since ‚Äúproperties‚Äù are represented by a set of get / set methods.  However, there is a significant difference: The methods of the element (its main interface) can only be called programmatically, in the case of Office documents, only from a running VBA program.  From a security point of view, this is not of great interest, since the execution of VBA is already a compromise of the operating system.  <b>Properties</b> are stored in the document and when opened, they will be <b>processed and loaded</b> into structures in memory <b>even if VBA execution is prohibited</b> . <br><br>  From a programmatic point of view, from the side of the element, to save its properties and state in the document, the container provides the interfaces <b>IStream</b> , <b>IStorage</b> and <b>IPropertyBag</b> .  Their implementation and presentation of data in a disk file is no longer a concern of the ActiveX control, and depends entirely on the container and the document format.  It should be noted that the set and format of the stored data may correspond to the ‚Äúpublicly‚Äù exported property set, or it may be completely different.  Consider implementation examples related to Microsoft Office. <br><br><h4>  Compound file (CFBF) </h4><br>  <a href="https://habr.com/company/dsec/blog/349450/">The legacy Office document format</a> , where the low-level ObjectPool storage and separate subdirectories inside it were allocated for storing ActiveX data.  The stream "\ 001CompObj" contains the class identifier, which ultimately determines the class of the loaded object.  <b>Replacing the identifier</b> directly in hex will result in an attempt to load an object of a completely <b>different class</b> . <br><br><img src="https://habrastorage.org/webt/bc/sx/uc/bcsxucmomcw9wnqwgn-84bxosnu.jpeg"><br><br><h4>  Office Open XML </h4><br>  Modern XML document format.  The file is a zip archive.  ActiveX control data is stored in the ActiveX subdirectory in files with simple names like activeX1.xml. <br><br><img src="https://habrastorage.org/webt/su/gx/uq/sugxuqtgsbhdg8tvr53srkbvtsg.png"><br><br>  Sample file: <br> <code>&lt;?xml version="1.0" encoding="UTF-8" standalone="no"?&gt; <br> &lt;ax:ocx ax: <b>classid="{D7053240-CE69-11CD-A777-00DD01143C57}</b> " ax: <b>persistence="persistPropertyBag"</b> xmlns:ax="http://schemas.microsoft.com/office/2006/activeX" xmlns:r="http://schemas.openxmlformats.org/officeDocument/2006/relationships"&gt; <br> &lt;ax:ocxPr ax:name="Caption" ax:value="CommandButton1"/&gt; <br> &lt;ax:ocxPr ax:name="Size" ax:value="2540;847"/&gt; <br> &lt;ax:ocxPr ax:name="FontName" ax:value="Calibri"/&gt; <br> &lt;ax:ocxPr ax:name="FontHeight" ax:value="225"/&gt; <br> &lt;ax:ocxPr ax:name="FontCharSet" ax:value="204"/&gt; <br> &lt;ax:ocxPr ax:name="FontPitchAndFamily" ax:value="2"/&gt; <br> &lt;ax:ocxPr ax:name="ParagraphAlign" ax:value="3"/&gt; <br> &lt;/ax:ocx&gt;</code> <br> <br>  These files in the text form identifies the classes.  Replacing an identifier will also cause an attempt to load an item of another class. <br><br>  Next, the file contains an indication of the type of data storage object: persistPropertyBag, persistStorage or persistStream.  If the element supports storage of the <b>persistPropertyBag</b> properties, its data can be saved <b>in the same text file</b> , see the example above.  If it needs a <b>repository</b> or <b>binary stream</b> , the data will be saved in a file with the name of the type activeX1.bin, which is <b>a CFBF file</b> . <br><br><img src="https://habrastorage.org/webt/pt/tx/hp/pttxhpe9gevkgf8l4a7ddmcfspu.png"><br><br><h4>  RTF </h4><br>  In the rtf document, the ActiveX element is defined by the tags <b>\ object \ objocx</b> .  The <b>\ objdata tag</b> contains the element property store as a hex representation of the CFBF file. <br><br> <code>{\object\objocx\f37\objsetsize\objw1440\objh480{\*\objclass Forms.CommandButton.1} <br> {\*\objdata 010500000200000016000000 <br> 466f726d732e436f6d6d616e64427574746f6e2e31000000000000000000000e0000 <br> <b>d0cf11e</b> 0a1b11ae1000000000000000000000000000000003e000300feff090006</code> <br> <br><h4>  Download from file </h4><br>  The process of loading ActiveX from a document as a whole is quite simple.  The container application creates a clean object of the specified class, queries it for the specified storage interface, and provides a pointer to the repository, stream, or "property package." <br><br>  Filtering items that can be loaded has many steps.  First of all, the classes listed in the blacklist, known as <b>Office COM Kill Bit, are</b> removed (registry registry * OFFICE_KEY * \ Common \ COM Compatibility).  For example, flags that prevent downloads have classes such as Microsoft Scriptlet Component and Microsoft Web Browser. <br><br>  The remaining classes will pass the initial load.  This means that <b>the DLL will be loaded</b> into the container application, or <b>the COM server process</b> implemented in the EXE file will be <b>launched</b> .  Only after that will the other checks be performed, including the elementary ‚Äî whether the object itself is an ActiveX representative. <br><blockquote>  Example: CVE-2015-6128 <br>  In 2015, the <a href="https://twitter.com/ParvezGHH/status/672433593558396929">researcher discovered</a> that the preloading of COM modules <a href="https://habr.com/company/dsec/blog/272487/">can be used to bypass the ASLR and execute arbitrary code</a> by loading bogus dynamic libraries.  In the description of the CVE-2015-6128 released later, there is not a word about Microsoft Office. <br></blockquote>  If the identifier really identifies ActiveX, it will pass several more checks in several black and white lists. <br><br><div class="spoiler">  <b class="spoiler_title">List of ActiveX loaded from .docx on clean Windows 7 and Office 2016 with default settings.</b> <div class="spoiler_text"> <code>{00024522-0000-0000-C000-000000000046} RefEdit.Ctrl <br> {02AF6DD2-77E6-44DF-B3E1-57CF1476D8EA} Microsoft Forms 2.0 OptionButton <br> {04082FC6-E032-49F2-A263-FE64E9DA1FA3} Microsoft Forms 2.0 HTML TEXT <br> {0B314611-2C19-4AB4-8513-A6EEA569D3C4} Microsoft Slider Control, version 6.0 <br> {13D557B6-A469-4362-BEAF-52BFD0F180E2} Microsoft Forms 2.0 HTML TextAREA <br> {19FED08E-EFD1-45da-B524-7BE4774A6AEE} Microsoft Forms 2.0 ListBox <br> {20DD1B9E-87C4-11D1-8BE3-0000F8754DA1} Microsoft Date and Time Picker Control 6.0 (SP4) <br> {227B1F3B-C276-4DE0-9FAA-C0AD42ADDCF0} Microsoft Forms 2.0 HTML RESET <br> {232E456A-87C3-11D1-8BE3-0000F8754DA1} Microsoft MonthView Control 6.0 (SP4) <br> {3D0FD779-0C2D-4708-A9BA-62F7458A5A53} Microsoft Forms 2.0 ToggleButton <br> {444D2D27-02E8-486B-9018-3644958EF8A9} FieldListCtrl.2 Object <br> {4C599241-6926-101B-9992-00000B65C6F9} Microsoft Forms 2.0 Image <br> {5052A832-2C0F-46c7-B67C-1F1FEC37B280} Microsoft Forms 2.0 Label <br> {5512D110-5CC6-11CF-8D67-00AA00BDCE1D} Microsoft Forms 2.0 HTML SUBMIT <br> {5512D112-5CC6-11CF-8D67-00AA00BDCE1D} Microsoft Forms 2.0 HTML IMAGE <br> {5512D114-5CC6-11CF-8D67-00AA00BDCE1D} Microsoft Forms 2.0 HTML RESET <br> {5512D116-5CC6-11CF-8D67-00AA00BDCE1D} Microsoft Forms 2.0 HTML CHECKBOX <br> {5512D118-5CC6-11CF-8D67-00AA00BDCE1D} Microsoft Forms 2.0 HTML OPTION <br> {5512D11A-5CC6-11CF-8D67-00AA00BDCE1D} Microsoft Forms 2.0 HTML TEXT <br> {5512D11C-5CC6-11CF-8D67-00AA00BDCE1D} Microsoft Forms 2.0 HTML Hidden <br> {5512D11E-5CC6-11CF-8D67-00AA00BDCE1D} Microsoft Forms 2.0 HTML Password <br> {5512D122-5CC6-11CF-8D67-00AA00BDCE1D} Microsoft Forms 2.0 HTML SELECT <br> {5512D124-5CC6-11CF-8D67-00AA00BDCE1D} Microsoft Forms 2.0 HTML TextAREA <br> {556C2772-F1AD-4DE1-8456-BD6E8F66113B} Microsoft ImageList Control 6.0 (SP6) <br> {585AA280-ED8B-46B2-93AE-132ECFA1DAFC} Microsoft StatusBar Control 6.0 (SP6) <br> {5CBA34AE-E344-40CF-B61D-FBA4D0D1FF54} Microsoft Forms 2.0 HTML CHECKBOX <br> {5E90CC8B-E402-4350-82D7-996E92010608} Microsoft Forms 2.0 HTML OPTION <br> {603C7E80-87C2-11D1-8BE3-0000F8754DA1} Microsoft UpDown Control 6.0 (SP4) <br> {6240EF28-7EAB-4dc7-A5E3-7CFB35EFB34D} Microsoft Forms 2.0 ScrollBar <br> {65BCBEE4-7728-41A0-97BE-14E1CAE36AAE} Microsoft Office List 16.0 <br> {6C177EBD-C42D-4728-A04B-4131892EDBF6} Microsoft Forms 2.0 ComboBox <br> {787A2D6B-EF66-488D-A303-513C9C75C344} Microsoft Forms 2.0 HTML Password <br> {79176FB0-B7F2-11CE-97EF-00AA006D2776} Microsoft Forms 2.0 SpinButton <br> {86F56B7F-A81B-478d-B231-50FD37CBE761} Microsoft Forms 2.0 CommandButton <br> {87DACC48-F1C5-4AF3-84BA-A2A72C2AB959} Microsoft ImageComboBox Control, version 6.0 <br> {8B2ADD10-33B7-4506-9569-0A1E1DBBEBAE} Microsoft Toolbar Control 6.0 (SP6) <br> {8BD21D10-EC42-11CE-9E0D-00AA006002F3} Microsoft Forms 2.0 TextBox <br> {8BD21D20-EC42-11CE-9E0D-00AA006002F3} Microsoft Forms 2.0 ListBox <br> {8BD21D30-EC42-11CE-9E0D-00AA006002F3} Microsoft Forms 2.0 ComboBox <br> {8BD21D40-EC42-11CE-9E0D-00AA006002F3} Microsoft Forms 2.0 CheckBox <br> {8BD21D50-EC42-11CE-9E0D-00AA006002F3} Microsoft Forms 2.0 OptionButton <br> {8BD21D60-EC42-11CE-9E0D-00AA006002F3} Microsoft Forms 2.0 ToggleButton <br> {9432194C-DF54-4824-8E24-B013BF2B90E3} Microsoft Forms 2.0 HTML SUBMIT <br> {95F0B3BE-E8AC-4995-9DCA-419849E06410} Microsoft TreeView Control 6.0 (SP6) <br> {978C9E23-D4B0-11CE-BF2D-00AA003F40D0} Microsoft Forms 2.0 Label <br> {9A948063-66C3-4F63-AB46-582EDAA35047} Microsoft TabStrip Control 6.0 (SP6) <br> {9BDAC276-BE24-4F04-BB22-11469B28A496} Microsoft Forms 2.0 HTML IMAGE <br> {A0E7BF67-8D30-4620-8825-7111714C7CAB} Microsoft ProgressBar Control, version 6.0 <br> {CCDB0DF2-FD1A-4856-80BC-32929D8359B7} Microsoft ListView Control 6.0 (SP6) <br> {D7053240-CE69-11CD-A777-00DD01143C57} Microsoft Forms 2.0 CommandButton <br> {DCA0ED3C-B95D-490f-9C60-0FF3726C789A} Microsoft Forms 2.0 Image <br> {DD4CB8C5-F540-47ff-84D7-67390D2743CA} Microsoft Forms 2.0 TextBox <br> {DFD181E0-5E2F-11CE-A449-00AA004A803D} Microsoft Forms 2.0 ScrollBar <br> {E9729012-8271-4e1f-BC56-CF85F914915A} Microsoft Forms 2.0 CheckBox <br> {EA778DB4-CE69-4da5-BC1D-34E2168D5EED} Microsoft Forms 2.0 SpinButton <br> {EAE50EB0-4A62-11CE-BED6-00AA00611080} Microsoft Forms 2.0 TabStrip <br> {F14E8B03-D080-4D3A-AEBA-355E77B20F3D} Microsoft Forms 2.0 HTML SELECT <br> {F8CF7A98-2C45-4c8d-9151-2D716989DDAB} Microsoft Visio Document <br> {FB453AD8-2EF4-44D3-98A8-8C6474E63CE4} Microsoft Forms 2.0 HTML Hidden <br> {FDEA20DB-AC7A-42f8-90EE-82208B9B4FC0} Microsoft Forms 2.0 TabStrip <br> {FE38753A-44A3-11D1-B5B7-0000C09000C4} Microsoft Flat Scrollbar Control 6.0 (SP4) <br></code> </div></div><br>  You can see that a significant place in the list is occupied by components of the <b>Microsoft Forms</b> group.  This is a set of controls that come with Office, you can see them in the panel "ActiveX controls."  Initially, all of them were registered as ‚Äúsafe‚Äù, but over time it turned out that this was not the case for individual elements.  For example, the Frame element loads any other ActiveX without checking any lists (in recent versions this is ‚Äúfixed‚Äù, but the Frame's own blacklist is different from the general Office).  For this reason, some Microsoft Forms items can be loaded into a document only with the permission of the user.  Microsoft Forms Frame also requires user consent (at default settings), but it allows you to download some items from the Kill Bit list that could not be loaded under other conditions. <br><br>  Therefore, if the attacker manages to convince the user to allow the download of ActiveX, Frame will help him to significantly expand the ‚Äúarsenal‚Äù at the expense of such elements as, for example, the Web Browser. <br><br>  The Microsoft Forms properties storage format is partially documented by <a href="https://msdn.microsoft.com/en-us/library/cc313125(v%3Doffice.12).aspx">the [MS-OFORMS] specification</a> . <br><br>  During the ActiveX scanning process, it turned out that the set of classes for doc, docx and rtf is different, as well as different lists of available ActiveX for an application running in the usual way and running <a href="https://habr.com/company/dsec/blog/359228/">in automation mode</a> . <br><br>  Many popular applications complement these lists with their own ActiveX.  If a vulnerability is discovered, it will be reflected in the bulletin as relevant to the application to which it belongs.  In this case, the only way to exploit the vulnerability may be Office documents. <br><blockquote>  Example: Flash ActiveX <br>  Flash ActiveX is especially popular with virus writers for consistently detectable vulnerabilities and a permanent place in the white lists of IE and Office.  The first known vulnerabilities in this component appeared in 2008, one of the latest <a href="https://blogs.quickheal.com/analysis-ms-office-document-exploiting-zero-day-flash-player-vulnerability-cve-2018-4878/">CVE-2018-4878</a> closed in February of this year.  With the decline of IE popularity, Office documents have become the main distribution path for Flash exploits. <br></blockquote><h3>  OLE embedded data items </h3><br>  OLE introduced elements are designed to implement the concept of ‚Äúdocument in document‚Äù with the ability to edit ‚Äúin place‚Äù of data of various formats processed by other applications.  Like ActiveX, OLE documents are implemented based on COM. <br><br>  You can add an OLE element to a Word document as follows: open the Insert tab and select Text -&gt; Object.  The program will display a list of document types for which OLE-handlers are registered.  As in the case of ActiveX, this list corresponds little to the set of classes that can actually be loaded as OLE documents. <br><br><img src="https://habrastorage.org/webt/yi/x9/1g/yix91gwugtk06yq_s37z4iibzy0.png"><br><br><h4>  Software presentation </h4><br>  As in the case of ActiveX, the implementation of any OLE document is represented by the corresponding COM class, made in the form of a DLL or EXE.  The component exports the necessary service interfaces, and state saving in the container document is done through IPersist * interfaces. <br><br>  In a CFBF document, OLE object data is stored in a second-level ObjectPool store.  The set of threads is generally similar to the corresponding ActiveX controls. <br><br><img src="https://habrastorage.org/webt/ir/qt/oc/irqtocl-val1mrwslawmlpzdpsq.png"><br><br>  In Open Office XML documents, OLE object data is stored in the embeddings subdirectory, in a CFBF storage file with a name of type oleObject1.bin. <br><br><img src="https://habrastorage.org/webt/p-/7e/ww/p-7ewwax0n2gfsbqercoev9tie0.png"><br><br>  In RTF documents, information about an object is stored under the <b>\ object \ objemb \</b> tag.  The section also contains the storage encoded as a hex representation of the CFBF file. <br><br> <code>{\object\objemb\objw8307\objh553{\*\objclass WordPad.Document.1} <br> {\*\objdata 010500000200000013000000576f72645061642e446f63756d656e742e31000000000000000000000a0000 <br> <b>d0cf11e</b> 0a1b11ae100000000 <br></code> <br><br>  The RTF format is distinguished by the fact that it supports the <b>\ objupdate</b> tag, which causes an automatic activation of an element while, by default, OLE elements are inactive when loaded. <br><blockquote>  Example: CVE-2017-11882 <br>  The vulnerability of the <a href="https://embedi.com/blog/skeleton-closet-ms-office-vulnerability-you-didnt-know-about/">CVE-2017-11882</a> OLE component Equation Editor due to the processing of the object in a separate process made it possible to stable and universal operation.  The \ objupdate tag forced Word to load the vulnerable component immediately upon opening the document. <br></blockquote><blockquote>  Example: Excel Inline Elements with Macro Virus <br>  <a href="https://www.zscaler.com/blogs/research/malicious-rtf-document-leading-netwiredrc-and-quasar-rat">Researchers have detected</a> malicious rtf-documents that do not use any new vulnerabilities.  Documents contain as embedded objects several Excel documents with macros.  The calculation is made on the fact that the user, forced after opening the document several times in a row to refuse to run the macro, will eventually ‚Äúsurrender‚Äù and allow execution.  At the moment, the technique is still working. <br><br><img src="https://habrastorage.org/webt/ih/e_/oq/ihe_oqpkamkndvqbjfcmxhjqhbi.png"><br></blockquote>  A significant difference from ActiveX in the case of embedded OLE elements is that the class identifier is written directly to the storage file by the WriteClassStg function.  This technique is inherited from very old times, when Microsoft enthusiastically developed the concept of "serialization" and storing objects with their state in CFBF format.  The container document also stores the class identifier of the element being implemented, but the object of the class specified in the repository will be loaded.  This identifier can be replaced by forcing the application to load an object that is not intended for this purpose at all. <br>  It is also possible to edit the data of the element, which in certain cases leads to the identification of vulnerabilities. <br><br>  OLE objects also undergo numerous checks on the ability to load, making it difficult to obtain a complete list of potentially downloadable items.  The set of elements that can be loaded as OLE objects differs from the list of loaded ActiveX.  In particular, they are checked on the KillBit list belonging not to Office, but to Internet Explorer (HKEY_LOCAL_MACHINE \ SOFTWARE \ Microsoft \ Internet Explorer \ ActiveX Compatibility). <br><br><h4>  OLE by reference </h4><br>  OLE distinguishes between two mechanisms for embedding content in a document ‚Äî directly embedding an OLE document and creating a link within the main document to another document.  In the case of embedding an OLE object by reference, the main document contains an indication of the path to the file of the embedded document.  The path can be local or network, or an Internet address.  OLE-handler is determined by the file extension, the corresponding handler must be registered in the operating system. <br><blockquote>  Example: CVE-2017-0199 <br>  The vulnerability of <a href="https://www.fireeye.com/blog/threat-research/2017/04/cve-2017-0199-hta-handler.html">CVE-2017-0199</a> was the ability to add an ‚Äúobject by reference‚Äù document in the hta format.  The latter is an html with the ability to execute code, that is, it is actually an executable file.  The handler automatically downloaded and executed hta, allowing you to execute arbitrary code when opening a document. <br></blockquote>  Before updating the embedded object, the application requests user permission.  In this case, the file is uploaded in advance, which can be used to disclose information about the user. <br><br><h3>  Injected files (Packages) </h3><br>  Office documents support the ability to add any file (Object -&gt; Create from file or simply drag the file icon into the edit box).  Technically, this is implemented by adding an <b>Object Packager</b> embedded element to the document that writes the desired file into its own data.  Object Packager allows you to replace the icon and signature of the file, as well as set the command line to open.  It may also include <b>files ‚Äúby reference‚Äù</b> , when the file is opened not from its own storage, but by the specified path, <b>including the network</b> path. <br><br>  Recently, the functionality of the Object Packager has been significantly clipped, and initially the element could save any files, including executables, links, and even the command line.  All the user had to do to launch the content was to double-click the icon in the text of the document. <br><blockquote>  Example: Files in the Outlook Message Body <br>  Outlook messages, which are also master documents, allow <a href="https://doublepulsar.com/oleoutlook-bypass-almost-every-corporate-security-control-with-a-point-n-click-gui-37f4cbc107d0">you</a> to <a href="https://doublepulsar.com/oleoutlook-bypass-almost-every-corporate-security-control-with-a-point-n-click-gui-37f4cbc107d0">add Object Packager elements to the message body</a> .  For the user, the element looks like an image arbitrarily chosen by the attacker.  Double click on the image opens the packaged file.  The attacker is left to choose the type of data from those that <a href="https://posts.specterops.io/the-tale-of-settingcontent-ms-files-f1ea253e4d39">have not yet come under tightening security policies</a> . <br></blockquote><br><img src="https://habrastorage.org/webt/r-/cl/lr/r-cllr7l101bxg1g7noz3ntrs-c.jpeg"><br><br><h3>  Non-OLE inline elements </h3><br>  At the moment, the greatest threat / interest from non-OLE elements may be <b>images added to a document by reference</b> .  When a document is opened in an unprotected mode, the images are downloaded automatically, which can lead to the disclosure of the location and identity of the user who downloaded the document through anonymizing proxies or received a confidential document from third parties.  This technique, in particular, was implemented in the <b>tool Scribbles</b> , which is in service with US intelligence. <br>  In a Windows local network, automatic downloading of images by reference makes it possible to exploit the <b>NTLMRelay vulnerability</b> .  The mechanism of links to pictures is not compatible with the security requirements of ActiveDirectory networks, since the administrator who receives such a document essentially executes the attacker's code with full administrative privileges. <br><br><h3>  Protection methods </h3><br>  What can be done?  In general, a bit. <br><br>  Currently, the most effective method of protection against vulnerabilities in objects embedded in Office documents is <b>the protected view mode</b> .  In this mode, both the loading of objects and the loading of data from external sources are excluded.  Unfortunately, the transition to the full-featured mode requires elementary user actions, easily provoked by social engineering methods. <br><br><img src="https://habrastorage.org/webt/4r/7l/x_/4r7lx_il1btctygcoor7a9gmvwc.png"><br><br>  ActiveX controls can be <b>disabled in the Trust Center settings</b> <br><br><img src="https://habrastorage.org/webt/bf/ev/ol/bfevolvqahqwt-6slndlob7phxq.png"><br><br>  Note that for embedded OLE elements this does not work. </div><p>Source: <a href="https://habr.com/ru/post/423933/">https://habr.com/ru/post/423933/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../423921/index.html">10 years of Android: remember everything</a></li>
<li><a href="../423923/index.html">SAP Leonardo Hackathon from velcom and SAP for developers from Belarus</a></li>
<li><a href="../423925/index.html">Open webinar ‚ÄúStrange recursive template‚Äù</a></li>
<li><a href="../423927/index.html">10 promising search engines to improve SEO</a></li>
<li><a href="../423931/index.html">How to bypass SMS-identification when connecting to public Wi-Fi networks?</a></li>
<li><a href="../423935/index.html">Answers from the Embox stand to popular questions from the IT-festival TechTrain</a></li>
<li><a href="../423937/index.html">Privilege escalation in a Windows environment</a></li>
<li><a href="../423939/index.html">Dynamic programming or "Divide and Conquer"</a></li>
<li><a href="../423941/index.html">Reports from iOS mitap Redmadrobot</a></li>
<li><a href="../423943/index.html">Optimization of prices in offline retail</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>