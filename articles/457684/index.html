<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>The experience of integrating the Atol cash register with its own CRM trading system</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Around the online cash register lately wild hype, July 1, 2019 ends the last delay, so I had to deal with this issue. Those who have 1C or another sys...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>The experience of integrating the Atol cash register with its own CRM trading system</h1><div class="post__text post__text-html js-mediator-article">  Around the online cash register lately wild hype, July 1, 2019 ends the last delay, so I had to deal with this issue.  Those who have 1C or another system should not strain themselves, but if you have your own samopisnaya system, then integration with online cash registers also falls on your shoulders. <br><br>  My experience is useful for integration with Atol cash registers in the mode of data exchange over the network, your program can send data to the Atol web server both to the localhost and via the local network, you can even send from the AJAX browser, even from the server via CURL, therefore, no matter what language your corporate software is written in, everything is cross-platform. <br><a name="habracut"></a><br>  The Atol 30f cash register came to my experiments - it is such a simple typewriter with a black box (FN), so it is appropriate when the entire ordering logic lies on the external software, and not on the software built into the cash register.  In addition, devices of this type are relatively inexpensive compared to android counterparts. <br><br>  Separately, I want to note that the ‚Äúspecialists‚Äù of some companies involved in support do not even know that Atol from version 10 has an embedded web server in the driver that accepts JSON tasks, moreover, this driver can also be installed on linux, judging by the number of ready-made solutions on the raspberries, I can assume that it can also be installed there, the installer for arm is present in the distribution kit of the 10th version of the driver. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      The planned scheme is approximately the same - there is a CRM that spins on a server on the local network, it is opened from browsers, from the server side, PHP will be sent through curl with checks and printed at the checkout.  And the cash register itself is connected to any computer on Windows on the same network. <br><br>  They say that if you do not activate the cashier, then it can work in printer mode and print that check is invalid, but I could not verify this, I had to do penny sales and refund operations. <br><br>  The driver of the tenth version is downloaded <a href="https://www.atol.ru/company/service-support/dkkt10-platforma5/">here</a> . <br><br>  Before installing, you need to install <a href="https://java.com/ru/download/manual.jsp">Java of</a> the same bitness as the driver, otherwise the checkbox of the web server will not be available if you install the 64-bit CCP driver, then Java x64. <br><br>  It seems that the logic needs to install a 64-bit driver on a 64-bit system, but some 32-bit software will not be able to work with it (it seems to be true for 1C if it is 32-bit). <br><br><img src="https://habrastorage.org/webt/nf/fn/uk/nffnukvhkzk3za8vpcrn567wygi.png"><br><br>  At the end of the installation, there is a check mark - to configure the web server, if it is not checked, then you need to enter the browser at <a href="http://127.0.0.1/">127.0.0.1</a> : 16732 / settings, put a check mark ‚Äúactivate the server‚Äù and save. <br><br><img src="https://habrastorage.org/webt/gv/fm/9l/gvfm9lfbrzxyntshlyhn7fmx-pc.png"><br><br><img src="https://habrastorage.org/webt/dy/so/pq/dysopqgomkepetfvn-de5vgdj3q.png"><br><br>  After that, you need to restart the server via START-&gt; ATOL-&gt; restart ... <br><br>  I also want to immediately warn you that if you start the web server, local applications will not be able to access the CCP, I was dying for a long time, installed the driver, started the driver test, and he tells me that the port is busy and everything, I called technical support for the local vendor, they said, we don‚Äôt know what to do, then overloaded the computer ten times, reinstalled the driver, nothing helps. <br><br>  In general, after you activated and restarted the server, and before that you turned off the server and checked the plain text printing using the supplied utility or just checked the connection, you can proceed. <br><br>  This web service does not have any password protection, so you need to immediately configure Windows Firewall or other software so that only the necessary computers can access on port 16732, in my situation it is the server on which CRM is spinning. <br><br>  <b>Communication with the web service is generally a separate topic, very interesting ...</b> <br><br><ol><li>  We generate unique uuid for the task </li><li>  We send the task by the POST method </li><li>  We are dabbling on the web service, waiting for the result of the task with our UUID, it may be that our task will have a wait status for a few seconds, and an error may occur if something is wrong in the request ... </li></ol><br>  And then I will give a working version, it is suitable for those situations where payment is only one method, and not so much of cash and part of cashless, the tax system is used by default, VAT is not calculated yet, I wanted to add a code, then upload it, but I think there are still people who need this information before July 1, than after.  At once I will say that the class needs some work, a lot of raw, no error handling, everything is done in a couple of hours without reading the documentation, this code is more like an example and I advise you to study the <a href="http://integration.atol.ru/api/">documentation</a> in detail and adapt it to your specific processes. <br><br><div class="spoiler">  <b class="spoiler_title">php code for an example of working with api (use only for educational purposes)</b> <div class="spoiler_text"><pre><code class="php hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?php</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">Class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">AtolWebDriver</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> $addr=<span class="hljs-string"><span class="hljs-string">"127.0.0.1"</span></span>,$port=<span class="hljs-string"><span class="hljs-string">"16732"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> $timeout = <span class="hljs-number"><span class="hljs-number">30</span></span>; <span class="hljs-comment"><span class="hljs-comment">//  public $operator; function __construct($addr=false,$port=false) { if ($addr!==false) $this-&gt;addr=$addr; if ($port!==false) $this-&gt;port=$port; } public function CallAPI($method, $data,$_url="/requests") { $url = "http://".$this-&gt;addr.":".$this-&gt;port.$_url; $curl = curl_init($url); curl_setopt($curl, CURLOPT_RETURNTRANSFER, true); curl_setopt($curl,CURLOPT_TIMEOUT, $this-&gt;timeout); $headers = ['Content-Type: application/json']; curl_setopt($curl,CURLOPT_HTTPHEADER, $headers); curl_setopt($curl, CURLOPT_CUSTOMREQUEST, $method); curl_setopt($curl, CURLOPT_POSTFIELDS, json_encode($data)); $resp = curl_exec($curl); $data = json_decode($resp,1); $code = curl_getinfo($curl, CURLINFO_HTTP_CODE); curl_close($curl); $res= [$data,$code,$resp]; print_r($res); return $res; } //   public function get_res($uuid) { $ready = false; $cnt=0; $res_url = '/requests/'.$uuid; while (!$ready &amp;&amp; ++$cnt&lt;60) { usleep(500000); // ,     list($res,$code,$resp) = $this-&gt;CallAPI('GET',[],$res_url); $ready = ($res['results'][0]['status'] == 'ready'); if ($ready) return $res; } return false; //    } //  public function add_req($uuid,$req) { return $this-&gt;CallAPI('POST', ['uuid'=&gt;$uuid,'request'=&gt;$req]); } //  id   public function gen_uuid() { return exec('uuidgen -r'); } //      public function atol_task($type,$req=[]) { $req['type'] = $type; $uuid = $this-&gt;gen_uuid(); $req = $this-&gt;add_req($uuid,$req); if ($req[1]!='201') return false; //  $res = $this-&gt;get_res($uuid); //  if ($res===false || !isset($res['results'][0])) return false; return $res['results'][0]; } /*    */ //  public function get_shift_status() { $res = $this-&gt;atol_task('getShiftStatus'); if ($res===false) return false; //closed / opened / expired return $res['result']['shiftStatus']['state']; } //  public function open_shift() { $status = $this-&gt;get_shift_status(); //e ,    if ($status=="expired") $this-&gt;close_shift(); if ($status=="opened") return "    "; $res = $this-&gt;atol_task('openShift',['operator'=&gt;$this-&gt;operator]); } //  public function close_shift() { $status = $this-&gt;get_shift_status(); if ($status=="closed") return "    "; $res = $this-&gt;atol_task('closeShift',['operator'=&gt;$this-&gt;operator]); } public function items_prepare($items) { $res_items = []; $summ = 0; while ($item = array_shift($items)) { $res_item = $item; if (!isset($item['type'])) $res_item['type']="position"; if (isset($item['price']) &amp;&amp; isset($item['quantity'])) { $res_item['amount'] = $item['price']*$item['quantity']; $res_item['tax'] = ['type'=&gt;'none']; $summ+=$res_item['amount']; } $res_items[] = $res_item; } return [$res_items,$summ]; } // sell,  sellReturn public function fiskal($type_op="sell",$items,$pay_type="cash") { $data = []; $data['operator'] = $this-&gt;operator; $data['payments'] = []; list($data['items'],$summ) = $this-&gt;items_prepare($items); //+++       $data['payments'][] = ['type'=&gt;$pay_type,'sum'=&gt;$summ]; $res = $this-&gt;atol_task($type_op,$data); } } //  ip   web-  ,      $atol = new AtolWebDriver('192.168.100.10'); //    $atol-&gt;operator = ['name'=&gt;'.']; //       $items = []; $items[] = ['name'=&gt;' ','price'=&gt;0.7,'quantity'=&gt;1]; $items[] = ['name'=&gt;' ','price'=&gt;0.4,'quantity'=&gt;1]; //  $atol-&gt;open_shift(); //  $atol-&gt;fiskal("sell",$items); sleep(10); // ,     //     , ..    $atol-&gt;fiskal("sellReturn",$items); //     sleep(20); // ,   $atol-&gt;close_shift();</span></span></code> </pre> <br></div></div><br>  There are some flaws that I will correct. <br><br><ol><li>  Rounding fractions when calculating the amount, you need to round to kopecks, otherwise you can get 1.000000001 or 0.999999999 </li><li>  With the correct writing of the rest of the program logic, this usually does not occur, but during the tests I found myself finding the task to return the result error, and I was waiting for the ready </li></ol><br>  Well, in the process of introducing I am afraid to catch many more mistakes, for example, if the task hangs for a long time in the wait status, then it is better to remove it from the queue, otherwise subsequent tasks will hang for a few minutes, I caught such a glitch once, I did not hope that it would print and here I sit, but it‚Äôs hop and printed two checks in a row sent earlier ... <br><br>  In general, it is possible to collect acquiring services from the site in the future, if there are no online checks in them, until it was decided what kind of acquiring to screw on.  But this decision, more likely as an idea for a decision, time will tell how this cash register will take root. <br><br>  <b>Warning</b> , for those who have not read the article carefully and are not very competent in the security issue - <b>this web service does not have encryption (https), does not have authorization</b> , even if it is used only in the local network - set up protection for access to the port. </div><p>Source: <a href="https://habr.com/ru/post/457684/">https://habr.com/ru/post/457684/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../457646/index.html">About antelope in a gas mask and pink salt lakes</a></li>
<li><a href="../457658/index.html">Union MS-11: Accident, which was not?</a></li>
<li><a href="../45766/index.html">Grails 1.1 Beta 1 Released</a></li>
<li><a href="../457666/index.html">Raspberry Pi Alternatives</a></li>
<li><a href="../45767/index.html">Five unusual globes</a></li>
<li><a href="../457686/index.html">How Sberbank Collects Consent to Biometrics Processing</a></li>
<li><a href="../45769/index.html">Many planets may contain the seeds of life</a></li>
<li><a href="../457690/index.html">Paranoid videos from the Yandex.Money mitap</a></li>
<li><a href="../457692/index.html">Reflections on the national standard NB-Fi and billing systems</a></li>
<li><a href="../457696/index.html">Danger of using multi-character constants</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>