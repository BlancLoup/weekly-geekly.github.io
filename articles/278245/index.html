<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Stack chases with a stack, or bytecode conversion of a Java virtual machine into a Phantom OS bytecode.</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Phantom OS is an experimental operating system containing, at the application level, a virtual bytecode machine in persistent RAM. 

 One of the two k...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Stack chases with a stack, or bytecode conversion of a Java virtual machine into a Phantom OS bytecode.</h1><div class="post__text post__text-html js-mediator-article">  <i>Phantom OS is an experimental operating system containing, at the application level, a virtual bytecode machine in persistent RAM.</i> <br><br>  One of the two key paths for migrating existing code that are planned for Phantom OS is the conversion of Java bytecode to Phantom bytecode. <br><br>  I must say that these virtual machines are pretty, albeit completely random, similar.  The Phantom Virtual Machine was designed when I did not know anything about Java, but, probably, the similarity of goals led to the similarity of the decisions made. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Both machines are stack machines.  Both operate on two separate stacks ‚Äî a stack for working with objects (only links are on the stack), and a binary stack ‚Äî for computing.  The Phantom machine also has separate stacks for feature frames and exception traps.  How this part is arranged in the JVM, I do not know so far, but I believe that it is unlikely to be radically different. <br><br>  Naturally, the set of operations of stack machines in some places is similar as two drops. <br><br>  But, of course, there are very significant differences. <br><br>  First, the Phantom Virtual Machine is designed to run the application code in a less friendly environment.  Java assumes that each program lives in a separate address space, and everything around is ‚Äúour‚Äù code.  Phantom allows direct calls between applications of different users and different programs, which requires a tougher attitude to some aspects of the virtual machine, including the same call, and the interface of the object in general.  For example, we cannot rely on the fact that the called method behaves ‚Äúdecently‚Äù - you cannot give it access to your stack, you cannot rely on the presence or absence of a return value.  It is impossible to guarantee the difference between a method, a function and a static function.  That is, we can assume that it is we who cause, but what is ‚Äúslipped‚Äù to us from that side is unknown. <br><br>  In view of all the above, the call in Phantom is absolutely unified - it is always a method call (there is this and there is a class), and a value is always returned, which for the void method is null and is explicitly destroyed by the calling code.  This ensures that whatever the call error happens, so that it does not turn up as the subject of the call, the call and return protocol will be observed. <br><a name="habracut"></a><br>  There is a difference in working with integers.  Java allocates them to a separate category of types, different from the object, ‚Äúclass‚Äù types - java.lang.Integer and int - different things in Java.  Kompyler sometimes successfully hides this fact, but inside they differ.  Phantom and here goes towards maximalism.  The whole is an honest object.  It can be pulled out onto an integer stack and there calculated in a ‚Äúnon-object‚Äù, binary form, but it will return to the form of an object being assigned to a variable or passed in a parameter.  Incidentally, this also follows from the requirement of uniformity of the method call protocol ‚Äî the methods that return the integer and the object according to the protocol are identical.  (The same, obviously, applies to other "integral" types - long, float, double.) <br><br>  There are other differences, for example, the connection protocol of what is called native methods in Java.  In Phantom, these are ‚Äúsystem calls,‚Äù and, again, at the level of a method call, they are indistinguishable from the usual ‚Äúhonest‚Äù method.  (The code of this method contains a special instruction for ‚Äúleaving‚Äù the OS kernel, but this method is not visible ‚Äúoutside‚Äù. In particular, this allows inheriting and overriding such methods in the traditional way, by replacing VMT.) <br><br>  It seems (at least, it seemed to me) that converting the bytecode of one stack machine to the bytecode of another stack machine is an elementary task.  In the end, there and there stacks, and 90% of operations are simply identical.  Well, there is no difference between the Phantom and Java bytecode integer addition: pick up two integers from the stack, fold, put the result on the stack. <br><br>  The first approach to translation was based on the model of sequential conversion of Java bytecode to phantom one.  It quickly turned out that it was impossible to do this linearly.  Totally.  It is necessary to ‚Äúwork out‚Äù when parsing the Java code ‚Äúwork‚Äù of the stack, and to synthesize an intermediate representation.  A part of such a translator was written and declared unsuitable - the labor intensity exceeded all imaginable boundaries.  For example, locally, at the call point, it is completely impossible to find out if the object is a call (the first parameter is this) or not.  It's all the same to us, but it matters to us.  You can figure it out, but you need to make a lot of effort.  It even provided that only the analyzer had to write - the compiler backend, generating quite reliable Phantom bytecode, worked stably by that time (due to the fact that the compiler of its own language was ready and stably used). <br><br>  In this place, the work would have stalled, do not get me under the hands of a framework called Soot.  Originally intended for static analysis and Java instrumentation bytecode, it was ideal for the task described.  Soot parses the JVM class file and generates an extremely sane internal representation ‚Äî a tree of operations with a compact (about a dozen types of nodes) basis, plus information about types and other meta-information. <br><br>  From this point, conversion is catastrophically simpler - in fact, you need to convert a tree into a tree.  By the way, by the way, we also get support from Dalvik (Andrid VM bytecode). <br><br>  We can not say that now everything is cloudless.  Although the first primitive Java classes have already been compiled and work has begun on the compiler unit tests.  There are a lot of problems. <br><br>  For example: in the phantom, inheritance from classes with an ‚Äúinternal‚Äù implementation was supposed to be prohibited.  At the same time, Java ‚Äúused‚Äù to see the type java.lang.String in the string, not internal.String.  But that's fine!  More difficult with the comparison of objects.  In Java, == for integers and strings works differently, compares values ‚Äã‚Äãand references, respectively.  The more consistent Phantom clearly distinguishes between comparing values ‚Äã‚Äãand references, which means that the seemingly simple conversion of operators == and! = Causes a problem - one has to either deal with the type, or introduce a java bytecode into the basis, which behaves as described above.  That ‚Äúinaccurately‚Äù, but damn simple. <br><br>  In general, it was originally supposed that the type system of Java should be encapsulated by presenting them in the type tree of the virtual machine Phantom inside the java branch.  In fact, I have now refused this.  This appears to cause more problems than it solves. <br><br>  A ridiculous problem was with access to public fields: in the Phantom they ... no.  At all.  Only methods.  Bypassing the problem required automatic generation and use of getters and setters.  Which is probably also problematic - they are now given typical ‚ÄúJava‚Äù names getVariable / setVariable, which may cause a conflict.  Apparently, it is necessary to make the names of the ‚Äúgenerated‚Äù methods special and inaccessible from the usual method namespace, but it‚Äôs also a bit sad to do so - the autogeneration of public setters has an applied value. <br><br>  The next problem will be synchronization primitives.  In Java, the synchronization point can be any object.  You do not want to keep special fields for this in each object of the Phantom, but you need to be able to somehow ‚Äúcomplete‚Äù the objects.  And not only synchronization, but also, for example, the mechanism of weak links requires that additional entities be ‚Äúhung‚Äù on the object.  At the moment, this is supposed to be done through the object header field, on which it is possible, if necessary, to hang an object or a multitude of objects to serve special cases.  For most ‚Äúlinear‚Äù objects, this field will be empty, and filled only if they are doing something special with it. <br><br>  Phew  Probably, to begin with, we put a semicolon. <br><br>  Well, yes, that's all - open source.  If it is interesting to take part in the work on the OS, or you need a ready-made virtual machine in your project, the project is easily located on the github using the phantomuserland key. </div><p>Source: <a href="https://habr.com/ru/post/278245/">https://habr.com/ru/post/278245/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../278231/index.html">Practical training in the field of information security: Corporate Laboratories 2016, reboot</a></li>
<li><a href="../278233/index.html">Java programmer cheat sheet 7.1 Typical tasks: The optimal way to convert an InputStream to a string</a></li>
<li><a href="../278235/index.html">Rules of life of the sysadmin</a></li>
<li><a href="../278237/index.html">Pub-Sub implementation examples: Azure Topics, EventHub, ZeroMQ, microServiceBus, etc</a></li>
<li><a href="../278243/index.html">Tales of "engineering special forces", well, or just our fun work</a></li>
<li><a href="../278247/index.html">Preparing an ASP.NET Core: Creating Your Cross-Platform Modular Framework</a></li>
<li><a href="../278251/index.html">Preparing an ASP.NET Core: Creating Your Own Tag Helper</a></li>
<li><a href="../278253/index.html">Zephyr Project - real-time open source OS</a></li>
<li><a href="../278255/index.html">Comparing SSL Certificates with Domain Verification</a></li>
<li><a href="../278257/index.html">Passport scanner do it yourself</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>