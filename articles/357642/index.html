<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Portgen - bypassing port filtering</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hi GT! 

 Without spreading thoughts on the trees, let's get down to business. To provide myself with fast and uncensored Internet, I have long been u...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Portgen - bypassing port filtering</h1><div class="post__text post__text-html js-mediator-article"> Hi GT! <br><br>  Without spreading thoughts on the trees, let's get down to business.  To provide myself with fast and uncensored Internet, I have long been using the standard scheme: OpenVPN and the simplest VPS abroad.  UDP is used as a transport protocol. <br><br>  <b>Problem</b> <br>  At one "wonderful" moment, I discovered that the VPN had fallen off and was no longer rising.  I will not describe a long investigation of the problem - I will say the result immediately: the change in the port number helped.  It did not help for a long time: after a couple of days the tunnel broke again and again was restored by changing the port. <br><a name="habracut"></a><br>  <b>Hypothesis</b> <br>  On the provider's firewall, my traffic statistics look like this: 100% or a little less using a single UDP protocol, through a single port and on a single IP.  Thus, if we imagine this in the form of a graph, it will be strikingly different from that of the average user, where there will be a lot of ‚Äúpeaks‚Äù of the graph for different protocols, ports (TCP 80, 443, 993 ...) and IP addresses. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      It seems that the heuristic of their firewall reacts to this and blocks the connection, through which the share of traffic passes, more than a certain threshold.  At the same time, such a filter, by definition, will work with some delay, since statistics is a science that loves large numbers. <br><br>  <b>Task</b> <br>  It is necessary to develop a solution that will change the VPN port number with a specified interval, which is obviously smaller than the statistics conversion interval for the firewall.  The port should change in an unpredictable manner to prevent the filter from running ahead of the curve.  You also need to be able to start the port change manually for various force majeure cases.  The change in time should work even with complete loss of server management. <br><br>  <b>Algorithm</b> <br>  In general, the generation formula looks like this: <br><br> <code>port = hash(shared_secret + round(time) + ondemand_key) % (port_max - port_min + 1) + port_min <br></code> <br><ul><li>  hash () - hash function </li><li>  shared_secret is the key that ensures the unpredictability of the next result without his knowledge.  <b>The only secret part of the system.</b> </li><li>  round (time) - some function of deification from the current time in UTC.  The degree of desensitization determines the interval for changing ports, for example, dropping seconds and minutes - an interval of 1 hour, dropping another hour and maintaining the AM / PM mark - 12 hours, and so on. </li><li>  ondemand_key is a key that is loaded from a reliable third-party server in order to be able to manually change the port by changing this key. </li><li>  port_min and port_max - the range of ports used, the minimum and maximum, respectively. </li></ul><br><br>  In order for the system to quickly respond to the change of ondemand-key, I run the script on the scheduler at a small interval of several minutes.  In this case, it is necessary to provide for checking whether the parameters actually changed, so that if the result is negative, the script would immediately end. <br><br>  Let's look at the expression above, which has already been calculated by the time of verification.  If neither the hash () value nor the range limit has changed, then there has been no change.  To do this, take the hash again: <br><br> <code>cache = hash(hash(...) + port_min + port_max) <br></code> <br>  After that, we‚Äôll read the old cache value from a special file, compare it, and if they differ, update the file and continue with the script;  if the same - exit. <br><br>  Next is a matter of technology: we substitute the port value into the rule template for iptables (there are two of these templates for the client and server role of the script), add the rule to the table, read the previous rule from another file and, if it exists, remove it from iptables, update the file current rule. <br><br>  Theoretically, at this moment the connection should already work on the new port, but in practice for some reason it continues to use the old one until the daemon is restarted.  I would be grateful if someone explained the reason for such a bug, but for now I‚Äôm just giving the command to restart from the script.  Communication interruption at the same time - a few seconds and does not cause inconvenience. <br><br>  <b>System restart on demand</b> <br>  It‚Äôs very convenient to use a public VCS (I have GitHub) as the ondemand key repository.  In principle, any free hosting would be suitable, however, VCS has an important advantage in storing the history of edits.  A situation may occur when one of the ends of the tunnel has updated its key, and the second for some reason cannot reach the repository and works according to the old key in the cache.  In this case, you can try to rollback the commit: if the drop in communication, which caused the admin to pull ondemand, is not caused by blocking the port, but for example by a temporary failure at the uplink, returning the key will soon raise the tunnel.  In practice, such situations have happened a couple of times. <br><br>  The script that pulls the key is nothing special - just wget, checking its return code and caching to the file - so there‚Äôs no point in describing it, the code will tell everything for itself. <br><br>  The ondemand-key management script is a more voluminous thing, although in fact it is also simple - it is a binding to simplify operations on the repository of keys.  Allows you to perform in one command operations create, delete and change keys. <br><br>  <b>Conclusion</b> <br>  I believe that the tool for solving the set task was a success, and has been successfully operating for more than a year.  Moreover, the resulting utility can be considered a universal weapon against this type of filtering, because: <br><ul><li>  In addition to OpenVPN, scripts can be used for any network service. </li><li>  as a cryptographic device, you can use any hash function, which provides a deposit for possible future compromise of today's algorithms </li><li>  one server can serve a large number of clients with unique keys - just scatter portgen instances into individual folders </li></ul><br>  <b>Links</b> <br>  <a href="https://github.com/Raegdan/portgen">github.com/Raegdan/portgen</a> - the portgen program itself <br>  <a href="https://github.com/Raegdan/portgen-ondemand">github.com/Raegdan/portgen-ondemand</a> is a program for managing ondemand keys and my keys at the same time.  This was done solely for convenience.  The keys ondemand are unclassified, so if someone for some reason suddenly needs a piece of my / dev / urandom, I don‚Äôt feel sorry;) <br><br>  <b>Note</b> <br><div class="spoiler">  <b class="spoiler_title">The code is for Habr!</b>  <b class="spoiler_title">Here we have astronauts, drones and gadget reviews!</b> <div class="spoiler_text">  In principle, I can not disagree with such an argument, and the program code is really more a Habr profile.  However, first, this project is directly related to the fight against censoring the Internet - a topic that has been explicitly resettled here.  Secondly, my only article so far was written before the separation and remained on Habr√©, which causes certain limitations for my account on the GT.  Please treat with understanding. <br></div></div></div><p>Source: <a href="https://habr.com/ru/post/357642/">https://habr.com/ru/post/357642/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../357632/index.html">Run the application for Android (from personal experience)</a></li>
<li><a href="../357634/index.html">We launch the application for Android Part 2 - finance, promotion (from personal experience)</a></li>
<li><a href="../357636/index.html">Android Studio 2.0 development environment released (preview)</a></li>
<li><a href="../357638/index.html">Obama recognized computer science as essential for fundamental education.</a></li>
<li><a href="../357640/index.html">About sorting (bubble, fast, comb ...)</a></li>
<li><a href="../357644/index.html">Programming as visual arts</a></li>
<li><a href="../357646/index.html">OS X developers are more popular than Linux - and other statistics with Stack Overflow</a></li>
<li><a href="../357648/index.html">Introduction to writing tests and familiarity with xUnit</a></li>
<li><a href="../357650/index.html">Jennifer Zero and other bad surnames</a></li>
<li><a href="../357652/index.html">Is the era of "fat" software coming to an end?</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>