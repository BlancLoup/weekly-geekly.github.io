<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Evolution of the TDL4 rootkit or field reports of recent months</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="We have been closely monitoring TDL4 for a long time, as well as botnets based on this family of rootkits. But lately it has been particularly interes...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Evolution of the TDL4 rootkit or field reports of recent months</h1><div class="post__text post__text-html js-mediator-article">  We have been closely monitoring TDL4 for a long time, as well as botnets based on this family of rootkits.  But lately it has been particularly interesting to watch the release of patches by Microsoft to block the download methods for unsigned drivers for the x64 systems used to install Win64 / Olmarik. <br><br>  Let's start from afar, so on April X, in addition to all the others, there was a <a href="http://blog.eset.com/2011/04/15/kb2506014-kills-tdl4-on-x64">fix KB2506014</a> , the task of which was to make several changes to the winloader.exe module for x64 OS versions and thus counteract the loading of unsigned drivers.  Before installing the patch, BCD (Boot Configuration Data) has three different boot options: <br><br>  <i>BcdLibraryBoolean_DisableIntegrityCheck</i> - forced disabling of the scan (most often used for debugging purposes); <br>  <i>BcdOSLoaderBoolean_WinPEMode</i> - disabling in OS installation or repair mode <br>  <i>BcdLibraryBoolean_AllowPrereleaseSignatures</i> - allow uploading modules having a test digital signature <a name="habracut"></a>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      After installing the patch, only two options remain - <i>BcdLibraryBoolean_DisableIntegrityCheck</i> and <i>BcdLibraryBoolean_AllowPrereleaseSignatures</i> , and <i>BcdOSLoaderBoolean_WinPEMode is</i> no longer used in the configuration of the integrity check of loaded drivers.  In winloader.exe there is a special function <i>BlImgQueryCodeIntegrityBootOptions</i> , which returns the value that determines the checking policy. <br><br>  The figure below shows the <i>BlImgQueryCode IntegrityBootOptions</i> procedure after the patch: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/789/d6f/a27/789d6fa27a399354db40c78df7c34e01.png" alt="image"><br><br>  As we can see, the <i>BcdOSLoaderBoolean_WinPEMode</i> option <i>is</i> no longer used, and the boot method used in TDL4 ceased to work after that (for more details about its work, see our research report <a href="http://www.eset.com/us/resources/white-papers/The_Evolution_of_TDL.pdf">‚ÄúThe Evolution of TDL: Conquering x64‚Äù</a> ). <br><br>  However, a new version of the TDL4 bootkit was released recently, which bypasses this fix - the ldr16 component was changed, allowing TDL4 to regain the ability to infect x64-bit systems.  In addition, malware protection against detection and deletion has been improved by improving low-level, kernel-mode event handlers related to the storage device miniport object. <br><br>  After the last patch from Microsoft, it became impossible to bypass the code digital signature verification policy in WinPE mode.  The creators of TDL4 had to change the tactics of infection of 64-bit OS.  The idea remains the same: change the components ld32 or ldr64 in the library kdcom.dll depending on the bitness of the OS being infected.  Instead of switching to WinPE mode, the new TDL4 version fixes the <i>I_CheckImageHashInCatalog</i> procedure.  This procedure checks the integrity of the modules loaded by the <i>winload.exe</i> program. <br><br>  Under normal conditions, when the I_CheckImageHashInCatalog procedure cannot verify the integrity of the module, a value of <i>0xC0000428 (STATUS_INVALID_IMAGE_HASH) is returned</i> , preventing the system from loading.  The TDL4 bootkit introduces changes that result in <i>0x0000C428</i> instead of <i>0xC0000428</i> .  The new value is not an error code (in kernel mode, the most significant bit of error codes is usually set to 1).  Thus, the OS does not detect the replacement of the kdcom.dll library. <br><br>  The following illustration shows the code that fixes the ldr16 component in the winload.exe program on the fly: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/5f0/53e/96b/5f053e96b947080ce718e159f6361da7.jpg" alt="image"><br><br>  However, this new mechanism, as it turned out, does not work quite stably.  On some systems, the OS can detect changes and run a startup recovery, as shown in the following screenshot. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/149/0e9/b4e/1490e9b4ef01feda97ec685524f16ea0.png" alt="image"><br><br>  After a forced reboot, the system becomes completely unbootable. <br>  The second enhancement to the new TDL4 version concerned low-level, kernel-mode event handlers related to the storage device miniport driver object.  Previous versions of the malware captured a driver object belonging to the lowest-level device object in the storage stack, as shown in the following diagram: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/176/dbc/f09/176dbcf09ecd023b16834cad11921199.png" alt="image"><br><br>  In this case, you can quickly access the miniport device object (Hard drive PDO, hard disk PDO object) and then go through the list of adjacent device objects to get a pointer to the ‚Äúreal‚Äù hard disk miniport driver object.  In the new TDL4 version, the hard drive miniport driver object is masked in a more sophisticated way: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/d64/e92/943/d64e929434eccf1a844e383ea989d054.png" alt="image"><br>  In this case, the lowest-level device object in the storage stack is no longer the PDO object corresponding to the hard disk.  After such a change, it becomes much more difficult to detect and remove this malware.  ESET antivirus products detect the latest TDL4 dropper as Win32 / Olmarik.AMN, and all treatment procedures work correctly. <br><br>  In the previous generation TDL3, there <a href="http://habrahabr.ru/company/eset/blog/84957/">was</a> already a similar case, when an update from MS dropped infected systems into a blue screen. </div><p>Source: <a href="https://habr.com/ru/post/120261/">https://habr.com/ru/post/120261/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../120252/index.html">HTML5 Presentation</a></li>
<li><a href="../120254/index.html">Microsoft does not consider cookiejacking a serious threat.</a></li>
<li><a href="../120257/index.html">Hacking keys for money - estimate based on the Bitcoin network</a></li>
<li><a href="../120258/index.html">Device for replacing news in WiFi traffic</a></li>
<li><a href="../120259/index.html">Version Control with Bundler</a></li>
<li><a href="../120262/index.html">EasyPay: Payment of fines for traffic violations</a></li>
<li><a href="../120264/index.html">Google's learning rap</a></li>
<li><a href="../120265/index.html">Vulnerability in reCaptcha allows you to activate up to 30 actions on the same token</a></li>
<li><a href="../120266/index.html">DIY quadcopter: Part I</a></li>
<li><a href="../120267/index.html">Digest Wanted.VC # 4</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>