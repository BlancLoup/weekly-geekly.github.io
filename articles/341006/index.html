<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Super expressive code involving levels of abstractions</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="I bring to your attention the translation of the article Super expressive code 


 With this post, I want to suggest a technique for transforming obsc...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Super expressive code involving levels of abstractions</h1><div class="post__text post__text-html js-mediator-article"><p>  I bring to your attention the translation of the article <a href="https://www.fluentcpp.com/2017/01/03/super-expressive-code-by-raising-levels-of-abstraction/">Super expressive code</a> </p><br><p>  With this post, I want to suggest a technique for transforming obscure code into an elegant and expressive, based on levels of abstraction. </p><br><h2 id="problema">  Problem </h2><br><p>  Below is the problem code.  We will transform this inexpressive and incomprehensible code into a clear and elegant. </p><a name="habracut"></a><br><p>  A user of our app plans a trip through several cities in the country. </p><br><p>  He goes immediately from one city to another without stopping, if they are close enough (say, at a distance of up to 100 km), otherwise he makes exactly one stop between cities. </p><br><p>  Suppose we have a planned route in the form of a collection of cities. </p><br><p>  Our task is to calculate the required number of stops, saving time on the train. </p><br><p>  The application already has a class City, which describes the city on the route.  City provides its geographic attributes, among which is the location implemented by the Location class.  An object of the Location class can calculate the length of the route to any other Location object on the map. </p><br><pre><code class="cpp hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Location</span></span></span><span class="hljs-class"> {</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span>: <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">double</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">distanceTo</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> Location &amp;other)</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">const</span></span></span></span>; ... }; <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">GeographicalAttributes</span></span></span><span class="hljs-class"> {</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span>: <span class="hljs-function"><span class="hljs-function">Location </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getLocation</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">const</span></span></span></span>; ... }; <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">City</span></span></span><span class="hljs-class"> {</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span>: <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">const</span></span></span><span class="hljs-function"> GeographicalAttributes &amp;</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getGeographicalAttributes</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">const</span></span></span></span>; ... };</code> </pre> <br><p>  Now it is proposed to calculate the required number of stops that the user will have to make: </p><br><pre> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt;vector&gt; int computeNumberOfBreaks(const std::vector&lt;City&gt; &amp;route) { static const double MaxDistance = 100; int nbBreaks = 0; for (std::vector&lt;City&gt;::const_iterator it1 = route.begin(), it2 = route.end(); it1 != route.end(); it2 = it1, ++it1) { if (it2 != route.end()) { if(it1-&gt;getGeographicalAttributes().getLocation().distanceTo( it2-&gt;getGeographicalAttributes().getLocation()) &gt; MaxDistance) { ++nbBreaks; } } } return nbBreaks; }</span></span></span></span></code> </pre> <br><p>  You will surely agree that this piece of code is rather vague, and the average reader of this code will spend some time trying to understand what is happening in the code.  Unfortunately, this is a non-fictional example of what we can find in the code of a real application.  And if such code is located in a place that is often studied and changed, ambiguity becomes a real problem. </p><br><p>  Let's work on this piece of code and turn it into your asset. </p><br><h2 id="sozdayom-yasnyy-kod">  Create a clear code </h2><br><p>  Creating a clear code is one of the positive consequences of attracting levels of abstractions, which, I believe, is an important principle of good code design. </p><br><p>  In many cases, the non-use of levels of abstraction occurs where the code of the lower level is inserted among the code of the middle or high level.  In other words, the problem is the code that describes <strong>how the</strong> result is produced instead of <strong>what</strong> is being done.  To improve such code, we need to increase the level of abstractions. </p><br><p>  To do this, we can use the following technique: </p><br><p>  <em>Determine what things the code does and replace them with meaningful labels.</em> </p><br><p>  This will lead to a significant improvement in code clarity. </p><br><p>  The problem with the above code is that it does not tell what it means - this code is not clear.  Let's apply the above technique to improve the clarity of the code: let's determine what things the code does and mark each such thing. </p><br><p>  Let's start with the logic of the cycle. </p><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::<span class="hljs-built_in"><span class="hljs-built_in">vector</span></span>&lt;City&gt;::const_iterator it1 = route.begin(), it2 = route.end(); it1 != route.end(); it2 = it1, ++it1) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (it2 != route.end()) {</code> </pre> <br><p>  Perhaps you already know this technique used in the code.  This trick is used to manipulate adjacent items in the collection.  it1 starts at the beginning of the collection, it2 points to an element right in front of it1 as it goes through the entire unidirectional collection.  At the beginning, it2 is initialized by the end of the collection, then in the body of the loop it is checked that it2 no longer indicates the end of the collection, and in this case calculations are made. </p><br><p>  We could not immediately say that this code is understandable.  But after describing the trick, we can definitely say <strong>what</strong> he does: he performs <strong>manipulations</strong> with two adjacent elements at a time. </p><br><p>  Let's now consider another piece of code in the condition: </p><br><pre> <code class="cpp hljs">it1-&gt;getGeographicalAttributes().getLocation().distanceTo( it2-&gt;getGeographicalAttributes().getLocation()) &gt; MaxDistance</code> </pre> <br><p>  By itself, this code is quite easy to analyze and understand what it does.  It determines that the <strong>distance</strong> between the two cities <strong>is greater</strong> than MaxDistance. </p><br><p>  And finally, let's analyze the rest of the code, the nbBreaks variable: </p><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">int</span></span> nbBreaks = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (...) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(...) { ++nbBreaks; } } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> nbBreaks;</code> </pre> <br><p>  This code increments the variable each time the condition is met.  It calculates the <strong>number of</strong> times the <strong>condition has</strong> been met. </p><br><p>  As a result, we obtain such labels that describe what the function does: </p><br><ul><li>  <strong>Manipulations with</strong> related elements </li><li>  Determining that two cities are at a <strong>distance greater</strong> than MaxDistance, </li><li>  <strong>Number</strong> how many times the <strong>condition has</strong> been satisfied. </li></ul><br><p>  After the analysis is done, there is only one step left before turning the obscure code into expressive code. </p><br><p>  The technique consists in assigning a label to each entity implemented by the code and replacing the corresponding code with this label.  Here we do the following: </p><br><ul><li>  To manipulate adjacent elements, we can create a component, which we call <code>consecutive</code> , which transforms a collection of elements into a collection of pairs of elements, each pair will have an element from the initial collection and the element following it.  If the route route contains {A, B, C, D, E}, the <code>consecutive(route)</code> will create {(A, B), (B, C), (C, D), (D, E)}.  A similar adapter that creates pairs of adjacent elements has recently been added under the name of <a href="">sliding</a> into the popular <a href="https://github.com/ericniebler/range-v3">range-v3</a> library. </li><li>  To determine the distance between two cities MaxDistance, we can use a functional object (functor), let's call it FartherThan.  I know that starting with C ++ 11, functors can basically be replaced by lambda functions, but here we need to name the action.  To do this elegantly with the help of the lambda function, you need a little more work, which I will discuss in a separate post. <br><pre> <code class="cpp hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">FartherThan</span></span></span><span class="hljs-class"> {</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span>: <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">explicit</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">FartherThan</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">double</span></span></span></span><span class="hljs-function"><span class="hljs-params"> distance)</span></span></span><span class="hljs-function"> : </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">m_distance</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(distance)</span></span></span><span class="hljs-function"> </span></span>{} <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">bool</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">operator</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-built_in"><span class="hljs-function"><span class="hljs-params"><span class="hljs-built_in">std</span></span></span></span><span class="hljs-function"><span class="hljs-params">::pair&lt;City, City&gt; &amp;cities)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> cities.first.getGeographicalAttributes().getLocation().distanceTo( cities.second.getGeographicalAttributes().getLocation()) &gt; m_distance; } <span class="hljs-keyword"><span class="hljs-keyword">private</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">double</span></span> m_distance; };</code> </pre> </li><li>  To calculate the number of times the condition has been satisfied, we can use the count_if algorithm from STL. </li></ul><br><p>  This is what happens after replacing the code with tags: </p><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">computeNumberOfBreaks</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-built_in"><span class="hljs-function"><span class="hljs-params"><span class="hljs-built_in">std</span></span></span></span><span class="hljs-function"><span class="hljs-params">::</span></span><span class="hljs-built_in"><span class="hljs-function"><span class="hljs-params"><span class="hljs-built_in">vector</span></span></span></span><span class="hljs-function"><span class="hljs-params">&lt;City&gt;&amp; route)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">double</span></span> MaxDistance = <span class="hljs-number"><span class="hljs-number">100</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> count_if(consecutive(route), FartherThan(MaxDistance)); }</code> </pre> <br><p>  <em>(Note: count_if from STL takes two iterators from the beginning to the end of the collection. It uses the count_if wrapper over std :: count_if, which passes the beginning and end of the collection to the standard std :: count_if to C ++ 17.)</em> </p><br><p>  This code clearly shows <strong>what</strong> it does and does not mix levels of abstractions.  For this reason, it is much more expressive and clearer than the original code.  The original code only described <strong>how</strong> it does its work, and the rest of the understanding remained on the reader. </p><br><p>  This technique can be applied to many parts of obscure code in order to convert it to clear.  It can also be used for other programming languages.  The next time you stumble upon an obscure code that you want to refactor, try to identify the things the code does and give them names.  You will be amazed at the result achieved. </p></div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <p>Source: <a href="https://habr.com/ru/post/341006/">https://habr.com/ru/post/341006/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../340996/index.html">Building projects with GitLab CI: one .gitlab-ci.yml for hundreds of applications</a></li>
<li><a href="../340998/index.html">UI Solitaire: Making Your StackView in Android</a></li>
<li><a href="../341000/index.html">Digest of IT events for November</a></li>
<li><a href="../341002/index.html">Installing FlexLM on Ubuntu Server 16</a></li>
<li><a href="../341004/index.html">Computer predicted the victory of the United States in Vietnam</a></li>
<li><a href="../341008/index.html">Interview with Pavel Golubev (Appodeal) about publishers, monetization and advertising mediation</a></li>
<li><a href="../341014/index.html">Swift 4 - weak links</a></li>
<li><a href="../341016/index.html">[SOA] Service Oriented Ansible</a></li>
<li><a href="../341020/index.html">The first deployment: how was the DevOops 2017 conference</a></li>
<li><a href="../341022/index.html">1st laboratory work of the program Data Engineer</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>