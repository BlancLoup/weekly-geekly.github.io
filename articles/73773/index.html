<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Programming Magic: the Gathering - ¬ß2 Map</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Let's continue our discussion of programming Magic the Gathering . Today we will discuss how the object model of a particular map is formed. Since the...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Programming Magic: the Gathering - ¬ß2 Map</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/getpro/habr/post_images/bfe/077/5e8/bfe0775e84a6cd27d95ae2957a6e5287.jpg" align="right">  Let's continue our discussion of programming <a href="http://www.mymagic.ru/">Magic the Gathering</a> .  Today we will discuss how the object model of a particular map is formed.  Since the cards interact with all participants in the system (with players, other cards, etc.), we will also touch on the implementation of the basic card behavior.  As before, we will use the .Net ecosystem, although in the future (hint) we will see the use of unmanaged C ++.  Also, for examples we will use maps of the 8th and later editions. [ <a href="https://habr.com/ru/post/73773/" title="As far as I know, or rather, as the database tells me, the 8th edition is not Russified. At the moment, all examples of the implementation of maps are in English, but this does not mean that they cannot be Russified when the rules are fully implemented. The parser is still more convenient to write in English. there words do not lean.">1</a> ] <br><br>  Previous posts: <a href="http://habrahabr.ru/blogs/net/72721/">¬ß1</a> <br><br><a name="habracut"></a><br>  The entire M: tG ecosystem implements the Observer pattern, and in such an unpleasant manner that it would be absurd to talk about any ‚Äúdata binding‚Äù.  Therefore, when first considering the structure of the map, you can try to create a bare, anemic model. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
     <code><font color="black"><font color="#0000FF">public</font> <font color="#0000FF">class</font> Card <br> { <br> <font color="#0000FF">public</font> <font color="#0000FF">string</font> Name { get; set; } <br> <font color="#0000FF">public</font> Mana Cost { get; set; } <br> ‚ãÆ <br> <font color="#006400">//   </font> <br> } <br></font></code> <br>  Unfortunately, changing the map, we need to remember its initial state.  For example, <strong>Avatar of Hope is</strong> originally worth <img src="http://magicnoob.com/wp-content/themes/magicnoob/images/mtg-symbols/colorless_6.png"><img src="http://magicnoob.com/wp-content/themes/magicnoob/images/mtg-symbols/mana_white.png"><img src="http://magicnoob.com/wp-content/themes/magicnoob/images/mtg-symbols/mana_white.png">  but when you have 3 lives or less, it‚Äôs worth not <img src="http://magicnoob.com/wp-content/themes/magicnoob/images/mtg-symbols/colorless_6.png"><img src="http://magicnoob.com/wp-content/themes/magicnoob/images/mtg-symbols/mana_white.png"><img src="http://magicnoob.com/wp-content/themes/magicnoob/images/mtg-symbols/mana_white.png">  but just <img src="http://magicnoob.com/wp-content/themes/magicnoob/images/mtg-symbols/mana_white.png"><img src="http://magicnoob.com/wp-content/themes/magicnoob/images/mtg-symbols/mana_white.png">  .  Therefore, we have a <a href="http://ru.wikipedia.org/wiki/%25D0%2594%25D0%25B8%25D1%2585%25D0%25BE%25D1%2582%25D0%25BE%25D0%25BC%25D0%25B8%25D1%258F">dichotomy</a> - we need both a prototype (the initial value) and the real value ‚Äúin the game‚Äù.  And so for each property. <br><br>  In principle, we can divide this functional into two interrelated classes that will reflect these states: <br><br> <code><font color="black"><font color="#006400">//  </font> <br> <font color="#0000FF">class</font> Card <br> { <br> <font color="#0000FF">public</font> <font color="#0000FF">virtual</font> <font color="#0000FF">string</font> Name { get; set; } <br> ‚ãÆ <br> } <br> <br> <font color="#006400">//   ,    </font> <br> <font color="#0000FF">class</font> CardInPlay : Card <br> { <br> <font color="#0000FF">public</font> <font color="#0000FF">override</font> <font color="#0000FF">string</font> Name <br> { <br> ‚ãÆ <br> } <br> <font color="#0000FF">public</font> Card Prototype { get; set; } <br> <font color="#006400">//    "" </font> <br> <font color="#0000FF">public</font> CardInPlay(Card prototype) <br> { <br> Prototype = prototype; <font color="#006400">//   </font> <br> Name = prototype.Name; <font color="#006400">//    -    C#  AutoMapper :)</font> <br> ‚ãÆ <br> } <br> } <br></font></code> <br>  The <code>CardInPlay</code> class implements one of the variations of the Decorator pattern, in which one class inherits and aggregates another class at the same time. <br><br>  Having some idea of ‚Äã‚Äãthese two classes, let's consider different properties of maps and how they can be implemented. <br><br><h3>  Card name and problem √Ü </h3><br>  In principle, everything is clear with the name of the card - it is a string, it is saved, drawn on the screen, sometimes, of course, it can change (for example, during cloning), but basically it presents no problems. <br><br>  But there is a problem with databases that for some reason do not want to write the letter, using capital AE instead.  This is not a big problem, we just need to use <code>string.Replace()</code> when reading the card from the database. <br><br><h3>  Card price </h3><br>  We discussed mana in the last post.  The cost is described by standard notation, which is then parsed by the system.  There are several cost variations, in particular <br><br><ul><li>  Zero cost ( <img src="http://magicnoob.com/wp-content/themes/magicnoob/images/mtg-symbols/colorless_0.png">  ) </li><li>  Regular cost ( <img src="http://magicnoob.com/wp-content/themes/magicnoob/images/mtg-symbols/colorless_2.png"><img src="http://magicnoob.com/wp-content/themes/magicnoob/images/mtg-symbols/mana_green.png"><img src="http://magicnoob.com/wp-content/themes/magicnoob/images/mtg-symbols/white_black.png">  ) </li><li>  Cost as a function of something ( <img src="http://magicnoob.com/wp-content/themes/magicnoob/images/mtg-symbols/colorless_x.png"><img src="http://magicnoob.com/wp-content/themes/magicnoob/images/mtg-symbols/mana_green.png">  ) </li></ul><br>  The structure of <code>Mana</code> is suitable for all cases, because  she can count the number of one or another mana, and also supports the <code>HasX</code> property if the mane appears <img src="http://magicnoob.com/wp-content/themes/magicnoob/images/mtg-symbols/colorless_x.png">  [ <a href="https://habr.com/ru/post/73773/" title="In fact, there is an uncovered option when the cost, for example. We will solve this problem when it becomes relevant.">2</a> ] In fact, there are no problems reading the cost of using the card.  As for the cost of using the features, in addition to the mana itself, we have additional properties, such as <code>RequiresTap</code> .  We will discuss this further in the post. <br><br><h3>  Card type </h3><br><img src="https://habrastorage.org/getpro/habr/post_images/0b6/c74/444/0b6c74444be513ed6f5d08aaf2ced517.jpg" align="right">  The map on the right has a type, or rather three.  A type as a string can be written as ‚ÄúLegendary Creature - Wizard‚Äù, but since there are maps that <em>actively manipulate</em> types, we will also create a collection that can store a list of types - firstly, for quick searching, secondly, in order to add additional types there. <br><br><br><br> <code><font color="black"><font color="#0000FF">public</font> <font color="#0000FF">string</font> Type <br> { <br> get { <font color="#0000FF">return</font> type; } <br> set <br> { <br> <font color="#0000FF">if</font> (type != <font color="#0000FF">value</font> ) <br> { <br> type = <font color="#0000FF">value</font> ; <br> <font color="#006400">// create derived types</font> <br> types.Clear(); <br> <font color="#0000FF">string</font> [] parts = type.Split( <font color="#570000">' '</font> , <font color="#570000">'-'</font> , <font color="#570000">'‚Äì'</font> ); <br> <font color="#0000FF">foreach</font> ( <font color="#0000FF">var</font> part <font color="#0000FF">in</font> parts.Select(p =&gt; p.Trim()).Where(p =&gt; p.Length &gt; 0)) <br> { <br> types.Add(part); <br> } <br> } <br> } <br> } <br> <font color="#0000FF">private</font> ICollection&lt; <font color="#0000FF">string</font> &gt; types = <font color="#0000FF">new</font> HashSet&lt; <font color="#0000FF">string</font> &gt;(); <br> <font color="#0000FF">public</font> ICollection&lt; <font color="#0000FF">string</font> &gt; Types <br> { <br> get <br> { <br> <font color="#0000FF">return</font> types; <br> } <br> set <br> { <br> types = <font color="#0000FF">value</font> ; <br> } <br> } <br></font></code> <br>  Above is used <code>HashSet&lt;T&gt;</code> .  Card types can not be repeated.  Having such a set, we can, for example, create a property that checks whether the map is legendary or not. <br><br> <code><font color="black"><font color="#0000FF">public</font> <font color="#0000FF">bool</font> IsLegend <br> { <br> get <br> { <br> <font color="#0000FF">return</font> Types.Where(t =&gt; t.Contains( <font color="#570000">"Legend"</font> )).Any(); <br> } <br> } <br></font></code> <br><h3>  rules </h3><br>  While Arkanis is hanging close to us on the screen, let's take it as an example.  Arkanis has two activated abilities ("abilities").  Using all the benefits of OOP, we can again create an anemic model. <br><br> <code><font color="black"><font color="#0000FF">public</font> <font color="#0000FF">sealed</font> <font color="#0000FF">class</font> ActivatedAbility <br> { <br> <font color="#0000FF">public</font> <font color="#0000FF">string</font> Description { get; set; } <br> <font color="#0000FF">public</font> Mana Cost { get; set; } <br> <font color="#0000FF">public</font> <font color="#0000FF">bool</font> RequiresTap { get; set; } <br> <font color="#0000FF">public</font> Action&lt;Game, CardInPlay&gt; Effect { get; set; } <br> } <br></font></code> <br>  As you may have guessed, the card has a list of abilities, and in the game itself, the user can choose one of them. <br><br>  So, the ability has a text description, a cost, a checkbox that indicates whether the card should be rotated, and a delegate who determines what this ability does.  For Arkanis, his two abilities will look like this: <br><br><table><tbody><tr><td><img src="http://magicnoob.com/wp-content/themes/magicnoob/images/mtg-symbols/tap.png">  : Draw three cards. </td><td><img src="http://magicnoob.com/wp-content/themes/magicnoob/images/mtg-symbols/colorless_2.png"><img src="http://magicnoob.com/wp-content/themes/magicnoob/images/mtg-symbols/mana_blue.png"><img src="http://magicnoob.com/wp-content/themes/magicnoob/images/mtg-symbols/mana_blue.png">  : Return Arcanis Omnipotent to its owner's hand. </td></tr><tr><td><ul><li>  Description = <em>Draw three cards</em> </li><li>  Cost = <img src="http://magicnoob.com/wp-content/themes/magicnoob/images/mtg-symbols/colorless_0.png"></li><li>  RequiresTap = <code>true</code> </li><li>  Effect = <code>(game,card) =&gt; card.Owner.DrawCards(3)</code> </li></ul></td><td><ul><li>  Description = <em>Return Arcanis Omnipotent to its owner's hand.</em> </li><li>  Cost = <img src="http://magicnoob.com/wp-content/themes/magicnoob/images/mtg-symbols/colorless_2.png"><img src="http://magicnoob.com/wp-content/themes/magicnoob/images/mtg-symbols/mana_blue.png"><img src="http://magicnoob.com/wp-content/themes/magicnoob/images/mtg-symbols/mana_blue.png"></li><li>  RequiresTap = <code>false</code> </li><li>  Effect = <code>(game,card) =&gt; game.ReturnCardToOwnersHand(card)</code> </li></ul></td></tr></tbody></table><br><img src="https://habrastorage.org/getpro/habr/post_images/02f/9a8/f1f/02f9a8f1f54acadb08258ae85c24f814.jpg" align="right">  Abilities are not created magically.  They are read in text format, and parsed using regular regular expressions.  Using mana is also an activated ability.  In order to add it to the model, we use a fairly simple delegate. <br><br><br><br> <code><font color="black">Action&lt; <font color="#0000FF">string</font> &gt; addManaGeneratingAbility = <br> mana =&gt; c.ActivatedAbilities.Add( <font color="#0000FF">new</font> ActivatedAbility <br> { <br> Cost = 0, <br> RequiresTap = <font color="#0000FF">true</font> , <br> Effect = (game, card) =&gt; <br> game.CurrentPlayer.ManaPool.Add(Mana.Parse(mana)), <br> Description = <font color="#570000">"Tap to add "</font> + mana + <font color="#570000">" to your mana pool."</font> <br> }); <br></font></code> <br>  Now, in order to realize, say, a double land like <strong>Shivan Oasis</strong> , you just need to find the appropriate text in the map rules and add the appropriate abilities. <br><br> <code><font color="black">Match m = Regex.Match(c.Text, <br> <font color="#570000">"{Tap}: Add {(.)} or {(.)} to your mana pool."</font> ); <br> <font color="#0000FF">if</font> (m.Success) <br> { <br> addManaGeneratingAbility(m.Groups[1].Value); <br> addManaGeneratingAbility(m.Groups[2].Value); <br> } <br></font></code> <br><h3>  Strength and health </h3><br>  It would be simple if the cards had only numerical values ‚Äã‚Äãfor the strength and health of the card.  Then, they could be made <code>Nullable&lt;int&gt;</code> and everything would be laced.  In fact, in the prototype may appear such values ‚Äã‚Äãas, for example, <code>*/*</code> .  Of course, in most cases, we just parse the values, but in addition to the fixed values, we have derivatives. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/01d/827/4ca/01d8274ca7415f5df7fcd5e12df4ec6d.jpg" align="right">  This in turn means that we have <code>Power</code> and <code>Toughness</code> override properties that consider derived values.  For example, for a <strong>Mortivore</strong> map, the structures look like this: <br><br><br><br> <code><font color="black"><font color="#0000FF">class</font> Card <br> { <br> <font color="#0000FF">public</font> Card() <br> { <br> ‚ãÆ <br> GetPower = (game, card) =&gt; card.Power; <br> GetToughness = (game, card) =&gt; card.Toughness; <br> } <br> ‚ãÆ <br> <font color="#006400">//  */*</font> <br> <font color="#0000FF">public</font> <strong><font color="#0000FF">string</font></strong> PowerAndToughness { get; set; } <br> <font color="#006400">//    (  )</font> <br> <font color="#0000FF">public</font> <font color="#0000FF">virtual</font> <font color="#0000FF">int</font> Power { get; set; } <br> <font color="#0000FF">public</font> <font color="#0000FF">virtual</font> <font color="#0000FF">int</font> Toughness { get; set; } <br> <font color="#006400">//     </font> <br> <font color="#0000FF">public</font> Func&lt;Game, CardInPlay, <font color="#0000FF">int</font> &gt; GetPower { get; set; } <br> <font color="#0000FF">public</font> Func&lt;Game, CardInPlay, <font color="#0000FF">int</font> &gt; GetToughness { get; set; } <br> } <br></font></code> <br>  Now, to create map properties we can use <code>Regex</code> s. <br><br> <code><font color="black">m = Regex.Match(c.Text, c.Name + <font color="#570000">"'s power and toughness are each equal to (.+)."</font> ); <br> <font color="#0000FF">if</font> (m.Success) <br> { <br> <font color="#0000FF">switch</font> (m.Groups[1].Value) <br> { <br> <font color="#0000FF">case</font> <font color="#570000">"the number of creature cards in all graveyards"</font> : <br> c.GetPower = c.GetToughness = (game,card) =&gt; <br> game.Players.Select(p =&gt; p.Graveyard.Count(cc =&gt; cc.IsCreature)).Sum(); <br> <font color="#0000FF">break</font> ; <br> } <br> } <br></font></code> <br><h3>  Conclusion </h3><br>  In this post, I briefly described what the object model of maps looks like.  I deliberately left all the meta-program delights ‚Äúoverboard‚Äù because with them the material would be less readable.  I can only hint that some of the repetitive aspects of the implementation of the Decorator pattern are too laborious - they need to either be <a href="http://www.codeproject.com/KB/codegen/decorators.aspx">automated</a> or use advanced languages ‚Äã‚Äãlike Boo. <br><br>  To be continued! <br><br><h3>  Notes </h3><br><ol><li>  <a href="https://habr.com/ru/post/73773/" title="Back to text">‚Üë</a> As far as I know, or rather, as far as the <a href="http://gatherer.wizards.com/">database</a> tells me, the 8th edition is not Russified.  At the moment, all examples of the implementation of maps are in English, but this does not mean that they cannot be Russified when the rules are fully implemented.  The parser is still more convenient to write in English.  there words do not lean. </li><li>  <a href="https://habr.com/ru/post/73773/" title="Back to text">‚Üë</a> In fact, there is an uncovered option when the cost, for example <img src="http://magicnoob.com/wp-content/themes/magicnoob/images/mtg-symbols/colorless_x.png"><img src="http://magicnoob.com/wp-content/themes/magicnoob/images/mtg-symbols/colorless_x.png">  .  We will solve this problem when it becomes relevant. </li></ol></div><p>Source: <a href="https://habr.com/ru/post/73773/">https://habr.com/ru/post/73773/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../73762/index.html">Elecom Magnetic Card Reader - Card Reader with Magnet</a></li>
<li><a href="../73765/index.html">Mitsubishi announced a 23-inch high-speed IPS-monitor</a></li>
<li><a href="../73766/index.html">Development Center S + S Russia</a></li>
<li><a href="../73771/index.html">Small but very convenient hint for MS Outlook</a></li>
<li><a href="../73772/index.html">50 years of space exploration</a></li>
<li><a href="../73774/index.html">Search C # and C ++ for Habrahabr</a></li>
<li><a href="../73775/index.html">Computer terminology in the Ukrainian language</a></li>
<li><a href="../73776/index.html">The Berlin Twitter Wall</a></li>
<li><a href="../73783/index.html">Why I don't like Web 2.0</a></li>
<li><a href="../73788/index.html">Split Subversion repository into parts</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>