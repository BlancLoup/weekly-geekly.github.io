<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Additional security software for NAS</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="The series of articles is named ‚ÄúBuilding a Secure NAS‚Äù . Therefore, this article will be considered an increase in the level of security. Also, those...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Additional security software for NAS</h1><div class="post__text post__text-html js-mediator-article"><p><img src="https://habrastorage.org/webt/39/ch/xl/39chxldtklziggqygx3wgmom0ky.png"></p><br><p>  The series of articles is named <a href="https://habr.com/post/359346/">‚ÄúBuilding a Secure NAS‚Äù</a> .  Therefore, this article will be considered an increase in the level of security.  Also, those tools that I did not use will be described, but it is possible to apply. </p><a name="habracut"></a><br><h2 id="kto-i-kak">  Who and how? </h2><br><p>  Who is going to attack the system and how will it do it? </p><br><p>  This is usually the first question to be answered before talking about security. <br>  At least, in the case of NAS, there is already an implicit answer.  But in order to fully answer this question, build a threat model and a model of the offender. </p><br><p>  Companies include the threat modeling phase in their development cycles. <br>  Microsoft has <a href="https://ru.wikipedia.org/wiki/Security_Development_Lifecycle">SDL</a> for this, people <a href="https://www.owasp.org/index.php/OWASP_SAMM_Project">have other models</a> . </p><br><p>  They involve the use of certain techniques, such as <a href="https://en.wikipedia.org/wiki/STRIDE_(security)">STRIDE</a> or <a href="https://en.wikipedia.org/wiki/DREAD_(risk_assessment_model)">DREAD</a> (STRIDE is still more general and well supported instrumentally). </p><br><p>  In STRIDE, for example, a model is built from data streams and is usually large, heavy, and poorly understood.  However, the tool provides a list of potential threats, which facilitates their consideration. </p><br><p>  The threat model is non-public information because it makes it easier for an attacker to analyze the system and search for weak points.  If he gets a model, he will not have to build it on his own, because analysts have already taken care of everything. </p><br><p>  <strong>It was a moment of advertising.</strong> </p><br><p><img src="https://habrastorage.org/webt/w4/ye/cz/w4yeczwns0wzroeq-ufxttf9yhm.jpeg"></p><br><p>  So build a model of serious companies.  And if this is interesting, I can somehow describe in a separate article. </p><br><p>  Here I will describe what is in English called <a href="https://en.wikipedia.org/wiki/Hardening_(computing)">"hardening"</a> and will deal with the security flaws that were made in the process of building the system. </p><br><p>  Basically, maintaining security at this level is accomplished by closing known system vulnerabilities, monitoring it, and periodically checking it. </p><br><h2 id="literatura-po-teme">  Related Literature </h2><br><p>  What to read: </p><br><ul><li>  It is worth starting with <a href="https://github.com/hardenedlinux">the Hardened Linux project</a> , where those who wish can find a <a href="https://github.com/hardenedlinux/Debian-GNU-Linux-Profiles">lot of useful information</a> . </li><li>  The harden-doc package contains the <a href="https://www.debian.org/doc/manuals/securing-debian-howto/index.en.html">Securing Debian Manual of the</a> old 2012, but running does not interfere with understanding the issue. </li><li>  Then, read the <a href="https://gist.github.com/vivianspencer/bc86e2765fc4df09795e">Debian 8 Hardening Quick Start Guide</a> . </li><li>  And finally, a <a href="https://wiki.debian.org/HardeningWalkthrough">little tutorial on Hardening deb packages</a> and <a href="https://wiki.debian.org/Hardening">C / C ++ code</a> , which you probably won't need. </li></ul><br><h2 id="snapshoty-i-doker">  Snapshots and docker </h2><br><p>  Previously, zfs-autosnapshot was installed.  He repeatedly helped me, because  I could restore corrupted configurations (for Nextcloud, for example) from snapshots. <br>  However, over time, the system began to slow down, and a few thousand snapshots. </p><br><p> It <code>com.sun:auto-snapshot=false</code> out that when creating the parent file system for containers, I forgot to set the <code>com.sun:auto-snapshot=false</code> flag <code>com.sun:auto-snapshot=false</code> . </p><br><p>  In the <a href="https://habr.com/post/415779/">original article,</a> this problem has already been fixed, here I will show how to get rid of unnecessary snapshots. </p><br><div class="spoiler">  <b class="spoiler_title">More on how to fix the error.</b> <div class="spoiler_text"><p>  First you need to turn off zfs-auto-snapshot on the docker‚Äôs parent file system: </p><br><pre> <code class="plaintext hljs">zfs set com.sun:auto-snapshot=false tank0/docker/lib</code> </pre> <br><p>  Now delete unused containers and images: </p><br><pre> <code class="plaintext hljs">docker container prune docker image prune</code> </pre> <br><p>  Remove snapshots: </p><br><pre> <code class="plaintext hljs">zfs list -t snapshot -o name -S creation | grep -e ".*docker/lib.*@zfs-auto-snap" | tail -n +1500 | xargs -n 1 zfs destroy -vr</code> </pre> <br><p>  And turn them off on all image file systems: </p><br><pre> <code class="plaintext hljs">zfs list -t filesystem -o name -S creation | grep -e "tank0/docker/lib" | xargs -n 1 zfs set com.sun:auto-snapshot=false</code> </pre> <br><p>  More details can be read <a href="https://www.1stbyte.com/2012/11/24/exclude-zfs-filesystems-from-zfs-auto-snapshot-on-ubuntu-and-remove-them/">here</a> . </p></div></div><br><h2 id="ldap">  Ldap </h2><br><p>  Last time, only one LDAP user was created with an administrative role. </p><br><p>  But most services do not need to change anything in the user database.  Therefore, it would be nice to add a user only for reading.  In order not to create roles manually, it is possible to use the container initialization script. </p><br><p>  First, add the settings to enable the read-only user in <code>docker-compose.yml</code> : </p><br><pre> <code class="plaintext hljs">- "LDAP_READONLY_USER=true" - "LDAP_READONLY_USER_USERNAME=readonly" - "LDAP_READONLY_USER_PASSWORD=READONLY_PASSWORD"</code> </pre> <br><p>  Full file under the spoiler. </p><br><div class="spoiler">  <b class="spoiler_title">docker-compose.yml</b> <div class="spoiler_text"><pre> <code class="plaintext hljs">version: "2" networks: ldap: docker0: external: name: docker0 services: open-ldap: image: "osixia/openldap" hostname: "open-ldap" restart: always environment: - "LDAP_ORGANISATION=NAS" - "LDAP_DOMAIN=nas.nas" - "LDAP_ADMIN_PASSWORD=ADMIN_PASSWORD" - "LDAP_CONFIG_PASSWORD=CONFIG_PASSWORD" - "LDAP_READONLY_USER=true" - "LDAP_READONLY_USER_USERNAME=readonly" - "LDAP_READONLY_USER_PASSWORD=READONLY_PASSWORD" - "LDAP_TLS=true" - "LDAP_TLS_ENFORCE=false" - "LDAP_TLS_CRT_FILENAME=ldap_server.crt" - "LDAP_TLS_KEY_FILENAME=ldap_server.key" - "LDAP_TLS_CA_CRT_FILENAME=ldap_server.crt" volumes: - ./certs:/container/service/slapd/assets/certs - ./ldap_data/var/lib:/var/lib/ldap - ./ldap_data/etc/ldap/slapd.d:/etc/ldap/slapd.d networks: - ldap ports: - 172.21.0.1:389:389 - 172.21.0.1:636:636 phpldapadmin: image: "osixia/phpldapadmin:0.7.1" hostname: "nas.nas" restart: always networks: - ldap - docker0 expose: - 443 links: - open-ldap:open-ldap-server volumes: - ./certs:/container/service/phpldapadmin/assets/apache2/certs environment: - VIRTUAL_HOST=ldap.* - VIRTUAL_PORT=443 - VIRTUAL_PROTO=https - CERT_NAME=NAS.cloudns.cc - "PHPLDAPADMIN_LDAP_HOSTS=open-ldap-server" #- "PHPLDAPADMIN_HTTPS=false" - "PHPLDAPADMIN_HTTPS_CRT_FILENAME=certs/ldap_server.crt" - "PHPLDAPADMIN_HTTPS_KEY_FILENAME=private/ldap_server.key" - "PHPLDAPADMIN_HTTPS_CA_CRT_FILENAME=certs/ldap_server.crt" - "PHPLDAPADMIN_LDAP_CLIENT_TLS_REQCERT=allow" ldap-ssp: image: openfrontier/ldap-ssp:https volumes: - /etc/ssl/certs/ssl-cert-snakeoil.pem:/etc/ssl/certs/ssl-cert-snakeoil.pem - /etc/ssl/private/ssl-cert-snakeoil.key:/etc/ssl/private/ssl-cert-snakeoil.key restart: always networks: - ldap - docker0 expose: - 80 links: - open-ldap:open-ldap-server environment: - VIRTUAL_HOST=ssp.* - VIRTUAL_PORT=80 - VIRTUAL_PROTO=http - CERT_NAME=NAS.cloudns.cc - "LDAP_URL=ldap://open-ldap-server:389" - "LDAP_BINDDN=cn=admin,dc=nas,dc=nas" - "LDAP_BINDPW=ADMIN_PASSWORD" - "LDAP_BASE=ou=users,dc=nas,dc=nas" - "MAIL_FROM=admin@nas.nas" - "PWD_MIN_LENGTH=8" - "PWD_MIN_LOWER=3" - "PWD_MIN_DIGIT=2" - "SMTP_HOST=" - "SMTP_USER=" - "SMTP_PASS="</code> </pre> </div></div><br><p>  Then, you need to make a dump and delete: </p><br><pre> <code class="plaintext hljs">$ cd /tank0/docker/services/ldap $ tar czf ~/ldap_backup.tgz . $ ldapsearch -Wx -D "cn=admin,dc=nas,dc=nas" -b "dc=nas,dc=nas" -H ldap://172.21.0.1 -LLL &gt; ldap_dump.ldif $ docker-compose down $ rm -rf ldap_data $ docker-compose up -d</code> </pre> <br><p>  So that the server, when recovering from the dump, does not swear at duplicate elements, in the file you need to delete the lines: </p><br><pre> <code class="plaintext hljs">dn: dc=nas,dc=nas objectClass: top objectClass: dcObject objectClass: organization o: NAS dc: nas dn: cn=admin,dc=nas,dc=nas objectClass: simpleSecurityObject objectClass: organizationalRole cn: admin description: LDAP administrator userPassword:: PASSWORD_BASE64</code> </pre><br><p>  And restore users and groups: </p><br><pre> <code class="plaintext hljs">$ ldapadd -Wx -D "cn=admin,dc=nas,dc=nas" -H ldap://172.21.0.1 -f ldap_dump.ldif</code> </pre> <br><p>  Such a beast will appear in the database: </p><br><pre> <code class="plaintext hljs">dn: cn=readonly,dc=nas,dc=nas cn: readonly objectClass: simpleSecurityObject objectClass: organizationalRole userPassword:: PASSWORD_BASE64 description: LDAP read only user</code> </pre> <br><p>  Roles in the LDAP server configuration for it will be created by the container. <br>  Perform post-restore checks and delete the backup: </p><br><pre> <code class="plaintext hljs">$ rm ~/ldap_backup.tgz</code> </pre> <br><h3 id="dobavlenie-grupp-v-ldap">  Adding groups to LDAP </h3><br><p>  Convenient is the division of LDAP users into groups similar to POSIX groups in Linux. <br>  For example, it is possible to create groups whose users will have access to repositories, access to the cloud, or access to the library. </p><br><p>  Groups are easily added to phpLDAPAdmin, and I will not focus on this. </p><br><p>  I note only the following: </p><br><ul><li>  The group is created from the "Default" template.  This is <strong>not a POSIX</strong> group, but a group of names. </li><li>  Accordingly, the group has an <code>objectClass</code> attribute, which includes the value <code>groupOfUniqueNames</code> . </li></ul><br><p> <a href=""><img src="https://habrastorage.org/webt/tx/i8/yj/txi8yjxxtbvlzynr1yttkn-ddgc.png" alt="Adding a group to phpLDAPAdmin"></a> </p><br><h2 id="docker">  Docker </h2><br><p>  In Docker, almost everything is done for you. <br>  By default, it uses <a href="https://docs.docker.com/engine/security/seccomp">the system call restriction</a> that is enabled in the OMV core: </p><br><pre> <code class="plaintext hljs"># grep SECCOMP /boot/config-4.16.0-0.bpo.2-amd64 CONFIG_HAVE_ARCH_SECCOMP_FILTER=y CONFIG_SECCOMP_FILTER=y CONFIG_SECCOMP=y</code> </pre> <br><p>  <a href="https://docs.docker.com/engine/security/security/">Here</a> it is possible to read a little more about the basic Docker security rules. <br>  Also, if AppArmor is enabled, Docker can integrate with it and <a href="https://docs.docker.com/engine/security/apparmor">forward its profiles to the container</a> . </p><br><h2 id="set">  Network </h2><br><h3 id="ustranenie-vozmozhnosti-obnaruzheniya-os">  Eliminate OS detection </h3><br><p>  The network is located behind the router, but it is possible to do a curious exercise by changing some parameters of the network stack so that the OS cannot be identified by the answers. <br>  There is little real benefit from this, because the attacker will study the banners of the services and anyway understand what kind of OS you are using. </p><br><div class="spoiler">  <b class="spoiler_title">Nmap shows which OS is running on the device.</b> <div class="spoiler_text"><pre> <code class="plaintext hljs"># nmap -O localhost Starting Nmap 7.40 ( https://nmap.org ) at 2018-08-26 14:39 MSK Nmap scan report for localhost (127.0.0.1) Host is up (0.000015s latency). Other addresses for localhost (not scanned): ::1 Not shown: 992 closed ports PORT STATE SERVICE 53/tcp open domain 80/tcp open http 443/tcp open https 5432/tcp open postgresql Device type: general purpose Running: Linux 3.X|4.X OS CPE: cpe:/o:linux:linux_kernel:3 cpe:/o:linux:linux_kernel:4 OS details: Linux 3.8 - 4.6 Network Distance: 0 hops OS detection performed. Please report any incorrect results at https://nmap.org/submit/ . Nmap done: 1 IP address (1 host up) scanned in 4.07 seconds</code> </pre> </div></div><br><p>  Loading settings from sysctl.conf: </p><br><pre> <code class="plaintext hljs"># sysctl -p /etc/sysctl.conf net.ipv4.conf.all.accept_redirects = 0 net.ipv6.conf.all.accept_redirects = 0 net.ipv4.conf.all.send_redirects = 0 net.ipv4.conf.all.accept_source_route = 0 net.ipv6.conf.all.accept_source_route = 0 net.ipv4.tcp_rfc1337 = 1 net.ipv4.ip_default_ttl = 128 net.ipv4.icmp_ratelimit = 900 net.ipv4.tcp_synack_retries = 7 net.ipv4.tcp_syn_retries = 7 net.ipv4.tcp_window_scaling = 1 net.ipv4.tcp_timestamps = 1</code> </pre> <br><p>  And so... </p><br><div class="spoiler">  <b class="spoiler_title">Nmap cannot determine the OS.</b> <div class="spoiler_text"><pre> <code class="plaintext hljs"># nmap -O localhost Starting Nmap 7.40 ( https://nmap.org ) at 2018-08-26 14:40 MSK Nmap scan report for localhost (127.0.0.1) Host is up (0.000026s latency). Other addresses for localhost (not scanned): ::1 Not shown: 992 closed ports PORT STATE SERVICE 53/tcp open domain 80/tcp open http 443/tcp open https 5432/tcp open postgresql No exact OS matches for host (If you know what OS is running on it, see https://nmap.org/submit/ ). TCP/IP fingerprint: OS:SCAN(V=7.40%E=4%D=8/26%OT=53%CT=1%CU=43022%PV=N%DS=0%DC=L%G=Y%TM=5B8291C OS:3%P=x86_64-pc-linux-gnu)SEQ(SP=FA%GCD=1%ISR=105%TI=Z%CI=I%TS=8)OPS(O1=MF OS:FD7ST11NW7%O2=MFFD7ST11NW7%O3=MFFD7NNT11NW7%O4=MFFD7ST11NW7%O5=MFFD7ST11 OS:NW7%O6=MFFD7ST11)WIN(W1=AAAA%W2=AAAA%W3=AAAA%W4=AAAA%W5=AAAA%W6=AAAA)ECN OS:(R=Y%DF=Y%T=80%W=AAAA%O=MFFD7NNSNW7%CC=Y%Q=)T1(R=Y%DF=Y%T=80%S=O%A=S+%F= OS:AS%RD=0%Q=)T2(R=N)T3(R=N)T4(R=Y%DF=Y%T=80%W=0%S=A%A=Z%F=R%O=%RD=0%Q=)T5( OS:R=Y%DF=Y%T=80%W=0%S=Z%A=S+%F=AR%O=%RD=0%Q=)T6(R=Y%DF=Y%T=80%W=0%S=A%A=Z% OS:F=R%O=%RD=0%Q=)T7(R=Y%DF=Y%T=80%W=0%S=Z%A=S+%F=AR%O=%RD=0%Q=)U1(R=Y%DF=N OS:%T=80%IPL=164%UN=0%RIPL=G%RID=G%RIPCK=G%RUCK=G%RUD=G)IE(R=Y%DFI=N%T=80%C OS:D=S) Network Distance: 0 hops OS detection performed. Please report any incorrect results at https://nmap.org/submit/ . Nmap done: 1 IP address (1 host up) scanned in 19.52 seconds</code> </pre> </div></div><br><p>  These settings are required in <code>/etc/sysctl.conf</code> , then each time they are rebooted, they will be read automatically. </p><br><div class="spoiler">  <b class="spoiler_title">Full /etc/sysctl.conf</b> <div class="spoiler_text"><pre> <code class="plaintext hljs">################################################################### # Additional settings - these settings can improve the network # security of the host and prevent against some network attacks # including spoofing attacks and man in the middle attacks through # redirection. Some network environments, however, require that these # settings are disabled so review and enable them as needed. # # Do not accept ICMP redirects (prevent MITM attacks) net.ipv4.conf.default.accept_redirects = 0 net.ipv6.conf.default.accept_redirects = 0 net.ipv4.conf.all.accept_redirects = 0 net.ipv6.conf.all.accept_redirects = 0 # _or_ # Accept ICMP redirects only for gateways listed in our default # gateway list (enabled by default) # net.ipv4.conf.all.secure_redirects = 1 # # Do not send ICMP redirects (we are not a router) net.ipv4.conf.all.send_redirects = 0 # # Do not accept IP source route packets (we are not a router) net.ipv4.conf.all.accept_source_route = 0 net.ipv6.conf.all.accept_source_route = 0 ## protect against tcp time-wait assassination hazards ## drop RST packets for sockets in the time-wait state ## (not widely supported outside of linux, but conforms to RFC) net.ipv4.tcp_rfc1337 = 1 # # Log Martian Packets #net.ipv4.conf.all.log_martians = 1 # ################################################################### # Magic system request Key # 0=disable, 1=enable all # Debian kernels have this set to 0 (disable the key) # See https://www.kernel.org/doc/Documentation/sysrq.txt # for what other values do #kernel.sysrq=1 ################################################################### # Protected links # # Protects against creating or following links under certain conditions # Debian kernels have both set to 1 (restricted) # See https://www.kernel.org/doc/Documentation/sysctl/fs.txt #fs.protected_hardlinks=0 #fs.protected_symlinks=0 vm.overcommit_memory = 1 vm.swappiness = 10 ################################################################### # Anti-fingerprinting. # # Def: 64. net.ipv4.ip_default_ttl = 128 #   ICMP  (  1000) net.ipv4.icmp_ratelimit = 900 #    ,     . # Def: 5. net.ipv4.tcp_synack_retries = 7 # Def: 5. net.ipv4.tcp_syn_retries = 7 #   TCP window  timespamp    1323. net.ipv4.tcp_window_scaling = 1 net.ipv4.tcp_timestamps = 1 # Redis requirement. net.core.somaxconn = 511</code> </pre> </div></div><br><p>  Protection against defining versions of services is more useful, for which an attacker can also use Nmap: </p><br><pre> <code class="plaintext hljs"># nmap -sV -sR --allports --version-trace 127.0.0.1</code> </pre> <br><div class="spoiler">  <b class="spoiler_title">The result is not very good for the system.</b> <div class="spoiler_text"><pre> <code class="plaintext hljs">Not shown: 991 closed ports PORT STATE SERVICE VERSION 22/tcp open ssh OpenSSH 7.4p1 Debian 10+deb9u3 (protocol 2.0) 25/tcp open smtp Postfix smtpd 80/tcp open http nginx 1.13.12 111/tcp open rpcbind 2-4 (RPC #100000) 139/tcp open netbios-ssn Samba smbd 3.X - 4.X (workgroup: WORKGROUP) 443/tcp open ssl/http nginx 1.13.12 445/tcp open netbios-ssn Samba smbd 3.X - 4.X (workgroup: WORKGROUP) 3493/tcp open nut Network UPS Tools upsd 8000/tcp open http Icecast streaming media server 2.4.2 Service Info: Hosts: nas.localdomain, NAS; OS: Linux; CPE: cpe:/o:linux:linux_kernel Final times for host: srtt: 22 rttvar: 1 to: 100000</code> </pre> </div></div><br><p>  But not everything is smooth with disguise: </p><br><ul><li>  For each service an individual approach is needed here. </li><li>  It is not always possible to remove the version. </li></ul><br><p>  For example, for SSH, it is possible to add the <code>DebianBanner no</code> option in <code>/etc/ssh/sshd_confg</code> . </p><br><p>  As a result: </p><br><pre> <code class="plaintext hljs">22/tcp open ssh OpenSSH 7.4p1 (protocol 2.0)</code> </pre> <br><p>  Better, alas, will not work: the version is used by SSH to establish which features are supported, and it is possible to change it only by <a href="https://superuser.com/questions/782382/hide-ssh-version">patching the server</a> . </p><br><h3 id="port-knocking">  Port-knocking </h3><br><p>  Not the most well-known protection technique that allows a remote user who knows the secret to connect to a closed port. <br>  <a href="https://en.wikipedia.org/wiki/Port_knocking">The work resembles a code lock</a> : everyone knows that service daemons are running on the server, but "they are not there" until the code is dialed. <br>  For example, in order to connect to an SSH server, a user needs to tap on ports UDP 7000, TCP 7007, and UDP 7777. <br>  After that, with its IP firewall will be allowed on the <strong>closed</strong> TCP port 22. </p><br><p>  Read more about how this works, it is possible to read <a href="https://habr.com/post/179219/">here</a> .  And <a href="https://www.cyberciti.biz/faq/debian-ubuntu-linux-iptables-knockd-port-knocking-tutorial/">in the Debian manual</a> . </p><br><p>  I do not recommend using, because  fail2ban is usually sufficient. </p><br><h3 id="fayrvoll">  Firewall </h3><br><p>  I configure the firewall via OpenMediaVault Web GUI, which I recommend to you. </p><br><p> <a href=""><img src="https://habrastorage.org/webt/cv/a9/eo/cva9eoxcbu4h8ut8cwrwczkjop8.png"></a> </p><br><p>  Open the necessary ports, such as 443 and 22, the rest - to taste.  Also, it is advisable to enable logging of dropped packets. </p><br><h3 id="ssh">  Ssh </h3><br><div class="spoiler">  <b class="spoiler_title">If SSH hangs on port 22, which is open on the Internet, you will receive many interesting messages ...</b> <div class="spoiler_text"><pre> <code class="plaintext hljs"># grep "invalid user" /var/log/auth.log|head Aug 26 00:07:57 nas sshd[29786]: input_userauth_request: invalid user test [preauth] Aug 26 00:07:59 nas sshd[29786]: Failed password for invalid user test from 185.143.160.137 port 51268 ssh2 Aug 26 00:11:01 nas sshd[5641]: input_userauth_request: invalid user 0 [preauth] Aug 26 00:11:01 nas sshd[5641]: Failed none for invalid user 0 from 5.188.10.180 port 49025 ssh2 Aug 26 00:11:04 nas sshd[5644]: input_userauth_request: invalid user 0101 [preauth] Aug 26 00:11:06 nas sshd[5644]: Failed password for invalid user 0101 from 5.188.10.180 port 59867 ssh2 Aug 26 00:32:55 nas sshd[20367]: input_userauth_request: invalid user ftp [preauth] Aug 26 00:32:56 nas sshd[20367]: Failed password for invalid user ftp from 5.188.10.144 port 47981 ssh2 Aug 26 00:32:57 nas sshd[20495]: input_userauth_request: invalid user guest [preauth] Aug 26 00:32:59 nas sshd[20495]: Failed password for invalid user guest from 5.188.10.144 port 34202 ssh2</code> </pre> </div></div><br><p>  At the risk of appearing banal, I‚Äôll remind you what is required: </p><br><ul><li>  Strictly prohibit logging in as root. </li><li>  Restrict access to specified users only. </li><li>  Change port to non-standard. </li><li>  It is advisable to disable password authentication, leaving only the key. </li></ul><br><p>  Read more is possible, for example <a href="https://www.cyberciti.biz/tips/linux-unix-bsd-openssh-server-best-practices.html">here</a> . </p><br><p>  All this is easily done from the OpenMediaVault interface via the menu "Services -&gt; SSH". <br>  Except for the fact that I did not change the port to a non-standard one, leaving 22 in the local network, and simply replacing the port in the NAT router. </p><br><div class="spoiler">  <b class="spoiler_title">I compiled such an interesting list of enumerated accounts until I changed the SSHD port to a different one from 22.</b> <div class="spoiler_text"><pre> <code class="plaintext hljs"># grep "invalid user" /var/log/auth.log|sed 's/.*invalid user \([^ ]*\) .*/\1/'|sort|uniq 0 0101 1234 22 admin ADMIN administrateur administrator admins alfred amanda amber Anonymous apache avahi backup@network bcnas benjamin bin cacti callcenter camera cang castis charlotte clamav client cristina cron CSG cvsuser cyrus david db2inst1 debian debug default denis elvira erik fabio fax ftp ftpuser gary gast GEN2 guest I2b2workdata2 incoming jboss john juan matilda max mia miner muhammad mysql nagios nginx noc office oliver operator oracle osmc pavel pi pmd postgres PROCAL prueba RSCS sales sales1 scaner selena student07 sunos support sybase sysadmin teamspeak telecomadmin test test1 test2 test3 test7 tirocu token tomcat tplink ubnt ubuntu user1 vagrant victor volition www-data xghwzp xxx zabbix zimbra</code> </pre> </div></div><br><p>  Once this is done, unauthorized entry attempts will be made much less frequently. </p><br><p>  To further improve the situation, it is possible to block attackers from certain IPs after several attempts at entry. </p><br><p>  What can be used for: </p><br><ul><li>  <a href="https://www.fail2ban.org/">Fail2ban</a> .  A popular utility that works not only for SSH, but also for many other applications. </li><li>  <a href="http://denyhosts.sourceforge.net/">Denyhosts</a> .  Looks like fail2ban. </li><li>  <a href="https://www.sshguard.net/">Sshguard</a> , if you wish, you can try to use it, but I was not interested in them in detail. </li></ul><br><p>  I am using fail2ban.  It will monitor the logs for various unwanted actions by certain IPs, and ban them if the number of triggers is exceeded: </p><br><div class="spoiler">  <b class="spoiler_title">/var/log/fail2ban.log.</b> <div class="spoiler_text"><pre> <code class="plaintext hljs">2018-08-29 21:17:25,351 fail2ban.filter [8650]: INFO [sshd] Found 5.188.10.144 2018-08-29 21:17:25,473 fail2ban.actions [8650]: NOTICE [sshd] Ban 5.188.10.144 2018-08-29 21:17:27,359 fail2ban.filter [8650]: INFO [sshd] Found 5.188.10.144 2018-08-29 21:28:13,128 fail2ban.filter [8650]: INFO [sshd] Found 5.188.10.176 2018-08-29 21:28:13,132 fail2ban.filter [8650]: INFO [sshd] Found 5.188.10.176 2018-08-29 21:28:15,137 fail2ban.filter [8650]: INFO [sshd] Found 5.188.10.176 2018-08-29 21:28:20,145 fail2ban.filter [8650]: INFO [sshd] Found 5.188.10.176 2018-08-29 21:28:25,153 fail2ban.filter [8650]: INFO [sshd] Found 5.188.10.176 2018-08-29 21:28:25,421 fail2ban.actions [8650]: NOTICE [sshd] Ban 5.188.10.176 2018-08-29 21:30:05,272 fail2ban.filter [8650]: INFO [sshd] Found 5.188.10.180 2018-08-29 21:30:05,274 fail2ban.filter [8650]: INFO [sshd] Found 5.188.10.180 2018-08-29 21:30:13,285 fail2ban.filter [8650]: INFO [sshd] Found 5.188.10.180 2018-08-29 21:30:13,286 fail2ban.filter [8650]: INFO [sshd] Found 5.188.10.180 2018-08-29 21:30:15,289 fail2ban.filter [8650]: INFO [sshd] Found 5.188.10.180 2018-08-29 21:30:15,803 fail2ban.actions [8650]: NOTICE [sshd] Ban 5.188.10.180</code> </pre> </div></div><br><p>  The ban is made by adding a firewall rule.  After a specified time, the rule is deleted, and the user can again try to log in. </p><br><p>  Initially, only SSH is included, but it is possible to enable control of the logs of the Web server and other services, <a href="https://bintray.com/openmediavault-plugin-developers/erasmus-testing/openmediavault-fail2ban/view">at least the same OMV</a> . <br>  And also, take out logs from containers and set fail2ban on them too. </p><br><p>  I recommend adding services to taste. <br>  You can read more about the configuration, for example, <a href="https://vps.ua/wiki/install-linux-vps/security/configuring-fail2ban/">here</a> or on your <a href="https://www.fail2ban.org/wiki/index.php/Main_Page">own Wiki</a> . </p><br><h2 id="logi">  Logs </h2><br><h3 id="lwatchhttpspackagesdebianorgstretchadminlwatch">  <a href="https://packages.debian.org/stretch/admin/lwatch">Lwatch</a> </h3><br><p>  A small utility that should be installed for convenience.  Highlight the logs and show them in a beautiful form. <br>  It is possible to use <a href="https://github.com/floriankraft/color-logviewer">any such utility</a> , as long as errors and problem areas of the logs are highlighted so that their visual analysis is facilitated. </p><br><h3 id="logcheckhttplogcheckorg">  <a href="http://logcheck.org/">Logcheck</a> </h3><br><p>  It is worthwhile to install and configure logcheck just so that when identifying problems with the configuration, which is reported in the logs, you immediately see it in the mail. <br>  It helps to see well what is going wrong, although it requires adjustment. </p><br><p>  Installation: </p><br><pre> <code class="plaintext hljs"># apt-get install logcheck</code> </pre> <br><p>  Immediately after installation, it will send reports. </p><br><div class="spoiler">  <b class="spoiler_title">Sample report.</b> <div class="spoiler_text"><pre> <code class="plaintext hljs">System Events =-=-=-=-=-=-= Oct 2 02:02:15 nas kernel: [793847.981226] [DROPPED] IN=br-ce OUT= PHYSIN=veth6c2a68e MAC=ff:ff:ff:ff:ff:ff: SRC=172.22.0.11 DST=255.255.255.255 LEN=29 TOS=0x00 PREC=0x00 TTL=64 ID=40170 DF PROTO=UDP SPT=35623 DPT=35622 LEN=9 Oct 2 02:02:20 nas hddtemp[13791]: /dev/sdh: Micron_1100 N #020–Ç: 32 C Oct 2 02:02:37 nas kernel: [793869.247128] [DROPPED] IN=br-7ba OUT= MAC= SRC=172.31.0.1 DST=172.31.255.255 LEN=239 TOS=0x00 PREC=0x00 TTL=128 ID=23017 DF PROTO=UDP SPT=138 DPT=138 LEN=219 Oct 2 02:02:37 nas kernel: [793869.247174] [DROPPED] IN=br-7ba OUT= MAC= SRC=172.31.0.1 DST=172.31.255.255 LEN=232 TOS=0x00 PREC=0x00 TTL=128 ID=23018 DF PROTO=UDP SPT=138 DPT=138 LEN=212 Oct 2 02:02:37 nas kernel: [793869.247195] [DROPPED] IN=br-673 OUT= MAC= SRC=192.168.224.1 DST=192.168.239.255 LEN=239 TOS=0x00 PREC=0x00 TTL=128 ID=8959 DF PROTO=UDP SPT=138 DPT=138 LEN=219 Oct 2 02:02:37 nas kernel: [793869.247203] [DROPPED] IN=br-673 OUT= MAC= SRC=192.168.224.1 DST=192.168.239.255 LEN=232 TOS=0x00 PREC=0x00 TTL=128 ID=8960 DF PROTO=UDP SPT=138 DPT=138 LEN=212 Oct 2 02:02:50 nas hddtemp[13791]: /dev/sdh: Micron_1100 N #020–Ç: 32 C</code> </pre> </div></div><br><p>  It is seen that there is a lot of excess, and further configuration will be reduced to its filtering. </p><br><p>  First you need to turn off the hddtemp, which does not work correctly due to non-ASCII characters in the SSD name. <br>  After correcting the hddtemp file, the messages stopped coming: </p><br><div class="spoiler">  <b class="spoiler_title">/etc/logcheck/ignore.d.server/hddtemp</b> <div class="spoiler_text"><pre> <code class="plaintext hljs">^\w{3} [ :0-9]{11} [._[:alnum:]-]+ hddtemp\[[0-9]+\]: /dev/([hs]d[az]|sg[0-9]):.*[0-9]+.*[CF] ^\w{3} [ :0-9]{11} [._[:alnum:]-]+ hddtemp\[[0-9]+\]: /dev/([hs]d[az]|sg[0-9]):.*drive is sleeping</code> </pre> </div></div><br><p>  Then, it is possible to see that logcheck is talking about blocking broadcast traffic with firewall: </p><br><pre> <code class="plaintext hljs">[793869.247128] [DROPPED] IN=br-7ba OUT= MAC= SRC=172.31.0.1 DST=172.31.255.255 LEN=239 TOS=0x00 PREC=0x00 TTL=128 ID=23017 DF PROTO=UDP SPT=138 DPT=138 LEN=219</code> </pre> <br><p>  Therefore, it is necessary to allow broadcast traffic from the router and containers: </p><br><ul><li>  Port 35622 from container with urbackup. </li><li>  Port 5678 from the router is the discovery of RouterOS neighbors.  It is possible to disable it on the router. </li><li>  Port 5353 to address 224.0.0.251 is <a href="https://habr.com/post/66020/">mDNS</a> . </li></ul><br><p>  Logcheck check: </p><br><pre> <code class="plaintext hljs">sudo -u logcheck logcheck -t -d</code> </pre> <br><p>  Finally, problems are visible: </p><br><pre> <code class="plaintext hljs">Oct 21 21:58:18 nas systemd[1]: Removed slice User Slice of user. Oct 21 21:58:31 nas systemd[1]: smbd.service: Unit cannot be reloaded because it is inactive. Oct 21 21:58:31 nas root: /etc/dhcp/dhclient-enter-hooks.d/samba returned non-zero exit status 1</code> </pre> <br><p>  It turns out that SAMBA does not start.  Indeed, the analysis showed that I had disguised it through the systemctl, and OMV was trying to launch it. </p><br><p>  Logcheck will still be spamming with various messages. <br>  For example, zfs-auto-snapshot has passed: </p><br><pre> <code class="plaintext hljs">Oct 21 22:00:57 nas zfs-auto-snap: @zfs-auto-snap_frequent-2018-10-21-1900, 16 created, 16 destroyed, 0 warnings.</code> </pre> <br><p>  To ignore: </p><br><div class="spoiler">  <b class="spoiler_title">/etc/logcheck/ignore.d.server/zfs-auto-snapshot</b> <div class="spoiler_text"><pre> <code class="plaintext hljs">^\w{3} [ :0-9]{11} [._[:alnum:]-]+ zfs-auto-snap: \@zfs-auto-snap_[[:alnum:]-]+, [0-9]+ created, [0-9]+ destroyed, 0 warnings.$</code> </pre> </div></div><br><p>  rrdcached also ignore: </p><br><div class="spoiler">  <b class="spoiler_title">/etc/logcheck/ignore.d.server/rrdcached</b> <div class="spoiler_text"><pre> <code class="plaintext hljs">^\w{3} [ :[:digit:]]{11} [._[:alnum:]-]+ rrdcached\[[0-9]+\]: flushing old values$ ^\w{3} [ :[:digit:]]{11} [._[:alnum:]-]+ rrdcached\[[0-9]+\]: rotating journals$ ^\w{3} [ :[:digit:]]{11} [._[:alnum:]-]+ rrdcached\[[0-9]+\]: started new journal [./[:alnum:]]+$ ^\w{3} [ :[:digit:]]{11} [._[:alnum:]-]+ rrdcached\[[0-9]+\]: removing old journal [./[:alnum:]]+$</code> </pre> </div></div><br><p>  Also, it is advisable to remove zed, if it has not yet been removed: </p><br><div class="spoiler">  <b class="spoiler_title">/etc/logcheck/ignore.d.server/zed</b> <div class="spoiler_text"><pre> <code class="plaintext hljs">^\w{3} [ :0-9]{11} [._[:alnum:]-]+ (/usr/bin/)?zed: .*$ ^\w{3} [ :0-9]{11} [._[:alnum:]-]+ (/usr/bin/)?zed\[[0-9]+\]: .*$</code> </pre> </div></div><br><p>  Well, and so on.  Many believe that logcheck is quite a useless utility. <br>  This is true if you use it as something that you have set and forgotten. </p><br><p>  However, if you understand that logcheck is just a customizable log filter, without heuristics, magic, and adaptive algorithms, the question of its usefulness does not arise.  Iteratively, examining what he sends and, either by inserting it into the ignore list or correcting it, it is gradually possible to achieve informative reports. </p><br><p>  Using an automated tool for analysis is much better than running logs through the same regular expressions with your hands, and often better than using a complete data analysis system like Splunk. </p><br><p>  It is possible to read about logcheck and its configuration on <a href="https://wiki.gentoo.org/wiki/Logcheck/ru">Gentoo Wiki</a> <a href="https://habr.com/sandbox/26810/">here</a> . </p><br><h2 id="ids-urovnya-uzla">  Node-level IDS </h2><br><p>  Here I refer to my own article <a href="https://habr.com/post/358200/">‚ÄúA Brief Analysis of Solutions in the Field of IDS and Development of a Neural Network Anomaly Detector in Data Networks‚Äù</a> , in which there are several examples. </p><br><p>  You can <a href="https://en.wikipedia.org/wiki/Host-based_intrusion_detection_system_comparison">read a</a> more complete review and comparison of similar IDS <a href="https://en.wikipedia.org/wiki/Host-based_intrusion_detection_system_comparison">on the Wiki</a> . </p><br><h3 id="stig-4httpswwwstigviewercomstigred_hat_enterprise_linux_6">  <a href="https://www.stigviewer.com/stig/red_hat_enterprise_linux_6/">STIG-4</a> </h3><br><p>  A complex and large script for static analysis of known gaps from RedHat. <br>  There is its <a href="https://github.com/hardenedlinux/STIG-4-Debian">port in Debian</a> , which I recommend downloading and running at least once. </p><br><div class="spoiler">  <b class="spoiler_title">STIG-4 work example</b> <div class="spoiler_text"><pre> <code class="plaintext hljs"># cd root@nas:~# git clone https://github.com/hardenedlinux/STIG-4-Debian Cloning into 'STIG-4-Debian'... remote: Enumerating objects: 572, done. remote: Total 572 (delta 0), reused 0 (delta 0), pack-reused 572 Receiving objects: 100% (572/572), 634.37 KiB | 0 bytes/s, done. Resolving deltas: 100% (316/316), done. root@nas:~# cd STIG-4-Debian/ root@nas:~/STIG-4-Debian# bash stig-4-debian.sh -H Script Run: Mon Nov 12 23:58:34 MSK 2018 Start checking process... [ FAIL ] The cryptographic hash of system files and commands must match vendor values. ... Pass Count: 54 Failed Count: 137</code> </pre> </div></div><br><p>  The process of working with this script is something like this: </p><br><ul><li>  Run the script. </li><li>  Search the web for every line with <code>[ FAIL ]</code> . </li><li>  As a rule, a link to the STIG online database will be found. </li><li>  Correct, following the instructions in the database, making a discount on the fact that this is Debian. </li><li>  Run the script again. </li></ul><br><h3 id="rkhunterhttprkhuntersourceforgenet">  <a href="http://rkhunter.sourceforge.net/">Rkhunter</a> </h3><br><p>  <a href="https://habr.com/company/first/blog/242865/">Too much has been</a> written about <a href="https://sourceforge.net/p/rkhunter/rkh_code/ci/master/tree/files/README">RkHunter</a> . <br>  Used long ago, widely, still evolving.  Available in the Debian repository. </p><br><h3 id="tigerhttpswwwnongnuorgtiger">  <a href="https://www.nongnu.org/tiger/">Tiger</a> </h3><br><p>  A modular shell script that performs system auditing and intrusion detection. <br>  In some ways similar to STIG-4. <br>  It can use third-party utilities for analyzing logs, for detecting violation of checksums. </p><br><p>  Consists of a large number of different modules. </p><br><p>  For example, there is a module that detects services that use deleted files, which happens when the libraries used by the service were changed during the system update, but the service was not restarted for some reason. </p><br><p>  There are modules for searching service users that are no longer used, system checks for the absence of security patches, umask checks, etc. </p><br><p>  Read more <a href="https://www.nongnu.org/tiger/tiger.8.html">in man</a> . </p><br><p>  Already 10 years does not develop (yes, I'm not the only one who throws software) </p><br><h3 id="samhainhttpswwwla-samhnadesamhain">  <a href="https://www.la-samhna.de/samhain/">Samhain</a> </h3><br><p>  Typical HIDS that can: </p><br><ul><li>  Check the integrity of the entire system using cryptographic hashes. </li><li>  Search for various executable files with the installed SUID, which should not be installed. </li><li>  Detect hidden processes. </li><li>  Sign logs and databases. </li></ul><br><p>  Plus, it has centralized monitoring with a web-based interface and centralized logging to the server. <br>  Usually, it is used to check whether the system binary files have changed between updates. <br>       . </p><br><p> ,  ,           . ,  ,    ,    ,         . </p><br><p> -     HIDS:        . <br>     Samhain,      . </p><br><h3 id="tripwirehttpssourceforgenetprojectstripwire"> <a href="https://sourceforge.net/projects/tripwire/">Tripwire</a> </h3><br><p>   ,   Samhain,  Tripwire ‚Äî    . <br>    ,   . </p><br><h3 id="lynishttpscisofycomlynis"> <a href="https://cisofy.com/lynis/">Lynis</a> </h3><br><p>  <a href="https://en.wikipedia.org/wiki/Lynis">  RkHunter</a> . </p><br><p>  ,    . <br>     <a href="https://cisofy.com/lynis/"> </a>     . <br>   Tiger       ,     ,  . <br>   ,  .    ,       , Lynix    Tripwire. </p><br><h3 id="chkrootkithttpwwwchkrootkitorg"> <a href="http://www.chkrootkit.org/">Chkrootkit</a> </h3><br><p>  The name speaks for itself.    . <br> : </p><br><ul><li>   ,  . </li><li>       . </li><li> ,     latslog, wtmp  utmp. </li><li>     ,   ,     . </li></ul><br><p>      . </p><br><h3 id="ninjahttpforkbomborgninja"> <a href="http://forkbomb.org/ninja">Ninja</a> </h3><br><p>        Linux. </p><br><p>      ninja-build. </p><br><p> ,      .      UID/GID, Ninja      ,         ,    (,     , ). <br>          (, su). <br>   ,     . </p><br><p>  <a href="https://packages.ubuntu.com/trusty/ninja">  Ubuntu</a> ,     Debian. </p><br><h2 id="skanery-bezopasnosti">   </h2><br><p>       .   .    ,    ,    ,   . <br>       <a href="https://nmap.org/">Nmap</a>  <a href="https://en.wikipedia.org/wiki/W3af">W3af</a>  Web-. </p><br><h2 id="sistemy-alternativnyh-modeley-bezopasnosti">     </h2><br><p>  Linux  <a href="https://ru.wikipedia.org/wiki/%25D0%2598%25D0%25B7%25D0%25B1%25D0%25B8%25D1%2580%25D0%25B0%25D1%2582%25D0%25B5%25D0%25BB%25D1%258C%25D0%25BD%25D0%25BE%25D0%25B5_%25D1%2583%25D0%25BF%25D1%2580%25D0%25B0%25D0%25B2%25D0%25BB%25D0%25B5%25D0%25BD%25D0%25B8%25D0%25B5_%25D0%25B4%25D0%25BE%25D1%2581%25D1%2582%25D1%2583%25D0%25BF%25D0%25BE%25D0%25BC"> (  )  </a> . <br>      .  ,     <a href="https://ru.wikipedia.org/wiki/%25D0%25A3%25D0%25BF%25D1%2580%25D0%25B0%25D0%25B2%25D0%25BB%25D0%25B5%25D0%25BD%25D0%25B8%25D0%25B5_%25D0%25B4%25D0%25BE%25D1%2581%25D1%2582%25D1%2583%25D0%25BF%25D0%25BE%25D0%25BC_%25D0%25BD%25D0%25B0_%25D0%25BE%25D1%2581%25D0%25BD%25D0%25BE%25D0%25B2%25D0%25B5_%25D1%2580%25D0%25BE%25D0%25BB%25D0%25B5%25D0%25B9"></a>  <a href="https://ru.wikipedia.org/wiki/%25D0%259C%25D0%25B0%25D0%25BD%25D0%25B4%25D0%25B0%25D1%2582%25D0%25BD%25D0%25BE%25D0%25B5_%25D1%2583%25D0%25BF%25D1%2580%25D0%25B0%25D0%25B2%25D0%25BB%25D0%25B5%25D0%25BD%25D0%25B8%25D0%25B5_%25D0%25B4%25D0%25BE%25D1%2581%25D1%2582%25D1%2583%25D0%25BF%25D0%25BE%25D0%25BC"></a> . </p><br><p>   ,  ,   ,    . </p><br><p>        <a href="https://www.ibm.com/developerworks/ru/library/l-se_linux_01/">  " Linux"  IBM</a> . </p><br><p>  NAS        ,    AppArmor. <br>  ,       ,     . <br> ,          ,          ,         . </p><br><h3 id="access-control-listshttpsdocsoraclecomcde19253-01820-0836ftyxiindexhtml"> <a href="https://docs.oracle.com/cd/E19253-01/820-0836/ftyxi/index.html">Access Control Lists</a> </h3><br><p>     ,     . <br>  , ZFS       . </p><br><div class="spoiler"> <b class="spoiler_title">   ACL  ZFS.</b> <div class="spoiler_text"><ul><li>       . </li><li>      . </li><li>    . </li><li>        . </li><li>         . </li><li>     . </li><li>     ACL ( ls). </li><li>       (   ACL,     "stat"). </li><li>     . </li><li>             . </li><li>           . </li><li>       . </li><li>      ,     ,   . </li><li>       ACL    chmod. </li><li>        .        chown  chgrp . </li><li>           ,     .               PRIV_FILE_CHOWN. </li><li>      ACL   . </li><li>   ACL      . </li><li>   ACL   ,         ,     .     ACL    file_inherit,  dir_inherit   . </li><li>   ACL       ,      . </li></ul></div></div><br><p>  ACL    , ,     ,   .         . </p><br><p>    EXT ,  ZFS  ACL      <code>setfacl/getfacl</code> ,    <code>chmod</code>  <code>ls</code> . </p><br><h3 id="apparmorhttpsgitlabcomapparmorapparmorwikishome"> <a href="https://gitlab.com/apparmor/apparmor/wikis/home/">AppArmor</a> </h3><br><p><img src="https://habrastorage.org/webt/p2/yt/br/p2ytbr0l4cq_ujt9sh_njrh1t7k.jpeg"></p><br><p>         . </p><br><p> ,         ,     <code>exec</code> ,  ,      <code>open</code> , <code>exec</code>  . <br>      ,     . <br> AppArmor ,       . <br>  ,      . <br>     capabilites. </p><br><p>     ,    .       ,   ,      ,   . </p><br><div class="spoiler"> <b class="spoiler_title">     ping.</b> <div class="spoiler_text"><pre> <code class="plaintext hljs">#include &lt;tunables/global&gt; profile ping /{usr/,}bin/ping flags=(complain) { #include &lt;abstractions/base&gt; #include &lt;abstractions/consoles&gt; #include &lt;abstractions/nameservice&gt; capability net_raw, capability setuid, network inet raw, network inet6 raw, /{,usr/}bin/ping mixr, /etc/modules.conf r, # Site-specific additions and overrides. See local/README for details. #include &lt;local/bin.ping&gt; }</code> </pre> </div></div><br><p> ,       , ..     . ,  ,           ( <code>local/bin.ping</code> ),    ,     . </p><br><p>     deb-based . <br>    <a href="https://wiki.archlinux.org/index.php/firejail">  firejail</a> ,    . </p><br><p>      ,   ,      . </p><br><p>    Debian, <a href="https://wiki.debian.org/AppArmor"> </a> . </p><br><h3 id="selinuxhttpselinuxprojectorgpagemain_page"> <a href="http://selinuxproject.org/page/Main_Page">SELinux</a> </h3><br><p> <a href=""><img src="https://habrastorage.org/webt/uk/8e/_4/uk8e_4yzmie_mnhkeak2sxxztem.png" alt=" SELinux"></a> </p><br><p>    . <br>   <a href="https://www.nsa.gov/">NSA</a> ,      Debian   <a href="https://wiki.debian.org/SELinux"> </a> . </p><br><p>   SELinux   " " (type enforcement). </p><br><p>  , , ,      SELinux .      "". </p><br><p> ,    ,   <code>firefox_t</code> . <br> SELinux         ,     . </p><br><p>  Example: </p><br><pre> <code class="plaintext hljs">allow firefox_t user_home_t : file { read write };</code> </pre> <br><p>     , ,  <code>firefox_t</code>         , ,  <code>user_home_t</code> . </p><br><p>  Example: </p><br><pre> <code class="plaintext hljs">allow user_t user_home_t:file { create read write unlink };</code> </pre> <br><p>    <code>user_t</code>  , ,       <code>user_home_t</code> .  <code>user_t</code> ,  ,  . </p><br><p> ,      . </p><br><p>     AppArmor -,  ,   ,        . </p><br><div class="spoiler"> <b class="spoiler_title">     SELinux   .</b> <div class="spoiler_text"><ul><li> <strong></strong>  SELinux     Linux.     su  sudo,  SELinux  .   Linux    SELinux ,     1:1,     root. </li><li> <strong></strong> ,   ,   .  " ", "Web-", " ".     ,     <code>object_r</code> . <br>      ,  . </li><li> <strong></strong>  <strong></strong>      .  ‚Äî    ,  . </li><li> <strong></strong>  <strong></strong>     .  ,   ,        . ,     <code>user_u:user_r:user_t</code> ,        <code>user_u:object_r:user_home_t</code> .     : </li></ul><br><pre> <code class="plaintext hljs">user:role:type:range</code> </pre> <br><p>   ‚Äî SELinux user.    ‚Äî   , .  ‚Äî   MLS . </p><br><p> ,     ,  ,  <code>user_home_t.</code> <code>user_home_t</code> ‚Äî  ,         ,     . </p><br><ul><li> <strong> </strong>  <strong> </strong> ,   <code>dir</code>    <code>file</code>     ,    ,    .      ,     . , <code>file</code>     (create),  (read),  (write)   (unlink),   <code>unix_stream_socket object</code> ( UNIX)     (create),   (connect),    (sendto). </li></ul></div></div><br><p>     ,        . <br>     . ,    (,     ),    . </p><br><p> ,   AppArmor,  permissive ,       ,    . <br>       . <br>   ,       ,    AppArmor       . </p><br><p>  <a href="https://habr.com/company/pt/blog/142423/">   SELinux</a>   . <br>  <a href="https://habr.com/company/kingservers/blog/209644/">  </a> . <br>    <a href="https://www.ibm.com/developerworks/ru/library/l-se_linux_01/">  IBM</a> . </p><br><h3 id="grsecurityhttpswwwgrsecuritynet"> <a href="https://www.grsecurity.net/">GrSecurity</a> </h3><br><p>    Debian -  .  ,    ,   . <br> ,   (     ), ‚Äî <a href="https://wiki.gentoo.org/wiki/Hardened/Grsecurity2_Quickstart"> Gentoo</a> .     : hardening <a href="https://wiki.gentoo.org/wiki/Hardened_Gentoo/ru">  </a> . </p><br><p> , <a href="https://bash.im/quote/394695">   </a> . </p><br><p>  <a href="https://wiki.debian.org/grsecurity">  Debian</a>  ,    GrSecurity  PaX. </p><br><h3 id="tomoyohttptomoyoosdnjp"> <a href="http://tomoyo.osdn.jp/">Tomoyo</a> </h3><br><p> Tomoyo  Debian   <a href="https://wiki.debian.org/Tomoyo"> </a> . </p><br><p>        .   AppArmor,   .   2003 . <br>   ,    ,  . <br>    ,    AppArmor,     . </p><br><h2 id="melochi">  Little things </h2><br><p>        <code>/etc/securetty</code>  ,  root       ( ),        . </p><br><p>       PAM,       <code>/etc/security</code> . </p><br><p>    ,  Samhain  Tripwire,      <a href="http://nsk.lug.ru/poleznye-sovety/poleznye-sovety-proverka-ustanovlennyh-paketov-s-pomoschyu-debsums/">debsums</a> ,      . </p><br><h2 id="zaklyuchenie">  Conclusion </h2><br><p>    .     ,      . </p><br><p>  ,      <a href="https://github.com/artiomn/NAS"> Github </a> ,   . </p></div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <p>Source: <a href="https://habr.com/ru/post/421279/">https://habr.com/ru/post/421279/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../421267/index.html">Semi-passive cooling of computer power supply unit</a></li>
<li><a href="../421269/index.html">The facial recognition system installed at a US airport helped catch the attacker</a></li>
<li><a href="../421271/index.html">Selection of useful materials on Azure. Part 2 - Courses</a></li>
<li><a href="../421275/index.html">What I realized after selling two startups in 12 months</a></li>
<li><a href="../421277/index.html">Segmentation of satellite images on the example of tree recognition</a></li>
<li><a href="../421281/index.html">Technical support 3CX responds: setting your own logo on the IP phone display</a></li>
<li><a href="../421283/index.html">The book about the "Paragraph" on Habr√©. Chapter One: The Watchman</a></li>
<li><a href="../421285/index.html">Optical trackers: ASEF and MOSSE</a></li>
<li><a href="../421287/index.html">Moon bricks from the solar furnace</a></li>
<li><a href="../421289/index.html">The number of electric cars in Russia increased from 920 to 2500 in a year and a half</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>