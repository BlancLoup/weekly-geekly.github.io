<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Mockito and how to cook it</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="About the article 


 Here is the next guide on the Mockito. In it, on the one hand, I tried to describe the functionality of this library so that a r...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Mockito and how to cook it</h1><div class="post__text post__text-html js-mediator-article"><h2 id="o-state">  About the article </h2><br><p>  Here is the next guide on the Mockito.  In it, on the one hand, I tried to describe the functionality of this library so that a reader unfamiliar with it immediately got the opportunity to fully use it, and not just a general idea about it.  On the other hand, I wanted to make it compact enough and structured so that you can quickly read it completely and quickly find in it something once read, but forgotten.  In general, this is such an article, which would be useful to me when I first encountered this library and did not really understand how it works. </p><br><p>  I suppose that even now it may be useful to me - sometimes I forget one of these, and it‚Äôs more convenient to remember the material not according to official documentation or other people's articles, but according to my own, let's say, outline.  At the same time, I tried to construct the text in such a way that it was convenient first of all to get acquainted with Mockito from scratch, and in some places I sort out the seemingly obvious things - not all of which were obvious to me from the very beginning. </p><a name="habracut"></a><br><h2 id="soderzhanie">  Content: </h2><br><ol><li>  <a href="https://habr.com/ru/post/444982/">Mockito: what it is and why you need it</a> </li><li>  <a href="https://habr.com/ru/post/444982/">Environment, version and experimental animal</a> </li><li>  <a href="https://habr.com/ru/post/444982/">mock and spy</a> </li><li>  <a href="https://habr.com/ru/post/444982/">Behavior management</a> <br><ol><li>  <a href="https://habr.com/ru/post/444982/">Set call conditions</a> </li><li>  <a href="https://habr.com/ru/post/444982/">Call results</a> </li></ol></li><li>  <a href="https://habr.com/ru/post/444982/">Tracking method calls</a> </li><li>  <a href="https://habr.com/ru/post/444982/">Mock objects as field values ‚Äã‚Äãand Mockito annotations</a> </li><li>  <a href="https://habr.com/ru/post/444982/">Rollback behavior to default and session Mockito</a> </li><li>  <a href="https://habr.com/ru/post/444982/">What else?</a> </li></ol><br><h2 id="mockito-chto-eto-takoe-i-zachem-nuzhno">  Mockito: what it is and why you need it </h2><br><p>  In short, Mockito is a stub framework. </p><br><p>  As you know, when testing code (first of all, unit testing, but not only), the element being tested often needs to provide instances of classes that it should use when working.  At the same time, they often do not have to be fully functional - on the contrary, they are required to behave in a strictly predetermined manner, so that their behavior is simple and completely predictable.  They are called stubs.  To get them, you can create alternative test interface implementations, inherit the necessary classes with redefinition of the functional, and so on, but all this is rather inconvenient, redundant and fraught with errors.  A more convenient solution in all senses is specialized frameworks for creating stubs.  One of those (and perhaps best known for Java) is the Mockito. </p><br><p> Mockito allows you to create with one line of code a so-called mock (something like the basis for the right stub) of any class.  For such a mock immediately after creation, some default behavior is typical (all methods return predefined values ‚Äã‚Äã- usually <code>null</code> or <code>0</code> ).  You can redefine this behavior in the desired way, check with the necessary degree of detail in addressing them, and so on.  As a result, the mock and becomes a stub with the desired properties.  Below I will explain in detail how to do this. </p><br><p>  I note that you can also create a mock for those classes whose new instance cannot be created as such, in particular, classes with exclusively private constructors such as singletons and utility classes, and with a minimal framework setting - and enumerations. </p><br><h2 id="okruzhenie-versii-i-podopytnoe-zhivotnoe">  Environment, version and experimental animal </h2><br><p>  When writing this article I used: </p><br><ul><li>  Mockito: 'org.mockito: mockito-core: 2.24.0' (latest stable version at the time of writing) </li><li>  TestNG: 'org.testng: testng: 6.14.3' as a test framework </li><li>  AssertJ: 'org.assertj: assertj-core: 3.11.1' as a verification tool </li><li>  Lombok: 'org.projectlombok: lombok: 1.18.6' (just for convenience) </li><li>  Java 8 </li></ul><br><p>  For my inhuman experiments, I wrote this service interface, providing access to certain data. </p><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">interface</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">DataService</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">saveData</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(List&lt;String&gt; dataToSave)</span></span></span></span>; <span class="hljs-function"><span class="hljs-function">String </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getDataById</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(String id)</span></span></span></span>; <span class="hljs-function"><span class="hljs-function">String </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getDataById</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(String id, Supplier&lt;String&gt; calculateIfAbsent)</span></span></span></span>; <span class="hljs-function"><span class="hljs-function">List&lt;String&gt; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getData</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>; <span class="hljs-function"><span class="hljs-function">List&lt;String&gt; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getDataListByIds</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(List&lt;String&gt; idList)</span></span></span></span>; <span class="hljs-function"><span class="hljs-function">List&lt;String&gt; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getDataByRequest</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(DataSearchRequest request)</span></span></span></span>; }</code> </pre> <br><p>  And this (let it be for the order) is the class code of the request passed to the last of the interface methods. </p><br><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@AllArgsConstructor</span></span> <span class="hljs-meta"><span class="hljs-meta">@Getter</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">DataSearchRequest</span></span></span><span class="hljs-class"> </span></span>{ String id; Date updatedBefore; <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> length; }</code> </pre> <br><p>  Data units are identified by ID and have some more characteristics, but directly in the form in which the service returns, they are strings, and not some more complex objects.  I don‚Äôt miss anything important, and the examples are easier and clearer. </p><br><p>  I note immediately: in the examples below, for clarity, I directly call the redefined methods of my mock objects, but with real testing, the idea is not at all in this!  In a real test, I would consistently do the following: </p><br><ul><li>  set up the mock of my service as needed; </li><li>  I passed it (most likely through the constructor) to an instance of another class using it (suppose it contains some business logic that uses the data provided by the <code>DataService</code> ), which I, in fact, would test; </li><li>  involved the functionality of the class under test and monitored the results; </li><li>  if necessary, I would check the number and order of my mock method (s) that should have been called by the class under test as a result of the previous action. </li></ul><br><h2 id="mock-i-spy">  mock and spy </h2><br><p>  The central class of Mockito, through which it is supposed to access most of the functionality, is, in fact, a class called <code>Mockito</code> (there is also a class <code>BDDMockito</code> , which provides approximately the same capabilities in a form more suitable for <a href="https://ru.wikipedia.org/wiki/BDD_(%25D0%25BF%25D1%2580%25D0%25BE%25D0%25B3%25D1%2580%25D0%25B0%25D0%25BC%25D0%25BC%25D0%25B8%25D1%2580%25D0%25BE%25D0%25B2%25D0%25B0%25D0%25BD%25D0%25B8%25D0%25B5)">BDD</a> , but here I will not dwell on it) .  Access to the functionality is implemented through its static methods. </p><br><p>  To create a mock of the <code>DataService</code> class, I just have to do the following: </p><br><pre> <code class="java hljs">DataService dataServiceMock = Mockito.mock(DataService.class);</code> </pre> <br><p>  Done - I got a copy of the class I needed.  It will be accepted by any method or constructor that requires a parameter of this type (for example, the constructor of the class that I want to test).  Even if further it is waited by check with predilection, it will pass it: not only the <code>instanceof DataService</code> returns <code>true</code> , but also the <code>dataServiceMock.getClass()</code> - exactly <code>DataService.class</code> .  In some formal way, to programmatically distinguish a mock-object from an ordinary one turns out to be a rather difficult task, which is logical: after all, the first is designed just to be indistinguishable from the second.  However, Mockito has a tool for this - the <code>Mockito.mockingDetails</code> method.  Passing an arbitrary object to it, I get an object of the <code>MockingDetails</code> class.  It contains information that this object is from the point of view of the Mockito: whether it is a mock, spy (see below), how it was used, how it was created, and so on. </p><br><p>  I should especially mention the situation when I try to create a mock for a final class or a mock enum instance or override the behavior of a final method.  In this case, when the behavior of the Mockito default code above refuses to work, referring to this circumstance.  However, this can be changed - it is enough to create the file <code>test/resources/mockito-extensions/org.mockito.plugins.MockMaker</code> in the project (with the standard device of the project directory tree) and enter the line: </p><br><pre> <code class="plaintext hljs">mock-maker-inline</code> </pre> <br><p>  After that, you can simulate the usual way final classes and enums, as well as override final methods. </p><br><p>  The mock I got in action is maximized: no method will have any impact on anything when called, and the return value will be <code>null</code> for object types and <code>0</code> for primitive ones.  Note: if the method returns a collection, the mock will default to returning not <code>null</code> 's, but empty instances of the collections.  For example, for a <code>List</code> this will be an empty <code>LinkedList</code> regardless of what the real method should have returned.  But as array values, primitive or object, I get <code>null</code> .  The default behavior (and not only it) can be changed with the help of the functional of the <code>MockSettings</code> class, but this is rarely necessary. </p><br><p>  Anyway, in most cases, I will not need the default behavior, and in the next section I will discuss in detail how to set what is required instead. </p><br><p>  However, what if I want to use as a stub an object of a real class with the existing functionality, overriding the work of only part of its methods?  If we are talking about unit testing, such a need usually (but not always) indicates that the design is not all right with the design, and in principle this is not recommended.  However, there are situations when this cannot be avoided for some reason.  In this case, the Mockito has a so-called spy, "spy".  Unlike mocks, they can be created on the basis of both the class and the finished object: </p><br><pre> <code class="java hljs">DataService dataServiceSpy = Mockito.spy(DataService.class); <span class="hljs-comment"><span class="hljs-comment">// or DataService dataService = new DataService(); dataServiceSpy = Mockito.spy(dataService);</span></span></code> </pre> <br><p>  When creating a spy based on a class, if its type is an interface, a regular mock object will be created, and if the type is a class, then Mockito will try to create an instance using the default constructor (without parameters).  And only if there is no such constructor, an error will occur and the test will not work. </p><br><p>  The default behavior of spy objects is identical to the behavior of a regular class instance, but they give me the same features as mock objects: they allow you to redefine their behavior and observe how they are used (see the following sections).  Important point: spy is not a wrapper around the instance on which it was created!  Therefore, calling the spy method will not affect the state of the original instance. </p><br><h2 id="upravlenie-povedeniem">  Behavior management </h2><br><p>  So, how to make mock or spy do what I need.  Further, I will write everywhere simply "mock" - this will mean "mock or spy", except when expressly stated otherwise. </p><br><p>  In general, controlling the behavior of a mock object is reduced to one obvious concept: when a mock was influenced in this way (that is, a certain method was called up with such and such arguments), it must react in such and such a way.  This concept has two implementations within the Mockito class - the main one recommended by developers for use wherever possible, and the alternative one used where the main one is not suitable. </p><br><p>  The main implementation is based on the <code>Mockito.when</code> method.  This method accepts as a ‚Äúparameter‚Äù a call to the overridden method of a mock object (thus the defined impact is fixed) and returns an object of the <code>OngoingStubbing</code> type, which allows you to call one of the methods of the <code>Mockito.then...</code> family <code>Mockito.then...</code> (this is how the response to this impact is set).  All together in the simplest case looks like this: </p><br><pre> <code class="java hljs">List&lt;String&gt; data = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ArrayList&lt;&gt;(); data.add(<span class="hljs-string"><span class="hljs-string">"dataItem"</span></span>); Mockito.when(dataService.getAllData()).thenReturn(data);</code> </pre> <br><p>  After this operation, I will <code>dataService</code> the <code>getAllData()</code> method on the <code>getAllData()</code> object and get the object specified in the first line of the listing. </p><br><p>  Here, the usual "object-oriented" intuition may give some glitch, so it is worthwhile to dwell on this in a bit more detail.  From a Java syntax point of view, the value passed to the <code>when</code> method as a parameter is, of course, the value returned by the override method.  For mock, this is an empty value, for spy, the value returned by the real object method.  But thanks to the magic of the "under the hood" Mockito magic, the <code>when</code> method will work in a regular manner (and will not fall at startup with an error) only if inside the brackets after <code>when</code> there is exactly a call to the mock-object method. </p><br><p>  Such an ideology often acts when defining mock behavior in a Mockito: calling a method (mock object or <code>Mockito</code> class), I try not to get the value returned by it, but to somehow influence the possible call of that method of the mock object I work with: specify its boundaries, set the result, set monitoring of its calls, and so on.  It sounds somewhat vague, I admit, and at the first collision it looks strange, but, having figured it out, very soon you begin to feel this approach as completely natural in the context of working with stubs. </p><br><p>  An alternative implementation of the binding condition and call result is the methods of the <code>Mockito.do...</code> family <code>Mockito.do...</code>  These methods allow you to set the behavior starting with the result of the call and return an object of the <code>Stubber</code> class, with which you can set a condition.  The same binding as above performed in this way looks like this: </p><br><pre> <code class="java hljs">List&lt;String&gt; data = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ArrayList&lt;&gt;(); data.add(<span class="hljs-string"><span class="hljs-string">"dataItem"</span></span>); Mockito.doReturn(data).when(dataService).getData()</code> </pre> <br><p>  What is the difference, why is linking through <code>Mockito.when</code> considered preferable and when does one have to use the methods of <code>Mockito.do...</code> ?  Note: in the first implementation, when defining the behavior of a method (in this case, <code>getAllData()</code> ), the call to its not yet redefined version is first called, and only then, in the depths of the Mockito, the redefinition occurs.  In the second, such a call does not occur - the <code>Stubber.when</code> passed directly to the <code>Stubber.when</code> method, and already the object of the same type returned by this method, but of a different nature, is <code>Stubber.when</code> redefined method.  This difference determines everything.  Linking through <code>Mockito.do...</code> does not control at any time at the compilation stage which method to override which I call and whether it is compatible with the specified return value.  Therefore, it is usually preferable to <code>Mockito.when</code> - there can be no errors with it.  But there are cases when I want to avoid calling an unredefined method ‚Äî for a newly created mock, such a call is quite acceptable, but if I have already redefined this method or deal with spy, it may be undesirable, and when throwing an exception, it will not allow to perform the necessary redefinition .  And here comes the help of binding through <code>Mockito.do...</code> </p><br><p>  Another situation where you cannot do without the methods of <code>Mockito.do...</code> is the redefinition of the method returning <code>void</code> : waiting for the parameter <code>Mockito.when</code> cannot work with this method.  <code>Mockito.doReturn</code> here, of course, not in the business, but there is <code>Mockito.doThrow</code> , <code>Mockito.doAnswer</code> and quite rarely come in handy <code>Mockito.doNothing</code> . </p><br><p>  Next, I will discuss in a little more detail how to set conditions and results of calls.  I will consider only binding through <code>Mockito.when</code> - an alternative method is almost completely analogous to handling. </p><br><h3 id="zadanie-usloviy-vyzova">  Set call conditions </h3><br><p>  The example above concerns a method without parameters, and the condition of a call associated with it is possible one thing - the fact of the call itself.  As soon as parameters appear, the situation becomes more complicated.  At a minimum, to call a method whose behavior I set, I need to pass something to it.  But more importantly: it may turn out that I do not always want to receive the specified reaction, but only when calling with parameters that meet certain requirements.  <code>DataService</code> has this method: </p><br><pre> <code class="java hljs"><span class="hljs-function"><span class="hljs-function">String </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getDataItemById</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(String id)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-comment"><span class="hljs-comment">// some code... }</span></span></code> </pre> <br><p>  If I need to set a reaction to any call to this method regardless of the arguments, I have to use the <code>Mockito.any</code> method: </p><br><pre> <code class="java hljs">Mockito.when(dataService.getDataItemById(any())) .thenReturn(<span class="hljs-string"><span class="hljs-string">"dataItem"</span></span>);</code> </pre> <br><p>  If I want the mock to respond only to a specific value of the argument, you can use this value directly or the methods of <code>Mockito.eq</code> (if we are talking about equivalence) or <code>Mockito.same</code> (if comparison of links is required): </p><br><pre> <code class="java hljs">Mockito.when(dataService.getDataItemById(<span class="hljs-string"><span class="hljs-string">"idValue"</span></span>)) .thenReturn(<span class="hljs-string"><span class="hljs-string">"dataItem"</span></span>); <span class="hljs-comment"><span class="hljs-comment">// or Mockito.when(dataService.getDataItemById(Mockito.eq("idValue"))) .thenReturn("dataItem");</span></span></code> </pre> <br><p>  And if I want the argument to meet some requirements, there are a number of convenient specialized static methods of the same <code>Mockito</code> class (for example, strings can be checked for content at the beginning or at the end of a certain sequence of characters, for pattern matching, etc.).  There is also a common method Mockito.argThat (and its analogues for primitive types), which accepts the implementation of the ArgumentMatcher functional interface: </p><br><pre> <code class="java hljs">Mockito.when(dataService.getDataById( Mockito.argThat(arg -&gt; arg == <span class="hljs-keyword"><span class="hljs-keyword">null</span></span> || arg.length() &gt; <span class="hljs-number"><span class="hljs-number">5</span></span>))) .thenReturn(<span class="hljs-string"><span class="hljs-string">"dataItem"</span></span>);</code> </pre> <br><p>  The <code>ArgumentMatchers</code> and <code>AdditionalMatchers</code> classes allow you to work with some useful ready-made implementations of this interface.  For example, <code>AdditionalMatchers.or</code> and <code>AdditionalMatchers.and</code> allow to combine other matchers (note: the static methods of these classes do not return instances of matchers, but only refer to them!) </p><br><p>  For the same method, you can set the behavior several times with different requirements for the arguments, and all behaviors defined in this way will act simultaneously.  Of course, in some cases they may intersect - for example, I will require returning one result when getting the value of an <code>int</code> parameter less than 5 and the other when getting an even value.  In this situation, the priority is given to the behavior that is specified later.  Therefore, when defining complex behavior patterns, one should start with the weakest requirements (in the limit, <code>any()</code> ) and only then proceed to more specific ones. </p><br><p>  When working with methods with more than one argument, the specified requirements are combined in accordance with the logical AND, that is, to obtain a given result, EACH of the arguments must meet the stated requirement.  I did not find a way to specify an arbitrary way to combine them, although it may exist. </p><br><p>  In addition, when specifying the behavior of this method, it is impossible to combine the static <code>Mockito</code> methods used by <code>Mockito</code> and the direct transfer of values.  Use <code>Mockito.eq</code> or <code>Mockito.same</code> . </p><br><h3 id="zadanie-rezultatov-vyzova">  Call results </h3><br><p>  After the mock object method is called, the object must respond to the call.  The main possible consequences are returning the result and throwing an exception, and it is these options that are primarily intended for the Mockito toolkit. </p><br><p>  In the simplest case already shown above, the response to the call is the return of the value.  I will give his code again: </p><br><pre> <code class="java hljs">List&lt;String&gt; data = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ArrayList&lt;&gt;(); data.add(<span class="hljs-string"><span class="hljs-string">"dataItem"</span></span>); Mockito.when(dataService.getAllData()).thenReturn(data);</code> </pre> <br><p>  Please note: you can return only an object; there are no separate methods for primitives.  Therefore, if the method returns a primitive value, un / boxing will occur in such a situation.  In most cases, this does not interfere at all, but if the compiler thinks otherwise, you will have to somehow negotiate with it ... or accept its warnings. </p><br><p>  Throwing exceptions is no more difficult: </p><br><pre> <code class="java hljs">Mockito.when(dataService.getDataById(<span class="hljs-string"><span class="hljs-string">"invalidId"</span></span>)) .thenThrow(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> IllegalArgumentException());</code> </pre> <br><p>  There is another way: you can create an exception object and throw it directly, or you can provide a Mockito only an exception class so that it is automatically created: </p><br><pre> <code class="java hljs">Mockito.when(dataService.getDataById(<span class="hljs-string"><span class="hljs-string">"invalidId"</span></span>)) .thenThrow(IllegalArgumentException.class);</code> </pre> <br><p>  In both cases, the syntax allows you to use and checked exceptions, however, Mockito will not allow you to run such a test if the exception type does not match the method I want to force to throw this exception. </p><br><p>  When using a class as a parameter, constructors (even without parameters), as well as direct initialization of fields, are ignored - an object is created to bypass them (after all, it's Mockito!), So all fields of the thrown exception will be <code>null</code> .  Therefore, if the contents of the exception matter to you (say, some <code>type</code> field that has a default value), you will have to abandon this method and create exceptions manually. </p><br><p>  These response options are suitable if, in response to a call with the given conditions, you always have to return a certain, always the same result value or always throw the same exception, and in most cases these possibilities are quite enough.  But what if you need more flexibility?  Suppose my method takes a collection of values, and returns another collection of values ‚Äã‚Äãassociated with the first one to one (for example, retrieving a collection of data objects based on their ID), and I want to use this mock object repeatedly with different sets of inputs in the test data, getting each time the corresponding result.  You can, of course, describe separately the reaction to each specific set of parameters, but there is a more convenient solution - the <code>Mockito.thenAnswer</code> method, also <code>Mockito.then</code> as <code>Mockito.then</code> .  It accepts the implementation of the Functional <code>Answer</code> interface, whose only method receives an object of class <code>InvocationOnMock</code> .  I can request the parameters of the method call (one by number or all at once as an array) from the latter and deal with them as I please.  For example, you can get the corresponding value for each of the elements of my collection, form a new collection of them and return it (note: the desired result simply returns, and is not written to some field of the parameter object, as you would expect): </p><br><pre> <code class="java hljs">Mockito.when(dataService.getDataByIds(Mockito.any())) .thenAnswer(invocation -&gt; invocation .&lt;List&lt;String&gt;&gt;getArgument(<span class="hljs-number"><span class="hljs-number">0</span></span>).stream() .map(id -&gt; { <span class="hljs-keyword"><span class="hljs-keyword">switch</span></span> (id) { <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-string"><span class="hljs-string">"a"</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">"dataItemA"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-string"><span class="hljs-string">"b"</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">"dataItemB"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">default</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>; } }) .collect(Collectors.toList()));</code> </pre> <br><p>  Ideologically, this is something like writing a model of a real method: getting parameters, processing, returning a result.          -  ,    - ,      ,     ,    mock-    . </p><br><p>     <code>Answer</code> ,     , ‚Äî , <code>AnswersWithDelay</code> , <code>ReturnsElementsOf</code>  . . </p><br><p>  :  <code>InvocationOnMock</code>   ‚Äî       <code>Object[]</code> ,  generic-. </p><br><p>        ‚Äî <code>thenCallRealMethod</code> .    .     mock-,    spy-.   mock   ,      ,  -   <code>null</code> .  spy   <code>thenCallRealMethod</code>     spy  ;    ,     -      . </p><br><p>        <code>thenAnswer</code> :  <code>InvocationOnMock</code>   <code>callRealMethod()</code> ‚Äî   ,   ""    -  . </p><br><p>    <code>OngoingStubbing</code>    <code>OngoingStubbing</code> ,  ,   ,     .            ,   .  <code>thenReturn</code>  <code>thenThrow</code>   ,  varargs.       . </p><br><pre> <code class="java hljs">Mockito.when(dataService.getDataById(<span class="hljs-string"><span class="hljs-string">"a"</span></span>)) .thenReturn(<span class="hljs-string"><span class="hljs-string">"valueA1"</span></span>, <span class="hljs-string"><span class="hljs-string">"valueA2"</span></span>) .thenThrow(IllegalArgumentException.class);</code> </pre> <br><p>         <code>"valueA1</code> ,  ‚Äî <code>"valueA2</code> ( ),   (  )    <code>IllegalArgumentException</code> . </p><br><h2 id="slezhenie-za-vyzovami-metodov">     </h2><br><p>        :          (mock'    ),     .   ,     :   ,          ,       .      <code>verify</code> . </p><br><p>  ,           ,  : </p><br><pre> <code class="java hljs">Mockito.verify(dataService).getDataById(Mockito.any());</code> </pre> <br><p>      ,            <code>getDataById</code> ,  ,           . ,             Mockito,      <code>when</code> ,   ,  ,         mock-. , ,  ,      <code>when</code>  , ‚Äî      mock',       (. ). </p><br><p>           : </p><br><pre> <code class="plaintext hljs">Mockito.verify(dataService, Mockito.times(1)) .getDataById(Mockito.any());</code> </pre> <br><p>           <code>Mockito.times</code> ;       <code>Mockito.never</code> .    <code>Mockito.atLeast</code> (  <code>Mockito.atLeastOnce</code>   1)  <code>Mockito.atMost</code> ,       ,    <code>Mockito.only</code> , ,         mock-  (. .     ). </p><br><p>  ,         <code>Mockito</code> ,     <code>VerificationAfterDelay</code>  <code>VerificationWithTimeout</code> ,    <code>Mockito.after</code>  <code>Mockito.timeout</code> .  For example: </p><br><pre> <code class="plaintext hljs">Mockito.verify(dataService, Mockito.after(1000).times(1)) .getDataById(Mockito.any());</code> </pre> <br><p>    ,    mock   ,      ,              ,       .        .   <code>after</code>  <code>timeout</code>  ,          ,    ,    ‚Äî   ,     .  ,   <code>timeout</code>         ‚Äî       .   <code>VerificationWithTimeout</code>   <code>never</code>  <code>atMost</code> :         . </p><br><p>  ,             <code>Mockito.any()</code> .          ,   ,     ‚Äî    Mockito       ,    ,     . Mock-     ,        ,   , , : </p><br><pre> <code class="java hljs">dataService.getDataById(<span class="hljs-string"><span class="hljs-string">"a"</span></span>); dataService.getDataById(<span class="hljs-string"><span class="hljs-string">"b"</span></span>); Mockito.verify(dataService, Mockito.times(<span class="hljs-number"><span class="hljs-number">2</span></span>)).getDataById(Mockito.any()); Mockito.verify(dataService, Mockito.times(<span class="hljs-number"><span class="hljs-number">1</span></span>)).getDataById(<span class="hljs-string"><span class="hljs-string">"a"</span></span>); Mockito.verify(dataService, Mockito.never()).getDataById(<span class="hljs-string"><span class="hljs-string">"c"</span></span>); dataService.getDataById(<span class="hljs-string"><span class="hljs-string">"c"</span></span>); Mockito.verify(dataService, Mockito.times(<span class="hljs-number"><span class="hljs-number">1</span></span>)).getDataById(<span class="hljs-string"><span class="hljs-string">"c"</span></span>); Mockito.verifyNoMoreInteractions(dataService);</code> </pre> <br><p>      <code>verifyNoMoreInteractions</code> (  <code>verifyZeroInteractions</code> ) ‚Äî    -  (            <code>verify</code> )    mock- ‚Äî    .  :   varargs,     ,     ,         <strong> </strong> ! </p><br><p>       ,   ,      ,     .   ,    <code>InOrder</code> : </p><br><pre> <code class="java hljs">InOrder inOrder = Mockito.inOrder(dataService);</code> </pre> <br><p>     varargs;     ‚Äî    mock-   ,    <code>InOrder</code>                .     <code>verify</code>    ,   <code>Mockito.verify</code> : </p><br><pre> <code class="java hljs">inOrder.verify(dataService, times(<span class="hljs-number"><span class="hljs-number">2</span></span>)).saveData(any()); inOrder.verify(dataService).getData();</code> </pre> <br><p>       ,         <code>saveData</code> , <strong> </strong>  ‚Äî <code>getData</code> .  ,   <code>InOrder</code>    ,      ‚Äî     . </p><br><p>       ,   ,       ‚Äî , .      -      ,    ,      ‚Äî  ,     ,    .     <code>ArgumentCaptor</code>    <code>capture()</code> .  For example: </p><br><pre> <code class="java hljs">DataSearchRequest request = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> DataSearchRequest(<span class="hljs-string"><span class="hljs-string">"idValue"</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Date(System.currentTimeMillis()), <span class="hljs-number"><span class="hljs-number">50</span></span>); dataService.getDataByRequest(request); ArgumentCaptor&lt;DataSearchRequest&gt; requestCaptor = ArgumentCaptor.forClass(DataSearchRequest.class); Mockito.verify(dataService, times(<span class="hljs-number"><span class="hljs-number">1</span></span>)).getDataByRequest(requestCaptor.capture()); assertThat(requestCaptor.getAllValues()).hasSize(<span class="hljs-number"><span class="hljs-number">1</span></span>); DataSearchRequest capturedArgument = requestCaptor.getValue(); assertThat(capturedArgument.getId()).isNotNull(); assertThat(capturedArgument.getId()).isEqualTo(<span class="hljs-string"><span class="hljs-string">"idValue"</span></span>); assertThat(capturedArgument.getUpdatedBefore()).isAfterYear(<span class="hljs-number"><span class="hljs-number">1970</span></span>); assertThat(capturedArgument.getLength()).isBetween(<span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">100</span></span>);</code> </pre> <br><p> <code>ArgumentCaptor</code>       ,      <strong> </strong> ,   <code>ArgumentCaptor</code>  . <code>getValue()</code>    , <code>getAllValues()</code> ‚Äî     .   ,         ,   . </p><br><h2 id="mock-obekty-kak-znacheniya-poley-i-annotacii-mockito"> Mock-      Mockito </h2><br><p>      ,     mock-   ,      ‚Äî     <code>@Mock</code>   -       : </p><br><pre> <code class="java hljs">MockitoAnnotations.initMocks(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>);</code> </pre> <br><p> (  ,       mock',       ) </p><br><p>  spy   <code>@Spy</code> ‚Äî     <code>@Mock</code> ‚Ä¶   spy   ,      , ?          ,      ‚Äî  spy     . </p><br><p>   <code>@Captor</code>    <code>ArgumentCaptor</code> ‚Äî   , ,    . </p><br><p>   <code>@InjectMocks</code> .       -  Mockito,          .       mock-   ,   .        ,    .  -     ,     <code>null</code> ,   -     .         (      )  dependency injection. </p><br><h2 id="otkat-povedeniya-k-defoltnomu-i-sessii-mockito">       Mockito </h2><br><p>         ,  :   mock (spy, argument captor...),   ,    , .    ,  mock' ‚Äî    ,    . JUnit           ,      ,    TestNG   ‚Äî       . , ,   mock'    ,     ,   ,         . .  ,  ,  ‚Äî  ,          . </p><br><p>   ,             mock-    .  TestNG     <code>@BeforeMethod</code> ( <code>@AfterMethod</code>  ).           mock'   ,        ,           (    JUnit ‚Äî      <code>@Before</code> ). </p><br><p>   ,     , ‚Äî   <code>Mockito.reset</code>  <code>Mockito.clearInvocations</code> .   varargs,      mock'.      ,    .     :     (,              )  ,   /   mock'    , ‚Äî       .     ,    mock'       . .      , ,             . </p><br><p>       (,  ) ‚Äî     <code>MockitoAnnotations.initMocks(this);</code>  .    ""  ,   Mockito. </p><br><p>    ‚Äî     Mockito.    .     mock- ,          ( mock'      ).          ,      <code>MockitoSession</code> ,           .     TestNG: </p><br><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@Mock</span></span> DataService dataService; MockitoSession session; <span class="hljs-meta"><span class="hljs-meta">@BeforeMethod</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">beforeMethod</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ session = Mockito.mockitoSession() .initMocks(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>) .startMocking(); } <span class="hljs-meta"><span class="hljs-meta">@Test</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">testMethod</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-comment"><span class="hljs-comment">// some code using the dataService field } @AfterMethod public void afterMethod() { session.finishMocking(); }</span></span></code> </pre> <br><p>  ,        ‚Äî  ,  "" (,     )  ,   . </p><br><h2 id="chto-eschyo">  ? </h2><br><p>      Mockito:  mock  spy-,        .      ,       .  ,  , : </p><br><ul><li>  Mockito   mock-   <code>MockSettings</code> (      ‚Äî ,   mock'    -  ); </li><li>     mock-,   <code>MockingDetails</code> ; </li><li>   <code>BDDMockito</code>   <code>Mockito</code> ; </li><li>     (    JUnit       Mockito,     ). </li></ul><br><p>         <a href="https://static.javadoc.io/org.mockito/mockito-core/2.7.10/org/mockito/Mockito.html">  Mockito</a> .           javadoc'  <code>Mockito</code> . </p><br><p> , ,  . </p></div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <p>Source: <a href="https://habr.com/ru/post/444982/">https://habr.com/ru/post/444982/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../444972/index.html">Intel Gen11 GPU architecture and Intel discrete graphics card</a></li>
<li><a href="../444974/index.html">Cryptography in Java. Class MessageDigest</a></li>
<li><a href="../444976/index.html">Quester - Platform for creating and passing quests (Beta)</a></li>
<li><a href="../444978/index.html">EU authorities have fined Google $ 1.7 billion for blocking advertising of competitors</a></li>
<li><a href="../444980/index.html">Analysis of the critical error in the operation of the CIB SEARCHINFORM encryption algorithm</a></li>
<li><a href="../444984/index.html">Where do they get photos for testing face recognition systems</a></li>
<li><a href="../444986/index.html">IETF ACME Approved - This is the standard for working with SSL certificates.</a></li>
<li><a href="../444988/index.html">Synthesis as one of PostgreSQL performance improvement methods</a></li>
<li><a href="../444992/index.html">Errors embedded in the system: their role in statistics</a></li>
<li><a href="../444994/index.html">About disk drives and their use on modern computers</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>