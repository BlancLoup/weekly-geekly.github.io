<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>A prototype of a LED board for 262,144 color combinations and 64 pixels</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="I want to share the experience of creating an 8x8 pixel LED board, 262k color combinations (18 bits), a frame rate of 180 FPS and a USB connection. Al...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>A prototype of a LED board for 262,144 color combinations and 64 pixels</h1><div class="post__text post__text-html js-mediator-article">  I want to share the experience of creating an 8x8 pixel LED board, 262k color combinations (18 bits), a frame rate of 180 FPS and a USB connection.  Also ready to listen to suggestions for optimization and refinement.  In the future, I plan to use the work to create a display of a home weather station. <br><a name="habracut"></a><br><h1>  Foreword </h1><br>  It all started with the simplest control scheme of a line of 8 LEDs through the LPT-port.  The next version was a 5x8 scoreboard of three-color LEDs, which also connected to the LPT and in essence was an array of fifteen 8-bit buffers with a decoder for addressing them. <br>  Later, after meeting with microcontrollers, I set out to create a similar board, but with a USB connection.  Originally hoped to use only 8 colors.  Subsequently, I found a way to control the brightness of each diode using a timer, by analogy with PWM, and after finalizing the program part, the current device turned out.  Theoretically, it is possible to work with 16 million colors, but ordinary LEDs are not suitable for such a mode in terms of color reproduction and repeatability.  In addition, problems with the color of different diodes are already noticeable in the current configuration. <br><br><h1>  Description of work </h1><br>  The device is based on the PIC18F4550 microcontroller operating at 48 MHz.  A built-in USB controller and a ready-made library for working with it are used, Timer0 in 8-bit mode, which implements a dynamic display.  Three 8-bit triggers on 74F374 are used to store three colors in one column.  The use of such a buffer allows you to reduce the time to display one frame by 3 times.  <i>Note: When I selected the 74F374 buffer, I didn‚Äôt pay attention to the layout of its legs, but I realized this only on the mounting stand, so I had to significantly complicate the board.</i>  <i>It is better to use more convenient analogues.</i>  <i>For example, 74HC574.</i> <br>  LEDs are connected via keys ULN2803 and UDN2982.  Current-limiting resistances are only in the red channel, because  their supply voltage is below blue and green.  For blue and green resistance is not installed, because  enough voltage drops on the keys.  <i>Note: For more accurate color reproduction, it is better to choose more accurate current-limiting resistance in each channel.</i> <br>  The microcontroller, in an infinite loop, polls the USB state and, upon receipt of a data packet, depending on the command, starts / stops indication or prepares data for indication.  Due to the size limit of one packet of 64 bytes, data for each color is transmitted in a separate packet of 48 bytes - 6 bytes for each of the 8 columns, encoding the brightness of each LED in the column.  After receiving each packet, it is copied from the USB memory into an array of its own color. <br>  After receiving the command to start the display, the MC activates a timer in the 8-bit mode and a divider by 128. The timer uses the microcontroller's working frequency as clock pulses.  Increasing the timer counter occurs every 4 cycles.  The minimum period of the timer is 10.6 Œºs (1/48 * 4 * 128), which is about 2.8 times longer than the interrupt processing time (46 operations, compared to 128 timer counts). <br>  If the timer overflows, a high vector interrupt is performed.  The interrupt handler disables the indication, updates the data in the buffers, transferring 1 byte from each color array according to the cursor, then turns on the indication.  Pushes the new value into the timer from the temporary buffer, decrements the cursor, shifts the temporary buffer for the timer.  If the timer buffer has exceeded the maximum rate, i.e.  shifted more than 5 times, the timer buffer is reset to the minimum value and the pointer of the selected column is shifted. <br>  The result is the following dynamic display algorithm: <br><ol><li>  Take the first group of 3 bytes from three arrays and put them in buffers of each color in the column. </li><li>  We activate the timer with a minimum delay time of 128 cycles. </li><li>  We take the next group 3 bytes from three arrays and put them into buffers of each color in the column. </li><li>  Activate the timer double delay relative to the previous step. </li><li>  Repeat the sample 4 more times and double the delay time each time. </li><li>  We reset the timer and start processing the next column from step 1. </li></ol><br>  Thus, we can set 2 ^ 6 = 64 brightness options for each diode in the column.  Combining the brightness of each of the three basic colors, we get 64 * 64 * 64 = 262144 colors.  The processing time of one column is (2 ^ 6-1) * 10.6 Œºs = 672 Œºs.  The time for one frame of 8 columns is 672 * 8 = 5.4ms, which roughly corresponds to 186 frames per second. <br><br><h4>  Used components </h4><br><ul><li>  <a href="http://ww1.microchip.com/downloads/en/DeviceDoc/39632e.pdf">PIC18F4550</a> - Microcontroller </li><li>  <a href="http://www.nxp.com/documents/data_sheet/74F373_374.pdf">74F374</a> - Trigger for storing current column values </li><li>  <a href="http://www.ti.com/lit/ds/symlink/uln2803a.pdf">ULN2803</a> - The key to control the cathodes </li><li>  <a href="http://datasheet.octopart.com/A2982SLWTR-T-Allegro-datasheet-7562219.pdf">UDN2982</a> - Key for <a href="http://datasheet.octopart.com/A2982SLWTR-T-Allegro-datasheet-7562219.pdf">anode</a> control </li><li>  4-pin RGB LEDs with a common cathode (you can use any LEDs) </li></ul><br><h4>  Scheme </h4><br>  Schema in dsn format - <a href="https://docs.google.com/uc%3Fid%3D0B2AyAaX6M-XNdGw2RDI2Q3RNQzA">download</a> <br><div class="spoiler">  <b class="spoiler_title">Graphics</b> <div class="spoiler_text"><img src="https://habrastorage.org/files/3a7/12c/04d/3a712c04d97c427093da5fe3a1e4d38e.png"><br></div></div><br><h4>  Pay </h4><br>  Lay6 drawings - <a href="https://docs.google.com/uc%3Fid%3D0B2AyAaX6M-XNaWpfVy1Ic0Z2YXc">download</a> <br><div class="spoiler">  <b class="spoiler_title">Graphics</b> <div class="spoiler_text">  main module side 1 <br><img src="https://habrastorage.org/files/cf2/092/8c9/cf20928c993d4107b44c7d527a39c910.GIF">
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      main module side 2 <br><img src="https://habrastorage.org/files/c48/2b8/4ef/c482b84ef3df4522bfb2fb58b4f118b2.GIF"><br><br>  LED module (note that a blue jumper wire connects the columns) <br><img src="https://habrastorage.org/files/dad/828/dec/dad828dec0034a97aeb4668276240c2a.GIF"><br><br>  LED mounting matrix <br><img src="https://habrastorage.org/files/b80/843/5a6/b808435a6eac4d28997eb0f223d208a3.GIF"><br></div></div><br><h4>  Firmware </h4><br>  Sources and compiled HEX to MPLABX X IDE v2.30 - <a href="https://docs.google.com/uc%3Fid%3D0B2AyAaX6M-XNTlJZXzhCVEVlOFU">download</a> <br><div class="spoiler">  <b class="spoiler_title">Main code</b> <div class="spoiler_text"><pre><code class="cs hljs"><span class="hljs-meta"><span class="hljs-meta">#ifndef MAIN_C #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> MAIN_C // Local includes #include "config.h" #include "usb.h" #include "HardwareProfile.h" #include "usb_function_hid.h" #include "genericHID.h" #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> UdnOn LATA&amp;=0b11111110 #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> UdnOff LATA|=0b00000001 #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> UlnOn LATD #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> UlnOff LATD =0b00000000 #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> LineBufer LATB #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> WriteR LATE|=0b00000001 #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> WriteG LATE|=0b00000010 #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> WriteB LATE|=0b00000100 #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> WriteRst LATE =0b00000000 #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> Columns 8 #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> BrightLevels 6 #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> BlockSize (Columns*BrightLevels) #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> MinBright 0b11111111 unsigned char cursor; unsigned char bright; unsigned char column; unsigned char dataR[BlockSize]; unsigned char dataG[BlockSize]; unsigned char dataB[BlockSize]; void ProcessIO(void) { unsigned char temp = BlockSize + 1; // If we are not in the configured state just return </span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">if</span></span></span><span class="hljs-meta"> ((USBDeviceState &lt; CONFIGURED_STATE) || (USBSuspendControl == 1)) return; //Check </span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">if</span></span></span><span class="hljs-meta"> data was received from the host. </span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">if</span></span></span><span class="hljs-meta"> (!HIDRxHandleBusy(USBOutHandle)) { switch (ReceivedDataBuffer[0]) { case 0x80: // get red packet while (--temp) dataR[temp-1] = ReceivedDataBuffer[temp]; break; case 0x81: // get green packet while (--temp) dataG[temp-1] = ReceivedDataBuffer[temp]; break; case 0x82: // get blue packet while (--temp) dataB[temp-1] = ReceivedDataBuffer[temp]; break; case 0x90: // start column = 0b00000001; cursor = BlockSize; bright = MinBright; TMR0ON = 1; SWDTEN = 0; break; case 0x91: // stop UdnOff; UlnOff; TMR0ON = 0; SWDTEN = 0; break; case 0x92: // power off UdnOff; UlnOff; TMR0ON = 0; SWDTEN = 0; SLEEP(); break; } // Re-arm the OUT endpoint for the next packet USBOutHandle = HIDRxPacket(HID_EP, (BYTE*) &amp; ReceivedDataBuffer, 64); } } void main(void) { // Set all port as digital input/output PCFG3 = 1; // Clear all ports // 76543210 PORTA = 0b00000000; PORTB = 0b00000000; PORTC = 0b00000000; PORTD = 0b00000000; PORTE = 0b00000000; // Configure ports (1 - inputs; 0 - outputs) // 76543210 TRISA = 0b00000000; TRISB = 0b00000000; TRISC = 0b00000000; TRISD = 0b00000000; TRISE = 0b00000000; // Configure interrupts for Timer0 // 76543210 INTCON = 0b10100000; // Configure Timer0 as 8bit and 128 prescaler // 76543210 T0CON = 0b01000110; USBDeviceInit(); while(1) { // Check bus status and service USB interrupts. USBDeviceTasks(); // Application-specific tasks. ProcessIO(); }; } void interrupt tc_int() // High priority interrupt { UdnOff; UlnOff; LineBufer = dataR[cursor-1]; WriteR; LineBufer = dataG[cursor-1]; WriteG; LineBufer = dataB[cursor-1]; WriteB; UdnOn; UlnOn = column; WriteRst; TMR0L = bright; </span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">if</span></span></span><span class="hljs-meta"> (!--cursor) cursor = BlockSize; bright &lt;&lt;= 1; asm("BTFSS _bright, 5, 0"); asm("RLNCF _column, 1, 0"); asm("BTFSS _bright, 5, 0"); bright = MinBright; TMR0IF = 0; } #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">endif</span></span></span></span></code> </pre> <br></div></div><br><br><h1>  Device in operation </h1><br>  To control, I use an Internet radio player written in C, based on the BASS.DLL library.  A demo with a gradient across the entire available color palette works during pause, the frame refresh rate (packets sent to the device) - 20 Hz.  When playing music, the visualizer that uses the FFT array, obtained by BASS.DLL, works. The frame refresh rate (packets transmitted to the device) in this mode is 29 Hz. <br><br><div class="spoiler">  <b class="spoiler_title">Gradient</b> <div class="spoiler_text"><iframe width="420" height="315" src="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://www.youtube.com/embed/EwYiWDn-k9Y%3Ffeature%3Doembed&amp;xid=17259,15700021,15700186,15700190,15700248,15700253&amp;usg=ALkJrhhBJ4h7IEDqk-lGTs7FrGCaGXrIyw" frameborder="0" allowfullscreen=""></iframe><br></div></div><br><div class="spoiler">  <b class="spoiler_title">Visualizer</b> <div class="spoiler_text"><iframe width="420" height="315" src="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://www.youtube.com/embed/06Y_qoPF8rM%3Ffeature%3Doembed&amp;xid=17259,15700021,15700186,15700190,15700248,15700253&amp;usg=ALkJrhisMvYnDesUmDPhQwqt9qrAxxKLvA" frameborder="0" allowfullscreen=""></iframe><br>  music: Tape Five - Soulsalicious <br></div></div><br>  <i>Note: The video was shot through the glass from sunglasses (so you can not see the black dots of the vertical scan) and without frosted glass (it interferes with focusing).</i>  <i>Since</i>  <i>my LEDs are not matte, I stoch the lens on them and treated it with an engraver.</i> <br><br><div class="spoiler">  <b class="spoiler_title">Photo assembled</b> <div class="spoiler_text"><img src="https://habrastorage.org/files/0e5/ed5/b52/0e5ed5b52f6e40499186b89f0a293e0a.jpg"><br><img src="https://habrastorage.org/files/a2f/2bd/69c/a2f2bd69c3af4b09bded9ecd90e7a7df.jpg"><br><img src="https://habrastorage.org/files/213/ef4/045/213ef404544c49baa6e1169ff81ffde4.jpg"><br><img src="https://habrastorage.org/files/6a1/218/2d8/6a12182d8c194235bf99c06f931494f7.jpg"><br></div></div><br><h1>  What can be improved </h1><br><ul><li>  replace keys with faster ones (especially for UDN) </li><li>  implement USB operation through interrupts </li><li>  use frosted LEDs or smd to simplify light scattering and mixing </li><li>  74F374 is better to use 74HC574 in place, which will greatly simplify the layout of the board </li><li>  add capacitance to each 74F374 circuit to protect against interference </li><li>  74HC138 descrambler can be used to select columns, which will save the legs of the MK </li><li>  To reduce the cost of the circuit, you can use LEDs with a common anode and use 3 cheaper ULN keys instead of UDN </li></ul></div><p>Source: <a href="https://habr.com/ru/post/392815/">https://habr.com/ru/post/392815/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../392799/index.html">Getting out of the comfort zone as a new business model</a></li>
<li><a href="../392803/index.html">Sony Xperia Z5 Premium comes in pink</a></li>
<li><a href="../392807/index.html">Smart room that helps in the work</a></li>
<li><a href="../392811/index.html">Game Patent for Boot Screens Gone</a></li>
<li><a href="../392813/index.html">Australian Craig Wright is going to prove that he is Satoshi Nakamoto, the creator of Bitcoin</a></li>
<li><a href="../392817/index.html">Death examination</a></li>
<li><a href="../392819/index.html">Vice-President of Jet Pack International crashed on a jetpack (alive, stable)</a></li>
<li><a href="../392823/index.html">High school students assembled a fusion reactor in the garage and set up experiments</a></li>
<li><a href="../392825/index.html">Reincarnation of the "popular" board TP4056 or self-made charging for lithium at 3A</a></li>
<li><a href="../392827/index.html">Robiton PM1 and PM2 power meters</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>