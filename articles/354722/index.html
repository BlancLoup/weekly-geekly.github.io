<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Failover VoIP Cluster 3CX</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="The 3CX failover cluster consists of two replicated PBX servers. When the main server fails, the replica server is activated, minimizing the time of t...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Failover VoIP Cluster 3CX</h1><div class="post__text post__text-html js-mediator-article">  The 3CX failover cluster consists of two replicated PBX servers.  When the main server fails, the replica server is activated, minimizing the time of telephony failure.  In this article, we will look at how to correctly configure the fault tolerance of the 3CX PBX. <br><br><h3>  Licensing </h3><br>  To use fault tolerance, you will need one Enterprise (ENT) or Professional (PRO) license.  The ENT license sets the lifetime (TTL) of the 3CX A-record FQDN of the server to 5 minutes.  In the PRO TTL license, A-records are set to 6 hours.  This means that in the PRO edition, the time for emergency reconnection of IP phones, 3CX clients, 3CX SBC clients and the web client will be much higher. <br><br><h3>  Fault tolerance implementation </h3><br>  3CX uses the principle of active-passive cluster with configuration replication once every minimum of 24 hours.  The primary (active) node performs the processing of VoIP calls, and the backup (passive) node monitors the active host.  If the active host fails (regardless of the cause), the passive host starts working from approximately the same state.  The mechanism for determining the failure of an active host depends on the settings on the passive host and is discussed below. <a name="habracut"></a>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h3>  Supported Network Topologies </h3><br>  3CX failover cluster is designed to work in the following topologies: <br><br><ul><li>  Local Server (NAT) <br></li><li>  Cloud (public server) <br></li></ul><br><img src="https://habrastorage.org/getpro/habr/post_images/426/c16/b5f/426c16b5fde5ac31161e50de7ea9457f.png"><br>  Fault tolerance between local and cloud nodes is not officially supported.  It is also assumed that the FQDN of the 3CX server is provided and maintained by 3CX.  Of course, you can use a more complex topology and your own FQDN name, but in this case, managing DNS records and reconfiguring devices is the responsibility of the system administrator. <br><br><h3>  Prerequisites </h3><br>  Before running a failover cluster on 2 servers, 3CX server should be installed as follows: <br><br><ul><li>  One 3CX in the cloud (first public IP) and another PBX in the cloud (second public IP) with a FQDN name from 3CX <br></li><li>  Both servers are installed with identical settings - the same FQDN, SSL certificate and SIP ports, tunnel and web server. <br></li><li>  In the IP phone auto configuration tab, you must specify the interface as a FQDN, and not as an IP address (see below). <br></li></ul><br>  In other topologies, for example, one node in the private network and the other in the cloud, you need to use scripts to update the DNS A records.  Scripts must be executed at the time of the failover.  Below we will talk about this in more detail. <br><br><h3>  Configure the primary node </h3><br>  Suppose that the main (active) server is already installed and configured 3CX v15.5. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/cfd/7a3/324/cfd7a3324d39d7871f83e58e543c55a4.png"><br><br>  For all extensions, specify the option of auto-configuring IP phones via the FQDN (Auto-configuration tab of the phone, option Select interface). <br><br><img src="https://habrastorage.org/getpro/habr/post_images/9d3/c6a/b41/9d3c6ab41e5936e524f11e6cf31c3be6.png"><br>  In the Backup section, click the Location button and select Google Drive.  You can choose a different location accessible from both servers.  In our example, the cluster stores the configuration in the SIP3CXCOMBackups folder on Google Drive. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/dae/590/518/dae5905189ebbae9d895bf5841ce357e.png"><br><br>  Click the Backup Plan button and select the data that you want to synchronize in the cluster, as well as the synchronization time.  It is recommended to set up daily night synchronization, as shown above.  The backup file name 3CXScheduledBackup.zip has been re-sliced ‚Äã‚Äãto 3CX for the last unloaded configuration and is used by both nodes in the cluster. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/522/956/a28/522956a283607e1f4e23beb65a5880d9.png"><br><br>  In the same section, click the Failsafe button, enable the Enable backup option and select Backup Switch Mode - Primary. <br>  This completes the configuration of the active cluster node. <br><br><h3>  Backup node setup </h3><br>  Install 3CX on the backup server, taking into account the prerequisites listed above.  Please note that if your primary and backup servers use different public IP addresses, after installing a backup server, the common FQDN of the cluster will be resolved to the backup node (and first, after installing the primary server, it resolves to its IP).  In order to associate the FQDN with the IP address of the main server again, on the main server in the Home section, click the License link, then click Change and OK.  Now the FQDN will start pointing to the IP of the main server again. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/ced/14c/8ce/ced14c8ce26c58cd81fefc236212462e.png"><br>  Go to the Backup section and click the Recovery Plan button.  Turn on recovery and specify the recovery time (of course, it should be a little bit later than the backup time).  Then set the Do not start services after recovery option. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/8c7/cbe/2c4/8c7cbe2c49e5bf116d1641ccc73dd11e.png"><br>  In the same section, click the Failsafe button, enable the Enable backup option and select Backup Switch Mode - Backup.  Specify the IP address of the main server (in our example 1.1.1.1) and the services that should be monitored: SIP Server, Web Server or Tunnel Server.  Set the check interval and the switching triggering logic ‚Äî when only one service or all services ‚Äúcrashes‚Äù. <br><br>  If the backup server detects a primary failure, it is activated using the data from the last restored backup.  In addition, it notifies DNS 3CX (which is located in the Google infrastructure) of the change of the A-record FQDN to the IP address of the backup host. <br><br>  It is important that the ‚Äúfallen‚Äù primary server be completely shut down, because if it has 3CX services running on it, there may be a conflict with similar services on the backup node. <br><br>  It should be noted that 3CX does not officially support the operation of FXO or FXS gateways in a failover cluster, since the interaction of the gateways and the server in such a topology depends on the features of the vendor, the specific model and firmware version. <br><br><h3>  Scripts in a complex topology </h3><br>  If you use your own FQDN in the LAN-LAN topology or the LAN-Cloud topology, you need to use special scripts (in Windows, this is <a href="">Powershell fault-tolerance scripts for Active Directory</a> ) that run with certain privileges. <br>  By default, scripts that can run during the backup switching process run with the privileges of the 3CX Event Notification Manager service (by default, Local System).  As a rule, to run the script, you need the privileges of managing the DNS server (dnscmd or psexec). <br><br><img src="https://habrastorage.org/getpro/habr/post_images/cc8/b5a/cfb/cc8b5acfb9bddad718119aa3a3691646.png"><br><br>  Click on the service in the corresponding Windows snap-in and on the Log On tab, change the account from the Local System to the one that has the appropriate privileges to configure the DNS, and restart the service.  It is recommended that you create a separate user with this privilege and set him an unchangeable password. </div><p>Source: <a href="https://habr.com/ru/post/354722/">https://habr.com/ru/post/354722/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../354712/index.html">Hosting VPS: Windows or Linux?</a></li>
<li><a href="../354714/index.html">Bioyino - a distributed, scalable metric aggregator</a></li>
<li><a href="../354716/index.html">Tracing and Javascript</a></li>
<li><a href="../354718/index.html">Clang. Part 1: introduction</a></li>
<li><a href="../354720/index.html">Mikrotik - collecting and analyzing NetFlow traffic</a></li>
<li><a href="../354724/index.html">Marvin Minsky "The Emotion Machine": Chapter 3 "The Pain"</a></li>
<li><a href="../354726/index.html">Who scans the Internet and does Australia exist</a></li>
<li><a href="../354728/index.html">Own asynchronous tcp-server in 15 minutes with detailed analysis</a></li>
<li><a href="../354730/index.html">We reanimate the Nintendo Switch and PlayStation gaming service after locks on the RKN</a></li>
<li><a href="../354732/index.html">Developing a simple deep learning model for predicting stock prices using TensorFlow</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>