<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Specification of system calls of the Chameleon operating system (be careful, lots of pictures!)</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Health to all readers! 

 We offer you a description of the system calls the microkernel operating system Chameleon aka Xameleon. My chameleon has not...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Specification of system calls of the Chameleon operating system (be careful, lots of pictures!)</h1><div class="post__text post__text-html js-mediator-article"> Health to all readers! <br><br>  We offer you a description of the system calls the microkernel operating system Chameleon aka Xameleon.  My chameleon has not yet hatched from his egg and is gaining strength in a virtual machine.  But he is very lonely and the little lizard wants to get to know the inhabitants of Habr. <br><br>  The ‚Äúmicro-core vs monolith‚Äù dispute has been going on for many years, but do both arguing parties represent the architecture of a micro-core system?  Perhaps this topic will shed some light on the architecture of micro-core systems. <br><a name="habracut"></a><br>  The document has a long history - once I realized that I had given too much time to Chameleon, from which I got problems in my main job.  Therefore, it was decided to kill two birds with one stone and to write an article advertising the report generator and, finally, to create documentation.  At first she was in broken English, but at some point it was decided not to disgrace and rewrite to a slightly better Russian. <br>  Actually, the document revision history: <br><img src="https://habrastorage.org/getpro/habr/post_images/795/20b/27d/79520b27d0d93bc0b189c36862e29691.gif"><br>  Let's get down to business.  The Chameleon operating system can be displayed as follows: <br><img src="https://habrastorage.org/getpro/habr/post_images/954/e2c/f8d/954e2cf8dc2f21b89bde0ad8f5b03a1c.gif"><br>  It is based on the L4 Pistachio microkernel.  The microkernel consists of two modules: the L4Ka Pistachio microkernel itself and the L4 Sigma0 basic memory manager.  The best way to learn more about Pistachio is from this document: <a href="http://l4ka.org/l4ka/l4-x2-r7.pdf">L4 Version X.2 Reference Manual (Latest snapshot, July 19 2010)</a> . 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      The Chameleon operating system is what is above the microkernel.  The system is organized in the form of several processes working on top of the microkernel and interacting with each other and with the microkernel through IPC (Inter Process Communication) ‚Äîspecific system calls that implement synchronous message transmission.  The basic rule of the system is that any interaction between an application and a system is (with a few exceptions) based on IPC.  The requesting task generates a message in a special way, then calls the IPC, which sends the message to the receiving task.  Some IPCs are blocked until a response is received, while others are blocked until they are received by the receiving party.  Synchronicity imposes a requirement for successful transmission of a message ‚Äî the receiving party must listen to them.  Hence the conclusion that some tasks must constantly listen to messages.  Such tasks in Chameleon are Supervisor, File System, Network Stack, device drivers.  The good news for us is the fact that a task in the state of waiting for a message does not consume the computational resources of the processor and gives its time to other tasks.  The most interesting thing for us is that the L4 concept uses one primitive for sending and receiving messages - this is an IPC message.  The message at the kernel level is organized by one system call, which may have several combinations of the transmission and reception phases. <br><br>  The specification describes the following types of data, of which the first five types are represented by the microkernel: <br><img src="https://habrastorage.org/getpro/habr/post_images/e23/a03/3cb/e23a033cb5c528e0adc5d32343ba3e92.gif"><br><br>  And now let's take a close look at Chameleon‚Äôs basic service - Supervisor.  From the point of view of the microkernel, the Supervisor is nothing but the first user task, so any other task, be it an application program, service or driver, can get the Supervisor's ThreadID via KIP (Kernel Interface Page - the basic concept of the L4 microkernel) ThreadID of other subsystems (using the GetDeviceHandle system call). <br><br><img src="https://habrastorage.org/getpro/habr/post_images/559/8b8/305/5598b83052aa2db956fd0c790af58323.gif"><br><img src="https://habrastorage.org/getpro/habr/post_images/958/e70/f99/958e70f99e62da4e55adca6ead92df73.gif"><br>  Twenty-two system calls for resource management.  This is quite enough to allocate and free virtual memory, start a process prepared in memory in advance, start a protocol driver / implementation, send a signal to a process, create a program flow (execution thread), wait for the process to finish, set a process timer and perform several other functions. . <br><br>  Consider some of the system calls in more detail.  Since the Supervisor is able to launch a new process for execution, the memory of this process must be prepared in advance.  Accordingly, we need a memory block where we put the new process before its execution.  You can request memory for a process using the following system call: <br><img src="https://habrastorage.org/getpro/habr/post_images/20d/a44/3de/20da443de6c7537c006858e15f550fdf.gif"><br>  As I said above, the first version of the documentation was in broken English.  Unfortunately, I did not have time to Russify the entire specification, so the description of the message body remained on the "ruglish". <br>  The symmetric system call for working with allocated memory is called ReferencingSegment.  In order to release a previously allocated memory segment, you need to reset the reference counter for this segment using the ReferencingSegment call.  At the same time, the segment itself and the virtual memory pages occupied by it are available for subsequent allocation using AllocateSegment: <br><img src="https://habrastorage.org/getpro/habr/post_images/f6e/c26/394/f6ec26394c6812e5f4591a4b7a0663df.gif"><br><br>  A process can also terminate itself using the ExitProcess call: <br><img src="https://habrastorage.org/getpro/habr/post_images/c02/9ce/88c/c029ce88c50cd807ca1c9f27aff02211.gif"><br>  Unlike previous messages, this message has no reception phase.  This is due to the fact that the process after the transfer of this message is completed, so the Supervisor does not send an acknowledgment.  The message conveys one parameter - the return code.  This code will be passed to a task waiting for the process to terminate using the ProcessWait system call: <br><img src="https://habrastorage.org/getpro/habr/post_images/a04/cee/572/a04cee57262b194ec15e028f6d577c9a.gif"><br><br>  Since the IPC microkernel uses synchronous calls, in many cases, the limitations imposed by synchronism can be circumvented using multithreading.  Any process can create a program flow (execution thread) in its address space.  In this case, all threads share common resources.  The following system call creates a new program flow: <br><img src="https://habrastorage.org/getpro/habr/post_images/77d/27d/f55/77d27df556f9388b0155b6a2c40a9ea3.gif"><br>  If threads are created, then there must be a way to stop them and free resources.  To do this, use the ExitThread system call: <br><img src="https://habrastorage.org/getpro/habr/post_images/0d6/b13/e29/0d6b13e29c4fc6af861e02ff9d18f5f2.gif"><br>  A bit of humor: "What is common to the process of the Chameleon system and amoebas - they multiply by division."  But seriously, in this case the bike was not invented, and the POSIX fork () was taken as the basis: <br><img src="https://habrastorage.org/getpro/habr/post_images/ea0/16d/18b/ea016d18b1d4c78330614c2e548b4808.gif"><br>  Implementing the fork () function based on the L4 primitives is a non-trivial, but doable, task.  The chip of this call is that it calls one process, and the answer is received by two processes - the caller and the newly created copy of the calling process.  Of course, both processes, the initiator and its copy, will be executed in different address spaces. <br><br>  The process can clone itself and we come to an interesting challenge - creating a new task from a prepared image.  Pay attention to MR2 (Message register 2) - it passes the handle to the memory block of the process being started.  This memory block should be created using the AllocateSegment system call described above and a prepared image of the process being started should be stored in it.  Also, the system call sets the basic process parameters - the entry point, the beginning and the size of the code, data and BSS segments. <br><img src="https://habrastorage.org/getpro/habr/post_images/7aa/0cc/914/7aa0cc9141ca9e6ba834da839bb9fd99.gif"><br>  Note the last two parameters passed in the ExecProcess message.  You can see the data types not yet discussed above - Compound.  In the message body, not the elements themselves, their descriptors are transmitted.  In the case of the ExecProcess message, these descriptors point to two memory blocks - the first memory block transmits char ** argv, the second memory block transmits char ** envp - analogs of the arguments of the function <i>int main (int argc, char ** argv, char ** envp)</i> . <br><br>  The supervisor is a basic service and it provides an interface to access other registered services.  For example, a certain task wants to work directly with the serial port driver, without using the file system.  You can learn the ThreadId of the registered serial port driver using the GetDeviceHandle system call: <br><img src="https://habrastorage.org/getpro/habr/post_images/c5c/9f9/35e/c5c9f935e988a87bf670a519afc45d4f.gif"><br>  Using the thread ID of the ThreadID process obtained by GetDeviceHandle, we can send messages to it and receive responses from it.  The message format depends on the type of device and can be described by one of the following protocols: <br><ul><li>  exchange format with the service; </li><li>  exchange format with a block device; </li><li>  exchange format with a character device; </li><li>  exchange format with a network device. </li></ul><br><br>  Download the full (pre-alpha) version of the specification in PDF format at the link: <a href="http://l4os.ru/ProtocolSpecRus.pdf">Xameleon protocol family specification</a> .  The document is still very raw, but I hope that your comments will give strength to correct it further. <br><br>  You can discuss the system call, clarify, point out an error or ask a question not only on Habr√©, but also on this page: <a href="http://fotki.yandex.ru/users/almandrykin/album/164974/">fotki.yandex.ru/users/almandrykin/album/164974</a> - select a picture and ask your question in the comments. <br><br>  It so happened that the description of even several system calls of the Supervisor is too big.  If interest is noticed, then the description of the remaining system calls of the Supervisor is possible, as well as the description of the system calls of the Falova system, the Network subsystem, and also the system calls of the drivers of block, character, and network devices. <br><br>  Finally, a few words about what development tools can be used to write programs for the Chameleon system.  For development, you can use any programming language that can create executable files in Elf or PE format - gcc, g ++, Visual C ++, various Pascal compilers.  In the general case, the compilation process is similar to compilation on any other system, but the main rule is not to use the standard libraries supplied with the compiler.  Chameleon's current implementation uses the original Elf-based libc and the original crt0, which provide a subset of POSIX functions.  Almost nothing prevents to compile this libc with a compiler that generates object code in PE format and to assemble MS Visual C ++ programs with a compiler.  It is also possible to implement system calls in the Pascal language and then no one else will say that this language is not created for system programming. <br><br>  ps When creating the documentation, the FastReport report generator was used. <br>  pps My English is really bad.  Please treat us indulgently.  I promise to translate the entire document into Russian. </div><p>Source: <a href="https://habr.com/ru/post/119283/">https://habr.com/ru/post/119283/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../119277/index.html">Smallest HD display: just 4.8 inches</a></li>
<li><a href="../119279/index.html">The book "Working with Postgresql: setting, scaling", version 2</a></li>
<li><a href="../119280/index.html">Spam - as a means of transmitting encryption?</a></li>
<li><a href="../119281/index.html">Spree 0.60.0 released</a></li>
<li><a href="../119282/index.html">About how to create and finance public projects in the field of e-Government</a></li>
<li><a href="../119284/index.html">Another Canvas Guide [2]: Styling, Gradients, Shadows</a></li>
<li><a href="../119285/index.html">Context menu design</a></li>
<li><a href="../119286/index.html">Solving parental control issues in Ubuntu with Dansguardian and Privoxy</a></li>
<li><a href="../119287/index.html">3D interface of future OS from Microsoft</a></li>
<li><a href="../119289/index.html">FAQ on Gemei A330</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>