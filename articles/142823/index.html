<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Using additional CPU instructions in one of the PHP tasks to speed up performance</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="When building large PHP projects, many faced a lack of performance, even on powerful servers. Even a small piece of code can significantly affect the ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Using additional CPU instructions in one of the PHP tasks to speed up performance</h1><div class="post__text post__text-html js-mediator-article"> When building large PHP projects, many faced a lack of performance, even on powerful servers.  Even a small piece of code can significantly affect the entire resource as a whole: in terms of profit, and in terms of the costs of support and maintenance of this resource.  I will tell you my experience about a non-standard approach to solving one problem. <br><br>  Over the course of the year, we constantly added new functionality: we wrote more code, created more modules, modules from modules, more tables with millions of records that participated in cross-sampling.  The project grew with great speed.  The composition of the developers has changed more than once, and this, though not essential, but, nevertheless, adversely affected the project, which also added unnecessary problems.  In general, a fairly large project, as is the case with large companies. <br><br>  Already when everything is written, it works, and continues to be further developed, and neither time nor budget redoing anything ‚Äî in order to improve performance ‚Äî no, and you only need to move forward, and as soon as possible, I get another task.  At first I looked at it as a regular ticket: all personal information of the user: last name, address, telephone number, identification code - should be stored in the database in an encrypted form, and can only be accessed by querying with the decryption keys.  Since this is my first serious experience related to data encryption, I began to search Google for possible solutions to the problem using PHP, and naturally I came across the well-known library mcrypt.  It does not take much time to figure out how to work with it.  The library worked - on the forums you can find many examples, comments, discussions.  It seemed to me an ideal option for solving my problem, especially considering that there was very little time. <br><a name="habracut"></a><br>  As a result, I used code that is located right on the page describing the mcrypt_encrypt function: <br>  <a href="http://us2.php.net/manual/en/function.mcrypt-encrypt.php">http://us2.php.net/manual/en/function.mcrypt-encrypt.php</a> <br> <code>&lt;?php <br> $iv_size = mcrypt_get_iv_size(MCRYPT_RIJNDAEL_256, MCRYPT_MODE_ECB); <br> $iv = mcrypt_create_iv($iv_size, MCRYPT_RAND); <br> $key = "This is a very secret key"; <br> $text = "Meet me at 11 o'clock behind the monument."; <br> echo strlen($text) . "\n"; <br> $crypttext = mcrypt_encrypt(MCRYPT_RIJNDAEL_256, $key, $text, MCRYPT_MODE_ECB, $iv); <br> echo strlen($crypttext) . "\n"; <br> ?&gt; <br></code> 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Everything works well, except for one small BUT: the 5th parameter is $ iv (it is also IV - initialization vector) in the mcrypt_encrypt function out of place - since it is not used at all in the ECB ( <a href="http://en.wikipedia.org/wiki/Block_cipher_modes_of_operation">Electronic codebook</a> ) encryption mode.  And in general, I wonder why this example is present in the documentation - it is confusing. <br><br>  Our Engineer Lead conducted a code review, and made two well-reasoned comments: <br><ol><li>  IV is not used in ECB mode (about which I wrote above) - this is with regard to safety, it does not deal with productivity. </li><li>  mcrypt is too heavy and slow to allow to call it on each page load, it is better to find pieces of code where you really need this data and only decrypt it in those cases. </li></ol><br>  The first is not a problem, google further, you immediately come across the CBC mode ( <a href="http://en.wikipedia.org/wiki/Block_cipher_modes_of_operation">Cipher-block chaining</a> ).  But what to do with the second one is that you need to search through all the modules, because the users' names are used on almost every page of the site.  This is too much, I thought, considering the timing, the risks - after all, QA will still have to pass. <br><br>  One evening, discussing daily problems related to work, drinking beer with a friend who is far from PHP and ‚Äúthese‚Äù problems, but very experienced in low-level programming and C ++ - this turned out to be not only a pleasant pastime, but also very useful for work. <br>  He revealed one secret to me (in fact, only for me it was a secret, but for the world of C ++ programmers, of course, this is obvious): if you use certain processor instructions, you can raise the performance of computing tasks 10 times, including tasks related to data encryption.  The new intel processors already support instructions for accelerating data encryption and decryption - <a href="http://en.wikipedia.org/wiki/AES_instruction_set">Advanced Encryption Standard (AES) Instruction Set</a> .  And fortunately, as it turned out, our project runs on servers with Intel Xeon E5645 processors that already have these instructions available ( <a href="http://ark.intel.com/products/48768/Intel-Xeon-Processor-E5645-%252812M-Cache-2_40-GHz-5_86-GTs-Intel-QPI%2529">AES New Instructions</a> ). <br><br><h6>  But how to use all this in PHP? </h6><br>  We will write our PHP module, which will take the value of PHP and encrypt / decrypt using the capabilities of the processor.  After several sleepless nights, comparing the results of performance and in general - the concept of what the module should do, where and how to store the vector with the data (after all, it is necessary for decoding) - the following has happened. <br>  PHP module consisting of two parts: <br><ol><li>  Botan ( <a href="http://botan.randombit.net/">http://botan.randombit.net/</a> ) is an open library written in C ++, which implements many encryption algorithms, including AES256, which we need, and at the same time has the ability to use AES-NI. <br></li><li>  libaecrypt ‚Äî already our part ‚Äî serves as an adapter for the C ++ interface of the Botan library into the C interface (functions, not classes), which can be called from the main C file of the module. </li></ol><br>  In the module, we implemented three functions: <br><ol><li>  Random Key Generator - returns random data of length N bytes, which can be used as a key or a vector. </li><li>  Encryption </li><li>  Decryption </li></ol><br>  Encryption / decryption - uses as parameters: <br><ul><li>  data key - 32 bytes, which must be created once and hidden </li><li>  key of the vector - 32 bytes, which must also be created once and hidden </li><li>  IV - 16 bytes, which is created by a "random key generator" </li></ul><br><br>  The algorithm looks like this: random IV is generated, then the data is encrypted using the data key and IV;  encrypted vector using key vector.  The encrypted vector is added to the encrypted data with the separator # and stored in the database, the decoding is in reverse order. <br><br><h6>  The main feature of Botan: </h6><br>  I do not think that it is reasonable to lay out the code listings in the article, because there are a lot of them, so I‚Äôll tell you about the module initialization, which is the juice. <br>  Included with the library Botan, is an auxiliary tool that allows you to determine the processor and its instructions (botan / cpuid.h).  To speed up encryption / decryption, it is checked whether the processor has an AES-NI;  if not, then is there SSSE3. <br> <code>int Init() <br> { <br> //   <br> pInitObj = new Botan::LibraryInitializer(); <br> <br> //    <br> CPUID::initialize(); <br> <br> //        <br> if(CPUID::has_aes_ni()) <br> global_state().algorithm_factory().set_preferred_provider("AES-256", "aes_isa"); <br> else if(CPUID::has_ssse3()) <br> global_state().algorithm_factory().set_preferred_provider("AES-256", "simd"); <br> else <br> global_state().algorithm_factory().set_preferred_provider("AES-256", "core"); <br> <br> return 1; <br> } <br></code> <br><br>  As a result, the Apache - ab (Apache Benchmark) load testing tool showed the difference between our module and the implementation of the same algorithm using mcrypt: approximately 600 requests / second versus 1400 requests / second - in favor of our module. <br><br><h6>  Conclusion: </h6><br><br>  OpenSSL, which also comes with PHP, starting with version 1.0.1, released on March 14, 2012 (after all our torments), already already knows how to use AES-NI instructions (and SSSE3), and in performance is a similar algorithm written in PHP c OpenSSL, gives our module only 200 requests per second ( <a href="http://en.wikipedia.org/wiki/AES_instruction_set">Software supporting AES instruction set</a> , OpenSSL from version 1.0.1 is in the list). <br>  Personally, in the future, I will use OpenSSL, instead of MCrypt.  Besides the fact that mcrypt is slower, it requires a key of <u>32 bytes</u> as an initialization vector <u>!</u>  - which is not quite standard, since OpenSSL, Botan, and as I understand it, many other libraries implementing encryption in AES256-CBC mode accept a key for an IV of <u>16 bytes</u> .  If you use mcrypt, then only they can decrypt the data. <br><br>  - <b>UPD1:</b> As for the code samples and the link to my module: the problem is that I signed a contract that does not allow me to publish the source code of the project publicly, because  This may affect security (we are talking about 100 thousand US users).  But I will try today to post a modified version of the module for viewing in order not to violate the terms of the contract. <br><br>  <b>UPD2:</b> I was surprised by the sharp negativity and minus in karma, so I want to say: I wanted to share my experience, tell you that if you are working in PHP and are dealing with encryption, then mcrypt is not the best choice, since this library has performance problems.  The php package also comes with OpenSSL, which since version 1.0.1 (as I wrote above), uses processor instructions, runs much faster and performs data encryption perfectly.  After the release of the new version of OpenSSL, our self-written module no longer matters, but this, unfortunately, was before its release, and again I note that we had too little time. <br><br>  <b>UPD3:</b> Once again, please note that 25k Page Views and performance problems of <u>our</u> project are not the main point, please focus on the main conclusion from my experience: using AES-NI (processor instructions for speeding up performance) and OpenSSL vs.  MCrypt.  Thanks to everyone who commented and expressed his opinion, I will try to rewrite the article as soon as possible in order to pay more attention to AES-NI, OpenSSL vs.  MCrypt and how to write a module for PHP. </div><p>Source: <a href="https://habr.com/ru/post/142823/">https://habr.com/ru/post/142823/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../142817/index.html">Facebook can refuse 30% of the commission and change the rules of the game throughout the market.</a></li>
<li><a href="../142818/index.html">Image processing matrix filters</a></li>
<li><a href="../142819/index.html">Multi-client Network Protocol on C #</a></li>
<li><a href="../142820/index.html">Google launches 3D virtual travel on Google Maps</a></li>
<li><a href="../142821/index.html">Festival of international multimedia creativity "Multimatograf"</a></li>
<li><a href="../142824/index.html">Draw me completely or how to stretch the "submit" and "button"</a></li>
<li><a href="../142825/index.html">Finding the maximum common subsequence</a></li>
<li><a href="../142826/index.html">WWDC 2012 will be held from June 11 to 15</a></li>
<li><a href="../142827/index.html">The future of microservers on MIPS processors</a></li>
<li><a href="../142828/index.html">STALKER received an heir</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>