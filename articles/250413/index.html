<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>How Elasticsearch can help you find suspicious site activity</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="I propose to the readers of Habrakhabr a translation of the article ‚ÄúSpotting bad actors: from your official blog Elasticsearch . The article talks ab...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>How Elasticsearch can help you find suspicious site activity</h1><div class="post__text post__text-html js-mediator-article">  <i>I propose to the readers of <a href="http://www.elasticsearch.org/blog/spotting-bad-actors-what-your-logs-can-tell-you-about-protecting-your-business/">Habrakhabr a</a> translation of the article <a href="http://www.elasticsearch.org/blog/spotting-bad-actors-what-your-logs-can-tell-you-about-protecting-your-business/">‚ÄúSpotting bad actors:</a> from your official blog <a href="http://www.elasticsearch.org/">Elasticsearch</a> .</i>  <i>The article talks about how you can use Elasticsearch capabilities to analyze web server logs in order to detect suspicious activity on the site.</i> <br><br>  Let's think about what and when we do in the case of attempts to hack our site?  Firstly, most often we are trying to eliminate the threat already when the attackers found a vulnerability on the site and took advantage of it.  Secondly, it is often the only operational tool to combat intruders - it is blocking IP-addresses, but it is not a very effective tool if we do not have detailed information about all the addresses from which an attack is made to the site. <br><br>  But how much would the situation change if we could receive in advance detailed information about all IP addresses and subnets that are showing suspicious activity and block them?  That sounds great, doesn't it? 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      We can easily do this with Elasticsearch. <br><a name="habracut"></a><br>  In the arsenal of this search engine there is a wonderful plugin <a href="https://github.com/markharwood/netrisk">Netrisk</a> , which takes all the trouble of analyzing logs and, using the ‚ÄúSankey‚Äù diagram (see picture), shows us the size and concentration of suspicious activity in various traffic segments. <br><br><img src="https://habrastorage.org/files/2b9/b0b/65a/2b9b0b65ad264f93bf4782f3abf9e09a.png"><br><br><h3>  Training </h3><br>  Start by installing Netrisk.  To do this, you should run the following command, being in the home directory of Elasticsearch (requires version not lower than 1.4.0): <br><br><pre><code class="bash hljs">bin/plugin -install markharwood/netrisk</code> </pre> <br>  Great, now the plugin is installed.  But that's not all.  He expects us to provide him with an index with a correctly configured mapping for the field in which the IP addresses will be stored.  I will explain the details later, but now you just need to create an index and fill it with a small amount of test data by running the following shell script: <br><br><pre> <code class="bash hljs"><span class="hljs-variable"><span class="hljs-variable">$ES_HOME</span></span>/plugins/netrisk/exampleData/indexAnonData.sh</code> </pre><br>  <b>Attention!</b>  This script will create an index ‚Äúmylogs‚Äù, while if you already have an index with this name, it will be deleted. <br><br>  If you have completed all the above instructions, you can open the plugin page: <a href="http://localhost/">localhost</a> : 9200 / _plugin / netrisk / <br><br><h3>  Launch </h3><br>  If you look at the data generated by the script, it may seem that this is not enough for serious analysis, because, in fact, from the valuable we have only the HTTP server status of responses.  In fact, this is enough to detect suspicious behavior.  Typically, the web server generates responses in the range from 200 to 300, but in case of problems, it can assign a status from 400 to 500 to the answer. For example, this can happen when someone tries to access a non-existent page.  It turns out that we can already get a list of all suspicious requests to the server using the query: <br><br><pre> <code class="javascript hljs">status:[<span class="hljs-number"><span class="hljs-number">400</span></span> TO <span class="hljs-number"><span class="hljs-number">599</span></span>]</code> </pre><br>  Netrisk uses the standard Lucene request parser (the same as Kibana), so you can supplement the request that detects suspicious traffic with additional filters through the OR condition.  For example, in this way, we can inform the system that calls to the site without specifying the UserAgent should also be considered suspicious. <br><br>  It is important to understand that the request made at this stage will not unambiguously determine that all entries in the journal that are suitable for it are bad.  No, we just make an assumption that it may be suspicious that, as a result, Elasticsearch would analyze the entire magazine for a high concentration of suspicious server access from specific IP or subnets. <br><br>  If we run the plugin using the above request, Netrisk will show us Sankey a diagram of suspicious traffic leading to your site.  Here is some info to read the chart: <br><br><ul><li>  The thickness of the line represents the number of "bad" requests, but this is not the most important! </li><li>  The line color is more important - it depends on which queries prevail: bright red color - means that almost all requests are bad, while green means that almost all requests can be considered good.  If you hover the cursor on the line, you can see the real numbers underlying the definition of color. </li><li>  The diagram shows which IP addresses belong to each subnet.  This information can be very valuable for the webmaster when determining whether malicious traffic is coming from: from specific IP addresses or from a subnet? </li><li>  Clicking on a specific IP address will open the Honey Pot project site, where you can read the comments of other webmasters regarding this IP address. </li></ul><br><br>  You may have noticed that the color of the line may change from red to green from left to right.  This is due to the fact that on the left side of the diagram, each node usually represents a small group of IP addresses, requests from which were identified as suspicious.  The following diagram nodes represent subnets that include large numbers of IP addresses with different behaviors.  However, some subnets will be completely red.  Most likely, this means that no one except attackers is interested in your site in this region (for example, if you have a Russian-language site, and red traffic from China is coming to you, which is most likely the Chinese hackers want to harm your resource). <br><br><h3>  How it works? </h3><br><h4>  Little about mapping data </h4><br>  The queries that Netrisk makes rely on the available IP and subnet statistics stored in the index.  For such an analysis, we cannot simply index each IP address as a string; we must divide it into tokens, which will represent the IP address itself and the subnets it belongs to (for example, the IP address of the 186.28.25.186 type will be divided into the following tokens: 186.28.25.186, 186.28.25, 186.28 and 186).  This can be implemented using the following mapping rule: <br><br><div class="spoiler">  <b class="spoiler_title">Mapping Rule</b> <div class="spoiler_text"><pre> <code class="bash hljs">curl -XPOST <span class="hljs-string"><span class="hljs-string">"http://localhost:9200/mylogs"</span></span> -d <span class="hljs-string"><span class="hljs-string">'{ "settings": { "analysis": { "analyzer": { "ip4_analyzer": { "tokenizer": "ip4_hierarchy" } }, "tokenizer": { "ip4_hierarchy": { "type": "PathHierarchy", "delimiter": "." } } } }, "mappings": { "log": { "properties": { "remote_host": { "type": "string", "index": "not_analyzed", "fields": { "subs": { "type": "string", "index_analyzer": "ip4_analyzer", "search_analyzer": "keyword" } } } } } } }'</span></span></code> </pre><br></div></div><br>  This approach allows us to perform a quick search simultaneously on all 4 levels of the hierarchy of each IP address.  (this also applies to IPv6 addresses) <br><br><h4>  What's inside? </h4><br>  Netrisk receives a request from you that determines what exactly should be considered ‚Äúbad downloads‚Äù (or, more precisely, ‚Äúpotentially bad downloads‚Äù).  After filtering the data, Netrisk uses significant_terms aggregation to determine which IP addresses or subnets most often receive suspicious messages.  The query template looks like this: <br><br><pre> <code class="bash hljs">curl -XGET <span class="hljs-string"><span class="hljs-string">"http://localhost:9200/anonlogs/_search?search_type=count"</span></span> -d<span class="hljs-string"><span class="hljs-string">'{ "query": { "query_string": { "query": "status:[400 TO 599]" } }, "aggs": { "sigIps": { "significant_terms": { "field": "remote_host.subs", "size": 50, "shard_size": 50000, "gnd": {} } } } }'</span></span></code> </pre><br><br>  This query selects the 50 most suspicious IP addresses and subnets.  There are several points worth noting: <br><br><ol><li>  To get the correct data, we need a high shard_size value.  This will seriously burden the memory and network, as well as the need for disk space for a large number of unique entries in the index.  If we do not index the IP addresses completely in the remote_host.subs field, then this will reduce the load, but it will also reduce the depth of the result. </li><li>  ElasticSearch for heuristic analysis uses the JLH algorithm by default, but the GND algorithm is much better suited for the problem we are considering.  Usually, when analyzing, we are interested in rare words, for example, it is important for us to determine that the words Nosferatu and Helsing are related to the set of documents about the movie Dracula, but we are not interested in what the common word ‚Äúhe‚Äù is connected with.  In the problem of analyzing IP addresses, we can neglect the possibilities that the JLH algorithm gives us and take advantage of the less functional but faster GND. </li></ol><br><br>  This single request will do a mass analysis and provide us with basic information about violators in our system, but it is advisable to clarify some information before making a decision on blocking IP addresses.  To do this, we can use the following query: <br><br><div class="spoiler">  <b class="spoiler_title">Request</b> <div class="spoiler_text"><pre> <code class="bash hljs">{ <span class="hljs-string"><span class="hljs-string">"query"</span></span>: { <span class="hljs-string"><span class="hljs-string">"terms"</span></span>: { <span class="hljs-string"><span class="hljs-string">"remote_host.subs"</span></span>: [ <span class="hljs-string"><span class="hljs-string">"256.52"</span></span>, <span class="hljs-string"><span class="hljs-string">"186.34.56"</span></span> ] } }, <span class="hljs-string"><span class="hljs-string">"aggs"</span></span>: { <span class="hljs-string"><span class="hljs-string">"ips"</span></span>: { <span class="hljs-string"><span class="hljs-string">"filters"</span></span>: { <span class="hljs-string"><span class="hljs-string">"filters"</span></span>: { <span class="hljs-string"><span class="hljs-string">"256.52"</span></span>: { <span class="hljs-string"><span class="hljs-string">"term"</span></span>: { <span class="hljs-string"><span class="hljs-string">"remote_host.subs"</span></span>: <span class="hljs-string"><span class="hljs-string">"256.52"</span></span> } }, <span class="hljs-string"><span class="hljs-string">"186.34.56"</span></span>: { <span class="hljs-string"><span class="hljs-string">"term"</span></span>: { <span class="hljs-string"><span class="hljs-string">"remote_host.subs"</span></span>: <span class="hljs-string"><span class="hljs-string">"186.34.56"</span></span> } } } }, <span class="hljs-string"><span class="hljs-string">"aggs"</span></span>: { <span class="hljs-string"><span class="hljs-string">"badTraffic"</span></span>: { <span class="hljs-string"><span class="hljs-string">"filter"</span></span>: { <span class="hljs-string"><span class="hljs-string">"query"</span></span>: { <span class="hljs-string"><span class="hljs-string">"query_string"</span></span>: { <span class="hljs-string"><span class="hljs-string">"query"</span></span>: <span class="hljs-string"><span class="hljs-string">"status:[400 TO 599]"</span></span> } } } }, <span class="hljs-string"><span class="hljs-string">"uniqueIps"</span></span>: { <span class="hljs-string"><span class="hljs-string">"cardinality"</span></span>: { <span class="hljs-string"><span class="hljs-string">"field"</span></span>: <span class="hljs-string"><span class="hljs-string">"remote_host"</span></span> } } } } } }</code> </pre><br></div></div><br><br>  For each specified suspicious IP or subnet, we get an array with the following information: <br><ol><li>  Total number of requests (bad and good); </li><li>  The total number of bad requests; </li><li>  The total number of unique IP addresses per subnet; </li></ol><br>  Now that we have a chart and detailed statistics about dubious IP addresses, we can make the final blocking decision. <br><br><h3>  Conclusion </h3><br>  Tracking the behavior of entities such as IP addresses by analyzing the web server log is a complex computational task, but the data we have obtained is only the tip of the iceberg. <br><br>  Let me give you some more interesting examples of behavioral analysis that you can implement yourself: <br><br><ol><li>  How much time do visitors spend on my site? </li><li>  What IP addresses behave like bots (do not load CSS and JavaScript ‚Äî only the page markup itself)? </li><li>  Which site page is most often the first / last when visiting the site? </li></ol></div><p>Source: <a href="https://habr.com/ru/post/250413/">https://habr.com/ru/post/250413/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../250393/index.html">Vibration API: who needs it and why?</a></li>
<li><a href="../250399/index.html">146% on Kickstarter: was it easy</a></li>
<li><a href="../250403/index.html">Vulnerabilities and backdoors in Grandstream phones</a></li>
<li><a href="../250407/index.html">UX-strategy in practice. Part 2 - Grocery Designer</a></li>
<li><a href="../250409/index.html">Apple's Android application, interactive cinema, Rovio's Match3 and other news of the week for a mobile developer</a></li>
<li><a href="../250415/index.html">Writing a plugin for October CMS</a></li>
<li><a href="../250417/index.html">The controller for an aquarium without Arduino</a></li>
<li><a href="../250419/index.html">ASP.NET Day: Announcement of Reports</a></li>
<li><a href="../250421/index.html">Interview with Olga Pavlova: ‚ÄúThe crisis has not affected the site building industry yet. You can work "</a></li>
<li><a href="../250423/index.html">How I created a mobile fighting game for iOS</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>