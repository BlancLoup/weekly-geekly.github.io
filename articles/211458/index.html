<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Instrument measuring temperature and humidity PI-TV-2</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Actually, the weather sensor is probably the second thing that everyone does after they flash the LED on the Arduino. And since this fate cannot be av...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Instrument measuring temperature and humidity PI-TV-2</h1><div class="post__text post__text-html js-mediator-article">  Actually, the weather sensor is probably the second thing that everyone does after they flash the LED on the Arduino.  And since this fate cannot be avoided, then we must deal with it as quickly as possible in order to move on. <br><br>  I initially did not plan to watch the temperature and humidity locally, because I spend most of the time during the week, first, outside the house, and, second, with a smartphone.  Therefore, there were two options: receive the weather by mail or upload to any suitable online service. <br><br>  Honestly, I first wanted to <s>do good and throw it into the water,</s> send the weather to <a href="http://openweathermap.org/">Openweathermap.org</a> and even did it for a while.  But then it began - then the service suddenly refuses, and I sit and wonder what happened, his IP will change, and I need to climb into the code of the central controller again. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      In general, I refused OWM, and used the experience to adapt the sensor to another online service.  Although he does not use the data for the forecast, it turned out to be very convenient for me to look at the current weather and statistics. <br><br><a name="habracut"></a><br><br><div class="spoiler">  <b class="spoiler_title">Other devices and devices of the series</b> <div class="spoiler_text">  <a href="http://habrahabr.ru/post/210664">My comfortable home</a> <br>  <a href="http://habrahabr.ru/post/210830">The controller is a central home, all-powerful KCD-V-2-12</a> <br>  <a href="http://habrahabr.ru/post/211234/">The device of feeding of cats operated, passive AKK-PU-1</a> <br>  <a href="http://habrahabr.ru/post/212093/">Automatic light and music ASIM-AU-2-6</a> <br>  <a href="http://habrahabr.ru/post/213425/">Remote service block multifunction BDS-M</a> <br><br></div></div><br><br><h5>  Purpose </h5><br>  PI-TV-2 is designed to measure the current values ‚Äã‚Äãof humidity and temperature, and transfer them to the <a href="http://habrahabr.ru/post/210830/">central home controller -2-12</a> over the radio channel. <br><br>  Has no other assignments yet, although the power supply and the Arduino Pro Mini controller on board seem to hint that you can add something else.  Than I probably will do someday. <br><br>  .  That's how it looks in the interior.  But the expectation is that design imperfections constantly cover the curtains <br><img src="https://habrastorage.org/getpro/habr/post_images/449/a7e/133/449a7e13381ba58214f7accd2f2d0b31.jpg" alt="image"><br><br><h5>  Principle of operation </h5><br>  PI-TV-2 is designed to work with the <a href="http://habrahabr.ru/post/210830/">central home controller -2-12</a> or similar device capable of receiving and interpreting the received data.  The data format is lower in the text and is also visible in the sketch. <br><br>  PI-TV-2 does not display current readings and does not have a wired connection to any external devices, except for the temperature / humidity sensor and the transmitter. <br><br>  Indications of temperature and humidity, measured by the DHT21 sensor, are transmitted to the central controller by radio with an interval of half an hour.  The central controller uploads the HTTP POST protocol to the <a href="http://narodmon.ru/">People‚Äôs Monitoring</a> service at one-hour intervals.  Both intervals are not tied to each other and are not synchronized. <br><br>  <a href="http://narodmon.ru/%3Fid%3D1504">DEMO sensor readings</a> <br><br>  During normal operation, the built-in Arduino LED blinks at intervals of about 8 seconds. <br><br>  Error correction and control of the reception and integrity of the transmitted data are not provided. <br><br><h5>  Iron </h5><br>  The design of PI-TV-2 is very simple and consists of only four main components (links, as usual, just for example): <br><br>  1. <a href="http://www.ebay.com/itm/1PCS-PRO-Mini-ATMEGA328P-5V-16M-16MHZ-Board-Module-For-Arduino-Compatible-Nano-/360732394240%3Fpt%3DLH_DefaultDomain_0%26hash%3Ditem53fd538300">Arduino Pro Mini</a> 5V, 16 MHz with an ATmega328 chip. <br>  2. Combined temperature and humidity <a href="http://dx.com/ru/p/dht21-am2301-capacitive-digital-temperature-humidity-sensor-black-151396">sensor DHT21</a> . <br>  3. 433 MHz transmitter with amplitude modulation ( <a href="http://www.ebay.com/itm/433Mhz-RF-transmitter-and-receiver-link-kit-for-Arduino-ARM-MC-U-remote-control-/180929057924%3Fpt%3DLH_DefaultDomain_0%26hash%3Ditem2a20365484">from such a kit</a> , for example). <br>  4. Resistor 4.7kohm, 0.125W <br>  5. Power supply 5V - 9V (optional, you can experiment with batteries or rechargeable batteries). <br>  6. To fill the code in the Arduino Pro Mini, you will need and <a href="http://www.ebay.com/itm/New-USB-2-0-to-TTL-UART-6PIN-Module-Serial-Converter-CP2102-STC-PRGMR-Free-cable-/310511987503%3Fpt%3DLH_DefaultDomain_0%26hash%3Ditem484bf4eb2f">here is such</a> (or similar) COM-USB converter (optional - maybe you already have one). <br><br>  It is this controller - because it is compact and already lay in my box for any homemade products.  And I bought a pack of these controllers, because they were inexpensive and met more often than version 3B.  Yes, and I did not think that I would feed this economy from 3B, so 5B was more important. <br><br>  .  something like this you will connect to fill the sketch <br><img src="https://habrastorage.org/getpro/habr/post_images/0ef/8a4/f29/0ef8a4f29152773399eaf413f64bff67.jpg" alt="image"><br><br>  The acquisition of the DHT21 temperature and humidity sensor is determined by the fact that I somehow ordered a very simple but nice watch for my wife on DX.  Only after the payment was made, the shop unsubscribed that there were no hours in stock, and they could return the money to the account in the shop, that is, for future purchases.  In short, took almost without looking. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/b32/c14/e91/b32c14e91817c1d70a4bbcdd3e8b9a36.jpg" alt="image"><br><br>  I selected the parameters taking into account the fact that the sensor is most likely to be outdoor, therefore not DHT11, but DHT21 whose minimum measurement temperature is -40 ¬∞ C.  I must say: this is for Moscow, and if you have other lows, the sensor will also be completely different.  For example, the super popular DS18B20, which measures up to -55C and something else for humidity. <br><br>  .  fits <br><img src="https://habrastorage.org/getpro/habr/post_images/aad/90f/aea/aad90faea76d194f79c55a265f654519.jpg" alt="image"><br><br>  An analog transmitter is required for communication with the analog receiver of the central controller using the protocol implemented in the <a href="https://code.google.com/p/rc-switch/">RC-Switch</a> library.  Again, in the central controller, I use the library for two purposes: control of wireless sockets and peripherals, as well as data exchange with service controllers.  This allows you to do a minimum of equipment and at the same time saves memory, since they do not need specialized libraries for wireless communications. <br><br>  Another choice is autonomous or networked power.  Again, I honestly tried to use self-powered: I liked the idea that the sensor would just hang somewhere without wires.  But it did not work out.  In fact, even the Arduino Pro Mini has a fairly high energy consumption, if you do not know how to turn off everything and everyone.  And I have not learned. <br><br>  The maximum that I managed to squeeze ‚Äúsleep‚Äù with various libraries was about a week of work on 14500 batteries. Two batteries died in a couple of weeks for some strange reason.  In theory, the protection should have prevented over-discharge, but in fact it simply blocked the battery.  Removing protection extended the battery life by another week, after which she died permanently. <br><br>  The bottom line is the power supply side and no worries. <br><br>  Logically assembly is as follows: <br><br><h6>  1. DHT21 sensor </h6><br>  <b>GND</b> - to the power supply minus; <br><br>  <b>VCC</b> - to Arduino pin VCC or to any Arduino digital pin in OUTPUT / HIGH mode to save battery power (code is pin 7) or to the 5V output of the power supply (if you have a 5V block).  To 9V sensor can not be connected; <br><br>  <b>OUT</b> - directly to pin 5 Arduino and through a 4.7 kŒ© resistor - to the power supply (we pull up to the power). <br><br>  .  in principle, and the wires can be seen, but to be 100% sure you need to open it <br><img src="https://habrastorage.org/getpro/habr/post_images/926/5e0/4c7/9265e04c7c5966e90f26e9c603bb453f.jpg" alt="image"><br><br><h6>  2. Transmitter </h6><br>  <b>GND</b> - to the power supply minus; <br><br>  <b>VCC</b> - to the power supply plus (from 3V to 12V), it is also possible to pin the VCC Arduino or to any digital pin Arduino in the OUTPUT / HIGH mode in order to save battery power (code is pin 8); <br><br>  <b>DATA</b> - to pin 6 Arduino. <br><br>  .  something like this in the process <br><img src="https://habrastorage.org/getpro/habr/post_images/375/ffa/f71/375ffaf71c60191b9a53a9f9544609b6.jpg" alt="image"><br><br>  .  based on batteries (rechargeable batteries) <br><img src="https://habrastorage.org/getpro/habr/post_images/0fe/c83/8f9/0fec838f94545b6c62f5806b47a4cdd1.jpg" alt="image"><br><br><h6>  3. Arduino </h6><br>  If you have a 5V source, then its plus can be connected to the VCC pin. <br><br>  If the power source gives noticeably more than 5V (but not more than 12V), then - to the pin of RAW.  At the same time on the pins VCC will be 5V, which can be used for the DHT21 sensor and other peripherals. <br><br>  Minus power supply, respectively, to <b>GND</b> Arduino. <br><br>  A bit of ‚Äúbattery power saving options.‚Äù  The fact is that we send the Arduino to sleep, but what to do with the peripherals that are constantly connected to the power supply?  To fence the keys on the supply chain?  Not necessarily.  After all, Arduino digital pins can be used to power low-power devices - transmitters, receivers, some sensors. <br><br>  And this, in turn, makes it easy to turn on and off peripherals as needed.  To enable, simply transfer the pin to the OUTPUT mode, write HIGH to it and get + 5V power.  And to turn off, we write in the same pin LOW. <br><br>  That's all with logic. <br><br>  Physically, the assembly is complicated by the fact that I, first of all, placed everything in the case from a wireless bell, because I hoped to use its battery compartment.  By the way, it turned out that the Arduino indicator LED turned out to be next to the ‚Äúlight music‚Äù window of the former call, so that through it you could monitor the controller‚Äôs activity, since the code requires periodic flashing (yes, and here it is!). <br><br>  .  until I discharged the power LED - it was also visible <br><img src="https://habrastorage.org/getpro/habr/post_images/e64/f72/90f/e64f7290fc756b4ade65f0a17680eed1.jpg" alt="image"><br><br>  Secondly, I connected the DHT21 sensor through the plug connector for easy maintenance of the weather sensor.  I extended the sensor wire so that it could be pulled out of the window without any problems. <br><br>  And thirdly, the power supply LED disappeared when it was still obsessed with the idea of ‚Äã‚Äãbattery power.  After all, when the power is on, the LED lights up constantly, but why does it need a weather sensor? <br><br>  For mounting the sensor outside the window, a small magnet is stuck on it.  In this form, the sensor "sticks" visor or "window sill".  I fix it below so that it does not flood with water and does not overheat by the sun. <br><br>  To power the whole PI-TV-2 in the final version I used a piece of wire with a connector for an existing network adapter. <br><br>  Well, the weather sensor itself hangs on the window on the same magnets: one magnet on the sensor, the other on the window.  By the way, they are very well joined by faces (magnet thickness of the order of a millimeter), which noticeably reduces bulkiness: the sensor seems to be simply glued to the frame. <br><br>  .  also not very aesthetic, but - back <br><img src="https://habrastorage.org/getpro/habr/post_images/22a/9d7/602/22a9d76029b1e0b1d48ad7f6fa3964d3.jpg" alt="image"><br><br><h5>  Soft </h5><br>  The peculiarity of the current version of the code is that it was inherited from attempts to make an autonomous meteorological sensor.  Therefore, here you can observe the energy-saving library in all its glory, and if you wish - try to power the sensor from batteries.  It needs at least 5V, while 14500 batteries with a capacity of 900 or 1000 Chinese mAh last about a week of continuous operation. <br><br>  Please note: one 14500 battery is small, so you need two.  And two - a total of 7.4V according to the characteristics on board the batteries (and about 8.4V immediately after full charge), so you need to connect to the pin of the RAW Arduino so as not to kill it.  And the sensor DHT21, respectively, only to pin VCC Arduino or to the power supply digital pin. <br><br>  Since the energy-saving library used lulls the controller for no more than 8 seconds, its call lives in a cycle that provides about half an hour of not very healthy, but still sleep. <br><br>  In the same cycle, the built-in Arduino LED flashes.  When working on batteries, it allowed us to quickly and simply understand the controller alive, or it was already time to recharge.  Now it is just an indicator of activity. <br><br>  As a result, the sensor readings are transmitted to the central controller at half-hour intervals.  This interval was chosen at once for several reasons: maximum battery saving (when it was relevant) with more or less reliable data and resource saving of the central controller, which has other things to do but post weather to the Internet. <br><br>  To transfer readings, I use, so to speak, a proprietary protocol that runs on top of the RC-Switch.  It looks like this: the sensor transmits the numbers of the form 161HSXXX, where H is a sign of humidity, S is the sign of temperature, XXX is the value of the climatic parameter accurate to tenths, multiplied by 10. <br><br>  If H = 1, the controller considers that the moisture readings are transmitted.  If H = 0, the controller thinks it got a temperature.  If S = 0, the temperature is considered positive, if S = 1, then it is negative. <br><br>  Both parameters are transmitted by the weather sensor at a short interval in order to guarantee the processing time on the side of the central controller, which then draws all the form of an HTTP POST request for transmission to the Internet.  Storage and visualization of parameters is carried out using the " <a href="http://narodmon.ru/">People's Monitoring</a> ".  Of course, you can choose any other suitable resource or your own service, but then do not forget to correct the code of the central controller or your service to receive data in the existing format. <br><br>  Do not forget that to compile this code, you will need three non-standard libraries: <br><br>  1. <a href="https://github.com/nethoncho/Arduino-DHT22">DHT22</a> for sensor. <br>  2. <a href="https://github.com/rocketscream/Low-Power">LowPower</a> for power saving mode. <br>  3. <a href="http://code.google.com/p/rc-switch/">RC-Switch</a> for transmitting readings. <br><br><div class="spoiler">  <b class="spoiler_title">Wireless weather sensor sketch</b> <div class="spoiler_text"><pre><code class="cpp hljs"><span class="hljs-comment"><span class="hljs-comment">// 23.11.2013 -       ,   Low Power #include &lt;LowPower.h&gt; // https://github.com/rocketscream/Low-Power #include &lt;DHT22.h&gt; //   https://github.com/nethoncho/Arduino-DHT22 #include &lt;RCSwitch.h&gt; // http://code.google.com/p/rc-switch/ //    4.7  VCC   Out DHT22 #define DHT22_PIN 5 // DHT21     5 Arduino //   DHT22 DHT22 myDHT22(DHT22_PIN); #define txPIN 6 //   #define sensorPower 7 //   #define txPower 8 //   //   RCSwitch RCSwitch meteoSwitch = RCSwitch(); byte param = 0; //   (/) unsigned long myData; //    void setup() { pinMode(sensorPower, OUTPUT); //     pinMode(txPower, OUTPUT); //     meteoSwitch.enableTransmit(txPIN); //   meteoSwitch.disableReceive(); getWeather(); //    ,     ,   pinMode(13, OUTPUT); //      Arduino } //     void getWeather() { digitalWrite(sensorPower, HIGH); //   digitalWrite(txPower, HIGH); //   delay(3000); //     DHT22_ERROR_t errorCode; //       errorCode = myDHT22.readData(); if (errorCode == 0) { //    //    if (myDHT22.getTemperatureCInt()&gt;30000) { myData = 16101000 + abs((myDHT22.getTemperatureCInt()-32768));} //  =   +   +   +  else { myData = 16100000 + myDHT22.getTemperatureCInt();} //  =   +   +   +  meteoSwitch.send(myData, 24); //   meteoSwitch.send(myData, 24); //   () delay(1000); //    myData = 16110000 + myDHT22.getHumidityInt(); //  =   +   +  meteoSwitch.send(myData, 24); //   meteoSwitch.send(myData, 24); //   lightsOn(); } digitalWrite(sensorPower, LOW); //   digitalWrite(txPower, LOW); //   } void loop () { for (byte i=0;i&lt;=225;i++){ LowPower.powerDown(SLEEP_8S, ADC_OFF, BOD_OFF); //   lightsOn(); //     } getWeather(); //     } void lightsOn() { digitalWrite(13, HIGH); //   delay(500); digitalWrite(13, LOW); }</span></span></code> </pre> <br><br></div></div><br><br><h5>  Final word </h5><br>  The biggest problem after energy efficiency is the reliability of the radio channel.  Whether I'm doing something wrong, or just at home, some surprisingly poor environment with interference, but the sensor more or less earned at a distance of 5-6 meters from the controller only if a rather large telescopic antenna was screwed to the conventional transmitter, or if i used a <a href="http://dx.com/ru/p/zsd-t3-315-433mhz-ask-high-power-rf-transmitter-module-yellow-228289">more expensive transmitter</a> . <br><br>  Another feature is that my DHT21 instance actually stops measuring humidity at its high values.  At some point, it simply wedges by 99.9%, and until the humidity decreases to a certain threshold, the value does not change. <br><br>  And since this has become attached to me, there is a mass of texts on the Internet about the current consumed by the Arduino.  Individuals managed to reduce consumption to micro-ampere units, but this is mainly on ‚Äúclean‚Äù controllers without any built-in voltage regulators, LEDs, etc., and so on.  Here, <a href="http://interface.khm.de/index.php/lab/experiments/sleep_watchdog_battery/">for example</a> . <br><br>  And, again, if I made a mistake somewhere - say, I will correct it. </div><p>Source: <a href="https://habr.com/ru/post/211458/">https://habr.com/ru/post/211458/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../211448/index.html">How to get to iTunes University: a step by step guide to action</a></li>
<li><a href="../211450/index.html">Start of the project through the eyes of the developer</a></li>
<li><a href="../211452/index.html">Microsoft has invested $ 15 million in Foursquare in exchange for using its data</a></li>
<li><a href="../211454/index.html">February 12 - World of Tanks release: Xbox 360 Edition</a></li>
<li><a href="../211456/index.html">Keypress 2.0.0</a></li>
<li><a href="../211460/index.html">Satya Nadella: Microsoft's new CEO</a></li>
<li><a href="../211462/index.html">FlightCar: peer-to-peer car exchange and the fight against bureaucrats</a></li>
<li><a href="../211464/index.html">Testing Digium phones with Asterisk and setting up Smart BLF</a></li>
<li><a href="../211466/index.html">A simple Python script to learn English words or why I don‚Äôt use flashcards</a></li>
<li><a href="../211468/index.html">VLC stereo player</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>