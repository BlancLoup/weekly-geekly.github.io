<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Network Security Services package and oidcalc utility</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="When implementing a project related to the use of Russian cryptographic algorithms in the KMail email client in the Kleopatra and GnuPG application , ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Network Security Services package and oidcalc utility</h1><div class="post__text post__text-html js-mediator-article">  When implementing a project related to the use of Russian cryptographic algorithms in the <a href="https://habrahabr.ru/post/316736/">KMail</a> email client <a href="https://habrahabr.ru/post/316736/">in the Kleopatra and GnuPG application</a> , to convert Russian <i>oid-</i> s from dot-decimal form to DER-encoding, I decided to use the <a href="http://ftp.mozilla.org/pub/security/nss/releases/">oidcalc</a> utility from the <a href="https://ru.wikipedia.org/wiki/Network_Security_Services">NSS</a> (Network Security Services) package , which is preinstalled in all Linux distributions, including domestic clones.  The resulting code was used in the work. <br><a name="habracut"></a><br>  And everything went well until an <i>oid</i> was <i>found</i> that had a decimal digit of 0 (zero), namely ‚Äú1.2.643.2.2.36.0‚Äù (szOID_GostR3410_2001_CryptoPro_XchA_ParamSet).  And here an unpleasant surprise was waiting for me - my code stopped working.  At some point I decided to look, and what this <i>oid means</i> : <br><br><pre><code class="hljs css"># <span class="hljs-selector-tag"><span class="hljs-selector-tag">oidcalc</span></span> 1<span class="hljs-selector-class"><span class="hljs-selector-class">.2</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.643</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.2</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.2</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.36</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.0</span></span> 0<span class="hljs-selector-tag"><span class="hljs-selector-tag">x2a</span></span>, 0<span class="hljs-selector-tag"><span class="hljs-selector-tag">x85</span></span>, 0<span class="hljs-selector-tag"><span class="hljs-selector-tag">x3</span></span>, 0<span class="hljs-selector-tag"><span class="hljs-selector-tag">x2</span></span>, 0<span class="hljs-selector-tag"><span class="hljs-selector-tag">x2</span></span>, 0<span class="hljs-selector-tag"><span class="hljs-selector-tag">x24</span></span>, #</code> </pre> <br>  But it should have been <i>0x2a, 0x85, 0x3, 0x2, 0x2, 0x24, 0x0,</i> - the trailing hex zero was missing. <br><br>  I tried to translate another oid "1.2.643.3.6.0.1" (CryptoPro Pro, Certificate validity period 1 month): 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <pre> <code class="hljs css"># <span class="hljs-selector-tag"><span class="hljs-selector-tag">oidcalc</span></span> 1<span class="hljs-selector-class"><span class="hljs-selector-class">.2</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.643</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.3</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.6</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.1</span></span> 0<span class="hljs-selector-tag"><span class="hljs-selector-tag">x2a</span></span>, 0<span class="hljs-selector-tag"><span class="hljs-selector-tag">x85</span></span>, 0<span class="hljs-selector-tag"><span class="hljs-selector-tag">x3</span></span>, 0<span class="hljs-selector-tag"><span class="hljs-selector-tag">x3</span></span> 0<span class="hljs-selector-tag"><span class="hljs-selector-tag">x3</span></span>, 0<span class="hljs-selector-tag"><span class="hljs-selector-tag">x6</span></span>, 0<span class="hljs-selector-tag"><span class="hljs-selector-tag">x1</span></span>, #</code> </pre> <br>  The same sad result - there is no penultimate byte with zero.  It became clear that the oidcalc utility throws out zeros from the oid.  The following example only confirmed this assumption: <br><br><pre> <code class="hljs css"># <span class="hljs-selector-tag"><span class="hljs-selector-tag">oidcalc</span></span> 1<span class="hljs-selector-class"><span class="hljs-selector-class">.2</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.643</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.3</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.6</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.1</span></span> 0<span class="hljs-selector-tag"><span class="hljs-selector-tag">x2a</span></span>, 0<span class="hljs-selector-tag"><span class="hljs-selector-tag">x85</span></span>, 0<span class="hljs-selector-tag"><span class="hljs-selector-tag">x3</span></span>, 0<span class="hljs-selector-tag"><span class="hljs-selector-tag">x3</span></span> 0<span class="hljs-selector-tag"><span class="hljs-selector-tag">x3</span></span>, 0<span class="hljs-selector-tag"><span class="hljs-selector-tag">x6</span></span>, 0<span class="hljs-selector-tag"><span class="hljs-selector-tag">x1</span></span>, #</code> </pre> <br>  For another check, I had to use the <a href="http://www.rtner.de/software/oid.html">oid</a> utility and got the result I expected: <br><br><pre> <code class="hljs pgsql"># ./<span class="hljs-type"><span class="hljs-type">oid</span></span> <span class="hljs-number"><span class="hljs-number">1.2</span></span><span class="hljs-number"><span class="hljs-number">.643</span></span><span class="hljs-number"><span class="hljs-number">.2</span></span><span class="hljs-number"><span class="hljs-number">.2</span></span><span class="hljs-number"><span class="hljs-number">.36</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span> <span class="hljs-number"><span class="hljs-number">06</span></span> <span class="hljs-number"><span class="hljs-number">07</span></span> <span class="hljs-number"><span class="hljs-number">2</span></span>A <span class="hljs-number"><span class="hljs-number">85</span></span> <span class="hljs-number"><span class="hljs-number">03</span></span> <span class="hljs-number"><span class="hljs-number">02</span></span> <span class="hljs-number"><span class="hljs-number">02</span></span> <span class="hljs-number"><span class="hljs-number">24</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> # ./<span class="hljs-type"><span class="hljs-type">oid</span></span> <span class="hljs-number"><span class="hljs-number">1.2</span></span><span class="hljs-number"><span class="hljs-number">.643</span></span><span class="hljs-number"><span class="hljs-number">.3</span></span><span class="hljs-number"><span class="hljs-number">.6</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span> <span class="hljs-number"><span class="hljs-number">06</span></span> <span class="hljs-number"><span class="hljs-number">07</span></span> <span class="hljs-number"><span class="hljs-number">2</span></span>A <span class="hljs-number"><span class="hljs-number">85</span></span> <span class="hljs-number"><span class="hljs-number">03</span></span> <span class="hljs-number"><span class="hljs-number">03</span></span> <span class="hljs-number"><span class="hljs-number">06</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> <span class="hljs-number"><span class="hljs-number">01</span></span> #</code> </pre> <br>  The <i>oid</i> utility displays the result already in ASN1-encoding, where the first byte determines the type of sequence, the second byte - the length of the sequence in bytes, and then the oid itself is in hexadecimal. <br><br>  After that, it remained to analyze the source code of the <i>oidcalc.c</i> utility and together the minimal changes: <br><br><pre> <code class="hljs kotlin"> . . . memset(buf, <span class="hljs-number"><span class="hljs-number">0</span></span>, sizeof(buf)); <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> = atoi(curstr); count = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-comment"><span class="hljs-comment">/* */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(curstr[<span class="hljs-number"><span class="hljs-number">0</span></span>] != <span class="hljs-string"><span class="hljs-string">'0'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">val</span></span>) { buf[count] = (<span class="hljs-keyword"><span class="hljs-keyword">val</span></span> &amp; <span class="hljs-number"><span class="hljs-number">0x7f</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> = <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> &gt;&gt; <span class="hljs-number"><span class="hljs-number">7</span></span>; count++; } <span class="hljs-comment"><span class="hljs-comment">/*   */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> buf[count++] = <span class="hljs-number"><span class="hljs-number">0x00</span></span>; . . .</code> </pre> <br>  Now, if you rebuild the utility, then everything works fine: <br><br><pre> <code class="hljs css"><span class="hljs-selector-id"><span class="hljs-selector-id">#oidcalc</span></span> 1<span class="hljs-selector-class"><span class="hljs-selector-class">.2</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.643</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.2</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.2</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.36</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.0</span></span> 0<span class="hljs-selector-tag"><span class="hljs-selector-tag">x2a</span></span>, 0<span class="hljs-selector-tag"><span class="hljs-selector-tag">x85</span></span>, 0<span class="hljs-selector-tag"><span class="hljs-selector-tag">x3</span></span>, 0<span class="hljs-selector-tag"><span class="hljs-selector-tag">x2</span></span>, 0<span class="hljs-selector-tag"><span class="hljs-selector-tag">x2</span></span>, 0<span class="hljs-selector-tag"><span class="hljs-selector-tag">x24</span></span>, 0<span class="hljs-selector-tag"><span class="hljs-selector-tag">x0</span></span>, <span class="hljs-selector-id"><span class="hljs-selector-id">#oidcalc</span></span> 1<span class="hljs-selector-class"><span class="hljs-selector-class">.2</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.643</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.3</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.6</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.1</span></span> 0<span class="hljs-selector-tag"><span class="hljs-selector-tag">x2a</span></span>, 0<span class="hljs-selector-tag"><span class="hljs-selector-tag">x85</span></span>, 0<span class="hljs-selector-tag"><span class="hljs-selector-tag">x3</span></span>, 0<span class="hljs-selector-tag"><span class="hljs-selector-tag">x3</span></span>, 0<span class="hljs-selector-tag"><span class="hljs-selector-tag">x6</span></span>, 0<span class="hljs-selector-tag"><span class="hljs-selector-tag">x0</span></span>, 0<span class="hljs-selector-tag"><span class="hljs-selector-tag">x1</span></span>, #</code> </pre> <br>  What was wrong with the utility developer?  In the little things.  To translate a number from a string to an integer, the author uses the <i>atoi</i> functions, which returns 0 (zero) and in case of translating the character '0' and in case of impossibility of translation (no number is given).  It turned out to be enough to add additional checks and it all worked. <br><br>  Did I write to the NSS developers?  Yes, he wrote.  Moreover, the NSS package with plug-in cryptographic tokens / smartcards that support <a href="https://habrahabr.ru/post/316328/">the PKCS # 11 interface</a> is actually a cryptographic <a href="https://ru.wikipedia.org/wiki/Network_Security_Services">core of applications</a> from Mozilla, and is also used in Google's Chrome browsers.  No reply, code not corrected.  Therefore, this note appeared so that someone else did not step on this rake as your humble servant.  And, of course, we hope that the suppliers of domestic Linux forks / clones will fix this error in their packages. </div><p>Source: <a href="https://habr.com/ru/post/398783/">https://habr.com/ru/post/398783/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../398773/index.html">City design based on data</a></li>
<li><a href="../398775/index.html">Why do Bigfoot see people of different cultures</a></li>
<li><a href="../398777/index.html">Space Housing, Part 3: How We Will Live on Mars</a></li>
<li><a href="../398779/index.html">Development of a strong AI, by copying structures and processes of the human psyche</a></li>
<li><a href="../398781/index.html">Wireless debugging STM32</a></li>
<li><a href="../398785/index.html">At the bottom of the Gulf of Mexico found a poisonous lake</a></li>
<li><a href="../398787/index.html">In the suburbs of Moscow with the help of a 3D printer a residential building will be built in 20 hours</a></li>
<li><a href="../398789/index.html">Neural network predicts the first impression of a person on his face</a></li>
<li><a href="../398791/index.html">Data ballad</a></li>
<li><a href="../398793/index.html">A pen for a computer or a computer for a pen?</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>