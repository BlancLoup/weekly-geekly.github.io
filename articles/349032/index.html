<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Manage IAX channels with a lot of Asterisk</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Good day. 

 Anyone who administers Asterisk in the slightest degree is faced with the task of combining several servers among themselves. Here it doe...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Manage IAX channels with a lot of Asterisk</h1><div class="post__text post__text-html js-mediator-article">  Good day. <br><br>  Anyone who administers Asterisk in the slightest degree is faced with the task of combining several servers among themselves.  Here it does not matter which protocol IAX or SIP is chosen, since regardless of the protocol there will be approximately the same set of actions.  This is no problem as long as your server can be counted on the fingers of one hand.  If you didn‚Äôt have one hand, and your fingers for the second are already ending then you are welcome under the cut in order to see one of the ways to solve this problem. <br><a name="habracut"></a><br>  I work in one relatively small organization, but this organization is very scattered geographically, we have many small offices and everyone needs telephony, respectively, Asterisk is installed in each office and all servers are integrated to make calls within the company.  When a new office opens, you have to configure all the servers and inform them about the additional numbering and the new server.  At one point, setting up a regular server, I thought that this could be automated and get rid of most routine actions.  According to the results I came to the conclusion that it should be automated: <br><br><ol><li>  Adding a new IAX channel. </li><li>  Change parameters of one IAX channel </li><li>  Changing the numbering in any office </li><li>  No changes required on other servers </li></ol><br>  Asterisk has already got everything to implement our plans, we just need to configure and link all the components together.  So, what do we need to implement our plans: 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <ol><li>  Asterisk - I use Asterisk 13 LTS Certified </li><li>  Realtime - Asterisk needs to be built with the pbx_realtime module </li><li>  Lua - I only use it in Asterisk (pbx_lua) </li><li>  Perl - Where to without Perl in automation, but can be replaced by any other language </li><li>  PostgreSql - I am using version 9.6.  Maybe any other database </li><li>  Bucardo - I use it for database replication, there may be a regular database tool </li></ol><br><h3>  Algorithm </h3><br>  For those who use a different set of software, I will describe just an algorithm and then move on to implementing it on the above software set. <br><br>  There is nothing outstanding here, the algorithm is simple as a stick.  Asterisk is configured to use realtime configuration.  Adding information about the new IAX channel occurs by adding a row to the appropriate database table.  A script is run on the server at regular intervals, which checks the presence of new IAX channels in the database and, if they are detected, performs the registration of all channels.  When making a call to an internal number, it checks to which server the given internal number belongs and sends the call to the corresponding server.  That's the whole algorithm, see below for more details. <br><br><h3>  Training </h3><br>  <b>Asterisk</b> .  There is no point in describing a complete and detailed installation, you can find more than a dozen articles on the web how to do it correctly and quickly.  I will describe only what modules should be installed to solve our problem: <br><br><ul><li>  pbx_realtime </li><li>  pbx_lua </li><li>  res_config_odbc </li><li>  res_odbc </li><li>  res_odbc_transaction </li></ul><br>  These modules should be enough to solve our problem, naturally we do not forget to connect all the modules you need personally.  Also install the packages that will be needed to build Asterisk: <br><br><pre><code class="bash hljs">yum install -y dmidecode ncurses-devel libxml2-devel openssl-devel newt-devel sqlite-devel libuuid-devel gtk2-devel jansson-devel binutils-devel curl-devel unixODBC unixODBC-devel spandsp-devel spandsp iksemel iksemel-devel libtool-ltdl libtool-ltdl-devel kernel-devel lua-devel perl-CPAN perl-DBD-Pg perl-DBI perl-App-cpanminus</code> </pre> <br>  Do not forget that you will need a compiler and all related applications, I usually install as follows: <br><br><pre> <code class="bash hljs">yum groupinstall -y <span class="hljs-string"><span class="hljs-string">"development tools"</span></span></code> </pre> <br>  So we put everything we need.  Then you can proceed with the installation of Asterisk, and we will proceed to the configuration. <br><br>  <b>Realtime</b> .  First we need to configure ODBC, it will be Asterisk who will use it to get the settings from the database.  Here, in fact, you need to fix only a few files. <br><br>  /etc/odbc.ini must be converted to this: <br><br><pre> <code class="hljs pgsql">[asterisk] Description=PostgreSQL Driver=PostgreSQL <span class="hljs-keyword"><span class="hljs-keyword">Database</span></span>=asrumoscow Servername=localhost Username=asterisk <span class="hljs-keyword"><span class="hljs-keyword">Password</span></span>=<span class="hljs-keyword"><span class="hljs-keyword">password</span></span> Port=<span class="hljs-number"><span class="hljs-number">5432</span></span> Protocol=<span class="hljs-number"><span class="hljs-number">7.4</span></span> Charset=utf8 ReadOnly=<span class="hljs-keyword"><span class="hljs-keyword">No</span></span> RowVersioning=<span class="hljs-keyword"><span class="hljs-keyword">No</span></span> ShowSystemTables=<span class="hljs-keyword"><span class="hljs-keyword">No</span></span> ShowOidColumn=<span class="hljs-keyword"><span class="hljs-keyword">No</span></span> Trace=<span class="hljs-keyword"><span class="hljs-keyword">No</span></span> TraceFile=/var/<span class="hljs-keyword"><span class="hljs-keyword">log</span></span>/asterisk/<span class="hljs-keyword"><span class="hljs-keyword">sql</span></span>.<span class="hljs-keyword"><span class="hljs-keyword">log</span></span> FakeOidIndex=<span class="hljs-keyword"><span class="hljs-keyword">No</span></span> # Asterisk <span class="hljs-number"><span class="hljs-number">13.8</span></span>   Pooling=yes</code> </pre> <br>  I think that in a special explanation this file is not needed, specify only your details of access to the database. <br><br>  /etc/odbcinst.ini we bring to the form: <br><br><pre> <code class="hljs javascript">[PostgreSQL] Description = ODBC <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> PostgreSQL Driver64 = <span class="hljs-regexp"><span class="hljs-regexp">/usr/</span></span>pgsql<span class="hljs-number"><span class="hljs-number">-9.6</span></span>/lib/psqlodbc.so Setup64 = <span class="hljs-regexp"><span class="hljs-regexp">/usr/</span></span>pgsql<span class="hljs-number"><span class="hljs-number">-9.6</span></span>/lib/psqlodbcw.so FileUsage = <span class="hljs-number"><span class="hljs-number">1</span></span></code> </pre> <br>  If you have another version of PostgreSql, correct the paths to the libraries.  This is where the ODBC setup is complete for us. <br><br>  Go to Asterisk.  In order for it to look for settings in the database using the ODBC configured by us, it is necessary to add a block to the /etc/asterisk/res_odbc.conf file: <br><br><pre> <code class="hljs php">[realtime-odbc] enabled =&gt; yes dsn =&gt; asterisk ;     /etc/odbc.ini username =&gt; asterisk ;    password =&gt; password ;    pre-connect =&gt; yes</code> </pre> <br>  Now it remains to tell Asterisk which tables and for what it can use.  Add the strings to the settings section of the /etc/asterisk/extconfig.conf file: <br><br><pre> <code class="hljs php">iax.conf =&gt; odbc,realtime-odbc,db_name_config ;    iax iaxusers =&gt; odbc,realtime-odbc,db_name_iax iaxpeers =&gt; odbc,realtime-odbc,db_name_iax sippeers =&gt; odbc,realtime-odbc,db_name_sip</code> </pre> <br>  db_name_ * - replace with the corresponding tables in the database with which asterisk works <br>  Do not forget to restart Asterisk so that he would take it all.  Now you can go directly to the implementation. <br><br><h3>  Implementation </h3><br>  First we need to figure out how to deliver information on new IAX channels to all Asterisk servers.  Given that all our servers use Realtime, we will use the database.  To do this, set up a separate server with PostgreSql.  Let's create a database in which there will be a table similar to the table from realtime Asterisk.  Now my table looks like this: <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> public.iax_peers ( <span class="hljs-keyword"><span class="hljs-keyword">id</span></span> <span class="hljs-built_in"><span class="hljs-built_in">serial</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">name</span></span> <span class="hljs-built_in"><span class="hljs-built_in">character</span></span> <span class="hljs-built_in"><span class="hljs-built_in">varying</span></span>(<span class="hljs-number"><span class="hljs-number">40</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">COLLATE</span></span> pg_catalog.<span class="hljs-string"><span class="hljs-string">"default"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">type</span></span> type_values, username <span class="hljs-built_in"><span class="hljs-built_in">character</span></span> <span class="hljs-built_in"><span class="hljs-built_in">varying</span></span>(<span class="hljs-number"><span class="hljs-number">40</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">COLLATE</span></span> pg_catalog.<span class="hljs-string"><span class="hljs-string">"default"</span></span>, mailbox <span class="hljs-built_in"><span class="hljs-built_in">character</span></span> <span class="hljs-built_in"><span class="hljs-built_in">varying</span></span>(<span class="hljs-number"><span class="hljs-number">40</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">COLLATE</span></span> pg_catalog.<span class="hljs-string"><span class="hljs-string">"default"</span></span>, secret <span class="hljs-built_in"><span class="hljs-built_in">character</span></span> <span class="hljs-built_in"><span class="hljs-built_in">varying</span></span>(<span class="hljs-number"><span class="hljs-number">40</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">COLLATE</span></span> pg_catalog.<span class="hljs-string"><span class="hljs-string">"default"</span></span>, dbsecret <span class="hljs-built_in"><span class="hljs-built_in">character</span></span> <span class="hljs-built_in"><span class="hljs-built_in">varying</span></span>(<span class="hljs-number"><span class="hljs-number">40</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">COLLATE</span></span> pg_catalog.<span class="hljs-string"><span class="hljs-string">"default"</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">context</span></span> <span class="hljs-built_in"><span class="hljs-built_in">character</span></span> <span class="hljs-built_in"><span class="hljs-built_in">varying</span></span>(<span class="hljs-number"><span class="hljs-number">40</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">COLLATE</span></span> pg_catalog.<span class="hljs-string"><span class="hljs-string">"default"</span></span>, regcontext <span class="hljs-built_in"><span class="hljs-built_in">character</span></span> <span class="hljs-built_in"><span class="hljs-built_in">varying</span></span>(<span class="hljs-number"><span class="hljs-number">40</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">COLLATE</span></span> pg_catalog.<span class="hljs-string"><span class="hljs-string">"default"</span></span>, host <span class="hljs-built_in"><span class="hljs-built_in">character</span></span> <span class="hljs-built_in"><span class="hljs-built_in">varying</span></span>(<span class="hljs-number"><span class="hljs-number">40</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">COLLATE</span></span> pg_catalog.<span class="hljs-string"><span class="hljs-string">"default"</span></span>, ipaddr <span class="hljs-built_in"><span class="hljs-built_in">character</span></span> <span class="hljs-built_in"><span class="hljs-built_in">varying</span></span>(<span class="hljs-number"><span class="hljs-number">40</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">COLLATE</span></span> pg_catalog.<span class="hljs-string"><span class="hljs-string">"default"</span></span>, port <span class="hljs-built_in"><span class="hljs-built_in">integer</span></span>, defaultip <span class="hljs-built_in"><span class="hljs-built_in">character</span></span> <span class="hljs-built_in"><span class="hljs-built_in">varying</span></span>(<span class="hljs-number"><span class="hljs-number">20</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">COLLATE</span></span> pg_catalog.<span class="hljs-string"><span class="hljs-string">"default"</span></span>, sourceaddress <span class="hljs-built_in"><span class="hljs-built_in">character</span></span> <span class="hljs-built_in"><span class="hljs-built_in">varying</span></span>(<span class="hljs-number"><span class="hljs-number">20</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">COLLATE</span></span> pg_catalog.<span class="hljs-string"><span class="hljs-string">"default"</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">mask</span></span> <span class="hljs-built_in"><span class="hljs-built_in">character</span></span> <span class="hljs-built_in"><span class="hljs-built_in">varying</span></span>(<span class="hljs-number"><span class="hljs-number">20</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">COLLATE</span></span> pg_catalog.<span class="hljs-string"><span class="hljs-string">"default"</span></span>, regexten <span class="hljs-built_in"><span class="hljs-built_in">character</span></span> <span class="hljs-built_in"><span class="hljs-built_in">varying</span></span>(<span class="hljs-number"><span class="hljs-number">40</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">COLLATE</span></span> pg_catalog.<span class="hljs-string"><span class="hljs-string">"default"</span></span>, regseconds <span class="hljs-built_in"><span class="hljs-built_in">integer</span></span>, accountcode <span class="hljs-built_in"><span class="hljs-built_in">character</span></span> <span class="hljs-built_in"><span class="hljs-built_in">varying</span></span>(<span class="hljs-number"><span class="hljs-number">20</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">COLLATE</span></span> pg_catalog.<span class="hljs-string"><span class="hljs-string">"default"</span></span>, mohinterpret <span class="hljs-built_in"><span class="hljs-built_in">character</span></span> <span class="hljs-built_in"><span class="hljs-built_in">varying</span></span>(<span class="hljs-number"><span class="hljs-number">20</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">COLLATE</span></span> pg_catalog.<span class="hljs-string"><span class="hljs-string">"default"</span></span>, mohsuggest <span class="hljs-built_in"><span class="hljs-built_in">character</span></span> <span class="hljs-built_in"><span class="hljs-built_in">varying</span></span>(<span class="hljs-number"><span class="hljs-number">20</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">COLLATE</span></span> pg_catalog.<span class="hljs-string"><span class="hljs-string">"default"</span></span>, inkeys <span class="hljs-built_in"><span class="hljs-built_in">character</span></span> <span class="hljs-built_in"><span class="hljs-built_in">varying</span></span>(<span class="hljs-number"><span class="hljs-number">40</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">COLLATE</span></span> pg_catalog.<span class="hljs-string"><span class="hljs-string">"default"</span></span>, outkeys <span class="hljs-built_in"><span class="hljs-built_in">character</span></span> <span class="hljs-built_in"><span class="hljs-built_in">varying</span></span>(<span class="hljs-number"><span class="hljs-number">40</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">COLLATE</span></span> pg_catalog.<span class="hljs-string"><span class="hljs-string">"default"</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">language</span></span> <span class="hljs-built_in"><span class="hljs-built_in">character</span></span> <span class="hljs-built_in"><span class="hljs-built_in">varying</span></span>(<span class="hljs-number"><span class="hljs-number">10</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">COLLATE</span></span> pg_catalog.<span class="hljs-string"><span class="hljs-string">"default"</span></span>, callerid <span class="hljs-built_in"><span class="hljs-built_in">character</span></span> <span class="hljs-built_in"><span class="hljs-built_in">varying</span></span>(<span class="hljs-number"><span class="hljs-number">100</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">COLLATE</span></span> pg_catalog.<span class="hljs-string"><span class="hljs-string">"default"</span></span>, cid_number <span class="hljs-built_in"><span class="hljs-built_in">character</span></span> <span class="hljs-built_in"><span class="hljs-built_in">varying</span></span>(<span class="hljs-number"><span class="hljs-number">40</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">COLLATE</span></span> pg_catalog.<span class="hljs-string"><span class="hljs-string">"default"</span></span>, sendani yes_no_values, fullname <span class="hljs-built_in"><span class="hljs-built_in">character</span></span> <span class="hljs-built_in"><span class="hljs-built_in">varying</span></span>(<span class="hljs-number"><span class="hljs-number">40</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">COLLATE</span></span> pg_catalog.<span class="hljs-string"><span class="hljs-string">"default"</span></span>, trunk yes_no_values, auth <span class="hljs-built_in"><span class="hljs-built_in">character</span></span> <span class="hljs-built_in"><span class="hljs-built_in">varying</span></span>(<span class="hljs-number"><span class="hljs-number">20</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">COLLATE</span></span> pg_catalog.<span class="hljs-string"><span class="hljs-string">"default"</span></span>, maxauthreq <span class="hljs-built_in"><span class="hljs-built_in">integer</span></span>, requirecalltoken iax_requirecalltoken_values, encryption iax_encryption_values, transfer iax_transfer_values, jitterbuffer yes_no_values, forcejitterbuffer yes_no_values, <span class="hljs-keyword"><span class="hljs-keyword">disallow</span></span> <span class="hljs-built_in"><span class="hljs-built_in">character</span></span> <span class="hljs-built_in"><span class="hljs-built_in">varying</span></span>(<span class="hljs-number"><span class="hljs-number">200</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">COLLATE</span></span> pg_catalog.<span class="hljs-string"><span class="hljs-string">"default"</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">allow</span></span> <span class="hljs-built_in"><span class="hljs-built_in">character</span></span> <span class="hljs-built_in"><span class="hljs-built_in">varying</span></span>(<span class="hljs-number"><span class="hljs-number">200</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">COLLATE</span></span> pg_catalog.<span class="hljs-string"><span class="hljs-string">"default"</span></span>, deny <span class="hljs-built_in"><span class="hljs-built_in">character</span></span> <span class="hljs-built_in"><span class="hljs-built_in">varying</span></span>(<span class="hljs-number"><span class="hljs-number">200</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">COLLATE</span></span> pg_catalog.<span class="hljs-string"><span class="hljs-string">"default"</span></span>, permit <span class="hljs-built_in"><span class="hljs-built_in">character</span></span> <span class="hljs-built_in"><span class="hljs-built_in">varying</span></span>(<span class="hljs-number"><span class="hljs-number">200</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">COLLATE</span></span> pg_catalog.<span class="hljs-string"><span class="hljs-string">"default"</span></span>, codecpriority <span class="hljs-built_in"><span class="hljs-built_in">character</span></span> <span class="hljs-built_in"><span class="hljs-built_in">varying</span></span>(<span class="hljs-number"><span class="hljs-number">40</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">COLLATE</span></span> pg_catalog.<span class="hljs-string"><span class="hljs-string">"default"</span></span>, qualify <span class="hljs-built_in"><span class="hljs-built_in">character</span></span> <span class="hljs-built_in"><span class="hljs-built_in">varying</span></span>(<span class="hljs-number"><span class="hljs-number">10</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">COLLATE</span></span> pg_catalog.<span class="hljs-string"><span class="hljs-string">"default"</span></span>, qualifysmoothing yes_no_values, qualifyfreqok <span class="hljs-built_in"><span class="hljs-built_in">character</span></span> <span class="hljs-built_in"><span class="hljs-built_in">varying</span></span>(<span class="hljs-number"><span class="hljs-number">10</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">COLLATE</span></span> pg_catalog.<span class="hljs-string"><span class="hljs-string">"default"</span></span>, qualifyfreqnotok <span class="hljs-built_in"><span class="hljs-built_in">character</span></span> <span class="hljs-built_in"><span class="hljs-built_in">varying</span></span>(<span class="hljs-number"><span class="hljs-number">10</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">COLLATE</span></span> pg_catalog.<span class="hljs-string"><span class="hljs-string">"default"</span></span>, timezone <span class="hljs-built_in"><span class="hljs-built_in">character</span></span> <span class="hljs-built_in"><span class="hljs-built_in">varying</span></span>(<span class="hljs-number"><span class="hljs-number">20</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">COLLATE</span></span> pg_catalog.<span class="hljs-string"><span class="hljs-string">"default"</span></span>, adsi yes_no_values, amaflags <span class="hljs-built_in"><span class="hljs-built_in">character</span></span> <span class="hljs-built_in"><span class="hljs-built_in">varying</span></span>(<span class="hljs-number"><span class="hljs-number">20</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">COLLATE</span></span> pg_catalog.<span class="hljs-string"><span class="hljs-string">"default"</span></span>, setvar <span class="hljs-built_in"><span class="hljs-built_in">character</span></span> <span class="hljs-built_in"><span class="hljs-built_in">varying</span></span>(<span class="hljs-number"><span class="hljs-number">200</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">COLLATE</span></span> pg_catalog.<span class="hljs-string"><span class="hljs-string">"default"</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">CONSTRAINT</span></span> iax_peers_pkey PRIMARY <span class="hljs-keyword"><span class="hljs-keyword">KEY</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">id</span></span>), <span class="hljs-keyword"><span class="hljs-keyword">CONSTRAINT</span></span> iax_peers_name_key <span class="hljs-keyword"><span class="hljs-keyword">UNIQUE</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">name</span></span>) ) <span class="hljs-keyword"><span class="hljs-keyword">WITH</span></span> ( OIDS = <span class="hljs-literal"><span class="hljs-literal">FALSE</span></span> ) <span class="hljs-keyword"><span class="hljs-keyword">TABLESPACE</span></span> pg_default; <span class="hljs-keyword"><span class="hljs-keyword">ALTER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> public.iax_peers OWNER <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> asterisk;</code> </pre><br>  The table structure must be completely identical on all servers. <br><br>  <b>Bucardo</b> .  Now we will configure replication of this table.  For replication we will use Bucardo, for our task it is more than enough.  I will not describe the installation, suppose it is installed and the initial setup is made.  It remains for us to only configure the replication of the desired tables. <br><br>  Add to Bucardo information which databases will participate in replication: <br><br>  Add a local database which will be our source of all data. <br><br><pre> <code class="bash hljs">bucardo add database pbxMaster dbname=asterisk dbhost=127.0.0.1 dbuser=bucardo dbpass=Pa$<span class="hljs-variable"><span class="hljs-variable">$w0rD</span></span></code> </pre> <br>  Add a database of a remote server Asterisk <br><br><pre> <code class="bash hljs">bucardo add database asRUmoscow dbname=asrumoscow dbhost=192.168.0.30 dbuser=bucardo dbpass=Pa$<span class="hljs-variable"><span class="hljs-variable">$w0rD</span></span></code> </pre> <br>  Specify which table will be replicated: <br><br><pre> <code class="bash hljs">bucardo add table iax_peers --db=pbxMaster relgroup=iax_peer</code> </pre> <br>  Create a group for our databases: <br><br><pre> <code class="bash hljs">bucardo add dbgroup asRealtime</code> </pre> <br>  We add our databases to the new group and indicate their purpose. <br><br>  Specify the data source: <br><br><pre> <code class="bash hljs">bucardo add dbgroup asRealtime pbxMaster:<span class="hljs-built_in"><span class="hljs-built_in">source</span></span></code> </pre> <br>  Now we indicate the recipients of this data: <br><br><pre> <code class="bash hljs">bucardo add dbgroup asRealtime asRUmoscow:target</code> </pre> <br>  We inform what and how to synchronize <br><br><pre> <code class="bash hljs">bucardo add sync asRealtimeSync relgroup=iax_peers dbs=asRealtime</code> </pre> <br>  Naturally, bucardo should know about all servers where it is necessary to replicate the table, and there should be 3 or more such servers. <br><br>  In my case, each server is named in a specific way, for example, asRUmoscow: <br><br><ul><li>  as - says that this is a server with Asterisk. </li><li>  RU is the country in which the server is located. </li><li>  Moscow is the city where the server is located. </li></ul><br>  The same name is called the database for Asterisk, it allows you to simplify the scripts. <br>  Since I have the source table name and the recipient table name is always different, you need to inform Bucardo of this, for this we execute the command: <br><br><pre> <code class="bash hljs">bucardo add customname iax_peers asrumoscow_iax db=asRUmoscow</code> </pre> <br>  Here we have indicated that all the data from the iax_peers table replicate to the asrumoscow_iax table and that this applies only to the asRUmoscow database.  You can restart Bucardo and verify replication by adding channel information to the iax_peers table, it will be duplicated on all servers. <br><br>  <b>Perl</b> .  Now we need to make the server register new IAX channels.  Everything is pretty simple, there is such a <a href="https://github.com/brestows/synIAX/blob/master/syncIAXchanels">Perl script</a> .  Its essence is simple, it starts over the crown every 5 minutes, connects to the database and checks for all IAX channels recorded in the hostname_iax table there are registration lines in the hostname_config table.  If something is missing, the script will fix it, naturally, it ignores the IAX channel, the name of which is the hostname of the local server, since registering with yourself the idea is so-so. <br><br>  <b>Lua</b> .  At this stage, it turns out that our channel information is replicated, the servers themselves are registered with each other.  It remains only to resolve the issue of call routing, in the normal mode of operation, a new extension is added to the call to the new server, approximately the following content: <br><br><pre> <code class="hljs php">exten =&gt; _19xx,<span class="hljs-number"><span class="hljs-number">1</span></span>,noop(  ) exten =&gt; _19xx,<span class="hljs-number"><span class="hljs-number">1</span></span>,dial(sip/${EXTEN},<span class="hljs-number"><span class="hljs-number">60</span></span>,r) exten =&gt; _19xx,<span class="hljs-number"><span class="hljs-number">1</span></span>,hangup()</code> </pre> <br><br>  If you have 10 servers, then you should add the code above to all servers.  It needs to be simplified, for this we will write just one general extension which will itself determine where and how to call.  To do this, we will add information about which numbers are served by this or that server in the IAX channels table.  For example, for asRUmoscow, the basic information about the IAX channel will look like this: <br><br><img src="https://habrastorage.org/webt/p4/so/ir/p4soir6msbkpdwr4wbr_qyyuyfg.png"><br><br>  Here we see in the setvar column a regular expression for which you can check the dialed number by the user to this server or not.  This is more than enough to find out where the user wants to call, it remains only to realize this. <br><br>  For this we have the following code: <br><br><pre> <code class="lua hljs">extensions = { office = { [<span class="hljs-string"><span class="hljs-string">"_xxxx"</span></span>] = internal_sip; }; } <span class="hljs-comment"><span class="hljs-comment">--      function internal_sip(context, extension) local dialString = getStringDial(extension); app.Dial(dialString,60,'rTt'); end --        function isLocalPeer(extension) local query = string.format("SELECT setvar FROM %s WHERE name='%s'", hostname.."_iax",hostname); local res = assert(con:execute(query)); local regexp = res:fetch(); if (rex.find(extension, regexp)) then res:close(); return true; end res:close(); return false; end --     Dial     --     function asSystem.getStringDial(extension) local dial=nil; if (isLocalPeer(extension)) then dial = string.format("sip/%s",extension); else local query = string.format("SELECT secret FROM %s WHERE name='%s'",hostname.."_iax",hostname); local res = assert (con:execute(query)); local secret = res:fetch(); query = string.format("SELECT username,setvar FROM %s",hostname.."_iax"); res = assert (con:execute(query)); local server_list = res:fetch({},"a"); local server = nil; local findNum = extension; while server_list do if rex.find(findNum,server_list.setvar) then server = server_list.username; break; end server_list = res:fetch({},"a"); end dial = string.format("iax2/%s:%s@%s/%s",hostname,secret,server,extension); res:close(); end return dial; end</span></span></code> </pre><br>  This is not an intricate code that allows you to not edit Asterisk configuration files every time a new server is added. <br><br><h3>  results </h3><br>  Now we don‚Äôt really need to do anything to add a new server.  For this you need to run a simple set of commands: <br><br>  Add information about the new database to the replication system: <br><br><pre> <code class="bash hljs">bucardo add database asRUsmolensk dbname=asrusmolensk dbhost=192.168.15.30 dbuser=bucardo dbpass=Me%gaP@$$ bucardo add dbgroup asRealtime asRUsmolensk:target bucardo add customname iax_peers asrusmolensk_iax db=asRUsmolensk</code> </pre><br>  Add information about the new IAX channel to the main database: <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">INSERT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INTO</span></span> public.iax_peers(<span class="hljs-keyword"><span class="hljs-keyword">name</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">type</span></span>, username, secret, <span class="hljs-keyword"><span class="hljs-keyword">context</span></span>, host, trunk, auth, deny, permit, qualify,setvar) <span class="hljs-keyword"><span class="hljs-keyword">VALUES</span></span> (<span class="hljs-string"><span class="hljs-string">'asRUsmolensk'</span></span>,<span class="hljs-string"><span class="hljs-string">'friend'</span></span>,<span class="hljs-string"><span class="hljs-string">'asRUsmolensk'</span></span>, <span class="hljs-string"><span class="hljs-string">'IAX_PAS$w0Rd'</span></span>,<span class="hljs-string"><span class="hljs-string">'office'</span></span>,<span class="hljs-string"><span class="hljs-string">'dynamic'</span></span>,<span class="hljs-string"><span class="hljs-string">'yes'</span></span>,<span class="hljs-string"><span class="hljs-string">'md5'</span></span>,<span class="hljs-string"><span class="hljs-string">'0.0.0.0/0.0.0.0'</span></span>,<span class="hljs-string"><span class="hljs-string">'192.168.15.30/255.255.255'</span></span>,<span class="hljs-string"><span class="hljs-string">'yes'</span></span>,<span class="hljs-string"><span class="hljs-string">'^[16]6\d{2,2}'</span></span>),</code> </pre> <br>  After that, wait 5 minutes and the IAX channels will rise between all the servers themselves and you can immediately call the new server. <br><br>  These two actions can be wrapped in the Ansible playbook and then everything will be beautiful and fashionable. <br><br>  All this allows not only to quickly add new servers, but also to change the routing with the parameters of IAX channels.  This has been working for more than one year, now the network has grown to 25 Asterisk servers and is not sure that this is the limit. <br><br>  If there are comments and suggestions, you are welcome in the comments or drugs. </div><p>Source: <a href="https://habr.com/ru/post/349032/">https://habr.com/ru/post/349032/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../349020/index.html">Hackathon live. Accelerate mobile sites</a></li>
<li><a href="../349022/index.html">We study and implement the algorithm of the correct observer pattern for react components</a></li>
<li><a href="../349024/index.html">OpenJDK Release Candidate 10ÔºÅ</a></li>
<li><a href="../349028/index.html">HTTP Codes in Valentine's Day Comics</a></li>
<li><a href="../349030/index.html">How to: Properly call class property methods</a></li>
<li><a href="../349034/index.html">Debug Embox on STM32</a></li>
<li><a href="../349036/index.html">Atlassian User Group Moscow visiting Raiffeisenbank</a></li>
<li><a href="../349038/index.html">Another article about quaternions and Euler angles</a></li>
<li><a href="../349040/index.html">How to become a web developer and not go crazy</a></li>
<li><a href="../349042/index.html">Video from UralJS # 6 mitap - get rid of this, type the Redux application and write on React without brakes</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>