<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Smart sessions</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Solve performance problems. 

 Initial data. 
 We broadcast football matches via the Internet. Visitors: 5,000-10,000 on regular days, 100,000-150,000...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Smart sessions</h1><div class="post__text post__text-html js-mediator-article">  Solve performance problems. <br><br>  <b>Initial data.</b> <br>  We broadcast football matches via the Internet.  Visitors: 5,000-10,000 on regular days, 100,000-150,000 on match days. <br><br>  <b>In the data center</b> <br><ul><li>  5 web servers with apache and PCP, hung out through hardware load balancer </li><li>  2 memkesh pools: for sessions and data from web services </li></ul><br>  <b>Problem</b> <br>  With a large influx of visitors, the local network is overloaded due to the large number of calls to the memksh.  <u>Aggravating factors</u> : 100 Mbit network, both pools on the same servers. <br><a name="habracut"></a><br>  <b>Solutions</b> <br><ul><li>  Increasing the network to 1Gbit after the end of the series of matches </li><li>  Increase cache storage time (as a temporary measure) </li><li>  Using smart session technology </li></ul><br>  Today we will talk about the technology of smart sessions, which we used to reduce the load. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h5>  What is the essence of technology </h5><br><ol><li>  We do not create a session if it is not really needed. </li><li>  We do not update the session in the repository, if it has not changed. </li></ol><br>  In fact, our site is paid, even if we have 150,000 unique per day, then there are really few people willing to pay.  Visitors are distributed approximately as follows: <br><ul><li>  70% - Gawker.  They opened the main page, they realized that it wasn‚Äôt what they needed, they closed it.  That is, S worked well, and rake us. </li><li>  28% - Fans.  There is no money, but use our site to keep track of information during the match (goals, substitutions).  Usually not recorded, because the information is available and so. </li><li>  2% - Really watching the matches, registering and paying. </li></ul><br><br><h5>  Implementation </h5><br>  Since we use memkesh, we already have a Session object, which overloads the standard session functionality and allows us to store the latest in memkesh.  Additionally we do the following: <br><ul><li>  We put the global session_start () in if so that the session is not created when not asked. <br><blockquote><code>if(!empty($_COOKIE[ini_get('session.name')])) <br> session_start(); <br></code> </blockquote></li><li>  In the place where the user log in we add the start of the session, because here it is already necessary: <br><blockquote> <code>if(empty($_COOKIE[ini_get('session.name')])) <br> session_start(); <br></code> </blockquote></li><li>  And finally, in our object we create an additional static variable, where we store the contents of the session while reading, and during writing we do the following check at the very beginning: <br><blockquote> <code>if(self::$data !== null &amp;&amp; self::$data == $currentData) <br> return strlen($currentData); <br></code> </blockquote></li></ul><br><br>  Voila, partially the load on the network is reduced, on memkes too.  Then they switched the caching of parts of the blocks to local web servers and were able to wait for the visitors to decline painlessly, after which they increased the network bandwidth. <br><br>  Comments are welcome. <br><br>  <b>UPD</b> : The essence of the post is not to show me how cool I am, but the fact that there are trivialities in PCPs that are so mundane that we stop paying attention to them, and in fact sometimes they are not too thought out and have an impact on performance. </div><p>Source: <a href="https://habr.com/ru/post/62412/">https://habr.com/ru/post/62412/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../62401/index.html">FF 3.5, PNG and color profiles</a></li>
<li><a href="../62404/index.html">Medvedev visited Kaspersky Lab</a></li>
<li><a href="../62406/index.html">Invites</a></li>
<li><a href="../62407/index.html">Habrapechat - Printed version of habr</a></li>
<li><a href="../62410/index.html">Start</a></li>
<li><a href="../62414/index.html">We are all one team</a></li>
<li><a href="../62418/index.html">Promotion by press releases. Inside view</a></li>
<li><a href="../62419/index.html">Online Broadcast SPIKa. Peter, Olgino</a></li>
<li><a href="../62421/index.html">Flip UltraHD - Video Podcast's Best Friend</a></li>
<li><a href="../62424/index.html">Why designers should be able to impose</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>