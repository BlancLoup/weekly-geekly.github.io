<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>The Story of One Thick Binary</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hey. My name is Marco (I'm a system programmer at Badoo). And I present to your attention the translation of the post on Go, which seemed to me intere...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>The Story of One Thick Binary</h1><div class="post__text post__text-html js-mediator-article"><p><img src="https://habrastorage.org/files/b4d/988/8eb/b4d9888eb7d4478b9e65030a1a53c896.png" alt="enter image description here"></p><br><p>  <em>Hey.</em>  <em>My name is Marco (I'm a system programmer at Badoo).</em>  <em>And I present to your attention the translation of the post on Go, which seemed to me interesting.</em>  <em>Go is really scolded for thick binaries, but at the same time they are praised for static linking and for the convenience of displaying a single file.</em>  <em>If on modern servers, thick binaries are not a problem, then on embedded systems - how.</em>  <em>The author describes his history of dealing with them in Go.</em> </p><a name="habracut"></a><br><p>  Small file size is important for applications running under very limited resources.  In this article we will consider the creation of an agent program that should work on various low-power devices.  Their memory and processor resources will be small, and I can't even predict how much. </p><br><p>  Go binaries are distinguished by their small size and self-sufficiency: by creating a program on Go, you get a single binary file that contains everything you need.  Compare with platforms such as Java, Node.js, Ruby and Python, where your code takes up only a small part of the application, and everything else is a bunch of dependencies that you also have to pack if you want to get a self-contained package. </p><br><p>  Despite this important convenience, like the ability to create self-contained binaries, Go does not have built-in tools to help evaluate dependency sizes, so that developers can make informed decisions about whether to include these dependencies in a file or not. </p><br><p> The <code>gofat</code> tool will help you deal with dependency sizes in your Go project. </p><br><h3 id="sozdanie-iot-agenta">  Creating an IoT agent </h3><br><p>  I'll talk a little about how we thought through and created one of our services - an IoT agent that will be deployed on low-power devices around the world.  And consider its architecture from an operational point of view. </p><br><p>  Sample code can be downloaded from here: <a href="https://github.com/jondot/fattyproject">https://github.com/jondot/fattyproject</a> </p><br><p>  First, we need a good CLI ergonomics, so we will use the <a href="https://github.com/alecthomas/kingpin"><code>kingpin</code></a> - this is a POSIX-compatible library of CLI flags and options (I like this library so much that I used it in many of my projects).  But in fact, I will use my <a href="https://github.com/jondot/go-cli-starter"><code>go-cli-starter</code></a> project, which includes this library: </p><br><pre> <code class="hljs bash">$ git <span class="hljs-built_in"><span class="hljs-built_in">clone</span></span> https://github.com/jondot/go-cli-starter fattyproject Cloning into <span class="hljs-string"><span class="hljs-string">'fattyproject'</span></span>... remote: Counting objects: 55, <span class="hljs-keyword"><span class="hljs-keyword">done</span></span>. remote: Total 55 (delta 0), reused 0 (delta 0), pack-reused 55 Unpacking objects: 100% (55/55), <span class="hljs-keyword"><span class="hljs-keyword">done</span></span>.</code> </pre> <br><p>  Since our program is an agent, it should work all the time.  As an example for this, we will use a cycle that infinitely performs a foolish operation. </p><br><pre> <code class="hljs css"><span class="hljs-selector-tag"><span class="hljs-selector-tag">for</span></span> { <span class="hljs-attribute"><span class="hljs-attribute">f </span></span>:= <span class="hljs-built_in"><span class="hljs-built_in">NewFarble</span></span>(&amp;Counter{}) f.<span class="hljs-built_in"><span class="hljs-built_in">Bumple</span></span>() time.<span class="hljs-built_in"><span class="hljs-built_in">Sleep</span></span>(time.Second * 1) }</code> </pre> <br><p>  During long-term work, trash accumulates in memory ‚Äî small memory leaks, forgotten open file descriptors.  But even a tiny leak can turn into a giant one if the application has been running non-stop for years.  Fortunately, Go has built-in metrics and a system status monitor - <a href="https://golang.org/pkg/expvar/"><code>expvars</code></a> .  This will be very helpful in analyzing the agent's internal kitchen: since it must work for a long time without stopping, from time to time we will analyze its state ‚Äî processor consumption, garbage collection cycles, and so on.  All this will be done for us by <code>expvars</code> and <code>expvars</code> , which is very convenient for solving such problems. </p><br><p>  To use <code>expvars</code> we need magic import.  Magic - because during the import a handler will be added to the existing HTTP server.  For this we need a working HTTP server from <code>net/http</code> . </p><br><pre> <code class="hljs go"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> ( _ <span class="hljs-string"><span class="hljs-string">"expvar"</span></span> <span class="hljs-string"><span class="hljs-string">"net/http"</span></span> : : <span class="hljs-keyword"><span class="hljs-keyword">go</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> { http.ListenAndServe(<span class="hljs-string"><span class="hljs-string">":5160"</span></span>, <span class="hljs-literal"><span class="hljs-literal">nil</span></span>) }()</code> </pre> <br><p>  Once our program turns into a complex service, we can also add a logging library with support for levels in order to receive information about errors and warnings, as well as understand when the program is working normally.  To do this, use <a href="https://github.com/uber-go/zap">zap</a> (from Uber). </p><br><pre> <code class="hljs pgsql"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span>( : "go.uber.org/zap" : logger, _ := zap.NewProduction() logger.<span class="hljs-keyword"><span class="hljs-keyword">Info</span></span>("OK", zap.Int("ip", *ip))</code> </pre> <br><p>  A service that runs non-stop on a remote device that you do not control and, most likely, cannot update, should be extremely stable.  So it is advisable to lay in him the flexibility.  For example, so that he can execute custom commands and scripts, that is, provide a mechanism for changing the behavior of a service without redeploying it or restarting it. </p><br><p>  Add a launcher for an arbitrary remote script.  Although it looks suspicious, but if this is your agent or service, then you can prepare the built-in runtime sandbox to run the code.  Most often build in runtime-environment for JavaScript and Lua. </p><br><p>  We will use the embedded <a href="https://github.com/robertkrimen/otto">otto</a> JS engine. </p><br><pre> <code class="hljs coffeescript"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span>( : <span class="hljs-string"><span class="hljs-string">"github.com/robertkrimen/otto"</span></span> : <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> { : vm.Run(`<span class="javascript"><span class="javascript"> abc = </span><span class="hljs-number"><span class="javascript"><span class="hljs-number">2</span></span></span><span class="javascript"> + </span><span class="hljs-number"><span class="javascript"><span class="hljs-number">2</span></span></span><span class="javascript">; </span><span class="hljs-built_in"><span class="javascript"><span class="hljs-built_in">console</span></span></span><span class="javascript">.log(</span><span class="hljs-string"><span class="javascript"><span class="hljs-string">"\nThe value of abc is "</span></span></span><span class="javascript"> + abc); </span><span class="hljs-comment"><span class="javascript"><span class="hljs-comment">// 4 </span></span></span></span>`) : }</code> </pre> <br><p>  If we assume that the content transmitted in <code>Run</code> , we receive from the outside, we got a complex and self-updating IoT agent! </p><br><h3 id="razbiraemsya-s-zavisimostyami-dvoichnogo-fayla-go">  Understanding the dependencies of the Go binary </h3><br><p>  So, what we have come to. </p><br><pre> <code class="hljs mel">$ <span class="hljs-keyword"><span class="hljs-keyword">ls</span></span> -lha fattyproject ... <span class="hljs-number"><span class="hljs-number">13</span></span>M ... fattyproject*</code> </pre> <br><p>  We assume that we need all the dependencies added, but as a result, the size of the binary file is adjusted to 12 megabytes.  Although this is not much compared with other languages ‚Äã‚Äãand platforms, however, given the modest capabilities of IoT equipment, it would be advisable to reduce the file size and the cost of computing resources. </p><br><p>  Let's find out how dependencies are added to our binary file. </p><br><p>  First, let's deal with a well-known binary.  <a href="http://www.graphicsmagick.org/">GraphicsMagick</a> is a modern variation of the popular <code>ImageMagick</code> image processing system.  You probably have it already installed.  If not, then under OS X you can do this with the <code>brew install graphicsmagick</code> . </p><br><p>  <code>otool</code> is an alternative to the <a href="http://man7.org/linux/man-pages/man1/ldd.1.html">ldd</a> tool, only under OS X. With it, we can analyze the binary file and find out which libraries it is linked to. </p><br><pre> <code class="hljs pgsql">$ otool -L `which convert` /usr/<span class="hljs-keyword"><span class="hljs-keyword">local</span></span>/bin/convert: /usr/<span class="hljs-keyword"><span class="hljs-keyword">local</span></span>/Cellar/imagemagick/<span class="hljs-number"><span class="hljs-number">6.9</span></span><span class="hljs-number"><span class="hljs-number">.3</span></span><span class="hljs-number"><span class="hljs-number">-0</span></span>_2/lib/libMagickCore<span class="hljs-number"><span class="hljs-number">-6.</span></span>Q16<span class="hljs-number"><span class="hljs-number">.2</span></span>.dylib (compatibility <span class="hljs-keyword"><span class="hljs-keyword">version</span></span> <span class="hljs-number"><span class="hljs-number">3.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">current</span></span> <span class="hljs-keyword"><span class="hljs-keyword">version</span></span> <span class="hljs-number"><span class="hljs-number">3.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span>) /usr/<span class="hljs-keyword"><span class="hljs-keyword">local</span></span>/Cellar/imagemagick/<span class="hljs-number"><span class="hljs-number">6.9</span></span><span class="hljs-number"><span class="hljs-number">.3</span></span><span class="hljs-number"><span class="hljs-number">-0</span></span>_2/lib/libMagickWand<span class="hljs-number"><span class="hljs-number">-6.</span></span>Q16<span class="hljs-number"><span class="hljs-number">.2</span></span>.dylib (compatibility <span class="hljs-keyword"><span class="hljs-keyword">version</span></span> <span class="hljs-number"><span class="hljs-number">3.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">current</span></span> <span class="hljs-keyword"><span class="hljs-keyword">version</span></span> <span class="hljs-number"><span class="hljs-number">3.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span>) /usr/<span class="hljs-keyword"><span class="hljs-keyword">local</span></span>/opt/freetype/lib/libfreetype<span class="hljs-number"><span class="hljs-number">.6</span></span>.dylib (compatibility <span class="hljs-keyword"><span class="hljs-keyword">version</span></span> <span class="hljs-number"><span class="hljs-number">19.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">current</span></span> <span class="hljs-keyword"><span class="hljs-keyword">version</span></span> <span class="hljs-number"><span class="hljs-number">19.3</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span>) /usr/<span class="hljs-keyword"><span class="hljs-keyword">local</span></span>/opt/xz/lib/liblzma<span class="hljs-number"><span class="hljs-number">.5</span></span>.dylib (compatibility <span class="hljs-keyword"><span class="hljs-keyword">version</span></span> <span class="hljs-number"><span class="hljs-number">8.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">current</span></span> <span class="hljs-keyword"><span class="hljs-keyword">version</span></span> <span class="hljs-number"><span class="hljs-number">8.2</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span>) /usr/lib/libbz2<span class="hljs-number"><span class="hljs-number">.1</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span>.dylib (compatibility <span class="hljs-keyword"><span class="hljs-keyword">version</span></span> <span class="hljs-number"><span class="hljs-number">1.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">current</span></span> <span class="hljs-keyword"><span class="hljs-keyword">version</span></span> <span class="hljs-number"><span class="hljs-number">1.0</span></span><span class="hljs-number"><span class="hljs-number">.5</span></span>) /usr/lib/libz<span class="hljs-number"><span class="hljs-number">.1</span></span>.dylib (compatibility <span class="hljs-keyword"><span class="hljs-keyword">version</span></span> <span class="hljs-number"><span class="hljs-number">1.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">current</span></span> <span class="hljs-keyword"><span class="hljs-keyword">version</span></span> <span class="hljs-number"><span class="hljs-number">1.2</span></span><span class="hljs-number"><span class="hljs-number">.5</span></span>) /usr/<span class="hljs-keyword"><span class="hljs-keyword">local</span></span>/opt/libtool/lib/libltdl<span class="hljs-number"><span class="hljs-number">.7</span></span>.dylib (compatibility <span class="hljs-keyword"><span class="hljs-keyword">version</span></span> <span class="hljs-number"><span class="hljs-number">11.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">current</span></span> <span class="hljs-keyword"><span class="hljs-keyword">version</span></span> <span class="hljs-number"><span class="hljs-number">11.1</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span>) /usr/lib/libSystem.B.dylib (compatibility <span class="hljs-keyword"><span class="hljs-keyword">version</span></span> <span class="hljs-number"><span class="hljs-number">1.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">current</span></span> <span class="hljs-keyword"><span class="hljs-keyword">version</span></span> <span class="hljs-number"><span class="hljs-number">1226.10</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span>)</code> </pre> <br><p>  From the list, you can isolate and the size of each dependency: </p><br><pre> <code class="hljs coffeescript">$ ls -lha <span class="hljs-regexp"><span class="hljs-regexp">/usr/l/</span></span>...<span class="hljs-regexp"><span class="hljs-regexp">/-0_2/lib/libMagickCore-6.Q16.2.dylib ... 1.7M ... /usr/</span></span>.../libMagickCore<span class="hljs-number"><span class="hljs-number">-6.</span></span>Q16<span class="hljs-number"><span class="hljs-number">.2</span></span>.dylib</code> </pre> <br><p>  Can we thus get a fairly complete picture of <strong>any</strong> binary file?  Obviously, the answer is no. </p><br><p>  By default, Go links statically.  Because of this, we get the only self-contained binary file.  But it also means that <code>otool</code> , like any other similar tool, will be useless. </p><br><pre> <code class="hljs go">$ cat main.<span class="hljs-keyword"><span class="hljs-keyword">go</span></span> <span class="hljs-keyword"><span class="hljs-keyword">package</span></span> main <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">main</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> { <span class="hljs-built_in"><span class="hljs-built_in">print</span></span>(<span class="hljs-string"><span class="hljs-string">"hello"</span></span>) } $ <span class="hljs-keyword"><span class="hljs-keyword">go</span></span> build &amp;&amp; otool -L main main:</code> </pre> <br><p>  If we still try to parse the Go binary file into its dependencies, then we will have to use a tool that understands the format of these binary files.  Let's look for something suitable. </p><br><p>  For a list of available tools, use the <code>go tool</code> : </p><br><pre> <code class="hljs perl">$ go tool addr2line api asm cgo compile cover dist doc fix <span class="hljs-keyword"><span class="hljs-keyword">link</span></span> nm objdump <span class="hljs-keyword"><span class="hljs-keyword">pack</span></span> pprof trace vet yacc</code> </pre> <br><p>  We can immediately refer to the <a href="https://golang.org/src/cmd/">source codes of these tools</a> .  Take, for example, nm, and see its <a href="">package documentation</a> .  I intentionally mentioned this tool.  As it turned out, the possibilities of <code>nm</code> very close to what we need, but this is still not enough.  He is able to display a list of characters and sizes of objects, but all this is useless if we try to get a general idea of ‚Äã‚Äãthe dependencies of a binary file. </p><br><pre> <code class="hljs go">$ <span class="hljs-keyword"><span class="hljs-keyword">go</span></span> tool nm -sort size -size fattyproject | head -n <span class="hljs-number"><span class="hljs-number">20</span></span> <span class="hljs-number"><span class="hljs-number">5</span></span>ee8a0 <span class="hljs-number"><span class="hljs-number">1960408</span></span> R runtime.eitablink <span class="hljs-number"><span class="hljs-number">5</span></span>ee8a0 <span class="hljs-number"><span class="hljs-number">1960408</span></span> R runtime.symtab <span class="hljs-number"><span class="hljs-number">5</span></span>ee8a0 <span class="hljs-number"><span class="hljs-number">1960408</span></span> R runtime.pclntab <span class="hljs-number"><span class="hljs-number">5</span></span>ee8a0 <span class="hljs-number"><span class="hljs-number">1960408</span></span> R runtime.esymtab <span class="hljs-number"><span class="hljs-number">4421e0</span></span> <span class="hljs-number"><span class="hljs-number">1011800</span></span> R <span class="hljs-keyword"><span class="hljs-keyword">type</span></span>.* <span class="hljs-number"><span class="hljs-number">4421e0</span></span> <span class="hljs-number"><span class="hljs-number">1011800</span></span> R runtime.types <span class="hljs-number"><span class="hljs-number">4421e0</span></span> <span class="hljs-number"><span class="hljs-number">1011800</span></span> R runtime.rodata <span class="hljs-number"><span class="hljs-number">551</span></span>a80 <span class="hljs-number"><span class="hljs-number">543204</span></span> R <span class="hljs-keyword"><span class="hljs-keyword">go</span></span>.<span class="hljs-keyword"><span class="hljs-keyword">func</span></span>.* <span class="hljs-number"><span class="hljs-number">551</span></span>a80 <span class="hljs-number"><span class="hljs-number">543204</span></span> R <span class="hljs-keyword"><span class="hljs-keyword">go</span></span>.<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>.hdr.* <span class="hljs-number"><span class="hljs-number">12d</span></span>160 <span class="hljs-number"><span class="hljs-number">246512</span></span> T github.com/robertkrimen/otto._newContext <span class="hljs-number"><span class="hljs-number">539238</span></span> <span class="hljs-number"><span class="hljs-number">100424</span></span> R <span class="hljs-keyword"><span class="hljs-keyword">go</span></span>.<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>.* <span class="hljs-number"><span class="hljs-number">804760</span></span> <span class="hljs-number"><span class="hljs-number">65712</span></span> B runtime.trace cd1e0 <span class="hljs-number"><span class="hljs-number">23072</span></span> T net/http.init <span class="hljs-number"><span class="hljs-number">5e3</span></span>b80 <span class="hljs-number"><span class="hljs-number">21766</span></span> R runtime.findfunctab <span class="hljs-number"><span class="hljs-number">1</span></span>ae1a0 <span class="hljs-number"><span class="hljs-number">18720</span></span> T <span class="hljs-keyword"><span class="hljs-keyword">go</span></span>.uber.org/zap.Any <span class="hljs-number"><span class="hljs-number">301510</span></span> <span class="hljs-number"><span class="hljs-number">18208</span></span> T unicode.init <span class="hljs-number"><span class="hljs-number">5e9088</span></span> <span class="hljs-number"><span class="hljs-number">17924</span></span> R runtime.typelink <span class="hljs-number"><span class="hljs-number">3</span></span>b7fe0 <span class="hljs-number"><span class="hljs-number">16160</span></span> T crypto/sha512.block <span class="hljs-number"><span class="hljs-number">8008</span></span>a0 <span class="hljs-number"><span class="hljs-number">16064</span></span> B runtime.semtable <span class="hljs-number"><span class="hljs-number">3f</span></span>6d60 <span class="hljs-number"><span class="hljs-number">14640</span></span> T crypto/sha256.block</code> </pre> <br><p>  Although in relation to the dependencies themselves, the indicated dimensions (second column) may be exact, but on the whole we cannot simply add and add these values. </p><br><h3 id="gofat">  Gofat </h3><br><p>  There remains the last trick that should work.  When you compile your binary file, Go generates intermediate files for each dependency, before statically linking them into a single file. </p><br><p>  I present to your attention <code>gofat</code> - a shell script that is a combination of Go code and some Unix tools.  It analyzes dependency sizes in Go binaries: </p><br><pre> <code class="hljs mel">#!/bin/sh <span class="hljs-keyword"><span class="hljs-keyword">eval</span></span> <span class="hljs-string"><span class="hljs-string">`go build -work -a 2&gt;&amp;1`</span></span> &amp;&amp; find $WORK -type f -name <span class="hljs-string"><span class="hljs-string">"*.a"</span></span> | xargs -I{} du -hxs <span class="hljs-string"><span class="hljs-string">"{}"</span></span> | gsort -rh | sed -es:${WORK}/::g</code> </pre> <br><p>  If you are in a hurry, just copy or download this script and make it executable ( <code>chmod +x</code> ).  Then run the script without any arguments in your project directory to get information about its dependencies. </p><br><p>  Let's deal with this command: </p><br><p>  eval <code>go build -work -a 2&gt;&amp;1</code> </p><br><p>  The -a flag tells Go to ignore the cache and build the project from scratch.  In this case, all dependencies will be reassembled forcibly.  The flag ‚Äìwork displays the working directory, so we can analyze it (thanks to the Go developers!). </p><br><pre> <code class="hljs nginx"><span class="hljs-attribute"><span class="hljs-attribute">find</span></span> <span class="hljs-variable"><span class="hljs-variable">$WORK</span></span> -type f -name <span class="hljs-string"><span class="hljs-string">"*.a"</span></span> | xargs -I{} <span class="hljs-attribute"><span class="hljs-attribute">du</span></span> -hxs <span class="hljs-string"><span class="hljs-string">"{}"</span></span> | gsort -rh</code> </pre> <br><p>  Then we use the <code>find</code> tool to <code>find</code> all the <code>*.a</code> files that represent our compiled dependencies.  Then we transfer all strings (locations of files) to <code>xargs</code> .  This utility allows you to apply commands to each transmitted string - in our case, <code>du</code> , which gets the file size. </p><br><p>  Finally, we use <code>gsort</code> (the GNU version of sort) to sort the file sizes in reverse order. </p><br><pre> <code class="hljs nginx"><span class="hljs-attribute"><span class="hljs-attribute">sed</span></span> -es:<span class="hljs-variable"><span class="hljs-variable">${WORK}</span></span>/::g</code> </pre> <br><p>  We remove the WORK folder prefix from everywhere and display a cleared string with data on dependencies. </p><br><p>  Moving on to the most interesting part: what does 12 MB occupy in our binary file? </p><br><h3 id="sbrasyvaem-ves">  Lose weight </h3><br><p>  For the first time, we launch <code>gofat</code> for our toy project with an IoT agent.  We get the following data: </p><br><pre> <code class="hljs pgsql"><span class="hljs-number"><span class="hljs-number">2.2</span></span>M github.com/robertkrimen/otto.a <span class="hljs-number"><span class="hljs-number">1.8</span></span>M net/http.a <span class="hljs-number"><span class="hljs-number">1.4</span></span>M runtime.a <span class="hljs-number"><span class="hljs-number">960</span></span>K net.a <span class="hljs-number"><span class="hljs-number">820</span></span>K reflect.a <span class="hljs-number"><span class="hljs-number">788</span></span>K gopkg.<span class="hljs-keyword"><span class="hljs-keyword">in</span></span>/alecthomas/kingpin.v2.a <span class="hljs-number"><span class="hljs-number">668</span></span>K github.com/newrelic/go-agent.a <span class="hljs-number"><span class="hljs-number">624</span></span>K github.com/newrelic/go-agent/<span class="hljs-type"><span class="hljs-type">internal</span></span>.a <span class="hljs-number"><span class="hljs-number">532</span></span>K crypto/tls.a <span class="hljs-number"><span class="hljs-number">464</span></span>K <span class="hljs-keyword"><span class="hljs-keyword">encoding</span></span>/gob.a <span class="hljs-number"><span class="hljs-number">412</span></span>K math/big.a <span class="hljs-number"><span class="hljs-number">392</span></span>K <span class="hljs-type"><span class="hljs-type">text</span></span>/<span class="hljs-keyword"><span class="hljs-keyword">template</span></span>.a <span class="hljs-number"><span class="hljs-number">392</span></span>K go.uber.org/zap/zapcore.a <span class="hljs-number"><span class="hljs-number">388</span></span>K github.com/alecthomas/<span class="hljs-keyword"><span class="hljs-keyword">template</span></span>.a <span class="hljs-number"><span class="hljs-number">352</span></span>K crypto/x509.a <span class="hljs-number"><span class="hljs-number">344</span></span>K go/ast.a <span class="hljs-number"><span class="hljs-number">340</span></span>K syscall.a <span class="hljs-number"><span class="hljs-number">328</span></span>K <span class="hljs-keyword"><span class="hljs-keyword">encoding</span></span>/<span class="hljs-type"><span class="hljs-type">json</span></span>.a <span class="hljs-number"><span class="hljs-number">320</span></span>K <span class="hljs-type"><span class="hljs-type">text</span></span>/<span class="hljs-keyword"><span class="hljs-keyword">template</span></span>/parse.a <span class="hljs-number"><span class="hljs-number">312</span></span>K github.com/robertkrimen/otto/<span class="hljs-keyword"><span class="hljs-keyword">parser</span></span>.a <span class="hljs-number"><span class="hljs-number">312</span></span>K github.com/alecthomas/<span class="hljs-keyword"><span class="hljs-keyword">template</span></span>/parse.a <span class="hljs-number"><span class="hljs-number">288</span></span>K go.uber.org/zap.a <span class="hljs-number"><span class="hljs-number">232</span></span>K <span class="hljs-type"><span class="hljs-type">time</span></span>.a <span class="hljs-number"><span class="hljs-number">224</span></span>K regexp/syntax.a <span class="hljs-number"><span class="hljs-number">224</span></span>K regexp.a <span class="hljs-number"><span class="hljs-number">224</span></span>K go/doc.a <span class="hljs-number"><span class="hljs-number">216</span></span>K fmt.a <span class="hljs-number"><span class="hljs-number">196</span></span>K unicode.a <span class="hljs-number"><span class="hljs-number">192</span></span>K compress/flate.a <span class="hljs-number"><span class="hljs-number">172</span></span>K github.com/robertkrimen/otto/ast.a <span class="hljs-number"><span class="hljs-number">172</span></span>K crypto/elliptic.a <span class="hljs-number"><span class="hljs-number">156</span></span>K <span class="hljs-keyword"><span class="hljs-keyword">encoding</span></span>/asn1.a <span class="hljs-number"><span class="hljs-number">152</span></span>K os.a <span class="hljs-number"><span class="hljs-number">136</span></span>K strconv.a <span class="hljs-number"><span class="hljs-number">128</span></span>K os/exec.a <span class="hljs-number"><span class="hljs-number">128</span></span>K github.com/Sirupsen/logrus.a <span class="hljs-number"><span class="hljs-number">128</span></span>K flag.a <span class="hljs-number"><span class="hljs-number">112</span></span>K vendor/golang_org/x/net/http2/hpack.a <span class="hljs-number"><span class="hljs-number">104</span></span>K strings.a <span class="hljs-number"><span class="hljs-number">104</span></span>K net/textproto.a <span class="hljs-number"><span class="hljs-number">104</span></span>K mime/multipart.a</code> </pre> <br><p>  If you experiment, you will notice that with <code>gofat</code> the build time increases significantly.  The fact is that we run the build in the <code>-a</code> mode, in which everything is rebuilt. </p><br><p>  Now we know how much space each dependency takes.  Roll up the sleeves, analyze and take action. </p><br><pre> <code class="hljs dos"><span class="hljs-number"><span class="hljs-number">1</span></span>.<span class="hljs-number"><span class="hljs-number">8</span></span>M <span class="hljs-built_in"><span class="hljs-built_in">net</span></span>/http.a</code> </pre> <br><p>  Everything related to HTTP processing pulls up to 1.8 MB.  Perhaps you can throw it out.  We will refuse <code>expvar</code> , instead we will periodically <code>expvar</code> critical parameters and program status information to a log file.  If you do this often, everything will be fine. </p><br><p>  <strong>Update:</strong> With the release of Go 1.8 net / http, it weighs 2.2 MB. </p><br><pre> <code class="hljs pgsql"><span class="hljs-number"><span class="hljs-number">788</span></span>K gopkg.<span class="hljs-keyword"><span class="hljs-keyword">in</span></span>/alecthomas/kingpin.v2.a <span class="hljs-number"><span class="hljs-number">388</span></span>K github.com/alecthomas/<span class="hljs-keyword"><span class="hljs-keyword">template</span></span>.a</code> </pre> <br><p>  And this is a big surprise: about 1 MB takes a very convenient POSIX-feature for parsing flags.  You can opt out of it and use the package from the standard library, or even do away with the flags altogether and read the configuration from the environment variables (and this will also take up some volume). </p><br><p>  <code>Newrelic</code> adds another 1.3 MB, so you can also drop it: </p><br><pre> <code class="hljs go"><span class="hljs-number"><span class="hljs-number">668</span></span>K github.com/newrelic/<span class="hljs-keyword"><span class="hljs-keyword">go</span></span>-agent.a <span class="hljs-number"><span class="hljs-number">624</span></span>K github.com/newrelic/<span class="hljs-keyword"><span class="hljs-keyword">go</span></span>-agent/internal.a</code> </pre> <br><p>  `Zap also throw out.  We use the standard logging package: </p><br><p>  392K go.uber.org/zap/zapcore.a </p><br><p>  <code>Otto</code> , being embedded JS-engine, weighs a lot: </p><br><pre> <code class="hljs pgsql"><span class="hljs-number"><span class="hljs-number">2.2</span></span>M github.com/robertkrimen/otto.a <span class="hljs-number"><span class="hljs-number">312</span></span>K github.com/robertkrimen/otto/<span class="hljs-keyword"><span class="hljs-keyword">parser</span></span>.a <span class="hljs-number"><span class="hljs-number">172</span></span>K github.com/robertkrimen/otto/ast.a</code> </pre> <br><p>  At the same time, <code>logrus</code> takes up little space for such a multifunctional logging library: </p><br><pre> <code class="hljs">128K github.com/Sirupsen/logrus.a</code> </pre> <br><p>  You can leave. </p><br><h3 id="zaklyuchenie">  Conclusion </h3><br><p>  We found a way to calculate dependency sizes in Go and saved about 7 MB.  And we decided that we will not use certain dependencies, but instead we will take analogues from the standard Go library. </p><br><p>  Moreover, I would say that if we try hard and experiment with a set of dependencies, we can shrink our binary file from the initial 12 MB to 1.2 MB. </p><br><p>  It is not necessary to do this, because the dependencies in Go are already small compared to other platforms.  But you definitely need to have on hand tools that will help you better understand what you are creating.  And if you are developing software for environments with very limited resources available, then <code>gofat</code> can be one such tool. </p><br><p>  PS: if you want to experiment more, here is the reference repository: <a href="https://github.com/jondot/fattyproject">https://github.com/jondot/fattyproject</a> . </p></div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <p>Source: <a href="https://habr.com/ru/post/322880/">https://habr.com/ru/post/322880/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../322860/index.html">Catch in 30 minutes and other records Social Media Support</a></li>
<li><a href="../322864/index.html">The time of cargo cults in the marketing of games has passed. Interview with Max Donskikh, Game Insight President</a></li>
<li><a href="../322870/index.html">Go to work in Germany and stay live forever</a></li>
<li><a href="../322872/index.html">The terms "frontend", "client side" and "interface" - how to use and not screw it up</a></li>
<li><a href="../322876/index.html">Fear and Loathing in Distributed Systems</a></li>
<li><a href="../322884/index.html">We look inside the domestic 28nm MIPS processor - Baikal-T1</a></li>
<li><a href="../322886/index.html">Pricing when creating a site and problems on the route Client - Contractor</a></li>
<li><a href="../322888/index.html">What you need to know when developing your CMF and CMS. Experience 2 years long</a></li>
<li><a href="../322890/index.html">The subtleties of R. How minute saves the minute</a></li>
<li><a href="../322892/index.html">The court, having no access to the Internet, supported the blocking of RosKomSvoboda in educational institutions of Moscow</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>