<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>About midi-files and PHP, as a tool for everyday programming with a live example</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Foreword 
 Very often I come across the fact that many people do not perceive PHP as anything other than a means for developing websites, but I want t...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>About midi-files and PHP, as a tool for everyday programming with a live example</h1><div class="post__text post__text-html js-mediator-article"><h4>  Foreword </h4><br>  Very often I come across the fact that many people do not perceive PHP as anything other than a means for developing websites, but I want to dissuade them with this topic. <br><br>  Today they called me and asked for help with the synthesizer of the company YAMAHA (in particular with the analogue of the model 403), which has one interesting feature - it allows you to save 5 written songs in your memory, but you can get them on your computer in any form other than the backup file no copy is allowed, as stated in all forums and in the technical documentation for this synthesizer. <br><a name="habracut"></a><br><br>  <u>The .bup format is used by the synthesizer to save all settings and 5 recorded songs.</u> 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      All the tips for recording these melodies boil down to recording music from a synthesizer in a velan time, but this is not an option. <br><br><h4>  so, let's begin </h4><br><br>  In my hands was a file named <b>08PK61.BUP</b> .  The first glance did not cause any positive emotions: <br> <code>06PK61 BackFile</code> <br>  Glasil ascii-header file.  Google also did not give any positive results. <br>  But then I remembered that synthesizers use the midi format for music, and why don't developers keep a standard midi stream in a backup file? <br>  ‚ÄúBut how will I find him ?!‚Äù flashed through my mind.  And everything turned out <a href="http://ru.wikipedia.org/wiki/MIDI">to</a> be <a href="http://ru.wikipedia.org/wiki/MIDI">easy.</a> <br>  As it turned out, the standard header of the midi-file looks like this: <br><br> <code><u>4D 54 68 64</u> <u>00 00 00 06</u> <u>00 00</u> <u>00 01</u> <u>00 60</u> <br></code> <br>  For a simplified understanding, I divided the title into 5 parts: <br><ul><li>  Mthd - header, midi-file begins with it </li><li>  00 00 00 06 - the length of the data behind this block (in bytes) </li><li>  00 00 - file type (3 types) </li><li>  00 01 - the number of MTrk blocks </li><li>  00 60 - pace </li></ul><br><br>  Well, I read this in Wikipedia, and immediately decided to drive MThd into the search for this file.  Here I was disappointed - this sequence of bytes was not in the file.  My hands dropped. <br><br>  Having nothing to do, I decided to finish reading the article to the end (and I realized that this should always be done) and I saw about MTrk recordings (briefly about them): <br>  Starts with a sequence <br> <code>4D 54 72 6B</code> <br>  The data goes farther and the block ends with a sequence <br> <code>FF 2F 00</code> <br> <br>  I start the search in the sequence 4D 54 72 6B, and about a miracle, I found as many as three such records. <br><br>  Then it remained for the small: <br>  It is necessary to copy the MTrk block ending with the sequence FF 2F 00 and after adding the standard MThd header to write all this to a file. <br>  No sooner said than done. <br>  Saving the result in the mid file and opening it in the player I heard the recorded music <br><br><h4>  And now about programming </h4><br><br>  Well, if you need to tear out one song from such a file, then okay, you could finish it, but if there is a need to process several files in a similar way, what then?  But then automation comes to the rescue. <br><br>  All the actions that we need to perform on the subject, we found out, now we will put them together and realize it, i.e.  in code: <br><br><ol><li>  Open file </li><li>  Read file </li><li>  Override the result in HEX </li><li>  Find matches with MTrk header, if any, continue, otherwise exit </li><li>  Match FF 2F 00 </li><li>  The resulting indices copy the substring into a variable </li><li>  Create output file </li><li>  Write the MThd header and the variable with the MTrk block processed by the HEX2BIN function </li><li>  Save, close file </li><li>  Back to p.4 </li></ol><br><br>  Ready php code: <br><blockquote><ol><li>  &lt;? php </li><li>  function hex2bin ($ h) <font color="#008000">// function, which for some unknown reason is not in php</font> </li><li>  { </li><li>  <font color="#0000ff">if</font> (! is_string ($ h)) <font color="#0000ff">return</font> <font color="#0000ff">null</font> ; </li><li>  $ r = <font color="#A31515">"</font> ; </li><li>  <font color="#0000ff">for</font> ($ a = 0; $ a &lt;strlen ($ h); $ a + = 2) {$ r. = chr (hexdec ($ h {$ a}. $ h {($ a + 1)}));  } </li><li>  <font color="#0000ff">return</font> $ r; </li><li>  } </li><li></li><li>  $ lp = 0; </li><li>  $ i = 0; </li><li>  $ fh = fopen ( <font color="#A31515">'test.bup'</font> , <font color="#A31515">"r"</font> ) or die ( <font color="#A31515">"Can't open file!"</font> );  <font color="#008000">// open the file</font> </li><li>  $ file = fread ($ fh, filesize ( <font color="#A31515">'test.bup'</font> ));  <font color="#008000">// read</font> </li><li>  $ bin = bin2hex ($ file);  <font color="#008000">// translate to hex</font> </li><li></li><li>  <font color="#0000ff">while</font> (strpos ($ bin, <font color="#A31515">'4d54726b'</font> , $ lp)! == <font color="#0000ff">false</font> ) <font color="#008000">// workflow</font> </li><li>  { </li><li>  $ fp = strpos ($ bin, <font color="#A31515">'4d54726b'</font> , $ lp); </li><li>  $ lp = strpos ($ bin, <font color="#A31515">'ff2f'</font> , $ fp); </li><li></li><li>  $ getss = substr ($ bin, $ fp, $ lp- $ fp + 6); </li><li></li><li>  $ fm = fopen ( <font color="#A31515">"mid $ i.mid"</font> , <font color="#A31515">"w"</font> ); </li><li>  fwrite ($ fm, hex2bin ( <font color="#A31515">'4d54686400000006000000010060'</font> . $ getss));  <font color="#008000">// write to the MThd and MTrk header file</font> </li><li>  fclose ($ fm); </li><li>  $ i ++; </li><li>  } </li><li>  fclose ($ fh); </li><li>  ?&gt; </li></ol></blockquote><br><br>  This is how everything is easy;) <br><br>  <b>UPD.</b>  On the advice of an unknown to me (except for nick eDogs) I will add a user about the function of converting to a binary form.  Instead, it can use the standard PHP function: <br>  string <b><a href="http://ru2.php.net/manual/en/function.pack.php">pack</a></b> (string <i>$ format</i> [, mixed <i>$ args</i> [, mixed <i>$ ...</i> ]])) </div><p>Source: <a href="https://habr.com/ru/post/81831/">https://habr.com/ru/post/81831/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../81824/index.html">Deploying sites on Windows Server 2003 / IIS 6 from scratch</a></li>
<li><a href="../81825/index.html">Pope Catholic priests: we have to become bloggers</a></li>
<li><a href="../81827/index.html">Happy Russian Students Day</a></li>
<li><a href="../81829/index.html">We draw interactive graphics using Flot php and mysql</a></li>
<li><a href="../81830/index.html">Would you use paid online TV with about a hundred channels and viewing from a browser / smart phone?</a></li>
<li><a href="../81832/index.html">Page for happy owners of IE6</a></li>
<li><a href="../81835/index.html">Handy.CMS 3.1 build 2003</a></li>
<li><a href="../81840/index.html">The art of killing dragons</a></li>
<li><a href="../81842/index.html">Recovery of the OS after the ransomware virus</a></li>
<li><a href="../81845/index.html">Implementing ToString () in C ++</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>