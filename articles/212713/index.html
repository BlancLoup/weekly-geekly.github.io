<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>IP PBX in the cloud do it yourself in 10 minutes</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Many of Habr's readers are familiar with modern IP PBXs in the cloud, such as Mango, Oktell, Octoline and others. All of them offer various functions ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>IP PBX in the cloud do it yourself in 10 minutes</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/getpro/habr/post_images/4ee/e03/ce5/4eee03ce5319e97476a77603387be55d.jpg" align="left">  Many of Habr's readers are familiar with modern IP PBXs in the cloud, such as Mango, Oktell, Octoline and others.  All of them offer various functions and tariff plans to satisfy the most different customers and meet their requirements, but there are always a number of those who choose Asterisk anyway, because they want to have opportunities for customization and integration, which only Asterisk can offer a few.  In addition to Asterisk itself, it will still require a person who will be able to configure everything and support it, a separate connection to the telecom operator via SIP or via a VoIP gateway and so on.  When we started to create our own cloud platform for developing <a href="http://voximplant.com/">VoxImplant</a> communication applications, we, of course, knew that one of the most popular scenarios for its use would be an IP PBX, so we implemented all the necessary functionality for this.  Unlike the case of Asterisk, a person who decides to make his IP PBX based on VoxImplant will need only Javascript knowledge, familiarization with this article and free 10-15 minutes to get the first working version of PBX at the output, which can later be integrated with their services and customize in accordance with their requirements.  More on this under the cut. <br><a name="habracut"></a><br>  First, we will define the architecture and functionality of the PBX, I will immediately note that in this article we will look at the basic version that is suitable for organizing telephony in the office in some cases, and if you wish, you can customize the scripts according to your requirements, but more on that later.  We will build a PBX in accordance with the following scheme: <br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/29b/38a/ef7/29b38aef7e9e67f7d9b2057a456345f7.png"></div><br>  PBX users can make calls to each other and to real phone numbers, a separate group of users (Operators) can also receive incoming calls that come to the PBX from ordinary phones (more on this later) or via SIP, respectively, they can transfer calls to regular users and each friend if necessary.  SIP phone - softphone or iron phone, with support for SIP, Web SDK / Mobile SDK - client application for a browser or smartphone, made using the appropriate SDK from VoxImplant. <br><br>  So, to create an IP PBX, we need a free VoxImplant developer account, which can be obtained here <a href="https://voximplant.com/sign-up">https://voximplant.com/sign-up</a> <br>  After creating and activating an account, you can go to the control panel <a href="https://manage.voximplant.com/">https://manage.voximplant.com/</a> , where most of our future work will take place.  To begin, we will need to create users (Users) that will correspond to users and operators of the PBX, when creating a user, you can choose whether he has a separate VoxImplant account (Separate account balance) or if he calls, the amount will be debited from the general account of the account (by default) - while we change nothing, we do by default.  <b><u>IMPORTANT:</u> Use 3-digit numeric codes (101, 102, 103, etc.) for login / username - in our scripts we will proceed from this format.</b>  Now you can proceed directly to the creation of PBX functionality, VoxImplant server applications are a set of scenarios that process calls passing through the platform.  These scripts are written in standard Javascript, in which several namespaces and classes are available for working with VoxImplant functions (for more details, see <a href="http://voximplant.com/docs/references/appengine/">the link</a> ).  Scripts are created and edited in the Scenarios section.  In total, we will have 3 types of call processing scenarios: for incoming, for outgoing and for calls between users, let's call them PBX in, PBX out and PBX local, respectively.  Let's start with the simplest PBX local: <br><br><pre><code class="javascript hljs">VoxEngine.forwardCallToUser();</code> </pre> <br>  ‚ÄúAnd this is all?‚Äù - you ask :) Yes, this is all, since <a href="https://voximplant.com/docs/references/voxengine/voxengine">forwardCallToUser</a> is one of the helper-functions that we wrote to speed up and facilitate the creation of applications.  In fact, behind this function is a piece of Javascript code, a la: 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <pre> <code class="javascript hljs">VoxEngine.addEventListener(AppEvents.CallAlerting, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">e</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> newCall = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.callUser(e.destination, e.callerid, e.displayName); VoxEngine.easyProcess(e.call, newCall); });</code> </pre><br>  Where easyProcess is another one of the helper-functions, in more detail all the functions can be found <a href="http://voximplant.com/docs/references/appengine/">in the documentation for VoxEngine</a> , since we do not have the task to study VoxImplant thoroughly now, we will continue without going into the details.  The following script (PBX out) is responsible for sending outgoing calls to regular phone numbers: <br><br><pre> <code class="javascript hljs">VoxEngine.addEventListener(AppEvents.CallAlerting, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">e</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> call2 = VoxEngine.callPSTN(e.destination.substring(<span class="hljs-number"><span class="hljs-number">1</span></span>), <span class="hljs-string"><span class="hljs-string">"74957893798"</span></span>); VoxEngine.easyProcess(e.call, call2); });</code> </pre><br>  In this code, we use the <a href="https://voximplant.com/docs/references/voxengine/voxengine">callPSTN</a> function to redirect the call to the telephone network with Caller ID - 74957893798, which must be preauthorized in the Settings -&gt; Caller IDs section, so that the caller ID when calling shows that we are calling.  For the first parameter, it simply discards the prefix from 1 digit (later we will adjust this digit during the binding of scripts to the application), which signals that the call should be skipped in the PSTN, that is, the number is entered in the form 974952200022 after 94952200022 remain - the usual Moscow number.  Here, too, everything is quite simple, now let's move on to the most interesting scenario - handling incoming calls (PBX in), I will add the ‚Äúmeat‚Äù in parts to make it clearer: <br><br><pre> <code class="javascript hljs"><span class="hljs-comment"><span class="hljs-comment">//    var callerid, displayName; //          AppEvents.CallAlerting VoxEngine.addEventListener(AppEvents.CallAlerting, function(e) { //  Caller ID callerid = e.callerid; //  displayName -   SIP displayName = e.displayName; //     (     ) e.call.handleTones(true); //       ,        e.call.answer(); });</span></span></code> </pre><br>  We have allowed the connection to the platform, now we need to handle the call, inside the previous listener we add handling of the call connection event: <br><br><pre> <code class="javascript hljs"><span class="hljs-comment"><span class="hljs-comment">//     ,         var GMT_offset = 4, workingHours = [ [0, 0], // Sun [10, 19], // Mon [10, 19], // Tue [10, 19], // Wed [10, 19], // Thu [10, 19], // Fri [0, 0] // Sat ], nonWorkingHours = false, workingHoursGreetingURL = 'http://yourdomain.com/ivr.mp3', //&lt;===    URL  MP3-  ( ) nonWorkingHoursGreetingURL = 'http://yourdomain.com/ivr_nwh.mp3'; //&lt;===    URL  MP3-  ( ) e.call.addEventListener(CallEvents.Connected, function(e) { // . /   ,   GMT_offset (GMT+4  ) var d = new Date(new Date().getTime() + GMT_offset * 3600 * 1000), day = d.getUTCDay(), hour = d.getUTCHours(); Logger.write("Day: " + day + " Hour: " + hour); if (hour &gt;= workingHours[day][0] &amp;&amp; hour &lt; workingHours[day][1]) { /** *     *    */ e.call.startPlayback(workingHoursGreetingURL, false); e.call.record(); } else { /** *     *    */ nonWorkingHours = true; e.call.startPlayback(nonWorkingHoursGreetingURL, false); } });</span></span></code> </pre><br>  Handler on the call connection hung, now you need to hang the handler on the disconnect: <br><br><pre> <code class="javascript hljs">e.call.addEventListener(CallEvents.Disconnected, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">e</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-comment"><span class="hljs-comment">//   VoxEngine.terminate(); });</span></span></code> </pre><br>  And the handler completes playing our greeting: <br><br><pre> <code class="javascript hljs"><span class="hljs-comment"><span class="hljs-comment">//          var TIMEOUT = 3000, operatorTimer; e.call.addEventListener(CallEvents.PlaybackFinished, function(e) { //      ,   -    ,      if (!nonWorkingHours) { operatorTimer = setTimeout(function() { forwardCallToOperator(e.call); }, TIMEOUT); } else VoxEngine.terminate(); //      -    });</span></span></code> </pre><br>  You, probably, noticed the forwardCallToOperator function, we will return to it right away as we enable the handling of button presses on the phone to enter the extension number.  Earlier we already included the handler by calling e.call.handleTones (true), now we need to declare it: <br><br><pre> <code class="javascript hljs"><span class="hljs-comment"><span class="hljs-comment">//      var input = ''; e.call.addEventListener(CallEvents.ToneReceived, function(e) { //        e.call.stopPlayback(); //    input += e.tone; if (input.length == 3) { //        3        forwardCallToExtension(e.call, input); } });</span></span></code> </pre><br>  Well, now it's time for the most interesting functions - forwardCallToExtension and forwardCallToOperator: <br><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> operators = [<span class="hljs-string"><span class="hljs-string">'101'</span></span>, <span class="hljs-string"><span class="hljs-string">'102'</span></span>, <span class="hljs-string"><span class="hljs-string">'103'</span></span>], <span class="hljs-comment"><span class="hljs-comment">// &lt;==    ,    -    operatorCalls = {}, nOperatorCalls = 0, activeOperatorCall; function forwardCallToExtension(call, ext) { clearTimeout(operatorTimer); //       call.handleTones(false); //   (     ) call.playProgressTone("RU"); //  ,     var call2 = VoxEngine.callUser(ext, callerid, displayName); //   call2.addEventListener(CallEvents.Failed, VoxEngine.terminate); call2.addEventListener(CallEvents.Connected, function(e) { //   -      VoxEngine.sendMediaBetween(call, call2); }); call2.addEventListener(CallEvents.Disconnected, VoxEngine.terminate); } function forwardCallToOperator(call) { //       call.handleTones(false); nOperatorCalls = 0; //   (     ) call.playProgressTone("RU"); //      ,    ,  . for (var i in operators) { var j = operators[i]; nOperatorCalls++; operatorCalls[j] = VoxEngine.callUser(j, callerid, displayName); operatorCalls[j].addEventListener(CallEvents.Failed, function(e) { if (typeof activeOperatorCall == "undefined") { delete operatorCalls[e.call.number()]; nOperatorCalls--; if (nOperatorCalls == 0) { call.hangup(); } } }); operatorCalls[j].addEventListener(CallEvents.Connected, function(e) { delete operatorCalls[e.call.number()]; activeOperatorCall = e.call; VoxEngine.sendMediaBetween(call, e.call); activeOperatorCall.addEventListener(CallEvents.Disconnected, VoxEngine.terminate); for (var i in operatorCalls) { operatorCalls[i].hangup(); } operatorCalls = {}; }); } }</span></span></code> </pre><br>  Everything is ready, we combine our parts and get a <a href="">complete script</a> .  The case remains for the small - to create a VoxImplant application and connect users and our scripts to it.  This is done in the following simple way: <br>  1. In the Applications section, we create an application, name it and specify users who can use it. <br><div style="text-align:center;"><img src="https://habrastorage.org/webt/l2/pu/js/l2pujsezbnwezksbfcvtcrfqrki.jpeg"></div><br>  2. After creating the application, select editing immediately. <br>  3. In the Rules tab, use the Add Rule button to create 3 new rules: local, out, in <br>  When creating a local rule, given that you specified the names of users as 101, 102, 103, etc.  in the Pattern field, specify 1 [0-9] {2} and, using drag'n'drop, drag the PBX local script from Available to Assigned, in order to assign which script should be called if users connected to our PBX decide to call their internal number Colleagues.  We save. <br><div style="text-align:center;"><img src="https://habrastorage.org/webt/8j/3k/qq/8j3kqqfsso4gwgaavby9vxuunsc.jpeg"></div>  Similarly, for the out rule, specify 9 [0-9] + in the Pattern field (remember the same 9 that we saw off with e.destination.substring (1) in the callPSTN method) and drag and drop the PBX out script to Assigned.  We save. <br>  And the last rule in: in the Pattern, we indicate something in the spirit (74957893798 | 100) and drag the PBX in in the direction of Assigned.  We save.  74957893798 is just an example, there should be a phone number here that you can connect to your application in the Phone numbers section.  And 100 allows you to call our PBX via SIP using a URL of the form sip: 100@appname.accountname.voximplant.com, where appname is the name of your application you specified during its creation, and accountname is the name of the account VoxImplant you specified During registration.  If you already have a purchased number that supports forwarding via SIP, then you can connect it to the PBX, for example, by sending calls to that SIP URI (sip: 100@appname.accountname.voximplant.com), which we made for incoming calls SIP. <br><div style="text-align:center;"><img src="https://habrastorage.org/webt/w-/_h/re/w-_hrewjxwbaww6ygwssr4rxany.jpeg"></div><br>  4. Save the application. <br><br>  Now our PBX is ready to connect SIP phones (or client applications based on VoxImplant SDK), receive and process calls, local calls between PBX users and outgoing calls to real numbers. <br><br>  PS Ready scripts from the article are posted on GitHub <a href="https://github.com/voximplant/pbx">https://github.com/voximplant/pbx</a> .  The ready-made web phone based on the VoxImplant Web SDK can be found at <a href="http://webphone.voximplant.com/%3Faccount%3Daccountname%26app%3Dappname">http://webphone.voximplant.com/?account=accountname&amp;app=appname</a> , remember to replace the accountname and appname with your own names.  Well, X-lite / Bria has not been canceled, if you need a more or less sane SIP softphone. </div><p>Source: <a href="https://habr.com/ru/post/212713/">https://habr.com/ru/post/212713/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../212689/index.html">Some interesting and useful things for web developer # 11</a></li>
<li><a href="../212701/index.html">NanoMMO on Go and Canvas [Server]</a></li>
<li><a href="../212705/index.html">Broadway - rendering GTK3 interface in a browser (HTML5)</a></li>
<li><a href="../212707/index.html">Questions and Tasks for the Russian-language book Thinking in Java (Java Philosophy) by Bruce Ekkel</a></li>
<li><a href="../212709/index.html">LocalForage: Mozilla Cross-browser Local Storage</a></li>
<li><a href="../212719/index.html">As I wrote and released a book on developing games for iOS</a></li>
<li><a href="../212721/index.html">Boids - a simple algorithm for moving groups of units</a></li>
<li><a href="../212723/index.html">To health! Expanding opportunities</a></li>
<li><a href="../212733/index.html">Open-source projects that we tested with PVS-Studio</a></li>
<li><a href="../212735/index.html">Interesting and informative: the upper stage ‚ÄúBreeze-M‚Äù</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>