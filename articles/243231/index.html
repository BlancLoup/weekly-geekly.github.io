<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>VexorCI under the hood</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hi, Habr! The time of the long-awaited post about the internal structure of Vexor - cloud-based continuous integration for developers, allowing to eff...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>VexorCI under the hood</h1><div class="post__text post__text-html js-mediator-article">  Hi, Habr!  The time of the long-awaited post about the internal structure of <a href="https://vexor.io/">Vexor</a> - cloud-based continuous integration for developers, allowing to effectively test projects and pay only for the resources that are actually used. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/49f/18a/d72/49f18ad726ba3a91004e184c562556f6.png" alt="image"><br><a name="habracut"></a><br>  <b>Story</b> <br><br>  The project emerged from the internal developments of the company <a href="http://evrone.ru/">Evrone</a> .  Initially, we used Jenkins to run the tests.  But when it became obvious that the CI service needed to be refined for our specific tasks, we changed it to GitlabCI.  There were several reasons for this: <br><ul><li>  GitlabCI is written in Ruby, which is the command's native language. </li><li>  it is small and simple, which means it is easy to refine. </li></ul><br>  During use, as is often the case, GitlabCI is quite mutated.  And at that moment, when he already had little to do with the original, we just rewrote everything from scratch.  This is how the first version of Vexor appeared, which was used only within the team. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      At Evrone, several projects are being developed in parallel.  Some of them are very large, and you need to run a lot of tests with each commit.  So, under the workers constantly need to keep a lot of servers ready.  And accordingly, pay for them in full. <br><br>  But if you think about it, you understand: <br><ul><li>  At night and on weekends, workers for tests are not needed at all. </li><li>  If the team is large and the process is designed in such a way that many commits are being done at the same time, then parallel workers are needed very, very much.  For example, if weekly iterations are used, then usually at the end of the iteration several features are released and at the same time 5-20 pull-requests are made, each of which is accompanied by a test run.  There is a situation in which you need, for example, 20+ workers. </li></ul><br>  Obviously, workers need to be lifted and removed automatically, focusing on current requests. <br><br>  The first version of autoscaling was written in a couple of hours based on Amazon EC2.  The implementation was very naive, but even with it, we immediately dropped the checks for the use of servers.  CI began to work much more stable, because we excluded the situation when a sudden influx of tests led to a shortage of workers.  Then the integration with the cloud was redone several times. <br><br>  Now in a cloud the pool of servers keeps.  This is managed by a separate application to which the workers are connected.  The application monitors their status: live / fell / failed to start / no work.  The application automatically changes the size of this pool, depending on the current state of the workers, the size of the task queue and the approximate estimate of the time spent on their execution. <br><br>  Initially, we used Amazon EC2 as a cloud.  But on Amazon, the disks that connect to the servers are not physically located on the host, but in a separate storage that is connected over the network.  When disks are used extensively (and the test run speed is very dependent on the speed of the disks), the speed will rest on the bandwidth of the channel to the storage and the allocated bandwidth.  Amazon solves this problem only for some money, which did not want to be paid at all.  Considered other options: Rackspace, DigitalOcean, Azure and GCE.  Comparing them, we stopped at Rackcspace. <br><br>  <b>Architecture</b> <br><br>  Now a little about architecture. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/2cc/35e/64e/2cc35e64ebac19185e97b01fccfa750f.png" alt="image"><br><br>  <a href="https://vexor.io/"><b>VexorCI</b></a> is not a monolithic application, but a set of related applications.  For communication between them is used mainly RabbitMQ.  What in our case is good rabbit: <br><br><ul><li>  He is able to message acknowledgment and publisher confirm.  This allows you to solve a lot of problems, in particular, allows you to write applications in the popular ‚ÄúLet it crash‚Äù style in Erlang.  That is, if any problems occur, a crash occurs, but as soon as the service returns to normal operation, all tasks will be completed and none of them will be lost. </li><li>  RabbitMQ is a broker with the ability to build spreading topologies of queues and exchange points, as well as to set up routing between them.  This makes it possible, for example, to easily test new versions of services in the production environment on current production tasks. </li><li>  RabbitMQ works steadily with large messages.  The record for today is 120Mb in one message.  VexorCI does not have the task to process millions of messages per minute, but the message itself can weigh tens of Mb or more (for example, when transferring logs). </li></ul><br>  RabbitMQ has some known flaws, which also have to deal with: <br><br><ul><li>  It requires a perfectly functioning network between the client and the server.  Ideally, the server should be on the same physical host as the clients.  Otherwise, rabbit customers will behave like canaries on a submarine: to fall if there are any problems that no other service sees. </li><li>  C RabbitMQ is difficult to ensure high availability.  There are three solutions for this, but only federation and shovel provide real high availability.  Which, unlike cluster (about which you can read <a href="http://aphyr.com/posts/315-call-me-maybe-rabbitmq">here</a> ), is not so easy to integrate into the existing architecture of the application, since they do not provide data consistency. </li></ul><br>  Since our servers are physically located in several data centers, and the pool with workers, in case of any problems with Rackspace, can switch to another data center, we use <a href="https://www.rabbitmq.com/federation.html">federation</a> to ensure stable operation of RabbitMQ. <br><br>  <b>Logs</b> <br><br>  SOA-architecture entails another difficulty: collecting logs becomes a non-trivial task.  When you have only a couple of applications, you can not think about it: the logs are on a few hosts, which you can always log in and get what you need.  But when there are many applications, and one event is handled by several services, a single service is needed on which the logs will be stored. <br><br>  In Vexor, the elasticsearch + logstash + logstash-forwarder bundle is responsible for this.  All logs of our applications are written at once in JSON format, all events from applications are logged, and also PG, RabbitMQ, Docker and other system messages (dmesg, mail and others) are logged in addition.  We try to write everything to the maximum, because the workers only work for a certain time.  After shutting down the server with the worker, we will not learn anything about the problem, except for what is stored in the logs. <br><br>  <b>Container</b> <br><br>  To run tests with workers, we use Docker.  This is an excellent solution for working with insulated containers, which provides all the necessary tools.  Now Docker is very stable and delivers minimal problems (especially if you have a fresh OS kernel).  Although bugs are also found, for example, <a href="https://github.com/docker/docker/issues/4036">like this</a> . <br><br>  Tests in Vexor are run in a container based on Ubuntu 14.04, in which popular services and libraries necessary for work are preinstalled.  Full list of packages and their versions can be found <a href="https://vexor.io/packages.txt">here</a> .  We periodically update the image, so the set of pre-installed software is always fresh. <br><br>  In order to use one image for all supported languages ‚Äã‚Äãand not to make the image size too large, the necessary language versions (Ruby, Python, Node.js, Go - we have a complete and up-to-date list of supported languages <a href="https://vexor.io/help">here</a> ) from the packages when launching builds.  This rather quick procedure takes a few seconds, and this solution allows us to easily support a large set of language versions without overloading the image. <br><br>  We rebuild the deb packages for the image at least once a week.  They are always available in the public repository at ‚Äúhttps://mirror.pkg.vexor.io/trusty main‚Äù.  If, for example, you use Ubuntu 14.04 amd64, then when you connect it you can immediately get 12 versions of Ruby, already compiled with the latest versions of the bundler and gem, fully ready for installation. <br><br>  In order not to do apt-get update when installing packages at runtime and use fuzzy matching for versions, we wrote a <a href="https://github.com/vexor/vx-packages/blob/master/vxvm">utility</a> with which you can very quickly install packages of the necessary versions from our repository, for example: <br><br>  $ time vxvm install go 1.3 <br>  Installed to /opt/vexor/packages/go-1.3 <br>  ... <br>  real 0m3.765s <br><br>  <b>Configuration</b> <br><br>  Ideally, Vexor himself understands what he needs to run to run your project.  We are working to automatically recognize which technologies you need and run them.  But this is not always possible.  Therefore, for unrecognized cases, we ask users to make a configuration file for the project. <br><br>  In order not to reinvent the wheel, we use the configuration file .travis.yml.  Travis CI is one of the most popular and well-known services today, which means it‚Äôs good if users experience the least amount of difficulty when switching from it.  After all, if in the root directory of the project there is already .travis.yml, then everything will start instantly.  Well, the team will get the joys of fast CI for our modest per-minute rates :) <br><br>  <b>Servers</b> <br><br>  We administer many servers on which many tasks are performed.  Therefore, we actively use various tools, such as Ansible, Packer and Vagrant.  Ansible is responsible for the allocation and configuration of servers and perfectly performs its tasks.  Packer and Vagrant are used to build and test Docker images and servers with workers.  VexorCI itself is used to automate image assembly, which automatically reassembles everything you need. <br><br>  <b>Who is our project for?</b> <br><br>  Small projects that run tests are not so much and often, but at the same time do not want to pay a lot and think about system administration and deployment, enjoying the pleasures of continous integration. <br><br>  For large projects where there are a lot of tests, we give an unlimited amount of resources, we are able to parallelize tests and speed up their run at times. <br><br>  For projects with a large team, we solve the problem with "queues for the miscalculation of tests."  Now, any number of tests can be run at the same time, eliminating long waits. <br><br>  Friends, in conclusion, we want to invite everyone to our <a href="https://vexor.io/">Vexor</a> .  Connect your projects and enjoy the benefits. </div><p>Source: <a href="https://habr.com/ru/post/243231/">https://habr.com/ru/post/243231/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../243219/index.html">RFM analysis on the knee (Excel)</a></li>
<li><a href="../243221/index.html">Meeting of mobile game developers, November 27, Moscow</a></li>
<li><a href="../243225/index.html">What is silent technical task?</a></li>
<li><a href="../243227/index.html">Setting up automatic restart of Windows services in Nagios XI</a></li>
<li><a href="../243229/index.html">Analyze friendships VK using Python. Continuation</a></li>
<li><a href="../243233/index.html">Calling a non-predefined method in a category after overriding it</a></li>
<li><a href="../243235/index.html">Fight for the buyer or how to buy loyalty?</a></li>
<li><a href="../243237/index.html">Localization of the button "Build"</a></li>
<li><a href="../243241/index.html">From the life of the usability lab Mail.Ru Group</a></li>
<li><a href="../243243/index.html">What to read at your leisure: the gaming industry news digest for October</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>