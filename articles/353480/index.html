<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Dangerous pickles - malicious serialization in Python</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hello! 

 Panta rhei and now the launch of the updated ‚ÄúPython Web Developer‚Äù course is approaching , and we still have some material that we found ve...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Dangerous pickles - malicious serialization in Python</h1><div class="post__text post__text-html js-mediator-article">  Hello! <br><br>  Panta rhei and now the launch of the updated <a href="https://otus.pw/kYot/">‚ÄúPython Web Developer‚Äù</a> course is approaching <a href="https://otus.pw/kYot/">,</a> and we still have some material that we found very interesting and we want to share with you. <br><br>  What are dangerous pickles? <br><blockquote>  These pickles are extremely dangerous.  I do not even know how to explain how.  Just trust me.  This is important, you understand? </blockquote>  <i>‚ÄúExplosive Disorder‚Äù Pan Telare</i> 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Before plunging into the opcode, let's talk about the basics.  In the standard Python library, there is a module called <a href="https://docs.python.org/3/library/pickle.html">pickle</a> (in translation ‚Äúsalty cucumber‚Äù or simply ‚Äúconservation‚Äù), which is used to <a href="https://ru.wikipedia.org/wiki/%25D0%25A1%25D0%25B5%25D1%2580%25D0%25B8%25D0%25B0%25D0%25BB%25D0%25B8%25D0%25B7%25D0%25B0%25D1%2586%25D0%25B8%25D1%258F">serialize and deserialize</a> objects.  Only it is called not serialization / deserialization, but pickling / unpickling (literally - ‚Äúconservation / re-activation‚Äù). <br><br><img src="https://habrastorage.org/webt/ii/gc/_a/iigc_agx3ccqks5luqippjv0nv8.jpeg"><br><a name="habracut"></a><br>  As a person who is still tormented by nightmares after using <a href="https://ru.wikipedia.org/wiki/%25D0%25A1%25D0%25B5%25D1%2580%25D0%25B8%25D0%25B0%25D0%25BB%25D0%25B8%25D0%25B7%25D0%25B0%25D1%2586%25D0%25B8%25D1%258F">Boost Serialization</a> in C ++, I can say that the conservation is excellent.  Whatever you throw at her, she continues to Just Work.  And not only with builtin types - in most cases, you can serialize your classes without needing to write serialization <i>preservation</i> methods.  Even with objects such as recursive data structures (which would cause a crash when using a similar marshal module), there are no problems. <br><br>  Let's give a quick example for those who are not familiar with the pickle module: <br><br><pre><code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> pickle <span class="hljs-comment"><span class="hljs-comment">#      Python original = { 'a': 0, 'b': [1, 2, 3] } #     pickled = pickle.dumps(original) #      identical = pickle.loads(pickled)</span></span></code> </pre> <br>  This is enough in most cases.  Preservation is really cool ... but somewhere in the depths of the darkness is hidden. <br><br>  In one of the first lines of the pickle module it is written: <br>  <i>Warning: The pickle module is not protected from erroneous and malicious data.</i>  <i>Never re-save data from an unreliable and unauthorized source.</i> <br><br>  I read this warning many times and often wondered what malicious data might be like.  And recently, I decided it was time to find out.  And for good reason. <br>  My quest to create malicious data helped me learn a lot about the work of the pickle protocol, discover cool debugging methods for preservation, and find a couple of daring comments in the Python source code.  If you continue reading, you will get the same benefits (and soon you will also start sending people your malicious conservation files).  Warning: there will be technical details, the only prerequisite is basic knowledge of Python.  But superficial knowledge of the assembler does not hurt. <br><br>  <b>Unreal Pickle Bomb</b> <br><br>  I started by reading the pickle module documentation, hoping to find clues on how to become an elite hacker, and came across a line: <br>  <i>The pickletools module contains tools for analyzing data streams generated by conservation.</i>  <i>The pickletools source code contains extensive comments about opcodes used by pickle protocols.</i> <br><br>  Opcodes?  I did not at all expect that the pickle implementation would be like this: <br><br><pre> <code class="python hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">dumps</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(obj)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> obj.__repr__() <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">loads</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(pickled)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-comment"><span class="hljs-comment"># :  pickle  ... return eval(pickled)</span></span></code> </pre><br>  But I also did not expect her to define her own low-level language.  Fortunately, the second part of the line is telling the truth - <a href="https://docs.python.org/3/library/pickletools.html">pickletools</a> modules are very helpful in understanding how the protocols work.  Plus, the comments in the code were very funny. <br><br>  For example, we will ask the question about which version of the protocol we need to focus on.  In Python 3.6, there are a total of five.  They are numbered from 0 to 4. Protocol 0 is an obvious choice, because it is called ‚Äú <a href="https://docs.python.org/3/library/pickle.html">readable</a> ‚Äù in the documentation, and the source code <a href="https://github.com/python/cpython/blob/3.6/Lib/pickletools.py">pickletools</a> offers additional information: <br><br>  <i>The pickle opcodes never disappear, even when new ways to do something appear.</i>  <i>The PM repertoire only grows with time ... ‚ÄúThe bloating of the opcode‚Äù is not a subtle hint, but a source of debilitating difficulties.</i> <br><br>  It turns out that each new protocol is a superset of the previous one.  Even if we do not take into account that protocol 0 is ‚Äúreadable‚Äù (it does not matter, because we are decompiling the instructions), it also contains the smallest possible number of opcodes.  What is perfect if the goal is to understand how malicious pickle files are created. <br><br>  If you're confused with opcodes, don't worry.  We will now return to Python, and then I will explain in detail how opcodes relate to Python code.  Create a simple Python class without opcodes. <br><br><pre> <code class="python hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Bomb</span></span></span><span class="hljs-class">:</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">__init__</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self, name)</span></span></span><span class="hljs-function">:</span></span> self.name = name <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">__getstate__</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> self.name <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">__setstate__</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self, state)</span></span></span><span class="hljs-function">:</span></span> self.name = state print(<span class="hljs-string"><span class="hljs-string">f'Bang! From, </span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">{self.name}</span></span></span><span class="hljs-string">.'</span></span>) bomb = Bomb(<span class="hljs-string"><span class="hljs-string">'Evan'</span></span>)</code> </pre> <br>  The __setstate __ () and __getstate __ () methods are used in the pickle module to serialize and deserialize classes.  Often you do not need to define them yourself, because the default implementations simply serialize the __dict__ instance.  As you can see, I directly identified them here to hide a small surprise at the moment of the de-serialization of the Bomb object. <br><br>  Check if the deserialization code works with a surprise.  We will conserve and reactivate the object using: <br><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> pickle pickled_bomb = pickle.dumps(bomb, protocol=<span class="hljs-number"><span class="hljs-number">0</span></span>) unpickled_bomb = pickle.loads(pickled_bomb)</code> </pre><br>  We get: <br><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># -!  . Bang! From, Evan.</span></span></code> </pre> <br>  Exactly according to the plan!  There is only one problem: if we try to deserialize the string pickled_bomp in a context where Bomb is undefined, it will fail.  Instead, an error will appear: <br><br><pre> <code class="bash hljs">AttributeError: Can<span class="hljs-string"><span class="hljs-string">'t get attribute '</span></span>Bomb<span class="hljs-string"><span class="hljs-string">' on &lt;module '</span></span>__main__<span class="hljs-string"><span class="hljs-string">'&gt;</span></span></code> </pre> <br>  It turns out that we can run our custom <code>__setstate__()</code> method only if the <code>__setstate__()</code> context already has access to the code with our malicious print expression.  And if we already have access to the code launched by the victim, why bother with the pickle at all?  We can simply write the malicious code in any other method that the victim uses.  And this is true - I just wanted to demonstrate clearly. <br><br>  In the end, it is not in vain to suspect that Pyton can support conservation bytecode for an object deserialization method.  For example, the marshal module can serialize methods, and many pickle alternatives: <a href="https://marshmallow.readthedocs.io/en/latest/">marshmallow</a> , <a href="https://github.com/uqfoundation/dill">dill</a> , and <a href="http://pythonhosted.org/Pyro4/">pyro</a> also support the serialization function. <br><br>  However, the ominous warning in the pickle documentation is not the point.  You need to dive a little deeper to find out the dangers of deserialization. <br><br>  <b>Decompile Pickle</b> <br><br>  It is time to try to understand how conservation really works.  Let's start by looking at the object from the previous section - pickled_bomb. <br><br><pre> <code class="bash hljs">b<span class="hljs-string"><span class="hljs-string">'ccopy_reg\n_reconstructor\np0\n(c__main__\nBomb\np1\nc__builtin__\nobject\np2\nNtp3\nRp4\nVEvan\np5\nb.'</span></span></code> </pre> <br>  Wait ... we used protocol 0?  Is it ‚Äúreadable‚Äù? <br><br>  But that's okay, we have to find <i>‚Äúextensive comments about opcodes used by pickle protocols‚Äù</i> in the pickletools source code.  They should help us understand the problem! <br><blockquote>  I desperately document this in detail - read the pickle code completely to find all special cases. </blockquote>  - a comment in the source code of pickletools <br><br>  God  What we fit in? <br><br>  Jokes aside, the source code for pickle tools is really well commented.  And the tools themselves are no less useful.  For example, there is a pickle disassembly method called pickletools.dis ().  He will help translate our pickle into a more understandable language. <br><br>  To disassemble our pickled_bomb line, simply run the following: <br><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> pickletools pickletools.dis(pickled_bomb)</code> </pre> <br><pre> <code class="python hljs">  : <span class="hljs-number"><span class="hljs-number">0</span></span>: c GLOBAL <span class="hljs-string"><span class="hljs-string">'copy_reg _reconstructor'</span></span> <span class="hljs-number"><span class="hljs-number">25</span></span>: p PUT <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">28</span></span>: ( MARK <span class="hljs-number"><span class="hljs-number">29</span></span>: c GLOBAL <span class="hljs-string"><span class="hljs-string">'__main__ Bomb'</span></span> <span class="hljs-number"><span class="hljs-number">44</span></span>: p PUT <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-number"><span class="hljs-number">47</span></span>: c GLOBAL <span class="hljs-string"><span class="hljs-string">'__builtin__ object'</span></span> <span class="hljs-number"><span class="hljs-number">67</span></span>: p PUT <span class="hljs-number"><span class="hljs-number">2</span></span> <span class="hljs-number"><span class="hljs-number">70</span></span>: N NONE <span class="hljs-number"><span class="hljs-number">71</span></span>: t TUPLE (MARK at <span class="hljs-number"><span class="hljs-number">28</span></span>) <span class="hljs-number"><span class="hljs-number">72</span></span>: p PUT <span class="hljs-number"><span class="hljs-number">3</span></span> <span class="hljs-number"><span class="hljs-number">75</span></span>: R REDUCE <span class="hljs-number"><span class="hljs-number">76</span></span>: p PUT <span class="hljs-number"><span class="hljs-number">4</span></span> <span class="hljs-number"><span class="hljs-number">79</span></span>: V UNICODE <span class="hljs-string"><span class="hljs-string">'Evan'</span></span> <span class="hljs-number"><span class="hljs-number">85</span></span>: p PUT <span class="hljs-number"><span class="hljs-number">5</span></span> <span class="hljs-number"><span class="hljs-number">88</span></span>: b BUILD <span class="hljs-number"><span class="hljs-number">89</span></span>: . STOP highest protocol among opcodes = <span class="hljs-number"><span class="hljs-number">0</span></span></code> </pre> <br>  If you dealt with languages ‚Äã‚Äãlike <a href="https://en.wikipedia.org/wiki/X86_instruction_listings">x86</a> , <a href="http://pallergabor.uw.hu/androidblog/dalvik_opcodes.html">Dalvik</a> , <a href="https://en.wikipedia.org/wiki/List_of_CIL_instructions">CLR</a> , then all of the above may seem familiar.  But even if they didn‚Äôt have it, it doesn‚Äôt matter, we‚Äôll sort it out in steps.  Now it‚Äôs enough to know that capital words like GLOBAL, PUT, and MARK are opcodes, and instructions that are interpreted almost as functions in high-level languages.  All to the right are the arguments of these functions, and to the left is shown how they were encrypted in the original ‚Äúreadable‚Äù line. <br><br>  But before starting the step-by-step parsing, let's imagine another useful thing from pickletools: pickletools.optimize ().  This method removes unused opcodes from pickle.  The output is a simplified, but similar pickle.  We can parse an optimized version of pickled_bomb by running the following: <br><br><pre> <code class="bash hljs">pickled_bomb = pickletools.optimize(pickled_bomb) pickletools.dis(pickled_bomb)</code> </pre> <br>  And we get a simplified version of a series of instructions: <br><br><pre> <code class="python hljs"> <span class="hljs-number"><span class="hljs-number">0</span></span>: c GLOBAL <span class="hljs-string"><span class="hljs-string">'copy_reg _reconstructor'</span></span> <span class="hljs-number"><span class="hljs-number">25</span></span>: ( MARK <span class="hljs-number"><span class="hljs-number">26</span></span>: c GLOBAL <span class="hljs-string"><span class="hljs-string">'__main__ Bomb'</span></span> <span class="hljs-number"><span class="hljs-number">41</span></span>: c GLOBAL <span class="hljs-string"><span class="hljs-string">'__builtin__ object'</span></span> <span class="hljs-number"><span class="hljs-number">61</span></span>: N NONE <span class="hljs-number"><span class="hljs-number">62</span></span>: t TUPLE (MARK at <span class="hljs-number"><span class="hljs-number">25</span></span>) <span class="hljs-number"><span class="hljs-number">63</span></span>: R REDUCE <span class="hljs-number"><span class="hljs-number">64</span></span>: V UNICODE <span class="hljs-string"><span class="hljs-string">'Evan'</span></span> <span class="hljs-number"><span class="hljs-number">70</span></span>: b BUILD <span class="hljs-number"><span class="hljs-number">71</span></span>: . STOP highest protocol among opcodes = <span class="hljs-number"><span class="hljs-number">0</span></span></code> </pre><br>  You may notice that this differs from the original only in the absence of all PUT opcodes.  Which leaves us with 10 instructional steps to understand.  Soon, we will examine them separately and manually ‚Äúsort‚Äù the code in Python. <br><br>  During re-opening, opcodes are usually interpreted by an entity called Pickle Machine (PM).  Each pickle is a program running on PM, just like compiled Java code runs on a <a href="https://en.wikipedia.org/wiki/Java_virtual_machine">Java Virtual Machine (JVM)</a> .  To parse our pickle code, you need to understand how PM works. <br><br>  There are two areas in PM for storing and interacting with data: memo and stack.  Memo is designed for long-term storage, and is similar to the Python dictionary that maps integers and objects.  Stack is like a Python list, with which many operations interact, adding and pulling things out.  We can emulate these Python data areas as follows: <br><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#  / PM memo = {} # Stack PM,       stack = []</span></span></code> </pre> <br>  During re-activation, PM reads the pickle program and executes each instruction sequentially.  It ends whenever it reaches the STOP opcode;  any object at the top of the stack is the final result of the re-activation.  Using our emulated memo and stack repositories, try translating our pickle to Python ... instruction by instruction. <br><br><ul><li>  <a href="https://github.com/python/cpython/blob/3.6/Lib/pickletools.py">GLOBAL</a> pushes the class and function to the stack, passing the module and name as arguments.  Note that the message is a bit misleading, because in Python 3, copy_reg was renamed copyreg. </li></ul><br><br><ul><li>  <a href="https://github.com/python/cpython/blob/3.6/Lib/pickletools.py">MARK</a> pushes a special markobject into the stack so that we can later use it to refine part of the stack.  We will use the ‚ÄúMARK‚Äù string to represent the markobject. <br><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#  markobject  . # 25: ( MARK stack.append('MARK')</span></span></code> </pre><br></li></ul><br><ul><li>  <a href="https://github.com/python/cpython/blob/3.6/Lib/pickletools.py">GLOBAL</a> again.  But this time with the __main__ module, so we do not need to import. <br><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#    (module.attr)  . # 26: c GLOBAL '__main__ Bomb' stack.append(Bomb)</span></span></code> </pre> </li></ul><ul><li>  <a href="https://github.com/python/cpython/blob/3.6/Lib/pickletools.py">GLOBAL</a> again.  And we do not need to explicitly import an object. <br><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#    (module.attr)  . # 41: c GLOBAL '__builtin__ object' stack.append(object)</span></span></code> </pre> <br></li></ul><br><ul><li>  <a href="https://github.com/python/cpython/blob/3.6/Lib/pickletools.py">NONE</a> just pushes None to stack. <br><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#  None  . # 61: N NONE stack.append(None)</span></span></code> </pre> <br></li></ul><br><ul><li>  <a href="https://github.com/python/cpython/blob/3.6/Lib/pickletools.py">TUPLE is a</a> little trickier.  Remember how we used to add ‚ÄúMARK‚Äù to the stack?  This operation will move everything from the stack after ‚ÄúMARK‚Äù to the tuple.  After that, it will remove the ‚ÄúMARK‚Äù and replace it with a tuple. <br><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#      ,  markobject. # 62: t TUPLE (MARK at 28) last_mark_index = len(stack) - 1 - stack[::-1].index('MARK') mark_tuple = tuple(stack[last_mark_index + 1:]) stack = stack[:last_mark_index] + [mark_tuple]   ,     . #    TUPLE: [&lt;function copyreg._reconstructor&gt;, 'MARK', __main__.Bomb, object, None] #    TUPLE: [&lt;function copyreg._reconstructor&gt;, (__main__.Bomb, object, None)]</span></span></code> </pre> <br></li></ul><br><ul><li>  <a href="https://github.com/python/cpython/blob/3.6/Lib/pickletools.py">REDUCE</a> removes the last two things from the stack.  After that, it calls the penultimate object using the positional extension of the last thing, and the result is placed on the stack.  It's hard to explain with words, but everything is clear in the code <br><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#  ,   callable  tuple . # 63: R REDUCE args = stack.pop() callable = stack.pop() stack.append(callable(*args))</span></span></code> </pre> <br></li></ul><br><ul><li>  <a href="https://github.com/python/cpython/blob/3.6/Lib/pickletools.py">UNICODE</a> just pushes the Unicode string to the stack (a very nice Unicode string, by the way!) <br><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#    Python Unicode. # 64: V UNICODE 'Evan' stack.append(u'Evan')</span></span></code> </pre> <br></li></ul><br><ul><li>  <a href="https://github.com/python/cpython/blob/3.6/Lib/pickletools.py">BUILD</a> removes the last object from the stack and then passes it as an argument to __setstate __ () with the new last thing in the stack. <br><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#      __setstate__  dict. # 70: b BUILD arg = stack.pop() stack[-1].__setstate__(arg)</span></span></code> </pre> <br></li></ul><br><ul><li>  <a href="https://github.com/python/cpython/blob/3.6/Lib/pickletools.py">STOP</a> simply means that any item at the top of the stack is our final result. <br><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#  PM. # 71: . STOP unpickled_bomb = stack[-1]</span></span></code> </pre> <br></li></ul><br>  Whew, we're done!  Not sure if our code is especially Python ... but it emulates PM.  You may notice that we have never used a memo.  Remember all those PUT opcodes that were removed with pickletools.optimize ()?  They could interact with momo, but in our simple example it was not needed. <br><br>  Let's try to simplify the code to visually show its work.  In fact, in addition to mixing data, only three operations occur: importing _reconstructor into instruction 1, calling _reconstructor into instruction 7 and calling __setstate __ () in instruction 9. If you mentally imagine mixing data, you can express all three lines of Python. <br><br><pre> <code class="python hljs"><span class="hljs-comment"><span class="hljs-comment">#  1,    `_reconstructor` from copyreg import _reconstructor #  7,  `_reconstructor`   unpickled_bomb = _reconstructor(cls=Bomb, base=object, state=None) #  9,  `__setstate__`   unpickled_bomb.__setstate__('Evan')</span></span></code> </pre> <br>  An inside look at the source code copyreg._reconstructor () reveals that we simply call object .__ new __ (Bomb).  Using this knowledge, we can simplify all up to two lines. <br><br><pre> <code class="python hljs">unpickled_bomb = object.__new__(Bomb) unpickled_bomb.__setstate__(<span class="hljs-string"><span class="hljs-string">'Evan'</span></span>)</code> </pre> <br>  Congratulations, you just decompiled pickle! <br><br>  <b>Real Pickle Bomb</b> <br><br>  I am not a pickle expert, but I have already outlined how to construct a malicious pickle.  You can use the GLOBAL opcode to import any function - os.system and __builtin __. Eval seem to be suitable candidates.  Then we use REDUCE to execute it with an arbitrary argument.  But just ... wait, what is it? <br><br>  <i>If it is not isinstance (callable, type), REDUCE will not swear only if callable was registered in the copyreg module's safe_constructors dictionary, or callable has the magic attribute __safe_for_unpickling__ with a true value.</i>  <i>I do not know why this is happening, but I have seen a sufficient number of complaints &lt;winks&gt;.</i> <br><br>  Wink in response.  It looks like the pickletools documentation suggests that only allowed callable can be performed by REDUCE.  For a moment, it made me worried, but the search for safe_constuctors quickly helped find <a href="https://www.python.org/dev/peps/pep-0307/">PEP 307</a> of 2003. <br><br>  <i>In previous versions of Python, the reenergation had a ‚Äúsecurity check‚Äù on individual operations, refusing to call functions or constructors that were not marked ‚Äúsafe for reopening‚Äù for having the __safe_for_unpickling__ attribute equal to 1, or registering in the global register copy_reg.safe_constructors.</i> <i><br><br></i>  <i>This feature creates a false sense of security: no one has ever performed the necessary extensive code review to prove that pickle de-reserving from unreliable sources cannot cause unwanted code.</i>  <i>In fact, the bugs in the pickle.py Python 2.2 module make it easy to get around these precautions.</i> <i><br><br></i>  <i>We firmly believe that when using the Internet, it is better to know that your protocol is not secure than to trust the security of the protocol, whose implementation has not been thoroughly tested.</i>  <i>Even high-quality implementation of popular protocols often contains errors;</i>  <i>without a large time investment, the implementation of pickle in Python simply cannot guarantee.</i>  <i>Therefore, starting with the version of Python 2.3, all security checks for re-opening are officially excluded and replaced with a warning:</i> <i><br></i>  <i><b>Warning</b> : Do not reapply data from unreliable and unverified sources.</i> <br><br>  <a href="https://youtu.be/4zLfCnGVeL4">Hello, darkness, our old friend</a> .  Here it all began. <br><br>  That's all, we have found the key ingredient, and there is no false sense of security left from what we plan to do.  Let's start by writing our bomb: <br><br><pre> <code class="python hljs"><span class="hljs-comment"><span class="hljs-comment">#       arbitrary python GLOBAL '__builtin__ eval' #      MARK #   Python,       UNICODE 'print("Bang! From, Evan.")' #    ,       REDUCE TUPLE #  `eval()`    Python    REDUCE #  STOP,   PM   STOP</span></span></code> </pre> <br>  To turn this into a real pickle, you need to replace each opcode with the corresponding ASCII code: c for GLOBAL, (for MARK, V for UNICODE, t for TUPLE, R for REDUCE, and. For STOP. Note that these are the same values that were written to the left of opcodes in the pickletools.dis () output earlier. The arguments are analyzed after each opcode, taking into account the combination of position and newline constraints. Each argument is located either immediately after the corresponding opcode, or after the previous argument, and is read continuously until until a newline character is found. Transfer to machine  th pickle Code provides as follows: <br><br><pre> <code class="bash hljs">c__builtin__ <span class="hljs-built_in"><span class="hljs-built_in">eval</span></span> (Vprint(<span class="hljs-string"><span class="hljs-string">"Bang! From, Evan."</span></span>) tR.</code> </pre> <br>  Finally, we can check it out: <br><br><pre> <code class="python hljs"><span class="hljs-comment"><span class="hljs-comment">#   ! #  , ! pickled_bomb = b'c__builtin__\neval\n(Vprint("Bang! From, Evan.")\ntR.' pickle.loads(pickled_bomb)</span></span></code> </pre> <br>  Iii ... <br><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># -!  . Bang! From, Evan.</span></span></code> </pre> <br>  I know that you have no reason to believe me, but it really worked the first time. <br>  It is easy to understand that someone can easily come up with a more malicious argument for eval ().  PM can be forced to do literally anything that Python code can execute, including the system commands os.system (). <br><br>  <b>All good things come to an end</b> <br><br>  I was planning to learn how to make a dangerous pickle, but accidentally in the process I understood how pickle works.  I admit, I enjoyed digging into this pickle machine.  <a href="https://github.com/python/cpython/blob/3.6/Lib/pickletools.py">The source code for pickletools</a> helped a <a href="https://github.com/python/cpython/blob/3.6/Lib/pickletools.py">lot</a> , and I recommend it if you are interested in learning more about the pickle protocol and PM. <br><br>  THE END <br><br>  As always, we are waiting for suggestions and questions that can be asked here or personally by <a href="https://otus.pw/ogCk/">Ilya Lebedev</a> at <a href="https://otus.pw/mYnu/">the Open Day</a> . </div><p>Source: <a href="https://habr.com/ru/post/353480/">https://habr.com/ru/post/353480/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../353468/index.html">What's new in AppCode 2018.1</a></li>
<li><a href="../353470/index.html">Migration from Check Point from R77.30 to R80.10</a></li>
<li><a href="../353472/index.html">PostgreSQL 10 partitioning and more</a></li>
<li><a href="../353476/index.html">Aitracking, Emotions and VR: Technology Convergence and Current Research</a></li>
<li><a href="../353478/index.html">Beautiful listing of files and directories in nginx</a></li>
<li><a href="../353482/index.html">4. Check Point for maximum. Checking Anti-Virus with Kali Linux</a></li>
<li><a href="../353484/index.html">Organizer catalog for Heroes III cards and more than 7,700 cards in addition</a></li>
<li><a href="../353486/index.html">Why game servers and chat must exist separately</a></li>
<li><a href="../353488/index.html">Issue # 18: IT training - current issues and challenges from leading companies</a></li>
<li><a href="../353490/index.html">And again about translating PHP documentation</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>