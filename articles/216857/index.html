<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Synchronization in Android applications. Part two</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Colleagues, good afternoon. Let's continue the topic begun in the last article , where we discussed the mechanism for creating an account on the devic...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Synchronization in Android applications. Part two</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/getpro/habr/post_images/a97/b50/e4a/a97b50e4a781c9fe98f5ae4ed9f27708.png" alt="account" align="left"><br>  Colleagues, good afternoon.  Let's continue the topic begun in the <a href="http://habrahabr.ru/company/e-Legion/blog/206210/">last article</a> , where we discussed the mechanism for creating an account on the device.  This was the first prerequisite for using the SyncAdapter Framework. <br><br>  The second condition is the presence of <a href="http://developer.android.com/guide/topics/providers/content-providers.html">ContentProvider'a</a> , the process of writing which is chewed in the documentation.  Frankly, I don‚Äôt really like the way it is described there: everything seems cumbersome and complicated.  Therefore, a little bicycles and even once more live through this topic.  It would be possible to get along with the stub-provider, but we are serious people and we will use the full power of this tool. <br><br>  In the comments to the previous part flashed, please consider the case when we do not need authorization, but only synchronization.  Such a case and consider.  As an example, we take and write a simple rss reader to read our favorite Habr and not only.  Yes, that's so trite. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      The application will be able to add / delete tapes, view the list of news and open them in the browser.  We will visualize the synchronization process and its launch using the <a href="https://developer.android.com/reference/android/support/v4/widget/SwipeRefreshLayout.html">SwipeRefreshLayout</a> class recently added to the support-library.  You can read what it is and how to use it <a href="http://habrahabr.ru/post/218365/">here</a> . <br><br>  To set up automatic synchronization at regular intervals, we need a settings screen for this good.  It is desirable that access to it was not only from the application, but also from the system screen of our account (as in the screenshot for the article).  Use for this <a href="http://developer.android.com/reference/android/preference/PreferenceFragment.html">PreferenceFragment'y</a> .  Determined the functionality, let's start. <br><a name="habracut"></a><br><h4>  Account </h4><br>  How to add an account to the application you already know from the previous part.  But for our application, we do not need authorization; accordingly, we replace the Authenticator with an empty implementation. <br><div class="spoiler">  <b class="spoiler_title">Authenticator.java</b> <div class="spoiler_text"><pre><code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Authenticator</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">AbstractAccountAuthenticator</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Authenticator</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Context context)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">super</span></span>(context); } <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> Bundle </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">editProperties</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(AccountAuthenticatorResponse response, String accountType)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> UnsupportedOperationException(); } <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> Bundle </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">addAccount</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(AccountAuthenticatorResponse response, String accountType, String authTokenType, String[] requiredFeatures, Bundle options)</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">throws</span></span></span><span class="hljs-function"> NetworkErrorException </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> UnsupportedOperationException(); } <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> Bundle </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">confirmCredentials</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(AccountAuthenticatorResponse response, Account account, Bundle options)</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">throws</span></span></span><span class="hljs-function"> NetworkErrorException </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> UnsupportedOperationException(); } <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> Bundle </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getAuthToken</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(AccountAuthenticatorResponse response, Account account, String authTokenType, Bundle options)</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">throws</span></span></span><span class="hljs-function"> NetworkErrorException </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> UnsupportedOperationException(); } <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> String </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getAuthTokenLabel</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(String authTokenType)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> UnsupportedOperationException(); } <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> Bundle </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">updateCredentials</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(AccountAuthenticatorResponse response, Account account, String authTokenType, Bundle options)</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">throws</span></span></span><span class="hljs-function"> NetworkErrorException </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> UnsupportedOperationException(); } <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> Bundle </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">hasFeatures</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(AccountAuthenticatorResponse response, Account account, String[] features)</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">throws</span></span></span><span class="hljs-function"> NetworkErrorException </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> UnsupportedOperationException(); } }</code> </pre> <br></div></div><br>  We will need to slightly modify the <b>res / xml / authenticator.xml</b> file to add the ability to go to the synchronization settings screen.  Add the parameter <b>android: accountPreferences</b> with an indication of the file from which these same <a href="http://developer.android.com/guide/topics/ui/settings.html">Preferences</a> need to be pulled up.  When you click on the ‚ÄúSync‚Äù item, the SyncSettingsActivity of our application will open. <br><div class="spoiler">  <b class="spoiler_title">authenticator.xml</b> <div class="spoiler_text"><pre> <code class="xml hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?xml version="1.0" encoding="utf-8"?&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">account-authenticator</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">xmlns:android</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"http://schemas.android.com/apk/res/android"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">android:accountPreferences</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"@xml/account_prefs"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">android:accountType</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"com.elegion.newsfeed.account"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">android:icon</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"@drawable/ic_launcher"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">android:label</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"@string/app_name"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">android:smallIcon</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"@drawable/ic_launcher"</span></span></span><span class="hljs-tag"> /&gt;</span></span></code> </pre><br></div></div><br><div class="spoiler">  <b class="spoiler_title">account_prefs.xml</b> <div class="spoiler_text"><pre> <code class="xml hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?xml version="1.0" encoding="utf-8"?&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">PreferenceScreen</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">xmlns:android</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"http://schemas.android.com/apk/res/android"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">android:persistent</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"true"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">PreferenceCategory</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">android:title</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"@string/general_settings"</span></span></span><span class="hljs-tag"> /&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">PreferenceScreen</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">android:key</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"com.elegion.newsfeed.KEY_ACCOUNT_SYNC"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">android:summary</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"@string/sync_settings_summary"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">android:title</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"@string/sync"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">intent</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">android:action</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"com.elegion.newsfeed.ACTION_SYNC_SETTINGS"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">android:targetClass</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"com.elegion.newsfeed.activity.SyncSettingsActivity"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">android:targetPackage</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"com.elegion.newsfeed"</span></span></span><span class="hljs-tag"> /&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">PreferenceScreen</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">PreferenceScreen</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre><br></div></div><br><h4>  ContentProvider </h4><br>  Our provider will be a wrapper over a SQLite database in which we will store the news.  Let us dwell a bit and take a closer look at its implementation.  The provider can work with two types of Uri: <br>  <u>content: // authority / table</u> - select all values ‚Äã‚Äãfrom a table <br>  <u>content: // authority / table / _id</u> - fetching one value by primary key <br>  in the <i>onCreate</i> method using <a href="http://developer.android.com/reference/android/content/pm/PackageManager.html">PackageManager.getProviderInfo</a> we get the authority for this provider and register them with SQLiteUriMatcher.  What happens in the methods: the provider takes the name of the table from uri, then the specific SQLiteTableProvider implementation (the provider for the table) is taken from SCHEMA for this table.  In SQLiteTableProvider, the corresponding methods are called (in fact, the call is proxied).  This approach allows for each table to customize work with data.  Depending on the results, the ContentResolver (and with it our application) receives a notification of data changes.  For <u>content: // authority / table / _id uri,</u> the where <u>clause is</u> rewritten to ensure that the primary key works.  If you wish, you can screw this provider up a bit and take it to the library class.  As practice shows, such an implementation is sufficient for 90% of the tasks (the remaining 10 are full text search, like nocase search). <br><div class="spoiler">  <b class="spoiler_title">SQLiteContentProvider.java</b> <div class="spoiler_text"><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">SQLiteContentProvider</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ContentProvider</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> String DATABASE_NAME = <span class="hljs-string"><span class="hljs-string">"newsfeed.db"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> DATABASE_VERSION = <span class="hljs-number"><span class="hljs-number">1</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> String MIME_DIR = <span class="hljs-string"><span class="hljs-string">"vnd.android.cursor.dir/"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> String MIME_ITEM = <span class="hljs-string"><span class="hljs-string">"vnd.android.cursor.item/"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> Map&lt;String, SQLiteTableProvider&gt; SCHEMA = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ConcurrentHashMap&lt;&gt;(); <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> { SCHEMA.put(FeedProvider.TABLE_NAME, <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> FeedProvider()); SCHEMA.put(NewsProvider.TABLE_NAME, <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> NewsProvider()); } <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> SQLiteUriMatcher mUriMatcher = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> SQLiteUriMatcher(); <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> SQLiteOpenHelper mHelper; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> ProviderInfo </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getProviderInfo</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Context context, Class&lt;? extends ContentProvider&gt; provider, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> flags)</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">throws</span></span></span><span class="hljs-function"> PackageManager.NameNotFoundException </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> context.getPackageManager() .getProviderInfo(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ComponentName(context.getPackageName(), provider.getName()), flags); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> String </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getTableName</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Uri uri)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> uri.getPathSegments().get(<span class="hljs-number"><span class="hljs-number">0</span></span>); } <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">boolean</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onCreate</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> ProviderInfo pi = getProviderInfo(getContext(), getClass(), <span class="hljs-number"><span class="hljs-number">0</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> String[] authorities = TextUtils.split(pi.authority, <span class="hljs-string"><span class="hljs-string">";"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">final</span></span> String authority : authorities) { mUriMatcher.addAuthority(authority); } mHelper = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> SQLiteOpenHelperImpl(getContext()); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (PackageManager.NameNotFoundException e) { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> SQLiteException(e.getMessage()); } } <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> Cursor </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">query</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Uri uri, String[] columns, String where, String[] whereArgs, String orderBy)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> matchResult = mUriMatcher.match(uri); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (matchResult == SQLiteUriMatcher.NO_MATCH) { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> SQLiteException(<span class="hljs-string"><span class="hljs-string">"Unknown uri "</span></span> + uri); } <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> String tableName = getTableName(uri); <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> SQLiteTableProvider tableProvider = SCHEMA.get(tableName); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (tableProvider == <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> SQLiteException(<span class="hljs-string"><span class="hljs-string">"No such table "</span></span> + tableName); } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (matchResult == SQLiteUriMatcher.MATCH_ID) { where = BaseColumns._ID + <span class="hljs-string"><span class="hljs-string">"=?"</span></span>; whereArgs = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> String[]{uri.getLastPathSegment()}; } <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> Cursor cursor = tableProvider.query(mHelper.getReadableDatabase(), columns, where, whereArgs, orderBy); cursor.setNotificationUri(getContext().getContentResolver(), uri); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> cursor; } <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> String </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getType</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Uri uri)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> matchResult = mUriMatcher.match(uri); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (matchResult == SQLiteUriMatcher.NO_MATCH) { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> SQLiteException(<span class="hljs-string"><span class="hljs-string">"Unknown uri "</span></span> + uri); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (matchResult == SQLiteUriMatcher.MATCH_ID) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> MIME_ITEM + getTableName(uri); } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> MIME_DIR + getTableName(uri); } <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> Uri </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">insert</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Uri uri, ContentValues values)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> matchResult = mUriMatcher.match(uri); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (matchResult == SQLiteUriMatcher.NO_MATCH) { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> SQLiteException(<span class="hljs-string"><span class="hljs-string">"Unknown uri "</span></span> + uri); } <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> String tableName = getTableName(uri); <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> SQLiteTableProvider tableProvider = SCHEMA.get(tableName); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (tableProvider == <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> SQLiteException(<span class="hljs-string"><span class="hljs-string">"No such table "</span></span> + tableName); } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (matchResult == SQLiteUriMatcher.MATCH_ID) { <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> affectedRows = updateInternal( tableProvider.getBaseUri(), tableProvider, values, BaseColumns._ID + <span class="hljs-string"><span class="hljs-string">"=?"</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> String[]{uri.getLastPathSegment()} ); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (affectedRows &gt; <span class="hljs-number"><span class="hljs-number">0</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> uri; } } <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> <span class="hljs-keyword"><span class="hljs-keyword">long</span></span> lastId = tableProvider.insert(mHelper.getWritableDatabase(), values); getContext().getContentResolver().notifyChange(tableProvider.getBaseUri(), <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> Bundle extras = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Bundle(); extras.putLong(SQLiteOperation.KEY_LAST_ID, lastId); tableProvider.onContentChanged(getContext(), SQLiteOperation.INSERT, extras); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> uri; } <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">delete</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Uri uri, String where, String[] whereArgs)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> matchResult = mUriMatcher.match(uri); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (matchResult == SQLiteUriMatcher.NO_MATCH) { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> SQLiteException(<span class="hljs-string"><span class="hljs-string">"Unknown uri "</span></span> + uri); } <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> String tableName = getTableName(uri); <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> SQLiteTableProvider tableProvider = SCHEMA.get(tableName); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (tableProvider == <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> SQLiteException(<span class="hljs-string"><span class="hljs-string">"No such table "</span></span> + tableName); } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (matchResult == SQLiteUriMatcher.MATCH_ID) { where = BaseColumns._ID + <span class="hljs-string"><span class="hljs-string">"=?"</span></span>; whereArgs = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> String[]{uri.getLastPathSegment()}; } <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> affectedRows = tableProvider.delete(mHelper.getWritableDatabase(), where, whereArgs); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (affectedRows &gt; <span class="hljs-number"><span class="hljs-number">0</span></span>) { getContext().getContentResolver().notifyChange(uri, <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> Bundle extras = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Bundle(); extras.putLong(SQLiteOperation.KEY_AFFECTED_ROWS, affectedRows); tableProvider.onContentChanged(getContext(), SQLiteOperation.DELETE, extras); } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> affectedRows; } <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">update</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Uri uri, ContentValues values, String where, String[] whereArgs)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> matchResult = mUriMatcher.match(uri); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (matchResult == SQLiteUriMatcher.NO_MATCH) { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> SQLiteException(<span class="hljs-string"><span class="hljs-string">"Unknown uri "</span></span> + uri); } <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> String tableName = getTableName(uri); <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> SQLiteTableProvider tableProvider = SCHEMA.get(tableName); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (tableProvider == <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> SQLiteException(<span class="hljs-string"><span class="hljs-string">"No such table "</span></span> + tableName); } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (matchResult == SQLiteUriMatcher.MATCH_ID) { where = BaseColumns._ID + <span class="hljs-string"><span class="hljs-string">"=?"</span></span>; whereArgs = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> String[]{uri.getLastPathSegment()}; } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> updateInternal(tableProvider.getBaseUri(), tableProvider, values, where, whereArgs); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">updateInternal</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Uri uri, SQLiteTableProvider provider, ContentValues values, String where, String[] whereArgs)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> affectedRows = provider.update(mHelper.getWritableDatabase(), values, where, whereArgs); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (affectedRows &gt; <span class="hljs-number"><span class="hljs-number">0</span></span>) { getContext().getContentResolver().notifyChange(uri, <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> Bundle extras = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Bundle(); extras.putLong(SQLiteOperation.KEY_AFFECTED_ROWS, affectedRows); provider.onContentChanged(getContext(), SQLiteOperation.UPDATE, extras); } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> affectedRows; } <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">SQLiteOpenHelperImpl</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">SQLiteOpenHelper</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">SQLiteOpenHelperImpl</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Context context)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">super</span></span>(context, DATABASE_NAME, <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>, DATABASE_VERSION); } <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onCreate</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(SQLiteDatabase db)</span></span></span><span class="hljs-function"> </span></span>{ db.beginTransactionNonExclusive(); <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">final</span></span> SQLiteTableProvider table : SCHEMA.values()) { table.onCreate(db); } db.setTransactionSuccessful(); } <span class="hljs-keyword"><span class="hljs-keyword">finally</span></span> { db.endTransaction(); } } <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onUpgrade</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(SQLiteDatabase db, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> oldVersion, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> newVersion)</span></span></span><span class="hljs-function"> </span></span>{ db.beginTransactionNonExclusive(); <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">final</span></span> SQLiteTableProvider table : SCHEMA.values()) { table.onUpgrade(db, oldVersion, newVersion); } db.setTransactionSuccessful(); } <span class="hljs-keyword"><span class="hljs-keyword">finally</span></span> { db.endTransaction(); } } } }</code> </pre><br></div></div><br>  Now you need to register the provider in AndroidManifest.xml and pay attention to the <b>android</b> parameter <b>: syncable = "true"</b> .  This flag indicates that our provider supports synchronization. <br><div class="spoiler">  <b class="spoiler_title">AndroidManifest.xml</b> <div class="spoiler_text"><pre> <code class="xml hljs"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">provider</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">android:name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">".sqlite.SQLiteContentProvider"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">android:authorities</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"com.elegion.newsfeed"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">android:exported</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"false"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">android:syncable</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"true"</span></span></span><span class="hljs-tag"> /&gt;</span></span></code> </pre><br></div></div><br>  Also of interest is the FeedProvider class - an implementation of SQLiteTableProvider for working with news feeds.  When inserting (!) Into this table (subscription to a new tape) forced synchronization will be called.  The <i>onContentChanged</i> method, which is pulled from the SQLiteContentProvider when the data changes (insert / update / delete), is responsible for this.  A trigger will be created for the table ( <i>onCreate</i> ), which will delete news related to the feed.  Why it is worth calling synchronization only when pasting?  To avoid looping, because our provider will update the table (add a caption, a link to a picture, a publication date, etc.).  Additional synchronization parameters are transmitted via syncExtras. <br><div class="spoiler">  <b class="spoiler_title">FeedProvider.java</b> <div class="spoiler_text"><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">FeedProvider</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">SQLiteTableProvider</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> String TABLE_NAME = <span class="hljs-string"><span class="hljs-string">"feeds"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> Uri URI = Uri.parse(<span class="hljs-string"><span class="hljs-string">"content://com.elegion.newsfeed/"</span></span> + TABLE_NAME); <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">FeedProvider</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">super</span></span>(TABLE_NAME); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">long</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getId</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Cursor c)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> c.getLong(c.getColumnIndex(Columns._ID)); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> String </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getIconUrl</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Cursor c)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> c.getString(c.getColumnIndex(Columns.IMAGE_URL)); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> String </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getTitle</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Cursor c)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> c.getString(c.getColumnIndex(Columns.TITLE)); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> String </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getLink</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Cursor c)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> c.getString(c.getColumnIndex(Columns.LINK)); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">long</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getPubDate</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Cursor c)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> c.getLong(c.getColumnIndex(Columns.PUB_DATE)); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> String </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getRssLink</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Cursor c)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> c.getString(c.getColumnIndex(Columns.RSS_LINK)); } <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> Uri </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getBaseUri</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> URI; } <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onContentChanged</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Context context, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> operation, Bundle extras)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (operation == INSERT) { extras.keySet(); <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> Bundle syncExtras = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Bundle(); syncExtras.putLong(SyncAdapter.KEY_FEED_ID, extras.getLong(KEY_LAST_ID, -<span class="hljs-number"><span class="hljs-number">1</span></span>)); ContentResolver.requestSync(AppDelegate.sAccount, AppDelegate.AUTHORITY, syncExtras); } } <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onCreate</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(SQLiteDatabase db)</span></span></span><span class="hljs-function"> </span></span>{ db.execSQL(<span class="hljs-string"><span class="hljs-string">"create table if not exists "</span></span> + TABLE_NAME + <span class="hljs-string"><span class="hljs-string">"("</span></span> + Columns._ID + <span class="hljs-string"><span class="hljs-string">" integer primary key on conflict replace, "</span></span> + Columns.TITLE + <span class="hljs-string"><span class="hljs-string">" text, "</span></span> + Columns.LINK + <span class="hljs-string"><span class="hljs-string">" text, "</span></span> + Columns.IMAGE_URL + <span class="hljs-string"><span class="hljs-string">" text, "</span></span> + Columns.LANGUAGE + <span class="hljs-string"><span class="hljs-string">" text, "</span></span> + Columns.PUB_DATE + <span class="hljs-string"><span class="hljs-string">" integer, "</span></span> + Columns.RSS_LINK + <span class="hljs-string"><span class="hljs-string">" text unique on conflict ignore)"</span></span>); db.execSQL(<span class="hljs-string"><span class="hljs-string">"create trigger if not exists after delete on "</span></span> + TABLE_NAME + <span class="hljs-string"><span class="hljs-string">" begin "</span></span> + <span class="hljs-string"><span class="hljs-string">" delete from "</span></span> + NewsProvider.TABLE_NAME + <span class="hljs-string"><span class="hljs-string">" where "</span></span> + NewsProvider.Columns.FEED_ID + <span class="hljs-string"><span class="hljs-string">"=old."</span></span> + Columns._ID + <span class="hljs-string"><span class="hljs-string">";"</span></span> + <span class="hljs-string"><span class="hljs-string">" end;"</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">interface</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Columns</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">BaseColumns</span></span></span><span class="hljs-class"> </span></span>{ String TITLE = <span class="hljs-string"><span class="hljs-string">"title"</span></span>; String LINK = <span class="hljs-string"><span class="hljs-string">"link"</span></span>; String IMAGE_URL = <span class="hljs-string"><span class="hljs-string">"imageUrl"</span></span>; String LANGUAGE = <span class="hljs-string"><span class="hljs-string">"language"</span></span>; String PUB_DATE = <span class="hljs-string"><span class="hljs-string">"pubDate"</span></span>; String RSS_LINK = <span class="hljs-string"><span class="hljs-string">"rssLink"</span></span>; } }</code> </pre><br></div></div><br>  Behind this, the rabbit mink ends and the looking-glass begins. <br><br><h4>  Syncadapter </h4><br>  Before breaking into the process of creating a SyncAdapter, let's think about why it is needed at all, what advantages it gives.  If you believe the documentation, then at least we get: <br><br><ul><li>  Check the status and start synchronization when the network is available. </li><li>  Scheduler that will synchronize by criteria and / or schedule. </li><li>  Automatic start of synchronization if it failed for some reason last time. </li><li>  Save battery power, as the system will switch the radio module less frequently.  Plus, synchronization does not start at a critical charge level. </li><li>  Integration into the system settings interface. </li></ul><br>  Already not bad, right?  We add that when using ContentProvider, we can start synchronization when data changes in it.  This completely removes the need for us to track changes in the data in the application and perform synchronization in ‚Äúmanual mode‚Äù. <br><br>  The process of integrating this good is very similar to the process of integrating your account into an application.  We will need an implementation of <a href="http://developer.android.com/reference/android/content/AbstractThreadedSyncAdapter.html">AbstractThreadedSyncAdapter</a> and <a href="http://developer.android.com/reference/android/app/Service.html">Service</a> for integration into the system.  AbstractThreadedSyncAdapter has just one abstract <i>onPerformSync</i> method, in which all the magic happens.  What exactly is going on here?  Depending on the extras-parameters passed (remember syncExtras in FeedProvider.onContentChanged), either one tape or all is synchronized.  In general, we select tapes from the database, parse rss by reference and add them to our database using the <i>ContentProviderClient provider</i> .  To inform the system about the status (number of updates, errors, etc.) synchronization is used <i>SyncResult syncResult</i> . <br><div class="spoiler">  <b class="spoiler_title">SyncAdapter.java</b> <div class="spoiler_text"><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">SyncAdapter</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">AbstractThreadedSyncAdapter</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> String KEY_FEED_ID = <span class="hljs-string"><span class="hljs-string">"com.elegion.newsfeed.sync.KEY_FEED_ID"</span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">SyncAdapter</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Context context)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">super</span></span>(context, <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>); } <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onPerformSync</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Account account, Bundle extras, String authority, ContentProviderClient provider, SyncResult syncResult)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> <span class="hljs-keyword"><span class="hljs-keyword">long</span></span> feedId = extras.getLong(KEY_FEED_ID, -<span class="hljs-number"><span class="hljs-number">1</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (feedId &gt; <span class="hljs-number"><span class="hljs-number">0</span></span>) { syncFeeds(provider, syncResult, FeedProvider.Columns._ID + <span class="hljs-string"><span class="hljs-string">"=?"</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> String[]{String.valueOf(feedId)}); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { syncFeeds(provider, syncResult, <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>); } } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">syncFeeds</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(ContentProviderClient provider, SyncResult syncResult, String where, String[] whereArgs)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> Cursor feeds = provider.query( FeedProvider.URI, <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> String[]{ FeedProvider.Columns._ID, FeedProvider.Columns.RSS_LINK }, where, whereArgs, <span class="hljs-keyword"><span class="hljs-keyword">null</span></span> ); <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (feeds.moveToFirst()) { <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> { syncFeed(feeds.getString(<span class="hljs-number"><span class="hljs-number">0</span></span>), feeds.getString(<span class="hljs-number"><span class="hljs-number">1</span></span>), provider, syncResult); } <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (feeds.moveToNext()); } } <span class="hljs-keyword"><span class="hljs-keyword">finally</span></span> { feeds.close(); } } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (RemoteException e) { Log.e(SyncAdapter.class.getName(), e.getMessage(), e); ++syncResult.stats.numIoExceptions; } } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">syncFeed</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(String feedId, String feedUrl, ContentProviderClient provider, SyncResult syncResult)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> HttpURLConnection cn = (HttpURLConnection) <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> URL(feedUrl).openConnection(); <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> RssFeedParser parser = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> RssFeedParser(cn.getInputStream()); <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { parser.parse(feedId, provider, syncResult); } <span class="hljs-keyword"><span class="hljs-keyword">finally</span></span> { parser.close(); } } <span class="hljs-keyword"><span class="hljs-keyword">finally</span></span> { cn.disconnect(); } } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (IOException e) { Log.e(SyncAdapter.class.getName(), e.getMessage(), e); ++syncResult.stats.numIoExceptions; } } }</code> </pre><br></div></div><br>  The implementation of SyncService is also very simple.  All we need is to give the IBinder object to the system, to communicate with our SyncAdapter.  In order for the system to understand what adapter we are registering, you need the xml-meta file sync_adapter.xml, and also register all this stuff in AndroidManifest.xml. <br><div class="spoiler">  <b class="spoiler_title">SyncService.java</b> <div class="spoiler_text"><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">SyncService</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Service</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> SyncAdapter sSyncAdapter; <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onCreate</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">super</span></span>.onCreate(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (sSyncAdapter == <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) { sSyncAdapter = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> SyncAdapter(getApplicationContext()); } } <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> IBinder </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onBind</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Intent intent)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> sSyncAdapter.getSyncAdapterBinder(); } }</code> </pre><br></div></div><br><div class="spoiler">  <b class="spoiler_title">sync_adapter.xml</b> <div class="spoiler_text"><pre> <code class="xml hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?xml version="1.0" encoding="utf-8"?&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">sync-adapter</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">xmlns:android</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"http://schemas.android.com/apk/res/android"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">android:accountType</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"com.elegion.newsfeed.account"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">android:allowParallelSyncs</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"false"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">android:contentAuthority</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"com.elegion.newsfeed"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">android:isAlwaysSyncable</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"true"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">android:supportsUploading</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"false"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">android:userVisible</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"true"</span></span></span><span class="hljs-tag"> /&gt;</span></span></code> </pre><br></div></div><br><div class="spoiler">  <b class="spoiler_title">AndroidManifest.xml</b> <div class="spoiler_text"><pre> <code class="xml hljs"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">service</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">android:name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">".sync.SyncService"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">android:exported</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"false"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">android:process</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">":sync"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">intent-filter</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">action</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">android:name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"android.content.SyncAdapter"</span></span></span><span class="hljs-tag"> /&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">intent-filter</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">meta-data</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">android:name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"android.content.SyncAdapter"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">android:resource</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"@xml/sync_adapter"</span></span></span><span class="hljs-tag"> /&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">service</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre><br></div></div><br><h4>  And now an example </h4><br><img src="https://habrastorage.org/getpro/habr/post_images/c5e/de0/692/c5ede0692c7732efeceb5de447fdb983.png" alt="image" align="right"><br>  This is how the window with the list of ribbons will look.  As you remember, we agreed to use <i>SwipeRefreshLayout</i> to force synchronization and visualization of this process.  <i>FeedList.java feed</i> list and <i>NewsList.java</i> news <i>list</i> will be inherited from common parent <i>SwipeToRefreshList.java</i> . <br><br>  To track the synchronization status, you must register the Observer in the ContentResolver (the <i>SwipeToRefreshList.onResume ()</i> method).  To do this, use the <i>ContentResolver.addStatusChangeListener</i> method.  In the <i>SwipeToRefreshList.onStatusChanged</i> method, <i>we</i> check the synchronization status using the <i>ContentResolver.isSyncActive</i> method and pass this result to the <i>SwipeToRefreshList.onSyncStatusChanged</i> method, which will be redefined by successors.  All that this method will do is hide / show a progress bar for <i>SwipeRefreshLayout</i> .  Since <i>SyncStatusObserver.onStatusChanged</i> is called from a separate thread, we wrap the result in a handler.  The <i>SwipeToRefreshList.onRefresh</i> method in descendants starts forced synchronization using <i>ContentResolver.requestSync</i> . <br><br>  All lists are loaded and displayed using the <a href="http://developer.android.com/guide/components/loaders.html">CursorLoader</a> + <a href="http://developer.android.com/reference/android/widget/CursorAdapter.html">CursorAdapter</a> , which also work wonderfully in conjunction with the ContentProvider, eliminating the need to keep track of the relevance of the lists.  As soon as a new item is added to the provider, all CursorLoaders will receive notifications and update the data in the CursorAdapters. <br><div class="spoiler">  <b class="spoiler_title">SwipeToRefreshList.java</b> <div class="spoiler_text"><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">SwipeToRefreshList</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Fragment</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">SwipeRefreshLayout</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">OnRefreshListener</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">SyncStatusObserver</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">AdapterView</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">OnItemClickListener</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">SwipeToDismissCallback</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> SwipeRefreshLayout mRefresher; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> ListView mListView; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> Object mSyncMonitor; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> SwipeToDismissController mSwipeToDismissController; <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> View </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onCreateView</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(LayoutInflater inflater, ViewGroup container, Bundle savedInstanceState)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> View view = inflater.inflate(R.layout.fmt_swipe_to_refresh_list, container, <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>); mListView = (ListView) view.findViewById(android.R.id.list); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> (mRefresher = (SwipeRefreshLayout) view); } <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onActivityCreated</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Bundle savedInstanceState)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">super</span></span>.onActivityCreated(savedInstanceState); mRefresher.setColorScheme( android.R.color.holo_blue_light, android.R.color.holo_red_light, android.R.color.holo_green_light, android.R.color.holo_orange_light ); mSwipeToDismissController = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> SwipeToDismissController(mListView, <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>); } <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onResume</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">super</span></span>.onResume(); mRefresher.setOnRefreshListener(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>); mSyncMonitor = ContentResolver.addStatusChangeListener( ContentResolver.SYNC_OBSERVER_TYPE_ACTIVE | ContentResolver.SYNC_OBSERVER_TYPE_PENDING, <span class="hljs-keyword"><span class="hljs-keyword">this</span></span> ); mListView.setOnItemClickListener(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>); mListView.setOnTouchListener(mSwipeToDismissController); mListView.setOnScrollListener(mSwipeToDismissController); } <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onPause</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ mRefresher.setOnRefreshListener(<span class="hljs-keyword"><span class="hljs-keyword">null</span></span>); ContentResolver.removeStatusChangeListener(mSyncMonitor); mListView.setOnItemClickListener(<span class="hljs-keyword"><span class="hljs-keyword">null</span></span>); mListView.setOnTouchListener(<span class="hljs-keyword"><span class="hljs-keyword">null</span></span>); mListView.setOnScrollListener(<span class="hljs-keyword"><span class="hljs-keyword">null</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">super</span></span>.onPause(); } <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">final</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onRefresh</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ onRefresh(AppDelegate.sAccount); } <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">final</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onStatusChanged</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> which)</span></span></span><span class="hljs-function"> </span></span>{ mRefresher.post(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Runnable() { <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">run</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ onSyncStatusChanged(AppDelegate.sAccount, ContentResolver .isSyncActive(AppDelegate.sAccount, AppDelegate.AUTHORITY)); } }); } <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onItemClick</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(AdapterView&lt;?&gt; parent, View view, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> position, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">long</span></span></span></span><span class="hljs-function"><span class="hljs-params"> id)</span></span></span><span class="hljs-function"> </span></span>{ } <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">boolean</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">canDismissView</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(View view, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> position)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>; } <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">dismissView</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(View view, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> position)</span></span></span><span class="hljs-function"> </span></span>{ } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">setListAdapter</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(ListAdapter adapter)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> DataSetObserver dataSetObserver = mSwipeToDismissController.getDataSetObserver(); <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> ListAdapter oldAdapter = mListView.getAdapter(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (oldAdapter != <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) { oldAdapter.unregisterDataSetObserver(dataSetObserver); } mListView.setAdapter(adapter); adapter.registerDataSetObserver(dataSetObserver); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">protected</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onRefresh</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Account account)</span></span></span><span class="hljs-function"> </span></span>{ } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">protected</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onSyncStatusChanged</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Account account, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">boolean</span></span></span></span><span class="hljs-function"><span class="hljs-params"> isSyncActive)</span></span></span><span class="hljs-function"> </span></span>{ } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">protected</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">setRefreshing</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">boolean</span></span></span></span><span class="hljs-function"><span class="hljs-params"> refreshing)</span></span></span><span class="hljs-function"> </span></span>{ mRefresher.setRefreshing(refreshing); } }</code> </pre><br></div></div><br><img src="https://habrastorage.org/getpro/habr/post_images/753/4ac/e24/7534ace24efbfc7fef857eaba19f6468.png" alt="image" align="left"><br>  So, with forced synchronization sorted out.  But the juice is automatic synchronization.  Remember, we added support for the settings screen to our account?  Good practice is not to force the user to perform unnecessary actions.  Therefore, access to this screen is duplicated by a button in the action bar. <br><br>  What he is like is seen on the left.  Technically, this is an activation with one PreferenceFragment ( <i>SyncSettings.java</i> ), whose settings are taken from <b>res / xml / sync_prefs.xml</b> . <br><br>  Change of parameters is traced in the <i>onSharedPreferenceChanged</i> method (implementation of <i>OnSharedPreferenceChangeListener</i> ).  To enable periodic synchronization, there is the <i>ContentResolver.addPeriodicSync</i> method, but strangely enough, the <i>ContentResolver.removePeriodicSync</i> method for disabling.  To update the synchronization interval, use the <i>ContentResolver.addPeriodicSync</i> method as <i>well</i> .  Because, according to the documentation for this method: "If you have the answer, you‚Äôve been updated." if synchronization is already scheduled, extra and authority will not be added to the new synchronization, instead the previous one will be updated). <br><br><br><br><div class="spoiler">  <b class="spoiler_title">sync_prefs.xml</b> <div class="spoiler_text"><pre> <code class="xml hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?xml version="1.0" encoding="utf-8"?&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">PreferenceScreen</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">xmlns:android</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"http://schemas.android.com/apk/res/android"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">PreferenceCategory</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">android:key</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"com.elegion.newsfeed.KEY_SYNC"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">android:title</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"@string/sync"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">CheckBoxPreference</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">android:defaultValue</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"false"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">android:key</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"com.elegion.newsfeed.KEY_AUTO_SYNC"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">android:summary</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"@string/auto_sync_summary"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">android:title</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"@string/auto_sync"</span></span></span><span class="hljs-tag"> /&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">ListPreference</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">android:defaultValue</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"@string/auto_sync_interval_default"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">android:dependency</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"com.elegion.newsfeed.KEY_AUTO_SYNC"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">android:entries</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"@array/auto_sync_intervals"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">android:entryValues</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"@array/auto_sync_interval_values"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">android:key</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"com.elegion.newsfeed.KEY_AUTO_SYNC_INTERVAL"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">android:title</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"@string/auto_sync_interval"</span></span></span><span class="hljs-tag"> /&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">PreferenceCategory</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">PreferenceScreen</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre><br></div></div><br><div class="spoiler">  <b class="spoiler_title">SyncSettings.java</b> <div class="spoiler_text"><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">SyncSettings</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">PreferenceFragment</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">SharedPreferences</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">OnSharedPreferenceChangeListener</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> String KEY_AUTO_SYNC = <span class="hljs-string"><span class="hljs-string">"com.elegion.newsfeed.KEY_AUTO_SYNC"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> String KEY_AUTO_SYNC_INTERVAL = <span class="hljs-string"><span class="hljs-string">"com.elegion.newsfeed.KEY_AUTO_SYNC_INTERVAL"</span></span>; <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onCreate</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Bundle savedInstanceState)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">super</span></span>.onCreate(savedInstanceState); addPreferencesFromResource(R.xml.sync_prefs); <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> ListPreference interval = (ListPreference) getPreferenceManager() .findPreference(KEY_AUTO_SYNC_INTERVAL); interval.setSummary(interval.getEntry()); } <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onResume</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">super</span></span>.onResume(); getPreferenceManager().getSharedPreferences() .registerOnSharedPreferenceChangeListener(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>); } <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onPause</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ getPreferenceManager().getSharedPreferences() .unregisterOnSharedPreferenceChangeListener(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">super</span></span>.onPause(); } <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onSharedPreferenceChanged</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(SharedPreferences prefs, String key)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (TextUtils.equals(KEY_AUTO_SYNC, key)) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (prefs.getBoolean(key, <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>)) { <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> <span class="hljs-keyword"><span class="hljs-keyword">long</span></span> interval = Long.parseLong(prefs.getString( KEY_AUTO_SYNC_INTERVAL, getString(R.string.auto_sync_interval_default) )); ContentResolver.addPeriodicSync(AppDelegate.sAccount, AppDelegate.AUTHORITY, Bundle.EMPTY, interval); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { ContentResolver.removePeriodicSync(AppDelegate.sAccount, AppDelegate.AUTHORITY, <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Bundle()); } } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (TextUtils.equals(KEY_AUTO_SYNC_INTERVAL, key)) { <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> ListPreference interval = (ListPreference) getPreferenceManager().findPreference(key); interval.setSummary(interval.getEntry()); ContentResolver.addPeriodicSync( AppDelegate.sAccount, AppDelegate.AUTHORITY, Bundle.EMPTY, Long.parseLong(interval.getValue()) ); } } }</code> </pre><br></div></div><br>  Having collected all this in a bunch, we get a working application, with all the buns that the Android system provides us.  Behind the scenes, a lot of delicious things remained, but this is enough to understand the power of the SyncAdapter Framework. <br><br>  That seems to be all.  Full source code of the project can be found <a href="https://github.com/elegion/newsfeed">here</a> .  Thank you for attention.  Constructive criticism is welcome. <br><br>  <a href="http://habrahabr.ru/company/e-Legion/blog/206210/">Synchronization in Android applications.</a>  <a href="http://habrahabr.ru/company/e-Legion/blog/206210/">Part one.</a> </div><p>Source: <a href="https://habr.com/ru/post/216857/">https://habr.com/ru/post/216857/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../216843/index.html">We start to study Cortex-M on the example of STM32</a></li>
<li><a href="../216845/index.html">Search for solutions for games with words. Boron application</a></li>
<li><a href="../216849/index.html">Setting up the development environment for OpenStack</a></li>
<li><a href="../216851/index.html">We control the machine via Bluetooth from a tablet or phone for Android</a></li>
<li><a href="../216853/index.html">Gateway between IRC and Google Hangouts</a></li>
<li><a href="../216865/index.html">Use a hash search, not an array search</a></li>
<li><a href="../216869/index.html">Alternative GDC Arcade: Home-Made Freak Controllers Gallery</a></li>
<li><a href="../216871/index.html">Operation windigo</a></li>
<li><a href="../216875/index.html">Fighting the Apocalypse: technologies that will save humanity</a></li>
<li><a href="../216877/index.html">New LG monitors of Ultrawide line</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>