<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Accelerate loading rail</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Despite the title, it‚Äôs about ruby ‚Äã‚Äãrather than rails. So I decided to post this translation on the Rubi blog. 

 The latest releases of MRI Ruby sho...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Accelerate loading rail</h1><div class="post__text post__text-html js-mediator-article">  <i>Despite the title, it‚Äôs about ruby ‚Äã‚Äãrather than rails.</i>  <i>So I decided to post this translation on the Rubi blog.</i> <br><br>  The latest releases of MRI Ruby show a significant slowdown when connecting files. <br><img src="https://habrastorage.org/storage/98aa5170/24e89012/d19fdcca/f83950a7.jpeg"><br>  For example, our average rail application when loading makes require about 2200 times - this is somewhere completely on the right side of the chart.  Absolutely no good.  At 1.9.2, the application starts in 20 seconds, and at 1.9.3 it is already 46. Too slow! <a name="habracut"></a><br><br>  There are several reasons for this, but the main one is the require algorithm, which looks like this: <br><pre><code class="ruby hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">require</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(file)</span></span></span></span> $loaded.each <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> <span class="hljs-params"><span class="hljs-params">|x|</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">false</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> x == file <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> load(file) $loaded &lt;&lt; file <span class="hljs-keyword"><span class="hljs-keyword">end</span></span></code> </pre> 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      All brakes come from the cycle, and the more files we connect, the more it slows down.  I wrote a patch for 1.9.3, which replaces the brake cycle with something like this: <br><pre> <code class="ruby hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">require</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(file)</span></span></span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">false</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> $loaded[file] load(file) $loaded[file] = <span class="hljs-literal"><span class="hljs-literal">true</span></span> <span class="hljs-keyword"><span class="hljs-keyword">end</span></span></code> </pre><br>  And it gives about the following result: <br><img src="http://habrastorage.org/storage/1c5f52d4/bceacec1/1588d221/87e1f451.jpeg"><br>  Much nicer! <br><br>  These are graphs of synthetic test for connecting empty files, but the patch accelerates in real projects.  My <a href="http://theconversation.edu.au/">application</a> now loads about 10 seconds.  At 1.9.2 it was loaded 20. An empty application loads in general in 1.1 seconds, which is even faster than in 1.8.7 <br><img src="http://habrastorage.org/storage/2757e8ee/969c011b/7c29713c/f55e6a8c.jpeg"><br><br><h2>  How to patch </h2><br>  It's all quite simple, it will take no more than 10 minutes, if you have installed RVM. <br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#      cd /your/rails/app time script/rails runner "puts 1" #   ruby curl https://gist.github.com/raw/996418/e2b346fbadeed458506fc69ca213ad96d1d08c3e/require-performance-fix-r31758.patch &gt; /tmp/require-performance-fix.patch rvm install ruby-head --patch /tmp/require-performance-fix.patch -n patched # ...     ‚Äî    8    MBP #     cd /your/rails/app rvm use ruby-head-patched gem install bundler --no-rdoc --no-ri bundle time script/rails runner "puts 1"</span></span></code> </pre> <br><br><h2>  How can I help </h2><br>  I need to get as much attention as possible to the patch before it is included in the main trunk.  It would help a lot if you: <br><ul><li>  We tried the patch on our applications and wrote off the execution time of benchmarks in the comments </li><li>  We looked at the <a href="https://github.com/ruby/ruby/pull/25">code in pull-rekveste on github</a> (language C, but I hope that no one will be scared) </li><li>  Tried on windows </li><li>  Reported bugs that you find </li></ul><br><br><h2>  What's next </h2><br>  I believe that before the inclusion of this patch in 1.9.3 is still far away, a lot of work remains to be done, but still, this is the first of many steps aimed at accelerating the launch of applications on rails.  There are Bundler and RubyGems, which spend a lot of time is not clear on what - I would like to explore their insides. <br>  I also plan to port this patch to JRuby, since there are similar problems there.  In Rubinius, it seems, initially this is all right. </div><p>Source: <a href="https://habr.com/ru/post/120180/">https://habr.com/ru/post/120180/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../120173/index.html">PayPal sued Google for Google Wallet</a></li>
<li><a href="../120174/index.html">Class for translating text using the Google Translate service</a></li>
<li><a href="../120175/index.html">Internet Mathematics 2011. Determining Image Similarity</a></li>
<li><a href="../120177/index.html">Gnome 3 - is the end close?</a></li>
<li><a href="../120179/index.html">How will the Sensor and Location platform in Windows 7 change our lives</a></li>
<li><a href="../120182/index.html">A simple example of phonetic search</a></li>
<li><a href="../120183/index.html">Visual component monitor COM-port</a></li>
<li><a href="../120185/index.html">New service from Google for those who need to quickly get information about the flight</a></li>
<li><a href="../120186/index.html">World War II mechanical encryption device</a></li>
<li><a href="../120187/index.html">How not to develop on the Zend Framework</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>