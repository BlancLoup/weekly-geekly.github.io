<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Tarantool: examples of use</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Tarantool is an open source database. Anyone can download it from GitHub and use it both in commercial and non-commercial applications. Today, the tec...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Tarantool: examples of use</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/files/5b0/9b7/22c/5b09b722c509423eb28109b7c5e47618.png"><br><br>  Tarantool is an open source database.  Anyone can download it from GitHub and use it both in commercial and non-commercial applications.  Today, the technical director of the Mail.ru Denis Anikin will talk about examples of using this database.  The material is based on the speech at the <a href="http://failoverconf.ru/conf2016/agenda/">conference FailOver Conference</a> . <br><a name="habracut"></a><br>  <a href="https://tarantool.org/">Tarantool has</a> been developed by Mail.Ru Group for more than seven years.  This DBMS is designed for highly loaded systems.  Its main difference is that it is a database that combines the properties of a real database ‚Äî transactions, replications, everything about reliability ‚Äî but at the same time it is as fast as caches, for example, Memcached or Redis. <br><br>  In Mail.Ru Group, a good half of the products work on Tarantool.  It is preferred in cases where the cache requires the properties of the cache, that is, it must be able to do 100 thousand updates per second, it must have very good latency ‚Äî 1 ms or less ‚Äî and so on.  Many DBMSs do not satisfy these criteria.  If many shards are used, this is not beneficial: transactions stop working, integrity is lost, and other problems arise.  And caches, in turn, do not have many of the useful properties of the database: the reliability of storing data on disk, transactions, and so on.  For example, in caches there is usually no such important thing as stored procedures.  They allow you to transfer logic to the data storage side. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h3>  DB + cache =? </h3><br>  Of course, you can live on high-loaded projects and without Tarantool.  Suppose you need the properties of both the base and the cache in one bottle.  Then you can use a very popular scheme: put the cache on top of the database.  Then all requests go to the cache first, if there is the necessary data in it, then they are given to the user.  If they are not there, then the request is redirected to the database.  All updates go immediately to the database and to the cache, because we cannot store something in the cache without saving it in the database, otherwise this data may be lost. <br><br>  This scheme allows you to get some of the properties of the database.  For example, there will no longer be any transactions or storage procedures, because when two systems appear, especially the cache, then we are not talking about any transactions.  In a sense, replication is also lost, because the data in the database is replicated, and in the cache - as if not quite.  Also, stored procedures and other properties of the database are lost.  Cache properties are also partially saved.  Such a system works faster, because it increases the speed of processing read requests, but at the same time, for example, a write request does not become faster.  If the database has slowed down, because it has a table vacuum or something else, then the system will slow down to write, because recording does not work without a database. <br><br>  In general, this is a working scheme.  It allows you to get some of the properties and the base and cache in one system.  If this is enough for you, then this scheme should be used. <br><br>  True, in this case, there are two frequent problems - inconsistent data and a cold start.  ‚ÄúInconsistency‚Äù means that the data in the cache and database may be different, because the cache and the database are not a replica of each other, they are just two separate entities.  ‚ÄúCold start‚Äù is a situation when at the start of the cache it is still empty, there is no data in it, therefore all requests fly to the database and the system performance leaves much to be desired. <br><br>  If you are not confused by these moments, then the ‚Äúcache on top of the database‚Äù scheme is quite a working option.  Otherwise, it is advisable to pay attention to Tarantool, because in it all these problems are solved initially.  One of the reasons for its development is not to fence such complex heterogeneous systems consisting of several repositories, but to calmly manage with one and store all the hot data in it. <br><br><h3>  Engines </h3><br>  Tarantool has two data storage engines.  One of them is an in-memory engine.  It is arranged like this: all data is stored in memory, copies of the data are on the disk.  Each transaction is written to the disk simply in a log, and from time to time the entire snapshot of the entire database is flushed to the disk.  Reset asynchronously in the background.  While it is being reset, the database is working, because all new updates go to separate places.  That is, everything works without any brakes.  Log transactions are always written. <br><br>  The second disk engine.  It allows you to store everything on disk.  And you can use both SSD and hard drives.  This engine grew from Google LevelDB, which has been optimized. <br><br><h3>  Advantages and disadvantages </h3><br>  Tarantool has cache specific properties: <br><br><ul><li>  Hot data. </li><li>  Availability 99.99%. </li><li>  Optimum operation with high parallel load. </li><li>  Latency: <br><ul><li>  99% of requests &lt;1 ms </li><li>  99.9% of requests &lt;3 ms </li></ul></li><li>  Write load ‚Äî up to 1 million transactions per second on a single CPU core. </li><li>  Do not need a lot of servers. </li><li>  Optimal use of memory. </li><li>  The system is constantly working, no need to take a break for maintenance work. </li></ul><br>  Basically, everything is connected with high speed of work.  Traditional DBMS does not have these properties.  At the same time, Tarantool also has the properties of classic DBMS: <br><br><ul><li>  Persistence (reliability of data storage on the disk). </li><li>  ACID transactions. </li><li>  Replication (master-slave and master-master). </li><li>  Stored procedures. </li><li>  Non-blocking server scripts. </li><li>  Convenient backups. </li><li>  Run queries Cursors, Range and Full scan. </li><li>  Primary and secondary indices. </li><li>  Tables </li></ul><br>  Again, the cache does not have these properties, but they are present in Tarantool. <br><br>  Some modern databases are aimed at high reliability of work, others focus on speed of work.  These are two different worlds, which, basically, do not overlap.  Tarantool is a fairly successful attempt to combine both worlds in one solution. <br><br><img src="https://habrastorage.org/files/412/fca/77d/412fca77d8cf4f2d99e86c439534858e.png"><br><br>  The disadvantages of Tarantool include the following: <br><br><ul><li>  He has not a very large community yet.  Before applying any technology, every person always thinks: ‚ÄúWhat if it will not work?  Who will I ask? ‚Äù  Tarantool developers try to be and answer questions everywhere: on Facebook, on Stack Overflow, and so on.  But from the point of view of a number of users there is a risk of not getting an answer due to the small number of the community. </li><li>  There is no consistent sharding.  We are working on this now, so that he is out of the box already normal, with transaction support. </li><li>  Proprietary protocol. </li></ul><br><h3>  Tarantool usage examples </h3><br>  All examples are taken from the experience of the Mail.Ru Group projects.  In fact, there are a lot of them, but we will consider only three: the authentication system, the push notification system and the advertising system.  Usually they are the highest loaded. <br><br><h4>  Authentication system </h4><br>  It should have a number of seemingly contradictory requirements. <br><br><ul><li>  <b>Highest demand</b> : Authentication should be checked for every hit on the website or in the mobile application.  You need to check the password, cookies, token, anything, because you can not just let the user in.  On the Mail.Ru portal and in mobile applications, the number of requests to the authentication system amounts to millions per second. </li><li>  <b>Latency</b> - the time between the request and the response from the database.  It should be as small as possible, otherwise everything will slow down, including the web server using authentication.  While it waits for a response from the database, it takes up some thread or process, the data hangs in memory, and this also consumes server resources.  That is, the slow authentication authentication system can drag along a lot of problems, so it should work just instantly. </li><li>  <b>High availability</b> .  If the authentication system does not work in 1% of cases, then the whole site will not work in 1% of cases. </li><li>  <b>Constant requests to the repository</b> .  Each hit in the authentication system is a check of the session, password, token. </li><li>  <b>Protection against brute-force attacks and fraud</b> .  Authentication system is constantly trying to break. </li><li>  <b>Almost every call is associated with the execution of a transaction</b> , that is, with the need to change some data.  For example, when performing authentication, you need to check the entered data, update the time and place of authentication, other parameters for the brute-force protection system.  All this is a direct transaction in the database.  This record can not be lost. </li><li>  <b>A lot of inevitable extra work</b> .  When everyone is trying to break the system, behind the scenes there are a lot of hits that are not generated by users, but by means of hacking.  These calls do not carry any useful traffic or profits.  This is an extra load.  But they have to be processed and checked. </li><li>  <b>Large data size</b> .  Naturally, the entire user base should be stored in the authentication system. </li><li>  <b>Presence of validity of the data entered by the user (expiration)</b> .  For security reasons, if the user is not active for a while, his session is terminated.  To do this, you must check the start time of the session and the presence of activity. </li><li>  <b>Reliability of data storage (persistence)</b> .  Obviously, if the authentication system ‚Äúforgets‚Äù a part of users as a result of the loss of credentials, this is a direct damage to reputation. </li></ul><br>  In general, this set of properties may look contradictory.  Some of them are usually implemented caches, and some - databases.  The authentication system must be reliable and durable as a truck, but at the same time as fast as a sports car.  And Tarantool came in handy here. <br><br>  The scheme of Mail.Ru authentication system by login and password: <br><br><img src="https://habrastorage.org/files/824/c19/338/824c193387d94a0f89afedf0015f69e3.png"><br><br>  Only when checking logins and passwords in Mail.Ru 50 thousand transactions per second are performed.  The brute-force protection and authentication system is read and written in Tarantool every time.  This total load reaches approximately one million requests per second: from the entire portal, from all mobile applications, from all Ajax and non-Ajax requests. <br><br><img src="https://habrastorage.org/files/45e/5eb/414/45e5eb4147c349d69deaa8fa31313b14.png"><br><br>  In this session, only 4 servers serve, and user profiles - 8 servers.  Not some kind of branded, special servers, but the most ordinary ones, with ordinary processors.  Nothing cosmic. <br><br><h4>  Push notification system </h4><br>  As you know, mobile apps like to send push notifications to users so that they stay longer.  That is, it is such a good and appreciative thing. <br><br>  How does the notification system in Mail.Ru? <br><br><img src="https://habrastorage.org/files/b63/a1f/c7e/b63a1fc7e12d4ffc9b5fc3d1d54a5410.png"><br><br>  When any events occur on the server - a letter has arrived, a message has been sent to the instant messenger, news has appeared - you need to send a notification to the mobile phones of the end users.  Directly to make it impossible.  Therefore, Apple and Google provide APIs for iOS and Android, through which you can pull mobile apps. <br><br>  But you cannot access these APIs directly from the server.  Why - about this below.  In addition, each time you generate an event, you need to go to the repository to understand which user to deliver this event.  And do not forget to read the token, because the API works with tokens.  And all this needs to be done very quickly. <br><br>  It is also extremely important to maintain very low latency, since events are generated from a large number of different contexts and server environments.  You can never slow down on the server, wait a second or two, because otherwise all the other participants in the process along the chain will begin to work slowly.  For this reason, we are accessing the API not directly from the server, but through a queue, also running on Tarantool.  This DBMS can also provide a queue service, moreover, persistent and replicable.  That is, when the machine crashes, when the disk fails, when the server is restarted, no one notices. <br><br>  It turns out that the server works directly only with fast storage, and everything slow is located further, behind the queue.  This scheme allows you to quickly process everything: the total number of requests in this system is about 200 thousand per second. <br><br><h4>  Advertising display system </h4><br>  This is probably the most highly loaded version of the use of Tarantool, and this is the largest farm that Mail.Ru Group has.  The system is responsible for displaying ads on almost all pages of a huge portal, and ad units on a page are usually at least 10. <br><br>  To show each ad unit, you need to understand what to show to the user.  For this data about him are collected from several different sources.  All this is aggregated and the result is formed.  All this is done for each block, and less than one millisecond is needed for this.  Where does this requirement come from?  Because users do not want the service to slow down due to advertising, it annoys everyone, but is a necessary evil. <br><br><img src="https://habrastorage.org/files/bb1/a14/497/bb1a14497be94796925d27040ec5f7b1.png"><br><br>  The load on the advertising display system is about 3 million requests per second.  And 1 million of them are changes, because the display of advertising often leads to an update of the user profile. <br><br><h3>  Brief conclusion </h3><br>  If you need to combine the properties of the database and the cache, reliability and speed, and if you cannot achieve this with some simple methods that you usually do, then take a closer look at Tarantool.  Most likely, he will solve this problem. </div><p>Source: <a href="https://habr.com/ru/post/309000/">https://habr.com/ru/post/309000/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../308990/index.html">Intel Software Conference 2016. September, Moscow, St. Petersburg</a></li>
<li><a href="../308992/index.html">The era of ‚ÄúPost-Let's Encrypt‚Äù. Who still needs to pay for SSL certificates?</a></li>
<li><a href="../308994/index.html">Baidu has published the PaddlePaddle depth learning toolkit demo.</a></li>
<li><a href="../308996/index.html">TargetSummit Moscow 2016 in a week</a></li>
<li><a href="../308998/index.html">Dropbox - stop displaying HTML content in the browser</a></li>
<li><a href="../309002/index.html">The Game of Java: Java Conference in Kiev, October 14-15, 2016</a></li>
<li><a href="../309004/index.html">Data Science Week 2016. Data Technologies Forum</a></li>
<li><a href="../309008/index.html">ML boot camp 2016 new to TOP 10</a></li>
<li><a href="../309010/index.html">Benefits of systemd-networkd on Linux virtual servers</a></li>
<li><a href="../309012/index.html">DevCon School schools and other good news for the day of knowledge</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>