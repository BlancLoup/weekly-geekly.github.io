<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>We draw a map with one select or about the benefits of multi-indexes</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="This article is written in continuation of the series, which tells about the prototyping of a simple and productive dynamic web map server. Earlier it...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>We draw a map with one select or about the benefits of multi-indexes</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/getpro/habr/post_images/cf2/f0a/52b/cf2f0a52b2b81dea98931ffeab19466e.png" alt="image"><br>  This article is written in continuation of the series, which tells about the prototyping of a simple and productive dynamic web map server.  <a href="http://habrahabr.ru/post/196682/">Earlier it was</a> described how spatial indexes are arranged in it, as well <a href="http://habrahabr.ru/post/200642/">as</a> how to take and draw a spatial layer just like that.  Now we make it a bit more elegant. <br><a name="habracut"></a><br>  In terms of working with one layer, we more or less figured out, but there are dozens of layers in reality, each of them will have to be queried in the spatial index, even if nothing has got into the search extent ... architecturally clean up the process and get rid of the obviously useless actions? <br><br><h4>  <b>Indexing</b> </h4><br>  It is possible, why not.  But for this we will have to create a single spatial index for all spatial layers.  Recall how our indexes are arranged: <br><ul><li>  The space of the layer is divided into blocks by a rectangular lattice. </li><li>  All blocks are numbered. </li><li>  Each indexed object is assigned one or more block numbers in which it is located. </li><li>  When searching, the extent of the query is split into blocks, and for each block or a continuous chain of blocks from the usual integer index, all the objects that belong to them are taken </li></ul><br>  Well, to create a single index, you will have to divide all the layers with one grid, number the same blocks and, in addition to the object identifier, store the table identifier in the index.  So: <br><ul><li>  We will train as before on the shape of the data obtained from <a href="http://gis-lab.info/qa/osmshp.html">OSM Russia</a> . </li><li>  Take 4 relatively populated layers - water, forests, buildings and roads. </li><li>  As a DBMS, as before, we will use OpenSource edition of <a href="http://virtuoso.openlinksw.com/dataspace/doc/dav/wiki/Main/">OpenLink Virtuoso</a> , the official Win_x64 build of version 7.0.0, taken from the developer‚Äôs site. </li><li>  For drawing, we will use the <a href="http://en.wikipedia.org/wiki/GD_Graphics_Library">GD-</a> based and previously described C plug-in that extends the set of built-in PL / SQL functions. </li><li>  Take the extent of the data: xmin = -180, ymin = 35, xmax = 180, ymax = 85 degrees. </li><li>  Divide this extent into blocks of 0.1 ¬∞ in latitude and longitude.  Thus we will receive a grid of 3600500 blocks.  0.1 ¬∞ is about 11 km, a bit too much to draw at the house level, but our goal at the moment is not the maximum performance in specific conditions, but a concept check. </li><li>  Load the layers in the DBMS in the same way as before: <br><ul><li>  vegetation-polygon.shp: 657673 items, load time 2 '4' ' </li><li>  water-polygon.shp: 380868 items, load time 1 '22' ' </li><li>  building-polygon.shp: 5326421 items, load time 15 '42' ' </li><li>  highway-line.shp: 2599083 elements, load time 7 '56' ' </li></ul></li><li>  Now there are data tables (Ex: "xxx". "YYY". "Water-polygon") and associated tables with spatial indexes (Ex: "xxx". "YYY". "Water-polygon__spx").  Using the fact that they are all formed with the same parameters, we merge them into a single spatial index <br><pre><code class="sql hljs">registry_set ('__spx_startx', '-180'); registry_set ('__spx_starty', '35'); registry_set ('__spx_nx', '3600'); registry_set ('__spx_ny', '500'); registry_set ('__spx_stepx', '0.1'); registry_set ('__spx_stepy', '0.1'); <span class="hljs-keyword"><span class="hljs-keyword">drop</span></span> <span class="hljs-keyword"><span class="hljs-keyword">table</span></span> <span class="hljs-string"><span class="hljs-string">"xxx"</span></span>.<span class="hljs-string"><span class="hljs-string">"YYY"</span></span>.<span class="hljs-string"><span class="hljs-string">"total__spx"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">create</span></span> <span class="hljs-keyword"><span class="hljs-keyword">table</span></span> <span class="hljs-string"><span class="hljs-string">"xxx"</span></span>.<span class="hljs-string"><span class="hljs-string">"YYY"</span></span>.<span class="hljs-string"><span class="hljs-string">"total__spx"</span></span> ( <span class="hljs-string"><span class="hljs-string">"node_"</span></span> <span class="hljs-built_in"><span class="hljs-built_in">integer</span></span>, <span class="hljs-string"><span class="hljs-string">"tab_"</span></span> <span class="hljs-built_in"><span class="hljs-built_in">integer</span></span>, <span class="hljs-string"><span class="hljs-string">"oid_"</span></span> <span class="hljs-built_in"><span class="hljs-built_in">integer</span></span>, primary <span class="hljs-keyword"><span class="hljs-keyword">key</span></span> (<span class="hljs-string"><span class="hljs-string">"node_"</span></span>, <span class="hljs-string"><span class="hljs-string">"tab_"</span></span>, <span class="hljs-string"><span class="hljs-string">"oid_"</span></span>)); <span class="hljs-keyword"><span class="hljs-keyword">create</span></span> <span class="hljs-keyword"><span class="hljs-keyword">procedure</span></span> mp_total_spx () { <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> <span class="hljs-string"><span class="hljs-string">"node_"</span></span>, <span class="hljs-string"><span class="hljs-string">"oid_"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">"xxx"</span></span>.<span class="hljs-string"><span class="hljs-string">"YYY"</span></span>.<span class="hljs-string"><span class="hljs-string">"water-polygon__spx"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">insert</span></span> <span class="hljs-keyword"><span class="hljs-keyword">into</span></span> <span class="hljs-string"><span class="hljs-string">"xxx"</span></span>.<span class="hljs-string"><span class="hljs-string">"YYY"</span></span>.<span class="hljs-string"><span class="hljs-string">"total__spx"</span></span> (<span class="hljs-string"><span class="hljs-string">"oid_"</span></span>,<span class="hljs-string"><span class="hljs-string">"tab_"</span></span>,<span class="hljs-string"><span class="hljs-string">"node_"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">values</span></span> (<span class="hljs-string"><span class="hljs-string">"oid_"</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-string"><span class="hljs-string">"node_"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">commit</span></span> <span class="hljs-keyword"><span class="hljs-keyword">work</span></span>; } for <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> <span class="hljs-string"><span class="hljs-string">"node_"</span></span>, <span class="hljs-string"><span class="hljs-string">"oid_"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">"xxx"</span></span>.<span class="hljs-string"><span class="hljs-string">"YYY"</span></span>.<span class="hljs-string"><span class="hljs-string">"vegetation-polygon__spx"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">insert</span></span> <span class="hljs-keyword"><span class="hljs-keyword">into</span></span> <span class="hljs-string"><span class="hljs-string">"xxx"</span></span>.<span class="hljs-string"><span class="hljs-string">"YYY"</span></span>.<span class="hljs-string"><span class="hljs-string">"total__spx"</span></span> (<span class="hljs-string"><span class="hljs-string">"oid_"</span></span>,<span class="hljs-string"><span class="hljs-string">"tab_"</span></span>,<span class="hljs-string"><span class="hljs-string">"node_"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">values</span></span> (<span class="hljs-string"><span class="hljs-string">"oid_"</span></span>, <span class="hljs-number"><span class="hljs-number">2</span></span>, <span class="hljs-string"><span class="hljs-string">"node_"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">commit</span></span> <span class="hljs-keyword"><span class="hljs-keyword">work</span></span>; } for <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> <span class="hljs-string"><span class="hljs-string">"node_"</span></span>, <span class="hljs-string"><span class="hljs-string">"oid_"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">"xxx"</span></span>.<span class="hljs-string"><span class="hljs-string">"YYY"</span></span>.<span class="hljs-string"><span class="hljs-string">"highway-line__spx"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">insert</span></span> <span class="hljs-keyword"><span class="hljs-keyword">into</span></span> <span class="hljs-string"><span class="hljs-string">"xxx"</span></span>.<span class="hljs-string"><span class="hljs-string">"YYY"</span></span>.<span class="hljs-string"><span class="hljs-string">"total__spx"</span></span> (<span class="hljs-string"><span class="hljs-string">"oid_"</span></span>,<span class="hljs-string"><span class="hljs-string">"tab_"</span></span>,<span class="hljs-string"><span class="hljs-string">"node_"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">values</span></span> (<span class="hljs-string"><span class="hljs-string">"oid_"</span></span>, <span class="hljs-number"><span class="hljs-number">3</span></span>, <span class="hljs-string"><span class="hljs-string">"node_"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">commit</span></span> <span class="hljs-keyword"><span class="hljs-keyword">work</span></span>; } for <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> <span class="hljs-string"><span class="hljs-string">"node_"</span></span>, <span class="hljs-string"><span class="hljs-string">"oid_"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">"xxx"</span></span>.<span class="hljs-string"><span class="hljs-string">"YYY"</span></span>.<span class="hljs-string"><span class="hljs-string">"building-polygon__spx"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">insert</span></span> <span class="hljs-keyword"><span class="hljs-keyword">into</span></span> <span class="hljs-string"><span class="hljs-string">"xxx"</span></span>.<span class="hljs-string"><span class="hljs-string">"YYY"</span></span>.<span class="hljs-string"><span class="hljs-string">"total__spx"</span></span> (<span class="hljs-string"><span class="hljs-string">"oid_"</span></span>,<span class="hljs-string"><span class="hljs-string">"tab_"</span></span>,<span class="hljs-string"><span class="hljs-string">"node_"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">values</span></span> (<span class="hljs-string"><span class="hljs-string">"oid_"</span></span>, <span class="hljs-number"><span class="hljs-number">4</span></span>, <span class="hljs-string"><span class="hljs-string">"node_"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">commit</span></span> <span class="hljs-keyword"><span class="hljs-keyword">work</span></span>; } }; mp_total_spx ();</code> </pre>  Making a general index takes 2'16 ''.  Using cursors instead of constructions (insert ... select ...) is caused by the fact that in the OpenSource version there is a 50 MB limit on the size of a single transaction log in the log.  This restriction is easy to fix by rebuilding, but that‚Äôs another story. <br></li><li>  Now we set up work with the index in the same way as we did before <br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">create</span></span> <span class="hljs-keyword"><span class="hljs-keyword">procedure</span></span> <span class="hljs-string"><span class="hljs-string">"xxx"</span></span>.<span class="hljs-string"><span class="hljs-string">"YYY"</span></span>.<span class="hljs-string"><span class="hljs-string">"total__spx_enum_items_in_box"</span></span> ( <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> minx <span class="hljs-keyword"><span class="hljs-keyword">double</span></span> <span class="hljs-keyword"><span class="hljs-keyword">precision</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> miny <span class="hljs-keyword"><span class="hljs-keyword">double</span></span> <span class="hljs-keyword"><span class="hljs-keyword">precision</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> maxx <span class="hljs-keyword"><span class="hljs-keyword">double</span></span> <span class="hljs-keyword"><span class="hljs-keyword">precision</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> maxy <span class="hljs-keyword"><span class="hljs-keyword">double</span></span> <span class="hljs-keyword"><span class="hljs-keyword">precision</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">declare</span></span> nx, ny <span class="hljs-built_in"><span class="hljs-built_in">integer</span></span>; nx := atoi (registry_get ('__spx_nx')); ny := atoi (registry_get ('__spx_ny')); <span class="hljs-keyword"><span class="hljs-keyword">declare</span></span> startx, starty <span class="hljs-keyword"><span class="hljs-keyword">double</span></span> <span class="hljs-keyword"><span class="hljs-keyword">precision</span></span>; startx := atof (registry_get ('__spx_startx')); starty := atof (registry_get ('__spx_starty')); <span class="hljs-keyword"><span class="hljs-keyword">declare</span></span> stepx, stepy <span class="hljs-keyword"><span class="hljs-keyword">double</span></span> <span class="hljs-keyword"><span class="hljs-keyword">precision</span></span>; stepx := atof (registry_get ('__spx_stepx')); stepy := atof (registry_get ('__spx_stepy')); <span class="hljs-keyword"><span class="hljs-keyword">declare</span></span> sx, sy, fx, fy <span class="hljs-built_in"><span class="hljs-built_in">integer</span></span>; sx := cast (floor ((minx - startx)/stepx) as integer); fx := cast (floor ((maxx - startx)/stepx) as integer); sy := cast (floor ((miny - starty)/stepy) as integer); fy := cast (floor ((maxy - starty)/stepy) as integer); <span class="hljs-keyword"><span class="hljs-keyword">declare</span></span> ress <span class="hljs-keyword"><span class="hljs-keyword">any</span></span>; ress := vector(dict_new (), dict_new (), dict_new (), dict_new ()); for (<span class="hljs-keyword"><span class="hljs-keyword">declare</span></span> iy <span class="hljs-built_in"><span class="hljs-built_in">integer</span></span>, iy := sy; iy &lt;= fy; iy := iy + 1) { <span class="hljs-keyword"><span class="hljs-keyword">declare</span></span> ixf, ixt <span class="hljs-built_in"><span class="hljs-built_in">integer</span></span>; ixf := nx * iy + sx; ixt := nx * iy + fx; for <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> <span class="hljs-string"><span class="hljs-string">"node_"</span></span>, <span class="hljs-string"><span class="hljs-string">"tab_"</span></span>, <span class="hljs-string"><span class="hljs-string">"oid_"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">"xxx"</span></span>.<span class="hljs-string"><span class="hljs-string">"YYY"</span></span>.<span class="hljs-string"><span class="hljs-string">"total__spx"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> <span class="hljs-string"><span class="hljs-string">"node_"</span></span> &gt;= ixf <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> <span class="hljs-string"><span class="hljs-string">"node_"</span></span> &lt;= ixt <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> { dict_put (ress[<span class="hljs-string"><span class="hljs-string">"tab_"</span></span> - <span class="hljs-number"><span class="hljs-number">1</span></span>], <span class="hljs-string"><span class="hljs-string">"oid_"</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>); } } result_names('oid', 'tab'); <span class="hljs-keyword"><span class="hljs-keyword">declare</span></span> ix <span class="hljs-built_in"><span class="hljs-built_in">integer</span></span>; for (ix := 0; ix &lt; 4; ix := ix + 1) { <span class="hljs-keyword"><span class="hljs-keyword">declare</span></span> arr <span class="hljs-keyword"><span class="hljs-keyword">any</span></span>; arr := dict_list_keys (ress[ix], 1); gvector_digit_sort (arr, 1, 0, 1); foreach (integer oid in arr) <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">result</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">oid</span></span>, ix + <span class="hljs-number"><span class="hljs-number">1</span></span>); } } }; <span class="hljs-keyword"><span class="hljs-keyword">create</span></span> <span class="hljs-keyword"><span class="hljs-keyword">procedure</span></span> <span class="hljs-keyword"><span class="hljs-keyword">view</span></span> <span class="hljs-string"><span class="hljs-string">"xxx"</span></span>.<span class="hljs-string"><span class="hljs-string">"YYY"</span></span>.<span class="hljs-string"><span class="hljs-string">"v_total__spx_enum_items_in_box"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> <span class="hljs-string"><span class="hljs-string">"xxx"</span></span>.<span class="hljs-string"><span class="hljs-string">"YYY"</span></span>.<span class="hljs-string"><span class="hljs-string">"total__spx_enum_items_in_box"</span></span> (minx, miny, maxx, maxy) (<span class="hljs-string"><span class="hljs-string">"oid"</span></span> <span class="hljs-built_in"><span class="hljs-built_in">integer</span></span>, <span class="hljs-string"><span class="hljs-string">"tab"</span></span> <span class="hljs-built_in"><span class="hljs-built_in">integer</span></span>);</code> </pre><br></li><li>  We check the correctness of the work: <pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">select</span></span> <span class="hljs-keyword"><span class="hljs-keyword">count</span></span>(*) <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">"xxx"</span></span>.<span class="hljs-string"><span class="hljs-string">"YYY"</span></span>.<span class="hljs-string"><span class="hljs-string">"v_total__spx_enum_items_in_box"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> a <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> a.minx = <span class="hljs-number"><span class="hljs-number">82.963</span></span> <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> a.miny = <span class="hljs-number"><span class="hljs-number">54.9866</span></span> <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> a.maxx = <span class="hljs-number"><span class="hljs-number">82.98997</span></span> <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> a.maxy = <span class="hljs-number"><span class="hljs-number">55.0133</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> <span class="hljs-keyword"><span class="hljs-keyword">count</span></span>(*) <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">"xxx"</span></span>.<span class="hljs-string"><span class="hljs-string">"YYY"</span></span>.<span class="hljs-string"><span class="hljs-string">"v_vegetation-polygon_spx_enum_items_in_box"</span></span> ... <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> <span class="hljs-keyword"><span class="hljs-keyword">count</span></span>(*) <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">"xxx"</span></span>.<span class="hljs-string"><span class="hljs-string">"YYY"</span></span>.<span class="hljs-string"><span class="hljs-string">"v_water-polygon_spx_enum_items_in_box"</span></span> ... <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> <span class="hljs-keyword"><span class="hljs-keyword">count</span></span>(*) <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">"xxx"</span></span>.<span class="hljs-string"><span class="hljs-string">"YYY"</span></span>.<span class="hljs-string"><span class="hljs-string">"v_building-polygon_spx_enum_items_in_box"</span></span> ... <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> <span class="hljs-keyword"><span class="hljs-keyword">count</span></span>(*) <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">"xxx"</span></span>.<span class="hljs-string"><span class="hljs-string">"YYY"</span></span>.<span class="hljs-string"><span class="hljs-string">"v_highway-line_spx_enum_items_in_box"</span></span> ...</code> </pre>  The first request returned 29158, the rest: 941 + 33 + 20131 + 8053. Matches. </li></ul><br><h4>  <b>We measure the performance of the index.</b> </h4><br>  We will launch a series of 10,000 random searches in the square [35 ... 45.50 ... 60] ¬∞ on the general index and in the old way.  All requests are executed in one connection i.  show performance on one core. <br><table><tbody><tr><th>  Request size </th><th>  Time in a single index </th><th>  Time as before </th></tr><tr><td>  0.01 ¬∞ </td><td>  7'35 '' </td><td>  8'26 '' </td></tr><tr><td>  0.1 ¬∞ </td><td>  8'25 '' </td><td>  9'20 '' </td></tr><tr><td>  0.5 ¬∞ </td><td>  15'11 " </td><td>  16'7 " </td></tr></tbody></table>  <b>Conclusion</b> : yes, a single index is faster, but the result is not amazing.  On the other hand, all 4 of our layers are relatively densely populated, again, it is important that the amount of data is relatively small so that all the advantages of a single search should stand up to their full height.  On the third hand, this is live data as it is. <br><br><h4>  <b>Draw a map</b> </h4><br>  First of all, let's draw it in the <b>old way</b> so that it can be compared with anything. <br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">create</span></span> <span class="hljs-keyword"><span class="hljs-keyword">procedure</span></span> mk_test_gif( <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> cminx <span class="hljs-keyword"><span class="hljs-keyword">double</span></span> <span class="hljs-keyword"><span class="hljs-keyword">precision</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> cminy <span class="hljs-keyword"><span class="hljs-keyword">double</span></span> <span class="hljs-keyword"><span class="hljs-keyword">precision</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> cmaxx <span class="hljs-keyword"><span class="hljs-keyword">double</span></span> <span class="hljs-keyword"><span class="hljs-keyword">precision</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> cmaxy <span class="hljs-keyword"><span class="hljs-keyword">double</span></span> <span class="hljs-keyword"><span class="hljs-keyword">precision</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">declare</span></span> img <span class="hljs-keyword"><span class="hljs-keyword">any</span></span>; img := img_create (512, 512, cminx, cminy, cmaxx, cmaxy, 1); <span class="hljs-keyword"><span class="hljs-keyword">declare</span></span> cl <span class="hljs-built_in"><span class="hljs-built_in">integer</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">declare</span></span> bg <span class="hljs-built_in"><span class="hljs-built_in">integer</span></span>; { cl := img_alloc_color (img, 0, 0, 255); bg := img_alloc_color (img, 0, 0, 255); whenever not found goto nf; for <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> blob_to_string(Shape) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> <span class="hljs-keyword"><span class="hljs-keyword">data</span></span> <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> xxx.YYY.<span class="hljs-string"><span class="hljs-string">"water-polygon"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> x, xxx.YYY.<span class="hljs-string"><span class="hljs-string">"v_water-polygon_spx_enum_items_in_box"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> a <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> a.minx = cminx <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> a.miny = cminy <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> a.maxx = cmaxx <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> a.maxy = cmaxy <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> x.<span class="hljs-string"><span class="hljs-string">"_OBJECTID_"</span></span> = a.oid <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> x.maxx_ &gt;= cminx <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> x.minx_ &lt;= cmaxx <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> x.maxy_ &gt;= cminy <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> x.miny_ &lt;= cmaxy <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> { img_draw_polygone (img, <span class="hljs-keyword"><span class="hljs-keyword">data</span></span>, cl, bg); } nf:; ...      ,    img_draw_polyline. ... } <span class="hljs-keyword"><span class="hljs-keyword">declare</span></span> ptr <span class="hljs-built_in"><span class="hljs-built_in">integer</span></span>; ptr := img_tostr (img); img_destroy (img); <span class="hljs-keyword"><span class="hljs-keyword">declare</span></span> image <span class="hljs-keyword"><span class="hljs-keyword">any</span></span>; image := img_fromptr(ptr); string_to_file('test.gif', image, -2); return; }; mk_test_gif(35., 50., 45., 60.);</code> </pre>  Work takes 17.2 seconds. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Now as it is promised, one.  The first thing that comes to mind <br>  <b>aggregates</b> . <br>  An aggregate is an object that is created when the cursor is opened, called on each line of the result, and finalized when the cursor is closed. <br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">create</span></span> <span class="hljs-keyword"><span class="hljs-keyword">function</span></span> mapx_agg_init (inout _agg <span class="hljs-keyword"><span class="hljs-keyword">any</span></span>) {;}; <span class="hljs-keyword"><span class="hljs-keyword">create</span></span> <span class="hljs-keyword"><span class="hljs-keyword">function</span></span> mapx_agg_acc ( inout _agg <span class="hljs-keyword"><span class="hljs-keyword">any</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> _tab <span class="hljs-built_in"><span class="hljs-built_in">integer</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> _oid <span class="hljs-built_in"><span class="hljs-built_in">integer</span></span> ) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (_agg <span class="hljs-keyword"><span class="hljs-keyword">is</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">declare</span></span> img <span class="hljs-keyword"><span class="hljs-keyword">any</span></span>; img := img_create (512, 512, _tab[0], _tab[1], _tab[2], _tab[3], 1); _agg := img; return 0; } else { return case when _tab = 4 then (img_draw_polygone(_agg, ( <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> blob_to_string(bl.Shape) <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">"xxx"</span></span>.<span class="hljs-string"><span class="hljs-string">"YYY"</span></span>.<span class="hljs-string"><span class="hljs-string">"building-polygon"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> bl <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> bl.<span class="hljs-string"><span class="hljs-string">"_OBJECTID_"</span></span> = _oid), <span class="hljs-number"><span class="hljs-number">255</span></span>, <span class="hljs-number"><span class="hljs-number">255</span></span>)) <span class="hljs-keyword"><span class="hljs-keyword">when</span></span> _tab = <span class="hljs-number"><span class="hljs-number">3</span></span> <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> (img_draw_polyline(_agg, ( <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> blob_to_string(hw.Shape) <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">"xxx"</span></span>.<span class="hljs-string"><span class="hljs-string">"YYY"</span></span>.<span class="hljs-string"><span class="hljs-string">"highway-line"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> hw <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> hw.<span class="hljs-string"><span class="hljs-string">"_OBJECTID_"</span></span> = _oid), <span class="hljs-number"><span class="hljs-number">100</span></span>, <span class="hljs-number"><span class="hljs-number">100</span></span>)) <span class="hljs-keyword"><span class="hljs-keyword">when</span></span> _tab = <span class="hljs-number"><span class="hljs-number">2</span></span> <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> (img_draw_polygone(_agg, ( <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> blob_to_string(vg.Shape) <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">"xxx"</span></span>.<span class="hljs-string"><span class="hljs-string">"YYY"</span></span>.<span class="hljs-string"><span class="hljs-string">"vegetation-polygon"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> vg <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> vg.<span class="hljs-string"><span class="hljs-string">"_OBJECTID_"</span></span> = _oid), <span class="hljs-number"><span class="hljs-number">10</span></span>, <span class="hljs-number"><span class="hljs-number">10</span></span>)) <span class="hljs-keyword"><span class="hljs-keyword">when</span></span> _tab = <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> (img_draw_polygone(_agg, ( <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> blob_to_string(wt.Shape) <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">"xxx"</span></span>.<span class="hljs-string"><span class="hljs-string">"YYY"</span></span>.<span class="hljs-string"><span class="hljs-string">"water-polygon"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> wt <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> wt.<span class="hljs-string"><span class="hljs-string">"_OBJECTID_"</span></span> = _oid), <span class="hljs-number"><span class="hljs-number">50</span></span>, <span class="hljs-number"><span class="hljs-number">50</span></span>)) <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">end</span></span>; } }; <span class="hljs-keyword"><span class="hljs-keyword">create</span></span> <span class="hljs-keyword"><span class="hljs-keyword">function</span></span> mapx_agg_final (inout _agg <span class="hljs-keyword"><span class="hljs-keyword">any</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">returns</span></span> <span class="hljs-built_in"><span class="hljs-built_in">integer</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">declare</span></span> ptr <span class="hljs-built_in"><span class="hljs-built_in">integer</span></span>; ptr := img_tostr (_agg); img_destroy (_agg); <span class="hljs-keyword"><span class="hljs-keyword">declare</span></span> image <span class="hljs-keyword"><span class="hljs-keyword">any</span></span>; image := img_fromptr(ptr); string_to_file('nskx_ii.gif', image, -2); return 1; }; <span class="hljs-keyword"><span class="hljs-keyword">create</span></span> <span class="hljs-keyword"><span class="hljs-keyword">aggregate</span></span> mapx_agg (<span class="hljs-keyword"><span class="hljs-keyword">in</span></span> _tab <span class="hljs-built_in"><span class="hljs-built_in">integer</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> _oid <span class="hljs-built_in"><span class="hljs-built_in">integer</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">returns</span></span> <span class="hljs-built_in"><span class="hljs-built_in">integer</span></span> <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> mapx_agg_init, mapx_agg_acc, mapx_agg_final; <span class="hljs-keyword"><span class="hljs-keyword">create</span></span> <span class="hljs-keyword"><span class="hljs-keyword">procedure</span></span> mk_testx_ii_gif( <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> cminx <span class="hljs-keyword"><span class="hljs-keyword">double</span></span> <span class="hljs-keyword"><span class="hljs-keyword">precision</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> cminy <span class="hljs-keyword"><span class="hljs-keyword">double</span></span> <span class="hljs-keyword"><span class="hljs-keyword">precision</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> cmaxx <span class="hljs-keyword"><span class="hljs-keyword">double</span></span> <span class="hljs-keyword"><span class="hljs-keyword">precision</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> cmaxy <span class="hljs-keyword"><span class="hljs-keyword">double</span></span> <span class="hljs-keyword"><span class="hljs-keyword">precision</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">declare</span></span> cnt <span class="hljs-built_in"><span class="hljs-built_in">integer</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> mapx_agg(tab, <span class="hljs-keyword"><span class="hljs-keyword">oid</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">into</span></span> cnt <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> ( <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">select</span></span> vector(cminx, cminy, cmaxx, cmaxy) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> tab, <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> <span class="hljs-keyword"><span class="hljs-keyword">oid</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> f1 <span class="hljs-keyword"><span class="hljs-keyword">union</span></span> all (<span class="hljs-keyword"><span class="hljs-keyword">select</span></span> tab, <span class="hljs-keyword"><span class="hljs-keyword">oid</span></span> <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> xxx.YYY.<span class="hljs-string"><span class="hljs-string">"v_total__spx_enum_items_in_box"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> a <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> a.minx = cminx <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> a.miny = cminy <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> a.maxx = cmaxx <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> a.maxy = cmaxy) ) f_all; } mk_testx_ii_gif(35., 50., 45., 60.);</code> </pre>  Unfortunately, there is no regular method to pass the initialization parameters to the aggregate, so you have to go for the trick, slip the union from the data and the initialization string to it, construct the context not in the constructor, but when you get the first string. <br>  How so, the attentive reader will say, one select was promised, and there a whole bunch of them!  In fact, the row identifiers come to the aggregate in an orderly and tablely manner, so seeming subqueries are in fact hand-organized join. <br>  So, the running time is 42 seconds.  NDA <br><br>  <b>Another attempt</b> <br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">create</span></span> <span class="hljs-keyword"><span class="hljs-keyword">procedure</span></span> mk_testx_gif( <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> cminx <span class="hljs-keyword"><span class="hljs-keyword">double</span></span> <span class="hljs-keyword"><span class="hljs-keyword">precision</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> cminy <span class="hljs-keyword"><span class="hljs-keyword">double</span></span> <span class="hljs-keyword"><span class="hljs-keyword">precision</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> cmaxx <span class="hljs-keyword"><span class="hljs-keyword">double</span></span> <span class="hljs-keyword"><span class="hljs-keyword">precision</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> cmaxy <span class="hljs-keyword"><span class="hljs-keyword">double</span></span> <span class="hljs-keyword"><span class="hljs-keyword">precision</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">declare</span></span> img <span class="hljs-keyword"><span class="hljs-keyword">any</span></span>; img := img_create (512, 512, cminx, cminy, cmaxx, cmaxy, 1); <span class="hljs-keyword"><span class="hljs-keyword">declare</span></span> cnt, cnt2 <span class="hljs-built_in"><span class="hljs-built_in">integer</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">declare</span></span> cl1, bg1 <span class="hljs-built_in"><span class="hljs-built_in">integer</span></span>; cl1 := img_alloc_color (img, 0, 0, 255); bg1 := img_alloc_color (img, 0, 0, 255); <span class="hljs-keyword"><span class="hljs-keyword">declare</span></span> cl2, bg2 <span class="hljs-built_in"><span class="hljs-built_in">integer</span></span>; cl2 := img_alloc_color (img, 0, 255, 0); bg2 := img_alloc_color (img, 0, 255, 0); <span class="hljs-keyword"><span class="hljs-keyword">declare</span></span> cl3, bg3 <span class="hljs-built_in"><span class="hljs-built_in">integer</span></span>; cl3 := img_alloc_color (img, 255, 100, 0); bg3 := img_alloc_color (img, 255, 100, 0); <span class="hljs-keyword"><span class="hljs-keyword">declare</span></span> cl4, bg4 <span class="hljs-built_in"><span class="hljs-built_in">integer</span></span>; cl4 := img_alloc_color (img, 255, 0, 0); bg4 := img_alloc_color (img, 255, 0, 0); <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> <span class="hljs-keyword"><span class="hljs-keyword">sum</span></span> ( <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-keyword"><span class="hljs-keyword">when</span></span> geom <span class="hljs-keyword"><span class="hljs-keyword">is</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span> <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">when</span></span> geom_type = <span class="hljs-number"><span class="hljs-number">2</span></span> <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> (img_draw_polyline(img, geom, cl, bg)) <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> (img_draw_polygone(img, geom, cl, bg)) <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> ) <span class="hljs-keyword"><span class="hljs-keyword">into</span></span> cnt <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> ( <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-keyword"><span class="hljs-keyword">when</span></span> a.tab = <span class="hljs-number"><span class="hljs-number">4</span></span> <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> ( <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> blob_to_string(bl.Shape) <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">"xxx"</span></span>.<span class="hljs-string"><span class="hljs-string">"YYY"</span></span>.<span class="hljs-string"><span class="hljs-string">"building-polygon"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> bl <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> bl.<span class="hljs-string"><span class="hljs-string">"_OBJECTID_"</span></span> = a.oid) <span class="hljs-keyword"><span class="hljs-keyword">when</span></span> a.tab = <span class="hljs-number"><span class="hljs-number">3</span></span> <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> ( <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> blob_to_string(hw.Shape) <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">"xxx"</span></span>.<span class="hljs-string"><span class="hljs-string">"YYY"</span></span>.<span class="hljs-string"><span class="hljs-string">"highway-line"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> hw <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> hw.<span class="hljs-string"><span class="hljs-string">"_OBJECTID_"</span></span> = a.oid) <span class="hljs-keyword"><span class="hljs-keyword">when</span></span> a.tab = <span class="hljs-number"><span class="hljs-number">2</span></span> <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> ( <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> blob_to_string(vg.Shape) <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">"xxx"</span></span>.<span class="hljs-string"><span class="hljs-string">"YYY"</span></span>.<span class="hljs-string"><span class="hljs-string">"vegetation-polygon"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> vg <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> vg.<span class="hljs-string"><span class="hljs-string">"_OBJECTID_"</span></span> = a.oid) <span class="hljs-keyword"><span class="hljs-keyword">when</span></span> a.tab = <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> ( <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> blob_to_string(wt.Shape) <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">"xxx"</span></span>.<span class="hljs-string"><span class="hljs-string">"YYY"</span></span>.<span class="hljs-string"><span class="hljs-string">"water-polygon"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> wt <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> wt.<span class="hljs-string"><span class="hljs-string">"_OBJECTID_"</span></span> = a.oid) <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-string"><span class="hljs-string">''</span></span> <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> geom, <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-keyword"><span class="hljs-keyword">when</span></span> a.tab = <span class="hljs-number"><span class="hljs-number">3</span></span> <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> <span class="hljs-number"><span class="hljs-number">2</span></span> <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> geom_type, <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-keyword"><span class="hljs-keyword">when</span></span> a.tab = <span class="hljs-number"><span class="hljs-number">4</span></span> <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> cl4 <span class="hljs-keyword"><span class="hljs-keyword">when</span></span> a.tab = <span class="hljs-number"><span class="hljs-number">3</span></span> <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> cl3 <span class="hljs-keyword"><span class="hljs-keyword">when</span></span> a.tab = <span class="hljs-number"><span class="hljs-number">2</span></span> <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> cl2 <span class="hljs-keyword"><span class="hljs-keyword">when</span></span> a.tab = <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> cl1 <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> cl, <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-keyword"><span class="hljs-keyword">when</span></span> a.tab = <span class="hljs-number"><span class="hljs-number">4</span></span> <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> bg4 <span class="hljs-keyword"><span class="hljs-keyword">when</span></span> a.tab = <span class="hljs-number"><span class="hljs-number">3</span></span> <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> bg3 <span class="hljs-keyword"><span class="hljs-keyword">when</span></span> a.tab = <span class="hljs-number"><span class="hljs-number">2</span></span> <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> bg2 <span class="hljs-keyword"><span class="hljs-keyword">when</span></span> a.tab = <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> bg1 <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> bg <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> xxx.YYY.<span class="hljs-string"><span class="hljs-string">"v_total__spx_enum_items_in_box"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> a <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> a.minx = cminx <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> a.miny = cminy <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> a.maxx = cmaxx <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> a.maxy = cmaxy ) f_all; <span class="hljs-keyword"><span class="hljs-keyword">declare</span></span> ptr <span class="hljs-built_in"><span class="hljs-built_in">integer</span></span>; ptr := img_tostr (img); img_destroy (img); <span class="hljs-keyword"><span class="hljs-keyword">declare</span></span> image <span class="hljs-keyword"><span class="hljs-keyword">any</span></span>; image := img_fromptr(ptr); string_to_file('testx.gif', image, -2); return; }; mk_testx_gif(35., 50., 45., 60.);</code> </pre>  This query runs 17.4 seconds.  Thus, the optimizer was able to recognize hidden join'y and execute the query without any loss for beauty.  A small gain in the actual index was eaten by the increased complexity of the query. <br><br>  And here is the result: <br><img src="http://habrastorage.org/storage3/2a9/f64/68d/2a9f6468d545504a0ed7c339e88ac209.gif" alt="image"><br>  In this nondescript image several million objects. <br><br><h4>  <b>findings</b> </h4><br>  Drawing a map in one query is not difficult.  We even managed to do it without losing much performance.  Win, however, also failed and the reason seems in the data structure.  And this structure is sharpened by the use of traditional GIS. <br><br>  For example, the 'highway-line' table contains a couple of dozen layers of different types with different attributes.  Usually, such tables serve as the basis for all road layers that refer to one physical table and differ in filters.  Of course, it is more convenient to work with one table than with two dozen (this moment was one of the motives for this work).  Again, we have a common spatial index for you of these layers. <br><br>  But there are also disadvantages.  As before, to draw each layer, you need to execute a separate SQL query.  Those.  even though there is one index, there are still several searches for it.  The maximum you can win on is on page caching.  An additional index is needed - a record type; it is also required to search by it and cross the samples.  In addition, since objects of different types are intermixed, there is little chance that objects of the same type will be side by side (on the same page) and thus the total number of readings increases. <br><br>  What if we scatter, for example, a 'highway-line' table on a bunch of sub-tables by type and combine all of them into one spatial index, as we did above?  Working with the index will not change, we will need only one search in it.  Working with data will only accelerate.  data locality will increase - data of the same type, close spatially more often appear next to the disk.  And if the data of any type is not in the search extent, they simply will not be processed.  No matter how many of them, it will not affect the reading of useful data. <br><br>  And one more observation at the end.  Indexes as such are pretty odd objects.  Neither in relational algebra nor in relational calculus are they close to them.  This is an implementation-dependent extension that allows the query processor to execute them more efficiently.  In our case, the indices are loaded with some semantics, which is not in the data.  In our multi-table index, the relationships between the layers are described, in fact, the layers that we want to draw together turn out to be in a specific index. <br><br>  On the other hand, we cannot perceive our index as a table (although in fact it is a table, it is a forced measure due to the fact that we are forced to remain within the framework of a specific DBMS) because  its values ‚Äã‚Äãare table identifiers.  This is a metatable and the query plan depends on the metadata from this one. <br><br>  Again, traditionally, the query processor is free to choose which indices to use.  But this is not our case.  We can create multiple multi-table indexes and explicitly indicate which index is the source of the primary data stream.  Regardless of what the optimizer thinks about this.  It is nice to see how the ‚Äútree of life is forever green‚Äù through the ‚Äúdry theory‚Äù of the relational model. <br><br><h4>  <b>PS:</b> </h4>  <i>As an illustration, the marvelous "city plan of Paris" by Mark Twain‚Äôs hand from the story of the same name was used in the article‚Äôs cap.</i> </div><p>Source: <a href="https://habr.com/ru/post/201474/">https://habr.com/ru/post/201474/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../201462/index.html">Ten names for one architecture</a></li>
<li><a href="../201466/index.html">What to do if you are a startup. BetaList, Indiegogo and more</a></li>
<li><a href="../201468/index.html">AngularJS 1.2.0: Timely Delivery</a></li>
<li><a href="../201470/index.html">Programming Language J. Why love?</a></li>
<li><a href="../201472/index.html">rusEfi: opensource DIY injector project</a></li>
<li><a href="../201486/index.html">Google says ‚ÄúF * ck You, NSA‚Äù and starts encrypting traffic between data centers</a></li>
<li><a href="../201490/index.html">We create the first application on NancyFX. Part Five. Super Simple View Engine</a></li>
<li><a href="../201492/index.html">3 myths about management</a></li>
<li><a href="../201494/index.html">Microsoft CEO candidate Stephen Elop may be considering selling Xbox and closing Bing</a></li>
<li><a href="../201496/index.html">Product management: from a good idea to the appropriate feature</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>