<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Transparent bypass in home network</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="The latest news has once again highlighted the problem of blocking Internet resources. On the one hand , much has been written about ways to circumven...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Transparent bypass in home network</h1><div class="post__text post__text-html js-mediator-article">  The latest news has once again highlighted the problem of blocking Internet resources.  On the one hand <a href="http://rutracker.wiki/%25D0%259A%25D0%25B0%25D0%25BA_%25D0%25BE%25D0%25B1%25D0%25BE%25D0%25B9%25D1%2582%25D0%25B8_%25D0%25B1%25D0%25BB%25D0%25BE%25D0%25BA%25D0%25B8%25D1%2580%25D0%25BE%25D0%25B2%25D0%25BA%25D1%2583_%25D1%2581%25D0%25B0%25D0%25B9%25D1%2582%25D0%25B0_%25D0%25BF%25D1%2580%25D0%25BE%25D0%25B2%25D0%25B0%25D0%25B9%25D0%25B4%25D0%25B5%25D1%2580%25D0%25BE%25D0%25BC">,</a> <a href="http://rublacklist.net/bypass/">much has been</a> <a href="http://rutracker.wiki/%25D0%259A%25D0%25B0%25D0%25BA_%25D0%25BE%25D0%25B1%25D0%25BE%25D0%25B9%25D1%2582%25D0%25B8_%25D0%25B1%25D0%25BB%25D0%25BE%25D0%25BA%25D0%25B8%25D1%2580%25D0%25BE%25D0%25B2%25D0%25BA%25D1%2583_%25D1%2581%25D0%25B0%25D0%25B9%25D1%2582%25D0%25B0_%25D0%25BF%25D1%2580%25D0%25BE%25D0%25B2%25D0%25B0%25D0%25B9%25D0%25B4%25D0%25B5%25D1%2580%25D0%25BE%25D0%25BC">written</a> <a href="http://habrahabr.ru/post/219623/">about ways to circumvent them</a> , and once again it would seem to chew on this topic once again.  On the other hand, to take some additional actions regularly to visit the necessary resource is not quite what the IT person should satisfy (and not always what a person can cope with to find a long time). <br><br>  We need a simple and transparent solution for users, which, once set up, will allow us to simply use the Internet, without thinking about what has been blocked today at the request of the next <a href="http://geektimes.ru/post/265514/">copyist plagiarists</a> . <br><br>  By itself, it begs the idea of ‚Äã‚Äãbypassing the lock already on the home router. <br><a name="habracut"></a><br>  Actually, it‚Äôs easy to pick up on a router and drive all traffic through VPN, and some VPN providers even have step-by-step instructions on how to configure OpenWrt to work with them. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      But the speed of VPN services still lags behind the speeds of Internet access, and the VPN service either costs money, or has a lot of restrictions, or the need to regularly receive new logins.  From the point of view of cost optimization, both financial and temporary, Tor looks preferable, but its speed is even worse, and it‚Äôs not the best idea to drive torrents through Tor. <br><br>  Exit - redirect only blocked resources to VPN / Tor, passing the rest in the usual way. <br><br>  <b>Attention: this scheme does not provide anonymity of viewing blocked sites: any external link reveals your real IP.</b> <br><br>  A specific implementation on OpenWrt is provided at the end of the article.  If you are not interested in the details and alternative solutions, then you can scroll right before her. <br><br><h4>  Tunneling and forwarding traffic to the tunnel </h4><br>  Setting up a VPN or Tor should not be difficult.  Tor should be configured as a transparent proxy (or configure a bunch of tor and <a href="https://code.google.com/p/badvpn/wiki/tun2socks">tun2socks</a> ).  Since  the final goal is to bypass pkn locks, then in Tor's config it is advisable to prohibit the use of output nodes in the territory of the Russian Federation ( <code>&lt;ExcludeExitNodes {RU}</code> ). <br><br>  In Tor, the traffic is redirected by the rule with <code>REDIRECT</code> to the transparent proxy port in the <code>PREROUTING</code> the <code>nat</code> netfilter table. <br><br>  For redirecting to VPN (or Tor + tun2socks), traffic is marked in the <code>mangle</code> table, the label is then used to <a href="http://habrahabr.ru/post/108690/">select the routing table</a> that redirects traffic to the appropriate interface. <br>  In both cases, to classify traffic, <code>ipset</code> used with hosts that are (once) blocked. <br><br><h4>  Formation of <code>ipset</code> with (times) blocked hosts </h4><br>  Unfortunately, the option ‚Äúdrive all IPs from the registry‚Äù in ipset does not work as we would like: firstly, the lists do not contain all IP addresses of blocked hosts, secondly, in an attempt to escape from blocking, the resource‚Äôs IP address may change (and the provider he already knows this, but we don‚Äôt yet), well, in the third, there are false positives for sites located on the same shared hosting. <br><br>  I do not really want to fuss with a dpi of one kind or another: after all, this should work on a rather weak hardware.  The output is quite simple and to some extent elegant: dnsmasq (the DNS server that is most likely already installed on the router) can add ip-addresses to the corresponding ipset when resolving names (the option of the same name in the config).  Just what you need: we put in the config all the domains that need to be unblocked, and further, if necessary, dnsmasq itself adds to ipset exactly the ip address that will be used to access the blocked resource. <br><br>  I had doubts that dnsmasq would start and work normally with a config of half a dozen thousand lines (about as many entries in the registry after shrinking and tuning), but fortunately they turned out to be unfounded. <br><br>  The fly in the ointment is that when updating the dnsmasq list you will have to restart, because  by SIGHUP it config does not overload. <br><br><h4>  List domains </h4><br>  Should happen automatically as far as possible. <br><br>  The first option (which is implemented in the example): create a list based on a single register of locks and update it by cron. <br>  Roskomnadzor does not provide the general public with a register of locks, but the world is not without good people and there are at least <a href="http://reestr.rublacklist.net/">two</a> <a href="http://antizapret.info/">resources</a> where it can be found.  And, which is great, they also have an API.  When parsing the list, you need to consider that <i>in the list of domain names,</i> in addition to the actual domain names, there are also IP addresses.  They need to be processed separately (or even score on them: they are about 0.1% of the list and they are unlikely to lead to the resources you are interested in).  Cyrillic domains are not always represented in punycode.  A considerable part of the list is occupied by subdomains on the same second-level domain, there are domains with www / without www and simply duplicate entries.  All of the above relates more to the list from rublacklist.net (it is also strange, in some places incorrectly, screened).  It was for him that the monster lua-script (given below) had to be fenced in, normalizing and compressing the list almost twice.  With antizapret.info, the situation is much better and one would be able to get along with an awk. <br><br>  You can go the other way: many providers, when accessing a blocked resource, are redirected to the access restriction stub.  For example <code>http://block.mts.ru/?host=/host/&amp;url=/url/&amp;params=/params/</code> .  By <code>address=/block.mts.ru/192.168.1.1</code> the same dnsmasq ( <code>address=/block.mts.ru/192.168.1.1</code> ) with the A-record <i>block.mts.ru</i> to the address of the web server of the router (and placing a simple script on it), you can locally generate a list of the requested network users resources, add them to the dnsmasq config, re-do nslookup (so that the ip address is added to ipset) and redirect the user to the original URL again.  But the need to restart dnsmasq every time is somewhat dampening.  Yes, and will work only for http. <br><br>  Now about another fly in the ointment: some providers have been noticed for the fact that in addition to the sites included in the list of sites, they are self-blocking and are not officially listed in the lists.  At the same time, they block by sly and do not remove the plugs.  So absolutely not to do without the manual drive. <br><br><h4>  Additional Notes </h4><br>  ISP's DNS servers are naturally not worth being used as upstream servers.  For blocking can occur at the stage of resource name resolution.  Give the provider's server to the desired address, that this is CNAME block.mts.ru and that's it.  The simplest solution is <code>server=8.8.8.8, server=8.8.4.4</code> .  I haven‚Äôt yet seen modifications by providers of third-party DNS servers.  If they start, you can send domain requests from the forbidden list to another upstream (via VPN / Tor), but without need I wouldn‚Äôt have inflated the config. <br><br>  When using Tor, you can get a bonus on surfing on .onion sites: Tor, when resolving a name via the built-in dns server, maps it to a virtual address from a predetermined range.  Then you only need to redirect the call to this address to Tor's and voila's proxies.  But once again I remind you that the connection with selective traffic tunneling does not provide anonymity. <br><br><h4>  Implementation on OpenWrt (15.05) </h4><br>  The router itself should not be the worst, especially when using Tor.  MIPS 400MHz @ 32MB RAM is the minimum worth considering. <br><br>  If there is a USB port, the lack of a built-in flash <a href="https://wiki.openwrt.org/doc/howto/extroot">can be compensated by a USB flash drive</a> (in general, it seems to me a sensible idea not to use the built-in flash for regularly rewritable data). <br><br>  Normally, OpenWrt firmware contains a stripped-down dnsmasq, which cannot ipset.  You need to replace it with <i>dnsmasq-full</i> . <br><br>  Of the packages that are not present by default, <i>ipset</i> , <i>tor</i> and <i>tor-geoip</i> are also required. <br>  You also need either the <i>luasocket</i> package, or (in the strict saving flash mode) separately <a href="">ltn12.lua</a> in the / usr / lib / lua folder.  To convert Cyrillic domains from utf8 to punycode, you need <a href="">idn.lua</a> to / usr / lib / lua and the <i>luabitop</i> package (or disable the options in the script config). <br><br><h6>  Script update block lists </h6><br><div class="spoiler">  <b class="spoiler_title">/usr/bin/rublupdate.lua</b> <div class="spoiler_text"><pre> <code class="lua hljs"><span class="hljs-keyword"><span class="hljs-keyword">local</span></span> <span class="hljs-built_in"><span class="hljs-built_in">config</span></span> = { blSource = <span class="hljs-string"><span class="hljs-string">"antizapret"</span></span>, <span class="hljs-comment"><span class="hljs-comment">-- antizapret  rublacklist groupBySld = 32, --             neverGroupMasks = { "^%a%a%a?.%a%a$" }, --    org.ru, net.ua   neverGroupDomains = { ["livejournal.com"] = true, ["facebook.com"] = true , ["vk.com"] = true }, stripWww = true, convertIdn = true, torifyNsLookups = false, --  DNS     TOR blMinimumEntries = 1000, --     ,  -        dnsmasqConfigPath = "/etc/runblock/runblock.dnsmasq", ipsetConfigPath = "/etc/runblock/runblock.ipset", ipsetDns = "rublack-dns", ipsetIp = "rublack-ip", torDnsAddr = "127.0.0.1#9053" } local function prequire(package) local result, err = pcall(function() require(package) end) if not result then return nil, err end return require(package) -- return the package value end local idn = prequire("idn") if (not idn) and (config.convertIdn) then error("you need either put idn.lua (github.com/haste/lua-idn) in script dir or set 'convertIdn' to false") end local http = prequire("socket.http") if not http then local ltn12 = require("ltn12") end if not ltn12 then error("you need either install luasocket package (prefered) or put ltn12.lua in script dir") end local function hex2unicode(code) local n = tonumber(code, 16) if (n &lt; 128) then return string.char(n) elseif (n &lt; 2048) then return string.char(192 + ((n - (n % 64)) / 64), 128 + (n % 64)) else return string.char(224 + ((n - (n % 4096)) / 4096), 128 + (((n % 4096) - (n % 64)) / 64), 128 + (n % 64)) end end local function rublacklistExtractDomains() local currentRecord = "" local buffer = "" local bufferPos = 1 local streamEnded = false return function(chunk) local retVal = "" if chunk == nil then streamEnded = true else buffer = buffer .. chunk end while true do local escapeStart, escapeEnd, escapedChar = buffer:find("\\(.)", bufferPos) if escapedChar then currentRecord = currentRecord .. buffer:sub(bufferPos, escapeStart - 1) bufferPos = escapeEnd + 1 if escapedChar == "n" then retVal = currentRecord break elseif escapedChar == "u" then currentRecord = currentRecord .. "\\u" else currentRecord = currentRecord .. escapedChar end else currentRecord = currentRecord .. buffer:sub(bufferPos, #buffer) buffer = "" bufferPos = 1 if streamEnded then if currentRecord == "" then retVal = nil else retVal = currentRecord end end break end end if retVal and (retVal ~= "") then currentRecord = "" retVal = retVal:match("^[^;]*;([^;]+);[^;]*;[^;]*;[^;]*;[^;]*.*$") if retVal then retVal = retVal:gsub("\\u(%x%x%x%x)", hex2unicode) else retVal = "" end end return (retVal) end end local function antizapretExtractDomains() local currentRecord = "" local buffer = "" local bufferPos = 1 local streamEnded = false return function(chunk) local haveOutput = 0 local retVal = "" if chunk == nil then streamEnded = true else buffer = buffer .. chunk end local newlinePosition = buffer:find("\n", bufferPos) if newlinePosition then currentRecord = currentRecord .. buffer:sub(bufferPos, newlinePosition - 1) bufferPos = newlinePosition + 1 retVal = currentRecord else currentRecord = currentRecord .. buffer:sub(bufferPos, #buffer) buffer = "" bufferPos = 1 if streamEnded then if currentRecord == "" then retVal = nil else retVal = currentRecord end end end if retVal and (retVal ~= "") then currentRecord = "" end return (retVal) end end local function normalizeFqdn() return function(chunk) if chunk and (chunk ~= "") then if config["stripWww"] then chunk = chunk:gsub("^www%.", "") end if idn and config["convertIdn"] then chunk = idn.encode(chunk) end if #chunk &gt; 255 then chunk = "" end chunk = chunk:lower() end return (chunk) end end local function cunstructTables(bltables) bltables = bltables or { fqdn = {}, sdcount = {}, ips = {} } local f = function(blEntry, err) if blEntry and (blEntry ~= "") then if blEntry:match("^%d+%.%d+%.%d+%.%d+$") then -- ip  -     iptables if not bltables.ips[blEntry] then bltables.ips[blEntry] = true end else --   , FQDN  .    2  (  bl   TLD -   :)) local subDomain, secondLevelDomain = blEntry:match("^([a-z0-9%-%.]-)([a-z0-9%-]+%.[a-z0-9%-]+)$") if secondLevelDomain then bltables.fqdn[blEntry] = secondLevelDomain if 1 &gt; 0 then bltables.sdcount[secondLevelDomain] = (bltables.sdcount[secondLevelDomain] or 0) + 1 end end end end return 1 end return f, bltables end local function compactDomainList(fqdnList, subdomainsCount) local domainTable = {} local numEntries = 0 if config.groupBySld and (config.groupBySld &gt; 0) then for sld in pairs(subdomainsCount) do if config.neverGroupDomains[sld] then subdomainsCount[sld] = 0 break end for _, pattern in ipairs(config.neverGroupMasks) do if sld:find(pattern) then subdomainsCount[sld] = 0 break end end end end for fqdn, sld in pairs(fqdnList) do if (not fqdnList[sld]) or (fqdn == sld) then local keyValue; if config.groupBySld and (config.groupBySld &gt; 0) and (subdomainsCount[sld] &gt; config.groupBySld) then keyValue = sld else keyValue = fqdn end if not domainTable[keyValue] then domainTable[keyValue] = true numEntries = numEntries + 1 end end end return domainTable, numEntries end local function generateDnsmasqConfig(configPath, domainList) local configFile = assert(io.open(configPath, "w"), "could not open dnsmasq config") for fqdn in pairs(domainList) do if config.torifyNsLookups then configFile:write(string.format("server=/%s/%s\n", fqdn, config.torDnsAddr)) end configFile:write(string.format("ipset=/%s/%s\n", fqdn, config.ipsetDns)) end configFile:close() end local function generateIpsetConfig(configPath, ipList) local configFile = assert(io.open(configPath, "w"), "could not open ipset config") configFile:write(string.format("flush %s-tmp\n", config.ipsetIp)) for ipaddr in pairs(ipList) do configFile:write(string.format("add %s %s\n", config.ipsetIp, ipaddr)) end configFile:write(string.format("swap %s %s-tmp\n", config.ipsetIp, config.ipsetIp)) configFile:close() end local retVal, retCode, url local output, bltables = cunstructTables() if config.blSource == "rublacklist" then output = ltn12.sink.chain(ltn12.filter.chain(rublacklistExtractDomains(), normalizeFqdn()), output) url = "http://reestr.rublacklist.net/api/current" elseif config.blSource == "antizapret" then output = ltn12.sink.chain(ltn12.filter.chain(antizapretExtractDomains(), normalizeFqdn()), output) url = "http://api.antizapret.info/group.php?data=domain" else error("blacklist source should be either 'rublacklist' or 'antizapret'") end if http then retVal, retCode = http.request { url = url, sink = output } else retVal, retCode = ltn12.pump.all(ltn12.source.file(io.popen("wget -qO- " .. url)), output) end if (retVal == 1) and ((retCode == 200) or (http == nil)) then local domainTable, recordsNum = compactDomainList(bltables.fqdn, bltables.sdcount) if recordsNum &gt; config.blMinimumEntries then generateDnsmasqConfig(config.dnsmasqConfigPath, domainTable) generateIpsetConfig(config.ipsetConfigPath, bltables.ips) print(string.format("blacklists updated. %d entries.", recordsNum)) os.exit(0) end end os.exit(1)</span></span></code> </pre><br></div></div><br><h6>  Dnsmasq settings </h6><br><div class="spoiler">  <b class="spoiler_title">/etc/dnsmasq.conf</b> <div class="spoiler_text"><pre> <code class="hljs axapta"><span class="hljs-keyword"><span class="hljs-keyword">server</span></span>=/onion/<span class="hljs-number"><span class="hljs-number">127.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span><span class="hljs-meta"><span class="hljs-meta">#9053 ipset=/onion/onion conf-file=/etc/runblock/runblock.dnsmasq</span></span></code> </pre><br></div></div><br><div class="spoiler">  <b class="spoiler_title">Add to dnsmasq / etc / config / dhcp section</b> <div class="spoiler_text"><pre> <code class="hljs php"> <span class="hljs-keyword"><span class="hljs-keyword">list</span></span> server <span class="hljs-string"><span class="hljs-string">'8.8.8.8'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">list</span></span> server <span class="hljs-string"><span class="hljs-string">'8.8.4.4'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">list</span></span> rebind_domain <span class="hljs-string"><span class="hljs-string">'onion'</span></span></code> </pre><br></div></div><br><h6>  Netfilter settings </h6><br><div class="spoiler">  <b class="spoiler_title">Add to / etc / config / firewall</b> <div class="spoiler_text"><pre> <code class="hljs pgsql">config ipset <span class="hljs-keyword"><span class="hljs-keyword">option</span></span> <span class="hljs-type"><span class="hljs-type">name</span></span> <span class="hljs-string"><span class="hljs-string">'rublack-dns'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">option</span></span> <span class="hljs-keyword"><span class="hljs-keyword">storage</span></span> <span class="hljs-string"><span class="hljs-string">'hash'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">option</span></span> match <span class="hljs-string"><span class="hljs-string">'dest_ip'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">option</span></span> timeout <span class="hljs-string"><span class="hljs-string">'86400'</span></span> config ipset <span class="hljs-keyword"><span class="hljs-keyword">option</span></span> <span class="hljs-type"><span class="hljs-type">name</span></span> <span class="hljs-string"><span class="hljs-string">'rublack-ip'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">option</span></span> <span class="hljs-keyword"><span class="hljs-keyword">storage</span></span> <span class="hljs-string"><span class="hljs-string">'hash'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">option</span></span> match <span class="hljs-string"><span class="hljs-string">'dest_ip'</span></span> config ipset <span class="hljs-keyword"><span class="hljs-keyword">option</span></span> <span class="hljs-type"><span class="hljs-type">name</span></span> <span class="hljs-string"><span class="hljs-string">'rublack-ip-tmp'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">option</span></span> <span class="hljs-keyword"><span class="hljs-keyword">storage</span></span> <span class="hljs-string"><span class="hljs-string">'hash'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">option</span></span> match <span class="hljs-string"><span class="hljs-string">'dest_ip'</span></span> config ipset <span class="hljs-keyword"><span class="hljs-keyword">option</span></span> <span class="hljs-type"><span class="hljs-type">name</span></span> <span class="hljs-string"><span class="hljs-string">'onion'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">option</span></span> <span class="hljs-keyword"><span class="hljs-keyword">storage</span></span> <span class="hljs-string"><span class="hljs-string">'hash'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">option</span></span> match <span class="hljs-string"><span class="hljs-string">'dest_ip'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">option</span></span> timeout <span class="hljs-string"><span class="hljs-string">'86400'</span></span> config redirect <span class="hljs-keyword"><span class="hljs-keyword">option</span></span> <span class="hljs-type"><span class="hljs-type">name</span></span> <span class="hljs-string"><span class="hljs-string">'torify-blocked-dns'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">option</span></span> src <span class="hljs-string"><span class="hljs-string">'lan'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">option</span></span> proto <span class="hljs-string"><span class="hljs-string">'tcp'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">option</span></span> ipset <span class="hljs-string"><span class="hljs-string">'rublack-dns'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">option</span></span> dest_port <span class="hljs-string"><span class="hljs-string">'9040'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">option</span></span> dest <span class="hljs-string"><span class="hljs-string">'lan'</span></span> config redirect <span class="hljs-keyword"><span class="hljs-keyword">option</span></span> <span class="hljs-type"><span class="hljs-type">name</span></span> <span class="hljs-string"><span class="hljs-string">'torify-blocked-ip'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">option</span></span> src <span class="hljs-string"><span class="hljs-string">'lan'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">option</span></span> proto <span class="hljs-string"><span class="hljs-string">'tcp'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">option</span></span> ipset <span class="hljs-string"><span class="hljs-string">'rublack-ip'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">option</span></span> dest_port <span class="hljs-string"><span class="hljs-string">'9040'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">option</span></span> dest <span class="hljs-string"><span class="hljs-string">'lan'</span></span> config redirect <span class="hljs-keyword"><span class="hljs-keyword">option</span></span> <span class="hljs-type"><span class="hljs-type">name</span></span> <span class="hljs-string"><span class="hljs-string">'torify-onion'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">option</span></span> src <span class="hljs-string"><span class="hljs-string">'lan'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">option</span></span> proto <span class="hljs-string"><span class="hljs-string">'tcp'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">option</span></span> ipset <span class="hljs-string"><span class="hljs-string">'onion'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">option</span></span> dest_port <span class="hljs-string"><span class="hljs-string">'9040'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">option</span></span> dest <span class="hljs-string"><span class="hljs-string">'lan'</span></span></code> </pre><br></div></div><br><div class="spoiler">  <b class="spoiler_title">Add to /etc/firewall.user</b> <div class="spoiler_text"><pre> <code class="hljs sql">cat /etc/runblock/runblock.ipset | ipset <span class="hljs-keyword"><span class="hljs-keyword">restore</span></span></code> </pre><br></div></div><br><h6>  Tor Settings </h6><br><div class="spoiler">  <b class="spoiler_title">/ etc / torrc</b> <div class="spoiler_text"><pre> <code class="hljs swift"><span class="hljs-type"><span class="hljs-type">User</span></span> tor <span class="hljs-type"><span class="hljs-type">PidFile</span></span> /<span class="hljs-keyword"><span class="hljs-keyword">var</span></span>/run/tor.pid <span class="hljs-type"><span class="hljs-type">DataDirectory</span></span> /<span class="hljs-keyword"><span class="hljs-keyword">var</span></span>/lib/tor <span class="hljs-type"><span class="hljs-type">ExcludeExitNodes</span></span> {<span class="hljs-type"><span class="hljs-type">RU</span></span>} <span class="hljs-type"><span class="hljs-type">VirtualAddrNetwork</span></span> <span class="hljs-number"><span class="hljs-number">10.254</span></span>.<span class="hljs-number"><span class="hljs-number">0.0</span></span>/<span class="hljs-number"><span class="hljs-number">16</span></span> #    .onion  <span class="hljs-type"><span class="hljs-type">AutomapHostsOnResolve</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-type"><span class="hljs-type">TransPort</span></span> <span class="hljs-number"><span class="hljs-number">9040</span></span> <span class="hljs-type"><span class="hljs-type">TransListenAddress</span></span> <span class="hljs-number"><span class="hljs-number">127.0</span></span>.<span class="hljs-number"><span class="hljs-number">0.1</span></span> <span class="hljs-type"><span class="hljs-type">TransListenAddress</span></span> <span class="hljs-number"><span class="hljs-number">192.168</span></span>.<span class="hljs-number"><span class="hljs-number">1.1</span></span> # <span class="hljs-type"><span class="hljs-type">LAN</span></span>  <span class="hljs-type"><span class="hljs-type">DNSPort</span></span> <span class="hljs-number"><span class="hljs-number">9053</span></span> <span class="hljs-type"><span class="hljs-type">DNSListenAddress</span></span> <span class="hljs-number"><span class="hljs-number">127.0</span></span>.<span class="hljs-number"><span class="hljs-number">0.1</span></span> #<span class="hljs-type"><span class="hljs-type">AvoidDiskWrites</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> #  <span class="hljs-type"><span class="hljs-type">OpenWrt</span></span> /<span class="hljs-keyword"><span class="hljs-keyword">var</span></span>    <span class="hljs-type"><span class="hljs-type">RAM</span></span> (tmpfs)  ,     </code> </pre><br></div></div><br>  It remains to create the <code>/etc/runblock</code> , manually launch the <code>lua /usr/bin/rublupdate.lua</code> script one-time, make sure that it worked without errors, add it to cron (a couple of times a day is enough) and forget about the Roskomnadzor.  Well, until they start to block the torus, or sites that publish the registry). </div><p>Source: <a href="https://habr.com/ru/post/270657/">https://habr.com/ru/post/270657/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../270645/index.html">Jiant. Models for frontend applications</a></li>
<li><a href="../270647/index.html">AppCode 3.3: Xcode 7, Swift 2 and Future Plans</a></li>
<li><a href="../270651/index.html">Watch the opening of the Connect () conference today at 6:00 MSK; // 2015</a></li>
<li><a href="../270653/index.html">5 days before the MBLTdev mobile developers conference</a></li>
<li><a href="../270655/index.html">Nuances of creating an arcade</a></li>
<li><a href="../270659/index.html">Russian platinum: SED works even where bears go</a></li>
<li><a href="../270661/index.html">Key Account: How Yahoo Hopes to End Passwords</a></li>
<li><a href="../270665/index.html">Creating site tips with EnjoyHint</a></li>
<li><a href="../270667/index.html">Freenote - a set of 500 icons for Keynote</a></li>
<li><a href="../270669/index.html">Adobe has updated Flash Player</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>