<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>TDD applications on Spring Boot: fine-tuning tests and working with context</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="The third article in the cycle and a small branch from the main series - this time I will show how the Spring integration test library works and how i...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>TDD applications on Spring Boot: fine-tuning tests and working with context</h1><div class="post__text post__text-html js-mediator-article"><p>  The third article in the cycle and a small branch from the main series - this time I will show how the Spring integration test library works and how it works, what happens when you run the test and how you can finely tune the application and its environment for the test. </p><a name="habracut"></a><br><p>  Write this article pushed me a <a href="https://habr.com/ru/post/433958/">comment</a> <a href="https://habr.com/ru/users/hixon10/" class="user_link">Hixon10</a> about how to use a real base, for example Postgres, in the integration test.  The comment author suggested using the convenient all-included library <a href="https://github.com/zonkyio/embedded-database-spring-test">embedded-database-spring-test</a> .  And I have already added a paragraph and an example of use in the code, but then I thought.  Of course, it‚Äôs right and good to take a ready-made library, but if the goal is to <em>understand how to write tests</em> for Spring applications, it will be more useful to show how to implement the very same functionality yourself.  First of all, this is a great excuse to talk about the fact that <strong>Spring Test is</strong> under the hood.  And secondly, I believe that it is impossible to rely on third-party libraries, if you do not understand how they are arranged inside, this only leads to strengthening the myth of the "magic" of technology. </p><br><p>  This time there will be no user feature, but there will be a problem that needs to be solved - <em>I want to run the real database on a random port and connect the application to this time base automatically, and after the tests, stop the base and delete it.</em> </p><br><p>  At first, as has already happened, a little theory.  People who are not too familiar with the concepts of bin, context, configuration, I recommend refreshing knowledge, for example, in my article The <a href="https://habr.com/post/334448/">Other Side of Spring / Habr</a> . </p><br><h1 id="spring-test">  Spring test </h1><br><p>  Spring Test is one of the libraries included in the Spring Framework, in fact, everything that is described in <a href="https://docs.spring.io/spring/docs/current/spring-framework-reference/testing.html">the documentation section</a> about integration testing is about it.  The four main tasks that the library solves are: </p><br><ul><li>  Manage Spring IoC containers and their caching between tests </li><li>  Provide dependency injection for test classes </li><li>  Provide transaction management suitable for integration tests. </li><li>  Provide a set of base classes to help the developer write integration tests. </li></ul><br><p>  I highly recommend reading the official documentation, there are many useful and interesting things written there.  Here I will give more likely a brief squeeze and a few practical tips that are useful to keep in mind. </p><br><h1 id="zhiznennyy-cikl-testa">  Test life cycle </h1><br><p><img src="https://habrastorage.org/webt/si/oq/ed/sioqedpwtepmojxgj2fqzcyy-d0.jpeg"><br>  The life cycle of the test is as follows: </p><br><ol><li> An extension to the test framework ( <code>SpringRunner</code> for JUnit 4 and <code>SpringExtension</code> for JUnit 5) calls Test Context Bootstrapper </li><li>  Boostrapper creates <code>TestContext</code> - the main class that stores the current state of the test and the application. </li><li>  <code>TestContext</code> configures different hooks (such as starting transactions before a test and rollback after), inject dependencies into test classes (all <code>@Autowired</code> fields on test classes), and creates contexts </li><li>  The context is created using the <em>Context Loader</em> - it takes the basic configuration of the application and merges it with the test configuration (overlapped properties, profiles, bins, initializers, etc.) </li><li>  The context is cached using a composite key that completely describes the application ‚Äî a set of beans, properties, and so on. </li><li>  Test starts </li></ol><br><blockquote>  All the dirty work on test management does <code>spring-test</code> , and <code>Spring Boot Test</code> in turn adds several auxiliary classes, like the already familiar <code>@DataJpaTest</code> and <code>@SpringBootTest</code> , useful utilities, like <code>TestPropertyValues</code> to dynamically change the context properties.  It also allows you to run the application as a real web-server, or as a mock environment (without access via HTTP), it is convenient to use the system components using <code>@MockBean</code> , etc. </blockquote><br><h1 id="keshirovanie-konteksta">  Context caching </h1><br><p>  Perhaps one of the very incomprehensible topics in integration testing that raises many questions and misconceptions is the <strong>caching of the context</strong> (see clause 5 above) between tests and its effect on the speed of test execution.  A frequent comment that I hear is that the integration tests "slow" and "run the application for each test."  So, they really run - but not for every test.  Each context (i.e. application instance) will be reused to the maximum, i.e.  If 10 tests use the same application configuration, then the application will run once for all 10 tests.  What does the "same configuration" application mean?  For Spring Test, this means that the set of bins, configuration classes, profiles, properties, etc. has not changed.  In practice, this means that, for example, these two tests will use the same context: </p><br><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@SpringBootTest</span></span> <span class="hljs-meta"><span class="hljs-meta">@ActiveProfiles</span></span>(<span class="hljs-string"><span class="hljs-string">"test"</span></span>) <span class="hljs-meta"><span class="hljs-meta">@TestPropertySource</span></span>(<span class="hljs-string"><span class="hljs-string">"foo=bar"</span></span>) <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">FirstTest</span></span></span><span class="hljs-class"> </span></span>{ } <span class="hljs-meta"><span class="hljs-meta">@SpringBootTest</span></span> <span class="hljs-meta"><span class="hljs-meta">@ActiveProfiles</span></span>(<span class="hljs-string"><span class="hljs-string">"test"</span></span>) <span class="hljs-meta"><span class="hljs-meta">@TestPropertySource</span></span>(<span class="hljs-string"><span class="hljs-string">"foo=bar"</span></span>) <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">SecondTest</span></span></span><span class="hljs-class"> </span></span>{ }</code> </pre> <br><blockquote>  The number of contexts in the cache is limited to 32 - then, following the LRSU principle, one of them will be removed from the cache. </blockquote><p>  So what can prevent Spring Test from reusing the cached context and creating a new one? </p><br><p>  <strong>@DirtiesContext</strong> <br>  The simplest option is if the test is marked as annotations, the context will not be cached.  This can be useful if the test changes the state of the application and you want to "reset" it. </p><br><p>  <strong>@MockBean</strong> <br>  A very unobvious option, I even rendered it separately - @MockBean replaces the real bin in context for the mock, which can be tested through the Mockito (in the next articles I will show how to use it).  The key point is that this annotation <em>changes the set of beans</em> in the application and forces Spring Test to create a new context.  If you take the previous example, for example, two contexts will be created here: </p><br><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@SpringBootTest</span></span> <span class="hljs-meta"><span class="hljs-meta">@ActiveProfiles</span></span>(<span class="hljs-string"><span class="hljs-string">"test"</span></span>) <span class="hljs-meta"><span class="hljs-meta">@TestPropertySource</span></span>(<span class="hljs-string"><span class="hljs-string">"foo=bar"</span></span>) <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">FirstTest</span></span></span><span class="hljs-class"> </span></span>{ } <span class="hljs-meta"><span class="hljs-meta">@SpringBootTest</span></span> <span class="hljs-meta"><span class="hljs-meta">@ActiveProfiles</span></span>(<span class="hljs-string"><span class="hljs-string">"test"</span></span>) <span class="hljs-meta"><span class="hljs-meta">@TestPropertySource</span></span>(<span class="hljs-string"><span class="hljs-string">"foo=bar"</span></span>) <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">SecondTest</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-meta"><span class="hljs-meta">@MockBean</span></span> CakeFinder cakeFinderMock; }</code> </pre> <br><p>  <strong>@TestPropertySource</strong> <br>  Any change in properties automatically changes the cache key and a new context is created. </p><br><p>  <strong>@ActiveProfiles</strong> <br>  Changing active profiles will also affect the cache. </p><br><p>  <strong>@ContextConfiguration</strong> <br>  Well, of course, any configuration change will also create a new context. </p><br><h1 id="zapuskaem-bazu">  Run the database </h1><br><p>  So now with all this knowledge we will try. <del>  take off </del>  understand how and where you can run the database.  The only correct answer is not here, it depends on the requirements, but you can think of two options: </p><br><ol><li>  Run once before all tests in the class. </li><li>  Run a random instance and a separate database for each cached context (potentially more than one class). </li></ol><br><p>  Depending on the requirements, you can choose any opitsyu.  If in my case, Postgres starts relatively quickly and the second option looks appropriate, then the first one may be suitable for something heavier. </p><br><blockquote>  The first option is not tied to Spring, but rather to the test framework.  For example, you can make your <a href="https://junit.org/junit5/docs/current/user-guide/">Extension for JUnit 5</a> . </blockquote><p>  If you put together all the knowledge about the test library, contexts and caching, then the task is as follows: <em>when creating a new application context, you need to run the database on a random port and transfer the connection data to the context</em> . </p><br><p>  The execution of actions with the context before launch in Spring is the responsibility of the <code>ApplicationContextInitializer</code> interface </p><br><h1 id="applicationcontextinitializer">  ApplicationContextInitializer </h1><br><p>  The interface has only one <code>initialize</code> method that runs before the context ‚Äústarts‚Äù (that is, before calling the <code>refresh</code> method) and allows you to make changes to the context ‚Äî add beans and properties. </p><br><p>  In my case, the class looks like this: </p><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">EmbeddedPostgresInitializer</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ApplicationContextInitializer</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">GenericApplicationContext</span></span></span><span class="hljs-class">&gt; </span></span>{ <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">initialize</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(GenericApplicationContext applicationContext)</span></span></span><span class="hljs-function"> </span></span>{ EmbeddedPostgres postgres = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> EmbeddedPostgres(); <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { String url = postgres.start(); TestPropertyValues values = TestPropertyValues.of( <span class="hljs-string"><span class="hljs-string">"spring.test.database.replace=none"</span></span>, <span class="hljs-string"><span class="hljs-string">"spring.datasource.url="</span></span> + url, <span class="hljs-string"><span class="hljs-string">"spring.datasource.driver-class-name=org.postgresql.Driver"</span></span>, <span class="hljs-string"><span class="hljs-string">"spring.jpa.hibernate.ddl-auto=create"</span></span>); values.applyTo(applicationContext); applicationContext.registerBean(EmbeddedPostgres.class, () -&gt; postgres, beanDefinition -&gt; beanDefinition.setDestroyMethodName(<span class="hljs-string"><span class="hljs-string">"stop"</span></span>)); } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (IOException e) { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> RuntimeException(e); } } }</code> </pre> <br><p>  The first thing that happens here is run Postgres starts, from the library <a href="https://github.com/yandex-qatools/postgresql-embedded">yandex-qatools / postgresql-embedded</a> .  Then, a set of properties is created ‚Äî the JDBC URL for the newly launched database, the type of driver, and the behavior of Hibernate for the schema (automatically create).  One unobvious thing is only <code>spring.test.database.replace=none</code> - this is what we say to DataJpaTest, that you should not try to connect to the embedded database, such as H2, and you shouldn‚Äôt replace the DataSource bean (it works). </p><br><p>  And another important point is the <code>application.registerBean(‚Ä¶)</code> .  In general, this bin can, of course, not be registered - if nobody uses it in the application, it is not really needed.  Registration is needed only to specify the destroy method that Spring will call when the context is destroyed, and in my case this method will call <code>postgres.stop()</code> and stop the base. </p><br><p>  In general, that's all, the magic is over, if some was.  Now I will register this initializer in a test context: </p><br><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@DataJpaTest</span></span> <span class="hljs-meta"><span class="hljs-meta">@ContextConfiguration</span></span>(initializers = EmbeddedPostgresInitializer.class) ...</code> </pre> <br><p>  Or even for convenience, you can create your own annotation, because we all love annotations! </p><br><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@Target</span></span>(ElementType.TYPE) <span class="hljs-meta"><span class="hljs-meta">@Retention</span></span>(RetentionPolicy.RUNTIME) <span class="hljs-meta"><span class="hljs-meta">@DataJpaTest</span></span> <span class="hljs-meta"><span class="hljs-meta">@ContextConfiguration</span></span>(initializers = EmbeddedPostgresInitializer.class) <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-meta"><span class="hljs-meta">@interface</span></span> EmbeddedPostgresTest { }</code> </pre> <br><p>  Now, any test annotated with <code>@EmbeddedPostgrestTest</code> will launch a database on a random port and with a random name, configure Spring to connect to this database, and stop it at the end of the test. </p><br><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@EmbeddedPostgresTest</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">JpaCakeFinderTestWithEmbeddedPostgres</span></span></span><span class="hljs-class"> </span></span>{ ... }</code> </pre> <br><h1 id="zaklyuchenie">  Conclusion </h1><br><p>  I wanted to show that there is no mysterious magic in Spring, there are just a lot of "smart" and flexible internal mechanisms, but knowing them you can get complete control on the tests and the application itself.  In general, in combat projects, I do not motivate everyone to write my own methods and classes for setting up an integration environment for tests, if there is a ready-made solution, then we can take it.  Although if the whole method is 5 lines of code, then probably dragging the dependency into the project, especially not understanding the implementation, is unnecessary. </p><br><h1 id="ssylki-na-ostalnye-stati-serii">  Links to other articles in the series </h1><br><ul><li>  <a href="https://habr.com/ru/post/431306/">How to build a pyramid in the trunk or Test-Driven Development applications for Spring Boot</a> </li><li>  <a href="https://habr.com/ru/post/433958/">TDD applications on Spring Boot: working with a database</a> </li></ul></div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <p>Source: <a href="https://habr.com/ru/post/446184/">https://habr.com/ru/post/446184/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../446166/index.html">A simple sprintf-based ASN1 codec</a></li>
<li><a href="../446172/index.html">Limit Messages API VK - what to do</a></li>
<li><a href="../446174/index.html">Yandex.Alisa and bot Telegram for PHP with a single functionality</a></li>
<li><a href="../446176/index.html">Recognition of tanks in the video stream by machine learning methods (+2 videos on the platforms Elbrus and Baikal)</a></li>
<li><a href="../446180/index.html">Was MongoDB even the right choice?</a></li>
<li><a href="../446186/index.html">How Ilon Musk tried to destroy the informant in the ranks of Tesla, and what came of it</a></li>
<li><a href="../446188/index.html">Is it time for URLs containing emoji?</a></li>
<li><a href="../446190/index.html">My home automation system. Creating an operating system image</a></li>
<li><a href="../446192/index.html">Backup History: Seven Inventors You May Not Have Heard Of</a></li>
<li><a href="../446194/index.html">New Galatea or revive an android girl for a fantastic novel</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>