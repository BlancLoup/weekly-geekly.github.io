<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Not quite a standard approach to organizing access to a WiFi network (Cisco WLC -> FreeRadius -> PHP -> web page)</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="I want to share the solution of one nontrivial task. It was necessary to organize convenient access to the wireless network in the office of the organ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Not quite a standard approach to organizing access to a WiFi network (Cisco WLC -> FreeRadius -> PHP -> web page)</h1><div class="post__text post__text-html js-mediator-article">  I want to share the solution of one nontrivial task.  It was necessary to organize convenient access to the wireless network in the office of the organization.  The network provides access only to the public internet, nothing connects with the corporate network - a completely isolated system.  The only common component is users.  To simplify the process, it was decided to do authentication at the Layer 3 level - that is, the network is open, after connecting, you must enter a password to access the Internet ( <a href="http://www.cisco.com/en/US/tech/tk722/tk809/technologies_configuration_example09186a008067489f.shtml">Cisco WLC Web Auth</a> ). <br>  In principle, everything is simple, accounts are created for each user, and everything is ready.  But, due to the lack of helpdesk staff, there was no one to create logins and, moreover, to issue passwords to the staff.  The task was to use one of the existing authentication sources, which in a standard situation is quite simple: for example, MS Active Directory can use NPS as the server radius, on LDAP you can connect directly). <br>  In our case, there was one and the other (AD for the network and LDAP for accessing the corporate intranet), but there was no access from the WiFi segment.  The maximum that we were able to give is a test AD account and an account for the intranet.  They sat down, thought ... and that's what came up <br><a name="habracut"></a><br><br>  FreeRadius has the ability to request authentication from an external script, such as PHP.  This is done like this: <br><pre><code class="hljs pgsql">authorize{ <span class="hljs-keyword"><span class="hljs-keyword">update</span></span> control { Auth-<span class="hljs-keyword"><span class="hljs-keyword">Type</span></span> := `/usr/bin/php -f /etc/raddb/yourscript.php <span class="hljs-string"><span class="hljs-string">'%{User-Name}'</span></span> <span class="hljs-string"><span class="hljs-string">'%{User-Password}'</span></span>` }</code> </pre> <br><br>  In this case, PHP should only check the login &amp; password and answer either Accept or Reject. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Using this, we successfully solved the problem.  Diagram of what happened: <br><img src="https://habrastorage.org/storage2/d10/640/b55/d10640b557168dfb0ac67108786c641a.gif"><br><br>  The PHP script logs into the intranet page with the '% {User-Name}' '% {User-Password}' `passed to it via curl, checks if this succeeds, and makes echo" Accept "if successful. <br><br>  Here is the script code (logging into the intranet using IBM Tivoli Access Manager WebSEAL) <br><pre> <code class="php hljs"> $authSuccessful = <span class="hljs-keyword"><span class="hljs-keyword">False</span></span>; $user = $argv[<span class="hljs-number"><span class="hljs-number">1</span></span>]; $password = $argv[<span class="hljs-number"><span class="hljs-number">2</span></span>]; $url = <span class="hljs-string"><span class="hljs-string">'https://intranet.of.the.company.accessible.from.internet/pkmslogin.form'</span></span>; $fields_string= <span class="hljs-string"><span class="hljs-string">"username="</span></span>.$user.<span class="hljs-string"><span class="hljs-string">"&amp;password="</span></span>.$password.<span class="hljs-string"><span class="hljs-string">"&amp;login-form-type=pwd&amp;submit=Login"</span></span>; <span class="hljs-comment"><span class="hljs-comment">//open connection $ch = curl_init(); //set the url, number of POST vars, POST data curl_setopt($ch,CURLOPT_URL, $url); curl_setopt($ch,CURLOPT_POSTFIELDS, $fields_string); curl_setopt($ch,CURLOPT_USERAGENT, "Mozilla/4.0 (compatible; MSIE 6.0; Windows NT 5.1)"); curl_setopt($ch,CURLOPT_SSL_VERIFYPEER, false); curl_setopt($ch, CURLOPT_COOKIESESSION, TRUE); curl_setopt($ch,CURLOPT_COOKIEJAR, "cookie.txt"); curl_setopt($ch,CURLOPT_COOKIEFILE, "cookie.txt"); curl_setopt($ch, CURLOPT_FOLLOWLOCATION, 0); curl_setopt($ch, CURLOPT_POSTREDIR, 0); curl_setopt($ch,CURLOPT_RETURNTRANSFER, true); //execute post $result = curl_exec($ch); curl_close($ch); if (strpos($result,'Your login was successful') !== false) $authSuccessful = True; if ($authSuccessful == True) echo "Accept\n"; else echo "Reject\n";</span></span></code> </pre><br><br>  Everything worked for glory, everyone was happy ... except for those who did not remember their intranet password (for some reason, the intranet passwords differed from AD passwords).  IT bosses, instead of hinting users that passwords should be remembered by everyone and not just the main one (in this case, AD was the main password), asked us to solve the problem using technical methods. <br>  Luckily, the office had a Citrix XenApp server with a Web Interface accessible from the Internet and MS AD as an authentication source.  What they used: <br>  Script code (login on Citrix Web Interface v 5.4) <br><pre> <code class="php hljs"> $authSuccessful = <span class="hljs-keyword"><span class="hljs-keyword">False</span></span>; $user = $argv[<span class="hljs-number"><span class="hljs-number">1</span></span>]; $password = $argv[<span class="hljs-number"><span class="hljs-number">2</span></span>]; <span class="hljs-comment"><span class="hljs-comment">//WebInterface 5.4.x $url = 'https://the.web.interface.of.citrix.xenapp/Citrix/XenApp/auth/login.aspx'; $fields_string= "user=".$user."&amp;password=".$password."&amp;LoginType=Explicit"; //open connection $ch = curl_init(); //set the url, number of POST vars, POST data curl_setopt($ch,CURLOPT_URL, $url); curl_setopt($ch,CURLOPT_POSTFIELDS, $fields_string); curl_setopt($ch,CURLOPT_USERAGENT, "Mozilla/4.0 (compatible; MSIE 6.0; Windows NT 5.1)"); curl_setopt($ch,CURLOPT_SSL_VERIFYPEER, false); curl_setopt($ch, CURLOPT_COOKIESESSION, TRUE); curl_setopt($ch,CURLOPT_COOKIEJAR, "cookie.txt"); curl_setopt($ch,CURLOPT_COOKIEFILE, "cookie.txt"); curl_setopt($ch, CURLOPT_FOLLOWLOCATION, 0); curl_setopt($ch, CURLOPT_POSTREDIR, 0); curl_setopt($ch,CURLOPT_RETURNTRANSFER, true); //execute post $result = curl_exec($ch); //close connection curl_close($ch); if (strpos($result,'default.aspx') !== false) { $authSuccessful = True; } if ($authSuccessful == True) echo "Accept\n"; else echo "Reject\n";</span></span></code> </pre><br><br>  We decided to go even further, and combined both scripts into one - now the intranet login is checked first, then MS AD via Citrix WI <br><div class="spoiler">  <b class="spoiler_title">Final Script Code</b> <div class="spoiler_text"><pre> <code class="php hljs"> $authSuccessful = <span class="hljs-keyword"><span class="hljs-keyword">False</span></span>; $user = $argv[<span class="hljs-number"><span class="hljs-number">1</span></span>]; $password = $argv[<span class="hljs-number"><span class="hljs-number">2</span></span>]; $url = <span class="hljs-string"><span class="hljs-string">'https://intranet.of.the.company.accessible.from.internet/pkmslogin.form'</span></span>; $fields_string= <span class="hljs-string"><span class="hljs-string">"username="</span></span>.$user.<span class="hljs-string"><span class="hljs-string">"&amp;password="</span></span>.$password.<span class="hljs-string"><span class="hljs-string">"&amp;login-form-type=pwd&amp;submit=Login"</span></span>; <span class="hljs-comment"><span class="hljs-comment">//open connection $ch = curl_init(); //set the url, number of POST vars, POST data curl_setopt($ch,CURLOPT_URL, $url); curl_setopt($ch,CURLOPT_POSTFIELDS, $fields_string); curl_setopt($ch,CURLOPT_USERAGENT, "Mozilla/4.0 (compatible; MSIE 6.0; Windows NT 5.1)"); curl_setopt($ch,CURLOPT_SSL_VERIFYPEER, false); curl_setopt($ch, CURLOPT_COOKIESESSION, TRUE); curl_setopt($ch,CURLOPT_COOKIEJAR, "cookie.txt"); curl_setopt($ch,CURLOPT_COOKIEFILE, "cookie.txt"); curl_setopt($ch, CURLOPT_FOLLOWLOCATION, 0); curl_setopt($ch, CURLOPT_POSTREDIR, 0); curl_setopt($ch,CURLOPT_RETURNTRANSFER, true); //execute post $result = curl_exec($ch); curl_close($ch); if (strpos($result,'Your login was successful') !== false) $authSuccessful = True; if ($authSuccessful == False) { //WebInterface 5.4.x $url = 'https://the.web.interface.of.citrix.xenapp/Citrix/XenApp/auth/login.aspx'; $fields_string= "user=".$user."&amp;password=".$password."&amp;LoginType=Explicit"; //open connection $ch = curl_init(); //set the url, number of POST vars, POST data curl_setopt($ch,CURLOPT_URL, $url); curl_setopt($ch,CURLOPT_POSTFIELDS, $fields_string); curl_setopt($ch,CURLOPT_USERAGENT, "Mozilla/4.0 (compatible; MSIE 6.0; Windows NT 5.1)"); curl_setopt($ch,CURLOPT_SSL_VERIFYPEER, false); curl_setopt($ch, CURLOPT_COOKIESESSION, TRUE); curl_setopt($ch,CURLOPT_COOKIEJAR, "cookie.txt"); curl_setopt($ch,CURLOPT_COOKIEFILE, "cookie.txt"); curl_setopt($ch, CURLOPT_FOLLOWLOCATION, 0); curl_setopt($ch, CURLOPT_POSTREDIR, 0); curl_setopt($ch,CURLOPT_RETURNTRANSFER, true); //execute post $result = curl_exec($ch); //close connection curl_close($ch); if (strpos($result,'default.aspx') !== false) { $authSuccessful = True; } } if ($authSuccessful == True) echo "Accept\n"; else echo "Reject\n";</span></span></code> </pre><br></div></div></div><p>Source: <a href="https://habr.com/ru/post/190156/">https://habr.com/ru/post/190156/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../190144/index.html">Titanium Cloud Service: sending emails without calling the email dialog</a></li>
<li><a href="../190146/index.html">Tessel - JavaScript Programmable Microcontroller</a></li>
<li><a href="../190148/index.html">Scrambls - protection of your intellectual property and encryption in social networks</a></li>
<li><a href="../190150/index.html">Storage Systems: Savings and Optimization</a></li>
<li><a href="../190154/index.html">SIP URI and URL. Part 1 (URI, URL and URN)</a></li>
<li><a href="../190158/index.html">Morphology. Tasks and approaches to their solution</a></li>
<li><a href="../190168/index.html">Design Integration with Blend</a></li>
<li><a href="../190170/index.html">Why it is worth taking loans</a></li>
<li><a href="../190176/index.html">Data Structures, PHP</a></li>
<li><a href="../190180/index.html">Acceleration Arduino. Under liquid nitrogen. 20 ‚áí 65.3Mhz @ -196 ¬∞ C</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>