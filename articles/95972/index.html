<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Node.JS: Example of an HTTP server in prefork mode using Web Workers</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="As promised earlier, I am publishing source code that demonstrates how to build an HTTP server in prefork mode using Web Workers and the new net.Serve...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Node.JS: Example of an HTTP server in prefork mode using Web Workers</h1><div class="post__text post__text-html js-mediator-article"> As promised earlier, I am publishing source code that demonstrates how to build an HTTP server in prefork mode using <a href="http://webo.in/articles/all/2009/25-computing-with-web-workers/">Web Workers</a> and the new <code>net.Server.listenFD()</code> API.  I hope this code will be a good example of how easy it is to load multiple server cores by combining the transfer of file descriptors and Web Workers. <br><br><a name="habracut"></a>  In master.js, we create a socket attached to port 8080 and generate 4 worker processes for processing requests.  We send a message to each handler with the text that will need to be used for all responses to requests, as well as the file descriptor of our socket. <br><br><blockquote><ol><li>  <font color="#003366"><b>var</b></font> path <font color="#339933">=</font> require <font color="#009900">(</font> <font color="#3366CC">'path'</font> <font color="#009900">)</font> <font color="#339933">;</font> </li><li>  <font color="#003366"><b>var</b></font> netBindings <font color="#339933">=</font> process.  <font color="#660066">binding</font> <font color="#009900">(</font> <font color="#3366CC">'net'</font> <font color="#009900">)</font> <font color="#339933">;</font> </li><li>  <font color="#003366"><b>var</b></font> Worker <font color="#339933">=</font> require <font color="#009900">(</font> <font color="#3366CC">'webworker'</font> <font color="#009900">)</font> .  <font color="#660066">Worker</font> <font color="#339933">;</font> </li><li></li><li>  <font color="#003366"><b>var</b></font> fd <font color="#339933">=</font> netBindings.  <font color="#660066">socket</font> <font color="#009900">(</font> <font color="#3366CC">'tcp4'</font> <font color="#009900">)</font> <font color="#339933">;</font> </li><li>  netBindings.  <font color="#660066">bind</font> <font color="#009900">(</font> fd <font color="#339933">,</font> <font color="#CC0000">8080</font> <font color="#009900">)</font> <font color="#339933">;</font> </li><li>  netBindings.  <font color="#660066">listen</font> <font color="#009900">(</font> fd <font color="#339933">,</font> <font color="#CC0000">128</font> <font color="#009900">)</font> <font color="#339933">;</font> </li><li></li><li>  <font color="#000066"><b>for</b></font> <font color="#009900">(</font> <font color="#003366"><b>var</b></font> i <font color="#339933">=</font> <font color="#CC0000">0</font> <font color="#339933">;</font> i <font color="#339933">&lt;</font> <font color="#CC0000">3</font> <font color="#339933">;</font> i <font color="#339933">++</font> <font color="#009900">)</font> <font color="#009900">{</font> </li><li>  <font color="#003366"><b>var</b></font> w <font color="#339933">=</font> <font color="#003366"><b>new</b></font> Worker <font color="#009900">(</font> path. <font color="#660066">join</font> <font color="#009900">(</font> __dirname <font color="#339933">,</font> <font color="#3366CC">'worker.js'</font> <font color="#009900">)</font> <font color="#009900">)</font> <font color="#339933">;</font> </li><li>  w.  <font color="#660066">postMessage</font> <font color="#009900">(</font> <font color="#009900">{</font> <font color="#3366CC">'banner'</font> <font color="#339933">:</font> <font color="#3366CC">'Hello, world!'</font> <font color="#009900">}</font> <font color="#339933">,</font> fd <font color="#009900">)</font> <font color="#339933">;</font> </li><li>  <font color="#009900">}</font> </li></ol></blockquote>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      In worker.js, we create an instance of the HTTP server, but do not call <code><font color="black">listen()</font></code> .  Instead, we expect to receive messages from the parent process.  When an event is received, we retrieve the file descriptor from the message and use it to bind our http.Server instance to the socket.  As soon as <code><font color="black">http.Server.listenFD()</font></code> is called, this process will start processing requests. <br><br><blockquote><ol><li>  <font color="#003366"><b>var</b></font> assert <font color="#339933">=</font> require <font color="#009900">(</font> <font color="#3366CC">'assert'</font> <font color="#009900">)</font> <font color="#339933">;</font> </li><li>  <font color="#003366"><b>var</b></font> http <font color="#339933">=</font> require <font color="#009900">(</font> <font color="#3366CC">'http'</font> <font color="#009900">)</font> <font color="#339933">;</font> </li><li></li><li>  <font color="#003366"><b>var</b></font> banner <font color="#339933">=</font> undefined <font color="#339933">;</font> </li><li></li><li>  <font color="#003366"><b>var</b></font> srv <font color="#339933">=</font> http.  <font color="#660066">createServer</font> <font color="#009900">(</font> <font color="#003366"><b>function</b></font> <font color="#009900">(</font> req <font color="#339933">,</font> resp <font color="#009900">)</font> <font color="#009900">{</font> </li><li>  resp.  <font color="#660066">writeHead</font> <font color="#009900">(</font> <font color="#CC0000">200</font> <font color="#339933">,</font> <font color="#009900">{</font> <font color="#3366CC">'Content-Type'</font> <font color="#339933">:</font> <font color="#3366CC">'text / plain'</font> <font color="#009900">}</font> <font color="#009900">)</font> <font color="#339933">;</font> </li><li>  resp.  <font color="#000066"><b>write</b></font> <font color="#009900">(</font> banner <font color="#339933">+</font> <font color="#3366CC">'(pid'</font> <font color="#339933">+</font> process. <font color="#660066">pid</font> <font color="#339933">+</font> <font color="#3366CC">') <font>\ n</font> '</font> <font color="#009900">)</font> <font color="#339933">;</font> </li><li>  resp.  <font color="#660066">end</font> <font color="#009900">(</font> <font color="#009900">)</font> <font color="#339933">;</font> </li><li>  <font color="#009900">}</font> <font color="#009900">)</font> <font color="#339933">;</font> </li><li></li><li>  onmessage <font color="#339933">=</font> <font color="#003366"><b>function</b></font> <font color="#009900">(</font> msg <font color="#009900">)</font> <font color="#009900">{</font> </li><li>  assert.  <font color="#660066">ok</font> <font color="#009900">(</font> msg. <font color="#660066">fd</font> <font color="#339933">&amp;&amp;</font> msg. <font color="#660066">fd</font> <font color="#339933">&gt;</font> <font color="#CC0000">0</font> <font color="#009900">)</font> <font color="#339933">;</font> </li><li></li><li>  banner <font color="#339933">=</font> msg.  <font color="#660066">data</font> .  <font color="#660066">banner</font> <font color="#339933">;</font> </li><li></li><li>  srv.  <font color="#660066">listenFD</font> <font color="#009900">(</font> msg. <font color="#660066">fd</font> <font color="#009900">)</font> <font color="#339933">;</font> </li><li>  <font color="#009900">}</font> <font color="#339933">;</font> </li></ol></blockquote><br><br>  When we run master.js, we can use curl to verify that requests have been processed by different processes. <br><br><blockquote><ol><li>  % curl 'http: // localhost: 8080' </li><li>  Hello, world!  (pid 27727) </li><li>  % curl 'http: // localhost: 8080' </li><li>  Hello, world!  (pid 27728) </li><li>  % curl 'http: // localhost: 8080' </li><li>  Hello, world!  (pid 27729) </li><li>  % curl 'http: // localhost: 8080' </li><li>  Hello, world!  (pid 27727) </li></ol></blockquote><br><br>  Very simple. </div><p>Source: <a href="https://habr.com/ru/post/95972/">https://habr.com/ru/post/95972/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../95964/index.html">Choosing card processing outside of Runet</a></li>
<li><a href="../95965/index.html">Install Android on iPhone 2G (3G) in automatic mode</a></li>
<li><a href="../95966/index.html">Back to the childhood</a></li>
<li><a href="../95969/index.html">Brothers and sisters Vkontakte</a></li>
<li><a href="../95970/index.html">Web Standards Days. June 26, St. Petersburg</a></li>
<li><a href="../95975/index.html">Reflections on the web studio, the customer and the contract</a></li>
<li><a href="../95978/index.html">Prizes go to Russia</a></li>
<li><a href="../95980/index.html">Video conference room: the experience of creating</a></li>
<li><a href="../95981/index.html">Do not open!</a></li>
<li><a href="../95984/index.html">Slow and / or resource-intensive tasks in the code: deferred tasks, queues, tasks with manual processing</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>