<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>We collect user activity in JS and ASP</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="After writing the functionality of the autorecorder of user actions, called by us breadcrumbs, in WinForms and Wpf , it is time to get to client-serve...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>We collect user activity in JS and ASP</h1><div class="post__text post__text-html js-mediator-article">  After writing the functionality of the autorecorder of user actions, called by us breadcrumbs, in <a href="https://habrahabr.ru/company/devexpress/blog/342530/">WinForms</a> and <a href="https://habrahabr.ru/company/devexpress/blog/343358/">Wpf</a> , it is time to get to client-server technologies. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/d11/4eb/064/d114eb064787257a148e2354adea1add.jpg" alt="image"><br>  Let's start with simple - javascript.  Unlike desktop applications, everything is pretty simple here - we subscribe to events, write down the necessary data and, in general, everything. <br><a name="habracut"></a><br>  We use standard <a href="https://developer.mozilla.org/en-US/docs/Web/API/EventTarget/addEventListener">addEventListener</a> to subscribe to events in js.  We hang event handlers on the window object in order to receive event notifications from all page elements. <br><br>  Let's write a class that will subscribe to all the events we need: 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <pre><code class="javascript hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">eventRecorder</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">constructor</span></span>() { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>._events = [ <span class="hljs-string"><span class="hljs-string">"DOMContentLoaded"</span></span>, <span class="hljs-string"><span class="hljs-string">"click"</span></span>, ..., <span class="hljs-string"><span class="hljs-string">"submit"</span></span> ]; } startListening(eventCallback) { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>._mainCallback = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">event</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.collectBreadcrumb(event, eventCallback); }.bind(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">let</span></span> i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>._events.length; i++) { <span class="hljs-built_in"><span class="hljs-built_in">window</span></span>.addEventListener( <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>._events[i], <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>._mainCallback, <span class="hljs-literal"><span class="hljs-literal">false</span></span> ); } } stopListening() { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>._mainCallback) { <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">let</span></span> i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>._events.length; i++) { <span class="hljs-built_in"><span class="hljs-built_in">window</span></span>.removeEventListener( <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>._events[i], <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>._mainCallback, <span class="hljs-literal"><span class="hljs-literal">false</span></span> ); } } } }</code> </pre> <br>  Now we are waiting for a fascinating torment of choice of the most valuable events for which it makes sense to subscribe.  First we find a complete list of events: <a href="https://developer.mozilla.org/en-US/docs/Web/Events">Events</a> .  Oh, how many of them ... In order not to clutter up the log with a bunch of extra information, you have to choose the most important events: <br><br><ul><li>  <a href="https://developer.mozilla.org/en-US/docs/Web/Events/DOMContentLoaded">DOMContentLoaded</a> - it is necessary to know if a page has already been loaded. </li><li>  Mouse events ( <a href="https://developer.mozilla.org/en-US/docs/Web/Events/click">click,</a> <a href="https://developer.mozilla.org/en-US/docs/Web/Events/dblclick">dblclick,</a> <a href="https://developer.mozilla.org/en-US/docs/Web/Events/auxclick">auxclick)</a> - there is not even doubt about the importance.  Know when and where the user clicked - well, just ‚ÄúMast hev‚Äù.  In js click, it works only on pressing the left mouse button.  To handle the middle and right keys, use the auxclick event. </li><li>  Keyboard events ( <a href="https://developer.mozilla.org/en-US/docs/Web/Events/keydown">keyDown,</a> <a href="https://developer.mozilla.org/en-US/docs/Web/Events/keypress">keyPress</a> , <a href="https://developer.mozilla.org/en-US/docs/Web/Events/keyup">keyUp)</a> - entered text, pressing the key combination - everything is important here. <br><br>  But what about the passwords, we will collect them?  This is not good, not pretty ... <br>  Let's check whether event.target is an input and get the type of this input.  If you received a password - write * instead of the value. <br><br><pre> <code class="javascript hljs">isSecureElement(event) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> event.target &amp;&amp; event.target.type &amp;&amp; event.target.type.toLowerCase() === <span class="hljs-string"><span class="hljs-string">"password"</span></span>; }</code> </pre></li><li>  Events of standard forms ( <a href="https://developer.mozilla.org/en-US/docs/Web/Events/submit">submit and</a> <a href="https://developer.mozilla.org/en-US/docs/Web/Events/reset">reset)</a> - information about sending form data or clearing it. <br></li><li>  Change event - where without events of change of standard form elements. </li></ul><br>  But there are events for which you are not subscribing to a simple addEventListener, as we did before.  These are events such as ajax requests and console logging.  Ajax requests are important to log in order to get a complete picture of user actions, and besides, crashes often occur during server interactions.  In the console, important debugging information can be written (in the form of warnings, errors, well, or just logs) both by the site developer and from third-party libraries. <br><br>  For these types of events, you will have to write wrappers for standard js functions.  In them, we substitute the standard function for our own (createBreadcrumb), where, in parallel with our actions (in this case, writing to breadcrumbs), we call the previously saved standard function.  Here‚Äôs how it looks for the console: <br><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">export</span></span> <span class="hljs-keyword"><span class="hljs-keyword">default</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">consoleEventRecorder</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">constructor</span></span>() { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>._events = [ <span class="hljs-string"><span class="hljs-string">"log"</span></span>, <span class="hljs-string"><span class="hljs-string">"error"</span></span>, <span class="hljs-string"><span class="hljs-string">"warn"</span></span> ]; } startListening(eventCallback) { <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">let</span></span> i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>._events.length; i++) { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.wrapObject(<span class="hljs-built_in"><span class="hljs-built_in">console</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>._events[i], eventCallback); } } wrapObject(object, property, callback) { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>._defaultCallback[property] = object[property]; <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> wrapperClass = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>; object[property] = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> args = <span class="hljs-built_in"><span class="hljs-built_in">Array</span></span>.prototype.slice.call(<span class="hljs-built_in"><span class="hljs-built_in">arguments</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>); wrapperClass.createBreadcrumb(args, property, callback); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">typeof</span></span> wrapperClass._defaultCallback[property] === <span class="hljs-string"><span class="hljs-string">"function"</span></span>) { <span class="hljs-built_in"><span class="hljs-built_in">Function</span></span>.prototype.apply.call(wrapperClass. _defaultCallback[property], <span class="hljs-built_in"><span class="hljs-built_in">console</span></span>, args); } }; } }</code> </pre><br>  For ajax requests, everything is somewhat more complicated - besides the need to override the standard open function, you must also add a callback to the onload function to receive data on the request status change, otherwise we will not get the server response code. <br><br>  And that's what happened with us: <br><br><pre> <code class="javascript hljs">addXMLRequestListenerCallback(callback) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (XMLHttpRequest.callbacks) { XMLHttpRequest.callbacks.push(callback); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { XMLHttpRequest.callbacks = [callback]; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>._defaultCallback = XMLHttpRequest.prototype.open; <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> wrapper = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>; XMLHttpRequest.prototype.open = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> xhr = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-string"><span class="hljs-string">'onload'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> xhr) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!xhr.onload) { xhr.onload = callback; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> oldFunction = xhr.onload; xhr.onload = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ callback(<span class="hljs-built_in"><span class="hljs-built_in">Array</span></span>.prototype.slice.call(<span class="hljs-built_in"><span class="hljs-built_in">arguments</span></span>)); oldFunction.apply(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>, <span class="hljs-built_in"><span class="hljs-built_in">arguments</span></span>); } } } } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (e) { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.onreadystatechange = callback; } wrapper._defaultCallback.apply(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>, <span class="hljs-built_in"><span class="hljs-built_in">arguments</span></span>); } } }</code> </pre><br>  However, it is worth noting that wrappers have one serious drawback - the called function moves inside our function, and therefore the name of the file from which it was called changes. <br><br>  The full source code of the JavaScript client on ES6 can be viewed on <a href="">GitHub</a> .  Customer documentation is <a href="https://logify.devexpress.com/Alert/Documentation/Send/ApiReference/JS%3Futm_source%3Dpublication_breadcrumbs%26utm_campaign%3Dblog">here</a> . <br><br>  And now a little about what can be done to solve this problem in ASP.NET.  On the server side, we track all incoming requests that precede the fall.  For ASP.NET (WebForms + MVC) we implement on the basis of IHttpModule and the event <a href="httpapplication.beginrequest(v%3Dvs.110).aspx">HttpApplication.BeginRequest</a> : <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">using</span></span> System.Web; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">AspExceptionHandler</span></span> : <span class="hljs-title"><span class="hljs-title">IHttpModule</span></span> { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">OnInit</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">HttpApplication context</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(LogifyAlert.Instance.CollectBreadcrumbs) context.BeginRequest += <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.OnBeginRequest; } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> { } } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">OnBeginRequest</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">object</span></span></span></span><span class="hljs-function"><span class="hljs-params"> sender, EventArgs e</span></span></span><span class="hljs-function">)</span></span> { AspBreadcrumbsRecorder .Instance .AddBreadcrumb(sender <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> HttpApplication); } }</code> </pre><br>  To separate and filter requests from different users, we use a cookie tracker.  When saving information about the request, we check if there is a cookie we need in it.  If not yet, add and save its value, do not forget to validate: <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">using</span></span> System.Web; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">AspBreadcrumbsRecorder</span></span> : <span class="hljs-title"><span class="hljs-title">BreadcrumbsRecorderBase</span></span>{ <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">internal</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">AddBreadcrumb</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">HttpApplication httpApplication</span></span></span><span class="hljs-function">)</span></span> { ... HttpRequest request = httpApplication.Context.Request; HttpResponse response = httpApplication.Context.Response; Breadcrumb breadcrumb = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Breadcrumb(); breadcrumb.CustomData = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Dictionary&lt;<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>&gt;() { ... { <span class="hljs-string"><span class="hljs-string">"session"</span></span>, TryGetSessionId(request, response) } }; <span class="hljs-keyword"><span class="hljs-keyword">base</span></span>.AddBreadcrumb(breadcrumb); } <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> CookieName = <span class="hljs-string"><span class="hljs-string">"BreadcrumbsCookie"</span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">string</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">TryGetSessionId</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">HttpRequest request, HttpResponse response</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> cookieValue = <span class="hljs-literal"><span class="hljs-literal">null</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { HttpCookie cookie = request.Cookies[CookieName]; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(cookie != <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { Guid validGuid = Guid.Empty; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(Guid.TryParse(cookie.Value, <span class="hljs-keyword"><span class="hljs-keyword">out</span></span> validGuid)) cookieValue = cookie.Value; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { cookieValue = Guid.NewGuid().ToString(); cookie = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> HttpCookie(CookieName, cookieValue); cookie.HttpOnly = <span class="hljs-literal"><span class="hljs-literal">true</span></span>; response.Cookies.Add(cookie); } } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> { } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> cookieValue; } }</code> </pre><br>  This allows you not to pledge, for example, on SessionState and to separate unique sessions, even when the user is not yet <a href="httpsessionstate.sessionid.aspx">authorized</a> or the session is <a href="https://msdn.microsoft.com/en-us/library/system.web.sessionstate.sessionstatemode(v%3Dvs.110).aspx">turned off</a> altogether. <br><br><img src="https://habrastorage.org/webt/kq/mm/en/kqmmen1hmasxyjjlwicqcx52d6k.png"><br><br>  Thus, this approach works like in good old ASP.NET (WebForms + MVC), <br>  so in the new ASP.NET Core, where with the usual session the case is somewhat different: <br><br>  Middleware: <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">using</span></span> Microsoft.AspNetCore.Http; <span class="hljs-keyword"><span class="hljs-keyword">internal</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">LogifyAlertMiddleware</span></span> { RequestDelegate next; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">LogifyAlertMiddleware</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">RequestDelegate next</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.next = next; ... } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">async</span></span></span><span class="hljs-function"> Task </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Invoke</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">HttpContext context</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(LogifyAlert.Instance.CollectBreadcrumbs) NetCoreWebBreadcrumbsRecorder.Instance.AddBreadcrumb(context); <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> next(context); } ... } }</code> </pre><br>  Saving the request: <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">using</span></span> Microsoft.AspNetCore.Http; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">NetCoreWebBreadcrumbsRecorder</span></span> : <span class="hljs-title"><span class="hljs-title">BreadcrumbsRecorderBase</span></span> { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">internal</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">AddBreadcrumb</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">HttpContext context</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(context.Request != <span class="hljs-literal"><span class="hljs-literal">null</span></span> &amp;&amp; context.Request.Path != <span class="hljs-literal"><span class="hljs-literal">null</span></span> &amp;&amp; context.Response != <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { Breadcrumb breadcrumb = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Breadcrumb(); breadcrumb.CustomData = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Dictionary&lt;<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>&gt;() { ... { <span class="hljs-string"><span class="hljs-string">"session"</span></span>, TryGetSessionId(context) } }; <span class="hljs-keyword"><span class="hljs-keyword">base</span></span>.AddBreadcrumb(breadcrumb); } } <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> CookieName = <span class="hljs-string"><span class="hljs-string">"BreadcrumbsCookie"</span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">string</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">TryGetSessionId</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">HttpContext context</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> cookieValue = <span class="hljs-literal"><span class="hljs-literal">null</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> cookie = context.Request.Cookies[CookieName]; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(!<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>.IsNullOrEmpty(cookie)) { Guid validGuid = Guid.Empty; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(Guid.TryParse(cookie, <span class="hljs-keyword"><span class="hljs-keyword">out</span></span> validGuid)) cookieValue = cookie; } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>.IsNullOrEmpty(cookieValue)) { cookieValue = Guid.NewGuid().ToString(); context.Response.Cookies.Append(CookieName, cookieValue, <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> CookieOptions() { HttpOnly = <span class="hljs-literal"><span class="hljs-literal">true</span></span> }); } } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> { } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> cookieValue; } }</code> </pre><br>  Full source code for ASP.NET clients on GitHub: <a href="">ASP.NET</a> and <a href="">ASP.NET Core</a> . </div><p>Source: <a href="https://habr.com/ru/post/343816/">https://habr.com/ru/post/343816/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../343804/index.html">A bit about the .NET Framework and .NET Core [plus useful links]</a></li>
<li><a href="../343806/index.html">The digest of fresh materials from the world of the frontend for the last week ‚Ññ291 (November 27 - December 3, 2017)</a></li>
<li><a href="../343808/index.html">Where is my payment? How fraudsters earn freelancers</a></li>
<li><a href="../343810/index.html">Neural network to identify individuals embedded in the smartphone</a></li>
<li><a href="../343812/index.html">DotNext 2018 Piter Release Notes</a></li>
<li><a href="../343818/index.html">TypeScript: tslib library</a></li>
<li><a href="../343820/index.html">Technical diary: half a year developing mobile PvP</a></li>
<li><a href="../343822/index.html">Heading "We read articles for you." October - November 2017</a></li>
<li><a href="../343824/index.html">MySQL and partitioning</a></li>
<li><a href="../343826/index.html">Russia's first mitap on Apache Ignite, December 12</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>