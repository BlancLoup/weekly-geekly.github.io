<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Organization of on-line payments on the site. For those who have never done this, but are afraid that they will have to. Part 2: Architecture</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Following the first part , designed primarily to show that "the devil is not so bad as he is painted" 

 An article about the architecture of the part...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Organization of on-line payments on the site. For those who have never done this, but are afraid that they will have to. Part 2: Architecture</h1><div class="post__text post__text-html js-mediator-article">  Following the <a href="http://habrahabr.ru/blogs/webdev/75191/">first part</a> , designed primarily to show that "the devil is not so bad as he is painted" <br><br>  An article about the architecture of the part of the project that deals with online payments.  Intentionally, I would not like to describe in detail the API of a particular billing or the registration procedure in it.  The subtleties of specific billing need to be discussed separately, otherwise the topic simply does not reveal.  The purpose of the article: to discuss the option of architecture that allows stringing new types of billing and types of payments, with the least headache. <br><a name="habracut"></a><br>  So, for a start, imagine, we thought a <b>little</b> and made on our website a <b>very simple</b> sale of goods through one of the billing systems. <br><ol><li>  We have information about the product: Product ID, price, &lt;specifications&gt;. </li><li>  Users go to the site and click on the "buy" button.  Store information about the purchase: purchase ID, product ID, price of the product at that moment, &lt;customer information&gt;; </li><li>  The user watches his purchases, presses "pay" for one of them.  We save the payment information: payment ID, purchase ID, payment date, payment status (, payment amount), and send the user to the billing system; </li><li>  The script processing billing responses saves response data: response ID, &lt;all billing sent&gt;, response date, response status.  Checks the validity of the answer, according to the result of the check it maintains the status of the answer.  If everything is ok, then put the desired purchase status "paid" </li><li>  information about the paid purchase is displayed at the moderators marked "must be delivered" </li></ol><br>  * <em>Information about the buyer - it can be a user number, by which you can find all the necessary data, and can be directly data (address, phone, ...), if you do not want to burden your users with registration.</em> <br><br>  We debugged all this, and for a while we were even satisfied with our work.  But, more and more often we hear: it would be necessary to tie such a billing.  In addition, we want to sell not only products, but also different types of accounts to our users, and even let them pay separately if they want to raise their rating by 10 points, and so on and so forth.  Call it shopping, but we will keep in mind that purchases are now of a different type. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      As you know, a good idea comes afterwards.  Only when I had to screw a couple of billing systems and organize several different types of purchases, in my system the purchase processing and billing processing were separated, the common parts in working with different billing systems, patterns in processing purchases of different types were distinguished. <br><br>  The separation of the processing of purchases from the processing of billing operations makes it possible <br><ul><li>  connect once and in one place a new billing, no matter how many types of purchases exist in the system; </li><li>  connect once and in one place a new type of purchase, no matter how many billing should work with it; </li></ul><br>  When processing different types of purchases, you can see that all of them can be divided into components: <br><ol><li>  Information about a specific product is available in the system: ID (unique for this type), price, &lt;specifications&gt;.  This may be a description of the goods in the store, or a description of the type of account and the period of its validity, or a description of the service of increasing the rating by N positions; </li><li>  Saving information about the user's choice (which user, which type of product and which product number he chose); </li><li>  Change of purchase status (paid, deleted, ...); </li><li>  Realization of the purchase, let's call it that.  (for example: delivery of goods, or a change in account type for a specified period, or an increase in rating by N positions); </li></ol><br>  Now it is clear that there are fundamental differences only in paragraphs 1 and 4. If the interface of the class describing the type of purchase and the actions for making a purchase is observed, the processing scheme for various types of purchase becomes unified. <br><br>  Work with the billing system can be divided into points: <br><ol><li>  Saving payment information: payment ID, billing type, purchase ID, payment status, &lt;other characteristics&gt;; </li><li>  Redirecting the user to the billing system, indicating the payment number and the amount of the purchase; </li><li>  Check the validity of the response from the billing; </li><li>  Payment status change; </li><li>  If everything is OK, the call for processing the purchase (change the status of the purchase, the realization of the purchase, ...) </li></ol>  Points 2 and 3 for different billing will be yours.  T.O.  while observing the interface of the class describing the type of billing that implements functions 2 and 3, the scheme of working with different billing systems is also unified. <br><br>  Class diagram for visual display of the structure described: <br><br><img src="http://lh3.ggpht.com/_NpYUPRfPCNQ/SxLm1HsA6-I/AAAAAAAAABg/mar4AfpYHuc/billing.gif" alt="image"><br><br>  These are general principles that I try to follow in my work.  I think this scheme can and should be improved.  I hope for a constructive discussion. <br><br><hr><br>  I remember, in the first part of the article, that not only common words are expected of me, but also specific lines of code.  Approximately, the code of this construction is given below.  A real example, pulled out of context and trimmed to the maximum to highlight the main point.  Unfortunately, even with this, it turned out a bit too much code :) <br><br>  <em>Immediately make a reservation, in another language, it was possible to get along with the abstract class and its heirs, but since in PHP you cannot redefine the static function, the ancestors were divided into an interface + base class.</em> <br><br>  Shopping interface and an example for the implementation of a paid member policy: <br><blockquote><code><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="black"><font color="#0000ff">interface</font> InterfacePurchase { <br> <font color="#0000ff">public</font> function getId(); <br> <br> <font color="#0000ff">public</font> function getItemId(); <br> <font color="#0000ff">public</font> function setItemId ($val); <br> <br> <font color="#0000ff">public</font> function getItemType(); <br> <font color="#0000ff">public</font> function setItemType ($val); <br> <br> <font color="#0000ff">public</font> function getPrice(); <br> <font color="#0000ff">public</font> function setPrice ($val); <br> <br> <font color="#0000ff">public</font> function getUserId(); <br> <font color="#0000ff">public</font> function setUserId($val); <br> <br> <font color="#0000ff">public</font> function getStatus(); <br> <font color="#0000ff">public</font> function setStatus($val); <br> <br> <font color="#0000ff">public</font> function save (); <br> <br> <font color="#008000">/**</font> <br> <font color="#008000">*    </font> <br> <font color="#008000">*/</font> <br> <font color="#0000ff">public</font> function callbackPayment (); <br> <br> <font color="#008000">/**</font> <br> <font color="#008000">*  -.    ,   </font> <br> <font color="#008000">*/</font> <br> <font color="#0000ff">public</font> function getItem (); <br> } <br> <br> <font color="#0000ff">class</font> CPurchase { <br> <font color="#0000ff">protected</font> $_mPurchase = <font color="#0000ff">null</font> ; <br> <br> <font color="#008000">/**</font> <br> <font color="#008000">* @return InterfacePurchase</font> <br> <font color="#008000">**/</font> <br> <font color="#0000ff">public</font> <font color="#0000ff">static</font> function createPurchaseByType ($type) { <br> $purchase = <font color="#0000ff">null</font> ; <br> <font color="#0000ff">switch</font> ($type){ <br> <font color="#0000ff">case</font> PURCHASE_SHOP:     $purchase = <font color="#0000ff">new</font> CPurchaseShop(); break; <br> <font color="#0000ff">case</font> PURCHASE_ACCOUNT:    $purchase = <font color="#0000ff">new</font> CPurchaseAccount(); break; <br> <font color="#0000ff">case</font> PURCHASE_RAIT:      $purchase = <font color="#0000ff">new</font> CPurchaseRait(); break; <br> <font color="#008000">// ...</font> <br> <font color="#0000ff">default</font> : <font color="#0000ff">throw</font> <font color="#0000ff">new</font> ExceptionUnknownPurchaseType (__CLASS__); <br> } <br> $purchase-&gt;_mPurchase = <font color="#0000ff">new</font> CPurchaseItem (); <br> <font color="#0000ff">return</font> $purchase; <br> } <br> <br> <font color="#008000">/**</font> <br> <font color="#008000">* @return InterfacePurchase</font> <br> <font color="#008000">**/</font> <br> <font color="#0000ff">public</font> <font color="#0000ff">static</font> function loadPurchaseById($id){ <br> $purchase_item = CPurchaseItem::getById($id); <br> $purchase = self::createPurchaseByType($purchase_item-&gt;getType()); <br> $purchase-&gt;_mPurchase = $purchase_item; <br> } <br> <br> <font color="#0000ff">public</font> function getId() { <font color="#0000ff">return</font> $ <font color="#0000ff">this</font> -&gt;_mPurchase-&gt;getId(); } <br> <br> <font color="#0000ff">public</font> function getItemId() { <font color="#0000ff">return</font> $ <font color="#0000ff">this</font> -&gt;_mPurchase-&gt;getItemId();} <br> <font color="#0000ff">public</font> function setItemId ($val) { <font color="#0000ff">return</font> $ <font color="#0000ff">this</font> -&gt;_mPurchase-&gt;setItemId( $val ); } <br> <br> <font color="#0000ff">public</font> function getItemType() { <font color="#0000ff">return</font> $ <font color="#0000ff">this</font> -&gt;_mPurchase-&gt;getItemType(); } <br> <font color="#0000ff">public</font> function setItemType ($val) { <font color="#0000ff">return</font> $ <font color="#0000ff">this</font> -&gt;_mPurchase-&gt;setItemType( $val ); } <br> <br> <font color="#0000ff">public</font> function getPrice() { <font color="#0000ff">return</font> $ <font color="#0000ff">this</font> -&gt;_mPurchase-&gt;getPrice (); } <br> <font color="#0000ff">public</font> function setPrice ($val) { <font color="#0000ff">return</font> $ <font color="#0000ff">this</font> -&gt;_mPurchase-&gt;setPrice ( $val ); } <br> <br> <font color="#0000ff">public</font> function getUserId() { <font color="#0000ff">return</font> $ <font color="#0000ff">this</font> -&gt;_mPurchase-&gt;getUserId(); } <br> <font color="#0000ff">public</font> function setUserId($val) { <font color="#0000ff">return</font> $ <font color="#0000ff">this</font> -&gt;_mPurchase-&gt;setUserId($val); } <br> <br> <font color="#0000ff">public</font> function getStatus() { <font color="#0000ff">return</font> $ <font color="#0000ff">this</font> -&gt;_mPurchase-&gt;getStatus(); } <br> <font color="#0000ff">public</font> function setStatus($val) { <font color="#0000ff">return</font> $ <font color="#0000ff">this</font> -&gt;_mPurchase-&gt;setStatus($val); } <br> <br> <font color="#0000ff">public</font> function save () { $ <font color="#0000ff">this</font> -&gt;_mPurchase-&gt;save(); } <br> <br> } <br> <br> Class CPurchaseAccount extends CPurchase implements InterfacePurchase { <br> <br> <font color="#0000ff">public</font> function getItem (){ <br> $item = <font color="#0000ff">null</font> ; <br> If ($item_id = $ <font color="#0000ff">this</font> -&gt;getItemId()) { <br> $item = CMembership::getById($item_id); <br> } <br> <font color="#0000ff">return</font> $item; <br> } <br> <font color="#0000ff">public</font> function callbackPayment () { <br> $ <font color="#0000ff">this</font> -&gt;setStatus(PURCHASE_STATUS_OK); <br> ServiceAccount::setMembership($ <font color="#0000ff">this</font> -&gt;getUserId(), $ <font color="#0000ff">this</font> -&gt;getItemId()); <br> } <br> } <br></font> <br> <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></code> </blockquote> <br><br>  Billing interface and an example for the implementation of working with Robox: <br><blockquote> <code><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="black"><font color="#0000ff">interface</font> InterfaceBilling { <br> <font color="#0000ff">public</font> function getId(); <br> <br> <font color="#0000ff">public</font> function getPurchaseId(); <br> <font color="#0000ff">public</font> function setPurchaseId ($val); <br> <br> <font color="#0000ff">public</font> function getBillingType(); <br> <font color="#0000ff">public</font> function setBillingType ($val); <br> <br> <font color="#0000ff">public</font> function getStatus(); <br> <font color="#0000ff">public</font> function setStatus($val); <br> <br> <font color="#0000ff">public</font> function save (); <br> <br> <font color="#008000">/**</font> <br> <font color="#008000">*      </font> <br> <font color="#008000">*/</font> <br> <font color="#0000ff">public</font> function redirectToBilling (); <br> <br> <font color="#008000">/**</font> <br> <font color="#008000">*   , ,     </font> <br> <font color="#008000">*/</font> <br> <font color="#0000ff">public</font> <font color="#0000ff">static</font> function checkResponseFormat ($data); <br> <br> <font color="#008000">/**</font> <br> <font color="#008000">*     </font> <br> <font color="#008000">*/</font> <br> <font color="#0000ff">public</font> function checkResult ($data); <br> <br> <font color="#008000">/**</font> <br> <font color="#008000">*      .  ,    .</font> <br> <font color="#008000">*/</font> <br> <font color="#0000ff">public</font> function addResultInView ($view, $results); <br> } <br> <br> <font color="#0000ff">class</font> CBilling { <br> <font color="#0000ff">protected</font> $_mBilling = <font color="#0000ff">null</font> ; <br> <br> <font color="#008000">/**</font> <br> <font color="#008000">* @return InterfaceBilling</font> <br> <font color="#008000">**/</font> <br> <font color="#0000ff">public</font> <font color="#0000ff">static</font> function createBillingByType( $type ) { <br> <font color="#0000ff">switch</font> ($type){ <br> <font color="#0000ff">case</font> BILLING_ROBOX: $billing = <font color="#0000ff">new</font> CBillingRobox(); break; <br> <font color="#0000ff">case</font> BILLING_WM: $billing = <font color="#0000ff">new</font> CBillingWM(); break; <br> <font color="#008000">// ...</font> <br> <font color="#0000ff">default</font> : <font color="#0000ff">throw</font> <font color="#0000ff">new</font> ExceptionUnknownBillingType (__CLASS__); <br> } <br> $billing-&gt;_mBilling = <font color="#0000ff">new</font> CBillingItem(); <br> $ <font color="#0000ff">this</font> -&gt;setBillingType($type); <br> } <br> <br> <font color="#0000ff">public</font> <font color="#0000ff">static</font> function getBillingTypeByRequest($response_data) { <br> $billing_type = <font color="#0000ff">null</font> ; <br> <font color="#0000ff">if</font> (CBillingRobox::checkResponseFormat($response_data)) { <br> $billing_type = self::BILLING_ROBOX; <br> } <br> <font color="#0000ff">if</font> (CBillingWM::checkResponseFormat($response_data)) { <br> $billing_type = self::BILLING_WM; <br> } <br> <br> <font color="#0000ff">return</font> $billing_type; <br> } <br> <br> <font color="#0000ff">public</font> function getId() { <font color="#0000ff">return</font> $ <font color="#0000ff">this</font> -&gt;_mBilling-&gt;getId(); } <br> <br> <font color="#0000ff">public</font> function getPurchaseId() { <font color="#0000ff">return</font> $ <font color="#0000ff">this</font> -&gt;_mBilling-&gt;getPurchaseId(); } <br> <font color="#0000ff">public</font> function setPurchaseId ($val) { <font color="#0000ff">return</font> $ <font color="#0000ff">this</font> -&gt;_mBilling-&gt;setPurchaseId($val); } <br> <br> <font color="#0000ff">public</font> function getBillingType() { <font color="#0000ff">return</font> $ <font color="#0000ff">this</font> -&gt;_mBilling-&gt;getBillingType(); } <br> <font color="#0000ff">public</font> function setBillingType ($val) { <font color="#0000ff">return</font> $ <font color="#0000ff">this</font> -&gt;_mBilling-&gt;setBillingType($val); } <br> <br> <font color="#0000ff">public</font> function getStatus() { <font color="#0000ff">return</font> $ <font color="#0000ff">this</font> -&gt;_mBilling-&gt;getStatus(); } <br> <font color="#0000ff">public</font> function setStatus($val) { <font color="#0000ff">return</font> $ <font color="#0000ff">this</font> -&gt;_mBilling-&gt;setStatus($val); } <br> <br> <font color="#0000ff">public</font> function save () { $ <font color="#0000ff">this</font> -&gt;_mBilling-&gt;save(); } <br> <br> <font color="#0000ff">public</font> function checkSumm($summ) { <br> $purchase = CPurchaseItem::getById($ <font color="#0000ff">this</font> -&gt;getPurchaseId()); <br> <font color="#0000ff">return</font> intval($purchase-&gt;getPrice()) == intval($summ); <br> } <br> <br> <font color="#0000ff">public</font> function checkStatusNotFinish() { <br> $purchase = CPurchaseItem::getById($ <font color="#0000ff">this</font> -&gt;getPurchaseId()); <br> <font color="#0000ff">return</font> PURCHASE_STATUS_OK != $purchase-&gt;getStatus(); <br> } <br> } <br> <br> <font color="#0000ff">class</font> CBillingRobox extends CBilling implements InterfaceBilling { <br> <font color="#0000ff">public</font> function redirectToBilling () { <br> $redirect_uri = Config::getKey( <font color="#A31515">'pay_uri'</font> , <font color="#A31515">'robox'</font> ); <br> $purchase = CPurchaseItem::getById($ <font color="#0000ff">this</font> -&gt;getPurchaseId()); <br> $hash = array( <br> <font color="#A31515">'MrchLogin'</font> =&gt; Config::getKey( <font color="#A31515">'merchant_login'</font> , <font color="#A31515">'robox'</font> ), <br> <font color="#A31515">'OutSum'</font> =&gt; $purchase-&gt;getPrice(), <br> <font color="#A31515">'InvId'</font> =&gt; $ <font color="#0000ff">this</font> -&gt;getId(), <br> <font color="#A31515">'SignatureValue'</font> =&gt; $ <font color="#0000ff">this</font> -&gt;_getSignatureValue() <br> ); <br> <br> MyApplication::redirect($redirect_uri, $hash); <br> } <br> <br> <font color="#0000ff">public</font> <font color="#0000ff">static</font> function checkResponseFormat ($data) { <br> $is_id = isset($data[ <font color="#A31515">'InvId'</font> ]); <br> $is_summ = isset($data[ <font color="#A31515">'OutSum'</font> ]); <br> $is_resp_crc = isset($data[ <font color="#A31515">'SignatureValue'</font> ]); <br> $result = $is_id &amp;&amp; $is_summ &amp;&amp; $is_resp_crc; <br> <font color="#0000ff">return</font> $result; <br> } <br> <br> <font color="#0000ff">public</font> function checkResult ($data) { <br> $billing_item_id = isset($data[ <font color="#A31515">'InvId'</font> ])? $data[ <font color="#A31515">'InvId'</font> ]:0; <br> $summ = isset($data[ <font color="#A31515">'OutSum'</font> ])? $data[ <font color="#A31515">'OutSum'</font> ]:0; <br> $result = FALSE; <br> $purchase = <font color="#0000ff">null</font> ; <br> <font color="#0000ff">try</font> { <br> $ <font color="#0000ff">this</font> -&gt;_mBilling = CBillingItem::sgetById($billing_item_id); <br> $purchase = CPurchase::loadPurchaseById($ <font color="#0000ff">this</font> -&gt;getPurchaseId()); <br> } <font color="#0000ff">catch</font> (ExObjectNotFound $e) {} <br> <br> <font color="#0000ff">if</font> ($ <font color="#0000ff">this</font> -&gt;_mBilling &amp;&amp; $purchase) { <br> <br> $is_valid_control_summ = $ <font color="#0000ff">this</font> -&gt;_checkControlSumm($data); <br> $is_valid_summ = $ <font color="#0000ff">this</font> -&gt;_checkSumm($summ); <br> $is_valid_status = $ <font color="#0000ff">this</font> -&gt;_checkStatusNotFinish(); <br> <br> <font color="#0000ff">if</font> ($is_valid_control_summ &amp;&amp; $is_valid_summ &amp;&amp; $is_valid_status) { <br> $result = TRUE; <br> $ <font color="#0000ff">this</font> -&gt;callbackPayment(); <br> $purchase-&gt;callbackPayment(); <br> <br> } <br> } <br> <br> <font color="#0000ff">return</font> $result; <br> } <br> <font color="#0000ff">public</font> function addResultInView ($view, $result) { <br> <font color="#0000ff">if</font> ($result &amp;&amp; $ <font color="#0000ff">this</font> -&gt;getId()) { <br> $view-&gt;addText( <font color="#A31515">"OK"</font> ); <br> $view-&gt;addText($ <font color="#0000ff">this</font> -&gt;getId()); <br> } <font color="#0000ff">else</font> { <br> $view-&gt;addText( <font color="#A31515">"ERROR"</font> ); <br> } <br> } <br> <br> <font color="#0000ff">private</font> function _getSignatureValue() { <br> $purchase = CPurchaseItem::getById($ <font color="#0000ff">this</font> -&gt;getPurchaseId()); <br> $hash = array( <br> Config::getKey( <font color="#A31515">'merchant_login'</font> , <font color="#A31515">'robox'</font> ) , <br> $purchase-&gt;getPrice(), <br> $ <font color="#0000ff">this</font> -&gt;getId(), <br> Config::getKey( <font color="#A31515">'merchant_password1'</font> , <font color="#A31515">'robox'</font> ) <br> ); <br> <br> <font color="#0000ff">return</font> md5(join( <font color="#A31515">':'</font> , $hash)); <br> } <br> <font color="#0000ff">private</font> function checkControlSumm($data) { <br> $resp_crc = isset($data[ <font color="#A31515">'SignatureValue'</font> ])? $data[ <font color="#A31515">'SignatureValue'</font> ]:0; <br> <font color="#0000ff">return</font> strtoupper(self::getControlSumm($data)) == strtoupper($resp_crc); <br> } <br> <font color="#0000ff">static</font> <font color="#0000ff">public</font> function getControlSumm($data) { <br> $hash = array( <br> isset($data[ <font color="#A31515">'OutSum'</font> ])? $data[ <font color="#A31515">'OutSum'</font> ]: <font color="#A31515">''</font> , <br> isset($data[ <font color="#A31515">'InvId'</font> ])? $data[ <font color="#A31515">'InvId'</font> ]: <font color="#A31515">''</font> , <br> Config::getKey( <font color="#A31515">'merchant_password2'</font> , <font color="#A31515">'robox'</font> ) <br> ); <br> <font color="#0000ff">return</font> md5(join( <font color="#A31515">':'</font> , $hash)); <br> } <br> } <br></font> <br> <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></code> </blockquote> <br><br>  An example of using this architecture: <br><blockquote> <code><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="black"><font color="#0000ff">class</font> ModuleBilling { <br> <font color="#0000ff">private</font> function _createResponse(){ <br> <font color="#008000">// ,   </font> <br> } <br> <font color="#008000">// ,    :</font> <br> <font color="#0000ff">public</font> function actionResultPage () { <br> $response = $ <font color="#0000ff">this</font> -&gt;_createResponse(); <br> $response_data = $_REQUEST; <br> $view = <font color="#0000ff">new</font> View(); <br> <br> <font color="#0000ff">if</font> ( $billing_type = CBilling::getBillingTypeByRequest( $response_data ) ) { <br> <br> $billing = CBilling::createBillingByType($billing_type); <br> $result = $billing-&gt;checkResult($response_data); <br> <font color="#0000ff">if</font> ($result){ <br> $response-&gt;setStatus(CResponse::STATUS_OK); <br> } <font color="#0000ff">else</font> { <br> $response-&gt;setStatus(CResponse::STATUS_ERROR); <br> } <br> $response-&gt;save(); <br> $billing-&gt;addResultInView($view, $result); <br> } <br> <font color="#0000ff">return</font> $view; <br> } <br> <br> <font color="#008000">//     :</font> <br> <font color="#0000ff">public</font> function actionBilling($req = array()){ <br> $user = ServiceUser::checkAccess(); <br> $billing_type = Request::getQueryVar( <font color="#A31515">'type'</font> ); <br> $purchase_id = Request::getQueryVar( <font color="#A31515">'purchase'</font> ); <br> $purchase = CPurchase::loadPurchaseById($purchase_id); <br> $purchase-&gt;setStatus(PURCHASE_STATUS_WAITMONEY); <br> $purchase-&gt;save(); <br> <br> $billing = CBilling::createBillingByType($billing_type); <br> $billing-&gt;setPurchaseId($purchase_id); <br> $billing-&gt;setStatus(BILLING_STATUS_WAITMONEY); <br> $billing-&gt;save(); <br> $billing-&gt;redirectToBilling(); <br> } <br> } <br> <br> <font color="#008000">//     :</font> <br> ... <br> $action = <font color="#0000ff">new</font> ModuleBilling (); <br> $action-&gt;actionResultPage(); <br> ... <br></font> <br> <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></code> </blockquote> </div><p>Source: <a href="https://habr.com/ru/post/76742/">https://habr.com/ru/post/76742/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../76731/index.html">Text at any cost: PPT. Take the second</a></li>
<li><a href="../76732/index.html">HabraToolbar v0.1</a></li>
<li><a href="../76733/index.html">Peculiarities of national outsourcing</a></li>
<li><a href="../76737/index.html">There is no future or what stops progress</a></li>
<li><a href="../76738/index.html">Code style</a></li>
<li><a href="../76743/index.html">Dynamic promo in Magento</a></li>
<li><a href="../76744/index.html">Robots are dancing</a></li>
<li><a href="../76747/index.html">Transitional age, reality, reality or reality?</a></li>
<li><a href="../76749/index.html">Browser loading of several files</a></li>
<li><a href="../76750/index.html">Why does nothing change?</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>