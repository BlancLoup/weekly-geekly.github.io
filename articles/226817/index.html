<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Yandex and security. As we studied and neutralized wrappers (aggressive adware)</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Recently, our support team began to complain more about dubious ads and pop-ups on the Yandex main page. People reported that unwanted ads pursue them...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Yandex and security. As we studied and neutralized wrappers (aggressive adware)</h1><div class="post__text post__text-html js-mediator-article">  Recently, our support team began to complain more about dubious ads and pop-ups on the Yandex main page.  People reported that unwanted ads pursue them on other popular resources and social networks (Mail.ru, Vkontakte, etc.).  The Yandex secure search team decided to figure out what was wrong. <br><br> <a href="http://habrahabr.ru/company/yandex/blog/226817/"><img src="https://habrastorage.org/getpro/habr/post_images/a90/94e/f1d/a9094ef1d4c067a4f40908a5a7abb1b7.png" width="400" height="336"></a> <br><br>  We analyzed the status of the systems of the users who applied and saw that they all had <a href="http://ru.wikipedia.org/wiki/Adware">Adware</a> class advertising software installed on their computers, which was the source of banners with questionable advertisements, pornography and other unwanted content.  It turned out that there are a number of programs with different names, but they seem to work, and the result of the work is almost identical.  Analysts decided not to stop there, dig deeper and analyze the algorithms of these programs. <br><a name="habracut"></a><br>  Of the programs found in the affected users, <b>BetterSurf</b> turned out to be the most common adware.  Here are the hashes of some of its modules: 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <blockquote>  0010aef925ea83579b70905d0e0c84b09df2a55f <br>  00190be9b6f2650416fe0154655f5aefd0a97eb0 </blockquote><br>  This software was installed on the system with this name, and was also sometimes hidden under the guise of <b>MediaViewer</b> .  The program itself is presented as a set of plug-ins for all popular browsers: Google Chrome, Mozilla Firefox and Internet Explorer.  These modules are based on almost identical js-code that loads web pages into the browser. <br><br>  Extensions each time a user visits a URL, send a GET request of the form: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/e6a/b6e/b1f/e6ab6eb1f1b8e2140c0d55f5ef6d65d2.png"><br><br>  The response to this request is a web page that looks like this: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/00b/0d3/c71/00b0d3c71d6aebc5582eff7e0c098707.png"><br><br>  During its processing, the browser loads a whole set of js-scripts, some of which are packed. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/1d8/72d/350/1d872d35005be1eb3373670609191c5a.png"><br>  <i>Web proxy log, during the operation of the Adware-plugin in the browser</i> <br><br>  A detailed analysis showed that these scripts determine the user's software suite, the region, in some cases even install a flash-cookie, and also try to determine on which site the user is currently located. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/c09/9bd/0b7/c099bd0b72724f983316dce77dbddae8.png"><br><br>  As a result of the work of these scripts (if the user went to the link from the site, which is in the array of interest), the user, depending on certain parameters, loads the js script, which injects an additional banner into the DOM of the web resource. <br><br>  Below is an example of a list of sites, during the transition to which advertising banners are added: <br><br>  <b>mail.inbox.lv, mail.com mail.mailig.ig.com.br "," mail.ru "," mail.terra.com.br ","</b> <b><br></b>  <b>mail.tiscali.it "," mail.uol.com.br "," mail.virgilio.it "," mail.yandex.ru "," mail.voila.fr "," mailbeta.libero.it "," mailonline.com ‚Äù,‚Äú mailonsunday.co.uk ‚Äù,‚Äú mailtribune.com ‚Äù,‚Äú mainlinemedianews.com ‚Äù,‚Äú majorleaguegaming.com ‚Äù,‚Äú makeandtakes.com ‚Äù,‚Äú makemebabies.com ‚Äù,‚Äú maketecheasier.com ‚Äù,"</b> <b><br></b>  <b>makeupgeek.com "," malavida.com "," malvin.tv "," mamacheaps.com ","</b> <b><br></b>  <b>mamapop.com "," mamaslatinas.com "," mamba.ru ","</b> <b><br></b>  <b>manager.com.br ... (the list includes over 4000 different hosts)</b> <br><br>  In the course of their analysis, a rather interesting detail was also found, the code of some scripts began with a comment: <br><br>  <b>/ ** See <a href="http://www.dealply.com/">www.dealply.com</a> for details.</b>  <b>* // * JavaScriptJsTagUrl = DealPlyScriptTagUrlMagic;</b>  <b>* /</b> <br><br>  Then came the packaging.  If you unpack these scripts, you can find mechanisms for determining the user's software and injecting additional scripts.  A quick analysis of DealPly showed that similar scripts do occur in it, but they load content from other sites and do not load questionable ads. <br><br>  During the work, BetterSurf not only builds in unwanted advertising, but also replaces the original one on some resources.  So, for example, the main Yandex page looks like with additional advertising embedded in its DOM. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/16e/92a/531/16e92a53140d0378ce3cc0d5e231e04d.png"><br><br>  Banners are constantly rotated and sometimes clicking on them can lead to the installation of malware. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/399/161/c16/399161c16964ff8997570e747c89c043.png"><br><br>  Perhaps the attackers have integrated part of the DealPly libraries into their aggressive Adware programs for convenience, and maybe for disguise - we don‚Äôt have the exact answer to this question. <br><br>  The second most common among AdWare-affected users was the AddLyrics program.  Some hashes of its modules: <br><br><blockquote>  aa8b5da964415c138b917953459a735d7d188b0d <br>  d164a3561886a4a74782bd5887766c2ca4261141 </blockquote><br>  This Adware-software works in the same way as BetterSurf (it loads scripts from rvzr-a.akamaihd.net), but it has some interesting features.  In particular, the Chrome extension modifies HTTP headers to bypass Content Security Policy restrictions.  This allows you to modify the DOM of web pages that use this mechanism to protect their web pages from changes.  An example of code that disables the Content Security Policy is shown in the figure below. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/94d/917/4d6/94d9174d646b74e604cbd1a25434bd83.png"><br><br>  Analyzing the users' computers, we encountered other browser plugins that loaded and designed similar scripts.  Their principle of operation was very similar - various js scripts were uploaded to the web page in the browser via inject into the DOM web page tag <code><code><a href=""></a>  (  ,    <b>akamaihd.net</b> ),      .      <b>WeatherBAR</b> . <br> <br> ,            .,     -      .url-   .      ,     . <br> <br>   adware-   ,         .     ,  ,    adware-   -,        ,  -   . <br> <br> <img src="https://habrastorage.org/getpro/habr/post_images/142/ab9/772/142ab97721a074368fb17a666f299b6a.png"> <br> <br>  ,       (  )      . <br> <br>   ,   ,  ,      adware ,       ,        ,      . <br> <br>      ,  -   ,  ,   ,       .     ,       .   ,       drive-by-download ,   . <br> <br>  ,  ,        Adware,          ,       . <br> <br>        ,         -   .    ,         -.           . <br> <br>   ,    ,   adware        ,    .</code></code> </div><p>Source: <a href="https://habr.com/ru/post/226817/">https://habr.com/ru/post/226817/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../226801/index.html">Projects for competition from Intel + workshop on wearable electronics in hackspace</a></li>
<li><a href="../226803/index.html">PHDays IV CTF: how it was</a></li>
<li><a href="../226807/index.html">Maximum Transmission Unit (MTU). Myths and reefs</a></li>
<li><a href="../226809/index.html">Integrating PayPal Here into an iOS application</a></li>
<li><a href="../226815/index.html">Adobe Photoshop CC 2014: what's new?</a></li>
<li><a href="../226823/index.html">Creating audio plug-ins, part 8</a></li>
<li><a href="../226825/index.html">Cross selling: we increase the average amount of goods in the basket</a></li>
<li><a href="../226827/index.html">Mobile software development: integration issues</a></li>
<li><a href="../226829/index.html">Stock Market Toolkit: What are Options and How Do They Work?</a></li>
<li><a href="../226831/index.html">Backup Backup Comparison</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>