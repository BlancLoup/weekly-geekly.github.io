<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Unity3d We play with the mesh. Part 1 - Generating a mesh using an elevation map</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="A long time ago I worked with Unity3D. These times are gone, but warm and not so memorable memories remain. 


 The other day, I decided to clean up m...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Unity3d We play with the mesh. Part 1 - Generating a mesh using an elevation map</h1><div class="post__text post__text-html js-mediator-article"><p>  A long time ago I worked with Unity3D.  These times are gone, but warm and not so memorable memories remain. </p><br><p> The other day, I decided to clean up my cloud storage from old files and came across my old practices - the <code>assetpackage PlanetWalker</code> . </p><br><p>  It was an old project in which it was planned to travel through space and visit various planets, the surface of which was to be generated from a randomly chosen height map. </p><br><p>  Unfortunately, apart from the ship class and the unfinished mesh generation class, there was nothing in this project.  But I decided to fix it and write a couple of editor extensions.  Firstly, I solemnly swear that I am only plotting a prank ... </p><br><p><img src="https://habrastorage.org/web/e43/77b/092/e4377b092cea4dc1aa4596f8958288fa.PNG"></p><a name="habracut"></a><br><h1>  Content </h1><br><ol><li>  <a href="https://habrahabr.ru/post/328498/">Unity3d</a>  <a href="https://habrahabr.ru/post/328498/">We play with the mesh.</a>  <a href="https://habrahabr.ru/post/328498/">Part 1 - Generating a mesh using an elevation map</a> </li><li>  <a href="https://habrahabr.ru/post/328564/">Unity3d</a>  <a href="https://habrahabr.ru/post/328564/">We play with the mesh.</a>  <a href="https://habrahabr.ru/post/328564/">Part 2 - Deformation of the mesh with a height map</a> </li><li>  <a href="https://habrahabr.ru/post/329146/">Unity3d</a>  <a href="https://habrahabr.ru/post/329146/">We play with the mesh.</a>  <a href="https://habrahabr.ru/post/329146/">Part 3 - Collision Based Mesh Warp</a> </li></ol><br><p>  In the image above, you could see the mesh.  By the way, this is the already generated mesh using the height map.  However, before we start, I suggest you understand what a mesh is. </p><br><h1>  What is a mesh </h1><br><p>  We use a mesh to display visual geometry in our games.  But what is he like? </p><br><p>  In Unity mesh has: </p><br><ul><li>  vertices - an array of coordinates of the vertices of the mesh </li><li>  triangles - an array of data on how these vertices are interconnected </li><li>  normals - the data array of where each vertex looks (each normal is perpendicular to the plane of the vertices) </li><li>  uv - texture coordinates </li><li>  colors - an array of vertex colors (unfortunately, I can‚Äôt say anything about it - I have never worked with them) </li><li>  tangents - tangents to each vertex (needed for bump map shading) </li></ul><br><p>  That is, a mesh is a class with a set of attributes, with the help of which it is rendered, reflects light, displays texture, etc.  True, if you look at it from this point of view, then nothing complicated?  :) </p><br><p>  What I would like to note right away is that in Unity the number of vertices should not exceed 65025 pieces.  This can be solved by describing your mesh class.  But why? </p><br><h1>  What is a height map? </h1><br><p><img src="https://habrastorage.org/web/027/990/6e8/0279906e8f6e486db7e61fce87c856ec.jpg"></p><br><p>  You probably have already met the maps of heights.  Roughly speaking, the elevation map is such a black and white drawing.  And the darker the pixel, the lower the height at that point, and the brighter - the higher the height. </p><br><h1>  Theory </h1><br><p>  How can we build the mesh itself using a height map?  It turns out that we have a picture, the color of the pixel which is responsible for the height of the vertex.  In theory, we have to go through each pixel of the height map and find out what color it is, convert the pixel color to float from 0 to 1 and convert the resulting data into a mesh in accordance with the specified dimensions. </p><br><p>  <a href="https://docs.unity3d.com/ScriptReference/Texture2D.GetPixel.html">GetPixel</a> and <a href="https://docs.unity3d.com/ScriptReference/Color-grayscale.html">Color.grayscale</a> will help <a href="https://docs.unity3d.com/ScriptReference/Texture2D.GetPixel.html">us</a> with <a href="https://docs.unity3d.com/ScriptReference/Color-grayscale.html">this</a> .  Keep in mind that the texture of the height map must be checked <code>Read&amp;Write</code> , otherwise it will not work to read the data. </p><br><h1>  Basic preparations </h1><br><p>  With what a mesh we met, it's time to get to work.  In order not to clutter up the code, create the <code>ParentEditor</code> class.  In it we will thrust all sorts of auxiliary methods and we will inherit our extension scripts from it.  As planned, we will have editor windows, so the class itself will inherit from <code>EditorWindow</code> . </p><br><div class="spoiler">  <b class="spoiler_title">I think that explanations are not needed here.</b> <div class="spoiler_text"><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">using</span></span> UnityEditor; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> UnityEngine; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">ParentEditor</span></span> : <span class="hljs-title"><span class="hljs-title">EditorWindow</span></span> { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">CreatePaths</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!AssetDatabase.IsValidFolder(<span class="hljs-string"><span class="hljs-string">"Assets/MeshTools"</span></span>)) AssetDatabase.CreateFolder(<span class="hljs-string"><span class="hljs-string">"Assets"</span></span>, <span class="hljs-string"><span class="hljs-string">"MeshTools"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!AssetDatabase.IsValidFolder(<span class="hljs-string"><span class="hljs-string">"Assets/MeshTools/Meshes"</span></span>)) AssetDatabase.CreateFolder(<span class="hljs-string"><span class="hljs-string">"Assets/MeshTools"</span></span>, <span class="hljs-string"><span class="hljs-string">"Meshes"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!AssetDatabase.IsValidFolder(<span class="hljs-string"><span class="hljs-string">"Assets/MeshTools/Meshes/Generated"</span></span>)) AssetDatabase.CreateFolder(<span class="hljs-string"><span class="hljs-string">"Assets/MeshTools/Meshes"</span></span>, <span class="hljs-string"><span class="hljs-string">"Generated"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!AssetDatabase.IsValidFolder(<span class="hljs-string"><span class="hljs-string">"Assets/MeshTools/Meshes/Updated"</span></span>)) AssetDatabase.CreateFolder(<span class="hljs-string"><span class="hljs-string">"Assets/MeshTools/Meshes"</span></span>, <span class="hljs-string"><span class="hljs-string">"Updated"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!AssetDatabase.IsValidFolder(<span class="hljs-string"><span class="hljs-string">"Assets/MeshTools/Prefabs"</span></span>)) AssetDatabase.CreateFolder(<span class="hljs-string"><span class="hljs-string">"Assets/MeshTools"</span></span>, <span class="hljs-string"><span class="hljs-string">"Prefabs"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!AssetDatabase.IsValidFolder(<span class="hljs-string"><span class="hljs-string">"Assets/MeshTools/Prefabs/Generated"</span></span>)) AssetDatabase.CreateFolder(<span class="hljs-string"><span class="hljs-string">"Assets/MeshTools/Prefabs"</span></span>, <span class="hljs-string"><span class="hljs-string">"Generated"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!AssetDatabase.IsValidFolder(<span class="hljs-string"><span class="hljs-string">"Assets/MeshTools/Prefabs/Updated"</span></span>)) AssetDatabase.CreateFolder(<span class="hljs-string"><span class="hljs-string">"Assets/MeshTools/Prefabs"</span></span>, <span class="hljs-string"><span class="hljs-string">"Updated"</span></span>); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Cut</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">value</span></span></span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> Mathf.Min(<span class="hljs-keyword"><span class="hljs-keyword">value</span></span>, <span class="hljs-number"><span class="hljs-number">255</span></span>); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> Mesh </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">CopyMesh</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">Mesh mesh</span></span></span><span class="hljs-function">)</span></span> { Mesh newmesh = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Mesh(); newmesh.vertices = mesh.vertices; newmesh.triangles = mesh.triangles; newmesh.uv = mesh.uv; newmesh.normals = mesh.normals; newmesh.tangents = mesh.tangents; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> newmesh; } }</code> </pre> </div></div><br><p>  Fine!  Go to the interesting ... </p><br><h1>  Mesh generation </h1><br><p>  Create a new <code>MeshGenerator</code> class and inherit it from <code>ParentEditor</code> . </p><br><p>  Let's designate in it several variables we need, make them displayed and specify the path in the toolbar: </p><br><div class="spoiler">  <b class="spoiler_title">Meshhenerator</b> <div class="spoiler_text"><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">using</span></span> UnityEditor; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> UnityEngine; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">MeshGenerator</span></span> : <span class="hljs-title"><span class="hljs-title">ParentEditor</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> Texture2D heightMap; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> Material mat; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> Vector3 size = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Vector3(<span class="hljs-number"><span class="hljs-number">2048</span></span>, <span class="hljs-number"><span class="hljs-number">300</span></span>, <span class="hljs-number"><span class="hljs-number">2048</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> mname = <span class="hljs-string"><span class="hljs-string">"Enter name"</span></span>; GameObject generated; [MenuItem(<span class="hljs-string"><span class="hljs-string">"Tools/Mesh Generator"</span></span>)] <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Init</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { MeshGenerator mg = (MeshGenerator)GetWindow(<span class="hljs-keyword"><span class="hljs-keyword">typeof</span></span>(MeshGenerator)); mg.Show(); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">OnGUI</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { heightMap = (Texture2D)EditorGUILayout.ObjectField(<span class="hljs-string"><span class="hljs-string">"Height map"</span></span>, heightMap, <span class="hljs-keyword"><span class="hljs-keyword">typeof</span></span>(Texture2D), <span class="hljs-literal"><span class="hljs-literal">false</span></span>); mat = (Material)EditorGUILayout.ObjectField(<span class="hljs-string"><span class="hljs-string">"Material"</span></span>, mat, <span class="hljs-keyword"><span class="hljs-keyword">typeof</span></span>(Material), <span class="hljs-literal"><span class="hljs-literal">false</span></span>); size = EditorGUILayout.Vector3Field(<span class="hljs-string"><span class="hljs-string">"Size"</span></span>, size); mname = EditorGUILayout.TextField(<span class="hljs-string"><span class="hljs-string">"Name"</span></span>, mname); }</code> </pre> </div></div><br><p>  Let's now write a method that will generate a mesh for us and return a full GO </p><br><div class="spoiler">  <b class="spoiler_title">Generate</b> <div class="spoiler_text"><pre> <code class="cs hljs"> <span class="hljs-function"><span class="hljs-function">GameObject </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Generate</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { <span class="hljs-comment"><span class="hljs-comment">//  GO   ,   GameObject go = new GameObject(mname); go.transform.position = Vector3.zero; go.AddComponent&lt;MeshFilter&gt;(); go.AddComponent&lt;MeshRenderer&gt;(); // ,    .    -   if (mat != null) go.GetComponent&lt;Renderer&gt;().material = mat; else { Debug.LogError("No material attached! Aborting"); return null; } //    Unity   //        255 // 255*255 = 65025 int width = Cut(heightMap.width); int height = Cut(heightMap.height); //   Mesh mesh = new Mesh(); Vector3[] vertices = new Vector3[height * width]; //    Vector2[] UVs = new Vector2[height * width]; // uv  Vector4[] tangs = new Vector4[height * width]; //   //      Vector2 uvScale = new Vector2(1 / (width - 1), 1 / (height - 1)); Vector3 sizeScale = new Vector3(size.x / (width - 1), size.y, size.z / (height - 1)); //  ,     Vector2 (x, y) //     Vector3(x, y, z).   //     z  int index; float pixelHeight; for (int y = 0; y &lt; height; y++) { for (int x = 0; x &lt; width; x++) { index = y * width + x; //   pixelHeight = heightMap.GetPixel(x, y).grayscale; //       Vector3 vertex = new Vector3(x, pixelHeight, y); //   vertices[index] = Vector3.Scale(sizeScale, vertex); //         Vector2 cur_uv = new Vector2(x, y); //  uv  UVs[index] = Vector2.Scale(cur_uv, uvScale); //  uv        /* Vector*.Scale(Vector* a, Vector* b)     .  , , Vector3.Scale(a=(1, 2, 1), b=(2, 3, 1))    (2, 6, 1) */ /*  :           X.       ,        . W        -1,  1,         W   */ Vector3 leftV = new Vector3(x - 1, heightMap.GetPixel(x - 1, y).grayscale, y); Vector3 rightV = new Vector3(x + 1, heightMap.GetPixel(x + 1, y).grayscale, y); Vector3 tang = Vector3.Scale(sizeScale, rightV - leftV).normalized; tangs[index] = new Vector4(tang.x, tang.y, tang.z, 1); } } //      mesh.vertices = vertices; //   mesh.uv = UVs; //  uv  //     index = 0; int[] triangles = new int[(height - 1) * (width - 1) * 6]; for (int y = 0; y &lt; height - 1; y++) { for (int x = 0; x &lt; width - 1; x++) { //   triangles[index++] = (y * width) + x; triangles[index++] = ((y + 1) * width) + x; triangles[index++] = (y * width) + x + 1; triangles[index++] = ((y + 1) * width) + x; triangles[index++] = ((y + 1) * width) + x + 1; triangles[index++] = (y * width) + x + 1; } } //        mesh.triangles = triangles; //  ,    mesh.RecalculateNormals(); //          mesh.tangents = tangs; //     go.GetComponent&lt;MeshFilter&gt;().sharedMesh = mesh; return go; }</span></span></code> </pre> </div></div><br><p>  Super!  Generation sorted out.  It remains to embed it all in our extension.  Let's change our <code>OnGUI</code> method, at the same time adding a save function to it. </p><br><div class="spoiler">  <b class="spoiler_title">New OnGUI</b> <div class="spoiler_text"><pre> <code class="cs hljs"> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">OnGUI</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { heightMap = (Texture2D)EditorGUILayout.ObjectField(<span class="hljs-string"><span class="hljs-string">"Height map"</span></span>, heightMap, <span class="hljs-keyword"><span class="hljs-keyword">typeof</span></span>(Texture2D), <span class="hljs-literal"><span class="hljs-literal">false</span></span>); mat = (Material)EditorGUILayout.ObjectField(<span class="hljs-string"><span class="hljs-string">"Material"</span></span>, mat, <span class="hljs-keyword"><span class="hljs-keyword">typeof</span></span>(Material), <span class="hljs-literal"><span class="hljs-literal">false</span></span>); size = EditorGUILayout.Vector3Field(<span class="hljs-string"><span class="hljs-string">"Size"</span></span>, size); mname = EditorGUILayout.TextField(<span class="hljs-string"><span class="hljs-string">"Name"</span></span>, mname); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (GUILayout.Button(<span class="hljs-string"><span class="hljs-string">"Generate mesh"</span></span>, GUILayout.Height(<span class="hljs-number"><span class="hljs-number">20</span></span>))) generated = Generate(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (GUILayout.Button(<span class="hljs-string"><span class="hljs-string">"Save"</span></span>, GUILayout.Height(<span class="hljs-number"><span class="hljs-number">20</span></span>))) { Mesh generated_mesh = generated.GetComponent&lt;MeshFilter&gt;().sharedMesh; CreatePaths(); AssetDatabase.CreateAsset(generated_mesh, <span class="hljs-string"><span class="hljs-string">"Assets/MeshTools/Meshes/Generated/"</span></span> + mname + <span class="hljs-string"><span class="hljs-string">".asset"</span></span>); <span class="hljs-comment"><span class="hljs-comment">//   PrefabUtility.CreatePrefab("Assets/MeshTools/Prefabs/Generated/" + mname + ".prefab", generated); //    GO } }</span></span></code> </pre> </div></div><br><p>  If you did everything correctly, then you have a new drop-down menu item <code>Tools-&gt;Mesh Generator</code> and you can already test your samopisny extension of the editor by inserting height maps and materials there!  :) </p><br><p>  If something <code>ParentEditor</code> with you, check that you have created the <code>ParentEditor</code> class, and your class itself looks like this: </p><br><div class="spoiler">  <b class="spoiler_title">MeshGenerator.cs</b> <div class="spoiler_text"><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">using</span></span> UnityEditor; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> UnityEngine; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">MeshGenerator</span></span> : <span class="hljs-title"><span class="hljs-title">ParentEditor</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> Texture2D heightMap; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> Material mat; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> Vector3 size = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Vector3(<span class="hljs-number"><span class="hljs-number">2048</span></span>, <span class="hljs-number"><span class="hljs-number">300</span></span>, <span class="hljs-number"><span class="hljs-number">2048</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> mname = <span class="hljs-string"><span class="hljs-string">"Enter name"</span></span>; GameObject generated; [MenuItem(<span class="hljs-string"><span class="hljs-string">"Tools/Mesh Generator"</span></span>)] <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Init</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { MeshGenerator mg = (MeshGenerator)GetWindow(<span class="hljs-keyword"><span class="hljs-keyword">typeof</span></span>(MeshGenerator)); mg.Show(); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">OnGUI</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { heightMap = (Texture2D)EditorGUILayout.ObjectField(<span class="hljs-string"><span class="hljs-string">"Height map"</span></span>, heightMap, <span class="hljs-keyword"><span class="hljs-keyword">typeof</span></span>(Texture2D), <span class="hljs-literal"><span class="hljs-literal">false</span></span>); mat = (Material)EditorGUILayout.ObjectField(<span class="hljs-string"><span class="hljs-string">"Material"</span></span>, mat, <span class="hljs-keyword"><span class="hljs-keyword">typeof</span></span>(Material), <span class="hljs-literal"><span class="hljs-literal">false</span></span>); size = EditorGUILayout.Vector3Field(<span class="hljs-string"><span class="hljs-string">"Size"</span></span>, size); mname = EditorGUILayout.TextField(<span class="hljs-string"><span class="hljs-string">"Name"</span></span>, mname); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (GUILayout.Button(<span class="hljs-string"><span class="hljs-string">"Generate mesh"</span></span>, GUILayout.Height(<span class="hljs-number"><span class="hljs-number">20</span></span>))) generated = Generate(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (GUILayout.Button(<span class="hljs-string"><span class="hljs-string">"Save"</span></span>, GUILayout.Height(<span class="hljs-number"><span class="hljs-number">20</span></span>))) { Mesh generated_mesh = generated.GetComponent&lt;MeshFilter&gt;().sharedMesh; CreatePaths(); AssetDatabase.CreateAsset(generated_mesh, <span class="hljs-string"><span class="hljs-string">"Assets/MeshTools/Meshes/Generated/"</span></span> + mname + <span class="hljs-string"><span class="hljs-string">".asset"</span></span>); PrefabUtility.CreatePrefab(<span class="hljs-string"><span class="hljs-string">"Assets/MeshTools/Prefabs/Generated/"</span></span> + mname + <span class="hljs-string"><span class="hljs-string">".prefab"</span></span>, generated); } } <span class="hljs-function"><span class="hljs-function">GameObject </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Generate</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { GameObject go = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> GameObject(mname); go.transform.position = Vector3.zero; go.AddComponent&lt;MeshFilter&gt;(); go.AddComponent&lt;MeshRenderer&gt;(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (mat != <span class="hljs-literal"><span class="hljs-literal">null</span></span>) go.GetComponent&lt;Renderer&gt;().material = mat; <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { Debug.LogError(<span class="hljs-string"><span class="hljs-string">"No material attached! Aborting"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> width = Cut(heightMap.width); <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> height = Cut(heightMap.height); Mesh mesh = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Mesh(); Vector3[] vertices = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Vector3[height * width]; Vector2[] UVs = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Vector2[height * width]; Vector4[] tangs = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Vector4[height * width]; Vector2 uvScale = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Vector2(<span class="hljs-number"><span class="hljs-number">1</span></span> / (width - <span class="hljs-number"><span class="hljs-number">1</span></span>), <span class="hljs-number"><span class="hljs-number">1</span></span> / (height - <span class="hljs-number"><span class="hljs-number">1</span></span>)); Vector3 sizeScale = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Vector3(size.x / (width - <span class="hljs-number"><span class="hljs-number">1</span></span>), size.y, size.z / (height - <span class="hljs-number"><span class="hljs-number">1</span></span>)); <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> index; <span class="hljs-keyword"><span class="hljs-keyword">float</span></span> pixelHeight; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> y = <span class="hljs-number"><span class="hljs-number">0</span></span>; y &lt; height; y++) { <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> x = <span class="hljs-number"><span class="hljs-number">0</span></span>; x &lt; width; x++) { index = y * width + x; pixelHeight = heightMap.GetPixel(x, y).grayscale; Vector3 vertex = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Vector3(x, pixelHeight, y); vertices[index] = Vector3.Scale(sizeScale, vertex); Vector2 cur_uv = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Vector2(x, y); UVs[index] = Vector2.Scale(cur_uv, uvScale); Vector3 leftV = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Vector3(x - <span class="hljs-number"><span class="hljs-number">1</span></span>, heightMap.GetPixel(x - <span class="hljs-number"><span class="hljs-number">1</span></span>, y).grayscale, y); Vector3 rightV = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Vector3(x + <span class="hljs-number"><span class="hljs-number">1</span></span>, heightMap.GetPixel(x + <span class="hljs-number"><span class="hljs-number">1</span></span>, y).grayscale, y); Vector3 tang = Vector3.Scale(sizeScale, rightV - leftV).normalized; tangs[index] = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Vector4(tang.x, tang.y, tang.z, <span class="hljs-number"><span class="hljs-number">1</span></span>); } } mesh.vertices = vertices; mesh.uv = UVs; index = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">int</span></span>[] triangles = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span>[(height - <span class="hljs-number"><span class="hljs-number">1</span></span>) * (width - <span class="hljs-number"><span class="hljs-number">1</span></span>) * <span class="hljs-number"><span class="hljs-number">6</span></span>]; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> y = <span class="hljs-number"><span class="hljs-number">0</span></span>; y &lt; height - <span class="hljs-number"><span class="hljs-number">1</span></span>; y++) { <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> x = <span class="hljs-number"><span class="hljs-number">0</span></span>; x &lt; width - <span class="hljs-number"><span class="hljs-number">1</span></span>; x++) { triangles[index++] = (y * width) + x; triangles[index++] = ((y + <span class="hljs-number"><span class="hljs-number">1</span></span>) * width) + x; triangles[index++] = (y * width) + x + <span class="hljs-number"><span class="hljs-number">1</span></span>; triangles[index++] = ((y + <span class="hljs-number"><span class="hljs-number">1</span></span>) * width) + x; triangles[index++] = ((y + <span class="hljs-number"><span class="hljs-number">1</span></span>) * width) + x + <span class="hljs-number"><span class="hljs-number">1</span></span>; triangles[index++] = (y * width) + x + <span class="hljs-number"><span class="hljs-number">1</span></span>; } } mesh.triangles = triangles; mesh.RecalculateNormals(); mesh.tangents = tangs; go.GetComponent&lt;MeshFilter&gt;().sharedMesh = mesh; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> go; } }</code> </pre> </div></div><br><div class="spoiler">  <b class="spoiler_title">We are testing our extension</b> <div class="spoiler_text"><p>  Take the height map and specify <code>MaxSize</code> in 256, tick <code>Read&amp;Write</code> and click on <code>Apply</code> . <br><img src="https://habrastorage.org/web/100/11b/b7d/10011bb7d5134f86a0645e6efc43d1e4.PNG"></p><br><p>  Open our extension and set the parameters.  Choose <code>Tools-&gt;Mesh Generator</code> <br>  And we see the next window (in my case the window is already with the settings): <br><img src="https://habrastorage.org/web/5cd/368/388/5cd3683883dd4bb981602d8d25392d1d.PNG"><br>  Click on <code>Generate Mesh</code> and ... </p><br><p><img src="https://habrastorage.org/web/4f5/b3f/e75/4f5b3fe75bec455587499f295b02c989.PNG"><br>  <em>Shaded and Wireframe mapping</em> </p><br><p><img src="https://habrastorage.org/web/2ac/8a0/09a/2ac8a009acc641b188b5b29c0df6cfce.jpg"><br>  <em>Elevation map used</em> </p><br><p>  By clicking on the <code>Save</code> button we save the generated mesh and object prefab in the folders "Assets / MeshTools / Meshes / Generated" and "Assets / MeshTools / Prefabs / Generated", respectively. </p></div></div><br><p>  Mischief managed!  :) </p><br><p>  <a href="https://habrahabr.ru/post/328564/">Continue to indulge</a> ... </p></div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <p>Source: <a href="https://habr.com/ru/post/328498/">https://habr.com/ru/post/328498/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../328486/index.html">Ansible and telnet: when you can not, but really want</a></li>
<li><a href="../328490/index.html">How to remove your IP from the black list of Gmail</a></li>
<li><a href="../328492/index.html">How not to mess with the design. Instructions for dummies for 5 minutes</a></li>
<li><a href="../328494/index.html">Optical novelties from Ubiquiti</a></li>
<li><a href="../328496/index.html">Why business processes are not scary</a></li>
<li><a href="../328500/index.html">New Rust-mitap is already on May 18 in the LC: come - it will be useful</a></li>
<li><a href="../328502/index.html">Cisco ACR 2017 Threat Research: Changes on the Other Side of the Barricade</a></li>
<li><a href="../328504/index.html">Interesting questions on knowledge of C # and .NET mechanisms</a></li>
<li><a href="../328506/index.html">Implementation of the minimization of logical functions by the method of Kvayna \ Mac Klasky</a></li>
<li><a href="../328508/index.html">A blood test: from a light microscope to hematology analyzers</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>