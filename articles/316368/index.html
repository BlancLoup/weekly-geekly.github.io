<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Creating a blog engine with Phoenix and Elixir / Part 4. Add processing roles in controllers</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="From the translator: ‚Äú Elixir and Phoenix are a great example of where modern web development is heading. Already, these tools provide high-quality ac...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Creating a blog engine with Phoenix and Elixir / Part 4. Add processing roles in controllers</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/files/81c/359/9c0/81c3599c01a1461aa1ecf172a495a750.png"><br><br>  From the translator: ‚Äú <i>Elixir and Phoenix are a great example of where modern web development is heading.</i>  <i>Already, these tools provide high-quality access to real-time technologies for web applications.</i>  <i>Sites with increased interactivity, multiplayer browser games, microservices - those areas in which these technologies will serve a good service.</i>  <i>The following is a translation of a series of 11 articles that describe in detail the aspects of development on the Phoenix framework that would seem such a trivial thing as a blog engine.</i>  <i>But do not hurry to sulk, it will be really interesting, especially if the articles encourage you to pay attention to the Elixir or become its followers.</i> <i><br><br></i>  <i>In this section, we will end the distinction of access rights using roles.</i>  <i>The key point of this series of articles is that a lot of attention is paid to tests, and tests are great!</i> 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      At the moment, our application is based on: <br><br><ul><li>  <b>Elixir</b> : v1.3.1 </li><li>  <b>Phoenix</b> : v1.2.0 </li><li>  <b>Ecto</b> : v2.0.2 </li><li>  <b>Comeonin</b> : v2.5.2 </li></ul><br><h2>  Where we stayed </h2><br>  Last time, we parted with you by adding the concept of a role into models and creating support functions for tests to make your life a little easier.  Now we need to add role-based constraints inside the controllers.  Let's start by creating an auxiliary function that we can use in any controller. <br><br><h2>  Creating an auxiliary function for checking roles </h2><br>  The first step for today is to create a simple user check for administrator rights.  To do this, create a file <code>web/models/role_checker.ex</code> and fill it with the following code: <br><a name="habracut"></a><br><pre> <code class="hljs pgsql">defmodule Pxblog.RoleChecker <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> <span class="hljs-keyword"><span class="hljs-keyword">alias</span></span> Pxblog.Repo <span class="hljs-keyword"><span class="hljs-keyword">alias</span></span> Pxblog.<span class="hljs-keyword"><span class="hljs-keyword">Role</span></span> def is_admin?(<span class="hljs-keyword"><span class="hljs-keyword">user</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">role</span></span> = Repo.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">Role</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">user</span></span>.role_id)) &amp;&amp; <span class="hljs-keyword"><span class="hljs-keyword">role</span></span>.<span class="hljs-keyword"><span class="hljs-keyword">admin</span></span> <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-keyword"><span class="hljs-keyword">end</span></span></code> </pre> <br>  Also let's write some tests to cover this functionality.  Open the file <code>test/models/role_checker_test.exs</code> : <br><br><pre> <code class="hljs sql">defmodule Pxblog.RoleCheckerTest <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> Pxblog.ModelCase <span class="hljs-keyword"><span class="hljs-keyword">alias</span></span> Pxblog.TestHelper <span class="hljs-keyword"><span class="hljs-keyword">alias</span></span> Pxblog.RoleChecker <span class="hljs-keyword"><span class="hljs-keyword">test</span></span> <span class="hljs-string"><span class="hljs-string">"is_admin? is true when user has an admin role"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> {:ok, <span class="hljs-keyword"><span class="hljs-keyword">role</span></span>} = TestHelper.create_role(%{<span class="hljs-keyword"><span class="hljs-keyword">name</span></span>: <span class="hljs-string"><span class="hljs-string">"Admin"</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">admin</span></span>: <span class="hljs-literal"><span class="hljs-literal">true</span></span>}) {:ok, <span class="hljs-keyword"><span class="hljs-keyword">user</span></span>} = TestHelper.create_user(<span class="hljs-keyword"><span class="hljs-keyword">role</span></span>, %{email: <span class="hljs-string"><span class="hljs-string">"test@test.com"</span></span>, username: <span class="hljs-string"><span class="hljs-string">"user"</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">password</span></span>: <span class="hljs-string"><span class="hljs-string">"test"</span></span>, password_confirmation: <span class="hljs-string"><span class="hljs-string">"test"</span></span>}) assert RoleChecker.is_admin?(<span class="hljs-keyword"><span class="hljs-keyword">user</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-keyword"><span class="hljs-keyword">test</span></span> <span class="hljs-string"><span class="hljs-string">"is_admin? is false when user does not have an admin role"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> {:ok, <span class="hljs-keyword"><span class="hljs-keyword">role</span></span>} = TestHelper.create_role(%{<span class="hljs-keyword"><span class="hljs-keyword">name</span></span>: <span class="hljs-string"><span class="hljs-string">"User"</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">admin</span></span>: <span class="hljs-literal"><span class="hljs-literal">false</span></span>}) {:ok, <span class="hljs-keyword"><span class="hljs-keyword">user</span></span>} = TestHelper.create_user(<span class="hljs-keyword"><span class="hljs-keyword">role</span></span>, %{email: <span class="hljs-string"><span class="hljs-string">"test@test.com"</span></span>, username: <span class="hljs-string"><span class="hljs-string">"user"</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">password</span></span>: <span class="hljs-string"><span class="hljs-string">"test"</span></span>, password_confirmation: <span class="hljs-string"><span class="hljs-string">"test"</span></span>}) refute RoleChecker.is_admin?(<span class="hljs-keyword"><span class="hljs-keyword">user</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-keyword"><span class="hljs-keyword">end</span></span></code> </pre> <br>  In the first test we create an administrator, and in the second we create a regular user.  And at the end, check that the function <code>is_admin?</code>  returns <code>true</code> for the first and <code>false</code> for the second.  So how is the <code>is_admin?</code> function <code>is_admin?</code>  from the <code>RoleChecker</code> module requires a user, we can write a very simple test to check the performance.  It turns out the code in which we can be sure!  We run the tests and make sure they stay green. <br><br><h2>  We allow adding users only to the administrator. </h2><br>  Previously, we did not add any restrictions to the <code>UserController</code> , so now is the time to connect the <code>authorize_user</code> .  Let's quickly plan what we will do now.  We will allow users to edit, update and delete their own profiles, but only administrators can add new users. <br><br>  Under the <code>scrub_params</code> line in the <code>web/controllers/user_controller.ex</code> add the following: <br><br><pre> <code class="hljs ruby">plug <span class="hljs-symbol"><span class="hljs-symbol">:authorize_admin</span></span> <span class="hljs-keyword"><span class="hljs-keyword">when</span></span> action <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> [<span class="hljs-symbol"><span class="hljs-symbol">:new</span></span>, <span class="hljs-symbol"><span class="hljs-symbol">:create</span></span>] plug <span class="hljs-symbol"><span class="hljs-symbol">:authorize_user</span></span> <span class="hljs-keyword"><span class="hljs-keyword">when</span></span> action <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> [<span class="hljs-symbol"><span class="hljs-symbol">:edit</span></span>, <span class="hljs-symbol"><span class="hljs-symbol">:update</span></span>, <span class="hljs-symbol"><span class="hljs-symbol">:delete</span></span>]</code> </pre> <br>  And at the bottom of the file, add some private functions for processing user authorization and administrator authorization: <br><br><pre> <code class="hljs sql">defp authorize_user(conn, _) <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> <span class="hljs-keyword"><span class="hljs-keyword">user</span></span> = get_session(<span class="hljs-keyword"><span class="hljs-keyword">conn</span></span>, :<span class="hljs-keyword"><span class="hljs-keyword">current_user</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> <span class="hljs-keyword"><span class="hljs-keyword">user</span></span> &amp;&amp; (Integer.to_string(user.id) == conn.params[<span class="hljs-string"><span class="hljs-string">"id"</span></span>] || Pxblog.RoleChecker.is_admin?(<span class="hljs-keyword"><span class="hljs-keyword">user</span></span>)) <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> <span class="hljs-keyword"><span class="hljs-keyword">conn</span></span> <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">conn</span></span> |&gt; put_flash(:<span class="hljs-keyword"><span class="hljs-keyword">error</span></span>, <span class="hljs-string"><span class="hljs-string">"You are not authorized to modify that user!"</span></span>) |&gt; redirect(<span class="hljs-keyword"><span class="hljs-keyword">to</span></span>: page_path(<span class="hljs-keyword"><span class="hljs-keyword">conn</span></span>, :<span class="hljs-keyword"><span class="hljs-keyword">index</span></span>)) |&gt; halt() <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> defp authorize_admin(<span class="hljs-keyword"><span class="hljs-keyword">conn</span></span>, _) <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> <span class="hljs-keyword"><span class="hljs-keyword">user</span></span> = get_session(<span class="hljs-keyword"><span class="hljs-keyword">conn</span></span>, :<span class="hljs-keyword"><span class="hljs-keyword">current_user</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> <span class="hljs-keyword"><span class="hljs-keyword">user</span></span> &amp;&amp; Pxblog.RoleChecker.is_admin?(<span class="hljs-keyword"><span class="hljs-keyword">user</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> <span class="hljs-keyword"><span class="hljs-keyword">conn</span></span> <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">conn</span></span> |&gt; put_flash(:<span class="hljs-keyword"><span class="hljs-keyword">error</span></span>, <span class="hljs-string"><span class="hljs-string">"You are not authorized to create new users!"</span></span>) |&gt; redirect(<span class="hljs-keyword"><span class="hljs-keyword">to</span></span>: page_path(<span class="hljs-keyword"><span class="hljs-keyword">conn</span></span>, :<span class="hljs-keyword"><span class="hljs-keyword">index</span></span>)) |&gt; halt() <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-keyword"><span class="hljs-keyword">end</span></span></code> </pre> <br>  The <code>authorize_user</code> call is essentially identical to what we had in <code>PostController</code> , except for checking <code>RoleChecker.is_admin?</code>  . <br><br>  The <code>authorize_admin</code> function is even simpler.  We only verify that the current user is an administrator. <br><br>  Let's <code>test/controllers/user_controller_test.exs</code> back to the file <code>test/controllers/user_controller_test.exs</code> and change our tests so that they take into account the new conditions. <br><br>  Let's start by changing the setup block. <br><br><pre> <code class="hljs sql">setup <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> {:ok, user_role} = TestHelper.create_role(%{<span class="hljs-keyword"><span class="hljs-keyword">name</span></span>: <span class="hljs-string"><span class="hljs-string">"user"</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">admin</span></span>: <span class="hljs-literal"><span class="hljs-literal">false</span></span>}) {:ok, nonadmin_user} = TestHelper.create_user(user_role, %{email: <span class="hljs-string"><span class="hljs-string">"nonadmin@test.com"</span></span>, username: <span class="hljs-string"><span class="hljs-string">"nonadmin"</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">password</span></span>: <span class="hljs-string"><span class="hljs-string">"test"</span></span>, password_confirmation: <span class="hljs-string"><span class="hljs-string">"test"</span></span>}) {:ok, admin_role} = TestHelper.create_role(%{<span class="hljs-keyword"><span class="hljs-keyword">name</span></span>: <span class="hljs-string"><span class="hljs-string">"admin"</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">admin</span></span>: <span class="hljs-literal"><span class="hljs-literal">true</span></span>}) {:ok, admin_user} = TestHelper.create_user(admin_role, %{email: <span class="hljs-string"><span class="hljs-string">"admin@test.com"</span></span>, username: <span class="hljs-string"><span class="hljs-string">"admin"</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">password</span></span>: <span class="hljs-string"><span class="hljs-string">"test"</span></span>, password_confirmation: <span class="hljs-string"><span class="hljs-string">"test"</span></span>}) {:ok, <span class="hljs-keyword"><span class="hljs-keyword">conn</span></span>: build_conn(), admin_role: admin_role, user_role: user_role, nonadmin_user: nonadmin_user, admin_user: admin_user} <span class="hljs-keyword"><span class="hljs-keyword">end</span></span></code> </pre> <br>  Create a user role, an administrator, a regular user and an administrator within it, and then return them.  Thereby we will be able to use them in tests through pattern matching.  We will also need a helper function to log in, so copy the <code>login_user</code> function from <code>PostController</code> . <br><br><pre> <code class="hljs pgsql">defp login_user(conn, <span class="hljs-keyword"><span class="hljs-keyword">user</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> post conn, session_path(conn, :<span class="hljs-keyword"><span class="hljs-keyword">create</span></span>), <span class="hljs-keyword"><span class="hljs-keyword">user</span></span>: %{username: <span class="hljs-keyword"><span class="hljs-keyword">user</span></span>.username, <span class="hljs-keyword"><span class="hljs-keyword">password</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">user</span></span>.<span class="hljs-keyword"><span class="hljs-keyword">password</span></span>} <span class="hljs-keyword"><span class="hljs-keyword">end</span></span></code> </pre> <br>  We do not add any restrictions to the <code>index</code> action, so we can skip this test.  The next test, the "renders form for new resources" (representing the action of <code>new</code> ), the restriction is imposed.  The user must have administrator rights. <br><br>  Modify the test to match the following code: <br><br><pre> <code class="hljs pgsql">@tag <span class="hljs-keyword"><span class="hljs-keyword">admin</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">true</span></span> test "renders form for new resources", %{conn: conn, admin_user: admin_user} <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> conn = conn |&gt; login_user(admin_user) |&gt; <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(user_path(conn, :<span class="hljs-built_in"><span class="hljs-built_in">new</span></span>)) <span class="hljs-keyword"><span class="hljs-keyword">assert</span></span> html_response(conn, <span class="hljs-number"><span class="hljs-number">200</span></span>) =~ "New user" <span class="hljs-keyword"><span class="hljs-keyword">end</span></span></code> </pre> <br>  Add a line <code>@tag admin: true</code> over this test to mark it as an admin.  Thus, we can run only similar tests instead of the entire set.  Let's try: <br><br><pre> <code class="bash hljs">mix <span class="hljs-built_in"><span class="hljs-built_in">test</span></span> --only admin</code> </pre> <br>  In the output we get the error: <br><br><pre> <code class="bash hljs">1) <span class="hljs-built_in"><span class="hljs-built_in">test</span></span> renders form <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> new resources (Pxblog.UserControllerTest) <span class="hljs-built_in"><span class="hljs-built_in">test</span></span>/controllers/user_controller_test.exs:26 ** (KeyError) key :role_id not found <span class="hljs-keyword"><span class="hljs-keyword">in</span></span>: %{id: 348, username: ‚Äúadmin‚Äù} stacktrace: (pxblog) web/models/role_checker.ex:6: Pxblog.RoleChecker.is_admin?/1 (pxblog) web/controllers/user_controller.ex:84: Pxblog.UserController.authorize_admin/2 (pxblog) web/controllers/user_controller.ex:1: Pxblog.UserController.phoenix_controller_pipeline/2 (pxblog) lib/phoenix/router.ex:255: Pxblog.Router.dispatch/2 (pxblog) web/router.ex:1: Pxblog.Router.do_call/2 (pxblog) lib/pxblog/endpoint.ex:1: Pxblog.Endpoint.phoenix_pipeline/1 (pxblog) lib/phoenix/endpoint/render_errors.ex:34: Pxblog.Endpoint.call/2 (phoenix) lib/phoenix/<span class="hljs-built_in"><span class="hljs-built_in">test</span></span>/conn_test.ex:193: Phoenix.ConnTest.dispatch/5 <span class="hljs-built_in"><span class="hljs-built_in">test</span></span>/controllers/user_controller_test.exs:28</code> </pre> <br>  The problem here is that we are not passing the full user model to the <code>RoleChecker.is_admin?</code> function <code>RoleChecker.is_admin?</code>  .  And we transfer a small subset of data received by the <code>current_user</code> function from the <code>sign_in</code> function of the <code>sign_in</code> module. <br><br>  Let's add the <code>role_id</code> to them as well.  I made changes to the <code>web/controllers/session_controller.ex</code> file as shown below: <br><br><pre> <code class="hljs sql">defp sign_in(user, password, conn) <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> checkpw(<span class="hljs-keyword"><span class="hljs-keyword">password</span></span>, user.password_digest) <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> <span class="hljs-keyword"><span class="hljs-keyword">conn</span></span> |&gt; put_session(:<span class="hljs-keyword"><span class="hljs-keyword">current_user</span></span>, %{<span class="hljs-keyword"><span class="hljs-keyword">id</span></span>: user.id, username: user.username, role_id: user.role_id}) |&gt; put_flash(:info, <span class="hljs-string"><span class="hljs-string">"Sign in successful!"</span></span>) |&gt; redirect(<span class="hljs-keyword"><span class="hljs-keyword">to</span></span>: page_path(<span class="hljs-keyword"><span class="hljs-keyword">conn</span></span>, :<span class="hljs-keyword"><span class="hljs-keyword">index</span></span>)) <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> failed_login(<span class="hljs-keyword"><span class="hljs-keyword">conn</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-keyword"><span class="hljs-keyword">end</span></span></code> </pre> <br>  Now once again try running tests with the <code>admin</code> tag. <br><br><pre> <code class="bash hljs">$ mix <span class="hljs-built_in"><span class="hljs-built_in">test</span></span> --only admin</code> </pre> <br>  Green again!  Now we need to create tests for the reverse situation, when the user is not an administrator, but at the same time tries to enter the action of the new <code>UserController</code> controller.  Go back to the file <code>test/controllers/user_controller_test.exs</code> : <br><br><pre> <code class="hljs pgsql">@tag <span class="hljs-keyword"><span class="hljs-keyword">admin</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">true</span></span> test "redirects from new form when not admin", %{conn: conn, nonadmin_user: nonadmin_user} <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> conn = login_user(conn, nonadmin_user) conn = <span class="hljs-keyword"><span class="hljs-keyword">get</span></span> conn, user_path(conn, :<span class="hljs-built_in"><span class="hljs-built_in">new</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">assert</span></span> get_flash(conn, :error) == "You are not authorized to create new users!" <span class="hljs-keyword"><span class="hljs-keyword">assert</span></span> redirected_to(conn) == page_path(conn, :<span class="hljs-keyword"><span class="hljs-keyword">index</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">assert</span></span> conn.halted <span class="hljs-keyword"><span class="hljs-keyword">end</span></span></code> </pre> <br>  And do the same for the <code>create</code> action.  Create one test for both cases. <br><br><pre> <code class="hljs pgsql">@tag <span class="hljs-keyword"><span class="hljs-keyword">admin</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">true</span></span> test "creates resource and redirects when data is valid", %{conn: conn, user_role: user_role, admin_user: admin_user} <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> conn = login_user(conn, admin_user) conn = post conn, user_path(conn, :<span class="hljs-keyword"><span class="hljs-keyword">create</span></span>), <span class="hljs-keyword"><span class="hljs-keyword">user</span></span>: valid_create_attrs(user_role) <span class="hljs-keyword"><span class="hljs-keyword">assert</span></span> redirected_to(conn) == user_path(conn, :<span class="hljs-keyword"><span class="hljs-keyword">index</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">assert</span></span> Repo.get_by(<span class="hljs-keyword"><span class="hljs-keyword">User</span></span>, @valid_attrs) <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> @tag <span class="hljs-keyword"><span class="hljs-keyword">admin</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">true</span></span> test "redirects from creating user when not admin", %{conn: conn, user_role: user_role, nonadmin_user: nonadmin_user} <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> conn = login_user(conn, nonadmin_user) conn = post conn, user_path(conn, :<span class="hljs-keyword"><span class="hljs-keyword">create</span></span>), <span class="hljs-keyword"><span class="hljs-keyword">user</span></span>: valid_create_attrs(user_role) <span class="hljs-keyword"><span class="hljs-keyword">assert</span></span> get_flash(conn, :error) == "You are not authorized to create new users!" <span class="hljs-keyword"><span class="hljs-keyword">assert</span></span> redirected_to(conn) == page_path(conn, :<span class="hljs-keyword"><span class="hljs-keyword">index</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">assert</span></span> conn.halted <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> @tag <span class="hljs-keyword"><span class="hljs-keyword">admin</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">true</span></span> test "does not create resource and renders errors when data is invalid", %{conn: conn, admin_user: admin_user} <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> conn = login_user(conn, admin_user) conn = post conn, user_path(conn, :<span class="hljs-keyword"><span class="hljs-keyword">create</span></span>), <span class="hljs-keyword"><span class="hljs-keyword">user</span></span>: @invalid_attrs <span class="hljs-keyword"><span class="hljs-keyword">assert</span></span> html_response(conn, <span class="hljs-number"><span class="hljs-number">200</span></span>) =~ "New user" <span class="hljs-keyword"><span class="hljs-keyword">end</span></span></code> </pre> <br>  We can skip the <code>show</code> action, because  we have not added any new conditions to it.  We will act on the same template until the <code>user_controller_test.exs</code> file looks like: <br><br><pre> <code class="hljs sql">defmodule Pxblog.UserControllerTest <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> Pxblog.ConnCase <span class="hljs-keyword"><span class="hljs-keyword">alias</span></span> Pxblog.User <span class="hljs-keyword"><span class="hljs-keyword">alias</span></span> Pxblog.TestHelper @valid_create_attrs %{email: <span class="hljs-string"><span class="hljs-string">"test@test.com"</span></span>, username: <span class="hljs-string"><span class="hljs-string">"test"</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">password</span></span>: <span class="hljs-string"><span class="hljs-string">"test"</span></span>, password_confirmation: <span class="hljs-string"><span class="hljs-string">"test"</span></span>} @valid_attrs %{email: <span class="hljs-string"><span class="hljs-string">"test@test.com"</span></span>, username: <span class="hljs-string"><span class="hljs-string">"test"</span></span>} @invalid_attrs %{} setup <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> {:ok, user_role} = TestHelper.create_role(%{<span class="hljs-keyword"><span class="hljs-keyword">name</span></span>: <span class="hljs-string"><span class="hljs-string">"user"</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">admin</span></span>: <span class="hljs-literal"><span class="hljs-literal">false</span></span>}) {:ok, nonadmin_user} = TestHelper.create_user(user_role, %{email: <span class="hljs-string"><span class="hljs-string">"nonadmin@test.com"</span></span>, username: <span class="hljs-string"><span class="hljs-string">"nonadmin"</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">password</span></span>: <span class="hljs-string"><span class="hljs-string">"test"</span></span>, password_confirmation: <span class="hljs-string"><span class="hljs-string">"test"</span></span>}) {:ok, admin_role} = TestHelper.create_role(%{<span class="hljs-keyword"><span class="hljs-keyword">name</span></span>: <span class="hljs-string"><span class="hljs-string">"admin"</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">admin</span></span>: <span class="hljs-literal"><span class="hljs-literal">true</span></span>}) {:ok, admin_user} = TestHelper.create_user(admin_role, %{email: <span class="hljs-string"><span class="hljs-string">"admin@test.com"</span></span>, username: <span class="hljs-string"><span class="hljs-string">"admin"</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">password</span></span>: <span class="hljs-string"><span class="hljs-string">"test"</span></span>, password_confirmation: <span class="hljs-string"><span class="hljs-string">"test"</span></span>}) {:ok, <span class="hljs-keyword"><span class="hljs-keyword">conn</span></span>: build_conn(), admin_role: admin_role, user_role: user_role, nonadmin_user: nonadmin_user, admin_user: admin_user} <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> defp valid_create_attrs(<span class="hljs-keyword"><span class="hljs-keyword">role</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> Map.put(@valid_create_attrs, :role_id, role.id) <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> defp login_user(<span class="hljs-keyword"><span class="hljs-keyword">conn</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">user</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> post <span class="hljs-keyword"><span class="hljs-keyword">conn</span></span>, session_path(<span class="hljs-keyword"><span class="hljs-keyword">conn</span></span>, :<span class="hljs-keyword"><span class="hljs-keyword">create</span></span>), <span class="hljs-keyword"><span class="hljs-keyword">user</span></span>: %{username: user.username, <span class="hljs-keyword"><span class="hljs-keyword">password</span></span>: user.password} <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-keyword"><span class="hljs-keyword">test</span></span> <span class="hljs-string"><span class="hljs-string">"lists all entries on index"</span></span>, %{<span class="hljs-keyword"><span class="hljs-keyword">conn</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">conn</span></span>} <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> <span class="hljs-keyword"><span class="hljs-keyword">conn</span></span> = <span class="hljs-keyword"><span class="hljs-keyword">get</span></span> <span class="hljs-keyword"><span class="hljs-keyword">conn</span></span>, user_path(<span class="hljs-keyword"><span class="hljs-keyword">conn</span></span>, :<span class="hljs-keyword"><span class="hljs-keyword">index</span></span>) assert html_response(<span class="hljs-keyword"><span class="hljs-keyword">conn</span></span>, <span class="hljs-number"><span class="hljs-number">200</span></span>) =~ <span class="hljs-string"><span class="hljs-string">"Listing users"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> @tag <span class="hljs-keyword"><span class="hljs-keyword">admin</span></span>: <span class="hljs-literal"><span class="hljs-literal">true</span></span> <span class="hljs-keyword"><span class="hljs-keyword">test</span></span> <span class="hljs-string"><span class="hljs-string">"renders form for new resources"</span></span>, %{<span class="hljs-keyword"><span class="hljs-keyword">conn</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">conn</span></span>, admin_user: admin_user} <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> <span class="hljs-keyword"><span class="hljs-keyword">conn</span></span> = login_user(<span class="hljs-keyword"><span class="hljs-keyword">conn</span></span>, admin_user) <span class="hljs-keyword"><span class="hljs-keyword">conn</span></span> = <span class="hljs-keyword"><span class="hljs-keyword">get</span></span> <span class="hljs-keyword"><span class="hljs-keyword">conn</span></span>, user_path(<span class="hljs-keyword"><span class="hljs-keyword">conn</span></span>, :<span class="hljs-keyword"><span class="hljs-keyword">new</span></span>) assert html_response(<span class="hljs-keyword"><span class="hljs-keyword">conn</span></span>, <span class="hljs-number"><span class="hljs-number">200</span></span>) =~ <span class="hljs-string"><span class="hljs-string">"New user"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> @tag <span class="hljs-keyword"><span class="hljs-keyword">admin</span></span>: <span class="hljs-literal"><span class="hljs-literal">true</span></span> <span class="hljs-keyword"><span class="hljs-keyword">test</span></span> <span class="hljs-string"><span class="hljs-string">"redirects from new form when not admin"</span></span>, %{<span class="hljs-keyword"><span class="hljs-keyword">conn</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">conn</span></span>, nonadmin_user: nonadmin_user} <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> <span class="hljs-keyword"><span class="hljs-keyword">conn</span></span> = login_user(<span class="hljs-keyword"><span class="hljs-keyword">conn</span></span>, nonadmin_user) <span class="hljs-keyword"><span class="hljs-keyword">conn</span></span> = <span class="hljs-keyword"><span class="hljs-keyword">get</span></span> <span class="hljs-keyword"><span class="hljs-keyword">conn</span></span>, user_path(<span class="hljs-keyword"><span class="hljs-keyword">conn</span></span>, :<span class="hljs-keyword"><span class="hljs-keyword">new</span></span>) assert get_flash(<span class="hljs-keyword"><span class="hljs-keyword">conn</span></span>, :<span class="hljs-keyword"><span class="hljs-keyword">error</span></span>) == <span class="hljs-string"><span class="hljs-string">"You are not authorized to create new users!"</span></span> assert redirected_to(<span class="hljs-keyword"><span class="hljs-keyword">conn</span></span>) == page_path(<span class="hljs-keyword"><span class="hljs-keyword">conn</span></span>, :<span class="hljs-keyword"><span class="hljs-keyword">index</span></span>) assert conn.halted <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> @tag <span class="hljs-keyword"><span class="hljs-keyword">admin</span></span>: <span class="hljs-literal"><span class="hljs-literal">true</span></span> <span class="hljs-keyword"><span class="hljs-keyword">test</span></span> <span class="hljs-string"><span class="hljs-string">"creates resource and redirects when data is valid"</span></span>, %{<span class="hljs-keyword"><span class="hljs-keyword">conn</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">conn</span></span>, user_role: user_role, admin_user: admin_user} <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> <span class="hljs-keyword"><span class="hljs-keyword">conn</span></span> = login_user(<span class="hljs-keyword"><span class="hljs-keyword">conn</span></span>, admin_user) <span class="hljs-keyword"><span class="hljs-keyword">conn</span></span> = post <span class="hljs-keyword"><span class="hljs-keyword">conn</span></span>, user_path(<span class="hljs-keyword"><span class="hljs-keyword">conn</span></span>, :<span class="hljs-keyword"><span class="hljs-keyword">create</span></span>), <span class="hljs-keyword"><span class="hljs-keyword">user</span></span>: valid_create_attrs(user_role) assert redirected_to(<span class="hljs-keyword"><span class="hljs-keyword">conn</span></span>) == user_path(<span class="hljs-keyword"><span class="hljs-keyword">conn</span></span>, :<span class="hljs-keyword"><span class="hljs-keyword">index</span></span>) assert Repo.get_by(<span class="hljs-keyword"><span class="hljs-keyword">User</span></span>, @valid_attrs) <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> @tag <span class="hljs-keyword"><span class="hljs-keyword">admin</span></span>: <span class="hljs-literal"><span class="hljs-literal">true</span></span> <span class="hljs-keyword"><span class="hljs-keyword">test</span></span> <span class="hljs-string"><span class="hljs-string">"redirects from creating user when not admin"</span></span>, %{<span class="hljs-keyword"><span class="hljs-keyword">conn</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">conn</span></span>, user_role: user_role, nonadmin_user: nonadmin_user} <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> <span class="hljs-keyword"><span class="hljs-keyword">conn</span></span> = login_user(<span class="hljs-keyword"><span class="hljs-keyword">conn</span></span>, nonadmin_user) <span class="hljs-keyword"><span class="hljs-keyword">conn</span></span> = post <span class="hljs-keyword"><span class="hljs-keyword">conn</span></span>, user_path(<span class="hljs-keyword"><span class="hljs-keyword">conn</span></span>, :<span class="hljs-keyword"><span class="hljs-keyword">create</span></span>), <span class="hljs-keyword"><span class="hljs-keyword">user</span></span>: valid_create_attrs(user_role) assert get_flash(<span class="hljs-keyword"><span class="hljs-keyword">conn</span></span>, :<span class="hljs-keyword"><span class="hljs-keyword">error</span></span>) == <span class="hljs-string"><span class="hljs-string">"You are not authorized to create new users!"</span></span> assert redirected_to(<span class="hljs-keyword"><span class="hljs-keyword">conn</span></span>) == page_path(<span class="hljs-keyword"><span class="hljs-keyword">conn</span></span>, :<span class="hljs-keyword"><span class="hljs-keyword">index</span></span>) assert conn.halted <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> @tag <span class="hljs-keyword"><span class="hljs-keyword">admin</span></span>: <span class="hljs-literal"><span class="hljs-literal">true</span></span> <span class="hljs-keyword"><span class="hljs-keyword">test</span></span> <span class="hljs-string"><span class="hljs-string">"does not create resource and renders errors when data is invalid"</span></span>, %{<span class="hljs-keyword"><span class="hljs-keyword">conn</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">conn</span></span>, admin_user: admin_user} <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> <span class="hljs-keyword"><span class="hljs-keyword">conn</span></span> = login_user(<span class="hljs-keyword"><span class="hljs-keyword">conn</span></span>, admin_user) <span class="hljs-keyword"><span class="hljs-keyword">conn</span></span> = post <span class="hljs-keyword"><span class="hljs-keyword">conn</span></span>, user_path(<span class="hljs-keyword"><span class="hljs-keyword">conn</span></span>, :<span class="hljs-keyword"><span class="hljs-keyword">create</span></span>), <span class="hljs-keyword"><span class="hljs-keyword">user</span></span>: @invalid_attrs assert html_response(<span class="hljs-keyword"><span class="hljs-keyword">conn</span></span>, <span class="hljs-number"><span class="hljs-number">200</span></span>) =~ <span class="hljs-string"><span class="hljs-string">"New user"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-keyword"><span class="hljs-keyword">test</span></span> <span class="hljs-string"><span class="hljs-string">"shows chosen resource"</span></span>, %{<span class="hljs-keyword"><span class="hljs-keyword">conn</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">conn</span></span>} <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> <span class="hljs-keyword"><span class="hljs-keyword">user</span></span> = Repo.insert! %<span class="hljs-keyword"><span class="hljs-keyword">User</span></span>{} <span class="hljs-keyword"><span class="hljs-keyword">conn</span></span> = <span class="hljs-keyword"><span class="hljs-keyword">get</span></span> <span class="hljs-keyword"><span class="hljs-keyword">conn</span></span>, user_path(<span class="hljs-keyword"><span class="hljs-keyword">conn</span></span>, :<span class="hljs-keyword"><span class="hljs-keyword">show</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">user</span></span>) assert html_response(<span class="hljs-keyword"><span class="hljs-keyword">conn</span></span>, <span class="hljs-number"><span class="hljs-number">200</span></span>) =~ <span class="hljs-string"><span class="hljs-string">"Show user"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-keyword"><span class="hljs-keyword">test</span></span> <span class="hljs-string"><span class="hljs-string">"renders page not found when id is nonexistent"</span></span>, %{<span class="hljs-keyword"><span class="hljs-keyword">conn</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">conn</span></span>} <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> assert_error_sent <span class="hljs-number"><span class="hljs-number">404</span></span>, fn -&gt; <span class="hljs-keyword"><span class="hljs-keyword">get</span></span> <span class="hljs-keyword"><span class="hljs-keyword">conn</span></span>, user_path(<span class="hljs-keyword"><span class="hljs-keyword">conn</span></span>, :<span class="hljs-keyword"><span class="hljs-keyword">show</span></span>, <span class="hljs-number"><span class="hljs-number">-1</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> @tag <span class="hljs-keyword"><span class="hljs-keyword">admin</span></span>: <span class="hljs-literal"><span class="hljs-literal">true</span></span> <span class="hljs-keyword"><span class="hljs-keyword">test</span></span> <span class="hljs-string"><span class="hljs-string">"renders form for editing chosen resource when logged in as that user"</span></span>, %{<span class="hljs-keyword"><span class="hljs-keyword">conn</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">conn</span></span>, nonadmin_user: nonadmin_user} <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> <span class="hljs-keyword"><span class="hljs-keyword">conn</span></span> = login_user(<span class="hljs-keyword"><span class="hljs-keyword">conn</span></span>, nonadmin_user) <span class="hljs-keyword"><span class="hljs-keyword">conn</span></span> = <span class="hljs-keyword"><span class="hljs-keyword">get</span></span> <span class="hljs-keyword"><span class="hljs-keyword">conn</span></span>, user_path(<span class="hljs-keyword"><span class="hljs-keyword">conn</span></span>, :edit, nonadmin_user) assert html_response(<span class="hljs-keyword"><span class="hljs-keyword">conn</span></span>, <span class="hljs-number"><span class="hljs-number">200</span></span>) =~ <span class="hljs-string"><span class="hljs-string">"Edit user"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> @tag <span class="hljs-keyword"><span class="hljs-keyword">admin</span></span>: <span class="hljs-literal"><span class="hljs-literal">true</span></span> <span class="hljs-keyword"><span class="hljs-keyword">test</span></span> <span class="hljs-string"><span class="hljs-string">"renders form for editing chosen resource when logged in as an admin"</span></span>, %{<span class="hljs-keyword"><span class="hljs-keyword">conn</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">conn</span></span>, admin_user: admin_user, nonadmin_user: nonadmin_user} <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> <span class="hljs-keyword"><span class="hljs-keyword">conn</span></span> = login_user(<span class="hljs-keyword"><span class="hljs-keyword">conn</span></span>, admin_user) <span class="hljs-keyword"><span class="hljs-keyword">conn</span></span> = <span class="hljs-keyword"><span class="hljs-keyword">get</span></span> <span class="hljs-keyword"><span class="hljs-keyword">conn</span></span>, user_path(<span class="hljs-keyword"><span class="hljs-keyword">conn</span></span>, :edit, nonadmin_user) assert html_response(<span class="hljs-keyword"><span class="hljs-keyword">conn</span></span>, <span class="hljs-number"><span class="hljs-number">200</span></span>) =~ <span class="hljs-string"><span class="hljs-string">"Edit user"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> @tag <span class="hljs-keyword"><span class="hljs-keyword">admin</span></span>: <span class="hljs-literal"><span class="hljs-literal">true</span></span> <span class="hljs-keyword"><span class="hljs-keyword">test</span></span> <span class="hljs-string"><span class="hljs-string">"redirects away from editing when logged in as a different user"</span></span>, %{<span class="hljs-keyword"><span class="hljs-keyword">conn</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">conn</span></span>, nonadmin_user: nonadmin_user, admin_user: admin_user} <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> <span class="hljs-keyword"><span class="hljs-keyword">conn</span></span> = login_user(<span class="hljs-keyword"><span class="hljs-keyword">conn</span></span>, nonadmin_user) <span class="hljs-keyword"><span class="hljs-keyword">conn</span></span> = <span class="hljs-keyword"><span class="hljs-keyword">get</span></span> <span class="hljs-keyword"><span class="hljs-keyword">conn</span></span>, user_path(<span class="hljs-keyword"><span class="hljs-keyword">conn</span></span>, :edit, admin_user) assert get_flash(<span class="hljs-keyword"><span class="hljs-keyword">conn</span></span>, :<span class="hljs-keyword"><span class="hljs-keyword">error</span></span>) == <span class="hljs-string"><span class="hljs-string">"You are not authorized to modify that user!"</span></span> assert redirected_to(<span class="hljs-keyword"><span class="hljs-keyword">conn</span></span>) == page_path(<span class="hljs-keyword"><span class="hljs-keyword">conn</span></span>, :<span class="hljs-keyword"><span class="hljs-keyword">index</span></span>) assert conn.halted <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> @tag <span class="hljs-keyword"><span class="hljs-keyword">admin</span></span>: <span class="hljs-literal"><span class="hljs-literal">true</span></span> <span class="hljs-keyword"><span class="hljs-keyword">test</span></span> <span class="hljs-string"><span class="hljs-string">"updates chosen resource and redirects when data is valid when logged in as that user"</span></span>, %{<span class="hljs-keyword"><span class="hljs-keyword">conn</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">conn</span></span>, nonadmin_user: nonadmin_user} <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> <span class="hljs-keyword"><span class="hljs-keyword">conn</span></span> = login_user(<span class="hljs-keyword"><span class="hljs-keyword">conn</span></span>, nonadmin_user) <span class="hljs-keyword"><span class="hljs-keyword">conn</span></span> = put <span class="hljs-keyword"><span class="hljs-keyword">conn</span></span>, user_path(<span class="hljs-keyword"><span class="hljs-keyword">conn</span></span>, :<span class="hljs-keyword"><span class="hljs-keyword">update</span></span>, nonadmin_user), <span class="hljs-keyword"><span class="hljs-keyword">user</span></span>: @valid_create_attrs assert redirected_to(<span class="hljs-keyword"><span class="hljs-keyword">conn</span></span>) == user_path(<span class="hljs-keyword"><span class="hljs-keyword">conn</span></span>, :<span class="hljs-keyword"><span class="hljs-keyword">show</span></span>, nonadmin_user) assert Repo.get_by(<span class="hljs-keyword"><span class="hljs-keyword">User</span></span>, @valid_attrs) <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> @tag <span class="hljs-keyword"><span class="hljs-keyword">admin</span></span>: <span class="hljs-literal"><span class="hljs-literal">true</span></span> <span class="hljs-keyword"><span class="hljs-keyword">test</span></span> <span class="hljs-string"><span class="hljs-string">"updates chosen resource and redirects when data is valid when logged in as an admin"</span></span>, %{<span class="hljs-keyword"><span class="hljs-keyword">conn</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">conn</span></span>, admin_user: admin_user} <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> <span class="hljs-keyword"><span class="hljs-keyword">conn</span></span> = login_user(<span class="hljs-keyword"><span class="hljs-keyword">conn</span></span>, admin_user) <span class="hljs-keyword"><span class="hljs-keyword">conn</span></span> = put <span class="hljs-keyword"><span class="hljs-keyword">conn</span></span>, user_path(<span class="hljs-keyword"><span class="hljs-keyword">conn</span></span>, :<span class="hljs-keyword"><span class="hljs-keyword">update</span></span>, admin_user), <span class="hljs-keyword"><span class="hljs-keyword">user</span></span>: @valid_create_attrs assert redirected_to(<span class="hljs-keyword"><span class="hljs-keyword">conn</span></span>) == user_path(<span class="hljs-keyword"><span class="hljs-keyword">conn</span></span>, :<span class="hljs-keyword"><span class="hljs-keyword">show</span></span>, admin_user) assert Repo.get_by(<span class="hljs-keyword"><span class="hljs-keyword">User</span></span>, @valid_attrs) <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> @tag <span class="hljs-keyword"><span class="hljs-keyword">admin</span></span>: <span class="hljs-literal"><span class="hljs-literal">true</span></span> <span class="hljs-keyword"><span class="hljs-keyword">test</span></span> <span class="hljs-string"><span class="hljs-string">"does not update chosen resource when logged in as different user"</span></span>, %{<span class="hljs-keyword"><span class="hljs-keyword">conn</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">conn</span></span>, nonadmin_user: nonadmin_user, admin_user: admin_user} <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> <span class="hljs-keyword"><span class="hljs-keyword">conn</span></span> = login_user(<span class="hljs-keyword"><span class="hljs-keyword">conn</span></span>, nonadmin_user) <span class="hljs-keyword"><span class="hljs-keyword">conn</span></span> = put <span class="hljs-keyword"><span class="hljs-keyword">conn</span></span>, user_path(<span class="hljs-keyword"><span class="hljs-keyword">conn</span></span>, :<span class="hljs-keyword"><span class="hljs-keyword">update</span></span>, admin_user), <span class="hljs-keyword"><span class="hljs-keyword">user</span></span>: @valid_create_attrs assert get_flash(<span class="hljs-keyword"><span class="hljs-keyword">conn</span></span>, :<span class="hljs-keyword"><span class="hljs-keyword">error</span></span>) == <span class="hljs-string"><span class="hljs-string">"You are not authorized to modify that user!"</span></span> assert redirected_to(<span class="hljs-keyword"><span class="hljs-keyword">conn</span></span>) == page_path(<span class="hljs-keyword"><span class="hljs-keyword">conn</span></span>, :<span class="hljs-keyword"><span class="hljs-keyword">index</span></span>) assert conn.halted <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> @tag <span class="hljs-keyword"><span class="hljs-keyword">admin</span></span>: <span class="hljs-literal"><span class="hljs-literal">true</span></span> <span class="hljs-keyword"><span class="hljs-keyword">test</span></span> <span class="hljs-string"><span class="hljs-string">"does not update chosen resource and renders errors when data is invalid"</span></span>, %{<span class="hljs-keyword"><span class="hljs-keyword">conn</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">conn</span></span>, nonadmin_user: nonadmin_user} <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> <span class="hljs-keyword"><span class="hljs-keyword">conn</span></span> = login_user(<span class="hljs-keyword"><span class="hljs-keyword">conn</span></span>, nonadmin_user) <span class="hljs-keyword"><span class="hljs-keyword">conn</span></span> = put <span class="hljs-keyword"><span class="hljs-keyword">conn</span></span>, user_path(<span class="hljs-keyword"><span class="hljs-keyword">conn</span></span>, :<span class="hljs-keyword"><span class="hljs-keyword">update</span></span>, nonadmin_user), <span class="hljs-keyword"><span class="hljs-keyword">user</span></span>: @invalid_attrs assert html_response(<span class="hljs-keyword"><span class="hljs-keyword">conn</span></span>, <span class="hljs-number"><span class="hljs-number">200</span></span>) =~ <span class="hljs-string"><span class="hljs-string">"Edit user"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> @tag <span class="hljs-keyword"><span class="hljs-keyword">admin</span></span>: <span class="hljs-literal"><span class="hljs-literal">true</span></span> <span class="hljs-keyword"><span class="hljs-keyword">test</span></span> <span class="hljs-string"><span class="hljs-string">"deletes chosen resource when logged in as that user"</span></span>, %{<span class="hljs-keyword"><span class="hljs-keyword">conn</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">conn</span></span>, user_role: user_role} <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> {:ok, <span class="hljs-keyword"><span class="hljs-keyword">user</span></span>} = TestHelper.create_user(user_role, @valid_create_attrs) <span class="hljs-keyword"><span class="hljs-keyword">conn</span></span> = login_user(<span class="hljs-keyword"><span class="hljs-keyword">conn</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">user</span></span>) |&gt; <span class="hljs-keyword"><span class="hljs-keyword">delete</span></span>(user_path(<span class="hljs-keyword"><span class="hljs-keyword">conn</span></span>, :<span class="hljs-keyword"><span class="hljs-keyword">delete</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">user</span></span>)) assert redirected_to(<span class="hljs-keyword"><span class="hljs-keyword">conn</span></span>) == user_path(<span class="hljs-keyword"><span class="hljs-keyword">conn</span></span>, :<span class="hljs-keyword"><span class="hljs-keyword">index</span></span>) refute Repo.get(<span class="hljs-keyword"><span class="hljs-keyword">User</span></span>, user.id) <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> @tag <span class="hljs-keyword"><span class="hljs-keyword">admin</span></span>: <span class="hljs-literal"><span class="hljs-literal">true</span></span> <span class="hljs-keyword"><span class="hljs-keyword">test</span></span> <span class="hljs-string"><span class="hljs-string">"deletes chosen resource when logged in as an admin"</span></span>, %{<span class="hljs-keyword"><span class="hljs-keyword">conn</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">conn</span></span>, user_role: user_role, admin_user: admin_user} <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> {:ok, <span class="hljs-keyword"><span class="hljs-keyword">user</span></span>} = TestHelper.create_user(user_role, @valid_create_attrs) <span class="hljs-keyword"><span class="hljs-keyword">conn</span></span> = login_user(<span class="hljs-keyword"><span class="hljs-keyword">conn</span></span>, admin_user) |&gt; <span class="hljs-keyword"><span class="hljs-keyword">delete</span></span>(user_path(<span class="hljs-keyword"><span class="hljs-keyword">conn</span></span>, :<span class="hljs-keyword"><span class="hljs-keyword">delete</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">user</span></span>)) assert redirected_to(<span class="hljs-keyword"><span class="hljs-keyword">conn</span></span>) == user_path(<span class="hljs-keyword"><span class="hljs-keyword">conn</span></span>, :<span class="hljs-keyword"><span class="hljs-keyword">index</span></span>) refute Repo.get(<span class="hljs-keyword"><span class="hljs-keyword">User</span></span>, user.id) <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> @tag <span class="hljs-keyword"><span class="hljs-keyword">admin</span></span>: <span class="hljs-literal"><span class="hljs-literal">true</span></span> <span class="hljs-keyword"><span class="hljs-keyword">test</span></span> <span class="hljs-string"><span class="hljs-string">"redirects away from deleting chosen resource when logged in as a different user"</span></span>, %{<span class="hljs-keyword"><span class="hljs-keyword">conn</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">conn</span></span>, user_role: user_role, nonadmin_user: nonadmin_user} <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> {:ok, <span class="hljs-keyword"><span class="hljs-keyword">user</span></span>} = TestHelper.create_user(user_role, @valid_create_attrs) <span class="hljs-keyword"><span class="hljs-keyword">conn</span></span> = login_user(<span class="hljs-keyword"><span class="hljs-keyword">conn</span></span>, nonadmin_user) |&gt; <span class="hljs-keyword"><span class="hljs-keyword">delete</span></span>(user_path(<span class="hljs-keyword"><span class="hljs-keyword">conn</span></span>, :<span class="hljs-keyword"><span class="hljs-keyword">delete</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">user</span></span>)) assert get_flash(<span class="hljs-keyword"><span class="hljs-keyword">conn</span></span>, :<span class="hljs-keyword"><span class="hljs-keyword">error</span></span>) == <span class="hljs-string"><span class="hljs-string">"You are not authorized to modify that user!"</span></span> assert redirected_to(<span class="hljs-keyword"><span class="hljs-keyword">conn</span></span>) == page_path(<span class="hljs-keyword"><span class="hljs-keyword">conn</span></span>, :<span class="hljs-keyword"><span class="hljs-keyword">index</span></span>) assert conn.halted <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-keyword"><span class="hljs-keyword">end</span></span></code> </pre> <br>  Run the entire test suite.  They all pass again! <br><br><h2>  We allow the administrator to change any posts. </h2><br>  Fortunately, we have already done most of the work and only this last piece remains.  After we finish with it, the administrator's functionality will be completely ready.  Let's open the <code>web/controllers/post_controller.ex</code> and change the <code>authorize_user</code> function to use the <code>RoleChecker.is_admin?</code> auxiliary function <code>RoleChecker.is_admin?</code>  .  If the user is an administrator, then we will give him full control over the change of user posts. <br><br><pre> <code class="hljs sql">defp authorize_user(conn, _) <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> <span class="hljs-keyword"><span class="hljs-keyword">user</span></span> = get_session(<span class="hljs-keyword"><span class="hljs-keyword">conn</span></span>, :<span class="hljs-keyword"><span class="hljs-keyword">current_user</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> <span class="hljs-keyword"><span class="hljs-keyword">user</span></span> &amp;&amp; (Integer.to_string(user.id) == conn.params[<span class="hljs-string"><span class="hljs-string">"user_id"</span></span>] || Pxblog.RoleChecker.is_admin?(<span class="hljs-keyword"><span class="hljs-keyword">user</span></span>)) <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> <span class="hljs-keyword"><span class="hljs-keyword">conn</span></span> <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">conn</span></span> |&gt; put_flash(:<span class="hljs-keyword"><span class="hljs-keyword">error</span></span>, <span class="hljs-string"><span class="hljs-string">"You are not authorized to modify that post!"</span></span>) |&gt; redirect(<span class="hljs-keyword"><span class="hljs-keyword">to</span></span>: page_path(<span class="hljs-keyword"><span class="hljs-keyword">conn</span></span>, :<span class="hljs-keyword"><span class="hljs-keyword">index</span></span>)) |&gt; halt() <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-keyword"><span class="hljs-keyword">end</span></span></code> </pre> <br>  <code>test/controllers/post_controller_test.exs</code> open the file <code>test/controllers/post_controller_test.exs</code> and add a few more tests to cover the authorization rules: <br><br><pre> <code class="hljs pgsql">test "redirects when trying to delete a post for a different user", %{conn: conn, <span class="hljs-keyword"><span class="hljs-keyword">role</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">role</span></span>, post: post} <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> {:ok, other_user} = TestHelper.create_user(<span class="hljs-keyword"><span class="hljs-keyword">role</span></span>, %{email: "test2@test.com", username: "test2", <span class="hljs-keyword"><span class="hljs-keyword">password</span></span>: "test", password_confirmation: "test"}) conn = <span class="hljs-keyword"><span class="hljs-keyword">delete</span></span> conn, user_post_path(conn, :<span class="hljs-keyword"><span class="hljs-keyword">delete</span></span>, other_user, post) <span class="hljs-keyword"><span class="hljs-keyword">assert</span></span> get_flash(conn, :error) == "You are not authorized to modify that post!" <span class="hljs-keyword"><span class="hljs-keyword">assert</span></span> redirected_to(conn) == page_path(conn, :<span class="hljs-keyword"><span class="hljs-keyword">index</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">assert</span></span> conn.halted <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> test "renders form for editing chosen resource when logged in as admin", %{conn: conn, <span class="hljs-keyword"><span class="hljs-keyword">user</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">user</span></span>, post: post} <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> {:ok, <span class="hljs-keyword"><span class="hljs-keyword">role</span></span>} = TestHelper.create_role(%{<span class="hljs-type"><span class="hljs-type">name</span></span>: "Admin", <span class="hljs-keyword"><span class="hljs-keyword">admin</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>}) {:ok, <span class="hljs-keyword"><span class="hljs-keyword">admin</span></span>} = TestHelper.create_user(<span class="hljs-keyword"><span class="hljs-keyword">role</span></span>, %{username: "admin", email: "admin@test.com", <span class="hljs-keyword"><span class="hljs-keyword">password</span></span>: "test", password_confirmation: "test"}) conn = login_user(conn, <span class="hljs-keyword"><span class="hljs-keyword">admin</span></span>) |&gt; <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(user_post_path(conn, :edit, <span class="hljs-keyword"><span class="hljs-keyword">user</span></span>, post)) <span class="hljs-keyword"><span class="hljs-keyword">assert</span></span> html_response(conn, <span class="hljs-number"><span class="hljs-number">200</span></span>) =~ "Edit post" <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> test "updates chosen resource and redirects when data is valid when logged in as admin", %{conn: conn, <span class="hljs-keyword"><span class="hljs-keyword">user</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">user</span></span>, post: post} <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> {:ok, <span class="hljs-keyword"><span class="hljs-keyword">role</span></span>} = TestHelper.create_role(%{<span class="hljs-type"><span class="hljs-type">name</span></span>: "Admin", <span class="hljs-keyword"><span class="hljs-keyword">admin</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>}) {:ok, <span class="hljs-keyword"><span class="hljs-keyword">admin</span></span>} = TestHelper.create_user(<span class="hljs-keyword"><span class="hljs-keyword">role</span></span>, %{username: "admin", email: "admin@test.com", <span class="hljs-keyword"><span class="hljs-keyword">password</span></span>: "test", password_confirmation: "test"}) conn = login_user(conn, <span class="hljs-keyword"><span class="hljs-keyword">admin</span></span>) |&gt; put(user_post_path(conn, :<span class="hljs-keyword"><span class="hljs-keyword">update</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">user</span></span>, post), post: @valid_attrs) <span class="hljs-keyword"><span class="hljs-keyword">assert</span></span> redirected_to(conn) == user_post_path(conn, :<span class="hljs-keyword"><span class="hljs-keyword">show</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">user</span></span>, post) <span class="hljs-keyword"><span class="hljs-keyword">assert</span></span> Repo.get_by(Post, @valid_attrs) <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> test "does not update chosen resource and renders errors when data is invalid when logged in as admin", %{conn: conn, <span class="hljs-keyword"><span class="hljs-keyword">user</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">user</span></span>, post: post} <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> {:ok, <span class="hljs-keyword"><span class="hljs-keyword">role</span></span>} = TestHelper.create_role(%{<span class="hljs-type"><span class="hljs-type">name</span></span>: "Admin", <span class="hljs-keyword"><span class="hljs-keyword">admin</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>}) {:ok, <span class="hljs-keyword"><span class="hljs-keyword">admin</span></span>} = TestHelper.create_user(<span class="hljs-keyword"><span class="hljs-keyword">role</span></span>, %{username: "admin", email: "admin@test.com", <span class="hljs-keyword"><span class="hljs-keyword">password</span></span>: "test", password_confirmation: "test"}) conn = login_user(conn, <span class="hljs-keyword"><span class="hljs-keyword">admin</span></span>) |&gt; put(user_post_path(conn, :<span class="hljs-keyword"><span class="hljs-keyword">update</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">user</span></span>, post), post: %{"body" =&gt; nil}) <span class="hljs-keyword"><span class="hljs-keyword">assert</span></span> html_response(conn, <span class="hljs-number"><span class="hljs-number">200</span></span>) =~ "Edit post" <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> test "deletes chosen resource when logged in as admin", %{conn: conn, <span class="hljs-keyword"><span class="hljs-keyword">user</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">user</span></span>, post: post} <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> {:ok, <span class="hljs-keyword"><span class="hljs-keyword">role</span></span>} = TestHelper.create_role(%{<span class="hljs-type"><span class="hljs-type">name</span></span>: "Admin", <span class="hljs-keyword"><span class="hljs-keyword">admin</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>}) {:ok, <span class="hljs-keyword"><span class="hljs-keyword">admin</span></span>} = TestHelper.create_user(<span class="hljs-keyword"><span class="hljs-keyword">role</span></span>, %{username: "admin", email: "admin@test.com", <span class="hljs-keyword"><span class="hljs-keyword">password</span></span>: "test", password_confirmation: "test"}) conn = login_user(conn, <span class="hljs-keyword"><span class="hljs-keyword">admin</span></span>) |&gt; <span class="hljs-keyword"><span class="hljs-keyword">delete</span></span>(user_post_path(conn, :<span class="hljs-keyword"><span class="hljs-keyword">delete</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">user</span></span>, post)) <span class="hljs-keyword"><span class="hljs-keyword">assert</span></span> redirected_to(conn) == user_post_path(conn, :<span class="hljs-keyword"><span class="hljs-keyword">index</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">user</span></span>) refute Repo.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(Post, post.id) <span class="hljs-keyword"><span class="hljs-keyword">end</span></span></code> </pre> <br>  Right now, our blogging engine as a whole works without a glitch, but there are a few bugs.  Maybe they appeared by mistake.  or we forgot something along the way.  So let's identify and eliminate them.  Also let's update all dependencies so that the application is launched on the latest version of all that is possible. <br><br><h2>  Adding a new user gives an error about missing roles </h2><br>  This was noticed by <b>nolotus</b> on the <b>Pxblog</b> page ( <a href="">https://github.com/Diamond/pxblog).</a>  Thank you! <br><br>  In the <code>part_3</code> branch <code>part_3</code> attempts to create a new user will result in an error due to the lack of a role (since we made the presence of <code>role_id</code> when creating the user).  Let's first examine the problem, and only then begin to fix it.  When we log in as an administrator, go to the address <code>/users/new</code> , fill in all the fields and click on the button, we get the following error: <br><br><img src="https://habrastorage.org/files/326/45a/6a9/32645a6a9bf04e19a195d12d4d5040db.png"><br>  Which happens because we require the user to enter a name, email, password, password confirmation.  But do not say anything about the role.  Now, knowing this, let's proceed to the decision.  We begin by submitting a list of possible roles to choose from on the form. <br><br>  We will need it in each of the actions: <code>new, create, edit  update</code> .  Add <code>alias Pxblog.Role</code> top of UserController ( <code>web/controllers/user_controller.ex</code> ) if this is not yet there.  Then we will make changes to all previously listed actions: <br><br><pre> <code class="hljs sql">def new(conn, _params) <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> <span class="hljs-keyword"><span class="hljs-keyword">roles</span></span> = Repo.all(<span class="hljs-keyword"><span class="hljs-keyword">Role</span></span>) changeset = User.changeset(%<span class="hljs-keyword"><span class="hljs-keyword">User</span></span>{}) render(<span class="hljs-keyword"><span class="hljs-keyword">conn</span></span>, <span class="hljs-string"><span class="hljs-string">"new.html"</span></span>, changeset: changeset, <span class="hljs-keyword"><span class="hljs-keyword">roles</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">roles</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-keyword"><span class="hljs-keyword">def</span></span> edit(<span class="hljs-keyword"><span class="hljs-keyword">conn</span></span>, %{<span class="hljs-string"><span class="hljs-string">"id"</span></span> =&gt; <span class="hljs-keyword"><span class="hljs-keyword">id</span></span>}) <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> <span class="hljs-keyword"><span class="hljs-keyword">roles</span></span> = Repo.all(<span class="hljs-keyword"><span class="hljs-keyword">Role</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">user</span></span> = Repo.get!(<span class="hljs-keyword"><span class="hljs-keyword">User</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">id</span></span>) changeset = User.changeset(<span class="hljs-keyword"><span class="hljs-keyword">user</span></span>) render(<span class="hljs-keyword"><span class="hljs-keyword">conn</span></span>, <span class="hljs-string"><span class="hljs-string">"edit.html"</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">user</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">user</span></span>, changeset: changeset, <span class="hljs-keyword"><span class="hljs-keyword">roles</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">roles</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-keyword"><span class="hljs-keyword">def</span></span> <span class="hljs-keyword"><span class="hljs-keyword">create</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">conn</span></span>, %{<span class="hljs-string"><span class="hljs-string">"user"</span></span> =&gt; user_params}) <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> <span class="hljs-keyword"><span class="hljs-keyword">roles</span></span> = Repo.all(<span class="hljs-keyword"><span class="hljs-keyword">Role</span></span>) changeset = User.changeset(%<span class="hljs-keyword"><span class="hljs-keyword">User</span></span>{}, user_params) <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> Repo.insert(changeset) <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> {:ok, _user} -&gt; <span class="hljs-keyword"><span class="hljs-keyword">conn</span></span> |&gt; put_flash(:info, <span class="hljs-string"><span class="hljs-string">"User created successfully."</span></span>) |&gt; redirect(<span class="hljs-keyword"><span class="hljs-keyword">to</span></span>: user_path(<span class="hljs-keyword"><span class="hljs-keyword">conn</span></span>, :<span class="hljs-keyword"><span class="hljs-keyword">index</span></span>)) {:<span class="hljs-keyword"><span class="hljs-keyword">error</span></span>, changeset} -&gt; render(<span class="hljs-keyword"><span class="hljs-keyword">conn</span></span>, <span class="hljs-string"><span class="hljs-string">"new.html"</span></span>, changeset: changeset, <span class="hljs-keyword"><span class="hljs-keyword">roles</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">roles</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-keyword"><span class="hljs-keyword">def</span></span> <span class="hljs-keyword"><span class="hljs-keyword">update</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">conn</span></span>, %{<span class="hljs-string"><span class="hljs-string">"id"</span></span> =&gt; <span class="hljs-keyword"><span class="hljs-keyword">id</span></span>, <span class="hljs-string"><span class="hljs-string">"user"</span></span> =&gt; user_params}) <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> <span class="hljs-keyword"><span class="hljs-keyword">roles</span></span> = Repo.all(<span class="hljs-keyword"><span class="hljs-keyword">Role</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">user</span></span> = Repo.get!(<span class="hljs-keyword"><span class="hljs-keyword">User</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">id</span></span>) changeset = User.changeset(<span class="hljs-keyword"><span class="hljs-keyword">user</span></span>, user_params) <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> Repo.update(changeset) <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> {:ok, <span class="hljs-keyword"><span class="hljs-keyword">user</span></span>} -&gt; <span class="hljs-keyword"><span class="hljs-keyword">conn</span></span> |&gt; put_flash(:info, <span class="hljs-string"><span class="hljs-string">"User updated successfully."</span></span>) |&gt; redirect(<span class="hljs-keyword"><span class="hljs-keyword">to</span></span>: user_path(<span class="hljs-keyword"><span class="hljs-keyword">conn</span></span>, :<span class="hljs-keyword"><span class="hljs-keyword">show</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">user</span></span>)) {:<span class="hljs-keyword"><span class="hljs-keyword">error</span></span>, changeset} -&gt; render(<span class="hljs-keyword"><span class="hljs-keyword">conn</span></span>, <span class="hljs-string"><span class="hljs-string">"edit.html"</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">user</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">user</span></span>, changeset: changeset, <span class="hljs-keyword"><span class="hljs-keyword">roles</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">roles</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-keyword"><span class="hljs-keyword">end</span></span></code> </pre> <br>  Please note that for each of them we have selected all the roles with the help of <code>Repo.all(Role)</code> and added them to the <code>assigns</code> list, which we pass to the view (including in case of an error). <br><br>  We also need to implement a drop-down list using auxiliary functions for forms from <code>Phoenix.Html</code> .  So let's see how this is done <a href="https://hexdocs.pm/phoenix_html/Phoenix.HTML.Form.html">in the documentation</a> : <br><br><pre> <code class="hljs sql"><span class="hljs-keyword"><span class="hljs-keyword">select</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">form</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">field</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">values</span></span>, opts \\ []) Generates a <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> tag <span class="hljs-keyword"><span class="hljs-keyword">with</span></span> the given values.</code> </pre> <br>  Drop-down lists expect as an argument <code>values</code> either a regular list (in the format of <code>[value, value, value]</code> ) or a list of keywords (in the format of <code>[displayed: value, displayed: value]</code> ).  In our case, we need to display the names of the roles and at the same time pass the value of the identifier of the selected role when sending the form.  We cannot just blindly throw the <code>@roles</code> variable into an auxiliary function, because it does not fit into any of the above formats.  So let's write a function in <code>View</code> that will simplify our task. <br><br><pre> <code class="hljs sql">defmodule Pxblog.UserView <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> Pxblog.Web, :<span class="hljs-keyword"><span class="hljs-keyword">view</span></span> <span class="hljs-keyword"><span class="hljs-keyword">def</span></span> roles_for_select(<span class="hljs-keyword"><span class="hljs-keyword">roles</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> <span class="hljs-keyword"><span class="hljs-keyword">roles</span></span> |&gt; Enum.map(&amp;[<span class="hljs-string"><span class="hljs-string">"#{&amp;1.name}"</span></span>: &amp;<span class="hljs-number"><span class="hljs-number">1.</span></span><span class="hljs-keyword"><span class="hljs-keyword">id</span></span>]) |&gt; List.flatten <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-keyword"><span class="hljs-keyword">end</span></span></code> </pre> <br>  We added the <code>roles_for_select</code> function, which simply accepts a collection of roles.  Let's look at line by line what this function does.  Let's start with the collection of roles, which we pass to the following function along the chain: <br><br><pre> <code class="hljs go">Enum.<span class="hljs-keyword"><span class="hljs-keyword">map</span></span>(&amp;[<span class="hljs-string"><span class="hljs-string">"#{&amp;1.name}"</span></span>: &amp;<span class="hljs-number"><span class="hljs-number">1.i</span></span>d])</code> </pre> <br>  Again I remind you that <code>&amp;/&amp;1</code> is an abbreviation for anonymous functions, which can be rewritten in its full version as follows: <br><br><pre> <code class="hljs pgsql">Enum.map(roles, fn <span class="hljs-keyword"><span class="hljs-keyword">role</span></span> -&gt; ["#{role.name}": <span class="hljs-keyword"><span class="hljs-keyword">role</span></span>.id] <span class="hljs-keyword"><span class="hljs-keyword">end</span></span>)</code> </pre> <br>  We launched the <code>map</code> operation to return a list of smaller key lists, where the name of the role is the key and the identifier of the role is the value. <br><br>  Suppose given some initial value for roles: <br><br><pre> <code class="hljs pgsql">roles = [%<span class="hljs-keyword"><span class="hljs-keyword">Role</span></span>{<span class="hljs-type"><span class="hljs-type">name</span></span>: "Admin Role", id: <span class="hljs-number"><span class="hljs-number">1</span></span>}, %<span class="hljs-keyword"><span class="hljs-keyword">Role</span></span>{<span class="hljs-type"><span class="hljs-type">name</span></span>: "User Role", id: <span class="hljs-number"><span class="hljs-number">2</span></span>}]</code> </pre> <br>  In this case, a call to the map function would return the following list: <br><br><pre> <code class="hljs json">[[<span class="hljs-string"><span class="hljs-string">"Admin Role"</span></span>: <span class="hljs-number"><span class="hljs-number">1</span></span>], [<span class="hljs-string"><span class="hljs-string">"User Role"</span></span>: <span class="hljs-number"><span class="hljs-number">2</span></span>]]</code> </pre> <br>  Which we then pass to the last function <code>List.flatten</code> , which removes the extra nesting.  So our final result: <br><br><pre> <code class="hljs json">[<span class="hljs-string"><span class="hljs-string">"Admin Role"</span></span>: <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-string"><span class="hljs-string">"User Role"</span></span>: <span class="hljs-number"><span class="hljs-number">2</span></span>]</code> </pre> <br>  It so happens that this is the required format for the auxiliary function of the drop-down list!  So far, we can‚Äôt pat ourselves, because we still need to change the templates in the <code>web/templates/user/new.html.eex</code> : <br><br><pre> <code class="hljs scala">&lt;h2&gt;<span class="hljs-type"><span class="hljs-type">New</span></span> user&lt;/h2&gt; &lt;%= render <span class="hljs-string"><span class="hljs-string">"form.html"</span></span>, changeset: <span class="hljs-meta"><span class="hljs-meta">@changeset</span></span>, action: user_path(<span class="hljs-meta"><span class="hljs-meta">@conn</span></span>, :create), roles: <span class="hljs-meta"><span class="hljs-meta">@roles</span></span> %&gt; &lt;%= link <span class="hljs-string"><span class="hljs-string">"Back"</span></span>, to: user_path(<span class="hljs-meta"><span class="hljs-meta">@conn</span></span>, :index) %&gt;</code> </pre> <br>  And in the <code>web/templates/user/edit.html.eex</code> : <br><br><pre> <code class="hljs scala"> &lt;h2&gt;<span class="hljs-type"><span class="hljs-type">Edit</span></span> user&lt;/h2&gt; &lt;%= render <span class="hljs-string"><span class="hljs-string">"form.html"</span></span>, changeset: <span class="hljs-meta"><span class="hljs-meta">@changeset</span></span>, action: user_path(<span class="hljs-meta"><span class="hljs-meta">@conn</span></span>, :update, <span class="hljs-meta"><span class="hljs-meta">@user</span></span>), roles: <span class="hljs-meta"><span class="hljs-meta">@roles</span></span> %&gt; &lt;%= link <span class="hljs-string"><span class="hljs-string">"Back"</span></span>, to: user_path(<span class="hljs-meta"><span class="hljs-meta">@conn</span></span>, :index) %&gt;</code> </pre><br>  And finally, I think you will not refuse to add our new helper function to the <code>web/templates/user/form.html.eex</code> .  As a result, a drop-down list will appear in the form, including all possible roles for the user to transfer.  Add the following code to the <b>Submit</b> button: <br><br><pre> <code class="hljs scala">&lt;div <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span></span>=<span class="hljs-string"><span class="hljs-string">"form-group"</span></span>&gt; &lt;%= label f, :role_id, <span class="hljs-string"><span class="hljs-string">"Role"</span></span>, <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span></span>: <span class="hljs-string"><span class="hljs-string">"control-label"</span></span> %&gt; &lt;%= select f, :role_id, roles_for_select(<span class="hljs-meta"><span class="hljs-meta">@roles</span></span>), <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span></span>: <span class="hljs-string"><span class="hljs-string">"form-control"</span></span> %&gt; &lt;%= error_tag f, :role_id %&gt; &lt;/div&gt;</code> </pre> <br>  Now, if you try to add a new user or edit an existing user, you will be able to assign the role to this person!  The last bug left! <br><br><h2>  Loading initial data duplicates them several times </h2><br>  Right now, if we load our initial data several times, we get a duplicate, which is an error.  Let's write a couple of helper anonymous functions <code>find_or_create</code> : <br><br><pre> <code class="hljs pgsql"><span class="hljs-keyword"><span class="hljs-keyword">alias</span></span> Pxblog.Repo <span class="hljs-keyword"><span class="hljs-keyword">alias</span></span> Pxblog.<span class="hljs-keyword"><span class="hljs-keyword">Role</span></span> <span class="hljs-keyword"><span class="hljs-keyword">alias</span></span> Pxblog.<span class="hljs-keyword"><span class="hljs-keyword">User</span></span> <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> Ecto.Query, <span class="hljs-keyword"><span class="hljs-keyword">only</span></span>: [<span class="hljs-keyword"><span class="hljs-keyword">from</span></span>: <span class="hljs-number"><span class="hljs-number">2</span></span>] find_or_create_role = fn role_name, <span class="hljs-keyword"><span class="hljs-keyword">admin</span></span> -&gt; <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> Repo.<span class="hljs-keyword"><span class="hljs-keyword">all</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">from</span></span> r <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Role</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">where</span></span>: r.name == ^role_name <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> r.<span class="hljs-keyword"><span class="hljs-keyword">admin</span></span> == ^<span class="hljs-keyword"><span class="hljs-keyword">admin</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> [] -&gt; %<span class="hljs-keyword"><span class="hljs-keyword">Role</span></span>{} |&gt; <span class="hljs-keyword"><span class="hljs-keyword">Role</span></span>.changeset(%{<span class="hljs-type"><span class="hljs-type">name</span></span>: role_name, <span class="hljs-keyword"><span class="hljs-keyword">admin</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">admin</span></span>}) |&gt; Repo.<span class="hljs-keyword"><span class="hljs-keyword">insert</span></span>!() _ -&gt; IO.puts "Role: #{role_name} already exists, skipping" <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> find_or_create_user = fn username, email, <span class="hljs-keyword"><span class="hljs-keyword">role</span></span> -&gt; <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> Repo.<span class="hljs-keyword"><span class="hljs-keyword">all</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">from</span></span> u <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> <span class="hljs-keyword"><span class="hljs-keyword">User</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">where</span></span>: u.username == ^username <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> u.email == ^email) <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> [] -&gt; %<span class="hljs-keyword"><span class="hljs-keyword">User</span></span>{} |&gt; <span class="hljs-keyword"><span class="hljs-keyword">User</span></span>.changeset(%{username: username, email: email, <span class="hljs-keyword"><span class="hljs-keyword">password</span></span>: "test", password_confirmation: "test", role_id: <span class="hljs-keyword"><span class="hljs-keyword">role</span></span>.id}) |&gt; Repo.<span class="hljs-keyword"><span class="hljs-keyword">insert</span></span>!() _ -&gt; IO.puts "User: #{username} already exists, skipping" <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> _user_role = find_or_create_role.("User Role", <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>) admin_role = find_or_create_role.("Admin Role", <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>) _admin_user = find_or_create_user.("admin", "admin@test.com", admin_role)</code> </pre> <br>  Note the addition of the alias <code>Repo</code> , <code>Role</code> and <code>User</code> .  We also import the <code>from</code> function <code>from</code> the <code>Ecto.Query</code> module to use the convenient query syntax.  Then take a look at the anonymous function <code>find_or_create_role</code> .  The function itself simply accepts the name of the role and the admin flag as arguments. <br><br>  Based on these criteria, we perform a query using <code>Repo.all</code> (note the <b>^</b> sign following each variable inside the <code>where</code> clause, because we want to compare values ‚Äã‚Äãinstead of matching to the sample).  And throw the result in the case statement.  If <code>Repo.all</code> did not find anything, we will get back an empty list, therefore, we need to add a role.  Otherwise, we assume that the role already exists and proceed to load the rest of the file.  The <code>find_or_create_user</code> function does the same thing but uses different criteria. <br><br>  Finally, we call each of these functions (note the mandatory for anonymous functions point between their name and arguments!).  To create an administrator, we need to reuse his role.  That is why we do not <code>admin_role</code> name <code>admin_role</code> with an underscore.  Later, we may want to use <code>user_role</code> or <code>admin_user</code> for further use in the initial data file, but for the time being we will leave this code alone by referring to the underscore.  This will make the raw data file look tidy and clean.  Now everything is ready to load the initial data: <br><br><pre> <code class="bash hljs">$ mix run priv/repo/seeds.exs [debug] SELECT r0.‚Äùid‚Äù, r0.‚Äùname‚Äù, r0.‚Äùadmin‚Äù, r0.‚Äùinserted_at‚Äù, r0.‚Äùupdated_at‚Äù FROM ‚Äúroles‚Äù AS r0 WHERE ((r0.‚Äùname‚Äù = <span class="hljs-variable"><span class="hljs-variable">$1</span></span>) AND (r0.‚Äùadmin‚Äù = <span class="hljs-variable"><span class="hljs-variable">$2</span></span>)) [‚ÄúUser Role‚Äù, <span class="hljs-literal"><span class="hljs-literal">false</span></span>] OK query=81.7ms queue=2.8ms [debug] BEGIN [] OK query=0.2ms [debug] INSERT INTO ‚Äúroles‚Äù (‚Äúadmin‚Äù, ‚Äúinserted_at‚Äù, ‚Äúname‚Äù, ‚Äúupdated_at‚Äù) VALUES (<span class="hljs-variable"><span class="hljs-variable">$1</span></span>, <span class="hljs-variable"><span class="hljs-variable">$2</span></span>, <span class="hljs-variable"><span class="hljs-variable">$3</span></span>, <span class="hljs-variable"><span class="hljs-variable">$4</span></span>) RETURNING ‚Äúid‚Äù [<span class="hljs-literal"><span class="hljs-literal">false</span></span>, {{2015, 11, 6}, {19, 35, 49, 0}}, ‚ÄúUser Role‚Äù, {{2015, 11, 6}, {19, 35, 49, 0}}] OK query=0.8ms [debug] COMMIT [] OK query=0.4ms [debug] SELECT r0.‚Äùid‚Äù, r0.‚Äùname‚Äù, r0.‚Äùadmin‚Äù, r0.‚Äùinserted_at‚Äù, r0.‚Äùupdated_at‚Äù FROM ‚Äúroles‚Äù AS r0 WHERE ((r0.‚Äùname‚Äù = <span class="hljs-variable"><span class="hljs-variable">$1</span></span>) AND (r0.‚Äùadmin‚Äù = <span class="hljs-variable"><span class="hljs-variable">$2</span></span>)) [‚ÄúAdmin Role‚Äù, <span class="hljs-literal"><span class="hljs-literal">true</span></span>] OK query=0.4ms [debug] BEGIN [] OK query=0.2ms [debug] INSERT INTO ‚Äúroles‚Äù (‚Äúadmin‚Äù, ‚Äúinserted_at‚Äù, ‚Äúname‚Äù, ‚Äúupdated_at‚Äù) VALUES (<span class="hljs-variable"><span class="hljs-variable">$1</span></span>, <span class="hljs-variable"><span class="hljs-variable">$2</span></span>, <span class="hljs-variable"><span class="hljs-variable">$3</span></span>, <span class="hljs-variable"><span class="hljs-variable">$4</span></span>) RETURNING ‚Äúid‚Äù [<span class="hljs-literal"><span class="hljs-literal">true</span></span>, {{2015, 11, 6}, {19, 35, 49, 0}}, ‚ÄúAdmin Role‚Äù, {{2015, 11, 6}, {19, 35, 49, 0}}] OK query=0.4ms [debug] COMMIT [] OK query=0.3ms [debug] SELECT u0.‚Äùid‚Äù, u0.‚Äùusername‚Äù, u0.‚Äùemail‚Äù, u0.‚Äùpassword_digest‚Äù, u0.‚Äùrole_id‚Äù, u0.‚Äùinserted_at‚Äù, u0.‚Äùupdated_at‚Äù FROM ‚Äúusers‚Äù AS u0 WHERE ((u0.‚Äùusername‚Äù = <span class="hljs-variable"><span class="hljs-variable">$1</span></span>) AND (u0.‚Äùemail‚Äù = <span class="hljs-variable"><span class="hljs-variable">$2</span></span>)) [‚Äúadmin‚Äù, ‚Äúadmin@test.com‚Äù] OK query=0.7ms [debug] BEGIN [] OK query=0.3ms [debug] INSERT INTO ‚Äúusers‚Äù (‚Äúemail‚Äù, ‚Äúinserted_at‚Äù, ‚Äúpassword_digest‚Äù, ‚Äúrole_id‚Äù, ‚Äúupdated_at‚Äù, ‚Äúusername‚Äù) VALUES (<span class="hljs-variable"><span class="hljs-variable">$1</span></span>, <span class="hljs-variable"><span class="hljs-variable">$2</span></span>, <span class="hljs-variable"><span class="hljs-variable">$3</span></span>, <span class="hljs-variable"><span class="hljs-variable">$4</span></span>, <span class="hljs-variable"><span class="hljs-variable">$5</span></span>, <span class="hljs-variable"><span class="hljs-variable">$6</span></span>) RETURNING ‚Äúid‚Äù [‚Äúadmin@test.com‚Äù, {{2015, 11, 6}, {19, 35, 49, 0}}, ‚Äú<span class="hljs-variable"><span class="hljs-variable">$2b</span></span><span class="hljs-variable"><span class="hljs-variable">$12</span></span>$.MuPBUVe/7/9HSOsccJYUOAD5IKEB77Pgz2oTJ/UvTvWYwAGn/Li‚Äù, 2, {{2015, 11, 6}, {19, 35, 49, 0}}, ‚Äúadmin‚Äù] OK query=1.2ms [debug] COMMIT [] OK query=1.1ms</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">When we load them for the first time, we see a stack of structures </font></font><code>INSERT</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">.</font></font> Awesome!<font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> To be completely sure that everything works as it should, let's try to load them again and make sure that there are no insert operations: </font></font><br><br><pre> <code class="bash hljs">$ mix run priv/repo/seeds.exs Role: User Role already exists, skipping [debug] SELECT r0.‚Äùid‚Äù, r0.‚Äùname‚Äù, r0.‚Äùadmin‚Äù, r0.‚Äùinserted_at‚Äù, r0.‚Äùupdated_at‚Äù FROM ‚Äúroles‚Äù AS r0 WHERE ((r0.‚Äùname‚Äù = <span class="hljs-variable"><span class="hljs-variable">$1</span></span>) AND (r0.‚Äùadmin‚Äù = <span class="hljs-variable"><span class="hljs-variable">$2</span></span>)) [‚ÄúUser Role‚Äù, <span class="hljs-literal"><span class="hljs-literal">false</span></span>] OK query=104.8ms queue=3.6ms Role: Admin Role already exists, skipping [debug] SELECT r0.‚Äùid‚Äù, r0.‚Äùname‚Äù, r0.‚Äùadmin‚Äù, r0.‚Äùinserted_at‚Äù, r0.‚Äùupdated_at‚Äù FROM ‚Äúroles‚Äù AS r0 WHERE ((r0.‚Äùname‚Äù = <span class="hljs-variable"><span class="hljs-variable">$1</span></span>) AND (r0.‚Äùadmin‚Äù = <span class="hljs-variable"><span class="hljs-variable">$2</span></span>)) [‚ÄúAdmin Role‚Äù, <span class="hljs-literal"><span class="hljs-literal">true</span></span>] OK query=0.6ms User: admin already exists, skipping [debug] SELECT u0.‚Äùid‚Äù, u0.‚Äùusername‚Äù, u0.‚Äùemail‚Äù, u0.‚Äùpassword_digest‚Äù, u0.‚Äùrole_id‚Äù, u0.‚Äùinserted_at‚Äù, u0.‚Äùupdated_at‚Äù FROM ‚Äúusers‚Äù AS u0 WHERE ((u0.‚Äùusername‚Äù = <span class="hljs-variable"><span class="hljs-variable">$1</span></span>) AND (u0.‚Äùemail‚Äù = <span class="hljs-variable"><span class="hljs-variable">$2</span></span>)) [‚Äúadmin‚Äù, ‚Äúadmin@test.com‚Äù] OK query=0.8ms</code> </pre> <br>  Sumptuously!<font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Everything works and works quite reliably! </font><font style="vertical-align: inherit;">Plus, no one will cancel the pleasure that we got from writing our own useful features for </font></font><code>Ecto</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">!</font></font><br><br><h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Errors about duplicate administrators in tests </font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Now, if at some point, you drop the test database, you get an error saying </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">"User already exists</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><i><font style="vertical-align: inherit;">" </font></i><font style="vertical-align: inherit;">I suggest a simple (and temporary) way to fix this. </font><font style="vertical-align: inherit;">Open the file </font></font><code>test/support/test_helper.ex</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">and change the function </font></font><code>create_user</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">:</font></font><br><br><pre> <code class="hljs pgsql">def create_user(<span class="hljs-keyword"><span class="hljs-keyword">role</span></span>, %{email: email, username: username, <span class="hljs-keyword"><span class="hljs-keyword">password</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">password</span></span>, password_confirmation: password_confirmation}) <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> <span class="hljs-keyword"><span class="hljs-keyword">user</span></span> = Repo.get_by(<span class="hljs-keyword"><span class="hljs-keyword">User</span></span>, username: username) <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> Repo.<span class="hljs-keyword"><span class="hljs-keyword">delete</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">user</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-keyword"><span class="hljs-keyword">role</span></span> |&gt; build_assoc(:users) |&gt; <span class="hljs-keyword"><span class="hljs-keyword">User</span></span>.changeset(%{email: email, username: username, <span class="hljs-keyword"><span class="hljs-keyword">password</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">password</span></span>, password_confirmation: password_confirmation}) |&gt; Repo.<span class="hljs-keyword"><span class="hljs-keyword">insert</span></span> <span class="hljs-keyword"><span class="hljs-keyword">end</span></span></code> </pre> <br><br><h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> What have we come to? </font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Now we have completely green tests, as well as users, posts and roles. We implemented workable restrictions on user registrations, changes to users and posts. And added some useful helper functions. In further posts, we will devote some time to adding new cool features to our blog engine!</font></font><br><br><h2>  Conclusion from the Wuns </h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Every week we are getting more and more, and this is good news! Friends, thank you very much for the interest in the community and the expressed trust. We try to justify it and post new interesting material several times a week. Therefore, if you still have not subscribed to the </font></font><a href="https://wunsh.ru/%3Futm_source%3Dhabrahabr%26utm_medium%3Dcontent%26utm_campaign%3Dblog-phoenix-4"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Russian-language newsletter about Elixir</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , then do not waste time. Subscribe now and tomorrow you will receive a new exclusive article! We work literally all night long, especially for you. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">I also remind you that we are holding a </font></font><a href="https://wunsh.ru/first_contest.html%3Futm_source%3Dhabr%26utm_medium%3Dcontent%26utm_campaign%3Dfirst_contest"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">contest with a new crisp book Programming Elixir from Dave Thomas</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> as a prize. Take part, win is not so difficult!</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Also, do not forget to put the pros and send the article to your friends if you like it. </font><font style="vertical-align: inherit;">Or if you like our activities. </font><font style="vertical-align: inherit;">After all, the sooner we collect the critical mass of users, the sooner we can launch a full-fledged version of the site, covering most of the questions about the beautiful language of Elixir.</font></font><br><br><h2>  Other series articles </h2><br><ol><li>  <a href="https://habrahabr.ru/post/311088/">Introduction</a> </li><li>  <a href="https://habrahabr.ru/post/313482/">Authorization</a> </li><li>  <a href="https://habrahabr.ru/post/315252/">Adding Roles</a> </li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Process roles in controllers </font></font></li><li>  <a href="https://habrahabr.ru/post/316996/">We connect ExMachina</a> </li><li>  <a href="https://habrahabr.ru/post/317550/">Markdown support</a> </li><li>  <a href="https://habrahabr.ru/post/318790/">Add comments</a> </li><li>  <a href="https://habrahabr.ru/post/323462/">We finish with comments</a> </li><li>  <a href="https://habrahabr.ru/post/332094/">Channels</a> </li><li>  <a href="https://habrahabr.ru/post/333020/">Channel testing</a> </li><li>  <a href="https://habrahabr.ru/post/335048/">Conclusion</a> </li></ol><br><br>  Good luck in learning, stay with us! </div><p>Source: <a href="https://habr.com/ru/post/316368/">https://habr.com/ru/post/316368/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../316358/index.html">React, Web Components, Angular and jQuery are friends forever. Generic JavaScript Components</a></li>
<li><a href="../316360/index.html">What is Flussonic Watcher</a></li>
<li><a href="../316362/index.html">GIS utilities: asynchronous model of interaction</a></li>
<li><a href="../316364/index.html">Version autoincrement in pom.xml via Jenkinsfile</a></li>
<li><a href="../316366/index.html">We invite you to a free webinar Oracle Cloud: PaaS Core Services</a></li>
<li><a href="../316370/index.html">12 billion requests per month for $ 120 in java</a></li>
<li><a href="../316374/index.html">Under the hood of the new crafts Dell + EMC - flash storage at the price of disk</a></li>
<li><a href="../316376/index.html">Entity? Provide your IP address</a></li>
<li><a href="../316378/index.html">Welcome to the DevFest Vladivostok</a></li>
<li><a href="../316380/index.html">FIAS addresses in the PostgreSQL environment. Part 2</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>