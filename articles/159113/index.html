<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Hibernation on PROXMOX2</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="What is it for 
 Hibernation (sleep mode) is a system shutdown mode in which its current state, including the state of RAM, is saved to non-volatile s...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Hibernation on PROXMOX2</h1><div class="post__text post__text-html js-mediator-article"><h4>  What is it for </h4><br>  Hibernation (sleep mode) is a system shutdown mode in which its current state, including the state of RAM, is saved to non-volatile storage. <br><br>  This mode, when used in conjunction with Proxmox, significantly speeds up the main shutdown process ‚Äî the host system without having to shut down the guest virtual systems.  It is especially convenient when terminal servers on Windows are deployed as a guest system.  After all, if the system is normally shut down, a request to save the edited document appears in users' windows, and if <s>the user also</s> turns <s>off the light along with his computer and monitor, the</s> user is not present, the forced termination of the system will cause the <s>pre-infarction state to</s> lose the data edited by the employee.  This is where the hibernation of the host nodes will save and after the restoration of power supply, users can continue to work from the same place! <br>  Of course, something like this would have to be configured by the UPS server.  Switching to hibernation mode is convenient to designate as an event when the UPS battery is discharged, and thanks to the speed of transition to this mode, you can seriously reduce the requirements for the capacity of its batteries. <br><a name="habracut"></a><br><h4>  How it works </h4><br>  Proxmox 2.2 runs on debian 6 and almost everything described below applies to it to one degree or another. <br><br>  Activating the hibernation mode requires a dedicated disk that will be visible to GRUB directly when booting or a separate swap partition on the system disk.  With the swap logical volume created automatically when installed inside LVM, I could not start the hibernation.  At the same time, proxmox does not allow creating the necessary disk structure for this mode during the installation process.  This is probably due to the concept of maximum ease of deploying a system that even a housewife can handle. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      The simplest solution is to simply add another hard disk to the server and assign it as storage for the hibernation mode, but we will consider a more complex option with finding free space on the same disk where proxmox was delivered. <br><br><h4>  Initial data </h4><br>  When installing, proxmox fully utilizes 1 of the disks destroying all the information on it and creating a certain partition structure: <br><br><pre><code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># parted /dev/sda print free Model: ATA WDC WD3200AAKS-7 (scsi) Disk /dev/sda: 320GB Sector size (logical/physical): 512B/512B Partition Table: msdos Number Start End Size Type File system Flags 32.3kB 1049kB 1016kB Free Space 1 1049kB 537MB 536MB primary ext3 boot 2 537MB 320GB 320GB primary lvm 320GB 320GB 352kB Free Space</span></span></code> </pre> <br><br>  Thus, we learned that the physical disk space not occupied by partitions is only 352kB, which is clearly not enough for the swap partition to which the system will keep the state of the occupied RAM when hibernating.  Such a partition must have a size not less than the size of the RAM node. <br><br>  We assume that the size we need is 32 GB. <br><br>  Now let's see what logical volumes our physical volume is located in the second section. <br><pre> <code class="bash hljs"> <span class="hljs-comment"><span class="hljs-comment"># lvs</span></span></code> </pre><br>  see <br><pre> <code class="bash hljs"> LV VG Attr LSize Pool Origin Data% Move Log Copy% Convert data pve -wi-ao-- 203.09g root pve -wi-ao-- 74.50g swap pve -wi-ao-- 4.00g</code> </pre><br><br><h4>  Carrier preparation </h4><br>  Let us find out how much free space is already inside the physical volume LVM2. <br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># pvs</span></span></code> </pre><br>  We look at the value of PFree <br><pre> <code class="bash hljs"> PV VG Fmt Attr PSize PFree /dev/sda2 pve lvm2 a-- 297.59g 16.00g</code> </pre><br>  This means that we can immediately reduce the partition on the physical disk by 16.00 GB, but our task is to get 32 ‚Äã‚ÄãGB, so we will look for additional data. <br>  We will select the space we need from the data logical volume.  To do this, we will reduce the size of / dev / pve / data to 16 GB. <br>  This process is carried out in 2 stages.  First, the file system size is reduced, and then the size of the logical volume itself is reduced.  Since the procedure is potentially not secure, the unmounting of the file system will be performed for the period of resizing, respectively, all virtual machines located in / var / lib / vz should be stopped for this time. <br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># lvresize /dev/pve/data -r -L-16Gb Do you want to unmount "/var/lib/vz"? [Y|n]</span></span></code> </pre><br>  Answer y <br><br>  Now re-run <br><pre> <code class="bash hljs"> <span class="hljs-comment"><span class="hljs-comment"># pvs PV VG Fmt Attr PSize PFree /dev/sda2 pve lvm2 a-- 297.59g 32.00g</span></span></code> </pre><br>  We see that the amount of free space inside the physical volume has increased to 32 GB. <br><br>  Now we can safely reduce its size to the size of the available free space + 1 GB for safety: <br><br>  Calculate the total size of the physical volume 297-32 + 1 = 266 <br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># pvresize /dev/sda2 --setphysicalvolumesize 266Gb</span></span></code> </pre><br>  Again, let's see what we have <br><pre> <code class="bash hljs"> <span class="hljs-comment"><span class="hljs-comment"># pvs PV VG Fmt Attr PSize PFree /dev/sda2 pve lvm2 a-- 266.00g 412.00m</span></span></code> </pre><br>  The size of the LVM physical volume has decreased by: <br>  297.59 - 266 + 0.412 = 32.002 GB <br>  But despite this, the size of the partition containing the LVM structure on the hard disk remained unchanged: <br><pre> <code class="bash hljs"> <span class="hljs-comment"><span class="hljs-comment"># parted /dev/sda print free Number Start End Size Type File system Flags 32.3kB 1049kB 1016kB Free Space 1 1049kB 537MB 536MB primary ext3 boot 2 537MB 320GB 320GB primary lvm 320GB 320GB 352kB Free Space</span></span></code> </pre><br>  This does not suit us, since it is necessary to get free space for a new partition in the partition table of the physical disk. <br><br>  At the moment, it was not possible to detect ready-made utilities capable of changing partitions containing the lvm2 structure, so we simply delete and re-create the partition on the hard disk with the beginning as the original one, but smaller.  This is a potentially rather dangerous procedure. <br><br>  Calculate the parameters of the 2nd section, which we want to get as a result.  It should be less than the current 32 GB <br>  320 - 32 = 288 GB <br>  Thus, the 2nd section will have parameters: <br><br>  Type primary <br>  Start 537MB <br>  End 288Gb <br><br>  Remove section 2 by ignoring warnings. <br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># parted /dev/sda rm 2</span></span></code> </pre><br>  Create a partition that is smaller but smaller than it was <br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># parted /dev/sda mkpart primary 537MB 288GB</span></span></code> </pre><br>  Assign the lvm flag to the section <br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># parted /dev/sda set 2 lvm on</span></span></code> </pre><br>  See the result <br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># parted /dev/sda print free</span></span></code> </pre><br>  We see that the physical disk has free space for the future partition. <br><pre> <code class="bash hljs"> Number Start End Size Type File system Flags 32.3kB 1049kB 1016kB Free Space 1 1049kB 537MB 536MB primary ext3 boot 2 537MB 288GB 287GB primary lvm 288GB 320GB 32.1GB Free Space</code> </pre><br><br>  Create a section of type swap.  Its parameters are: <br><br>  Type primary <br>  fs linux-swap <br>  Begin 288GB <br>  End 320GB <br><br>  Perform: <br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># parted /dev/sda mkpart primary linux-swap 288GB 320GB # mkswap /dev/sda3</span></span></code> </pre><br><br>  The preparatory work is finished and now you can proceed directly to the setup of hibernation <br><h4>  Hibernate activation </h4><br>  Component installation <br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># apt-get update # apt-get install pm-utils</span></span></code> </pre><br>  Adding parameters to grub and fstab <br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># echo 'GRUB_CMDLINE_LINUX_DEFAULT="resume=/dev/sda3"' &gt;&gt; /etc/default/grub # echo '/dev/sda3 none swap sw 0 0' &gt;&gt; /etc/fstab</span></span></code> </pre><br>  We connect the new partition as a paging file to the system <br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># swapon /dev/sda3</span></span></code> </pre><br>  Update the bootloader <br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># update-grub</span></span></code> </pre><br>  You can start testing directly the hibernation mode.  But before that, it is highly advisable to reboot the server, if there is such an opportunity, as there have been quite serious changes in the structure of the media! <br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># reboot</span></span></code> </pre><br>  Perform full hibernation with system power off <br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># pm-hibernate</span></span></code> </pre><br><br>  Now it remains to assign the execution of this command at the event of a battery discharge on the UPS, but this is another story that I hope will describe in the next article. <br><br>  All of the above is tested on freshly installed <a href="http://proxmox.com/downloads/proxmox-ve/17-iso-images">proxmox 2.2</a> </div><p>Source: <a href="https://habr.com/ru/post/159113/">https://habr.com/ru/post/159113/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../159099/index.html">Decorator cached_property</a></li>
<li><a href="../159101/index.html">Basic styles and useful CSS snippets</a></li>
<li><a href="../159103/index.html">ReactOS in the semi-final of Zvorykin Prize</a></li>
<li><a href="../159107/index.html">Simple release management with Git</a></li>
<li><a href="../159109/index.html">Phased array antenna</a></li>
<li><a href="../159115/index.html">We improve labor productivity. Objective-c macros and literals</a></li>
<li><a href="../159121/index.html">We solder a ‚Äúsmart‚Äù car PSU on 5v with USB charging and automatic on / off</a></li>
<li><a href="../159123/index.html">We turn on FCoE on the Cisco Nexus 5000 switch</a></li>
<li><a href="../159127/index.html">Two simple tasks on Haskell (for beginners)</a></li>
<li><a href="../159129/index.html">Proper definition of the user's language</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>