<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Difficult development of simple devices</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Greetings reader! Today I will tell you a funny story that made me think about the problems that arise when choosing the right components for the impl...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Difficult development of simple devices</h1><div class="post__text post__text-html js-mediator-article">  Greetings reader!  Today I will tell you a funny story that made me think about the problems that arise when choosing the right components for the implementation of an electronic product that is not (optimally).  And also about the seeming simplicity on the example of the ‚Äúone day‚Äù device. <br><div style="text-align:center;"><img src="https://habrastorage.org/webt/uv/9g/hg/uv9ghgxb_nswu_pvba8bbjt5jp0.jpeg" width="450"></div><a name="habracut"></a>  We agree that the story is fictional, any coincidences are random ... or not random. <br>  Once Seryozha, a programmer, approached me with a request to make a device for him in the car that emulates the sequential pressing of 2 virtual buttons when pressing one physical in the cruise control car control circuit (Ford Focus 2).  The scheme of the standard control unit is as follows: <br><br><img src="https://habrastorage.org/webt/wu/yr/j3/wuyrj3rbtekr3o9zd3ogzyybvsg.png"><br><br>  From the side of the control unit, this is a classic push-button input using an ADC.  So, the device‚Äôs task when pressing the hardware button is to successively press the ON and SET + button for ~ 0.2s.  For ease of integration of the device, it was decided to power it from the upper resistor of the divider.  Voltage at the terminals of connection 4.6 V without the connected circuit of buttons.  Since the device was planned to be made in the evening, I made the scheme without preliminary calculations from what was on the mounting table.  The solution "in the forehead": 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <img src="https://habrastorage.org/webt/xz/vg/4j/xzvg4jaka9aknb__8taqs7pwrmw.png"><br><br>  Serezha wrote the firmware, and the device worked fine on the car.  At the moment when the board already wanted to pack someone from the depths of the office into the body of the steering-wheel switch shouted: ‚ÄúWhy is it so difficult?  Half of the parts can be thrown out, and in general STM8 for such a task is the most ".  And so it began ... The author of the idea volunteered to solder the layout ‚Äúout of 3 details‚Äù (apparently anticipating an easy victory).  I (guided by my own article on <a href="https://habr.com/post/397039/">professional jealousy</a> ) decided not to interfere with the flight of a young specialist, but only connected at a stage when everyone understood that a miracle did not happen. <br><br>  The scheme proposed by my colleague was really simpler, but it worked only on the table: <br><br><img src="https://habrastorage.org/webt/pb/fc/yk/pbfcykqizfvig66cx0l3zo2e008.png"><br><br>  Errors were visible even at first glance, nevertheless I decided to make the circuit work on MK STM8S001J3. <br><br>  In order to understand how to remake the scheme, we will conduct several measurements.  The resistance of the upper resistor in the ADC divider is ~ 130 Ohms, and the voltage without load is 4.6 V. <br><br>  Then the layout of the button node is: <br><br><img src="https://habrastorage.org/webt/g4/th/-g/g4th-gpsd2dzk3czstorlhjcati.png"><br><br><ul><li>  when the buttons are released, the current in the circuit is 2 mA, the voltage at the input of the ADC is 4.33 V; </li><li>  when the button is pressed ON 3.7 mA, the voltage at the input of the ADC is 4.11 V; </li><li>  when the SET button is pressed + 18.4 mA, the input voltage of the ADC is 2.2 V. </li></ul><br>  In this case, the operating voltage range of the MK STM8S001J3 is 2.95-5.5 V. It turns out that an attempt to press the SET + button leads to a voltage drop below the minimum and the MC is reset. <br><br>  At this point, I propose to distract and discuss what an ideal MK is for this task and why it was not chosen.  Usually for such crafts use what the developer knows how to work and what is at hand.  For example, the microchip has PIC10F200 or ATtiny10 controllers in the SOT23-6 package with a supply voltage range of 2 (1.8) - 5.5 V. These chips do not require a voltage regulator (like STM32L031), but they will not restart when you press the SET + button (as STM8S001J3).  In the strapping will be only 2 resistors and a capacitor.  Beauty, but in the nomenclature of STMicro controllers with this power range is not.  An attentive reader will rightly note that within the framework of such a task almost any controller can be mastered, but the lack of a familiar programming environment and debugging tools determine the choice. <br>  Let's return to the scheme.  To solve the problem of resetting the controller, we need energy to power the controller while pressing the SET + button.  To estimate the amount of this energy, it is necessary to measure the current consumption (or see the documentation): <br><br><img src="https://habrastorage.org/webt/sc/70/vu/sc70vuonse7-qjwdmc6a2fh4zaa.png"><br><br>  Almost 500 uA at best.  This is a lot, but to make it clear I will give the calculation.  For energy storage, we need a diode (VD1) and a capacitor (C1): <br><br><img src="https://habrastorage.org/webt/si/2q/fe/si2qfeyf6zzawldlp-kk863noz0.png"><br><br>  The fall on VD1 of 0.2 V, respectively, with the released buttons C1 will be charged up to 4.33 - 0.2 = 4.13 V. When the "press" button SET + is pressed, the voltage at the point Vin drops to 2.2 V, VD1 closes and MK powered by discharging C1. <br><br><img src="https://habrastorage.org/webt/zn/by/cg/znbycg5v4zszjmr8uqvprphihce.png"><br><br>  (For editing the error, thanks to <a href="https://habr.com/users/VT100/">VT100</a> and <a href="https://habr.com/users/DenisHW/">DenisHW</a> ) <br>  In this expression, the energy stored in the capacitor on the left (when it is discharged from 4.13 to 3.1 V), on the right is the energy spent by the controller during the time t = 0.2 s.  Then the capacitance of the capacitor: <br><br><img src="https://habrastorage.org/webt/yx/cf/l8/yxcfl8hijew86jmxqjkwvfeedic.png"><br><br>  100 uF for this task is tolerable, but we will try to put the controller to sleep while pressing the button. <br><br>  For this, the STM8 has Active Halt Mode: <br><br><img src="https://habrastorage.org/webt/0n/mi/g9/0nmig9qr2gusc-np2serzxf0pim.png"><br><br>  By turning off MVR and Flash, we managed to get a current consumption of ~ 40 ŒºA (this is significantly higher than the stated current, but this current is suitable for this task), and thanks to the AWU (auto wake up unit), you can easily set an awakening after 256 ms after going to sleep.  In this case, to ensure the operation of the controller, a capacitor with a capacity of just 10 microfarads is needed, but since it takes some time after the leg is clamped, the capacity of 47 microfarads turned out to be necessary and sufficient. <br><br>  It seems that all problems are solved, but there is one more BUT.  The current when the SET button is pressed + 18.4 mA is less than the current limit for output, but the logic zero voltage will be around 0.7 V. This will lead to a drop in current through the resistor and will require either recalculating the resistance or using an external transistor according to the scheme with open drain.  I chose the second option as more predictable in behavior.  The final scheme took the form: <br><br><img src="https://habrastorage.org/webt/fn/7j/kx/fn7jkxbq6apqrnqzcudayesbwyo.png"><br><br>  In this form, it has successfully earned and operated to this day. <br><br>  <b>Instead of conclusion</b> <br><br>  In this article I want to draw attention to the problem of how the developer is punished for an unnecessarily superficial or frivolous approach to the development of a simple (at first glance) device.  On the other hand, I wanted to show how a non-optimal choice of the main element base (in this case, MK) complicates the development process and the product itself for two main reasons: <br><br><ol><li>  The need to adjust the choice of technical solutions to the skills of the programmer. </li><li>  Impossibility to embrace the whole range of possible components suitable for the task, in order to choose the ‚Äúmost‚Äù of them.  These factors, most often, explain the fact that many devices (household, commercial, special) work normally, but they are not made the way you would have done it. </li></ol></div><p>Source: <a href="https://habr.com/ru/post/432574/">https://habr.com/ru/post/432574/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../432562/index.html">Techday Make IT Real - December 17, Moscow</a></li>
<li><a href="../432564/index.html">Rust 2018 came out ... but what is it?</a></li>
<li><a href="../432566/index.html">Two worlds or "engineers have something to say." About the various types of complex tasks and processes associated with them</a></li>
<li><a href="../432568/index.html">‚ÄúWhen you are the editor in chief of Rusbase‚Äù: a new podcast about working with content and a career in technology media</a></li>
<li><a href="../432572/index.html">Metal-air transistor will extend Moore's law - how technology works</a></li>
<li><a href="../432576/index.html">Under the hood JobIntentService</a></li>
<li><a href="../432578/index.html">China confirms leadership in the Asian lunar race</a></li>
<li><a href="../432580/index.html">What is the AI ‚Äã‚Äãpierced when generating human faces?</a></li>
<li><a href="../432584/index.html">China leads the way in the development of quantum cryptography systems</a></li>
<li><a href="../432586/index.html">Atomic CSS - order and cleanliness</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>