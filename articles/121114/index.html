<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Workshop Zend Framework. Part One: Authentication and Acl</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Recently, I am becoming more and more convinced of the universality of the Zend Framework, as a platform for creating web applications. Today I will t...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Workshop Zend Framework. Part One: Authentication and Acl</h1><div class="post__text post__text-html js-mediator-article"><div style="text-align:center;"><img src="https://habrastorage.org/storage/5c8214a4/12abdd60/6b736ba2/8058a3df.png"></div><br>  Recently, I am becoming more and more convinced of the universality of the Zend Framework, as a platform for creating web applications.  Today I will talk about the process of creating a site framework on the Zend Framework, which will provide the necessary framework for the implementation of sites of average complexity <a name="habracut"></a>  : <br><ul><li>  <b>Part one</b> <br><ul><li>  <b>Authentication</b> - user login </li><li>  <b>ACL</b> - distribution of access rights </li></ul><br></li><li>  <a href="http://habrahabr.ru/blogs/zend_framework/121222/"><b>Part two</b></a> <br><ul><li>  <b>Routing</b> - setting the url for various system components </li><li>  <b>Registry</b> - quick access to system constants </li></ul><br></li></ul><h2>  Authentication </h2><br>  Authentication is an integral part of almost any site.  As you know, the Zend Framework uses a special component, Zend_Auth, for this purpose.  This component allows you to perform the login process by checking the match of the login-password pair.  Typically, the entry point is a special action authentication, as well as a possible action registration (or registration confirmation).  Consider a simple authentication example: <br><pre><code class="php hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">authAction</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>{ $form = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Application_Form_Enter(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ($form-&gt;isValid(<span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;getRequest()-&gt;getPost())){ $bootstrap = <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;getInvokeArg(<span class="hljs-string"><span class="hljs-string">'bootstrap'</span></span>); $auth = Zend_Auth::getInstance(); $adapter = $bootstrap-&gt;getPluginResource(<span class="hljs-string"><span class="hljs-string">'db'</span></span>)-&gt;getDbAdapter(); $authAdapter = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Zend_Auth_Adapter_DbTable( $adapter, <span class="hljs-string"><span class="hljs-string">'user'</span></span>, <span class="hljs-string"><span class="hljs-string">'login'</span></span>, <span class="hljs-string"><span class="hljs-string">'password'</span></span>, <span class="hljs-string"><span class="hljs-string">'MD5(?)'</span></span> ); $authAdapter-&gt;setIdentity($form-&gt;login-&gt;getValue()); $authAdapter-&gt;setCredential($form-&gt;password-&gt;getValue()); $result = $auth-&gt;authenticate($authAdapter); <span class="hljs-comment"><span class="hljs-comment">//       storage    if ($result-&gt;isValid()){ $storage = $auth-&gt;getStorage(); $storage_data = $authAdapter-&gt;getResultRowObject( null, array('activate', 'password', 'enabled')); $user_model = new Application_Model_DbTable_User(); $language_model = new Application_Model_DbTable_Language(); $storage_data-&gt;status = 'user'; $storage-&gt;write($storage_data); } } }</span></span></code> </pre> <br>  This is a typical authentication code that you can use.  To complete the work you will need the appropriate form, which sends the username and password to this action. <br>  After successful authentication, user data is stored in the Zend_Auth storage.  Further, when you need to find out any information about the current user, you can refer to Zend_Auth (it is available everywhere, because it is a implementation of Singleton) as follows: <br><pre> <code class="php hljs">$auth = Zend_Auth::getInstance(); <span class="hljs-comment"><span class="hljs-comment">//    if ($auth-&gt;hasIdentity()){ //     $user_data = $auth-&gt;getStorage()-&gt;read(); }</span></span></code> </pre><br>  Also an important action to be taken is the initial initialization of Zend_Auth when the user first visits the site.  To do this, add the following method to the bootstrap: <br><pre> <code class="php hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">_initAuth</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>{ $auth = Zend_Auth::getInstance(); $data = $auth-&gt;getStorage()-&gt;read(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!<span class="hljs-keyword"><span class="hljs-keyword">isset</span></span>($data-&gt;status)){ $storage_data = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> stdClass(); $storage_data-&gt;status = <span class="hljs-string"><span class="hljs-string">'guest'</span></span>; $auth-&gt;getStorage()-&gt;write($storage_data); } }</code> </pre><br><h2>  Acl </h2><br>  Most web applications have several access statuses, each of which has certain privileges.  For most sites, the privileges and their distribution are relatively constant, so we implement Acl in the form of rules written directly in the program code.  If you are developing a system that has a frequently changing structure of statuses and rights (for example, CMS), then you need to build a more flexible implementation of Acl, the rights in which will be stored, for example, in a database. <br>  The main tasks to be performed by the access control system are the assignment of privileges and access control itself.  To accomplish these tasks, we need two components: <ul><li>  Acl - Authorization Lists </li><li>  Plugin that checks the correctness of the current user's access to the requested resource </li></ul><br>  Consider the simplest case when resources are parts of the site, i.e.  in MVC terms, actions.  Each user inherits rights from a certain abstract status (guest, user, administrator), the privileges of each status are described in Acl.  To implement Acl, expand Zend_Acl: <br><pre> <code class="php hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Acl</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Zend_Acl</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">__construct</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-comment"><span class="hljs-comment">//  $this-&gt;addRole('guest'); $this-&gt;addRole('user', 'guest'); $this-&gt;addRole('admin', 'user'); //  //   ! $this-&gt;add(new Zend_Acl_Resource('guest_allow')); $this-&gt;add(new Zend_Acl_Resource('index/index'),'guest_allow'); //... //   ! $this-&gt;add(new Zend_Acl_Resource('user_allow')); $this-&gt;add(new Zend_Acl_Resource('user/index'), 'user_allow'); // ... //   ! $this-&gt;add(new Zend_Acl_Resource('admin_allow')); $this-&gt;add(new Zend_Acl_Resource('admin/index'), 'admin_allow'); //... // , -   $this-&gt;deny(null, null, null); $this-&gt;allow('guest', 'guest_allow', 'show'); $this-&gt;allow('user', 'user_allow', 'show'); $this-&gt;allow('admin','admin_allow', 'show'); } public function can($privilege='show'){ //  $request = Zend_Controller_Front::getInstance()-&gt;getRequest(); $resource = $request-&gt;getControllerName() . '/' . $request-&gt;getActionName(); //      if (!$this-&gt;has($resource)) return true; //  $storage_data = Zend_Auth::getInstance()-&gt;getStorage()-&gt;read(); $role = array_key_exists('status', $storage_data)?$storage_data-&gt;status : 'guest'; return $this-&gt;isAllowed($role, $resource, $privilege); } }</span></span></code> </pre><br>  Put this code in the file application / classes / Acl.php. <br>  We describe the lists of rights in the standard form for ZF.  A method is also created here that checks the current user's access rights to the current action.  As resource identifiers, the controller / action format is used.  If you design the system in such a way that you do not change permissions inside the controller, then you can use only the names of controllers instead of resource identifiers (do not forget to change the <code>can</code> method). <br>  For more flexibility, we add the concept of "privilege", which allows you to control certain actions within the action.  The privilege to view is called "show." <br>  Now, when we have a list of access rights and we are able to determine whether a user has access to the current action, we need to embed the check into the Zend Framework request processing cycle.  Creating a front controller plugin is best suited for this.  Plugins allow you to perform specified actions at various stages of the dispatching process: <br><pre> <code class="php hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">CheckAccess</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Zend_Controller_Plugin_Abstract</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-comment"><span class="hljs-comment">/** *  preDispatch      *  controller/action      * generateAccessError * * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@param</span></span></span><span class="hljs-comment"> Zend_Controller_Request_Abstract $request */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">preDispatch</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Zend_Controller_Request_Abstract $request)</span></span></span><span class="hljs-function"> </span></span>{ $acl = Zend_Controller_Front::getInstance()-&gt;getParam(<span class="hljs-string"><span class="hljs-string">'bootstrap'</span></span>)-&gt;getResource(<span class="hljs-string"><span class="hljs-string">'Acl'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!$acl-&gt;can()){ <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;generateAccessError(); } } <span class="hljs-comment"><span class="hljs-comment">/** *       . *     error     *      . * * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@param</span></span></span><span class="hljs-comment"> string $msg */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">generateAccessError</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($msg=</span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">' !'</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span></span>{ $request = <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;getRequest(); $request-&gt;setControllerName (<span class="hljs-string"><span class="hljs-string">'error'</span></span>); $request-&gt;setActionName(<span class="hljs-string"><span class="hljs-string">'error'</span></span>); $request-&gt;setParam(<span class="hljs-string"><span class="hljs-string">'message'</span></span>, $msg); } }</code> </pre><br>  Place this code in the file application / plugins / CheckAccess.php. <br>  This plugin will perform user access checks on each request coming to the site.  To test access, use the Acl class, discussed above.  In case of an error, the request will be focused on error / error.  In order to correctly display an error message, you need to add the corresponding code in ErrorController.php. <br>  Now you need to connect the plugin and create an Acl resource in bootstrap: <br><pre> <code class="php hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">_initAcl</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>{ Zend_Loader::loadClass(<span class="hljs-string"><span class="hljs-string">'Acl'</span></span>); Zend_Loader::loadClass(<span class="hljs-string"><span class="hljs-string">'CheckAccess'</span></span>); Zend_Controller_Front::getInstance()-&gt;registerPlugin(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> CheckAccess()); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Acl(); }</code> </pre><br>  In order for Zend_Loader to ‚Äúknow‚Äù where to look for our files, add it to application.ini: <br><blockquote>  includePaths.plugins = APPLICATION_PATH "/ plugins" <br>  includePaths.classes = APPLICATION_PATH "/ classes" <br></blockquote><br>  <font color="#999">PS This post only considers one of the ways to implement access control, which is not universal, but meets the needs of most small sites.</font> </div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <p>Source: <a href="https://habr.com/ru/post/121114/">https://habr.com/ru/post/121114/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../121101/index.html">Maybe not to extremes?</a></li>
<li><a href="../121104/index.html">What can Ctrl in Visual Studio</a></li>
<li><a href="../121106/index.html">Mayor Cupertino approved Apple spacecraft</a></li>
<li><a href="../121107/index.html">ICQ dropped</a></li>
<li><a href="../121113/index.html">Quick build C ++ libraries for Android</a></li>
<li><a href="../121117/index.html">Powerful database server for a little over $ 2000</a></li>
<li><a href="../121118/index.html">VNC monitor from Playboy / Vogue player ‚Äúfor dummies‚Äù</a></li>
<li><a href="../121120/index.html">Script backup vps servers</a></li>
<li><a href="../121125/index.html">About today's ICQ crash</a></li>
<li><a href="../121126/index.html">Using TileMill</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>