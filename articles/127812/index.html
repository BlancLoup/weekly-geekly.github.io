<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Competitiveness in an asynchronous application on the example of twisted</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Theoretically, the problem of competitive access is not typical for asynchronous applications. Unlike applications with a parallel architecture, in wh...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Competitiveness in an asynchronous application on the example of twisted</h1><div class="post__text post__text-html js-mediator-article">  Theoretically, the problem of competitive access is not typical for asynchronous applications.  Unlike applications with a parallel architecture, in which several tasks claiming for some common resource can be performed at a time, in an asynchronous application, only one activity is performed at a time. <br><br>  <b>But in practice, everything looks a little different:</b> <br><a name="habracut"></a><br>  We present the following situation.  Our service works with a remote service (S), which processes requests in parallel.  We have resource A, which depends on data on S. Request R1 updates A, for this it requests data from S. R2 comes at this time, it modifies the corresponding data on S. Request R2 comes later, but because of the parallel architecture S - processed earlier (see Fig.1). <br><br><img src="https://habrastorage.org/getpro/habr/post_images/6d3/e43/3a9/6d3e433a9b24dd7ab1702ba7225da4ad.jpg" alt="image"><br>  Fig.1.  The order of the query. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Now R1 receives data already with modifications R2, while resource A does not yet know that this is the result of R2 operations.  Here is the race condition. <br><br><h5>  Example: </h5><br>  Kolya has a wife and a bank account.  Kohl and his wife decided that they have equal rights and a common budget in their family, and therefore each of them has a card tied to this account.  Kohl works on freelancing and the time comes when he should pay for the latest project. <br>  His wife decides to please Kohl, and give him a new iPad2 for DR.  Getting up early in the morning, she finds N $ in the account!  Joyful, she orders her husband‚Äôs iPad2 and her new watch.  When Kohl checks the bank account, there is "still" zero.  He does not guess to check the recent operations and for a long time he swears with the customer. <br><br>  Kohl - request 1, his wife - request 2, a bank account - a resource on a remote service, bank cards - a proxy for a remote resource. <br><br>  In place of Kolya, his wife and bank accounts can be: financial services, process control systems and much more.  The essence of my problem specifically can not disclose, as the NDA. <br><br><h5>  How to fight. </h5><br>  We will fight with the use of twisted.  Although the overall concept is true for any asynchronous framework. <br><br>  Obviously, the solution is to lock the resource A. Theoretically, the same constructions will be suitable for blocking as for the parallel architecture: semaphor, mutex, conditional variable.  The question of implementation.  So, consider mutex (why mutex? Because the conditional variable is trivial, and for semaphor I haven‚Äôt managed to find an application yet). <br><br><h5>  How to make a mutex? </h5><br>  <b>Option non-working.</b>  In a parallel architecture, the stream can simply sleep, and we will not get anything for it.  In an asynchronous architecture - if we just fall asleep (for example, time.sleep (100)) - then everything will be a stake, and we will never wait, because we need the eventloop to switch to processing the request that blocked the resource, and while we are sleeping - will not happen. <br><br>  <b>The option is wrong.</b>  You can implement it via reactor.callLater (1, self.some_method, * args), where self.some_method is our method that waits for the end of the lock. <br><br>  The disadvantages are as follows: <br><ul><li>  Pretty scary code. </li><li>  We are waiting a full second, and much can happen for it, for example, a certain request Rn will block A. again. </li></ul><br><br>  <b>Option.</b>  And finally, the right option.  We have an asynchronous application built on Deferreds.  In order for something to happen in it, it is necessary for Deferred to work.  Conclusion - the lock must be done on Deferred'ah. <br><br><pre><code class="python hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Mutex</span></span></span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">(object)</span></span></span><span class="hljs-class">:</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">__init__</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self)</span></span></span><span class="hljs-function">:</span></span> self.locked = <span class="hljs-keyword"><span class="hljs-keyword">False</span></span> self.waiters = list() <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">acquire</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self)</span></span></span><span class="hljs-function">:</span></span> d = Deferred() <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> self.locked: self.waiters.append(d) <span class="hljs-keyword"><span class="hljs-keyword">else</span></span>: self.locked = <span class="hljs-keyword"><span class="hljs-keyword">True</span></span> d.callback(<span class="hljs-keyword"><span class="hljs-keyword">True</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> d <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">release</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self)</span></span></span><span class="hljs-function">:</span></span> self.locked = <span class="hljs-keyword"><span class="hljs-keyword">False</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> self.waiters: self.locked = <span class="hljs-keyword"><span class="hljs-keyword">True</span></span> d = self.waiters.pop() d.callback(<span class="hljs-keyword"><span class="hljs-keyword">True</span></span>)</code> </pre> <br>  The construction is simple: if we want to access the resource, we get Deferred.  We start working with a resource only after Deferred is triggered.  The class itself tracks the testing of the Deferreds, and as soon as one of them works out, he gets the next one out of the queue and starts it. <br><br>  The example implementation is not complete, the twisted (DeferredLock) mutex implementation can be viewed here: <a href="http://twistedmatrix.com/trac/browser/tags/releases/twisted-11.0.0/twisted/internet/defer.py">http://twistedmatrix.com/trac/browser/tags/releases/twisted-11.0.0/twisted/internet/defer.py</a> .  There is also DeferredSemaphore. <br><br><h5>  An example of use. </h5><br>  You can use it in different ways: you can make the object itself monitor access to it: <br><br><pre> <code class="python hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ImportantObject</span></span></span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">(object)</span></span></span><span class="hljs-class">:</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">__init__</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self)</span></span></span><span class="hljs-function">:</span></span> self.lock = defer.DeferredLock() <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">get_lock</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> self.lock.acquire() <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">release_lock</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> self.lock.release()</code> </pre><br><br>  Or, if objects are selected from the database and stored in sessions (that is, for each request, the ImportantObject object with id 1 will be different), you can make a pool of locks: <br><br><pre> <code class="python hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Pool</span></span></span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">(object)</span></span></span><span class="hljs-class">:</span></span> __metaclass__ = Singleton <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">__init__</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self, objects_list)</span></span></span><span class="hljs-function">:</span></span> self.__objects = dict() <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> o <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> objects_list: self.__objects[o.id] = defer.DeferredLock() <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">acquire</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self, o)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> o.id <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> self.__objects: self.__objects[o.id] = defer.DeferredLock() <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> self.__objects[o.id].acquire() <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">release</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self, o)</span></span></span><span class="hljs-function">:</span></span> self.__objects[o.id].release()</code> </pre><br><br>  Pool here is slightly simplified, we ‚Äúforgot‚Äù the methods for updating the list of monitored objects so as not to clutter up the article.  We also missed the implementation of Singleton, but finding / making it would not be difficult even for a beginner pythonist. <br><br>  And finally: <br><br><pre> <code class="python hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">multiplex</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self, a)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">get_value_from_remote_service</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(skipped, a)</span></span></span><span class="hljs-function">:</span></span> d = some_service.do_long_boring_call(a) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> d <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">multiply</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(result, a)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> result*a d = Pool().acquire(a) d.addCallback(get_value_from_remote_service, a) d.addCallback(power,a) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> d</code> </pre><br><br>  PS: Unfortunately, the twisted documentation is far from exhaustive.  Moreover, it covers well if 30 percent of this framework.  Therefore, when I solved the problem of competitiveness - I invented various bicycles for 3 days.  Until I thought to see the source twisted.  So the general advice - working with twisted - read more the source code, there are hidden bicycles for all occasions. <br><br>  Sources: <br>  <a href="http://twistedmatrix.com/documents/11.0.0/api/twisted.internet.defer.html">Official documentation twisted.</a> <br>  <a href="http://twistedmatrix.com/trac/browser/tags/releases/twisted-11.0.0/twisted/internet/defer.py">Twisted sources</a> </div><p>Source: <a href="https://habr.com/ru/post/127812/">https://habr.com/ru/post/127812/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../127806/index.html">Alert the emergence of a new topic on Habrahabr using Python</a></li>
<li><a href="../127807/index.html">Home Media Organization</a></li>
<li><a href="../127808/index.html">Getting started with jPCT - a free 3d engine for Java</a></li>
<li><a href="../127809/index.html">Mozilla selected the Firefox trademark from Russian cybersquatters</a></li>
<li><a href="../127811/index.html">Implementing a RESTful service in classic ASP.NET</a></li>
<li><a href="../127814/index.html">If the site you visit will play music</a></li>
<li><a href="../127815/index.html">CloudShot - DropBox Screenshot</a></li>
<li><a href="../127817/index.html">Nolan Bushnell, founder of Atari: life is like a game</a></li>
<li><a href="../127818/index.html">Background mode in Google Chrome</a></li>
<li><a href="../127819/index.html">Social Design Strategy</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>