<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Android JNI + Intelij Idea + Gradle. Full process automation</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Good day! 
 This post is a small tutorial on automating the compilation of native code in Intellij Idea using Gradle. Gradle provides quite a lot of f...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Android JNI + Intelij Idea + Gradle. Full process automation</h1><div class="post__text post__text-html js-mediator-article">  Good day! <br>  This post is a small tutorial on automating the compilation of native code in Intellij Idea using Gradle.  Gradle provides quite a lot of functionality for auto-assembling projects.  But even connecting native libraries to the Android project requires additional efforts from the developer. <br><br><h4>  Prehistory </h4><br>  Recently, I changed jobs and got a job at a company that develops my own mobile software.  My new colleagues and I decided to switch from Eclipse (which all development was done before) to Intellij Idea, and in addition from Ant to Gradle.  We have a fairly large project, with a decent amount of code, including using native C and C ++ code, both self-written and ready-made libraries. <br><br>  Those who are engaged in the development of Android projects using the Android NDK in the Intellij Idea + Gradle environment I ask for cat. <br><a name="habracut"></a><br><h4>  Hastily </h4><br>  As for the java code, we rather easily transferred the whole development process to a new IDE and build system, I will not delve into this process.  With the transfer of native code, everything was much more complicated. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Since we didn‚Äôt have enough time to search for a suitable solution right away, so we just collected all the modules of the native project for the platforms we needed, put them in the source folder of our project and used the quickly found solution to automatically include them in our apk file, this approach is described in <a href="http://habrahabr.ru/post/193122/">this article</a> . <br><br><h4>  Finding the right solution </h4><br>  In fact, the first approach for some time we are absolutely satisfied.  Libraries were tested a long time ago, and we didn‚Äôt have to make frequent changes to the native code, until recently, when we needed to add another module.  Then we began to look for a solution on how to compile all of our source code, including the native one. <br><br>  It turned out that Gradle ignores Android.mk files and creates its own.  To do this, it provides great functionality on the transfer of various flags and properties of ndk.  This is well written in <a href="http://habrahabr.ru/company/intel/blog/216353/">this article</a> .  But we liked to use the compilation features, using * .mk files. <br><br>  That's why we remembered that Gradle provides great functionality for the build and tried to directly call the ndk-build script provided by the Android NDK. <br><br>  In order for this to happen automatically, a separate Gradle-task was written and added to the dependencies of the task on automatic packaging of native libraries.  Here is a cut from the build.gralde file of our module: <br><br><pre><code class="java hljs">task(<span class="hljs-string"><span class="hljs-string">'compileNative'</span></span>) { exec { executable = <span class="hljs-string"><span class="hljs-string">'path/to/ndk/ndk-build'</span></span> args = [<span class="hljs-string"><span class="hljs-string">"NDK_PROJECT_PATH=src/main"</span></span>] } } <span class="hljs-function"><span class="hljs-function">task </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">nativeLibsToJar</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(type: Zip, description: </span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">'create a jar archive of the native libs'</span></span></span></span><span class="hljs-function"><span class="hljs-params">, dependsOn: </span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">'compileNative'</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-function"><span class="hljs-function">destinationDir </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">file</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">"$buildDir/native-libs"</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> baseName '</span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">native</span></span></span><span class="hljs-function">-libs' extension 'jar' from </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">fileTree</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(dir: </span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">'jniLibs'</span></span></span></span><span class="hljs-function"><span class="hljs-params">, include: </span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">'**/*.so'</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> into 'lib/' } tasks.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">withType</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(JavaCompile)</span></span></span><span class="hljs-function"> </span></span>{ compileTask -&gt; compileTask.dependsOn(nativeLibsToJar) }</code> </pre> <br><br>  In principle, this code is already enough to compile the native sources in automatic mode and connect them to the project.  But we work in a team and it‚Äôs not good if everyone will modify the main build file for themselves, because everyone will most likely have his own 'path / to / ndk /'.  Therefore, it was decided to place the path to the NDK in the local settings file of the project assembly. <br><br><pre> <code class="java hljs">#    NDK ndk.dir=path/to/ndk #    SDK sdk.dir=path/to/sdk</code> </pre><br><br>  The local.properties file must be in the project root.  If you add this file, you will need to specify not only the NDK directory, but also the SDK directory, otherwise Gradle will issue a corresponding warning and refuse to build your project. <br><br>  Now we are changing our Gradle task, adding the use of a local path to the NDK. <br><br><pre> <code class="java hljs">task(<span class="hljs-string"><span class="hljs-string">'compileNative'</span></span>) { def $ndkProjectRootFolder = <span class="hljs-string"><span class="hljs-string">'src/main'</span></span> def $ndkDirPropertyName = <span class="hljs-string"><span class="hljs-string">'ndk.dir'</span></span> <span class="hljs-comment"><span class="hljs-comment">//     Properties properties = new Properties() //      properties.load(project.rootProject.file('local.properties').newDataInputStream()) //      ndk def $ndkDir = properties.getProperty($ndkDirPropertyName) //           if( $ndkDir == null) throw new RuntimeException("Property 'ndk.dir' not found. Please specify it. \n" + " It must be something like this in your local.properties file \n" + " ndk.dir=path/to/your/ndk") //       native  exec { executable = $ndkDir + '/ndk-build' args = ["NDK_PROJECT_PATH=" + $ndkProjectRootFolder] } }</span></span></code> </pre><br><br>  Gradle allows you to define variables and throw exceptions in the build process, so let's use this functionality.  If in the local settings, the developer does not specify the path to the Android NDK then we remind him to do it. <br><br>  And lastly, we must remember that some developers are sitting on Windows. <br><br><pre> <code class="java hljs">task(<span class="hljs-string"><span class="hljs-string">'compileNative'</span></span>) { def $ndkBuildScript = <span class="hljs-comment"><span class="hljs-comment">//   ndk-build (linux) / ndk-build.cmd (windows)   ndk System.properties['os.name'].toLowerCase().contains('windows') ? 'ndk-build.cmd' : 'ndk-build' def $ndkProjectRootFolder = 'src/main' def $ndkDirPropertyName = 'ndk.dir' //     Properties properties = new Properties() //      properties.load(project.rootProject.file('local.properties').newDataInputStream()) //      ndk def $ndkDir = properties.getProperty($ndkDirPropertyName) //           if( $ndkDir == null) throw new RuntimeException("Property 'ndk.dir' not found. Please specify it. \n" + " It must be something like this in your local.properties file \n" + " ndk.dir=path/to/your/ndk") //       native  exec { executable = $ndkDir + '/' + $ndkBuildScript args = ["NDK_PROJECT_PATH=" + $ndkProjectRootFolder] } }</span></span></code> </pre><br><br>  The result of our work is the automatic compilation of native code using all the advantages of Android.mk files and compiling it into an apk file.  Well, as a plus, now it is not necessary to store the compiled libraries in the repository. <br><br>  I hope this approach will be useful. </div><p>Source: <a href="https://habr.com/ru/post/227541/">https://habr.com/ru/post/227541/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../227529/index.html">Why Vase drowned, and C ++ still afloat</a></li>
<li><a href="../227531/index.html">ElasticSearch - mapping and search without surprises</a></li>
<li><a href="../227533/index.html">Database backup - is it there?</a></li>
<li><a href="../227537/index.html">‚ÄúFrost-bitten‚Äù computer and useful ‚ÄúHryuker‚Äù: what will surprise NeoQUEST-2014</a></li>
<li><a href="../227539/index.html">How to prepare for the PMP exam for an experienced project manager</a></li>
<li><a href="../227543/index.html">Addon for generating materials Cycles Blender</a></li>
<li><a href="../227545/index.html">Experience in custom analysis of c # code</a></li>
<li><a href="../227555/index.html">Paint.NET 4.0 graphic editor released</a></li>
<li><a href="../227559/index.html">Again about the clouds. Several tools for VMware virtual infrastructure administrators</a></li>
<li><a href="../227565/index.html">LG G Watch and Samsung Gear Live smart watches are available for pre-order</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>