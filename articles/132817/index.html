<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Comprehensive website optimization on WordPress</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Dear residents of Habr! 

 Your attention is the story of how we optimized your site. The site is powered by Wordpress (most readers should wince at t...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Comprehensive website optimization on WordPress</h1><div class="post__text post__text-html js-mediator-article">  Dear residents of Habr! <br><br>  Your attention is the story of how we optimized your site.  <a href="http://www.appleinsider.ru/">The site is</a> powered by Wordpress (most readers should wince at this phrase, knowing how WordPress is doing at speed).  But still we did it, and the site began to fly.  I‚Äôll say right away that I can hardly be considered a server optimization professional, but what I‚Äôve been able to achieve makes me very happy.  Also, invaluable experience was gained, which I want to share with Habr's readers. <br><a name="habracut"></a><br><h3>  Go </h3><br>  We began with a study of the causes of inhibition of the site.  Personally, I like the <a href="http://loadimpact.com/">LoadImpact</a> service the <a href="http://loadimpact.com/">most</a> .  Not so long ago, he had new features and a new interface, and the service itself began to be called "LoadImpact 2.0".  All this is not said for advertising sake - the service is really good.  You can also test the site using similar services - <a href="http://tools.pingdom.com/fpt/">Pingdom Full Page Test</a> and <a href="https://developers.google.com/pagespeed/">Google PageSpeed</a> . <br><br>  With the help of <a href="http://loadimpact.com/page-analyzer">Load Impact Page Analyzer,</a> we found a great value for the Time to first byte parameter (4 seconds), which told us that the PHP scripts that form the page run too long.  It was necessary to look for the most brake components of the site. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Adding to the template footer.php line <br><br> <code>&lt;!-- &lt;?php echo get_num_queries(); ?&gt; queries --&gt; <br></code> <br>  we saw that 82 SQL queries are required to generate the main page, which is a lot.  It became clear that you need to reduce the number of WordPress modules, and with them the number of SQL queries.  After smashing up the installed WordPress plugins, of which there were about 40 pieces, we realized that most of them are really needed. <br><br>  We decided to make profiling of all the PHP code in the template.  We did not bother with Xdebug + <a href="http://wordpress.org/extend/plugins/performance-testing/">Performance Testing</a> (to do this, we had to install a bunch of third-party software), but we did a simple self-profiling of the form: <br><br> <code>&lt;!-- HEADER01 - &lt;?php print microtime(true) ?&gt; --&gt; <br></code> <br>  We immediately discovered the following major problems: <br><ul><li>  geo-targeting advertising module </li><li>  Apple stock price module </li><li>  side blocks "Review of applications" and "most interesting" </li></ul>  Each of these problems, upon closer inspection, causes a reference facepalm.  Now I will tell about each of them. <br><br><h4>  Time </h4><br>  The biggest brake on our site was the geo-targeted advertising module.  Its essence is that the site shows two types of banners - one is displayed for visitors from St. Petersburg, and the other for all others.  Having gone deep into the module, I discovered this, sorry, shit code: <br><br><blockquote><pre> if ($ ip_part)
 {
 for ($ y1 = $ ip_part [0] ['start']; $ y1 &lt;= $ ip_part [0] ['end']; $ y1 ++)
 for ($ y2 = $ ip_part [1] ['start']; $ y2 &lt;= $ ip_part [1] ['end']; $ y2 ++)
 for ($ y3 = $ ip_part [2] ['start']; $ y3 &lt;= $ ip_part [2] ['end']; $ y3 ++)
 for ($ y4 = $ ip_part [3] ['start']; $ y4 &lt;= $ ip_part [3] ['end']; $ y4 ++)
 {
 $ ip [] = $ y1. ".". $ y2. ".". $ y3. ".". $ y4;
 if ($ ip_addr == $ y1. ".". $ y2. ".". $ y3. "." $ y4) return true;
 }
 }
</pre></blockquote><br>  At this point, I even felt a little sorry for the processor, which all this time was doing empty work ... <br><br>  The initial ranges of IP addresses of St. Petersburg were set in advance in the $ ip_part array.  As you can see from this piece of code, for each function call, for some reason, a dynamic array of $ ip was created and filled with string (!) Data with IP addresses, stupidly after 4 nested loops.  In each iteration of the loop, the visitor's IP address was compared line by line (!) With the resulting IP address string.  Fix it was simple: <br><br><blockquote><pre> $ ip_tmp = explode (".", $ ip_addr);
 if ($ ip_part)
 if (($ ip_part [0] ['start'] &lt;= $ ip_tmp [0]) and ($ ip_tmp [0] &lt;= $ ip_part [0] ['end']))
 if (($ ip_part [1] ['start'] &lt;= $ ip_tmp [1]) and ($ ip_tmp [1] &lt;= $ ip_part [1] ['end']))
 if (($ ip_part [2] ['start'] &lt;= $ ip_tmp [2]) and ($ ip_tmp [2] &lt;= $ ip_part [2] ['end']))
 if (($ ip_part [3] ['start'] &lt;= $ ip_tmp [3]) and ($ ip_tmp [3] &lt;= $ ip_part [3] ['end']))
 return true;
</pre></blockquote><br>  I do not deny that this code can be rewritten more optimally, however, even after this edit, the site has earned 2 seconds faster! <br><br><h4>  Two </h4><br><img align="right" src="https://habrastorage.org/storage1/bd888530/647528cc/2e14b91b/af2bac8c.png">  The second plugin called Embedded Stock Data, which on our page showed quotes Apple.  It was found that this bastard at every page load went to another site (!) Through CURL.  Naturally, this greatly increased the page load time.  Solved the problem in a natural way - on the server once a minute, a script was called on the crown, which downloaded the required quote and saved it in a special file.  Next we include this file.  This gave us about 500 ms. <br><br><h4>  Three </h4><br>  Side blocks "Review of applications" and "Most Interesting" also performed significant time.  Looking inside the template (sidebar.php), I saw the classic mistake of novice web programmers called ‚ÄúORDER BY RAND ()‚Äù.  More information about the essence of this problem can, for example, <a href="http://habrahabr.ru/blogs/mysql/54176/">read here</a> . <br><br>  For those interested, there was this code: <br><br><blockquote><pre> $ args = array (
 'caller_get_posts' =&gt; '1',
 'post__not_in' =&gt; $ sticky,
 'cat' =&gt; '75',
 'fields' =&gt; 'ids',
 'post_per_page' =&gt; '20',
 'orderby' =&gt; 'id',
 );
 $ sk_count = new WP_Query ($ args);

 $ args = array (
 'caller_get_posts' =&gt; '1',
 'post__not_in' =&gt; $ sticky,
 'showposts' =&gt; '4',
 'cat' =&gt; '75',
 &lt;b&gt; 'orderby' =&gt; 'rand' &lt;/ b&gt;
 );
 $ sk_posts = new WP_Query ($ args);
</pre></blockquote><br>  In it, we replaced the highlighted line with <br><br><pre> 'post__in' =&gt; array_rand (array_flip ($ sk_count-&gt; posts), 4)
</pre><br>  The essence of the solution - we pre-select the 20 most recent entries, then choose from these 20 entries a random 4 pieces, and then select from the base posts with these numbers. <br><br>  On this we saved another half a second. <br><br><h3>  Moving to Clodo </h3><br>  Our iron server initially hosted a large number of sites, but the most important for traffic and value was <a href="http://www.appleinsider.ru/">AppleInsider.ru</a> .  We wanted to protect this site from the neighborhood with other sites, and it was decided to transfer it to the cloud <a href="http://www.clodo.ru/">of Clodo</a> .  The main advantage of Clodo can be called the "elasticity" of tariffing - how many resources you use, you pay so much.  Hand on heart, I would also like to mention the technical support of the company, which even behaved correctly in a non-VIP version, answered all our tricky questions and helped in setting up. <br><br>  ‚ÄúUnder the guise of‚Äù with the transfer, some changes were made, for example, we removed the completely heavy Apache web server, and instead we made a bunch of nginx + php-fpm, which eats less memory.  Nginx worked in the usual way - it gave statics, and everything else was redirected to the index.php script, in which further WordPress logic goes. <br><br>  In order not to take away the resources of the hardware allocated for the nginx + php-fpm web server, we brought the MySQL database server to a separate server, connecting it to the web server via a local network. <br><br>  We also set up two separate ‚Äúcloud‚Äù servers - for our <a href="http://www.appleinsider.ru/ipodcast">podcast AppleInsider.ru</a> and <a href="http://www.appleinsider.ru/yablochnyj-ogryzok">Apple Stub</a> and for online text broadcasts.  We will tell about them in more detail next time. <br><br>  The transition to Clodo has not significantly reduced the time of page generation, but this has secured the site itself. <br><br><h3>  WP Super Cache and Asynchronous Advertising </h3><br>  At this stage, the page was formed in about 1 second.  Already not bad, but it was not enough for us, because there were still a few moments that could be optimized. <br><br>  For example, use a plugin to cache WordPress pages called <a href="http://wordpress.org/extend/plugins/wp-super-cache/">WP Super Cache</a> .  It works like a regular cache - the user enters the page, it is generated and placed in the / wp-content / cache / supercache directory.  The next visitor will be given a static, pre-formed HTML file.  It would seem that everything is super - the site is flying ... <br><br>  However, as it was soon discovered, the use of caching broke geotargeted advertising.  Check for the entry of the visitor's address in the address range of St. Petersburg was performed at the PHP level, i.e.  already behind the cache.  Accordingly, the result of this check "forever" remained in the cache.  But we still had to distinguish the display of banners. <br><br>  We solved this task as follows: Javascipt instructions were placed in the template of the page in the right places, indicating that you need to load content from a specific URL into this div block.  Thus, the user freely receives the cached page with Javascript instructions, and after the first letters appear, advertising and other structural blocks of the site, stored at separate special URL addresses, begin to load.  Visually, this happens very quickly.  So we managed to achieve two goals - firstly, due to caching the site was significantly accelerated, and secondly, geo-targeted advertising was working correctly. <br><br><h3>  ClodoStorage </h3><br>  The last step we made in optimization was to transfer static content (images, CSS styles, Javascript) to CloudStorage.  Read more about it <a href="http://habrahabr.ru/company/clodo/blog/130410/">here</a> .  In a nutshell - this is the Content Delivery Network from Clodo, and in Russian - a very fast server, specially sharpened for the distribution of statics. <br><br>  The integration with WordPress consists in correctly configuring two plugins - the CDN Sync Tool (for Clodo you need to use the <a href="https://github.com/ClodoCorp/php-cloudfiles">special assembly of the PHP Cloud Files API library</a> ) and the WP Super Cache. <br><br>  The first plugin, <a href="http://wordpress.org/extend/plugins/cdn-sync-tool/">CDN Sync Tool</a> , is committed to uploading WordPress content to the repository, performing some actions along with this content.  With the <a href="http://wordpress.org/extend/plugins/wp-minify/">WP Minify plugin,</a> it can compress CSS and JS files.  He can also compress downloaded images on the fly.  In this case, the GD library is used; for us, the GD Compression Level = 2 compression level turned out to be the most acceptable - to put it in terms of other programs, this is 90% quality.  The most important thing, of course, is that with the standard upload of pictures by the authors, they began to be automatically uploaded to the repository. <br><br>  For statics, we created a separate subdomain static.appleinsider.ru, and the initial content download was done using <a href="http://cyberduck.ch/">CyberDuck</a> - this is a fairly convenient program for working with FTP, SFTP, WebDAV, Cloud Files, Google Docs and Amazon S3. <br><br>  Here is a screenshot of the Clodo CDN Sync Tool plugin (clickable): <br> <a href=""><img src="https://habrastorage.org/storage1/3b481fe0/e636b372/d12268b3/c34c528c.jpg"></a> <br> <a href="http://cdn_sync_tool.png/"><img src="http://CDN_Sync_Tool_mini.jpg"></a> <br><br>  The second plugin, which we have already mentioned, WP Super Cache, is tricky - it takes the generated page and replaces all URLs for static files with URLs in the repository.  For example, <a href="">http://www.appleinsider.ru/Angry-Birds.jpg</a> will be <a href="">http://static.appleinsider.ru/Angry-Birds.jpg</a> <br><br><h3>  Results </h3><br><img src="https://habrastorage.org/storage1/3873513d/18f30659/bea1c825/7315be21.png"><br><br>  Now, if there is no page in the cache, the page loads in 1.25 seconds, if there is 250 ms in the cache, and this taking into account all 4 factors - DNS Lookup + Connection + Time to first + Download.  I think this is a great result! <br><br>  In conclusion, I will give dry facts - statistics on the use of resources and financial costs. <br><br>  For the week of work November 23, 2011 - November 30, 2011: <br><br><h4>  Web </h4><br><img src="https://habrastorage.org/storage1/c365857e/18ebec0a/2cd0938f/d7b88676.png"><br><img src="https://habrastorage.org/storage1/a6428c5d/a1dea392/86b8cf3f/343b79f1.png"><br><table><tbody><tr><td>  Scale Server - RAM resources </td><td>  45708.00 GB * min </td><td>  457.080 rub. </td></tr><tr><td>  Scale Server - processor resources </td><td>  1027116.50 CPU sec </td><td>  427.300 rub. </td></tr><tr><td>  Use of disk resources </td><td>  5760.00 GB * hour </td><td>  57.600 rub. </td></tr><tr><td>  Incoming traffic (full gigabytes) </td><td>  34 GB </td><td>  6.800 rub. </td></tr><tr><td>  Outgoing traffic (full gigabytes) </td><td>  129 GB </td><td>  129.870 rub. </td></tr><tr><td>  Disk usage for backups </td><td>  1910.00 GB * hour </td><td>  19.100 rub. </td></tr><tr><td>  SMS notifications </td><td>  1 PC. </td><td>  5.000 rub. </td></tr><tr><td>  <i>Total debited from the account</i> </td><td></td><td>  <i>1102.75 rub.</i> </td></tr></tbody></table><br><br><h4>  DB </h4><br><img src="https://habrastorage.org/storage1/9fa9a157/bc3caee3/34bfcbe3/87d18e09.png"><br><img src="https://habrastorage.org/storage1/2723c0b9/e3b7ad11/8fba367e/7c86db9a.png"><br><table><tbody><tr><td>  Scale Server - RAM resources </td><td>  22924.00 GB * min </td><td>  229.240 rub. </td></tr><tr><td>  Scale Server - processor resources </td><td>  67490.34 CPU sec </td><td>  28.080 rub. </td></tr><tr><td>  Use of disk resources </td><td>  3840.00 GB * hour </td><td>  38.400 rubles </td></tr><tr><td>  Incoming traffic (full gigabytes) </td><td>  1 GB </td><td>  0.200 rub. </td></tr><tr><td>  Outgoing traffic (full gigabytes) </td><td>  12 GB </td><td>  12.000 rub. </td></tr><tr><td>  Disk usage for backups </td><td>  1910.00 GB * hour </td><td>  19.100 rub. </td></tr><tr><td>  <i>Total debited from the account</i> </td><td></td><td>  <i>327.02 rub.</i> </td></tr></tbody></table><br><br><h4>  Cloudstorage </h4><br><img src="https://habrastorage.org/storage1/1df5f594/62cba356/951a1dbf/ae7e70cb.png"><br><table><tbody><tr><td>  Cloud Storage - Disk Usage </td><td>  1139.00 GB * hour </td><td>  11.390 rub. </td></tr><tr><td>  Cloud Storage - incoming traffic (full gigabytes) </td><td>  - </td><td>  not charged </td></tr><tr><td>  Cloud Storage - outgoing traffic (full gigabytes) </td><td>  330 GB </td><td>  330.000 rub. </td></tr><tr><td>  <i>Total debited from the account</i> </td><td></td><td>  <i>341.39 rub.</i> </td></tr></tbody></table><br>  Total for the week of the site - 1771.16 rubles.  Quite a lot, but stability and satisfied users are worth it :-) <br><br>  Really looking forward to your comments. </div><p>Source: <a href="https://habr.com/ru/post/132817/">https://habr.com/ru/post/132817/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../132808/index.html">SaveMoney for everyone</a></li>
<li><a href="../132810/index.html">Try AndEngine and physicsbox2d</a></li>
<li><a href="../132812/index.html">Video comparison of Windows Phone 7 and Android OS</a></li>
<li><a href="../132813/index.html">Sony Ericsson WT19i - Review with Comments</a></li>
<li><a href="../132815/index.html">DrupalSN: free registration!</a></li>
<li><a href="../132818/index.html">Home Virtualization or Atom Virtualization</a></li>
<li><a href="../132819/index.html">Ubuntu 11.10 build from NNLUG</a></li>
<li><a href="../132821/index.html">Mobile version of 2GIS appeared in the OVI Store</a></li>
<li><a href="../132822/index.html">Deploying Kaviza VDI-in-a-Box</a></li>
<li><a href="../132823/index.html">PROhq for legal freelance: each freelancer can apply for IE for free</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>