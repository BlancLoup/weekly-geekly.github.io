<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>PVS-Studio and hostile habitat</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Another story, how difficult it is for programs to interact with the outside world. At first glance, the static analyzer should have no problems. It r...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>PVS-Studio and hostile habitat</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/getpro/habr/post_images/9c4/269/d0f/9c4269d0fb59178f062414b5b8e5f406.png" alt="hostile habitat" align="left"><br>  Another story, how difficult it is for programs to interact with the outside world.  At first glance, the static analyzer should have no problems.  It receives files for input, additional information and must generate a report.  But as always, the devil is in the details. <br><br>  I consider PVS-Studio a very high quality product.  We can make and upload a distribution kit almost any day.  We use a very large number of automated tests of various levels and types.  Here is a description of some of them: " <a href="http://www.viva64.com/ru/a/0047/">How we test the code analyzer</a> ."  Now there are more of them.  For example, now for static analysis we use not only our own analyzer, but also Clang.  If the revised version has passed all the tests, then it can be safely issued to users. <br><a name="habracut"></a><br><br>  Unfortunately, all the beauty and reliability of the internal code sometimes falls apart due to the impacts of a hostile environment.  As a result, the entire impression of the product spoils.  It seems we are not to blame, but it is our product that does not work.  I can cite a large number of examples.  The first thing that comes to mind is: <ul><li>  Third-party add-in spoils something in the Visual Studio environment.  As a result, you have to create a crutch to work around a problem, or accept it and respond, "sorry, we can do nothing."  One such example is " <a href="http://www.viva64.com/ru/b/0056/">Description of the Intel Parallel Studio Service Pack 1 Integration Error in Visual Studio 2005/2008</a> ." </li><li>  Visual Studio COM interfaces for project information may unexpectedly throw an exception.  Apparently, the environment at this unfortunate moment is busy with something else.  Challenges have to be wrapped in a loop for multiple repetitions.  Dances with a tambourine, which do not always help. </li><li>  A developer has antivirus X and, according to corporate policy, he does not have the right to change his settings.  This antivirus "holds" for some time some temporary files, and the analyzer cannot delete them.  The result is that the analyzer "shits" in the project folder. </li><li>  Miscellaneous can be remembered.  Some examples can be found <a href="http://www.viva64.com/ru/b/0181/">here</a> , <a href="http://www.viva64.com/ru/b/0086/">here</a> and <a href="http://www.viva64.com/ru/b/0031/">here</a> . </li></ul><br>  Now I will tell another such story, how easy it is to spoil the impression of our product, being innocent. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      One of the potential users sent a question about the strange behavior of PVS-Studio: <br><br>  <i>We are now chasing the trial version and are thinking about buying the full one.</i>  <i>However, the analysis stumbled upon one nuance that puts the validity of the conclusions into question.</i> <br><br>  <i>Below is a screenshot showing the error.</i> <br><br>  <i>filePath and cachePath are marked as unused (warning <a href="http://www.viva64.com/ru/d/0274/"><i>V808</i></a> ), although it can be seen that they are used literally in the next line after the announcement.</i> <br><br>  <i>Could you explain this behavior of the analyzer?</i> <br><br>  In the screenshot you can see the code of the following type (code changed): <br><pre><code class="cpp hljs"><span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::<span class="hljs-function"><span class="hljs-built_in"><span class="hljs-function"><span class="hljs-built_in">string</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Foo</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::<span class="hljs-function"><span class="hljs-built_in"><span class="hljs-function"><span class="hljs-built_in">string</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">filePath</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(MAX_PATH + </span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">1</span></span></span></span><span class="hljs-function"><span class="hljs-params">, </span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">0</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span></span>; <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::<span class="hljs-built_in"><span class="hljs-built_in">string</span></span> cachePath = <span class="hljs-string"><span class="hljs-string">"d:\\tmp"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!GetTempFileName(cachePath.c_str(), <span class="hljs-string"><span class="hljs-string">"tmp"</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, &amp;filePath.front())) <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> MakeSystemError(<span class="hljs-string"><span class="hljs-string">"..."</span></span>, GetLastError(), __SOURCE__); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::move(filePath); }</code> </pre> <br>  What can I say.  Shame on the analyzer.  After all, really reports nonsense.  The variables filePath and cachePath are explicitly used.  There are no reasons for warning.  And okay, the function would be on 1000 lines.  No, the function is simple for disgrace. <br><br>  Everything, the first impression is spoiled.  Now I will tell about the results of the investigation. <br><br>  PVS-Studio analyzer uses the Visual C ++ compiler (CL.exe) or Clang to preprocess files.  In more detail, how we use Clang is described in the article: " <a href="http://www.viva64.com/ru/b/0186/">A little about the interaction of PVS-Studio and Clang</a> ". <br><br>  The Visual C ++ compiler preprocessor works efficiently, but very slowly.  Clang is fast, but a lot of things don't support or work incorrectly.  Clang developers say they are very well compatible with Visual C ++, but this is not true.  There are many little things that they do not support or do not like Visual C ++.  For the analyzer, these little things are fatal, as happened this time. <br><br>  By default, the PVS-Studio analyzer first tries to preprocess the file with Clang.  However, he knows: Clang is far from always able to preprocess what Visual C ++ can.  If a preprocessing error occurs, CL.exe is launched.  So a little time is lost on the useless launch of Clang, but in general this approach saves time on getting * .i files. <br><br>  In this case, it did not help.  Clang ‚Äúsuccessfully‚Äù preprocessing the file, although the output is abracadabra. <br><br>  The reason for the incorrect behavior was the macro __SOURCE__, declared in the code as follows: <br><pre> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> __SLINE_0__(_line) #_line #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> __SLINE__(_line) __SLINE_0__(_line) #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> __SOURCE__ __FILE__</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">":"</span></span></span><span class="hljs-meta">__SLINE__(__LINE__)</span></span></code> </pre> <br>  When preprocessing a line: <br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> MakeSystemError(_T(<span class="hljs-string"><span class="hljs-string">"GetTempFileName"</span></span>), GetLastError(), __SOURCE__);</code> </pre> <br>  It should turn into: <br><pre> <code class="cpp hljs">MakeSystemError(<span class="hljs-string"><span class="hljs-string">"GetTempFileName"</span></span>, GetLastError(), <span class="hljs-string"><span class="hljs-string">"..path.."</span></span><span class="hljs-string"><span class="hljs-string">":"</span></span><span class="hljs-string"><span class="hljs-string">"37"</span></span>);</code> </pre> <br>  This is exactly what the Visual C ++ compiler does.  All perfectly.  The analyzer will correctly process this code. <br><br>  If you explicitly use CL.exe in the settings of PVS-Studio, then false positives will disappear.  However, if Clang is launched, the analyzer will deal with incorrect code. <br><br>  Clang cannot master macros and at the output we have: <br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> MakeSystemError(<span class="hljs-string"><span class="hljs-string">"GetTempFileName"</span></span>, GetLastError(), <span class="hljs-string"><span class="hljs-string">"..path.."</span></span><span class="hljs-string"><span class="hljs-string">":"</span></span>__SLINE__(<span class="hljs-number"><span class="hljs-number">37</span></span>));</code> </pre> <br>  The macro __SLINE__ remained undiscovered. <br><br>  It turned out an incorrect construction, which is unacceptable from the point of view of the C ++ language.  Having encountered it, the PVS-Studio analyzer tries to somehow bypass the incorrect code in order to continue the analysis further.  It is better to miss something, than not to completely process the file.  Often, such omissions have no effect on the results of the analysis. <br><br>  But this time around the incorrect place painlessly failed.  The whole block was thrown: <br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!GetTempFileName(cachePath.c_str(), <span class="hljs-string"><span class="hljs-string">"tmp"</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, &amp;filePath.front())) <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> MakeSystemError(<span class="hljs-string"><span class="hljs-string">"...."</span></span>, GetLastError(), __SOURCE__); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::move(filePath);</code> </pre> <br>  So it happened ... The analyzer did everything it could. <br><br>  Since this fragment does not exist for the analyzer, the variables are not initialized, are not used in any way.  This leads to the issuance of a false positive. <br><br>  One solution to the problem is to always use a preprocessor from Visual C ++.  But there is a drawback - slow analysis. <br><br>  Therefore, in this case, we have chosen a different path.  Since the company from which we were approached, is thinking about acquiring PVS-Studio, we considered this particular case and made another backup in the code.  It is ugly, but practical.  We already have a lot of different special places that bypass some of the nuances found in the projects of our users.  This is a form of support. <br><br>  So, this time we were let down by the preprocessor implemented in Clang.  Interestingly, what will be the reason to write the following similar article on external errors. <br><br>  That's how we live.  Thanks for attention. <br><br>  <a href="http://www.viva64.com/ru/pvs-studio-download/">Try</a> our static code analyzer on your projects and, if something goes wrong, <a href="http://www.viva64.com/ru/about-feedback/">write to us</a> .  Often we turn a negative attitude into a positive one. </div><p>Source: <a href="https://habr.com/ru/post/249085/">https://habr.com/ru/post/249085/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../249073/index.html">Spring - Hibernate: One-to-Many Association</a></li>
<li><a href="../249075/index.html">Online service for tracking changes on sites</a></li>
<li><a href="../249077/index.html">To the attention of Masterhost / Mastermind customers!</a></li>
<li><a href="../249079/index.html">Microsoft News: R support, new Power BI for analytics and reports, animation and 3D graphics in the cloud</a></li>
<li><a href="../249083/index.html">How to protect Linux ‚Äì server from critical vulnerability Ghost. Update your OS!</a></li>
<li><a href="../249087/index.html">FutoIn AsyncSteps: the concept and implementation of asynchronous business logic</a></li>
<li><a href="../249089/index.html">Deep learning and Caffe on New Year's holidays</a></li>
<li><a href="../249091/index.html">An extension for the normal selection of text inside a link in browsers</a></li>
<li><a href="../249093/index.html">Open Data Day February 21 will be held around the world</a></li>
<li><a href="../249095/index.html">Data Center per billion or "Super Ring" for the "Wild West"</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>