<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Ask a question to Mail.Ru Group cloud service developers</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Thanks to Reddit, the Ask Me Anything (AMA) format is becoming popular - when a team of specialists responsible for some big, popular project invites ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Ask a question to Mail.Ru Group cloud service developers</h1><div class="post__text post__text-html js-mediator-article"><p><img src="https://habrastorage.org/web/f20/4f7/0a6/f204f70a6fc74f3db5e5ad02f677bc09.jpg"></p><br><p>  Thanks to Reddit, the Ask Me Anything (AMA) format is becoming popular - when a team of specialists responsible for some big, popular project invites everyone to ask them any questions about their work and what the service is under the hood like is arranged.  The first format AMA on Habr√© was <a href="https://habrahabr.ru/company/badoo/blog/317442/">used by the</a> developers of Badoo.  We also decided to try.  We hope that other companies will follow our example and begin to let readers into their internal cuisines. </p><br><p>  We decided to start AMA with the <a href="https://cloud.mail.ru/">Mail.Ru Cloud</a> team.  This is a young, actively developing project, about which we are always asked many questions.  In addition, since its launch (since August 2013), the Cloud has grown into a large family of projects. </p><br><p>  Historically, the Cloud began as a B2C product with web, desktop and mobile versions.  However, B2B is also a very promising market.  Therefore, we have a <a href="https://biz.mail.ru/">Mail.Ru</a> platform <a href="https://biz.mail.ru/">for business</a> , combining all the B2B services of Mail.Ru Group, including the Cloud for archives (Icebox), the Cloud for workgroups (Teambox), and Hot storage (Hotbox). </p><br><p>  Who and how exactly provides the livelihoods and prosperity of this fun family, how data integrity is achieved, due to which we achieve high download speeds and low latency - you will learn all this from the article, and then you can ask any questions you are interested in. </p><a name="habracut"></a><br><h2 id="dlya-nachala-nemnogo-istorii">  First, a little history </h2><br><p>  When we started writing Cloud, we took as a basis a single code base that was used in the Mail, in My World, and in content projects.  This code base we call Mpop.  It is a bunch of Perl libraries.  And several years ago, all Mail.Ru Group portal projects lived on it.  When in some of the projects something was refactored in Mpop, it affected the rest.  Gradually, each project moved to its version of Mpop, and then we started to leave it.  Mail, for example, partially switched to Go.  We also initially lived on Mpop, but quietly copied everything to our super-fast Perl server.  We have a fully asynchronous architecture, we use AnyEvent.  And if you know Perl, then come to us, we have a lot of fun and interesting! </p><br><h2 id="kak-vsyo-ustroeno">  How things are arranged </h2><br><p>  Structurally, Mail.Ru Cloud consists of several commands: </p><br><ul><li>  The team that writes the server part and builds its interaction with the repositories and mobile clients. </li><li>  API development team, a layer between servers and the web.  The API is used by both Icebox and Teambox. </li><li>  Hotbox development team.  It develops both the administrative interface for working with bakery and keys in the Hotbox, as well as the S3 API itself. </li><li>  Development team of UI (user interface) and layout.  Responsible for the beauty of the interface, its stability, speed and functionality. </li><li>  A desktop client development team that makes a cloud client for Windows, Linux, macOS platforms.  Also this team is working on a <a href="https://screenshoter.mail.ru/">Screenshot</a> and various features for it. </li><li>  Two mobile development teams that write client applications for iOS and Android that directly interact with the server side. </li><li>  A team of admins that supports all this, not closing eyes for days and nights. </li><li>  We also have a testing team and an autotesting team that writes autotests for the API. </li></ul><br><h2 id="pod-kapotom-veb--i-desktopnoy-versiy-oblaka">  Under the hood of the web and desktop versions of Clouds </h2><br><p>  The Mail.Ru Cloud backend is written in ANSI C, Perl, Lua and some C ++.  Perl solves API related tasks.  For example, editing documents.  By the way, we once told on Habr√© how we <a href="https://habrahabr.ru/company/mailru/blog/272769/">show video in the Cloud</a> , the server part there is written in Perl + Lua. </p><br><p> From the very beginning, when the task to create the Cloud was set, one of the main requirements was the absence of long searches on the database, no <code>seek</code> on the disk and storage on the principle of append only.  At the time of launch, we did not find a suitable database for tree data, so we created our own to represent the file system. </p><br><p>  Here are some numbers: </p><br><ul><li>  Our users download about 100 terabytes of data per day. </li><li>  We have over a thousand disk storage servers - more than 100 petabytes of data, they contain more than 9 billion files.  You need to optimally bypass and verify them and be sure that the user content is stored securely and unchanged. </li><li>  The number of monthly active users is over 18 million.  Every day many hundreds of thousands of unique users visit the web. </li><li>  We change an average of ten disks per week, we re-roll the data on them. </li><li>  The network capacity is up to 200 Gbit / s (if necessary, we can increase it several times).  The download to us now is about 25 Gbit / s. </li></ul><br><p>  <a href="https://habrahabr.ru/company/mailru/blog/211340/">Cloud was originally written</a> with a focus on desktop and mobile clients.  Then it became clear that the web is a zhzhot, you need to redo it.  The cloud was completely rewritten asynchronously (in general, our entire codebase is asynchronous, from ANSI C to AnyEvent in Perl), it has become much better and faster.  For example, now the web version of Cloud lives on the same dozen of servers as three years ago, despite the fact that the number of users has grown significantly.  Only then they lay in the shelf for resources without any stock.  Our other new products, for example Hotbox, we also write in Perl.  So it goes. </p><br><h2 id="pod-kapotom-mobilnogo-oblaka">  Under the hood of mobile Clouds </h2><br><p>  We continue to use Objective-C to write the iOS Cloud application.  Swift do not touch for several reasons: </p><br><ol><li>  We still support iOS 7. Yes, Swift is already supported on this version of the operating system, but working with Swift dependencies is very difficult. </li><li>  Swift is still unstable, and we don‚Äôt want to repeat the heroic feats of adapting new versions of the language, <a href="https://mozilla-mobile.github.io/ios/firefox/swift/core/2017/02/22/migrating-to-swift-3.0.html">well described</a> by the Firefox development team. </li><li>  Using Swift at the moment significantly increases the size of the application, and we are proud to weigh only about 20 MB. </li><li>  We actively use dynamic properties of the Objective-C language, and there are no analogues in Swift. </li></ol><br><p>  As examples of using Objective-C dynamism, we‚Äôll give the following: </p><br><ol><li>  Writing unit tests for memory leaks.  This is possible thanks to our <a href="https://github.com/pavelosipov/POSAllocationTracker">POSAllocationTracker</a> library.  The ability to use in unit tests favorably distinguishes it from the Facebook counterpart in the person of <a href="https://github.com/facebook/FBAllocationTracker">FBAllocationTracker</a> . </li><li>  Automatic detection of access to an object from the wrong stream.  Implemented in a POSRx <a href="https://github.com/pavelosipov/POSRx">POSSchedulableObject</a> .  By the way, in it you can look at the combat examples of unit tests for memory leaks. </li></ol><br><p>  Other architectural features of an iOS application: </p><br><ul><li>  Use <a href="https://github.com/pavelosipov/POSInputStreamLibrary">POSInputStreamLibrary</a> to upload video files to the Cloud.  The graph below shows two types of video downloads.  Orange pillars - downloads, the contents of which are obtained using the Photos.framework API.  Blue pillars - the content is obtained using ALAssetsLibrary and wrapped in a POSInputStreamLibrary.  This makes loading heavy video files extremely fast, as described in <a href="https://habrahabr.ru/company/mailru/blog/216247/">our long-time article</a> . </li></ul><br><p><img src="https://habrastorage.org/web/698/024/45b/69802445b2e741ac85edb24ac81fbc2f.png"></p><br><ul><li>  Using <a href="http://searchdisasterrecovery.techtarget.com/definition/disaster-recovery-DR-test">disaster recovery tests</a> .  The mechanism of random network error generation is built into our network library.  Thus, in the debug build, the application will necessarily arrive from the service of five hundred and four hundred.  Due to this, it is almost impossible not to test every new feature for these regional cases.  Implementation is available in visual form in the POSHTTPGateway object from the <a href="https://github.com/pavelosipov/POSRx">POSRx</a> library. </li></ul><br><p>  The main architectural task for an iOS application today is to get rid of application hangs when working with large clouds.  As a tool for solving this problem, we see the <a href="https://habrahabr.ru/company/mailru/blog/317440/">Schedulable Architecture</a> pattern, which we wrote about not so long ago on Habr√©.  In order to immediately see the results and be sure that we are moving in the right direction as it is implemented, we have done monitoring of the suspensions.  Now we already have a schedule of the most problematic places in the form of a list of classes in which hangs occur most often.  It looks like this: </p><br><p><img src="https://habrastorage.org/web/ffb/b94/a50/ffbb94a5001545d3bd575c41af455e7c.png"></p><br><p>  Thanks to the <a href="https://github.com/pavelosipov/POSHockeyAppExtension">plugin for HockeyApp</a> , we have complete information about each freeze - call stack and logs. </p><br><p>  The Android Cloud client is completely developed in Java (we have not yet found benefits for ourselves in Kotlin).  In principle, there is nothing supermode in the architecture: MVP, the entire network layer in the service, for the network we use okhttp, we store the data in SQLite, with the exception of the gallery.  There may be a lot of data, and they must be quickly picked up from the cache.  Therefore, we apply samopisny serialization for the gallery.  For communication within the application, there is an eventbus from green robot.  For effective work in the background on new versions of android we use JobScheduler'y, and for not very new - GcmNetworkManager. </p><br><p>  For rolling out features for percentages, A / B testing and some analytics, we use Firebase.  To debug the interaction with the server, we use it in the debug Stetho builds from Facebook.  The latest version almost switched to vector graphics in the app.  I think in a couple of versions we‚Äôll move on to it completely.  We write tests on junit, uiautomator and espresso. </p><br><h2 id="pod-kapotom-b2b-oblaka">  Under the hood of B2B-Clouds </h2><br><p>  B2B Cloud is three different products: </p><br><ul><li>  Teambox is a cloud for workgroups, an analogue of B2C-Cloud, in which you can allocate personal space for each account in the domain, create shared folders for departments and groups of employees and set up access to files. </li><li>  Hotbox is a fast-access repository for distributing media and any other frequently downloaded content with an S3-compatible access protocol, distributed storage with multiple copies and a guaranteed SLA of 99.99%. </li><li>  Icebox - object cloud storage for archiving and long-term storage of data and a simple web interface.  It is designed for storing and accessing rarely used data with S3 protocol support, which can be quickly accessed if necessary. </li></ul><br><p>  B2B-Cloud consists of two parts - the frontend, which we have built into our Platform for business, and the backend, which ensures the management of the Cloud and its operation.  The part of the backend that is responsible for the operation of the Cloud is written in Perl, the management support is written in Python. </p><br><p>  Business platform biz.mail.ru provides access to the management of all B2B-Clouds.  The platform itself is a general administrative panel for the Mail.Ru B2B services: Mail for the site, corporate Calendar, Agent, DNS service and B2B Cloud.  The platform provides a personal account of administrators and is implemented on the principle of plug-ins - there are common elements (authorization, project and domain management, user list), there are separate sections for connected services - Mail, Teambox, Hotbox, Icebox and others.  The Platform has its own API and a mechanism for proxying requests from the backend of the Platform to the backends of connected services.  Thus, we have a common infrastructure, the functionality of which is developed by different teams of programmers, and for users, all controls are collected in one administrative panel. </p><br><h2 id="itak-sprashivayte">  So ask! </h2><br><p>  By tradition, it is necessary to designate the time when we will answer questions.  And let it be two days, not one: today and tomorrow from 12.00 to 19.00 (Moscow time).  But in the case of particularly harsh discussions, we, of course, will not limit ourselves to this interval.  Ask questions about our software, about our servers, about our teams, about our API, and so on.  Let's go! </p></div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <p>Source: <a href="https://habr.com/ru/post/330348/">https://habr.com/ru/post/330348/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../330332/index.html">15 best recipes for Smart Home with ioBroker</a></li>
<li><a href="../330338/index.html">Energy Limit: New Data Center Cooling Technologies</a></li>
<li><a href="../330340/index.html">In 2017, a fivefold increase in DDoS attacks was recorded.</a></li>
<li><a href="../330342/index.html">Evolutionary strategies as a scalable alternative to reinforcement learning</a></li>
<li><a href="../330346/index.html">Monitoring Linksys SPA8000 via Zabbix</a></li>
<li><a href="../330350/index.html">Five steps to save the Linux server that crashed</a></li>
<li><a href="../330352/index.html">We provide the PVS-Studio analyzer to security experts</a></li>
<li><a href="../330354/index.html">Video: indie developers about failure, success and monetization</a></li>
<li><a href="../330356/index.html">Chromium based browsers - now also in ReactOS</a></li>
<li><a href="../330358/index.html">Rapid STP</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>