<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>JavaScript Web Workers: Secure Concurrency</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Web workers provide a programmer with a tool to execute JavaScript code outside the main thread, which is responsible for what happens in the browser....">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>JavaScript Web Workers: Secure Concurrency</h1><div class="post__text post__text-html js-mediator-article">  Web workers provide a programmer with a tool to execute JavaScript code outside the main thread, which is responsible for what happens in the browser.  This thread handles requests for data output to the screen, it supports user interaction, perceiving, in particular, keyboard presses and mouse clicks.  The same thread is responsible for supporting network interaction, for example, processing AJAX requests. <br><br>  Event handling and AJAX requests are asynchronous, it can be considered a way of executing some code outside the main thread, however, all the load on performing such operations still falls on the main thread, and, to ensure normal operation of the user interface, these operations need to be performed very fast.  Otherwise, the interactive elements of the pages will not work as well as expected. <br><br> <a href="https://habrahabr.ru/company/ruvds/blog/352828/"><img src="https://habrastorage.org/getpro/habr/post_images/5dd/b23/8e1/5ddb238e1fa619ef59f3789e9debe840.png" alt="image"></a> 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Web workers allow you to execute JavaScript code in a separate stream, which is completely independent of the main stream and what usually happens in it. <br><br>  Recently there has been a lot of talk about what practical problems can be solved with the help of web workers.  Given the computational power that even ordinary modern personal computers have, and the fact that mobile devices are approaching them in terms of performance and memory size, now in browser applications you can do a lot of things that used to be considered too complicated. <br><br>  In the material, the translation that we publish today, we will consider the features of using web workers for solving problems that are too heavy for the main thread.  In particular, the discussion here will focus on how to organize data exchange between the main stream and the web worker flow.  A couple of examples illustrating various scenarios for using web workers will be considered here. <br><a name="habracut"></a><br><h2>  <font color="#3AC1EF">Basics of working with web workers</font> </h2><br>  Often, application performance is analyzed in an isolated environment, on a developer's computer, and they are satisfied with what they do.  With this approach, for example, a minimum of additional programs are running on such a computer.  However, in real life is not so.  For example, a regular user can run many more applications with our program. <br><br>  As a result, applications that run normally in an isolated environment, without using separate threads created by web workers, may need such threads in order to look decent in real-world use cases. <br><br>  Starting a web worker is reduced to creating an appropriate object with passing it the path to a file with JavaScript code. <br><br><pre><code class="hljs cs"><span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Worker(<span class="hljs-string"><span class="hljs-string">'worker-script.js'</span></span>)</code> </pre> <br>  After creation, the worker works in a separate thread, independent of the main thread, executing any code that is transferred to it as a file.  The browser, when searching for the file specified when creating the web worker, uses a relative path whose root is the folder that contains the current HTML page. <br><br>  Data between the workers and the main stream is transmitted through two complementary mechanisms: <br><br><ul><li>  The <code>postMessage()</code> function is used by the transmitting side. <br></li><li>  The <code>message</code> event handler is applied on the receiving side. <br></li></ul><br>  The <code>message</code> event handler takes an event argument in the same way as other handlers.  This argument has a <code>data</code> property that contains the data passed to the receiving side. <br><br>  Using the above mechanisms, you can organize bidirectional information exchange.  The code in the main thread can use the <code>postMessage()</code> function to send messages to the worker.  A worker can send responses to the main thread using the <code>postMessage()</code> implementation, which is globally available in the worker's environment. <br><br>  Here is how a simple data exchange between the main stream and the web worker looks like.  This shows how the code on the HTML page sends a message to the worker and waits for a response: <br><br><pre> <code class="hljs coffeescript">var worker = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Worker(<span class="hljs-string"><span class="hljs-string">"demo1-hello-world.js"</span></span>); <span class="hljs-regexp"><span class="hljs-regexp">//</span></span>  ,    postMessage()  - worker.onmessage = <span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(evt)</span></span></span><span class="hljs-function"> =&gt;</span></span> {   <span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.log(<span class="hljs-string"><span class="hljs-string">"Message posted from webworker: "</span></span> + evt.data); } <span class="hljs-regexp"><span class="hljs-regexp">//</span></span>   - worker.postMessage({data: <span class="hljs-string"><span class="hljs-string">"123456789"</span></span>});</code> </pre> <br>  Here is the code of the web worker in which the processing of messages coming from the page and the mechanism for sending responses are organized: <br><br><pre> <code class="hljs coffeescript"><span class="hljs-regexp"><span class="hljs-regexp">//</span></span> demo1-hello-world.js postMessage(<span class="hljs-string"><span class="hljs-string">'Worker running'</span></span>); onmessage = <span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(evt)</span></span></span><span class="hljs-function"> =&gt;</span></span> {   postMessage(<span class="hljs-string"><span class="hljs-string">"Worker received data: "</span></span> + JSON.stringify(evt.data)); };</code> </pre> <br>  After executing this code, the following will be displayed in the console: <br><br><pre> <code class="hljs cs">Message posted <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> webworker: Worker running Message posted <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> webworker: Worker received data: {<span class="hljs-string"><span class="hljs-string">"data"</span></span>:<span class="hljs-string"><span class="hljs-string">"123456789"</span></span>}</code> </pre> <br>  When using web workers, it is expected that they will be performed for a long time, rather than used for short tasks, constantly starting and stopping.  During the life cycle of a worker, multiple messaging sessions with the main thread can take place.  Implementing web workers ensures safe, non-conflicting code execution through two mechanisms: <br><br><ul><li>  A dedicated, isolated global environment for the worker thread, separated from the browser environment. <br></li><li>  Transferring copies of data between the main thread and the worker thread when using the <code>postMessage()</code> function. <br></li></ul><br>  The flow of each worker has a dedicated, isolated global environment that is different from the JavaScript environment in which the code on the HTML page is running.  Workers do not have access to the mechanisms accessible from the page environment.  They do not have access to the DOM, they cannot work with <code>window</code> and <code>document</code> objects. <br><br>  The worker has its own versions of some mechanisms, like the <code>console</code> object for logging messages to the developer console, and the <code>XMLHttpRequest</code> object for performing AJAX requests.  However, in other matters, it is expected that the code executed by the worker is self-sufficient.  So, for example, the data from the worker's thread, which is planned to be used in the main thread, should be transferred as a <code>data</code> object via the <code>postMessage()</code> function. <br><br>  Moreover, the data passed by the <code>postMessage()</code> function is copied, that is, changes to this data made by the main thread will not affect the original data that is in the worker's thread.  This is an internal defense mechanism against conflicting parallel data changes that are transmitted between the main stream and the worker thread. <br><br><h2>  <font color="#3AC1EF">Options for using web workers</font> </h2><br>  A typical use case for a web worker is any task that can become complex in terms of the amount of computations that can be performed in the main thread.  This complexity is expressed either in the consumption of too much CPU resources, or in that this task may require an unpredictably large amount of time required, for example, to access data. <br><br>  Here are some of the possible uses for web workers: <br><br><ul><li>  Preload or cache data for later use. <br></li><li>  Downloading data from web services and processing this data. <br></li><li>  Processing and preparation for the output of large amounts of data (like some kind of scientific images). <br></li><li>  Calculations related to the handling of movements in games. <br></li><li>  Image processing and filtering. <br></li><li>  Processing text data (checking the syntax of program texts, checking spelling in plain text, counting the number of words). <br></li></ul><br>  In the simplest case, choosing a problem to solve with the help of a web worker, you should pay attention to the amount of computation needed to solve it.  However, it may be very important to record the time required, for example, to access network resources.  Very often, data exchange sessions via the Internet may take very little time, milliseconds, but sometimes network resources may be unavailable, data exchange may stop until the connection is restored or until the request timeout occurs (which can take 1-2 minutes). <br><br>  And even if it may not take too much time to execute a certain code when testing a program in an isolated development environment, executing the code in real conditions, when, in addition to it, many more tasks are performed on the user's computer, may become a problem. <br><br>  The following examples show a couple of practical uses for web workers. <br><br><h2>  <font color="#3AC1EF">Handling collisions in the game</font> </h2><br>  Nowadays, HTML5 games that are executed in browsers are quite common.  One of the central gaming mechanisms is the calculation of the movements and interactions of the objects of the game world.  In some games, the number of moving elements is relatively small, it is easy to animate them (for example, as in this version of <a href="http://supermarioemulator.com/mario.php">Super Mario</a> ).  However, let's assume that we have a game that requires more intensive calculations. <br><br>  In this example, many multicolored objects are presented (we will consider them balls or balls), which, being in a closed rectangular space, move, bouncing off its walls.  Our task is that the balls, firstly, do not leave this space, and secondly - that they bounce off each other.  That is, we need to handle their collisions with each other and with the boundaries of the playing field. <br><br>  Boundary collision handling is a relatively simple task, it doesn‚Äôt require serious calculations, but collision detection of objects with each other can require a lot of computational resources, since the complexity of such a task, if you don‚Äôt go into details, is proportional to the square of the number of objects.  Namely, for <code>n</code> balls, you need to check the position of each of them in comparison with all the others in order to understand if they do not intersect, and do not need them to change the direction of motion, realizing a rebound, which leads to the number of operations equal to n in the square . <br><br>  So, for 50 balls you need to make about 2500 comparisons.  For 100 balls - already 10,000 checks are required (in fact, this number is slightly less than half of the specified, because if a check for a collision of a ball <code>n</code> with a ball <code>m</code> , then it is no longer necessary to check the collision of a ball <code>m</code> with a ball <code>n</code> , however, in spite of this, a large amount of computations is required to solve such a problem). <br><br>  In this example, the execution of calculations to handle collisions of balls with each other and with the boundaries of the playing field is performed in a separate thread of the web worker.  This thread is accessed 60 times per second, which corresponds to the browser animation speed, or to each <code>requestAnimationFrame()</code> call.  Here we describe the <code>World</code> object, which contains a list of <code>Ball</code> objects.  Each <code>Ball</code> object stores information about its current position and speed (there is also information about the radius and color of the object, which allow you to display it on the screen). <br><br>  The output of the balls in their current position is performed in the main thread (which has access to the <code>Canvas</code> object and its drawing context).  Ball positions are updated in the web worker thread.  The speed (in particular, the direction of movement of the balls) changes if they collide with the boundaries of the playing field or with other balls. <br><br>  The <code>World</code> object is passed between the client code in the browser and the worker thread.  This is a relatively small object, even for a few hundred balls (for example, for 100 balls, given that you need about 64 bytes of data per one, the total volume will be about 6400 bytes).  As a result, the main problem here is not the transfer of data about game objects, but the computational load on the system. <br><br>  The full code for this example can be found <a href="https://codepen.io/bwilln/pen/VXYRay">here</a> .  There is, in particular, the <code>Ball</code> class, which is used to represent animated objects, and the <code>World</code> class, which implements the <code>move()</code> and <code>draw()</code> methods, which perform animation. <br><br>  If we performed the animation without using workers, the main code of this example would look like this: <br><br><pre> <code class="hljs lua">const canvas = $(<span class="hljs-string"><span class="hljs-string">'#democanvas'</span></span>).get(<span class="hljs-number"><span class="hljs-number">0</span></span>),   canvasBounds = {<span class="hljs-string"><span class="hljs-string">'left'</span></span>: <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-string"><span class="hljs-string">'right'</span></span>: canvas.width,       <span class="hljs-string"><span class="hljs-string">'top'</span></span>: <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-string"><span class="hljs-string">'bottom'</span></span>: canvas.height},   ctx = canvas.getContext(<span class="hljs-string"><span class="hljs-string">'2d'</span></span>); const numberOfBalls = <span class="hljs-number"><span class="hljs-number">150</span></span>,   ballRadius = <span class="hljs-number"><span class="hljs-number">15</span></span>,   maxVelocity = <span class="hljs-number"><span class="hljs-number">10</span></span>; //   World const world = new World(canvasBounds), <span class="hljs-string"><span class="hljs-string">'#FFFF00'</span></span>, <span class="hljs-string"><span class="hljs-string">'#FF00FF'</span></span>, <span class="hljs-string"><span class="hljs-string">'#00FFFF'</span></span>]; //   Ball   World <span class="hljs-keyword"><span class="hljs-keyword">for</span></span>(let i=<span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; numberOfBalls; i++) {   world.addObject(new Ball(ballRadius, colors[i % colors.length])           .setRandomLocation(canvasBounds)           .setRandomVelocity(maxVelocity)); } ... //   <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">animationStep</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> {   world.move();   world.draw(ctx);   requestAnimationFrame(animationStep); } animationStep();</code> </pre> <br>  It uses <code>requestAnimationFrame()</code> to call the <code>animationStep()</code> function 60 times per second, during the screen refresh period.  An animation step consists of calling the <code>move()</code> method, which updates the position of each ball (and, possibly, the direction of its movement), and from the call to the <code>draw()</code> method, which outputs, using the objects of the <code>canvas</code> object, balls in new positions. <br><br>  In order to use a worker's thread in this program, the calculations performed when calling the <code>move()</code> method, that is, the code from <code>World.move()</code> , must be moved to the worker.  The <code>World</code> object will be passed, in the form of a <code>data</code> object, to the worker's thread, using the <code>postMessage()</code> call, which will allow you to call the <code>move()</code> method here.  Obviously, you need to transfer between the main thread and the web worker at the <code>World</code> object, since it contains a list of <code>Ball</code> objects displayed on the screen and data about the rectangular area within which they should remain.  At the same time, <code>Ball</code> objects contain all information about the position, speed, and direction of movement of the respective balls. <br><br>  After making changes to the project designed to use a web worker, the animation loop will look like this: <br><br><pre> <code class="hljs coffeescript">let worker = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Worker(<span class="hljs-string"><span class="hljs-string">'collider-worker.js'</span></span>); <span class="hljs-regexp"><span class="hljs-regexp">//</span></span>   draw worker.addEventListener(<span class="hljs-string"><span class="hljs-string">"message"</span></span>, <span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(evt)</span></span></span><span class="hljs-function"> =&gt;</span></span> {   <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ( evt.data.message === <span class="hljs-string"><span class="hljs-string">"draw"</span></span>) {       world = evt.data.world;       world.draw(ctx);       requestAnimationFrame(animationStep);   } }); <span class="hljs-regexp"><span class="hljs-regexp">//</span></span>   function animationStep() {   worker.postMessage(world);  <span class="hljs-regexp"><span class="hljs-regexp">//</span></span> world.move() <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> worker } animationStep();</code> </pre> <br>  Here's what the worker code will look like: <br><br><pre> <code class="hljs lua">// collider-worker.js importScripts(<span class="hljs-string"><span class="hljs-string">"collider.js"</span></span>); this.addEventListener(<span class="hljs-string"><span class="hljs-string">"message"</span></span>, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(evt)</span></span></span></span> {   var world = evt.data;   world.move();   //     ,       this.postMessage({message: <span class="hljs-string"><span class="hljs-string">"draw"</span></span>, world: world}); });</code> </pre> <br>  The code presented here is based on the fact that the web worker's thread accepts the <code>World</code> object passed to it using <code>postMessage()</code> from the main thread, and then passes the same object back to the main thread, having previously calculated the new values ‚Äã‚Äãfor the position and speed of the game objects. of the world.  Remember that the browser makes a copy of this object when it is transmitted between threads.  Here we proceed from the assumption that the time required to create a copy of the <code>World</code> object is much less than O (n ** n), that is, the time required for collision detection (in fact, a relatively small amount of data is stored in the <code>World</code> object ). <br><br>  When launching a new code, however, we will encounter an unexpected error: <br><br><pre> <code class="hljs pgsql">Uncaught TypeError: world.<span class="hljs-keyword"><span class="hljs-keyword">move</span></span> <span class="hljs-keyword"><span class="hljs-keyword">is</span></span> <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> a <span class="hljs-keyword"><span class="hljs-keyword">function</span></span> at collider-worker.js:<span class="hljs-number"><span class="hljs-number">10</span></span></code> </pre> <br>  It turns out that in the process of copying an object when passing it using the <code>postMessage()</code> function, the data of the object's properties is copied, but not its prototype.  The methods of the <code>World</code> object are separated from the prototype when the object is copied and passed to the worker.  This is part of <a href="https://developer.mozilla.org/ru/docs/Web/API/Web_Workers_API/Structured_clone_algorithm">the structure cloning algorithm</a> , a standard way of copying objects when transferring them between the main thread and the web worker.  This process is also known as <a href="https://www.w3.org/TR/html5/infrastructure.html">serialization</a> . <br><br>  In order to get rid of the above error, we will add to the <code>World</code> class a method for creating its new instance (which will have a prototype with methods) and reassigning the properties of this object based on the data passed using <code>postMessage()</code> : <br><br><pre> <code class="hljs haskell"><span class="hljs-title"><span class="hljs-title">static</span></span> restoreFromData(<span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">data</span></span></span><span class="hljs-class">) {   //     ,          </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">let</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">world</span></span></span><span class="hljs-class"> = </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">new</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">World</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">data</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">bounds</span></span></span><span class="hljs-class">);   </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">world</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">displayList</span></span></span><span class="hljs-class"> = </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">data</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">displayList</span></span></span><span class="hljs-class">;   </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">return</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">world</span></span></span><span class="hljs-class">; }</span></span></code> </pre> <br>  Attempting to execute code after these changes results in another, similar error.  The fact is that the list of <code>Ball</code> objects that <code>World</code> stores also needs to be restored: <br><br><pre> <code class="hljs css"><span class="hljs-selector-tag"><span class="hljs-selector-tag">Uncaught</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">TypeError</span></span>: <span class="hljs-selector-tag"><span class="hljs-selector-tag">obj1</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.getRadius</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">is</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">not</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">a</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">function</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">at</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">World</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.checkForCollisions</span></span> (<span class="hljs-selector-tag"><span class="hljs-selector-tag">collider</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.js</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:60)</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">at</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">World</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.move</span></span> (<span class="hljs-selector-tag"><span class="hljs-selector-tag">collider</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.js</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:36)</span></span></code> </pre> <br>  The <code>World</code> class implementation needs to be expanded in order to restore each <code>Ball</code> object based on the data passed to <code>postMessage()</code> , just like the <code>World</code> class itself is being restored. <br><br>  Now the <code>World</code> class will look like this: <br><br><pre> <code class="hljs haskell"><span class="hljs-title"><span class="hljs-title">static</span></span> restoreFromData(<span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">data</span></span></span><span class="hljs-class">) {   //     ,          </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">let</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">world</span></span></span><span class="hljs-class"> = </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">new</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">World</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">data</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">bounds</span></span></span><span class="hljs-class">);   </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">world</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">animationStep</span></span></span><span class="hljs-class"> = </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">data</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">animationStep</span></span></span><span class="hljs-class">;   </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">world</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">displayList</span></span></span><span class="hljs-class"> = [];   </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">data</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">displayList</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">forEach</span></span></span><span class="hljs-class">((</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">obj</span></span></span><span class="hljs-class">) =&gt; {       //    </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Ball</span></span></span><span class="hljs-class">       </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">let</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ball</span></span></span><span class="hljs-class"> = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Ball</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">restoreFromData</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">obj</span></span></span><span class="hljs-class">);       </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">world</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">displayList</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">push</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ball</span></span></span><span class="hljs-class">);   });   return world; }</span></span></code> </pre> <br>  A similar <code>restoreFromData()</code> method is <code>restoreFromData()</code> implemented in the <code>Ball</code> class: <br><br><pre> <code class="hljs haskell"><span class="hljs-title"><span class="hljs-title">static</span></span> restoreFromData(<span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">data</span></span></span><span class="hljs-class">) {   //     ,          </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">const</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ball</span></span></span><span class="hljs-class"> = </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">new</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Ball</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">data</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">radius</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">data</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">color</span></span></span><span class="hljs-class">);   </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ball</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">position</span></span></span><span class="hljs-class"> = </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">data</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">position</span></span></span><span class="hljs-class">;   </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ball</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">velocity</span></span></span><span class="hljs-class"> = </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">data</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">velocity</span></span></span><span class="hljs-class">;   </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">return</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ball</span></span></span><span class="hljs-class">; }</span></span></code> </pre> <br>  Thanks to these changes, the animation is performed correctly, calculations are made for the movements of each of the possibly hundreds of balls in the worker's stream and output them in the browser in new positions at a speed of 60 times per second. <br><br>  This example of working with web worker threads demonstrates how to solve a problem that requires large computational resources, but not memory.  What if we face a task that requires a lot of memory? <br><br><h2>  <font color="#3AC1EF">Threshold image processing</font> </h2><br>  In this example, we consider an application that places a significant load on both the processor and memory.  It takes pixel data from an image represented as an HTML5 <code>canvas</code> object and transforms it, creating another image based on it. <br><br>  Here we use the <a href="https://www.html5rocks.com/en/tutorials/canvas/imagefilters/">image processing library</a> created in 2012 by Ilmari Heikinen.  The program will take a color image and convert it into a binary black and white image.  During the conversion, a gray threshold value will be used: pixels whose color values ‚Äã‚Äãin gray are less than this threshold will turn black, pixels with large values ‚Äã‚Äãwill turn white. <br><br>  The code for obtaining a new image is traversed over all color values ‚Äã‚Äã(represented in RGB format), and uses a formula to convert them to the appropriate shades of gray, after which it decides whether the final pixel will be black or white: <br><br><pre> <code class="hljs matlab">Filters.threshold = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(pixels, threshold)</span></span></span><span class="hljs-function"> {   </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">var</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">d</span></span></span><span class="hljs-function"> = </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">pixels</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">data</span></span></span><span class="hljs-function">;   </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">for</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(var i=0; i &lt; d.length; i+=4)</span></span></span><span class="hljs-function"> {       </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">var</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">r</span></span></span><span class="hljs-function"> = </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">d</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">[i]</span></span></span><span class="hljs-function">;       </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">var</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">g</span></span></span><span class="hljs-function"> = </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">d</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">[i+1]</span></span></span><span class="hljs-function">;       </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">var</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">b</span></span></span><span class="hljs-function"> = </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">d</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">[i+2]</span></span></span><span class="hljs-function">;       </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">var</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">v</span></span></span><span class="hljs-function"> = </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(0.2126*r + 0.7152*g + 0.0722*b &gt;= threshold)</span></span></span><span class="hljs-function"> ? 255 : 0;       </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">d</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">[i]</span></span></span><span class="hljs-function"> = </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">d</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">[i+1]</span></span></span><span class="hljs-function"> = </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">d</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">[i+2]</span></span></span><span class="hljs-function"> = </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">v</span></span></span><span class="hljs-function">   }   </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">return</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">pixels</span></span></span><span class="hljs-function">; };</span></span></code> </pre> <br>  Here is the original image. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/a33/228/003/a3322800371f82e36e80f116440bbe5c.jpg"></div><br>  <i><font color="#999999">Source image</font></i> <br><br>  Here is what happens after processing. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/73c/a2b/cf0/73ca2bcf048038c210fb9799a3f3c9f8.png"></div><br>  <i><font color="#999999">Processed image</font></i> <br><br>  An example code can be found <a href="https://codepen.io/bwilln/pen/RMKwMX">here</a> . <br><br>  Even when working with small images, the amount of data that needs to be processed, as well as the computational processing costs, can be significant.  For example, in an image of 640x480 pixels there are 307200 pixels, each of which corresponds to 4 bytes of RGBA data (A is the alpha channel that sets the color transparency).  As a result, the size of this image is approximately 1.2 MB.  Our plan is to use a web worker to iterate over pixel data and convert their color values.  The pixel data for the image will be transferred from the main stream to the web worker, and the modified image will be returned from the worker to the main stream.  It would be nice if it were not necessary to copy this data every time they cross the border between the main stream and the worker stream. <br><br>  The <code>postMessage()</code> function can be used by setting one or more properties that describe the data that is passed in the message by reference.  That is, not copies of the data are transferred, but links to them.  It looks like this: <br><br><pre> <code class="hljs xml"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">style</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"margin: 50px 100px"</span></span></span><span class="hljs-tag">&gt;</span></span>   <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">img</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">id</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"original"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">src</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"images/flmansion.jpg"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">width</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"500"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">height</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"375"</span></span></span><span class="hljs-tag">&gt;</span></span>   <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">canvas</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">id</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"output"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">width</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"500"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">height</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"375"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">style</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"border: 1px solid;"</span></span></span><span class="hljs-tag">&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">canvas</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag">&gt;</span></span> ... <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">type</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"text/javascript"</span></span></span><span class="hljs-tag">&gt;</span></span><span class="javascript"><span class="javascript"> </span><span class="hljs-keyword"><span class="javascript"><span class="hljs-keyword">const</span></span></span><span class="javascript"> image = </span><span class="hljs-built_in"><span class="javascript"><span class="hljs-built_in">document</span></span></span><span class="javascript">.getElementById(</span><span class="hljs-string"><span class="javascript"><span class="hljs-string">'original'</span></span></span><span class="javascript">); ... </span><span class="hljs-comment"><span class="javascript"><span class="hljs-comment">//    HTML5 canvas     const tempCanvas = document.createElement('canvas'),   tempCtx = tempCanvas.getContext('2d'); tempCanvas.width = image.width; tempCanvas.height = image.height; tempCtx.drawImage(image, 0, 0, image.width, image.height); const imageDataObj = tempCtx.getImageData(0, 0, image.width, image.height); ... worker.addEventListener('message', (evt) =&gt; {   console.log("Received data back from worker");   const results = evt.data;   ctx.putImageData(results.newImageObj, 0, 0); }); worker.postMessage(imageDataObj, [imageDataObj.data.buffer]); </span></span></span></span><span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre> <br>  Here you can use any object that implements the <code>Transferable</code> interface.  The design of the <code>data.buffer</code> object meets this requirement - it is of type <code>Uint8ClampedArray</code> (arrays of this type are designed to store 8-bit image data).  <code>ImageData</code> is what the <code>getImageData()</code> method returns for the HTML5 <code>canvas</code> object <code>context</code> . <br><br>  The <code>Transferable</code> interface implements several standard data types: <code>ArrayBuffer</code> , <code>MessagePort</code> , and <code>ImageBitmap</code> .  <code>ArrayBuffer</code> , in turn, is represented by a number of array types: <code>Int8Array</code> , <code>Uint8Array</code> , <code>Uint8ClampedArray</code> , <code>Int16Array</code> , <code>Uint16Array</code> , <code>Int32Array</code> , <code>Uint32Array</code> , <code>Float32Array</code> , <code>Float64Array</code> . <br><br>  As a result, if data is now transferred between streams by reference, and not by value, can this data be modified from two streams simultaneously?    .      <code>postMessage()</code> ,        (    ¬´neutered¬ª).        <code>postMessage()</code>      -,         .     JS-. <br><br><h2>  <font color="#3AC1EF">Results</font> </h2><br> - HTML5          ,        ,      . <br><br>     ,   -: <br><br><ul><li>       <code>postMessage()</code>    <code>message</code> . <br></li><li> ,           HTML5-. <br></li><li> ,     ,     ,    ,           <code>postMessage()</code> . <br></li></ul><br>             -: <br><br><ul><li>  ,     JavaScript-    <code>postMessage()</code> ,      .      ,    . <br></li><li>     ,     <code>getImageData()</code> ,  <code>buffer</code>            <code>postMessage()</code> (   <code>imageData.data.buffer</code> ,   <code>imageData.data</code> ).     <code>Transferable</code>      . <br></li></ul><br> -       .  ,  Chrome, Safari  FireFox     2009 . -    MS Edge,    Internet Explorer   IE10. <br><br>       -,               <code>if (typeof Worker !== "undefined")</code> .  ,  -    , ,   ,     ,      (       -    <code>requestAnimationFrame()</code> ). <br><br>  <b>Dear readers!</b>    -? <br><br> <a href="https://ruvds.com/ru-rub/"><img src="https://habrastorage.org/files/1ba/550/d25/1ba550d25e8846ce8805de564da6aa63.png"></a> </div><p>Source: <a href="https://habr.com/ru/post/352828/">https://habr.com/ru/post/352828/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../352814/index.html">Tutorial: toon-contours in Unreal Engine 4</a></li>
<li><a href="../352820/index.html">Avito at GopherCon Russia 2018</a></li>
<li><a href="../352822/index.html">How to expand the functionality of Zabbix and not pay for licenses</a></li>
<li><a href="../352824/index.html">Data Center for Technopark: from ‚ÄúConcrete‚Äù to Tier Facility Certification</a></li>
<li><a href="../352826/index.html">We are preparing a project in Sparx Enterprise Architect. Our recipe</a></li>
<li><a href="../352830/index.html">Flask Mega-Tutorial, Part XVIII: Deploying to Heroku</a></li>
<li><a href="../352832/index.html">19 years in the same language. The story of how the Olympiad from Belarus became C ++ Chief Software Architect</a></li>
<li><a href="../352834/index.html">We are programmers</a></li>
<li><a href="../352836/index.html">Why the interface should be accessible to everyone and how to do it</a></li>
<li><a href="../352838/index.html">Your first mobile app: choose a platform</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>