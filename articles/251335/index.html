<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Interactive map of the shopping center on HTML5 canvas</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Introduction 
 The customer was assigned the next task - to show statistics on store attendance, use of escalators, elevators and corridors on the map...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Interactive map of the shopping center on HTML5 canvas</h1><div class="post__text post__text-html js-mediator-article"><h4>  Introduction </h4><br>  The customer was assigned the next task - to show statistics on store attendance, use of escalators, elevators and corridors on the maps of shopping centers.  The map needs to be able to mark up - indicate the points, where to show the statistics and what specific statistics.  And, of course, show these statistics for the selected time period and filters.  Where the data is taken from and where it is stored is a separate large topic, outside the brackets of this article. <br><br>  If you spit, you say, we take the vector map of the shopping center in svg and supplement it with data.  Beautiful, modern, fast.  There are even ready-made solutions like jVectorMap. <br><br>  Only here there are no vector maps of the necessary shopping centers, there are only those pictures provided by the owners of the centers.  Absolutely different in style and content.  And a large number of centers (about 300) do not allow to redraw them into vectors quickly and cheaply.  And the addition of new shopping centers will require additional work. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Therefore, it was decided to use HTML5 canvas both for marking the map and for displaying data. <br><br><h4>  Choosing a framework </h4><br>  Working directly with the canvas API is not very convenient, but there are a lot of tools to facilitate the work.  Requirements for the framework in our case: <br><ol><li>  Object model over canvas API. </li><li>  The ability to draw and scale the image. </li><li>  Interactivity: <br><ul><li>  the possibility of manipulating objects at the stage of map layout, </li><li>  ability to scale and move around the map. </li></ul></li><li>  The ability to export / import tagged objects. </li><li>  The presence of detailed events. </li><li>  High rendering speed. </li></ol><br>  <a href="http://fabricjs.com/">Fabric.js</a> , <a href="http://www.createjs.com/EaselJS">EaselJS</a> , <a href="http://raphaeljs.com/">Rapha√´l</a> , <a href="http://paperjs.org/">Paper.js</a> and <a href="http://processingjs.org/">Processing.js</a> came under consideration. <br>  Fabric.js meets all requirements.  Given the current experience with him, it was decided to take it as a basis.  Later in the examples version 1.4.4 was used. <br><br><a name="habracut"></a><br><br><h4>  Canvas and drawing a map </h4><br>  Take the card: <br><img src="https://habrastorage.org/getpro/habr/post_images/684/09d/da4/68409dda4b502e221afa0a6b9e332d8f.png" alt="image"><br><br>  In the markup of the page we will create a plain canvas: <br><pre><code class="html hljs xml"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">canvas</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">id</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"canvas"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">width</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"1000px"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">height</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"400px"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">style</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"border: 1px solid black"</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre> <br>  Let's make a fabric.js canvas out of it, setting the necessary parameters at the same time: <br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> element = $(<span class="hljs-string"><span class="hljs-string">'#canvas'</span></span>), <span class="hljs-comment"><span class="hljs-comment">//      canvas = new fabric.Canvas(element.get(0), { selection: false, //     scale: 1, //     renderOnAddRemove: false, //  -,        moveCursor: 'default', //  ,    hoverCursor: 'default' });</span></span></code> </pre><br><br><h4>  Scaling and moving around the map </h4><br>  The size of the maps can be anything, so it is necessary to give the user the opportunity to scale and move freely around it using the mouse.  In essence, such manipulations are a transformation of all objects on the map, that is, a change in size and position. <br>  Therefore, we have to keep the initial and current state: <br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> baseWidth = <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-comment"><span class="hljs-comment">//   baseHeight= 0, //   baseScale = 1, //   width = 0, //   height = 0, //   transX = 0, //     x transY = 0, //     y scale = 1; //    </span></span></code> </pre><br>  Apply the transformation of objects on the canvas will be as follows: <br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> applyTransform = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> maxTransX, maxTransY, minTransX, minTransY, group; <span class="hljs-comment"><span class="hljs-comment">//        x if (baseWidth * scale &lt;= width) { //      maxTransX = (width - baseWidth * scale) / (2 * scale); minTransX = (width - baseWidth * scale) / (2 * scale); } else { //   maxTransX = 0; minTransX = (width - baseWidth * scale) / scale; } //     if (transX &gt; maxTransX) { transX = maxTransX; } else if (transX &lt; minTransX) { transX = minTransX; } //      y if (baseHeight * scale &lt;= height) { maxTransY = (height - baseHeight * scale) / (2 * scale); minTransY = (height - baseHeight * scale) / (2 * scale); } else { maxTransY = 0; minTransY = (height - baseHeight * scale) / scale; } if (transY &gt; maxTransY) { transY = maxTransY; } else if (transY &lt; minTransY) { transY = minTransY; } //         group = new fabric.Group(canvas.getObjects()); group.scaleX = scale / canvas.scale; group.scaleY = scale / canvas.scale; group.left = group.getWidth() / 2 + transX * scale; group.top = group.getHeight() / 2 + transY * scale; group.destroy(); //      canvas.scale = scale; //      canvas.renderAll(); };</span></span></code> </pre><br>  Separate function will set the scale: <br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> setScale = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">scaleToSet, anchorX, anchorY</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> zoomMax = <span class="hljs-number"><span class="hljs-number">5</span></span>, <span class="hljs-comment"><span class="hljs-comment">//  5-   zoomMin = 1, //   -    zoomStep; //    //  ,   if (scaleToSet &gt; zoomMax * baseScale) { scaleToSet = zoomMax * baseScale; } else if (scaleToSet &lt; zoomMin * baseScale) { scaleToSet = zoomMin * baseScale; } //   - ,     . //   anchorX  anchorY. //        . if (typeof anchorX != 'undefined' &amp;&amp; typeof anchorY != 'undefined') { zoomStep = scaleToSet / scale; // ,      , //      . transX -= (zoomStep - 1) / scaleToSet * anchorX; transY -= (zoomStep - 1) / scaleToSet * anchorY; } scale = scaleToSet; applyTransform(); };</span></span></code> </pre><br>  It now remains to subscribe to mouse events: <br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> bindContainerEvents= <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> mouseDown = <span class="hljs-literal"><span class="hljs-literal">false</span></span>, oldPageX, oldPageY, container = $(canvas.wrapperEl); container.mousemove(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">e</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-comment"><span class="hljs-comment">//   if (mouseDown) { //      transX -= (oldPageX - e.pageX) / scale; transY -= (oldPageY - e.pageY) / scale; applyTransform(); oldPageX = e.pageX; oldPageY = e.pageY; return false; } }).mousedown(function (e) { //        mouseDown = true; oldPageX = e.pageX; oldPageY = e.pageY; return false; }); $('body').mouseup(function () { mouseDown = false; }); //    container.mousewheel(function (event, delta, deltaX, deltaY) { var offset = element.offset(), //     centerX = event.pageX - offset.left, //  x   centerY = event.pageY - offset.top, //  y   zoomStep = Math.pow(1.3, deltaY); //  ,   . setScale(scale * zoomStep, centerX, centerY); //    event.preventDefault(); }); };</span></span></code> </pre><br>  Here we used <a href="http://plugins.jquery.com/mousewheel/">jQuery Mousewheel</a> to handle the scrolling of the mouse wheel. <br>  In addition, for users of touch devices, we will do separate event handling.  Then the usual patterns of touching "move" (one-finger touch), "increase" and "reduce" (two-finger touch) will please the owners of such devices. <br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> bindContainerTouchEvents = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> touchStartScale, touchStartDistance, container = $(canvas.wrapperEl), touchX, touchY, centerTouchX, centerTouchY, lastTouchesLength, handleTouchEvent = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">e</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> touches = e.originalEvent.touches, offset, currentScale, transXOld, transYOld; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (e.type == <span class="hljs-string"><span class="hljs-string">'touchstart'</span></span>) { lastTouchesLength = <span class="hljs-number"><span class="hljs-number">0</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (touches.length == <span class="hljs-number"><span class="hljs-number">1</span></span>) { <span class="hljs-comment"><span class="hljs-comment">//   if (lastTouchesLength == 1) { transXOld = transX; transYOld = transY; transX -= (touchX - touches[0].pageX) / scale; transY -= (touchY - touches[0].pageY) / scale; applyTransform(); if (transXOld != transX || transYOld != transY) { e.preventDefault(); } } touchX = touches[0].pageX; touchY = touches[0].pageY; } else if (touches.length == 2) { //  if (lastTouchesLength == 2) { currentScale = Math.sqrt( Math.pow(touches[0].pageX - touches[1].pageX, 2) + Math.pow(touches[0].pageY - touches[1].pageY, 2) ) / touchStartDistance; setScale(touchStartScale * currentScale, centerTouchX, centerTouchY); e.preventDefault(); } else { //   ,   offset = element.offset(); if (touches[0].pageX &gt; touches[1].pageX) { centerTouchX = touches[1].pageX + (touches[0].pageX - touches[1].pageX) / 2; } else { centerTouchX = touches[0].pageX + (touches[1].pageX - touches[0].pageX) / 2; } if (touches[0].pageY &gt; touches[1].pageY) { centerTouchY = touches[1].pageY + (touches[0].pageY - touches[1].pageY) / 2; } else { centerTouchY = touches[0].pageY + (touches[1].pageY - touches[0].pageY) / 2; } centerTouchX -= offset.left; centerTouchY -= offset.top; touchStartScale = scale; touchStartDistance = Math.sqrt( Math.pow(touches[0].pageX - touches[1].pageX, 2) + Math.pow(touches[0].pageY - touches[1].pageY, 2) ); } } lastTouchesLength = touches.length; }; container.bind('touchstart', handleTouchEvent); container.bind('touchmove', handleTouchEvent); };</span></span></code> </pre><br>  The magic of transformations and event handling is taken from the <a href="https://www.drupal.org/project/jvector">jVector</a> . <br><br>  Finally, load the map and draw it: <br><pre> <code class="javascript hljs">fabric.util.loadImage(<span class="hljs-string"><span class="hljs-string">'Map.png'</span></span>, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">img</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> map = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> fabric.Image(img), curBaseScale; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ((<span class="hljs-string"><span class="hljs-string">'ontouchstart'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> <span class="hljs-built_in"><span class="hljs-built_in">window</span></span>) || (<span class="hljs-built_in"><span class="hljs-built_in">window</span></span>.DocumentTouch &amp;&amp; <span class="hljs-built_in"><span class="hljs-built_in">document</span></span> <span class="hljs-keyword"><span class="hljs-keyword">instanceof</span></span> DocumentTouch)) { bindContainerTouchEvents(); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { bindContainerEvents(); } <span class="hljs-comment"><span class="hljs-comment">//      baseWidth = map.width; baseHeight = map.height; width = element.width(); height = element.height(); //            map.set({ hasRotatingPoint: false, hasBorders: false, hasControls: false, lockScalingY: true, lockScalingX: true, selectable: false, left: map.width / 2, top: map.height / 2, originX: 'center', originY: 'center' }); canvas.add(map); // ,      curBaseScale = baseScale; if (width / height &gt; baseWidth / baseHeight) { baseScale = height / baseHeight; } else { baseScale = width / baseWidth; } scale *= baseScale / curBaseScale; transX *= baseScale / curBaseScale; transY *= baseScale / curBaseScale; canvas.setWidth(width); canvas.setHeight(height); applyTransform(); //   ,   createMarkers(); });</span></span></code> </pre><br><br><h4>  Tags on the map </h4><br>  We have already received an easy-to-use map, it remains to learn how to put labels on it and then show them with the necessary data. <br>  It is best to use vector objects, then at any map magnification they will look great. <br>  In addition to the label, we‚Äôll also add text showing statistics of visits to this map point.  The text will be readable on any map if it is wrapped in a rectangle with a solid fill.  For the correct positioning of the text and the wrapper relative to each other, set originX and originY to 'center'. <br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> markerColor = <span class="hljs-string"><span class="hljs-string">'#2567d5'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> addMarker = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">point, text</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-comment"><span class="hljs-comment">//   var marker = new fabric.Path('m 11,-19.124715 c -8.2234742,0 -14.8981027,-6.676138 -14.8981027,-14.9016 0,-5.633585 3.35732837,-10.582599 6.3104192,-14.933175 C 4.5507896,-52.109948 9.1631953,-59.34619 11,-61.92345 c 1.733396,2.518329 6.760904,9.975806 8.874266,13.22971 3.050966,4.697513 6.023837,8.647788 6.023837,14.667425 0,8.225462 -6.674629,14.9016 -14.898103,14.9016 zm 0,-9.996913 c 2.703016,0 4.903568,-2.201022 4.903568,-4.904687 0,-2.703664 -2.200552,-4.873493 -4.903568,-4.873493 -2.7030165,0 -4.903568,2.169829 -4.903568,4.873493 0,2.703665 2.2005515,4.904687 4.903568,4.904687 z"', { width: 40, height: 80, scaleX: scale, scaleY: scale, left: point.x, top: point.y, originX: 'center', originY: 'center', fill: markerColor, stroke: '#2e69b6', text: text //      / }), //  textObject = new fabric.Text(text, { fontSize: 30, originX: 'center', fill: markerColor, originY: 'center' }), //    background = new fabric.Rect({ width: 100, height: 40, originX: 'center', originY: 'center', fill: 'white', stroke: 'black' }), //      textGroup = new fabric.Group([background, textObject], { scaleX: scale, scaleY: scale, left: point.x + 20 * scale, //    top: point.y - 30 * scale //    }); canvas.add(marker); canvas.add(textGroup); };</span></span></code> </pre><br>  Now it‚Äôs easy to map a couple of tags: <br><pre> <code class="javascript hljs"> addMarker({<span class="hljs-attr"><span class="hljs-attr">x</span></span>: <span class="hljs-number"><span class="hljs-number">550</span></span>, <span class="hljs-attr"><span class="hljs-attr">y</span></span>: <span class="hljs-number"><span class="hljs-number">390</span></span>}, <span class="hljs-string"><span class="hljs-string">'#0:500'</span></span>); addMarker({<span class="hljs-attr"><span class="hljs-attr">x</span></span>: <span class="hljs-number"><span class="hljs-number">460</span></span>, <span class="hljs-attr"><span class="hljs-attr">y</span></span>: <span class="hljs-number"><span class="hljs-number">120</span></span>}, <span class="hljs-string"><span class="hljs-string">'#1:300'</span></span>); canvas.renderAll();</code> </pre><br>  The result will be as follows: <br><img src="//habrastorage.org/files/d0d/468/398/d0d468398e8447f3934c7b15181dbe57.png"><br><br><h5>  Editing </h5><br>  Introduce editing mode - when clicking on the map we will create a new label.  For an example, the simple checkbox and the flag are enough for us: <br><pre> <code class="html hljs xml"> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag">&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">input</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">type</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"checkbox"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">onclick</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"window.isEditing = this.checked"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">id</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"editing"</span></span></span><span class="hljs-tag">/&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">label</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">for</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"editing"</span></span></span><span class="hljs-tag">&gt;</span></span>Editing<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">label</span></span></span><span class="hljs-tag">&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre><br>  Now you can write the createMarkers function: <br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> createMarkers = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> markersCount = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-comment"><span class="hljs-comment">//    window.isEditing = false; //    canvas.on('mouse:down', function (options) { var position; if (!window.isEditing) { return; } //      position = canvas.getPointer(options.e); //  -     addMarker(position, '#' + markersCount++ + ':' + Math.round(Math.random() * 1000)); //    canvas.renderAll(); }); };</span></span></code> </pre><br>  With this feature, you can turn the card into a mash from tags or a work of art: <br><img src="//habrastorage.org/files/f14/6f4/414/f146f4414b414f2399a988f2c4296635.png"><br><br>  Naturally, you can add the ability to select the color and type of label, related information and so on.  For example, the label may be an escalator icon: <br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> circle = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> fabric.Circle({ <span class="hljs-attr"><span class="hljs-attr">radius</span></span>: <span class="hljs-number"><span class="hljs-number">22.5</span></span> }), path1 = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> fabric.Path(<span class="hljs-string"><span class="hljs-string">'M31,31h-2L15,17H9c-1.1027832,0-2,0.8971558-2,2c0,1.1027832,0.8972168,2,2,2h2l14,14h6c1.1027832,0,2-0.8972168,2-2C33,31.8971558,32.1027832,31,31,31z'</span></span>, { <span class="hljs-attr"><span class="hljs-attr">originX</span></span>: <span class="hljs-string"><span class="hljs-string">'center'</span></span>, <span class="hljs-attr"><span class="hljs-attr">originY</span></span>: <span class="hljs-string"><span class="hljs-string">'center'</span></span>, <span class="hljs-attr"><span class="hljs-attr">fill</span></span>: markerColor }), path2 = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> fabric.Path(<span class="hljs-string"><span class="hljs-string">'M22.5,2C11.1782227,2,2,11.1781616,2,22.5S11.1782227,43,22.5,43S43,33.8218384,43,22.5S33.8217773,2,22.5,2z M26.5,7C27.8806152,7,29,8.1192627,29,9.5c0,1.3806763-1.1193848,2.5-2.5,2.5c-1.3807373,0-2.5-1.1193237-2.5-2.5C24,8.1192627,25.1192627,7,26.5,7z M26.5,13.0023804c1.380249-0.0330811,2.5,0.2385864,2.5,3s0,8,0,8l-6-7C23,17.0023804,25.0908203,13.0361938,26.5,13.0023804z M31,38h-7L10,24H9c-2.7614746,0-5-2.2385864-5-5s2.2385254-5,5-5h7l14,14h1c2.7613525,0,5,2.2385864,5,5S33.7613525,38,31,38z'</span></span>, { <span class="hljs-attr"><span class="hljs-attr">originX</span></span>: <span class="hljs-string"><span class="hljs-string">'center'</span></span>, <span class="hljs-attr"><span class="hljs-attr">originY</span></span>: <span class="hljs-string"><span class="hljs-string">'center'</span></span>, <span class="hljs-attr"><span class="hljs-attr">fill</span></span>: markerColor }), marker = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> fabric.Group([circle, path1, path2], { <span class="hljs-attr"><span class="hljs-attr">width</span></span>: <span class="hljs-number"><span class="hljs-number">40</span></span>, <span class="hljs-attr"><span class="hljs-attr">height</span></span>: <span class="hljs-number"><span class="hljs-number">80</span></span>, <span class="hljs-attr"><span class="hljs-attr">scaleX</span></span>: scale, <span class="hljs-attr"><span class="hljs-attr">scaleY</span></span>: scale, <span class="hljs-attr"><span class="hljs-attr">left</span></span>: point.x, <span class="hljs-attr"><span class="hljs-attr">top</span></span>: point.y, <span class="hljs-attr"><span class="hljs-attr">originX</span></span>: <span class="hljs-string"><span class="hljs-string">'center'</span></span>, <span class="hljs-attr"><span class="hljs-attr">originY</span></span>: <span class="hljs-string"><span class="hljs-string">'center'</span></span>, <span class="hljs-attr"><span class="hljs-attr">fill</span></span>: markerColor, });</code> </pre><br><img src="//habrastorage.org/files/239/cfb/6fc/239cfb6fcf9c4d36a65a47f4cc36d1bb.png"><br><br>  In addition, fabric.js allows you to edit objects - move, resize, rotate, etc.  So the user gets ample opportunities to create readable and easy to analyze images. <br><br><h5>  Zones </h5><br>  In our case, the customer also wanted to be able to select zones on the map and show statistics on these zones.  We decided to use as a zone a standard transparent polygon with an arbitrary number of points marked by the user with mouse clicks.  Such a polygon is always closed and easily mapped.  We will end the zone with a double click.  And to remove the last added point by pressing the backspace or delete buttons - in case of an error. <br>  Then the zone marking can be done as follows. <br><pre> <code class="hljs pgsql">canvas.<span class="hljs-keyword"><span class="hljs-keyword">on</span></span>(<span class="hljs-string"><span class="hljs-string">'mouse:down'</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">function</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">options</span></span>) { addExtendZone(<span class="hljs-keyword"><span class="hljs-keyword">options</span></span>.e); }).<span class="hljs-keyword"><span class="hljs-keyword">on</span></span>(<span class="hljs-string"><span class="hljs-string">'mouse:move'</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">function</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">options</span></span>) { drawZone(<span class="hljs-keyword"><span class="hljs-keyword">options</span></span>.e); }); $(document).<span class="hljs-keyword"><span class="hljs-keyword">on</span></span>(<span class="hljs-string"><span class="hljs-string">'dblclick'</span></span>, finishZone).<span class="hljs-keyword"><span class="hljs-keyword">on</span></span>(<span class="hljs-string"><span class="hljs-string">'keydown'</span></span>, undoZonePoint); //     ,    var convertPointToRelative = <span class="hljs-keyword"><span class="hljs-keyword">function</span></span>(<span class="hljs-type"><span class="hljs-type">point</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">object</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> { x: (<span class="hljs-type"><span class="hljs-type">point</span></span>.x - <span class="hljs-keyword"><span class="hljs-keyword">object</span></span>.left) / scale, y: (<span class="hljs-type"><span class="hljs-type">point</span></span>.y - <span class="hljs-keyword"><span class="hljs-keyword">object</span></span>.top) / scale }; }; var addExtendZone = <span class="hljs-keyword"><span class="hljs-keyword">function</span></span>(mouseEvent) { var position = canvas.getPointer(mouseEvent); //      <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (currentEditingZone) { currentEditingZone.points.push(convertPointToRelative(position, currentEditingZone)); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>; } //   -   <span class="hljs-number"><span class="hljs-number">3</span></span> ,      currentEditingZone = <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> fabric.Polygon( [{ x: <span class="hljs-number"><span class="hljs-number">0</span></span>, y: <span class="hljs-number"><span class="hljs-number">0</span></span> }, { x: <span class="hljs-number"><span class="hljs-number">1</span></span>, y: <span class="hljs-number"><span class="hljs-number">1</span></span> }, { x: <span class="hljs-number"><span class="hljs-number">-1</span></span>, y: <span class="hljs-number"><span class="hljs-number">-1</span></span> }], { scaleX: scale, scaleY: scale, left: position.x, top: position.y, fill: <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> fabric.Color(markerColor).setAlpha(<span class="hljs-number"><span class="hljs-number">0.3</span></span>).toRgba(), stroke: <span class="hljs-string"><span class="hljs-string">'#2e69b6'</span></span>, }); canvas.<span class="hljs-keyword"><span class="hljs-keyword">add</span></span>(currentEditingZone); canvas.renderAll(); }; var drawZone = <span class="hljs-keyword"><span class="hljs-keyword">function</span></span>(mouseEvent) { var points; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (currentEditingZone) { //       ,    points = currentEditingZone.points; points[points.length - <span class="hljs-number"><span class="hljs-number">1</span></span>] = convertPointToRelative(canvas.getPointer(mouseEvent), currentEditingZone); canvas.renderAll(); } }; var finishZone = <span class="hljs-keyword"><span class="hljs-keyword">function</span></span> () { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!currentEditingZone) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>; } //   ,     currentEditingZone.points.pop(); currentEditingZone = <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>; }; var undoZonePoint = <span class="hljs-keyword"><span class="hljs-keyword">function</span></span>(event) { //  backspace  <span class="hljs-keyword"><span class="hljs-keyword">delete</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (currentEditingZone &amp;&amp; (event.which == <span class="hljs-number"><span class="hljs-number">8</span></span> || event.which == <span class="hljs-number"><span class="hljs-number">46</span></span>)) { var points = currentEditingZone.points, isDeleted = points.length &lt;= <span class="hljs-number"><span class="hljs-number">3</span></span>; points[points.length - <span class="hljs-number"><span class="hljs-number">2</span></span>] = points[points.length - <span class="hljs-number"><span class="hljs-number">1</span></span>]; points.pop(); //    <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (isDeleted) { canvas.remove(currentEditingZone); currentEditingZone = <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>; } canvas.renderAll(); event.preventDefault(); } };</code> </pre><br><br><h4>  Result </h4><br>  Putting it all together, we were able to put labels and zones on an arbitrary map, unload / load them at will and draw with specific data on visits to these points or areas on the map.  Like that: <br><img src="//habrastorage.org/files/570/0d4/dd1/5700d4dd16e5468ea335289531a584f1.png"><br><br>  Thus, the variety and functionality of modern technologies and frameworks allows you to visualize data in a pleasant and flexible way with minimal time and effort.  HTML5 canvas, along with fabric.js, provide the developer with the tools to create fast and convenient interactive systems. </div><p>Source: <a href="https://habr.com/ru/post/251335/">https://habr.com/ru/post/251335/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../251323/index.html">Porting Android apps for Android TV and Nexus Player</a></li>
<li><a href="../251325/index.html">Five traps for the novice swifter</a></li>
<li><a href="../251329/index.html">Static JavaScript analyzers and errors from which they will help to unlearn (Part 2)</a></li>
<li><a href="../251331/index.html">Registration for the fifth annual championship on sports programming Russian Code Cup has begun</a></li>
<li><a href="../251333/index.html">Lossless Image Compression</a></li>
<li><a href="../251337/index.html">Architectural design of mobile applications: part 2</a></li>
<li><a href="../251339/index.html">Automatically Testing Java Swing Applications</a></li>
<li><a href="../251341/index.html">Whip and ... whip information security in the enterprise</a></li>
<li><a href="../251345/index.html">Pebble Time: a new watch with a color screen</a></li>
<li><a href="../251347/index.html">Context Model Pattern via Aero Framework</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>