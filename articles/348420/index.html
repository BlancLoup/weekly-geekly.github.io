<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Wi-Fi under the Neva: how we built a network in the deepest metro of the world</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="We started our blog on Habrahabr with our first and main project - we talked about how four years ago we built the world's first free Wi-Fi network in...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Wi-Fi under the Neva: how we built a network in the deepest metro of the world</h1><div class="post__text post__text-html js-mediator-article"><p><img src="https://habrastorage.org/webt/qu/hy/y8/quhyy84ugzmbpdcewu97jgogvai.jpeg"></p><br><p>  We started our blog on Habrahabr with our first and main project - we <a href="https://habrahabr.ru/company/maximatelecom/blog/332538/">talked</a> about how four years ago we built the world's first free Wi-Fi network in the rolling stock of the Moscow metro.  Having received the first experience of building a Wi-Fi transport network, our team implemented the project again, but for the residents of the Northern capital. <a name="habracut"></a></p><br><h3 id="same-same-but-different">  SAME-SAME BUT DIFFERENT </h3><br><p>  The network architecture in the St. Petersburg metro we did almost the same as in Moscow.  In the same way, the rolling stock in the tunnels travels in the zone of continuous radio coverage, an intra-train network is created and a stationary infrastructure is deployed. </p><br><p>  However, when planning and designing the St. Petersburg network, we: </p><br><ul><li>  accurately calculated the radio coverage of the tunnels; </li><li>  changed the composition and functions of active equipment; </li><li>  used the equipment of new generations (of course, four years have passed); </li><li>  virtualized more services than in Moscow; </li><li><p>  used antennas of domestic development and production. </p><br><p>  But first things first. </p><br></li></ul><br><h3 id="sem-raz-otmer">  SEVEN TIME </h3><br><p>  When we were planning a network in Moscow, there was no proven in our world an approved mathematical model for calculating the propagation of radio waves in tunnels.  Radio planning was done semi-empirically.  We have developed our own tool that can calculate the optimal placement of base stations in tunnels and with its help conducted radio network planning in St. Petersburg. </p><br><div class="spoiler">  <b class="spoiler_title">How we developed a mathematical model</b> <div class="spoiler_text"><p>  Together with our partner ZAO RadioGigabit, we developed a mathematical model of radio signal propagation in tunnels in the frequency range 3-6 GHz (by the way, in other bands, too).  On the basis of the model they wrote a calculation program, which: </p><br><ul><li>  at the entrance it takes a complete array of data describing subway tunnels: the geometry of tunnels and stations (shape and dimensions in section, curvature in horizontal and vertical planes), materials of the walls and ceiling of the tunnel in each section, presence or absence of separation of paths, branches and parking / dead ends , objects in the tunnel that affect the signal propagation (for example, hydraulic locks, traffic lights, other equipment), etc .; </li><li>  allows you to set the target accuracy of the calculation (approximate calculation can be performed quickly, while accurate calculation for the project is done for days on a fairly powerful supercluster) and other parameters; </li><li>  Allows you to specify the characteristics of the radio equipment and antennas used, as well as the network‚Äôs target indicators you want to achieve </li><li>  allows you to set the graphs and speeds of the compositions, as well as their sizes / geometry; </li><li>  on the basis of all the above, carry out simulations (mathematical modeling) of the network in a tunnel (not only of the data link layer, but also taking into account systemic effects, such as movement of trains, shielding antennas and each other under certain conditions); </li><li>  output the target BS assignment at the output, at which the stated target network parameters are achieved. </li></ul><br></div></div><br><p>  <strong>What exactly did we do?</strong> </p><br><ol><li>  We developed a theoretical model of signal propagation in tunnels and a system-level model. </li><li>  We created several measurement systems for carrying out full-scale measurements and model calibration / adjustment. </li><li>  We carried out several iterations of measurements and refinements of the model, until it began to give data that completely agreed with the results of measurements. </li></ol><br><p>  As a result, we got a tool for practical radio planning of wireless communication networks in metro, which has no analogues in the world. </p><br><p><img src="https://habrastorage.org/webt/rk/dw/nq/rkdwnqxdcifvxxhwkqfjmzyfcpk.jpeg"></p><br><p>  At one time, when planning a network in Moscow, we only had approximate rules for setting up the BS (maximum and minimum distances, etc.) that we used.  We conducted tests in the tunnels to check the assumptions made and made some adjustments to these rules based on the results.  Now we know (having conducted a study of our network in Moscow with the help of our new planning tool) that many decisions made at the beginning of the project about the placement were not optimal.  Now we would put many BS in a different way and in general would increase their number by about 15%.  We plan to gradually upgrade the network in Moscow, optimizing the radio coverage. </p><br><p>  In St. Petersburg, we received the target optimal BS arrangement, which allowed us to actually get the specified target indicators of speed and signal quality in the communication channels immediately after the launch of the network. </p><br><h3 id="menshe--luchshe">  LESS IS BETTER </h3><br><p>  When planning a network in Petersburg, we tried to reduce the amount of active equipment, and also use only equipment that supports remote monitoring.  This has helped us reduce operational costs. </p><br><p>  We have abandoned the use of tunnels and switching nodes of media converters, which convert the optical signal into electrical and vice versa.  Instead, they switched to a fully optical connection, which required new type base stations and more modern switches.  Due to more careful design, we have reduced the number of active equipment due to the fact that now there is one switch for 2.5-3 stations.  In Moscow, there is a pair of switches for every two stations.  All these changes helped us save the project budget, which was also one of the important tasks. </p><br><p>  In addition, the bandwidth between the station switches and the core was increased.  And if in Moscow these are two georeserved channels of 1 Gbit / s, in St. Petersburg the capacity of each of them is increased to 10 Gbit / s. </p><br><p>  Antenna specially designed for us by Zelenograd company Delta Satellite helped to improve the quality of the network.  Thanks to them, we were not only able to significantly reduce the cost of antenna systems, but also achieved improved radio path characteristics compared to those achieved in Moscow. </p><br><p><img src="https://habrastorage.org/webt/v9/d2/qi/v9d2qielquxae1kkp74fajebq7a.jpeg"></p><br><p>  We also changed the intra-train network: now all the cars are interconnected by two reserved channels of 1 Gbit / s (in Moscow, I remind you, the backup channel has a capacity of 100 Mbit / s).  The more modern Cisco AIR-CAP2702i access points with support for the standard 802.11ac and MIMO 3x4 are installed in the cars, which can provide an improved quality of service for modern user devices. </p><br><h3 id="smena-pokoleniy">  CHANGE OF GENERATIONS </h3><br><p>  Another major change is the use of a new train-tunnel communications radio equipment.  Since the launch of the network in Moscow, the generations of transport equipment have changed.  Now available devices with much better performance than four years ago.  In the project of the Petersburg Metro, we used the equipment of the company Fluidmesh, developed in Italy.  As in the project in Moscow, the equipment is built on the basis of Wi-Fi-chips.  But if 802.11n chipsets are used in Moscow, then in Petersburg there are new 802.11ac chipsets that support wider frequency bands (and therefore data transfer rates).  In addition, the modified antenna systems in St. Petersburg provide support for the MIMO 2x2 mode better than the antenna systems of the Moscow network.  Due to this, as well as due to optimal radio planning, the maximum throughput of the train-tunnel channel has increased from 120 Mbit / s in Moscow to 500 Mbit / s in St. Petersburg. </p><br><p><img src="https://habrastorage.org/webt/ak/56/i7/ak56i7woivbvlykk79xzisilgiy.jpeg"></p><br><p>  If we delve a little into the technology, then it should be noted that the communication equipment that we use in Moscow significantly modifies the standard level of access control to the medium (MAC level), transforming the TDD half-duplex Wi-Fi protocol into a synchronous TDM protocol.  This leads, among other things, to static separation of capacity between the ascending and descending communication channels in the ‚Äúcomposition-tunnel‚Äù section, and to the need for organizing the time synchronization of all base stations of the network using separate hardware clock sources.  Fluidmesh equipment also modifies the Wi-Fi protocol to improve its performance with our usage model.  We do not forget that standard Wi-Fi is, first of all, a protocol for accessing multiple subscribers to a shared network, and not a protocol for organizing communication between a small number of subscribers in motion (mobile PmP transport).  But the Fluidmesh technology retains the principle of dynamic distribution of capacity between the descending and ascending channels and does not require time synchronization, which simplifies the structure of the network and increases the efficiency of using channel capacity. </p><br><p>  Another major advantage of the selected equipment is the network architecture.  Fluidmesh allows you to build a packet-based network on the mesh principle by organizing a transport protocol using MPLS-like packet labeling.  This approach simplifies setup and management, allows you to completely avoid a number of standard Ethernet-specific problems that manifest themselves in networks with moving clients with roaming (handover), for example, problems of updating MAC address tables (MAC learning).  Due to, among other things, the new architecture in St. Petersburg, the latency (delay) in the network is several times less than in Moscow, and the level of packet loss when switching trains between base stations is very low (almost zero). </p><br><h3 id="virtualiziruy-eto">  VIRTUALIZE IT </h3><br><p>  New for the St. Petersburg network has become the virtualization of a part of network services (the IT layer has been fully virtualized in Moscow from the very beginning).  Instead of a dedicated controller of access points in the head car, we used industrial computers and a virtual controller.  From the point of view of managing a Wi-Fi network in rolling stock, nothing has changed, but other possibilities have appeared: </p><br><ul><li>  In St. Petersburg, user and advertising content can be stored (cached) in the train itself on servers in the head cars, this has made it possible to speed up access to frequently required content units for subscribers and relieve the ‚Äúcomponent-tunnel‚Äù communication channel; </li><li>  now in each train, in each head car a test device is installed (the same industrial PC :).  With it, we will be able to automatically measure the parameters of the channel, transmit to the network control center much more objective and accurate information about the operation of the network of the train.  This can significantly improve operating procedures and enhance real user experience; </li><li> and, finally, in case of an emergency on the network, we can activate more detailed, load and other tests in order to localize and eliminate the accident more quickly. </li></ul><br><p>  The industrial computer was taken with a large margin of computing power and with the possibility of an upgrade, which allows us to further increase the number of services and improve the quality of services. </p><br><h3 id="bystree-glubzhe-moschnee-set-konechno-zhe-set">  FASTER, DEEPER, POWERFUL (network, of course, network) </h3><br><p><img src="https://habrastorage.org/webt/yp/tu/s0/yptus0ocvboxtknfwn3ddzpw_sg.jpeg"></p><br><p>  We grow up and learn from our mistakes, as well as improve and expand our competencies.  Our solutions are becoming more sophisticated and technologically advanced, and we can already say with confidence that within the framework of building wireless networks in difficult conditions, there will be no impossible tasks for us.  But communication, as such, has long been no longer a service in itself, but merely acts as a transport for more and more complex both client and technological services and various other large and not very data.  We are actively working in this direction.  We already have a number of interesting solutions that we have created and are actively using, and we will tell about them in the next posts. </p><br><div class="spoiler">  <b class="spoiler_title">And we have open vacancies.</b> <div class="spoiler_text"><p>  Watch them <a href="https://habrahabr.ru/company/maximatelecom/vacancies/">here</a> </p></div></div></div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <p>Source: <a href="https://habr.com/ru/post/348420/">https://habr.com/ru/post/348420/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../348406/index.html">The most dangerous word in software development</a></li>
<li><a href="../348410/index.html">The book "Reactive design patterns"</a></li>
<li><a href="../348414/index.html">Threats of the past and future protocols</a></li>
<li><a href="../348416/index.html">The system bus PC transmits music in the middle frequencies</a></li>
<li><a href="../348418/index.html">Understand Bitcoin and the Future. Like what you know will be rethought forever</a></li>
<li><a href="../348422/index.html">Top 10 errors from 1000+ JavaScript projects and recommendations for eliminating them</a></li>
<li><a href="../348424/index.html">How JS works: web workers and five use cases</a></li>
<li><a href="../348428/index.html">Writing a Microsoft DNS server plugin to protect against IDN spoofing</a></li>
<li><a href="../348430/index.html">Security technology: virtual servers vs. containers</a></li>
<li><a href="../348432/index.html">QIWI invites designers, researchers and analysts to the kitchen</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>