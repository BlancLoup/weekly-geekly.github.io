<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>How our code works. Single project server architecture</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="It so happened that by the age of thirty I changed jobs only once and did not have the opportunity to learn from my own experience how different compa...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>How our code works. Single project server architecture</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/files/b1c/20f/fbc/b1c20ffbc51d4d1e9b3f7ffad19f9f80.jpg" alt="Picture to attract attention" align="left" width="250">  It so happened that by the age of thirty I changed jobs only once and did not have the opportunity to learn from my own experience how different companies set up web projects designed for high response speed and a large number of users.  <i>&lt;irony&gt; So, dear habrauser, caught in my field of view offline, saw me, run better, until I started to bother you with questions about error handling, logging and updating process on working servers &lt;/ irony&gt;</i> .  I am interested not in the set of technologies used, but on the principles on which the code base is built.  How the code is divided into classes, how classes are divided into layers, how business logic interacts with the infrastructure, what are the criteria by which the quality of the code is assessed and how the process of developing new functionality is organized.  Unfortunately, it is not easy to find such information, at best, everything is limited to listing the technologies and a brief description of the developed bicycles, but you want, of course, a more detailed picture.  In this topic, I will try to describe in as much detail as possible how the code works in the company where I work. <br><a name="habracut"></a><br>  I apologize in advance if my tone seems to someone to be a mentor - I have no ambitions to train anyone, the maximum that this post claims is a story about the architecture of the server part of one real project.  In my not very developed city in terms of software development, I have not once or twice met developers who were very interested in our experience in building server-side web applications, so guys, I write this post largely because of you, and I sincerely hope that I will be able to satisfy your interest. <br><br>  Like any other hired developer, I am not the owner of the code and cannot demonstrate the working draft listings, but telling about how the code base is organized without listings will still be wrong, too.  Therefore, I have no choice but to ‚Äúinvent‚Äù an abstract product and, by its example, go through the entire process of developing the server side: from getting TK programmers to implementing storage services, using the practices adopted in our team and drawing parallels with how our real project. <br><br><h3>  MoneyFlow.  Formulation of the problem </h3><br>  A virtual customer wants to create a cloud system to account for the expenditure of funds from the family budget.  He already came up with a name for it - MoneyFlow and drew UI mockups.  He wants the system to have web, android and iOS versions, and the application has a high (&lt;200 ms) response speed for any user actions.  The customer is going to invest serious funds in the promotion of the service and promises an avalanche-like growth of users immediately after launch. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Software development is an iterative process, and the number of iterations during development mainly depends on how accurately the task was set initially.  In this sense, our team was lucky, we have two wonderful analysts and a no less remarkable designer-designer (yes, there is such luck too), so by the beginning of work we usually have the final version of the TOR and a ready-made layout, which greatly simplifies life and frees us, developers, from headaches and the development of extrasensory skills to read the thoughts of the customer at a distance.  The virtual customer in my face also did not let us down and provided UI mockups as a description of his vision of the service.  I apologize in advance to the experts in building UI, pixel-perfectionists and just people with a developed sense of beauty for the eerie graphics of the layouts and their no less awful usability.  My only (albeit weak) excuse is just the fact that this is more a prototype than a real project, but I still hide these layouts under the cat. <br><br>  The idea of ‚Äã‚Äãthe service is simple - the user enters expenses into the system, on the basis of which reports are built in the form of pie charts. <br><div class="spoiler">  <b class="spoiler_title">Layout 1. Add expense</b> <div class="spoiler_text"><img src="https://habrastorage.org/files/480/224/244/480224244e00490181ffccbd30479256.jpg" height="400"></div></div><div class="spoiler">  <b class="spoiler_title">Layout 2. Sample Report</b> <div class="spoiler_text"><img src="https://habrastorage.org/files/438/be6/3f6/438be63f690a47baab1339c30364e29c.jpg" height="400"></div></div>  Categories of expenses and types of reports are predetermined by the customer and the same for all users.  The web version of the application will be a SPA written in Angular JS, and the server API on ASP.NET, from which the JS application receives data in JSON format.  We will build the service on the same technology stack on which our real application is built.  This stack looks something like this. <br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/2ca/20e/f13/2ca20ef131e8cc6da3581861d61e04a5.gif"></div><br><br><h3>  The contract of interaction between the client and server parts of the application </h3><br>  In our team, the development of new functional server and client parts of the service is conducted in parallel.  After getting acquainted with the TZ, we first determine the interface by which the front-end interaction with the backend is built.  It so happened that our API is built as RPC, not REST, and when we define it (API) we are primarily guided by the principle of the necessity and sufficiency of the transmitted data.  Let's try on the layouts to estimate what information the client application may need from the server side. <br><br><div class="spoiler">  <b class="spoiler_title">Layout 3. List of operations</b> <div class="spoiler_text"><img src="https://habrastorage.org/files/782/90f/d43/78290fd43fcf4bc58ef62aa5849712da.jpg" height="400"></div></div><br>  In the layout of the list we have only three columns - the amount, description and the day when the operation was performed.  In addition, the client application to display the list will require the category to which the expense operation relates, and Id, so that you can click on the list to go to the editing screen. <br><br>  An example of the result of calling the server method for a page with a list of committed expense transactions. <br><br><pre><code class="hljs json">[ { <span class="hljs-attr"><span class="hljs-attr">"id"</span></span>:<span class="hljs-string"><span class="hljs-string">"fe9a2da8-96df-4171-a5c4-f4b00d0855d5"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"sum"</span></span>:<span class="hljs-number"><span class="hljs-number">540.0</span></span>, <span class="hljs-attr"><span class="hljs-attr">"details"</span></span>:<span class="hljs-string"><span class="hljs-string">"   "</span></span>, <span class="hljs-attr"><span class="hljs-attr">"date"</span></span>:<span class="hljs-string"><span class="hljs-string">"2015-01-25T00:00:00+05:00"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"category"</span></span>:‚ÄùTransport‚Äù }, { <span class="hljs-attr"><span class="hljs-attr">"id"</span></span>:<span class="hljs-string"><span class="hljs-string">"a8a1e175-b7be-4c34-9544-5a25ed750f85"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"sum"</span></span>:<span class="hljs-number"><span class="hljs-number">500.0</span></span>, <span class="hljs-attr"><span class="hljs-attr">"details"</span></span>:<span class="hljs-string"><span class="hljs-string">"  "</span></span>, <span class="hljs-attr"><span class="hljs-attr">"date"</span></span>:<span class="hljs-string"><span class="hljs-string">"2015-01-25T00:00:00+05:00"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"category"</span></span>:‚ÄùEntertainment‚Äù } ]</code> </pre> <br><br>  Now look at the layout of the edit page. <br><br><div class="spoiler">  <b class="spoiler_title">Layout 4. Edit Screen</b> <div class="spoiler_text"><img src="https://habrastorage.org/files/a00/dd0/e10/a00dd0e1021b492eab34323eabf116d9.jpg" height="400"></div></div><br>  To display the edit page, the client application will need a method that returns the next JSON string. <br><br><pre> <code class="hljs json">{ <span class="hljs-attr"><span class="hljs-attr">"id"</span></span>:<span class="hljs-string"><span class="hljs-string">"23ed4bf4-375d-43b2-a0a7-cc06114c2a18"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"sum"</span></span>:<span class="hljs-number"><span class="hljs-number">500.0</span></span>, <span class="hljs-attr"><span class="hljs-attr">"details"</span></span>:<span class="hljs-string"><span class="hljs-string">"  "</span></span>, <span class="hljs-attr"><span class="hljs-attr">"date"</span></span>:<span class="hljs-string"><span class="hljs-string">"2015-01-25T00:00:00+05:00"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"category"</span></span>:‚ÄùEntertainment‚Äù, <span class="hljs-attr"><span class="hljs-attr">"history"</span></span>:[ { <span class="hljs-attr"><span class="hljs-attr">"text"</span></span>:<span class="hljs-string"><span class="hljs-string">"    "</span></span>, <span class="hljs-attr"><span class="hljs-attr">"created"</span></span>:<span class="hljs-string"><span class="hljs-string">"2015-01-25T16:06:27.318389Z"</span></span> }, { <span class="hljs-attr"><span class="hljs-attr">"text"</span></span>:<span class="hljs-string"><span class="hljs-string">"    "</span></span>, <span class="hljs-attr"><span class="hljs-attr">"created"</span></span>:<span class="hljs-string"><span class="hljs-string">"2015-01-25T16:06:27.318389Z"</span></span> } ] }</code> </pre> <br>  Compared to the operation model requested in the list, information on the record creation / modification history was added to the model on the edit page.  As I already wrote, we are guided by the principle of necessity and sufficiency and do not create a single common data model for each entity that could be used in the API in each method associated with it.  Yes, in the MoneyFlow application, there is a difference in the models of the list and the edit page in just one field, but in reality such simple models are only in books, like ‚ÄúHow to learn to program in C ++ at expert level,‚Äù with an unkindly smiling plump peasant in a sweater on the cover.  Real projects are much more complicated, the difference in the model for the editing screen as compared with the model requested in the list in a real project can reach two-digit fields and if we try to use the same model everywhere, we will unnecessarily increase the list generation time and waste we will load our servers. <br><br>  JSON objects returned by the server are of course serialized DTO objects, so in the server code we will have classes that define the models for each method from the API.  In accordance with the principle of DRY, these classes, if possible, are built into a hierarchy. <br><br>  Classes defining the MoneyFlow API contract for list screens, creating and editing operations. <br><br><pre> <code class="hljs pgsql"> //     <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> ChargeOpForAdding { <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> <span class="hljs-type"><span class="hljs-type">double</span></span> Sum { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> string Details { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> ECategory Category { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } } //    <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> ChargeOpForList : ChargeOpForAdding { <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> Guid Id { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> DateTime <span class="hljs-type"><span class="hljs-type">Date</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } } //     <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> ChargeOpForEditing : ChargeOpForList { <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> List&lt;HistoryMessage&gt; History { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } }</code> </pre><br>  After the contract is determined, the front-end developers involved create mocks for non-existent server methods and go on to create Angular JS magic.  Yes, we have a very fat and very wonderful client, to whom respected iKbaht <a href="http://habrahabr.ru/users/ikbaht/" class="user_link">habrayusers</a> , <a href="http://habrahabr.ru/users/houston/" class="user_link">Houston</a> and some more equally remarkable habra-anonymous authors have put their hand.  And it would be completely ugly on the part of server developers, if our beautiful, powerful JS application worked on a slow API.  Therefore, on the back end, we try to develop our API as fast as possible, doing most of the work asynchronously and building the data storage model as readable as possible. <br><br><h3>  We break the system into modules </h3><br>  If we consider the application MoneyFlow from the point of view of functionality, we can distinguish two different modules in it - this is a module for working with expenses and a reporting module.  If we were confident that the number of users of our application would be small, we would build a reporting module directly on top of the cost entry module.  In this case, we would have, for example, a stored procedure that would build for the user a report for the year directly on the basis of the expenses paid.  This scheme is very convenient from the point of view of data consistency, but, unfortunately, it also has a drawback.  With a sufficiently large number of users, the table with the cost data will become too large for our stored procedure to work out quickly, counting on the fly, for example, how much money was spent by the user on transport for the year.  Therefore, so that the user does not have to wait for the report for a long time, we will have to generate reports in advance, updating their content as new data appears in the cost accounting system. <br>  Software development is an iterative process.  If we consider the scheme with a single data model for expenses and reports as the first iteration, then the delivery of reports into a separate denormalized database is already iteration number two.  If we further theorize, then we can completely grope for the following improvements.  For example, how often do we have to update reports for the last month or year?  Probably, in early January, users will enter information about purchases made at the end of December into the system, but most of the data coming into the system will relate to the current calendar month.  The same is true for reporting, users are much more likely to be interested in reports for the current month.  Therefore, in the third iteration, if the effect of using a separate repository for reports will be offset by an increase in the number of users, you can optimize the storage system by transferring data for the current period to a faster repository located, for example, on a separate server.  Or using a repository like Redis, which stores its data in RAM.  If we draw an analogy with our real project, then we are at iteration 2.5.  Faced with a drop in performance, we optimized our storage system by transferring the data of each module to independent databases, and we also transferred some of the frequently used data to Redis. <br><br>  According to the legend, the MoneyFlow project is only preparing to launch, so we will keep it at iteration number two, leaving room for future improvements. <br><br><h3>  Synchronous and asynchronous execution stacks </h3><br>  In addition to increasing productivity by storing data in the most readable form, we try to produce most of the work seamlessly for the user in the asynchronous execution stack.  Every time a request comes to us from the client application, we look at what part of the work needs to be done before the answer is returned to the client.  Very often we return the answer almost immediately, having performed only the necessary part, like checking the validity of the incoming data, shifting most of the work to asynchronous processing.  It works as follows. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/files/ca5/747/cac/ca5747cac0584d059795b6a0189e463a.png" height="250"></div><br><br>  In the team we call the asynchronous stack of execution background processes that are busy processing messages coming from the server queues.  I will describe the device of our background handler in detail below, but for now let's see an example of interaction between the client application and server API when clicking on the ‚ÄúAdd‚Äù button from layout 1. For those who are too lazy to scroll - clicking on this button adds a new expense ‚ÄúGoing to the movies ‚Äù: 500r to the system. <br>  What actions need to be performed each time a new expense is entered into the system? <br><ul><li>  Check the validity of the input data </li><li>  Add information about the transaction to the cost accounting module </li><li>  Update the corresponding report in the reporting module </li></ul><br>  Which of these actions should we manage to do before we report to the client about the successful processing of the operation?  Exactly that we have to make sure that the data transmitted by the client application is correct, and return an error to it if this is not the case.  We can also quite add a new entry to the cost accounting module (although we can also transfer this to the background process), but it will be completely unnecessary to update reports synchronously, forcing the user to wait for each report, and there may be several, to be updated. <br><br>  Now the code itself.  For each request that came from the client side, we create an object responsible for its correct processing.  The object processing the request for the creation of a new expenditure transaction would look like this with us. <br><br><pre> <code class="hljs pgsql"> //,  //    <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> ChargeOpsCreator { private readonly IChargeOpsStorage _chargeOpsStorage; private readonly ICategoryStorage _categoryStorage; private readonly IServiceBusPublisher _serviceBusPublisher; <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> ChargeOpsCreator(IChargeOpsStorage chargeOpsStorage, ICategoryStorage categoryStorage, IServiceBusPublisher pub) { _chargeOpsStorage = chargeOpsStorage; _categoryStorage = categoryStorage; _serviceBusPublisher = pub; } <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> Guid <span class="hljs-keyword"><span class="hljs-keyword">Create</span></span>(ChargeOpForAdding op, Guid userId) { //   CheckingData(op); //     //    var id = Guid.NewGuid(); _chargeOpsStorage.CreateChargeOp(op); //      _serviceBusPublisher.Publish(<span class="hljs-built_in"><span class="hljs-built_in">new</span></span> ChargeOpCreated() {<span class="hljs-type"><span class="hljs-type">Date</span></span> = DateTime.UtcNow, ChargeOp = op, UserId = userId}); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> id; } //   private <span class="hljs-type"><span class="hljs-type">void</span></span> CheckingData(ChargeOpForAdding op) { //     <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (op.Sum &lt;= <span class="hljs-number"><span class="hljs-number">0</span></span>) throw <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> DataValidationException("    "); //        <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!_categoryStorage.CategoryExists(op.Category)) throw <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> DataValidationException("   "); } }</code> </pre><br>  The ChargeOpsCreator object checked the validity of the input data and added the completed operation to the cost accounting module, after which the Id of the created record was returned to the client application.  The process of updating reports is performed in the background process; for this, we sent the message ChargeOpCreated to the queue server, the processor of which will update the report for the user.  Messages sent to the service bus are simple DTO objects.  This is what the ChargeOpCreated class looks like, which we have just sent to the service bus. <br><br><pre> <code class="hljs pgsql"> <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> ChargeOpCreated { //    <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> DateTime <span class="hljs-type"><span class="hljs-type">Date</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } //,     <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> ChargeOpForAdding ChargeOp{ <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } //,    <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> Guid UserId { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } }</code> </pre><br><br><h3>  Splitting an application into layers </h3><br>  Both the execution stack (synchronous and asynchronous) at the assembly level are divided into three layers - the application layer (execution context), the business logic layer and data storage services.  Each layer is strictly defined area of ‚Äã‚Äãresponsibility. <br><br><h4>  Synchronous stack.  Application layer </h4><br>  In a synchronous stack, the execution context is an ASP.NET application.  His zone of responsibility, besides the usual for any web server actions like receiving requests and serializing / deserializing data, we have small.  It: <br><br><ul><li>  user authentication </li><li>  Instance of business logic objects using IoC container </li><li>  error handling and logging </li></ul><br>  All the code in the controllers is reduced to creating with the help of IoC a container of business logic objects responsible for further processing of requests.  This is what the controller method will look like, called to add a new expense in the MoneyFlow application. <br><br><pre> <code class="hljs pgsql"> <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> Guid <span class="hljs-keyword"><span class="hljs-keyword">Add</span></span>([FromBody]ChargeOpForAdding op) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> Container.Resolve&lt;ChargeOpsCreator&gt;().<span class="hljs-keyword"><span class="hljs-keyword">Create</span></span>(op, CurrentUserId); }</code> </pre><br>  The application layer in our system is very simple and lightweight; in a day we can change the execution context of our system from ASP.NET MVC (as we have historically) to ASP.NET WebAPI or Katana. <br><br><h4>  Synchronous stack.  Business logic layer </h4><br>  The business logic layer in the synchronous stack consists of many small objects that process incoming user requests.  The ChargeOpsCreator class, listed above, is just an example of such an object.  The creation of such classes will dock well with the principle of sole responsibility, and each such class can be fully tested with unit tests due to the fact that all its dependencies are injected into the constructor. <br><br>  The tasks of the business logic layer in our application include: <br><ul><li>  validation of incoming data </li><li>  user authorization (checking the user's rights to perform an action) </li><li>  interaction with the data storage layer </li><li>  generating DTO messages to send to the client application </li><li>  sending messages to the queue server for further asynchronous processing </li></ul><br>  It is important that we check the input data for correctness only in the business logic layer of the synchronous stack.  All other modules (queue disassemblers, storage services) are considered ‚Äúdemilitarized‚Äù from the point of view of inspections by the zone, with very few exceptions. <br><br>  In a real project, the objects of the business logic layer are separated from the controllers, where they are instantiated, by interfaces.  But this office did not bring us any particular practical benefits, but only complicated the IoC section of the container in the configuration file. <br><br><h3>  Asynchronous stack </h3><br>  In an asynchronous stack, an application is a service that parses messages arriving at the server of queues.  By itself, the service does not know which queues it should connect to, what types of messages and how it should process, and how many threads it can allocate for processing messages of a particular queue.  All this information is contained in the configuration file loaded by the service at startup. <br><br>  Example config service (pseudocode). <br><br><pre> <code class="xml hljs"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name"></span></span></span><span class="hljs-tag">  = </span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">‚ÄúReportBuilder‚Äù</span></span></span><span class="hljs-tag">  = </span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">‚Äú10‚Äù</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">_</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">=‚ÄúChargeOpCreatedHandler‚Äù</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">_</span></span></span><span class="hljs-tag"></span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">_</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">‚Äù2‚Äù</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">_</span></span></span><span class="hljs-tag"></span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">_</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">‚Äù200‚Äù</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">_</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">‚ÄùCriticalError‚Äù</span></span></span><span class="hljs-tag"> ‚Ä¶ /&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">_</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name"></span></span></span><span class="hljs-tag">&gt;</span></span> /*     5 */ <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name"></span></span></span><span class="hljs-tag">  = </span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">‚ÄúMailSender‚Äù</span></span></span><span class="hljs-tag">  = </span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">‚Äú5‚Äù</span></span></span><span class="hljs-tag">&gt;</span></span> ...</code> </pre><br>  At start, the service reads the configuration file, checks that there is a queue on the message server called ReportBuilder (if not, creates it), checks for the existence of a routing sending messages like ChargeOpCreated to this queue (if not, sets up routing itself), and starts processing messages that fall into the ReportBuilder queue by running the appropriate handlers for them.  In our case, this is the only ChargeOpCreatedHandler type handler (about the objects handlers just below).  Also, the service will understand from the configuration file that it can allocate up to 10 streams for parsing the ‚ÄúReportBuilder‚Äù queue messages, that if an error occurs in the operation of the ChargeOpCreatedHandler object, the message should return to the queue with a 200ms timeout, and when the handler re-drops, the message should go to a log with the note ‚ÄúCriticalError‚Äù and some more similar parameters.  This gives us a wonderful opportunity ‚Äúon the fly‚Äù, without making changes to the code, to scale the queue disassemblers, launching additional services on backup servers in case of accumulation of messages in any queue, telling it in the config file what kind of queue it should parse, which is very , very comfortably. <br><br>  The queuing service is a wrapper over the MassTransit library ( <a href="http://masstransit-project.com/">the project itself</a> , <a href="http://habrahabr.ru/post/210428/">an article in Habr√©</a> ) that implements the DataBus pattern over the RabbitMQ queue server.  But a programmer who writes in the business logic layer does not need to know anything about this, the entire infrastructure he touches (queue server, storage key / value, DBMS, etc.) is hidden from him by a layer of abstraction.  Probably, many have seen the post <a href="http://habrahabr.ru/post/153225/">‚ÄúHow two programmers baked bread‚Äù</a> about Boris and Marcus, using diametrically opposite approaches to writing code.  Both of us would have approached: Markus would develop business logic and a layer working with data, while Boris would work with us on infrastructure, the development of which we try to maintain at a high level of abstraction (sometimes it seems to me that even Boris would approve our code) .  When developing business logic, we are not trying to build objects into a long hierarchy, creating a large number of interfaces, we rather try to comply with the KISS principle, leaving our code as simple as possible.  So, for example, in MoneyFlow, the ChargeOpCreated message handler will look like, which we have already carefully specified in the configuration of the ReportBuilder service, which deals with the analysis of the Queue. <br><br><pre> <code class="hljs cpp"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ChargeOpCreatedHandler</span></span></span><span class="hljs-class">:</span></span>MessageHandler&lt;ChargeOpCreated&gt; { <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> readonly IReportsStorage _reportsStorage; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ChargeOpCreatedHandler</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(IReportsStorage reportsStorage)</span></span></span><span class="hljs-function"> </span></span>{ _reportsStorage = reportsStorage; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> override </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">HandleMessage</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(ChargeOpCreated message)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-comment"><span class="hljs-comment">//  _reportsStorage.UpdateMonthReport(userId, message.ChargeOp.Category, message.Date.Year, message.Date.Month, message.ChargeOp.Sum); } }</span></span></code> </pre><br>  All handler objects are descendants of the MessageHandler abstract class, where T is the type of the message to be parsed, with the only abstract method HandleMessage overloaded in the heirs. <br><br><pre> <code class="hljs cpp"> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> abstract <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">MessageHandler</span></span></span><span class="hljs-class">&lt;T&gt; :</span></span> where T : <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> {</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> abstract </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">HandleMessage</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(T message)</span></span></span></span>; }</code> </pre><br>  After receiving the message from the queue server, the service creates the required handler object using the IoC container and calls the HandleMessage method, passing the received message as a parameter.  To leave the opportunity to test the behavior of the handler in isolation from its dependencies, all external dependencies, while with ChargeOpCreatedHandler it is only a report storage service, are injected into the designer. <br><br>  As I already wrote, we do not check the correctness of the input data in the processing of messages - the business logic of the synchronous stack should deal with this and do not handle errors - it is the responsibility of the service in which the handler was running. <br><br><h3>  Error handling in the asynchronous execution stack </h3><br>  The reporting module is more suitable for the definition of consistency in the end ( <em>eventual consistency</em> ) than for the definition of <em>strong consistency</em> , but it still guarantees the ultimate consistency of data in the reporting module for any possible system failures.  Imagine that a server with a database that stores reports fell.  It is clear that in the case of binary clustering, when each database instance is duplicated on a separate server, a similar situation is practically excluded, but still imagine that this happened.  Customers continue to make their own expenses, messages about them appear in the queue server, but the parser responsible for updating the reports cannot access the database server and crashes.  According to the service configuration above, after dropping the ChargeOpCreated message, the same message will be returned to the queue server after 200 ms, after the second attempt (also unsuccessful) the message will be serialized and stored in a special storage of dropped messages, which in our project is combined with logs.  ,    ,                   (    ),         .           -     .     ,   .  ,     ‚Äú‚Äù,       ,       ,     ,      . <br><br><h3>    </h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">We have a shared storage layer for asynron and synchronous execution stacks. For a business logic developer, a storage service is simply an interface with methods for retrieving and modifying data. Under the interface is a service that completely encapsulates access to the data of a specific module. When designing service interfaces, we try, if possible, to follow the concept of </font></font><a href="https://ru.wikipedia.org/wiki/CQRS"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">CQRS</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - each method we have is either a command that performs some action or a request that returns data in the form of DTO objects, but not at the same time. We do this not to partition the storage system into two independent structures for reading and writing, but rather for order.</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">No matter how much we reduce the response time, doing most of the work asynchronously, an unsuccessfully designed storage system can erase all the work done. I did not accidentally leave a description of how the storage layer in our project is arranged at the very end. We made it a rule to develop storage services only after the implementation of the business logic layer objects has been completed, so that when designing the database tables, we will understand exactly how the data from these tables will be used. If during development of business logic we need to get some information from the storage layer, we add a new method to the interface that hides the service implementation, a new method that provides data in a form convenient for business logic. Our business logic defines the storage interface, but not vice versa.</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Here is an example of a report storage service interface that was defined during the development of the business logic of the MoneyFlow application. </font></font><br><br><pre> <code class="hljs pgsql"> <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> interface IReportsStorage { //   .  <span class="hljs-type"><span class="hljs-type">json</span></span>        string GetMonthReport (Guid userId, <span class="hljs-type"><span class="hljs-type">int</span></span> month, <span class="hljs-type"><span class="hljs-type">int</span></span> year); //      <span class="hljs-type"><span class="hljs-type">void</span></span> UpdateMonthReport(Guid userId, ECategory category, <span class="hljs-type"><span class="hljs-type">int</span></span> year, <span class="hljs-type"><span class="hljs-type">int</span></span> month, <span class="hljs-type"><span class="hljs-type">double</span></span> sum); }</code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">For data storage, we use the Postgresql relational database. </font><font style="vertical-align: inherit;">But this of course does not mean that we store the data in a relational form. </font><font style="vertical-align: inherit;">We lay the possibility of scaling by sharding and design tables and queries to them according to the sharding-specific canons: we do not use join-s, we construct queries on primary keys, etc. </font><font style="vertical-align: inherit;">When building a MoneyFlow report repository, we also leave the possibility to transfer part of the reports to another server, if it is suddenly needed later, without rebuilding the table structure. </font><font style="vertical-align: inherit;">How do we do sharding - using the built-in mechanism for the </font></font><a href="http://www.postgresql.org/docs/9.4/static/ddl-partitioning.html"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">physical separation of tables</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ( </font></font><em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">partitioning</font></font></em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">) or by adding a shard manager to the storage service of the reports - we will decide when the need arises. In the meantime, we should concentrate on designing the structure of the table, which would subsequently not hinder sharding. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Postgresql has wonderful NoSQL data types, such as json and less well-known, but no less remarkable </font></font><a href="http://www.postgresql.org/docs/9.4/static/hstore.html"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">hstore.</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">The report that is needed by the client application must be a json string. </font><font style="vertical-align: inherit;">Therefore, it would be logical for us to use the built-in json type for storing reports and give it to the client as is, without spending resources on the DB Tables-&gt; DTO-&gt; json serialization chain. </font><font style="vertical-align: inherit;">But in order to repost hstore again, I will do the same with the only difference that inside the database the report will be in the form of an associative array, which hstore is intended to store. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">To store the reports we will need one table with four fields:</font></font><br><table><tbody><tr><td> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Field</font></font></b> </td><td> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Which means</font></font></b> </td></tr><tr><td>  id </td><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> user ID </font></font></td></tr><tr><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> year </font></font></td><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> reporting year </font></font></td></tr><tr><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> month </font></font></td><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> the reporting month </font></font></td></tr><tr><td>  report </td><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> hash table with report data </font></font></td></tr></tbody></table><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The primary key of the table will be composite in the fields id year month. We will use expenditure categories as keys of the associative array report, and the amount spent on the corresponding category as values. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Sample database report. </font></font><br><br><img src="//habrastorage.org/files/f1f/af2/c9a/f1faf2c9abf44a79bd905c3172785c73.jpg"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">On this line it is clear that the user with id ‚Äúd717b8e4-1f0f-4094-bceb-d8a8bbd6a673‚Äù spent 500r on transport in January 2015 and 2500r on entertainment.</font></font><br><br>    GetMonthReport()   ,  json         postgresql,         UpdateMonthReport()    . -,   ,            ,    . -,      (race condition) ‚Äî  /     .    ,        hstore,      UpSert,            . 99%         ,     ,      .     ,    ,    -      ,   .           ,         AddReport(), GetReport(), UpdateReport()              .     -.  ,    -     ,    ,   :         ,        ,          . <br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Report Store Service Code. </font></font><br><br><pre> <code class="hljs pgsql"> //   <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> ReportStorage : IReportsStorage { private readonly IDbMapper _dbMapper; private readonly IDistributedLockFactory _lockFactory; <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> ReportStorage(IDbMapper dbMapper, IDistributedLockFactory lockFactory) { _dbMapper = dbMapper; _lockFactory = lockFactory; } //      <span class="hljs-type"><span class="hljs-type">json</span></span> <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> string GetMonthReport(Guid userId, <span class="hljs-type"><span class="hljs-type">int</span></span> month, <span class="hljs-type"><span class="hljs-type">int</span></span> year) { var report = _dbMapper.ExecuteScalarOrDefault&lt;string&gt;("select hstore_to_json(report) from reps where id = :userId and year = :year and month = :month", <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> QueryParameter("userId", userId), <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> QueryParameter("year", year), <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> QueryParameter("month", month)); //     -   <span class="hljs-type"><span class="hljs-type">json</span></span>  <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (string.IsNullOrEmpty(report)) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> "{}"; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> report; } //    <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> <span class="hljs-type"><span class="hljs-type">void</span></span> UpdateMonthReport(Guid userId, ECategory category, <span class="hljs-type"><span class="hljs-type">int</span></span> year, <span class="hljs-type"><span class="hljs-type">int</span></span> month, <span class="hljs-type"><span class="hljs-type">double</span></span> sum) { //          <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> (_lockFactory.AcquireLock(BuildLockKey(userId, year, month) , TimeSpan.FromSeconds(<span class="hljs-number"><span class="hljs-number">10</span></span>))) { //  RaceUnsafeMonthReportUpsert(userId, category.ToString().ToLower(), year, month, sum); } } // upsert    private <span class="hljs-type"><span class="hljs-type">void</span></span> RaceUnsafeMonthReportUpsert(Guid userId, string category, <span class="hljs-type"><span class="hljs-type">int</span></span> year, <span class="hljs-type"><span class="hljs-type">int</span></span> month, <span class="hljs-type"><span class="hljs-type">double</span></span> sum) { // : <span class="hljs-keyword"><span class="hljs-keyword">null</span></span> -   ,  - ,       <span class="hljs-type"><span class="hljs-type">double</span></span>? sumForCategory = _dbMapper.ExecuteScalarOrDefault&lt;<span class="hljs-type"><span class="hljs-type">double</span></span>?&gt;("select Coalesce((report-&gt;:category)::real, 0) from reps where id = :userId and year = :year and month = :month", <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> QueryParameter("category", category), <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> QueryParameter("userId", userId), <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> QueryParameter("year", year), <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> QueryParameter("month", month)); //   -   ,     <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!sumForCategory.HasValue) { _dbMapper.ExecuteNonQuery("insert into reps values(:userId, :year, :month, :categorySum::hstore)", <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> QueryParameter("userId", userId), <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> QueryParameter("year", year), <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> QueryParameter("month", month), <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> QueryParameter("categorySum", BuildHstore(category, sum))); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>; } //  ,      _dbMapper.ExecuteNonQuery("update reps set report = (report || :categorySum::hstore) where id = :userId and year = :year and month = :month", <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> QueryParameter("userId", userId), <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> QueryParameter("year", year), <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> QueryParameter("month", month), <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> QueryParameter("categorySum", BuildHstore(category, sumForCategory.<span class="hljs-keyword"><span class="hljs-keyword">Value</span></span> + sum))); } //  - ( :)   hstore private string BuildHstore(string category, <span class="hljs-type"><span class="hljs-type">double</span></span> sum) { var sb = <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> StringBuilder(); sb.Append(category); sb.Append("=&gt;\""); sb.Append(sum.ToString("<span class="hljs-number"><span class="hljs-number">0.00</span></span>", CultureInfo.InvariantCulture)); sb.Append("\""); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> sb.ToString(); } //     private string BuildLockKey(Guid userId, <span class="hljs-type"><span class="hljs-type">int</span></span> year, <span class="hljs-type"><span class="hljs-type">int</span></span> month) { var sb = <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> StringBuilder(); sb.Append(userId); sb.Append("_"); sb.Append(year); sb.Append("_"); sb.Append(month); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> sb.ToString(); } }</code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">In the ReportStorage service constructor, we have two dependencies ‚Äî IDbMapper and IDistributedLockFactory. </font><font style="vertical-align: inherit;">IDbMapper is a facade above the lightweight ORM framework BLToolkit.</font></font><br><br><pre> <code class="hljs cs"> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">interface</span></span> <span class="hljs-title"><span class="hljs-title">IDbMapper</span></span> { List&lt;T&gt; ExecuteList&lt;T&gt;(<span class="hljs-keyword"><span class="hljs-keyword">string</span></span> query, <span class="hljs-keyword"><span class="hljs-keyword">params</span></span> QueryParameter[] list) <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> T : <span class="hljs-keyword"><span class="hljs-keyword">class</span></span>; List&lt;T&gt; ExecuteScalarList&lt;T&gt;(<span class="hljs-keyword"><span class="hljs-keyword">string</span></span> query, <span class="hljs-keyword"><span class="hljs-keyword">params</span></span> QueryParameter[] list); T ExecuteObject&lt;T&gt;(<span class="hljs-keyword"><span class="hljs-keyword">string</span></span> query, <span class="hljs-keyword"><span class="hljs-keyword">params</span></span> QueryParameter[] list) <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> T : <span class="hljs-keyword"><span class="hljs-keyword">class</span></span>; T ExecuteObjectOrNull&lt;T&gt;(<span class="hljs-keyword"><span class="hljs-keyword">string</span></span> query, <span class="hljs-keyword"><span class="hljs-keyword">params</span></span> QueryParameter[] list) <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> T : <span class="hljs-keyword"><span class="hljs-keyword">class</span></span>; T ExecuteScalar&lt;T&gt;(<span class="hljs-keyword"><span class="hljs-keyword">string</span></span> query, <span class="hljs-keyword"><span class="hljs-keyword">params</span></span> QueryParameter[] list) ; T ExecuteScalarOrDefault&lt;T&gt;(<span class="hljs-keyword"><span class="hljs-keyword">string</span></span> query, <span class="hljs-keyword"><span class="hljs-keyword">params</span></span> QueryParameter[] list); <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ExecuteNonQuery</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> query, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">params</span></span></span></span><span class="hljs-function"><span class="hljs-params"> QueryParameter[] list</span></span></span><span class="hljs-function">)</span></span>; Dictionary&lt;TKey, TValue&gt; ExecuteScalarDictionary&lt;TKey, TValue&gt;(<span class="hljs-keyword"><span class="hljs-keyword">string</span></span> query, <span class="hljs-keyword"><span class="hljs-keyword">params</span></span> QueryParameter[] list); }</code> </pre><br>         NHibernate   - ORM,             DTO    ,   <a href="https://github.com/igor-tkachev/bltoolkit/">BLToolkit</a>   . <br><br> IDistributedLockFactory    ‚Äî      ,    ServiceStack  <a href="https://github.com/ServiceStack/ServiceStack.Redis/wiki/RedisLocks">RedisLocks</a> . <br>   ,    :   ‚Äî ‚Äú ‚Äù -,          ,       ,   - . <br><br><h3> ‚Äú‚Äù     </h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">There is a certain amount of cunning in the words that we have divided the reporting system of the MoneyFlow application into a separate, independent module. Yes, we store the report data separately from the accounting system data, but in our application, business logic and parts of the infrastructure, such as a service bus or, for example, a web server, are shared resources for all application modules. For our small company, in which for recounting programmers, the fingers of one hand of the milling-machine operator are enough, this approach is more than justified. In large companies, where work on different modules can be carried out by different teams, it is customary to take care of minimizing the use of common resources and the lack of single points of failure. So, if the MoneyFlow application were developed in a large company, its architecture would be a classic SOA.</font></font><br><br><div style="text-align:center;"><img src="http://habrastorage.org/files/81d/dd2/170/81ddd2170c1740c082cd9119b40e1433.png" height="450"></div><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The refusal of the idea to make a system based on completely independent modules, communicating with each other on the basis of one simple protocol, was not easy for us. Initially, when designing, we planned to make a real SOA solution, but at the last moment, after weighing all the pros and cons within our compact (not in the closed and limited sense, but simply very small), the teams decided to use the ‚Äúmixed‚Äù concept of module division: common infrastructure and business logic are independent storage services. Now I understand that this decision was right. We were able to direct time and effort not spent on complete duplication of the infrastructure of the modules to improve other aspects of the application.</font></font><br><br><h3>  Instead of conclusion </h3><br>        .       ,  , -     -,     ,     API.       ,        .   API  ,                      . </div><p>Source: <a href="https://habr.com/ru/post/249453/">https://habr.com/ru/post/249453/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../249441/index.html">The digest of interesting materials from the world of web development and IT for the last week No. 145 (January 26 - February 1, 2015)</a></li>
<li><a href="../249445/index.html">Minimal viability for mobile applications</a></li>
<li><a href="../249447/index.html">Winter Digest Gaming Industry News</a></li>
<li><a href="../249449/index.html">Cross compilation in Go</a></li>
<li><a href="../249451/index.html">We listen to the birds from 1905. Recovery of old records</a></li>
<li><a href="../249455/index.html">How we provided communication in the cities of the Arctic Circle</a></li>
<li><a href="../249459/index.html">Raspberry Pi 2: 4 cores, gigabytes of RAM, six times the performance</a></li>
<li><a href="../249461/index.html">CTOcast # 4: Jacob Fine (Farata Systems, SuranceBay)</a></li>
<li><a href="../249465/index.html">(Video) Project Management Office in 10 minutes</a></li>
<li><a href="../249467/index.html">A short course in computer graphics: we write a simplified OpenGL do it yourself, article 4c of 6</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>