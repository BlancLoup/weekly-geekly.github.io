<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>How Tor works</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Tor is an anonymity tool used by people seeking privacy and struggling with Internet censorship. Over time, Tor has become a very, very good deal with...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>How Tor works</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/getpro/geektimes/post_images/f34/692/9ef/f346929efd7366504a40f4a0340fcbf4.png"><br><br>  Tor is an anonymity tool used by people seeking privacy and struggling with Internet censorship.  Over time, Tor has become a very, very good deal with its task.  Therefore, the security, stability and speed of this network is critical for people who rely on it. <br><br>  But how does Tor work ‚Äúunder the hood‚Äù?  In this article, we will dive into the structure and protocols used in the network to get a close look at the work of Tor. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h4>  Short history of tor </h4><br>  The concept of bulbous routing (later we will explain this name) was first proposed in 1995.  Initially, these studies were funded by the Ministry of Naval Studies, and then in 1997 DARPA joined the project.  Since then, the Tor Project was funded by various sponsors, and not so long ago the project won the reddit campaign to collect donations. <br><br>  The code for the modern version of Tor was opened in October 2003, and it was already the 3rd generation of onion-based software.  The idea is that we wrap traffic in encrypted layers (like a bulb) in order to protect the data and the anonymity of the sender and receiver. <br><br><h4>  Tor Basics </h4><br>  With the story figured out - let's get down to the principles of work.  At the highest level, Tor works by transferring the connection of your computer to the target computers (for example, google.com) through several intermediary computers, or relays (relay). <br><a name="habracut"></a><br><img src="https://habrastorage.org/getpro/geektimes/post_images/f6c/2e7/99f/f6c2e799f6d101d30a07e355949cd15a.png"><br>  Package Path: Security Node, Intermediate Node, Output Node, Destination <br><br>  Now (February 2015), about 6,000 routers are engaged in the transmission of the Tor network.  They are located around the world and work thanks to volunteers who agree to give some traffic for a good cause.  It is important that most nodes have no special hardware or additional software ‚Äî they all work with Tor software that is configured to work as a node. <br><br>  The speed and anonymity of the Tor network depends on the number of nodes - the more the better!  And this is understandable, since the traffic of one node is limited.  The more nodes you have, the more difficult it is to track the user. <br><br><h4>  Types of nodes </h4><br>  By default, Tor passes traffic through 3 nodes.  Each of them has its own role (we will analyze them in detail later). <br><br><img src="https://habrastorage.org/getpro/geektimes/post_images/c8c/458/1af/c8c4581af03413ae7961b15f68a7d328.png"><br>  <i>Client, security node, intermediate node, output node, destination</i> <br><br>  The gateway or gateway node is the network entry point.  Input nodes are selected from those that work for a long time, and have shown themselves to be stable and high-speed. <br>  Intermediate node - transmits traffic from the security to the weekend.  As a result, the former do not know anything about the latter. <br>  The exit node is the exit point from the network, which sends traffic to the destination that the client needs. <br><br>  Usually, a secure method of launching a watchdog or intermediate node is a virtual server (DigitalOcean, EC2) ‚Äîin this case, the server operators will see only encrypted traffic. <br><br>  But the output node operators have a special responsibility.  Since they send traffic to the destination, all illegal actions performed through Tor will be associated with the output node.  And this can lead to police raids, notifications of illegal activities and other things. <br><br>  Meet the operator of the output node - tell him thanks.  He deserves it. <br><br><h4>  And here onions? </h4><br>  Having understood the route of connections going through the nodes, let us ask ourselves: how can we trust them?  Is it possible to be sure that they will not break the connection and will not extract all the data from it?  In short, we don‚Äôt need to trust them! <br><br>  The Tor network is designed so that nodes can be treated with minimal trust.  This is achieved through encryption. <br><br>  So what about the bulbs?  Let's look at the work of encryption in the process of establishing a client connection through the Tor network. <br><br>  The client encrypts the data so that only the output node can decrypt it. <br>  This data is then encrypted again so that only the intermediate node can decrypt it. <br>  And then this data is again encrypted so that only the sentry node can decrypt it. <br><br><img src="https://habrastorage.org/getpro/geektimes/post_images/320/8ff/639/3208ff639134ce9d25c875531e7f1c5f.png"><br><br>  It turns out that we wrapped the original data in layers of encryption - like a bow.  As a result, each node has only the information it needs - where the encrypted data came from, and where to send it.  Such encryption is useful for everyone - client traffic is not open, and the nodes are not responsible for the content of the transmitted data. <br><br>  Note: output nodes can see the source data, since they need to send them to their destination.  Therefore, they can extract valuable information from traffic transmitted in clear text over HTTP and FTP! <br><br><h4>  Nodes and bridges: a problem with nodes </h4><br>  After starting the Tor client, he needs to get lists of all input, intermediate and output nodes.  And this list is not a secret - later I will tell you how it is distributed (you can look in the documentation for the word ‚Äúconcensus‚Äù yourself).  The publicity of the list is necessary, but there is a problem in it. <br><br>  To understand it, let's pretend to be attacking and ask ourselves: what would the Authoritarian Government (AP) do?  Thinking this way, we can understand why Tor is built like this. <br><br>  So what would the AP do?  Censorship is a serious matter, and Tor allows you to bypass it, so the AP would want to block users from accessing Tor.  There are two ways to do this: <br><ul><li>  block users logging out of Tor; </li><li>  block users in Tor. </li></ul><br><br>  The first is possible, and this is a free choice of the owner of the router or website.  He just needs to download a list of Tor output nodes, and block all traffic from them.  It will be bad, but Tor cannot do anything about it. <br><br>  The second option is seriously worse.  Blocking users logging out of Tor can prevent them from visiting a particular service, and blocking all incoming users will prevent them from going to any sites - Tor will become useless for those users who are already suffering from censorship, as a result of which they turned to this service.  And if there were only nodes in Tor, this would be possible, since the AP can download the list of sentinel nodes and block traffic to them. <br><br>  It‚Äôs good that Tor developers thought about it and came up with a clever solution to the problem.  Get to know the bridges. <br><br><h4>  Bridges </h4><br>  In essence, bridges are nodes that are not publicly shared.  Users outside the wall of censorship can use them to access the Tor network.  But if they are not published, how do users know where to find them?  Do you need any special list?  Let's talk about it later, but in short, yes - there is a list of bridges, which are engaged in the project developers. <br><br>  It's just not public.  Instead, users can get a small list of bridges to connect to the rest of the network.  This list, BridgeDB, gives users only a few bridges at a time.  This is reasonable, since they don‚Äôt need many bridges at once. <br><br>  By issuing several bridges, it is possible to prevent the network from being blocked by the Authoritarian Government.  Of course, getting information about new nodes, you can block them, but can someone discover all the bridges? <br><br><h4>  Can anyone discover all the bridges </h4><br>  The list of bridges is strictly secret.  If the AP gets this list, it will be able to completely block Tor.  Therefore, network developers conducted research on the possibility of obtaining a list of all bridges. <br><br>  I will describe in detail two items from this list, the 2nd and 6th, since it was with these methods that I managed to gain access to the bridges.  At point 6, researchers searched for Tor bridges and scanned the entire IPv4 space with a ZMap port scanner, and found between 79% and 86% of all bridges. <br><br>  The 2nd point implies the launch of a Tor intermediate node that can track incoming requests to it.  Only guard nodes and bridges refer to an intermediate node ‚Äî and if the addressing node is not in the public list of nodes, then it is obvious that this node is a bridge.  This is a serious challenge to Tor, or any other network.  Since users cannot be trusted, it is necessary to make the network anonymous and closed as far as possible, which is why the network is done this way. <br><br><h4>  Consensus </h4><br>  Consider how the network functions at a lower level.  How it is organized and how to find out which nodes in the network are active.  We have already mentioned that there is a list of nodes and a list of bridges in the network.  Let's talk about who makes these lists. <br><br>  Each Tor client contains fixed information about 10 powerful nodes supported by trusted volunteers.  They have a special task - to monitor the status of the entire network.  These are called directory authorities (DA, list management). <br><br>  They are distributed around the world and are responsible for distributing a constantly updated list of all known Tor nodes.  They choose which nodes to work with, and when. <br><br>  Why 10?  Usually it is not necessary to make a committee of an even number of members, so that when a vote does not happen a draw.  The bottom line is that 9 DAs deal with lists of nodes, and one DA (Tonga) - with a list of bridges <br><br><img src="https://habrastorage.org/getpro/geektimes/post_images/9a2/948/55d/9a294855de28ddd1973be1f529c22961.png"><br>  <i>DA List</i> <br><br><h4>  Consensus </h4><br>  So how does a DA support network performance? <br><br>  The status of all nodes is contained in an updated document called "consensus".  DA support it and update it hourly by voting.  Here‚Äôs how it happens: <br><ul><li> each DA creates a list of known nodes; </li><li>  then it counts all other data ‚Äî host flags, traffic weights, etc .; </li><li>  sends data as a ‚Äústatus vote‚Äù to everyone else; </li><li>  gets the votes of everyone else; </li><li>  combines and signs all parameters of all votes; </li><li>  sends the signed data to the rest; </li><li>  Most DAs must agree on data and confirm that there is consensus; </li><li>  consensus is published by every DA. </li></ul><br><br>  Publication of consensus occurs via HTTP, so that everyone can download the latest version.  You can check for yourself by downloading the consensus through Tor or through the gate tor26. <br><br>  And what does it mean? <br><br><h4>  Anatomy of consensus </h4><br>  Just reading the specification in this document is difficult to understand.  I like the visual display to understand how the structure works.  For this, I made a poster in the style of corkami.  And here (clickable) graphic representation of this document. <br><br> <a href=""><img src="https://habrastorage.org/getpro/geektimes/post_images/9f6/e69/3cf/9f6e693cf6f1c159e5e45880462cd151.png"></a> <br><br><h4>  What happens if the node is empty? </h4><br>  A detailed review of the principles of the network, we have not yet dealt with the principles of the work of the output nodes.  These are the last links in the Tor chain, providing the path from the client to the server.  Because they send data to their destination, they can see it as if they had just left the device. <br><br>  Such transparency implies a lot of trust in the output nodes, and they usually behave responsibly.  But not always.  And what happens when an output node operator decides to take up arms against Tor users? <br><br><h4>  Sniffers case </h4><br><br>  Tor output nodes are a nearly reference example of a ‚Äúman in the middle‚Äù (man-in-the-middle, MitM).  This means that any unencrypted communication protocols (FTP, HTTP, SMTP) can be monitored by them.  And these are logins and passwords, cookies, uploaded and downloaded files. <br><br>  Output nodes can see traffic as if it had just left the device. <br><br>  The ambush is that we can't do anything about it (except using encrypted protocols).  Sniffing, passive listening to the network does not require active participation, so the only defense is to understand the problem and avoid transferring important data without encryption. <br><br>  But suppose the exit node operator decides to harm the network in a big way.  Listening is an occupation of fools.  Let's modify traffic! <br><br><h4>  Squeeze the maximum </h4><br>  Recall that the output node operator is responsible for ensuring that traffic passing from and to the client will not be changed.  Yeah of course‚Ä¶ <br><br>  Let's see how you can change it. <br><br><h5>  SSL MiTM &amp; sslstrip </h5><br>  SSL spoils the whole raspberry when we try to podgadit users.  Fortunately for attackers, many sites have problems with its implementation, allowing us to force the user to go through unencrypted connections.  Examples are redirection from HTTP to HTTPS, the inclusion of HTTP content on HTTPS sites, and so on. <br><br>  A convenient tool for exploiting vulnerabilities is sslstrip.  We only need to pass through all the outgoing traffic, and in many cases we will be able to harm the user.  Of course, we can simply use a self-signed certificate, and look at the SSL traffic passing through the site.  Easy! <br><br><h5>  Putting browsers on BeEF </h5><br>  Having seen the details of the traffic, you can proceed to sabotage.  For example, you can use the BeEF framework to gain control over browsers.  Then you can use the function from Metasploit "browser autopwn", as a result of which the host will be compromised, and we will be able to execute commands on it.  Come! .. <br><br><h5>  Backdoor Binary </h5><br>  Suppose, through our site, the binaries are downloaded - software or updates to it.  Sometimes the user may not even suspect that updates are being downloaded.  We just need to add a back door to them through tools like The Backdoor Factory.  Then after the execution of the program the host will be compromised.  Come again! .. <br><br><h5>  How to catch Walter White </h5><br>  And although most of Tor's output nodes behave decently, cases of destructive behavior of some of them are not so rare.  All attacks, which we talked about in theory, have already taken place. <br><br>  By the way, the developers thought about this and developed a precautionary measure against customers using bad output nodes.  It works like a flag in a consensus called BadExit. <br><br>  To solve the problem of catching bad output nodes, a clever exitmap system has been developed.  It works like this: for each output node, a module is launched in Python that deals with logins, file downloads, and so on.  The results of his work are then recorded. <br><br>  The exitmap works using the Stem library (designed to work with Tor from Python) to help build the schemas for each output node.  Simple but effective. <br><br>  Exitmap was created in 2013 as part of the ‚Äúdamaged bulbs‚Äù program.  The authors found 65 output nodes that change traffic.  It turns out that although this is not a catastrophe (at the time of operation, there were about 1,000 output nodes), but the problem is serious enough to track violations.  Therefore, exitmap is still working and supported. <br><br>  In another example, the researcher simply made a fake login page, and logged in through each output node.  Then, HTTP server logs were viewed for example login attempts.  Many sites attempted to enter the site with the login and password used by the author. <br><br><h4>  This problem is not peculiar to Tor. </h4><br>  It is important to note that this problem is not just Tor.  Between you and the photo of the cat on which you want to look, and so there are quite a lot of nodes.  Only one person with hostile intentions is enough to cause a lot of harm.  The best thing to do here is to force encryption where possible.  If the traffic cannot be recognized, it cannot be easily changed. <br><br>  And remember that this is only an example of bad behavior of operators, and not the norm.  The overwhelming majority of the exit nodes take their role very seriously and deserve great thanks for all the risks they assume in the name of free dissemination of information. </div><p>Source: <a href="https://habr.com/ru/post/357128/">https://habr.com/ru/post/357128/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../357118/index.html">Iran gives 1 year to foreign messengers to transfer servers to the country</a></li>
<li><a href="../357120/index.html">The new version of Tor Browser: the rejection of SHA-1 and the transition to search DuckDuckGo</a></li>
<li><a href="../357122/index.html">Bypassing the rules of access control in the means of protection from unauthorized access</a></li>
<li><a href="../357124/index.html">Russia is among the world leaders in Internet resiliency</a></li>
<li><a href="../357126/index.html">Roskomnadzor: control the data of Russian Internet users need to instruct the "national operator"</a></li>
<li><a href="../357130/index.html">The US Federal Court does not consider personal information on a personal computer.</a></li>
<li><a href="../357132/index.html">The effect of the cobra. Keylogger on eBay and ban on copy-paste password</a></li>
<li><a href="../357134/index.html">Rostelecom proposes to ban foreign smart-machines and other equipment to transfer data abroad</a></li>
<li><a href="../357136/index.html">"Hunter for sysadmines" from the NSA contacted</a></li>
<li><a href="../357138/index.html">In Russia, create a "backup" Runet</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>