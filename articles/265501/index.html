<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Creating a test DB context in tests using xUnit</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="In cases where your application has a non-trivial data scheme (people, products, orders, prices, volumes, states depending on a heap of parameters, et...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Creating a test DB context in tests using xUnit</h1><div class="post__text post__text-html js-mediator-article">  In cases where your application has a non-trivial data scheme (people, products, orders, prices, volumes, states depending on a heap of parameters, etc.), it is easier to have some data dump recreated on the test environment, or taken from production, and use it for tests.  In this case, you may need several data dumps, for each of the cases that automated tests should be able to roll and roll back to the test environment.  In this article I will try to show how this can be done using the fixtures and collections of the xUnit framework.  The entire solution is based on xUnit version 2.0 <a href="http://xunit.github.io/release-notes/2015-03-16.html">dated March 16, 2015</a> . <br><a name="habracut"></a><br><h4>  Test execution script in context </h4><br>  The simplest scenario for data-driven tests might look like this: <br><ol><li>  create a database for test collection </li><li>  update the database to the latest version (optional) </li><li>  run automatic tests </li><li>  delete DB </li></ol><br>  Now I do not want to dwell on cases when it is necessary to update the database, since  These technical details are not important to this article.  But I would like to note that ADO.NET does not allow the execution of scripts in which there is a GO.  If you want to automatically roll scripts, build your system so that you can roll each script separately.  Even the SQL Server Management Objects (SMO) library breaks scripts by GO and runs the pieces individually (tested).  Thus, the 2nd paragraph will not be considered in the article.  XUnit will help us with the rest.  A description of the general concept of xUnit contexts can be found in their <a href="http://xunit.github.io/docs/shared-context.html">documentation</a> . <br><br>  Fixture is a class created before running tests from one suite.  I call a suite a class with tests in order to avoid tautology.  Collection is a class that describes a group of suites, but is never created during the execution of tests.  It is for description only.  Below it will be shown in the examples. <br><br><h4>  Life cycle of Fixtures and Collections </h4><br>  Examples you can find on <a href="https://github.com/xtrmstep/xUnitFixturesLifeCycle">github</a> .  Beginning with xUnit 2.0, the authors replaced IUseFixture with ICollectionFixture and IClassFixture. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      To demonstrate how xUnit creates instances of classes, I created three suites.  Two of them must run in the same context. <br><br><pre><code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">CollectionFixture</span></span> : <span class="hljs-title"><span class="hljs-title">IDisposable</span></span> { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">CollectionFixture</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Dispose</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) } </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> class ClassFixture : IDisposable</span></span> { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ClassFixture</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Dispose</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) } [</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">CollectionDefinition</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">"ContextOne"</span></span></span></span></span><span class="hljs-function">)] </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> class TestCollection : ICollectionFixture&lt;CollectionFixture&gt;</span></span> { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">TestCollection</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span><span class="hljs-comment"><span class="hljs-function"><span class="hljs-comment">// TestCollection is never instantiated } [Collection("ContextOne")] public class TestContainerOne : IClassFixture&lt;ClassFixture&gt;, IDisposable { public TestContainerOne() [Fact] public void TestOne() [Fact] public void TestTwo() public void Dispose() } [Collection("ContextOne")] public class TestContainerTwo : IDisposable { public TestContainerTwo() [Fact] public void TestOne() public void Dispose() } public class TestContainerThree { [Fact] public void TestOne() }</span></span></span></span></code> </pre> <br>  To see the lines in the output window as below, tests must be run in debug mode.  I want to note one thing about the papallism of the tests in xUnit.  By default, tests are performed synchronously within one suite, or collection, if there is one.  In other cases, tests are performed in parallel.  More details about this can <a href="http://xunit.github.io/docs/running-tests-in-parallel.html">be found here</a> .  Therefore, in reality, the output may be slightly different on your computer, but I sorted it for greater visibility. <br><br><pre> <code class="cs hljs">CollectionFixture : ctor ClassFixture : ctor TestContainerOne : ctor TestContainerOne : TestOne TestContainerOne : disposed TestContainerOne : ctor TestContainerOne : TestTwo TestContainerOne : disposed ClassFixture : disposed TestContainerTwo : ctor TestContainerTwo : TestOne TestContainerTwo : disposed CollectionFixture : disposed TestContainerThree : TestOne</code> </pre><br>  Thus, you can see to group several tests into one context you can use ICollectionFixture.  At the same time, IClassFixture can adjust the environment settings for a specific suite.  And it is important to note that the designer of the suite is called for each individual test, no matter how many.  In Dispose, it is reasonable to locate the cleanup code of the appropriate scop (test, suite or collection). <br><br><h4>  Implementation details </h4><br>  Now it should be obvious that you can create a class that executes the script described above and attach it to the tests using ICollectionFixture or IClassFixture, depending on the specific tasks.  In my example, I used a collection that restores the database before the tests, and in Dispose () it drops it. <br><br>  It is worth noting about the following problems of this approach: <br><ul><li>  When restoring a database from backup, internal information about files is used.  In the case of parallel execution of tests, this may lead to their falling due to the conflict of names of the restored bases.  To solve the problem, you need to restore the database with the movement of files.  This is an example on GitHub. </li><li>  In general, a database can have a different number of files (data, log, file stream, etc.).  This situation must be properly handled.  But for the purposes of this article, I assume that only Data and Log are needed.  The remaining files are ignored using Partial Restore ( <a href="https://msdn.microsoft.com/en-us/library/ms186858.aspx">PARTIAL</a> ). </li></ul><br>  Below are examples of T-SQL for restoring and deleting databases. <br><br><pre> <code class="sql hljs">IF NOT EXISTS (<span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">name</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> master.dbo.sysdatabases <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">name</span></span> = <span class="hljs-string"><span class="hljs-string">'&lt;DBNAME&gt;'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">BEGIN</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DECLARE</span></span> @<span class="hljs-keyword"><span class="hljs-keyword">Table</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> ( LogicalName <span class="hljs-built_in"><span class="hljs-built_in">VARCHAR</span></span>(<span class="hljs-number"><span class="hljs-number">128</span></span>) , [PhysicalName] <span class="hljs-built_in"><span class="hljs-built_in">VARCHAR</span></span>(<span class="hljs-number"><span class="hljs-number">128</span></span>) , [<span class="hljs-keyword"><span class="hljs-keyword">Type</span></span>] <span class="hljs-built_in"><span class="hljs-built_in">VARCHAR</span></span> , [FileGroupName] <span class="hljs-built_in"><span class="hljs-built_in">VARCHAR</span></span>(<span class="hljs-number"><span class="hljs-number">128</span></span>) , [<span class="hljs-keyword"><span class="hljs-keyword">Size</span></span>] <span class="hljs-built_in"><span class="hljs-built_in">VARCHAR</span></span>(<span class="hljs-number"><span class="hljs-number">128</span></span>) , [<span class="hljs-keyword"><span class="hljs-keyword">MaxSize</span></span>] <span class="hljs-built_in"><span class="hljs-built_in">VARCHAR</span></span>(<span class="hljs-number"><span class="hljs-number">128</span></span>) , [FileId] <span class="hljs-built_in"><span class="hljs-built_in">VARCHAR</span></span>(<span class="hljs-number"><span class="hljs-number">128</span></span>) , [CreateLSN] <span class="hljs-built_in"><span class="hljs-built_in">VARCHAR</span></span>(<span class="hljs-number"><span class="hljs-number">128</span></span>) , [DropLSN] <span class="hljs-built_in"><span class="hljs-built_in">VARCHAR</span></span>(<span class="hljs-number"><span class="hljs-number">128</span></span>) , [UniqueId] <span class="hljs-built_in"><span class="hljs-built_in">VARCHAR</span></span>(<span class="hljs-number"><span class="hljs-number">128</span></span>) , [ReadOnlyLSN] <span class="hljs-built_in"><span class="hljs-built_in">VARCHAR</span></span>(<span class="hljs-number"><span class="hljs-number">128</span></span>) , [ReadWriteLSN] <span class="hljs-built_in"><span class="hljs-built_in">VARCHAR</span></span>(<span class="hljs-number"><span class="hljs-number">128</span></span>) , [BackupSizeInBytes] <span class="hljs-built_in"><span class="hljs-built_in">VARCHAR</span></span>(<span class="hljs-number"><span class="hljs-number">128</span></span>) , [SourceBlockSize] <span class="hljs-built_in"><span class="hljs-built_in">VARCHAR</span></span>(<span class="hljs-number"><span class="hljs-number">128</span></span>) , [FileGroupId] <span class="hljs-built_in"><span class="hljs-built_in">VARCHAR</span></span>(<span class="hljs-number"><span class="hljs-number">128</span></span>) , [LogGroupGUID] <span class="hljs-built_in"><span class="hljs-built_in">VARCHAR</span></span>(<span class="hljs-number"><span class="hljs-number">128</span></span>) , [DifferentialBaseLSN] <span class="hljs-built_in"><span class="hljs-built_in">VARCHAR</span></span>(<span class="hljs-number"><span class="hljs-number">128</span></span>) , [DifferentialBaseGUID] <span class="hljs-built_in"><span class="hljs-built_in">VARCHAR</span></span>(<span class="hljs-number"><span class="hljs-number">128</span></span>) , [IsReadOnly] <span class="hljs-built_in"><span class="hljs-built_in">VARCHAR</span></span>(<span class="hljs-number"><span class="hljs-number">128</span></span>) , [IsPresent] <span class="hljs-built_in"><span class="hljs-built_in">VARCHAR</span></span>(<span class="hljs-number"><span class="hljs-number">128</span></span>) , [TDEThumbprint] <span class="hljs-built_in"><span class="hljs-built_in">VARCHAR</span></span>(<span class="hljs-number"><span class="hljs-number">128</span></span>) ) <span class="hljs-keyword"><span class="hljs-keyword">INSERT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INTO</span></span> @<span class="hljs-keyword"><span class="hljs-keyword">Table</span></span> EXEC ( <span class="hljs-string"><span class="hljs-string">'RESTORE FILELISTONLY FROM DISK = ''&lt;PATH_TO_BACKUP_FILE&gt;'''</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">DECLARE</span></span> @LogicalNameData <span class="hljs-built_in"><span class="hljs-built_in">varchar</span></span>(<span class="hljs-number"><span class="hljs-number">128</span></span>), @LogicalNameLog <span class="hljs-built_in"><span class="hljs-built_in">varchar</span></span>(<span class="hljs-number"><span class="hljs-number">128</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> @LogicalNameData=(<span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> LogicalName <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> @<span class="hljs-keyword"><span class="hljs-keyword">Table</span></span> <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Type</span></span>=<span class="hljs-string"><span class="hljs-string">'D'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> @LogicalNameLog=(<span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> LogicalName <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> @<span class="hljs-keyword"><span class="hljs-keyword">Table</span></span> <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Type</span></span>=<span class="hljs-string"><span class="hljs-string">'L'</span></span>) EXEC (<span class="hljs-string"><span class="hljs-string">'RESTORE DATABASE [&lt;DBNAME&gt;] FROM DISK = ''&lt;PATH_TO_BACKUP_FILE&gt;'' WITH MOVE '''</span></span>+@LogicalNameData+<span class="hljs-string"><span class="hljs-string">''' TO ''&lt;PATH&gt;\&lt;DBNAME&gt;_Data.mdf'', MOVE '''</span></span>+@LogicalNameLog+<span class="hljs-string"><span class="hljs-string">''' TO ''&lt;PATH&gt;\&lt;DBNAME&gt;_Log.ldf'', REPLACE, PARTIAL'</span></span> ) <span class="hljs-keyword"><span class="hljs-keyword">END</span></span></code> </pre><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">ALTER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DATABASE</span></span> [{<span class="hljs-number"><span class="hljs-number">0</span></span>}] <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> SINGLE_USER <span class="hljs-keyword"><span class="hljs-keyword">WITH</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ROLLBACK</span></span> <span class="hljs-keyword"><span class="hljs-keyword">IMMEDIATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DROP</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DATABASE</span></span> [{<span class="hljs-number"><span class="hljs-number">0</span></span>}]</code> </pre><br>  Some comments for example on GitHub.  To make fixture with a universal database context, you need to pass the connection string and the path to the backup file to the constructor.  You can use the SqlConnectionStringBuilder class to define the database name in the connection string for other scripts, since  create and delete scripts should be run in the context of the [master] database.  If you need to remove the database after some test suite, do it forcibly by calling Dispose ().  It will, of course, be called by xUnit itself, but this is non-deterministic and, perhaps, a little earlier your tests will fall down due to database conflicts. </div><p>Source: <a href="https://habr.com/ru/post/265501/">https://habr.com/ru/post/265501/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../265489/index.html">Co-clustering: Segmentation of data along and across</a></li>
<li><a href="../265491/index.html">We do our iterator</a></li>
<li><a href="../265495/index.html">Corporate immunity: we create a system of centralized management of network security in the company and its branches</a></li>
<li><a href="../265497/index.html">Telegram-like animated placeholder for HTML inputs</a></li>
<li><a href="../265499/index.html">Unstructured data analysis and storage optimization</a></li>
<li><a href="../265503/index.html">Motivational tale for indie game developers</a></li>
<li><a href="../265505/index.html">IBM adds support for Apache Spark for z Systems</a></li>
<li><a href="../265507/index.html">New Memory Profiler in Visual Studio 2015</a></li>
<li><a href="../265509/index.html">Anatomy of the program in memory</a></li>
<li><a href="../265511/index.html">How to make friends JavaFX and Spring Boot</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>