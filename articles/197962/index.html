<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>The introduction of high-performance Pony ORM in the project Django</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="The previous post on performance, described Pony ORM , which showed fantastic results compared to Django ORM and SQLAlchemy. 

 Impressed with such ex...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>The introduction of high-performance Pony ORM in the project Django</h1><div class="post__text post__text-html js-mediator-article">  The previous <a href="http://habrahabr.ru/post/188842/">post</a> on performance, described <a href="http://www.ponyorm.com/">Pony ORM</a> , which showed fantastic results compared to Django ORM and SQLAlchemy. <br><br>  Impressed with such extraordinary results and concerned about the performance of my own project, I decided to implement Pony ORM in my project.  What came out of it, see tackle. <br><br><a name="habracut"></a><br><h4>  The temptations </h4><br>  Of course, you could rewrite the project again.  This temptation always hovers over the developer who has encountered problems whose roots lie in the tool used.  However, the amount of code already written, a huge branched data model, and the impressive number of fully working plug-in applications for Django used in the project put a big and bold cross on this path. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h4>  Alternative </h4><br>  Some time ago, in search of an alternative to Django ORM, I came across an interesting project <a href="https://github.com/Deepwalker/aldjemy">Aldjemy</a> .  This is a small link above Django ORM, which allows you to use the structure of Django models to build an alternative hierarchy of SQLAlchemy models.  This approach makes it possible, while preserving the basis of the project (including the entire Django data model), to use SQLAlchemy precisely and only where you want.  Inspired by the idea of ‚Äã‚Äãthis project <s>and having licked a number of lines of code</s> , I made a <a href="https://github.com/nnseva/djony">similar library</a> for Pony ORM to Django ORM, naming it djony (DJango pONY). <br><br><h4>  Short excursion </h4><br>  Using djony is more than simple.  After installing djony into the system (for example, using the command <code>pip install git+git://github.com/nnseva/djony.git@master#egg=djony</code> ), we can specify djony as one of the used applications in settings.py.  You just need to remember that djony must be the <i>most recent</i> application in the list. <br><br>  Now, each of the Django models (namely, models as classes) has the `p` attribute (from the word pony).  This is the model Pony ORM.  It can be used wherever, <a href="http://doc.ponyorm.com/">according to the</a> Pony <a href="http://doc.ponyorm.com/">documentation</a> , you need to use a model.  You will also need the orm module, you can import it from the pony module ( <code>from pony import orm</code> ).  Alternatively, you can use the djony.orm module, which contains all the variables of the pony.orm module, as well as djony-specific functions and variables. <br><br>  Objects of the Pony ORM models will contain only data fields and collections of objects according to the data model and the structure of relations (perhaps in the future it will be necessary to fasten the ability to add members to the automatically created Pony ORM models). <br><br><h4>  Test </h4><br>  Let us now try to test one of the most popular operations for performance ‚Äî user rights checking. <br><br>  For Django, we will use the out-of-the-box User.has_perm function.  Of course, for Pony ORM you will need to write code approximately equivalent to this function: <br><br><pre> <code class="python hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">has_perm</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(user,perm)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> user.is_active: <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">False</span></span> app_label,codename = perm.split(<span class="hljs-string"><span class="hljs-string">'.'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> p <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> orm.select( p <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> p <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> Permission.p <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (user <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> p.user_set <span class="hljs-keyword"><span class="hljs-keyword">or</span></span> user <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> p.group_set.user_set) <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> p.codename == codename <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> p.content_type.app_label == app_label ): <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">True</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">False</span></span></code> </pre><br><br>  Let's take a look at the test results (for testing, 1000 users were created in the database, performing the role of ballast for the test). <br><br><pre> <code class="hljs pgsql">&gt;&gt;&gt; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> test_pony &gt;&gt;&gt; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> test_django &gt;&gt;&gt; test_django.test_django() <span class="hljs-keyword"><span class="hljs-keyword">check</span></span> <span class="hljs-keyword"><span class="hljs-keyword">user</span></span> permissions: django req/seq: <span class="hljs-number"><span class="hljs-number">170.308759221</span></span> req <span class="hljs-type"><span class="hljs-type">time</span></span> (ms): <span class="hljs-number"><span class="hljs-number">5.8716886</span></span> &gt;&gt;&gt; test_pony.test_pony() <span class="hljs-keyword"><span class="hljs-keyword">check</span></span> <span class="hljs-keyword"><span class="hljs-keyword">user</span></span> permissions: pony req/seq: <span class="hljs-number"><span class="hljs-number">729.517146462</span></span> req <span class="hljs-type"><span class="hljs-type">time</span></span> (ms): <span class="hljs-number"><span class="hljs-number">1.3707697</span></span></code> </pre><br><br>  As you can see, we have received an increase of more than 4 times.  Not bad! <br><br><h4>  Application.  Test code. </h4><br><br><h5>  test_django.py </h5><br><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> datetime <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> django.contrib.auth.models <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> User <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">test_django</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function">:</span></span> t1 = datetime.datetime.now() <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> i <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> range(<span class="hljs-number"><span class="hljs-number">10000</span></span>): test() t2 = datetime.datetime.now() <span class="hljs-keyword"><span class="hljs-keyword">print</span></span> <span class="hljs-string"><span class="hljs-string">"check user permissions: django req/seq:"</span></span>,<span class="hljs-number"><span class="hljs-number">10000</span></span>/(t2-t1).total_seconds(),<span class="hljs-string"><span class="hljs-string">'req time (ms):'</span></span>,(t2-t1).total_seconds()/<span class="hljs-number"><span class="hljs-number">10.</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">test</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function">:</span></span> user = User.objects.get(username=<span class="hljs-string"><span class="hljs-string">'testuser'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> user.has_perm(<span class="hljs-string"><span class="hljs-string">'auth.add_user'</span></span>)</code> </pre><br><br><h5>  test_pony.py </h5><br><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> datetime <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> django.contrib.auth.models <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> User, Permission <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">test_pony</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function">:</span></span> t1 = datetime.datetime.now() <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> i <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> range(<span class="hljs-number"><span class="hljs-number">10000</span></span>): test() t2 = datetime.datetime.now() <span class="hljs-keyword"><span class="hljs-keyword">print</span></span> <span class="hljs-string"><span class="hljs-string">"check user permissions: pony req/seq:"</span></span>,<span class="hljs-number"><span class="hljs-number">10000</span></span>/(t2-t1).total_seconds(),<span class="hljs-string"><span class="hljs-string">'req time (ms):'</span></span>,(t2-t1).total_seconds()/<span class="hljs-number"><span class="hljs-number">10.</span></span> <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> djony <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> orm @orm.db_session <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">test</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function">:</span></span> user = User.p.get(username=<span class="hljs-string"><span class="hljs-string">'testuser'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> has_perm(user,<span class="hljs-string"><span class="hljs-string">'auth.add_user'</span></span>) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">has_perm</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(user,perm)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> user.is_active: <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">False</span></span> app_label,codename = perm.split(<span class="hljs-string"><span class="hljs-string">'.'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> p <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> orm.select( p <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> p <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> Permission.p <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (user <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> p.user_set <span class="hljs-keyword"><span class="hljs-keyword">or</span></span> user <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> p.group_set.user_set) <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> p.codename == codename <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> p.content_type.app_label == app_label ): <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">True</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">False</span></span></code> </pre></div><p>Source: <a href="https://habr.com/ru/post/197962/">https://habr.com/ru/post/197962/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../197946/index.html">Some myths about open access to science (Open Access)</a></li>
<li><a href="../197948/index.html">Scheduled work on the site Payoneer October 19</a></li>
<li><a href="../197950/index.html">Aviate - a new adaptive launcher (+ invite)</a></li>
<li><a href="../197956/index.html">FlyKly - smart bike wheel</a></li>
<li><a href="../197960/index.html">Test of the world's first window cleaning robot Windoro</a></li>
<li><a href="../197964/index.html">The history of "Silk Road" gets on the big screen</a></li>
<li><a href="../197970/index.html">Fresh results of Techempower framework performance testing became available.</a></li>
<li><a href="../197972/index.html">Windows 8.1 in release</a></li>
<li><a href="../197974/index.html">Investigation of the method of principal components and linear discriminant analysis on the change in the angle and conditions of the person‚Äôs illumination as an object of recognition</a></li>
<li><a href="../197976/index.html">Windows 8.1 and Visual Studio 2013 are available for download.</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>