<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Message Passing in F #. Application MailboxProcessor</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="This article continues a series of publications about the technologies that we use to develop the HostTracker web accessibility service . 
 Today we w...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Message Passing in F #. Application MailboxProcessor</h1><div class="post__text post__text-html js-mediator-article">  This article continues a series of publications about the technologies that we use to develop the <a href="http://www.host-tracker.com/">HostTracker</a> web accessibility <a href="http://www.host-tracker.com/">service</a> . <br>  Today we will talk about ... <br><br><h5>  <b>Mailboxprocessor</b> </h5><br><br><img src="https://habrastorage.org/files/1a2/31f/a32/1a231fa32c064707830b814932190b5a.png" alt="image">
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <a name="habracut"></a><br><br>  MailboxProcessor is a class that allows you to create an agent in the F # language, which consists of two parts - a message queue and a function that processes messages from a queue.  It provides the following interaction interface: <br><br>  ‚Ä¢ <b>Post</b> ‚Äî send the message 'msg to the processor queue asynchronously, without waiting for it to be processed; <br><br>  ‚Ä¢ <b>PostAndReply: (msgBuilder: AsyncReplyChannel &lt;'reply&gt; -&gt;' msg) -&gt; 'reply</b> - send a message with an asynchronous channel waiting for the AsyncReplyChannel result.  The thread that called this method waits for a call to AsyncReplyChannel.Reply: 'reply -&gt; unit from the message handler from the queue to get the result.  msgBuilder is a lambda function that composes a message from a channel; <br><br>  ‚Ä¢ <b>PostAndAsyncReply: (msgBuilder: AsyncReplyChannel &lt;'reply&gt; -&gt;' msg) -&gt; Async &lt;'reply&gt;</b> is similar to PostAndReply, but the result is not waiting.  An asynchronous calculation is returned, the result of which is the value passed to AsyncReplyChannel.Reply.  The client decides how to expect the result - by giving the current thread to the pool or blocking it; <br><br>  ‚Ä¢ <b>TryPostAndReply: (msgBuilder: AsyncReplyChannel &lt;'reply&gt; -&gt;' msg) *? Timeout: int -&gt; 'reply option</b> is similar to PostAndReply, but the wait occurs within timeout milliseconds.  If the result is obtained during this time, then the method returns Some (result).  Otherwise, it returns None; <br><br>  ‚Ä¢ <b>PostAndTryAsyncReply: (msgBuilder: AsyncReplyChannel &lt;'reply&gt; -&gt;' msg) *? Timeout: int -&gt; Async &lt;'reply option&gt;</b> - similar to TryPostAndReply, but the method returns asynchronous calculation; <br><br>  ‚Ä¢ <b>Receive: unit -&gt; Async &lt;'msg&gt;;</b>  <b>TryReceive: timeout: int -&gt; Async &lt;'msg option&gt;</b> - asynchronous calculations that return a message to the queue in the FIFO order (TryReceive - asynchronous calculations that wait for timeout milliseconds to the message and return Some (msg) if it came to given time period, and None if not).  It is used mainly on the side of the message handler and very rarely on the client side; <br><br>  ‚Ä¢ <b>Scan: (scanner: 'msg -&gt; Async &lt;' T&gt; option) -&gt; Async &lt;'T&gt;;</b>  <b>TryScan: (scanner: 'msg -&gt; Async &lt;' T&gt; option) *? Timeout: int -&gt; Async &lt;'T option&gt;</b> - return asynchronous calculations that will check the message queue for the presence of such a message for which the scanner can build asynchronous calculations.  For Scan, calculations created using the scanner will be executed after it has been built, and the result will be the result of an asynchronous calculation that Scan returns.  TryScan is set to scan the queue.  If during this time the scanner builds the calculations, they will be executed and their result will be the result of the asynchronous calculation created by TryScan.  Otherwise, the asynchronous calculation will return None. <br><br>  The lambda function, which generates asynchronous calculations that the agent will perform, takes part in the formation of the MailboxProcessor.  This function takes as a parameter the processor itself, which allows the above-described interface for interacting with the queue to be used in the created calculation (the methods PostAndReply, often Post, Receive, Scan are used very rarely).  Thus, the queue is processed by asynchronous computing.  The client built by the processor uses the same interface to interact with the message queue, but usually (in most scenarios) the execution of the Receive and Scan methods on its side does not occur. <br><br>  Using MailboxProcessor: <br><br>  ‚Ä¢ Caches (caches) of data when working with their repositories (SQL databases, ...).  Regardless of the type of storage, the application often has the task of accessing data according to certain criteria (usually by record identifier).  This can lead to a noticeable decrease in system performance.  The solution based on MaiboxProcessor is given in the following code: <br><br><pre><code class="hljs haskell">//  : // <span class="hljs-type"><span class="hljs-type">GetFromCache</span></span>: id -   - generic // <span class="hljs-type"><span class="hljs-type">AsyncReplyChannel</span></span>&lt;<span class="hljs-type"><span class="hljs-type">Choice</span></span>&lt;'res, exn&gt;&gt; -      // <span class="hljs-type"><span class="hljs-type">ClearCache</span></span> -   <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">type</span></span></span><span class="hljs-class"> cacheCommands&lt;'id,'res&gt; = | </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">GetFromCache</span></span></span><span class="hljs-class"> of 'id * </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">AsyncReplyChannel</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Choice</span></span></span><span class="hljs-class">&lt;'res, exn&gt;&gt; | </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ClearCache</span></span></span><span class="hljs-class"> //  </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Cache</span></span></span><span class="hljs-class">  </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">MailboxProcessor</span></span></span><span class="hljs-class"> // getById -          // cleanupCacheInterval -    </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">type</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Cache</span></span></span><span class="hljs-class">&lt;'itemId,'item when 'itemId : comparison &gt; (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">getById</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">cleanupCacheInterval</span></span></span><span class="hljs-class">) = // </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">MailboxProcessor</span></span></span><span class="hljs-class">     let inbox = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">MailboxProcessor</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Start</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">fun</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">inbox</span></span></span><span class="hljs-class"> -&gt; //      // </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">cache</span></span></span><span class="hljs-class"> -   - </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Map</span></span></span><span class="hljs-class"> -  </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">id</span></span></span><span class="hljs-class">   </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">let</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">rec</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">loop</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">cache</span></span></span><span class="hljs-class"> = </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">async</span></span></span><span class="hljs-class"> { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">let</span></span></span><span class="hljs-class">! </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">res</span></span></span><span class="hljs-class"> = </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">inbox</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Receive</span></span></span><span class="hljs-class">() //   // </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">MailboxProcessor</span></span></span><span class="hljs-class">      match res with | </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">GetFromCache</span></span></span><span class="hljs-class"> (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">itemId</span></span></span><span class="hljs-class">:'</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">itemId</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">rc</span></span></span><span class="hljs-class">) -&gt; let (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">item</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">cache'</span></span></span><span class="hljs-class">)= match </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Map</span></span></span><span class="hljs-class">.tryFind itemId cache with | </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">None</span></span></span><span class="hljs-class"> -&gt; //   try match getById itemId with | </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">None</span></span></span><span class="hljs-class"> -&gt; (</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Choice2Of2</span></span></span><span class="hljs-class">(</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">KeyNotFoundException</span></span></span><span class="hljs-class">() :&gt; exn), cache) | </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Some</span></span></span><span class="hljs-class"> (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">item</span></span></span><span class="hljs-class">:'</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">item</span></span></span><span class="hljs-class">) -&gt; (</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Choice1Of2(item)</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Map</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">add</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">itemId</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">item</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">cache</span></span></span><span class="hljs-class">) with exc -&gt; (</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Choice2Of2(exc)</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">cache</span></span></span><span class="hljs-class">) | </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Some</span></span></span><span class="hljs-class"> item -&gt; //   (</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Choice1Of2(item)</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">cache</span></span></span><span class="hljs-class">) rc.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Reply</span></span></span><span class="hljs-class"> item //  return! loop cache' //     | </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ClearCache</span></span></span><span class="hljs-class"> -&gt; return! loop </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Map</span></span></span><span class="hljs-class">.empty //   } loop </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Map</span></span></span><span class="hljs-class">.empty) //      let rec runCleanupCicle () = async { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">do</span></span></span><span class="hljs-class">! </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Async</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Sleep</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">cleanupCacheInterval</span></span></span><span class="hljs-class"> //   </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">inbox</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Post</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ClearCache</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">return</span></span></span><span class="hljs-class">! </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">runCleanupCicle</span></span></span><span class="hljs-class"> () } do if cleanupCacheInterval &gt; 0 then runCleanupCicle () |&gt; </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Async</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Start</span></span></span><span class="hljs-class"> with //  member x.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">TryGet</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">itemId</span></span></span><span class="hljs-class">) = match inbox.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">PostAndReply</span></span></span><span class="hljs-class">( </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">fun</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">rc</span></span></span><span class="hljs-class"> -&gt; </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">GetFromCache</span></span></span><span class="hljs-class"> (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">itemId</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">rc</span></span></span><span class="hljs-class">) ) with | </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Choice1Of2</span></span></span><span class="hljs-class"> item -&gt; </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Some</span></span></span><span class="hljs-class"> item | _ -&gt; </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">None</span></span></span><span class="hljs-class"> member x.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Get</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">itemId</span></span></span><span class="hljs-class">) = match inbox.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">PostAndReply</span></span></span><span class="hljs-class">( </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">fun</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">rc</span></span></span><span class="hljs-class"> -&gt; </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">GetFromCache</span></span></span><span class="hljs-class"> (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">itemId</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">rc</span></span></span><span class="hljs-class">) ) with | </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Choice1Of2</span></span></span><span class="hljs-class"> item -&gt; item | </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Choice2Of2</span></span></span><span class="hljs-class"> e -&gt; raise e member x.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Cleanup</span></span></span><span class="hljs-class">() = inbox.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Post</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ClearCache</span></span></span></span></code> </pre> <br><br>  Another problem occurs when the operation of modifying data in the repository (insert, delete, update).  Such operations are optimally grouped (batch mode).  To do this, you can implement cache grouping data from different streams: <br><br><pre> <code class="hljs pgsql">//  : // Save:     // SaveToDB:     // UpdateSaveState:         <span class="hljs-keyword"><span class="hljs-keyword">type</span></span> commandsSave&lt;<span class="hljs-string"><span class="hljs-string">'itemId, '</span></span>item <span class="hljs-keyword"><span class="hljs-keyword">when</span></span> <span class="hljs-string"><span class="hljs-string">'itemId: comparison&gt; = | Save of '</span></span>itemId * <span class="hljs-string"><span class="hljs-string">'item | SaveToDB | UpdateSaveState of (Map&lt;'</span></span>itemId, <span class="hljs-string"><span class="hljs-string">'item&gt; -&gt; Map&lt;'</span></span>itemId, <span class="hljs-string"><span class="hljs-string">'item&gt;) // saveToDB -       Map&lt;'</span></span>itemId, <span class="hljs-string"><span class="hljs-string">'item&gt; // savingInterval -     type SavingCache&lt;'</span></span>itemId, <span class="hljs-string"><span class="hljs-string">'item when '</span></span>itemId : comparison&gt;(saveToDB, savingInterval) = let inbox = MailboxProcessor.<span class="hljs-keyword"><span class="hljs-keyword">Start</span></span>( fun inbox -&gt; //    let rec <span class="hljs-keyword"><span class="hljs-keyword">loop</span></span> <span class="hljs-keyword"><span class="hljs-keyword">cache</span></span> = async{ let! msg = inbox.Receive() let <span class="hljs-keyword"><span class="hljs-keyword">cache</span></span>' = match msg with | Save (key: 'itemId, value: 'item) -&gt; Map.add key value <span class="hljs-keyword"><span class="hljs-keyword">cache</span></span> //    | SaveToDB -&gt; saveToDB <span class="hljs-keyword"><span class="hljs-keyword">cache</span></span> Map.empty | UpdateSaveState updater -&gt; updater <span class="hljs-keyword"><span class="hljs-keyword">cache</span></span> //     updater ( Save -  ) return! loop <span class="hljs-keyword"><span class="hljs-keyword">cache</span></span>' } loop Map.empty ) //    let rec runCleanSaveCicle () = async{ do! Async.Sleep savingInterval inbox.Post(SaveToDB) return! runCleanSaveCicle() } do if savingInterval &gt; <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> runCleanSaveCicle() |&gt; Async.<span class="hljs-keyword"><span class="hljs-keyword">Start</span></span> <span class="hljs-keyword"><span class="hljs-keyword">with</span></span> member x.Save(itemId, item) = inbox.Post( Save (itemId, item) ) member x.UpdateBy f = inbox.Post &lt;| UpdateSaveState f</code> </pre><br><br>  ‚Ä¢ MailboxProcessor is a state machine that has at least one state.  For a set of states, the number of which is more than one, for each of them is determined by the set of messages that can be processed.  During the processing of a particular message, it is possible to switch to another state.  The lambda function, which is passed to the MailboxProcessor constructor, defines a set of asynchronous recursive calculations, one for each state of the machine.  In each calculation, one message is waited from among all possible ones from the queue (Receive), or a specific subset of messages (Scan).  After waiting, processing takes place, in which a transition to a calculation for another state of the machine, continuation of work with the current state or completion of work is possible.  The following is an example - a proxy for working with a remote agent.  The states working, stoped, recovery are defined.  All messages are presented in the form of the RemoteAgentProxyCommand type: <br><br><pre> <code class="hljs pgsql">// ProcessData -   // Reconfigure - // <span class="hljs-keyword"><span class="hljs-keyword">type</span></span> private RemoteAgentProxyCommand&lt;<span class="hljs-string"><span class="hljs-string">'data, '</span></span>result&gt; = | ProcessData <span class="hljs-keyword"><span class="hljs-keyword">of</span></span> <span class="hljs-string"><span class="hljs-string">'data * ('</span></span>result <span class="hljs-keyword"><span class="hljs-keyword">option</span></span> -&gt; unit) | Reconfigure <span class="hljs-keyword"><span class="hljs-keyword">of</span></span> string | Suspend | Resume | CleanupExpiredData <span class="hljs-keyword"><span class="hljs-keyword">type</span></span> RemoteAgentProxy&lt;<span class="hljs-string"><span class="hljs-string">'data, '</span></span>result&gt;(transport, ?cleanupInterval) = let cleanupInterval = defaultArg cleanupInterval <span class="hljs-number"><span class="hljs-number">60000</span></span> let processor = MailboxProcessor.<span class="hljs-keyword"><span class="hljs-keyword">Start</span></span>(fun inbox -&gt; let cleanup state now = ‚Ä¶//  let send state = async { ‚Ä¶ } //    //   let rec working (state: Map&lt;_, _&gt;) = async { let! msgOpt = inbox.TryReceive(<span class="hljs-number"><span class="hljs-number">1000</span></span>) //    <span class="hljs-number"><span class="hljs-number">1</span></span>  let now = DateTime.UtcNow match msgOpt <span class="hljs-keyword"><span class="hljs-keyword">with</span></span> | <span class="hljs-keyword"><span class="hljs-keyword">None</span></span> <span class="hljs-keyword"><span class="hljs-keyword">when</span></span> state.Count = <span class="hljs-number"><span class="hljs-number">0</span></span> -&gt; //c       <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>! working state //     | <span class="hljs-keyword"><span class="hljs-keyword">None</span></span> -&gt; //        let nextStateHandler = //    async { try let! stat<span class="hljs-string"><span class="hljs-string">e' = send state //     return! working state'</span></span> //    -     <span class="hljs-keyword"><span class="hljs-keyword">with</span></span> e -&gt; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>! recovery(state, <span class="hljs-number"><span class="hljs-number">10000</span></span>) //   -     } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>! nextStateHandler | <span class="hljs-keyword"><span class="hljs-keyword">Some</span></span> CleanupExpiredData -&gt; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>! working (cleanup state now) //  | <span class="hljs-keyword"><span class="hljs-keyword">Some</span></span> (ProcessData (data, channelReply)) -&gt; //     let expiration = DateTime.UtcNow.AddMilliseconds(<span class="hljs-type"><span class="hljs-type">float</span></span> cleanupInterval) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>! working (Map.<span class="hljs-keyword"><span class="hljs-keyword">add</span></span> (Guid.NewGuid()) (expiration, data, channelReply) state) | <span class="hljs-keyword"><span class="hljs-keyword">Some</span></span> Suspend -&gt; //   <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>! stoped (working state) //   stoped | <span class="hljs-keyword"><span class="hljs-keyword">Some</span></span> _ -&gt; //   <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>! working state } <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> stoped nextStateHandler = inbox.Scan(<span class="hljs-keyword"><span class="hljs-keyword">function</span></span> | Resume -&gt; <span class="hljs-keyword"><span class="hljs-keyword">Some</span></span>(nextStateHandler) | _ -&gt; <span class="hljs-keyword"><span class="hljs-keyword">None</span></span>) //  Resume <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> recovery(state, timeToRecieve) = async { //  let! nextTimeToRecieve = <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> timeToRecieve &lt;= <span class="hljs-number"><span class="hljs-number">100</span></span> <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> async { try let! stat<span class="hljs-string"><span class="hljs-string">e' = send state return Choice1Of2 state'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">with</span></span> e -&gt; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> Choice2Of2 <span class="hljs-number"><span class="hljs-number">10000</span></span> } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> async.<span class="hljs-keyword"><span class="hljs-keyword">Return</span></span> &lt;| Choice2Of2 timeToRecieve match nextTimeToRecieve <span class="hljs-keyword"><span class="hljs-keyword">with</span></span> | Choice1Of2 state -&gt; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>! working state | Choice2Of2 <span class="hljs-type"><span class="hljs-type">time</span></span> -&gt; let nextDateTime = DateTime.UtcNow.AddMilliseconds(<span class="hljs-type"><span class="hljs-type">float</span></span> <span class="hljs-type"><span class="hljs-type">time</span></span>) let! msg = inbox.TryReceive(timeToRecieve) let now = DateTime.UtcNow let nextTime = <span class="hljs-type"><span class="hljs-type">int</span></span> (nextDateTime - now).TotalMilliseconds match msg <span class="hljs-keyword"><span class="hljs-keyword">with</span></span> | <span class="hljs-keyword"><span class="hljs-keyword">Some</span></span> (ProcessData (data, channelReply)) -&gt; channelReply <span class="hljs-keyword"><span class="hljs-keyword">None</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>! recovery(state, nextTime) | <span class="hljs-keyword"><span class="hljs-keyword">Some</span></span> CleanupExpiredData -&gt; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>! recovery (cleanup state now, nextTime) | <span class="hljs-keyword"><span class="hljs-keyword">Some</span></span> Suspend -&gt; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>! stoped (recovery(state, nextTime)) | <span class="hljs-keyword"><span class="hljs-keyword">None</span></span> -&gt; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>! recovery(state, <span class="hljs-number"><span class="hljs-number">0</span></span>) | _ -&gt; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>! recovery(state, nextTime) } working Map.empty)</code> </pre><br><br>  ‚Ä¢ MailboxProcessor can be used to organize an asynchronous reusable data channel.  Its purpose is to transfer data from one part of the application to another (transmission is possible between different streams), while not rigidly linking these parts.  A channel is a tuple of two functions: functions for sending data and functions for waiting to receive them without blocking the stream: <br><br><pre> <code class="hljs haskell"><span class="hljs-title"><span class="hljs-title">let</span></span> <span class="hljs-type"><span class="hljs-type">CreateAsyncChannel</span></span>&lt;'a&gt; () = //'a -       //<span class="hljs-type"><span class="hljs-type">MailboxProcessor</span></span>     <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> inbox = new <span class="hljs-type"><span class="hljs-type">MailboxProcessor</span></span>&lt;_&gt;( fun inbox -&gt; //     <span class="hljs-type"><span class="hljs-type">AsyncReplyChannel</span></span>   <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> <span class="hljs-keyword"><span class="hljs-keyword">rec</span></span> waitResponse (repl:<span class="hljs-type"><span class="hljs-type">AsyncReplyChannel</span></span>&lt;'a*bool&gt;) = inbox.<span class="hljs-type"><span class="hljs-type">Scan</span></span> &lt;| function | <span class="hljs-type"><span class="hljs-type">GetResult</span></span> repl -&gt; //   <span class="hljs-type"><span class="hljs-type">AsyncReplyChannel</span></span>    -   <span class="hljs-type"><span class="hljs-type">Some</span></span> &lt;| waitResponse repl | <span class="hljs-type"><span class="hljs-type">IntermediateResult</span></span> res -&gt; //    repl.<span class="hljs-type"><span class="hljs-type">Reply</span></span> (res, false) <span class="hljs-type"><span class="hljs-type">Some</span></span> &lt;| waitRepl () | <span class="hljs-type"><span class="hljs-type">Result</span></span> res -&gt; //    repl.<span class="hljs-type"><span class="hljs-type">Reply</span></span> (res, true) <span class="hljs-type"><span class="hljs-type">Some</span></span> &lt;| async.<span class="hljs-type"><span class="hljs-type">Return</span></span> () and waitRepl () = //   -     <span class="hljs-type"><span class="hljs-type">GetResult</span></span> //         //repl -     inbox.<span class="hljs-type"><span class="hljs-type">Scan</span></span> &lt;| function | <span class="hljs-type"><span class="hljs-type">GetResult</span></span> repl -&gt; <span class="hljs-type"><span class="hljs-type">Some</span></span> &lt;| waitResponse repl | _ -&gt; <span class="hljs-type"><span class="hljs-type">None</span></span> waitRepl () ) inbox.<span class="hljs-type"><span class="hljs-type">Start</span></span>() //    resultWaiter -   <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> resultWaiter timeout = inbox.<span class="hljs-type"><span class="hljs-type">PostAndTryAsyncReply</span></span> ((fun replChannel -&gt; <span class="hljs-type"><span class="hljs-type">GetResult</span></span> replChannel), timeout) //    postResult -    //     <span class="hljs-type"><span class="hljs-type">MailboxProcessor</span></span> <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> postResult closeChannel = <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> closeChannel <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> <span class="hljs-type"><span class="hljs-type">Result</span></span> <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-type"><span class="hljs-type">IntermediateResult</span></span> &gt;&gt; inbox.<span class="hljs-type"><span class="hljs-type">Post</span></span> (resultWaiter, postResult)</code> </pre><br><br>  Thus, based on MailboxProcessor, you can build a system of independent components, each of which owns its own resources and provides a thread-safe interface to others.  The next article will discuss the features of building a state machine based on the TPL Dataflow library. <br><br></div><p>Source: <a href="https://habr.com/ru/post/236325/">https://habr.com/ru/post/236325/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../236315/index.html">Bookmarklet: analysis of essential points, part two, loadable</a></li>
<li><a href="../236317/index.html">Zenfone 4 Review</a></li>
<li><a href="../236319/index.html">New features of Google Search in site links</a></li>
<li><a href="../236321/index.html">Formula E: Electric Car Racing</a></li>
<li><a href="../236323/index.html">Thermostat Nest has become even smarter</a></li>
<li><a href="../236329/index.html">We automate assembly of system</a></li>
<li><a href="../236331/index.html">Microsoft released a set of updates, September 2014</a></li>
<li><a href="../236333/index.html">Statements by the Free Software Foundation and Defective By Design regarding the latest Apple press conference.</a></li>
<li><a href="../236335/index.html">News from the world of Node: DataCollection.js, Supererror, Readability</a></li>
<li><a href="../236337/index.html">First look at the design of the new standard WordPress theme "Twenty Fifteen"</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>