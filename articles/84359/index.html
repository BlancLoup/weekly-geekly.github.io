<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>iPhone development: Integrating In-App Purchases</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="In-App Purchases is a simple and convenient mechanism for organizing sales of your applications or additional features directly from your application....">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>iPhone development: Integrating In-App Purchases</h1><div class="post__text post__text-html js-mediator-article">  <strong>In-App Purchases</strong> is a simple and convenient mechanism for organizing sales of your applications or additional features directly from your application.  In-App Purchases are easy to integrate and open a new sales channel for you.  Interaction with the App Store is carried out using StoreKit.framework, which comes with the SDK, starting with version 3.0. <br><a name="habracut"></a><br><br><h2>  <strong>general information</strong> </h2><br>  In-App Purchases are of three types: <br><ul><li>  Consumables </li><li>  Non-consumeries </li><li>  Subscriptions </li></ul><br>  <strong>Consumable</strong> - consumed type.  Purchase of this type can be bought several times.  For example, in an <a href="http://itunes.apple.com/us/app/eliminate-pro/id318760264%3Fmt%3D8">Eliminate</a> game, a player buys energy, which is wasted over time and you have to buy it again, or wait three hours until energy is restored. <br><br>  <strong>Non-Consumable</strong> - non-consumable type.  Purchase is bought only once.  It is usually used to unlock new themes, additional levels, etc. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      <strong>Subscription</strong> is a subscription to something.  For example, you can write an iPhone application for a Web service, in which there is a Premium account that opens up additional features.  With Subscription, you can activate your account, say, for a month or a year. <br><br>  In-App Purchases can be implemented using two models: <br><ul><li>  Built-in model </li><li>  Server model </li></ul><br>  <strong>The built-in model</strong> allows you to unlock features.  Typically, the use of this model encourages developers to embed them in the application in advance.  With this implementation, StoreKit is only responsible for paying for features.  In general, with the help of StoreKit we can find out whether the purchase has passed or not. <br><br>  <strong>The server model</strong> is more flexible.  Three entities take part in the model: an iPhone application, an Apple server and our server.  All new features are stored on our server, so there is no need to update the application when adding new features or products.  The model works as follows: <br><ol><li>  The iPhone application requests a list of products from its server. </li><li>  The iPhone application displays new products to the user, </li><li>  User buys (or does not buy :)) </li><li>  The iPhone application requests a purchase from the Apple server through StoreKit, </li><li>  StoreKit returns the answer. </li><li>  iPhone application sends the answer to your server </li><li>  The answer is checked again (it is sure to check that the answer came from Apple), </li><li>  After that, the iPhone application downloads a new product from its server. </li></ol><br>  In this post, the built-in model is considered. <br><br><h2>  Implementation </h2><br>  I will demonstrate the work of the built-in In-App Purchases model using the AppPurchasesExample test example.  This is a small iPhone application with 3 windows.  The first (it‚Äôs the main) window will be available to the user by default.  This window will contain information about the other two windows, which can only be unlocked for money. <br><br><h3>  Step 1. Create App ID </h3><br>  Go to the <a title="iPhone Developer Program Portal" href="http://developer.apple.com/iphone/">iPhone Developer Program Portal</a> and open the App IDs tab: <br><br> <a href=""><img title="App ID" src="https://habrastorage.org/getpro/habr/post_images/e44/0ad/c7c/e440adc7c0657848c9b0ad0207e8f434.png" width="300" height="220"></a> <br><br>  In the upper right corner of the screen, click New App ID.  Then we enter information about the application.  For my example, I filled out a form like this: <br><br> <a href=""><img title="App ID" src="https://habrastorage.org/getpro/habr/post_images/8e1/320/65e/8e132065ee4bed96cae26a34e76d9f6c.png" width="252" height="300"></a> <br><br>  To create a Bundle Identifier, Apple recommends using the <a title="Reverse DNS" href="http://en.wikipedia.org/wiki/Reverse-DNS">Reverse DNS</a> notation, which guarantees the uniqueness of your Identifier and will save you from further problems when publishing an application.  <strong>It is very important</strong> not to use the '*' symbol in the Bundle Identifier.  If you enter 'com.wordpress.indiedevelop. *', Then In-App Purchases will not work. <br><br>  Next you need to enable In App Purchases for the App ID.  In the App IDs list, opposite the desired Bundle Identifier in the Action column, click Configure.  The Configure App ID form will appear, on which you must enable the checkbox 'Enable In App Purchase'. <br><br> <a href=""><img title="Enable In App Purchase" src="https://habrastorage.org/getpro/habr/post_images/7ac/0c7/0bf/7ac0c70bfdcf0b925cc4c03ecac5048e.png" width="300" height="270"></a> <br><br><h3>  Step 2. Creating a Development Profile </h3><br><ol><li>  In the left column, click on 'Provisioning' and go to the 'Development' tab. </li><li>  Click 'New Profile' and fill in all the necessary information.  The Profile Name field can be any (I recorded 'InAppPurchasesExample Dev'). </li><li>  In the list that appears, the profile created has a pending status.  You need to refresh the page, or go to another tab and back, then the profile will be available for download. </li><li>  Profile can be downloaded and installed in xCode.  To install, simply click on the profile by double-clicking, or drag the profile to the xCode icon. </li></ol><br>  If the profile was installed correctly, then Organizer will open in xCode and you will see something like the following: <br><br> <a href=""><img title="xCode Organizer" src="https://habrastorage.org/getpro/habr/post_images/834/4fc/48e/8344fc48ebfe79f0d0343b45d281036f.png" width="300" height="81"></a> <br><br><h3>  Step 3. Create an application in iTunes Connect </h3><br>  In order to test our in-app purchase app, you need to create it in iTunes Connect.  To do this: <br><ol><li>  You need to go to <a title="iTunes Connect" href="https://itunesconnect.apple.com/">iTunes Connect</a> and click on 'Manage Your Applications-&gt; Add New Application'. </li><li>  To the question "Does your product contain encryption?"  answer in the negative. </li><li>  Fill out the form where you need to specify the application name, description, version number, category, etc.  Everything is quite trivial.  Difficulties can cause unless the field 'SKU Number'.  This field must be unique, I entered 'IAPEX' in it (short for In-App Purchases Example). </li><li>  On the form 'Upload' you must set the flag 'Upload application binary later'.  All other parameters and forms for the test example have no meaning. </li></ol><br><br><h3>  Step 4. Create In-App Purchases in iTunes Connect </h3><br><ol><li>  In iTunes Connect, click on 'Manage Your In App Purchases-&gt; Create New' and select the desired application. </li><li>  Choose a Bundle ID and fill in the Purchase information (type, name, price, etc.). You also need to enter a 'Product ID', which can be arbitrary, but I advise you to use Reverse DNS.  It is best to form the Product ID from the Bund ID of your application and the name of the feature.  For my example, it looks like this: </li></ol><br> <a href=""><img title="In App Product" src="https://habrastorage.org/getpro/habr/post_images/02d/86f/262/02d86f2629247e6aea0746f9e212a7c3.png" width="300" height="108"></a> <br><br>  For the test application, I created two In-App products with Product Id 'com.wordpress.indiedevelop.InAppPurchasesExample.f1' and 'com.wordpress.indiedevelop.InAppPurchasesExample.f2'.  Both features with type Non-Consumables. <br><br><h3>  Step 5. Creating a test user </h3><br>  To test In-App Purchases, you must create at least one test user.  This is done simply: <br><ol><li>  In iTunes Connect, you must go to the 'Manage Users-&gt; In App Purchase Test User' </li><li>  Click 'Add New User' </li><li>  Enter user information </li></ol><br>  User email does not have to be real.  For my example, I created one test user: <br><br> <a href=""><img title="Test user" src="https://habrastorage.org/getpro/habr/post_images/603/4cb/b71/6034cbb71667b41dd4ff55f37fabd344.png" width="300" height="280"></a> <br><br>  <strong>An important point.</strong>  If you have not completed a contract with Apple, then in-app purchase will not work for you.  In order to complete the contract, you must specify Contact Info, Bank Info and Tax Info. <br><br><h3>  Step 6. Programming </h3><br>  For my test case, I created a project framework and User Interface: <br><br> <a href=""><img title="User interface" src="https://habrastorage.org/getpro/habr/post_images/c51/e24/c03/c51e24c0328f1d3b19cb98deaddadded.png" width="216" height="300"></a> <br><br>  To work with the App Store, I recommend using <a href="http://blog.mugunthkumar.com/coding/iphone-tutorial-%25E2%2580%2593-in-app-purchases/">MKStoreKit</a> , developed in 2009 by developer Kumar (Mugunth Kumar).  This set of classes will greatly facilitate the work with StoreKit.  In addition to MKStoreKit, StoreKit.framework must be added to the project. <br><br>  In my example, I use the slightly modernized first MKStoreKit.  For convenience, I added the following delegate to the MKStoreManager class: <br><br><blockquote><code><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="black">@protocol MKStoreKitDelegate @optional <br> - ( <font color="#0000ff">void</font> )productAPurchased; <br> - ( <font color="#0000ff">void</font> )productBPurchased; <br> - ( <font color="#0000ff">void</font> )failed; <br> @end</font> <br> <br> <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></code> </blockquote> <br><br>  A message is sent to the delegate by productAPurchased when feature 1 is purchased, productBPurchased ‚Äî when feature 2 is purchased, and failed ‚Äî when the user either canceled the purchase or the purchase failed. <br><br>  Class- <a href="http://en.wikipedia.org/wiki/Singleton_pattern">Singleton</a> MKStoreManager is primary in MKStoreKit.  This is what his announcement looks like: <br><br><blockquote> <code><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="black">@ <font color="#0000ff">interface</font> MKStoreManager : NSObject&lt;SKProductsRequestDelegate&gt; { <br> ... <br> } <br> <br> <font color="#008000">// </font> <br> @property (nonatomic, retain) id&lt;MKStoreKitDelegate&gt; <font color="#0000ff">delegate</font> ; <br> <font color="#008000">// ,   </font> <br> @property (nonatomic, retain) NSMutableArray *purchasableObjects; <br> <br> <font color="#008000">//    Singleton</font> <br> + (MKStoreManager*)sharedManager; <br> <br> <font color="#008000">//    </font> <br> - ( <font color="#0000ff">void</font> ) buyFeatureA; <br> - ( <font color="#0000ff">void</font> ) buyFeatureB; <br> <br> <font color="#008000">//      </font> <br> + (BOOL) featureAPurchased; <br> + (BOOL) featureBPurchased; <br> ... <br> @end</font> <br> <br> <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></code> </blockquote> <br><br>  Consider using the class in my test case. <br><br>  First, in the MKStoreManager.m file, I registered the Product ID of my features: <br><br><blockquote> <code><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="black"><font color="#0000ff">static</font> NSString *featureAId = <font color="#A31515">@"com.wordpress.indiedevelop.InAppPurchasesExample.f1"</font> ; <br> <font color="#0000ff">static</font> NSString *featureBId = <font color="#A31515">@"com.wordpress.indiedevelop.InAppPurchasesExample.f2"</font> ;</font> <br> <br> <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></code> </blockquote> <br><br>  You also need to check whether the program features were purchased.  The main example class is inherited from UIViewController, so it is advisable to embed the verification code in the viewDidLoad method: <br><br><blockquote> <code><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="black">- ( <font color="#0000ff">void</font> )viewDidLoad { <br> [super viewDidLoad]; <br> <br> [MKStoreManager sharedManager]. <font color="#0000ff">delegate</font> = self; <font color="#008000">//     MKStoreManager</font> <br> <br> <font color="#0000ff">if</font> ([MKStoreManager featureAPurchased]) <font color="#008000">//    1</font> <br> { <br> feature1Button.hidden = YES; <font color="#008000">//   '  1'</font> <br> seeFeature1Button.hidden = NO; <font color="#008000">//   '   1'</font> <br> } <br> <br> <font color="#0000ff">if</font> ([MKStoreManager featureBPurchased]) <font color="#008000">//    2</font> <br> { <br> feature2Button.hidden = YES; <font color="#008000">//   '  2'</font> <br> seeFeature2Button.hidden = NO; <font color="#008000">//   '   2'</font> <br> } <br> }</font> <br> <br> <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></code> </blockquote> <br><br>  Inside MKStoreKit, information about whether the product is purchased is saved through NSUserDefaults, so when the application is deleted, the information is reset.  However, the user will not buy features twice, because StoreKit will open access to the feature for free. <br><br>  Next you need to implement the 'Buy' methods.  They are tied to the TouchUpInside event of the appropriate buttons: <br><br><blockquote> <code><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="black">-(IBAction)feature1ButtonPressed <br> { <br> [self showLockView]; <font color="#008000">//  ,   </font> <br> [[MKStoreManager sharedManager] buyFeatureA]; <font color="#008000">//    '  1'</font> <br> } <br> <br> -(IBAction)feature2ButtonPressed <br> { <br> [self showLockView]; <font color="#008000">//  ,   </font> <br> [[MKStoreManager sharedManager] buyFeatureB]; <font color="#008000">//    '  2'</font> <br> }</font> <br> <br> <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></code> </blockquote> <br><br>  Next, I implemented the delegate MKStoreKitDelegate methods: <br><br><blockquote> <code><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="black"><font color="#008000">//  1 </font> <br> - ( <font color="#0000ff">void</font> )productAPurchased <br> { <br> [self hideLockView]; <font color="#008000">//   </font> <br> feature1Button.hidden = YES; <font color="#008000">//   ''</font> <br> seeFeature1Button.hidden = NO; <font color="#008000">//   ''</font> <br> } <br> <br> <font color="#008000">//  2 </font> <br> - ( <font color="#0000ff">void</font> )productBPurchased <br> { <br> [self hideLockView]; <font color="#008000">//   </font> <br> feature2Button.hidden = YES; <font color="#008000">//   ''</font> <br> seeFeature2Button.hidden = NO; <font color="#008000">//   ''</font> <br> } <br> <br> <font color="#008000">//   ,   </font> <br> - ( <font color="#0000ff">void</font> )failed <br> { <br> [self hideLockView]; <font color="#008000">//   </font> <br> }</font> <br> <br> <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></code> </blockquote> <br><br>  New features are implemented as separate UIViews under the control of a UIViewController.  I implemented the transition to new features with the help of UINavigationController: <br><br><blockquote> <code><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="black"><font color="#008000">//    1</font> <br> -(IBAction)seeFeature1 <br> { <br> [self.navigationController pushViewController:feature1ViewController animated:YES]; <br> } <br> <br> <font color="#008000">//    2</font> <br> -(IBAction)seeFeature2 <br> { <br> [self.navigationController pushViewController:feature2ViewController animated:YES]; <br> }</font> <br> <br> <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></code> </blockquote> <br><br>  Also, when manipulating the store, you can add a check for its availability.  This is done like this: <br><br><blockquote> <code><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="black"><font color="#0000ff">if</font> ([SKPaymentQueue canMakePayments]) <br> { <br> ... <font color="#008000">//   </font> <br> } <br> <font color="#0000ff">else</font> <br> { <br> ... <font color="#008000">//  ,  Purchases </font> <br> }</font> <br> <br> <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></code> </blockquote> <br><br>  As you can see everything is quite simple.  It remains to be copied and tested :) <br><br><h3>  Step 7. Testing </h3><br>  To test In-App Purchases you need to compile, install and run the application.  When testing, remember the following: <br><ol><li>  Testing Purchases can only be on the device. </li><li>  Before testing, you need to exit iTunes on your iPhone.  This is done via 'Settings-&gt; Store-&gt; Sign Out'. </li><li>  When testing, messages with an offer to buy a feature will appear [Environment: sandbox] - this is a sign of the test mode. </li><li>  Test can only test accounts (see Step 5) </li></ol><br><h2>  InAppPurchasesExample Test Case </h2><br>  As a result, I got an application that can unlock two additional windows.  This application can be used as an example to create your in-app purchase projects. <br><br>  Source code: <a href="http://ifolder.ru/16408660">InAppPurchasesExample.zip</a> <br><br>  Screenshots: <br> <a href=""><img src="https://habrastorage.org/getpro/habr/post_images/2c8/6e5/a15/2c86e5a15ab558117e735ff3abdac8bb.png" title="Screens" width="200" height="300"></a> <br><br>  I really hope that this post has helped you.  If you have Questions, please ask.  I will answer them with pleasure. <br><br>  - Jacob </div><p>Source: <a href="https://habr.com/ru/post/84359/">https://habr.com/ru/post/84359/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../84349/index.html">Video preview of the interface Symbian OS 3</a></li>
<li><a href="../84350/index.html">Cheapest way to get to Hawaii</a></li>
<li><a href="../84351/index.html">Zend Framework Tips and Tricks</a></li>
<li><a href="../84355/index.html">Our iPad Killer</a></li>
<li><a href="../84357/index.html">SVN: Six months later</a></li>
<li><a href="../84360/index.html">Project to optimize the distribution of incoming Voip calls</a></li>
<li><a href="../84361/index.html">Cubestormer robot, collects the Rubik's cube in 12 seconds</a></li>
<li><a href="../84362/index.html">Where do you go for packaging from household and computer equipment?</a></li>
<li><a href="../84364/index.html">Akinator and Mathematics</a></li>
<li><a href="../84367/index.html">NOMOBILE.RU at MWC-2010. Day zero and day one. How it was</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>