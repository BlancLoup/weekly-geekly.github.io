<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Write the code as if it would be accompanied by a violent psychopath who knows where you live.</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="... even if the project is not planned to be developed and you are not going to share the source codes, because in 20 years some maniac will study and...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Write the code as if it would be accompanied by a violent psychopath who knows where you live.</h1><div class="post__text post__text-html js-mediator-article">  ... even if the project is not planned to be developed and you are not going to share the source codes, because in 20 years some maniac will study and modify the machine code of your product, and he may want to find you. <br><br><img src="https://habrastorage.org/files/8cc/846/a58/8cc846a584d24b3fb590eddd8de2c8d2.png" alt="Development of Need For Speed ‚Äã‚ÄãIII Modern Patch"><br><br>  In general, I rarely play computer games.  Happened, not played for several years in a row.  But sometimes a small reverse engineer wakes up in me who motivates me to get into the machine code of some favorite toy from the past.  In the past year, I worked on <a href="http://veg.by/ru/projects/nfs3/">refining Need For Speed ‚Äã‚ÄãIII: Hot Pursuit (1998)</a> .  This is my favorite game in the genre, but now I, unfortunately, know how disgusting it is written.  A large number of small bugs in the most unexpected places are a direct consequence of the poor quality of the code. <br><a name="habracut"></a><br><h2>  How bad is it? </h2><br>  In the executable file, a huge amount of code that was inherited from the previous parts of the game and is not used, that is, the outdated code was not removed by the developers, and I had cases when some outdated code was called, but the results of its work were ignored, because the updated code they were no longer needed.  In the game, static fixed-size arrays are used everywhere, in many cases there are no checks for going beyond the array, which leads to crashes when some reserved amount of memory is not enough.  The game uses a large number of dirty hacks.  For example, the race function for the reflected route variant is implemented not by the reflection of the model of the route when it is loaded, but by flipping each frame when rendering, with the inversion of the left and right buttons and a number of similar substitutions where the developers did not forget to add the corresponding code.  Because of this, the inscriptions on the cars (for example, cops) are reflected, and during the races the cops confuse the ‚Äúright‚Äù and ‚Äúleft‚Äù in the negotiations on the radio.  There are also errors that are clearly related to the use of magic numbers in the code instead of the named constants, when the value of the constant in the development process was changed, but there was code that uses the old value and does not work correctly.  But one case turned out to be so funny that I wanted to share it within a small note. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h2>  How many errors can be in 4 variants of the same code? </h2><br>  In the game there was one minor bug associated with indents in the drop-down menus.  For example, if the Hot Pursuit mode was selected, the left indent of all top drop-down lists increased significantly without an obvious need. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/f96/d91/7f5/f96d917f5c3e89333aa7cbe2021d8cf1.png" alt="image"><img src="https://habrastorage.org/getpro/habr/post_images/e3d/be1/8a5/e3dbe18a5d67fe93776f1942de54f624.png" alt="image"><br><br>  I suggested that this is due to an error in the code, which adds space for displaying icons of the passage in the drop-down list of tracks, which should be displayed only in the Hot Pursuit mode. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/59b/99b/254/59b99b254f8e1a02715cf6e5c0bcbce4.png" alt="image"><img src="https://habrastorage.org/getpro/habr/post_images/6b9/e3d/cc5/6b9e3dcc535e85c2d72ee8f397433596.png" alt="image"><br><br>  Regular drop-down lists also had problems with indents depending on the mode, but not in such an explicit form.  Since I was just digging along with the corresponding code, I decided to correct this strange behavior at the same time. <br><br>  It is worth noting that the code of the game does not contain traces of things like inheritance, so most likely it was written in pure C. The game implements code that reads lists of menu items and their properties from external text files, but developers were often lazy to add support for a new property, and wrote additional code, relying simply on the name of the element.  For example, the output code of drop-down lists itself checks the name of the current element and some other variables, and depending on this it can apply some additional logic. <br><br>  So it turned out here.  Since the menu uses two different types of drop-down lists (regular and top), the entire code for working with them was completely duplicated twice.  In addition, it turned out that the left indent is selected by different code fragments when calculating the left and right borders of the drop-down list.  Total - in theory, we should have 4 copies of the same code.  No matter how wrong! <br><br>  Option 1 (when calculating the indent of the left border of the usual dropout): <br><img src="https://habrastorage.org/getpro/habr/post_images/503/a42/f7e/503a42f7e7edae8aa4acc486a2390525.png" alt="image"><br>  On C, it looked like this: <br><pre><code class="cpp hljs">dw_padding = (stricmp(str_element_name, <span class="hljs-string"><span class="hljs-string">"tracks"</span></span>) == <span class="hljs-number"><span class="hljs-number">0</span></span> &amp;&amp; dw_cfg_race_type == <span class="hljs-number"><span class="hljs-number">3</span></span>) ? <span class="hljs-number"><span class="hljs-number">35</span></span> : <span class="hljs-number"><span class="hljs-number">15</span></span>;</code> </pre> <br>  Option 2 (when calculating the indent of the right border of a normal dropout): <br><img src="https://habrastorage.org/getpro/habr/post_images/141/b8c/b79/141b8cb796d91d2e5327193f2545ff02.png" alt="image"><br>  On C, it looked like this: <br><pre> <code class="cpp hljs">dw_padding = (stricmp(str_element_name, <span class="hljs-string"><span class="hljs-string">"tracks"</span></span>) == <span class="hljs-number"><span class="hljs-number">0</span></span> || stricmp(str_element_name, <span class="hljs-string"><span class="hljs-string">"rectrk"</span></span>) == <span class="hljs-number"><span class="hljs-number">0</span></span>) ? <span class="hljs-number"><span class="hljs-number">35</span></span> : <span class="hljs-number"><span class="hljs-number">15</span></span>;</code> </pre><br>  Options 3 and 4 (when calculating the indentation of the left and right borders of the dropout under the title): <br><img src="https://habrastorage.org/getpro/habr/post_images/fba/e02/4b3/fbae024b35cc6329fcf937617d6867af.png" alt="image"><img src="https://habrastorage.org/getpro/habr/post_images/2e2/faa/cb9/2e2faacb94995ff1a7b571ea19ffbe19.png" alt="image"><br>  On C, it looked like this: <br><pre> <code class="cpp hljs">dw_padding = (dw_cfg_race_type == <span class="hljs-number"><span class="hljs-number">3</span></span>) ? <span class="hljs-number"><span class="hljs-number">35</span></span> : <span class="hljs-number"><span class="hljs-number">15</span></span>;</code> </pre><br>  All options together (for clarity): <br><pre> <code class="cpp hljs">dw_padding = (stricmp(str_element_name, <span class="hljs-string"><span class="hljs-string">"tracks"</span></span>) == <span class="hljs-number"><span class="hljs-number">0</span></span> &amp;&amp; dw_cfg_race_type == <span class="hljs-number"><span class="hljs-number">3</span></span>) ? <span class="hljs-number"><span class="hljs-number">35</span></span> : <span class="hljs-number"><span class="hljs-number">15</span></span>; dw_padding = (stricmp(str_element_name, <span class="hljs-string"><span class="hljs-string">"tracks"</span></span>) == <span class="hljs-number"><span class="hljs-number">0</span></span> || stricmp(str_element_name, <span class="hljs-string"><span class="hljs-string">"rectrk"</span></span>) == <span class="hljs-number"><span class="hljs-number">0</span></span>) ? <span class="hljs-number"><span class="hljs-number">35</span></span> : <span class="hljs-number"><span class="hljs-number">15</span></span>; dw_padding = (dw_cfg_race_type == <span class="hljs-number"><span class="hljs-number">3</span></span>) ? <span class="hljs-number"><span class="hljs-number">35</span></span> : <span class="hljs-number"><span class="hljs-number">15</span></span>;</code> </pre><br>  What is the correct option?  The answer is: none!  Only if we combine all the checks together can we get the only correct version of the code, and it would look like this: <br><pre> <code class="cpp hljs">dw_padding = (dw_cfg_race_type == <span class="hljs-number"><span class="hljs-number">3</span></span> &amp;&amp; (stricmp(str_element_name, <span class="hljs-string"><span class="hljs-string">"tracks"</span></span>) == <span class="hljs-number"><span class="hljs-number">0</span></span> || stricmp(str_element_name, <span class="hljs-string"><span class="hljs-string">"rectrk"</span></span>) == <span class="hljs-number"><span class="hljs-number">0</span></span>)) ? <span class="hljs-number"><span class="hljs-number">35</span></span> : <span class="hljs-number"><span class="hljs-number">15</span></span>;</code> </pre><br>  In total, we have 4 variants of the same code, with 3 different errors made in different variants!  Just a unique case and a great demonstration of why copy-paste is a bad idea. <br><br><h2>  How was this fixed? </h2><br>  How changes are made to the machine code, I <a href="https://habrahabr.ru/post/51857/">wrote earlier</a> .  To fix the problem, I wrote one function: <br><img src="https://habrastorage.org/getpro/habr/post_images/87a/524/e9b/87a524e9bbcd2d02546cc667680aa4d1.png" alt="image"><br>  All the above code snippets have been replaced by a call to this function.  Now the indents in the lists are selected correctly :) And this is just one of more than 200 changes that were made in the <a href="http://veg.by/ru/projects/nfs3/">patch</a> .  The described change is actually one of the smallest, but the error itself, in my opinion, was interesting (as a demonstration of the harm from the corresponding anti-pattern). <br><br><h2>  Findings? </h2><br>  And now think.  If an impostor was found here who undertook to fix other people's bugs in the program without source codes without asking, there may be someone who will be so angry that he will have a desire to find a developer or his relatives.  And you need it?  Write a quality code :) </div><p>Source: <a href="https://habr.com/ru/post/302570/">https://habr.com/ru/post/302570/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../302556/index.html">Mastering programming - no problem</a></li>
<li><a href="../302560/index.html">Mars rover Opportunity more than 40 times the planned service life</a></li>
<li><a href="../302562/index.html">How to set up two-factor authentication for login and sudo</a></li>
<li><a href="../302566/index.html">Wolfram Technologies: 4th Russian Conference</a></li>
<li><a href="../302568/index.html">Already 2016, and the future does not come. Who is to blame and what to do?</a></li>
<li><a href="../302576/index.html">Tony Robbins seminar review ‚ÄúFree your inner strength‚Äù. Day 2: Turning dreams into reality (part 2)</a></li>
<li><a href="../302580/index.html">How I caught a Wi-Fi printer via OSPF, corporate network on MikroTik part 2</a></li>
<li><a href="../302590/index.html">Launch queues and the Laravel scheduler in the Elastic Beanstalk environment</a></li>
<li><a href="../302594/index.html">Client-side Linq to NHibernate</a></li>
<li><a href="../302598/index.html">SMS as a secret weapon</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>