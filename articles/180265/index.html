<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Corporate PBX based on Asterisk</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Prerequisites 

 In the life of any large developing company, sooner or later the question arises of expanding the capabilities of a telephone exchang...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Corporate PBX based on Asterisk</h1><div class="post__text post__text-html js-mediator-article">  <b>Prerequisites</b> <br><br>  In the life of any large developing company, sooner or later the question arises of expanding the capabilities of a telephone exchange and the transition from classical telephony to IP. <br><br>  In the far spring of 2011 and in front of our company, there was such a question, since the external and internal lines require constant expansion, and the number of ports on the old Panasonic KX-TA624 was set statically and was not subject to expansion.  The opening of offices in other cities and the introduction of a unified customer service in other cities also pushed for qualitative changes. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      <b>Technical task</b> <br><br>  The final product must have the following characteristics: <br>  1) have a large number (in our case at least 100) of external and internal lines and be ready for expansion; <br>  2) be able to greet users during working hours and report that they called during non-working hours when there is no one in place; <br>  3) redirection timeouts when no response / busy / unavailability must be configured individually; <br>  4) queues should be provided.  Queue - a group of numbers, the distribution of calls within which occurs according to certain rules; <br>  5) write log messages (both text and audio); <br>  6) have a flexible policy of distribution of rights to external calls.  Users who can call only internal numbers should be provided;  city ‚Äã‚Äãnumbers;  to any rooms; <br>  7) depending on the time of day, call one or another number. <a name="habracut"></a><br><br>  <b>Unsuccessful experience</b> <br><br>  The initial choice fell on the Planet ipx-1900.  Characteristics can be found here: <br>  <a href="http://www.planet.com.ru/en/product/product_keyf.php%3Fid%3D18500">www.planet.com.ru/en/product/product_keyf.php?id=18500</a> <br><br>  Among other things, support is claimed: <br>  ‚Ä¢ Autoinformer (AA) <br>  ‚Ä¢ Interactive Voice Responses (IVR) <br>  ‚Ä¢ Call Detail Report (CDR) <br><br>  In practice, none of these parameters work.  Planet support ignored questions.  It was impossible to get 8800 on this iron by standard means. <br><br>  I had to dig deeper.  On this PBX there is a com-port and telnet, when connected to it, a login and password is requested.  Technical support for Planet refused to provide details for entry ... more precisely, it ignored the request.  A page with firmware for the device can be found here: <br>  <a href="http://planet.com.ru/en/support/download2.php%3Fid%3D18500%26file_type%3D65%26prod_model%3DIPX-1900">planet.com.ru/en/support/download2.php?id=18500&amp;file_type=65&amp;prod_model=IPX-1900</a> <br><br>  The firmware was nothing more than an archive: <br><pre><code class="bash hljs">$ mkdir untar &amp;&amp; <span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> untar &amp;&amp; tar xvf ../FW-IPX1900_1.16.8.dat rootfs.jffs2 vmImage start_install.sh aimage.tar.gz</code> </pre> <br><br>  The most interesting was start_install.sh - this script is executed immediately after downloading the firmware to the device.  Immediately after the line: <br><pre> <code class="bash hljs"><span class="hljs-meta"><span class="hljs-meta">#!/bin/sh</span></span></code> </pre><br>  add the line: <br><pre> <code class="bash hljs">useradd -groot -proot toor</code> </pre><br><br>  We pack everything back into the archive and download the firmware to the station. <br><br>  If everything goes well, it will be possible to login to the station via com-port or telnet. <br>  Inside was detected by ŒºClinux with Asterix 1.4 <br><br>  And began dopilivaniya station to working condition.  We will not post the list of changes, because it is, by now, irretrievably lost. <br><br>  Thanks to access to the station console, we managed to implement step 1-4 of the technical task.  And add at station 8800, which is also not bad, if not: <br>  1) permanent freezing of the station and external ports; <br>  2) daily station reboots at night; <br>  3) at times, after a reboot, the station could not be synchronized with the temporary server, and she informed clients that the time was not working, although in fact the time was working. <br><br>  However, in this form, telephony existed in Regtime for about a year and a half.  Nevertheless, the management continued to "kick" technical support (yes, yes, technical support) on the theme of making the dream of a completed technical task come true, and technical support was born. <br><br>  <b>Iron</b> <br><br>  At the time of the transition from the planet to a regular server, there were: <br>  1) several planet ata-150s voice gateways (2 fxs ports); <br>  2) linksys spa-3000 (1fxo + 1 fxs port) - 2 pieces; <br>  3) a bunch of analog phones (Panasonic heritage); <br>  4) VoIP phone dlink-dph150s, dlink-dph150se; <br>  5) server with Debian OS; <br>  6) network filters, twisted pair, switch :) <br><br>  <b>Subjective review of the gland</b> <br><br>  VoIP dlink work well.  Hanging almost not observed.  There were several models with a marriage, but without any questions they were changed to new ones. <br><br>  Linksys - not bad.  Sometimes there is a hangup, at which the voice gateway itself does not hang, but the FXO port on it.  Unfortunately, it is found only at the request of customers. <br><br>  Planet ata-150s - bad.  Very often, hangs occur, periodically there are noises in the tube.  Only restart helps.  Were bought a pack - so you have to work with what is. <br><br>  <b>Install Asterisk</b> <br><br>  Unfortunately, the asterisk installation log on debian has not been saved.  Therefore, the article will be translated installation commands on Ubuntu 12.04.  By and large, there should be very few differences, for example, Asterisk 1.8 is not included in the main debian repository, but it is in the backports. <br><br>  For work we use the following packages: <br>  1 asterisk - Asterisk 1.8 <br>  2 libasterisk-agi-perl - AGI module for perl.  About this a little later. <br>  3 asterisk-mysql - Asterisk extension, which allows storing statistics not in a text file, but in a database <br><br><pre> <code class="bash hljs">$ sudo aptitude install asterisk libasterisk-agi-perl asterisk-mysql mysql-server</code> </pre><br><br>  <b>Call Log Setup</b> <br><br>  1) From the database root, create a new database and user: <br><pre> <code class="bash hljs">CREATE DATABASE astr; GRANT ALL PRIVILEGES ON astr.* TO <span class="hljs-string"><span class="hljs-string">'asterisk'</span></span>@<span class="hljs-string"><span class="hljs-string">'localhost'</span></span> IDENTIFIED BY <span class="hljs-string"><span class="hljs-string">'super-pass'</span></span> WITH GRANT OPTION; EXIT;</code> </pre><br><br>  2) Go under the newly created user: <br><pre> <code class="bash hljs">$ mysql -uasterisk -psuper-pass astr</code> </pre><br><br>  3) Create a table: <br><pre> <code class="bash hljs">CREATE TABLE `cdr` ( `calldate` datetime NOT NULL DEFAULT <span class="hljs-string"><span class="hljs-string">'0000-00-00 00:00:00'</span></span>, `clid` varchar(80) NOT NULL DEFAULT <span class="hljs-string"><span class="hljs-string">''</span></span>, `src` varchar(80) NOT NULL DEFAULT <span class="hljs-string"><span class="hljs-string">''</span></span>, `dst` varchar(80) NOT NULL DEFAULT <span class="hljs-string"><span class="hljs-string">''</span></span>, `dcontext` varchar(80) NOT NULL DEFAULT <span class="hljs-string"><span class="hljs-string">''</span></span>, `channel` varchar(80) NOT NULL DEFAULT <span class="hljs-string"><span class="hljs-string">''</span></span>, `dstchannel` varchar(80) NOT NULL DEFAULT <span class="hljs-string"><span class="hljs-string">''</span></span>, `lastapp` varchar(80) NOT NULL DEFAULT <span class="hljs-string"><span class="hljs-string">''</span></span>, `lastdata` varchar(80) NOT NULL DEFAULT <span class="hljs-string"><span class="hljs-string">''</span></span>, `duration` int(11) NOT NULL DEFAULT <span class="hljs-string"><span class="hljs-string">'0'</span></span>, `billsec` int(11) NOT NULL DEFAULT <span class="hljs-string"><span class="hljs-string">'0'</span></span>, `disposition` varchar(45) NOT NULL DEFAULT <span class="hljs-string"><span class="hljs-string">''</span></span>, `amaflags` int(11) NOT NULL DEFAULT <span class="hljs-string"><span class="hljs-string">'0'</span></span>, `accountcode` varchar(20) NOT NULL DEFAULT <span class="hljs-string"><span class="hljs-string">''</span></span>, `userfield` varchar(255) NOT NULL DEFAULT <span class="hljs-string"><span class="hljs-string">''</span></span>, KEY `calldate` (`calldate`), KEY `dst` (`dst`), KEY `accountcode` (`accountcode`) ); EXIT;</code> </pre><br><br>  4) Go to the config directory asterisk (all further actions must be performed on behalf of the super-user) and make a copy of all the content just in case: <br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># cp -r ../asterisk/ ~/asterisk_config # echo '' &gt; cdr_mysql.conf &amp;&amp; mcedit cdr_mysql.conf</span></span></code> </pre><br>  We have it looks like: <br><pre> <code class="bash hljs">[global] hostname=localhost dbname=astr table=cdr password=super-pass user=asterisk [columns] <span class="hljs-built_in"><span class="hljs-built_in">alias</span></span> start =&gt; calldate</code> </pre><br><br>  Config cdr.conf remained unchanged. <br><br>  <b>Outgoing Call Users and Contexts</b> <br><br>  For outgoing user calls, we have 4 contexts: <br>  1 phone_int is the default value.  Users who are allowed to call only to internal 3-digit numbers. <br>  2 phone_local - users can call 7-digit city numbers; <br>  3 phone_long_d - these users are allowed calls within the country; <br>  4 phone_too_long_d - international calls. <br><br>  Contexts are integrated into each other, i.e.  phone_too_long_d users are allowed to call both internal numbers of employees and inside the city. <br><br>  Let's start: <br><br>  1) Let's split sip.conf into several: <br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># mcedit sip.conf #include sip_general.conf #include sip_trunk.conf #include sip_internal.conf</span></span></code> </pre><br><br>  sip_general.conf - the main asterisk settings. <br>  sip_internal.conf - internal numbers of users; <br>  sip_trunk.conf - external lines; <br><br>  2) An example of configuring 3 numbers in sip_internal.conf: <br><br><pre> <code class="bash hljs">[defaults](!) <span class="hljs-built_in"><span class="hljs-built_in">type</span></span> = friend qualify = yes ;    ; ,     context = phone_int canreinvite = no host = dynamic callgroup = 1 pickupgroup = 1 [101](defaults) secret = pass_for_reception callerid = <span class="hljs-string"><span class="hljs-string">"Sveta"</span></span>&lt;101&gt; context = phone_long_d [112](defaults) secret = pass_for_artur callerid = ‚ÄúArtur<span class="hljs-string"><span class="hljs-string">"&lt;112&gt; context = phone_local [106](defaults) secret = pass_for_fax callerid = "</span></span>Fax<span class="hljs-string"><span class="hljs-string">"&lt;106&gt; context = phone_too_long_d [495](defaults) secret = pass_msk callerid = "</span></span>MSK<span class="hljs-string"><span class="hljs-string">"&lt;495&gt;</span></span></code> </pre><br><br>  User 101 is allowed to make calls within Russia (context = phone_long_d);  user 112 (phone_local) can call within the city;  106 allowed to call anywhere;  user 495 is only allowed to dial extensions (if the context is not set, the phone_int context is used).  The secret field is the password that will be used for authorization. <br><br>  <b>Incoming lines</b> <br><br>  Example of the main config: <br><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># mcedit sip_general.conf [general] bindport = 5060 bindaddr=0.0.0.0 allowguest = no allowtransfer = yes allowoverlap = no tos_sip = cs3 tos_audio = ef tos_video = af41 srvlookup = no minexpiry = 900 maxexpiry = 3600 defaultexpiry = 360 checkmwi = 10 language = en relaxdtmf = no rtptimeout = 550 rtpholdtimeout = 600 progressinband = never useragent = PBX dtmfmode = rfc2833 disallow = all domain = pbx.webnames.ru ;    allow = ulaw,alaw,gsm,ilbc,g726,g729,g723 ;   registertimeout = 60 registerattempts = 65535 externip = 8.8.8.8 ; ip  externrefresh = 10 nat = yes canreinvite = nonat insecure = invite register = example_num:pass_for_example_num:example_num@proxyreg_time/example_num</span></span></code> </pre><br><br>  Setting up the trunk: <br><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># mcedit sip_trunk.conf [trunk](!) type = friend call-limit=1 canreinvite=no qualify=yes context= from_external disallow=all ; need to disallow=all before we can use allow= allow=ulaw ; Note: In user sections the order of codecs allow=alaw allow=g723.1 ; Asterisk only supports g723.1 pass-thru! allow=g729 ; Pass-thru only unless g729 license obtained allow=gsm ;; example_num [example_num] type = peer username = example_num fromuser = example_num secret = pass_for_example_num fromdomain = 1.1.1.1 ; external pbx ip host = 1.1.1.1 ; external pbx ip port = 5060 outboundproxy = 1.1.1.1 ; external pbx ip outboundproxyport = 5060 context = from_external ;    [pstn_beeline](trunk) username = pstn_beeline fromuser = pstn_beeline host = dynamic secret = pass_for_beeline ;; 88001004022 (RosTelecom) [RTK] username = trace_num type = peer host = 2.2.2.2 ; external pbx ip insecure=port,invite context= from_external</span></span></code> </pre><br><br>  The example_num line uses authorization and registration at a remote station to commit.  Please note for this line spelled: <br><pre> <code class="bash hljs">register = example_num:pass_for_example_num:example_num@proxyreg_time/example_num</code> </pre><br><br>  in sip_general.conf. <br><br>  The pstn_beeline line does not require registration - in fact, this is one of the ‚Äúland‚Äù lines connected via the fxo port linksys spa 3000, but more on that later. <br><br>  Line RTK - no authorization or registration is required here.  At the station, you need only a user and ip (host field) from which calls will come.  This number is 8800 - only incoming telephony is carried out to it.  In terms of Rostelecom, the username is the route number. <br><br>  For all incoming calls, the context is one - from_external. <br><br>  <b>Dialplan (dial plan) - call routing</b> <br><br>  The most interesting thing about any PBX is the dial plan.  The dial plan routes calls according to the rules described in it.  So: <br><br>  1) Outgoing calls. <br><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># mcedit extensions.conf [globals] [general] autofallthrough=yes ;      ;      ; dial_internal.pl -     [out_int] ;       exten =&gt; *, 1, NoOp() exten =&gt; _[1-9]XX, 1, Macro(monitor) exten =&gt; _[1-9]XX, n, Macro(int-dial,${EXTEN}) exten =&gt; _[1-9]XX, n, Hangup() ;   -  [out_local] ;   exten =&gt; _X., 1, Macro(monitor) exten =&gt; _[1-79]XXXXXX, 2, Dial(SIP/${EXTEN}@pstn_beeline&amp;SIP/${EXTEN}@example_num) exten =&gt; _0[1-79]XXXXXX, 2, Dial(SIP/${EXTEN:1}@pstn_beeline&amp;SIP/${EXTEN:1}@example_num) exten =&gt; _83[1-79]XXXXXX, 2, Dial(SIP/${EXTEN:2}@pstn_beeline) exten =&gt; _85[1-79]XXXXXX, 2, Dial(SIP/${EXTEN:2}@example_num) ;  -          ; .      exten =&gt; _094959874596, 2, Dial(SIP/${EXTEN:1}@pstn_beeline) ; msk line ;  [out_long_d] ;   exten =&gt; _X., 1, Macro(monitor) ;     ; 1) -  ; 2) -   exten =&gt; _08X., 2, Dial(SIP/${EXTEN:1}@pstn_beeline&amp;SIP/${EXTEN:1}@example_num) ;         exten =&gt; _838X., 2, Dial(SIP/${EXTEN:2}@pstn_beeline) exten =&gt; _858X., 2, Dial(SIP/${EXTEN:2}@example_num) ;   [out_too_long_d] exten =&gt; _X., 1, Macro(monitor) exten =&gt; _0X., 2, Dial(SIP/${EXTEN:1}@pstn_beeline&amp;SIP/${EXTEN:1}@example_num) ;      exten =&gt; _83X., 2, Dial(SIP/${EXTEN:2}@pstn_beeline) exten =&gt; _85X., 2, Dial(SIP/${EXTEN:2}@example_num) ;    [phone_int] include =&gt; out_int ;   [phone_local] include =&gt; phone_int include =&gt; out_local ;  [phone_long_d] include =&gt; phone_local include =&gt; out_long_d ;   [phone_too_long_d] include =&gt; phone_long_d include =&gt; out_too_long_d ; ======== ==============</span></span></code> </pre><br><br>  Parse string: <br><pre> <code class="bash hljs">exten =&gt; _0[1-79]XXXXXX, 2, Dial(SIP/<span class="hljs-variable"><span class="hljs-variable">${EXTEN:1}</span></span>@pstn_beeline&amp;SIP/<span class="hljs-variable"><span class="hljs-variable">${EXTEN:1}</span></span>@example_num)</code> </pre><br><br>  _0 [1-79] XXXXXX - the mask of the dialed number.  Read more here ( <a href="http://voip.rus.net/tiki-index.php%3Fpage%3DAsterisk%2BDialplan%2BPatterns">voip.rus.net/tiki-index.php?page=Asterisk+Dialplan+Patterns</a> ) <br><br>  0 - the first digit that came <br>  [1-79] - the second digit can be any number except 8, since  This is the exit to the intercity <br>  XXXXXX - any 7 digits <br><br>  X matches any number from 0 to 9 <br>  Z matches any number from 1 to 9 <br>  N matches any number from 2 to 9 <br><br>  2 - priority, means that this action will be performed second in a row. <br><br>  Dial is one of the most used asterisk applications.  It is designed to call the number through a certain line.  You can read more about this application here ( <a href="http://voip.rus.net/tiki-index.php%3Fpage%3DAsterisk%2Bcmd%2BDial">voip.rus.net/tiki-index.php?page=Asterisk+cmd+Dial</a> ) <br><br>  SIP / $ {EXTEN: 1} is a kind of regexp.  For example, when dialing the number 03799039, the number 3799039 will be sent to the channel. <br><br>  @pstn_beeline - the channel through which the call will be made. <br><br>  &amp; SIP / $ {EXTEN: 1} @example_num is another channel through which the call will be made if the biline line is busy or unavailable. <br><br><pre> <code class="bash hljs">;   [phone_local] include =&gt; phone_int include =&gt; out_local</code> </pre><br><br>  in order to get the phone_local context, you need to include 2 contexts in it - phone_int and out_local;  the user to whom such a context is connected (in the example above is user 112), calls to fixed numbers are allowed. <br><br>  2) Incoming calls are handled as follows: <br><br><pre> <code class="bash hljs">; ========= ============== [from_external] exten =&gt; _X., 1, Macro(dial) exten =&gt; s, 1, Macro(dial) ; ========= ==============</code> </pre><br><br>  3) Macros <br><br>  In essence, macros are functions.  A macro can be passed parameters that it will use depending on the context.  You can refer to the macro as follows: <br><pre> <code class="bash hljs">exten =&gt; _[1-79]XX, n, Macro(int-dial,<span class="hljs-variable"><span class="hljs-variable">${EXTEN}</span></span>)</code> </pre><br><br>  _ [1-9] XX - the number by which dialing occurs. <br>  n is the priority; <br>  Macro - the macro application itself. <br>  int-dial - the name of the macro. <br>  $ {EXTEN} - the parameter that will be passed to the macro (in this case, the phone number) <br><br>  Read more about macros here ( <a href="http://voip.rus.net/tiki-index.php%3Fpage%3DAsterisk%2Bcmd%2BMacro%26highlight%3DMacro">voip.rus.net/tiki-index.php?page=Asterisk+cmd+Macro&amp;highlight=Macro</a> ()). <br><br>  Macros that we use in terms of typing: <br><br><pre> <code class="bash hljs">; =============================== ;       ;   /var/lib/asterisk/agi/dial_internal.pl ;      (  ) ;     ;     users .. asterisk [macro-int-dial] exten =&gt; s, 1, NoOp() exten =&gt; s, 2, AGI(/var/lib/asterisk/agi/dial_internal.pl, <span class="hljs-variable"><span class="hljs-variable">${ARG1}</span></span>) exten =&gt; s, n, Hangup() ;    ( ) ;         ;     [phone_int] ;     /var/lib/asterisk/agi/ivr.pl [macro-monitor] exten =&gt; s, 1, AGI(/var/lib/asterisk/agi/monitor.pl) ;     [macro-groupe-dial] exten =&gt; s, 1, Queue(<span class="hljs-variable"><span class="hljs-variable">${ARG1}</span></span>, rtT,,,100) ;     ;   -  (     ) ;   ( &lt;-&gt;. ), ;   - ‚Äú  ,    <span class="hljs-string"><span class="hljs-string">" [macro-dial] exten =&gt; s, 1, AGI(/var/lib/asterisk/agi/ivr.pl) exten =&gt; s, n, Hangup() ; ===============================</span></span></code> </pre><br><br>  In almost all contexts, the AGI application is used.  Read more about the application here ( <a href="http://voip.rus.net/tiki-index.php%3Fpage%3DAsterisk%2Bcmd%2BAGI%26highlight%3DAGI">voip.rus.net/tiki-index.php?page=Asterisk+cmd+AGI&amp;highlight=AGI</a> ()). <br><br>  How we use this application - in the next section. <br><br>  <b>AGI greeting</b> <br><br>  Task. <br>  Implement a menu that works like this: <br>  1) Weekends and non-working hours - a message stating that the customer called during non-working hours;  voice time work. <br>  2) Working time - greeting;  depending on the time, switch the client to <br>  ‚Ä¢ secretary (if the client got into the office;); <br>  ‚Ä¢ technical support during the rest of the working time <br><br>  Working time is considered Monday-Friday from 9 to 21;  the office is open from 9 to 13 and from 14 to 18 on weekdays (from one to two in the office lunch). <br><br>  A tool for solving the problem. <br>  To solve the problem, the AGI tool was chosen. <br>  AGI (Asterisk Gateway Interface) is Asterisk's built-in method for executing external scripts (similar to CGI for http servers), which can extend the functionality of asterisk using other programming languages. <br>  Perl was chosen as the development language as a universal tool for solving any task.  :-) <br>  On cpan there is a module Asterisk :: AGI <a href="">search.cpan.org/~jamesgol/asterisk-perl-1.03/lib/Asterisk/AGI.pm</a> . <br><br>  AGI's advantages are simplicity of development;  flexibility.  Cons - significantly increases the load on the server.  The script is compiled each time it is accessed, and not cached;  on the Internet, they write that AGI is buggy, but during our work (~ 0.5 years) there were no problems with this.  We also have no problems with computing power. <br><br>  The solution of the problem. <br>  All incoming calls are sent here (see previous section): <br><pre> <code class="bash hljs">exten =&gt; s, 1, AGI(/var/lib/asterisk/agi/ivr.pl)</code> </pre><br><br>  The incoming call handler (/var/lib/asterisk/agi/ivr.pl) will look like this: <br><pre> <code class="bash hljs">use Data::Dumper; use warnings; use strict; use Asterisk::AGI; use Time::localtime; my <span class="hljs-variable"><span class="hljs-variable">$AGI</span></span> = new Asterisk::AGI; my %input = <span class="hljs-variable"><span class="hljs-variable">$AGI</span></span>-&gt;ReadParse(); <span class="hljs-comment"><span class="hljs-comment">#   ""  # ,    #  check_ivr my $schedule_time = '/var/lib/asterisk/agi/schedule.conf'; #    my $support = '300'; #   my $recep = '101'; # non_working -   # working -    (   9-13;14-18 ) # work_supp -      (default 13-14; 18-21) my @ivr = (\&amp;non_working, \&amp;working, \&amp;work_supp); #START $AGI-&gt;answer(); #          my $mode = &amp;check_ivr(); # $AGI-&gt;verbose( "Mode =&gt; $mode", 0); &amp;{$ivr[$mode]}; #   $AGI-&gt;hangup(); exit(); sub non_working{ #       $AGI-&gt;exec('Playback', 'offduty'); } sub working{ #  $AGI-&gt;exec('Playback', 'welcome'); #       $AGI-&gt;exec('Macro', "monitor"); #   $AGI-&gt;exec('Macro', "int-dial,$recep"); } sub work_supp{ $AGI-&gt;exec('Playback', 'welcome'); $AGI-&gt;exec('Macro', "monitor"); #     $AGI-&gt;exec('Macro', "groupe-dial,$support"); } ################# check_ivr ##################################### #  ( .      ):# # $wday -    (   - 0..6 )############### # $hour -  (   - 0..23 )########################### # $date -  (   - . )################### #   ( 0..2 ):####################################### # 0 -  ;########################################### # 1 -  ;############################################## # 2 -  ..###################################### sub check_ivr { my ( $wday, $hour, $date ) = @_; #         -   ($wday, $hour, $date ) = &amp;_date_now_ if !$date||!$hour||!$date; my ( %check, $check); # -        my %sch_dates; open ( SCH, $schedule_time ); while ( &lt;SCH&gt; ) { if ( $_ =~ /^(\d{1,2}\.\d{1,2})\s*(.*)[\r\n]*$/) { my ( $sch_date, $sch ) = ($1, $2); $date =~ s/^0(\d)/$1\./; $date =~ s/0(\d)$/$1/; $sch ||= '0'; $sch_dates{$sch_date} = $sch; } } close(SCH); foreach my $schedule_d (keys %sch_dates){ if ( $date eq $schedule_d ) { if ( $sch_dates{$date} ) { return &amp;_check_time_( $hour, $sch_dates{$date} ); } else { return $sch_dates{$date} } } } #   ?   1(  )  0 (  ) $check{wday} = $wday&gt;0&amp;&amp;$wday&lt;6 ? '1':'0'; #   0, 1, 2 -  _check_time_ $check{hour} = &amp;_check_time_( $hour ); $check = 1; foreach ( values %check ) { $check *= $_; } return $check; sub _check_time_ { # $hour_tm -   # $wr_time - work time (    )   [9,13,18,21] my ( $hour_tm, $wr_time) = @_; # $wr_time - work time (    ) #   () my %wr_time = &amp;_parse_work_time_( $wr_time ); # 0 -    # 1 -    ( 9-13; 14-18 ) # 2 - c 13  14;  18  21 my $check_tm = 0; if( $hour_tm&gt;$wr_time{st_office}&amp;&amp;$hour_tm&lt;$wr_time{end_support} ) { if ( $hour_tm==$wr_time{lunch}||$hour_tm&gt;$wr_time{end_office} ) { $check_tm = 2; } else { $check_tm = 1 } } return $check_tm; } #     [9,13,18,21] #    # %work_time = ( st_office =&gt; 8, # lunch =&gt; 13, # end_office =&gt; 17, # end_support =&gt; 21); sub _parse_work_time_ { my ( $work_time ) = @_; #      1 #   . $work_time = "[9,13,18,21]" if (!$work_time||$work_time eq 1 ); $work_time =~ s/^\[(.+)\][\r\n]*$/$1/; my %work_time; ( $work_time{st_office}, $work_time{lunch}, $work_time{end_office}, $work_time{end_support}, $work_time{lunch_support} ) = split /\s*,\s*/, $work_time; $work_time{st_office} -= 1; $work_time{end_office} -= 1; return %work_time; } sub _date_now_ { return ( localtime-&gt;wday, localtime-&gt;hour, localtime-&gt;mday.'.'.(localtime-&gt;mon+1) ); } } __END__</span></span></code> </pre><br><br>  The /var/lib/asterisk/agi/schedule.conf file stores ‚Äúexceptional‚Äù time, i.e.  the time when the office does not work as usual, for example, a holiday or short day.  Example: <br><br>  # 1 - date (day.month) <br>  # 2 - what day (optional parameter) <br>  # 0 is non-working or empty <br>  # 1 - a normal worker ([9,13,18,21]) or an array <br>  # 2.1 - office start time (9) <br>  # 2.2 - lunch (13, that is, from 13 to 14) <br>  # 2.3 - office end time (18) <br>  # 2.4 - technical support end time <br>  # date is entered without zeros.  06.11 - does not work;  6.11 - works <br>  29.12 [9,11,17,20] <br>  31.12 <br><br>  December 29 [9,11,17,20] (December 29) - abbreviated day.  The office is open from 9 to 17;  lunch from 11 to 12;  technical support works up to 20. <br>  December 31 is a non-working day. <br><br>  <b>AGI call handler</b> <br><br>  Task. <br>  When calling the number, the call must be redirected after a certain timeout / busy / non-response / unavailability to another number (as a rule, this is one of the queues).  "Timeout" and "other number" - dynamic variables - for each number they can be set individually. <br><br>  Tool. <br>  As in the last section - AGI. <br><br>  The solution of the problem. <br><br>  Employee internal numbers are stored in the mysql database in the users table. <br>  Create a table: <br><pre> <code class="bash hljs">CREATE TABLE `users` ( `num` int(11) PRIMARY KEY NOT NULL, `timeout` tinyint(4) NOT NULL DEFAULT <span class="hljs-string"><span class="hljs-string">'10'</span></span>, `queue` int(11) DEFAULT NULL );</code> </pre><br><br>  num - employee's phone number; <br>  timeout - time in seconds, after which the call will be redirected; <br>  queue - the queue number to which the call will be forwarded. <br><br>  add entries for numbers: <br><pre> <code class="bash hljs">INSERT INTO `users` VALUES (101,10,300), (106,20,0), (112,20,0);</code> </pre><br><br>  check what happened: <br>  SELECT * FROM users; <br>  + ----- + --------- + ------- + <br>  |  num |  timeout |  queue | <br>  + ----- + --------- + ------- + <br>  |  101 |  10 |  300 | <br>  |  106 |  20 |  0 | <br>  |  112 |  20 |  0 | <br>  + ----- + --------- + ------- + <br><br>  If you call 101 after 10 seconds, the call will go to 300 number (we have this technical support number);  when you call 112 or 106, the call will not go anywhere, but will simply end in 20 seconds. <br><br>  You can call the handler as follows (AGI (/var/lib/asterisk/agi/dial_internal.pl, $ {ARG1})): <br><br>  In dialplan this is: <br><pre> <code class="bash hljs">exten =&gt; _[1-9]XX, n, Macro(int-dial,<span class="hljs-variable"><span class="hljs-variable">${EXTEN}</span></span>) [macro-int-dial] exten =&gt; s, 1, NoOp() exten =&gt; s, 2, AGI(/var/lib/asterisk/agi/dial_internal.pl, <span class="hljs-variable"><span class="hljs-variable">${ARG1}</span></span>) exten =&gt; s, n, Hangup()</code> </pre><br><br>  The phone number is in the $ {EXTEN} variable macro, and then passed to the /var/lib/asterisk/agi/dial_internal.pl handler using $ {ARG1}. <br><br>  Handler Code: <br><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#!/usr/bin/perl use Data::Dumper; use warnings; use strict; use Asterisk::AGI; use DBI; my $user = 'asterisk'; my $pass = 'super-pass'; my $db = 'astr'; my $AGI = new Asterisk::AGI; my %input = $AGI-&gt;ReadParse(); $AGI-&gt;answer(); #     my $exten = $input{arg_1}; #    ,       my ($timeout, $queue) = &amp;get_timeout($exten); #     #  ,    . $timeout ||= '10'; #$AGI-&gt;verbose("$timeout $queue", 0); $AGI-&gt;exec('Dial', "SIP/$exten, $timeout, Tt"); #           if ( $queue ) { # $AGI-&gt;verbose('$queue', 0); $AGI-&gt;exec('Macro', "groupe-dial,$queue") if ( $AGI-&gt;get_variable('DIALSTATUS') ne 'ANSWER'); } $AGI-&gt;hangup(); exit(); sub get_timeout { my ($num) = @_; my $dbh = DBI-&gt;connect("DBI:mysql:database=$db;host=localhost", $user, $pass, {'RaiseError' =&gt; 1}); my $sth = $dbh-&gt;prepare("SELECT * FROM users WHERE num like $num"); $sth-&gt;execute(); my $ref = $sth-&gt;fetchrow_hashref(); ( $timeout, $queue ) = ( ${$ref}{timeout}, ${$ref}{queue}); $sth-&gt;finish (); $dbh-&gt;disconnect(); return ($timeout, $queue); } __END__</span></span></code> </pre><br><br> <b> </b> <br><br>       .       AGI.       ,   ,      . <br>   : ./2013/03/28/20130328.150550.9033779401.wav, <br>  those. .////__.__.___._.wav <br><br>     ,            grep'    ( /  ..) <br><br>   /var/lib/asterisk/agi/monitor.pl: <br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#!/usr/bin/perl use Data::Dumper; use warnings; use strict; use Asterisk::AGI; use File::Path qw(make_path); #    my $dir = '/mnt/pbx/'; my $AGI = new Asterisk::AGI; my %input = $AGI-&gt;ReadParse(); #  -  ,    #   my $prop = $input{arg_1}; $AGI-&gt;answer(); my ($date, $time) = split / /, $AGI-&gt;get_variable('CDR(start)'); $time =~ s/://g; $date =~ s/-/\//g; $date .= '/'; my $dir = $dir.$date; #        $date =~ s/\///g; #        #        - 'ivr' $prop ||= $AGI-&gt;get_variable('CDR(src)'); #    $prop =~ s/[\+\.\'\"\:\(\)\[\]\&amp;\^\$\#\@\!\%\*\s]//g; my $file = $prop ? $dir.$date.".$time.$prop" : $dir.$date.".$time.anon"; #   $file .= '.wav'; $AGI-&gt;exec('MixMonitor', "$file, a"); exit(); __END__</span></span></code> </pre><br>    MixMonitor    ( <a href="http://www.voip-info.org/wiki/view/MixMonitor">www.voip-info.org/wiki/view/MixMonitor</a> ) <br><br>  <b>Queues</b> <br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">With queues, everything is relatively simple. </font><font style="vertical-align: inherit;">The config is called queues.conf. </font><font style="vertical-align: inherit;">We have 2 queues - technical support (number 300) and accounting (301):</font></font><br><br><pre> <code class="bash hljs">[general] persistentmembers=yes autofill=yes autopause=no monitor-type=MixMonitor strategy=ringall ;  . ringinuse=no timeout=100 retry=2 wrapuptime=0 maxlen=0 defaultrule = plus10 [301] member =&gt; SIP/105,1 member =&gt; SIP/109,1 [300] member =&gt; SIP/102,1 member =&gt; SIP/108,1</code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">You can read more about queue features here: </font></font><br> <a href=""><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">www.voip-info.org/wiki/view/Asterisk+config+queues.conf </font></font></a> <br><br> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Setting up external lines through linksys spa-3000</font></font></b> <br><br>  Task. <br>  linksys spa-3000   fxo-   fxs.    ,     (  .. ),     fxs  (    ).        <br> 1)    ,   fxo   ; <br> 2)    ,      ; <br> 3)      ,   . <br><br> . <br>  ,   ,   ..  .    Admin login-&gt;Advanced-&gt;PSTN Line: <br> Proxy: 10.0.0.5 # (ip ) <br> Outbound Proxy: 10.0.0.5 # (ip ) <br> Register: yes <br> User ID: pstn_beeline <br> Password: pass_for_beeline <br><br> #  ,         . <br> Dial Plan 2: (&lt;:@gw0&gt;) <br> PSTN Caller Default DP:2 <br><br>           (pstn_beeline). <br><br> 106  fax: <br> Proxy: 10.0.0.5 # (ip ) <br> Outbound Proxy: 10.0.0.5 # (ip ) <br> Register: yes <br> User ID: 106 <br> Password: pass_for_fax <br><br>              (106) <br><br> <b> </b> <br><br> asterisk -r ‚Äî     asterisk <br> asterisk -rx 'sip show peers' ‚Äî           asterisk.   -x    ,     asterisk <br><br> ,  asterisk,      : <br> sip reload ‚Äî     sip.conf <br> dialplan reload ‚Äî    <br> sip show channels ‚Äî    <br> sip set debug ip ip__peer'a ‚Äî  debug  .          .    <br> core set verbose 3 ‚Äî   .        . </div><p>Source: <a href="https://habr.com/ru/post/180265/">https://habr.com/ru/post/180265/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../180249/index.html">Two-day free access to Code School courses</a></li>
<li><a href="../180251/index.html">Save body movements!</a></li>
<li><a href="../180255/index.html">Is there life in the world of PostPC? Part 4: Clouds, White Mane Horses</a></li>
<li><a href="../180257/index.html">Panorama at 9600 km in 15 minutes</a></li>
<li><a href="../180259/index.html">Unknown mathematician made a breakthrough in the theory of twin prime numbers</a></li>
<li><a href="../180269/index.html">Graphs of road networks and algorithms for working with them</a></li>
<li><a href="../180271/index.html">The effect of film film projector in digital video technology</a></li>
<li><a href="../180273/index.html">Low automation, or how to send two bytes</a></li>
<li><a href="../180275/index.html">The effect of slides on the site. Version two, supplemented and corrected</a></li>
<li><a href="../180277/index.html">Time management and organizers</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>