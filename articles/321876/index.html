<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Terminal Server User Authentication on FirePOWER</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="For us, engineers, to monitor the emergence of new versions of FirePOWER is a real pleasure. Each time, opening the regular Release Notes, we are with...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Terminal Server User Authentication on FirePOWER</h1><div class="post__text post__text-html js-mediator-article"><div style="text-align:center;"><img src="https://habrastorage.org/files/462/9e6/4cd/4629e64cdead4b9b8864626ed08391bc.png"></div><br>  For us, engineers, to monitor the emergence of new versions of FirePOWER is a real pleasure.  Each time, opening the regular Release Notes, we are with a sinking heart (and sometimes with a full stop) studying the new features added by the developers. <br><br>  One of the long-awaited innovations was the <b>Cisco Terminal Server Agent</b> (hereinafter TS Agent).  It is intended for correct authentication of users of terminal servers (hereinafter TC).  In this article I will tell why it is needed and how it works. <a name="habracut"></a><br><br>  Let me remind you that the authentication problem on the TS is that in most solutions like FirePOWER, it works by the IP address, which is the same for all TS users. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      For example, Vasily and Peter simultaneously work on a terminal server.  According to corporate rules, Vasily can attend social.  network, and Pete - no.  ITU will not be able to separate the traffic of Vasily and Peter from each other without having additional information other than an IP address.  Therefore, either both employees will be denied access to social.  network, or both allowed. <br><br>  There are different ways to solve a problem.  For example, the "crutch" option using IP Virtualization technology on the vehicle.  In this case, each new session on the vehicle will be assigned a unique IP address.  But immediately it is worth noting that this approach has many nuances. <br><br>  The Cisco WSA Web Proxy introduces the concept of Session-cookies (session fingerprint).  Thanks to information from session-cookies, WSA can distinguish users with the same IP address.  But there is a drawback: cookies can only be used for browser sessions.  Applications that do not support cookies will not work (Skype, TeamViewer, etc.). <br><br>  Using an agent installed on a vehicle is the most universal method of solving a problem.  Identity Agent has long existed for Checkpoint solutions.  Now, finally, Cisco has introduced a similar solution for ITU based on FirePOWER.  The announcement took place on August 29, 2016 (we mentioned it here, UPD (09/02/2016)).  But the agent became available for download only on January 26, 2017. From the official Release Notes for version 6.1 of the FirePOWER Management Center (FMC, FirePOWER control system), information about the terminal agent was removed and migrated to Release Notes for 6.2.  Thus, the terminal agent is supported on FMC, starting with version 6.2. <br><br><h3>  How the agent works </h3><br>  The idea is as simple as slippers.  For each TS user, the source tcp / udp ports of the launched sessions are translated to a specific port pool.  Yes, yes, it is broadcast.  PAT occurs.  When the agent is installed on the server, a special low-level driver is added, which deals with the conversion of tcp / udp ports. <br><br>  User mapping and port pool information is passed to the FMC (FirePOWER Management Center) control center via the REST API. <br><br>  The agent is downloaded from cisco.com as an installation exe file.  After completing the installation on the vehicle, the agent settings window opens: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/files/7e0/027/241/7e0027241fcd46eea547729356f34a50.png"></div><br>  Here we can specify how many users can simultaneously use the server (Max User Sessions).  In this version of the agent 199 users - the maximum. <br><br>  We select the server's network card, and which ports we can and cannot use for broadcasting. <br><br>  For the system to work, you must specify the IP address of the FMC and the user who has the rights to use REST VDI.  By default, the following user roles have rights: <br><br><ul><li>  Access Admin </li><li>  Admin </li><li>  Network admin </li></ul><br>  You can create a separate role for the agent on the FMC, which I did for the test. <br><br>  System ‚Üí Users ‚Üí User Roles tab.  Click Create User Role: <br><br><img src="https://habrastorage.org/files/3a0/9ea/7d1/3a09ea7d180342e29aa711a7530f519a.png"><br><br>  Choose from the submenu "Rest VDI". <br><br>  Next, create a user ts-agent and assign the newly created TS Agent role to it.  On the Users tab, click Create User: <br><br><img src="https://habrastorage.org/files/55e/969/7c1/55e9697c186f4cfa9f1b6f49383e8b59.png"><br><br>  We return to the agent, enter the IP address of the FMC, the user ts-agent and its password.  Click Test: <br><br><img src="https://habrastorage.org/files/558/0b9/1fa/5580b91fa0c54c1291efde287540e3e0.png"><br><br>  Click Save.  Here is the nuance: the agent will ask to restart the server.  Do nothing, obey the will of the soulless machine.  By the way (or not by the way), making any changes in the settings of the agent also requires a reboot. <br><br>  All is ready.  You can check what happened.  We make two rules for access to FMC.  The first rule for a group of AD "IT-department", it will be allowed full access to the Internet.  The second rule for all other users.  According to this rule, we block access to social services.  networks.  Setup: <br><br><img src="https://habrastorage.org/files/7d1/75f/61b/7d175f61b54e462b93623aebd02c1f9a.png"><br><br>  We go under two users on the vehicle.  The first user ‚ÄúUskov‚Äù is a member of the IT department.  The second user ‚ÄúVasiliy‚Äù is not included in the IT department.  Accordingly, for ‚ÄúUskov‚Äù it will be allowed to go to social.  network, for "Vasiliy" - is prohibited.  We are checking. <br><br>  For "Uskov": <br><br><img src="https://habrastorage.org/files/e12/88c/8bd/e1288c8bdeba41c985b822b677dafdfc.png"><br><br>  For Vasiliy: <br><br><img src="https://habrastorage.org/files/89a/27e/b83/89a27eb83a2248819d775a5124538226.png"><br><br>  Fuh, not deceived ciskodely, works!  Let's see the logs.  The agent can see which port ranges are issued to users: <br><br><img src="https://habrastorage.org/files/4fa/d90/79f/4fad9079f3b24f768dbc1783de64553a.png"><br><br>  Information on ports appeared on the FMC tab Analysis ‚Üí Users ‚Üí User Activity: <br><br><img src="https://habrastorage.org/files/90d/299/aeb/90d299aebdf448b6a35de2e38fd98263.png"><br><br>  Everything works as intended. <br><br><h3>  What agent is installed on </h3><br><ul><li>  Windows Server 2008 R2; </li><li>  Windows Server 2012; </li><li>  Windows Server 2012 R2. </li></ul><br>  The following virtualization systems are supported: <br><br><ul><li>  Citrix xendesktop </li><li>  Citrix xenapp </li><li>  Xen Project Hypervisor </li><li>  VMware vSphere Hypervisor / VMware ESXi 6.0 </li><li>  Windows Terminal Services / Windows Remote Desktop Services (RDS) </li></ul><br><h3>  Limitations and notes for the first version of the agent (1.0.0-36) </h3><br><ul><li>  Up to 199 users on the vehicle; </li><li>  Only one TC network card can be used; </li><li>  Time on the vehicle must be synchronized with the time on the FMC; </li><li>  On FMC, user information obtained from TS Agent is more priority than information from other sources of passive authentication: User Agent and Cisco ISE.  This is logical, otherwise there would be no miracle.  Active authentication should not be used in conjunction with the TS Agent. </li></ul></div><p>Source: <a href="https://habr.com/ru/post/321876/">https://habr.com/ru/post/321876/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../321864/index.html">OpenResty: we turn NGINX into a full-fledged application server</a></li>
<li><a href="../321868/index.html">Exceptions in Windows x64. How it works. Part 1</a></li>
<li><a href="../321870/index.html">"Neuromorphic chips": a different look at machine learning</a></li>
<li><a href="../321872/index.html">GameDev from scratch: From the hackathon to your own game development studio. Part 1</a></li>
<li><a href="../321874/index.html">Noise functions and map generation</a></li>
<li><a href="../321878/index.html">UX: Why too much advertising is not user friendly</a></li>
<li><a href="../321880/index.html">Google launched the beta version of Cloud Spanner - NewSQL DBMS generation</a></li>
<li><a href="../321882/index.html">Install MLDonkey and DC ++ plugin for it</a></li>
<li><a href="../321884/index.html">PyNSK # 12 - February meeting of the Pitonists of Novosibirsk</a></li>
<li><a href="../321886/index.html">How IT professionals work. Andrei Makarov, Neti company</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>