<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>All you need to know about Node.js</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hi, Habr! I present to you the translation of the article "Everything you need to know about Node.js" by Jorge Ram√≥n. 





 Nowadays, Node.js platfor...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>All you need to know about Node.js</h1><div class="post__text post__text-html js-mediator-article"><p>  Hi, Habr!  I present to you the translation of the article <a href="https://dev.to/jorge_rockr/everything-you-need-to-know-about-node-js-lnc">"Everything you need to know about Node.js"</a> by Jorge Ram√≥n. </p><br><p><img src="https://habrastorage.org/webt/ua/qz/gr/uaqzgrarpig3cxhjdiuiutbxbms.jpeg"></p><br><p>  Nowadays, Node.js platform is one of the most popular platforms for building efficient and scalable REST API's.  It is also suitable for building hybrid mobile apps, desktop programs, and even IoT. </p><br><p>  I have been working with the Node.js platform for over 6 years and I really love it.  This post is mainly trying to be a guide to how Node.js actually works. </p><a name="habracut"></a><br><p>  Let's get started !! </p><br><p>  <strong>What will be discussed:</strong> </p><br><ul><li>  <a href="https://habr.com/ru/post/460661/">World to Node.js</a> </li><li>  <a href="https://habr.com/ru/post/460661/">C10K problem</a> </li><li>  <a href="https://habr.com/ru/post/460661/">Node.js and event loop</a> </li><li>  <a href="https://habr.com/ru/post/460661/">The problem of CPU-intensive tasks</a> </li><li>  <a href="https://habr.com/ru/post/460661/">Workers and their streams</a> </li></ul><br><a name="p1"></a><br><h3 id="mir-do-nodejs">  World to Node.js </h3><br><p>  <strong>Multithreaded server</strong> </p><br><p>  Web applications written according to the client / server architecture work as follows: the client requests the necessary resource from the server and the server sends the resource in response.  In this scheme, the server, responding to a request, terminates the connection. </p><br><p>  This model is effective since each request to the server consumes resources (memory, processor time, etc.).  In order to process each subsequent request from the client, the server must complete the processing of the previous one. </p><br><p>  Does this mean that the server can only process one request at a time?  Not really!  When the server receives a new request, it creates a separate <strong>stream</strong> to process it. </p><br><p>  <em>A thread</em> , if in simple terms, is the time and resources that the CPU allocates for executing a small block of instructions.  With that said, the server can process several requests at the same time, but only one per stream.  Such a model is also called the <strong>thread-per-request model</strong> . </p><br><p><img src="https://habrastorage.org/webt/mm/ns/gn/mmnsgnzvz7aptv62xrbo6zxju-w.jpeg"></p><br><p>  To process N requests, the server needs N threads.  If the server receives N + 1 requests, then it must wait until one of the threads becomes available. </p><br><p>  In the figure above, the server can process up to 4 requests (streams) at a time and when it receives the next 3 requests, these requests must wait until any of these 4 threads becomes available. </p><br><p>  One of the ways to get rid of the limitations is to add more resources (memory, processor cores, etc.) to the server, but this is not the best solution .... </p><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/yb/qz/zl/ybqzzljzkgej-kirqwza-43amcw.gif"></div><br><p>  And, of course, do not forget about technological limitations. </p><br><p>  <strong>Blocking I / O</strong> </p><br><p>  The limited number of threads on the server is not the only problem.  Perhaps you wondered why a single thread could not process several requests at the same time?  all because of <strong>blocking I / O operations</strong> . </p><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/ei/ao/02/eiao02s-dtpki8au6sybf8-dmbu.gif"></div><br><p>  Suppose you are developing an online store and you need a page where the user can view a list of all products. </p><br><p>  The user knocks on <a href="http://yourstore.com/products">http://yourstore.com/products</a> and the server renders an HTML file with all products from the database in response.  Not difficult at all, is it? </p><br><p>  But, what happens behind the scenes? </p><br><ul><li> When a user knocks on <code>/products</code> particular method or function must be executed to process the request.  A small piece of code (yours or framework) analyzes the URL of the request and looks for a suitable method or function.  <strong>The thread is working</strong> . <img width="20" src="https://habrastorage.org/webt/o1/sw/x5/o1swx5v-gnn2ptqjjzonhq3oew0.png"></li><li>  Now the necessary method or function is executed, as in the first paragraph - the <strong>thread works.</strong> <img width="20" src="https://habrastorage.org/webt/o1/sw/x5/o1swx5v-gnn2ptqjjzonhq3oew0.png"></li><li>  Since you are a good developer, you save all the system logs to a file, and of course, to be sure that the router performs the desired method / function - you also log the line "Method X executing !!". But all this is blocking operations I / O. <strong>Stream is waiting</strong> . <img width="20" src="https://habrastorage.org/webt/bq/lm/cq/bqlmcq7ntk4kpr2gncodmxpqqee.png"></li><li>  All logs are saved and the following function lines are executed.  <strong>The thread is running again</strong> . <img width="20" src="https://habrastorage.org/webt/o1/sw/x5/o1swx5v-gnn2ptqjjzonhq3oew0.png"></li><li>  Time to access the database and get all the products ‚Äî a simple query, like <code>SELECT * FROM products</code> , does its job, but guess what?  Yes, yes, this is a blocking I / O operation.  <strong>The flow is waiting</strong> . <img width="20" src="https://habrastorage.org/webt/bq/lm/cq/bqlmcq7ntk4kpr2gncodmxpqqee.png"></li><li>  You have received an array or a list of all the products, but make sure that you have all this secured.  <strong>The flow is waiting</strong> . <img width="20" src="https://habrastorage.org/webt/bq/lm/cq/bqlmcq7ntk4kpr2gncodmxpqqee.png"></li><li>  Now you have all the products and it's time to render the template for the future page, but before that you need to read them.  <strong>The flow is waiting</strong> . <img width="20" src="https://habrastorage.org/webt/bq/lm/cq/bqlmcq7ntk4kpr2gncodmxpqqee.png"></li><li>  The rendering engine does its job and sends a response to the client.  <strong>The thread is running again</strong> . <img width="20" src="https://habrastorage.org/webt/o1/sw/x5/o1swx5v-gnn2ptqjjzonhq3oew0.png"></li><li>  The stream is free, like a bird in heaven. <img width="20" src="https://habrastorage.org/webt/wr/vg/0_/wrvg0_hul5qltn9qpyg9fv6beua.png"></li></ul><br><p>  How slow are I / O operations?  Well, it depends on the specific.  Let's turn to the table: </p><br><div class="scrollable-table"><table><tbody><tr><th>  <b>Operation</b> </th><th>  <b>The number of CPU cycles</b> </th></tr><tr><td>  CPU Registers </td><td>  3 cycles </td></tr><tr><td>  L1 Cache </td><td>  8 cycles </td></tr><tr><td>  L2 cache </td><td>  12 cycles </td></tr><tr><td>  Ram </td><td>  150 cycles </td></tr><tr><td>  Disk </td><td>  30,000,000 cycles </td></tr><tr><td>  Network </td><td>  250,000,000 cycles </td></tr></tbody></table></div><br><p>  Network and disk reads are too slow.  Imagine how many requests or calls to external API your system could handle during this time. </p><br><p>  Summarizing: I / O operations make the thread wait and waste resources. </p><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/bg/qm/k1/bgqmk13cgzyfg7vmynzpkxdxbdc.gif"></div><br><a name="p2"></a><br><h3 id="problema-c10k">  C10K problem </h3><br><p>  <strong>Problem</strong> </p><br><p>  <b>C10k</b> (English <i>C10k; 10k connections</i> - the problem of 10 thousand connections) </p><br><p>  In the early 2000s, server and client machines were slow.  The problem arose with parallel processing of 10,000 client connections to a single machine. </p><br><p>  But why the traditional model of thread-per-request (stream on request) could not solve this problem?  Well, let's use some math. </p><br><p>  Native implementation of threads allocates more than 1 MB of memory per stream, leaving this - for 10 thousand threads 10 GB of RAM is required and this is only for the stack of threads.  Yes, and do not forget, we are in the early 2000s !! </p><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/af/99/xc/af99xcxnykot0wq-zv20o-6cvps.jpeg"></div><br><p>  Nowadays, server and client computers work faster and more efficiently and almost any programming language or framework can cope with this problem.  But in fact the problem is not exhausted.  For 10 million client connections to the same machine, the problem returns again (but now it is <a href="http://c10m.robertgraham.com/p/manifesto.html">C10M Problem</a> ). </p><br><p>  <strong>Javascript salvation?</strong> </p><br><p>  Beware, spoilers <img width="70" src="https://habrastorage.org/webt/vl/iw/8n/vliw8nxrmg8paobiiyvuozjxpdc.png">  !!! <br>  Node.js actually solves the C10K problem ... but how ?! </p><br><p>  Server-side JavaScript was not something new and unusual in the early 2000s, at that time there were already implementations on top of the JVM (java virtual machine) RingoJS and AppEngineJS that worked on the thread-per-request model. </p><br><p>  But if they could not solve the problem, then how could Node.js ?!  All because JavaScript is <strong>single-threaded</strong> . </p><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/lp/nx/vh/lpnxvhxjbmqmkzmblpqqmfcxq0s.gif"></div><br><a name="p3"></a><br><h3 id="nodejs-i-cikl-sobytiy">  Node.js and event loop </h3><br><p>  <strong>Node.js</strong> </p><br><p>  Node.js is a server platform that runs on the Google Chrome engine - V8, which can compile JavaScript code into native code. </p><br><p>  Node.js uses an <strong>event-oriented</strong> model and <strong>non-blocking I / O</strong> architecture, which makes it lightweight and efficient.  This is not a framework, and not a library, it is a JavaScript runtime environment. </p><br><p>  Let's write a small example: </p><br><pre> <code class="javascript hljs"><span class="hljs-comment"><span class="hljs-comment">// Importing native http module const http = require('http'); // Creating a server instance where every call // the message 'Hello World' is responded to the client const server = http.createServer(function(request, response) { response.write('Hello World'); response.end(); }); // Listening port 8080 server.listen(8080);</span></span></code> </pre> <br><p>  <strong>Non-blocking I / O</strong> </p><br><p>  Node.js uses non-blocking I / O operations, what does this mean: </p><br><ul><li>  The main thread will not be blocked by I / O operations. </li><li>  The server will continue to service requests. </li><li>  We have to work with <strong>asynchronous code</strong> . </li></ul><br><p>  Let's write an example in which a request to the <code>/home</code> server sends an HTML page in response, and for all other requests, a 'Hello World'.  To send an HTML page, you first need to read it from a file. </p><br><p> <code>home.html</code> </p> <br><pre> <code class="html hljs xml"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">html</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">body</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">h1</span></span></span><span class="hljs-tag">&gt;</span></span>This is home page<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">h1</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">body</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">html</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre> <br><p> <code>index.js</code> </p> <br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">const</span></span> http = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'http'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> fs = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'fs'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> server = http.createServer(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">request, response</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (request.url === <span class="hljs-string"><span class="hljs-string">'/home'</span></span>) { fs.readFile(<span class="hljs-string"><span class="hljs-string">`</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${ __dirname }</span></span></span><span class="hljs-string">/home.html`</span></span>, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">err, content</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!err) { response.setHeader(<span class="hljs-string"><span class="hljs-string">'Content-Type'</span></span>, <span class="hljs-string"><span class="hljs-string">'text/html'</span></span>); response.write(content); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { response.statusCode = <span class="hljs-number"><span class="hljs-number">500</span></span>; response.write(<span class="hljs-string"><span class="hljs-string">'An error has ocurred'</span></span>); } response.end(); }); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { response.write(<span class="hljs-string"><span class="hljs-string">'Hello World'</span></span>); response.end(); } }); server.listen(<span class="hljs-number"><span class="hljs-number">8080</span></span>);</code> </pre> <br><p>  If the requested url is <code>/home</code> , then the native <code>fs</code> module is used to read the <code>home.html</code> file. </p><br><p>  The functions that fall into <code>http.createServer</code> and <code>fs.readFile</code> as arguments are <strong>callbacks</strong> .  These functions will be performed at some point in the future (the first, as soon as the server receives the request, and the second, when the file is read from the disk and placed in the buffer). </p><br><p>  While the file is being read from disk, Node.js can process other requests and even read the file again and all this in one stream ... but how ?! </p><br><p>  <strong>Cycle of events</strong> </p><br><p>  <strong>The event loop</strong> is the magic that happens inside Node.js.  It is literally an endless loop and is actually one thread. </p><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/f_/sc/go/f_scgo68j5gpf0xsnzklzdr9cjc.jpeg"></div><br><p>  <strong>Libuv</strong> is a C library that implements this pattern and is part of the Node.js core.  You can learn more about libuv <a href="https://nikhilm.github.io/uvbook/introduction.html">here</a> . </p><br><p>  The event cycle has 6 phases, each performance of all 6 phases is called a <strong>tick</strong> . </p><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/2k/xy/eq/2kxyeqk7srzdocs9egzl5zlpwhm.png"></div><br><ul><li>  <strong>timers</strong> : this phase executes callbacks scheduled by the <code>setTimeout()</code> and <code>setInterval()</code> methods; </li><li>  <strong>pending callbacks</strong> : almost all <strong>callbacks</strong> are executed, except for <code>close</code> events, timers, and <code>setImmediate()</code> ; </li><li>  <strong>idle, prepare</strong> : used only for internal purposes; </li><li>  <strong>poll</strong> : responsible for receiving new I / O events.  Node.js can block at this stage; </li><li>  <strong>check</strong> : callbacks called by the <code>setImmediate()</code> method are executed at this stage; </li><li>  <strong>close callbacks</strong> : for example, <code>socket.on('close', ...)</code> ; </li></ul><br><p>  Well, there is only one thread, and this thread is the event loop, but then who performs all the I / O operations? </p><br><p>  note <img width="60" src="https://habrastorage.org/webt/92/8i/lj/928iljyzpqhkbczypvvqgkx0zc0.png">  !!! <br>  When an event loop needs to perform an I / O operation, it uses an OS thread from the thread pool, and when the task is completed, the callback is queued during the <em>pending callbacks</em> phase. </p><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/lz/z7/uw/lzz7uwcdvm1xd1yr6utj7cae36g.png"></div><br><p>  Isn't that cool? </p><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/it/yo/bh/ityobhc10qgnkk5m9yk5xp94ble.gif"></div><br><a name="p4"></a><br><h3 id="problema-cpu-yomkih-zadach">  The problem of CPU-intensive tasks </h3><br><p>  Node.js seems perfect!  You can create whatever you want. </p><br><p>  Let's write an API for computing prime numbers. </p><br><p>  A prime number is an integer (positive integer) number greater than one and divisible only by 1 and by itself. </p><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/nl/kn/7f/nlkn7fwr_kxhtktm-_gt0ci7ask.jpeg"></div><br><p>  Given the number N, the API should calculate and return the first N prime numbers in the list (or array). </p><br><p> <code>primes.js</code> </p> <br><pre> <code class="javascript hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">isPrime</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">n</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">for</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">let</span></span> i = <span class="hljs-number"><span class="hljs-number">2</span></span>, s = <span class="hljs-built_in"><span class="hljs-built_in">Math</span></span>.sqrt(n); i &lt;= s; i++) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(n % i === <span class="hljs-number"><span class="hljs-number">0</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">false</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> n &gt; <span class="hljs-number"><span class="hljs-number">1</span></span>; } } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">nthPrime</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">n</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> counter = n; <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> iterator = <span class="hljs-number"><span class="hljs-number">2</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> result = []; <span class="hljs-keyword"><span class="hljs-keyword">while</span></span>(counter &gt; <span class="hljs-number"><span class="hljs-number">0</span></span>) { isPrime(iterator) &amp;&amp; result.push(iterator) &amp;&amp; counter--; iterator++; } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> result; } <span class="hljs-built_in"><span class="hljs-built_in">module</span></span>.exports = { isPrime, nthPrime };</code> </pre> <br><p> <code>index.js</code> </p> <br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">const</span></span> http = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'http'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> url = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'url'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> primes = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'./primes'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> server = http.createServer(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">request, response</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> { pathname, query } = url.parse(request.url, <span class="hljs-literal"><span class="hljs-literal">true</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (pathname === <span class="hljs-string"><span class="hljs-string">'/primes'</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> result = primes.nthPrime(query.n || <span class="hljs-number"><span class="hljs-number">0</span></span>); response.setHeader(<span class="hljs-string"><span class="hljs-string">'Content-Type'</span></span>, <span class="hljs-string"><span class="hljs-string">'application/json'</span></span>); response.write(<span class="hljs-built_in"><span class="hljs-built_in">JSON</span></span>.stringify(result)); response.end(); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { response.statusCode = <span class="hljs-number"><span class="hljs-number">404</span></span>; response.write(<span class="hljs-string"><span class="hljs-string">'Not Found'</span></span>); response.end(); } }); server.listen(<span class="hljs-number"><span class="hljs-number">8080</span></span>);</code> </pre> <br><p>  <code>prime.js</code> is an implementation of the necessary computations: the <code>isPrime</code> function checks whether a number is simple, and nthPrime returns N such numbers. </p><br><p>  The <code>index.js</code> file is responsible for creating the server and uses the <code>prime.js</code> module to process each request for <code>/primes</code> .  The number N is prokibyvaetsya through the query string in the URL. </p><br><p>  To get the first 20 primes we need to make a request for <code>http://localhost:8080/primes?n=20</code> . </p><br><p>  Suppose 3 clients are knocking us and trying to get access to our non-blocking I / O API: </p><br><ul><li>  The first asks for 5 prime numbers every second. </li><li>  The second requests 1000 prime numbers every second. </li><li>  The third is requesting 10,000,000,000 primes, but ... </li></ul><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/pz/rx/bl/pzrxblziplf06w7-kzbyojhafhg.gif"></div><br><p>  When a third client sends a request, the main thread is blocked and this is the main symptom of a <strong>CPU-intensive task problem</strong> .  When the main thread is busy with the execution of a ‚Äúheavy‚Äù task, it becomes unavailable for other tasks. </p><br><p>  But what about libuv?  If you remember, this library helps Node.js to perform I / O operations using OS threads, avoiding blocking the main thread, and you are absolutely right, this is a solution to our problem, but in order for this to be possible, our module must be written in C ++ so that libuv can work with it. </p><br><p>  Fortunately, starting with v10.5, the native <strong>Worker Threads</strong> module has been added to Node.js. </p><br><a name="p5"></a><br><h3 id="vorkery-i-ih-potoki">  Workers and their streams </h3><br><p>  As the <a href="https://nodejs.org/api/worker_threads.html">documentation</a> tells us: </p><br><blockquote>  Workers are useful for performing CPU-intensive JavaScript operations;  do not use them for I / O operations, mechanisms already built into Node.js are more efficient in coping with such tasks than Worker thread. </blockquote><p>  <strong>Code fix</strong> </p><br><p>  It's time to rewrite our code: </p><br><p> <code>primes-workerthreads.js</code> </p> <br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">const</span></span> { workerData, parentPort } = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'worker_threads'</span></span>); <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">isPrime</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">n</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">for</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">let</span></span> i = <span class="hljs-number"><span class="hljs-number">2</span></span>, s = <span class="hljs-built_in"><span class="hljs-built_in">Math</span></span>.sqrt(n); i &lt;= s; i++) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(n % i === <span class="hljs-number"><span class="hljs-number">0</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">false</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> n &gt; <span class="hljs-number"><span class="hljs-number">1</span></span>; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">nthPrime</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">n</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> counter = n; <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> iterator = <span class="hljs-number"><span class="hljs-number">2</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> result = []; <span class="hljs-keyword"><span class="hljs-keyword">while</span></span>(counter &gt; <span class="hljs-number"><span class="hljs-number">0</span></span>) { isPrime(iterator) &amp;&amp; result.push(iterator) &amp;&amp; counter--; iterator++; } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> result; } parentPort.postMessage(nthPrime(workerData.n));</code> </pre> <br><p> <code>index-workerthreads.js</code> </p> <br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">const</span></span> http = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'http'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> url = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'url'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> { Worker } = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'worker_threads'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> server = http.createServer(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">request, response</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> { pathname, query } = url.parse(request.url, <span class="hljs-literal"><span class="hljs-literal">true</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (pathname === <span class="hljs-string"><span class="hljs-string">'/primes'</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> worker = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Worker(<span class="hljs-string"><span class="hljs-string">'./primes-workerthreads.js'</span></span>, { <span class="hljs-attr"><span class="hljs-attr">workerData</span></span>: { <span class="hljs-attr"><span class="hljs-attr">n</span></span>: query.n || <span class="hljs-number"><span class="hljs-number">0</span></span> } }); worker.on(<span class="hljs-string"><span class="hljs-string">'error'</span></span>, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ response.statusCode = <span class="hljs-number"><span class="hljs-number">500</span></span>; response.write(<span class="hljs-string"><span class="hljs-string">'Oops there was an error...'</span></span>); response.end(); }); <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> result; worker.on(<span class="hljs-string"><span class="hljs-string">'message'</span></span>, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">message</span></span></span><span class="hljs-function">) </span></span>{ result = message; }); worker.on(<span class="hljs-string"><span class="hljs-string">'exit'</span></span>, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ response.setHeader(<span class="hljs-string"><span class="hljs-string">'Content-Type'</span></span>, <span class="hljs-string"><span class="hljs-string">'application/json'</span></span>); response.write(<span class="hljs-built_in"><span class="hljs-built_in">JSON</span></span>.stringify(result)); response.end(); }); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { response.statusCode = <span class="hljs-number"><span class="hljs-number">404</span></span>; response.write(<span class="hljs-string"><span class="hljs-string">'Not Found'</span></span>); response.end(); } }); server.listen(<span class="hljs-number"><span class="hljs-number">8080</span></span>);</code> </pre> <br><p>  In the <code>index-workerthreads.js</code> , each request for <code>/primes</code> creates an instance of the <code>Worker</code> class (from the native module <code>worker_threads</code> ) to upload and execute the <code>primes-workerthreads.js</code> file <code>primes-workerthreads.js</code> stream.  When the list of primes is calculated and ready, the <code>message</code> event is triggered - the result falls into the main thread due to the fact that the worker has no work left, he also triggers the <code>exit</code> event, allowing the main thread to send data to the client. </p><br><p>  <code>primes-workerthreads.js</code> changed a bit.  It imports <code>workerData</code> (this is a copy of the parameters passed from the main thread) and <code>parentPort</code> through which the result of the worker's robots is passed back to the main thread. </p><br><p>  Now let's try our example again and see what happens: </p><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/zu/vk/gh/zuvkghy8dnhjryfdf5b62ped8dw.gif"></div><br><p>  The main thread is no longer blocked. <img width="115" src="https://habrastorage.org/webt/nn/hs/r3/nnhsr3jiw_4aed53jye8gokutpy.png">  !!!!! </p><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/tt/ij/el/ttijelgt36k_vbengx3qjaaajlc.gif"></div><br><p>  Now everything works as it should, but it‚Äôs still not a good practice to produce workers without any reason, to create streams is not a cheap pleasure.  Be sure to create a thread pool before this. </p><br><h4 id="zaklyuchenie">  Conclusion </h4><br><p>  Node.js is a powerful technology worth exploring when possible. <br>  My personal recommendation - always be curious!  If you know how something works from the inside, you can work with it more effectively. </p><br><p>  This is all for today, guys.  I hope this post was useful for you and you have learned something new about Node.js. </p><br><p>  Thanks for reading and see you in the next posts. <img width="20" src="https://habrastorage.org/webt/bd/lk/kd/bdlkkdf7adtljydvhxyw22y3cfi.png">  . </p></div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <p>Source: <a href="https://habr.com/ru/post/460661/">https://habr.com/ru/post/460661/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../460647/index.html">The solution to the task with pwnable.kr 05 - passcode. Rewriting the procedure link table via format string vulnerability</a></li>
<li><a href="../460651/index.html">Meeting of the Society of Anonymous Testers: TMS, monitoring monitoring, search quality assessment and native iOS tests</a></li>
<li><a href="../460655/index.html">How I broke Telegram</a></li>
<li><a href="../460659/index.html">We use pipe for pivoting</a></li>
<li><a href="../46066/index.html">Sequential - free photo viewer for Mac OS X</a></li>
<li><a href="../460665/index.html">Draft FAQ: Why do C ++ standards come out every three years?</a></li>
<li><a href="../460669/index.html">How to ensure the safety of development, saving time and nerves</a></li>
<li><a href="../460671/index.html">Ownership and borrowing in D</a></li>
<li><a href="../460675/index.html">Retrieving machine learning data</a></li>
<li><a href="../46068/index.html">Formatting Long SQL Queries</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>