<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>MySQL Performance real life Tips and Tricks. To be continued.</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="At the request of workers decided to write another article on query optimization in MySQL. 

 The last article on habrahabr.ru/blogs/mysql/38907 addre...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>MySQL Performance real life Tips and Tricks. To be continued.</h1><div class="post__text post__text-html js-mediator-article">  At the request of workers decided to write another article on query optimization in MySQL. <br><br>  The last article on <a href="http://habrahabr.ru/blogs/mysql/38907/">habrahabr.ru/blogs/mysql/38907</a> addressed optimization issues of LIMIT, GROUP BY, COUNT. <br><br>  In this article, I will return to the above and describe a couple of examples that I encountered recently on the project, after that I will give a few more small examples about what is good and what is bad in MySQL. <br><a name="habracut"></a><br>  Returning to the topic of large LIMIT requests.  For example, we have such a request, which pulls out of the database the pictures and user names that these pictures are laid out, and we pull this information for pictures with ID&gt; 2500 and we are interested in the results from 5000 to 5100. (In this example, you should pay attention to request structure). <br>  So, what should our query do in this case: <br>  1. Of the many pages of `tx_localrep_images` as tli <br>  2. From them we select those that satisfy the condition tli.uid&gt; 2500 <br>  3. Further, because  we have a LEFT JOIN, then the number of results (records) in the resulting sample does not depend on the gluing, therefore MySQL could well do the LIMIT on the sample that we have at this point (obtained after step 2) and only after that start gluing with the `fe_users` table.  BUT MySQL does NOT do this! <br>  And he does the following: he does the gluing first, and only then cuts off the first ‚Äúunnecessary‚Äù 5000 records !!! 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <blockquote>  <font color="black"><font color="#0000ff">SELECT</font></font> <font color="black"><br></font>  <font color="black">SQL_NO_CACHE tli.`.uid`, tli.`caption`, fe`.username`</font> <font color="black"><br></font>  <font color="black"><font color="#0000ff">FROM</font></font> <font color="black"><br></font>  <font color="black">`tx_localrep_images` <font color="#0000ff">as</font> tli</font> <font color="black"><br></font>  <font color="black"><font color="#0000ff">LEFT</font> <font color="#0000ff">JOIN</font></font> <font color="black"><br></font>  <font color="black">`fe_users` <font color="#0000ff">as</font> fe ON` tli`.</font>  <font color="black">cruser_id = fe.uid</font> <font color="black"><br></font>  <font color="black"><font color="#0000ff">WHERE</font></font> <font color="black"><br></font>  <font color="black">tli.uid&gt; 2500</font> <font color="black"><br></font>  <font color="black"><font color="#0000ff">LIMIT</font></font> <font color="black"><br></font>  <font color="black">5000, 100;</font> <br>  <font color="gray">* This source code was highlighted with <a href="http://source.virtser.net/"><font color="gray">Source Code Highlighter</font></a> .</font> </blockquote><br><br>  This is not the behavior that we expected, but it does not matter!  There is a very simple solution to this problem with DERIVED TABLE.  Here such a request is performed much faster (the difference in execution speed is directly proportional to the number of entries in LIMIT) <br><br><blockquote>  <font color="black"><font color="#0000ff">SELECT</font></font> <font color="black"><br></font>  <font color="black">SQL_NO_CACHE tli.`.uid`, tli.`caption`, fe`.username`</font> <font color="black"><br></font>  <font color="black"><font color="#0000ff">FROM</font></font> <font color="black"><br></font>  <font color="black">(</font> <font color="black"><br></font>  <font color="black"><font color="#0000ff">SELECT</font></font> <font color="black"><br></font>  <font color="black">tli.` uid`, tli.`caption`, tli.`cruser_id`</font> <font color="black"><br></font>  <font color="black"><font color="#0000ff">FROM</font></font> <font color="black"><br></font>  <font color="black">`tx_localrep_images` <font color="#0000ff">as</font> tli</font> <font color="black"><br></font>  <font color="black"><font color="#0000ff">WHERE</font></font> <font color="black"><br></font>  <font color="black">tli.uid&gt; 2500</font> <font color="black"><br></font>  <font color="black"><font color="#0000ff">LIMIT</font></font> <font color="black"><br></font>  <font color="black">5000, 100</font> <font color="black"><br></font>  <font color="black">) <font color="#0000ff">as</font> tli</font> <font color="black"><br></font>  <font color="black"><font color="#0000ff">LEFT</font> <font color="#0000ff">JOIN</font></font> <font color="black"><br></font>  <font color="black">`fe_users` <font color="#0000ff">as</font> fe ON` tli`.</font>  <font color="black">cruser_id = fe.uid;</font> <br>  <font color="gray">* This source code was highlighted with <a href="http://source.virtser.net/"><font color="gray">Source Code Highlighter</font></a> .</font> </blockquote><br><br>  After that, I decided to experiment a little how MySQL optimizer works with queries of the form SELECT (*) <br><br>  Accordingly, there is such a standard query. <br><br><blockquote>  <font color="black"><font color="#0000ff">SELECT</font></font> <font color="black"><br></font>  <font color="black">SQL_NO_CACHE <font color="#0000ff">count</font> (*)</font> <font color="black"><br></font>  <font color="black"><font color="#0000ff">FROM</font></font> <font color="black"><br></font>  <font color="black">`tx_localrep_images` <font color="#0000ff">as</font> tli</font> <font color="black"><br></font>  <font color="black"><font color="#0000ff">WHERE</font></font> <font color="black"><br></font>  <font color="black">tli.uid&gt; 500;</font> <font color="black"><br></font> <br>  <font color="gray">* This source code was highlighted with <a href="http://source.virtser.net/"><font color="gray">Source Code Highlighter</font></a> .</font> </blockquote><br><br>  There is such a less standard.  I ask the distinguished community not to write that the LEFT JOIN in this query does not make sense, because  does not affect the number of records in the resulting sample.  This is clear to everyone ... everyone except MySQL optimizer :-), which will properly perform the gluing, and then it will calculate the number of records in it. <br><br><blockquote>  <font color="black"><font color="#0000ff">SELECT</font></font> <font color="black"><br></font>  <font color="black">SQL_NO_CACHE <font color="#0000ff">count</font> (*)</font> <font color="black"><br></font>  <font color="black"><font color="#0000ff">FROM</font></font> <font color="black"><br></font>  <font color="black">`tx_localrep_images` <font color="#0000ff">as</font> tli</font> <font color="black"><br></font>  <font color="black"><font color="#0000ff">LEFT</font> <font color="#0000ff">JOIN</font></font> <font color="black"><br></font>  <font color="black">`fe_users` <font color="#0000ff">as</font> fe ON` tli`.</font>  <font color="black">cruser_id = fe.uid</font> <font color="black"><br></font>  <font color="black"><font color="#0000ff">WHERE</font></font> <font color="black"><br></font>  <font color="black">tli.uid&gt; 500;</font> <br>  <font color="gray">* This source code was highlighted with <a href="http://source.virtser.net/"><font color="gray">Source Code Highlighter</font></a> .</font> </blockquote><br><br>  Therefore, this request for a relatively small data set (50,000 rows) is executed 20 times slower. <br><br>  <b>COUNT (*) vs COUNT (column_name)</b> <br><br>  Noticed more than once that many believe that COUNT (*) is a COUNT alias (column_name).  This is absolutely not true. <br><br>  First, these queries can return different results.  This can occur when the column column_name may contain NULL values.  Those.  The COUNT construction (column_name) returns the number of records with column_name IS NOT NULL. <br><br>  Secondly, these requests are executed at different speeds.  For example, such a request <br><br><blockquote>  <font color="black"><font color="#0000ff">SELECT</font></font> <font color="black"><br></font>  <font color="black">SQL_NO_CACHE <font color="#0000ff">count</font> (tli.` type`)</font> <font color="black"><br></font>  <font color="black"><font color="#0000ff">FROM</font></font> <font color="black"><br></font>  <font color="black">`tx_localrep_images` <font color="#0000ff">as</font> tli</font> <font color="black"><br></font>  <font color="black"><font color="#0000ff">WHERE</font></font> <font color="black"><br></font>  <font color="black">tli.uid&gt; 500;</font> <br>  <font color="gray">* This source code was highlighted with <a href="http://source.virtser.net/"><font color="gray">Source Code Highlighter</font></a> .</font> </blockquote><br><br>  can perform much longer <br><br><blockquote>  <font color="black"><font color="#0000ff">SELECT</font></font> <font color="black"><br></font>  <font color="black">SQL_NO_CACHE <font color="#0000ff">count</font> (*)</font> <font color="black"><br></font>  <font color="black"><font color="#0000ff">FROM</font></font> <font color="black"><br></font>  <font color="black">`tx_localrep_images` <font color="#0000ff">as</font> tli</font> <font color="black"><br></font>  <font color="black"><font color="#0000ff">WHERE</font></font> <font color="black"><br></font>  <font color="black">tli.uid&gt; 500;</font> <br><br>  <font color="gray">* This source code was highlighted with <a href="http://source.virtser.net/"><font color="gray">Source Code Highlighter</font></a> .</font> </blockquote><br><br>  because  a query using COUNT (*), if there is an index across the tli.uid field, will use the covering index and, accordingly, it will be executed very quickly.  The first query will look for the COUNT method ROW SCAN, which is what ‚ÄúExtra: USING WHERE‚Äù says in the EXPLAIN of this query. <br><br>  In fact, it is possible to make the first query use a covering index. To do this, add the following index to this table. <br><br><blockquote>  <font color="black"><font color="#0000ff">alter</font> <font color="#0000ff">table</font> `tx_localrep_images` <font color="#0000ff">add</font> <font color="#0000ff">key</font> cover_key (uid, type);</font> <br>  <font color="gray">* This source code was highlighted with <a href="http://source.virtser.net/"><font color="gray">Source Code Highlighter</font></a> .</font> </blockquote><br><br>  But IMHO, rather than introducing additional indexes, for a single query that uses them, and which take up too much disk space and what is most noticeable in the cache, and also slows down our data changes (UPDATE, INSERT, DELETE), it‚Äôs better to use COUNT (*) <br><br>  <b>Fields declared as DEFAULT NULL</b> <br><br>  Also if I made a reservation and cited as an example saying that a column can be declared as DEFAULT NULL. <br>  I‚Äôll say right away that it‚Äôs better not to declare such columns at all if you don‚Äôt initially plan to store NULL values.  There are many tasks where there is no need to store NULL values, however, many create tables containing NULL values.  The storage of NULL values ‚Äã‚Äãcomplicates the work of the internal MySQL mechanism, namely, working with indexes on these fields and maintaining statistics on indexes, as well as comparing values ‚Äã‚Äãon such fields. <br><br>  It is a number of reasons why there is a fixed-size index.  It can be a null.  Consider using zero, a special value, or an empty string instead.  It‚Äôs not a problem.  However, if you‚Äôre planning to index the columns, avoid them if possible.  ¬© - High Performance MySQL, Second Edition <br><br>  <b>The length of the field INT (length)</b> <br><br>  A little distracted, and I will say a few words about data storage, in general in this article I was not going to talk about it.  but now there was a conversation with one grief optimizer ... Accordingly, I will add a couple of lines and about this, maybe among the community there are those who repeat his mistakes ... <br><br>  As you know, it is better to select data types for columns that are minimal enough to store the entire range of values ‚Äã‚Äãin it.  Those.  sometimes people use int where they can calmly use tiny int, etc. <br><br>  In MySQL, when creating tables, you can specify the length of the fields, something like `column` int (10) UNSIGNED NOT NULL <br>  So, I found the creation of tables in which the field length values ‚Äã‚Äãwere different from 1 to 20. As it turned out, some people think that MySQL will allocate such an amount of memory to store the field in order to accommodate its maximum value.  Maybe badly explained.  I will show an example.  Take this ad: <br>  `column` int (10) UNSIGNED NOT NULL <br>  well, some think that mysql will do the following <br>  1. create a number of 10 9-k (maximum number), i.e.  999999999 <br>  2. find the degree of 2-ki minimum sufficient (ie, the minimum of the large) to store this number, that is, in our case <br>  2 ^ 30 = 1073741824 <br>  3. This value is rounded up to bytes, i.e.  up to 32 = 4 bytes <br><br>  <b>In general, the whole algorithm described above has nothing to do with real life!</b> <br>  In fact, for MySQL, under the INT (1) field, the same amount of memory will be allocated for storage as under INT (20). <br>  Because  This value is used to display values, i.e.  size of reserved space.  For example, when we execute requests through the command-line interface, etc. <br><br>  <b>Storing IP addresses in the database.</b> <br><br>  By the way, I have already moved away from the topic of the article, so I‚Äôll bring the last trick, which many people actually use, except for beginners, but for them I will write it. <br>  Very often I see that people store an IP address in the database using the VARCHAR data type (15), this is very uneconomic, moreover, it works rather slowly in searches on the range <br>  To store IP addresses in MySQL, there are 2-fii. <br>  The first is INET_ATON <br>  Allows you to convert a string consisting of 4 numbers separated by dots into an INT UNSIGNED value. <br>  This is done according to this algorithm. <br><br>  SELECT INET_ATON ('XYZJ'); <br><br>  X * 256 ^ 3 + Y * 256 ^ 2 + Z * 256 ^ 1 + J * 256 ^ 0 <br><br>  The INET_NTOA function performs the inverse conversion (from a number, to the usual IP address type separated by dots). <br><br>  Accordingly, all we need is to create a UNSIGNED INT field in the table that will hold the number converted by the INET_ATON function. <br><br>  Accordingly, if we want to, say, perform a search and retrieve all IP addresses from a subnet, say 255.255.0.0 <br><br>  Then you can perform such a request <br><br><blockquote>  <font color="black"><font color="#0000ff">SELECT</font></font> <font color="black"><br></font>  <font color="black">ip</font> <font color="black"><br></font>  <font color="black"><font color="#0000ff">FROM</font></font> <font color="black"><br></font>  <font color="black">`ips`</font> <font color="black"><br></font>  <font color="black"><font color="#0000ff">WHERE</font></font> <font color="black"><br></font>  <font color="black">`ips`.ip&gt; INET_ATON ( <font color="#A31515">'255.255.0.0'</font> )</font> <br>  <font color="gray">* This source code was highlighted with <a href="http://source.virtser.net/"><font color="gray">Source Code Highlighter</font></a> .</font> </blockquote><br>  That if there is an index on the ip field, it will be rather fast. <br><br>  And the last thing is always think what the optimal type of data you can choose to store the field you need! <br>  For example, to store a <a href="http://ru.wikipedia.org/wiki/%25D0%259C%25D0%25B0%25D1%2581%25D0%25BA%25D0%25B0_%25D0%25BF%25D0%25BE%25D0%25B4%25D1%2581%25D0%25B5%25D1%2582%25D0%25B8">subnet mask,</a> some will choose VARCHAR (15), some will choose INT and use the INET_ATON, INET_NTOA functions.  <b>But the correct options in this case</b> is to select the TINY INT field to store the number of units. <br><br>  On this probably finish.  I'm tired of writing. <br>  Shl.  Leave an opinion in the comments whether you are interested or not.  If not, write so: ‚ÄúSpare us, golden antelope!  Enough! ‚Äù <br><br>  ZZY.  Thanks to the habr-community for advice on the layout of articles and the presentation of the material.  In particular,% hlomzik% and% maxshopen% <br></div><p>Source: <a href="https://habr.com/ru/post/39260/">https://habr.com/ru/post/39260/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../392589/index.html">pyLCI - front end for Raspberry Pi and other Linux devices</a></li>
<li><a href="../39259/index.html">16 very expensive gadgets that suit a luxurious lifestyle</a></li>
<li><a href="../392591/index.html">A passenger who has fallen asleep in Uber and has rolled back the extra 20 miles to ¬£ 105 has returned his money</a></li>
<li><a href="../392595/index.html">A new record: a pig's heart transplanted to a baboon has been around for over two years.</a></li>
<li><a href="../392599/index.html">Empty space is not really empty [Voice Vert Dider]</a></li>
<li><a href="../392601/index.html">The first telephoto lens used for filming on the moon, put up for auction</a></li>
<li><a href="../392603/index.html">To be healthy for retirement, you need to constantly engage in sports.</a></li>
<li><a href="../392605/index.html">Photo booth do it yourself</a></li>
<li><a href="../392607/index.html">Internet on ISS</a></li>
<li><a href="../392609/index.html">We rewrite the arduino code for MSP430 using the example of nRF24_multipro, a project for managing toy multicopters</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>