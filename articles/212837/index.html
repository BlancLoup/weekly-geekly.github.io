<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>The basics of creating a 2D character in Godot. Part 2: compiling templates, a little about GDScript, movement and animation of the hero</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="In the previous article we looked at the basics of creating a new project in Godot . And with this superficial knowledge, one can only look at the dem...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>The basics of creating a 2D character in Godot. Part 2: compiling templates, a little about GDScript, movement and animation of the hero</h1><div class="post__text post__text-html js-mediator-article">  In the previous <a href="http://habrahabr.ru/post/212583/">article</a> we looked at the basics of creating a new project in <a href="http://www.godotengine.org/wp/">Godot</a> .  And with this superficial knowledge, one can only look at the demo versions of games. <br><img src="https://habrastorage.org/getpro/habr/post_images/a94/96b/098/a9496b0987731c54aa939416775f75d7.png"><br>  In the second part of the agenda we have: <br>  1) Export the finished project into binary files for the selected architecture. <br>  2) New animations.  Character options. <br>  3) Management. <br>  3) GDScript.  Welcome to real coding! <br>  4) Import the simplest Tilesets. <br>  5) Bonus: analysis of the device of the simplest backs. <br><br>  Well, as usual, a lot of pictures! <br><br><a name="habracut"></a><br><h5>  Compilation....? </h5>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      In the last article I mentioned that the authors did not provide binaries for linux x86.  At the time of writing, the binary files were still not ready.  But I already wanted to export finished projects, demo or just tests.  But what if there are no export templates?  Right!  Compile them yourself! <br><br>  Go to the source directory and compile <br><br><pre><code class="bash hljs"><span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> ./godot</code> </pre> <br>  Debugging Tools: <br><br><pre> <code class="bash hljs">scons bin/godot target=release_debug tools=no</code> </pre> <br>  After successful compilation, rename the newly received file to linux_x11_32_debug <br><br>  Export template itself: <br><br><pre> <code class="bash hljs">scons bin/godot_rel target=release tools=no</code> </pre> <br>  Rename to linux_x11_32_release <br><br>  We pack in a zip-archive. <br><br><pre> <code class="bash hljs">find ./* -name <span class="hljs-string"><span class="hljs-string">"linux_x11_32_*"</span></span> -<span class="hljs-built_in"><span class="hljs-built_in">exec</span></span> zip ./linux_x11_32_templates.zip <span class="hljs-string"><span class="hljs-string">"{}"</span></span> +</code> </pre> <br>  Feed the Godot archive.  Voila, now you can export a project for GNU / Linux OS of any digit capacity. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/422/caa/9b1/422caa9b1e7cce2b26fb96bc111d1b24.png"><br><br>  Yes, even under the OS and bit, different from yours.  Binary files for Windows without problems could get in wine, the main thing is not to forget to remove or put a tick 64bits, and turn off debugging, if not needed. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/27f/323/f7a/27f323f7abaeebaca6e5de852b6fb6bd.png"><br><br>  More information about <a href="http://www.godotengine.org/wiki/doku.php%3Fid%3Dexport">export</a> settings can be read on <a href="http://www.godotengine.org/wiki/doku.php%3Fid%3Dexport_pc">the</a> project <a href="http://www.godotengine.org/wiki/doku.php%3Fid%3Dexport_pc">website</a> in English.  If it is relevant and in demand, it will be possible to think about the Russian localization of articles and the creation of a Russian-language wiki on Godot. <br><br><h5>  Animation running and jumping </h5><br><br>  In the last lesson, I prepared a texture in advance with the sprites of running and jumping our Captain.  So I think to create two animations for jumping and run is not difficult.  I think it will not be difficult to do.  Let me just say the parameters: <br><pre> <code class="python hljs">run: Len(s): <span class="hljs-number"><span class="hljs-number">0.9</span></span> Step(s): <span class="hljs-number"><span class="hljs-number">0.1</span></span> Looping: yes jumping: Len(s): <span class="hljs-number"><span class="hljs-number">1</span></span> Step(s): <span class="hljs-number"><span class="hljs-number">0.1</span></span> Animation: ‚óã‚óã‚óã‚óã‚óã‚óã‚óã ,   -    <span class="hljs-number"><span class="hljs-number">24</span></span>  <span class="hljs-number"><span class="hljs-number">30</span></span>,   -  . Looping: no</code> </pre><br><img src="https://habrastorage.org/getpro/habr/post_images/d8a/941/861/d8a941861eb31198c2eea548c9f792b0.png"><br><br>  Yes, a jump is only a jump.  So you need another drop animation. <br><pre> <code class="python hljs">falling: Len(s): <span class="hljs-number"><span class="hljs-number">0.1</span></span> Step(s): <span class="hljs-number"><span class="hljs-number">0.1</span></span> Animation:  ‚Ññ<span class="hljs-number"><span class="hljs-number">30</span></span> Looping: yes</code> </pre><br><h6>  Character options </h6><br><br>  Three points: <br><br><ul><li>  Camera </li><li>  Touch with the ground </li><li>  Character Geometry </li></ul><br><br>  1) I remind you.  Check whether the Camera2D / Current parameter is checked, which is responsible for linking the camera object to the player object. <br><br>  2) Add Node CollisionShape2D.  This "Noda" is responsible for the position of our Captain in 2D-space. <br><img src="https://habrastorage.org/getpro/habr/post_images/b45/ea7/ffd/b45ea7ffddc73062ffb7561cfea554bd.png"><br>  In the Inspector choose CollisionShape2D -&gt; Shape -&gt; New RayShape2D.  In 2 millimeters a small arrow will appear to the right - click on it - the RayShape2D parameters will open. <br>  The RayShape2D / Lenght parameter will leave 20, but Custom Solver Bias will be set to 0.5 (this will allow a small offset) <br>  Now in the game itself in the future, if the character ‚Äúdoes not hit the feet on the floor,‚Äù his position can be adjusted with this arrow.  She's the one who checks "whether the sprite touches the floor." <br><br>  3) With geometry more fun.  First you need to add Node CollisionPolygon2D.  Now we need to draw this same polygon, giving the character a ‚Äúmass.‚Äù That is, it is necessary to draw what the hero will ‚Äúbeat against the walls‚Äù when confronting them.  Otherwise, it will simply pass through the walls. <br><img src="https://habrastorage.org/getpro/habr/post_images/306/f89/253/306f89253606be71c674cc3f9cb5ae80.png"><br>  Choose a pencil.  Now left-click "set" 3 vertices of the triangle.  Two on each of the shoulders, and one in the abdomen.  And right-click (just click on the workspace) draw a triangle.  It is desirable that he eventually turned out isosceles or equilateral.  With the bottom vertex on the Y axis. Now we will increase it.  Little.  Otherwise, the character will pass through the ceiling for example. <br><img src="https://habrastorage.org/getpro/habr/post_images/5a6/975/8cf/5a69758cfef71e2f3405ffcf1f604484.png"><br><br>  Done, our character - the dummy is ready.  Now the easiest - management. <br><br><h5>  Creating control keys </h5><br><br><ol><li>  Standard management. <br><br>  Creating this is pretty easy.  Go to Scene -&gt; Project Settings -&gt; Input Map <br><img src="https://habrastorage.org/getpro/habr/post_images/31b/123/d07/31b123d0796a8ce903807395e51ece2b.png"><br>  Create 3 control keys - move_left, move_right and jump.  Assign them keys.  Done! <br>  As you can see, Godot can work with gamepads, though for everyone it will be necessary to set up their own controls.  But more about that some other time. <br></li><li>  Office with touchscreen. <br>  Here, too, especially nothing complicated.  We are tied to our hero Node CanvasLayer with the name "ui".  And to her in turn - 3 copies of the TouchScreenButton.  We call them left, right and jump. <br>  To each bind the image of the key.  They will immediately appear in the working area of ‚Äã‚Äãthe program.  We arrange as it seems to us more convenient.  Do not forget that the blue window - this is the "display area of ‚Äã‚Äãthe camera." <br>  In the Action sections we enter the parameters move_left, move_right and jump, respectively.  Well, set the parameter Visibility Mode in TouchScreen Only.  Done! <img src="https://habrastorage.org/getpro/habr/post_images/605/6a8/0eb/6056a80eb678b76fd06d62202a8aced5.png"><br></li></ol><br><br><h5>  GDScript </h5><br><br>  Here I am a bit in a stupor.  The fact is that of me the programmer is honestly not very.  I myself do not understand much.  And I read books on Python to better understand the issue.  Because GDScript is very similar to it. <br><h6>  Attention! </h6><ul><li>  The engine does not understand Cyrillic.  But if you accidentally write something on it, it simply does not display it.  And just marks the entire line with it, as one big mistake. </li><li>  Indentation is very important.  Not there is an indent - and the hero can fall into the floor, the wrong functions can be performed. </li><li>  I repeat once again, I am a noob in programming, but I will try to explain everything as simply as possible. </li></ul><br><br>  A small request - if you know how to arrange better - please write.  I will be glad to take into account all the comments. <br><br>  Let me remind you of the previous code for displaying the simplest animation: <br><div class="spoiler">  <b class="spoiler_title">What happened</b> <div class="spoiler_text"><pre> <code class="python hljs">extends RigidBody2D var anim=<span class="hljs-string"><span class="hljs-string">""</span></span> func _integrate_forces(s): var new_anim=anim new_anim=¬´idle¬ª <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (new_anim!=anim): anim=new_anim get_node(¬´anim¬ª).play(anim)</code> </pre></div></div><br>  Add and modify code: <br><div class="spoiler">  <b class="spoiler_title">Declare variables</b> <div class="spoiler_text"><pre> <code class="python hljs">extends RigidBody2D var anim=<span class="hljs-string"><span class="hljs-string">""</span></span> <span class="hljs-comment"><span class="hljs-comment">#  var siding_left=false #   var jumping=false #  var stopping_jump=false #   var WALK_ACCEL = 800.0 #    var WALK_DEACCEL= 800.0 #  var WALK_MAX_VELOCITY= 800.0 #  var GRAVITY = 900.0 # var AIR_ACCEL = 200.0 #      var AIR_DEACCEL= 200.0 #  (   )  . ,         Mario Bros' var JUMP_VELOCITY=460 #  var STOP_JUMP_FORCE=900.0 #   var MAX_FLOOR_AIRBORNE_TIME = 0.15 # ,     . - ,       .  ,    ""   . var airborne_time=1e20 #   var floor_h_velocity=0.0</span></span></code> </pre></div></div><br>  We start the function integrate_forces.  Here is what Help says: <br>  Modify the function to use your interaction physics.  Well, that's what we'll do. <br>  PS I do not know how to comment on the code further.  So just leave it like this: <br><div class="spoiler">  <b class="spoiler_title">We write interaction function</b> <div class="spoiler_text"><pre> <code class="python hljs">func _integrate_forces(s): var lv = s.get_linear_velocity() var step = s.get_step() var new_anim=anim var new_siding_left=siding_left</code> </pre> </div></div><div class="spoiler">  <b class="spoiler_title">Get control</b> <div class="spoiler_text"><pre> <code class="python hljs"> var move_left = Input.is_action_pressed(<span class="hljs-string"><span class="hljs-string">"move_left"</span></span>) var move_right = Input.is_action_pressed(<span class="hljs-string"><span class="hljs-string">"move_right"</span></span>) var jump = Input.is_action_pressed(<span class="hljs-string"><span class="hljs-string">"jump"</span></span>) <span class="hljs-comment"><span class="hljs-comment">#   x () lv.x-=floor_h_velocity floor_h_velocity=0.0</span></span></code> </pre></div></div><div class="spoiler">  <b class="spoiler_title">Land search (check the contact of the texture with the floor)</b> <div class="spoiler_text"><pre> <code class="python hljs"> var found_floor=false var floor_index=<span class="hljs-number"><span class="hljs-number">-1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> x <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> range(s.get_contact_count()): var ci = s.get_contact_local_normal(x) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (ci.dot(Vector2(<span class="hljs-number"><span class="hljs-number">0</span></span>,<span class="hljs-number"><span class="hljs-number">-1</span></span>))&gt;<span class="hljs-number"><span class="hljs-number">0.6</span></span>): found_floor=true floor_index=x <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (found_floor): airborne_time=<span class="hljs-number"><span class="hljs-number">0.0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">else</span></span>: airborne_time+=step <span class="hljs-comment"><span class="hljs-comment">#,    var on_floor = airborne_time &lt; MAX_FLOOR_AIRBORNE_TIME</span></span></code> </pre></div></div><div class="spoiler">  <b class="spoiler_title">Jump process</b> <div class="spoiler_text"><pre> <code class="python hljs"> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (jumping): <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (lv.y&gt;<span class="hljs-number"><span class="hljs-number">0</span></span>): <span class="hljs-comment"><span class="hljs-comment">#     (   ) jumping=false elif (not jump): stopping_jump=true if (stopping_jump): lv.y+=STOP_JUMP_FORCE*step</span></span></code> </pre></div></div><div class="spoiler">  <b class="spoiler_title">Movement of the character on the ground</b> <div class="spoiler_text"><pre> <code class="python hljs"> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (on_floor): <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (move_left <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> move_right): <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (lv.x &gt; -WALK_MAX_VELOCITY): lv.x-=WALK_ACCEL*step <span class="hljs-keyword"><span class="hljs-keyword">elif</span></span> (move_right <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> move_left): <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (lv.x &lt; WALK_MAX_VELOCITY): lv.x+=WALK_ACCEL*step <span class="hljs-keyword"><span class="hljs-keyword">else</span></span>: var xv = abs(lv.x) xv-=WALK_DEACCEL*step <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (xv&lt;<span class="hljs-number"><span class="hljs-number">0</span></span>): xv=<span class="hljs-number"><span class="hljs-number">0</span></span> lv.x=sign(lv.x)*xv <span class="hljs-comment"><span class="hljs-comment">#  if (not jumping and jump): lv.y=-JUMP_VELOCITY jumping=true stopping_jump=false #     if (lv.x &lt; 0 and move_left): new_siding_left=true elif (lv.x &gt; 0 and move_right): new_siding_left=false if (jumping): new_anim="jumping" elif (abs(lv.x)&lt;0.1): new_anim="idle" else: new_anim="run"</span></span></code> </pre></div></div><div class="spoiler">  <b class="spoiler_title">Movement of the character in the air</b> <div class="spoiler_text"><pre> <code class="python hljs"> <span class="hljs-keyword"><span class="hljs-keyword">else</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (move_left <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> move_right): <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (lv.x &gt; -WALK_MAX_VELOCITY): lv.x-=AIR_ACCEL*step <span class="hljs-keyword"><span class="hljs-keyword">elif</span></span> (move_right <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> move_left): <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (lv.x &lt; WALK_MAX_VELOCITY): lv.x+=AIR_ACCEL*step <span class="hljs-keyword"><span class="hljs-keyword">else</span></span>: var xv = abs(lv.x) xv-=AIR_DEACCEL*step <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (xv&lt;<span class="hljs-number"><span class="hljs-number">0</span></span>): xv=<span class="hljs-number"><span class="hljs-number">0</span></span> lv.x=sign(lv.x)*xv <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (lv.y&lt;<span class="hljs-number"><span class="hljs-number">0</span></span>): new_anim=<span class="hljs-string"><span class="hljs-string">"jumping"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">else</span></span>: new_anim=<span class="hljs-string"><span class="hljs-string">"falling"</span></span></code> </pre></div></div><div class="spoiler">  <b class="spoiler_title">Moving a character</b> <div class="spoiler_text"><pre> <code class="python hljs"> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (new_siding_left!=siding_left): <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (new_siding_left): get_node(<span class="hljs-string"><span class="hljs-string">"sprite"</span></span>).set_scale( Vector2(<span class="hljs-number"><span class="hljs-number">-1</span></span>,<span class="hljs-number"><span class="hljs-number">1</span></span>) ) <span class="hljs-keyword"><span class="hljs-keyword">else</span></span>: get_node(<span class="hljs-string"><span class="hljs-string">"sprite"</span></span>).set_scale( Vector2(<span class="hljs-number"><span class="hljs-number">1</span></span>,<span class="hljs-number"><span class="hljs-number">1</span></span>) ) siding_left=new_siding_left</code> </pre></div></div><div class="spoiler">  <b class="spoiler_title">Change animation</b> <div class="spoiler_text"><pre> <code class="python hljs"> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (new_anim!=anim): anim=new_anim get_node(<span class="hljs-string"><span class="hljs-string">"anim"</span></span>).play(anim)</code> </pre></div></div><div class="spoiler">  <b class="spoiler_title">Applying ground speed</b> <div class="spoiler_text"><pre> <code class="python hljs"> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (found_floor): floor_h_velocity=s.get_contact_collider_velocity_at_pos(floor_index).x lv.x+=floor_h_velocity</code> </pre></div></div><div class="spoiler">  <b class="spoiler_title">The use of gravity on this whole mess</b> <div class="spoiler_text"><pre> <code class="python hljs"> lv+=s.get_total_gravity()*step s.set_linear_velocity(lv)</code> </pre></div></div><br><br>  Damn, it was a horror. <br><div class="spoiler">  <b class="spoiler_title">Now all together without comment:</b> <div class="spoiler_text"><pre> <code class="python hljs">extends RigidBody2D var anim=<span class="hljs-string"><span class="hljs-string">""</span></span> var siding_left=false var jumping=false var stopping_jump=false var WALK_ACCEL = <span class="hljs-number"><span class="hljs-number">300.0</span></span> var WALK_DEACCEL= <span class="hljs-number"><span class="hljs-number">300.0</span></span> var WALK_MAX_VELOCITY= <span class="hljs-number"><span class="hljs-number">400.0</span></span> var GRAVITY = <span class="hljs-number"><span class="hljs-number">900.0</span></span> var AIR_ACCEL = <span class="hljs-number"><span class="hljs-number">300.0</span></span> var AIR_DEACCEL= <span class="hljs-number"><span class="hljs-number">300.0</span></span> var JUMP_VELOCITY=<span class="hljs-number"><span class="hljs-number">460</span></span> var STOP_JUMP_FORCE=<span class="hljs-number"><span class="hljs-number">200.0</span></span> var MAX_FLOOR_AIRBORNE_TIME = <span class="hljs-number"><span class="hljs-number">0.15</span></span> var airborne_time=<span class="hljs-number"><span class="hljs-number">1e20</span></span> var floor_h_velocity=<span class="hljs-number"><span class="hljs-number">0.0</span></span> func _integrate_forces(s): var lv = s.get_linear_velocity() var step = s.get_step() var new_anim=anim var new_siding_left=siding_left var move_left = Input.is_action_pressed(<span class="hljs-string"><span class="hljs-string">"move_left"</span></span>) var move_right = Input.is_action_pressed(<span class="hljs-string"><span class="hljs-string">"move_right"</span></span>) var jump = Input.is_action_pressed(<span class="hljs-string"><span class="hljs-string">"jump"</span></span>) lv.x-=floor_h_velocity floor_h_velocity=<span class="hljs-number"><span class="hljs-number">0.0</span></span> var found_floor=false var floor_index=<span class="hljs-number"><span class="hljs-number">-1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> x <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> range(s.get_contact_count()): var ci = s.get_contact_local_normal(x) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (ci.dot(Vector2(<span class="hljs-number"><span class="hljs-number">0</span></span>,<span class="hljs-number"><span class="hljs-number">-1</span></span>))&gt;<span class="hljs-number"><span class="hljs-number">0.6</span></span>): found_floor=true floor_index=x <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (found_floor): airborne_time=<span class="hljs-number"><span class="hljs-number">0.0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">else</span></span>: airborne_time+=step var on_floor = airborne_time &lt; MAX_FLOOR_AIRBORNE_TIME <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (jumping): <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (lv.y&gt;<span class="hljs-number"><span class="hljs-number">0</span></span>): jumping=false <span class="hljs-keyword"><span class="hljs-keyword">elif</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">not</span></span> jump): stopping_jump=true <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (stopping_jump): lv.y+=STOP_JUMP_FORCE*step <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (on_floor): <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (move_left <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> move_right): <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (lv.x &gt; -WALK_MAX_VELOCITY): lv.x-=WALK_ACCEL*step <span class="hljs-keyword"><span class="hljs-keyword">elif</span></span> (move_right <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> move_left): <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (lv.x &lt; WALK_MAX_VELOCITY): lv.x+=WALK_ACCEL*step <span class="hljs-keyword"><span class="hljs-keyword">else</span></span>: var xv = abs(lv.x) xv-=WALK_DEACCEL*step <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (xv&lt;<span class="hljs-number"><span class="hljs-number">0</span></span>): xv=<span class="hljs-number"><span class="hljs-number">0</span></span> lv.x=sign(lv.x)*xv <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">not</span></span> jumping <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> jump): lv.y=-JUMP_VELOCITY jumping=true stopping_jump=false <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (lv.x &lt; <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> move_left): new_siding_left=true <span class="hljs-keyword"><span class="hljs-keyword">elif</span></span> (lv.x &gt; <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> move_right): new_siding_left=false <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (jumping): new_anim=<span class="hljs-string"><span class="hljs-string">"jumping"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">elif</span></span> (abs(lv.x)&lt;<span class="hljs-number"><span class="hljs-number">0.1</span></span>): new_anim=<span class="hljs-string"><span class="hljs-string">"idle"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">else</span></span>: new_anim=<span class="hljs-string"><span class="hljs-string">"run"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">else</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (move_left <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> move_right): <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (lv.x &gt; -WALK_MAX_VELOCITY): lv.x-=AIR_ACCEL*step <span class="hljs-keyword"><span class="hljs-keyword">elif</span></span> (move_right <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> move_left): <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (lv.x &lt; WALK_MAX_VELOCITY): lv.x+=AIR_ACCEL*step <span class="hljs-keyword"><span class="hljs-keyword">else</span></span>: var xv = abs(lv.x) xv-=AIR_DEACCEL*step <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (xv&lt;<span class="hljs-number"><span class="hljs-number">0</span></span>): xv=<span class="hljs-number"><span class="hljs-number">0</span></span> lv.x=sign(lv.x)*xv <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (lv.y&lt;<span class="hljs-number"><span class="hljs-number">0</span></span>): new_anim=<span class="hljs-string"><span class="hljs-string">"jumping"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">else</span></span>: new_anim=<span class="hljs-string"><span class="hljs-string">"falling"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (new_siding_left!=siding_left): <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (new_siding_left): get_node(<span class="hljs-string"><span class="hljs-string">"sprite"</span></span>).set_scale( Vector2(<span class="hljs-number"><span class="hljs-number">-1</span></span>,<span class="hljs-number"><span class="hljs-number">1</span></span>) ) <span class="hljs-keyword"><span class="hljs-keyword">else</span></span>: get_node(<span class="hljs-string"><span class="hljs-string">"sprite"</span></span>).set_scale( Vector2(<span class="hljs-number"><span class="hljs-number">1</span></span>,<span class="hljs-number"><span class="hljs-number">1</span></span>) ) siding_left=new_siding_left <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (new_anim!=anim): anim=new_anim get_node(<span class="hljs-string"><span class="hljs-string">"anim"</span></span>).play(anim) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (found_floor): floor_h_velocity=s.get_contact_collider_velocity_at_pos(floor_index).x lv.x+=floor_h_velocity lv+=s.get_total_gravity()*step s.set_linear_velocity(lv)</code> </pre></div></div><br><br>  PS In order for gravity to work, you need to tick Scene -&gt; Project Settings -&gt; Physics2D -&gt; Default Gravity <br><br><h5>  Import TileSets </h5><br>  I don‚Äôt have time to tell in detail about the tileset.  I can only offer my finished scene (from my project) or you can create your own from TileSet.  You can download the set from the link below, and then add to the Node TileMap project.  In the settings you need to add a ready TileSet to it (TileSet -&gt; Load -&gt; tileset.xml).  The simplest floor / earth can draw.  How to draw levels, TileSets I will explain in detail in the next lesson. <br><br><h5>  Bonus!  Adding Backdrops! </h5><br>  Create a new scene.  Add ‚ÄúNode‚Äù Parallax Background to it.  We call it parallax_bg and save it as parallax_bg.xml. <br>  To her create ParallaxLayer 4 pieces.  We call them sky, clouds, mount_1, mount_2.  Accordingly, the sky, clouds, and mountains. <br>  The resolution of our game is 800x600 (Look in the settings Scene -&gt; Project Settings -&gt; Display).  Therefore, we set the Mirroring 800.0 parameter to each "Node" - mirroring along the Y axis. Change the Scale parameters of the "Nodes" clouds, mount_1, mount_2 to 0.1.1;  0.2.1 and 0.4.1 respectively. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/a6e/192/308/a6e192308cb6792547e6c6d984e5751a.png"><br><br>  Add the sky itself to the Node sky.  I have already drawn my own in advance.  And you can download all the links below. <br>  On the working area immediately appeared 2 strips.  We transfer to the working area of ‚Äã‚Äãthe image, we scale.  We see that changing the main sprite is changing and its mirror image. <br><br>  Add clouds to Node clouds.  I think it will be possible to duplicate each of the 3 so that in the end it was 6, the mirror duplicates again, so we will have as many as 12 clouds! <br><br>  Now add mount to Node mount_1 and mount_2.  But we will raise the mount_2 layer above mount_1. <br><img src="https://habrastorage.org/getpro/habr/post_images/7ce/bd9/108/7cebd91087abe9f06485603213ae49dc.png"><br><br>  Save the scene.  Open stage.xml.  And to our Stage we add through the "plus" scene with backs. <br><br>  And as usual a small video gameplay: <br><br><iframe width="420" height="315" src="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://www.youtube.com/embed/5V5RhiPg0GU%3Ffeature%3Doembed&amp;xid=17259,15700021,15700186,15700190,15700253&amp;usg=ALkJrhgYlbfVkGmXr4K2ct7Q2v4D4HlblA" frameborder="0" allowfullscreen=""></iframe><br><br>  Small FAQ (Will be updated): <br><ul><li>  If the character does not move - check whether the control keys have added and added correctly. </li><li>  Problems with animation - whether the animation was added correctly.  Check out the looping animations for idle, run and falling. </li><li>  The character falls through the floor / passes through walls, ceilings - increase the triangle CollisionPolygon2D. </li><li>  Character partially in textures / above them - work with the arrow CollisionShape2D </li></ul><br>  Download: <br><ul><li> <a href=""><img src="https://habrastorage.org/getpro/habr/post_images/a42/d08/85d/a42d0885daf7b7278f784d528e12df83.png"></a>  <a href="">Project sources</a> </li><li> <a href=""><img src="https://habrastorage.org/getpro/habr/post_images/92f/ca3/1a6/92fca31a6c1e97effd4bb34f155bd9c0.png"></a>  <a href="">Backdrops (zip)</a> </li><li> <a href=""><img src="https://habrastorage.org/getpro/habr/post_images/7fa/89c/500/7fa89c500f0c10e42f698cb698368829.png"></a>  <a href="">Compiled export templates for Linux x86 (zip)</a> </li><li> <a href="https://www.dropbox.com/s/r0jdvpku54a4jws/Linux%2520x86"><img src="https://habrastorage.org/getpro/habr/post_images/5d5/265/e2c/5d5265e2c130bc7855adf5e43cc29630.png"></a>  <a href="https://www.dropbox.com/s/r0jdvpku54a4jws/Linux%2520x86">Demo Linux Linux x86 tutorials</a> </li><li> <a href="https://www.dropbox.com/s/c19eo3yax7dwrmn/Linux%2520amd64"><img src="https://habrastorage.org/getpro/habr/post_images/5d5/265/e2c/5d5265e2c130bc7855adf5e43cc29630.png"></a>  <a href="https://www.dropbox.com/s/c19eo3yax7dwrmn/Linux%2520amd64">Linux binaries Demo amd64 lesson</a> </li><li> <a href="https://www.dropbox.com/s/ne0vfeam7cz065g/Windows%2520x86"><img src="https://habrastorage.org/getpro/habr/post_images/6b5/4db/c67/6b54dbc679184ce693fbcd66e5504f30.png"></a>  <a href="https://www.dropbox.com/s/ne0vfeam7cz065g/Windows%2520x86">Windows x86 Demo Binaries</a> </li><li> <a href="https://www.dropbox.com/s/whfzlvmitfpaijs/Windows%2520x86_64"><img src="https://habrastorage.org/getpro/habr/post_images/6b5/4db/c67/6b54dbc679184ce693fbcd66e5504f30.png"></a>  <a href="https://www.dropbox.com/s/whfzlvmitfpaijs/Windows%2520x86_64">Binaries Demo Windows lesson x86_64</a> </li><li> <a href="https://www.dropbox.com/s/pegktdn9ev2d8e9/MacOS%2520%2520x86"><img src="https://habrastorage.org/getpro/habr/post_images/f8f/c93/885/f8fc9388581f06784c685ce6219dc4b2.png"></a>  <a href="https://www.dropbox.com/s/pegktdn9ev2d8e9/MacOS%2520%2520x86">Mac OS x86 Demo Binaries</a> </li><li> <a href="https://www.dropbox.com/s/kaozjptvh4l519b/MacOS%2520amd64"><img src="https://habrastorage.org/getpro/habr/post_images/f8f/c93/885/f8fc9388581f06784c685ce6219dc4b2.png"></a>  <a href="https://www.dropbox.com/s/kaozjptvh4l519b/MacOS%2520amd64">Binaries Demo lesson MacOS amd64</a> </li></ul><br>  Thank you if you mastered and read to the end.  In case of defects, write in a personal.  Thanks, see you soon! </div><p>Source: <a href="https://habr.com/ru/post/212837/">https://habr.com/ru/post/212837/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../212823/index.html">Rusty brains - go over the bridge. The Bridge by Ty Tailor</a></li>
<li><a href="../212825/index.html">Anti-rootkit for Userland-RootKit Azazel "on the knee"</a></li>
<li><a href="../212831/index.html"># 3dprintexpo: Russia's first exhibition of three-dimensional printing</a></li>
<li><a href="../212833/index.html">Lshell instead of chroot ssh</a></li>
<li><a href="../212835/index.html">Tame ZoG (Part 3: Football of the Kumsk Valley)</a></li>
<li><a href="../212839/index.html">SIP Security Essay</a></li>
<li><a href="../212841/index.html">Portal migration from SharePoint 2010 to SharePoint 2013. What has changed and how to live with it</a></li>
<li><a href="../212843/index.html">Monthly digest of interesting IT-projects on Kickstarter ‚Ññ1</a></li>
<li><a href="../212847/index.html">Denormalization of trees</a></li>
<li><a href="../212849/index.html">Rare PDA Casio Cassiopeia A-11A</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>