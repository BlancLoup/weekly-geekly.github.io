<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ISO 8601 and ECMAScript - a headache from different interpretations of standards</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="We are developing here some integration service with a very third-party system. The service itself works on Node.js. And everything would be fine, but...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>ISO 8601 and ECMAScript - a headache from different interpretations of standards</h1><div class="post__text post__text-html js-mediator-article">  We are developing here some integration service with a very third-party system.  The service itself works on Node.js.  And everything would be fine, but only the inaccessibility of the server during garbage collection made the third-party system very unnerving. <br><br>  On the eve of the new year, it was decided to make a gift to the server - to update Node.js from version 0.4.8 to 0.6.6 For a number of organizational reasons, which I don‚Äôt really want to discuss here, the update was carried out immediately on the combat system and even without <a href="http://ru.wikipedia.org/wiki/%25D0%25A0%25D0%25B5%25D0%25B3%25D1%2580%25D0%25B5%25D1%2581%25D1%2581%25D0%25B8%25D0%25BE%25D0%25BD%25D0%25BD%25D0%25BE%25D0%25B5_%25D1%2582%25D0%25B5%25D1%2581%25D1%2582%25D0%25B8%25D1%2580%25D0%25BE%25D0%25B2%25D0%25B0%25D0%25BD%25D0%25B8%25D0%25B5">regression testing</a> . <br><br>  Could something really go wrong in this situation? <a name="habracut"></a>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Updated.  We work on.  Suddenly it turns out that in messages transmitted by a third-party system, time is shifted by 4 hours ahead.  There is probably no need to talk about the business implications of such a shift. <br><br>  We start to think.  There is a hypothesis that if everything worked before, and suddenly stopped with the update of Node.js, it means that it is in it or in v8.  Can not be, I say.  To such a jamb and we first noticed - surely this is our admin screwed up.  Obviously, I say, he has something wrong with the time zone settings on the server.  They looked into all possible corners - no, everything is clear. <br><br>  The last, the most incredible hypothesis remains - the time parsing in ISO 8601 format broke. It is in this format that the third-party system sends the time in messages.  It would seem, well, what can be broken.  Here comes the local time: ‚Äú2011-12-30T22: 00: 00‚Äù.  In a quick look in the server: <br><br><pre> &gt; var d = new Date ('2011-12-30T22: 00: 00')
 undefined
 &gt; d
 Fri, 30 Dec 2011 22:00:00 GMT
 &gt; d.getHours ()
 2
</pre><br>  Opanki.  The server obviously lives in GMT.  Not otherwise, already emigrated.  Checking: <br><br><pre> &gt; var d = new Date ('2011-12-30T22: 00: 00Z')
 undefined
 &gt; d
 Fri, 30 Dec 2011 22:00:00 GMT
 &gt; d.getHours ()
 2
</pre><br>  In both cases, regardless of whether the time is indicated locally or GMT, it is perceived as GMT.  We are looking at what Chrome will say: <br><br><pre> &gt; var d = new Date ('2011-12-30T22: 00: 00')
 undefined
 &gt; d.toString ()
 "Sat Dec 31 2011 02:00:00 GMT + 0400 (MSK)"
 &gt; d.getHours ()
 2
</pre><br>  But this is already unpleasant.  Chrome - at the workstation.  And with the time zone everything is in order. <br><br>  While the developer is pulling me off with the question ‚ÄúWhen will we have a bug on Google?‚Äù I read the description of the standard.  130 francs for the official document is not, therefore, we study <a href="http://en.wikipedia.org/wiki/ISO_8601">Wikipedia</a> : <br><blockquote>  If you are not <br></blockquote><br>  We dig further. <br><br><pre> var d = new Date ('2011-12-30T22: 00: 00')
 undefined
 d.  getTimezoneOffset () / 60
 -four
</pre><br>  -4 returns on all tested computers and platforms.  Then a thought comes to my mind.  Until now, we checked everything except Firefox and Windows.  I look in FF under Windows: <br><br><pre> var d = new Date ('2011-12-30T22: 00: 00')
 undefined
 d.getUTCHours ()
 18
 d.getHours ()
 22
</pre><br>  I check the same thing in Chrome under Windows: <br><br><pre> var d = new Date ('2011-12-30T22: 00: 00')
 undefined
 d.getUTCHours ()
 22
 d.getHours ()
 2
</pre><br>  Wow!  Does Google really have a cant?  Again, an offer to write a bug report.  Composing it is still too lazy, so I am starting to read manuals. <br><br>  Mozilla Developer Network (MDN).  Description of the <a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Date/parse">Date.parse</a> method: <br><blockquote>  If you do not specify a time zone, it is assumed <br></blockquote><br>  Here, the time is disassembled according to the standard, so Firefox is correct. <br><br>  There is no independent documentation on v8, but there is a link to ECMAscript.  <a href="http://www.ecma-international.org/publications/files/ECMA-ST/Ecma-262.pdf">Download</a> the version 5.1 specification, on page 181 we read: <br><blockquote>  The value of an absent time zone offset is "Z". <br></blockquote><br>  Wow!  The third-party system transmits us local time in accordance with the ISO standard, and our server interprets it as Greenwich time - in full compliance with the ECMA standard. <br><br>  Just in case, <a href="http://msdn.microsoft.com/en-us/library/ff743760%2528VS.94%2529.aspx">I read MSDN</a> - Microsoft has long since claimed that their JavaScript standard is the most correct, because it is ECMA.  And for sure: <br><blockquote>  If you do not include a value in the Z position, UTC time is used. <br></blockquote><br>  Examination of the repositories showed that the very correction of the behavior of v8 was made in the <a href="http://code.google.com/p/v8/source/detail%3Fr%3D8513">wording of 8513</a> at the end of June 2011. However, when Mozille <a href="https://bugzilla.mozilla.org/show_bug.cgi%3Fid%3D647568">was asked to</a> fix it in his room, the discussion pointed to discrepancies in ISO and ECMA 5.1 standards. As a result, there is a chance that in version 6 of the ECMA standard, time will still be <a href="https://bugs.ecmascript.org/show_bug.cgi%3Fid%3D112">dealt with correctly</a> . <br><br>  And we still had to add crutches to the code.  If the time coming from the third-party system does not contain an indication of the time zone, add getTimezoneOffset to it.  After the new ECMA standard comes out, in which this discrepancy will be corrected and the v8 will be updated in accordance with this standard, we will have to track this down and remove the crutches. <br><br>  PS Habrayuser <a href="https://habrahabr.ru/users/zerodivisi0n/" class="user_link">zerodivisi0n</a> , which, unfortunately, has read-only rights, has taken the <a href="https://habrahabr.ru/users/zerodivisi0n/" class="user_link">brunt of the</a> events described.  If someone has enough karma (or whatever is needed there) to transfer him to a more advanced state, we will both be very grateful.  At the same time, he himself will be able to answer questions. </div><p>Source: <a href="https://habr.com/ru/post/135565/">https://habr.com/ru/post/135565/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../135559/index.html">Rockbox for everyone</a></li>
<li><a href="../135561/index.html">Brainfuck on tape with unlimited bit cells</a></li>
<li><a href="../135562/index.html">How to get access to other mailboxes on mail.ru</a></li>
<li><a href="../135563/index.html">Some questions on .NET and C #</a></li>
<li><a href="../135564/index.html">Looking through the engine through the exhaust pipe, or how to get the normal keyboard controls in FIFA 12</a></li>
<li><a href="../135568/index.html">Fog computing</a></li>
<li><a href="../135570/index.html">Robot-turtle on ATMega8</a></li>
<li><a href="../135571/index.html">Digital Eyepiece for Microscope DIY</a></li>
<li><a href="../135572/index.html">Improving interaction with small controls through a touch interface</a></li>
<li><a href="../135573/index.html">StarchartJs Code Revealed Under MIT License</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>