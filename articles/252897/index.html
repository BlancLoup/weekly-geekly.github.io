<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Creating games without Canvas</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="One day, Blizzard's HeartStone card game caught my eye. Playing it came the idea that such things can be created using html5 technology, which will al...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Creating games without Canvas</h1><div class="post__text post__text-html js-mediator-article">  One day, Blizzard's HeartStone card game caught my eye.  Playing it came the idea that such things can be created using html5 technology, which will allow them to be cross-platform.  In my opinion, such things can be done by people who are still engaged only in creating websites. <br><br>  So, what we have: <br><ul><li>  Dedicated server with LAMP (without phpDaemon); </li><li>  The desire to break in WebSockets. </li></ul><br><br>  Actually, everything.  This is quite enough to carry out our plans. <br><a name="habracut"></a><br>  For this example, I used a <a href="https://github.com/Doncode/simple_php_websocket_server">ready-made WebSockets server</a> written in php. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Exchange with the server will be data in json format to transfer the names of methods and arguments. <br><br>  The most basic thing we need is to establish the sane interaction between the client and the server, that is, the interface through which our application (in this case, the game) can be expanded. <br><br>  In the client, it will look like this: <br><br><pre><code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> socketInfo = {}; socket = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> WebSocket(<span class="hljs-string"><span class="hljs-string">'ws://localhost:8000'</span></span>); socket.onopen = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">e</span></span></span><span class="hljs-function">)</span></span>{ socketInfo.method = <span class="hljs-string"><span class="hljs-string">"connect"</span></span>; socket.send(<span class="hljs-built_in"><span class="hljs-built_in">JSON</span></span>.stringify(socketInfo)); <span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.log(<span class="hljs-string"><span class="hljs-string">'   ws://localhost:8000'</span></span>); } socket.onclose = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">e</span></span></span><span class="hljs-function">)</span></span>{ <span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.log(<span class="hljs-string"><span class="hljs-string">' !'</span></span>); } socket.onmessage = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">e</span></span></span><span class="hljs-function">)</span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">typeof</span></span> e.data === <span class="hljs-string"><span class="hljs-string">"string"</span></span>){ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> request = <span class="hljs-built_in"><span class="hljs-built_in">JSON</span></span>.parse(e.data); Actions[request.function](request.args); }; }</code> </pre> <br>  This is a standard description of WebSockets features.  Let‚Äôs focus on the onmessage method. <br><br>  As a parameter, it takes a string in json format, which was sent to us by the server.  The string contains the name of the function that must be executed on the client, as well as the parameters that we will pass to it. <br><br>  In order to run a function whose name contains some variable, this function must be an element of an array (alternatively, the global window array).  In this example, this is the Actions array: <br><br><pre> <code class="javascript hljs"> <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> Actions = { <span class="hljs-attr"><span class="hljs-attr">myId</span></span>: <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">id</span></span></span><span class="hljs-function">)</span></span>{ localStorage.setItem(<span class="hljs-string"><span class="hljs-string">"myId"</span></span>, id); }, <span class="hljs-attr"><span class="hljs-attr">log</span></span>: <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">str</span></span></span><span class="hljs-function">)</span></span>{ <span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.log(str); }, ....... }</code> </pre><br>  Naturally, we also send a string to the server in json format.  I have two fields: the name of the method and the argument. <br>  Similarly, the server parses the resulting line: <br><br><pre> <code class="php hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">websocket_onmessage</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($keyINsock, $str)</span></span></span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">global</span></span> $Users; $json = json_decode($str); $method = strval($json-&gt;{<span class="hljs-string"><span class="hljs-string">'method'</span></span>}); $args = $json-&gt;{<span class="hljs-string"><span class="hljs-string">'args'</span></span>}; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!<span class="hljs-keyword"><span class="hljs-keyword">isset</span></span>($args)) $args = $keyINsock; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!<span class="hljs-keyword"><span class="hljs-keyword">empty</span></span>($method)) $Users-&gt;$method($keyINsock, $args); }</code> </pre><br><br>  The websocket_onmessage function processes requests to our server, taking as an argument the connection ID and the transmitted string, respectively.  Next comes the work with the object of the class Users. <br><br>  Let me explain using the example of connecting players: <br><br><pre> <code class="php hljs"> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">frAccept</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($myid, $opId)</span></span></span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;opponents[$myid] = $opId; <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;opponents[$opId] = $myid; $args = <span class="hljs-keyword"><span class="hljs-keyword">array</span></span>($myid, $opId); $arrOut = <span class="hljs-keyword"><span class="hljs-keyword">array</span></span>(<span class="hljs-string"><span class="hljs-string">'function'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'frAccept'</span></span>, <span class="hljs-string"><span class="hljs-string">'args'</span></span> =&gt; $args); $arrOutJSON = json_encode($arrOut); websock_send($opId, $arrOutJSON); websock_send($myid, $arrOutJSON); }</code> </pre><br>  In each method, the first parameter is the connection identifier for which the request came, which is why it is called $ myId.  The example describes the method of connecting two players (the second parameter is the id of the player who accepted the invitation to battle).  For simplicity, I do not use databases, so we put the IDs of the oponients into an array for further work with them (they are stored in the client in LocalStorage, but why drive them back and forth). <br><br>  All those whose opponent wrote down, give this information to both players. <br><br><pre> <code class="javascript hljs"> frAccept: <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">id</span></span></span><span class="hljs-function">)</span></span>{ fight_start(id); <span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.log(<span class="hljs-string"><span class="hljs-string">'Fight starting'</span></span>); } ....... function fight_start(ids){ $(<span class="hljs-string"><span class="hljs-string">'body'</span></span>).load(<span class="hljs-string"><span class="hljs-string">'fight.html'</span></span>); curplayer = ids[<span class="hljs-number"><span class="hljs-number">0</span></span>]; localStorage.setItem(<span class="hljs-string"><span class="hljs-string">"opponent"</span></span>, ids[<span class="hljs-number"><span class="hljs-number">0</span></span>]); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (ids[<span class="hljs-number"><span class="hljs-number">0</span></span>] == localStorage.getItem(<span class="hljs-string"><span class="hljs-string">"myId"</span></span>)) localStorage.setItem(<span class="hljs-string"><span class="hljs-string">"opponent"</span></span>, ids[<span class="hljs-number"><span class="hljs-number">1</span></span>]); }</code> </pre><br>  The variable curplayer stores data about whose turn it is. <br><br>  Our whole game is built on ordinary blocks div. <br><br><pre> <code class="html hljs xml"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">meta</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">http-equiv</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"Cache-Control"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">content</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"no-cache"</span></span></span><span class="hljs-tag"> /&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">id</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"to_area"</span></span></span><span class="hljs-tag">&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">id</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"wrapper"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">id</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"opHand"</span></span></span><span class="hljs-tag">&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">id</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"area"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">id</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"timer"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"bg"</span></span></span><span class="hljs-tag">&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">id</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"opUnits"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"nexus card"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">data-health</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"30"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">id</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">""</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">data-attack</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"0"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"health"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"inner"</span></span></span><span class="hljs-tag">&gt;</span></span>30<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"bg"</span></span></span><span class="hljs-tag">&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">id</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"myUnits"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"nexus card"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">data-health</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"30"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">data-attack</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"0"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"health"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"inner"</span></span></span><span class="hljs-tag">&gt;</span></span>30<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"bg"</span></span></span><span class="hljs-tag">&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">id</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"next"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">id</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"myhand"</span></span></span><span class="hljs-tag">&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre><br><br>  Having such a frame, we begin to work with the elements of the game. <br><br>  To get started, we get 4 starting cards.  How to do it?  Four times we ask the server: ‚Äúgive the card‚Äù.  I simplified this operation by adding the desired number of cards as an argument: get_cards (4); <br><br><pre> <code class="javascript hljs"> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">get_cards</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">num</span></span></span><span class="hljs-function">)</span></span>{ socketInfo.method = <span class="hljs-string"><span class="hljs-string">"get_cards"</span></span>; socketInfo.args = num; socket.send(<span class="hljs-built_in"><span class="hljs-built_in">JSON</span></span>.stringify(socketInfo)); }</code> </pre><br>  We have already figured out that the server parses the received json string in the name of the method and the argument.  As a result, we will use the get_cards method: <br><br><pre> <code class="php hljs"> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">get_cards</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($myid, $num)</span></span></span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">global</span></span> $Cards; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> ($i=<span class="hljs-number"><span class="hljs-number">0</span></span>; $i &lt; $num; $i++){ $card = $Cards-&gt;getRandom(); $args = <span class="hljs-keyword"><span class="hljs-keyword">array</span></span>( <span class="hljs-string"><span class="hljs-string">"player_id"</span></span> =&gt; $myid, <span class="hljs-string"><span class="hljs-string">"card"</span></span> =&gt; $card ); $arrOut = <span class="hljs-keyword"><span class="hljs-keyword">array</span></span>(<span class="hljs-string"><span class="hljs-string">'function'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'player_get_card'</span></span>, <span class="hljs-string"><span class="hljs-string">'args'</span></span> =&gt; $args); $arrOutJSON = json_encode($arrOut); websock_send($myid, $arrOutJSON); websock_send(<span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;opponents[$myid], $arrOutJSON); } }</code> </pre><br>  In the loop, we request a random card from the deck ($ Cards-&gt; getRandom () returns the json card representation: name, attack, number of lives, picture) and send the result to both players.  Do not forget about the opponent, he should see that we took a map. <br><br>  Which players took the current map is determined by comparing the ID: <br><br><pre> <code class="javascript hljs"> player_get_card: <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">args</span></span></span><span class="hljs-function">)</span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!me(args.player_id)) { $(<span class="hljs-string"><span class="hljs-string">'#opHand'</span></span>).append(<span class="hljs-string"><span class="hljs-string">'&lt;div class="card" id="'</span></span>+args.card.id+<span class="hljs-string"><span class="hljs-string">'" /&gt;'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>; }<span class="hljs-keyword"><span class="hljs-keyword">else</span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> card = card_construct(args.card); $(<span class="hljs-string"><span class="hljs-string">'#myhand'</span></span>).append(card); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>; } }</code> </pre><br>  Accordingly, #opHand is an opponent‚Äôs hand, #myhand is our hand.  That is, the cards that we hold in hand. <br><br>  So, the cards are typed, it's time to lay them on the table.  To do this, we write an elementary jquery function: <br><br><pre> <code class="javascript hljs"> $(<span class="hljs-string"><span class="hljs-string">'#myhand'</span></span>).on(<span class="hljs-string"><span class="hljs-string">'click'</span></span>,<span class="hljs-string"><span class="hljs-string">".card"</span></span>,<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span>{ <span class="hljs-comment"><span class="hljs-comment">//      if (!me(curplayer)) return; to_area($(this)); });</span></span></code> </pre><br>  When clicking on the map in our hand, the map is sent to the arena: to_area (). <br><br><pre> <code class="javascript hljs"> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">to_area</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">card</span></span></span><span class="hljs-function">)</span></span>{ <span class="hljs-comment"><span class="hljs-comment">//     card.appendTo('#myUnits'); socketInfo.method = 'opGetCard'; socketInfo.args = card.attr("id"); socket.send(JSON.stringify(socketInfo)); }</span></span></code> </pre><br>  Do not forget that the enemy must see all this. <br><br><pre> <code class="php hljs"> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">opGetCard</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($myid, $card_id)</span></span></span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">global</span></span> $Cards; $card = $Cards-&gt;getById($card_id); $arrOut = <span class="hljs-keyword"><span class="hljs-keyword">array</span></span>(<span class="hljs-string"><span class="hljs-string">'function'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'opGetCard'</span></span>, <span class="hljs-string"><span class="hljs-string">'args'</span></span> =&gt; $card); $arrOutJSON = json_encode($arrOut); websock_send(<span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;opponents[$myid], $arrOutJSON); }</code> </pre><br><br>  Next, you need to consider the most important - attack.  One card, we attack the enemy card.  For this we need: <br><ul><li>  Select a card, which we will go; </li><li>  Select a victim card. </li></ul><br><br>  To select the card-aggressor, we will manipulate the active class: <br><br><pre> <code class="javascript hljs"> $(<span class="hljs-string"><span class="hljs-string">'#area'</span></span>).on(<span class="hljs-string"><span class="hljs-string">'click'</span></span>,<span class="hljs-string"><span class="hljs-string">"#myUnits .card"</span></span>,<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span>{ <span class="hljs-comment"><span class="hljs-comment">//////////////////      if(!me(curplayer) || $(this).hasClass('nexus'))return; if ($(this).hasClass('active')) { $(this).removeClass('active'); }else{ $('#area #myUnits .card.active').removeClass('active'); $(this).addClass('active'); } });</span></span></code> </pre><br>  The aggressor has a class of active, that is, the card is selected.  Now you can choose a victim. <br><br><pre> <code class="javascript hljs"> $(<span class="hljs-string"><span class="hljs-string">'#area'</span></span>).on(<span class="hljs-string"><span class="hljs-string">'click'</span></span>,<span class="hljs-string"><span class="hljs-string">"#opUnits .card"</span></span>,<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span>{ <span class="hljs-comment"><span class="hljs-comment">//////////////////       $agressor = $('#area #myUnits .card.active'); if ($agressor.length &lt; 1) { return false; }; attack_request($agressor,$(this)); });</span></span></code> </pre><br>  So, when clicking on the victim map, we pass two arguments to the function with the talking name attack_request: the aggressor and the victim.  That is who and who will attack. <br><br>  The function itself is a wrapper and only sends information to the server that there will be an attack. <br><br><pre> <code class="javascript hljs"> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">attack_request</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">agressor, victim</span></span></span><span class="hljs-function">)</span></span>{ <span class="hljs-comment"><span class="hljs-comment">////////////   socketInfo.method = 'attack_request'; socketInfo.args = agressor.attr("id")+'-'+victim.attr("id"); socket.send(JSON.stringify(socketInfo)); }</span></span></code> </pre><br>  The function on the server works in echo mode, sends the information back to me and my opponent.  This is done in order to level out the difference in Internet speed between two players as much as possible (after all, we have a timer in the game that counts 2 minutes per turn). <br><br><pre> <code class="php hljs"> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">attack_request</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($myid, $args)</span></span></span></span>{ $arrOut = <span class="hljs-keyword"><span class="hljs-keyword">array</span></span>(<span class="hljs-string"><span class="hljs-string">'function'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'attack'</span></span>, <span class="hljs-string"><span class="hljs-string">'args'</span></span> =&gt; $args); $arrOutJSON = json_encode($arrOut); websock_send($myid, $arrOutJSON); websock_send(<span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;opponents[$myid], $arrOutJSON); }</code> </pre><br>  Our cards are clearly identified with unique IDs, therefore, having the aggressor and victim id, we can draw this attack: <br><br><pre> <code class="javascript hljs"> attack: <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">args</span></span></span><span class="hljs-function">)</span></span>{ id = args.split(<span class="hljs-string"><span class="hljs-string">'-'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> alias = $(<span class="hljs-string"><span class="hljs-string">'#'</span></span>+id[<span class="hljs-number"><span class="hljs-number">0</span></span>]).data(<span class="hljs-string"><span class="hljs-string">'alias'</span></span>); onBeforeAttack(alias,id); } .................. function onBeforeAttack(alias, id){ <span class="hljs-comment"><span class="hljs-comment">//     if(Units[alias] == undefined){ var uFile = 'js/units/'+alias+'.unit.js'; var xmlhttp = getXmlHttp(); xmlhttp.open('GET', uFile, false); xmlhttp.send(null); if(xmlhttp.status == 200){ $('body').append('&lt;script src="'+uFile+'"&gt;&lt;/scipt&gt;'); }else{ Units[alias] = new defaultUnit(); } } Units[alias].attack(id[0], id[1]); }</span></span></code> </pre><br><br>  Please note that before the attack is drawn it is necessary to check whether we have an object containing information about this type of unit.  I tried to immediately think about the moment of extensibility.  After all, we have both melee units and range, and we would like their attack to look different.  But this is for the future.  So far we have only the default object that is used if the corresponding file with the description of the unit object is missing. <br><br>  Here is what it looks like: <br><br><pre> <code class="javascript hljs"> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">defaultUnit</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span>{} defaultUnit.prototype.attack = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">agressor_id, victim_id</span></span></span><span class="hljs-function">)</span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> victim = $(<span class="hljs-string"><span class="hljs-string">'#'</span></span>+victim_id); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> agressor = $(<span class="hljs-string"><span class="hljs-string">'#'</span></span>+agressor_id); victim.css(<span class="hljs-string"><span class="hljs-string">'z-index'</span></span>,<span class="hljs-number"><span class="hljs-number">5</span></span>); agressor.css(<span class="hljs-string"><span class="hljs-string">'z-index'</span></span>,<span class="hljs-number"><span class="hljs-number">10</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> $ypos = victim.offset().top - agressor.offset().top; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> $xpos = victim.offset().left - agressor.offset().left; agressor.animate({<span class="hljs-attr"><span class="hljs-attr">top</span></span>:$ypos, <span class="hljs-attr"><span class="hljs-attr">left</span></span>:$xpos}, <span class="hljs-number"><span class="hljs-number">100</span></span>).delay(<span class="hljs-number"><span class="hljs-number">200</span></span>).animate({<span class="hljs-attr"><span class="hljs-attr">top</span></span>:<span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-attr"><span class="hljs-attr">left</span></span>:<span class="hljs-number"><span class="hljs-number">0</span></span>}, <span class="hljs-number"><span class="hljs-number">100</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-built_in"><span class="hljs-built_in">isNaN</span></span>(victim.data(<span class="hljs-string"><span class="hljs-string">'attack'</span></span>))) victim.data(<span class="hljs-string"><span class="hljs-string">'attack'</span></span>,<span class="hljs-number"><span class="hljs-number">0</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-built_in"><span class="hljs-built_in">isNaN</span></span>(agressor.data(<span class="hljs-string"><span class="hljs-string">'attack'</span></span>))) agressor.data(<span class="hljs-string"><span class="hljs-string">'attack'</span></span>,<span class="hljs-number"><span class="hljs-number">0</span></span>); victim.data(<span class="hljs-string"><span class="hljs-string">'health'</span></span>,victim.data(<span class="hljs-string"><span class="hljs-string">'health'</span></span>)-agressor.data(<span class="hljs-string"><span class="hljs-string">'attack'</span></span>)); agressor.data(<span class="hljs-string"><span class="hljs-string">'health'</span></span>,agressor.data(<span class="hljs-string"><span class="hljs-string">'health'</span></span>)-victim.data(<span class="hljs-string"><span class="hljs-string">'attack'</span></span>)); refreshCards(); }</code> </pre><br>  After the attack is drawn, we call refreshCards (), which will change the values ‚Äã‚Äãof the number of lives of all the cards in the arena (just everyone, as there are massive spells). <br><br><pre> <code class="javascript hljs"> refreshCards = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span>{ <span class="hljs-comment"><span class="hljs-comment">////    $('#myUnits .card.active').removeClass('active'); var rest = setTimeout(function(){ $('#area .card').each(function(){ refresh_card($(this)); if ($(this).data('health') &lt; 1) { death($(this)); }; }); clearTimeout(rest); },1000); } function refresh_card(card){ //////////   $('.health .inner',card).html(card.data('health')); $('.attack .inner',card).html(card.data('attack')); }</span></span></code> </pre><br>  If the number of lives becomes less than one, we launch the ‚Äúdying‚Äù card, and if the main building dies, which, in essence, the game, must be defended, then we also trigger the event of losing one of the players: <br><br><pre> <code class="javascript hljs"> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">death</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">unit</span></span></span><span class="hljs-function">)</span></span>{ <span class="hljs-comment"><span class="hljs-comment">//////////  if (unit.hasClass('nexus')) { var lose = localStorage.getItem("opponent"); if (!me(curplayer)) lose = localStorage.getItem("myId"); socketInfo.method = 'lose'; socketInfo.args = lose; socket.send(JSON.stringify(socketInfo)); }; unit.addClass('die'); var dt = setTimeout(function(){ unit.remove(); clearTimeout(dt); },2000); }</span></span></code> </pre><br>  Actually, I was not going to describe every elementary action that I created in the game, described the concept. <br><br>  To view the demo you will need two browsers / tabs (it looks rotten on mobile, I do not advise it). <br><br>  <a href="http://141.8.196.181/new-cards/">141.8.196.181/new-cards</a> </div><p>Source: <a href="https://habr.com/ru/post/252897/">https://habr.com/ru/post/252897/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../252883/index.html">Creating APK x86 and ARM APK packages using the Intel¬Æ and GNU gcc compiler</a></li>
<li><a href="../252885/index.html">(Without) dangerous copy elision</a></li>
<li><a href="../252889/index.html">What is WMS?</a></li>
<li><a href="../252893/index.html">Timing for amateur car racing</a></li>
<li><a href="../252895/index.html">Material Design. Was there a boy?</a></li>
<li><a href="../252903/index.html">Android A few words about MVP + rxJava</a></li>
<li><a href="../252905/index.html">Results of Radare Summer of Code 2014 and the organization of the new RSoC / GSoC 2015</a></li>
<li><a href="../252907/index.html">Looking for perfect monitoring</a></li>
<li><a href="../252909/index.html">Use Marionette.Region to create boot views</a></li>
<li><a href="../252911/index.html">Telegram attack for 2 ^ 64 operations, and why the supervillain doesn't need it</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>