<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>220V device control via LPT port (full creation cycle)</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Prehistory 
 After reading the article on Habr√© about controlling the lamp via the Internet, I had an idea to control the lighting at home from a comp...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>220V device control via LPT port (full creation cycle)</h1><div class="post__text post__text-html js-mediator-article"><h4>  Prehistory </h4><br>  After reading the <a href="http://habrahabr.ru/blogs/DIY/92655/">article</a> on Habr√© about controlling the lamp via the Internet, I had an idea to control the lighting at home from a computer, and since I‚Äôve already set up controlling a computer from a cell phone, this means that the light can be controlled from the same phone.  After demonstrating the article to one of my colleagues, he said that he needed it.  Since he often watches films that he watches on a computer, he falls asleep.  The computer some time after the end of the film also falls asleep and turns off the monitor, but the light in the room remains on.  Those.  it was decided that the thing was useful, and I began to collect information and details for this miracle. <br>  The rest of the information under the habracut (cautiously a lot of pictures - traffic). <br><a name="habracut"></a><br><h4>  Device layout </h4><br>  For the original scheme was taken <a href="http://spbty.fatal.ru/engine/lpt/lpt.htm">one of the schemes</a> found on the Internet and it looked like this: <br><img src="https://habrastorage.org/storage/habraeffect/04/5e/045e91ff88c977bba301a86350ce9a57.jpg" alt="Scheme predecessor"><br>  But only with a slight change: a resistor of 390 ohms was added between the first pin of the 4N25 optocoupler and the second pin of the LPT, and another LED was added to indicate switching on.  The scheme was assembled in test mode, i.e.  just wired as needed and tested.  In this version, she simply turned on and off the old Soviet torch. <br>  It was decided that if you already had control, it was not for one device, but for at least 4 devices (at the rate of: one lamp on the table, a chandelier for two switches, a spare socket).  At this stage, it became necessary to build a complete scheme of the device, the choice of various programs began. <br>  Were installed: <br><ol><li>  Pbc </li><li>  Kicad </li><li>  gEDA </li><li>  Eagle </li></ol><br>  After looking at all of them, I stopped at Eagle, as there were ‚Äúsimilar‚Äù details in its library.  That's what happened in it: <br><img src="https://habrastorage.org/storage/habraeffect/c2/08/c2086a2d11442e91bb2b0f04aa621cb7.png" alt="Eagle Device Diagram"><br><br><img src="https://habrastorage.org/storage/habraeffect/ab/12/ab1281db07a6d8240e6554506b37742f.png" alt="Device diagram with details"><br><br>  The diagram used port DB9 ie  An ordinary COM port, this is done for reasons of economy, both on board and on the connectors themselves (I had COMs), and since we will only use 5 conductors, this is enough for us with a margin.  So we also do the adapter from DB25 (LPT) to DB9 (COM), in my case it is done as follows: <br>  LPT 2-9 pin = COM 1-8 pin - these are control data pins; <br>  LPT 18-25 pin (they are often interconnected) = COM 9 pin - this is our land. <br>  Also, the circuit uses additional 12V power supply to power the relay, according to the plan it will be a simple Chinese charger or maybe 9V crown (one relay works normally, you need to check for 4 at a time).  Separate power and galvanic isolation using optocouplers is used to secure the computer port.  If you wish, you can of course be powered from a 12V power supply unit of a computer, but this each does on its own and at its own peril and risk. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h5>  Necessary parts to create a device </h5><br><ol><li>  COM port - 1 pc </li><li>  power connector - 1 pc </li><li>  green LED - 4 pcs </li><li>  optocoupler 4n25 - 4 pieces </li><li>  seat for optocoupler (I only had 8 feet) - 4 pcs </li><li>  390 ohm resistor - 4 pcs </li><li>  4.7 kŒ© resistor - 4 pcs </li><li>  KT815G transistor - 4 pieces </li><li>  Relay HJR-3FF-SZ - 4 pcs </li><li>  clips on 3 contacts - 4 pieces </li><li>  foil textolite </li></ol><br><br><h4>  Preparing the circuit board </h4><br>  Having tried to use Eagle for preparing the printed circuit board, I realized that it would be difficult and decided to find a simpler version.  This option was the sprint layout 5 program, even if it is for windows, but runs without problems in wine under linux.  The interface of the program is intuitive, in Russian and in the program there is quite clear help (help).  Therefore, all further actions for the development of the printed circuit board were made in sprint layout 5 (hereinafter referred to as SL5). <br>  Although many people use this program to develop the boards of their devices, I didn‚Äôt have the details I needed (even in a heap of downloaded macro collections).  Therefore, we had to first create the missing parts: <br><ol><li>  COM port (the one that did not coincide with mine, through the mounting holes) </li><li>  power socket </li><li>  three contact clip </li><li>  relay HJR-3FF-SZ </li></ol><br>  View of these details: <br><img src="https://habrastorage.org/storage/habraeffect/59/a4/59a47f704584d3f7408ef1fab17bd852.png" alt="Created parts in sl5"><br><br>  After adding the necessary details, the design of the PCB itself began.  It passed in several attempts, there were about five of them.  Each version of the board was printed on cardboard, holes were punctured and parts were inserted into them.  Actually, it was found out that my COM port does not match the one that was in SL5.  Just a small error surfaced in the relay circuit - in fact, the relay body was shifted by 2-3 mm.  Naturally all the errors have been corrected. <br>  On the first printed version, it turned out that the transistor connection was not correct, two contacts were mixed up. <br>  After all the corrections and fits, it turned out to be the following board: <br><img src="https://habrastorage.org/storage/habraeffect/22/d2/22d215e598299ee21a7549fed3fa8adf.png" alt="Final board view"><br><br>  In SL5 there is a ‚ÄúPhoto View‚Äù function for viewing the board, here‚Äôs how it looks in it: <br><img src="https://habrastorage.org/storage/habraeffect/55/72/55723d908796bb4b9ead9dd74a8ceba8.png" alt="Photo board with transparency"><br><br><img src="https://habrastorage.org/storage/habraeffect/7c/29/7c29262a7b586e891bfa52117ae941e9.png" alt="Photo board without transparency"><br><br>  In the final version of the board, the tracks will be slightly corrected, but otherwise it looks the same. <br><br>  In SL5 there is also a convenient option for printing the board, you can hide unnecessary layers and choose the print color of each layer, which is very useful. <br><br><h4>  PCB preparation </h4><br>  It was decided to make the board using the LUT method (laser-iron technology).  Next, the whole process in the photo. <br><br>  Cut out the required size of a piece of textolite. <br><img src="https://habrastorage.org/storage/habraeffect/df/48/df48581a92fca39b91010af7449c3f08.jpg" alt="PCB Preparation"><br><br>  We take the smallest sandpaper and gently we clean the copper surface. <br><img src="https://habrastorage.org/storage/habraeffect/4d/7d/4d7dadc7cffbe842c1c6f30ec2220f1e.jpg" alt="Cleaned surface"><br><br>  After stripping the surface, it must be rinsed and degreased.  You can rinse with water, and degrease with acetone (in my case it was solvent 646). <br>  Then we print our board on a laser printer on coated paper, without forgetting to install the most bold print in the printer (without saving toner).  This option turned out a bit unsuccessful, since the toner was smeared, but another attempt was just right. <br><img src="https://habrastorage.org/storage/habraeffect/bb/9c/bb9ccbd98f0dabd9aa1548d9d667c06b.jpg" alt="Printed blank for LUT"><br><br>  Now you need to transfer the picture from paper to textolite.  To do this, we cut out the picture and apply it to the PCB, we try to align it as needed and then heat it with an iron.  It is necessary to thoroughly heat the entire surface so that the toner melts and sticks to the copper surface.  Then we give the board to cool down a bit and go to wet it under running water.  When the paper is well enough wet it must be separated from the board.  Only adhered toner will remain on the board.  It looks like this: <br><img src="https://habrastorage.org/storage/habraeffect/86/7c/867c53727bb4595de640b8c301b27565.jpg" alt="Fee after drawing"><br><br>  Next, you need to prepare a solution for etching.  I used ferric chloride for this.  It is written on the ferric chloride bank that the solution needs to be done 1 to 3. I stepped back a bit from this and made 60 g of ferric chloride per 240 g of water, i.e.  it turned out 1 to 4, in spite of this board etching was normal, only a little slower.  Pay attention that the process of dissolving dry ferric chloride in water proceeds with the evolution of heat, therefore it is necessary to pour it into the water in small portions and stir it.  Naturally, it is necessary to use non-metallic dishes for pickling, in my case it was a plastic container (sort of from herring).  I got this solution: <br><img src="https://habrastorage.org/storage/habraeffect/94/c7/94c7a5cbd2d674cd835b8314b3fcaf7c.jpg" alt="Ferric chloride solution"><br><br>  Before lowering the board into the solution, I glued a line to the back of the line with the help of an adhesive tape, which would be more convenient to get the board and turn it over.  If the solution gets on your hands, you must quickly wash it off with soap (the soap neutralizes it), but the stains may still remain, it all depends on the specific conditions.  Stains from clothes are not displayed at all, but I was lucky not to check this for myself.  Immersing the board into the solution should be copper down and not all flat, but at an angle.  From time to time it is advisable to clear the board from working off, as it prevents further etching.  This can be done with cotton swabs. <br><img src="https://habrastorage.org/storage/habraeffect/06/b6/06b6d07da11c486939f362a8bdf7e7f4.jpg" alt="Fee after 10-15 minutes of etching"><br><br><img src="https://habrastorage.org/storage/habraeffect/50/e7/50e7e4603b760735f13a538d2ccd3966.jpg" alt="Fee after 38 minutes of pickling"><br><br>  The whole etching process took me 45 minutes, 40 minutes would be enough, but I was just busy with one more thing. <br>  After etching, wash the board with soap and tear off the tape with the line and get: <br><img src="https://habrastorage.org/storage/habraeffect/71/66/71669a26808e8ec2803f944e26fd624a.jpg" alt="Fee after etching and washing (on the ground)"><br><br><img src="https://habrastorage.org/storage/habraeffect/4a/f8/4af81bcc912a8f373bf6c36232e3fd50.jpg" alt="Fee after pickling and rinsing"><br><br>  Attention!  Do not pour the solution of ferric chloride into the sink (sewage) - this may damage the metal parts of the sink, and in general the solution may still be useful. <br>  Next, we need to wash off the toner, this is successfully done with the same solvent 646 that was used for degreasing (long contact of the solvent with the skin can damage it). <br><img src="https://habrastorage.org/storage/habraeffect/59/78/5978fa617f35d2e571b61bea1a56b98a.jpg" alt="Fee after toner removal"><br><br>  The next step is to drill holes.  I had 1mm and 1.5mm holes on the board, initially, since it was not possible to find thinner drills.  It was also impossible to find a collet chuck for mounting it on an electric motor in our city, so everything was done with a big drill. <br><img src="https://habrastorage.org/storage/habraeffect/f7/e6/f7e6786fd00d4dca2c0aff04f9fc720c.jpg" alt="Preparation for drilling"><br><br>  The first device came up <br><img src="https://habrastorage.org/storage/habraeffect/a7/b6/a7b66200537c108f9327d9b024704a1c.jpg" alt="The first device came up"><br><br>  The first time I took only two drills, but when using such a drill this turned out to be not enough.  One drill broke, and the second bent.  All that I managed to drill on the first day: <br><img src="https://habrastorage.org/storage/habraeffect/18/bc/18bc74f8e1a5e674cdc5720f831b89f0.jpg" alt="And that's all for today"><br><br>  The next day I bought five drills.  And they were just enough, because if they do not break (by the way, only one broke out of the five), they become blunt, and when bored, the tracks deteriorate, the copper begins to flake off.  After complete drilling of the board we get: <br><img src="https://habrastorage.org/storage/habraeffect/2b/34/2b347faef9918a4bcab161d488885526.jpg" alt="Board fully drilled, to the light"><br><br><img src="https://habrastorage.org/storage/habraeffect/b4/1d/b41ddf14a03fae82ffc1a8a51991d6b2.jpg" alt="Board fully drilled, side of parts"><br><br>  After drilling it is necessary to conduct a tin plating.  For this, I used the old method - a soldering iron, a TAGS flux and tin.  I wanted to try using the Rosa alloy, but not to find it in our town. <br><img src="https://habrastorage.org/storage/habraeffect/5e/f0/5ef05acfd70fc0831c1e8fc186e42acf.jpg" alt="Tinning process"><br><br>  After tinning we get the following result: <br><img src="https://habrastorage.org/storage/habraeffect/fe/fa/fefae0c8c98a0f7e697d877f4796660f.jpg" alt="Fee after tinning, view 1"><br><br><img src="https://habrastorage.org/storage/habraeffect/d5/9e/d59eb2ebcf269590f825cced5b7a65e4.jpg" alt="Fee after tinning, view 2"><br><br>  Next, you need to wash the board to remove residual flux, since the TAGS is water-washed, this can be done either with water or with alcohol.  I did something mean - laundered old vodka and rubbed with cotton buds.  After all these actions, our board is ready. <br><br><h4>  Mounting parts </h4><br>  To verify the correctness of the board, I initially collect only one (out of four) line of parts, where the error has crept in. <br><img src="https://habrastorage.org/storage/habraeffect/24/ef/24efb31f91db4472a80f204e5e3ff9ce.jpg" alt="One row row of parts"><br><br>  After mounting the parts, go and connect the device to the computer via LPT, for this an adapter is connected from DB25 (LPT) to DB9 (COM) in the following form: <br><ul><li>  2 pin DB25 to 1 pin DB9 </li><li>  3 pin DB25 to 2 pin DB9 </li><li>  4 pin DB25 to 3 pin DB9 </li><li>  5 pin DB25 to 4 pin DB9 </li><li>  6 pin DB25 to 5 pin DB9 </li><li>  7 pin DB25 to 6 pin DB9 </li><li>  8 pin DB25 to 7 pin DB9 </li><li>  21 pin DB25 (can be any from 18 to 25) to 9 pin DB9 </li></ul><br>  Since ordinary twisted pair was used as a wire, one wiring was not enough, but only five wires are enough for this device, so this option is suitable.  As an included load we have a simple Soviet flashlight.  Well, as a power supply - universal Chinese power supply (4 connectors and power from 3 to 12).  Here are all in the collection: <br><img src="https://habrastorage.org/storage/habraeffect/46/d0/46d02935c75894e8ce7fe48e10d689f1.jpg" alt="Device assembled for test"><br><br>  But the device is already working: <br><img src="https://habrastorage.org/storage/habraeffect/69/74/6974d4132e4c2b8fb075a23a2682d01c.jpg" alt="The device works successfully"><br><br>  This ended another evening and the installation of the remaining parts was left the next day. <br><br>  And here is the fully assembled device: <br><img src="https://habrastorage.org/storage/habraeffect/d9/46/d946ac05bc5eef716018c935a0ac0db4.jpg" alt="Fully equipped board - tracks"><br><br><img src="https://habrastorage.org/storage/habraeffect/7a/90/7a9030e3f9283b8d7c5634f5a9872862.jpg" alt="Complete board - parts"><br><br>  Well, a little video about how it works (the quality is not very good, there was nothing to take off normally) <br><iframe width="420" height="315" src="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://www.youtube.com/embed/Sl5vrB7kzro%3Ffeature%3Doembed&amp;xid=17259,15700022,15700186,15700191,15700253,15700256,15700259&amp;usg=ALkJrhiEQVkRrfOV5-wfxOvAfcL94ojFtw" frameborder="0" allowfullscreen=""></iframe><br>  That's all, it remains only to find a normal case for the device and run it in the case. <br><br><h4>  Software part </h4><br>  Naturally, to manage the LPT port, you need some kind of software, but since I have linux at my home, it was decided to simply write the simplest program myself, and later it would need to be added and adapted as necessary.  She looked like this: <br> <code>#include &lt;stdio.h&gt; <br> #include &lt;stdlib.h&gt; <br> #include &lt;unistd.h&gt; <br> #include &lt;sys/io.h&gt; <br> #define BASE 0x378 <br> #define TIME 100000 <br> int main () <br> { <br> int x = 0x0F; <br> int y = 0x00; <br> if (ioperm (BASE, 1, 1)) <br> { <br> perror ("ioperm()"); <br> exit (77); <br> } <br> outb (x, BASE); <br> return 0; <br> } <br></code> <br><br>  This program sends to LPT port 0x0F = 00001111, i.e.  delivers 1 to 2-5 pins (Data0-Data3), and this is our control voltage between 2-5 pins and ground (18-25 pins), thus all four relays will be turned on.  Similarly, there is a program for sending 0x00 to the port for disconnecting, instead of x, just sending y - outb (y, BASE).  You can also read the port status: <br> <code>#define BASEPORT 0x378 /* lp1 */ <br> ... <br> printf(": %d\n", inb(BASEPORT)); <br> ... <br></code> <br>  The only nuance of this program is that it needs to be performed as root, since the ioperm function is not available to the simple user.  I think how to solve such a problem can not tell, everyone will choose a more suitable option. <br><br>  Subsequently, the program was refined so that passing the command line parameters to it could indicate with which device and what to do. <br>  The ‚Äúsw --help‚Äù output: <br> <code>     LPT . <br>        . <br>  : sw [ ] [] <br>   -  1  8 <br>  - "on", "off", "st" - , ,  <br> : "sw 2 on"      "sw --help"   </code> <br> <br>  PS If someone needs it, then I can somewhere lay out the circuit card file in sl5 and the source code of the control program. </div><p>Source: <a href="https://habr.com/ru/post/112511/">https://habr.com/ru/post/112511/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../112499/index.html">Information technology in medicine</a></li>
<li><a href="../112500/index.html">XSD: partial validation</a></li>
<li><a href="../112502/index.html">Fully touchscreen concept</a></li>
<li><a href="../112503/index.html">Satellite running Android OS</a></li>
<li><a href="../112507/index.html">A lot of useful pieces for AS3 # 2</a></li>
<li><a href="../112514/index.html">Mark Russinovich wrote a new book</a></li>
<li><a href="../112515/index.html">Web studios and freelance teams - start-ups? (intermediate results)</a></li>
<li><a href="../112516/index.html">Release of a pirated version to increase sales on the AppStore</a></li>
<li><a href="../112517/index.html">US and German Courts Deny Mass Claims Against File-Sharing Network Members</a></li>
<li><a href="../112518/index.html">Validation of forms in JavaScript Part 1</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>