<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Video calls from browser to SIP</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="In the previous article I covered a bit the question of the available ways of organizing voice communication in the browser. This time the task will b...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Video calls from browser to SIP</h1><div class="post__text post__text-html js-mediator-article">  In the <a href="http://habrahabr.ru/blogs/voip/131575/">previous article</a> I covered a bit the question of the available ways of organizing voice communication in the browser.  This time the task will be more difficult: we want to make video calls from the browser to the remote subscriber, who is sitting at the softphone or a device that supports SIP.  It may be necessary, for example, here's why: <br><ul><li>  we want to make a system of online consultations for online stores, which will allow site visitors to conduct a video conversation with a consultant sitting at the usual messenger. </li><li>  we want to complement the Polycom-based teleconferencing system with the ability to connect participants who have nothing but the browser. </li></ul><div style="text-align:center;"><img src="https://habrastorage.org/storage2/d66/f6b/0a1/d66f6b0a191ab75ef13145e63cc03276.png"></div><br><a name="habracut"></a><br><h4>  Technology </h4><br>  I will not completely repeat all the calculations from the previous article, but go straight to the conclusions.  If we want to: <br><ul><li>  all desktop browsers were supported </li><li>  it was not necessary to put additional software </li><li>  the system was robust to network interference </li><li>  delays were minimal </li></ul>  we do <i>n‚Äôt have</i> any other way <i>at the moment</i> , except to make decisions based on Adobe Flash Player and the <a href="http://en.wikipedia.org/wiki/Real_Time_Media_Flow_Protocol">RTMFP</a> protocol <a href="http://en.wikipedia.org/wiki/Real_Time_Media_Flow_Protocol">,</a> however sad it may sound.  The bright future is not far off: Google has <a href="http://techcrunch.com/2011/11/24/chrome-getting-native-gamepad-webcam-and-webrtc-support-in-early-2012/">promised</a> to soon include in Chrome the support of the very interesting technology <a href="http://webrtc.org/">WebRTC</a> , which I will definitely write in a separate article.  In the meantime, we use what users already have. <br><br><h4>  Video support in Adobe Flash Player </h4><br>  Flash is currently able to play streams compressed with several codecs: <br><ul><li>  H264 </li><li>  Sorenson Spark H263 </li><li>  On2 VP6 </li><li>  Flash Screen Video </li></ul>  Of all this ‚Äúwealth‚Äù, we are interested only in H264, because finding support for the other options in softphones and SIP devices is almost impossible. <br><br>  With the capture and encoding of video from the camera, everything is much worse.  H264 encoding support appeared only in the recently released version of FP11, and before that the only option was Sorenson Spark.  Unfortunately, the 11th version is not yet installed by the vast majority of users, so you have to reckon with those who only have FP10. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <img src="https://habrastorage.org/storage2/2c6/744/811/2c674481149be6d0cd46cd73f992b27e.jpeg"><br><br>  We must also not forget with whom we are dealing.  Adobe managed to ‚Äúbreak down‚Äù the playback of certain types of H264 streams in Flash Player versions 11.0 - 11.2.  The problem is in playing streams packaged in packetization-mode: 0, and this is the mode used by most softphones.  Details about the bug can be read in the <a href="https://bugbase.adobe.com/index.cfm%3Fevent%3Dbug%26id%3D2991202">bugtracker</a> company. <br><br>  Total the following picture turns out.  To successfully connect to the H264 SIP client, we need: <br><ul><li>  perform Sorenson -&gt; H264 transcoding in one direction if the user of the FP version is lower than 11 </li><li>  perform <b>transcoding H264 -&gt; H264</b> (to change the packetization) in one direction, if the user has FP 11 with the above mentioned bug </li><li>  let traffic as it is, in all other cases. </li></ul>  The <a href="http://ffmpeg.org/">ffmpeg</a> and <a href="http://www.videolan.org/developers/x264.html">libx264</a> bundle is well suited for transcoding.  For transcoding performance, it is extremely important that the server supports MMX, SSE and similar technologies as later as possible.  Video codecs are able to use them, while accelerating at the same time. <br><br><h5>  Video is not a voice </h5><br>  At first glance, it may seem that the only difference between video and voice transmission is the width of the channel used.  This is certainly true, but there are a number of significant differences. <br><br>  The audio stream is usually divided into frames of 10-20 ms, each of which is encoded and decoded separately from the others.  For video, this would be too wasteful, so for most frames, the image itself is not encoded, but its difference with the previous frame.  For even better compression, the difference is taken with a slightly ‚Äúshifted‚Äù previous frame to compensate for the movement of objects.  In general, you can write separate cycles of articles about video compression and I will not dwell on this here. <br><br>  Another thing is important.  If we lose one frame of the audio stream, then we can simply <a href="http://en.wikipedia.org/wiki/Packet_loss_concealment">disguise it</a> , for example, by losing the previous frame again, and few people will notice it.  And in the video, this trick will not work, because the subsequent frames should be superimposed on the lost one.  From here, artifacts appear that will not disappear themselves, unless you ask the remote side to send an independently compressed frame (key frame).  In SIP, this can be done in two ways: at the signaling level via SIP INFO, and at the media level via RTCP. <br><br>  Next, you need to consider the limit on the MTU of the channel between the participants in the conversation, which is usually about 1500 bytes (you can not rely on IP fragmentation in the case of NAT).  Any audio frame will fit into this restriction, but the video frame most often does not.  Hence the need for splitting frames into pieces, which is called packetization, which is precisely the cause of a bug in some versions of Flash Player. <br><br><h4>  Result </h4><br>  As a result, if you carefully walk through all the rakes, and everywhere you need to spread the necessary amount of hay, you can get a completely working solution.  We managed to integrate support for video calls from the browser into our cloud platform <a href="http://rtckit.com/">RTCKit</a> , which in turn allows us to integrate this functionality into any web service in a matter of hours, saving a lot of time. <br><br> <a href="http://rtckit.com/"><img src="http://rtckit.com/static/img/rtckit.png" alt="Rtckit"></a> <br><br>  You can <a href="http://rtckit.com/demo/">test</a> all this without registering on our <a href="http://rtckit.com/demo/">test page</a> .  Video resolution there is limited to 352x288.  We tested the <a href="http://jitsi.org/">Jitsi</a> and <a href="http://www.linphone.org/">LinPhone softphones</a> , it would be interesting to hear feedback about other customers with H264 support.  We will try to withstand the load from the habr-effect!  Important note: if you call via RTCKit from browser to browser, and you have a sufficiently friendly NAT, then RTMFP Peer-2-Peer technology is used instead of everything described. <br><br>  In future articles we will cover the topic of voice and video conferencing, call routing, and interaction with mobile devices.  Stay tuned. </div><p>Source: <a href="https://habr.com/ru/post/136012/">https://habr.com/ru/post/136012/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../136005/index.html">Budget server solution all-in-one</a></li>
<li><a href="../136008/index.html">A selection of high-quality free fonts from Smashing Magazine</a></li>
<li><a href="../136009/index.html">StopSocial - extension to block social content (Opera, Chrome) [UPD]</a></li>
<li><a href="../136010/index.html">Technical overview of the tablet Lenovo IdeaPad Tablet K1</a></li>
<li><a href="../136011/index.html">What the coming year is preparing for us: ECM development trends in 2012</a></li>
<li><a href="../136013/index.html">Reddit website closes January 18 from 8:00 to 20:00 in protest against SOPA</a></li>
<li><a href="../136014/index.html">About safety and adequacy of support</a></li>
<li><a href="../136017/index.html">About tech support and CMS users</a></li>
<li><a href="../136019/index.html">Civic social network ‚ÄúNew Russia‚Äù</a></li>
<li><a href="../136021/index.html">Be prepared for the worst because it will happen anyway</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>