<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>The method of recovering data from a disk encrypted with NotPetya using the Salsa20 algorithm</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Attacks using encryption viruses have become a real trend of 2017. There were a lot of similar attacks, but the loudest of them were WannaCry and NotP...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>The method of recovering data from a disk encrypted with NotPetya using the Salsa20 algorithm</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/web/d56/d5b/ae4/d56d5bae47a24a86b68249619c44586f.JPG"><br><br>  Attacks using encryption viruses have become a real trend of 2017.  There were a lot of similar attacks, but the loudest of them were WannaCry and NotPetya (also known by many other names - Petya, Petya.A, ExPetr and others).  Having mastered the experience of the previous epidemic, experts around the world promptly reacted to the new challenge and, in a matter of hours after the first computers were infected, they began to study instances of encrypted disks.  Already on June 27, the <a href="https://www.ptsecurity.com/ru-ru/about/news/283092/">first descriptions of</a> methods of infection and distribution of NotPetya appeared, moreover, a <a href="https://twitter.com/PTsecurity_UK/status/879779707075665922">vaccine against infection appeared</a> . <br><br><a name="habracut"></a>  When you run NotPetya, the AES algorithm encrypts user files with certain extensions, but the operating system continues to work.  Limited time is allowed for encryption (the default is 1 hour).  And if during this time the encryption process has time to complete, the README.TXT file with the ransom request will be placed in the root of the disk.  Unfortunately, to recover files encrypted in this way requires knowledge of the RSA secret key (which, it seems, is <a href="https://xakep.ru/2017/07/06/petya-private-key/">offered to be bought</a> on the Darknet for 100 bitcoins).  If encryption was not completed, or it was interrupted, or there was no right to write to the disk root, the README.TXT file (containing the encrypted key) will not be created, and the AES-encrypted files will not be able to recover even if they receive the RSA secret key. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      <b>The following data recovery method is applicable in cases where the NotPetya virus had administrative privileges and encrypted the entire hard disk using the Salsa20 algorithm.</b> <br><br>  This is the second layer of encryption.  However, decoding Salsa20 is advisable for several reasons: <br><br><ul><li>  AES does not encrypt all file types (for example, skips images). </li><li>  AES works for a limited time (usually 1 hour), and that AES did not have time to encrypt is potentially recoverable. </li><li>  AES works from a specific user.  If you have multiple user accounts on your computer, AES may not have access rights to other users' data. </li></ul><br>  And Salsa20 encrypts all data, regardless of type, time and access rights. <br><br>  As <a href="https://habrahabr.ru/company/pt/blog/331962/">it turned out</a> , the authors of the virus made an error in the implementation of the Salsa20 algorithm, due to which half of the encryption key bytes were not used at all.  Reducing the key length from 256 to 128 bits, unfortunately, leaves no hope of finding it within a reasonable time. <br><br>  However, due to some features of using the Salsa20 algorithm, it is possible to recover data without knowing the key. <br><br><h3>  How Salsa20 works </h3><br>  Recall that Salsa20 is a synchronous stream cipher in which when encrypting a gamma is generated, depending on the key, and the bytes of this gamma are added using XOR operation with plaintext bytes.  To decrypt, repeat the procedure. <br><br>  So that the gamma can be calculated for any displacement in the stream, the gamma generator s20_expand32 () forms a 64-byte keystream array, in which the following are mixed: <br><br><ul><li>  256 bits (32 bytes) encryption key </li><li>  8 bytes of non-secret random sequence nonce (number used once), </li><li>  16 bytes of sigma constant (‚Äúexpand 32-byte k‚Äù or ‚Äú-1nvalid s3ct-id‚Äù), </li><li>  64 bits (8 bytes) block numbers in the stream. </li></ul><br>  This illustration, taken from <a href="http://blog.checkpoint.com/2016/04/11/decrypting-the-petya-ransomware/">the</a> Check Point <a href="http://blog.checkpoint.com/2016/04/11/decrypting-the-petya-ransomware/">report</a> , clearly shows how the data is laid out: <br><br><img src="https://habrastorage.org/web/1b7/cd8/a94/1b7cd8a9476a4af58e5450329e5bb4cd.png"><br><br>  The 64 bytes of the keystream are passed through the shuffle function, and the resulting 64 bytes are used as a fragment of the gamma. <br><br>  It should be noted that the generated gamma fragments are always aligned with a boundary multiple of 64 bytes.  And in order to encrypt, say, 7 bytes starting at offset 100, you need to find the block number that contains the first byte (100/64 == 1), calculate the gamma for this block and use 7 bytes from it starting at offset (100% 64 == 36).  If there are not enough bytes in the block, then a gamma is generated for the next block, etc. <br><br>  In the process of encrypting one stream (and the disk, from the point of view of NotPetya, is one stream), no key or nonce change occurs.  Therefore, for each encrypted disk, the only variable value in the keystream is the block number. <br><br>  As planned by the authors of the Salsa20 cipher, 2 ^ 64 blocks of 64 bytes each make it possible to generate a gamma with a period of 2 ^ 70 ~ 10 ^ 21 bytes.  This is a long enough period for almost any practical application, and hard drives of this size will not appear for a very long time. <br><br>  However, the implementation is not so smooth. <br><br><h3>  Real gamma period in NotPetya </h3><br>  Let's look at the prototype of the function s20_crypt32 (), through which calls the disk sectors are encrypted. <br><br><pre><code class="hljs cpp"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">enum</span></span></span><span class="hljs-function"> s20_status_t </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">s20_crypt32</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">uint8_t</span></span></span></span><span class="hljs-function"><span class="hljs-params"> *key, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">uint8_t</span></span></span></span><span class="hljs-function"><span class="hljs-params"> nonce[</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">static</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">8</span></span></span></span><span class="hljs-function"><span class="hljs-params">], </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">uint32_t</span></span></span></span><span class="hljs-function"><span class="hljs-params"> si, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">uint8_t</span></span></span></span><span class="hljs-function"><span class="hljs-params"> *buf, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">uint32_t</span></span></span></span><span class="hljs-function"><span class="hljs-params"> buflen)</span></span></span></span></code> </pre> <br>  Through the argument si (probably the Stream Index), the byte offset in the stream is passed.  And by the type of argument it is clear that there is not 64, but only 32 bits.  This value falls into the keystream after dividing by 64, that is, a maximum of 26 bits remains. <br><br><pre> <code class="hljs sql">// <span class="hljs-keyword"><span class="hljs-keyword">Set</span></span> the <span class="hljs-keyword"><span class="hljs-keyword">second</span></span>-<span class="hljs-keyword"><span class="hljs-keyword">to</span></span>-highest <span class="hljs-number"><span class="hljs-number">4</span></span> <span class="hljs-keyword"><span class="hljs-keyword">bytes</span></span> <span class="hljs-keyword"><span class="hljs-keyword">of</span></span> n <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> the <span class="hljs-keyword"><span class="hljs-keyword">block</span></span> <span class="hljs-built_in"><span class="hljs-built_in">number</span></span> s20_rev_littleendian(n+<span class="hljs-number"><span class="hljs-number">8</span></span>, si / <span class="hljs-number"><span class="hljs-number">64</span></span>);</code> </pre> <br>  And now we will look at one more picture taken from the same <a href="http://blog.checkpoint.com/2016/04/11/decrypting-the-petya-ransomware/">report</a> . <br><br><img src="https://habrastorage.org/web/3ac/b58/34b/3acb5834b8ea4621b22e8765b134e389.png"><br><br>  On it, those bytes are highlighted in gray, which do not affect gamma formation due to the implementation error of the function s20_rev_littleendian ().  Thus, of the 26 bits of the block number, only 16 bits (bytes at offset 0x20-0x21) will affect the keystream.  Consequently, the maximum gamma period will be 2 ^ 16 = 65536 blocks of 64 bytes, or 4 megabytes. <br><br>  The volume of encrypted data is likely to significantly exceed 4 megabytes, so many different pieces of data will be encrypted on the same gamma fragments.  This allows you to implement a trivial attack based on the well-known plaintext. <br><br><h3>  And one more mistake </h3><br>  At this developer flaws do not end there.  When you call the function s20_crypt32 (), instead of the offset value in bytes, they transfer ... the number of the 512-byte sector! <br><br>  Sectors are usually encrypted in pairs (1024 bytes in one access), which means that the gamma used to encrypt two adjacent pairs of sectors will match in 1022 bytes (with an offset of 2 bytes). <br><br><h3>  Known Plaintext Attack Heuristics </h3><br>  Modern versions of Windows use the NTFS file system, which uses quite a lot of different structures, the lion's share of fields in which can be easily predicted. <br>  In addition, the disc contains many files whose contents are easy to predict (in part or in full). <br><br><h3>  Introductory 512 bytes gamma </h3><br><br>  To verify the correctness of the encryption key, NotPetya encrypts sector 0x21 containing the predefined values ‚Äã‚Äã(all bytes 0x07).  This gives us 512 bytes of gamma. <br><br><h3>  MFT gamma recovery </h3><br>  NotPetya does not encrypt the first 16 entries in the MFT (32 sectors), but encrypts all the rest. <br><br>  It is known that each file entry begins with the sequence ‚ÄúFILE‚Äù, then bytes 30 00 03 00 usually go (UpdateSequenceArrayOffset = 0x30, UpdateSequenceArrayLength = 3).  Theoretically, these 4 bytes may have other values, but they are almost always the same for all file entries within the same NTFS logical volume. <br><br>  Thus, from one file record (occupying two sectors) we can get 8 bytes of gamma, and each adjacent record will give us two additional bytes (and the ability to check the 6 bytes received earlier).  The last entries are almost entirely zeros, which can give up to 1024 bytes of gamma. <br><br>  And by restoring the gamma fragments used to encrypt the MFT, we can completely restore the file system structure. <br><br><h3>  Recover gamma from known files </h3><br>  The extorter encrypts the first two sectors of each file that is longer than 1024 bytes.  In this case, the cluster size is usually larger than two sectors (for example, 8).  In this case, finding the encrypted beginning of any file and skipping 1024 bytes, we can easily get the next 3 kilobytes in the clear.  And if we have a file in which at the offset of 1024 bytes from the beginning there are exactly the same 3 kilobytes - with high probability and the beginning of the file will coincide.  And we will get up to 1024 bytes of gamma. <br><br>  If you put a ‚Äúclean‚Äù Windows XP and look into the Windows folder, you can find 8315 files there.  In actively used Windows 8.1 files will be more than 200 thousand.  The chances that many of them will match the files on the encrypted disk are more than enough. <br><br>  So, if you index DLL- and EXE-files from the available Windows installations (preferably the same version and with a close set of updates), it may be enough to restore the gamma completely. <br><br>  And having received gamma fragments, you can try to recover and unique files. <br><br><h3>  Perspectives and pitfalls </h3><br>  The complexity of the "manual" recovery of an encrypted disk is that this process takes considerable time (hours) and requires large amounts of free disk space.  Few of the users have an empty disk, the volume of which is not less than the volume of the encrypted one.  And to experiment on the affected original is akin to suicide. <br><br>  So it is unlikely that in the near future there will be a utility that will allow everything to be restored "quickly and without SMS."  Rather, we can expect the emergence of services for a more complete data recovery - in comparison with what is offered now. <br><br>  Companies that specialize in data recovery are more likely to handle the task of developing related software.  They should have a decent experience in solving such problems. <br><br>  However, we must not forget that the algorithm for selecting the sectors to be encrypted (and therefore need to be decrypted) also contains errors (for example, when parsing NTFS structures), and this may affect the result. <br><br>  Data recovery from the hard disk by this method requires the use of heuristics.  The degree of recovery depends on many factors (disk size, degree of its filling and fragmentation) and can reach 100% for large disks containing many ‚Äúpublic‚Äù files (components of the operating system and software products that are identical on many machines). <br><br>  We repeat that the method proposed in the article, unfortunately, will not allow decrypting files that were encrypted with the AES algorithm used by NotPetya, if it could not receive administrative privileges at startup. <br><br>  <i>I would like to express my gratitude to Alexander Peslyak (Solar Designer) for the suggestive clues that allowed me to come up with the method described above.</i> <br><br>  <b>Author: Dmitry Sklyarov, Head of Application Analysis, Positive Technologies.</b> </div><p>Source: <a href="https://habr.com/ru/post/332618/">https://habr.com/ru/post/332618/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../332604/index.html">How to build a database for mailings and do not turn into a spammer?</a></li>
<li><a href="../332608/index.html">How to create a vegetation billboard texture in Unreal Engine 4</a></li>
<li><a href="../332612/index.html">Seminar "Clouds and reality: cases, rakes, good news", July 13, St. Petersburg</a></li>
<li><a href="../332614/index.html">Backup LVM2 volumes with IO overload protection using SIGSTOP, SIGCONT signals</a></li>
<li><a href="../332616/index.html">Node.js platform will bypass Java for a year</a></li>
<li><a href="../332620/index.html">Will Python save from execution?</a></li>
<li><a href="../332622/index.html">DPM: Why is he like that?</a></li>
<li><a href="../332624/index.html">How to win in Vkontakte contests? Another approach</a></li>
<li><a href="../332626/index.html">Handling recurring SIGSEGV-like errors</a></li>
<li><a href="../332628/index.html">5 tricks to help develop on vue.js + vuex</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>