<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Removing the hardware key of full disk protection in Android phones on Qualcomm processors</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Exploit published on Github 


 Google has begun to implement full disk encryption (Full Disk Encryption, FDE) by default with the version of Android ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Removing the hardware key of full disk protection in Android phones on Qualcomm processors</h1><div class="post__text post__text-html js-mediator-article"><h3>  Exploit <a href="https://github.com/laginimaineb/ExtractKeyMaster">published on Github</a> </h3><br><img src="https://habrastorage.org/files/f96/0af/e81/f960afe81a5d49a997e1c74fbfadc1ae.png"><br><br>  Google has begun to implement full disk encryption (Full Disk Encryption, FDE) by default with the version of Android 5.0 Lollipop.  At the first time, when encryption was implemented in Nexus 6 devices, many users complained of a decrease in performance when reading and writing data to the drive, but since Android 6.0, this problem seems to be solved. <br><br>  Full disk encryption protects all information on the phone, even if the device fell into the hands of law enforcement or <s>other</s> intruders. <br><a name="habracut"></a><br>  When encryption is enabled, any information on the phone is automatically encrypted on the fly with an AES key before being written to the media.  And vice versa, when reading information, it is automatically decrypted with this key. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      On iOS 9 devices, this key is a derivative of the user password and the unique 256-bit hardware key sewn into the smartphone at the factory.  Even the FBI, as we know from a recent history with a San Bernardino shooter‚Äôs smartphone, because of which the FBI and Apple <a href="https://geektimes.ru/post/271238/">got to court,</a> cannot crack the encryption of such a level with the help of brute force.  As a result, the FBI still managed to hack the phone using an unknown 0day vulnerability.  As can be understood from the words of the head of the state structure, hackers <a href="https://geektimes.ru/post/274739/">had to pay</a> over a million dollars to bypass the FBI‚Äôs defense. <br><br><img src="https://habrastorage.org/files/51c/bcc/b6b/51cbccb6b54f4fa4ba8e33eaacfcab98.png"><br>  <i>Full disk encryption in iOS</i> <br><br>  Thus, brute-force FDE is only possible using a specific hardware device.  This greatly complicates the attack.  In the usual case, it would be possible to create a million copies and parallelize brute-force in the cloud service, which allows you to very quickly select 99% of real passwords.  But in this case, we have to limit ourselves to a single device, on which Apple adds more and additional interference - the delay between attempts to enter a password, the limit on the maximum number of attempts, etc.  That is why it is extremely important for the special services to find a way to extract the hardware UID, then the brute force password becomes a commonplace technical problem. <br><br>  Full disk encryption in Android 5.0+ is implemented somewhat differently than in iOS 9, and is described in detail in <a href="https://nelenkov.blogspot.com/2014/10/revisiting-android-disk-encryption.html">Nikolai Elenkov‚Äôs blog</a> and in the <a href="https://source.android.com/security/encryption/index.html">official Android documentation</a> . <br><br>  Here, the encryption key is also a derivative of the <font color="gray">usually weak</font> user password, but also of a randomly generated 128-bit master key (Device Encryption Key - DEK) and a randomly generated 128-bit salt.  The DEK generation field is protected using a carefully thought-out scheme in which user-entered values ‚Äã‚Äã‚Äî a pincode / password / pattern (graphic key) are used to enter.  Then the encrypted DEK is placed in a special encrypted storage called <i>crypto footer</i> .  All these levels of encryption need to be overcome before decrypting the DEK, and then any information recorded on the drive. <br><br><img src="https://habrastorage.org/files/6da/e30/cac/6dae30cac6a94ecfbf3891ad10d73548.png"><br><br>  As in the case of iOS 9, the Android operating system implements the binding of the encryption scheme to specific hardware in order to prevent bruteforce on copies of the operating system.  The hardware binding function is performed by a special <a href="https://source.android.com/security/keystore/">hardware storage</a> , KeyMaster, which operates in a special Trusted Execution Environment (TEE) environment, completely independent of the Android operating system.  Key security in the KeyMaster environment is essential.  Only this protects the system of full disk encryption from conducting effective brute force in parallel streams on OS copies. <br><br>  On Android devices, an isolated environment will never give its own key out to the ‚Äúinsecure‚Äù environment.  On the contrary, the KeyMaster module receives a ‚Äúkey blob‚Äù from an insecure environment, decrypts the key stored there - and gives it back.  In other words, the operation of the encryption system is possible only directly on the hardware device, but not in a virtual environment on another computer. <br><br>  In general, the whole process can be schematically depicted in such a diagram, which <a href="https://nelenkov.blogspot.com/2014/10/revisiting-android-disk-encryption.html">Nikolai Elenkov gives</a> . <br><br><img src="https://habrastorage.org/files/66d/bd5/9f6/66dbd59f6cf94b0f8e7b1c3ebc6ff42c.png"><br><br>  Protection of the KeyMaster environment and execution of commands on a dedicated secure processor is ensured by the secure environment provided by the hardware manufacturer.  In the case of Qualcomm, this is the QSEE (Qualcomm Secure Execution Environment) environment.  It allows for execution on a dedicated processor only individual small applications called ‚Äútrustlets‚Äù.  One such trust is KeyMaster.  The Android source code <a href="">has instructions</a> for accessing the KeyMaster application.  In fact, the trustlet only supports four instructions: <br><br><pre><code class="hljs swift">* <span class="hljs-type"><span class="hljs-type">Commands</span></span> supported */ <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">enum</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">keymaster_cmd_t</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-comment"><span class="hljs-comment">/* * List the commands supportedin by the hardware. */</span></span> <span class="hljs-type"><span class="hljs-type">KEYMASTER_GENERATE_KEYPAIR</span></span> = <span class="hljs-number"><span class="hljs-number">0x00000001</span></span>, <span class="hljs-type"><span class="hljs-type">KEYMASTER_IMPORT_KEYPAIR</span></span> = <span class="hljs-number"><span class="hljs-number">0x00000002</span></span>, <span class="hljs-type"><span class="hljs-type">KEYMASTER_SIGN_DATA</span></span> = <span class="hljs-number"><span class="hljs-number">0x00000003</span></span>, <span class="hljs-type"><span class="hljs-type">KEYMASTER_VERIFY_DATA</span></span> = <span class="hljs-number"><span class="hljs-number">0x00000004</span></span>, };</code> </pre> <br>  KeyMaster works exactly as described above: it gets the key blob, calculates the signature and puts it in the buffer. <br><br>  And now we have come to exactly the stage at which the new exploit is in place, which appeared in open access on June 30 (the <a href="https://github.com/laginimaineb/ExtractKeyMaster">repository on Github</a> ).  The exploit exploits the recently discovered vulnerabilities <a href="http://www.cvedetails.com/cve/CVE-2015-6639/">CVE-2015-6639</a> and <a href="http://www.cvedetails.com/cve/CVE-2016-2431/">CVE-2016-2431</a> . <br><br>  The author of the exploit, security specialist Gal Beniamini (Gal Beniamini) wrote a fake version of the QSEE application and using the above vulnerabilities was able to download it into a protected environment, thereby increasing its privileges and hacking the environment protection QSEE, which is involved in the process of key generation for disk encryption. <br><br>  Thus, a hypothetical attacker can ‚Äúfake‚Äù the hardware component of the encryption key and brute force the rest of the components, bypassing Android‚Äôs protection by the number of retries.  It remains only to find a user PIN / password. <br><br>  By the way, for the rare case when a user has set up a truly complex password with high entropy for encryption and cannot be picked up by brute force in a reasonable time, there is a backup plan.  If hacking encryption is really extremely necessary, then you can find exactly the same phone, the same model, with the same scratches and a protective case - and program it to send a password as soon as the victim enters it.  This fake device is attached to the victim instead of the original one.  To avoid disclosure and at the same time eliminate the risk of the victim entering the wrong password on the first attempt, the phone must be programmed that it does not accept any entered password as correct. <br><br>  But this is an extreme case, of course.  Ordinary pincodes and passwords are actually quite simple to pick up if there are no hardware brute force restrictions. <br><br>  There is an interesting point.  Protected environment on mobile devices is not set by Qualcomm itself, but by OEMs.  They can cooperate with the law enforcement agencies of the country in whose jurisdiction they are located and fulfill the requirements of court inquiries.  Accordingly, if such a cryptographic scheme is implemented by a Russian manufacturer, the information on the smartphone will be declassified at the request of the Russian court. <br><br>  And one more interesting moment.  Despite the fact that Gal Benyamini discussed these vulnerabilities with Qualcomm and Google for several months, fixing them is not so easy - there is not enough software upgrade (patches for Android came out in <a href="https://source.android.com/security/bulletin/2016-01-01.html">January</a> and <a href="https://source.android.com/security/bulletin/2016-05-01.html">May</a> for two vulnerabilities), or you may need a hardware upgrade.  The fact is that if an attacker gets a device, then theoretically he can roll back a software upgrade, return the device to a vulnerable version and conduct an attack. <br><br>  As mentioned above, the exploit code is <a href="https://github.com/laginimaineb/ExtractKeyMaster">published on Github</a> .  Here is a diagram of his work. <br><br><img src="https://habrastorage.org/files/dfc/b42/148/dfcb421481da432bb25a1160dcac71b3.png"><br><br>  Gal Benjamini has written <a href="https://github.com/laginimaineb/android_fde_bruteforce">several Python scripts</a> that simplify brute force after the exploit has been triggered.  In the comments to his blog posts, colleagues <a href="http://bits-please.blogspot.com/2016/06/extracting-qualcomms-keymaster-keys.html%3FshowComment%3D1467290026217">expressed a desire to</a> help in porting the script to the most powerful <a href="https://hashcat.net/hashcat/">hashcat</a> / <a href="https://hashcat.net/oclhashcat/">oclHashcat brutfors platform</a> . <br><br>  Benjamini suggests that Google, along with OEM builders, will develop a new, completely reliable hardware-software encryption scheme, which even theoretically cannot be cracked. <br><br>  We hope that this scheme will be implemented on a new generation of Android devices. </div><p>Source: <a href="https://habr.com/ru/post/395643/">https://habr.com/ru/post/395643/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../395627/index.html">The book "Project Eye" came to crowdfunding</a></li>
<li><a href="../395629/index.html">Create installation media with multiple versions of Windows NT 6.0+ without using third-party software</a></li>
<li><a href="../395635/index.html">The first batch of Blocks Wearables modular smart watches will be delivered in September 2016</a></li>
<li><a href="../395637/index.html">The self-taught Russian robot IR77 again ‚Äúran away‚Äù to freedom</a></li>
<li><a href="../395639/index.html">Streamers, Twitch and Total eSports organization (part 4)</a></li>
<li><a href="../395645/index.html">StartUps, IT and the rest of the world ...</a></li>
<li><a href="../395647/index.html">Scientists in Japan and the United States announced the launch of clinical trials of a new anti-aging drug</a></li>
<li><a href="../395649/index.html">How is Jolla + a late review of Sailfish OS 2.0</a></li>
<li><a href="../395651/index.html">Worthy end: the developers destroyed the Planetside game world by meteorite bombardment</a></li>
<li><a href="../395653/index.html">E-bike - accessibility and efficiency on a personal example</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>