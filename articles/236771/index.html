<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>A couple of useful commands that can be useful with DDoS and not only</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="In my case, as a frontend server, there is nginx and the access-log format is: 

 log_format main '$ remote_addr - $ remote_user [$ time_local] "$ hos...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>A couple of useful commands that can be useful with DDoS and not only</h1><div class="post__text post__text-html js-mediator-article">  In my case, as a frontend server, there is nginx and the access-log format is: <br><br>  log_format main '$ remote_addr - $ remote_user [$ time_local] "$ host" "$ request"' <br>  '$ status $ body_bytes_sent "$ http_referer"' <br>  '"$ http_user_agent" "$ http_x_forwarded_for" -&gt; $ upstream_response_time'; <br><br>  What the output gives something like this line: 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      188.142.8.61 - - [14 / Sep / 2014: 22: 51: 03 +0400] " <a href="http://www.mysite.ru/">www.mysite.ru</a> " "GET / HTTP / 1.1" 200 519 " <a href="http://6wwro6rq35muk.ru/">6wwro6rq35muk.ru</a> " "Mozilla / 4.0 (compatible; MSIE 8.0 ; Windows NT 5.1; WOW64; Trident / 4.0; SLCC2; .NET CLR 2.0.191602; .NET CLR 3.5.191602; .NET CLR 3.0.191602 "" - "-&gt; 0.003 <br><br>  1. <b>tail -f /var/log/nginx/nginx.access.log |</b>  <b>cut -d '' -f 1 |</b>  <b>logtop</b> <br><br>  Allows you to get the big picture: the distribution of unique IP, from which there are requests, the number of requests from a single IP, etc. <br>  The most valuable thing is that all this works in real time and you can monitor the situation by making any changes to the configuration (for example, simply ban the TOP 20 most active IPs via iptables or temporarily limit the geography of requests in nginx via GeoIP <a href="http_geoip_module.html">http://nginx.org /en/docs/http/ngx_http_geoip_module.html</a> ). <br><a name="habracut"></a><br>  Shows (and will be updated in real time) something like: <br><br>  <i>3199 elements in 27 seconds (118.48 elements / s)</i> <i><br></i>  <i>1,337 12.48 / s 95.65.66.183</i> <i><br></i>  <i>2 308 11.41 / s 122.29.177.10</i> <i><br></i>  <i>3 304 11.26 / s 122.18.251.54</i> <i><br></i>  <i>4,284 10.52 / s 92.98.80.164</i> <i><br></i>  <i>5,275 10.19 / s 188.239.14.134</i> <i><br></i>  <i>6,275 10.19 / s 201.87.32.17</i> <i><br></i>  <i>7,270 10.00 / s 112.185.132.118</i> <i><br></i>  <i>8,230 8.52 / s 200.77.195.44</i> <i><br></i>  <i>9 182 6.74 / s 177.35.100.49</i> <i><br></i>  <i>10 172 6.37 / s 177.34.181.245</i> <br><br>  Where in this case the columns mean: <br><br><ul><li>  1 - serial number </li><li>  2 - the number of requests from this IP </li><li>  3 - the number of requests per second from this IP </li><li>  4 - the actual IP itself </li></ul><br><br>  Above shows summary statistics for all requests. <br><br>  In this case, we see that 12.48 requests per second are coming from IP 95.65.66.183, and 337 requests have been made in the last 27 seconds.  The rest of the lines are similar. <br><br>  We will analyze in parts: <br>  <b>tail -f /var/log/nginx/nginx.access.log</b> - in continuous mode, read the end of the log file <br><br>  <b>cut -d '' -f 1</b> - divide the string into ‚Äúsubstrings‚Äù by the delimiter specified in the -d flag.  (in this example, a space is indicated). <br>  Flag -f 1 - show only the field with the sequence number "1" (in this case, this field will contain the IP from which the request is coming) <br><br>  <b>logtop</b> - counts the number of identical lines (in this case, IP), sorts them in descending order and lists them, adding statistics along the way (in Debian, put aptitude from the standard repository). <br><br>  2. <b>grep "&amp; key =" /var/log/nginx/nginx.access.log |</b>  <b>cut -d '' -f 1 |</b>  <b>sort |</b>  <b>uniq -c |</b>  <b>sort -n |</b>  <b>tail -n 30</b> - shows the distribution of any line by IP in the log. <br><br>  In my case, I needed to collect statistics on how often one IP uses the &amp; key = parameter in the request. <br><br>  It will show something like this: <br><br>  <i>31 66.249.69.246</i> <i><br></i>  <i>47 66.249.69.15</i> <i><br></i>  <i>51 66.249.69.46</i> <i><br></i>  <i>53 66.249.69.30</i> <i><br></i>  <i>803 66.249.64.33</i> <i><br></i>  <i>822 66.249.64.25</i> <i><br></i>  <i>912 66.249.64.29</i> <i><br></i>  <i>1856 66.249.64.90</i> <i><br></i>  <i>1867 66.249.64.82</i> <i><br></i>  <i>1878 66.249.64.86</i> <br><br><ul><li>  1 - the number of occurrences of the string (in this case, IP) </li><li>  2 - the actual IP itself </li></ul><br><br>  In this case, we see that 1878 requests came together from IP 66.249.64.86 (and then, if we look at Whois, we‚Äôll see that this IP belongs to Google and is not ‚Äúmalicious‚Äù) <br><br>  We will analyze in parts: <br><br>  <b>grep "&amp; key =" /var/log/nginx/nginx.access.log</b> - find all the lines in the log containing the substring "&amp; key =" (no matter what part of the line) <br>  <b>cut -d '' -f 1</b> - (see previous example), display IP <br>  <b>sort</b> - sort the lines (needed for the next command to work correctly) <br>  <b>uniq -c</b> - show unique lines + calculate the number of occurrences of these lines (the -c flag) <br>  <b>sort -n</b> - sort using numeric sort mode (-n flag) <br>  <b>tail -n 30</b> - print 30 lines with the most occurrences (flag -n 30, you can specify an arbitrary number of lines) <br><br>  All the requests above are for Debian or Ubuntu, but I think the commands in other Linux distributions will have a similar look. </div><p>Source: <a href="https://habr.com/ru/post/236771/">https://habr.com/ru/post/236771/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../236757/index.html">Overview of the most interesting materials on data analysis and machine learning ‚Ññ13 (September 8 - 14, 2014)</a></li>
<li><a href="../236759/index.html">Analysis of lost passwords Gmail, Yandex and Mail.Ru</a></li>
<li><a href="../236761/index.html">Superiority Mask. About the magic of "Merlin" put in a word</a></li>
<li><a href="../236763/index.html">The digest of interesting materials from the world of web development and IT for the last week ‚Ññ125 (September 8 - 14, 2014)</a></li>
<li><a href="../236769/index.html">The use of machine learning in trading. Part 2</a></li>
<li><a href="../236773/index.html">Sun Service</a></li>
<li><a href="../236777/index.html">A special look at the Android console: EXEQ Set 2</a></li>
<li><a href="../236779/index.html">Video demonstration of the Start menu from Windows 9</a></li>
<li><a href="../236781/index.html">Will the entrance through the social media account replace the usual login form?</a></li>
<li><a href="../236783/index.html">Canada Start-up Visa Program VS Ukrainian Entrepreneurs</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>