<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>The cost of real estate on heat maps</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="The article describes the process of creating a heat price map for the sale of real estate for Moscow and St. Petersburg. 





 My name is Dmitry, I ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>The cost of real estate on heat maps</h1><div class="post__text post__text-html js-mediator-article"><p>  The article describes the process of creating a heat price map for the sale of real estate for Moscow and St. Petersburg. </p><br><p><img src="https://habrastorage.org/web/b4a/44c/8b6/b4a44c8b66c84a649a00d843d89d8f32.PNG" alt="Moscow heat price map"></p><br><p>  My name is Dmitry, I am a programmer from St. Petersburg and I have a hobby - this is the real estate portal I have been doing in my free time for almost 5 years now.  The site is authoring, and it gives a sufficient level of freedom to experiment and implement any ideas on it.  And one of the old ideas was to create a heat price map. </p><a name="habracut"></a><br><p>  If you are too lazy to read the article, then you can touch the finished result <a href="https://kvartiri-domiki.ru/karta-cen">here</a> . </p><br><p>  With an abundance of sites dedicated to real estate, in RuNet there is no normal price map.  There are some not very clear maps where the areas are painted in a different color, but this is all wrong.  The average price for the district says little, there are areas in which prices differ by an order of magnitude, or even more.  The idea of ‚Äã‚Äãmaking a heat map has been visiting me for a long time, but in anticipation of the difficulty of undertaking it, I didn‚Äôt want to - I didn‚Äôt have enough inspiration. </p><br><p>  As usual, I accidentally stumbled upon an article about the <a href="https://habrahabr.ru/post/324596/">statistics of real estate prices in Saratov</a> .  The author describes exactly what I wanted to do: the map I imagined.  Actually it inspired me. </p><br><h1 id="instrumenty">  Instruments </h1><br><p>  The article has a link to the source code, but I don‚Äôt understand in Python (or in python), and I didn‚Äôt have a goal to learn a new language, so I decided to look for if not a ready-made component, then at least something that I can rewrite myself under .Net. </p><br><p>  As the first component to generate an image, I tried what <a href="https://developers.google.com/maps/documentation/javascript/examples/layer-heatmap">Google offers</a> . </p><br><p>  It turned out not at all what you need.  There is probably an intensity map - they would be suitable for visualizing the density of objects on the map, but not for displaying prices.  In addition, when the map is scaled, the points merge to become more intense - this is no good at all. </p><br><p><img src="https://habrastorage.org/web/24d/c26/4b0/24dc264b0b28467db24b5d48a20bfd27.gif"></p><br><p>  There is one Belarusian site where the price map is implemented using this method.  You can see <a href="https://resta.by/karta-cen">here</a> . </p><br><p><img src="https://habrastorage.org/web/324/f89/41b/324f8941beb046feaf94f562a903235e.PNG" alt="Price map resta.by"></p><br><p>  Looking at this map, who can tell where it is more expensive, and where it is cheaper?  I cant.  In general, this is ... three out of ten. </p><br><p>  The search continued, and I ended up on the stack <a href="https://stackoverflow.com/questions/30073977/create-custom-temperature-map-with-front-end-javascript">with the</a> following: a person asks exactly the question that interested me, namely, how to make a heat map and not an intensity map.  And in the answers there is a <a href="https://github.com/optimisme/javascript-temperatureMap">link to the JS-library</a> which does the right thing.  For calculations using <a href="https://en.wikipedia.org/wiki/Inverse_distance_weighting">Inverse Distance Weighting</a> .  JS is certainly not Sharp, but closer, so I was very happy.  Especially after I ‚Äúfelt‚Äù all this <a href="https://jsfiddle.net/mertk/y9gcuf65/">on jsfiddle</a> and made sure that the result was <a href="https://jsfiddle.net/mertk/y9gcuf65/">valid</a> .  A few hours later I already had a working code in C # (which was later heavily refined).  Here is a <a href="https://github.com/d-sky/HeatMap">link to GitHab</a> , if anyone needs it. </p><br><h1 id="dannye">  Data </h1><br><p>  During the work of the portal, I have accumulated more than 20 million objects throughout Russia (archival objects remain forever). </p><br><p>  How to process raw data is not an obvious question.  To begin with, filters: sales objects, new buildings and secondary housing, and only apartments and houses, because they can accurately calculate the cost per square meter, and I was going to show exactly the cost of a meter on the map as the most objective indicator.  I do not like rent because there is a lot of garbage.  Prices are highly distorted, lots of bogus ads, etc.  On sale, too, it's all there, but on a smaller scale.  In addition, rental prices directly depend on the cost of selling apartments, so the final map is quite suitable for visualizing the overall picture, if not tied to the values ‚Äã‚Äãin the legend. </p><br><p>  Any commerce, plots and parking lots had to be excluded, but for each of these categories it would also be interesting to see the result, but this somehow later.  Plus, it probably does not make sense to include old objects there, prices change.  It was decided that in six months and the volume will be normal and prices are relevant.  It turned out about 40,000 objects for Moscow and 30,000 for St. Petersburg. </p><br><p>  I could not decide on the optimal step for arranging objects to the starting point on the map.  I tried different options from 100 meters to 5 km.  I decided to leave at the discretion of users the three most interesting options: 250, 500 and 1000 meters. </p><br><p>  Points are generated as follows: the area is recursively divided into 4 rectangular sections until the section size coincides or slightly exceeds the minimum, or until there are no less objects in the area than the minimum allowable number (for example, 3).  For sections in which less than three objects, the final point is not created - they distort the overall picture and create excessive ‚Äúleakyness‚Äù, since such single objects often differ in price from those around them. </p><br><p><img src="https://habrastorage.org/web/389/a99/db9/389a99db9e4d4d558b8f4a1459a00ec7.gif" alt="Heat map points"></p><br><p>  Inside each resulting section is considered the average price of objects and set the final point.  Coordinates are not set at the center of the section, but the average value is calculated from the coordinates of all objects. </p><br><p>  For each of the steps (250, 500, 1000) its own set of points is generated.  For each point, the list of used objects is stored for display by clicking on the map. </p><br><p>  The coordinates of points in the database are stored in the form of geographic data, so before transferring them to work, the coordinates must be brought to world, and then to pixel data on the final bitmap.  What is the world coordinates can be read <a href="https://developers.google.com/maps/documentation/javascript/maptypes%3Fhl%3Dru">here</a> .  If in a nutshell, geographic coordinates imply placement on a sphere, and in order to display them on a plane they need to be converted in a certain way.  <a href="https://developers.google.com/maps/documentation/javascript/examples/map-coordinates">From here</a> I took the code to get the world and pixel coordinates. </p><br><p>  I decided that I would limit the zoom on the map from 8 to 14, because taking into account the minimum grid step with values ‚Äã‚Äãof 250 meters, it makes no sense to look closer. </p><br><h1 id="tayly">  Tiles </h1><br><p>  At first I thought it was better to make one big bitmap, and then break it into small fragments.  But, as a result, I did the opposite - small fragments are generated - tiles (tile), after which they are assembled for each of the zooms. </p><br><p>  Now, to display everything on the map, you must attach them to the corresponding coordinates.  The first thing I found in the search - <a href="https://developers.google.com/maps/documentation/javascript/examples/groundoverlay-simple">Ground Overlays</a> . </p><br><p>  After several hours of work, I got quite a visual result, but with one problem - terrible brakes when navigating the map.  Obviously, working with a large number of fragments is not what this mechanism is for. </p><br><p>  Began to google further and found <a href="https://developers.google.com/maps/documentation/android-api/tileoverlay">Tile Overlays</a> - it turned out in the end what you need.  The bottom line is this: for each of the zoom levels of the map (zoom index), the resulting image is composed of 256 pixels by 256 pixels, for each of which you can overlay your own image.  When navigating the map, only those tiles are loaded that fall into the visible area and correspond to the value of zoom index. </p><br><h1 id="granicy-regionov">  Region Borders </h1><br><p>  I have always had the coordinates of the borders of the regions, so this made the work a little easier.  When generating each of the tiles, it is checked whether it is necessary to cut it, and if necessary, I cut it, making the non-falling region transparent. </p><br><p> Seeing the result, I thought that users are not interested in official borders, and perhaps it would be more useful for them to see nearby areas too.  I had to draw my borders for maps exciting both the cities themselves (Moscow and St. Petersburg) and the nearest regions.  The number of objects has increased several times.  Now there are about 140 and 50 thousand for Moscow and St. Petersburg, respectively. </p><br><p>  Moscow: </p><br><p><img src="https://habrastorage.org/web/5ae/3bf/c62/5ae3bfc6239a4385b4b33493df408378.png" alt="Moscow Area"></p><br><p>  St. Petersburg: </p><br><p><img src="https://habrastorage.org/web/083/9bd/dbd/0839bddbd4804e599a421914f35f457b.png" alt="SPB Area"></p><br><p>  For drawing borders and getting their coordinates, I used someone‚Äôs ready-made code in codepen.io with minor changes.  Here is a link for <a href="https://codepen.io/d-sky/pen/JJqpYe">Moscow</a> and <a href="https://codepen.io/d-sky/pen/PKJzoO">St. Petersburg</a> .  After changing any of the points on the map, the list of geographical coordinates is inserted into the window in the form of a convenient for inserting into the database. </p><br><p>  Later, such a problem emerged: there are situations when areas with different price categories are located so close that they fall into one segment and the average price is considered for them.  For example, in St. Petersburg there are Kamenny and Krestovsky Islands, where only elite real estate is sold, and across a river 300 meters wide, there is an ordinary area with Khrushchev houses.  The difference in price is more than an order of magnitude (98 tr. Versus 1200 tr.). </p><br><p><img src="https://habrastorage.org/web/064/1fe/be5/0641febe56e94290b4b7c01b486374c2.PNG" alt="Kamenny island"></p><br><p>  In the figure, Stone Island, and red dots indicate objects on both sides of it that fell into the final section at a step of 1000 meters.  This greatly affects the average price in a position and distorts the overall picture. </p><br><p>  The solution was this: select some sections and when assembling objects, objects that fell into the section should not be mixed with objects that were not broken or that fell into another section.  For Peter, I also singled out the islands. </p><br><p><img src="https://habrastorage.org/web/910/b13/5d0/910b135d033e411799527bc70238ac76.PNG" alt="SPB separated areas"></p><br><p>  Accuracy is not important here.  The main thing is that there are no intersections between the regions. </p><br><h1 id="vybor-cvetov">  Choice of colors </h1><br><p>  I made it customizable to generate a heat map so that you can choose colors, adjust the number of levels, etc. <br>  For example, for an area of ‚Äã‚Äã500 by 500 pixels with 6 points set with values ‚Äã‚Äãfrom -100 to 100, you can get such options. </p><br><p>  Test points with values: </p><br><p><img src="https://habrastorage.org/web/839/3fc/e48/8393fce489894be781c451f29996c65a.png" alt="Testpoints"></p><br><p>  The same data on the map with levels: </p><br><p><img src="https://habrastorage.org/web/a24/865/0f4/a248650f4aee4e94ac5fc28315329480.png" alt="MapWithTestPoints"></p><br><p>  Without color restrictions and by level: </p><br><p><img src="https://habrastorage.org/web/a32/070/5e6/a320705e638045479a4069edebab32ab.png"></p><br><p>  With color restriction and no levels: </p><br><p><img src="https://habrastorage.org/web/623/0af/538/6230af538fac4a5d9d128961463eb746.png"></p><br><p>  With manually defined colors: </p><br><p><img src="https://habrastorage.org/web/61d/81d/50d/61d81d50d89442f89ff3c1983978545f.png"></p><br><p>  After long and painful experiments, preference was given to their own set of flowers (borrowed <a href="https://www.ventusky.com/%3Fp%3D9%3B71%3B1%26l%3Dtemperature">here</a> ) which are hardcoded to the class as the default set. </p><br><p>  The result at a step of 500 meters looks like this: </p><br><p><img src="https://habrastorage.org/web/b4a/44c/8b6/b4a44c8b66c84a649a00d843d89d8f32.PNG" alt="500m Map"></p><br><h1 id="proizvoditelnost">  Performance </h1><br><p>  To generate a map only for Moscow with parallel 6 streams (on an eight-core server of 3.2 GHz) it took more than a day.  This is completely unacceptable, because in the future there will be more regions and the launch should take place on a schedule at least once a week. </p><br><p>  The bottleneck in the algorithm is calculating the color for each pixel in the tile.  It is necessary to sort all points by distance from this pixel.  That is, an array of 6000 points had to be sorted 256x256 times.  A waste of resources.  It is obvious that all points are not needed, and we can limit ourselves to the closest ones.  The simplest solution is to take, for example, the top 100 points sorted by distance from the center of the tile.  But there may be a situation when the nearest 100 points are in a group, for example, from one side only.  Those.  we need not just the 100 nearest, but so that they are also located around.  Here is what I did: from the middle of the tile in every direction in 10-degree increments, rays each extend one third of the entire map.  Each beam grows until it has at least 5 points, or it does not reach the limit in length.  Thus, guaranteed in the final list will be approximately 150 points from all sides. </p><br><p>  It looks like this (the green dots - which were selected, the red ones - all the others. The red square in the middle is the tile itself): </p><br><p><img src="https://habrastorage.org/web/32f/b80/87c/32fb8087cce447ce9be882621538e13a.gif" alt="Bicycle"></p><br><p>  Beautiful, interesting and sticky, but absolutely useless.  Bicycle, in its classic manifestation.  I spent a whole day experimenting with parameters: the number of rays, their length, the number of points in each beam, etc.  And I always got errors on the map. </p><br><p>  They look like this: </p><br><p><img src="https://habrastorage.org/web/e60/41e/743/e6041e74391a430aa70cf2f355c0b1e2.gif"></p><br><p>  These are angularities on areas of which borders should always be rounded.  These errors always appear in places with a low concentration of data. </p><br><p>  As a result, this whole mechanism had to be thrown out.  The easiest and most obvious way works best - the 100 nearest points without taking into account those that are in the tile itself.  Although the errors remained on the map, they are in places that, I hope, are of little interest to people, because there is almost nothing for sale. </p><br><p>  The speed of work has increased significantly.  It takes about 3 hours to Moscow, about an hour from them only for data processing, the rest is directly to drawing. </p><br><h1 id="prosmotr-obektov">  View objects </h1><br><p>  When clicking on the map, the point closest to the location of the click is selected, and summary information is displayed for it: the average price per meter and the list of objects used for the calculation.  Also, the red dots on the map show the coordinates of these objects.  Under the link you can go to the card for each more detailed information.  Many objects are archival, so that they may not be displayed photos and contacts of the seller, but otherwise - all the information corresponds to the original. </p><br><p><img src="https://habrastorage.org/web/a71/32c/389/a7132c389ad94d439bbb02deae11d7f8.PNG" alt="Display points"></p><br><h1 id="zaklyuchenie">  Conclusion </h1><br><p>  In the near future I plan to increase the number of objects on the map, because most of them in the database do not have geographical coordinates.  To do this, you need to make a geolocation module that will run daily on such objects by receiving coordinates for them via Google or Yandex services. </p><br><p>  I also plan to supplement the map with some statistical information in the form of tabular data.  Breakdown by price categories, average prices, etc. </p><br><h1 id="ssylki">  Links </h1><br><p>  Just in case duplicate links here in the same order in which they are listed in the article. </p><br><div class="spoiler">  <b class="spoiler_title">Links from the post</b> <div class="spoiler_text"><p>  <a href="https://habrahabr.ru/post/324596/">https://habrahabr.ru/post/324596/</a> <br>  <a href="https://developers.google.com/maps/documentation/javascript/examples/layer-heatmap">https://developers.google.com/maps/documentation/javascript/examples/layer-heatmap</a> <br>  <a href="https://resta.by/karta-cen">https://resta.by/karta-cen</a> <br>  <a href="https://stackoverflow.com/questions/30073977/create-custom-temperature-map-with-front-end-javascript">https://stackoverflow.com/questions/30073977/create-custom-temperature-map-with-front-end-javascript</a> <br>  <a href="https://github.com/optimisme/javascript-temperatureMap">https://github.com/optimisme/javascript-temperatureMap</a> <br>  <a href="https://en.wikipedia.org/wiki/Inverse_distance_weighting">https://en.wikipedia.org/wiki/Inverse_distance_weighting</a> <br>  <a href="https://jsfiddle.net/mertk/y9gcuf65/">https://jsfiddle.net/mertk/y9gcuf65/</a> <br>  <a href="https://github.com/d-sky/HeatMap">https://github.com/d-sky/HeatMap</a> <br>  <a href="https://developers.google.com/maps/documentation/javascript/maptypes%3Fhl%3Dru">https://developers.google.com/maps/documentation/javascript/maptypes?hl=en#MapCoordinates</a> <br>  <a href="https://developers.google.com/maps/documentation/javascript/examples/map-coordinates">https://developers.google.com/maps/documentation/javascript/examples/map-coordinates</a> <br>  <a href="https://developers.google.com/maps/documentation/javascript/examples/groundoverlay-simple">https://developers.google.com/maps/documentation/javascript/examples/groundoverlay-simple</a> <br>  <a href="https://developers.google.com/maps/documentation/android-api/tileoverlay">https://developers.google.com/maps/documentation/android-api/tileoverlay</a> <br>  <a href="https://codepen.io/d-sky/pen/JJqpYe">https://codepen.io/d-sky/pen/JJqpYe</a> <br>  <a href="https://codepen.io/d-sky/pen/PKJzoO">https://codepen.io/d-sky/pen/PKJzoO</a> <br>  <a href="https://www.ventusky.com/%3Fp%3D9%3B71%3B1%26l%3Dtemperature">https://www.ventusky.com/?p=9;71;1&amp;l=temperature</a> <br>  <a href="https://kvartiri-domiki.ru/karta-cen">https://kvartiri-domiki.ru/karta-cen</a> </p></div></div><br><h1 id="ps">  PS </h1><br><p>  When you navigate around the map, now there is a small freeze about once every 10-15 seconds, this is not on my website a bug, this is how the new Web Metric WebVisor behaves.  I have already written to Yandex - they said that they need time to figure it out.  So, soon, I hope to fix it. </p></div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <p>Source: <a href="https://habr.com/ru/post/335638/">https://habr.com/ru/post/335638/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../335628/index.html">New features of Veeam Agent 2.0 for Microsoft Windows (in free and paid versions)</a></li>
<li><a href="../335630/index.html">Emercoin will reduce transaction fees by 100 times</a></li>
<li><a href="../335632/index.html">Placement of icons on the site page. Make it easier, support it easier</a></li>
<li><a href="../335634/index.html">How to find out the balance of someone else's bank card, knowing its number?</a></li>
<li><a href="../335636/index.html">Warehouse management system using CQRS and Event Sourcing. Service layer</a></li>
<li><a href="../335642/index.html">Redesign Habrahabra and Hiktayms. Finish line</a></li>
<li><a href="../335644/index.html">Postgres 9.x Partitioning Using pg_pathman to optimize the insertion and pruning of partitions</a></li>
<li><a href="../335646/index.html">We are testing a new mechanism for synchronization of settings JetBrains IDEs</a></li>
<li><a href="../335648/index.html">Returning a Cisco router with a non-working CF or mini-flash card</a></li>
<li><a href="../335650/index.html">What can chat bot</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>