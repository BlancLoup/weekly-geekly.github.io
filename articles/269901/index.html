<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Pitfalls Entity Framework and Performance</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="When working with the Entity Framework, as with any other ORM, there are often issues related to its performance. Many developers because of ignorance...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Pitfalls Entity Framework and Performance</h1><div class="post__text post__text-html js-mediator-article">  When working with the Entity Framework, as with any other ORM, there are often issues related to its performance.  Many developers because of ignorance of the nuances make mistakes that lead to poor results.  Then, during the analysis of the problems and the search for solutions, not enough to understand the question, they come to the conclusion that the situation can only be improved by switching to another ORM or abandoning it in general.  Although in some situations such a decision may be reasonable, it is often not so bad ‚Äî you just need to know the nuances.  In this article, I tried to collect those pitfalls that I most often encountered in practice. <br><a name="habracut"></a><br><ol><li>  <a href="https://habr.com/ru/post/269901/">Enable tracking changes when not needed</a> </li><li>  <a href="https://habr.com/ru/post/269901/">Permanent recompilation of some queries</a> <br><ul><li>  <a href="https://habr.com/ru/post/269901/">Using Contains on collection in memory</a> </li><li>  <a href="https://habr.com/ru/post/269901/">Use Take and Skip</a> </li></ul></li><li>  <a href="https://habr.com/ru/post/269901/">A large number of Include in one request</a> </li><li>  <a href="https://habr.com/ru/post/269901/">Subtracting fields from the base entity only when using the Table Per Type mapping</a> </li><li>  <a href="https://habr.com/ru/post/269901/">Additional Information</a> </li></ol><br><br><a name="1"></a><h2>  Enable tracking changes when not needed </h2><br>  Suppose there is such a code fragment in our project, designed to read some list of entities and then transfer them to the client: <br><br><pre><code class="hljs pgsql"><span class="hljs-keyword"><span class="hljs-keyword">using</span></span>(var context = <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> EntityDataContext()) { <span class="hljs-built_in"><span class="hljs-built_in">found</span></span> = context.Entities.<span class="hljs-keyword"><span class="hljs-keyword">Where</span></span>(e =&gt; e.Name.StartsWith(<span class="hljs-keyword"><span class="hljs-keyword">filter</span></span>)).ToList(); }</code> </pre> <br>  At first glance, there are no problems, but if there are no special settings hidden in the context constructor, this code will lead to extra computational resources.  Each request has a MergeOption attribute that specifies how to load the objects read by the request into the context.  By default, this attribute is AppendOnly, which says that entities that are not yet in context should be added to it. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      The question arises - why add objects to the context if there is no further action to change and save them?  The answer is no need, these are extra expenses, and they are noticeable.  If the objects read using the Entity Framework context will not be modified and will not participate in modifications of other objects, in the corresponding request, call AsNoTracking () for the collection: <br><br><pre> <code class="hljs pgsql"><span class="hljs-keyword"><span class="hljs-keyword">using</span></span>(var context = <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> EntityDataContext()) { <span class="hljs-built_in"><span class="hljs-built_in">found</span></span> = context.Entities.AsNoTracking().<span class="hljs-keyword"><span class="hljs-keyword">Where</span></span>(e =&gt; e.Name.StartsWith(<span class="hljs-keyword"><span class="hljs-keyword">filter</span></span>)).ToList(); }</code> </pre><br>  This function sets the MergeOption attribute to NoTracking, thereby excluding actions to add the read objects to the context.  You can see how significant the gain is at this link <a href="https://msdn.microsoft.com/en-us/data/hh949853.aspx">https://msdn.microsoft.com/en-us/data/hh949853.aspx</a> (point 5.2) or here - <a href="http://blog.staticvoid.co.nz/2012/4/2/entity_framework_and_asnotracking">http://blog.staticvoid.co.nz/2012/4 / 2 / entity_framework_and_asnotracking</a> . <br><br>  Another potential problem associated with excessive tracking of changes is primarily concerned with scenarios with adding and modifying data.  The context configuration has an AutoDetectChangesEnabled property that indicates whether to automatically call the DetectChanges method before performing certain operations.  Such operations include adding an object to the context, saving changes to the database, searching for objects through the Find method, etc.  The call to DetectChanges is needed, in particular, to determine what exactly has changed / deleted / added, to update links between objects, etc.  For more information about what this method is for, you can read here - <a href="http://blog.oneunicorn.com/2012/03/10/secrets-of-detectchanges-part-1-what-does-detectchanges-do/">http://blog.oneunicorn.com/2012/03/10/secrets-of-detectchanges-part-1-what-does-detectchanges-do/</a> . <br><br>  Suppose a typical scenario is to add a set of objects to the database: <br><br><pre> <code class="hljs pgsql"><span class="hljs-keyword"><span class="hljs-keyword">using</span></span> (var context = <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> EntitiesContext()) { <span class="hljs-keyword"><span class="hljs-keyword">for</span></span>(<span class="hljs-type"><span class="hljs-type">int</span></span> i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; <span class="hljs-number"><span class="hljs-number">1000</span></span>; i++) { context.PassengerCars.<span class="hljs-keyword"><span class="hljs-keyword">Add</span></span>(<span class="hljs-built_in"><span class="hljs-built_in">new</span></span> PassengerCar { <span class="hljs-type"><span class="hljs-type">Name</span></span> = "RandomCar " + i.ToString() }); } context.SaveChanges(); }</code> </pre><br>  The value of AutoDetectChangesEnabled defaults to true, which means that when adding each new PassengerCar object, DetectChanges will be called first, which will go through all the objects in the context and check for changes.  But in this case, it is absolutely not needed - there are no changes to the added entities in this code, they are saved in the form in which they were added.  And the cost of DetectChanges is very significant, examples can be seen here - <a href="http://blog.staticvoid.co.nz/2012/5/7/entityframework_performance_and_autodetectchanges">http://blog.staticvoid.co.nz/2012/5/7/entityframework_performance_and_autodetectchanges</a> . <br><br>  The thoughtless shutdown of the AutoDetectChangesEnabled property can lead to undesirable consequences (loss of changes, exceptions due to data integrity), so I would put the simplest rule - if your code does not imply further changes to the objects added to the context within the same session, then this property can be easily disabled.  This situation occurs quite often - a typical CRUD API usually receives an object from the outside and either just adds it, or determines what changes have been made since the time of reading, and updates the information about the state of the object in the context accordingly (for example, using <a href="https://github.com/refactorthis/GraphDiff">GraphDiff</a> , or using self-tracked entities, or any other similar solutions).  The object itself does not change. <br><br><a name="2"></a><h2>  Permanent recompilation of some queries </h2><br>  Starting with the Entity Framework 5, queries are automatically cached after compilation, which significantly speeds up their subsequent execution - the SQL query text will be taken from the cache, it only remains to substitute the required parameter values.  But there are several situations in which compilation will be performed with each execution. <br><br><a name="2a"></a><h3>  Using Contains on collection in memory </h3><br>  In practice, it is often necessary to add to the query a condition similar to the SQL IN operator ‚Äî check whether the value of the property matches any of the elements of the collection.  For example, like this: <br><br><pre> <code class="hljs pgsql">List&lt;<span class="hljs-type"><span class="hljs-type">int</span></span>&gt; channels = <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> List&lt;<span class="hljs-type"><span class="hljs-type">int</span></span>&gt; { <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-number"><span class="hljs-number">5</span></span>, <span class="hljs-number"><span class="hljs-number">9</span></span> }; dataContext.Entities .AsNoTracking() .<span class="hljs-keyword"><span class="hljs-keyword">Where</span></span>(e =&gt; channels.Contains(e.Channel)) .ToList();</code> </pre><br>  This expression is eventually converted to the following SQL: <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> [Extent1].[<span class="hljs-keyword"><span class="hljs-keyword">Id</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> [<span class="hljs-keyword"><span class="hljs-keyword">Id</span></span>], [Extent1].[<span class="hljs-keyword"><span class="hljs-keyword">Name</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> [<span class="hljs-keyword"><span class="hljs-keyword">Name</span></span>], [Extent1].[Channel] <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> [Channel] <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> [dbo].[Entities] <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> [Extent1] <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> [Extent1].[Channel] <span class="hljs-keyword"><span class="hljs-keyword">IN</span></span> (<span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-number"><span class="hljs-number">5</span></span>, <span class="hljs-number"><span class="hljs-number">9</span></span>)</code> </pre><br>  It turns out that for the IN operator the parameters are not used, but instead the values ‚Äã‚Äãthemselves are substituted.  Such a request to cache will not work, because  when using a collection with different content, the query text will need to be regenerated.  This, incidentally, beats not only the performance of the Entity Framework itself, but also against the database server, since for any new list of values ‚Äã‚Äãin the IN operator, the server will have to rebuild and cache the execution plan. <br><br>  If a collection that doesn‚Äôt expect a large number of elements (say, no more than a hundred), the problem can be solved by dynamically generating conditions connected by the OR operator.  This is easily done, for example, using the <a href="http://www.albahari.com/nutshell/linqkit.aspx">LinqKit</a> library: <br><br><pre> <code class="hljs pgsql">List&lt;<span class="hljs-type"><span class="hljs-type">int</span></span>&gt; channels = <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> List&lt;<span class="hljs-type"><span class="hljs-type">int</span></span>&gt; { <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-number"><span class="hljs-number">5</span></span>, <span class="hljs-number"><span class="hljs-number">9</span></span> }; var channelsCondition = PredicateBuilder.<span class="hljs-keyword"><span class="hljs-keyword">False</span></span>&lt;Entity&gt;(); channelsCondition = channels.<span class="hljs-keyword"><span class="hljs-keyword">Aggregate</span></span>(channelsCondition, (<span class="hljs-keyword"><span class="hljs-keyword">current</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">value</span></span>) =&gt; <span class="hljs-keyword"><span class="hljs-keyword">current</span></span>.<span class="hljs-keyword"><span class="hljs-keyword">Or</span></span>(e =&gt; e.Channel == <span class="hljs-keyword"><span class="hljs-keyword">value</span></span>).Expand()); var query = dataContext.Entities .AsNoTracking() .<span class="hljs-keyword"><span class="hljs-keyword">Where</span></span>(channelsCondition);</code> </pre><br>  As a result, we get the already parameterized query: <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> [Extent1].[<span class="hljs-keyword"><span class="hljs-keyword">Id</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> [<span class="hljs-keyword"><span class="hljs-keyword">Id</span></span>], [Extent1].[<span class="hljs-keyword"><span class="hljs-keyword">Name</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> [<span class="hljs-keyword"><span class="hljs-keyword">Name</span></span>], [Extent1].[Channel] <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> [Channel] <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> [dbo].[Entities] <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> [Extent1] <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> [Extent1].[Channel] <span class="hljs-keyword"><span class="hljs-keyword">IN</span></span> (@p__linq__0,@p__linq__1,@p__linq__2)</code> </pre><br>  Despite the fact that the dynamic construction of a query looks like an extra costly job, in practice it takes relatively little CPU time.  In one of the real tasks, building a query with each call took more than a second.  And replacing Contains with a similar dynamic expression reduced the query processing time (except for the first one) to tens of milliseconds. <br><br><a name="2b"></a><h3>  Use Take and Skip </h3><br>  In many projects there is a need to implement paging for search results.  The obvious solution for selecting the desired portion of records here are the Take and Skip functions: <br><br><pre> <code class="hljs cs"><span class="hljs-keyword"><span class="hljs-keyword">int</span></span> pageSize = <span class="hljs-number"><span class="hljs-number">10</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> startFrom = <span class="hljs-number"><span class="hljs-number">10</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> query = dataContext.Entities .AsNoTracking() .OrderBy(e =&gt; e.Name) .Skip(startFrom) .Take(pageSize);</code> </pre><br>  Let's see what SQL will be in this case: <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> [Extent1].[<span class="hljs-keyword"><span class="hljs-keyword">Id</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> [<span class="hljs-keyword"><span class="hljs-keyword">Id</span></span>], [Extent1].[<span class="hljs-keyword"><span class="hljs-keyword">Name</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> [<span class="hljs-keyword"><span class="hljs-keyword">Name</span></span>], [Extent1].[Channel] <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> [Channel] <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> [dbo].[Entities] <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> [Extent1] <span class="hljs-keyword"><span class="hljs-keyword">ORDER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BY</span></span> [Extent1].[<span class="hljs-keyword"><span class="hljs-keyword">Name</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">ASC</span></span> <span class="hljs-keyword"><span class="hljs-keyword">OFFSET</span></span> <span class="hljs-number"><span class="hljs-number">10</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ROWS</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FETCH</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NEXT</span></span> <span class="hljs-number"><span class="hljs-number">10</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ROWS</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ONLY</span></span></code> </pre><br>  Both the page size and the offset value are specified in the request by constants, not parameters.  This, again, means that the request text will not be cached.  Fortunately, starting with Entity Framework 6, there is a simple way to get around this problem - use lambda expressions in the Take and Skip functions: <br><br><pre> <code class="hljs javascript"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> query = dataContext.Entities .AsNoTracking() .OrderBy(<span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">e</span></span></span><span class="hljs-function"> =&gt;</span></span> e.Name) .Skip(<span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> =&gt;</span></span> startFrom) .Take(<span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> =&gt;</span></span> pageSize);</code> </pre><br>  And the resulting query will contain parameters instead of constants: <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> [Extent1].[<span class="hljs-keyword"><span class="hljs-keyword">Id</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> [<span class="hljs-keyword"><span class="hljs-keyword">Id</span></span>], [Extent1].[<span class="hljs-keyword"><span class="hljs-keyword">Name</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> [<span class="hljs-keyword"><span class="hljs-keyword">Name</span></span>], [Extent1].[Channel] <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> [Channel] <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> [dbo].[Entities] <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> [Extent1] <span class="hljs-keyword"><span class="hljs-keyword">ORDER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BY</span></span> [Extent1].[<span class="hljs-keyword"><span class="hljs-keyword">Name</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">ASC</span></span> <span class="hljs-keyword"><span class="hljs-keyword">OFFSET</span></span> @p__linq__0 <span class="hljs-keyword"><span class="hljs-keyword">ROWS</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FETCH</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NEXT</span></span> @p__linq__1 <span class="hljs-keyword"><span class="hljs-keyword">ROWS</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ONLY</span></span></code> </pre><br><br><a name="3"></a><h2>  A large number of Include in one request </h2><br>  Obviously, the easiest way to read data from a database along with child collections and other navigation properties is to use the Include () method.  Regardless of the number of Include () in a LINQ query, one SQL query will be generated by the total, which returns all the specified data.  It may seem that within the Entity Framework such an approach for reading complex objects will be the most optimal in any situation.  But it is not so. <br><br>  To begin, consider the structure of the final SQL query.  For example, we have a LINQ request with two Include for collections. <br><br><pre> <code class="hljs javascript"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> query = c.GuidKeySequentialParentEntities .AsNoTracking() .Include(<span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">e</span></span></span><span class="hljs-function"> =&gt;</span></span> e.Children1) .Include(<span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">e</span></span></span><span class="hljs-function"> =&gt;</span></span> e.Children2) .Where(<span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">e</span></span></span><span class="hljs-function"> =&gt;</span></span> e.Id == sequentialGuidKey);</code> </pre><br>  The corresponding SQL will contain UNION ALL: <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> [UnionAll1].[C2] <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> [C1], [UnionAll1].[<span class="hljs-keyword"><span class="hljs-keyword">Id</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> [C2], [UnionAll1].[<span class="hljs-keyword"><span class="hljs-keyword">Name</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> [C3], [UnionAll1].[C1] <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> [C4], [UnionAll1].[Id1] <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> [C5], [UnionAll1].[Name1] <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> [C6], [UnionAll1].[ParentId] <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> [C7], [UnionAll1].[C3] <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> [C8], [UnionAll1].[C4] <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> [C9], [UnionAll1].[C5] <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> [C10] <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">CASE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">WHEN</span></span> ([Extent2].[<span class="hljs-keyword"><span class="hljs-keyword">Id</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">IS</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">THEN</span></span> <span class="hljs-keyword"><span class="hljs-keyword">CAST</span></span>(<span class="hljs-literal"><span class="hljs-literal">NULL</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> <span class="hljs-built_in"><span class="hljs-built_in">int</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">ELSE</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">END</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> [C1], <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> [C2], [Extent1].[<span class="hljs-keyword"><span class="hljs-keyword">Id</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> [<span class="hljs-keyword"><span class="hljs-keyword">Id</span></span>], [Extent1].[<span class="hljs-keyword"><span class="hljs-keyword">Name</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> [<span class="hljs-keyword"><span class="hljs-keyword">Name</span></span>], [Extent2].[<span class="hljs-keyword"><span class="hljs-keyword">Id</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> [Id1], [Extent2].[<span class="hljs-keyword"><span class="hljs-keyword">Name</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> [Name1], [Extent2].[ParentId] <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> [ParentId], <span class="hljs-keyword"><span class="hljs-keyword">CAST</span></span>(<span class="hljs-literal"><span class="hljs-literal">NULL</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> uniqueidentifier) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> [C3], <span class="hljs-keyword"><span class="hljs-keyword">CAST</span></span>(<span class="hljs-literal"><span class="hljs-literal">NULL</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> <span class="hljs-built_in"><span class="hljs-built_in">varchar</span></span>(<span class="hljs-number"><span class="hljs-number">1</span></span>)) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> [C4], <span class="hljs-keyword"><span class="hljs-keyword">CAST</span></span>(<span class="hljs-literal"><span class="hljs-literal">NULL</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> uniqueidentifier) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> [C5] <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> [dbo].[GuidKeySequentialParentEntities] <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> [Extent1] <span class="hljs-keyword"><span class="hljs-keyword">LEFT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">OUTER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">JOIN</span></span> [dbo].[GuidKeySequentialChildEntity1] <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> [Extent2] <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> [Extent1].[<span class="hljs-keyword"><span class="hljs-keyword">Id</span></span>] = [Extent2].[ParentId] <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> [Extent1].[<span class="hljs-keyword"><span class="hljs-keyword">Id</span></span>] = @p__linq__0 <span class="hljs-keyword"><span class="hljs-keyword">UNION</span></span> ALL <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> <span class="hljs-number"><span class="hljs-number">2</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> [C1], <span class="hljs-number"><span class="hljs-number">2</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> [C2], [Extent3].[<span class="hljs-keyword"><span class="hljs-keyword">Id</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> [<span class="hljs-keyword"><span class="hljs-keyword">Id</span></span>], [Extent3].[<span class="hljs-keyword"><span class="hljs-keyword">Name</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> [<span class="hljs-keyword"><span class="hljs-keyword">Name</span></span>], <span class="hljs-keyword"><span class="hljs-keyword">CAST</span></span>(<span class="hljs-literal"><span class="hljs-literal">NULL</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> uniqueidentifier) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> [C3], <span class="hljs-keyword"><span class="hljs-keyword">CAST</span></span>(<span class="hljs-literal"><span class="hljs-literal">NULL</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> <span class="hljs-built_in"><span class="hljs-built_in">varchar</span></span>(<span class="hljs-number"><span class="hljs-number">1</span></span>)) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> [C4], <span class="hljs-keyword"><span class="hljs-keyword">CAST</span></span>(<span class="hljs-literal"><span class="hljs-literal">NULL</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> uniqueidentifier) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> [C5], [Extent4].[<span class="hljs-keyword"><span class="hljs-keyword">Id</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> [Id1], [Extent4].[<span class="hljs-keyword"><span class="hljs-keyword">Name</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> [Name1], [Extent4].[ParentId] <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> [ParentId] <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> [dbo].[GuidKeySequentialParentEntities] <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> [Extent3] <span class="hljs-keyword"><span class="hljs-keyword">INNER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">JOIN</span></span> [dbo].[GuidKeySequentialChildEntity2] <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> [Extent4] <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> [Extent3].[<span class="hljs-keyword"><span class="hljs-keyword">Id</span></span>] = [Extent4].[ParentId] <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> [Extent3].[<span class="hljs-keyword"><span class="hljs-keyword">Id</span></span>] = @p__linq__0) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> [UnionAll1] <span class="hljs-keyword"><span class="hljs-keyword">ORDER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BY</span></span> [UnionAll1].[<span class="hljs-keyword"><span class="hljs-keyword">Id</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">ASC</span></span>, [UnionAll1].[C1] <span class="hljs-keyword"><span class="hljs-keyword">ASC</span></span></code> </pre><br>  It would be logical to assume that Include () simply adds another JOIN to the query.  But the Entity Framework behaves harder.  If the included navigation property is a single object, not a collection, then there will simply be another JOIN.  If the collection is for each, a separate subquery will be formed, where the parent table is joined with the child, and all such subqueries will be merged into a common UNION ALL.  Obviously, if only one child collection is needed, then UNION ALL will not.  Schematically, this can be represented as: <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> <span class="hljs-comment"><span class="hljs-comment">/*   */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> <span class="hljs-comment"><span class="hljs-comment">/*   */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> <span class="hljs-comment"><span class="hljs-comment">/*   */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">LEFT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">OUTER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">JOIN</span></span> <span class="hljs-comment"><span class="hljs-comment">/*   1 */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> <span class="hljs-comment"><span class="hljs-comment">/*   */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">UNION</span></span> ALL <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> <span class="hljs-comment"><span class="hljs-comment">/*   */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> <span class="hljs-comment"><span class="hljs-comment">/*   */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INNER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">JOIN</span></span> <span class="hljs-comment"><span class="hljs-comment">/*   2 */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> <span class="hljs-comment"><span class="hljs-comment">/*   */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">UNION</span></span> ALL <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> <span class="hljs-comment"><span class="hljs-comment">/*   */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> <span class="hljs-comment"><span class="hljs-comment">/*   */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INNER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">JOIN</span></span> <span class="hljs-comment"><span class="hljs-comment">/*   3 */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> <span class="hljs-comment"><span class="hljs-comment">/*   */</span></span> <span class="hljs-comment"><span class="hljs-comment">/* ... */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ORDER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BY</span></span> <span class="hljs-comment"><span class="hljs-comment">/*   */</span></span></code> </pre><br>  This is done to combat the problem of multiplying the results.  Suppose an object has three child collections of 10 elements each.  If all three are added via OUTER JOIN directly to the ‚Äúmain‚Äù query, then the result will be 10 * 10 * 10 = 1000 records.  If we go through the Entity Framework, and collect these three collections in one request via UNION, we get 30 records.  The more collections and elements in them, the more obvious the benefit of the approach with UNION. <br><br>  But the problem is that, given the great complexity of the entities themselves and the selection criteria, the construction and optimization of such a query is very laborious for the Entity Framework, as is its implementation at the database server level.  Therefore, if the results of the profiling show unsatisfactory performance of queries containing Include, and with the indexes in the database everything is in order, it makes sense to think about alternative solutions. <br><br>  The main idea of ‚Äã‚Äãalternative solutions is the reading of each collection by a separate request.  The simplest option is possible if the objects are added to the context during selection, i.e.  without using AsNoTracking (): <br><br><pre> <code class="hljs javascript"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> children1 = c.ChildEntities1 .Where(<span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">e</span></span></span><span class="hljs-function"> =&gt;</span></span> e.Parent.CreatedAt &gt;= DbFunctions.AddDays(DateTime.UtcNow, <span class="hljs-number"><span class="hljs-number">-1</span></span>)) <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> children2 = c.ChildEntities2 .Where(<span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">e</span></span></span><span class="hljs-function"> =&gt;</span></span> e.Parent.CreatedAt &gt;= DbFunctions.AddDays(DateTime.UtcNow, <span class="hljs-number"><span class="hljs-number">-1</span></span>)) children1.Load(); children2.Load(); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> query = c.ParentEntities .Where(<span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">e</span></span></span><span class="hljs-function"> =&gt;</span></span> e.CreatedAt &gt;= DbFunctions.AddDays(DateTime.UtcNow, <span class="hljs-number"><span class="hljs-number">-1</span></span>)) .ToList();</code> </pre><br>  It turns out that for each child collection we read all the objects that are related to the parent entities that fall under the query criteria.  After calling Load () objects are added to the context.  During the proofreading of the parent entities, the Entity Framework will find all the children in the context and add references to them accordingly. <br><br>  The main disadvantage here is that each request is a separate appeal to the database server.  Fortunately, there is a way to solve this problem.  In the <a href="https://github.com/loresoft/EntityFramework.Extended">EntityFramework.Extended</a> library <a href="https://github.com/loresoft/EntityFramework.Extended">it</a> is possible to create ‚Äúfuture‚Äù requests.  The basic idea is that all requests for which the extension method Future () was called will be sent in one call to the server when one of them has a terminal method called: <br><br><pre> <code class="hljs javascript"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> children1 = c.ChildEntities1 .Where(<span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">e</span></span></span><span class="hljs-function"> =&gt;</span></span> e.Parent.CreatedAt &gt;= DbFunctions.AddDays(DateTime.UtcNow, <span class="hljs-number"><span class="hljs-number">-1</span></span>)) .Future(); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> children2 = c.ChildEntities2 .Where(<span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">e</span></span></span><span class="hljs-function"> =&gt;</span></span> e.Parent.CreatedAt &gt;= DbFunctions.AddDays(DateTime.UtcNow, <span class="hljs-number"><span class="hljs-number">-1</span></span>)) .Future(); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> results = c.ParentEntities .Where(<span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">e</span></span></span><span class="hljs-function"> =&gt;</span></span> e.CreatedAt &gt;= DbFunctions.AddDays(DateTime.UtcNow, <span class="hljs-number"><span class="hljs-number">-1</span></span>)) .Future() .ToList();</code> </pre><br>  As a result, as in the first example, objects from the results collection will contain correctly filled collections of Children1 and Children2, all the data will be received in one call to the server. <br><br>  Using ‚Äúfuture‚Äù queries will be useful in all situations where there is a need to perform several separate queries. <br><br><a name="4"></a><h2>  Subtracting fields from the base entity only when using the Table Per Type mapping </h2><br>  Imagine a system in which a number of entities have a base class that contains their common characteristics (name, creation date, owner, status, etc.).  There is also a requirement to implement a search for these characteristics and display a list of results.  Mapping implies, again, using only basic characteristics. <br><br>  From the point of view of model flexibility, the Table Per Type mapping is well suited for this task, where a separate table is created for each type.  For example, we have the base class Vehicle and the heirs - PassengerCar, Truck, Motorcycle.  In this case, four tables will be created in the database. <br><br>  We write a query that reads the search results for any criterion.  For example, the date of addition is not earlier than 10 days ago: <br><br><pre> <code class="hljs javascript"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> vehicles = context.Vehicles .AsNoTracking() .Where(<span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">v</span></span></span><span class="hljs-function"> =&gt;</span></span> v.CreatedAt &gt;= DbFunctions.AddDays(DateTime.UtcNow, <span class="hljs-number"><span class="hljs-number">-10</span></span>)) .ToList();</code> </pre><br>  And let's see what the Entity Framework transforms it to: <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">CASE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">WHEN</span></span> (( <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> (([Project1].[C1] = <span class="hljs-number"><span class="hljs-number">1</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> ([Project1].[C1] <span class="hljs-keyword"><span class="hljs-keyword">IS</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>))) <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> ( <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> (([Project3].[C1] = <span class="hljs-number"><span class="hljs-number">1</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> ([Project3].[C1] <span class="hljs-keyword"><span class="hljs-keyword">IS</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>))) <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> ( <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> (([Project2].[C1] = <span class="hljs-number"><span class="hljs-number">1</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> ([Project2].[C1] <span class="hljs-keyword"><span class="hljs-keyword">IS</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>)))) <span class="hljs-keyword"><span class="hljs-keyword">THEN</span></span> <span class="hljs-string"><span class="hljs-string">'0X'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">WHEN</span></span> (([Project1].[C1] = <span class="hljs-number"><span class="hljs-number">1</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> ([Project1].[C1] <span class="hljs-keyword"><span class="hljs-keyword">IS</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>)) <span class="hljs-keyword"><span class="hljs-keyword">THEN</span></span> <span class="hljs-string"><span class="hljs-string">'0X0X'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">WHEN</span></span> (([Project3].[C1] = <span class="hljs-number"><span class="hljs-number">1</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> ([Project3].[C1] <span class="hljs-keyword"><span class="hljs-keyword">IS</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>)) <span class="hljs-keyword"><span class="hljs-keyword">THEN</span></span> <span class="hljs-string"><span class="hljs-string">'0X1X'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ELSE</span></span> <span class="hljs-string"><span class="hljs-string">'0X2X'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">END</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> [C1], [Extent1].[<span class="hljs-keyword"><span class="hljs-keyword">Id</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> [<span class="hljs-keyword"><span class="hljs-keyword">Id</span></span>], [Extent1].[CreatedAt] <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> [CreatedAt], [Extent1].[<span class="hljs-keyword"><span class="hljs-keyword">Name</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> [<span class="hljs-keyword"><span class="hljs-keyword">Name</span></span>], <span class="hljs-keyword"><span class="hljs-keyword">CASE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">WHEN</span></span> (( <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> (([Project1].[C1] = <span class="hljs-number"><span class="hljs-number">1</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> ([Project1].[C1] <span class="hljs-keyword"><span class="hljs-keyword">IS</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>))) <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> ( <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> (([Project3].[C1] = <span class="hljs-number"><span class="hljs-number">1</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> ([Project3].[C1] <span class="hljs-keyword"><span class="hljs-keyword">IS</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>))) <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> ( <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> (([Project2].[C1] = <span class="hljs-number"><span class="hljs-number">1</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> ([Project2].[C1] <span class="hljs-keyword"><span class="hljs-keyword">IS</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>)))) <span class="hljs-keyword"><span class="hljs-keyword">THEN</span></span> <span class="hljs-keyword"><span class="hljs-keyword">CAST</span></span>(<span class="hljs-literal"><span class="hljs-literal">NULL</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> <span class="hljs-built_in"><span class="hljs-built_in">bit</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">WHEN</span></span> (([Project1].[C1] = <span class="hljs-number"><span class="hljs-number">1</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> ([Project1].[C1] <span class="hljs-keyword"><span class="hljs-keyword">IS</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>)) <span class="hljs-keyword"><span class="hljs-keyword">THEN</span></span> [Project1].[HasCycleCar] <span class="hljs-keyword"><span class="hljs-keyword">WHEN</span></span> (([Project3].[C1] = <span class="hljs-number"><span class="hljs-number">1</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> ([Project3].[C1] <span class="hljs-keyword"><span class="hljs-keyword">IS</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>)) <span class="hljs-keyword"><span class="hljs-keyword">THEN</span></span> <span class="hljs-keyword"><span class="hljs-keyword">CAST</span></span>(<span class="hljs-literal"><span class="hljs-literal">NULL</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> <span class="hljs-built_in"><span class="hljs-built_in">bit</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">END</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> [C2], <span class="hljs-keyword"><span class="hljs-keyword">CASE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">WHEN</span></span> (( <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> (([Project1].[C1] = <span class="hljs-number"><span class="hljs-number">1</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> ([Project1].[C1] <span class="hljs-keyword"><span class="hljs-keyword">IS</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>))) <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> ( <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> (([Project3].[C1] = <span class="hljs-number"><span class="hljs-number">1</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> ([Project3].[C1] <span class="hljs-keyword"><span class="hljs-keyword">IS</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>))) <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> ( <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> (([Project2].[C1] = <span class="hljs-number"><span class="hljs-number">1</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> ([Project2].[C1] <span class="hljs-keyword"><span class="hljs-keyword">IS</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>)))) <span class="hljs-keyword"><span class="hljs-keyword">THEN</span></span> <span class="hljs-keyword"><span class="hljs-keyword">CAST</span></span>(<span class="hljs-literal"><span class="hljs-literal">NULL</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> <span class="hljs-built_in"><span class="hljs-built_in">int</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">WHEN</span></span> (([Project1].[C1] = <span class="hljs-number"><span class="hljs-number">1</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> ([Project1].[C1] <span class="hljs-keyword"><span class="hljs-keyword">IS</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>)) <span class="hljs-keyword"><span class="hljs-keyword">THEN</span></span> <span class="hljs-keyword"><span class="hljs-keyword">CAST</span></span>(<span class="hljs-literal"><span class="hljs-literal">NULL</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> <span class="hljs-built_in"><span class="hljs-built_in">int</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">WHEN</span></span> (([Project3].[C1] = <span class="hljs-number"><span class="hljs-number">1</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> ([Project3].[C1] <span class="hljs-keyword"><span class="hljs-keyword">IS</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>)) <span class="hljs-keyword"><span class="hljs-keyword">THEN</span></span> [Project3].[Seats] <span class="hljs-keyword"><span class="hljs-keyword">END</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> [C3], <span class="hljs-keyword"><span class="hljs-keyword">CASE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">WHEN</span></span> (( <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> (([Project1].[C1] = <span class="hljs-number"><span class="hljs-number">1</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> ([Project1].[C1] <span class="hljs-keyword"><span class="hljs-keyword">IS</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>))) <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> ( <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> (([Project3].[C1] = <span class="hljs-number"><span class="hljs-number">1</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> ([Project3].[C1] <span class="hljs-keyword"><span class="hljs-keyword">IS</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>))) <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> ( <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> (([Project2].[C1] = <span class="hljs-number"><span class="hljs-number">1</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> ([Project2].[C1] <span class="hljs-keyword"><span class="hljs-keyword">IS</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>)))) <span class="hljs-keyword"><span class="hljs-keyword">THEN</span></span> <span class="hljs-keyword"><span class="hljs-keyword">CAST</span></span>(<span class="hljs-literal"><span class="hljs-literal">NULL</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> <span class="hljs-built_in"><span class="hljs-built_in">int</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">WHEN</span></span> (([Project1].[C1] = <span class="hljs-number"><span class="hljs-number">1</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> ([Project1].[C1] <span class="hljs-keyword"><span class="hljs-keyword">IS</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>)) <span class="hljs-keyword"><span class="hljs-keyword">THEN</span></span> <span class="hljs-keyword"><span class="hljs-keyword">CAST</span></span>(<span class="hljs-literal"><span class="hljs-literal">NULL</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> <span class="hljs-built_in"><span class="hljs-built_in">int</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">WHEN</span></span> (([Project3].[C1] = <span class="hljs-number"><span class="hljs-number">1</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> ([Project3].[C1] <span class="hljs-keyword"><span class="hljs-keyword">IS</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>)) <span class="hljs-keyword"><span class="hljs-keyword">THEN</span></span> <span class="hljs-keyword"><span class="hljs-keyword">CAST</span></span>(<span class="hljs-literal"><span class="hljs-literal">NULL</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> <span class="hljs-built_in"><span class="hljs-built_in">int</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">ELSE</span></span> [Project2].[<span class="hljs-keyword"><span class="hljs-keyword">Capacity</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">END</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> [C4] <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> [dbo].[Vehicles] <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> [Extent1] <span class="hljs-keyword"><span class="hljs-keyword">LEFT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">OUTER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">JOIN</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> [Extent2].[<span class="hljs-keyword"><span class="hljs-keyword">Id</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> [<span class="hljs-keyword"><span class="hljs-keyword">Id</span></span>], [Extent2].[HasCycleCar] <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> [HasCycleCar], <span class="hljs-keyword"><span class="hljs-keyword">cast</span></span>(<span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> <span class="hljs-built_in"><span class="hljs-built_in">bit</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> [C1] <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> [dbo].[Motorcycles] <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> [Extent2] ) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> [Project1] <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> [Extent1].[<span class="hljs-keyword"><span class="hljs-keyword">Id</span></span>] = [Project1].[<span class="hljs-keyword"><span class="hljs-keyword">Id</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">LEFT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">OUTER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">JOIN</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> [Extent3].[<span class="hljs-keyword"><span class="hljs-keyword">Id</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> [<span class="hljs-keyword"><span class="hljs-keyword">Id</span></span>], [Extent3].[<span class="hljs-keyword"><span class="hljs-keyword">Capacity</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> [<span class="hljs-keyword"><span class="hljs-keyword">Capacity</span></span>], <span class="hljs-keyword"><span class="hljs-keyword">cast</span></span>(<span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> <span class="hljs-built_in"><span class="hljs-built_in">bit</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> [C1] <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> [dbo].[Trucks] <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> [Extent3] ) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> [Project2] <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> [Extent1].[<span class="hljs-keyword"><span class="hljs-keyword">Id</span></span>] = [Project2].[<span class="hljs-keyword"><span class="hljs-keyword">Id</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">LEFT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">OUTER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">JOIN</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> [Extent4].[<span class="hljs-keyword"><span class="hljs-keyword">Id</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> [<span class="hljs-keyword"><span class="hljs-keyword">Id</span></span>], [Extent4].[Seats] <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> [Seats], <span class="hljs-keyword"><span class="hljs-keyword">cast</span></span>(<span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> <span class="hljs-built_in"><span class="hljs-built_in">bit</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> [C1] <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> [dbo].[PassengerCars] <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> [Extent4] ) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> [Project3] <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> [Extent1].[<span class="hljs-keyword"><span class="hljs-keyword">Id</span></span>] = [Project3].[<span class="hljs-keyword"><span class="hljs-keyword">Id</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> [Extent1].[CreatedAt] &gt;= (<span class="hljs-keyword"><span class="hljs-keyword">DATEADD</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">day</span></span>, <span class="hljs-number"><span class="hljs-number">-10</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">SysUtcDateTime</span></span>()))</code> </pre><br>  It turns out that we need only basic information, and the Entity Framework reads all, and with a rather cumbersome request.  In fact, in this particular situation there is nothing bad - despite the fact that we select objects from the collection of base classes, the framework must comply with polymorphic behavior and return an object of the type it was created. <br><br>  The main question here is how to simplify the request so that it does not read too much?  Fortunately, starting with the Entity Framework 5, there is such a possibility - this is the use of projection.  Simply create an object of another type or anonymous, using to fill it only with the properties of the base entity: <br><br><pre> <code class="hljs javascript"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> vehicles = context.Vehicles .AsNoTracking() .Where(<span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">v</span></span></span><span class="hljs-function"> =&gt;</span></span> v.CreatedAt &gt;= DbFunctions.AddDays(DateTime.UtcNow, <span class="hljs-number"><span class="hljs-number">-10</span></span>)) .Select(<span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">v</span></span></span><span class="hljs-function"> =&gt;</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> { Id = v.Id, CreatedAt = v.CreatedAt, Name = v.Name }) .ToList();</code> </pre><br>  And everything becomes much easier: <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> [C1], [Extent1].[<span class="hljs-keyword"><span class="hljs-keyword">Id</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> [<span class="hljs-keyword"><span class="hljs-keyword">Id</span></span>], [Extent1].[CreatedAt] <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> [CreatedAt], [Extent1].[<span class="hljs-keyword"><span class="hljs-keyword">Name</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> [<span class="hljs-keyword"><span class="hljs-keyword">Name</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> [dbo].[Vehicles] <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> [Extent1] <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> [Extent1].[CreatedAt] &gt;= (<span class="hljs-keyword"><span class="hljs-keyword">DATEADD</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">day</span></span>, <span class="hljs-number"><span class="hljs-number">-10</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">SysUtcDateTime</span></span>()))</code> </pre><br>  But there is some unpleasant news - if there is a collection in the base class and it needs to be read, the problem remains.  Here is an example: <br><br><pre> <code class="hljs javascript"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> vehicles = context.Vehicles .AsNoTracking() .Where(<span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">v</span></span></span><span class="hljs-function"> =&gt;</span></span> v.CreatedAt &gt;= DbFunctions.AddDays(DateTime.UtcNow, <span class="hljs-number"><span class="hljs-number">-10</span></span>)) .Select(<span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">v</span></span></span><span class="hljs-function"> =&gt;</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> { Id = v.Id, CreatedAt = v.CreatedAt, Name = v.Name, ServiceTickets = v.ServiceTickets }) .ToList();</code> </pre><br>  And the SQL generated for it: <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> [Project1].[Id1] <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> [<span class="hljs-keyword"><span class="hljs-keyword">Id</span></span>], [Project1].[Id2] <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> [Id1], [Project1].[Id3] <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> [Id2], [Project1].[<span class="hljs-keyword"><span class="hljs-keyword">Id</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> [Id3], [Project1].[C1] <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> [C1], [Project1].[CreatedAt] <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> [CreatedAt], [Project1].[<span class="hljs-keyword"><span class="hljs-keyword">Name</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> [<span class="hljs-keyword"><span class="hljs-keyword">Name</span></span>], [Project1].[C2] <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> [C2], [Project1].[Id4] <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> [Id4], [Project1].[Comments] <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> [Comments], [Project1].[Vehicle_Id] <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> [Vehicle_Id] <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> ( <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> [Extent1].[<span class="hljs-keyword"><span class="hljs-keyword">Id</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> [<span class="hljs-keyword"><span class="hljs-keyword">Id</span></span>], [Extent1].[CreatedAt] <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> [CreatedAt], [Extent1].[<span class="hljs-keyword"><span class="hljs-keyword">Name</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> [<span class="hljs-keyword"><span class="hljs-keyword">Name</span></span>], [Extent2].[<span class="hljs-keyword"><span class="hljs-keyword">Id</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> [Id1], [Extent3].[<span class="hljs-keyword"><span class="hljs-keyword">Id</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> [Id2], [Extent4].[<span class="hljs-keyword"><span class="hljs-keyword">Id</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> [Id3], <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> [C1], [Extent5].[<span class="hljs-keyword"><span class="hljs-keyword">Id</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> [Id4], [Extent5].[Comments] <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> [Comments], [Extent5].[Vehicle_Id] <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> [Vehicle_Id], <span class="hljs-keyword"><span class="hljs-keyword">CASE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">WHEN</span></span> ([Extent5].[<span class="hljs-keyword"><span class="hljs-keyword">Id</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">IS</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">THEN</span></span> <span class="hljs-keyword"><span class="hljs-keyword">CAST</span></span>(<span class="hljs-literal"><span class="hljs-literal">NULL</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> <span class="hljs-built_in"><span class="hljs-built_in">int</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">ELSE</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">END</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> [C2] <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> [dbo].[Vehicles] <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> [Extent1] <span class="hljs-keyword"><span class="hljs-keyword">LEFT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">OUTER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">JOIN</span></span> [dbo].[Motorcycles] <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> [Extent2] <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> [Extent1].[<span class="hljs-keyword"><span class="hljs-keyword">Id</span></span>] = [Extent2].[<span class="hljs-keyword"><span class="hljs-keyword">Id</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">LEFT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">OUTER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">JOIN</span></span> [dbo].[Trucks] <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> [Extent3] <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> [Extent1].[<span class="hljs-keyword"><span class="hljs-keyword">Id</span></span>] = [Extent3].[<span class="hljs-keyword"><span class="hljs-keyword">Id</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">LEFT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">OUTER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">JOIN</span></span> [dbo].[PassengerCars] <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> [Extent4] <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> [Extent1].[<span class="hljs-keyword"><span class="hljs-keyword">Id</span></span>] = [Extent4].[<span class="hljs-keyword"><span class="hljs-keyword">Id</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">LEFT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">OUTER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">JOIN</span></span> [dbo].[ServiceTickets] <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> [Extent5] <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> [Extent1].[<span class="hljs-keyword"><span class="hljs-keyword">Id</span></span>] = [Extent5].[Vehicle_Id] <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> [Extent1].[CreatedAt] &gt;= (<span class="hljs-keyword"><span class="hljs-keyword">DATEADD</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">day</span></span>, <span class="hljs-number"><span class="hljs-number">-10</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">SysUtcDateTime</span></span>())) ) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> [Project1] <span class="hljs-keyword"><span class="hljs-keyword">ORDER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BY</span></span> [Project1].[Id1] <span class="hljs-keyword"><span class="hljs-keyword">ASC</span></span>, [Project1].[Id2] <span class="hljs-keyword"><span class="hljs-keyword">ASC</span></span>, [Project1].[Id3] <span class="hljs-keyword"><span class="hljs-keyword">ASC</span></span>, [Project1].[<span class="hljs-keyword"><span class="hljs-keyword">Id</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">ASC</span></span>, [Project1].[C2] <span class="hljs-keyword"><span class="hljs-keyword">ASC</span></span></code> </pre><br>  I created a ticket for the Entity Framework on this topic: <a href="https://entityframework.codeplex.com/workitem/2814">https://entityframework.codeplex.com/workitem/2814</a> , but they politely told me that because of the great complexity and danger of breaking everything, they would not fix it. <br><br>  In some cases, when the size of the base and / or the number of heir objects is small, you can live with it.  If such requests begin to significantly degrade performance, you need to look for solutions.  Once at the level of the framework itself, the problem cannot be prevented, a workaround is needed.  The easiest option here is to read the collections in separate requests, for example: <br><br><pre> <code class="hljs pgsql">//   var vehiclesQuery = context.Vehicles .AsNoTracking() .<span class="hljs-keyword"><span class="hljs-keyword">Where</span></span>(v =&gt; v.CreatedAt &gt;= DbFunctions.AddDays(DateTime.UtcNow, <span class="hljs-number"><span class="hljs-number">-10</span></span>)); //       ,   var vehicles = vehiclesQuery .<span class="hljs-keyword"><span class="hljs-keyword">Select</span></span>(v =&gt; <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> VehicleDto { Id = v.Id, CreatedAt = v.CreatedAt, <span class="hljs-type"><span class="hljs-type">Name</span></span> = v.Name }) .ToList(); //  ,     ,    var serviceTickets = context.ServiceTickets .AsNoTracking() .<span class="hljs-keyword"><span class="hljs-keyword">Where</span></span>(s =&gt; vehiclesQuery.<span class="hljs-keyword"><span class="hljs-keyword">Any</span></span>(v =&gt; v.Id == s.VehicleId)) .ToList(); //     vehicles.<span class="hljs-keyword"><span class="hljs-keyword">ForEach</span></span>(v =&gt; v.ServiceTickets .AddRange(serviceTickets.<span class="hljs-keyword"><span class="hljs-keyword">Where</span></span>(s =&gt; s.VehicleId == v.Id)));</code> </pre><br>  There is no universal recipe, and the above solution may not give a win in all cases.  For example, a basic query can be quite complicated, and it will be unprofitable to execute it in a new way for each collection.  You can try to get around this problem by obtaining a list of identifiers from the results of the basic query, and then using it in all further subqueries.  But if there are many results, there may not be a win.  In addition, in this case, one should remember what was said earlier about the Contains method, which is obviously being asked for by identifiers. <br><br>  I would formulate a general approach to solving a problem like this - if there is an opportunity not to use Table Per Type mapping, it is better not to use it.  In cases where it is difficult to manage without it, you need to try the options described above and see if they give a win. <br><br><a name="5"></a><h2>  Additional Information </h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Performance related nuances that should be considered when working with the Entity Framework (including those described in the article) are briefly described at this link: </font></font><a href="https://msdn.microsoft.com/en-us/data/hh949853.aspx"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">https://msdn.microsoft.com/en-us/data/hh949853.aspx</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Unfortunately, alternative solutions are not indicated for all problems, but the information is still very useful. </font><font style="vertical-align: inherit;">It should also be noted that at least clause 4.3 is not confirmed in practice for the Entity Framework 6.1.3.</font></font></div><p>Source: <a href="https://habr.com/ru/post/269901/">https://habr.com/ru/post/269901/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../269889/index.html">PostgreSQL Evangelist Memo: Replicants vs. Replication</a></li>
<li><a href="../269893/index.html">Pure architecture in a go app. Part 1</a></li>
<li><a href="../269895/index.html">How I did the web version of KeePass</a></li>
<li><a href="../269897/index.html">Automatic generation of microcontroller software code based on event-oriented model</a></li>
<li><a href="../269899/index.html">Lua 5.3 Reference Guide</a></li>
<li><a href="../269903/index.html">Create a REST service on Rust. Part 5: Handlers, Refactoring, and Macros</a></li>
<li><a href="../269905/index.html">How we lost and again found millions without testing A / B</a></li>
<li><a href="../269907/index.html">Unpacked types of unions in Scala based on the Curry-Howard isomorphism</a></li>
<li><a href="../269909/index.html">Errors are values</a></li>
<li><a href="../269915/index.html">Divide means multiply</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>