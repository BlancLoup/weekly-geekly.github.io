<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>How to replace old indexes and not to break the system?</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="It is possible that many people came across a situation that historically developed over the years, before appearing on a project, when all possible i...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>How to replace old indexes and not to break the system?</h1><div class="post__text post__text-html js-mediator-article">  It is possible that many people came across a situation that historically developed over the years, before appearing on a project, when all possible indexes with all include'ami were created on the table.  I saw the index on the inherited database, which contained all the fields in the table.  At the same time, it is not always possible to quickly change the indices, as often we need a guarantee that the changes will not affect the performance of the system. <br><br>  With the growth of the volume of the table, it becomes painfully painful for the aimlessly occupied place, but just because the index can not be killed, and usage statistics show that the index is used. <br>  The described example of consolidation of indices on a high-load database operating 24/7.  The application uses only stored procedures.  Version of MS SQL Server 2012 SP3. <br><br><img src="https://habrastorage.org/webt/dt/zb/mz/dtzbmzh_tizhgzxpmbztvcyvpjs.png"><br><a name="habracut"></a><br>  Source table with clustered index: 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <pre><code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> [dbo].[ClientFile]( [StorageId] [<span class="hljs-built_in"><span class="hljs-built_in">int</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, [FolderId] [<span class="hljs-built_in"><span class="hljs-built_in">int</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, [ClientFileInternalId] [<span class="hljs-built_in"><span class="hljs-built_in">int</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">IDENTITY</span></span>(<span class="hljs-number"><span class="hljs-number">1</span></span>,<span class="hljs-number"><span class="hljs-number">1</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, [FileName] [<span class="hljs-keyword"><span class="hljs-keyword">nvarchar</span></span>](<span class="hljs-number"><span class="hljs-number">900</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, [FileExtension] [<span class="hljs-keyword"><span class="hljs-keyword">nvarchar</span></span>](<span class="hljs-number"><span class="hljs-number">10</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, [FileClientVersionId] [<span class="hljs-built_in"><span class="hljs-built_in">smallint</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, [ClientFileVersionId] [<span class="hljs-built_in"><span class="hljs-built_in">int</span></span>] <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, [FileInternalId] [<span class="hljs-built_in"><span class="hljs-built_in">bigint</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, [FileLength] [<span class="hljs-built_in"><span class="hljs-built_in">bigint</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, [OrderId] [tinyint] <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, [FileFileExtensionId] [<span class="hljs-built_in"><span class="hljs-built_in">int</span></span>] <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, [FileStatus] [tinyint] <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, [DirectoryVersionId] [<span class="hljs-built_in"><span class="hljs-built_in">int</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, [DateDeleted] [datetime] <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">CONSTRAINT</span></span> [PK_ClientFile] PRIMARY <span class="hljs-keyword"><span class="hljs-keyword">KEY</span></span> CLUSTERED ( [StorageId] <span class="hljs-keyword"><span class="hljs-keyword">ASC</span></span>, [ClientFileInternalId] <span class="hljs-keyword"><span class="hljs-keyword">ASC</span></span> ) )</code> </pre> <br>  Noncluster indices: <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> NONCLUSTERED <span class="hljs-keyword"><span class="hljs-keyword">INDEX</span></span> [IX_ClientFile_StorageId_FileStatus] <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> [dbo].[ClientFile] ( [StorageId] <span class="hljs-keyword"><span class="hljs-keyword">ASC</span></span>, [FileStatus] <span class="hljs-keyword"><span class="hljs-keyword">ASC</span></span>, [OrderId] <span class="hljs-keyword"><span class="hljs-keyword">DESC</span></span> ) <span class="hljs-keyword"><span class="hljs-keyword">INCLUDE</span></span> ( [ClientFileInternalId], [FolderId], [DirectoryVersionId], [FileInternalId], [FileClientVersionId], [FileLength]); <span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> NONCLUSTERED <span class="hljs-keyword"><span class="hljs-keyword">INDEX</span></span> [IX_ClientFile_StorageId_FolderId_FileStatus_FileName] <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> [dbo].[ClientFile] ( [StorageId] <span class="hljs-keyword"><span class="hljs-keyword">ASC</span></span>, [FolderId] <span class="hljs-keyword"><span class="hljs-keyword">ASC</span></span>, [FileStatus] <span class="hljs-keyword"><span class="hljs-keyword">ASC</span></span>, [FileName] <span class="hljs-keyword"><span class="hljs-keyword">ASC</span></span> ) <span class="hljs-keyword"><span class="hljs-keyword">INCLUDE</span></span> ( [DateDeleted], [DirectoryVersionId], [FileExtension], [FileInternalId], [FileClientVersionId], [FileLength]);</code> </pre><br>  The 1m index of 14 fields in the table contains 9, and in the second - 10. <br><br>  These 2 indexes in total occupy up to 180 GB on each server, servers 12. This is frustrating and troubling, since indexes with matching fields, as well as 6 included fields in each.  In addition, sometimes the server selects these indexes in cases where it would be more efficient to use a clustered index, which required recompilation of the procedure.  After recompilation, the cluster index was already used and the load on the CPU decreased. <br><br><h3>  Step 1. Analysis of statistics on the use of indices </h3><br>  Servers collect information about the use of indexes on the ClientFile table. <br><br><div class="spoiler">  <b class="spoiler_title">Statistics use indexes on the table</b> <div class="spoiler_text"><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">declare</span></span> @dbid <span class="hljs-built_in"><span class="hljs-built_in">int</span></span> <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> @dbid = db_id() <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">cast</span></span>((user_seeks + user_scans + user_lookups) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> <span class="hljs-built_in"><span class="hljs-built_in">float</span></span>) / <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> user_updates <span class="hljs-keyword"><span class="hljs-keyword">when</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> <span class="hljs-number"><span class="hljs-number">1.0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">cast</span></span>(user_updates <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> <span class="hljs-built_in"><span class="hljs-built_in">float</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">end</span></span>) * <span class="hljs-number"><span class="hljs-number">100</span></span> <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> [%] , (user_seeks + user_scans + user_lookups) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> total_usage , objectname=object_name(s.object_id), s.object_id , indexname=i.name, i.index_id , user_seeks, user_scans, user_lookups, user_updates , last_user_seek, last_user_scan, last_user_update , last_system_seek, last_system_scan, last_system_update , <span class="hljs-string"><span class="hljs-string">'DROP INDEX '</span></span> + i.name + <span class="hljs-string"><span class="hljs-string">' ON '</span></span> + object_name(s.object_id) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> [Command] <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> sys.dm_db_index_usage_stats s, sys.indexes i <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> database_id = @dbid <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> objectproperty(s.object_id,<span class="hljs-string"><span class="hljs-string">'IsUserTable'</span></span>) = <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> i.object_id = s.object_id <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> i.index_id = s.index_id <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> i.name <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> <span class="hljs-keyword"><span class="hljs-keyword">like</span></span> <span class="hljs-string"><span class="hljs-string">'PK_%'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> object_name(s.object_id) = <span class="hljs-string"><span class="hljs-string">'ClientFile'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">order</span></span> <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> [%] <span class="hljs-keyword"><span class="hljs-keyword">asc</span></span></code> </pre><br></div></div><br>  In the described case, both indexes are used.  If an index is not used, it makes the task easier and often it can be simply deleted.  These statistics are cleared when restarting MS SQL Server, when deciding whether to remove an index based on it, you need to make sure that the database does not have any very important report that is counted once a month and uses this index. <br><br><h3>  Step 2. Select all the plans from the cache, which have the use of the described 2 indices. </h3><br>  To do this, use the spGetPlanUsingIndex procedure (the main query is taken from the Jonathan Kehayias articles <a href="https://www.sqlskills.com/blogs/jonathan">www.sqlskills.com/blogs/jonathan</a> ), which adds usage statistics to a table.  Jobe is set up with the launch of the procedure for collecting statistics every 1 hour. <br><br>  The important point is that not all plans will be cached, for example, procedures with the RECOMPILE hint.  If such a hint is used, the procedures should be checked and formulated for them and included in the analysis. <br><br><div class="spoiler">  <b class="spoiler_title">Fetch plans from cache with specified index</b> <div class="spoiler_text"><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> [dbo].[LogDataFileIndexUsage]( [PlanId] [<span class="hljs-built_in"><span class="hljs-built_in">int</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">IDENTITY</span></span>(<span class="hljs-number"><span class="hljs-number">1</span></span>,<span class="hljs-number"><span class="hljs-number">1</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, [PlanDate] [datetime] <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> <span class="hljs-keyword"><span class="hljs-keyword">CONSTRAINT</span></span> [DF_LogDataFileIndexUsage_PlanDate] <span class="hljs-keyword"><span class="hljs-keyword">DEFAULT</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">getutcdate</span></span>()), [DBname] [<span class="hljs-built_in"><span class="hljs-built_in">varchar</span></span>](<span class="hljs-number"><span class="hljs-number">50</span></span>) <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, [SPname] [<span class="hljs-built_in"><span class="hljs-built_in">varchar</span></span>](<span class="hljs-number"><span class="hljs-number">256</span></span>) <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, [ScanCount] [<span class="hljs-built_in"><span class="hljs-built_in">int</span></span>] <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, [SeekCount] [<span class="hljs-built_in"><span class="hljs-built_in">int</span></span>] <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, [UpdateCount] [<span class="hljs-built_in"><span class="hljs-built_in">int</span></span>] <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, [RefCount] [<span class="hljs-built_in"><span class="hljs-built_in">int</span></span>] <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, [UseCount] [<span class="hljs-built_in"><span class="hljs-built_in">int</span></span>] <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, [QueryPlan] [<span class="hljs-keyword"><span class="hljs-keyword">xml</span></span>] <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> ) <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> [PRIMARY] TEXTIMAGE_ON [PRIMARY] <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> ANSI_PADDING <span class="hljs-keyword"><span class="hljs-keyword">OFF</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ALTER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> [dbo].[LogDataFileIndexUsage] <span class="hljs-keyword"><span class="hljs-keyword">ADD</span></span> [IndexName] [<span class="hljs-built_in"><span class="hljs-built_in">varchar</span></span>](<span class="hljs-number"><span class="hljs-number">256</span></span>) <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> PRIMARY <span class="hljs-keyword"><span class="hljs-keyword">KEY</span></span> CLUSTERED ( [PlanId] <span class="hljs-keyword"><span class="hljs-keyword">ASC</span></span> )<span class="hljs-keyword"><span class="hljs-keyword">WITH</span></span> (PAD_INDEX = <span class="hljs-keyword"><span class="hljs-keyword">OFF</span></span>, STATISTICS_NORECOMPUTE = <span class="hljs-keyword"><span class="hljs-keyword">OFF</span></span>, IGNORE_DUP_KEY = <span class="hljs-keyword"><span class="hljs-keyword">OFF</span></span>, ALLOW_ROW_LOCKS = <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span>, ALLOW_PAGE_LOCKS = <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> [PRIMARY] <span class="hljs-keyword"><span class="hljs-keyword">GO</span></span> <span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">PROCEDURE</span></span> [dbo].[spGetPlanUsingIndex] @indexName <span class="hljs-keyword"><span class="hljs-keyword">NVARCHAR</span></span>(<span class="hljs-number"><span class="hljs-number">128</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BEGIN</span></span> <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> NOCOUNT <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TRANSACTION</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ISOLATION</span></span> <span class="hljs-keyword"><span class="hljs-keyword">LEVEL</span></span> <span class="hljs-keyword"><span class="hljs-keyword">READ</span></span> UNCOMMITTED <span class="hljs-comment"><span class="hljs-comment">-- Make sure the name passed is appropriately quoted IF (LEFT(@IndexName, 1) &lt;&gt; '[' AND RIGHT(@IndexName, 1) &lt;&gt; ']') SET @IndexName = QUOTENAME(@IndexName); WITH XMLNAMESPACES (DEFAULT 'http://schemas.microsoft.com/sqlserver/2004/07/showplan') INSERT INTO [dbo].[LogDataFileIndexUsage] ( DBName, SPname, ScanCount, SeekCount, UpdateCount, RefCount, UseCount, QueryPlan, IndexName ) SELECT DB_NAME(E.dbid) AS [DBName], object_name(E.objectid, dbid) AS [ObjectName], E.query_plan.value('count(//RelOp[@LogicalOp = ''Index Scan'' or @LogicalOp = ''Clustered Index Scan'']/*/Object[@Index=sql:variable("@IndexName")])','int') AS [ScanCount], E.query_plan.value('count(//RelOp[@LogicalOp = ''Index Seek'' or @LogicalOp = ''Clustered Index Seek'']/*/Object[@Index=sql:variable("@IndexName")])','int') AS [SeekCount], E.query_plan.value('count(//Update/Object[@Index=sql:variable("@IndexName")])','int') AS [UpdateCount], P.refcounts AS [RefCounts], P.usecounts AS [UseCounts], E.query_plan AS [QueryPlan], @IndexName FROM sys.dm_exec_cached_plans P CROSS APPLY sys.dm_exec_query_plan(P.plan_handle) E WHERE E.query_plan.exist('//*[@Index=sql:variable("@IndexName")]') = 1 OPTION(MAXDOP 1, RECOMPILE); END GO</span></span></code> </pre><br></div></div><br><h3>  Step 3. Analysis of the collected data </h3><br>  In this case, the analysis showed that both indexes are used by the same procedures, that is, the procedure uses, then one index then the other, for the same query. <br>  There are a total of 24 procedures that use these indexes.  For each procedure, it is analyzed by what fields the data is filtered, the JOIN is made, and which fields are specified in the SELECT. <br><br>  This was all done manually in the excel spreadsheet.  Now I understand that it was possible to avoid such amount of manual labor by writing a request with a sample of this from the xml plan.  Fields to select: seek predicate, predicate and which fields are selected from the table. <br><br><h3>  Step 4. Formation of a new index </h3><br>  Based on the data obtained in the analysis of the use of indices in the plans, a new index was formed. <br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> NONCLUSTERED <span class="hljs-keyword"><span class="hljs-keyword">INDEX</span></span> [IX_ClientFile_StorageId_FolderId_FileStatus] <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> [dbo].[ClientFile] ([StorageId], [FolderId], [FileStatus]);</code> </pre><br><h3>  Step 5. Testing </h3><br>  On the project, when making changes, load testing is necessarily done.  The load test with the new index showed that it is necessary to add the Name field to the index in order to remove the Key lookup.  The field is added because it is used in the WHERE clause. <br>  Also after the test, the information in the missing index is checked. <br><br><div class="spoiler">  <b class="spoiler_title">Missing index</b> <div class="spoiler_text"><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> mig.index_group_handle, mid.index_handle, <span class="hljs-keyword"><span class="hljs-keyword">CONVERT</span></span> (<span class="hljs-built_in"><span class="hljs-built_in">decimal</span></span> (<span class="hljs-number"><span class="hljs-number">28</span></span>,<span class="hljs-number"><span class="hljs-number">1</span></span>), migs.avg_total_user_cost * migs.avg_user_impact * (migs.user_seeks + migs.user_scans) ) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> improvement_measure, <span class="hljs-string"><span class="hljs-string">'CREATE INDEX missing_index_'</span></span> + <span class="hljs-keyword"><span class="hljs-keyword">CONVERT</span></span> (<span class="hljs-built_in"><span class="hljs-built_in">varchar</span></span>, mig.index_group_handle) + <span class="hljs-string"><span class="hljs-string">'_'</span></span> + <span class="hljs-keyword"><span class="hljs-keyword">CONVERT</span></span> (<span class="hljs-built_in"><span class="hljs-built_in">varchar</span></span>, mid.index_handle) + <span class="hljs-string"><span class="hljs-string">' ON '</span></span> + mid.statement + <span class="hljs-string"><span class="hljs-string">' ('</span></span> + <span class="hljs-keyword"><span class="hljs-keyword">ISNULL</span></span> (mid.equality_columns,<span class="hljs-string"><span class="hljs-string">''</span></span>) + <span class="hljs-keyword"><span class="hljs-keyword">CASE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">WHEN</span></span> mid.equality_columns <span class="hljs-keyword"><span class="hljs-keyword">IS</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> mid.inequality_columns <span class="hljs-keyword"><span class="hljs-keyword">IS</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> <span class="hljs-keyword"><span class="hljs-keyword">THEN</span></span> <span class="hljs-string"><span class="hljs-string">','</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ELSE</span></span> <span class="hljs-string"><span class="hljs-string">''</span></span> <span class="hljs-keyword"><span class="hljs-keyword">END</span></span> + <span class="hljs-keyword"><span class="hljs-keyword">ISNULL</span></span> (mid.inequality_columns, <span class="hljs-string"><span class="hljs-string">''</span></span>) + <span class="hljs-string"><span class="hljs-string">')'</span></span> + <span class="hljs-keyword"><span class="hljs-keyword">ISNULL</span></span> (<span class="hljs-string"><span class="hljs-string">' INCLUDE ('</span></span> + mid.included_columns + <span class="hljs-string"><span class="hljs-string">')'</span></span>, <span class="hljs-string"><span class="hljs-string">''</span></span>) + <span class="hljs-string"><span class="hljs-string">' with (online=on)'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> create_index_statement, migs.*, mid.*, mid.database_id, mid.[object_id] <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> sys.dm_db_missing_index_groups mig <span class="hljs-keyword"><span class="hljs-keyword">INNER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">JOIN</span></span> sys.dm_db_missing_index_group_stats migs <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> migs.group_handle = mig.index_group_handle <span class="hljs-keyword"><span class="hljs-keyword">INNER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">JOIN</span></span> sys.dm_db_missing_index_details <span class="hljs-keyword"><span class="hljs-keyword">mid</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> mig.index_handle = mid.index_handle <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">CONVERT</span></span> (<span class="hljs-built_in"><span class="hljs-built_in">decimal</span></span> (<span class="hljs-number"><span class="hljs-number">28</span></span>,<span class="hljs-number"><span class="hljs-number">1</span></span>), migs.avg_total_user_cost * migs.avg_user_impact * (migs.user_seeks + migs.user_scans)) &gt; <span class="hljs-number"><span class="hljs-number">10</span></span> <span class="hljs-comment"><span class="hljs-comment">--AND database_id = 12 AND mid.statement like ('%[ClientFile]') ORDER BY convert(varchar(10), last_user_seek, 120) desc, migs.avg_total_user_cost * migs.avg_user_impact * (migs.user_seeks + migs.user_scans) /*last_user_seek*/ DESC</span></span></code> </pre><br></div></div><br>  Total index <br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> NONCLUSTERED <span class="hljs-keyword"><span class="hljs-keyword">INDEX</span></span> [IX_ClientFile_StorageId_FolderId_FileStatus_FileName] <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> [dbo].[ClientFile] ([StorageId], [FolderId], [FileStatus], [FileName]);</code> </pre><br><h3>  Step 6. Apply the changes </h3><br>  The table has 700 million rows, so the new index was applied by creating a new table and migrating data to it. <br><br>  Saving disk space 45% on each server.  The server often uses a clustered index, which reduces the number of key lookup in the plans. </div><p>Source: <a href="https://habr.com/ru/post/344284/">https://habr.com/ru/post/344284/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../344270/index.html">Webpage interaction with Ethereum</a></li>
<li><a href="../344272/index.html">Angular 5 (or 4): downgrade component for use in AngularJS</a></li>
<li><a href="../344278/index.html">Location of Wi-FI sources in AR and bowler</a></li>
<li><a href="../344280/index.html">Solution of the optimization problem of multistage rockets</a></li>
<li><a href="../344282/index.html">Rust vs. C ++ on algorithmic tasks</a></li>
<li><a href="../344288/index.html">Arrays, Collections: Algorithmic minimum</a></li>
<li><a href="../344290/index.html">Blockchain's guide for the marketer</a></li>
<li><a href="../344292/index.html">Websockets. Possible approach to use</a></li>
<li><a href="../344294/index.html">Basics and methods of information security in 2017</a></li>
<li><a href="../344296/index.html">Yandex Lecture: Advanced UI, Part Two</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>