<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Cross-platform use of .Net classes from unmanaged code. Or analogue IDispatch on Linux</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Being a 1C programmer, I often have to use .Net classes through different layers. 

 Using .Net assemblies through a wrapper that implements IReflect ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Cross-platform use of .Net classes from unmanaged code. Or analogue IDispatch on Linux</h1><div class="post__text post__text-html js-mediator-article">  Being a 1C programmer, I often have to use .Net classes through different layers. <br><br>  <a href="http://infostart.ru/public/238584/">Using .Net assemblies through a wrapper that implements IReflect</a> <br>  <a href="http://infostart.ru/public/300091/">CLR Hosting API is used to connect .NET assemblies</a> <br>  <a href="http://infostart.ru/public/70859/">1C.Net: Enterprise is an example of commercial success of .Net solutions in Russia</a> <br>  <a href="http://ru.stackoverflow.com/questions/527763/%25D0%259A%25D0%25B0%25D0%25BA-%25D0%25B2%25D1%258B%25D0%25B7%25D0%25B2%25D0%25B0%25D1%2582%25D1%258C-%25D0%25BC%25D0%25B5%25D1%2582%25D0%25BE%25D0%25B4-%25D0%25B8%25D0%25B7-c-%25D0%25B2-1%25D0%25A1">How to call a method from C # to 1C?</a> <br><br>  But they all use COM to one degree or another.  With the advent of <a href="https://blogs.msdn.microsoft.com/dotnet/2016/06/27/announcing-net-core-1-0/">.Net Core,</a> it became possible to use .Net assemblies on any axis other than Windows. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      A solution was found on the Internet: <a href="http://www.fancy-development.net/hosting-net-core-clr-in-your-own-process">Hosting .NET Core Clr in your own process</a> and <a href="https://github.com/Marqin/simpleCoreCLRHost">simpleCoreCLRHost</a> and <br>  <a href="">initializeCoreCLR createDelegate</a> and <br>  <a href="">unixinterface</a> <br><br>  The essence of the connection is to load the coreclr.dll library, get the interfaces you need and start the CLR Runtime Host. <br><a name="habracut"></a><br>  Now we can get references to static methods from the .Net class: <br><br><pre><code class="cs hljs"><span class="hljs-comment"><span class="hljs-comment">//               public static void SetDelegate(IntPtr ,IntPtr ) //       (  ReturnValue==null) public static bool CallAsFunc(int Target, IntPtr Ptr, IntPtr ReturnValue, IntPtr , int ) //       1 public static int GetNParams(int Target, IntPtr Ptr) //       public static bool SetPropVal(int Target, IntPtr Ptr, IntPtr pvarPropVal) public static bool GetPropVal(int Target, IntPtr Ptr, IntPtr varPropVal) //       public static void DeleteObject(int Target)</span></span></code> </pre> <br>  Now you can get links to them from C ++.  We declare the types of methods: <br><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">typedef</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">bool</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(STDMETHODCALLTYPE *ManagedCallAsFunc)</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> __int32, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">wchar_t</span></span></span></span><span class="hljs-function"><span class="hljs-params">*, tVariant* pvarRetValue, tVariant* paParams, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> __int32 lSizeArray)</span></span></span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">typedef</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">int</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(STDMETHODCALLTYPE *ManagedGetNParams)</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> __int32, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">wchar_t</span></span></span></span><span class="hljs-function"><span class="hljs-params">*)</span></span></span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">typedef</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">bool</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(STDMETHODCALLTYPE *ManagedGetPropVal)</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> __int32, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">wchar_t</span></span></span></span><span class="hljs-function"><span class="hljs-params">*, tVariant*)</span></span></span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">typedef</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">bool</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(STDMETHODCALLTYPE *ManagedSetPropVal)</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> __int32, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">wchar_t</span></span></span></span><span class="hljs-function"><span class="hljs-params">*, tVariant*)</span></span></span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">typedef</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">void</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(STDMETHODCALLTYPE *ManagedSetDelegate)</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">void</span></span></span></span><span class="hljs-function"><span class="hljs-params">*(*) (</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">long</span></span></span></span><span class="hljs-function"><span class="hljs-params">), </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">void</span></span></span></span><span class="hljs-function"><span class="hljs-params">(*) (</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">wchar_t</span></span></span></span><span class="hljs-function"><span class="hljs-params">*))</span></span></span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">typedef</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">void</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(STDMETHODCALLTYPE *ManagedDeleteObject)</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> __int32)</span></span></span></span>;</code> </pre><br>  Now we will get links to them through the function: <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">bool</span></span> ManagedDomainLoader::CreateDelegate(DWORD appDomainID, wstring MethodName, INT_PTR * fnPtr) { HRESULT hr = ClrLoader::pClrLoader-&gt;pCLRRuntimeHost-&gt;CreateDelegate( appDomainID, <span class="hljs-string"><span class="hljs-string">L"NetObjectToNative"</span></span>, <span class="hljs-comment"><span class="hljs-comment">//   L"NetObjectToNative.AutoWrap", //   MethodName.c_str(), //   (INT_PTR*)fnPtr); //     if (FAILED(hr)) { wprintf_s(L"Failed to create a delegate to the managed entry point: %s\n", MethodName.c_str()); printf_s("Failed to create a delegate to the managed entry point: (%d).\n", hr); ClrLoader::pClrLoader-&gt;pCLRRuntimeHost-&gt;UnloadAppDomain(appDomainID, true); return false; } return true; }</span></span></code> </pre><br>  And accordingly the challenge: <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!CreateDelegate(domainId,<span class="hljs-string"><span class="hljs-string">L"CallAsFunc"</span></span>, (INT_PTR*)&amp;pCallAsFunc)) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">false</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!CreateDelegate(domainId, <span class="hljs-string"><span class="hljs-string">L"GetNParams"</span></span>, (INT_PTR*)&amp;pGetNParams)) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">false</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!CreateDelegate(domainId, <span class="hljs-string"><span class="hljs-string">L"GetPropVal"</span></span>, (INT_PTR*)&amp;pGetPropVal)) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">false</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!CreateDelegate(domainId, <span class="hljs-string"><span class="hljs-string">L"SetPropVal"</span></span>, (INT_PTR*)&amp;pSetPropVal)) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">false</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!CreateDelegate(domainId, <span class="hljs-string"><span class="hljs-string">L"DeleteObject"</span></span>, (INT_PTR*)&amp;pDeleteObject)) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">false</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!CreateDelegate(domainId, <span class="hljs-string"><span class="hljs-string">L"SetDelegate"</span></span>, (INT_PTR*)&amp;pSetDelegate)) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">false</span></span>; <span class="hljs-comment"><span class="hljs-comment">//      pSetDelegate(ManagedDomainLoader::GetMem, ManagedDomainLoader::AddError);</span></span></code> </pre><br>  The first part of Marlezonsky ballet safely ended.  Now we need to solve several problems: <br><br>  1. Storage for .Net objects.  We cannot pass a reference to a .Net object as .Net objects are defragmented.  Plus you need to keep a link to them, to prevent them from garbage collection;  (GCHandle can also be applied, but this is an unnecessary load on the GC) <br>  2. Make a shell for calling methods and properties; <br>  3. Make a system for finding and calling class methods.  The fact is that in Core .Net such a powerful Type.InvokeMember function; <br>  4. Make an analogue of the Variant structure in COM and get and set values ‚Äã‚Äãinto it. <br><br>  But then, having solved this problem, we will be able to use extension methods and generic methods, which are determined by the types of parameters.  Let's start with the repository.  This is a list implementation on an array.  An elementary analogue of the memory manager.  The main task: to set the object, get and delete. <br><br><pre> <code class="cs hljs"> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">struct</span></span>  { <span class="hljs-keyword"><span class="hljs-keyword">internal</span></span> AutoWrap ; <span class="hljs-keyword"><span class="hljs-keyword">internal</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> Next; <span class="hljs-keyword"><span class="hljs-keyword">internal</span></span> (AutoWrap ) { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>. = ; Next = <span class="hljs-number"><span class="hljs-number">-1</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">internal</span></span> (AutoWrap , <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> next) { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>. = ; Next = next; } } <span class="hljs-keyword"><span class="hljs-keyword">internal</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span>  { List&lt;&gt; = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> List&lt;&gt;(); <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> FirstDeleted = <span class="hljs-number"><span class="hljs-number">-1</span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Add</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">AutoWrap </span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span>  = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> (); <span class="hljs-comment"><span class="hljs-comment">//    ,         if (FirstDeleted == -1) { .Add(); return .Count-1; } else { //         //         int newPos = FirstDeleted; FirstDeleted = [newPos].Next; [newPos] = ; return newPos; } } public void RemoveKey(int Pos) { if (Pos &gt; 0 &amp;&amp; Pos &lt; .Count &amp;&amp; [Pos]. != null) { var  = new (null, FirstDeleted); [Pos] =; FirstDeleted = Pos; } } public AutoWrap GetValue(int Pos) { if (!(Pos &gt; -1 &amp;&amp; Pos &lt; .Count &amp;&amp; [Pos]. != null)) return null; return [Pos].; } }</span></span></code> </pre><br>  We now turn to creating a wrapper. <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">AutoWrap</span></span> { [UnmanagedFunctionPointer(CallingConvention.Cdecl)] <span class="hljs-keyword"><span class="hljs-keyword">internal</span></span> <span class="hljs-keyword"><span class="hljs-keyword">delegate</span></span> IntPtr Delegate(<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> ); [UnmanagedFunctionPointer(CallingConvention.Cdecl)] <span class="hljs-keyword"><span class="hljs-keyword">internal</span></span> <span class="hljs-keyword"><span class="hljs-keyword">delegate</span></span> <span class="hljs-keyword"><span class="hljs-keyword">void</span></span> Delegate(IntPtr ); <span class="hljs-comment"><span class="hljs-comment">//      internal static  ; //   1,      . Byte[]    //            internal static string  = "&lt;&gt;‚Ññ_%)?&amp;";//new Guid().GetHashCode(); //    protected internal object O = null; //   .         protected internal Type T = null; protected internal int ; //       internal bool ; //     Enum.Parse(T, name); internal bool IsEnum; // ExpandoObject   . //    DynamicObject   DynamicMetaObject internal bool ExpandoObject; //    COM internal static bool  = false; internal static bool  = true; internal static Exception  = null; //         internal static Delegate ; //        internal static Delegate ; //  .    public static void SetDelegate(IntPtr ,IntPtr ) {  = Marshal.GetDelegateForFunctionPointer&lt;Delegate&gt;();  = Marshal.GetDelegateForFunctionPointer&lt;Delegate&gt;(); } static AutoWrap() { //        //  ,    //       0  = new (); var  = new AutoWrap(typeof(NetObjectToNative)); } public AutoWrap(object obj) {  = .Add(this); O = obj; if (O is Type) { T = O as Type;  = true; } else { T = O.GetType();  = false; ExpandoObject = O is System.Dynamic.ExpandoObject; IsEnum = T.GetTypeInfo().IsEnum; } } //      public AutoWrap(object obj, Type type) {  = .Add(this); O = obj; T = type;  = false; // ExpandoObject = O is System.Dynamic.ExpandoObject; }</span></span></code> </pre><br>  Now we will describe the option.  Rather, it is described 1C: <br><br><pre> <code class="cs hljs"><span class="hljs-comment"><span class="hljs-comment">// struct _tVariant // { // _ANONYMOUS_UNION union // { // int8_t i8Val; // int16_t shortVal; // int32_t lVal; // int intVal; // unsigned int uintVal; // int64_t llVal; // uint8_t ui8Val; // uint16_t ushortVal; // uint32_t ulVal; // uint64_t ullVal; // int32_t errCode; // long hRes; // float fltVal; // double dblVal; // bool bVal; // char chVal; // wchar_t wchVal; // DATE date; // IID IDVal; // struct _tVariant *pvarVal; // struct tm tmVal; // _ANONYMOUS_STRUCT struct // { // void* pInterfaceVal; // IID InterfaceID; // } // __VARIANT_NAME_2/*iface*/; // _ANONYMOUS_STRUCT struct // { // char* pstrVal; // uint32_t strLen; //count of bytes //} //__VARIANT_NAME_3/*str*/; // _ANONYMOUS_STRUCT struct // { // WCHAR_T* pwstrVal; //uint32_t wstrLen; //count of symbol // } __VARIANT_NAME_4/*wstr*/; // } __VARIANT_NAME_1; // uint32_t cbElements; //Dimension for an one-dimensional array in pvarVal //TYPEVAR vt; //}; public enum EnumVar { VTYPE_EMPTY = 0, VTYPE_NULL, VTYPE_I2, //int16_t VTYPE_I4, //int32_t VTYPE_R4, //float VTYPE_R8, //double VTYPE_DATE, //DATE (double) VTYPE_TM, //struct tm VTYPE_PSTR, //struct str string VTYPE_INTERFACE, //struct iface VTYPE_ERROR, //int32_t errCode VTYPE_BOOL, //bool VTYPE_VARIANT, //struct _tVariant * VTYPE_I1, //int8_t VTYPE_UI1, //uint8_t VTYPE_UI2, //uint16_t VTYPE_UI4, //uint32_t VTYPE_I8, //int64_t VTYPE_UI8, //uint64_t VTYPE_INT, //int Depends on architecture VTYPE_UINT, //unsigned int Depends on architecture VTYPE_HRESULT, //long hRes VTYPE_PWSTR, //struct wstr VTYPE_BLOB, //means in struct str binary data contain VTYPE_CLSID, //UUID VTYPE_STR_BLOB = 0xfff, VTYPE_VECTOR = 0x1000, VTYPE_ARRAY = 0x2000, VTYPE_BYREF = 0x4000, //Only with struct _tVariant * VTYPE_RESERVED = 0x8000, VTYPE_ILLEGAL = 0xffff, VTYPE_ILLEGALMASKED = 0xfff, VTYPE_TYPEMASK = 0xfff, VTYPE_AutoWrap = 0xff //     //      1 }; public class  { internal static Dictionary&lt;Type, EnumVar&gt; ; static () {  = new Dictionary&lt;Type, EnumVar&gt;() { { typeof(Int16),EnumVar.VTYPE_I2 }, {typeof(Int32),EnumVar.VTYPE_I4 }, {typeof(float),EnumVar.VTYPE_R4 }, {typeof(double),EnumVar.VTYPE_R8 }, {typeof(bool),EnumVar.VTYPE_BOOL }, {typeof(sbyte),EnumVar.VTYPE_I1 }, {typeof(byte),EnumVar.VTYPE_UI1 }, {typeof(UInt16),EnumVar.VTYPE_UI2}, {typeof(UInt32),EnumVar.VTYPE_UI4}, {typeof(Int64),EnumVar.VTYPE_I8}, {typeof(UInt64),EnumVar.VTYPE_UI8}, {typeof(string),EnumVar.VTYPE_PWSTR}, {typeof(byte[]),EnumVar.VTYPE_BLOB}, {typeof(DateTime),EnumVar.VTYPE_DATE}, {typeof(AutoWrap),EnumVar.VTYPE_AutoWrap}, }; } public static DateTime ConvertTmToDateTime(IntPtr ) { tm val = Marshal.PtrToStructure&lt;tm&gt;(); return val.ToDateTime(); } public static object IntPtr(IntPtr ) { IntPtr  =  + 44; int IntPtr = Marshal.SizeOf&lt;IntPtr&gt;(); EnumVar  =(EnumVar) Marshal.ReadInt16(); switch () { case EnumVar.VTYPE_EMPTY: case EnumVar.VTYPE_NULL: return null; case EnumVar.VTYPE_I2: return Marshal.ReadInt16(); case EnumVar.VTYPE_I4: return Marshal.ReadInt32(); case EnumVar.VTYPE_R4: return Marshal.PtrToStructure&lt;float&gt;(); case EnumVar.VTYPE_R8: return Marshal.PtrToStructure&lt;double&gt;(); case EnumVar.VTYPE_BOOL:return Marshal.ReadByte()!=0; case EnumVar.VTYPE_I1: return (sbyte)Marshal.ReadByte(); case EnumVar.VTYPE_UI1: return Marshal.ReadByte(); case EnumVar.VTYPE_UI2: return (UInt16)Marshal.ReadInt16(); case EnumVar.VTYPE_UI4: return (UInt32)Marshal.ReadInt32(); case EnumVar.VTYPE_I8: return Marshal.ReadInt64(); case EnumVar.VTYPE_UI8: return (UInt64)Marshal.ReadInt64(); case EnumVar.VTYPE_PWSTR: var str= Marshal.PtrToStringUni(Marshal.ReadIntPtr()); return AutoWrap.(str); case EnumVar.VTYPE_BLOB:  =  + IntPtr; byte[] res = new byte[Marshal.ReadInt32()]; Marshal.Copy(Marshal.ReadIntPtr(), res,0,res.Length); return res; case EnumVar.VTYPE_DATE: var date= Marshal.PtrToStructure&lt;double&gt;(); return DateTimeHelper.FromOADate(date); case EnumVar.VTYPE_TM: return ConvertTmToDateTime(); } return null; } public static IntPtr IntPtr(string str) { var res = UnicodeEncoding.Unicode.GetBytes(str); IntPtr  = AutoWrap.(res.Length + 2); Marshal.Copy(res, 0, , res.Length); Marshal.WriteInt16( + res.Length, 0); return ; } static void IntPtr(string str, IntPtr ) { Marshal.WriteIntPtr(, IntPtr(str)); IntPtr  =  + Marshal.SizeOf&lt;IntPtr&gt;(); Marshal.WriteInt32(, str.Length); } static void IntPtr(byte[] value, IntPtr ) { IntPtr  = AutoWrap.(value.Length); Marshal.Copy(value, 0, , value.Length); Marshal.WriteIntPtr(, ); IntPtr  =  + Marshal.SizeOf&lt;IntPtr&gt;(); Marshal.WriteInt32(, value.Length); } public static bool IntPtr(object , IntPtr ) { IntPtr  =  + 44; int IntPtr = Marshal.SizeOf&lt;IntPtr&gt;(); if ( == null) { Marshal.WriteInt16(, (Int16)EnumVar.VTYPE_NULL); Marshal.WriteInt32(, 0); return true; } EnumVar ; var res = .TryGetValue(.GetType(), out ); if (!res) return false; Marshal.WriteInt16(, (Int16)); switch () { case EnumVar.VTYPE_I2: Marshal.WriteInt16(,(Int16) ); break; case EnumVar.VTYPE_I4: Marshal.WriteInt32(, (Int32)); break; case EnumVar.VTYPE_R4: double val = (double)(float); Marshal.StructureToPtr&lt;double&gt;(val, ,false); Marshal.WriteInt16(, (Int16)EnumVar.VTYPE_R8); break; case EnumVar.VTYPE_R8: Marshal.StructureToPtr&lt;double&gt;((double), , false); break; case EnumVar.VTYPE_BOOL: Marshal.WriteByte(, Convert.ToByte()); break; case EnumVar.VTYPE_I1: Marshal.WriteByte(, Convert.ToByte()); break; case EnumVar.VTYPE_UI1: Marshal.WriteByte(, (byte)); break; case EnumVar.VTYPE_UI2: Marshal.WriteInt16(, Convert.ToInt16()); break; case EnumVar.VTYPE_UI4: Marshal.WriteInt32(, Convert.ToInt32()); break; case EnumVar.VTYPE_I8: Marshal.WriteInt64(, (Int64)); break; case EnumVar.VTYPE_UI8: Marshal.WriteInt64(, Convert.ToInt64()); break; case EnumVar.VTYPE_PWSTR: IntPtr((string), ); break; case EnumVar.VTYPE_BLOB: IntPtr((byte[]), ); break; case EnumVar.VTYPE_DATE: Marshal.StructureToPtr&lt;double&gt;(((DateTime)).ToOADate(), , false); break; case EnumVar.VTYPE_AutoWrap: IntPtr(((AutoWrap)).(), ); Marshal.WriteInt16(, (Int16)EnumVar.VTYPE_PWSTR); break; } return true; } }</span></span></code> </pre><br>  The rest of the implementation can be viewed in the source or see here <a href="http://ru.stackoverflow.com/questions/523386/%25D0%2592%25D1%258B%25D0%25B7%25D0%25BE%25D0%25B2-%25D1%2583%25D0%25BF%25D1%2580%25D0%25B0%25D0%25B2%25D0%25BB%25D1%258F%25D0%25B5%25D0%25BC%25D0%25BE%25D0%25B3%25D0%25BE-%25D0%25BA%25D0%25BE%25D0%25B4%25D0%25B0-net-core-%25D0%25B8%25D0%25B7-%25D0%25BD%25D0%25B5%25D1%2583%25D0%25BF%25D1%2580%25D0%25B0%25D0%25B2%25D0%25BB%25D1%258F%25D0%25B5%25D0%25BC%25D0%25BE%25D0%25B3%25D0%25BE">Calling a managed code (.Net Core) from unmanaged</a> <br><br>  I will pass to use on With ++: <br><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">TestCallMethod</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">NetObjectToNative::ManagedDomainLoader* mD, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">long</span></span></span></span><span class="hljs-function"><span class="hljs-params"> Target</span></span></span><span class="hljs-function">)</span></span> { tVariant Params[<span class="hljs-number"><span class="hljs-number">4</span></span>]; tVariant RetVal; tVariant* paParams = Params; typedef std::chrono::high_resolution_clock Clock; auto start = Clock::now(); <span class="hljs-keyword"><span class="hljs-keyword">long</span></span> r = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; <span class="hljs-number"><span class="hljs-number">1000000</span></span>; i++) { paParams-&gt;lVal = i; paParams-&gt;vt = VTYPE_I4; mD-&gt;pCallAsFunc(Target, L<span class="hljs-string"><span class="hljs-string">""</span></span>, &amp;RetVal, paParams, <span class="hljs-number"><span class="hljs-number">1</span></span>); r += RetVal.lVal; r %= <span class="hljs-number"><span class="hljs-number">1</span></span> &lt;&lt; <span class="hljs-number"><span class="hljs-number">30</span></span>; } auto finish = Clock::now(); auto elapsed = std::chrono::duration_cast&lt;std::chrono::nanoseconds&gt;(finish - start).count() / <span class="hljs-number"><span class="hljs-number">1000000000.0</span></span>; wprintf_s(L<span class="hljs-string"><span class="hljs-string">"Tme=: %.2f second\n"</span></span>, elapsed); wprintf_s(L<span class="hljs-string"><span class="hljs-string">"Eval Value=: %d \n"</span></span>, r); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">long</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GetTarget</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">tVariant* CurParam</span></span></span><span class="hljs-function">)</span></span> { wchar_t* curstr = CurParam-&gt;pwstrVal; curstr += <span class="hljs-number"><span class="hljs-number">13</span></span>; wstring temp = curstr; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> stol(temp); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">main</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { setlocale(<span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-string"><span class="hljs-string">""</span></span>); <span class="hljs-comment"><span class="hljs-comment">//  Core CLR //    //       coreclr.dll NetObjectToNative::ManagedDomainLoader* mD = NetObjectToNative::ManagedDomainLoader::InitManagedDomain(L"c:\\Program Files\\DNX\\runtimes\\dnx-coreclr-win-x86.1.0.0-rc1-update1\\bin\\", L"", L""); if (!mD) return 0; tVariant Params[4]; tVariant RetVal; tVariant* paParams = Params; paParams-&gt;vt = VTYPE_PWSTR; paParams-&gt;pwstrVal = L"System.Text.StringBuilder"; cout &lt;&lt; "Press Key"; cin.get(); // 0             bool res = mD-&gt;pCallAsFunc(0, L"", &amp;RetVal, paParams, 1); if (!res) return 0; //    1      //     12   .   long   //        //        BLOB //      ref  ; long Target = GetTarget(&amp;RetVal); //     wprintf_s(L"index : %d\n", Target); //     .   . delete[] RetVal.pstrVal; paParams-&gt;vt = VTYPE_PWSTR; paParams-&gt;pwstrVal = L" "; // 0     void       ,      res = mD-&gt;pCallAsFunc(Target, L"Append", 0, paParams, 1); res = mD-&gt;pCallAsFunc(Target, L"ToString", &amp;RetVal, paParams, 0); wprintf_s(L"ToString() : %s\n", RetVal.pwstrVal); delete[] RetVal.pstrVal; paParams-&gt;vt = VTYPE_I4; paParams-&gt;lVal = 40; res = mD-&gt;pSetPropVal(Target, L"Capacity", paParams); res = mD-&gt;pGetPropVal(Target, L"Capacity", &amp;RetVal); wprintf_s(L"Capacity : %d\n", RetVal.lVal); //    if (!mD-&gt;pGetPropVal(Target, L" ", &amp;RetVal)) wprintf_s(L"    : %s\n", L" "); //    .     GC mD-&gt;pDeleteObject(Target); //     paParams-&gt;vt = VTYPE_PWSTR; paParams-&gt;pwstrVal = L"System.Text.StringBuilder"; //  ID  typeof(System.Text.StringBuilder) res = mD-&gt;pCallAsFunc(0, L"", &amp;RetVal, paParams, 1); //paParams[0] = RetVal; //  ID  typeof(System.Text.StringBuilder) // RetVal     typeof(System.Text.StringBuilder) //   paParams[0] = RetVal; wchar_t* ref = RetVal.pwstrVal; //    StringBuilder res = mD-&gt;pCallAsFunc(0, L"", &amp;RetVal, paParams, 1); //   delete[] ref; if (!res) return 0; //      paParams[0] = RetVal; res = mD-&gt;pCallAsFunc(0, L"", &amp;RetVal, paParams, 1); //       paParams-&gt;vt = VTYPE_PWSTR; paParams-&gt;pwstrVal = L"TestDllForCoreClr., TestDllForCoreClr, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null"; auto par2 = paParams; par2++; par2-&gt;vt = VTYPE_PWSTR; par2-&gt;pwstrVal = L"  "; res = mD-&gt;pCallAsFunc(0, L"", &amp;RetVal, paParams, 2); long testRef = GetTarget(&amp;RetVal); paParams-&gt;vt = VTYPE_I4; paParams-&gt;lVal = 3; res = mD-&gt;pCallAsFunc(testRef, L"", &amp;RetVal, paParams, 1); wprintf_s(L"input int : %d\n", RetVal.lVal); TestCallMethod(mD, testRef); TestCallMethod(mD, testRef); TestCallMethod(mD, testRef);</span></span></code> </pre><br>  In general, this is a primitive analogue of IDispatch without the support of reference counting.  But you can make such an analogue on the side of the native and use it in .Net through a wrapper through DynamicObject.  The execution speed per million calls is 2.7 seconds on my i3-2120 3.3 GHz. <br><br>  If on Windows for 1C it was possible to solve through COM, then this shop covered itself on the linkus.  But you can use Core .Net! <br><br>  In perspective, you can use the .Net objects of <a href="http://infostart.ru/public/417830/">.NET (C #) for 1C.</a>  <a href="http://infostart.ru/public/417830/">Dynamic compilation of a wrapper class for using .Net events in 1C via Add Handler or Processing an External Event</a> <a href="http://infostart.ru/public/417830/"><br></a> <br>  Sources can be downloaded <a href="https://yadi.sk/d/FBHUVl22suNwH">here.</a> <br><br>  In the next article I will write about using .Net Core in 1C using Native VK technology <br><br>  Added support for dynamic objects supporting IDynamicMetaObjectProvider (DynamicObject, ExpandoObject) <br>  Examples can be found here. <br>  <a href="https://habrahabr.ru/post/304542/">Cross-platform use of .Net classes in 1C through Native VK.</a>  <a href="https://habrahabr.ru/post/304542/">Or replacing COM with Linux</a> </div><p>Source: <a href="https://habr.com/ru/post/304482/">https://habr.com/ru/post/304482/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../304468/index.html">What you need to know about the IaaS-provider even before the start of cooperation</a></li>
<li><a href="../304470/index.html">How typography can save your life</a></li>
<li><a href="../304472/index.html">Vibration Management with jquery.vibrate.js Library</a></li>
<li><a href="../304474/index.html">How to level the Pyramid of death</a></li>
<li><a href="../304476/index.html">The base of free Github repositories is available through the interface BigQuery</a></li>
<li><a href="../304484/index.html">VDI for all: VMware Horizon 7 specification</a></li>
<li><a href="../304486/index.html">iMessage in iOS 10: New Opportunities for Developers</a></li>
<li><a href="../304488/index.html">Shake Detector for Android on RxJava</a></li>
<li><a href="../304490/index.html">Why do video surveillance developers love retail more than production?</a></li>
<li><a href="../304492/index.html">Translation of C ++ project for development with unit testing / TDD</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>