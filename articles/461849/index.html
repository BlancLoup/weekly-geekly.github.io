<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>PVS-Studio glanced at Red Dead Redemption engine - Bullet</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Nowadays, for, for example, developing games, there is no longer any need to independently implement the physics of objects from scratch, since there ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>PVS-Studio glanced at Red Dead Redemption engine - Bullet</h1><div class="post__text post__text-html js-mediator-article"><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/0d4/8af/4e2/0d48af4e201510deac9e3634151d647e.png" alt="Picture 4"></div><br>  Nowadays, for, for example, developing games, there is no longer any need to independently implement the physics of objects from scratch, since there are a large number of libraries for this.  Bullet was once actively used in many AAA games, virtual reality projects, various simulations and machine learning.  Yes, and it is still used today, being, for example, one of the engines of Red Dead Redemption and Red Dead Redemption 2. So why not check Bullet with PVS-Studio to see what errors static analysis can detect in such a large-scale project, related to physics simulation. <br><a name="habracut"></a><br>  This library is <a href="https://github.com/bulletphysics">freely distributed</a> , so that everyone can optionally use it in their projects.  In addition to Red Dead Redemption, this physics engine is also used in the film industry to create special effects.  For example, he was involved in the filming of Sherlock Holmes by Guy Ritchie to calculate collisions. <br><br>  If this is your first encounter with an article where PVS-Studio checks projects, then I will make a small digression.  <a href="https://www.viva64.com/ru/pvs-studio/">PVS-Studio</a> is a static code analyzer that helps find errors, shortcomings and potential vulnerabilities in the source code of C, C ++, C #, Java programs.  Static analysis is a kind of automated code review process. <br><br><h2>  For warming up </h2><br>  <b>Example 1:</b> 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Let's start with a funny mistake: <br><br>  <a href="https://www.viva64.com/ru/w/v624/">V624</a> There is probably a misprint in '3.141592538' constant.  Consider using the M_PI constant from &lt;math.h&gt;.  PhysicsClientC_API.cpp 4109 <br><br><pre><code class="cpp hljs"><span class="hljs-function"><span class="hljs-function">B3_SHARED_API </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">b3ComputeProjectionMatrixFOV</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">float</span></span></span></span><span class="hljs-function"><span class="hljs-params"> fov, ....)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">float</span></span> yScale = <span class="hljs-number"><span class="hljs-number">1.0</span></span> / <span class="hljs-built_in"><span class="hljs-built_in">tan</span></span>((<span class="hljs-number"><span class="hljs-number">3.141592538</span></span> / <span class="hljs-number"><span class="hljs-number">180.0</span></span>) * fov / <span class="hljs-number"><span class="hljs-number">2</span></span>); .... }</code> </pre> <br>  A small typo in the number Pi (3.141592653 ...), missing the number "6" at the 7th position in the fractional part. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/f83/42b/62f/f8342b62f2250ce927675fbbc1f40af7.png" alt="Picture 1"></div>  Perhaps the error in the ten-millionth fraction after the decimal point will not lead to tangible consequences, but you should still use the existing library constants without typos.  For Pi, there is an <i>M_PI</i> constant from the <i>math.h</i> header. <br><br><h2>  Copy paste </h2><br>  <b>Example 2:</b> <br><br>  Sometimes the analyzer allows you to find the error indirectly.  So, for example, here three related arguments <i>halfExtentsX, halfExtentsY, halfExtentsZ</i> are passed to the function, but the latter is not used anywhere in the function.  You may notice that when calling the <i>addVertex</i> method, the variable <i>halfExtentsY is</i> used twice.  So perhaps this is a copy-paste error, and here a forgotten argument should be used. <br><br>  <a href="https://www.viva64.com/ru/w/v751/">V751</a> Parameter 'halfExtentsZ' is not used inside function body.  TinyRenderer.cpp 375 <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">void</span></span> TinyRenderObjectData::createCube(<span class="hljs-keyword"><span class="hljs-keyword">float</span></span> halfExtentsX, <span class="hljs-keyword"><span class="hljs-keyword">float</span></span> halfExtentsY, <span class="hljs-keyword"><span class="hljs-keyword">float</span></span> halfExtentsZ, ....) { .... m_model-&gt;addVertex(halfExtentsX * cube_vertices_textured[i * <span class="hljs-number"><span class="hljs-number">9</span></span>], halfExtentsY * cube_vertices_textured[i * <span class="hljs-number"><span class="hljs-number">9</span></span> + <span class="hljs-number"><span class="hljs-number">1</span></span>], halfExtentsY * cube_vertices_textured[i * <span class="hljs-number"><span class="hljs-number">9</span></span> + <span class="hljs-number"><span class="hljs-number">2</span></span>], cube_vertices_textured[i * <span class="hljs-number"><span class="hljs-number">9</span></span> + <span class="hljs-number"><span class="hljs-number">4</span></span>], ....); .... }</code> </pre> <br>  <b>Example 3:</b> <br><br>  The analyzer also found the following interesting fragment, I will cite it first in its original form. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/f03/4d3/6a0/f034d36a087d3705a4aaf5c1ca4ff54c.png" alt="Picture 11"></div><br>  See this last line? <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/97f/976/5f6/97f9765f6af6eef034ea0c541f6e95c1.png" alt="Picture 12"></div><br>  It is very strange that the programmer decided to write such a long condition in one line.  But the fact that a mistake most likely crept into it is not at all surprising. <br><br>  The analyzer issued the following warnings on this line. <br><br>  <a href="https://www.viva64.com/ru/w/v501/">V501</a> There are identical sub-expressions 'rotmat.Column1 (). Norm () &lt;1.0001' to the left and to the right of the '&amp;&amp;' operator.  LinearR4.cpp 351 <br><br>  <a href="https://www.viva64.com/ru/w/v501/">V501</a> There are identical sub-expressions '0.9999 &lt;rotmat.Column1 (). Norm ()' to the left and to the right of the '&amp;&amp;' operator.  LinearR4.cpp 351 <br><br>  If we write everything in a visual ‚Äútabular‚Äù form, it will become clear that the same checks apply to <i>Column1</i> .  The last two comparisons show that there are <i>Column1</i> and <i>Column2</i> .  Most likely the third and fourth comparisons should have checked the value of <i>Column2</i> . <br><br><pre> <code class="cpp hljs"> Column1().Norm() &lt; <span class="hljs-number"><span class="hljs-number">1.0001</span></span> &amp;&amp; <span class="hljs-number"><span class="hljs-number">0.9999</span></span> &lt; Column1().Norm() &amp;&amp; Column1().Norm() &lt; <span class="hljs-number"><span class="hljs-number">1.0001</span></span> &amp;&amp; <span class="hljs-number"><span class="hljs-number">0.9999</span></span> &lt; Column1().Norm() &amp;&amp;(Column1() ^ Column2()) &lt; <span class="hljs-number"><span class="hljs-number">0.001</span></span> &amp;&amp; (Column1() ^ Column2()) &gt; <span class="hljs-number"><span class="hljs-number">-0.001</span></span></code> </pre><br>  In this form, the same comparison becomes much more noticeable. <br><br>  <b>Example 4:</b> <br><br>  An error of a similar kind: <br><br>  <a href="https://www.viva64.com/ru/w/v501/">V501</a> There are identical sub-expressions 'cs.m_fJacCoeffInv [0] == 0' to the left and to the right of the '&amp;&amp;' operator.  b3CpuRigidBodyPipeline.cpp 169 <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">float</span></span> m_fJacCoeffInv[<span class="hljs-number"><span class="hljs-number">2</span></span>]; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">inline</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">b3SolveFriction</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(b3ContactConstraint4&amp; cs, ....)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (cs.m_fJacCoeffInv[<span class="hljs-number"><span class="hljs-number">0</span></span>] == <span class="hljs-number"><span class="hljs-number">0</span></span> &amp;&amp; cs.m_fJacCoeffInv[<span class="hljs-number"><span class="hljs-number">0</span></span>] == <span class="hljs-number"><span class="hljs-number">0</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>; } .... }</code> </pre> <br>  In this case, the same array element is double checked.  Most likely, the condition should have looked like this: <i>cs.m_fJacCoeffInv [0] == 0 &amp;&amp; cs.m_fJacCoeffInv [1] == 0</i> .  This is a classic example of copy-paste error. <br><br>  <b>Example 5:</b> <br><br>  Another shortcoming was discovered: <br><br>  <a href="https://www.viva64.com/ru/w/v517/">V517</a> The use of 'if (A) {...} else if (A) {...}' pattern was detected.  There is a probability of logical error presence.  Check lines: 79, 112. main.cpp 79 <br><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">main</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> argc, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">char</span></span></span></span><span class="hljs-function"><span class="hljs-params">* argv[])</span></span></span><span class="hljs-function"> </span></span>{ .... <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (serviceResult &gt; <span class="hljs-number"><span class="hljs-number">0</span></span>) { serviceResult = enet_host_service(client, &amp;event, <span class="hljs-number"><span class="hljs-number">0</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (serviceResult &gt; <span class="hljs-number"><span class="hljs-number">0</span></span>) { .... } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (serviceResult &gt; <span class="hljs-number"><span class="hljs-number">0</span></span>) { <span class="hljs-built_in"><span class="hljs-built_in">puts</span></span>(<span class="hljs-string"><span class="hljs-string">"Error with servicing the client"</span></span>); <span class="hljs-built_in"><span class="hljs-built_in">exit</span></span>(EXIT_FAILURE); } .... } .... }</code> </pre> <br>  The <i>enet_host_service</i> function, whose result is assigned to <i>serviceResult</i> , returns one if it <i>succeeds</i> and -1 if it fails.  Most likely the <i>else if</i> branch should have responded to the negative value of <i>serviceResult</i> , but the verification condition was duplicated.  Most likely this is also a copy-paste error. <br><br>  A similar analyzer warning, which does not make sense to describe in the article: <br><br>  <a href="https://www.viva64.com/ru/w/v517/">V517</a> The use of 'if (A) {...} else if (A) {...}' pattern was detected.  There is a probability of logical error presence.  Check lines: 151, 190. PhysicsClientUDP.cpp 151 <br><br><h2>  Beyond the limits: going beyond the boundaries of the array </h2><br>  <b>Example 6:</b> <br><br>  One of the unpleasant things to look for errors is going out of the array.  Often this error occurs due to complex indexing in the loop. <br><br>  Here, in the loop condition, the <i>dofIndex</i> variable <i>is</i> limited to 128 from above and <i>dof</i> to 4, inclusive.  But <i>m_desiredState</i> also contains only 128 elements.  As a result, the index <i>[dofIndex + dof]</i> can lead to the <i>outflow of the</i> array. <br><br>  <a href="https://www.viva64.com/ru/w/v557/">V557</a> Array overrun is possible.  The value of 'dofIndex + dof' index could reach 130. PhysicsClientC_API.cpp 968 <br><br><pre> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> MAX_DEGREE_OF_FREEDOM 128 double m_desiredState[MAX_DEGREE_OF_FREEDOM]; B3_SHARED_API int b3JointControl(int dofIndex, double* forces, int dofCount, ....) { .... </span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">if</span></span></span><span class="hljs-meta"> ( (dofIndex &gt;= 0) &amp;&amp; (dofIndex </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt; MAX_DEGREE_OF_FREEDOM ) &amp;&amp; dofCount &gt;= 0 &amp;&amp; dofCount &lt;= 4) { for (int dof = 0; dof &lt; dofCount; dof++) { command-&gt;m_sendState.m_desiredState[dofIndex+dof] = forces[dof]; .... } } .... }</span></span></span></span></code> </pre> <br>  <b>Example 7</b> <br><br>  A similar error, but now summation leads to it not when indexing an array, but in a condition.  If the file name is as long as possible, then the terminal zero will be written outside the array ( <a href="https://cwe.mitre.org/data/definitions/193.html">Off-by-one Error</a> ).  Naturally, the <i>len</i> variable will be equal to <i>MAX_FILENAME_LENGTH</i> only in exceptional cases, but this does not eliminate the error, but simply makes its occurrence rare. <br><br>  <a href="https://www.viva64.com/ru/w/v557/">V557</a> Array overrun is possible.  The value of 'len' index could reach 1024. PhysicsClientC_API.cpp 5223 <br><br><pre> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> MAX_FILENAME_LENGTH MAX_URDF_FILENAME_LENGTH 1024 struct b3Profile { char m_name[MAX_FILENAME_LENGTH]; int m_durationInMicroSeconds; }; int len = strlen(name); </span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">if</span></span></span><span class="hljs-meta"> (len &gt;= 0 &amp;&amp; len </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt; (MAX_FILENAME_LENGTH + 1)) { command-&gt;m_type = CMD_PROFILE_TIMING; strcpy(command-&gt;m_profile.m_name, name); command-&gt;m_profile.m_name[len] = 0; }</span></span></span></span></code> </pre> <br><h2>  Measure once - cut seven times </h2><br>  <b>Example 8:</b> <br><br>  In cases where you need to repeatedly use the result of a function or reuse a variable that you need to access through a series of calls, you should use temporary variables to optimize and read the code better.  The analyzer found more than 100 places in the code where such an amendment can be made. <br><br>  <a href="https://www.viva64.com/ru/w/v807/">V807</a> Decreased Performance.  Consider creating a pointer to avoid using the 'm_app-&gt; m_renderer-&gt; getActiveCamera ()' expression repeatedly.  InverseKinematicsExample.cpp 315 <br><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">virtual</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">resetCamera</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ .... <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (....) { m_app-&gt;m_renderer-&gt;getActiveCamera()-&gt;setCameraDistance(dist); m_app-&gt;m_renderer-&gt;getActiveCamera()-&gt;setCameraPitch(pitch); m_app-&gt;m_renderer-&gt;getActiveCamera()-&gt;setCameraYaw(yaw); m_app-&gt;m_renderer-&gt;getActiveCamera()-&gt;setCameraPosition(....); } }</code> </pre> <br>  Here the same call chain is reused, which can be replaced with a single pointer. <br><br>  <b>Example 9:</b> <br><br>  <a href="https://www.viva64.com/ru/w/v810/">V810</a> Decreased Performance.  The 'btCos (euler_out.pitch)' function was called several times with identical arguments.  The result should possibly be saved to a temporary variable, which then could be used while calling the 'btAtan2' function.  btMatrix3x3.h 576 <br><br>  <a href="https://www.viva64.com/ru/w/v810/">V810</a> Decreased Performance.  The 'btCos (euler_out2.pitch)' function was called several times with identical arguments.  The result should possibly be saved to a temporary variable, which then could be used while calling the 'btAtan2' function.  btMatrix3x3.h 578 <br><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getEulerZYX</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(....)</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">const</span></span></span><span class="hljs-function"> </span></span>{ .... <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (....) { .... } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { .... euler_out.roll = btAtan2(m_el[<span class="hljs-number"><span class="hljs-number">2</span></span>].y() / btCos(euler_out.pitch), m_el[<span class="hljs-number"><span class="hljs-number">2</span></span>].z() / btCos(euler_out.pitch)); euler_out2.roll = btAtan2(m_el[<span class="hljs-number"><span class="hljs-number">2</span></span>].y() / btCos(euler_out2.pitch), m_el[<span class="hljs-number"><span class="hljs-number">2</span></span>].z() / btCos(euler_out2.pitch)); euler_out.yaw = btAtan2(m_el[<span class="hljs-number"><span class="hljs-number">1</span></span>].x() / btCos(euler_out.pitch), m_el[<span class="hljs-number"><span class="hljs-number">0</span></span>].x() / btCos(euler_out.pitch)); euler_out2.yaw = btAtan2(m_el[<span class="hljs-number"><span class="hljs-number">1</span></span>].x() / btCos(euler_out2.pitch), m_el[<span class="hljs-number"><span class="hljs-number">0</span></span>].x() / btCos(euler_out2.pitch)); } .... }</code> </pre><br>  In this case, you can create two variables and store the values ‚Äã‚Äãreturned by the <i>btCos</i> function for <i>euler_out.pitch</i> and <i>euler_out2.pitch in them</i> , instead of calling the function four times for each argument. <br><br><h2>  A leak </h2><br>  <b>Example 10:</b> <br><br>  A lot of errors of the following type were found in the project: <br><br>  <a href="https://www.viva64.com/ru/w/v773/">V773</a> Visibility scope of the 'importer' pointer was exited without releasing the memory.  A memory leak is possible.  SerializeSetup.cpp 94 <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">void</span></span> SerializeSetup::initPhysics() { .... btBulletWorldImporter* importer = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> btBulletWorldImporter(m_dynamicsWorld); .... fclose(file); m_guiHelper-&gt;autogenerateGraphicsObjects(m_dynamicsWorld); }</code> </pre> <br>  No memory has been freed from the <i>importer</i> pointer here.  This may cause a memory leak.  And for the physical engine, this may be a bad trend.  To avoid leakage, it is enough after the variable is no longer needed to add <i>delete importer</i> .  But of course, it‚Äôs better to use smart pointers. <br><br><h2>  Here are your laws </h2><br>  <b>Example 11:</b> <br><br>  The following error appears in the code due to the fact that C ++ rules do not always coincide with mathematical rules or ‚Äúcommon sense‚Äù.  Notice for yourself where a small code snippet contains an error? <br><br><pre> <code class="cpp hljs">btAlignedObjectArray&lt;btFractureBody*&gt; m_fractureBodies; <span class="hljs-keyword"><span class="hljs-keyword">void</span></span> btFractureDynamicsWorld::fractureCallback() { <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; numManifolds; i++) { .... <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> f0 = m_fractureBodies.findLinearSearch(....); <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> f1 = m_fractureBodies.findLinearSearch(....); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (f0 == f1 == m_fractureBodies.size()) <span class="hljs-keyword"><span class="hljs-keyword">continue</span></span>; .... } .... }</code> </pre> <br>  The analyzer generates the following warning: <br><br>  <a href="https://www.viva64.com/ru/w/v709/">V709</a> Suspicious comparison found: 'f0 == f1 == m_fractureBodies.size ()'.  Remember that 'a == b == c' is not equal to 'a == b &amp;&amp; b == c'.  btFractureDynamicsWorld.cpp 483 <br><br>  It would seem that the condition checks that <i>f0</i> is equal to <i>f1</i> and equal to the number of elements in <i>m_fractureBodies</i> .  It looks like this comparison should have checked if <i>f0</i> and <i>f1 are</i> at the end of the <i>m_fractureBodies</i> array, since they contain the position of the object found by the <i>findLinearSearch ()</i> method.  However, in fact, this expression turns into a test to see if <i>f0</i> and <i>f1</i> are equal, and then to a check if <i>m_fractureBodies.size ()</i> is equal to the result of <i>f0 == f1</i> .  As a result, the third operand here is compared with 0 or 1. <br><br>  Beautiful mistake!  And, fortunately, quite rare.  So far we have <a href="https://www.viva64.com/ru/examples/v709/">met</a> her only in two open projects, and interestingly, all of them were just game engines. <br><br>  <b>Example 12:</b> <br><br>  When working with strings, it is often better to use the facilities provided by the <i>string</i> class.  So, for the following two cases, it is better to replace <i>strlen (MyStr.c_str ())</i> and <i>val = ""</i> with <i>MyStr.length ()</i> and <i>val.clear ()</i> respectively. <br><br>  <a href="https://www.viva64.com/ru/w/v806/">V806</a> Decreased Performance.  The expression of strlen (MyStr.c_str ()) kind can be rewritten as MyStr.length ().  RobotLoggingUtil.cpp 213 <br><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-function">FILE* </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">createMinitaurLogFile</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">char</span></span></span></span><span class="hljs-function"><span class="hljs-params">* fileName, </span></span><span class="hljs-built_in"><span class="hljs-function"><span class="hljs-params"><span class="hljs-built_in">std</span></span></span></span><span class="hljs-function"><span class="hljs-params">::</span></span><span class="hljs-built_in"><span class="hljs-function"><span class="hljs-params"><span class="hljs-built_in">string</span></span></span></span><span class="hljs-function"><span class="hljs-params">&amp; structTypes, ....)</span></span></span><span class="hljs-function"> </span></span>{ FILE* f = fopen(fileName, <span class="hljs-string"><span class="hljs-string">"wb"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (f) { .... fwrite(structTypes.c_str(), <span class="hljs-built_in"><span class="hljs-built_in">strlen</span></span>(structTypes.c_str()), <span class="hljs-number"><span class="hljs-number">1</span></span>, f); .... } .... }</code> </pre><br>  <a href="https://www.viva64.com/ru/w/v815/">V815</a> Decreased Performance.  Consider replacing the expression 'val = ""' with 'val.clear ()'.  b3CommandLineArgs.h 40 <br><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">addArgs</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> argc, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">char</span></span></span></span><span class="hljs-function"><span class="hljs-params"> **argv)</span></span></span><span class="hljs-function"> </span></span>{ .... <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::<span class="hljs-built_in"><span class="hljs-built_in">string</span></span> val; .... val = <span class="hljs-string"><span class="hljs-string">""</span></span>; .... }</code> </pre> <br>  There were other warnings, but I think you can stop.  As you can see, static code analysis can reveal a wide range of various errors. <br><br>  It is interesting to read about one-time checks of projects, but this is not the right way to use static code analyzers.  And about this we will talk below. <br><br><h2>  Bugs Found Before Us </h2><br>  It was interesting in the spirit of the recent article ‚Äú <a href="https://habr.com/ru/company/pvs-studio/blog/460119/">Errors that static code analysis does not find because it is not used</a> ‚Äù to try to find bugs or shortcomings that have already been fixed, but which the static analyzer would be able to detect. <br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/0e5/4ab/39d/0e54ab39d2d7d7dbd4d595d1032fe994.png" alt="Picture 2"></div><br>  There were not so many pull requests in the repository, and many of them are related to the internal logic of the engine.  But there were also errors that the analyzer could detect. <br><br>  <b>Example 13:</b> <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">char</span></span> m_deviceExtensions[B3_MAX_STRING_LENGTH]; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">b3OpenCLUtils_printDeviceInfo</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(cl_device_id device)</span></span></span><span class="hljs-function"> </span></span>{ b3OpenCLDeviceInfo info; b3OpenCLUtils::getDeviceInfo(device, &amp;info); .... <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (info.m_deviceExtensions != <span class="hljs-number"><span class="hljs-number">0</span></span>) { .... } }</code> </pre> <br>  A comment on the edit suggests that it was necessary to check the array that it is not empty, but instead a pointless pointer check was performed, which always returned true.  This is indicated by the warning PVS-Studio on the initial type of check: <br><br>  <a href="https://www.viva64.com/ru/w/v600/">V600</a> Consider inspecting the condition.  The 'info.m_deviceExtensions' pointer is always not equal to NULL.  b3OpenCLUtils.cpp 551 <br><br>  <b>Example 14:</b> <br><br>  Can you immediately find out what the problem is in the next function? <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">inline</span></span> <span class="hljs-keyword"><span class="hljs-keyword">void</span></span> Matrix4x4::SetIdentity() { m12 = m13 = m14 = m21 = m23 = m24 = m13 = m23 = m41 = m42 = m43 = <span class="hljs-number"><span class="hljs-number">0.0</span></span>; m11 = m22 = m33 = m44 = <span class="hljs-number"><span class="hljs-number">1.0</span></span>; }</code> </pre> <br>  The analyzer generates the following warnings: <br><br>  <a href="https://www.viva64.com/ru/w/v570/">V570</a> The same value is assigned twice to the 'm23' variable.  LinearR4.h 627 <br><br>  <a href="https://www.viva64.com/ru/w/v570/">V570</a> The same value is assigned twice to the 'm13' variable.  LinearR4.h 627 <br><br>  Repeated assignments with this form of recording are difficult to track with the naked eye and as a result, some of the matrix elements did not receive the initial value.  This error was corrected in the tabular form of the assignment record: <br><br><pre> <code class="cpp hljs">m12 = m13 = m14 = m21 = m23 = m24 = m31 = m32 = m34 = m41 = m42 = m43 = <span class="hljs-number"><span class="hljs-number">0.0</span></span>;</code> </pre><br>  <b>Example 15:</b> <br><br>  The following error in one of the conditions of the <i>btSoftBody :: addAeroForceToNode ()</i> function led to an explicit bug.  According to the comment in the pull request, forces were applied to objects from the wrong side. <br><br><pre> <code class="cpp hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">eAeroModel</span></span></span><span class="hljs-class"> {</span></span> <span class="hljs-keyword"><span class="hljs-keyword">enum</span></span> _ { V_Point, V_TwoSided, .... END }; }; <span class="hljs-keyword"><span class="hljs-keyword">void</span></span> btSoftBody::addAeroForceToNode(....) { .... <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (....) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (btSoftBody::eAeroModel::V_TwoSided) { .... } .... } .... }</code> </pre> <br>  PVS-Studio could also find this error and display the following warning: <br><br>  <a href="https://www.viva64.com/ru/w/v768/">V768</a> The enumeration constant 'V_TwoSided' is used as a variable of a Boolean-type.  btSoftBody.cpp 542 <br><br>  The corrected check is as follows: <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (m_cfg.aeromodel == btSoftBody::eAeroModel::V_TwoSided) { .... }</code> </pre> <br>  Instead of the equivalence of the object property to one of the enumerators, the <i>V_TwoSided</i> enumerator itself was checked. <br><br>  It‚Äôs clear that I didn‚Äôt look at all the pull requests, since I didn‚Äôt set myself such a task.  I just wanted to show that regular use of a static code analyzer can detect errors at an early stage.  This is the correct way to use static code analysis.  Static analysis should be built into the DevOps process and be the primary filter of bugs.  All this is well described in the article " <a href="https://habr.com/ru/post/436868/">Embed static analysis into the process, and not look for bugs with it</a> ." <br><br><h2>  Conclusion </h2><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/a4a/dc3/388/a4adc33880ad2c22a88902ae54a7fa44.png" alt="Picture 6"></div><br>  Judging by some pull requests, a project is sometimes checked through various code analysis tools, however, edits are made not gradually, but in groups and at large intervals in time.  In some requests, a comment indicates that the changes were made only to suppress warnings.  Such an approach to the use of analysis significantly reduces its benefit, since it is a constant check of the project that allows you to fix errors immediately, and not wait until any obvious bugs appear. <br><br>  If you want to always be in the know about the news and events of our team, subscribe to our social services.  Networks: <a href="https://www.instagram.com/pvsstudio_rus/">Instagram</a> , <a href="https://twitter.com/pvsstudio_rus">Twitter</a> , <a href="https://vk.com/pvsstudio_rus">Vkontakte</a> , <a href="https://t.me/pvsstudio_rus">Telegram</a> . <br><br> <a href="https://habr.com/en/company/pvs-studio/blog/461841/"><img src="https://habrastorage.org/getpro/habr/post_images/898/3b6/5a7/8983b65a74adb29a2113eba12fbec3f1.png" align="left"></a> <br><br>  If you want to share this article with an English-speaking audience, then please use the translation link: <a href="https://habr.com/en/company/pvs-studio/blog/461841/">PVS-Studio Looked into the Red Dead Redemption's Bullet Engine</a> </div><p>Source: <a href="https://habr.com/ru/post/461849/">https://habr.com/ru/post/461849/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../46183/index.html">Domain .tel: Internet Phone Directory</a></li>
<li><a href="../461831/index.html">StealthWatch: Deployment and Customization. Part 2</a></li>
<li><a href="../461833/index.html">Do not get lost in three pines: an egocentric representation of the environment</a></li>
<li><a href="../461837/index.html">Deploying your MTProxy Telegram with statistics</a></li>
<li><a href="../461845/index.html">Investments on the stock exchange as a way to preserve finances: 3 working methods</a></li>
<li><a href="../461855/index.html">Salaries in IT in the first half of 2019: according to the salary calculator My Circle</a></li>
<li><a href="../461859/index.html">You don't know anything about food tech</a></li>
<li><a href="../461861/index.html">Office 365 Cloud Services: Check Point CloudGuard SaaS Testing</a></li>
<li><a href="../461863/index.html">How Chinese Mpow Headphones Bestseller on Amazon: Getting to Know the Brand</a></li>
<li><a href="../461865/index.html">Video course ‚ÄúIntroduction to reversing from scratch using IDA PRO. Chapter 1"</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>