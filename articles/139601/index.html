<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>STM32F1xx - Developer Tools and FreeRTOS</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Good afternoon, dear habrovchane. In my previous articles ( STM32F1xx - we treat arduino dependency together , STM32F1xx - we continue treatment of ar...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>STM32F1xx - Developer Tools and FreeRTOS</h1><div class="post__text post__text-html js-mediator-article">  Good afternoon, dear habrovchane.  In my previous articles ( <a href="http://habrahabr.ru/blogs/controllers/123791/">STM32F1xx - we treat arduino dependency together</a> , <a href="http://habrahabr.ru/blogs/controllers/139384/">STM32F1xx - we continue treatment of arduino dependency with LCD</a> ) I tried to highlight the issues of transition from 8-bit microcontrollers to new 32-bit STM32F1xx. <br>  In the process of working with them, I, of course, chose the tools for myself ‚Äúby the hand‚Äù - that is, I tried to find the most convenient debugging boards for me, programmers, IDE.  In this article I want to share with you a few thoughts on this matter, as well as describe the build process in the chosen IDE of the real-time operating system FreeRTOS. <br><a name="habracut"></a><br><h4>  Iron </h4><br>  Traditionally start with iron. <br>  In previous articles, the core of the system was <a href="http://www.terraelectronica.ru/catalog_info.php%3FID%3D1001%26CODE%3D573571%26Name%3DSTM32VLDISCOVERY%26Razdel%3D%25CE%25F2%25EB%25E0%25E4%25EE%25F7%25ED%25FB%25E5%2520%25E8%2520%25EE%25F6%25E5%25ED%25EE%25F7%25ED%25FB%25E5%2520%25EF%25EB%25E0%25F2%25FB%2520%25E8%2520%25ED%25E0%25E1%25EE%25F0%25FB%2520%25E4%25EB%25FF%2520%25F1%25E5%25EC%25E5%25E9%25F1%25F2%25E2%25E0%2520STM32%2520(Cortex-M3)%26TableName%3Dclass_19_2_40_4_6">STM32VLDISCOVERY</a> . <br>  The fee is certainly good, and impresses with the fact that its price is only 300 rubles.  In principle, a good tool to begin to get acquainted with this family of microcontrollers.  But. <br>  The fact is that when choosing a debug board, you always want to keep the balance of quantity and quality, that is, on the one hand, you have everything you need for work, on the other hand, you don‚Äôt want the board to turn into a huge and expensive monster.  At STM32VLDISCOVERY, the balance is shifted towards low cost and minimalism. <br>  Climbing on e-bay, I found a more convenient, in my opinion, charge, which I present to your attention.  Here she is: <br>  <a href="http://www.ebay.com/itm/280580644330%3FssPageName%3DSTRK:MEWNX:IT%26_trksid%3Dp3984.m1439.l2649">Mini-STM32</a> <br><br><img src="https://habrastorage.org/getpro/geektimes/post_images/a37/470/d99/a37470d9988f9fcf9a491bb2e32ca456.jpg" alt="image"><br><br>  For 46 dollars we are offered: <br><ol><li>  Microcontroller STM32F103VE, having onboard 512 kilobytes of flash and 64 kilobytes of RAM, USB, SDIO (that is, it will be much faster to read from a card than on an SPI).  In addition, since the board has a 100-foot version of it, it has enough external pins to manage memory through the FSMC.  FSMC is a Flexible Static Memory Controller, a very convenient static memory controller, starting with SRAM itself and ending with NAND flash drives.  By setting it up and connecting the memory to the control pins, we get our memory mapped to the controller's address space.  That is, from now on, all interactions with it will be transparent to us and equivalent to simply writing to RAM. </li><li>  Color TFT-display with a resolution of 320x240 and a pre-installed resistive touch-screen.  The display is placed on the board as a module, if desired, you can unscrew the small stands to which it is attached, and use the board without it.  In addition to the display module, the display module also includes a step-up converter for powering its backlight, as well as a touch-screen controller that is controlled via SPI.  In addition, the connector is connected to the above-mentioned FSMC, which makes it more convenient to interact with it. <br>  For example, here is the entry in the display registers, and then in its memory, using DMA: <br><pre><code class="hljs delphi">#define LCDRegister <span class="hljs-comment"><span class="hljs-comment">(*((volatile u16*)</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>x60000000)) #define LCDMemory <span class="hljs-comment"><span class="hljs-comment">(*((volatile u16*)</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>x60020000)) <span class="hljs-comment"><span class="hljs-comment">//‚Ä¶ void LCDWriteRegister(unsigned short reg, unsigned short data) { LCDRegister=reg; LCDMemory=data; } void LCDBeginRAMWrite() { LCDRegister=CTR_WRITE_DATA; } int main(void) { //‚Ä¶ RCC_AHBPeriphClockCmd(RCC_AHBPeriph_DMA1, ENABLE); DMA_InitTypeDef DMA_InitStructure; DMA_DeInit(DMA1_Channel1); // -  DMA_InitStructure.DMA_PeripheralBaseAddr = (u32) PlasmaBuffer1; // ¬´ ¬ª   DMA_InitStructure.DMA_MemoryBaseAddr = (u32)(&amp;LCDMemory); DMA_InitStructure.DMA_DIR = DMA_DIR_PeripheralSRC; DMA_InitStructure.DMA_BufferSize = PLASMA_WIDTH*PLASMA_HEIGHT; DMA_InitStructure.DMA_PeripheralInc = DMA_PeripheralInc_Enable; DMA_InitStructure.DMA_MemoryInc = DMA_MemoryInc_Disable; DMA_InitStructure.DMA_PeripheralDataSize = DMA_PeripheralDataSize_Byte; DMA_InitStructure.DMA_MemoryDataSize = DMA_MemoryDataSize_HalfWord; DMA_InitStructure.DMA_Mode = DMA_Mode_Normal; DMA_InitStructure.DMA_Priority = DMA_Priority_High; DMA_InitStructure.DMA_M2M = DMA_M2M_Enable; DMA_Init(DMA1_Channel1, &amp;DMA_InitStructure); //‚Ä¶ //,  LCDBeginRAMWrite(); DMA_SetCurrDataCounter(DMA1_Channel1, PLASMA_WIDTH*PLASMA_HEIGHT); DMA_Cmd(DMA1_Channel1, ENABLE); }</span></span></code> </pre> <br>  After the last line is completed, the control is returned to the program, so you can immediately begin the calculation of the next frame while the first one is output via DMA. <br></li><li>  A micro-SD slot connected to the control pins of the SDMO STM controller.  The situation is the same as with the display - we have a fast and convenient way to communicate with the memory card, much faster than SPI. </li><li>  USB connector and accompanying schematics.  As you know, USB host determines the presence of a device on the bus on the pull-up resistor.  Accordingly, in order to be able to perform any actions first and only then give a signal to the host ‚ÄúI am connected!‚Äù You need to connect a pull-up resistor through a transistor switch <br>  On the board, this has already been done for us, the control transistor is connected to one of the GPIO pins, the pull-up resistors are tuned to Full-Speed ‚Äã‚ÄãUSB. </li><li>  Unused pins are placed on a two-row forty-kopeck connector, the second connector is a display connector, the third is a connector for a programmer, J-Link compatible. </li><li>  Of nice bonuses - the board also has a connector for a battery that powers the RTC, a two-meter SPI flash drive, one controlled LED, one button, a good stabilizer for USB power and a max232 converter, along with a connector for a com-port. <br>  The latter, of course, in my opinion is the most superfluous part in the entire board, only occupying space, but okay, so be it. </li></ol><br>  In addition, at a separate request, for $ 28, the seller will attach a J-Link-compatible programmer to the board (or, simply, a real Segger J-Link clone, shamelessly masquerading under it), with a cable that is fully compatible with the connector on the board. <br>  Summarizing the above, I consider this board a thing of first necessity for a person who decided to start studying STM32F1xx microcontrollers. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h4>  Soft </h4><br>  Now for the IDE.  Initially, I chose Keil uVision, as I once worked with it. <br>  Well, what can I say - I worked in Keila enough, and in principle you can reconcile with him.  But, hand on heart - it is terrible there.  It is also terrible as the idea of ‚Äã‚ÄãIAR'a, in my opinion. <br>  IAR and Keil are recognized leaders in the development of compilers, they can‚Äôt take this from them, but I still cannot understand why, having such compilers, they continue to pull their IDEs, which are stuck in convenience at the 2002 level.  As an example I can cite Texas Instruments - they also had their own IDE before, in the appendage to the compiler.  Then they got tired of it, they took Eclipse, finished it, screwed it to their compiler and profiler, and got a great product.  Why Keil and IAR will not do this for me remains a mystery, but in my opinion their IDEs are not as convenient as they could be.  Irritating is not very convenient syntax highlighting, the complete absence of code-completion, not the most convenient code navigation.  Plus, uVision often fell at me, but this can be attributed to the programmer driver. <br>  Anyway, I began to look for an alternative and found it in the form of <a href="http://www.coocox.org/CooCox_CoIDE.htm">CooCox IDE</a> . <br><br><img src="http://www.coocox.org/images/CoBuilder/builder_full_1.png" alt="image"><br><br>  This is a free Eclipse-based development environment, which is designed, of course, to work with GCC. <br>  Of the advantages, I would like to note all the advantages of the Eclipse - easy navigation, there is code completion, etc. <br>  In addition, a convenient processor peripheral viewer is bolted, I liked it more than Kaylovsky.  It is very convenient to have a repository of components - simply speaking, when starting a project, we, as a wizard, select the processor we need from the list, and then tick the ones from the Standard Peripheral Library modules that we would like to use, and they automatically connect to the project (About a little more in the next section of the article).  You can also immediately see the examples included with this SPL module and help with its functions. <br>  CooCox IDE also absorbed the minuses from Eclipse, which is heavy - it consumes about 180 meters of RAM from me, occupying 800 megabytes of disk space. <br>  Another disadvantage is her work with this very J-Link-com.  Debugging takes place through an application from the creators of J-Link, which provides a standard gdb interface, but for some reason the environment restarts at each debug, unlike the same keil (which works through its own dlls). <br>  Therefore, the start of debugging in Kayla begins in a second, but in CooCox, in about 20 seconds. Perhaps this can be somehow corrected by settings, but I haven‚Äôt seen such settings yet, so I will be grateful if someone tells me. <br>  Nevertheless, I still stopped at CooCox - if you are also not satisfied with the IDE from Keil or IAR, or you do not want to use broken software and prefer open source - download it without thinking. <br><br><h4>  CooCox and FreeRTOS </h4><br>  Much has been said about the FreeRTOS operating system, in particular, in Habr√© (for example, one of the articles: <a href="http://habrahabr.ru/blogs/controllers/129105/">FreeRTOS: introduction</a> ) <br>  I also decided to join this technology and expand my arsenal of tools, especially since FreeRTOS does not impose any HAL (Hardware Abstraction Layer, hardware abstraction layer, drivers, that is), and provides only tools for working with tasks, synchronization and inter-process interaction, so in many cases will be very convenient. <br>  Let's take a closer look at what we need to use FreeRTOS with CooCox IDE on our Mini-STM32 board. <br>  In fact, everything is very simple.  Architectural porting (porting the code required by the scheduler for the Cortex M3 architecture) has long been done, and we need to, in fact, just make the right project for CooCox. <br>  We start by downloading the FreeRTOS sources from their official website. <br>  Here is the direct link: <a href="http://sourceforge.net/projects/freertos/files/">http://sourceforge.net/projects/freertos/files/</a> . <br>  In the meantime, we are creating a new project in CooCox, I called it FreeRTOS-Mini. <br><br><img src="https://habrastorage.org/storage2/ef9/a4a/90a/ef9a4a90aaf6a20f7dfbf25cb95a510b.jpg"><br><br>  We select the manufacturer ST in the wizard, in the list of chips - the chip on which the debug board is built, STM32F103VE. <br><br><img src="https://habrastorage.org/storage2/26f/8ea/788/26f8ea788fd2e5146cd187bf75f2e459.jpg"><br><br><img src="https://habrastorage.org/storage2/366/8a9/293/3668a9293f5d310c8b0d89ac42a10ea9.jpg"><br><br>  After this, we already see the already mentioned window of the repository of components that are parts of the SPL. <br><br><img src="https://habrastorage.org/storage2/aca/0ee/0db/aca0ee0db321778bb0e7be2bbf3bb660.jpg"><br><br>  There we select CMSIS Core and CMSIS Boot - this is the actual CMSIS kernel and the start code, which sets up and pulls the main () <br>  By the way, pay attention - in CooCox, the start code is written entirely in C, not a single asm line.  It lies in the file <b>cmsis_boot \ startup \ startup_stm32f10x_hd.c</b> - remember this way, we will need to correct something there.  At the same time, we add a GPIO module to the project, so that there is something to do in the FreeRTOS test task.  This module automatically pulls the dependent RCC responsible for setting up clocks. <br>  Now we return to the downloaded source codes of FreeRTOS.  To begin, copy the entire folder to the folder with our project.  After, we will start to delete the excess.  So, personally, under my knife, the contents of the Demo folder went right away - there are demo applications for different controllers, you don‚Äôt need the entire folder in any case, but if you want, you can leave what applies to STM32F103.  The only thing that we definitely need from there is the FreeRTOS kernel settings file, which can be taken from any suitable project, let's say from here: <b>Demo \ CORTEX_STM32F103_Primer_GCC \ FreeRTOSConfig.h</b> <br>  It can be copied to any folder of the desktop, I personally put it at the very root of the project, next to <b>main.c</b> <br>  Further, in the <b>source \ portable</b> folder there are a lot of sub-folders, where the code for different compilers and environments lies.  Go to the folder <b>source \ portable \ GCC \ ARM_CM3</b> , copy it two levels higher, in <b>source \ portable</b> .  Pay attention to the folder <b>source \ portable \ MemMang</b> - we also need it.  Therefore, we delete everything except <b>source \ portable \ MemMang</b> and <b>fresh</b> <b>source \ portable \ ARM_CM3</b> <br>  After that, right-click in the CooCox search explorer, click Add Linked Folder and add our folder with the prepared FreeRTOS sources.  As a result, you should get this project tree: <br><br><img src="https://habrastorage.org/storage2/95e/e8d/cd8/95ee8dcd865f259883b280eb86d2cd1f.jpg"><br><br>  Now we start to edit the project files.  Let's start with the kernel settings.  From there, we will need to remove only a couple of lines related to the old project - the left, unnecessary us. <br><br><pre> <code class="hljs cpp"><span class="hljs-comment"><span class="hljs-comment">/* Library includes. */</span></span> <span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"stm32f10x_lib.h"</span></span></span></span></code> </pre><br>  Everything else can be left unchanged, but you can read an article about configuring the FreeRTOS kernel and change the options as needed, we are not going to do that now. <br>  Now we go to the startup code ( <b>cmsis_boot \ startup \ startup_stm32f10x_hd.c</b> ) and do the following: we find the lines: <br><br><pre> <code class="hljs cs"><span class="hljs-comment"><span class="hljs-comment">/*----------Function prototypes-----------------------------------------------*/</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">extern</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">main</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">void</span></span></span></span></span><span class="hljs-function">)</span></span>; <span class="hljs-comment"><span class="hljs-comment">/*!&lt; The entry point for the application. */</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">extern</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">SystemInit</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">void</span></span></span></span></span><span class="hljs-function">)</span></span>; <span class="hljs-comment"><span class="hljs-comment">/*!&lt; Setup the microcontroller system(CMSIS) */</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Default_Reset_Handler</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">void</span></span></span></span></span><span class="hljs-function">)</span></span>; <span class="hljs-comment"><span class="hljs-comment">/*!&lt; Default reset handler */</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Default_Handler</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">void</span></span></span></span></span><span class="hljs-function">)</span></span>; <span class="hljs-comment"><span class="hljs-comment">/*!&lt; Default exception handler */</span></span></code> </pre><br>  I have lines 114-122, and add the following code after them: <br><br><pre> <code class="hljs cs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">extern</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">xPortPendSVHandler</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">void</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span></span><span class="hljs-function">) __</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">attribute__</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">( naked </span></span></span><span class="hljs-function">))</span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">extern</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">xPortSysTickHandler</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">void</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span></span><span class="hljs-function">)</span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">extern</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">vPortSVCHandler</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">void</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span></span><span class="hljs-function">) __</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">attribute__</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">( naked </span></span></span><span class="hljs-function">))</span></span>;</code> </pre><br>  These are interrupt handlers from the OS kernel, which are declared in the port.c. file.  Now we need to stuff them into the interrupt vector that comes below (lines 129-209): <br><br><pre> <code class="hljs objectivec">__attribute__ ((section(<span class="hljs-string"><span class="hljs-string">".isr_vector"</span></span>))) <span class="hljs-keyword"><span class="hljs-keyword">void</span></span> (* <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> g_pfnVectors[])(<span class="hljs-keyword"><span class="hljs-keyword">void</span></span>) = { <span class="hljs-comment"><span class="hljs-comment">/*----------Core Exceptions-------------------------------------------------*/</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">void</span></span> *)&amp;pulStack[STACK_SIZE<span class="hljs-number"><span class="hljs-number">-1</span></span>], <span class="hljs-comment"><span class="hljs-comment">/*!&lt; The initial stack pointer */</span></span> Reset_Handler, <span class="hljs-comment"><span class="hljs-comment">/*!&lt; Reset Handler */</span></span> NMI_Handler, <span class="hljs-comment"><span class="hljs-comment">/*!&lt; NMI Handler */</span></span> HardFault_Handler, <span class="hljs-comment"><span class="hljs-comment">/*!&lt; Hard Fault Handler */</span></span> MemManage_Handler, <span class="hljs-comment"><span class="hljs-comment">/*!&lt; MPU Fault Handler */</span></span> BusFault_Handler, <span class="hljs-comment"><span class="hljs-comment">/*!&lt; Bus Fault Handler */</span></span> UsageFault_Handler, <span class="hljs-comment"><span class="hljs-comment">/*!&lt; Usage Fault Handler */</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>,<span class="hljs-number"><span class="hljs-number">0</span></span>,<span class="hljs-number"><span class="hljs-number">0</span></span>,<span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-comment"><span class="hljs-comment">/*!&lt; Reserved */</span></span> vPortSVCHandler, <span class="hljs-comment"><span class="hljs-comment">/*!&lt; SVCall Handler */</span></span> DebugMon_Handler, <span class="hljs-comment"><span class="hljs-comment">/*!&lt; Debug Monitor Handler */</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-comment"><span class="hljs-comment">/*!&lt; Reserved */</span></span> xPortPendSVHandler, <span class="hljs-comment"><span class="hljs-comment">/*!&lt; PendSV Handler */</span></span> xPortSysTickHandler, <span class="hljs-comment"><span class="hljs-comment">/*!&lt; SysTick Handler */</span></span></code> </pre><br>  Accordingly, we change the vector as written in the above code, replacing the lines marked <i>SVCall Handler</i> , <i>PendSV Handler</i> , <i>SysTick Handler</i> with <i>vPortSVCHandler</i> , <i>xPortPendSVHandler</i> and <i>xPortSysTickHandler,</i> respectively. <br><br>  <b>UPD:</b> <br>  <i>In the comments I was prompted by a more elegant option than picking the starting file.</i>  <i>It is enough just to override handlers with the following defines:</i> <br><br><pre> <code class="hljs cs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> vPortSVCHandler SVC_Handler #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> xPortPendSVHandler PendSV_Handler #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> vPortSVCHandler SVC_Handler #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> xPortSysTickHandler SysTick_Handler</span></span></code> </pre><br><br>  After that, open the <b>Source \ MemMang</b> folder in the project tree, and select the implementation of the management <b>memory</b> that suits us.  Read more about it here: <a href="http://www.freertos.org/a00111.html">FreeRTOS Memory Management</a> . <br>  In short, file number 1 is a simplified implementation with memory allocation, but without release, file number 2 is a more advanced implementation that allows memory release, and number 3 is an implementation that will require a library with implemented malloc and free.  I chose the second implementation, excluding the remaining two files from the compilation by right-clicking on the file name in the project tree and selecting <i>Exclude from build</i> . <br>  It remains quite a bit - open the file main.c, add the necessary SPL files we need there: <br><br><pre> <code class="hljs cpp"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"stm32f10x.h"</span></span></span><span class="hljs-meta"> #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"stm32f10x_gpio.h"</span></span></span><span class="hljs-meta"> #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"stm32f10x_rcc.h"</span></span></span></span></code> </pre><br>  Includes from FreeRTOS: <br><br><pre> <code class="hljs cpp"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"FreeRTOS.h"</span></span></span><span class="hljs-meta"> #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"task.h"</span></span></span><span class="hljs-meta"> #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"queue.h"</span></span></span></span></code> </pre><br>  After declaring the function that will be called before the start of the scheduler, in accordance with the recommendations in this form: <br><br><pre> <code class="hljs cs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">prvSetupHardware</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">void</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span></span><span class="hljs-function">)</span></span>;</code> </pre><br>  And the function that will play the role of our test task, like this: <br><br><pre> <code class="hljs cs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">prvLedBlink</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">void</span></span></span></span><span class="hljs-function"><span class="hljs-params"> *pvParameters </span></span></span><span class="hljs-function">)</span></span>;</code> </pre><br>  The implementation of functions looks like this: <br><br><pre> <code class="hljs cs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">prvSetupHardware</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { GPIO_InitTypeDef GPIO_InitStructure; RCC_APB2PeriphClockCmd(RCC_APB2Periph_GPIOB, ENABLE); GPIO_InitStructure.GPIO_Pin = GPIO_Pin_5; GPIO_InitStructure.GPIO_Mode = GPIO_Mode_Out_PP; GPIO_InitStructure.GPIO_Speed = GPIO_Speed_50MHz; GPIO_Init(GPIOB, &amp;GPIO_InitStructure); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">prvLedBlink</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">void</span></span></span></span><span class="hljs-function"><span class="hljs-params"> *pvParameters </span></span></span><span class="hljs-function">)</span></span> { GPIO_SetBits(GPIOB,GPIO_Pin_5); <span class="hljs-keyword"><span class="hljs-keyword">while</span></span>(<span class="hljs-number"><span class="hljs-number">1</span></span>); }</code> </pre><br>  For testing purposes, I did not write anything useful, the task just lights the LED on the board. <br>  The main () function itself remains, which will start the task and the scheduler: <br><br><pre> <code class="hljs cpp"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">main</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">void</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> </span></span>{ prvSetupHardware(); xTaskCreate(prvLedBlink,(<span class="hljs-keyword"><span class="hljs-keyword">signed</span></span> <span class="hljs-keyword"><span class="hljs-keyword">char</span></span>*)<span class="hljs-string"><span class="hljs-string">"LED"</span></span>,configMINIMAL_STACK_SIZE, <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, tskIDLE_PRIORITY + <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>); <span class="hljs-comment"><span class="hljs-comment">/* Start the scheduler. */</span></span> vTaskStartScheduler(); <span class="hljs-keyword"><span class="hljs-keyword">while</span></span>(<span class="hljs-number"><span class="hljs-number">1</span></span>); }</code> </pre><br>  That's basically it.  It remains to configure debugging - for this, click ‚ÄúDebug configuration‚Äù, in the Debugger tab, select our programmer (J-Link) and the JTAG port. <br>  We tick the Run To Main checkbox in order not to wallow in the startup code, in the GDBServer cmdline tool line we specify the path to the executable with the programmer (you can download it from the <a href="http://www.segger.com/jlink.html">Segger</a> website), I have <b>C: \ SEGGER \ JLinkARM_V440b \ JLinkGDBServerCL.exe</b> <br>  After we press Apply and Close. <br>  Now we compile our project and click on debug - if everything worked out, after the aplode and execution, the LED should light up. <br><br><h4>  Conclusion </h4><br><br>  The right choice of developer tools will certainly ensure the most rapid and comfortable mastering of new technologies.  I hope that by highlighting the Mini-STM32 and CooCox IDE debug board in this article, I helped the developers to look at the new tool.  As for the operating system, FreeRTOS is undoubtedly a very powerful tool, and, in my opinion, a good step to move from programming the firmware head-on to the use of operational systems. <br><br><h4>  Links </h4><br>  <a href="http://www.ebay.com/itm/280580644330">An eBay page where you can buy a debug board</a> <br>  <a href="http://www.coocox.org/">CooCox official website</a> <br>  <a href="http://www.freertos.org/">FreeRTOS official website</a> <br>  <a href="http://microsin.net/programming/ARM/freertos-part1.html">Russian manual on FreeRTOS</a> </div><p>Source: <a href="https://habr.com/ru/post/139601/">https://habr.com/ru/post/139601/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../139593/index.html">Writing a driver for a homemade USB device</a></li>
<li><a href="../139594/index.html">Cebit 2012. Day Two - Blackberry, Archos, MSI, Gigabyte</a></li>
<li><a href="../139596/index.html">Workshop on using Schuhart control charts</a></li>
<li><a href="../139597/index.html">Published a stop list of zones. RF and .RU</a></li>
<li><a href="../139598/index.html">Apple event March 7, 2012 - New iPad and new Apple TV, iOS 5.1, iPhoto</a></li>
<li><a href="../139603/index.html">Congratulations! We are all under the hood</a></li>
<li><a href="../139604/index.html">Tracking user‚Äôs browser and OS settings as a measure to prevent account hijacking (updated)</a></li>
<li><a href="../139606/index.html">iOS 5.1 available for download</a></li>
<li><a href="../139607/index.html">Insert the code generator into the qmake assembly</a></li>
<li><a href="../139611/index.html">The company Carl Zeiss has released "virtual" glasses</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>