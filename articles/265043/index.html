<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Backup ESXi virtual machines with ghettoVCB scripts</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="In this article, I will step by step describe the setup of automatic backups and an example of restoring virtual machines running on an ESX (i) platfo...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Backup ESXi virtual machines with ghettoVCB scripts</h1><div class="post__text post__text-html js-mediator-article">  In this article, I will step by step describe the setup of automatic backups and an example of restoring virtual machines running on an ESX (i) platform using free <a href="https://github.com/lamw/ghettoVCB" title="https://github.com/lamw/ghettoVCB">ghettoVCB</a> scripts.  I will focus on the version of ESXi 5.x, but these tools also work on versions 3.5-6.x, although for earlier versions the settings are somewhat different.  Backup will be made on the NFS server.  A report on the work will be sent to the mail.  During the backup, a snapshot (snapshot) of the virtual machine (including the running one) is taken, the VMDK disks of the machine are saved and the snapshot is deleted. <br>  The ghettoVCB project is well documented, but in the process of implementation there were some nuances that resulted in this instruction.  I hope this article will be useful for novice administrators. <br><br><a name="habracut"></a><br><br><ol><li>  <a href="https://habr.com/ru/post/265043/">Backup Setup</a> </li><li>  <a href="https://habr.com/ru/post/265043/">Save ESXi server configuration</a> </li><li>  <a href="https://habr.com/ru/post/265043/">Restoring a machine from a backup</a> </li><li>  <a href="https://habr.com/ru/post/265043/">Links</a> </li></ol>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h4>  Backup Setup </h4><br>  First of all, prepare an NFS server to your taste, where backups will be made.  In my case, this is FreeNAS (Freebsd 9.3) and ZFS dataset with deduplication and compression enabled, which saves space.  Configuration on an ESXi server is done over SSH from the <b>root user</b> .  It is possible and under another user with administrative rights, but then you will not be able to run scripts to check from the console.  Let's get started <br><br>  1. To configure, you need access to the server via SSH, enable via vSphere client: <br><pre><code class="bash hljs">Configuration -&gt; security profile -&gt; properties -&gt; SSH</code> </pre> <br><br>  2. Take the scripts from the <a href="https://github.com/lamw/ghettoVC" title="https://github.com/lamw/ghettoVC">github repository</a> and put the content on the server.  Be sure to set the performance bit, otherwise the scripts will not work: <br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># chmod u+x /ghettoVCB-master/ghettoVCB.sh # chmod u+x /ghettoVCB-master/ghettoVCB-restore.sh</span></span></code> </pre><br><br>  3. We will back up once a week, with a cycle of 4 weeks.  Overdue backups will be deleted.  Register the corresponding config file: <br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># cat /ghettoVCB-master/4week.conf VM_BACKUP_VOLUME=/vmfs/volumes/backup DISK_BACKUP_FORMAT=thin #   VM_BACKUP_ROTATION_COUNT=4 POWER_VM_DOWN_BEFORE_BACKUP=0 ENABLE_HARD_POWER_OFF=0 ITER_TO_WAIT_SHUTDOWN=3 POWER_DOWN_TIMEOUT=5 ENABLE_COMPRESSION=0 ALLOW_VMS_WITH_SNAPSHOTS_TO_BE_BACKEDUP=0 ENABLE_NON_PERSISTENT_NFS=1 UNMOUNT_NFS=1 # NFS ,     NFS_SERVER=10.1.3.101 NFS_MOUNT=/mnt/backup/vmware NFS_LOCAL_NAME=backup #   NFS  (  ESXi ) NFS_VM_BACKUP_DIR=autobackup/vm01 SNAPSHOT_TIMEOUT=15 #    EMAIL_LOG=1 EMAIL_SERVER=mail.core.local EMAIL_SERVER_PORT=25 EMAIL_DELAY_INTERVAL=1 EMAIL_TO=admins@mail.local EMAIL_FROM=ghettoVCB@vm01.core.local WORKDIR_DEBUG=0 VM_SHUTDOWN_ORDER= VM_STARTUP_ORDER=</span></span></code> </pre>  Where are the key parameters: <br><ul><li>  VM_BACKUP_VOLUME - path on the ESXi server where the nfs partition will be mounted; </li><li>  DISK_BACKUP_FORMAT = thin - VMDK disk format, which will be created during backup; </li><li>  VM_BACKUP_ROTATION_COUNT - the number of stored backups; </li><li>  POWER_VM_DOWN_BEFORE_BACKUP = 0 - do not turn off the machine before backup; </li><li>  ENABLE_COMPRESSION = 0 - do not press the data, leave it at zfs; </li><li>  ALLOW_VMS_WITH_SNAPSHOTS_TO_BE_BACKEDUP = 0 - backup machines with snapshots (the latest versions of scripts can do this, but we don‚Äôt need it); </li><li>  ENABLE_NON_PERSISTENT_NFS = 1 - the nfs drive will connect only for the duration of the backup; </li><li>  UNMOUNT_NFS = 1 - and then disconnect; </li><li>  NFS_SERVER and NFS_MOUNT - coordinates of the nfs disk; </li><li>  NFS_LOCAL_NAME - the name that will be assigned to the connected array (datastores identification); </li><li>  NFS_VM_BACKUP_DIR - the path where the copies will be added (relative to VM_BACKUP_VOLUME); </li><li>  EMAIL_LOG = 1 - enable mailing of the report; </li><li>  EMAIL_ * - mail settings. </li></ul><br>  If on the ESXi server there is already a connected nfs disk with the same coordinates (server / path), then the disk will not connect. <br><br>  The letter body is formed while the script is running, and then sent by the <b><code>nc</code></b> utility.  This may cause a failure on the part of the mail server, with the argument " <code>Recipient address rejected: Improper use of SMTP command pipelining</code> ".  It is necessary to exclude the corresponding check for ESXi servers (for postfix, this will be <b><code>reject_unauth_pipelining</code></b> ). <br><br>  4. Create a list of machines that need to be backed up.  You can get it using the <code>esxcli vm process list</code> command.  Each line of the list is one machine: <br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># cat /ghettoVCB-master/week.list win7 win10 vCenterUpdate</span></span></code> </pre>  If you need several backup plans, with different frequency and parameters, create the necessary number of configurations. <br><br>  5. We configure <b>cron</b> to perform a periodic task: <br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># cat /var/spool/cron/crontabs/root #min hour day mon dow command #‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶. 3 18 * * 6 /ghettoVCB-master/ghettoVCB.sh -g /ghettoVCB-master/4week.conf -f /ghettoVCB-master/week.list &gt; /var/log/ghettoVCB-backup-week-$((($(date +\%d)-1)/7+1)).log</span></span></code> </pre><br>  The system time is in UTC, so you need to make a correction for the current time zone.  In my case, +7 hours - the backup will start on Sunday at 1 am.  Logs must be written (or forwarded to / dev / null), otherwise the script may hang when the buffer for the user is overflowed.  The construction of <code>$((($(date +\%d)-1)/7+1))</code> gives the number of the week in the month, so we do not accumulate garbage. <br><br>  6. Restart <b>cron</b> : <br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># kill $(cat /var/run/crond.pid) # crond</span></span></code> </pre><br><br>  7. To send mail, you need to add permission for outgoing traffic in the ESXi server firewall: <br><ul><li>  create customization file with contents: <br><pre> <code class="xml hljs"># cat /etc/vmware/firewall/email.xml <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">ConfigRoot</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">service</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">id</span></span></span><span class="hljs-tag">&gt;</span></span>email<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">id</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">rule</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">id</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"0000"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">direction</span></span></span><span class="hljs-tag">&gt;</span></span>outbound<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">direction</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">protocol</span></span></span><span class="hljs-tag">&gt;</span></span>tcp<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">protocol</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">porttype</span></span></span><span class="hljs-tag">&gt;</span></span>dst<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">porttype</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">port</span></span></span><span class="hljs-tag">&gt;</span></span>25<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">port</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">rule</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">enabled</span></span></span><span class="hljs-tag">&gt;</span></span>true<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">enabled</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">required</span></span></span><span class="hljs-tag">&gt;</span></span>false<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">required</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">service</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">ConfigRoot</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre><br></li><li>  reread firewall rules check: <br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># esxcli network firewall refresh # esxcli network firewall ruleset list | grep email email true # nc mail.core.local 25 220 mail.core.local SMTP Postfix quit 221 2.0.0 Bye</span></span></code> </pre><br></li></ul><br><br>  You can run a test check for the backup of the machine named ‚ÄúvCenterUpdate‚Äù as follows: <br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># /ghettoVCB-master/ghettoVCB.sh -g /ghettoVCB-master/4week.conf -d dryrun -m vCenterUpdate</span></span></code> </pre><div class="spoiler">  <b class="spoiler_title">Conclusion:</b> <div class="spoiler_text"><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># /ghettoVCB-master/ghettoVCB.sh -g /ghettoVCB-master/4week.conf -d dryrun -m vCenterUpdate Logging output to "/tmp/ghettoVCB-2015-08-18_07-15-08-23516502.log" ... 2015-08-18 07:15:09 -- info: ============================== ghettoVCB LOG START ============================== 2015-08-18 07:15:09 -- info: CONFIG - USING GLOBAL GHETTOVCB CONFIGURATION FILE = /ghettoVCB-master/4week.conf 2015-08-18 07:15:09 -- info: CONFIG - VERSION = 2015_05_06_1 2015-08-18 07:15:09 -- info: CONFIG - GHETTOVCB_PID = 23516502 2015-08-18 07:15:09 -- info: CONFIG - VM_BACKUP_VOLUME = /vmfs/volumes/backup/autobackup/vm01 2015-08-18 07:15:09 -- info: CONFIG - ENABLE_NON_PERSISTENT_NFS = 1 2015-08-18 07:15:09 -- info: CONFIG - UNMOUNT_NFS = 1 2015-08-18 07:15:09 -- info: CONFIG - NFS_SERVER = 10.1.3.101 2015-08-18 07:15:09 -- info: CONFIG - NFS_VERSION = nfs 2015-08-18 07:15:09 -- info: CONFIG - NFS_MOUNT = /mnt/backup/vmware 2015-08-18 07:15:09 -- info: CONFIG - VM_BACKUP_ROTATION_COUNT = 4 2015-08-18 07:15:09 -- info: CONFIG - VM_BACKUP_DIR_NAMING_CONVENTION = 2015-08-18_07-15-08 2015-08-18 07:15:09 -- info: CONFIG - DISK_BACKUP_FORMAT = thin 2015-08-18 07:15:09 -- info: CONFIG - POWER_VM_DOWN_BEFORE_BACKUP = 0 2015-08-18 07:15:09 -- info: CONFIG - ENABLE_HARD_POWER_OFF = 0 2015-08-18 07:15:09 -- info: CONFIG - ITER_TO_WAIT_SHUTDOWN = 3 2015-08-18 07:15:09 -- info: CONFIG - POWER_DOWN_TIMEOUT = 5 2015-08-18 07:15:09 -- info: CONFIG - SNAPSHOT_TIMEOUT = 15 2015-08-18 07:15:09 -- info: CONFIG - LOG_LEVEL = dryrun 2015-08-18 07:15:09 -- info: CONFIG - BACKUP_LOG_OUTPUT = /tmp/ghettoVCB-2015-08-18_07-15-08-23516502.log 2015-08-18 07:15:09 -- info: CONFIG - ENABLE_COMPRESSION = 0 2015-08-18 07:15:09 -- info: CONFIG - VM_SNAPSHOT_MEMORY = 0 2015-08-18 07:15:09 -- info: CONFIG - VM_SNAPSHOT_QUIESCE = 0 2015-08-18 07:15:09 -- info: CONFIG - ALLOW_VMS_WITH_SNAPSHOTS_TO_BE_BACKEDUP = 0 2015-08-18 07:15:09 -- info: CONFIG - VMDK_FILES_TO_BACKUP = all 2015-08-18 07:15:09 -- info: CONFIG - VM_SHUTDOWN_ORDER = 2015-08-18 07:15:09 -- info: CONFIG - VM_STARTUP_ORDER = 2015-08-18 07:15:09 -- info: CONFIG - RSYNC_LINK = 0 2015-08-18 07:15:09 -- info: CONFIG - EMAIL_LOG = 1 2015-08-18 07:15:09 -- info: CONFIG - EMAIL_SERVER = mail.core.local 2015-08-18 07:15:09 -- info: CONFIG - EMAIL_SERVER_PORT = 25 2015-08-18 07:15:09 -- info: CONFIG - EMAIL_DELAY_INTERVAL = 2 2015-08-18 07:15:09 -- info: CONFIG - EMAIL_FROM = ghettoVCB@vm02.core.local 2015-08-18 07:15:09 -- info: CONFIG - EMAIL_TO = admins@mail.local 2015-08-18 07:15:09 -- info: CONFIG - WORKDIR_DEBUG = 0 2015-08-18 07:15:09 -- info: 2015-08-18 07:15:10 -- dryrun: ############################################### 2015-08-18 07:15:10 -- dryrun: Virtual Machine: vCenterUpdate 2015-08-18 07:15:10 -- dryrun: VM_ID: 588 2015-08-18 07:15:10 -- dryrun: VMX_PATH: /vmfs/volumes/ds3524_ds/vCenterUpdate/vCenterUpdate.vmx 2015-08-18 07:15:10 -- dryrun: VMX_DIR: /vmfs/volumes/ds3524_ds/vCenterUpdate 2015-08-18 07:15:10 -- dryrun: VMX_CONF: vCenterUpdate/vCenterUpdate.vmx 2015-08-18 07:15:10 -- dryrun: VMFS_VOLUME: ds3524_ds 2015-08-18 07:15:10 -- dryrun: VMDK(s): 2015-08-18 07:15:10 -- dryrun: vCenterUpdate.vmdk 40 GB 2015-08-18 07:15:10 -- dryrun: INDEPENDENT VMDK(s): 2015-08-18 07:15:10 -- dryrun: TOTAL_VM_SIZE_TO_BACKUP: 40 GB 2015-08-18 07:15:10 -- dryrun: ############################################### 2015-08-18 07:15:10 -- info: ###### Final status: OK, only a dryrun. ###### 2015-08-18 07:15:10 -- info: ============================== ghettoVCB LOG END ================================</span></span></code> </pre><br></div></div><br><br>  Run manually for the list of machines: <br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># /ghettoVCB-master/ghettoVCB.sh -g /ghettoVCB-master/4week.conf -f /ghettoVCB-master/week.list</span></span></code> </pre><br>  Each copy of the machines will be stored in directories, like: <br><pre> <code class="bash hljs">autobackup/vm01/VMNAME/VMNAME-FULL_DATE/</code> </pre><br>  And be a machine disk in <b>* .vmdk</b> format and a machine configuration file <b>* .vmx</b> . <br><br><h4>  Save ESXi server configuration </h4><br>  The ESXi settings made above will live until the first reboot.  To save the configuration you need to do a number of actions. <br><br>  1. Add commands to change the cron settings to the boot script: <br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># cat /etc/rc.local.d/local.sh #................... /bin/kill $(cat /var/run/crond.pid) /bin/echo "3 18 * * 6 /ghettoVCB-master/ghettoVCB.sh -g /ghettoVCB-master/4week.conf -f /ghettoVCB-master/week.list &gt; /var/log/ghettoVCB-backup-week-$((($(date +\%d)-1)/7+1)).log" &gt;&gt; /var/spool/cron/crontabs/root /bin/busybox crond</span></span></code> </pre><br><br>  2. To save the firewall settings, let's create our own VIB package and install it on the server.  For this we use the utility <a href="https://labs.vmware.com/flings/vib-author" title="https://labs.vmware.com/flings/vib-author">VIB Author</a> .  Unfortunately, it is only for 32-bit architecture, so I had to use the lxc container.  When installing it can scary to swear on the dependency type: <br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># rpm -ivh vmware-esx-vib-author-5.0.0-0.0.847598.i386.rpm error: Failed dependencies: libc.so.6()(64bit) is needed by vmware-esx-vib-author-5.0.0-0.0.847598.i386 libc.so.6(GLIBC_2.2.5)(64bit) is needed by vmware-esx-vib-author-5.0.0-0.0.847598.i386 libc.so.6(GLIBC_2.3)(64bit) is needed by vmware-esx-vib-author-5.0.0-0.0.847598.i386 libc.so.6(GLIBC_2.4)(64bit) is needed by vmware-esx-vib-author-5.0.0-0.0.847598.i386 libdl.so.2()(64bit) is needed by vmware-esx-vib-author-5.0.0-0.0.847598.i386 libdl.so.2(GLIBC_2.2.5)(64bit) is needed by vmware-esx-vib-author-5.0.0-0.0.847598.i386 libpthread.so.0()(64bit) is needed by vmware-esx-vib-author-5.0.0-0.0.847598.i386 libpthread.so.0(GLIBC_2.2.5)(64bit) is needed by vmware-esx-vib-author-5.0.0-0.0.847598.i386</span></span></code> </pre><br>  But it doesn't matter, and the <code>rpm --nodeps</code> key <code>rpm --nodeps</code> will save us. <br><br>  Prepare the directory tree for building the VIB package: <br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># mkdir -p stage/payloads/payload1/etc/vmware/firewall/</span></span></code> </pre><br>  And create two files.  The first is the description of our package: <br><pre> <code class="xml hljs"># cat stage/descriptor.xml <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">vib</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">version</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"5.0"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">type</span></span></span><span class="hljs-tag">&gt;</span></span>bootbank<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">type</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">name</span></span></span><span class="hljs-tag">&gt;</span></span>mailFirewall<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">name</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">version</span></span></span><span class="hljs-tag">&gt;</span></span>5.0.0-0.0.1<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">version</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">vendor</span></span></span><span class="hljs-tag">&gt;</span></span>Lelik.13a<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">vendor</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">summary</span></span></span><span class="hljs-tag">&gt;</span></span>Custom VIB from Lelik.13a<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">summary</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">description</span></span></span><span class="hljs-tag">&gt;</span></span>Adds custom firewall rule for mail sender to ESXi host<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">description</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">relationships</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">depends</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">depends</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">conflicts</span></span></span><span class="hljs-tag">/&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">replaces</span></span></span><span class="hljs-tag">/&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">provides</span></span></span><span class="hljs-tag">/&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">compatibleWith</span></span></span><span class="hljs-tag">/&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">relationships</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">software-tags</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">software-tags</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">system-requires</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">maintenance-mode</span></span></span><span class="hljs-tag">&gt;</span></span>false<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">maintenance-mode</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">system-requires</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">file-list</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">file-list</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">acceptance-level</span></span></span><span class="hljs-tag">&gt;</span></span>community<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">acceptance-level</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">live-install-allowed</span></span></span><span class="hljs-tag">&gt;</span></span>true<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">live-install-allowed</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">live-remove-allowed</span></span></span><span class="hljs-tag">&gt;</span></span>true<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">live-remove-allowed</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">cimom-restart</span></span></span><span class="hljs-tag">&gt;</span></span>false<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">cimom-restart</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">stateless-ready</span></span></span><span class="hljs-tag">&gt;</span></span>true<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">stateless-ready</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">overlay</span></span></span><span class="hljs-tag">&gt;</span></span>false<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">overlay</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">payloads</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">payload</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"payload1"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">type</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"vgz"</span></span></span><span class="hljs-tag">&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">payload</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">payloads</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">vib</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre>  Detailed instructions for the parameters can be found on the utility website. <br><br>  And the second file is email.xml, the contents of which is given above.  And it will be located on the <code>stage/payloads/payload1/etc/vmware/firewall/email.xml</code> , where the path after " <code>payload1</code> " is the desired path on the target server. <br><br>  We collect VIB package: <br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># vibauthor -C -t stage -v mailFirewall.vib</span></span></code> </pre><br><div class="spoiler">  <b class="spoiler_title">And check its contents</b> <div class="spoiler_text"><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># vibauthor -i -v mailFirewall.vib **** Info for VIB: mailFirewall.vib **** VIB Format: 2.0.0 VIB ID: Lelik.13a_bootbank_mailFirewall_5.0.0-0.0.1 VIB Type: bootbank Name: mailFirewall Version: 5.0.0-0.0.1 Vendor: Lelik.13a Summary: [Fling] Custom VIB from Lelik.13a Description: Adds custom firewall rule for mail sender to ESXi host Creation Date: 2015-08-12 09:47:07.199735+00:00 Provides: mailFirewall = 5.0.0-0.0.1 Depends: Conflicts: Replaces: mailFirewall &lt;&lt; 5.0.0-0.0.1 Software Tags: [] MaintenanceMode: remove/update: False, installation: False Signed: False AcceptanceLevel: community LiveInstallAllowed: True LiveRemoveAllowed: True CimomRestart: False StatelessReady: True Overlay: False Payloads: Name Type Boot Size Checksums payload1 vgz 0 347 sha-256 69aa821faa4ccd5a5e34e487ecf6049aa6bf55652ffffbfaae1257e40610c405 sha-1 4d77e529c8da74e82d4aa4e816bcf193e29ab8de</span></span></code> </pre><br></div></div><br>  If you need, you can use <a href="https://github.com/Lelik13a/VmWare-custom-vibs" title="https://github.com/Lelik13a/VmWare-custom-vibs">my package</a> (at your own risk). <br><br>  3. Copy our package to the ESXi server, install and check what happened: <br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># esxcli software vib install -v /tmp/mailFirewall.vib -f # esxcli software vib list | grep mail # esxcli network firewall refresh</span></span></code> </pre>  Since the package adds its files to the system, it is necessary to use the " <code>-f</code> " key. <br>  And just in case, we re-read the firewall rules. <br><br>  This way you can collect and fix other useful server settings. <br><br>  4. And finally, run a manual backup of the ESXi server settings: <br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># /sbin/auto-backup.sh</span></span></code> </pre><br><br><h4>  Restoring a machine from a backup </h4><br>  At once it is necessary to take into account that the machine, which was backed up for hot, after recovery will be like after crash - data loss inside the machine is possible. <br><br>  1. We connect the storage with backup to the target ESXi server via NFS, or simply copy the data via ssh. <br><br>  2. Create a configuration file ‚Äúvms_to_restore‚Äù of the following type: <br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># cat /ghettoVCB-master/vms_to_restore #"&lt;DIRECTORY or .TGZ&gt;;&lt;DATASTORE_TO_RESTORE_TO&gt;;&lt;DISK_FORMAT_TO_RESTORE&gt;" # DISK_FORMATS # 1 = zeroedthick # 2 = 2gbsparse # 3 = thin # 4 = eagerzeroedthick # eg "/vmfs/volumes/restore/autobackup/vm01/vCenterUpdate/vCenterUpdate-2015-08-13_07-55-50/;/vmfs/volumes/local_vm01/;3;vCenterUpdate-restore"</span></span></code> </pre>  Where in order through " <b>;</b> ": <br><ul><li>  the path where the restored machine lies; </li><li>  the path to restore the machine (the directory for it will be created); </li><li>  disk type of the recovery machine; </li><li>  new car name (optional). </li></ul><br><br>  3. Run the test run: <br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># /ghettoVCB-master/ghettoVCB-restore.sh -c /ghettoVCB-master/vms_to_restore -d 1</span></span></code> </pre><br>  And combat: <br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># /ghettoVCB-master/ghettoVCB-restore.sh -c /ghettoVCB-master/vms_to_restore -l /var/log/vms-restore.log ################## Restoring VM: vCenterUpdate-restore ##################### Start time: Fri Aug 14 06:05:06 UTC 2015 Restoring VM from: "/vmfs/volumes/restore/autobackup/vm01/vCenterUpdate/vCenterUpdate-2015-08-13_07-55-50/" Restoring VM to Datastore: "/vmfs/volumes/local_vm01/" using Disk Format: "thin" Creating VM directory: "/vmfs/volumes/local_vm01//vCenterUpdate-restore" ... Copying "vCenterUpdate.vmx" file ... Restoring VM's VMDK(s) ... Updating VMDK entry in "vCenterUpdate-restore.vmx" file ... Destination disk format: VMFS thin-provisioned Cloning disk '/vmfs/volumes/restore/autobackup/vm01/vCenterUpdate/vCenterUpdate-2015-08-13_07-55-50//vCenterUpdate.vmdk'... Clone: 100% done. Registering vCenterUpdate-restore ... 12 End time: Fri Aug 14 06:11:19 UTC 2015</span></span></code> </pre><br>  4. We are happy. <br><br>  The second option.  Since the backup is a dump of a machine with a configuration file, you can simply: <br><br>  1. Copy it somewhere on the ESXi server. <br><br>  2. Correct the machine configuration file (* .vmx) by changing the name and location fields of the machine disk: <br><pre> <code class="bash hljs">displayName = vCenterUpdate-restore extendedConfigFile = <span class="hljs-string"><span class="hljs-string">"vCenterUpdate-restore.vmxf"</span></span> scsi0:0.fileName = <span class="hljs-string"><span class="hljs-string">"vCenterUpdate-restore-0.vmdk"</span></span> sched.swap.derivedName = <span class="hljs-string"><span class="hljs-string">"vCenterUpdate-ff0c3749.vswp"</span></span></code> </pre>  Paths to files can (and should) be specified relative to the machine directory. <br><br>  3. Through vSphereClient go to the repository: <br><pre> <code class="bash hljs">Configuration -&gt; storage -&gt;  -&gt; <span class="hljs-string"><span class="hljs-string">"browse datastore"</span></span></code> </pre><br>  and add a new car to the list: <br><pre> <code class="bash hljs"> -&gt; <span class="hljs-string"><span class="hljs-string">"Add to inventory"</span></span>   *.vmx</code> </pre> <br>  4. If the recovery server is different, then in the settings of the machine we change ‚ÄúNetwork Connection‚Äù. <br><br>  5. When you first start it asks, from where the car was drawn, you need to answer what was transferred. <br>  If you answer that you have cloned you will change unique data, including the mac address of the network card. <br><br>  Here in general, that's all.  The ghettoVCB scripts support other interesting parameters and copy options, so it‚Äôs helpful to read the documentation.  The method is far from ideal, but if you want cheap and angry, it is quite efficient. <br><br>  Thanks for attention. <br><br><h4>  Links </h4><br><ul><li>  <a href="https://communities.vmware.com/docs/DOC-8760" title="https://communities.vmware.com/docs/DOC-8760">ghettoVCB.sh - Free alternatives for backing up VM's for ESX (i) 3.5, 4.x &amp; 5.x</a> </li><li>  <a href="https://communities.vmware.com/docs/DOC-10595" title="https://communities.vmware.com/docs/DOC-10595">Ghetto Tech Preview - ghettoVCB-restore.sh - VMs Restoring backed up from ghettoVCB to ESX (i) 3.5, 4.x &amp; 5.x</a> </li><li>  <a href="http://www.virtuallyghetto.com/2012/09/creating-custom-vibs-for-esxi-50-51.html" title="http://www.virtuallyghetto.com/2012/09/creating-custom-vibs-for-esxi-50-51.html">Creating Custom VIBs For ESXi 5.0 &amp; 5.1 with VIB Author Fling</a> </li><li>  <a href="https://labs.vmware.com/flings/vib-author" title="https://labs.vmware.com/flings/vib-author">VIB Author</a> </li></ul></div><p>Source: <a href="https://habr.com/ru/post/265043/">https://habr.com/ru/post/265043/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../265029/index.html">Statistical problems of identification of network structures</a></li>
<li><a href="../265031/index.html">QIWI launched Visa payWave on Android devices</a></li>
<li><a href="../265037/index.html">7 tips on how to improve the performance of your site in Microsoft Edge and other modern browsers</a></li>
<li><a href="../265039/index.html">Git for Windows 2.5.0 released</a></li>
<li><a href="../265041/index.html">CRM plus mobile communications. We strike integration at low sales</a></li>
<li><a href="../265045/index.html">Processor "in slow motion" and its system on a chip</a></li>
<li><a href="../265047/index.html">Dagaz: Kicks to common sense (part 9)</a></li>
<li><a href="../265049/index.html">Business automation: 5 interesting tools (and their analogues)</a></li>
<li><a href="../265051/index.html">Attack on archivers. Hiding in one archive from three programs</a></li>
<li><a href="../265053/index.html">Old market or restored servers conquered the USA and Europe</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>