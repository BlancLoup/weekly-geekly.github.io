<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Google Analytics - bypass sampling and collect raw data</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hello! 

 If you have a visited site (more than 500 thousand sessions during the reporting period) or you build some complicated reports through the i...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Google Analytics - bypass sampling and collect raw data</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/webt/pr/1_/ms/pr1_msyemwuinptzeg3fx3_pyje.png" alt="image"><br>  Hello! <br><br>  If you have a visited site (more than 500 thousand sessions during the reporting period) or you build some complicated reports through the interface (segmentation, connection of additional parameters, frequent change of the reporting period) - Google Analytics starts saving its resources and includes sampling data.  Details are well described in the <a href="https://support.google.com/analytics/answer/2637192%3Fhl%3Dru">official certificate</a> .  That is, in order to prepare a report for you, not all data is taken, but some part, for example 30%, and then proportionally the indicators are adjusted to 100% and displayed in your report. <br><br>  Of course, in such cases there will be a discrepancy in the number of payments, transaction amounts and in the number of conversions.  Check is easy - compare with numbers from a database or CRM. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Avoiding problems is easy - connect Google Analytics 360, but expensive. <br>  Let's learn how to collect raw data using free Google Analytics. <br><br>  <i>// this instruction is not a solution to all your problems, we are getting acquainted with technology!</i> <br><br><a name="habracut"></a><br><h2>  How reports are built in Google Analytics </h2><br>  To display the reports in the Google Analytics interface (hereafter GA), the following happens: data collection, data processing, report generation. <br><br><img src="https://habrastorage.org/webt/tn/ry/kv/tnrykvkm-1cnhjr6l7oqcxw3lkq.jpeg" alt="image"><br><br>  <b>Data collection</b> <br>  According to the protocol <a href="https://habrahabr.ru/company/englishdom/blog/326788/">Measurement Protocol</a> GA collects information about all interactions: page views, user events, transactions. <br><br>  <b>Data processing</b> <br>  Based on information received about interactions (page views, other events) GA: <br><ul><li>  divides them into sessions: if the difference between the interactions is more than 30 minutes (with basic settings), </li><li>  calculates the number of views per session, bounce rate, </li><li>  obtains information about sources from utm-tags and so on, </li><li>  Applies filters if you set them up at the presentation level. </li></ul><br>  <b>Report generation</b> <br>  When you open a report via the GA web interface or API, depending on the selected report, the system retrieves data from the repository and returns information. <br><br><h2>  How GA collects data - technical side </h2><br>  You add the code that GA provides you, or create a tag through the Google Tag Manager. <br><br>  When this code is triggered in the user's browser, a ga object is created with the tracker.  Further, through this tracker, the interaction is fixed - page view. <br>  Interaction is fixed, so information is sent to the Google Analytics server using the <a href="https://habrahabr.ru/company/englishdom/blog/326788/">Measurement Protocol</a> . <br><br>  If to simplify as much as possible: the information is transmitted to the GA server via a GET request of the format: <br><br><pre><code class="hljs perl">https:<span class="hljs-regexp"><span class="hljs-regexp">//www</span></span>.google-analytics.com/collect?v=<span class="hljs-number"><span class="hljs-number">1</span></span>&amp;_v=j67&amp;a=<span class="hljs-number"><span class="hljs-number">1998834664</span></span>&amp;t=pageview&amp;_s=<span class="hljs-number"><span class="hljs-number">1</span></span>&amp;dl=https%3A%2F%2Fhabrahabr.ru%2Ftop%2F&amp;ul=en-us&amp;de=UTF-<span class="hljs-number"><span class="hljs-number">8</span></span>&amp;dt=%D0%9B%D1%83%D1%87%D1%88%D0%B8%D0%B5%20%D0%BF%D1%83%D0%B1%D0%BB%D0%B8%D0%BA%D0%B0%D1%86%D0%B8%D0%B8%20%D0%B7%D0%B0%20%D1%81%D1%83%D1%82%D0%BA%D0%B8%20%2F%20%D0%A5%D0%B0%D0%B1%D1%80%D0%B0%D1%85%D0%B0%D0%B1%D1%80&amp;sd=<span class="hljs-number"><span class="hljs-number">24</span></span>-bit&amp;sr=<span class="hljs-number"><span class="hljs-number">1920</span></span>x108<span class="hljs-number"><span class="hljs-number">0</span></span>&amp;vp=<span class="hljs-number"><span class="hljs-number">1841</span></span>x341&amp;je=<span class="hljs-number"><span class="hljs-number">0</span></span>&amp;_u=SCCAgEADQ~&amp;jid=&amp;gjid=&amp;cid=<span class="hljs-number"><span class="hljs-number">2098823486.1505375017</span></span>&amp;tid=UA-<span class="hljs-number"><span class="hljs-number">726094</span></span>-<span class="hljs-number"><span class="hljs-number">1</span></span>&amp;_gid=<span class="hljs-number"><span class="hljs-number">1797204180.1524028566</span></span>&amp;cd1=habrauser&amp;cd2=other&amp;cd4=<span class="hljs-keyword"><span class="hljs-keyword">no</span></span>&amp;z=<span class="hljs-number"><span class="hljs-number">1479651106</span></span></code> </pre> <br><br>  You can open in the browser the Panel for developers, the Network tab, filter the word ‚Äúcollect‚Äù and see detailed information on request. <br><br><img src="https://habrastorage.org/webt/p4/v2/0_/p4v20_bsy8gx0ntxap9fohesxfi.png" alt="image"><br><br>  That is, the data is transmitted via the Query String to Google Analytics: <br><br><pre> <code class="hljs pgsql">v:<span class="hljs-number"><span class="hljs-number">1</span></span> _v:j50 a:<span class="hljs-number"><span class="hljs-number">643761009</span></span> t:pageview _s:<span class="hljs-number"><span class="hljs-number">1</span></span> dl:https://habrahabr.ru/ ul:en-us de:UTF<span class="hljs-number"><span class="hljs-number">-8</span></span> dt:    /  sd:<span class="hljs-number"><span class="hljs-number">24</span></span>-<span class="hljs-type"><span class="hljs-type">bit</span></span> sr:<span class="hljs-number"><span class="hljs-number">1920</span></span>x1080 vp:<span class="hljs-number"><span class="hljs-number">1109</span></span>x966 je:<span class="hljs-number"><span class="hljs-number">0</span></span> fl:<span class="hljs-number"><span class="hljs-number">25.0</span></span> r0 _u:QCCAgEAB~ jid:<span class="hljs-number"><span class="hljs-number">1630561303</span></span> cid:<span class="hljs-number"><span class="hljs-number">774042187.1492148509</span></span> tid:UA<span class="hljs-number"><span class="hljs-number">-726094</span></span><span class="hljs-number"><span class="hljs-number">-1</span></span> cd1:guest cd4:<span class="hljs-keyword"><span class="hljs-keyword">no</span></span> cd5:other z:<span class="hljs-number"><span class="hljs-number">1998272259</span></span></code> </pre><br>  Also, each request is accompanied by the transfer of ip-address, referrer, information about the user agent. <br><br>  Any other interactions: events, transactions are also sent through this tracker.  That is, the tracker is one and information about all interactions is sent through it (standard + those that you set up yourself). <br><br><h2>  Collect raw data </h2><br>  We have already figured out how GA sends itself data.  It would be great to duplicate this data and save it to your storage. <br><br>  <i>Write a parser that will collect all the parameters that Google Analytics collects, connect to all events ...</i> No, no bikes! <br><br>  Before sending the information, the GA script performs a <a href="https://developers.google.com/analytics/devguides/collection/analyticsjs/tasks">series of tasks</a> .  Just sending information to the server is one of the tasks.  And to our joy, these tasks can be modified - to send data not only to Google, but also to an arbitrary URL. <br><br><h3>  How to do it </h3><br>  Choose the option through which you have a Google Analytics counter connected: <br><br><div class="spoiler">  <b class="spoiler_title">Analytics.js</b> <div class="spoiler_text">  The standard installation code analytics.js is: <br><pre> <code class="html hljs xml"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag">&gt;</span></span><span class="javascript"><span class="javascript"> (</span><span class="hljs-function"><span class="hljs-keyword"><span class="javascript"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span></span><span class="javascript"><span class="hljs-function">(</span></span><span class="hljs-params"><span class="javascript"><span class="hljs-function"><span class="hljs-params">i,s,o,g,r,a,m</span></span></span></span><span class="javascript"><span class="hljs-function">)</span></span></span><span class="javascript">{i[</span><span class="hljs-string"><span class="javascript"><span class="hljs-string">'GoogleAnalyticsObject'</span></span></span><span class="javascript">]=r;i[r]=i[r]||</span><span class="hljs-function"><span class="hljs-keyword"><span class="javascript"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span></span><span class="javascript"><span class="hljs-function">(</span></span><span class="hljs-params"></span><span class="javascript"><span class="hljs-function"><span class="hljs-params"></span>)</span></span></span><span class="javascript">{ (i[r].q=i[r].q||[]).push(</span><span class="hljs-built_in"><span class="javascript"><span class="hljs-built_in">arguments</span></span></span><span class="javascript">)},i[r].l=</span><span class="hljs-number"><span class="javascript"><span class="hljs-number">1</span></span></span><span class="javascript">*</span><span class="hljs-keyword"><span class="javascript"><span class="hljs-keyword">new</span></span></span><span class="javascript"> </span><span class="hljs-built_in"><span class="javascript"><span class="hljs-built_in">Date</span></span></span><span class="javascript">();a=s.createElement(o), m=s.getElementsByTagName(o)[</span><span class="hljs-number"><span class="javascript"><span class="hljs-number">0</span></span></span><span class="javascript">];a.async=</span><span class="hljs-number"><span class="javascript"><span class="hljs-number">1</span></span></span><span class="javascript">;a.src=g;m.parentNode.insertBefore(a,m) })(</span><span class="hljs-built_in"><span class="javascript"><span class="hljs-built_in">window</span></span></span><span class="javascript">,</span><span class="hljs-built_in"><span class="javascript"><span class="hljs-built_in">document</span></span></span><span class="javascript">,</span><span class="hljs-string"><span class="javascript"><span class="hljs-string">'script'</span></span></span><span class="javascript">,</span><span class="hljs-string"><span class="javascript"><span class="hljs-string">'https://www.google-analytics.com/analytics.js'</span></span></span><span class="javascript">,</span><span class="hljs-string"><span class="javascript"><span class="hljs-string">'ga'</span></span></span><span class="javascript">); ga(</span><span class="hljs-string"><span class="javascript"><span class="hljs-string">'create'</span></span></span><span class="javascript">, </span><span class="hljs-string"><span class="javascript"><span class="hljs-string">'UA-XXXXXXXXX-X'</span></span></span><span class="javascript">, </span><span class="hljs-string"><span class="javascript"><span class="hljs-string">'auto'</span></span></span><span class="javascript">); ga(</span><span class="hljs-string"><span class="javascript"><span class="hljs-string">'send'</span></span></span><span class="javascript">, </span><span class="hljs-string"><span class="javascript"><span class="hljs-string">'pageview'</span></span></span><span class="javascript">); </span></span><span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre><br><br>  We finish the customTask task, as a result it turns out: <br><pre> <code class="html hljs xml"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag">&gt;</span></span><span class="javascript"><span class="javascript"> (</span><span class="hljs-function"><span class="hljs-keyword"><span class="javascript"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span></span><span class="javascript"><span class="hljs-function">(</span></span><span class="hljs-params"><span class="javascript"><span class="hljs-function"><span class="hljs-params">i,s,o,g,r,a,m</span></span></span></span><span class="javascript"><span class="hljs-function">)</span></span></span><span class="javascript">{i[</span><span class="hljs-string"><span class="javascript"><span class="hljs-string">'GoogleAnalyticsObject'</span></span></span><span class="javascript">]=r;i[r]=i[r]||</span><span class="hljs-function"><span class="hljs-keyword"><span class="javascript"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span></span><span class="javascript"><span class="hljs-function">(</span></span><span class="hljs-params"></span><span class="javascript"><span class="hljs-function"><span class="hljs-params"></span>)</span></span></span><span class="javascript">{ (i[r].q=i[r].q||[]).push(</span><span class="hljs-built_in"><span class="javascript"><span class="hljs-built_in">arguments</span></span></span><span class="javascript">)},i[r].l=</span><span class="hljs-number"><span class="javascript"><span class="hljs-number">1</span></span></span><span class="javascript">*</span><span class="hljs-keyword"><span class="javascript"><span class="hljs-keyword">new</span></span></span><span class="javascript"> </span><span class="hljs-built_in"><span class="javascript"><span class="hljs-built_in">Date</span></span></span><span class="javascript">();a=s.createElement(o), m=s.getElementsByTagName(o)[</span><span class="hljs-number"><span class="javascript"><span class="hljs-number">0</span></span></span><span class="javascript">];a.async=</span><span class="hljs-number"><span class="javascript"><span class="hljs-number">1</span></span></span><span class="javascript">;a.src=g;m.parentNode.insertBefore(a,m) })(</span><span class="hljs-built_in"><span class="javascript"><span class="hljs-built_in">window</span></span></span><span class="javascript">,</span><span class="hljs-built_in"><span class="javascript"><span class="hljs-built_in">document</span></span></span><span class="javascript">,</span><span class="hljs-string"><span class="javascript"><span class="hljs-string">'script'</span></span></span><span class="javascript">,</span><span class="hljs-string"><span class="javascript"><span class="hljs-string">'https://www.google-analytics.com/analytics.js'</span></span></span><span class="javascript">,</span><span class="hljs-string"><span class="javascript"><span class="hljs-string">'ga'</span></span></span><span class="javascript">); ga(</span><span class="hljs-string"><span class="javascript"><span class="hljs-string">'create'</span></span></span><span class="javascript">, </span><span class="hljs-string"><span class="javascript"><span class="hljs-string">'UA-XXXXXXXXX-X'</span></span></span><span class="javascript">, </span><span class="hljs-string"><span class="javascript"><span class="hljs-string">'auto'</span></span></span><span class="javascript">); </span><span class="hljs-comment"><span class="javascript"><span class="hljs-comment">//  customTask ga('set', 'customTask', function(tracker) { //    sendHitTask. var originalSendHitTask = tracker.get('sendHitTask'); //     sendHitTask tracker.set('sendHitTask', function(model) { //     www.google-analytics.com/collect originalSendHitTask(model); //         var custom_tracking_url = '    ', hitPayLoad = '?' + model.get('hitPayload'), user_agent = '&amp;user_agent='+ encodeURIComponent(navigator.userAgent), referrer = '&amp;referrer='+encodeURIComponent(document.referrer); var final_tracking_url = custom_tracking_url + hitPayLoad + user_agent + referrer document.createElement("img").src = final_tracking_url; }); }); ga('send', 'pageview'); </span></span></span></span><span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre><br></div></div><br><br><div class="spoiler">  <b class="spoiler_title">Google tag manager</b> <div class="spoiler_text">  You need to create a custom JavaScript <b>customTask</b> variable: <br><br><pre> <code class="hljs lua"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(tracker)</span></span></span></span> { //    sendHitTask. var originalSendHitTask = tracker.get(<span class="hljs-string"><span class="hljs-string">'sendHitTask'</span></span>); //     sendHitTask tracker.set(<span class="hljs-string"><span class="hljs-string">'sendHitTask'</span></span>, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(model)</span></span></span></span> { //     www.google-analytics.com/collect originalSendHitTask(model); //         var custom_tracking_url = <span class="hljs-string"><span class="hljs-string">'    '</span></span>, hitPayLoad = <span class="hljs-string"><span class="hljs-string">'?'</span></span> + model.get(<span class="hljs-string"><span class="hljs-string">'hitPayload'</span></span>), user_agent = <span class="hljs-string"><span class="hljs-string">'&amp;user_agent='</span></span>+ encodeURIComponent(navigator.userAgent), referrer = <span class="hljs-string"><span class="hljs-string">'&amp;referrer='</span></span>+encodeURIComponent(document.referrer); var final_tracking_url = custom_tracking_url + hitPayLoad + user_agent + referrer document.createElement(<span class="hljs-string"><span class="hljs-string">"img"</span></span>).src = final_tracking_url; }); } }</code> </pre><br><br>  Now you need to add <b>customTask field</b> with {{customTask}} to your Universal Analytics tag: <br><br><img src="https://habrastorage.org/webt/of/d_/4a/ofd_4awcx5j-aij0xjhre0m7lre.png" alt="image"><br><br></div></div><br><br>  The result is that we have added a new task to the Google Analytics tracker and with each interaction the information will be sent not only to Google Analytics, but also to your entry point. <br><br><h3>  Storage Configuration </h3><br>  For simplicity, I'll take Google Tables as a repository.  Of course, for large amounts of data this is not an option at all.  But we are familiar with the technology here, so for example, it will do. <br><br>  We create the table, we set names to columns.  Names must match the name of the parameters from the Query String that will be sent by the Google Analytics tracker: <br><br><img src="https://habrastorage.org/webt/0q/mo/f6/0qmof6aemel3komrkohlon95jhy.png" alt="image"><br><br>  Open script editing: <br><br><img src="https://habrastorage.org/webt/xd/mw/zp/xdmwzp5rj0yp9rvy29fb6sxjcno.png"><br><br>  Add a script that, with each GET request, will parse the Query String and add values ‚Äã‚Äãto the table: <br><br><pre> <code class="hljs pgsql"><span class="hljs-keyword"><span class="hljs-keyword">function</span></span> doGet(e) { record_data(e); } var SCRIPT_PROP = PropertiesService.getScriptProperties(); <span class="hljs-keyword"><span class="hljs-keyword">function</span></span> setup() { var doc = SpreadsheetApp.getActiveSpreadsheet(); SCRIPT_PROP.setProperty("key", doc.getId()); } <span class="hljs-keyword"><span class="hljs-keyword">function</span></span> record_data(e) { try { var doc = SpreadsheetApp.openById(SCRIPT_PROP.getProperty("key")); var sheet = doc.getSheetByName(<span class="hljs-string"><span class="hljs-string">'Sheet1'</span></span>); // <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> the responses sheet var headers = sheet.getRange(<span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>, sheet.getLastColumn()).getValues()[<span class="hljs-number"><span class="hljs-number">0</span></span>]; var nextRow = sheet.getLastRow()+<span class="hljs-number"><span class="hljs-number">1</span></span>; // <span class="hljs-keyword"><span class="hljs-keyword">get</span></span> next <span class="hljs-keyword"><span class="hljs-keyword">row</span></span> var <span class="hljs-keyword"><span class="hljs-keyword">row</span></span> = [ <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> <span class="hljs-type"><span class="hljs-type">Date</span></span>() ]; // first element <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> the <span class="hljs-keyword"><span class="hljs-keyword">row</span></span> should <span class="hljs-keyword"><span class="hljs-keyword">always</span></span> be a <span class="hljs-type"><span class="hljs-type">timestamp</span></span> // <span class="hljs-keyword"><span class="hljs-keyword">loop</span></span> through the <span class="hljs-keyword"><span class="hljs-keyword">header</span></span> <span class="hljs-keyword"><span class="hljs-keyword">columns</span></span> <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (var i = <span class="hljs-number"><span class="hljs-number">1</span></span>; i &lt; headers.length; i++) { // <span class="hljs-keyword"><span class="hljs-keyword">start</span></span> at <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> avoid <span class="hljs-type"><span class="hljs-type">Timestamp</span></span> <span class="hljs-keyword"><span class="hljs-keyword">column</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(headers[i].length &gt; <span class="hljs-number"><span class="hljs-number">0</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(!e.parameter[headers[i]]) { e.parameter[headers[i]] = <span class="hljs-string"><span class="hljs-string">''</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">row</span></span>.push(e.parameter[headers[i]]); // <span class="hljs-keyword"><span class="hljs-keyword">add</span></span> data <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> <span class="hljs-keyword"><span class="hljs-keyword">row</span></span> } } sheet.getRange(nextRow, <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">row</span></span>.length).setValues([<span class="hljs-keyword"><span class="hljs-keyword">row</span></span>]); } catch(error) { Logger.log(e); } finally { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>; } }</code> </pre><br><br>  Run the setup () function and give access to the script: <br><br><img src="https://habrastorage.org/webt/q9/pt/us/q9ptusotg5mdebj9y2ijs-z_3ke.png"><br><br>  In the ‚ÄúWho has access to the app‚Äù option, select ‚ÄúAnyone, even anonymous‚Äù. <br><br>  As a result, you will receive a link to your Web App: <br><br><img src="https://habrastorage.org/webt/i5/mj/_r/i5mj_rui-9hdagatulopsjr5hje.png"><br><br>  Copy the link and transfer it to the CustomTask script, in the variable custom_tracking_url. <br><br>  Now, with all the configured interactions, the data will fall not only into GA, but also into your repository. <br><br><img src="https://habrastorage.org/webt/0q/mo/f6/0qmof6aemel3komrkohlon95jhy.png"><br><br>  <b>See how it works in realtime:</b> <b><br></b> <ol><li>  <a href="https://docs.google.com/spreadsheets/d/1ngeATZ6FMbOsH_fIFuYMgJHDq5TpfN5rusOlS449D64/edit%3Fusp%3Dsharing">Open the table</a> . </li><li>  Open a <a href="http://ga.marketello.ru/">test site</a> . </li><li>  Walk through the site + stay tuned in the table. </li></ol><br><br><h3>  Not all data </h3><br>  Since some data (for example, an IP address) does not arrive via the get parameter, but in the request headers you can parse it on the side of the receiving script. <br><br>  With source / medium - you can also work, get it out of Pageurl and scatter it in different columns. <br><br>  We will not dwell on this, I think that the idea is clear. <br><br><h2>  Why is this all about? </h2><br><ul><li>  We get rid of sampling when building reports. </li><li>  Now there are no restrictions on custom fields: send / receive / communicate what you need. </li><li>  You can use this data as conditions for triggers: pageviews, performing an action.  We match with the email and send letters / pushes. </li><li>  For system recommendations: also interested / buy. </li><li>  Analyze user behavior: how they walk around your site, in the context of each session, and in general, for all the time! </li><li>  Analyze traffic sources, see sequences, channels that lead to conversions. </li><li>  Track scams on CPA networks.  Here you will see sudden transitions, for example, when a person simply learns new words in the simulator, and the page reloads and affiliate cookies are set. </li><li>  And a tale for marketers - <a href="https://habrahabr.ru/post/353936/">custom remarketing lists</a> .  Select a segment by behavior, unload cid and send to GA. </li></ul></div><p>Source: <a href="https://habr.com/ru/post/353836/">https://habr.com/ru/post/353836/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../353824/index.html">Comfortable work in the data center</a></li>
<li><a href="../353826/index.html">Drown or swim. How using bootstrapping to pump into a classy entrepreneur</a></li>
<li><a href="../353828/index.html">Instrument for monitoring perturbation near-cosmos</a></li>
<li><a href="../353832/index.html">Detecting Active Directory Attacks with Azure</a></li>
<li><a href="../353834/index.html">Tips for creating applications by the end of recruitment at the Yandex Mobile Development School</a></li>
<li><a href="../353838/index.html">Data Fest 2018: announcement and registration</a></li>
<li><a href="../353842/index.html">Three data centers without seams, or how VTB protects business systems</a></li>
<li><a href="../353844/index.html">DotNext 2018 Piter Conference Program Overview</a></li>
<li><a href="../353848/index.html">What's New in PostgreSQL 11: Embedded Web Search</a></li>
<li><a href="../353850/index.html">Pwn iNt All! We find vulnerabilities in scripting engines and open usermode-mechanisms for protecting Windows. Part 1</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>