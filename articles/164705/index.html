<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>WPF, WinForms: draw Bitmap with> 15000 FPS. Hardcore tricks Part 1</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Immediately clarification: Bitmap 200x100 on a computer with fast memory and i7 3930K at 1366. But, this is an honest System.Drawing.Bitmap. 
 Introdu...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>WPF, WinForms: draw Bitmap with> 15000 FPS. Hardcore tricks Part 1</h1><div class="post__text post__text-html js-mediator-article">  Immediately clarification: Bitmap 200x100 on a computer with fast memory and i7 3930K at 1366. But, this is an honest System.Drawing.Bitmap. <br>  Introductory: oscilloscope type application.  Link to the finished project with a frontend at the end of the article. <br>  How to quickly draw it on the screen?  <a href="http://msdn.microsoft.com/en-us/library/system.windows.media.imaging.writeablebitmap.aspx">WriteableBitmap</a> is good, fast, and it is the best solution for WP, WinRT, WPF.  But WinForms, .Net 2.0, Win2K are also worried about the boring Starper coder (yes, in some government agencies there is still a <s>warm</s> Win2K <s>lamp</s> ). <br>  Next, I drew attention to DirectX, the more we have for WPF appeared useful <a href="http://msdn.microsoft.com/en-us/library/system.windows.interop.d3dimage.aspx">D3DImage</a> control.  I tried many engines, but none of them gave a convenient, elegant way to draw GDI + Bitmap from memory.  Some worked with DX10-11 only.  Closest to the goal was <a href="http://slimdx.org/">SlimDX</a> .  In any case, the frontend for control turned out to be ugly.  All these engines ... are, to say the least, redundant, for my simple task. <br><a name="habracut"></a><br>  But there is a solution. <br>  And, to my satisfaction, it turned out to be quite simple and universal, exactly as it should, it will work even on Win2K and .Net 2.0. <br>  When I was young and I thought I still had a 5 inch drive, I used BitBlt and SetDIBitsToDevice.  Then, with the transition to .Net, I still used them and Win32 GDI BITMAP, because I used old practices, then everything was forgotten.  But suddenly, now I needed a non-standard control with pixel-by-pixel graphics, plus a fast drawing.  That's how I got into a little dead end. <br>  GDI + Bitmap is pretty darn comfortable with its gradients, anti-aliasing, and alpha.  Very tasty pictures are obtained.  It is easy to prepare the necessary Bitmap in memory, and even to do it quickly if you cache most of the image, but quickly display them on the screen there is no obvious way. <br><br>  I had to remember not obvious: <br><pre><code class="cs hljs">[<span class="hljs-meta"><span class="hljs-meta">DllImport(</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"gdi32"</span></span></span><span class="hljs-meta">)</span></span>] <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">extern</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">SetDIBitsToDevice</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">HandleRef hDC, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> xDest, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> yDest, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> dwWidth, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> dwHeight, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> XSrc, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> YSrc, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> uStartScan, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> cScanLines, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">ref</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> lpvBits, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">ref</span></span></span></span><span class="hljs-function"><span class="hljs-params"> BITMAPINFO lpbmi, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">uint</span></span></span></span><span class="hljs-function"><span class="hljs-params"> fuColorUse</span></span></span><span class="hljs-function">)</span></span>;</code> </pre> <br>  And the <b>key</b> method ended up with this: <br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Paint</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">HandleRef hRef, Bitmap bitmap</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (bitmap.Width != _width || bitmap.Height != _height) Realloc(bitmap.Width, bitmap.Height); <span class="hljs-comment"><span class="hljs-comment">//_gcHandle = GCHandle.Alloc(pArray, GCHandleType.Pinned); BitmapData BD = bitmap.LockBits(new Rectangle(0, 0, bitmap.Width, bitmap.Height), ImageLockMode.ReadOnly, PixelFormat.Format32bppArgb); Marshal.Copy(BD.Scan0, _pArray, 0, _width * _height); SetDIBitsToDevice(hRef, 0, 0, _width, _height, 0, 0, 0, _height, ref _pArray[0], ref _BI, 0); bitmap.UnlockBits(BD); //if (gcHandle.IsAllocated) // _gcHandle.Free(); }</span></span></code> </pre><br>  Regarding the commented lines.  In general, they should be uncommented to make life easier for the GC, but for the sake of hardcore FPS, if the _pArray size has not changed, I get kicked with GCHandle once in Realloc ().  Although ... when we have 15,000, plus or minus a couple of hundreds of FPS do not play the role, hehe.  If uncommenting in Paint () - do not forget to comment out the pin in Realloc (). <br>  So, with the price of only 100 lines of code (the code is completely in the attached project below), we solved the FPS problem for System.Drawing.Bitmap, and no monstrous GPU engines and frameworks.  The anger of Microsoft evangelists is possible ‚ÄúYou can't do that, it‚Äôs against accepted programming practices,‚Äù but what can you do. <br>  The whole frontend for the desired control is elegantly reduced to several lines: <br><pre> <code class="cs hljs">RazorPainter RP = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> RazorPainter(); graphics = Control1.CreateGraphics(); hDCRef = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> HandleRef(graphics, graphics.GetHdc()); <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Render</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { RP.Paint(hDCRef, BMP); } RP.Dispose(); graphics.Dispose();</code> </pre><br>  <b>And now cookies</b> !  One of the reasons for the transition to the "dark side" of GDI32.  The fact is that with this approach, we are absolutely indifferent to UI Thread and Invoke it.  For the sake of record FPS, we boldly create a separate high-grade Thread and it is cruel in it: <br><pre> <code class="cs hljs">renderthread = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Thread(() =&gt; { <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (<span class="hljs-literal"><span class="hljs-literal">true</span></span>) Render(); }); renderthread.Start();</code> </pre><br>  There is still a little detail.  Since the OS is not aware of our hooliganism with memory, in the window WndProc it is useless and pointless, but obstinately wipes our Background Color control.  We will relieve the OS of unnecessary torment (and slightly increase the FPS) in this way: <br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">RazorBackend</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { InitializeComponent(); SetStyle(ControlStyles.DoubleBuffer, <span class="hljs-literal"><span class="hljs-literal">false</span></span>); SetStyle(ControlStyles.UserPaint, <span class="hljs-literal"><span class="hljs-literal">true</span></span>); SetStyle(ControlStyles.AllPaintingInWmPaint, <span class="hljs-literal"><span class="hljs-literal">true</span></span>); SetStyle(ControlStyles.Opaque, <span class="hljs-literal"><span class="hljs-literal">true</span></span>); }</code> </pre><br>  In general, of course, FPS will be different for everyone, and the matter is not at all in a video card - here the frequency of the bus, processor, memory, their throughput is pianous.  In general, almost quantum effects for the ordinary user. <br><br>  So, I achieved 15600 FPS, the application takes ~ 30MB of memory, but 8% of processor utilization did not please me at all.  To put it mildly, this is a lot for 3930K.  And here in my head the video driver ‚Äúvozvopil‚Äù: ‚ÄúMaster, I think I have epilepsy!‚Äù, And the monitor: ‚ÄúAnd in general I only know how to 60Hz!‚Äù.  Of course, we do not need such an FPS, and the correct rendering cycle will be something like this: <br><pre> <code class="cs hljs">rendertimer = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> DispatcherTimer(); rendertimer.Interval = TimeSpan.FromMilliseconds(<span class="hljs-number"><span class="hljs-number">15</span></span>); <span class="hljs-comment"><span class="hljs-comment">/* ~60 FPS on my PC */</span></span> rendertimer.Tick += (o, args) =&gt; Render(); rendertimer.Start();</code> </pre><br>  Well, or in another way, to your taste.  Utilization of the processor goes around zero + error. <br>  Next WPF.  Everything is complicated and simple at the same time.  WPF "controls" are not actually controls (otherwise we would not be able to turn and flatten them), and they do not have DC.  Everything is decided by hosting Windows Forms controls in WPF using Windows FormsHost.  In the attached project, WPF is an example of use, but is easily converted into pure Windows Forms, since the front end is simple as a boot. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      The Bitmap rendering cycle in a demo project consists of just one line: <br><pre> <code class="cs hljs">GFX.Clear((drawred = !drawred) ? System.Drawing.Color.Red : System.Drawing.Color.Blue);</code> </pre><br>  Of course, the FPS rendering cycle mostly depends on the complexity of drawing the initial Bitmap in memory, and simply clearing its Graphics in a demo project is a wildly fast block operation.  But I tested the approach and speed. <br><br>  Use on health, if you understand what you are doing and why.  Sources and build, laid out on CodePlex under MIT license: <br>  <a href="http://razorgdipainter.codeplex.com/">http://razorgdipainter.codeplex.com/</a> <br>  (I apologize in advance for the frivolous design of the project on CodePlex, if you're interested, I will complete it to normal OpenSource) <br><br>  <b>UPD</b> : <a href="https://habrahabr.ru/users/alexanderzaytsev/" class="user_link">alexanderzaytsev</a> Correctly signaled that my version of WPF implementation may not be perfect.  I tried to make it simple and understandable.  The key is only in the RazorPainter.cs file, and the demo project is not an exemplary pattern of its use, it only demonstrates the ability in WPF and shows FPS. <br>  Judging by the resonance, I probably should make a real OpenSource framework out of this.  I‚Äôm already writing a WinForms control article. <br>  <b>UPD2</b> : There was a continuation of the post: <a href="http://habrahabr.ru/post/164885/">http://habrahabr.ru/post/164885/</a> .  Update sorts and binaries on CodePlex to v.  0.6 beta </div><p>Source: <a href="https://habr.com/ru/post/164705/">https://habr.com/ru/post/164705/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../164695/index.html">Mars rover Spirit went down to Mars 9 years ago</a></li>
<li><a href="../164697/index.html">Corning will present Gorilla Glass 3 at CES 2013</a></li>
<li><a href="../164699/index.html">Plugin system as an exercise in C ++ 11</a></li>
<li><a href="../164701/index.html">Clojure in the Belarusian State University</a></li>
<li><a href="../164703/index.html">AWS: Semifinalists Startup Contest</a></li>
<li><a href="../164707/index.html">Drupal: we write the parser for Feeds</a></li>
<li><a href="../164709/index.html">Work with Freebase from .NET</a></li>
<li><a href="../164711/index.html">Simulation of life in the Darwinbots system. I. First acquaintance</a></li>
<li><a href="../164717/index.html">Optimize SQL Server performance using indexes</a></li>
<li><a href="../164721/index.html">Porting Qt4 application to Qt5</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>