<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>SMEV 3. Electronic signature of messages in Java and CryptoPro</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="The system of interdepartmental electronic interaction (SMEV) was conceived as a digital environment for the provision of services and the execution o...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>SMEV 3. Electronic signature of messages in Java and CryptoPro</h1><div class="post__text post__text-html js-mediator-article"><div style="text-align:center;"><img src="https://habrastorage.org/webt/0p/qb/hq/0pqbhq1rhwklxvk19nzoybkxsns.jpeg"></div><br><br>  The system of interdepartmental electronic interaction (SMEV) was conceived as a digital environment for the provision of services and the execution of state and municipal functions in electronic form. <br><br>  Currently, SMEV continues to expand its capabilities and involve an increasing number of participants in the interaction. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      What turned out to be an opportune way, including for commercial organizations, in particular banks, which are increasingly seeking to translate their services into digital and serialize processes. <br><br>  In this article we will talk about how to sign requests with our own forces and check the electronic signatures of the responses of the SMEV version 3.0, and about a couple of interesting nuances that we had to face. <br><a name="habracut"></a><br>  Hello! <br><br>  There may be a question.  Why on their own?  When for SMEV 3 there is a whole <a href="https://smev3.gosuslugi.ru/portal/">Technology portal</a> , where <br><br><ul><li>  published all the documentation and guidelines, </li><li>  There is a section with <a href="https://smev3.gosuslugi.ru/portal/faq.jsp">frequently asked questions</a> , </li><li>  You can download the latest version of the library SMEV 3, </li><li>  examples of complete message envelopes with signatures are provided, </li><li>  you can even <a href="https://smev3.gosuslugi.ru/portal/checkxmlform.jsp">check</a> your message <a href="https://smev3.gosuslugi.ru/portal/checkxmlform.jsp">online</a> or from an example for compliance with the SMEV service schemes and the validity of its electronic signature </li></ul><br>  That's right, the portal is certainly extremely useful, and all its tips and tools can and should be used, but here we write our Java code. <br><br>  For the simple reason that there is already a proprietary information system that works with the <b>XMLDSig</b> electronic signature <b>formats, XAdES,</b> which uses <a href="http://santuario.apache.org/">Apache Santuario</a> project libraries that implement basic security standards for XML.  As well as the libraries that make up <b>CryptoPro JCSP</b> , in addition to working with XML, provide the cryptographic functions API of the <b>CryptoPro CSPI</b> . <br><br>  Writing our own methods for working with electronic signatures of SMEV 3 in this case looks more appropriate than deploying the full client of the supplied: <br>  <b>FSBI SRI "Sunrise" (until March 21, 2016 FSUE SRI "Sunrise")</b> or the integration of its individual classes and packages. <br><br>  At the same time, looking into the open source code of a client is always useful, and its presence in itself speaks of the maturity of the system and a high level of support. <br><br><h3>  Source Data Analysis </h3><br>  Download from the portal SMEV 3: <br><ul><li>  current version of the document <a href="https://smev3.gosuslugi.ru/portal/api/files/2_%25D0%259C%25D0%25B5%25D1%2582%25D0%25BE%25D0%25B4%25D0%25B8%25D1%2587%25D0%25B5%25D1%2581%25D0%25BA%25D0%25B8%25D0%25B5%2520%25D1%2580%25D0%25B5%25D0%25BA%25D0%25BE%25D0%25BC%25D0%25B5%25D0%25BD%25D0%25B4%25D0%25B0%25D1%2586%25D0%25B8%25D0%25B8%2520%25D0%25BF%25D0%25BE%2520%25D1%2580%25D0%25B0%25D0%25B1%25D0%25BE%25D1%2582%25D0%25B5%2520%25D1%2581%2520%25D0%2595%25D0%25A1%25D0%259C%25D0%25AD%25D0%2592%2520%25D0%25B2%25D0%25B5%25D1%2580%25D1%2581%25D0%25B8%25D1%258F%25203.4.0.3.docx">Guidelines for working with ESMB version 3.4.0.3</a> </li><li>  <a href="">examples of</a> full envelopes of messages sent to SMEV 3 </li></ul><br><br>  If we are already able to form an ordinary XMLDSig or sign, for example, the envelopes of the SMEV 2 messages, then it becomes most interesting to know what distinguishes the envelope with the signature of the SMEV 3 from the SMEV 2. <br><br>  Open the envelope example SMEV 3 <b>SendRequestRequestNoAttach.xml</b> <br><br><pre><code class="xml hljs"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">S:Envelope</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">xmlns:S</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"http://schemas.xmlsoap.org/soap/envelope/"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">xmlns:ns</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"urn://x-artefacts-smev-gov-ru/services/message-exchange/types/1.1"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">S:Body</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">ns2:SendRequestRequest</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">xmlns:ns3</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"urn://x-artefacts-smev-gov-ru/services/message-exchange/types/faults/1.1"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">xmlns:ns2</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"urn://x-artefacts-smev-gov-ru/services/message-exchange/types/1.1"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">xmlns</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"urn://x-artefacts-smev-gov-ru/services/message-exchange/types/basic/1.1"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">ns:SenderProvidedRequestData</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Id</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"SIGNED_BY_CONSUMER"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">xmlns</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"urn://x-artefacts-smev-gov-ru/services/message-exchange/types/1.1"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">xmlns:ns</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"urn://x-artefacts-smev-gov-ru/services/message-exchange/types/1.1"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">xmlns:ns2</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"urn://x-artefacts-smev-gov-ru/services/message-exchange/types/basic/1.1"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">ns:MessageID</span></span></span><span class="hljs-tag">&gt;</span></span>db0486d0-3c08-11e5-95e2-d4c9eff07b77<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">ns:MessageID</span></span></span><span class="hljs-tag">&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">ns2:MessagePrimaryContent</span></span></span><span class="hljs-tag">&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">ns1:BreachRequest</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">xmlns:ns1</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"urn://x-artefacts-gibdd-gov-ru/breach/root/1.0"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">xmlns:ns2</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"urn://x-artefacts-gibdd-gov-ru/breach/commons/1.0"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">xmlns:ns3</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"urn://x-artefacts-smev-gov-ru/supplementary/commons/1.0.1"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Id</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"PERSONAL_SIGNATURE"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">ns1:RequestedInformation</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">ns2:RegPointNum</span></span></span><span class="hljs-tag">&gt;</span></span>78557<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">ns2:RegPointNum</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">ns1:RequestedInformation</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">ns1:Governance</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">ns2:Name</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">ns2:Name</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">ns2:Code</span></span></span><span class="hljs-tag">&gt;</span></span>GIBDD<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">ns2:Code</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">ns2:OfficialPerson</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">ns3:FamilyName</span></span></span><span class="hljs-tag">&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">ns3:FamilyName</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">ns3:FirstName</span></span></span><span class="hljs-tag">&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">ns3:FirstName</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">ns3:Patronymic</span></span></span><span class="hljs-tag">&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">ns3:Patronymic</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">ns2:OfficialPerson</span></span></span><span class="hljs-tag">&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">ns1:Governance</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">ns1:BreachRequest</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">ns2:MessagePrimaryContent</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">ns:TestMessage</span></span></span><span class="hljs-tag">/&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">ns:SenderProvidedRequestData</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">ns2:CallerInformationSystemSignature</span></span></span><span class="hljs-tag">&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">ds:Signature</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">xmlns:ds</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"http://www.w3.org/2000/09/xmldsig#"</span></span></span><span class="hljs-tag">&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">ds:SignedInfo</span></span></span><span class="hljs-tag">&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">ds:CanonicalizationMethod</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Algorithm</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"http://www.w3.org/2001/10/xml-exc-c14n#"</span></span></span><span class="hljs-tag">/&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">ds:SignatureMethod</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Algorithm</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"http://www.w3.org/2001/04/xmldsig-more#gostr34102001-gostr3411"</span></span></span><span class="hljs-tag">/&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">ds:Reference</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">URI</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"#SIGNED_BY_CONSUMER"</span></span></span><span class="hljs-tag">&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">ds:Transforms</span></span></span><span class="hljs-tag">&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">ds:Transform</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Algorithm</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"http://www.w3.org/2001/10/xml-exc-c14n#"</span></span></span><span class="hljs-tag">/&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">ds:Transform</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Algorithm</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"urn://smev-gov-ru/xmldsig/transform"</span></span></span><span class="hljs-tag">/&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">ds:Transforms</span></span></span><span class="hljs-tag">&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">ds:DigestMethod</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Algorithm</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"http://www.w3.org/2001/04/xmldsig-more#gostr3411"</span></span></span><span class="hljs-tag">/&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">ds:DigestValue</span></span></span><span class="hljs-tag">&gt;</span></span>/jXl70XwnttJB5sSokwh8SaVHwo2gjgILSu0qBaLUAo=<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">ds:DigestValue</span></span></span><span class="hljs-tag">&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">ds:Reference</span></span></span><span class="hljs-tag">&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">ds:SignedInfo</span></span></span><span class="hljs-tag">&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">ds:SignatureValue</span></span></span><span class="hljs-tag">&gt;</span></span>J3746ks34pOcPGQpKzc0sz3n9+gjPtzZbSEEs4c3sTwbtfdaY7N/hxXzEIvXc+3ad9bc35Y8yBhZ/BYbloGt+Q==<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">ds:SignatureValue</span></span></span><span class="hljs-tag">&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">ds:KeyInfo</span></span></span><span class="hljs-tag">&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">ds:X509Data</span></span></span><span class="hljs-tag">&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">ds:X509Certificate</span></span></span><span class="hljs-tag">&gt;</span></span>MIIBcDCCAR2gAwIBAgIEHVmVKDAKBgYqhQMCAgMFADAtMRAwDgYDVQQLEwdTWVNURU0xMQwwCgYDVQQKEwNJUzIxCzAJBgNVBAYTAlJVMB4XDTE1MDUwNzEyMTUzMFoXDTE4MDUwNjEyMTUzMFowLTEQMA4GA1UECxMHU1lTVEVNMTEMMAoGA1UEChMDSVMyMQswCQYDVQQGEwJSVTBjMBwGBiqFAwICEzASBgcqhQMCAiMBBgcqhQMCAh4BA0MABEDoWGZlTUWD43G1N7TEm14+QyXrJWProrzoDoCJRem169q4bezFOUODcNooQJNg3PtAizkWeFcX4b93u8fpVy7RoyEwHzAdBgNVHQ4EFgQUaRG++MAcPZvK/E2vR1BBl5G7s5EwCgYGKoUDAgIDBQADQQCg25vA3RJL3kgcJhVOHA86vnkMAtZYr6HBPa7LpEo0HJrbBF0ygKk50app1lzPdZ5TtK2itfmNgTYiuQHX3+nE<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">ds:X509Certificate</span></span></span><span class="hljs-tag">&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">ds:X509Data</span></span></span><span class="hljs-tag">&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">ds:KeyInfo</span></span></span><span class="hljs-tag">&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">ds:Signature</span></span></span><span class="hljs-tag">&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">ns2:CallerInformationSystemSignature</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">ns2:SendRequestRequest</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">S:Body</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">S:Envelope</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre> <br><br>  By the deductive method it turns out that: <br><ul><li>  There is no longer any method of taking out the contents of the Signature tag in the Security header of the BinarySecurityToken element with the certificate of the public key for verifying the electronic signature and linking to it via SecurityTokenReference in the body of the Signature itself, as, for example, in SMEV 2.4.6.  Now the certificate should be inside Signature. </li><li>  The second and, in fact, the most significant and important change that has a great impact on the signature process is the addition of a new proprietary transformation: <br><br><pre> <code class="xml hljs"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">ds:Transform</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Algorithm</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"urn://smev-gov-ru/xmldsig/transform"</span></span></span><span class="hljs-tag">/&gt;</span></span></code> </pre> <br></li></ul><br>  Through this transformation, own rules of canonicalization of SMEV 3 are disseminated. <br><br>  <b>Canonicalization</b> is the process of converting data, having several possible forms of presentation, to one normalized standard form. <br><br>  Before calculating the hash of the attribute being signed in the XML envelope and signing it, it is necessary to convert it to the 3 form specified by the rules of SMEV. <br><br>  In search of a description of the transformation <b>urn: // smev-gov-ru / xmldsig / transform</b> open Methodical recommendations 3.4.0.3 <br><br>  We are acquainted with clause <b>4.4.2.1 of the Rules for generating electronic signature of messages.</b> <br><br><blockquote>  XMLDSig detached signature format (https://www.w3.org/TR/xmldsig-core/) <br><br>  Transformation, in addition to canonization urn: // smev-gov-ru / xmldsig / transform <br><br>  Formatting Requirements The XML structure of the signature between elements does not allow text nodes, including line breaks. <br></blockquote><br>  Paragraph Guidelines <b>12.4.</b>  <b>APPENDIX 4: EXEMPLARY IMPLEMENTATION OF TRANSFORMATION URN: // SMEV-GOV-RU / XMLDSIG / TRANSFORM</b> <br>  contains the Java class <b>SmevTransformSpi.java</b> , which implements the transformation algorithm "urn: // smev-gov-ru / xmldsig / transform", inherited from org.apache.xml.security.transforms.TransformSpi from the Apache Santuario library. <br><br>  Thus, in order to ensure the canonicalization of the signed envelope SMEV 3, this transformation class can be used in your code. <br><br>  The only condition and limitation in this case is that to process the XML document when generating a signature or verifying it, you need to use org.apache.xml.security.signature.XMLSignature from the Apache Santuario project. <br><br>  Using tools from the javax.xml.crypto.dsig or ru.CryptoPro.JCPxml.xmldsig packages just won't work anymore. <br><br><h3>  Preparation for the signature according to the rules of SMEV 3 </h3><br>  Apache Santuario initially does not know anything about GOST cryptographic algorithms and CryptoPro SKZI. <br><br>  The xmlsec-1.5.0.jar library in the \ org \ apache \ xml \ security \ resource \ config.xml file contains settings for working with foreign cryptographic algorithms only. <br><br>  In order for it to begin to recognize and apply GOST, you need to initialize it. <br><br>  In the old way it was done like this: <br><br><pre> <code class="java hljs"><span class="hljs-comment"><span class="hljs-comment">//APACHE-SANTUARIO INIT WITH CryptoPro JCP System.setProperty("org.apache.xml.security.resource.config", "resource/jcp.xml"); org.apache.xml.security.Init.init(); String cfile1 = System.getProperty("org.apache.xml.security.resource.config"); LOGGER.log(Level.INFO, "Init class URL: " + org.apache.xml.security.Init.class.getProtectionDomain().getCodeSource().getLocation()); LOGGER.log(Level.INFO, cfile1);</span></span></code> </pre><br>  In new versions of CryptoPro JCP (JCSP), one line will perform initialization: <br><br><pre> <code class="java hljs">ru.CryptoPro.JCPxml.xmldsig.JCPXMLDSigInit.init();</code> </pre> <br>  Now we need Apache Santuario to teach the new transformation rules dictated by SMEV 3. To do this, we register the transformation class: <br><br><pre> <code class="java hljs"> <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { Transform.register(SmevTransformSpi.ALGORITHM_URN, SmevTransformSpi.class.getName()); santuarioIgnoreLineBreaks(<span class="hljs-keyword"><span class="hljs-keyword">true</span></span>); LOGGER.log(Level.INFO, <span class="hljs-string"><span class="hljs-string">"SmevTransformSpi has been initialized"</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (AlgorithmAlreadyRegisteredException e) { LOGGER.log(Level.INFO, <span class="hljs-string"><span class="hljs-string">"SmevTransformSpi Algorithm already registered: "</span></span> + e.getMessage()); }</code> </pre><br>  At the same time, we immediately fulfill the requirement of the Methodical Instructions: <br><br><blockquote>  Formatting Requirements The XML structure of the signature between elements does not allow text nodes, including line breaks. </blockquote><br><pre> <code class="java hljs">santuarioIgnoreLineBreaks(<span class="hljs-keyword"><span class="hljs-keyword">true</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> String IGNORE_LINE_BREAKS_FIELD = <span class="hljs-string"><span class="hljs-string">"ignoreLineBreaks"</span></span>; <span class="hljs-comment"><span class="hljs-comment">/** * Apache Santuario privileged switch IgnoreLineBreaks property * * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@param</span></span></span><span class="hljs-comment"> mode */</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">santuarioIgnoreLineBreaks</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Boolean mode)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { Boolean currMode = mode; AccessController.doPrivileged(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> PrivilegedExceptionAction&lt;Boolean&gt;() { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> Boolean </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">run</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">throws</span></span></span><span class="hljs-function"> Exception </span></span>{ Field f = XMLUtils.class.getDeclaredField(IGNORE_LINE_BREAKS_FIELD); f.setAccessible(<span class="hljs-keyword"><span class="hljs-keyword">true</span></span>); f.set(<span class="hljs-keyword"><span class="hljs-keyword">null</span></span>, currMode); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>; } }); } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (Exception e) { LOGGER.warning(<span class="hljs-string"><span class="hljs-string">"santuarioIgnoreLineBreaks "</span></span> + ExceptionUtils.getFullStackTrace(e)); } }</code> </pre><br>  This is done in the privileged block AccessController.doPrivileged <br>  and through reflection, due to the peculiarity of the implementation of the ignoreLineBreaks property in Santuario. <br><br>  Just by setting the system property: <br><br><pre> <code class="java hljs">System.setProperty(<span class="hljs-string"><span class="hljs-string">"org.apache.xml.security.ignoreLineBreaks"</span></span>, <span class="hljs-string"><span class="hljs-string">"true"</span></span>);</code> </pre><br>  does not work. <br><br>  By setting the JVM option: <br><br><pre> <code class="java hljs">-Dcom.sun.org.apache.xml.internal.security.ignoreLineBreaks=<span class="hljs-keyword"><span class="hljs-keyword">true</span></span></code> </pre> <br>  works. <br><br>  If you look at the code of the <a href="http://grepcode.com/file/repo1.maven.org/maven2/org.apache.santuario/xmlsec/1.5.0/org/apache/xml/security/utils/XMLUtils.java/">org.apache.xml.security.utils.XMLUtils</a> class, you can see that the ignoreLineBreaks static field is initialized in a privileged block from the system property <b>"org.apache.xml.security.ignoreLineBreaks"</b> . <br><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">boolean</span></span> ignoreLineBreaks = AccessController.doPrivileged(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> PrivilegedAction&lt;Boolean&gt;() { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> Boolean </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">run</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> Boolean.valueOf(Boolean.getBoolean (<span class="hljs-string"><span class="hljs-string">"org.apache.xml.security.ignoreLineBreaks"</span></span>)); } }).booleanValue(); <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">boolean</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ignoreLineBreaks</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> ignoreLineBreaks; }</code> </pre><br>  Such an implementation makes it impossible to configure flexibly in one Java process for part of the methods to ignore line feeds, and for the other part not to ignore. <br><br>  That is, if one application executes the XMLDsig, SMEV 2 and SMEV 3 signatures, all XML documents processed by Santuario should lose the translation of the output at the output. <br><br>  With this property, of course, the question arises for Apache Santuario: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/kd/0g/7y/kd0g7ypyulf_y1pta6sd7zc22re.jpeg"></div><br><br><h3>  Signature of messages SMEV 3 </h3><br>  For the signing of documents SMEV 3 everything is ready. <br><br>  The signing code looks like this: <br><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> String XMLDSIG_MORE_GOSTR34102001_GOSTR3411 = <span class="hljs-string"><span class="hljs-string">"http://www.w3.org/2001/04/xmldsig-more#gostr34102001-gostr3411"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> String XMLDSIG_MORE_GOSTR3411 = <span class="hljs-string"><span class="hljs-string">"http://www.w3.org/2001/04/xmldsig-more#gostr3411"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> String CANONICALIZATION_METHOD = <span class="hljs-string"><span class="hljs-string">"http://www.w3.org/2001/10/xml-exc-c14n#"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> String DS_SIGNATURE = <span class="hljs-string"><span class="hljs-string">"//ds:Signature"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> String SIG_ID = <span class="hljs-string"><span class="hljs-string">"sigID"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> String COULD_NOT_FIND_XML_ELEMENT_NAME = <span class="hljs-string"><span class="hljs-string">"ERROR! Could not find xmlElementName = "</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> String GRID = <span class="hljs-string"><span class="hljs-string">"#"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> String XML_SIGNATURE_ERROR = <span class="hljs-string"><span class="hljs-string">"xmlDSignature ERROR: "</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { <span class="hljs-comment"><span class="hljs-comment">//    XML- DocumentBuilderFactory dbf = DocumentBuilderFactory.newInstance(); //  ,     //     XML- dbf.setIgnoringElementContentWhitespace(true); //  ,    CDATA  //     XML- dbf.setCoalescing(true); //  ,      //  XML- dbf.setNamespaceAware(true); //       //       data DocumentBuilder documentBuilder = dbf.newDocumentBuilder(); Document doc = documentBuilder.parse(new ByteArrayInputStream(data)); /* *    &lt;ds:Signature&gt;   XML- */ //   (  34.10-2001) final String signMethod = XMLDSIG_MORE_GOSTR34102001_GOSTR3411; //  ,    (  34.11-94) final String digestMethod = XMLDSIG_MORE_GOSTR3411; final String canonicalizationMethod = CANONICALIZATION_METHOD; String[][] filters = {{XPath2FilterContainer.SUBTRACT, DS_SIGNATURE}}; String sigId = SIG_ID; //        //    34.10-2001 XMLSignature sig = new XMLSignature(doc, "", signMethod, canonicalizationMethod); //      sig.setId(sigId); //    XML- Element anElement = null; if (xmlElementName == null) { anElement = doc.getDocumentElement(); } else { NodeList nodeList = doc.getElementsByTagName(xmlElementName); anElement = (Element) nodeList.item(0); } // = doc.getElementById("#AppData"); //     XML-   if (anElement != null) { anElement.appendChild(sig.getElement()); } else { throw new SignatureProcessorException(COULD_NOT_FIND_XML_ELEMENT_NAME + xmlElementName); } /* *     XML-       *  */ //    &lt;ds:Transforms&gt;  // XML- Transforms transforms = new Transforms(doc); //         // transforms.addTransform(Transforms.TRANSFORM_ENVELOPED_SIGNATURE); transforms.addTransform(Transforms.TRANSFORM_C14N_EXCL_OMIT_COMMENTS); transforms.addTransform(SmevTransformSpi.ALGORITHM_URN); //      ( &lt;ds:Reference&gt;), //     // XML- (      //  &lt;ds:Transforms&gt;  //    ) sig.addDocument(xmlElementID == null ? "" : GRID + xmlElementID, transforms, digestMethod); /* *     XML-    , *     */ //      &lt;ds:KeyInfo&gt;   //     //  sig.addKeyInfo(x509Cert); //   XML- sig.sign(privateKey); //  ,      // XML- bais = new ByteArrayOutputStream(); //     XML-  //  TransformerFactory tf = TransformerFactory.newInstance(); //     XML-   Transformer trans = tf.newTransformer(); //   XML-   trans.transform(new DOMSource(doc), new StreamResult(bais)); bais.close(); } catch (TransformationException e) { throw new SignatureProcessorException("TransformationException " + XML_SIGNATURE_ERROR + e.getMessage()); } catch (XMLSignatureException e) { throw new SignatureProcessorException("XMLSignatureException " + XML_SIGNATURE_ERROR + e.getMessage()); } catch (TransformerException e) { throw new SignatureProcessorException("TransformerException " + XML_SIGNATURE_ERROR + e.getMessage()); } catch (IOException e) { throw new SignatureProcessorException("IOException " + XML_SIGNATURE_ERROR + e.getMessage()); } catch (XMLSecurityException e) { throw new SignatureProcessorException("XMLSecurityException " + XML_SIGNATURE_ERROR + e.getMessage()); } catch (SAXException e) { throw new SignatureProcessorException("SAXException " + XML_SIGNATURE_ERROR + e.getMessage()); } catch (ParserConfigurationException e) { throw new SignatureProcessorException( "ParserConfigurationException " + XML_SIGNATURE_ERROR + e.getMessage()); } return bais.toByteArray();</span></span></code> </pre><br>  The main parameters here are: <br><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">byte</span></span>[] data, <span class="hljs-comment"><span class="hljs-comment">// XML      String xmlElementName, //    XML   ,     ,  -3    "ns2:CallerInformationSystemSignature" String xmlElementID // ID   XML ( )   ,     ,  -3    "SIGNED_BY_CONSUMER" X509Certificate certificate //      PrivateKey privateKey //   </span></span></code> </pre><br><br><h3>  Verification of the signature of the message SMEV 3 </h3><br>  The signature verification code is as follows: <br><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> QName QNAME_SIGNATURE = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> QName(<span class="hljs-string"><span class="hljs-string">"http://www.w3.org/2000/09/xmldsig#"</span></span>, <span class="hljs-string"><span class="hljs-string">"Signature"</span></span>, <span class="hljs-string"><span class="hljs-string">"ds"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> String SIGNATURE_NOT_FOUND = <span class="hljs-string"><span class="hljs-string">"Signature not found!"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> String SIGNATURE_NOT_VALID = <span class="hljs-string"><span class="hljs-string">"Signature not valid"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> String SMEV_SIGNATURE_PASSED_CORE_VALIDATION = <span class="hljs-string"><span class="hljs-string">"SmevSignature passed core validation"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> String VERIFY_SIGNATURE_ON_XML_IO_EXCEPTION = <span class="hljs-string"><span class="hljs-string">"Verify signature on XML IOException: "</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> String VERIFY_SIGNATURE_ON_XML_PARSER_CONFIGURATION_EXCEPTION = <span class="hljs-string"><span class="hljs-string">"Verify signature on XML ParserConfigurationException: "</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> String VERIFY_SIGNATURE_ON_XML_SAX_EXCEPTION = <span class="hljs-string"><span class="hljs-string">"Verify signature on XML SAXException: "</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> String VERIFY_SIGNATURE_ON_XML_XML_SIGNATURE_EXCEPTION = <span class="hljs-string"><span class="hljs-string">"Verify signature on XML XMLSignatureException: "</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> String VERIFY_SIGNATURE_ON_XML_XML_SECURITY_EXCEPTION = <span class="hljs-string"><span class="hljs-string">"Verify signature on XML XMLSecurityException: "</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> String ID = <span class="hljs-string"><span class="hljs-string">"Id"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">boolean</span></span> coreValidity = <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { DocumentBuilderFactory bf = DocumentBuilderFactory.newInstance(); bf.setNamespaceAware(<span class="hljs-keyword"><span class="hljs-keyword">true</span></span>); DocumentBuilder b = bf.newDocumentBuilder(); Document doc = b.parse(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> InputSource(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ByteArrayInputStream(signedXmlData))); NodeList sigs = doc.getElementsByTagNameNS(QNAME_SIGNATURE.getNamespaceURI(), QNAME_SIGNATURE.getLocalPart()); org.apache.xml.security.signature.XMLSignature sig = <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>; sigSearch: { <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; sigs.getLength(); i++) { Element sigElement = (Element) sigs.item(i); String sigId = sigElement.getAttribute(ID); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (sigId != <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) { sig = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> org.apache.xml.security.signature.XMLSignature(sigElement, <span class="hljs-string"><span class="hljs-string">""</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">break</span></span> sigSearch; } } <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> XMLSignatureVerificationException(SIGNATURE_NOT_FOUND); } org.apache.xml.security.keys.KeyInfo ki = (org.apache.xml.security.keys.KeyInfo) sig.getKeyInfo(); X509Certificate certificate = ki.getX509Certificate(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!sig.checkSignatureValue(certificate.getPublicKey())) { coreValidity = <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>; LOGGER.log(Level.INFO, SIGNATURE_NOT_VALID); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { LOGGER.log(Level.INFO, String.format(SMEV_SIGNATURE_PASSED_CORE_VALIDATION)); } } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (IOException e) { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> XMLSignatureVerificationException(VERIFY_SIGNATURE_ON_XML_IO_EXCEPTION + ExceptionUtils.getStackTrace(e)); } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (ParserConfigurationException e) { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> XMLSignatureVerificationException(VERIFY_SIGNATURE_ON_XML_PARSER_CONFIGURATION_EXCEPTION + ExceptionUtils.getStackTrace(e)); } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (SAXException e) { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> XMLSignatureVerificationException(VERIFY_SIGNATURE_ON_XML_SAX_EXCEPTION + ExceptionUtils.getStackTrace(e)); } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (org.apache.xml.security.signature.XMLSignatureException e) { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> XMLSignatureVerificationException(VERIFY_SIGNATURE_ON_XML_XML_SIGNATURE_EXCEPTION + ExceptionUtils.getStackTrace(e)); } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (XMLSecurityException e) { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> XMLSignatureVerificationException(VERIFY_SIGNATURE_ON_XML_XML_SECURITY_EXCEPTION + ExceptionUtils.getStackTrace(e)); } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> coreValidity;</code> </pre><br><br><h3>  Problems.  Hash does not match </h3><br>  <b>Attention!</b> <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/-w/if/q5/-wifq5mdmjea7amsahn5wdjinc4.jpeg"></div><br><br>  For debugging, we used the example of the envelope SMEV 3 SendRequestRequestNoAttach.xml <br>  The ds: Signature element was deleted from it with the goal of re-signing the message and checking it with the original. <br><br>  Despite the fact that the signature method and the SmevTransformSpi transformation, taken from the Methodical Instructions, were worked out, the output was a signed document, which was interpreted as an online signature on the SMEV 3 portal. <br><br><blockquote>  VC-OB is not confirmed: VC check error: VC integrity is violated <br></blockquote><br>  Why <br><br><pre> <code class="xml hljs"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">ds:DigestValue</span></span></span><span class="hljs-tag">&gt;</span></span>e76oVeYGapFDE+PV6glsj0XDjLHydLMd0cSkFPY8fWk=<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">ds:DigestValue</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre> <br>  did not coincide with the original example: <br><br><pre> <code class="xml hljs"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">ds:DigestValue</span></span></span><span class="hljs-tag">&gt;</span></span>/jXl70XwnttJB5sSokwh8SaVHwo2gjgILSu0qBaLUAo==<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">ds:DigestValue</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre> <br>  To diagnose the causes, your XMLEventWriter has been added to the SmevTransformSpi class in the process method. <br><br><pre> <code class="java hljs">ByteArrayOutputStream baos = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ByteArrayOutputStream(); XMLEventWriter bdst = outputFactory.get().createXMLEventWriter(baos, ENCODING_UTF_8);</code> </pre><br>  for parallel analysis of all stages of transformation. <br><br>  The normalized XML element to which you want to sign was as follows: <br><br><pre> <code class="xml hljs"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">ns1:SenderProvidedRequestData</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">xmlns:ns1</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"urn://x-artefacts-smev-gov-ru/services/message-exchange/types/1.1"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Id</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"SIGNED_BY_CONSUMER"</span></span></span><span class="hljs-tag">&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">ns1:MessageID</span></span></span><span class="hljs-tag">&gt;</span></span>db0486d0-3c08-11e5-95e2-d4c9eff07b77<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">ns1:MessageID</span></span></span><span class="hljs-tag">&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">ns2:MessagePrimaryContent</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">xmlns:ns2</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"urn://x-artefacts-smev-gov-ru/services/message-exchange/types/basic/1.1"</span></span></span><span class="hljs-tag">&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">ns3:BreachRequest</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">xmlns:ns3</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"urn://x-artefacts-gibdd-gov-ru/breach/root/1.0"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Id</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"PERSONAL_SIGNATURE"</span></span></span><span class="hljs-tag">&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">ns3:RequestedInformation</span></span></span><span class="hljs-tag">&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">ns4:RegPointNum</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">xmlns:ns4</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"urn://x-artefacts-gibdd-gov-ru/breach/commons/1.0"</span></span></span><span class="hljs-tag">&gt;</span></span>78557<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">ns4:RegPointNum</span></span></span><span class="hljs-tag">&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">ns3:RequestedInformation</span></span></span><span class="hljs-tag">&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">ns3:Governance</span></span></span><span class="hljs-tag">&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">ns4:Name</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">ns4:Name</span></span></span><span class="hljs-tag">&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">ns4:Code</span></span></span><span class="hljs-tag">&gt;</span></span>GIBDD<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">ns4:Code</span></span></span><span class="hljs-tag">&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">ns4:OfficialPerson</span></span></span><span class="hljs-tag">&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">ns5:FamilyName</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">xmlns:ns5</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"urn://x-artefacts-smev-gov-ru/supplementary/commons/1.0.1"</span></span></span><span class="hljs-tag">&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">ns5:FamilyName</span></span></span><span class="hljs-tag">&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">ns5:FirstName</span></span></span><span class="hljs-tag">&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">ns5:FirstName</span></span></span><span class="hljs-tag">&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">ns5:Patronymic</span></span></span><span class="hljs-tag">&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">ns5:Patronymic</span></span></span><span class="hljs-tag">&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">ns4:OfficialPerson</span></span></span><span class="hljs-tag">&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">ns3:Governance</span></span></span><span class="hljs-tag">&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">ns3:BreachRequest</span></span></span><span class="hljs-tag">&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">ns2:MessagePrimaryContent</span></span></span><span class="hljs-tag">&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">ns1:TestMessage</span></span></span><span class="hljs-tag">&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">ns1:TestMessage</span></span></span><span class="hljs-tag">&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">ns1:SenderProvidedRequestData</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre> <br>  The search for a solution showed that, in the first place, <a href="https://www.cryptopro.ru/forum2/default.aspx%3Fg%3Dposts%26m%3D87576">the CryptoPro forum</a> , a normalized document may actually look different and, accordingly, its hash will be different and possibly correct. <br><br>  Secondly, it resulted in <a href="">GitHub</a> , where the older version of SmevTransformSpi class was laid out. <br><br>  The old version of the transformation class has issued the following normalized document: <br><br><pre> <code class="xml hljs"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">ns1:SenderProvidedRequestData</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">xmlns:ns1</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"urn://x-artefacts-smev-gov-ru/services/message-exchange/types/1.1"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Id</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"SIGNED_BY_CONSUMER"</span></span></span><span class="hljs-tag">&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">ns1:MessageID</span></span></span><span class="hljs-tag">&gt;</span></span>db0486d0-3c08-11e5-95e2-d4c9eff07b77<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">ns1:MessageID</span></span></span><span class="hljs-tag">&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">ns2:MessagePrimaryContent</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">xmlns:ns2</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"urn://x-artefacts-smev-gov-ru/services/message-exchange/types/basic/1.1"</span></span></span><span class="hljs-tag">&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">ns3:BreachRequest</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">xmlns:ns3</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"urn://x-artefacts-gibdd-gov-ru/breach/root/1.0"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Id</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"PERSONAL_SIGNATURE"</span></span></span><span class="hljs-tag">&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">ns3:RequestedInformation</span></span></span><span class="hljs-tag">&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">ns4:RegPointNum</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">xmlns:ns4</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"urn://x-artefacts-gibdd-gov-ru/breach/commons/1.0"</span></span></span><span class="hljs-tag">&gt;</span></span>78557<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">ns4:RegPointNum</span></span></span><span class="hljs-tag">&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">ns3:RequestedInformation</span></span></span><span class="hljs-tag">&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">ns3:Governance</span></span></span><span class="hljs-tag">&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">ns5:Name</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">xmlns:ns5</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"urn://x-artefacts-gibdd-gov-ru/breach/commons/1.0"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">ns5:Name</span></span></span><span class="hljs-tag">&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">ns6:Code</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">xmlns:ns6</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"urn://x-artefacts-gibdd-gov-ru/breach/commons/1.0"</span></span></span><span class="hljs-tag">&gt;</span></span>GIBDD<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">ns6:Code</span></span></span><span class="hljs-tag">&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">ns7:OfficialPerson</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">xmlns:ns7</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"urn://x-artefacts-gibdd-gov-ru/breach/commons/1.0"</span></span></span><span class="hljs-tag">&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">ns8:FamilyName</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">xmlns:ns8</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"urn://x-artefacts-smev-gov-ru/supplementary/commons/1.0.1"</span></span></span><span class="hljs-tag">&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">ns8:FamilyName</span></span></span><span class="hljs-tag">&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">ns9:FirstName</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">xmlns:ns9</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"urn://x-artefacts-smev-gov-ru/supplementary/commons/1.0.1"</span></span></span><span class="hljs-tag">&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">ns9:FirstName</span></span></span><span class="hljs-tag">&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">ns10:Patronymic</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">xmlns:ns10</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"urn://x-artefacts-smev-gov-ru/supplementary/commons/1.0.1"</span></span></span><span class="hljs-tag">&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">ns10:Patronymic</span></span></span><span class="hljs-tag">&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">ns7:OfficialPerson</span></span></span><span class="hljs-tag">&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">ns3:Governance</span></span></span><span class="hljs-tag">&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">ns3:BreachRequest</span></span></span><span class="hljs-tag">&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">ns2:MessagePrimaryContent</span></span></span><span class="hljs-tag">&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">ns1:TestMessage</span></span></span><span class="hljs-tag">&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">ns1:TestMessage</span></span></span><span class="hljs-tag">&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">ns1:SenderProvidedRequestData</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre> <br>  With it, the hash began to match, and the signature successfully passed the validation. <br><br>  Comparing the versions of the SmevTransformSpi class showed that in addition to the additional logging and diagnostic functions added in the new implementation in debug mode: <br><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (logger.isDebugEnabled()) { debugStream = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> DebugOutputStream(argDst); dst = outputFactory.get().createXMLEventWriter(debugStream, ENCODING_UTF_8); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { dst = outputFactory.get().createXMLEventWriter(argDst, ENCODING_UTF_8); }</code> </pre><br>  The class from the Methodical Instructions does not contain the necessary line, or contains a typo: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/fi/lz/r5/filzr5rjncb5o3vodq5yiojortk.jpeg"></div><br><br>  Missing line: <br><br><pre> <code class="java hljs">prefixMappingStack.pop();</code> </pre> <br>  which removes the first object from the prefixed stack <br><br><pre> <code class="java hljs"> Stack&lt;List&lt;Namespace&gt;&gt; prefixMappingStack = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Stack&lt;List&lt;Namespace&gt;&gt;();</code> </pre> <br>  , which led to incorrect operation of SmevTransformSpi. <br><br>  Adding this line to the new version of SmevTransformSpi.java solved the problem. <br><br>  A working transformation class and an envelope with a signature can be viewed at <a href="https://github.com/VBurmistrov/Smev3">github.com/VBurmistrov/Smev3</a> <br><br><h3>  results </h3><br>  The signing of envelopes SMEV 3 is successful. <br><br>  Messages are checked on the portal of <a href="https://smev3.gosuslugi.ru/portal/checkxmlform.jsp">e-government services</a> <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/mk/x-/62/mkx-62q5oimmu6k2xhpxzxyzaju.jpeg"></div><br><br>  And in its own application: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/h-/sc/a7/h-sca7moexwodaxmxruacvfslmk.jpeg"></div></div><p>Source: <a href="https://habr.com/ru/post/350158/">https://habr.com/ru/post/350158/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../350144/index.html">Richard Hamming: Chapter 29. You get what you measure</a></li>
<li><a href="../350148/index.html">Flask Mega-Tutorial, Part XIII: I18n and L10n (Edition 2018)</a></li>
<li><a href="../350152/index.html">We are testing the array of OceanStor Dorado V3: so ordinary that right at all</a></li>
<li><a href="../350154/index.html">ViyaDB: analytical database for unsorted data</a></li>
<li><a href="../350156/index.html">Learn OpenGL. Lesson 4.8 - Advanced GLSL</a></li>
<li><a href="../350160/index.html">30 seconds CSS</a></li>
<li><a href="../350162/index.html">Event digest for HR-specialists in IT for March 2018</a></li>
<li><a href="../350164/index.html">TOP-10: analysis of the best reports of HolyJS 2017 Moscow</a></li>
<li><a href="../350166/index.html">Using CSS Grid to Design User Interfaces</a></li>
<li><a href="../350168/index.html">Communication in space: how it works</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>