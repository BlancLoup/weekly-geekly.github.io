<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>We intercept the launch of any application in Windows and try not to break anything.</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="If you do a lot of debugging Windows applications, you may have heard of such a wonderful mechanism as Image File Execution Options ( IFEO ). One of t...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>We intercept the launch of any application in Windows and try not to break anything.</h1><div class="post__text post__text-html js-mediator-article"><p>  If you do a lot of debugging Windows applications, you may have heard of such a wonderful mechanism as <a href="https://msdn.microsoft.com/en-us/library/a329t4ed(v%3Dvs.100).aspx">Image File Execution Options</a> ( <strong>IFEO</strong> ).  One of the opportunities it provides allows you to debug the application in conditions more close to combat.  By writing a special key to the right place in the registry, we can automatically launch the debugger instead of the program, allowing it to do its own debugging tasks.  However, who said that this mechanism (in fact, launch interception of anything) can only be used for such purposes?  This article is not about using things as intended. </p><br><p>  Under the cut there is a story about how I tried to squeeze more out of this mechanism for my good purposes, and what pitfalls I encountered on the way.  And here I have good, selected stones. <a name="habracut"></a></p><br><blockquote>  Generally speaking, this idea is not new.  I know at least three programs that use this mechanism for non-debugging purposes: the well-known <a href="https://docs.microsoft.com/en-us/sysinternals/downloads/process-explorer">Process Explorer</a> and <a href="https://wj32.org/processhacker/index.php">Process Hacker</a> - to replace the standard task manager;  and <a href="http://akelpad.sourceforge.net/ru/index.php">AkelPad</a> - to replace the notebook.  But I decided to go a little further. </blockquote><p>  <strong>So, what we have:</strong> we can run our program instead of any other pre-specified, if we pre-register ourselves in the registry.  And it is not particularly important who, how, and with what rights will run it. </p><br><p>  What can be useful to do with such capabilities?  The first thing that came to my mind was to ask the user - does he really want this process to start?  Having quickly figured out how to register myself in <abbr title="Image File Execution Options">IFEO,</abbr> I made a tiny utility with a dialog box and Yes / No buttons, which starts the intercepted program only with the user's consent.  Immediately after the launch, I realized the depth of my naivety.  Already guess what happened when choosing "Yes"?  Of course, I launched myself again and received a new window asking for confirmation, and here you can continue indefinitely.  Interception worked fine. </p><br><p>  Not sure how useful this mechanism would be if it were not possible to bypass it: the debugger needs to start the process being debugged.  So in Image File Execution Options there is one exception.  Let's start with the fact that in user mode there are only two methods for starting processes: <a href="https://msdn.microsoft.com/en-us/library/windows/desktop/ms682425(v%3Dvs.85).aspx">CreateProcess</a> and <a href="https://msdn.microsoft.com/en-us/library/windows/desktop/bb762154(v%3Dvs.85).aspx">ShellExecuteEx</a> .  And then, the second, in the end, also calls CreateProcess, but more on that later.  And so, the exception is that process starts with the <abbr title="DEBUG_PROCESS = 1">DEBUG_PROCESS</abbr> flag <abbr title="DEBUG_PROCESS = 1">are</abbr> not intercepted.  This solves the problem with debuggers, but, in my case, it also means that you cannot fully rely on IFEO.  And yet, I do not know of any programs (except debuggers, of course) that would use this flag.  You can not just put this flag and enjoy: you need an additional code to make it work. </p><br><h3>  Register file in IFEO </h3><br><p>  If you follow <a href="https://docs.microsoft.com/en-us/sysinternals/downloads/procmon">Process Monitor</a> 'and what happens when you call the CreateProcess function, you will probably find a lot of interesting things.  In addition to correcting errors in the file name, which we will talk about later, you will find access to the registry for IFEO settings.  What it looks like: </p><br><div style="text-align:center;"><img src="https://habrastorage.org/web/47e/566/a68/47e566a68a784f0fa82f7e8ca773f70e.png"></div><br><p>  If this key is found, then the presence of certain fields, including the <strong>Debugger</strong> string field, will also be checked.  It is what we need.  It stores the path to the debugger, or, in our case, to the program being launched instead of this one. </p><br><pre><code class="hljs tex">[HKEY_LOCAL_MACHINE<span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">SOFTWARE</span></span></span></span><span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Microsoft</span></span></span></span><span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Windows</span></span></span></span> NT<span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">CurrentVersion</span></span></span></span><span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Image</span></span></span></span> File Execution Options<span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">YourExecutable</span></span></span></span>.exe] "Debugger" = "C:<span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Path</span></span></span></span>-to-debugger<span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Debugger</span></span></span></span>.exe"</code> </pre> <br><p>  It is worth noting that there are limitations here: </p><br><ul><li>  Only the name of the executable file is checked.  This means - no masks.  You can not just take and intercept the call <strong>* .exe</strong> . </li><li>  The action for all programs with the same executable file name will be the same.  Until we use the <strong>UseFilter</strong> key.  Then, yes, you can assign a specific debugger for a particular executable file based on its full path.  Again - no masks. </li></ul><br><div class="spoiler">  <b class="spoiler_title">Details about UseFilter</b> <div class="spoiler_text"><blockquote>  To use filtering in the IFEO \ YourExecutable.exe branch, you need to create a DWORD field <strong>UseFilter</strong> with a nonzero value.  In this case, when trying to create a process, it will bypass all the sub-keys in the given branch, and in each of them it will check the value of the <strong>FilterFullPath</strong> string field with the full path to the executable file.  If there is a match, the executable found in the <strong>Debugger</strong> field will be launched.  If no match is found, the default Debugger will be launched (that is, the one that would be used without any filters). <br><br>  <strong>Note:</strong> any sub-key without the <strong>FilterFullPath</strong> field <strong>is</strong> treated as a match, and all settings are taken from it and take precedence over those that would be without a filter. </blockquote></div></div><br><h3>  Assigning standard actions </h3><br><p>  The initial meaning of this venture for me was that, having learned about IFEO, I decided to write a program that would offer the user a set of typical actions (implemented in the form of small utilities) assigned to other programs.  It was before I decided to write an article, realizing how many interesting things there can be told.  Therefore, we use these utilities as a clear and practical example for narration.  So, what was enough of my imagination: </p><br><ul><li>  <strong>Ask.exe</strong> - notifies the user about the attempt to start and asks for permission; </li><li>  <strong>Deny.exe</strong> - fails to start.  At the same time, it can either notify the user or do it silently.  <strike>Very handy if you need to prevent Windows from running any telemetry.</strike> </li><li>  <strong>Elevate.exe</strong> - always requests <abbr title="User Account Control - User Account Control">UAC</abbr> for elevation of rights to the Administrator; </li><li>  <strong>Drop.exe</strong> - lowers the privileges of the process.  It is simply the crown of creation.  It is similar in meaning to the <abbr title="If anyone gives a link - I will be grateful">DropMyRights</abbr> and <a href="https://docs.microsoft.com/en-us/sysinternals/downloads/psexec">PsExec utilities</a> with the -‚Ñì flag.  But in combination with IFEO - much more efficient; </li><li>  <strong>PowerRequest.exe</strong> - does not allow the computer to fall asleep / <strong>turn</strong> off the screen until the program is completed. </li></ul><br><div style="text-align:center;"><img src="https://habrastorage.org/web/2f2/7d8/3af/2f27d83af36747068f3e9a5e9d857b39.png"></div><br><p>  To register these actions, two versions of the program presented in the screenshot were written: GUI and console.  There is nothing to talk about here.  Just read / write to the registry. </p><br><p>  As you can guess from the title, the most interesting thing is how to substitute someone else's program during the execution, and without breaking anything.  But first, a few obvious, though necessary things.  If we even launch the intercepted process, then we need to reproduce as best we can the same conditions under which we launched ourselves.  Which means: </p><br><ul><li>  Exactly the same <a href="https://msdn.microsoft.com/en-us/library/windows/desktop/ms686331(v%3Dvs.85).aspx">STARTUPINFO</a> structure, setting the <em>bInheritHandles</em> flag, and the same working directory; </li><li>  Waiting for the completion of the process being started to get its return code and transfer along the chain; </li><li>  And ... another trick, which I will discuss later. </li></ul><br><p>  Good.  And how do we know what to run? </p><br><h3>  Evaluate the possibilities </h3><br><p>  Suppose that in IFEO as a debugger for the program <strong>A.exe the</strong> following is written: </p><br><pre> <code class="hljs tex">"C:<span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">My</span></span></span></span>-Path<span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">B</span></span></span></span>.exe" /param</code> </pre> <br><p>  If someone tries to create the process "C: \ Folder \ <strong>A.exe</strong> " with the <em>-a</em> parameter, the <strong>B.exe</strong> process will be created with the following command line: </p><br><pre> <code class="hljs tex">"C:<span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">My</span></span></span></span>-Path<span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">B</span></span></span></span>.exe" /param "C:<span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Folder</span></span></span></span><span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">A</span></span></span></span>.exe" -a</code> </pre> <br><p>  Since we ourselves write the code for <strong>B.exe</strong> , we will easily analyze the command line into its component parts and we can easily run <strong>A.exe</strong> with the same parameters with which this nameless someone wanted to launch it.  This is where we have complete freedom.  We want - we run with other privileges, we want - we can change the transmitted parameters. </p><br><p>  The curious thing about all this is this: how do you think the <a href="https://ru.wikipedia.org/wiki/User_Account_Control">control of user accounts</a> responds to such an arbitrary appeal?  The correct answer: but no way.  If you select ‚ÄúRun as Administrator‚Äù in the <strong>explorer</strong> on the <strong>A.exe</strong> file, then the UAC message will display information about the <strong>A.exe</strong> file, and its digital signature will determine the window color.  And the fact that <strong>B.exe</strong> will be launched <strong>instead</strong> is the tenth thing.  No, there are no special security issues here: writing to IFEO itself requires administrative privileges.  For us, this means something else: by writing our utilities in IFEO, we <strong>generally</strong> will not confuse the user with incorrect accounts control messages.  After all, from his point of view - the way it should look. </p><br><h3>  How to start processes </h3><br><p>  With the advent of user account control in Windows Vista, starting processes has become more complex.  The fact is that now the call to CreateProcess may be unsuccessful due to the lack of rights to run some programs.  In this case, <a href="https://msdn.microsoft.com/en-us/library/windows/desktop/ms679360(v%3Dvs.85).aspx">GetLastError</a> returns <abbr title="ERROR_ELEVATION_REQUIRED = 740">ERROR_ELEVATION_REQUIRED</abbr> .  For such a case, even a special <a href="https://msdn.microsoft.com/ru-ru/library/cc722422.aspx">fix for compatibility issues is</a> built into Windows, although I never noticed that it fixes at least something.  Modern programs, in response to this error, should call ShellExecuteEx with the action "runas" to request elevation of privileges.  This means that the typical code for creating a process now looks like this: </p><br><pre> <code class="hljs pgsql"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> CreateProcess(‚Ä¶) <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> GetLastError = ERROR_ELEVATION_REQUIRED <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> ShellExecuteEx(‚Ä¶) //   "runas" <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> //   </code> </pre> <br><p>  Since our utilities should always work, they will not require elevated privileges to run, which means that the process that tries to start <strong>A.exe</strong> (and instead starts our <strong>B.exe</strong> ) <strong>will</strong> never get ERROR_ELEVATION_REQUIRED.  It seems to be: okay, okay, we ourselves can request elevation of rights for it, if necessary.  Now imagine what happened.  Someone started <strong>A.exe</strong> , we started instead, and since <strong>A.exe is</strong> demanding of privileges, we cannot start it with CreateProcess, and therefore we must use ShellExecuteEx.  Already guessed?  ShellExecuteEx is <strong>always</strong> intercepted by IFEO, there is no DEBUG_PROCESS flag that could save us.  As a result, we will launch ourselves again.  True, this time we already have enough privileges to use CreateProcess to run <strong>A.exe</strong> .  And all this without any visible traces from the UAC!  You can break the brain, is not it?  I myself am not fully accustomed to the concept of "almost comprehensive interception of my own actions." </p><br><div style="text-align:center;"><img src="https://habrastorage.org/web/cc3/eeb/270/cc3eeb2701b04c97aaa977cf64283b51.png"></div><br><p>  For this reason, in the <strong>Elevate.exe</strong> utility, <strong>you</strong> cannot do with ShellExecuteEx alone ‚Äî we simply cannot get around IFEO.  In the case of <strong>Ask.exe,</strong> this adds another problem.  Here we asked the user, he confirmed the launch.  And then ShellExecuteEx in combination with IFEO, we launched ourselves again.  What, again we will ask?  I had to add suppression of the secondary issue.  But this is impossible to do by simply adding a special parameter: wherever we add it, we are still going to run <strong>A.exe</strong> , so that it will be indistinguishable from its own parameters.  This is a very good exercise for the mind - to try to predict in advance all these difficulties. </p><br><h3>  Difference CreateProcess from ShellExecuteEx </h3><br><p>  Have you read the <a href="https://msdn.microsoft.com/en-us/library/windows/desktop/ms682425(v%3Dvs.85).aspx">documentation</a> for CreateProcess?  There is one thing that many miss, potentially creating some vulnerability in the security of their applications.  The same applies to the obsolete <a href="https://msdn.microsoft.com/en-us/library/windows/desktop/ms687393(v%3Dvs.85).aspx">WinExec</a> function, which is a wrapper over CreateProcess.  The first two parameters of the function determine what will be launched with which arguments.  These are <em>lpApplicationName</em> and <em>lpCommandLine</em> .  Here is a translation of a piece of text from MSDN: </p><br><blockquote>  The <em>lpApplicationName</em> parameter can be <em>NULL</em> .  Then the name of the executable file must be the first space separated by a substring in <em>lpCommandLine</em> .  If you use long file names that may contain spaces, use quotation marks to indicate where the file name ends and the arguments begin.  Otherwise, the file name is ambiguous. </blockquote><p>  Why do people keep forgetting to put quotes?  This is how it works - an error correction mechanism is built into CreateProcess.  Set <em>lpApplicationName</em> to <em>NULL</em> and try to start the program by passing the name of its executable file to <em>lpCommandLine</em> : <strong>C: \ Program Files \ Sub Dir \ Program Name</strong> .  What will CreateProcess do?  Search the line for what you can run until you find it, and also substituting the file extension: </p><br><blockquote>  <strong>C: \ Program</strong> Files \ Sub Dir \ Program Name <br>  <strong>C: \ Program.exe</strong> Files \ Sub Dir \ Program Name <br>  <strong>C: \ Program Files \ Sub</strong> Dir \ Program Name <br>  <strong>C: \ Program Files \ Sub.exe</strong> Dir \ Program Name <br>  <strong>C: \ Program Files \ Sub Dir \ Program</strong> Name <br>  <strong>C: \ Program Files \ Sub Dir \ Program.exe</strong> Name <br>  <strong>C: \ Program Files \ Sub Dir \ Program Name</strong> </blockquote><p>  If you want to experiment - create the file <strong>C: \ Program.exe</strong> on your computer and see if any of the programs fall into this.  I caught up with Process Hacker (the fix is ‚Äã‚Äãalready in the nightly build), Punto Switcher (I should write them too), and one of the plugins for Far Manager.  By the way, Windows Explorer also knows about this problem: </p><br><div style="text-align:center;"><img src="https://habrastorage.org/web/a4e/9a3/b15/a4e9a3b157b94920a411f44a5a6e3ca2.png"></div><br><p>  Returning to the question: what does this mean for us?  From IFEO, we get exactly <em>lpCommandLine</em> .  Yes, we can simply pass it to CreateProcess - if there was such a problem there - it will remain, here we are powerless.  But we may also need to pass it to ShellExecuteEx, and there, oops, there is no such error correction.  There are separate <em>lpFile</em> and separately <em>lpParameters</em> .  You will have to independently parse the string by spaces and search for the name of the first existing executable file, just as CreateProcess does.  Super. </p><br><p>  And now we are a little distracted and talk about other curious things.  I'm going to talk about how one of the utilities works. </p><br><h3>  Lowering privileges </h3><br><p>  The principle ‚ÄúRun any program with the minimum necessary rights‚Äù is probably familiar to everyone here.  But what to do if the author of the program you like has not heard about this principle - the question is already more complicated.  Sometimes in these situations, mechanisms for resolving compatibility problems are saved: </p><br><pre> <code class="hljs lisp">SetEnvironmentVariable('__COMPAT_LAYER', 'RunAsInvoker')<span class="hljs-comment"><span class="hljs-comment">;</span></span></code> </pre> <br><p>  This significantly reduces the number of times CreateProcess cannot start the program and returns ERROR_ELEVATION_REQUIRED.  But this does not always work.  For example, over this method have the priority <abbr title="C: \ Windows \ AppPatch \ *. Sdb">* .sdb</abbr> <abbr title="See Microsoft Application Compatibility Toolkit">patches</abbr> . </p><br><p>  There are also special utilities that can run processes with an Elevated token (that is, as if on behalf of the administrator), but <abbr title="Use the &quot;Use for deny only&quot; flag">cut out all the relevant privileges</abbr> .  These are <a href="https://yadi.sk/d/XCFoh2yK3LwZYw">DropMyRights</a> , written by <a href="https://en.wikipedia.org/wiki/Michael_Howard_(Microsoft)">Michael Howard from Microsoft</a> , and <a href="https://docs.microsoft.com/en-us/sysinternals/downloads/psexec">PsExec</a> from the well-known <a href="https://docs.microsoft.com/en-us/sysinternals/">Microsoft Sysinternals</a> kit, launched with the ‚Äì‚Ñì key.  Oddly enough, but these utilities achieve their different ways. </p><br><p>  I prefer the method used in DropMyRights.  Yes, and its source code is open.  The <a href="https://msdn.microsoft.com/en-us/library/windows/desktop/ms721849(v%3Dvs.85).aspx">Windows Safer API is</a> used there, which allows literally in a few lines of code to calculate a token with reduced privileges, which can be immediately used in <a href="https://msdn.microsoft.com/en-us/library/windows/desktop/ms682429(v%3Dvs.85).aspx">CreateProcessAsUser</a> .  Eh, I would like all the installer writers to know how easy it is, and not to run programs with maximum permissions after the installation is complete ... </p><br><p>  And now let's combine both mentioned approaches, combining them with IFEO.  As a result, we get an automatic downgrade and a minimum of requests for account control.  I do not know about you, but I really like it.  And since elevation of rights by calling ShellExecuteEx is always intercepted, then, as far as I understand, the program under the influence of our utility has no chance to get out on its own until the user confirms UAC for another executable file that is in cooperation with the limited .  But for really serious cases - use sandboxes like Sandboxie.  Or virtual machines, for that matter. </p><br><h3>  IFEO bypass </h3><br><p>  Let's return to the main topic.  I am saying everything, they say, we will launch the process with the flag DEBUG_PROCESS and we will be happy, we will not get ourselves into our rake.  But in order to make it work, something else needs to be done.  With this flag we will start the process under debugging, which means we will receive debug events.  If they are not processed, the process will remain motionless.  To process them, you need only two functions: <a href="https://msdn.microsoft.com/en-us/library/windows/desktop/ms681423(v%3Dvs.85).aspx">WaitForDebugEvent</a> and <a href="https://msdn.microsoft.com/en-us/library/windows/desktop/ms679285(v%3Dvs.85).aspx">ContinueDebugEvent</a> . </p><br><p>  However, not all programs normally belong to debuggers, right?  Not that I specifically made an exception for the sake of viruses, but disconnecting the debugger would really be a better idea.  We are not here to write a debugger.  And here, unexpectedly, comes the difficulty: this action probably refers to undocumented features, because I did not find it on MSDN.  Therefore, we will use the Process Hacker documentation.  So, we need the <a href="http://processhacker.sourceforge.net/doc/ntdbg_8h.html">NtRemoveProcessDebug</a> function from <strong>ntdll.dll</strong> .  It also needs a <em>DebugObjectHandle</em> , which can be obtained using <a href="https://msdn.microsoft.com/en-us/library/windows/desktop/ms684280(v%3Dvs.85).aspx">NtQueryInformationProcess</a> , requesting <a href="http://processhacker.sourceforge.net/doc/ntpsapi_8h_source.html">ProcessDebugObjectHandle = 30</a> from it as a <em>ProcessInformationClass</em> .  That's all.  Although ... It is better not to do so with other people's processes: their debugger can wait for the debugging event at this moment, and for them the kill-on-close can be enabled. </p><br><blockquote>  <strong>UPD.</strong> <br>  I was wrong, and therefore went the more difficult way.  There is a documented function for this, this is <a href="https://msdn.microsoft.com/en-us/library/windows/desktop/ms679296(v%3Dvs.85).aspx">DebugActiveProcessStop</a> .  It is recommended to use <a href="https://msdn.microsoft.com/en-us/library/windows/desktop/ms679307(v%3Dvs.85).aspx">DebugSetProcessKillOnExit</a> with it. </blockquote><p>  It is worth noting that there is a feature related to the bitness of the operating system: a 32-bit process cannot start a 64-bit process with the DEBUG_PROCESS flag.  But 64-bit can run anyone. </p><br><p>  Oh yeah, do you still remember?  Above, I promised to tell you about another trick that allows you to achieve a slightly better compatibility with the subsequent launch of the intercepted processes. </p><br><h3>  Account Control Magic </h3><br><p>  I have already said that account control does not react at all to what is happening.  And if you even then asked the question "Why?", Then you are definitely here. </p><br><p>  How does UAC work and how does it allow privilege escalation?  Well the answer to this question is given in the English article <a href="https://www.codeproject.com/Articles/19165/Vista-UAC-The-Definitive-Guide">Vista UAC: The Definitive Guide</a> .  In short: ShellExecuteEx, making its way through the jungle of COM calls, calls the AppInfo service.  That creates the <strong>consent.exe</strong> process, which displays the window with a request to confirm the launch, and, if necessary, enter a password.  The creation of the process itself, naturally, occurs after all this.  And there is used the most common <a href="https://msdn.microsoft.com/en-us/library/windows/desktop/ms682429(v%3Dvs.85).aspx">CreateProcessAsUser</a> .  It is at this stage that the IFEO is triggered, and, intercepting the creation of the process, it launches us.  That is why account control knows nothing about this. </p><br><p>  The most shrewd ones should have asked: if the process is created by someone else, then how is it that his parent process still turns out to be the initiator of the request? </p><br><p>  Starting from Windows Vista, you can use <a href="https://msdn.microsoft.com/en-us/library/windows/desktop/ms686331(v%3Dvs.85).aspx">STARTUPINFOEX</a> instead of <a href="https://msdn.microsoft.com/en-us/library/windows/desktop/ms686331(v%3Dvs.85).aspx">STARTUPINFO</a> in CreateProcess (if you use the <abbr title="EXTENDED_STARTUPINFO_PRESENT = 0x80000">EXTENDED_STARTUPINFO_PRESENT</abbr> flag).  It contains all the same information + <em>lpAttributeList</em> with a list of process attributes.  This attribute list must be created by calling <a href="https://msdn.microsoft.com/en-us/library/windows/desktop/ms683481(v%3Dvs.85).aspx">InitializeProcThreadAttributeList</a> , and then updated by <a href="https://msdn.microsoft.com/en-us/library/windows/desktop/ms686880(v%3Dvs.85).aspx">UpdateProcThreadAttribute</a> .  You can replace the parent process by specifying the <abbr title="PROC_THREAD_ATTRIBUTE_PARENT_PROCESS = 0x20000">PROC_THREAD_ATTRIBUTE_PARENT_PROCESS</abbr> flag and providing a handle to the desired process.  What is there to remember: </p><br><ul><li>  The handle to the process that we make the new parent must have <abbr title="PROCESS_CREATE_PROCESS = 128">PROCESS_CREATE_PROCESS</abbr> rights and live up to the call to <a href="https://msdn.microsoft.com/en-us/library/windows/desktop/ms682559(v%3Dvs.85).aspx">DeleteProcThreadAttributeList</a> ; </li><li>  You must set the value of the <strong>cb</strong> field of the nested STARTUPINFO to SizeOf (STARTUPINFOEX). </li></ul><br><blockquote>  A ready C # example is on <a href="https://stackoverflow.com/questions/10554913/how-to-call-createprocess-with-startupinfoex-from-c-sharp-and-re-parent-the-ch">StackOverflow</a> . </blockquote><p>  Do you often when analyzing, for example, suspicious activity on a computer, proceed from who started what process?  Oh, now you definitely won't do that. </p><br><p>  There are some interesting features.  I remember a humorous phrase from one cartoon, it sounds something like this: ‚ÄúWhy, even at my birth, none of my parents were present ...‚Äù.  Oddly enough, but something like this is possible here.  If between the call to <a href="https://msdn.microsoft.com/en-us/library/windows/desktop/ms684320(v%3Dvs.85).aspx">OpenProcess</a> ' a and the creation of the process itself, the assigned parent will be completed - no problem.  It is just that the child process will be ‚Äúas if‚Äù created by the parent upon completion.  Why not. </p><br><p>  Everything is good, but this trick will not work with ShellExecuteEx - everything is simple: the one who caused it, that is the parent.  However, since we have IFEO enabled, the final word is always left behind CreateProcess: without it, we cannot get out of the interception.  So, walking along the process chain, you can find the one who started all this initially, and appoint him as the parent.  Perhaps the result is now not so beautiful in Process Explorer and Process Hacker, but from the point of view of someone else's process, everything will be fine.  Well, with the exception, perhaps, of "illegitimate" children who appeared at start-up and are awaiting the return code of the intercepted process.  There's nothing to be done. </p><br><p>  The picture shows how I run <strong>nsx.exe</strong> from <strong>Far.exe</strong> , to which the <strong>Ask.exe</strong> action is <strong>assigned</strong> , and which requires elevated privileges to run. </p><br><div style="text-align:center;"><img src="https://habrastorage.org/web/57a/02d/972/57a02d972ce848b29b020dd30cc11613.png"></div><br><p>  To be honest, I thought that the idea of ‚Äã‚Äãreplacing the parent process is just another cool opportunity, not more.  However, she did fix a few problems.  So, the same Far Manager can create a second process to perform more privileged actions, and in the presence of interception, this functionality was broken.  The substitution of the parent again fixed it. </p><br><h3>  What not to do </h3><br><p>  I didn‚Äôt dare to check it on my computer for a long time, because it was too lazy to deploy a virtual machine: what will happen if you install it yourself as a program launched during interception?  Fortunately, no big deal.  But then I decided to be prudent and did not test on my computer hypotheses like ‚Äúoh, and if you try to create a cycle <strong>A</strong> ‚Üí <strong>B</strong> ‚Üí <strong>A</strong> ...‚Äù.  Also, I think you should not try to intercept important system processes (I embedded their list in the registration utility with confirmation of the action).  Although, I am curious about what will happen.  For everything that I ran on behalf of SYSTEM was intercepted.  So I added suppression of all dialog boxes in zero session, well, so as not to depend in such cases on the UI0Detect service. </p><br><p>  One last thing: I would not recommend putting actions on programs that create many processes of the same type.  One thing is a couple of additional processes, another is whole hordes.      ,     .  ,      .  ,  :  <strong>chrome.exe</strong>    .    :        .         . </p><br><h3>   </h3><br><p>  Windows    <a href="https://msdn.microsoft.com/en-us/library/windows/desktop/ms680339(v%3Dvs.85).aspx"></a>   .     <strong>Native</strong> (), <strong>Windows CUI</strong> ( ),  <strong>Windows GUI</strong> ( ).        ‚Äî          ,      .      ‚Äî   :   ?       ,      ,   ‚Äî .   , GUI       :     <strong>svchost.exe</strong> ,     Windows GUI. </p><br><p>         .    ,         ,  .          ,      .        ? , .  ,      <a href="https://msdn.microsoft.com/en-us/library/windows/desktop/dd562082(v%3Dvs.85).aspx">Application Compatibility Toolkit</a>  -,     , ,   ,    ¬´   ¬ª.  ,      .   ,      .        ,    :   ,    -  ,   ,    .   ,     .          ,  Delphi    ‚Äî    ,    :  <strong>02</strong>  <strong>03</strong>   0x15C. </p><br><h3>  Conclusion </h3><br><p>  ,   ¬´  1001     Windows¬ª      .  ,     Delphi,      WinApi, , ,  . </p><br><p>        <a href="https://github.com/diversenok/ExecutionMaster"><strong></strong></a> .    Windows 7  ,  Windows Vista ‚Äî  .  ‚Äî  . </p><br><p> P. S.     ,   -     ‚Äî    ,     ,     .  Thank. </p></div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <p>Source: <a href="https://habr.com/ru/post/335736/">https://habr.com/ru/post/335736/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../335720/index.html">Techniques for building corporate budgeting systems</a></li>
<li><a href="../335728/index.html">Sosnovkino - the first domestic scam? Or we will collect money faster and more</a></li>
<li><a href="../335730/index.html">To whom life with ISDEF is good</a></li>
<li><a href="../335732/index.html">Social Organism - as a form of effective team interaction. Part 3</a></li>
<li><a href="../335734/index.html">Blockchain as an academic discipline: ITMO University Master's Program</a></li>
<li><a href="../335738/index.html">The most interesting ICO of summer 2017: national cryptocurrency, blockchain-social network and streaming service</a></li>
<li><a href="../335742/index.html">How to legally "open" QIWI Wallet and pump it in full</a></li>
<li><a href="../335746/index.html">Forwarding a real video card in a VM with ReactOS</a></li>
<li><a href="../335748/index.html">As we increased the application load by 14% with the help of the new icon design</a></li>
<li><a href="../335750/index.html">Binary search in javascript. Practical example</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>