<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>GitLab for Continuous Delivery project on InterSystems technologies: Containers</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="This article is a continuation of an article about the organization of Continuous Integration / Continuous Delivery processes that automate the assemb...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>GitLab for Continuous Delivery project on InterSystems technologies: Containers</h1><div class="post__text post__text-html js-mediator-article"><p>  This article is a continuation of an <a href="https://habr.com/company/intersystems/blog/354158/">article</a> about the organization of <a href="https://ru.wikipedia.org/wiki/%25D0%259D%25D0%25B5%25D0%25BF%25D1%2580%25D0%25B5%25D1%2580%25D1%258B%25D0%25B2%25D0%25BD%25D0%25B0%25D1%258F_%25D0%25B8%25D0%25BD%25D1%2582%25D0%25B5%25D0%25B3%25D1%2580%25D0%25B0%25D1%2586%25D0%25B8%25D1%258F">Continuous Integration</a> / Continuous Delivery processes that automate the assembly, testing and delivery of applications applicable to solutions on the InterSystems platform. </p><br><p>  Consider topics such as: </p><br><ul><li>  Containers 101 </li><li>  Containers at different stages of the software development cycle </li><li>  Continuous Delivery with Containers <a name="habracut"></a></li></ul><br><h1 id="konteynery-101">  Containers 101 </h1><br><p>  A lot of articles and books have been written about containers and containerization, so here I will make a small introduction, which, however, does not pretend to any finality.  So, let's begin. </p><br><p>  Containers, technically, is a virtualization method in which the operating system kernel supports several isolated instances of user space (containers), instead of one.  It clearly looks like this: </p><br><p><img src="https://habrastorage.org/getpro/habr/post_images/114/c21/985/114c21985549c134bf91685e2b15d1d3.jpg" alt="Docker vs VM"></p><br><p>  It is important to note that containers are not virtual machines, here‚Äôs a <a href="https://blog.docker.com/2016/03/containers-are-not-vms/">good article</a> about their differences. </p><br><h2 id="preimuschestva-konteynerov">  Container Benefits </h2><br><p>  There are several advantages to using containers: </p><br><ul><li>  Portability </li><li>  Efficiency </li><li>  Insulation </li><li>  Ease </li><li>  Immutability </li></ul><br><h3 id="portativnost">  Portability </h3><br><p>  The container contains the application along with all the dependencies.  This makes it easy to run applications in various environments, such as physical servers, virtual machines, testing environments and product environments, clouds. </p><br><p>  Also portability is that after the Docker image is assembled and it works correctly, it will work anywhere if the Docker works there.  on Windows, Linux and MacOS servers. </p><br><h3 id="effektivnost">  Efficiency </h3><br><p>  When working with virtual machine applications, are OS processes, system programs, etc. really necessary?  As a rule, no, only the process of your application is interesting.  Containers provide just that: only those processes that are obviously needed, and nothing more, are started in the container.  Because containers do not require a separate operating system, they use fewer resources.  A virtual machine often takes several gigabytes, but a container can be just a few megabytes in size, which allows you to run many more containers than virtual machines on a single server. </p><br><p>  Because containers have a higher level of server utilization, less hardware is required, which leads to cost savings. </p><br><h3 id="izolyaciya">  Insulation </h3><br><p>  Containers isolate the application from all other processes, and although several containers can run on the same server, they can be completely independent of each other.  Any interaction between containers must be explicitly declared.  If one container fails, it does not affect other containers and can be quickly restarted.  Security is also enhanced by this isolation.  For example, exploiting a web server's vulnerability on a host could give an attacker access to the entire server, but in the case of a container, an attacker would gain access to the web server container only. </p><br><h3 id="lyogkost">  Ease </h3><br><p>  Since containers do not require a separate OS, they can be started, stopped or reloaded in a matter of seconds, which will speed up all related processes, including Continuous Integration processes.  You can start developing faster and not waste time on setting up the environment. </p><br><h3 id="neizmennost-immutability">  Immutability </h3><br><p>  The immutable infrastructure consists of immutable components that are replaced for each deployment and not updated.  Constancy reduces inconsistency and allows you to easily and quickly replicate and move between different states of your application.  <a href="https://blog.codeship.com/immutable-infrastructure/">More on immutability</a> . </p><br><h2 id="novye-vozmozhnosti">  New opportunities </h2><br><p>  All these advantages allow you to manage your infrastructure and applications in new ways. </p><br><h3 id="orkestraciya">  Orchestration </h3><br><p>  Over the course of time, virtual machines and servers often acquire "individuality", which leads to many usually unpleasant surprises in the future.  One of the solutions to this problem is <a href="https://en.wikipedia.org/wiki/Infrastructure_as_Code">Infrastructure as a code</a> (IoC) - infrastructure management using a descriptive model using a version control system. </p><br><p>  When using IoC, the environment deployment command always brings the target environment into the same configuration, regardless of the initial state of the environment.  This is achieved by automatically setting up the existing environment or by re-creating the environment from scratch. </p><br><p>  Using IoC, developers make changes to the description of the environment.  Subsequently, the target environment is modified to the new state.  If it is necessary to make changes on Wednesday, its description is edited. </p><br><p>  All this is much easier to do with containers.  Turning off the container and launching a new one takes a few seconds, and allocating a new virtual machine takes several minutes. </p><br><h3 id="masshtabirovanie">  Scaling </h3><br><p>  Orchestration tools can also scale out based on the current load.  It is possible to run as many containers as currently required, and scale the application accordingly.  All this also reduces the cost of the application. </p><br><h1 id="konteynery-na-raznyh-etapah-zhiznennogo-cikla-po">  Containers at different stages of the software life cycle </h1><br><p>  Consider the advantages of containers at different stages of the software life cycle. </p><br><p><img src="https://habrastorage.org/getpro/habr/post_images/639/58e/062/63958e06271594a0c8fbe5a8e8785ca7.png" alt="Software life cycle"></p><br><h2 id="razrabotka">  Development </h2><br><p> The most important advantage is the ease of starting development.  After <a href="">installing Docker</a> , just run two commands: <code>docker pull</code> to load the image and <code>docker run</code> to launch it.  All dependencies are already resolved at the application build stage. </p><br><h2 id="otladka">  Debugging </h2><br><p>  All environments are consistent and their definitions exist, and it‚Äôs easy to deploy the necessary environment.  It is enough to make a <code>docker pull</code> the container of interest and launch it. </p><br><h2 id="testirovanie--qa">  Testing / QA </h2><br><p>  In case of an error, the problematic environment and the conditions for the reproduction of the error can be transferred with the container.  All infrastructure changes are ‚Äúdocumented‚Äù.  The number of variables decreases - versions of libraries, frameworks, OS ... It is possible to launch several containers to parallelize tests. </p><br><h2 id="dostavka">  Delivery </h2><br><p>  The use of containers allows you to build once, in addition to the use of containers requires a high level of automation of the processes of assembly and deployment of the application.  Shipping an application using containers can be safer with additional isolation. </p><br><h1 id="continuous-delivery">  Continuous delivery </h1><br><p>  Let's move from theory to practice.  Here is a general view of our solution for automating assembly and delivery: </p><br><p><img src="https://habrastorage.org/webt/yv/dn/qc/yvdnqcgyrlswgft4-zhnm-2mabc.png" alt="CD"></p><br><p>  There are three main stages: </p><br><ul><li>  Assembly </li><li>  Delivery </li><li>  Launch </li></ul><br><h2 id="sborka">  Assembly </h2><br><p>  In the previous article, the build was incremental ‚Äî we considered the difference between the current environment and the new code base and modified our environment to match the new code base.  With containers each assembly is complete.  The result of the assembly is a Docker Image image that can be run anywhere. </p><br><h2 id="dostavka-1">  Delivery </h2><br><p>  After our image is compiled and tested, it is downloaded to the Docker Registry - a specialized application for hosting Docker Image.  There he can replace the previous image with the same name (tag).  For example, because of a new commit to the master branch, we have compiled a new image ( <code>MyProject/MyApp:master</code> ), and if the tests are passed, we can update the image in the Docker Registry and everyone who downloads <code>MyProject/MyApp:master</code> will receive a new version. </p><br><h2 id="zapusk">  Launch </h2><br><p>  Finally, the image needs to be run.  A CD system, such as GitLab, can manage it both directly and with the help of a specialized orchestrator, but the process is generally the same - some images are run, periodically checked for performance and updated if a new version becomes available. </p><br><p>  Watch the <a href="https://blog.docker.com/2018/02/ci-cd-with-docker-ee/">webinar</a> explaining these steps. </p><br><p>  Alternatively, in terms of commit: </p><br><p><img src="https://habrastorage.org/getpro/habr/post_images/ced/48d/84c/ced48d84c0a2213b3bd9c2bda109146e.png"></p><br><p>  In our continuous delivery configuration, we: </p><br><ul><li>  Commit the code to the GitLab repository. </li><li>  We collect image </li><li>  We test it </li><li>  We publish a new image in our Docker Registry </li><li>  Let's update the old container to the new version from Docker Registry </li></ul><br><p>  For this we need: </p><br><ul><li>  Docker </li><li>  Docker registry </li><li>  Registered Domain (optional, but desirable) </li><li>  GUI tools (optional) </li></ul><br><h3 id="docker">  Docker </h3><br><p>  First of all, we need to run Docker.  I would advise starting with a single server with a common version of Linux, such as Ubuntu, RHEL or Suse.  I do not recommend starting with distributions such as CoreOS, RancherOS, etc. - they are not aimed at beginners.  <a href="">Remember to switch the storage driver to devicemapper</a> . </p><br><p>  If we talk about large-scale deployment, then using the tools of orchestration, such as Kubernetes, Rancher or Swarm, you can automate most of the tasks, but we will not discuss them (at least in the framework of this article). </p><br><h3 id="docker-registry">  Docker registry </h3><br><p>  This is the first container that we need to run, a standalone application that allows you to store and distribute Docker images.  You need to use the Docker Registry if you want: </p><br><ul><li>  Control where your images are stored </li><li>  Own an image distribution server </li><li>  Integrate the storage and distribution of images in the development process </li></ul><br><p>  Here is the <a href="https://docs.docker.com/registry/">documentation</a> for launching and configuring Docker Registry. </p><br><h3 id="podklyuchenie-docker-registry-i-gitlab">  Connecting Docker Registry and GitLab </h3><br><p>  To connect the Docker Registry to GitLab, you need to run Docker Registry with <a href="https://docs.docker.com/registry/configuration/">HTTPS support</a> .  I use Let's Encrypt to get certificates, and I followed <a href="https://gist.github.com/PieterScheffers/63e4c2fd5553af8a35101b5e868a811e">this instruction</a> to get a certificate.  After making sure that the Docker Registry is available over HTTPS (you can check it in the browser), follow <a href="https://docs.gitlab.com/ee/administration/container_registry.html">these instructions</a> for connecting the Docker Registry to GitLab.  These instructions vary depending on your GitLab installation and the required configuration.  In my case, the configuration was to add the Docker Registry certificate and key in <code>/etc/gitlab/ssl</code> , and these lines in <code>/etc/gitlab/gitlab.rb</code> : </p><br><pre> <code class="hljs nginx"><span class="hljs-attribute"><span class="hljs-attribute">registry_external_url</span></span> <span class="hljs-string"><span class="hljs-string">'https://docker.domain.com'</span></span> gitlab_rails [<span class="hljs-string"><span class="hljs-string">'registry_api_url'</span></span>] = <span class="hljs-string"><span class="hljs-string">"https://docker.domain.com"</span></span></code> </pre> <br><p>  After <a href="https://docs.gitlab.com/ee/administration/restart_gitlab.html">reconfiguring GitLab</a> , a new Registry tab has appeared, which provides information on how to properly name the created images so that they appear here. </p><br><p><img src="https://habrastorage.org/getpro/habr/post_images/a54/6b0/f85/a546b0f853ab022249ef03232927461d.png"></p><br><h3 id="domen">  Domain </h3><br><p>  In our configuration of continuous delivery, we will automatically create an image for each branch, and if the image passes tests, it will be published in the Docker Registry and launched automatically, so our application will be automatically deployed from all branches, for example: </p><br><ul><li>  Several <code>&lt;featureName&gt;.docker.domain.com</code> branches at <code>&lt;featureName&gt;.docker.domain.com</code> </li><li>  Test version on <code>master.docker.domain.com</code> </li><li>  Experienced version on <code>preprod.docker.domain.com</code> </li><li>  Product version on <code>prod.docker.domain.com</code> </li></ul><br><p>  To do this, we need a domain name and a wildcard DNS record that redirects requests to <code>* .docker.domain.com</code> to the <code>* .docker.domain.com</code> IP address.  Alternatively, you can use different ports. </p><br><h3 id="nginx">  Nginx </h3><br><p>  Since we have several environments, we need to automatically redirect requests to subdomains to the correct container.  For this we can use Nginx as a reverse proxy.  Here is a <a href="https://cloud.google.com/community/tutorials/nginx-reverse-proxy-docker">guide</a> . </p><br><h3 id="gui-instrumenty">  GUI Tools </h3><br><p>  To get started with containers, you can use either the command line or one of the graphical interfaces.  There are many available, for example: </p><br><ul><li>  Rancher </li><li>  Microbadger </li><li>  Portainer </li><li>  Simple docker ui </li><li>  ... </li></ul><br><p>  They allow you to create containers and manage them from the GUI instead of the CLI.  This is what the Rancher looks like: </p><br><p><img src="https://habrastorage.org/getpro/habr/post_images/574/485/d9c/574485d9c01d464510f79097f6b823b4.png" alt="Rancher"></p><br><h3 id="gitlab-runner">  Gitlab runner </h3><br><p>  As before, to run scripts on other servers, we need to install the GitLab runner.  This question is described in detail in the <a href="https://habr.com/company/intersystems/blog/354158/">previous article</a> . </p><br><p>  Note that you need to use the executor Shell, not the Docker.  Executor Docker is used when you need something from inside the image, for example, when creating an Android application in a java container, and only need apk.  In our case, the artifact is a container entirely, and for this you need an executor Shell. </p><br><h1 id="konfiguraciya-continuous-delivery">  Continuous Delivery Configuration </h1><br><p>  Now that all the necessary components are configured, you can begin to create a configuration for continuous delivery. </p><br><h2 id="sborka-1">  Assembly </h2><br><p>  First, we need to build an image. </p><br><p>  Our code, as always, is stored in the repository, the CD configuration in <code>gitlab-ci.yml</code> , but in addition (for increased security) we will store several image files on the build server. </p><br><h3 id="gitlabxml">  GitLab.xml </h3><br><p>  Contains callback code for CD.  It was developed in a <a href="https://habr.com/company/intersystems/blog/354158/">previous article</a> and is available on <a href="https://github.com/intersystems-ru/GitLab">GitHub</a> .  This is a small library for downloading code, running various callbacks and test code.  It is preferable to use git submodules to include this project or something similar in your repository.  Sub-modules are better because it is easier to keep them up to date.  Another alternative is to create a release on GitLab and load it with the ADD command already at build. </p><br><h3 id="iriskey">  iris.key </h3><br><p>  License key.  It can be loaded during container assembly, and not stored on the server.  It is not safe to store the key in the repository.  You can get a trial key <a href="https://wrc.intersystems.com/wrc/">on the WRC</a> or try the <a href="https://www.intersystems.com/learn-play/">InterSystems IRIS Experience</a> . </p><br><h3 id="pwdtxt">  pwd.txt </h3><br><p>  The file containing the default password.  Again, storing a password in the repository is pretty insecure. </p><br><h3 id="load_ciscript">  load_ci.script </h3><br><p>  A script that: </p><br><ul><li>  Enables <a href="">OS authentication</a> with InterSystems IRIS </li><li>  Downloads GitLab.xml </li><li>  Initializes GitLab callback settings </li><li>  Loads the code </li></ul><br><pre> <code class="hljs kotlin"><span class="hljs-keyword"><span class="hljs-keyword">set</span></span> sc = ##Class(Security.System).Get(<span class="hljs-string"><span class="hljs-string">"SYSTEM"</span></span>,.Properties) write:(<span class="hljs-string"><span class="hljs-string">'sc) $System.Status.GetErrorText(sc) set AutheEnabled = Properties("AutheEnabled") set AutheEnabled = $ZBOOLEAN(+AutheEnabled,16,7) set Properties("AutheEnabled") = AutheEnabled set sc = ##Class(Security.System).Modify("SYSTEM",.Properties) write:('</span></span>sc) $System.Status.GetErrorText(sc) zn <span class="hljs-string"><span class="hljs-string">"USER"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> ##<span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span></span>(%SYSTEM.OBJ).Load(##<span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span></span>(%File).ManagerDirectory() _ <span class="hljs-string"><span class="hljs-string">"GitLab.xml"</span></span>,<span class="hljs-string"><span class="hljs-string">"cdk"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> ##<span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span></span>(isc.git.Settings).setSetting(<span class="hljs-string"><span class="hljs-string">"hooks"</span></span>, <span class="hljs-string"><span class="hljs-string">"MyApp/Hooks/"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> ##<span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span></span>(isc.git.Settings).setSetting(<span class="hljs-string"><span class="hljs-string">"tests"</span></span>, <span class="hljs-string"><span class="hljs-string">"MyApp/Tests/"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> ##<span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span></span>(isc.git.GitLab).load() halt</code> </pre> <br><p>  Note that the first line is intentionally left blank.  If this initial script is always the same, you can simply save it in the repository. </p><br><h2 id="gitlab-ciyml">  gitlab-ci.yml </h2><br><p>  Now, let's move on to the configuration of continuous delivery: </p><br><pre> <code class="hljs bash">build image: stage: build tags: - <span class="hljs-built_in"><span class="hljs-built_in">test</span></span> script: - cp -r /InterSystems/mount ci - <span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> ci - <span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> <span class="hljs-string"><span class="hljs-string">'SuperUser'</span></span> | cat - pwd.txt load_ci.script &gt; temp.txt - mv temp.txt load_ci.script - <span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> .. - docker build --build-arg CI_PROJECT_DIR=<span class="hljs-variable"><span class="hljs-variable">$CI_PROJECT_DIR</span></span> -t docker.domain.com/<span class="hljs-built_in"><span class="hljs-built_in">test</span></span>/docker:<span class="hljs-variable"><span class="hljs-variable">$CI_COMMIT_REF_NAME</span></span> .</code> </pre> <br><p>  What's going on here? </p><br><p>  First of all, since <a href="https://docs.docker.com/engine/reference/commandline/build/">the image build process</a> can access only the subdirectories of the base directory ‚Äî in our case, the root directory of the repository, you need to copy the ‚Äúsecret‚Äù directory (in which there is <code>GitLab.xml</code> , <code>iris.key</code> , <code>pwd.txt</code> and <code>load_ci.skript</code> ) to cloned repository. </p><br><p>  Further, access to the terminal requires a user / password, so we add them to <code>load_ci.script</code> (for this we need an empty line at the beginning of <code>load_ci.script</code> ). </p><br><p>  Finally, we create a Docker Image and call it: <code>docker.domain.com/test/docker:$CI_COMMIT_REF_NAME</code> </p><br><p>  where <code>$CI_COMMIT_REF_NAME</code> is the name of the branch.  Please note: the first part of the image tag must match the repository name in GitLab so that it can be seen on the Registry tab (more complete instructions on correct tagging are available there too). </p><br><h3 id="dockerfile">  Dockerfile </h3><br><p>  Docker Image is created using <a href="https://docs.docker.com/engine/reference/builder/">Dockerfile</a> , here it is: </p><br><pre> <code class="hljs mel">FROM docker.intersystems.com/intersystems/iris:<span class="hljs-number"><span class="hljs-number">2018.1</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span><span class="hljs-number"><span class="hljs-number">.613</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span> ENV SRC_DIR=/tmp/src ENV CI_DIR=$SRC_DIR/ci ENV CI_PROJECT_DIR=$SRC_DIR COPY ./ $SRC_DIR RUN cp $CI_DIR/iris.key $ISC_PACKAGE_INSTALLDIR/mgr/ \ &amp;&amp; cp $CI_DIR/GitLab.xml $ISC_PACKAGE_INSTALLDIR/mgr/ \ &amp;&amp; $ISC_PACKAGE_INSTALLDIR/dev/Cloud/ICM/changePassword.sh $CI_DIR/<span class="hljs-keyword"><span class="hljs-keyword">pwd</span></span>.txt \ &amp;&amp; iris start $ISC_PACKAGE_INSTANCENAME \ &amp;&amp; irissession $ISC_PACKAGE_INSTANCENAME -U%SYS &lt; $CI_DIR/load_ci.script \ &amp;&amp; iris stop $ISC_PACKAGE_INSTANCENAME quietly</code> </pre> <br><p>  The following actions are performed: </p><br><ul><li>  We take the image of InterSystems IRIS as a basis.  It should be in your Docker Registry.  If you didn‚Äôt work with Docker before, try <a href="">First Look: Docker</a> , which describes how to get the InterSystems IRIS image, add it to the Docker Registry and start it manually. </li><li>  First of all, copy our repository (and ‚Äúsecret‚Äù directory) inside the container. </li><li>  Copy the license key and <code>GitLab.xml</code> in the directory <code>mgr</code> . </li><li>  Change the password to the value from <code>pwd.txt</code> .  Note that <code>pwd.txt</code> is deleted during this operation. </li><li>  Runs InterSystems IRIS. </li><li>  Running <code>load_ci.script</code> . </li><li>  InterSystems IRIS stops. </li></ul><br><div class="spoiler">  <b class="spoiler_title">Here is a partial build log</b> <div class="spoiler_text"><pre> <code class="hljs perl">Running with gitlab-runner <span class="hljs-number"><span class="hljs-number">10.6</span></span>.<span class="hljs-number"><span class="hljs-number">0</span></span> (a3543a27) on docker <span class="hljs-number"><span class="hljs-number">7</span></span>b21e0c4 Using Shell executor... Running on docker... Fetching changes... Removing ci/ Removing temp.txt HEAD is now at <span class="hljs-number"><span class="hljs-number">5</span></span>ef9904 Build load_ci.script From http:<span class="hljs-regexp"><span class="hljs-regexp">//gitlab</span></span>.eduard.win/test/docker <span class="hljs-number"><span class="hljs-number">5</span></span>ef9904..<span class="hljs-number"><span class="hljs-number">9753</span></span>a8d master -&gt; origin/master Checking out <span class="hljs-number"><span class="hljs-number">9753</span></span>a8db as master... Skipping Git submodules setup $ cp -r /InterSystems/mount ci $ cd ci $ echo <span class="hljs-string"><span class="hljs-string">'SuperUser'</span></span> | cat - pwd.txt load_ci.script &gt; temp.txt $ mv temp.txt load_ci.script $ cd .. $ docker build --build-arg CI_PROJECT_DIR=$CI_PROJECT_DIR -t docker.eduard.win/test/docker:$CI_COMMIT_REF_NAME . Sending build context to Docker daemon <span class="hljs-number"><span class="hljs-number">401.4</span></span>kB Step <span class="hljs-number"><span class="hljs-number">1</span></span>/<span class="hljs-number"><span class="hljs-number">6</span></span> : FROM docker.intersystems.com/intersystems/iris:<span class="hljs-number"><span class="hljs-number">2018.1</span></span>.<span class="hljs-number"><span class="hljs-number">1.613</span></span>.<span class="hljs-number"><span class="hljs-number">0</span></span> ---&gt; cd2e53e7f85<span class="hljs-number"><span class="hljs-number">0</span></span> Step <span class="hljs-number"><span class="hljs-number">2</span></span>/<span class="hljs-number"><span class="hljs-number">6</span></span> : ENV SRC_DIR=<span class="hljs-regexp"><span class="hljs-regexp">/tmp/src</span></span> ---&gt; Using cache ---&gt; <span class="hljs-number"><span class="hljs-number">68</span></span>ba1cb00aff Step <span class="hljs-number"><span class="hljs-number">3</span></span>/<span class="hljs-number"><span class="hljs-number">6</span></span> : ENV CI_DIR=$SRC_DIR/ci ---&gt; Using cache ---&gt; <span class="hljs-number"><span class="hljs-number">6784</span></span>c34a9ee6 Step <span class="hljs-number"><span class="hljs-number">4</span></span>/<span class="hljs-number"><span class="hljs-number">6</span></span> : ENV CI_PROJECT_DIR=$SRC_DIR ---&gt; Using cache ---&gt; <span class="hljs-number"><span class="hljs-number">3757</span></span>fa88a28a Step <span class="hljs-number"><span class="hljs-number">5</span></span>/<span class="hljs-number"><span class="hljs-number">6</span></span> : COPY ./ $SRC_DIR ---&gt; <span class="hljs-number"><span class="hljs-number">5515</span></span>e13741b<span class="hljs-number"><span class="hljs-number">0</span></span> Step <span class="hljs-number"><span class="hljs-number">6</span></span>/<span class="hljs-number"><span class="hljs-number">6</span></span> : RUN cp $CI_DIR/iris.key $ISC_PACKAGE_INSTALLDIR/mgr/ &amp;&amp; cp $CI_DIR/GitLab.xml $ISC_PACKAGE_INSTALLDIR/mgr/ &amp;&amp; $ISC_PACKAGE_INSTALLDIR/dev/Cloud/ICM/changePassword.sh $CI_DIR/pwd.txt &amp;&amp; iris start $ISC_PACKAGE_INSTANCENAME &amp;&amp; irissession $ISC_PACKAGE_INSTANCENAME -U%SYS &lt; $CI_DIR/load_ci.script &amp;&amp; iris stop $ISC_PACKAGE_INSTANCENAME quietly ---&gt; Running in <span class="hljs-number"><span class="hljs-number">86526183</span></span>cf7c . Waited <span class="hljs-number"><span class="hljs-number">1</span></span> seconds <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> InterSystems IRIS to start This copy of InterSystems IRIS has been licensed <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> exclusively by: ISC Internal Container Sharding Copyright (c) <span class="hljs-number"><span class="hljs-number">1986</span></span>-<span class="hljs-number"><span class="hljs-number">2018</span></span> by InterSystems Corporation Any other <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> is a violation of your license agreement %SYS&gt; <span class="hljs-number"><span class="hljs-number">1</span></span> %SYS&gt; Using <span class="hljs-string"><span class="hljs-string">'iris.cpf'</span></span> configuration file This copy of InterSystems IRIS has been licensed <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> exclusively by: ISC Internal Container Sharding Copyright (c) <span class="hljs-number"><span class="hljs-number">1986</span></span>-<span class="hljs-number"><span class="hljs-number">2018</span></span> by InterSystems Corporation Any other <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> is a violation of your license agreement <span class="hljs-number"><span class="hljs-number">1</span></span> alert(<span class="hljs-keyword"><span class="hljs-keyword">s</span></span>) during startup. See messages.log <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> details. Starting IRIS Node: <span class="hljs-number"><span class="hljs-number">39702</span></span>b122ab6, Instance: IRIS Username: Password: Load started on <span class="hljs-number"><span class="hljs-number">04</span></span>/<span class="hljs-number"><span class="hljs-number">06</span></span>/<span class="hljs-number"><span class="hljs-number">2018</span></span> <span class="hljs-number"><span class="hljs-number">17</span></span>:<span class="hljs-number"><span class="hljs-number">38</span></span>:<span class="hljs-number"><span class="hljs-number">21</span></span> Loading file /usr/irissys/mgr/GitLab.xml as xml Load finished successfully. USER&gt; USER&gt; [<span class="hljs-number"><span class="hljs-number">2018</span></span>-<span class="hljs-number"><span class="hljs-number">04</span></span>-<span class="hljs-number"><span class="hljs-number">06</span></span> <span class="hljs-number"><span class="hljs-number">17</span></span>:<span class="hljs-number"><span class="hljs-number">38</span></span>:<span class="hljs-number"><span class="hljs-number">22.017</span></span>] Running init hooks: before [<span class="hljs-number"><span class="hljs-number">2018</span></span>-<span class="hljs-number"><span class="hljs-number">04</span></span>-<span class="hljs-number"><span class="hljs-number">06</span></span> <span class="hljs-number"><span class="hljs-number">17</span></span>:<span class="hljs-number"><span class="hljs-number">38</span></span>:<span class="hljs-number"><span class="hljs-number">22.017</span></span>] Importing hooks dir /tmp/src/MyApp/Hooks/ [<span class="hljs-number"><span class="hljs-number">2018</span></span>-<span class="hljs-number"><span class="hljs-number">04</span></span>-<span class="hljs-number"><span class="hljs-number">06</span></span> <span class="hljs-number"><span class="hljs-number">17</span></span>:<span class="hljs-number"><span class="hljs-number">38</span></span>:<span class="hljs-number"><span class="hljs-number">22.374</span></span>] Executing hook class: MyApp.Hooks.Global [<span class="hljs-number"><span class="hljs-number">2018</span></span>-<span class="hljs-number"><span class="hljs-number">04</span></span>-<span class="hljs-number"><span class="hljs-number">06</span></span> <span class="hljs-number"><span class="hljs-number">17</span></span>:<span class="hljs-number"><span class="hljs-number">38</span></span>:<span class="hljs-number"><span class="hljs-number">22.375</span></span>] Executing hook class: MyApp.Hooks.Local [<span class="hljs-number"><span class="hljs-number">2018</span></span>-<span class="hljs-number"><span class="hljs-number">04</span></span>-<span class="hljs-number"><span class="hljs-number">06</span></span> <span class="hljs-number"><span class="hljs-number">17</span></span>:<span class="hljs-number"><span class="hljs-number">38</span></span>:<span class="hljs-number"><span class="hljs-number">22.375</span></span>] Importing dir /tmp/src/ Loading file /tmp/src/MyApp/Tests/TestSuite.cls as udl Compilation started on <span class="hljs-number"><span class="hljs-number">04</span></span>/<span class="hljs-number"><span class="hljs-number">06</span></span>/<span class="hljs-number"><span class="hljs-number">2018</span></span> <span class="hljs-number"><span class="hljs-number">17</span></span>:<span class="hljs-number"><span class="hljs-number">38</span></span>:<span class="hljs-number"><span class="hljs-number">22</span></span> with qualifiers <span class="hljs-string"><span class="hljs-string">'c'</span></span> Compilation finished successfully in <span class="hljs-number"><span class="hljs-number">0</span></span>.<span class="hljs-number"><span class="hljs-number">194</span></span>s. Load finished successfully. [<span class="hljs-number"><span class="hljs-number">2018</span></span>-<span class="hljs-number"><span class="hljs-number">04</span></span>-<span class="hljs-number"><span class="hljs-number">06</span></span> <span class="hljs-number"><span class="hljs-number">17</span></span>:<span class="hljs-number"><span class="hljs-number">38</span></span>:<span class="hljs-number"><span class="hljs-number">22.876</span></span>] Running init hooks: after [<span class="hljs-number"><span class="hljs-number">2018</span></span>-<span class="hljs-number"><span class="hljs-number">04</span></span>-<span class="hljs-number"><span class="hljs-number">06</span></span> <span class="hljs-number"><span class="hljs-number">17</span></span>:<span class="hljs-number"><span class="hljs-number">38</span></span>:<span class="hljs-number"><span class="hljs-number">22.878</span></span>] Executing hook class: MyApp.Hooks.Local [<span class="hljs-number"><span class="hljs-number">2018</span></span>-<span class="hljs-number"><span class="hljs-number">04</span></span>-<span class="hljs-number"><span class="hljs-number">06</span></span> <span class="hljs-number"><span class="hljs-number">17</span></span>:<span class="hljs-number"><span class="hljs-number">38</span></span>:<span class="hljs-number"><span class="hljs-number">22.921</span></span>] Executing hook class: MyApp.Hooks.Global Removing intermediate container <span class="hljs-number"><span class="hljs-number">39702</span></span>b122ab6 ---&gt; dea6b2123165 [Warning] One <span class="hljs-keyword"><span class="hljs-keyword">or</span></span> more build-args [CI_PROJECT_DIR] were <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> consumed Successfully built dea6b2123165 Successfully tagged docker.domain.com/test/docker:master Job succeeded</code> </pre> </div></div><br><h2 id="zapusk-1">  Launch </h2><br><p>  We have an image, run it.  In the case of feature branches, you can simply destroy the old container and start a new one.  In the case of the product environment, we can start the temporary container first and replace the environment container in case of passing the tests. </p><br><p>  First, the script to delete the old container. </p><br><pre> <code class="hljs ruby">destroy <span class="hljs-symbol"><span class="hljs-symbol">old:</span></span> <span class="hljs-symbol"><span class="hljs-symbol">stage:</span></span> destroy <span class="hljs-symbol"><span class="hljs-symbol">tags:</span></span> - test <span class="hljs-symbol"><span class="hljs-symbol">script:</span></span> - docker stop iris-$CI_COMMIT_REF_NAME <span class="hljs-params"><span class="hljs-params">||</span></span> <span class="hljs-literal"><span class="hljs-literal">true</span></span> - docker rm -f iris-$CI_COMMIT_REF_NAME <span class="hljs-params"><span class="hljs-params">||</span></span> <span class="hljs-literal"><span class="hljs-literal">true</span></span></code> </pre> <br><p>  This script destroys the running container and always completes successfully (by default, Docker returns an error when trying to stop / delete a nonexistent container). </p><br><p>  After that we launch a new container and register it as an environment. </p><br><pre> <code class="hljs bash">run image: stage: run environment: name: <span class="hljs-variable"><span class="hljs-variable">$CI_COMMIT_REF_NAME</span></span> url: http://<span class="hljs-variable"><span class="hljs-variable">$CI_COMMIT_REF_SLUG</span></span>.docker.eduard.win/index.html tags: - <span class="hljs-built_in"><span class="hljs-built_in">test</span></span> script: - docker run -d --expose 52773 --volume /InterSystems/durable/<span class="hljs-variable"><span class="hljs-variable">$CI_COMMIT_REF_SLUG</span></span>:/data --env ISC_DATA_DIRECTORY=/data/sys --env VIRTUAL_HOST=<span class="hljs-variable"><span class="hljs-variable">$CI_COMMIT_REF_SLUG</span></span>.docker.eduard.win --name iris-<span class="hljs-variable"><span class="hljs-variable">$CI_COMMIT_REF_NAME</span></span> docker.eduard.win/<span class="hljs-built_in"><span class="hljs-built_in">test</span></span>/docker:<span class="hljs-variable"><span class="hljs-variable">$CI_COMMIT_REF_NAME</span></span> --<span class="hljs-built_in"><span class="hljs-built_in">log</span></span> <span class="hljs-variable"><span class="hljs-variable">$ISC_PACKAGE_INSTALLDIR</span></span>/mgr/messages.log</code> </pre> <br><p>  <a href="https://cloud.google.com/community/tutorials/nginx-reverse-proxy-docker">The Nginx container</a> automatically redirects requests using the <code>VIRTUAL_HOST</code> environment <code>VIRTUAL_HOST</code> to the specified port - in this case 52773. </p><br><p>  Since it is necessary to store some data (passwords,% SYS, application data), the <a href="">Durable% SYS</a> functionality exists on the host in InterSystems IRIS, allowing you to store data on the host such as: </p><br><ul><li>  <code>iris.cpf</code> is the main configuration file. </li><li>  <code>/csp</code> with web application files. </li><li>  <code>/httpd/httpd.conf</code> with Apache private server configuration. </li><li>  Directory <code>/mgr</code> , which stores: <br><ul><li>  <code>IRISSYS</code> , <code>IRISTEMP</code> , <code>IRISAUDIT</code> , <code>IRIS</code> , <code>USER</code> databases. </li><li>  <code>IRIS.WIJ</code> . </li><li>  Directory <code>/journal</code> storing journals. </li><li>  <code>/temp</code> directory for temporary files. </li><li>  Logs <code>messages.log</code> , <code>journal.log</code> , <code>SystemMonitor.log</code> . </li></ul></li></ul><br><p>  To enable Durable% SYS, the <code>volume</code> argument is the mount directory of the host and the variable <code>ISC_DATA_DIRECTORY</code> sets the directory for storing the Durable% SYS files.  This directory should not exist, it will be created automatically. </p><br><p>  Thus, the architecture of our containerized application is as follows: </p><br><p><img src="https://habrastorage.org/webt/61/0q/ze/610qzezlqdilphfkapj5vac9t84.png" alt="containerized application architecture"></p><br><p>  To build such an application, we must at least create one additional database (to save the application code) and create its mapping into the application area.  I used the <code>USER</code> area to store application data, because this area is added by default to Durable% SYS.  The application code is stored in a container so that it can be updated. </p><br><p>  Based on the above, <a href="https://habr.com/company/intersystems/blog/268767/">% Installer</a> should: </p><br><ul><li>  Create <code>APP</code> Area / Database </li><li>  Upload code to <code>APP</code> area </li><li>  Create mapping classes of our application in the <code>USER</code> area </li><li>  Perform other configuration (I created a CSP web application and a REST web application) </li></ul><br><div class="spoiler">  <b class="spoiler_title">% Installer code</b> <div class="spoiler_text"><pre> <code class="hljs pgsql"><span class="hljs-keyword"><span class="hljs-keyword">Class</span></span> MyApp.Hooks.<span class="hljs-keyword"><span class="hljs-keyword">Local</span></span> { Parameter Namespace = "APP"; /// See <span class="hljs-keyword"><span class="hljs-keyword">generated</span></span> code <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> zsetup+<span class="hljs-number"><span class="hljs-number">1</span></span>^MyApp.Hooks.<span class="hljs-keyword"><span class="hljs-keyword">Local</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span> XData Install [ XMLNamespace = INSTALLER ] { &lt;Manifest&gt; &lt;<span class="hljs-keyword"><span class="hljs-keyword">Log</span></span> <span class="hljs-type"><span class="hljs-type">Text</span></span>="Creating namespace ${Namespace}" <span class="hljs-keyword"><span class="hljs-keyword">Level</span></span>="0"/&gt; &lt;Namespace <span class="hljs-type"><span class="hljs-type">Name</span></span>="${Namespace}" <span class="hljs-keyword"><span class="hljs-keyword">Create</span></span>="yes" Code="${Namespace}" Ensemble="" Data="IRISTEMP"&gt; &lt;<span class="hljs-keyword"><span class="hljs-keyword">Configuration</span></span>&gt; &lt;<span class="hljs-keyword"><span class="hljs-keyword">Database</span></span> <span class="hljs-type"><span class="hljs-type">Name</span></span>="${Namespace}" Dir="/usr/irissys/mgr/${Namespace}" <span class="hljs-keyword"><span class="hljs-keyword">Create</span></span>="yes" MountRequired="true" Resource="%DB_${Namespace}" PublicPermissions="RW" MountAtStartup="true"/&gt; &lt;/<span class="hljs-keyword"><span class="hljs-keyword">Configuration</span></span>&gt; &lt;<span class="hljs-keyword"><span class="hljs-keyword">Import</span></span> File="${Dir}Form" Recurse="1" Flags="cdk" IgnoreErrors="1" /&gt; &lt;/Namespace&gt; &lt;<span class="hljs-keyword"><span class="hljs-keyword">Log</span></span> <span class="hljs-type"><span class="hljs-type">Text</span></span>="End Creating namespace ${Namespace}" <span class="hljs-keyword"><span class="hljs-keyword">Level</span></span>="0"/&gt; &lt;<span class="hljs-keyword"><span class="hljs-keyword">Log</span></span> <span class="hljs-type"><span class="hljs-type">Text</span></span>="Mapping to USER" <span class="hljs-keyword"><span class="hljs-keyword">Level</span></span>="0"/&gt; &lt;Namespace <span class="hljs-type"><span class="hljs-type">Name</span></span>="USER" <span class="hljs-keyword"><span class="hljs-keyword">Create</span></span>="no" Code="USER" Data="USER" Ensemble="0"&gt; &lt;<span class="hljs-keyword"><span class="hljs-keyword">Configuration</span></span>&gt; &lt;<span class="hljs-keyword"><span class="hljs-keyword">Log</span></span> <span class="hljs-type"><span class="hljs-type">Text</span></span>="Mapping Form package to USER namespace" <span class="hljs-keyword"><span class="hljs-keyword">Level</span></span>="0"/&gt; &lt;ClassMapping <span class="hljs-keyword"><span class="hljs-keyword">From</span></span>="${Namespace}" Package="Form"/&gt; &lt;RoutineMapping <span class="hljs-keyword"><span class="hljs-keyword">From</span></span>="${Namespace}" <span class="hljs-keyword"><span class="hljs-keyword">Routines</span></span>="Form" /&gt; &lt;/<span class="hljs-keyword"><span class="hljs-keyword">Configuration</span></span>&gt; &lt;CSPApplication Url="/" Directory="${Dir}client" AuthenticationMethods="64" IsNamespaceDefault="false" <span class="hljs-keyword"><span class="hljs-keyword">Grant</span></span>="%ALL" Recurse="1" /&gt; &lt;/Namespace&gt; &lt;/Manifest&gt; } /// This <span class="hljs-keyword"><span class="hljs-keyword">is</span></span> a <span class="hljs-keyword"><span class="hljs-keyword">method</span></span> generator whose code <span class="hljs-keyword"><span class="hljs-keyword">is</span></span> <span class="hljs-keyword"><span class="hljs-keyword">generated</span></span> <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> XGL. /// Main setup <span class="hljs-keyword"><span class="hljs-keyword">method</span></span> /// <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> vars("Namespace")="TEMP3" /// <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> ##<span class="hljs-keyword"><span class="hljs-keyword">class</span></span>(MyApp.Hooks.<span class="hljs-keyword"><span class="hljs-keyword">Global</span></span>).setup(.vars) ClassMethod setup(ByRef pVars, pLogLevel <span class="hljs-keyword"><span class="hljs-keyword">As</span></span> %<span class="hljs-type"><span class="hljs-type">Integer</span></span> = <span class="hljs-number"><span class="hljs-number">0</span></span>, pInstaller <span class="hljs-keyword"><span class="hljs-keyword">As</span></span> %Installer.Installer) <span class="hljs-keyword"><span class="hljs-keyword">As</span></span> %Status [ CodeMode = objectgenerator, <span class="hljs-type"><span class="hljs-type">Internal</span></span> ] { Quit ##<span class="hljs-keyword"><span class="hljs-keyword">class</span></span>(%Installer.Manifest).%Generate(%compiledclass, %code, "Install") } /// Entry <span class="hljs-type"><span class="hljs-type">point</span></span> ClassMethod onAfter() <span class="hljs-keyword"><span class="hljs-keyword">As</span></span> %Status { try { <span class="hljs-keyword"><span class="hljs-keyword">write</span></span> "START INSTALLER",! <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> vars("Namespace") = ..#Namespace <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> vars("Dir") = ..getDir() <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> sc = ..setup(.vars) <span class="hljs-keyword"><span class="hljs-keyword">write</span></span> !,$<span class="hljs-keyword"><span class="hljs-keyword">System</span></span>.Status.GetErrorText(sc),! <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> sc = ..createWebApp() } catch ex { <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> sc = ex.AsStatus() <span class="hljs-keyword"><span class="hljs-keyword">write</span></span> !,$<span class="hljs-keyword"><span class="hljs-keyword">System</span></span>.Status.GetErrorText(sc),! } quit sc } /// Modify web app REST ClassMethod createWebApp(appName <span class="hljs-keyword"><span class="hljs-keyword">As</span></span> %String = "/forms") <span class="hljs-keyword"><span class="hljs-keyword">As</span></span> %Status { <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>:$e(appName)<span class="hljs-string"><span class="hljs-string">'="/" appName = "/" _ appName #dim sc As %Status = $$$OK new $namespace set $namespace = "%SYS" if '</span></span>##<span class="hljs-keyword"><span class="hljs-keyword">class</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">Security</span></span>.Applications).<span class="hljs-keyword"><span class="hljs-keyword">Exists</span></span>(appName) { <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> props("AutheEnabled") = $$<span class="bash"><span class="hljs-variable"><span class="bash"><span class="hljs-variable">$AutheUnauthenticated</span></span></span><span class="bash"> </span><span class="hljs-built_in"><span class="bash"><span class="hljs-built_in">set</span></span></span><span class="bash"> props(</span><span class="hljs-string"><span class="bash"><span class="hljs-string">"NameSpace"</span></span></span><span class="bash">) = </span><span class="hljs-string"><span class="bash"><span class="hljs-string">"USER"</span></span></span><span class="bash"> </span><span class="hljs-built_in"><span class="bash"><span class="hljs-built_in">set</span></span></span><span class="bash"> props(</span><span class="hljs-string"><span class="bash"><span class="hljs-string">"IsNameSpaceDefault"</span></span></span><span class="bash">) = $$</span></span>$<span class="hljs-keyword"><span class="hljs-keyword">NO</span></span> <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> props("DispatchClass") = "Form.REST.Main" <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> props("MatchRoles")=":" _ $$<span class="bash"><span class="hljs-variable"><span class="bash"><span class="hljs-variable">$AllRoleName</span></span></span><span class="bash"> </span><span class="hljs-built_in"><span class="bash"><span class="hljs-built_in">set</span></span></span><span class="bash"> sc = </span><span class="hljs-comment"><span class="bash"><span class="hljs-comment">##class(Security.Applications).Create(appName, .props) } quit sc } ClassMethod getDir() [ CodeMode = expression ] { ##class(%File).NormalizeDirectory($system.Util.GetEnviron("CI_PROJECT_DIR")) } }</span></span></span></span></code> </pre> </div></div><br><p>  I note that to create a database not on the host, I use the <code>/usr/irissys/mgr</code> directory, because the call to <code>##class(%File).ManagerDirectory()</code> returns the path to the directory for Durable% SYS. </p><br><h2 id="testy">  Tests </h2><br><p>  Now run the tests. </p><br><pre> <code class="hljs bash"><span class="hljs-built_in"><span class="hljs-built_in">test</span></span> image: stage: <span class="hljs-built_in"><span class="hljs-built_in">test</span></span> tags: - <span class="hljs-built_in"><span class="hljs-built_in">test</span></span> script: - docker <span class="hljs-built_in"><span class="hljs-built_in">exec</span></span> iris-<span class="hljs-variable"><span class="hljs-variable">$CI_COMMIT_REF_NAME</span></span> irissession iris -U USER <span class="hljs-string"><span class="hljs-string">"##class(isc.git.GitLab).test()"</span></span></code> </pre> <br><h2 id="dostavka-2">  Delivery </h2><br><p>  Tests passed, publish our image in the Docker Registry. </p><br><pre> <code class="hljs pgsql">publish image: stage: publish tags: - test script: - docker <span class="hljs-keyword"><span class="hljs-keyword">login</span></span> docker.<span class="hljs-keyword"><span class="hljs-keyword">domain</span></span>.com -u <span class="hljs-keyword"><span class="hljs-keyword">user</span></span> -p pass - docker push docker.<span class="hljs-keyword"><span class="hljs-keyword">domain</span></span>.com/test/docker:$CI_COMMIT_REF_NAME</code> </pre> <br><p>  Login / password can be transferred using <a href="https://docs.gitlab.com/ee/ci/variables/">secret variables</a> . </p><br><p>  Now the image is displayed on GitLab. </p><br><p><img src="https://habrastorage.org/getpro/habr/post_images/064/0b3/56f/0640b356f33ea72491c91d55399a4670.png"></p><br><p>  And other developers can download it from the Docker Registry.  On the Environments tab, all of our environments are available for viewing: </p><br><h1 id="vyvody">  findings </h1><br><p>  This series of articles discusses general approaches to continuous integration.  Automating the assembly, testing and delivery of your application on InterSystems platforms is possible and easy to implement. </p><br><p>  The use of containerization technologies will help optimize the development and deployment of applications.  Eliminating inconsistencies between environments makes testing and debugging easier.  Orchestration allows you to create scalable applications. </p><br><h1 id="ssylki">  Links </h1><br><ul><li>  <a href="https://habr.com/company/intersystems/blog/354158/">Previous article</a> </li><li>  <a href="https://community.intersystems.com/post/continuous-delivery-your-intersystems-solution-using-gitlab-index">A series of articles on the InterSystems Community</a> </li><li>  <a href="http://gitlab.eduard.win/test/docker">Code</a> </li><li>  <a href="https://github.com/intersystems-ru/GitLab">GitHub Code</a> </li></ul></div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <p>Source: <a href="https://habr.com/ru/post/420749/">https://habr.com/ru/post/420749/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../420731/index.html">Zabbix on steroids: how the Sbertech single monitoring platform is arranged</a></li>
<li><a href="../420735/index.html">We invite you to the finale of the marathon ‚ÄúFind yourself in digital‚Äù in the office of Mail.Ru Group</a></li>
<li><a href="../420737/index.html">Mini ai cup 2 or almost AgarIO - what could be done to win</a></li>
<li><a href="../420739/index.html">The box is still in the pen: why in 2018 you still need to learn languages ‚Äã‚Äãyourself</a></li>
<li><a href="../420741/index.html">Cheat sheet for programmers or "we google for you"</a></li>
<li><a href="../420753/index.html">Microservice Frontend - Modern Approach to Front Sharing</a></li>
<li><a href="../420757/index.html">Programming Contest: Trading (Results)</a></li>
<li><a href="../420761/index.html">TypeScript 3.0</a></li>
<li><a href="../420763/index.html">KDD 2018, second day, seminars</a></li>
<li><a href="../420765/index.html">Impressions of the Gemini PDA. Pocket dual-boot combine or useless toy?</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>