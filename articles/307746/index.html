<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>MongoDB as a logger for OSSIM</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Good day, dear readers! This article was conceived by me as an addition to the wonderful article by Evgeny Sokolov about using MongoDB as a logger for...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>MongoDB as a logger for OSSIM</h1><div class="post__text post__text-html js-mediator-article">  Good day, dear readers!  This article was conceived by me as an addition to the wonderful <a href="https://esguardian.ru/2016/05/28/ossim-logger-free/">article by Evgeny Sokolov</a> about using MongoDB as a logger for OSSIM (that is, a long-term repository of event logs). <a name="habracut"></a>  I supplemented the original article by Eugene with comments and explanations where, in my opinion, it was necessary for a better understanding. <br><br>  I allowed myself to copy some parts of the original article by Eugene with the permission of the author himself. <br><br><h2>  1. What is it for? </h2><br>  Those who want to use the SIEM system Alienvault OSSIM, or are already using it, probably noticed one of its main differences from the paid counterpart (Alienvault USM) - the absence of the ‚ÄúLogger‚Äù component.  Thus, the only option for storing the collected event logs is the MySQL database, which is based on OSSIM.  But the larger its volume becomes, the slower the search and the entire system begins to work.  The best option is to store a small ‚Äúoperational‚Äù volume of journals in the OSSIM database.  For long-term storage, it's better to use something else, for example, MongoDB. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h2>  2. Task statement and source data </h2><br>  <b>Task:</b> configure OSSIM to send collected event logs for storage in an external database, which is MongoDB. <br><br>  <b>Initial data:</b> <br><br><ul><li>  server with installed OSSIM (version 5.2.2 used, IP: 192.168.0.111); </li><li>  server with MongoDB installed (server running Debian 8.5, MongoDB version 3.2 database, IP: 192.168.0.77). </li></ul><br>  On the installation process, MongoDB will not stop, because  It is well described on the <a href="https://docs.mongodb.com/manual/tutorial/install-mongodb-on-debian/">official site of the system</a> . <br>  The scheme of interaction of components is shown in the figure below. <br><br><img src="https://habrastorage.org/files/5fc/901/4ae/5fc9014ae66d442295df0dea5c296977.jpg"><br>  <em><b>Figure 1</b> - Diagram of the interaction of components OSSIM and mongoDB</em> <br><br>  OSSIM consists of two main components: agent (ossim-agent) and server (ossim-server).  The agent is engaged in the processing of event logs from different sources and their normalization, i.e.  leading to a single format.  After the agent normalizes, events are transmitted to the ossim-sever component for processing (correlation, building reports, etc.).  After processing the events are placed in the MySQL database.  As part of solving the task, the agent will be configured to send normalized events to the mongoDB server, as shown in Figure 1. <br><br>  A little going into the agent code (written in python), you can see that the agent creates an object of class Event, which gives to the server.  The Event object in one of its attributes contains the raw log line from the source.  The event is transmitted to the server by the OutputPlugins class, whose code lies in /usr/share/alienvault/ossim-agent/Output.py.  If we read this code, we will see that the data output is provided not only to the server, but also to a text file, to a file in csv format, to a SQL database (to any one that the python adoDB module supports).  These options can be simply enabled in the agent configuration file in /etc/ossim/agent/config.cfg.  Various "conclusions" can be included simultaneously.  In this way, parallel transmission of events to an external logger can be enabled. <br><br><h2>  3. Decision </h2><br>  Here it is necessary to clarify that in order to implement the required functionality, it will be necessary to make edits to the code of the ossim itself, or rather, the three files responsible for processing the event logs by the agent: Output.py, Agent.py, Event.py. <br>  To solve the problem will be performed: <br><br><ul><li>  adding code to ossim files (Output.py, Agent.py, Event.py); </li><li>  configure mongoDB to receive event logs; </li><li>  Enable sending event logs to mongoDB server. </li></ul><br><h3>  3.1.  Adding code to ossim files (Output.py, Agent.py, Event.py) </h3><br>  The Output.py, Agent.py, Event.py files are located on the OSSIM server in the / usr / share / alienvault / ossim-agent folder. <br>  Modified to work with mongoDB samples of the files Output.py, Agent.py, Event.py, which can be copied to your OSSIM installation, replacing the original ones (just in case, making a backup copy of them) can be taken <a href="https://bitbucket.org/esguardian/ossim/src/7db38cae1f9f20a1e8b209773ccaeacf34077fbf/usr/share/alienvault/ossim-agent/%3Fat%3Dv.-2.1.1">via the link</a> in the OSSIM / usr / folder share / alienvault / ossim-agent / ¬ªbranches 2.1.1.  Below will be described the changes made to the original files Output.py, Agent.py, Event.py in OSSIM. <br><br>  <b>Modify Output.py</b> <br>  First of all, you need to add class code to the Output.py to create an output object.  In the GLOBAL IMPORTS section: <br><br><pre><code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># GLOBAL IMPORTS # import os import re import string import sys import uuid from pymongo import MongoClient from bson import BSON</span></span></code> </pre> <br>  Added the last two lines.  ‚ÄúFrom pymongo import MongoClient‚Äù - connects the mongoDB client module (obviously, to work with mongo).  "From bson import BSON" - connects the BSON codec (binary JSON). <br><br>  Next, the ‚ÄúOutputESGuard‚Äù class is added, which performs the transmission of events to the mongoDB server.  It looks like this: <br><br><pre> <code class="bash hljs">class OutputESGuard(OutputPlugins): def __init__(self, conf): logger.info(<span class="hljs-string"><span class="hljs-string">"Added ESGuard output"</span></span>) logger.debug(<span class="hljs-string"><span class="hljs-string">"OutputDB options: %s"</span></span> % (conf.hitems(<span class="hljs-string"><span class="hljs-string">"output-esguard"</span></span>))) self.conf = conf self.dbhost = self.conf.get(<span class="hljs-string"><span class="hljs-string">'output-esguard'</span></span>, <span class="hljs-string"><span class="hljs-string">'host'</span></span>) self.dbport = self.conf.get(<span class="hljs-string"><span class="hljs-string">'output-esguard'</span></span>, <span class="hljs-string"><span class="hljs-string">'port'</span></span>) self.dbschema = self.conf.get(<span class="hljs-string"><span class="hljs-string">'output-esguard'</span></span>, <span class="hljs-string"><span class="hljs-string">'base'</span></span>) self.dbuser = self.conf.get(<span class="hljs-string"><span class="hljs-string">'output-esguard'</span></span>, <span class="hljs-string"><span class="hljs-string">'user'</span></span>) self.dbpass = self.conf.get(<span class="hljs-string"><span class="hljs-string">'output-esguard'</span></span>, <span class="hljs-string"><span class="hljs-string">'pass'</span></span>) mongodbURI = <span class="hljs-string"><span class="hljs-string">"mongodb://"</span></span> + self.dbuser + <span class="hljs-string"><span class="hljs-string">":"</span></span> + self.dbpass + <span class="hljs-string"><span class="hljs-string">"@"</span></span> + self.dbhost + <span class="hljs-string"><span class="hljs-string">":"</span></span> + self.dbport + <span class="hljs-string"><span class="hljs-string">"/"</span></span> + self.dbschema try : self.conn = MongoClient(mongodbURI) self.log_db = self.conn[self.dbschema] self.event_coll = self.log_db[<span class="hljs-string"><span class="hljs-string">'logger'</span></span>] self.activated = True except Exception, e: logger.error(<span class="hljs-string"><span class="hljs-string">": Error connecting to Mongodb %s"</span></span> % (e)) def event(self, e): <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> e[<span class="hljs-string"><span class="hljs-string">"event_type"</span></span>] == <span class="hljs-string"><span class="hljs-string">"event"</span></span> and self.activated: try : self.event_coll.insert_one(BSON.decode(e.to_bson_esguard())) except : logger.error(<span class="hljs-string"><span class="hljs-string">": Error insert data to mongodb log_coll. Plugin_id is %s. Retry as binary"</span></span> % (e[<span class="hljs-string"><span class="hljs-string">'plugin_id'</span></span>])) self.event_coll.insert_one(BSON.decode(e.to_bson())) def shutdown(self): logger.info(<span class="hljs-string"><span class="hljs-string">"Closing ESGuard output .."</span></span>) self.conn.close() self.activated = False</code> </pre> <br>  Also in Output.py, the add_esguard_output method was added to the Output class code: <br><br><pre> <code class="bash hljs">@staticmethod def add_esguard_output(conf): <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> Output.esguard_output is False: Output._outputs.append(OutputESGuard(conf)) Output.esguard_output = True</code> </pre> <br>  <b>Modification of Event.py</b> <br>  The method to_bson_esguard () (which is used by the event method in output.py) has been added to the Event class code (/usr/share/alienvault/ossim-agent/Event.py).  This method (to_bson_esguard ()) is a copy of the existing to_bson method with one difference.  In the standard method, the attribute log (it contains the event in its raw form) is declared as binary and is recorded in Base64.  We also need text in utf8 there.  That is what was changed. <br><br>  However, not all plugins write payload text.  There is, for example, Suricata, which can put binary data there.  This does not always happen.  Usually, too, the text, but sometimes - a stream of bytes.  When trying to push a binary to the server in a field described as text, it returns a parser error utf8.  To prevent such an error, pass to the try block.  If an error occurs, the event is recoded using the standard to_bson () method and sent to the server again. <br><br>  <b>Modification Agent.py</b> <br>  In Agent.py, you need to add a section for reading and processing the configuration file (/etc/ossim/agent/config.cfg), checking for the presence of the section [output-esguard] and reading the parameters specified in it.  In this section, the IP address and credentials of the mongoDB server will be specified, to which the event logs are sent. <br><br><pre> <code class="bash hljs">def init_output(self): <span class="hljs-string"><span class="hljs-string">''</span></span><span class="hljs-string"><span class="hljs-string">' Initialize Outputs '</span></span><span class="hljs-string"><span class="hljs-string">''</span></span> printEvents = True <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> self.conf.has_section(<span class="hljs-string"><span class="hljs-string">"output-properties"</span></span>): printEvents = self.conf.getboolean(<span class="hljs-string"><span class="hljs-string">"output-properties"</span></span>, <span class="hljs-string"><span class="hljs-string">"printEvents"</span></span>) Output.print_ouput_events(printEvents) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> self.conf.has_section(<span class="hljs-string"><span class="hljs-string">"output-plain"</span></span>): <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> self.conf.getboolean(<span class="hljs-string"><span class="hljs-string">"output-plain"</span></span>, <span class="hljs-string"><span class="hljs-string">"enable"</span></span>): Output.add_plain_output(self.conf) <span class="hljs-comment"><span class="hljs-comment"># output-server is enabled in connect_server() # if the connection becomes availble if self.conf.has_section("output-csv"): if self.conf.getboolean("output-csv", "enable"): Output.add_csv_output(self.conf) if self.conf.has_section("output-db"): if self.conf.getboolean("output-db", "enable"): Output.add_db_output(self.conf) if self.conf.has_section("output-esguard"): if self.conf.getboolean("output-esguard", "enable"): Output.add_esguard_output(self.conf)</span></span></code> </pre> <br><h3>  3.2.  Configure mongoDB to receive event logs </h3><br>  The minimum mongoDB setting implies: <br><br><ul><li>  creating a user to connect to the database; </li><li>  Configuring the slider to connect to the database via the network; </li><li>  enable authentication; </li></ul><br>  To create a database user, you need to connect to the database from the console of the server on which it is installed: <br><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># mongo MongoDB shell version: 3.2.8 connecting to: admin</span></span></code> </pre> <br>  Creating a user is done with the command: <br><br><pre> <code class="bash hljs">db.createUser( { user: <span class="hljs-string"><span class="hljs-string">"ossim"</span></span>, <span class="hljs-built_in"><span class="hljs-built_in">pwd</span></span>: <span class="hljs-string"><span class="hljs-string">"1q2w3e4r"</span></span>, roles: [ {role: <span class="hljs-string"><span class="hljs-string">"readWrite"</span></span>, db: <span class="hljs-string"><span class="hljs-string">"test"</span></span>} ] } )</code> </pre> <br>  With the above command, we created a user with the name ‚Äúossim‚Äù, password ‚Äú1q2w3e4r‚Äù, which has read and write access to the ‚Äútest‚Äù database.  According to the ideology of mongoDB, manually creating a database (as is customary in relational databases, the same MySQL) is not necessary.  It is created automatically, at the moment when the first record enters it. <br>  Also, for convenience, you can create a user with the privileges of creating and managing accounts of other users (so that we can manage users after we enable authentication and authorization when accessing the database): <br><br><pre> <code class="bash hljs">db.createUser( { user: <span class="hljs-string"><span class="hljs-string">"uadm"</span></span>, <span class="hljs-built_in"><span class="hljs-built_in">pwd</span></span>: <span class="hljs-string"><span class="hljs-string">"1q2w3e4r"</span></span>, roles: [ <span class="hljs-string"><span class="hljs-string">"userAdminAnyDatabase"</span></span> ] } )</code> </pre> <br>  The mongoDB installation settings ‚Äúout of the box‚Äù do not allow connecting to the database via the network; therefore, you need to comment out the ‚ÄúbindIp: 127.0.0.1‚Äù line in the ‚Äúnet‚Äù section of the configuration file "/etc/mongod.conf" (or enter which database will respond): <br><br><pre> <code class="bash hljs">net: port: 27017 <span class="hljs-comment"><span class="hljs-comment"># bindIp: 127.0.0.1</span></span></code> </pre> <br>  In addition, these same settings allow anonymous users (O_O) to connect to the database.  To enable authentication and authorization mechanisms, you need to add the "authorization: enabled" lines to the "security" section (in mongoDB version 2.x, this is done differently. If you are using version 2.x, see the official documentation on the site): <br><pre> <code class="bash hljs">security: authorization: enabled</code> </pre> <br>  And restart the server: <br><br><pre> <code class="bash hljs">/etc/init.d/mongod restart</code> </pre> <br>  Check that the KS user can work with a command from the console: <br><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># mongo localhost:27017/test -u ossim -p MongoDB shell version: 3.2.8 Enter password: connecting to: localhost:27017/test</span></span></code> </pre> <br><h3>  3.3.  Enable sending event logs to mongoDB server </h3><br>  So, at the moment, we have the ossim-agent component of the ossim server with the configured additional output of events in mongoDB and the database itself, ready to receive data over the network.  It remains only to inform the ossim agent where to send the event logs.  For this, in the configuration file of the agent (/etc/ossim/agent/config.cfg) you need to add the appropriate section.  An example of its contents is shown below: <br><br><pre> <code class="bash hljs">[output-esguard] <span class="hljs-built_in"><span class="hljs-built_in">enable</span></span>=True host=192.168.0.77 port=27017 base=<span class="hljs-built_in"><span class="hljs-built_in">test</span></span> user=ossim pass=1q2w3e4r</code> </pre> <br>  The configuration speaks for itself: the enable switch, the server's address is the host, the port is the port (default is 27017), the database name is base, the user name is user, and the password is pass. <br><br>  After editing this configuration file, it is necessary to restart the agent with the command: <br><br><pre> <code class="bash hljs">/etc/init.d/ossim-agent restart</code> </pre> <br><h2>  4. Conclusion </h2><br>  If done correctly, the events have already begun to be transmitted to mongoDB.  You can see if they appeared there using graphic clients, of which there are many (Google help) or by connecting to mongoDB via the console and running the ‚Äúshow collections‚Äù command: <br><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># mongo localhost:27017/test -u ossim -p MongoDB shell version: 3.2.8 Enter password: connecting to: localhost:27017/test &gt; show collections logger.20160810 logger.20160811 logger.20160812 logger.20160813 logger.20160814 logger.20160815</span></span></code> </pre> <br>  Thanks for attention! </div><p>Source: <a href="https://habr.com/ru/post/307746/">https://habr.com/ru/post/307746/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../307734/index.html">Systematic vulnerability of sites created on CMS 1C-Bitrix</a></li>
<li><a href="../307736/index.html">What the IT manager needs to know or learn the light, and you have to pay for the light</a></li>
<li><a href="../307738/index.html">How trading on the exchange actually works, and how it can be improved: A simple algorithm (part 4)</a></li>
<li><a href="../307740/index.html">10 proven ways to reduce productivity</a></li>
<li><a href="../307744/index.html">Development of a simple chat on Socket.IO [2016] \ Node.js</a></li>
<li><a href="../307750/index.html">Nest Admin - control panel for sites (landing page)</a></li>
<li><a href="../307752/index.html">New flash storage for Big Data from IBM: Deep Flash 150</a></li>
<li><a href="../307754/index.html">Appcelerator Releases Hyperloop</a></li>
<li><a href="../307756/index.html">Container Virtualization: Standards Coming Soon</a></li>
<li><a href="../307758/index.html">Restore from backup using Veeam Agent for Linux</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>