<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>The story of creating another robot. Part Two, "it's alive!"</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="I continue a series of publications on the creation of a simple wheeled robot on an ATmega16A microcontroller. 
 In the second part of my publication,...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>The story of creating another robot. Part Two, "it's alive!"</h1><div class="post__text post__text-html js-mediator-article">  I continue a series of publications on the creation of a simple wheeled robot on an ATmega16A microcontroller. <br>  In the <i>second</i> part of my publication, I will describe the process of creating and assembling my robot.  Let's start with the manufacture of a printed circuit board and finish the video of the first steps (or, more correctly, scrolling the wheels) of our device.  I will also pay attention to the first experience of PC programming in Qt, namely the creation of a control program and data exchange with the robot via Bluetooth. <br>  If you want, you can familiarize yourself with the <a href="http://habrahabr.ru/post/255025/">first publication</a> and find out how it all began, but I‚Äôll ask everyone else for a cat. <br><img src="https://habrastorage.org/files/bb4/e47/98b/bb4e4798b29f4307a98ec11bcb7e7d28.JPG" alt="image"><br><a name="habracut"></a><br>  The last part ended with the fact that there was a ready layout of the printed circuit board in front of us, which means that it‚Äôs time to create and transfer our idea from the electronic version to the real tangible world, doesn‚Äôt that desire lie in the mind of every radio amateur, engineer, inventor ?!  I only had 1mm textolite on my hands, so without thinking twice I began the process of transferring the track pattern to the board using standard LUT. <br><br>  I apologize for the quality of the photos, but I have a cheap phone ... <br><img src="https://habrastorage.org/files/06f/c0c/e4d/06fc0ce4d6f6409ba4e40ba12ccaf10a.jpg" alt="image"><br><br><img src="https://habrastorage.org/files/fd4/8fc/e16/fd48fce161d84b6c8f7410e52a502cc9.jpg" alt="image">
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      The next step was etching!  I tried a new method of etching with hydrogen peroxide and citric acid, which is certainly safe and very cheap, but it seemed to me too sensitive to the proportions of the components.  After an hour of magical manipulation of the container with a solution, the process went with decent strength (it is worth saying that it was possible to change the board template and then everything would have worn out much faster). <br><br><img src="https://habrastorage.org/files/79f/31b/e20/79f31be20653403190166e66c9d6e684.jpg" alt="image"><br><br><img src="https://habrastorage.org/files/55c/1b9/fa5/55c1b9fa55c7488989974312ce073458.jpg" alt="image"><br><br>  80-90% of the tracks on the board turned out well, but because  Most of the tracks were 0.2mm, mordants caught, which I removed with solder and thin conductors, thanks to them I made vias.  In general, the whole process of soldering took 3 pm. <br><br><img src="https://habrastorage.org/files/5b5/33b/796/5b533b79696b44ed80212e4431505604.JPG" alt="image"><br><br><img src="https://habrastorage.org/files/bc8/ce9/559/bc8ce955984d452b9be34147c8fa0249.JPG" alt="image"><br><br>  Motors had to be transferred to the bottom of the board, because I realized that I needed the maximum gap between the board and the surface on which I would need to drive, but still the robot turned out to be low-lying. <br>  And since we remembered the motors, we also recall the idea with the encoder, since the magnets I ordered were literally half a millimeter in diameter less than the grooves in the wheel, they had to be fixed there somehow, but as we know everything ingenious is simple - I just took them and drove them there, filling the bay with a glue gun is not very aesthetic, but quickly and practically.  The main thing is not to confuse the polarity, otherwise there will be shoals with accuracy, but it is already small - 12 magnets per wheel, i.e.  6 actuations per turn, and with a wheel diameter of 43mm, we get approximately 22mm of the distance traveled by the wheel in one operation. <br><br><img src="https://habrastorage.org/files/0e2/442/44f/0e244244fa034d42b93a099e7266579b.JPG" alt="image"><br><br>  On the board, in turn, with a small spacing in height, put the Hall sensors to understand which way we are going. <br><br><img src="https://habrastorage.org/files/622/5cb/4e4/6225cb4e4e264da48d8c953ed63fad8a.JPG" alt="image"><br><br>  To attach the battery, serva and ultrasonic rangefinder were printed on a 3D printer, the simplest parts. <br><br>  Battery holder <br><img src="https://habrastorage.org/files/cb9/e62/fff/cb9e62fffd294ab9b0291f014a18ebff.jpg" alt="image"><br><br>  Servo holder. <br><img src="https://habrastorage.org/files/57e/d8a/cc4/57ed8acc48a7465bb0b9a8958f7cde29.jpg" alt="image"><br><br>  UZ range finder holder. <br><img src="https://habrastorage.org/files/cfc/b2d/fb9/cfcb2dfb9ab04a0db90c307bf53eed10.jpg" alt="image"><br><br>  A bit of fine-tuning of the parts with a file and everything fell into place, in the end, the robot turned out like this. <br><br><img src="https://habrastorage.org/files/1b5/9f5/1ef/1b59f51ef21a4e26ba2bcf0d97c27c3b.JPG" alt="image"><br><br><img src="https://habrastorage.org/files/439/a25/d5a/439a25d5a2574a42975005169a9998cb.JPG" alt="image"><br><br>  And yes, this is just a bead, a bead on a thick wire, and this is so far the only unsolved ‚Äúproblem‚Äù of the structure.  In fact, I did not take up the decision on the question of the third wheel, because I caught fire with the wheels, the servo, etc. <br>  Due to the use of 1mm PCB, the robot seems to be fluid, but since we have a small mass, this does not affect its strength and maneuverability. <br>  Well, the first thing I wanted to ride on the line, so to speak the first experience with automated control. <br>  I‚Äôll say right away that I am not a programmer by profession and this is probably my weakest point in my hobby, so please do not criticize the code too much, in any case I am sure that I will need to rewrite the entire program in the future. <br><br>  A test program was written that implemented the PD algorithm.  It consisted of an ADC interrupt handler and the main data cycle itself. <br><br><div class="spoiler">  <b class="spoiler_title">Interrupt handler</b> <div class="spoiler_text"><pre><code class="hljs lua">#define FIRST_ADC_INPUT <span class="hljs-number"><span class="hljs-number">2</span></span> #define LAST_ADC_INPUT <span class="hljs-number"><span class="hljs-number">7</span></span> unsigned int real_adc[<span class="hljs-number"><span class="hljs-number">8</span></span>]={<span class="hljs-number"><span class="hljs-number">0</span></span>,<span class="hljs-number"><span class="hljs-number">0</span></span>,<span class="hljs-number"><span class="hljs-number">0</span></span>,<span class="hljs-number"><span class="hljs-number">0</span></span>,<span class="hljs-number"><span class="hljs-number">0</span></span>,<span class="hljs-number"><span class="hljs-number">0</span></span>,<span class="hljs-number"><span class="hljs-number">0</span></span>,<span class="hljs-number"><span class="hljs-number">0</span></span>}; unsigned <span class="hljs-built_in"><span class="hljs-built_in">char</span></span> sample_adc; volatile unsigned <span class="hljs-built_in"><span class="hljs-built_in">char</span></span> adc_ready = <span class="hljs-number"><span class="hljs-number">0</span></span>; unsigned <span class="hljs-built_in"><span class="hljs-built_in">char</span></span> leds[<span class="hljs-number"><span class="hljs-number">8</span></span>]={<span class="hljs-number"><span class="hljs-number">0x21</span></span>,<span class="hljs-number"><span class="hljs-number">0x41</span></span>,<span class="hljs-number"><span class="hljs-number">0x61</span></span>,<span class="hljs-number"><span class="hljs-number">0x63</span></span>,<span class="hljs-number"><span class="hljs-number">0x23</span></span>,<span class="hljs-number"><span class="hljs-number">0x43</span></span>}; unsigned <span class="hljs-built_in"><span class="hljs-built_in">char</span></span> adc_inputs[<span class="hljs-number"><span class="hljs-number">8</span></span>]={<span class="hljs-number"><span class="hljs-number">0</span></span>,<span class="hljs-number"><span class="hljs-number">1</span></span>,<span class="hljs-number"><span class="hljs-number">2</span></span>,<span class="hljs-number"><span class="hljs-number">4</span></span>,<span class="hljs-number"><span class="hljs-number">6</span></span>,<span class="hljs-number"><span class="hljs-number">7</span></span>,<span class="hljs-number"><span class="hljs-number">3</span></span>,<span class="hljs-number"><span class="hljs-number">5</span></span>}; interrupt [ADC_INT] void adc_isr(void) //////////////ADC_INT { static unsigned <span class="hljs-built_in"><span class="hljs-built_in">char</span></span> input_index=<span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (adc_ready == <span class="hljs-number"><span class="hljs-number">0</span></span>){ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (sample_adc == <span class="hljs-number"><span class="hljs-number">0</span></span>) { real_adc[input_index]=(signed int)(ADCW); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (input_index &lt; LAST_ADC_INPUT-FIRST_ADC_INPUT){ input_index++; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { input_index = <span class="hljs-number"><span class="hljs-number">0</span></span>; PORTB=leds[input_index]; sample_adc = <span class="hljs-number"><span class="hljs-number">1</span></span>; } ADMUX=(ADC_VREF_TYPE &amp; <span class="hljs-number"><span class="hljs-number">0xff</span></span>)+adc_inputs[(FIRST_ADC_INPUT+input_index)]; ADCSRA|=<span class="hljs-number"><span class="hljs-number">0x40</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (adc_ready==<span class="hljs-number"><span class="hljs-number">0</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (ADCW &gt; real_adc[input_index]){ real_adc[input_index]=(signed int)(ADCW); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { real_adc[input_index]=(signed int)(real_adc[input_index]); } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (input_index &lt; (LAST_ADC_INPUT-FIRST_ADC_INPUT)){ input_index++; PORTB=leds[input_index]; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { input_index = <span class="hljs-number"><span class="hljs-number">0</span></span>; adc_ready = <span class="hljs-number"><span class="hljs-number">1</span></span>; PORTB&amp;=~(<span class="hljs-number"><span class="hljs-number">1</span></span>&lt;&lt;<span class="hljs-number"><span class="hljs-number">0</span></span>); } ADMUX=(ADC_VREF_TYPE &amp; <span class="hljs-number"><span class="hljs-number">0xff</span></span>)+adc_inputs[(FIRST_ADC_INPUT+input_index)]; } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (adc_ready == <span class="hljs-number"><span class="hljs-number">0</span></span>){ ADCSRA|=<span class="hljs-number"><span class="hljs-number">0x40</span></span>; } } } }</code> </pre> <br></div></div><br><div class="spoiler">  <b class="spoiler_title">PID implementation</b> <div class="spoiler_text"><pre> <code class="hljs lua"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (adc_ready == <span class="hljs-number"><span class="hljs-number">1</span></span>) { adc_l = (real_adc[<span class="hljs-number"><span class="hljs-number">1</span></span>]+real_adc[<span class="hljs-number"><span class="hljs-number">2</span></span>]); adc_r = (real_adc[<span class="hljs-number"><span class="hljs-number">3</span></span>]+real_adc[<span class="hljs-number"><span class="hljs-number">4</span></span>]); <span class="hljs-built_in"><span class="hljs-built_in">error</span></span> = (adc_l-adc_r); delta_error = <span class="hljs-built_in"><span class="hljs-built_in">error</span></span> - old_error; //sum_error += <span class="hljs-built_in"><span class="hljs-built_in">error</span></span>; PID = Kp*<span class="hljs-built_in"><span class="hljs-built_in">error</span></span> + Kd*delta_error + Ki*sum_error; old_error = <span class="hljs-built_in"><span class="hljs-built_in">error</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (PID &gt; <span class="hljs-number"><span class="hljs-number">0</span></span>) { pwr_l += (signed int)PID ; pwr_r -= (signed int)PID ; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { pwr_l += (signed int)PID ; pwr_r -= (signed int)PID ; } <span class="hljs-keyword"><span class="hljs-keyword">for</span></span>(i=<span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; (LAST_ADC_INPUT-FIRST_ADC_INPUT)+<span class="hljs-number"><span class="hljs-number">1</span></span>; i++){ real_adc[i]=<span class="hljs-number"><span class="hljs-number">0</span></span>; } ADCSRA |= <span class="hljs-number"><span class="hljs-number">0x40</span></span>; adc_ready = <span class="hljs-number"><span class="hljs-number">0</span></span>; sample_adc = <span class="hljs-number"><span class="hljs-number">0</span></span>; }</code> </pre><br></div></div><br><br>  How glad I was to see that the robot performs the function assigned to it, not so much as on steep videos with absolutely smooth and fast line-followers, but for me even this result was an achievement. <br><br><iframe width="560" height="315" src="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://www.youtube.com/embed/kPhF3XPNS-4%3Ffeature%3Doembed&amp;xid=17259,15700022,15700186,15700190,15700248,15700253&amp;usg=ALkJrhilh1Qo-sO4A-vn6BVJlkffHZVfPQ" frameborder="0" allowfullscreen=""></iframe><br><br>  After that, I calmed down a bit with the programming part of the microcontroller itself and realized that in the future I would need to implement a robot control program from a PC and started studying Qt, and since I wrote the last program for PC only at the university (in Pascal), and that was something standard laboratory in computer science, my knowledge was in the region of zero. <br><br><div class="spoiler">  <b class="spoiler_title">offtopic, about my grandiose plans to control the robot from a smartphone and how I gave up and scored on this idea</b> <div class="spoiler_text">  In general, I initially wanted to write a program for a mobile phone on Android, but did not want to learn Java, or rather did not want to leave C, and I have a friend who fumbled in Qt and he could ask a lot of things.  At first, I myself tried to comprehend Zen of working with Qbluetooth and trying to dock with HC-05 with the help of my Chinese Jiayu g3, but every time I came across a problem that did not allow HC-05 to be friends.  At first he sinned on Qbluetooth and said that he doesn‚Äôt perceive HC-05, but on the Internet he found information that people start data exchange through the bluetooth line of HC modules using QBluetooth or write their libraries, after complaining to a friend about their hard life, friend I wrote the program in one day and still managed to exchange data with the robot, but unfortunately through my tablet.  As a result, having justified everything with the fact that my Chinese does not support rfcomm, I gave up and decided to write everything for a PC. <br></div></div><br><br>  The program was supposed to switch the operating modes of the robot (following the line, keyboard control, offline mode) and output (set) data from all sensors of interest (serves, line sensors, ultrasonic range finder, motors, encoders). <br>  After a couple of weeks, the first version of the robot control panel was written.  I liked working with the GUI in Qt - very convenient. <br><br><img src="https://habrastorage.org/files/314/ad0/bb0/314ad0bb0f33457d80cf282098187995.jpg" alt="image"><br><br>  The program code will not be better inserted, so that they do not ban me for mocking C.  In short, I‚Äôll say that the program simply takes a data availability signal in QSerialPort and collects them according to labels and widgets, in response to a timer, if necessary, sends specifying data, such as the position of the servo and the speed of the motors.  The green field in the program is in dreams - the future location map in front of the robot. <br><br>  The program accepts all available data and temporarily acts as a debugger.  He has not yet implemented control from the keyboard, and the autonomous mode is very raw and the robot is just seeing an obstacle, turns around at a given angle and tries to leave in a new direction.  In general, as I said, the project as a whole is still damp in the program part. <br><br>  In the future, I want to implement ambitious plans that stumble a little on the understanding that you need to redo both programs on the MK and PC completely, since I made a big mistake and started writing both programs like a bloated layer cake where one test module is adjacent to the other, and not as strict structured system.  But the main thing is not to give up and create further until what you planned in your head is realized in the material world, because this is the meaning of a hobby. <br><br>  P.S.  In the future I will try to write one more part of the publication, so to speak as I progress in the program part. </div><p>Source: <a href="https://habr.com/ru/post/256209/">https://habr.com/ru/post/256209/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../256197/index.html">Step-by-step instructions on how to implement uploading files to the server without reloading the page in PHP + Javascript</a></li>
<li><a href="../256199/index.html">Analysis of ARPD on the example of several small mobile applications and games</a></li>
<li><a href="../256201/index.html">CLRium: continue the tour of the cities. Ekaterinburg and Peter</a></li>
<li><a href="../256203/index.html">How and why do I write articles on Habrahabr. Personal experience</a></li>
<li><a href="../256207/index.html">Using LevelDB</a></li>
<li><a href="../256211/index.html">Multithreading in Rust</a></li>
<li><a href="../256213/index.html">How to make JSON Vulnerability Protection in the server response under Yii2</a></li>
<li><a href="../256215/index.html">Breaking gas leakage sensor</a></li>
<li><a href="../256217/index.html">What you need to know about migration to Russia by September 1, 2015 from foreign infrastructure</a></li>
<li><a href="../256221/index.html">Microsoft Research Conference - Cloud Computing for Microsoft Azure, May 19 at MSU</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>