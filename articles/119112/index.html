<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Monitoring the number of active hosts on the network</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Recently, I faced the task of determining the number of enabled computers on several subnets of our organization. The network is terribly running: the...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Monitoring the number of active hosts on the network</h1><div class="post__text post__text-html js-mediator-article">  Recently, I faced the task of determining the number of enabled computers on several subnets of our organization.  The network is terribly running: there is no domain or remote installation tools, so it was not possible to install the monitoring agent on all computers.  On the other hand, on many computers a firewall was turned on, which is why computers did not respond to a ping request. <br><br>  To solve this problem, I used a wonderful utility <b>arping</b> . <br><br><img src="https://habrastorage.org/storage/dd04364f/ab15707f/49f903f7/daf340c0.png" alt="That's what happened">
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <a name="habracut"></a><br><br>  <a href="http://en.wikipedia.org/wiki/Arping">Arping</a> works at the second level of the OSI model and is not blocked by a firewall, since  the computer must respond to ARP requests so that it can receive IP packets.  The downside to arping compared to ping is that arping works within the same local network and is not routed.  However, this restriction can be circumvented by using <a href="http://en.wikipedia.org/wiki/Proxy_ARP">ARP proxying</a> . <br><br>  To start, I wrote a simple PHP script (this is the only language I know ‚ò∫) using arping.  Networks and masks are set, and the script in a cycle pings each IP address in them: <br><blockquote>  <font color="#000000">&lt;? php</font> <br>  <font color="#666666">// set the network and masks</font> <br>  <font color="#000088">$ subnets</font> <font color="#339933">=</font> <font color="#990000">array</font> <font color="#009900">(</font> <font color="#0000ff">"192.168.0.0/255.255.255.0"</font> <font color="#339933">,</font> <font color="#0000ff">"10.10.8.0/255.255.252.0"</font> <font color="#009900">)</font> <font color="#339933">;</font> <br><br>  <font color="#000088">$ up</font> <font color="#339933">=</font> <font color="#cc66cc">0</font> <font color="#339933">;</font>  <font color="#666666">// number of live hosts</font> <br>  <font color="#b1b100">foreach</font> <font color="#009900">(</font> <font color="#000088">$ subnets</font> <font color="#b1b100">as</font> <font color="#000088">$ subnet</font> <font color="#009900">)</font> <br>  <font color="#009900">{</font> <br>  <font color="#990000">list</font> <font color="#009900">(</font> <font color="#000088">$ addr</font> <font color="#339933">,</font> <font color="#000088">$ mask</font> <font color="#009900">)</font> <font color="#339933">=</font> <font color="#990000">explode</font> <font color="#009900">(</font> <font color="#0000ff">'/'</font> <font color="#339933">,</font> <font color="#000088">$ subnet</font> <font color="#009900">)</font> <font color="#339933">;</font> <br>  <font color="#666666">// calculate the starting and ending address</font> <br>  <font color="#000088">$ start</font> <font color="#339933">=</font> <font color="#009900">(</font> <font color="#990000">ip2long</font> <font color="#009900">(</font> <font color="#000088">$ addr</font> <font color="#009900">)</font> <font color="#339933">&amp;</font> <font color="#990000">ip2long</font> <font color="#009900">(</font> <font color="#000088">$ mask</font> <font color="#009900">)</font> <font color="#009900">)</font> <font color="#339933">+</font> <font color="#cc66cc">1</font> <font color="#339933">;</font> <br>  <font color="#000088">$ end</font> <font color="#339933">=</font> <font color="#000088">$ start</font> <font color="#339933">+</font> <font color="#009900">(</font> ~ <font color="#990000">ip2long</font> <font color="#009900">(</font> <font color="#000088">$ mask</font> <font color="#009900">)</font> <font color="#009900">)</font> <font color="#339933">-</font> <font color="#cc66cc">1</font> <font color="#339933">;</font> <br>  <font color="#666666">// run through all the addresses and arping them</font> <br>  <font color="#b1b100">for</font> <font color="#009900">(</font> <font color="#000088">$ ip</font> <font color="#339933">=</font> <font color="#000088">$ start</font> <font color="#339933">;</font> <font color="#000088">$ ip</font> <font color="#339933">&lt;=</font> <font color="#000088">$ end</font> <font color="#339933">;</font> <font color="#000088">$ ip</font> <font color="#339933">++</font> <font color="#009900">)</font> <br>  <font color="#009900">{</font> <br>  <font color="#000088">$ response</font> <font color="#339933">=</font> <font color="#990000">shell_exec</font> <font color="#009900">(</font> <font color="#0000ff">"arping -c 2"</font> <font color="#339933">.</font> <font color="#990000">long2ip</font> <font color="#009900">(</font> <font color="#000088">$ ip</font> <font color="#009900">)</font> <font color="#009900">)</font> <font color="#339933">;</font> <br>  <font color="#b1b100">if</font> <font color="#009900">(</font> <font color="#339933">!</font> <font color="#990000">strstr</font> <font color="#009900">(</font> <font color="#000088">$ response</font> <font color="#339933">,</font> <font color="#0000ff">'0 packets received'</font> <font color="#009900">)</font> <font color="#009900">)</font> <font color="#000088">$ up</font> <font color="#339933">++;</font> <br>  <font color="#009900">}</font> <br>  <font color="#009900">}</font> <br>  <font color="#b1b100">echo</font> <font color="#000088">$ up</font> <font color="#339933">.</font>  <font color="#0000ff">" <font color="#000099">\ r</font> <font color="#000099">\ n</font> "</font> <font color="#339933">;</font> <br>  <font color="#000000">?&gt;</font> </blockquote><br><br>  But of course, such a script is not suitable for continuous monitoring.  First, I would like it to work constantly in the background.  Secondly, the verification should be carried out in several streams - so faster. <br><br>  As a result, I rewrote the script like this: <ul><li>  Settings and network addresses are read from the ini-file. </li><li>  The "Papa" script runs an instance of the child script for each network and controls its operation. </li><li>  The child script checks all its network addresses in a circle and updates the information in Memcached.  In addition to the number of active nodes, their mac, dns and netbios name is stored. </li><li>  From memcached this data can be viewed on a web page or in zabbix. </li></ul> You can see the list of computers in the ascetic web interface: <br><img src="https://habrastorage.org/storage/565abfcf/6ef4f8bc/57638fa5/e3f00453.png"><br><br>  I also added a chart in Zabbix (see the beginning of the post). <br>  To do this, you need to add a line for each network in the zabbix_agentd.conf file: <br> <code>UserParameter=network_count. <i>net_name</i> ,/usr/local/bin/php / <i>  </i> /get_network_stats.php <i>net_name</i></code> <br>  On the server add the appropriate item. <br><img src="https://habrastorage.org/storage/fda1a455/2ff751be/b0ee2c34/9e2dc398.png"><br>  And set up a schedule. <br>  The get_network_stats.php &lt;network_name&gt; script gives the number of active hosts by the network name.  I think that users of other monitoring systems will be able to easily attach this script to them. <br><br>  I will not give the source, because  he is big.  <a href="">Download</a> it - readme attached. <br>  I think, who needs such a thing, can rewrite it to fit your needs: for example, you can use a regular file instead of memcached. </div><p>Source: <a href="https://habr.com/ru/post/119112/">https://habr.com/ru/post/119112/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../119104/index.html">Angry Birds have become a web application.</a></li>
<li><a href="../119105/index.html">Russian Wikipedia 10 years!</a></li>
<li><a href="../119108/index.html">Putting Atari Punk Console</a></li>
<li><a href="../119110/index.html">Vulnerability in Google Chrome turns out to be Adobe Flash vulnerability</a></li>
<li><a href="../119111/index.html">Ogs Mahjong 0.7</a></li>
<li><a href="../119114/index.html">Google I / O, Day 1: Results</a></li>
<li><a href="../119116/index.html">Google Tasks finally found the API</a></li>
<li><a href="../119117/index.html">Why Windows Phone will become the market leader in 2015</a></li>
<li><a href="../119118/index.html">Google Tasks API</a></li>
<li><a href="../119122/index.html">Valve has released a beta version of the level editor for Portal 2</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>