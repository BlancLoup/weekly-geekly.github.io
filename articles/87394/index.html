<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Multi-Master replication in MySQL</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="This article will discuss the process of deploying a fault-tolerant database subsystem based on MySQL server. 


 Before reading, I advise you to read...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Multi-Master replication in MySQL</h1><div class="post__text post__text-html js-mediator-article">  This article will discuss the process of deploying a fault-tolerant database subsystem based on MySQL server. <br><a name="habracut"></a><br><br>  <i>Before reading, I advise you to read <a href="http://habrahabr.ru/blogs/mysql/56702/">this article</a> .</i> <br><br>  At work, the question arose of creating a mirror site for another region (Asia).  Because  the time of passing the packages there is quite large, the geographical distance affects, and the Great Chinese Firewall is also not canceled, it was decided to create a mirror in the Asian region.  With the transfer of the engine, no problems were foreseen, user files can be safely synchronized via rsync, but there is a problem with the database.  What if a user added an object in Asia?  It is necessary that this object was visible not only to users of the local mirror, but also to everyone else. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      I started exploring the issue with MySQL clustering.  It turned out many interesting details.  For example, the fact that the server version included in the Ubuntu distribution (I use it on the test bench) does not support the NDB (Network Data Base) Storage Engine.  You must install either a version of mysql-max that is rumored to support NDB, or mysql-cluster.  The most interesting thing is that there are no deb-packages for them, so you should either install from binaries or from sources.  I did not succeed in installing binary files.  I could not remove the old server (the package is removed, and the files are all in place).  Having honestly stumbled with this for two days, I quit this undertaking.  I did not try to compile from the source, but I think this is the best option. <br><br><h4>  Master-Master replication </h4><br><img src="https://habrastorage.org/storage/habraeffect/4a/4e/4a4e9ce3cd827ddae6243ceaa62a16dd.jpg" alt="image"><br><br>  In general, the next stage of the survey was replication.  Then I realized that this is what I need.  There is a central server, and there is a replica in the region that will pull updates from it.  But we must make sure that updates from the replica fall into the main database.  So, it is necessary to make a master-master replication.  Those.  the first server will be the master for the second (the second will connect to it as a slave), and the second will be the master for the first (the first connects to it as a slave).  Tests conducted on virtualok based on Ubuntu Server 9.10 <br><br>  So, the ubuntu1 server (192.168.0.21), mysql config: <br><br> <code>[mysqld] <br> #  ,         <br> server-id = 1 <br> <br> #  ,   <br> log-bin = /var/lib/mysql/mysql-bin <br> <br> #  ,   <br> relay-log = /var/lib/mysql/mysql-relay-bin <br> relay-log-index = /var/lib/mysql/mysql-relay-bin.index <br> replicate-do-db = test_db <br> master-host=192.168.0.22 #ubuntu2 <br> master-user=replication <br> master-password=password_of_user_replication <br> master-port=3306</code> <br> <br>  For the second, similarly, just another ip master and server number. <br><br>  Now restart the server.  Then we create the user replication, give it the rights to replicate: <br> <code>mysql@ubuntu1&gt; GRANT REPLICATION SLAVE, REPLICATION CLIENT ON *.* TO 'replication'@'192.168.0.22' IDENTIFIED BY 'password'; <br> mysql@ubuntu2&gt; GRANT REPLICATION SLAVE, REPLICATION CLIENT ON *.* TO 'replication'@'192.168.0.21' IDENTIFIED BY 'password';</code> <br> <br>  Further it is necessary to tie the slaves to their masters.  This is done like this: <br>  Binding ubuntu1 as a wizard to ubuntu2: <br>  First, we block entry to the database. <br> <code>mysql@ubuntu1&gt; SET GLOBAL read_only = OFF;</code> <br>  Read more about it <a href="http://habrahabr.ru/blogs/mysql/56702/">here.</a> <br><br> <code>mysql@ubuntu1&gt; show master status; <br> +------------------+----------+--------------+------------------+ <br> | File | Position | Binlog_Do_DB | Binlog_Ignore_DB | <br> +------------------+----------+--------------+------------------+ <br> | mysql-bin.000006 | 7984 | | | <br> +------------------+----------+--------------+------------------+ <br> 1 row in set (0,00 sec)</code> <br> <br>  From there we take the value of File and position and connect the wizard. <br> <code>mysql@ubuntu2&gt; slave stop; #    <br> mysql@ubuntu2&gt; CHANGE MASTER TO MASTER_HOST = "192.168.0.22", MASTER_USER = "replication", MASTER_PASSWORD = "password_of_user_replication", MASTER_LOG_FILE = "mysql-bin.000006", MASTER_LOG_POS = 7984; <br> mysql@ubuntu2&gt; slave start;</code> <br>  After that, you can check the connection either through <br> <code>mysql@ubuntu2&gt;load data from master;</code> <br>  either through <br> <code>mysql@ubuntu2&gt; show slave status;</code> <br>  If there are no errors, the wizard is connected. <br>  Now we connect this server as the master for the first (it is done in the same way). <br>  As a result, we have a system of two servers, we make a change to any server and it replicates to the second. <br><br><h4>  Multi-Master replication </h4><br>  But this seemed to me a little.  And if you want to add a third server?  At first I was thinking about linear topology. <br>  ubuntu1 &lt;-&gt; ubuntu2 &lt;-&gt; ubunt3 and even the star topology.  But alas, it was far from reality.  MySQL does not allow one slave to have multiple wizards.  And in a linear topology this would be ubuntu2.  If someone knows <b>how to tie one slave to several masters</b> I will be grateful for the information. <br>  The star does not fit, linear, too, remains a ring.  And I will try, I thought. <br><br><img src="https://habrastorage.org/storage/habraeffect/a5/de/a5de278410e6a7d82c29445c3742085a.jpg" alt="image"><br><br>  It turns out that in this scheme, each server has only one master, and due to the fact that the ring is closed, updates will reach all servers from anywhere in the ring.  It is important to mention here that in order for the master to <b>transfer not only its own updates to the slave, but also updates to its master,</b> you must add the following line to the [mysqld] section of my.cnf: <br> <code>log-slave-updates</code> <br>  respectively, in the configuration of each server. <br><br>  I checked and was pleasantly surprised that the scheme worked.  Wherever the base is changed, the changes are actually replicated to other servers. <br><br><h4>  Auto-increment fields </h4><br>  When simultaneously adding new lines containing auto-increment fields to different master servers, a conflict may arise.  To prevent this from happening, you need to change the step of the sequence of auto-increments on the database servers. <br><ul><li>  auto_increment_increment determines the AUTO_INCREMENT change step. </li><li>  auto_increment_offset defines the initial value of the increment </li></ul><br>  Having selected the correct (non-conflicting) values ‚Äã‚Äãof these parameters on different wizards, the servers used in the multi-master configuration will use non-conflicting AUTO_INCREMENT values ‚Äã‚Äãwhen inserting records.  For example, for N master servers, set these values: <br><ul><li>  Set auto_increment_increment to N on each wizard. </li><li>  On each of the N masters set different values ‚Äã‚Äãof auto_increment_offset using 1, 2, ..., N. </li></ul><br>  For example, using auto_increment_increment = 10 and auto_increment_offset = 3, the following field 3, 13, 23 values ‚Äã‚Äãwill be generated. And using 10, 7, these will be 7, 17, 27, etc. <br><br><h4>  Fault tolerance </h4><br>  After all this, I could not help but try to drop one of the servers.  Pull the power out of ubuntu2.  Then we load it.  What happens? <br>  With subsequent changes to ubnutu2, they are easily replicated to ubuntu3 and ubuntu1.  But the changes made on ubuntu2 to other servers are not replicated.  We look at the show slave status on ubuntu3 and see that it has lost its master. <br>  As a recipe, I can offer the following: <br>  After the start of the database server, untie the master from the slave of the current server, and bind it again.  Because  in the topology, there is only one slave ring for any server, this simplifies the task.  The algorithm will be something like this: <br>  1. ubuntu2 turned off on power and booted again <br>  2. ubuntu2 at home: <br>  - blocks replicated database for writing: <code>mysql@ubuntu2&gt; SET GLOBAL read_only = OFF;</code> <br>  - looks at the name and position in the log: <code>mysql@ubuntu2&gt; show master status;</code> <br>  2. ubuntu2 through mysql the client comes on the slave (ubuntu3) <br>  - untie himself from the slave <code>mysql@ubuntu3&gt; slave stop;</code> <br>  - declares himself a master: <code>mysql@ubuntu3&gt; CHANGE MASTER TO MASTER_HOST = "192.168.0.22", MASTER_USER = "replication", MASTER_PASSWORD = "password_of_user_replication", MASTER_LOG_FILE = "mysql-bin.000006", MASTER_LOG_POS = 5161;</code>  with the log name and position obtained in the previous step. <br>  - reattaches the slave: <code>mysql@ubuntu3&gt; slave start;</code> <br>  While the implementation of this script is not ready, I think on what to write it perl / php / python / bash ... <br>  I will be glad to hear the thoughts of habrasoobshchestva on this topic.  Write if the article turned out to be useful, plans to deal with clustering and replicate clusters. </div><p>Source: <a href="https://habr.com/ru/post/87394/">https://habr.com/ru/post/87394/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../87380/index.html">Open 3D Stereo and 3D Vision. Do I need a stereo image on my work / home laptop / desktop?</a></li>
<li><a href="../87383/index.html">Andromeda Software Development - Lifeforce</a></li>
<li><a href="../87387/index.html">GDC Heroes 2010: Uncharted 2, Carmack and Newell</a></li>
<li><a href="../87390/index.html">Jobs at Google for young professionals</a></li>
<li><a href="../87391/index.html">Yandex.Mail - ‚Äúsecret question‚Äù is not an obstacle for us</a></li>
<li><a href="../87395/index.html">Would you like to give up everything and make your childhood dream a reality?</a></li>
<li><a href="../87396/index.html">Don't be evil</a></li>
<li><a href="../87397/index.html">Creating your own disk in the cloud and working with it</a></li>
<li><a href="../87400/index.html">Deflection or necessity?</a></li>
<li><a href="../87401/index.html">Windows 95 on HTC HD2</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>