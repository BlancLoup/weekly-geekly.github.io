<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Sell ‚Äã‚ÄãSide Platform</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Good afternoon, dear reader! Continuing the series of articles on the implementation of the RTB stack by our company, I suggest that you familiarize y...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Sell ‚Äã‚ÄãSide Platform</h1><div class="post__text post__text-html js-mediator-article">  Good afternoon, dear reader!  Continuing the series of articles on the <a href="http://habrahabr.ru/post/261191/">implementation of the RTB stack by</a> our company, I suggest that you familiarize yourself with the implementation of our SSP - <a href="https://vox.targetix.net/login">VOX Ad Exchange</a> . <br><br><img src="https://habrastorage.org/files/2dd/71b/38d/2dd71b38d8c34e83a51670f5a30d593a.jpg"><br><a name="habracut"></a><br>  The load here is not as big as, for example, in our <a href="http://habrahabr.ru/post/261745/">DSP</a> , and the main processing time of the request is spent waiting for responses from connected DSPs.  It is written in the form of an asynchronous ASP.NET MVC application. <br>  So, let's begin to figure out how the processing of requests. <br><br>  Request for advertising begins to form on the client side.  Here, using javascript, we try to collect as much information as possible about the visitor of the site where our script is installed.  Basically this is technical information: whether the flash player is included in the browser, the size of the browser window, the screen size, we get the address of the page and the referrer to the page from which the user came and so on.  Further information is collected in the JSON string, the request for advertising is encoded and sent.  Now the back-end gets down to business. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <img src="https://habrastorage.org/files/fa0/e0e/34b/fa0e0e34b5484ced9b09b961d44f0b00.png"><br><br>  Having received a request for advertising, we also receive from the database all the information we know about this visitor (history of his interests, advertising views and clicks).  According to the user-agent, we get data about the browser used, its version and visitor's operating system, and by its ip-address we determine its current location.  We send all the information collected about the user to our DMP for its further analysis. <br><br>  Having collected data about the user, we proceed to the site.  We receive information about the cost of advertising space, the CTR of the site, the categories of content, the presence of prohibited content, etc. On the basis of these data, the minimum threshold price of the auction will be formed.  Having finished with the sites, we proceed to the longest SSP task, this is polling the connected DSPs.  Based on the data obtained above in the manner described, a request is made to the DSP.  Next, a parallel polling of the DSP takes place, and the response of each of them is set aside 120 ms, which includes the time for delivering the request and receiving the response (ping to the servers on which the DSP is located).  So the location of the DSP also plays an important role.  Having received the answer from all DSPs, it remains only to sort them by the size of the bet and take the answer from the largest one.  The answer is in the form of JSON, to show advertising, we return to the front-end. <br><br>  The frontend remains only a little - to display the code of the received ad.  Since there is no way to keep track of the quality of the DSP code and its compatibility with sites, our code for displaying ads on the page creates a separate iframe, loads the code into it, and this is what we put on the page.  This is where the ad request processing ends. <br><br>  Let's now figure out what difficulties we had to face during the implementation of SSP, and how we dealt with them.  One of the main problems during the implementation of SSP was the clogging of the IIS pool.  The reason for this was the expectation of a response from the DSP for 100 milliseconds or more.  While the SSP was waiting for a response from the DSP, the remaining requests were waiting for the SSP to process the current one.  And the solution to this problem was the use of asynchronous controllers, and here async / await modifiers came in handy.  Also, it would be superfluous to mention that the information about the site and the DSP is cached in the memory of the application and is updated every minute.  The next main place to pay attention is the DSP survey.  Initially, the question arose how to parallelize the DSP poll.  During the development of SSP, several solutions to this task were tested, such as: Parallel.ForEach, Task.WaitAll and Task.WhenAll.  No particular differences in performance were found; each method correctly performed its task, but due to the transition to the asynchronous model, the choice fell on the latter option.  The request itself to the DSP is done via HttpWebRequest.  The most important thing that should be done when working with HttpWebRequest is to enable KeepAlive support, because requests to the DSP are constantly following each other, and constant breaks and connection setup will noticeably slow down the receipt of the response.  I will give an example of the resulting class for polling DSP: <br><br><div class="spoiler">  <b class="spoiler_title">Code</b> <div class="spoiler_text"><pre><code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">DspRequests</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> _method = <span class="hljs-string"><span class="hljs-string">"POST"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> _contentType = <span class="hljs-string"><span class="hljs-string">"application/json"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> List&lt;<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>&gt; _headers = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> List&lt;<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>&gt; { <span class="hljs-string"><span class="hljs-string">"x-openrtb-version: 2.0"</span></span> }; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> List&lt;<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>&gt; _dspUrls { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> List&lt;<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>&gt; DspUrls { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span> { returns _dspUrls; } <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> { _dspUrls = <span class="hljs-keyword"><span class="hljs-keyword">value</span></span>; } } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">async</span></span> Task&lt;List&lt;<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>&gt;&gt; PollDspAsync(<span class="hljs-keyword"><span class="hljs-keyword">string</span></span> request) { List&lt;<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>&gt; responses = <span class="hljs-literal"><span class="hljs-literal">null</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> tasks = _dspUrls.DspRecords.Select(el =&gt; PollAsync(el, request)); responses = (<span class="hljs-keyword"><span class="hljs-keyword">await</span></span> Task.WhenAll(tasks)).Where(el =&gt; el != <span class="hljs-literal"><span class="hljs-literal">null</span></span>).ToList(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> responses; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">async</span></span></span><span class="hljs-function"> Task&lt;</span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">string</span></span></span><span class="hljs-function">&gt; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">PollAsync</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> url, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> bidRequest</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> response = <span class="hljs-literal"><span class="hljs-literal">null</span></span>; HttpWebRequest httpWebRequest = (HttpWebRequest)WebRequest.Create(url); httpWebRequest.Method = _method; httpWebRequest.ContentType = _contentType; httpWebRequest.KeepAlive = <span class="hljs-literal"><span class="hljs-literal">true</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">foreach</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">string</span></span> header <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> _headers) httpWebRequest.Headers.Add(header); httpWebRequest.Timeout = <span class="hljs-number"><span class="hljs-number">120</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> (StreamWriter streamWriter = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> StreamWriter(<span class="hljs-keyword"><span class="hljs-keyword">await</span></span> httpWebRequest.GetRequestStreamAsync())) { streamWriter.Write(bidRequest); } <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> (HttpWebResponse webResponse = (HttpWebResponse) <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> httpWebRequest.GetResponseAsync()) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (webResponse.StatusCode == HttpStatusCode.OK) { <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> (StreamReader streamReader = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> StreamReader(webResponse.GetResponseStream())) { response = streamReader.ReadToEnd(); } } } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> response; } }</code> </pre> <br></div></div><br>  <a href="http://habrahabr.ru/post/262917/">The client part of</a> our SSP.  This is the personal account of the web publisher (site), which contains statistics on all its advertising spaces.  VOX is a self-service platform that allows you to create both banner advertising spaces (the 5 most popular sizes in RTB) and Rich Media banners (fullscreen).  At each advertising space, you can hang a stub (HTML or Javascript), as well as add a counter display third-party system. <br><br><img src="https://habrastorage.org/files/e03/aaa/6a3/e03aaa6a36894e5c9cc0f82d3cd93f16.png"><br><br>  Here, perhaps, we will finish the review of the work of our SSP. </div><p>Source: <a href="https://habr.com/ru/post/264015/">https://habr.com/ru/post/264015/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../264005/index.html">PHP to Clojure</a></li>
<li><a href="../264007/index.html">Magic of tensor algebra: Part 16 - Properties of the solid body inertia tensor</a></li>
<li><a href="../264009/index.html">Message Formatting for Yii :: t ()</a></li>
<li><a href="../264011/index.html">Microservices Q & A</a></li>
<li><a href="../264013/index.html">Antivirus # 2: Hacking BitDefender and Serious Symantec Vulnerabilities</a></li>
<li><a href="../264017/index.html">Fighting bad URIs, spammers and php shells is a personal experience</a></li>
<li><a href="../264019/index.html">Algorithm for organizing logical volumes in the Windows OS environment</a></li>
<li><a href="../264021/index.html">How to transfer a project of 9 million lines of code to a 64-bit platform?</a></li>
<li><a href="../264023/index.html">Increased battery life in Android M</a></li>
<li><a href="../264025/index.html">We are flashing the Upvel UR-313N4G router on OpenWRT</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>