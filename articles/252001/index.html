<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Automate and speed up the process of setting up cloud servers with Ansible. Part 3: Variables and the inventory file</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="In the first part, we began the study of Ansible, a popular tool for automating the configuration and deployment of IT infrastructure. Ansible has bee...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Automate and speed up the process of setting up cloud servers with Ansible. Part 3: Variables and the inventory file</h1><div class="post__text post__text-html js-mediator-article">  <a href="http://habrahabr.ru/company/infobox/blog/249143/">In the first part,</a> we began the study of Ansible, a popular tool for automating the configuration and deployment of IT infrastructure.  Ansible has been successfully installed, describes the principles of operation, the basic setting.  At the end of the article we showed how to quickly install nginx on multiple servers. <br><br>  <a href="http://habrahabr.ru/company/infobox/blog/250115/">In the second part,</a> we sorted out the output of the playbook, learned how to debug and reuse the Ansible scripts. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/bec/f95/ce3/becf95ce3cd30f909dbcb7d2efdf7f68.png" width="300">
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      In this part you will learn how to write a single Ansible playbook for different operating systems (for example, with rpm and deb), how to maintain many hosts and not write them all in inventory, how to group servers by <a href="http://infoboxcloud.ru/">InfoboxCloud</a> regions and much more. <br><a name="habracut"></a><br><h4>  <b>Variables in Ansible</b> </h4><br>  Variables are used to store values ‚Äã‚Äãthat can be used in a playbook.  In the process of using variables, you can override it many times.  Information about servers from inventory can also be used as variables. <br><br>  There are several ways to define variables in Ansible: <br><ul><li>  variable file transfer </li><li>  defining variables in the playbook </li><li>  transfer to ansible-playbook using the <strong>-e</strong> / <strong>--extra-vars command</strong> </li><li>  defining variables in the inventory file </li></ul><br>  The need to use variables is perfectly demonstrated by the example of installing Apache.  The fact is that in different distributions a package with apache is called differently.  The difference in configurations of different operating systems is quite common. <br>  For example: <br><pre><code class="bash hljs">- set_fact package_name=httpd when: ansible_os_family == <span class="hljs-string"><span class="hljs-string">"Redhat"</span></span> - set_fact package_name=apache2 when: ansible_os_family == <span class="hljs-string"><span class="hljs-string">"Debian"</span></span></code> </pre> <br>  The task will set the variable package_name to httpd or apache2 depending on the OS family on the server. <br><br>  Variables can be used to set user values ‚Äã‚Äãduring the playbook execution: <br><pre> <code class="bash hljs">- name: Package to install pause: prompt=<span class="hljs-string"><span class="hljs-string">"Provide the package name which you want to install "</span></span> register: package_name</code> </pre><br>  It is convenient to save a list of values ‚Äã‚Äãinto variables for its repeated use.  If the same variable is used in the playbook set, their use will reduce the complexity of the scripts. <br><br>  <strong>All variables in Ansible must begin with a letter.</strong>  <strong>You can use letters, numbers, and underscores in the name.</strong> <br>  Variables defined in the include files will overload (replace) variables defined at other levels of the hierarchy, except for variables passed via <strong>--extra-vars</strong> . <br><br><h5>  <b>Variables in imported files</b> </h5><br>  Let's look at how you can use variables from files imported into the playbook. <br>  Let's create a separate file for installing Apache (~ / ansible / playbooks / tasks / <strong>pkg_apache_install.yml</strong> ): <br><pre> <code class="bash hljs"> - set_fact: package_name=httpd when: ansible_os_family == <span class="hljs-string"><span class="hljs-string">"Redhat"</span></span> - set_fact: package_name=apache2 when: ansible_os_family == <span class="hljs-string"><span class="hljs-string">"Debian"</span></span> - name: Install httpd package yum: name=httpd state=latest sudo: yes when: ansible_os_family == <span class="hljs-string"><span class="hljs-string">"Redhat"</span></span> - name: Install apache2 package apt: name=apache2 state=latest sudo: yes when: ansible_os_family == <span class="hljs-string"><span class="hljs-string">"Debian"</span></span></code> </pre><br>  Include it in the Apache installation file and verify that the service is running (~ / ansible / <strong>setup_apache.yml</strong> ): <br><pre> <code class="bash hljs">--- - hosts: experiments remote_user: root tasks: - include: tasks/pkg_apache_install.yml - name: Check apache service service: name={{ package_name }} state=started sudo: yes</code> </pre><br>  As we can see, in the setup_apache.yml file we successfully use the variable defined in the included file.  This playbook will install apache correctly on both rpm distributions and deb using the correct apache package name. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/f92/d55/644/f92d5564474aaffccdee66259e49232f.jpg" width="800"><br><br><h5>  <b>Variables in the playbook</b> </h5><br>  Variables in a playbook are set using the <strong>vars:</strong> keyword.  Variables are set as variable_name: value.  Variables will overload other variables that are set in the global file or in inventory. <br><br>  Example of a variable description in a playbook: <br><pre> <code class="bash hljs">vars: - package_name: <span class="hljs-string"><span class="hljs-string">"httpd"</span></span></code> </pre><br><br><h5>  <b>Variables in the global file</b> </h5><br>  Variables in Ansible can be set in a separate file, which allows you to separate data from the playbook.  You can create as many variable files as you need; you just need to tell the playbook where to find them.  The format for defining variables in a file is similar to the format for defining variables in a Playbook. <br>  ~ / ansible / common / vars / <strong>global.yml</strong> <br><pre> <code class="bash hljs">--- package_name: <span class="hljs-string"><span class="hljs-string">"httpd"</span></span> <span class="hljs-comment"><span class="hljs-comment">#Apache #Enviroment variables proxy_env: INFOBOXCLOUD_API_KEY: "{{ lookup('env', 'INFOBOXCLOUD_API_KEY') }}" INFOBOXCLOUD_LOGIN: "{{ ('env', 'INFOBOXCLOUD_LOGIN') }}"</span></span></code> </pre><br>  In this example, we set the variable package_name directly (after # you can write a comment), and access keys for the InfoboxCloud API are searched in environment variables using the lookup plugin. <br><br>  In a playbook, the path to the variable files is set via vars_files: <br><pre> <code class="bash hljs">vars_files: - var1.yml - var2.yml</code> </pre><br><br><h5>  <b>Using facts as variables</b> </h5><br>  You can use any fact as a variable that gathers with gather_facts.  To get a list of all the facts for a specific group of machines, use the command: <br><pre> <code class="bash hljs">ansible experiments -i inventory -m setup</code> </pre><br>  where experiments is the name of the group of machines in inventory. <br><br><h4>  <b>Plunging into the inventory ‚Äì file</b> </h4><br>  <a href="https://infoboxcloud.ru/community/blog/iaas/226.html">In the first part,</a> we briefly reviewed a simple inventory ‚Äì file.  Let's take a closer look at it. <br><br>  Simple inventory (~ / ansible / <strong>inventory</strong> ): <br><pre> <code class="bash hljs">ansible.trukhin.com 77.221.144.179</code> </pre><br>  You can simply write the host names and ip addresses and all servers will be used when running the playbook with this inventory file. <br><br><h5>  <b>Groups in inventory</b> </h5><br>  We also saw the use of groups earlier: <br><pre> <code class="bash hljs">[my] ansible.trukhin.com ansible2.trukhin.com [corp] ansible.sandbox.infoboxcloud.ru ansible2.sandbox.infoboxcloud.ru</code> </pre><br><br>  The playbook execution group is listed in the ‚Äúhosts:‚Äù playbook section <br><pre> <code class="bash hljs">hosts: my</code> </pre><br>  If you want to use a specific host, you can transfer it to the hosts section. <br><pre> <code class="bash hljs">hosts: ansible.trukhin.com</code> </pre><br>  If you want to use all the hosts of all groups - you can use <br><pre> <code class="bash hljs">hosts: all</code> </pre><br><br><h5>  <b>Groups of groups in inventory</b> </h5><br>  A very useful feature that allows, for example, to group hosts not only by purpose, but also by location, which is very important for InfoboxCloud (Moscow, Amsterdam).  Often there are other tasks where you need to use groups of groups. <br><pre> <code class="bash hljs">[msk] webMSK.trukhin.com dbMSK.trukhin.com [ams] webAMS.trukhin.com dbAMS.trukhin.com [web:children] msk ams</code> </pre><br>  In this example, the web my group includes servers in Moscow and Amsterdam.  You can access both the web group and server groups in a specific region from the playbook. <br><br><h5>  <b>Regular expressions in inventory</b> </h5><br>  If you have a large number of servers, the use of naming conventions (for example web001, web002 ... web00N) will make it easier to specify them in inventory.  You can use regular expressions in the inventory file: <br><pre> <code class="bash hljs">[web] web[001:200] [db] db[001:020] [balancer] 192.168.2.[1:3]</code> </pre><br>  where <strong>web [001: 200]</strong> will correspond to web 001, web002, web003, web004, ..., web199, web200 for the web group; <br>  <strong>db [001: 020]</strong> will correspond to db001, db002, db003 ..., db019, db020 for the db group. <br>  <strong>192.168.2. [1:30]</strong> will correspond to 192.168.2.1, 192.168.2.2, 192.168.2.3 for the balancer group. <br><br><h5>  <b>Variables in inventory file</b> </h5><br>  The previously described methods for setting variables applied them immediately to all hosts in inventory.  Sometimes it may be necessary to use specific variables for a specific group of hosts or a particular host. <br><br>  Setting host-specific variables: <br><pre> <code class="bash hljs">ansible.trukhin.com web001 db001 db_name=mysql 192.168.2.1 db_name=redis db_port=6380</code> </pre><br>  Setting variables for a group of hosts (web): <br><pre> <code class="bash hljs">[web] web[001:010] [db] db[001:002] [web:vars] web_port=443</code> </pre><br><br><h5>  <b>Removal of variables in separate files for inventory</b> </h5><br>  You can create variable files for hosts and groups.  Folders with these files should be in the same directory as the inventory file.  Files of variables related to specific hosts should be saved in the folder host_vars, belonging to specific groups - in the folder group_vars. <br><br>  An example variable file for web001 host (~ / ansible / <strong>host_vars</strong> / web001): <br><pre> <code class="bash hljs">web_port_ssl=443 web_port=80</code> </pre><br>  An example of a variable file for a db group (~ / ansible / group_vars / db): <br><pre> <code class="bash hljs">db_port=6380 db_name=redis</code> </pre><br>  The inventory variables follow hierarchies: the variables in the global file overload any host variables, group variables, and variables in the inventory file.  Host variables overload group variables, and in turn group variables overload inventory file variables. <br><br>  Through <strong>ansible.cfg,</strong> you can override the Ansible configuration settings. <br><br><h4>  Conclusion </h4><br>  The book " <a href="http://www.amazon.com/Learning-Ansible-Madhurranjan-Mohaan/dp/1783550635/ref%3Dsr_1_2%3Fie%3DUTF8%26qid%3D1422482924%26sr%3D8-2%26keywords%3Dansible">Learning Ansible</a> " and of course the <a href="http://docs.ansible.com/">official documentation</a> helped a lot in writing the article. <br><br>  It is convenient to conduct all experiments with Ansible in <a href="http://infoboxcloud.ru/">InfoboxCloud</a> , since there is an opportunity for each virtual server to set the exact amount of resources needed for the task (CPU / Ram / disk independently of each other) or to use autoscaling, and not to choose VM from ready-made templates.  When experiments are not conducted - you can simply turn off the VM and pay only the cost of the disk. <br><br>  If you find an error in the article, the author will gladly correct it.  Please write in the LAN or <a href="">in the mail</a> about it.  There you can also ask questions about Ansible for coverage in subsequent articles. <br><br>  <a href="http://habrahabr.ru/company/infobox/blog/252239/">Part 4: working with modules</a> <br>  <a href="http://habrahabr.ru/company/infobox/blog/252461/">Part 5: local_action, conditions, cycles and roles</a> <br><br>  Successful work! </div><p>Source: <a href="https://habr.com/ru/post/252001/">https://habr.com/ru/post/252001/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../251989/index.html">How to create and earn SaaS | Part 14 | Somersaults with prices</a></li>
<li><a href="../251991/index.html">Corona SDK has become free</a></li>
<li><a href="../251993/index.html">Tank Masters - Mobile Tank Puzzle</a></li>
<li><a href="../251995/index.html">"Heavy" applied software: everyday development and implementation</a></li>
<li><a href="../251997/index.html">How to increase advertising revenue in mobile applications</a></li>
<li><a href="../252003/index.html">Tomorrow at 10:00, see the online broadcast: Cross-Platform Development with Visual Studio 2015</a></li>
<li><a href="../252013/index.html">Atomic reactor in every site</a></li>
<li><a href="../252015/index.html">Overview of glands for practicing robotics with children - 2</a></li>
<li><a href="../252017/index.html">DevCon 2015 Conference: Internet of Things in the World of Living Code</a></li>
<li><a href="../252019/index.html">5 demons in the soul of a support worker</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>