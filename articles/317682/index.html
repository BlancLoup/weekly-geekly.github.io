<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Scaling ClickHouse, managing migrations and sending requests from PHP to the cluster</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="In the previous article, we shared our experience in implementing and using ClickHouse in the media company2 . In the current article, we will address...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Scaling ClickHouse, managing migrations and sending requests from PHP to the cluster</h1><div class="post__text post__text-html js-mediator-article"><p>  In the previous <a href="https://habrahabr.ru/company/smi2/blog/314558/">article,</a> we shared our experience in implementing and using ClickHouse in the <a href="https://smi2.net/">media company2</a> .  In the current article, we will address the scaling issues that arise with an increase in the amount of data being analyzed and an increase in workload, when data can no longer be stored and processed within a single physical server.  We will also tell you about the tool we developed for migrating <a href="https://en.wikipedia.org/wiki/Data_definition_language">DDL</a> queries to the ClickHouse cluster. </p><br><p><img src="https://habrastorage.org/files/d0d/766/d01/d0d766d019724159bc0896bcafad3da5.png" alt="Two shard two replicas"></p><br><a name="habracut"></a><br><p>  <a href="https://clickhouse.yandex/">ClickHouse was</a> specially designed to work in clusters located in different data centers.  The DBMS is scaled linearly to hundreds of nodes.  For example, <a href="https://metrika.yandex.ru/">Yandex.Metrika</a> at the time of writing this article is a cluster of more than 400 nodes. </p><br><p>  ClickHouse provides sharding and out-of-box replication; they can be flexibly configured separately for each table.  <a href="https://zookeeper.apache.org/">Apache ZooKeeper</a> is required for replication (version 3.4.5+ recommended).  For higher reliability, we use a ZK cluster (ensemble) of 5 nodes.  An odd number of ZK nodes (for example, 3 or 5) should be chosen to ensure quorum.  Also note that ZK is not used in SELECT operations, but is used, for example, in ALTER queries for changing columns, keeping the instructions for each of the replicas. </p><br><h2 id="shardirovanie">  Sharding </h2><br><p>  ClickHouse sharding allows you to write and store portions of data in a cluster distributedly and process (read) data in parallel on all nodes of the cluster, increasing throughput and reducing latency.  For example, in queries with GROUP BY, ClickHouse will aggregate at remote nodes and pass the intermediate states of aggregate functions to the requesting node, where they will be aggregated. </p><br><p>  For sharding, a special <a href="https://clickhouse.yandex/reference_ru.html">Distributed</a> engine is used, which does not store data, but delegates SELECT queries to shard tables (tables containing chunks of data) with subsequent processing of the received data.  Data can be written to shards in two modes: 1) via the Distributed table and an optional sharding key or 2) directly into shard tables from which further data will be read through the Distributed table.  Consider these modes in more detail. </p><br><p>  In the first mode, data is written to the Distributed table using the sharding key.  In the simplest case, the sharding key can be a random number, that is, the result of a call to the <a href="https://clickhouse.yandex/reference_ru.html">rand ()</a> function.  However, as a sharding key, it is recommended to take the hash value from the field in the table, which will, on the one hand, localize small data sets on one shard, and on the other, ensure a fairly even distribution of such sets across different shards in a cluster.  For example, the session identifier (sess_id) of a user will allow localizing page impressions for one user on one shard, while sessions of different users will be distributed evenly across all shards in the cluster (provided that the sess_id field values ‚Äã‚Äãhave a good distribution).  The sharding key can also be non-numeric or composite.  In this case, you can use the built-in hash function <a href="https://clickhouse.yandex/reference_ru.html">cityHash64</a> .  In this mode, the data written to one of the cluster nodes will be automatically redirected to the necessary shards by the sharding key, however, increasing traffic. </p><br><p>  A more complicated way is to calculate the necessary shard outside ClickHouse and write directly to the shard table.  The difficulty here is due to the fact that you need to know the set of available shard nodes.  However, in this case, the recording becomes more efficient, and the sharding mechanism (determining the desired shard) can be more flexible. </p><br><h2 id="replikaciya">  Replication </h2><br><p>  ClickHouse supports data <a href="https://clickhouse.yandex/reference_ru.html">replication</a> , ensuring data integrity on replicas.  For data replication, special MergeTree-family engines are used: </p><br><ul><li>  ReplicatedMergeTree </li><li>  ReplicatedCollapsingMergeTree </li><li>  ReplicatedAggregatingMergeTree </li><li>  ReplicatedSummingMergeTree </li></ul><br><p>  Replication is often used with sharding.  For example, a cluster of 6 nodes can contain 3 shards of 2 replicas each.  It should be noted that replication does not depend on sharding mechanisms and works at the level of individual tables. </p><br><p>  Data recording can be performed in any of the replica tables, ClickHouse performs automatic data synchronization between all replicas. </p><br><h2 id="primery-konfiguracii-clickhouse-klastera">  Configuration examples ClickHouse-cluster </h2><br><p> As examples, we will consider various configurations for four nodes: <code>ch63.smi2, ch64.smi2, ch65.smi2, ch66.smi2</code> .  Settings are contained in the <em>/etc/clickhouse-server/config.xml</em> configuration file. </p><br><h3 id="odin-shard-i-chetyre-repliki">  One shard and four replicas </h3><br><p><img src="https://habrastorage.org/files/24c/291/fcd/24c291fcda9943d2b6f416fec8b6eefc.png" alt="One shard and four replicas"></p><br><pre> <code class="xml hljs"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">remote_servers</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-comment"><span class="hljs-comment">&lt;!-- One shard, four replicas --&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">repikator</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">shard</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-comment"><span class="hljs-comment">&lt;!-- replica 01_01 --&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">replica</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">host</span></span></span><span class="hljs-tag">&gt;</span></span>ch63.smi2<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">host</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">replica</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-comment"><span class="hljs-comment">&lt;!-- replica 01_02 --&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">replica</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">host</span></span></span><span class="hljs-tag">&gt;</span></span>ch64.smi2<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">host</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">replica</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-comment"><span class="hljs-comment">&lt;!-- replica 01_03 --&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">replica</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">host</span></span></span><span class="hljs-tag">&gt;</span></span>ch65.smi2<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">host</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">replica</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-comment"><span class="hljs-comment">&lt;!-- replica 01_04 --&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">replica</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">host</span></span></span><span class="hljs-tag">&gt;</span></span>ch66.smi2<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">host</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">replica</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">shard</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">repikator</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">remote_servers</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre> <br><p>  Example of the table creation scheme: </p><br><p><img src="https://habrastorage.org/files/352/b8d/314/352b8d314e574ba9aa54350715f47697.png" alt="Scheme"></p><br><p>  An example of a SQL query to create a table for the specified configuration: </p><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DATABASE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">IF</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">EXISTS</span></span> dbrepikator ; <span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">IF</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">EXISTS</span></span> dbrepikator.anysumming_repl_sharded ( event_date <span class="hljs-built_in"><span class="hljs-built_in">Date</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DEFAULT</span></span> toDate(event_time), event_time DateTime <span class="hljs-keyword"><span class="hljs-keyword">DEFAULT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">now</span></span>(), body_id Int32, views Int32 ) <span class="hljs-keyword"><span class="hljs-keyword">ENGINE</span></span> = ReplicatedSummingMergeTree(<span class="hljs-string"><span class="hljs-string">'/clickhouse/tables/{repikator_replica}/dbrepikator/anysumming_repl_sharded'</span></span>, <span class="hljs-string"><span class="hljs-string">'{replica}'</span></span>, event_date, (event_date, event_time, body_id), <span class="hljs-number"><span class="hljs-number">8192</span></span>) ; <span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">IF</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">EXISTS</span></span> dbrepikator.anysumming_repl <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> dbrepikator.anysumming_repl_sharded <span class="hljs-keyword"><span class="hljs-keyword">ENGINE</span></span> = <span class="hljs-keyword"><span class="hljs-keyword">Distributed</span></span>( repikator, dbrepikator, anysumming_repl_sharded , <span class="hljs-keyword"><span class="hljs-keyword">rand</span></span>() )</code> </pre> <br><p>  The advantage of this configuration: </p><br><ul><li>  The most reliable way to store data. </li></ul><br><p>  Disadvantages: </p><br><ul><li>  For most tasks, an excess of copies of the data will be stored. </li><li>  Since there is only 1 shard in this configuration, a SELECT query cannot run in parallel on different nodes. </li><li>  Additional resources are required to replicate data multiple times between all nodes. </li></ul><br><h3 id="chetyre-sharda-po-odnoy-replike">  Four shards one replica </h3><br><p><img src="https://habrastorage.org/files/38f/b5c/3c5/38fb5c3c51f64b7896c55b9c5d872478.png" alt="Four shards one replica"></p><br><pre> <code class="xml hljs"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">remote_servers</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-comment"><span class="hljs-comment">&lt;!-- Four shards, one replica --&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">sharovara</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-comment"><span class="hljs-comment">&lt;!-- shard 01 --&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">shard</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-comment"><span class="hljs-comment">&lt;!-- replica 01_01 --&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">replica</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">host</span></span></span><span class="hljs-tag">&gt;</span></span>ch63.smi2<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">host</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">replica</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">shard</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-comment"><span class="hljs-comment">&lt;!-- shard 02 --&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">shard</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-comment"><span class="hljs-comment">&lt;!-- replica 02_01 --&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">replica</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">host</span></span></span><span class="hljs-tag">&gt;</span></span>ch64.smi2<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">host</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">replica</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">shard</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-comment"><span class="hljs-comment">&lt;!-- shard 03 --&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">shard</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-comment"><span class="hljs-comment">&lt;!-- replica 03_01 --&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">replica</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">host</span></span></span><span class="hljs-tag">&gt;</span></span>ch65.smi2<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">host</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">replica</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">shard</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-comment"><span class="hljs-comment">&lt;!-- shard 04 --&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">shard</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-comment"><span class="hljs-comment">&lt;!-- replica 04_01 --&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">replica</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">host</span></span></span><span class="hljs-tag">&gt;</span></span>ch66.smi2<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">host</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">replica</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">shard</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">sharovara</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">remote_servers</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre> <br><p>  An example of a SQL query to create a table for the specified configuration: </p><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DATABASE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">IF</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">EXISTS</span></span> testshara ; <span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">IF</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">EXISTS</span></span> testshara.anysumming_sharded ( event_date <span class="hljs-built_in"><span class="hljs-built_in">Date</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DEFAULT</span></span> toDate(event_time), event_time DateTime <span class="hljs-keyword"><span class="hljs-keyword">DEFAULT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">now</span></span>(), body_id Int32, views Int32 ) <span class="hljs-keyword"><span class="hljs-keyword">ENGINE</span></span> = ReplicatedSummingMergeTree(<span class="hljs-string"><span class="hljs-string">'/clickhouse/tables/{sharovara_replica}/sharovara/anysumming_sharded_sharded'</span></span>, <span class="hljs-string"><span class="hljs-string">'{replica}'</span></span>, event_date, (event_date, event_time, body_id), <span class="hljs-number"><span class="hljs-number">8192</span></span>) ; <span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">IF</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">EXISTS</span></span> testshara.anysumming <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> testshara.anysumming_sharded <span class="hljs-keyword"><span class="hljs-keyword">ENGINE</span></span> = <span class="hljs-keyword"><span class="hljs-keyword">Distributed</span></span>( sharovara, testshara, anysumming_sharded , <span class="hljs-keyword"><span class="hljs-keyword">rand</span></span>() )</code> </pre> <br><p>  The advantage of this configuration: </p><br><ul><li>  Since in this configuration there are 4 shards, a SELECT query can be executed simultaneously in parallel on all nodes of the cluster. </li></ul><br><p>  Disadvantage: </p><br><ul><li>  The least reliable way to store data (loss of a node leads to the loss of a portion of data). </li></ul><br><h3 id="dva-sharda-po-dve-repliki">  Two shard two replicas </h3><br><p><img src="https://habrastorage.org/files/d0d/766/d01/d0d766d019724159bc0896bcafad3da5.png" alt="Two shard two replicas"></p><br><pre> <code class="xml hljs"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">remote_servers</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-comment"><span class="hljs-comment">&lt;!-- Two shards, two replica --&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">pulse</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-comment"><span class="hljs-comment">&lt;!-- shard 01 --&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">shard</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-comment"><span class="hljs-comment">&lt;!-- replica 01_01 --&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">replica</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">host</span></span></span><span class="hljs-tag">&gt;</span></span>ch63.smi2<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">host</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">replica</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-comment"><span class="hljs-comment">&lt;!-- replica 01_02 --&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">replica</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">host</span></span></span><span class="hljs-tag">&gt;</span></span>ch64.smi2<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">host</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">replica</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">shard</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-comment"><span class="hljs-comment">&lt;!-- shard 02 --&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">shard</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-comment"><span class="hljs-comment">&lt;!-- replica 02_01 --&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">replica</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">host</span></span></span><span class="hljs-tag">&gt;</span></span>ch65.smi2<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">host</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">replica</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-comment"><span class="hljs-comment">&lt;!-- replica 02_02 --&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">replica</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">host</span></span></span><span class="hljs-tag">&gt;</span></span>ch66.smi2<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">host</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">replica</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">shard</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">pulse</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">remote_servers</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre> <br><p>  An example of a SQL query to create a table for the specified configuration: </p><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DATABASE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">IF</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">EXISTS</span></span> dbpulse ; <span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">IF</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">EXISTS</span></span> dbpulse.normal_summing_sharded ( event_date <span class="hljs-built_in"><span class="hljs-built_in">Date</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DEFAULT</span></span> toDate(event_time), event_time DateTime <span class="hljs-keyword"><span class="hljs-keyword">DEFAULT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">now</span></span>(), body_id Int32, views Int32 ) <span class="hljs-keyword"><span class="hljs-keyword">ENGINE</span></span> = ReplicatedSummingMergeTree(<span class="hljs-string"><span class="hljs-string">'/clickhouse/tables/{pulse_replica}/pulse/normal_summing_sharded'</span></span>, <span class="hljs-string"><span class="hljs-string">'{replica}'</span></span>, event_date, (event_date, event_time, body_id), <span class="hljs-number"><span class="hljs-number">8192</span></span>) ; <span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">IF</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">EXISTS</span></span> dbpulse.normal_summing <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> dbpulse.normal_summing_sharded <span class="hljs-keyword"><span class="hljs-keyword">ENGINE</span></span> = <span class="hljs-keyword"><span class="hljs-keyword">Distributed</span></span>( pulse, dbpulse, normal_summing_sharded , <span class="hljs-keyword"><span class="hljs-keyword">rand</span></span>() )</code> </pre> <br><p>  This configuration embodies the best qualities of the first and second examples: </p><br><ul><li>  Since in this configuration there are 2 shards, a SELECT query can be executed in parallel on each of the shards in the cluster. </li><li>  A relatively reliable way to store data (the loss of a single cluster node does not lead to the loss of a piece of data). </li></ul><br><h2 id="primer-konfiguracii-klasterov-v-ansible">  An example of cluster configuration in ansible </h2><br><p>  The cluster configuration in <a href="http://docs.ansible.com/ansible/index.html">ansible</a> may look like this: </p><br><pre> <code class="hljs css"><span class="hljs-selector-tag"><span class="hljs-selector-tag">-</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">name</span></span>: "<span class="hljs-selector-tag"><span class="hljs-selector-tag">pulse</span></span>" <span class="hljs-selector-tag"><span class="hljs-selector-tag">shards</span></span>: <span class="hljs-selector-tag"><span class="hljs-selector-tag">-</span></span> { <span class="hljs-attribute"><span class="hljs-attribute">name</span></span>: <span class="hljs-string"><span class="hljs-string">"01"</span></span>, replicas: [<span class="hljs-string"><span class="hljs-string">"ch63.smi2"</span></span>, <span class="hljs-string"><span class="hljs-string">"ch64.smi2"</span></span>]} <span class="hljs-selector-tag"><span class="hljs-selector-tag">-</span></span> { <span class="hljs-attribute"><span class="hljs-attribute">name</span></span>: <span class="hljs-string"><span class="hljs-string">"02"</span></span>, replicas: [<span class="hljs-string"><span class="hljs-string">"ch65.smi2"</span></span>, <span class="hljs-string"><span class="hljs-string">"ch66.smi2"</span></span>]} <span class="hljs-selector-tag"><span class="hljs-selector-tag">-</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">name</span></span>: "<span class="hljs-selector-tag"><span class="hljs-selector-tag">sharovara</span></span>" <span class="hljs-selector-tag"><span class="hljs-selector-tag">shards</span></span>: <span class="hljs-selector-tag"><span class="hljs-selector-tag">-</span></span> { <span class="hljs-attribute"><span class="hljs-attribute">name</span></span>: <span class="hljs-string"><span class="hljs-string">"01"</span></span>, replicas: [<span class="hljs-string"><span class="hljs-string">"ch63.smi2"</span></span>]} <span class="hljs-selector-tag"><span class="hljs-selector-tag">-</span></span> { <span class="hljs-attribute"><span class="hljs-attribute">name</span></span>: <span class="hljs-string"><span class="hljs-string">"02"</span></span>, replicas: [<span class="hljs-string"><span class="hljs-string">"ch64.smi2"</span></span>]} <span class="hljs-selector-tag"><span class="hljs-selector-tag">-</span></span> { <span class="hljs-attribute"><span class="hljs-attribute">name</span></span>: <span class="hljs-string"><span class="hljs-string">"03"</span></span>, replicas: [<span class="hljs-string"><span class="hljs-string">"ch65.smi2"</span></span>]} <span class="hljs-selector-tag"><span class="hljs-selector-tag">-</span></span> { <span class="hljs-attribute"><span class="hljs-attribute">name</span></span>: <span class="hljs-string"><span class="hljs-string">"04"</span></span>, replicas: [<span class="hljs-string"><span class="hljs-string">"ch66.smi2"</span></span>]} <span class="hljs-selector-tag"><span class="hljs-selector-tag">-</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">name</span></span>: "<span class="hljs-selector-tag"><span class="hljs-selector-tag">repikator</span></span>" <span class="hljs-selector-tag"><span class="hljs-selector-tag">shards</span></span>: <span class="hljs-selector-tag"><span class="hljs-selector-tag">-</span></span> { <span class="hljs-attribute"><span class="hljs-attribute">name</span></span>: <span class="hljs-string"><span class="hljs-string">"01"</span></span>, replicas: [<span class="hljs-string"><span class="hljs-string">"ch63.smi2"</span></span>, <span class="hljs-string"><span class="hljs-string">"ch64.smi2"</span></span>,<span class="hljs-string"><span class="hljs-string">"ch65.smi2"</span></span>, <span class="hljs-string"><span class="hljs-string">"ch66.smi2"</span></span>]}</code> </pre> <br><h2 id="php-drayver-dlya-raboty-s-clickhouse-klasterom">  PHP-driver for working with ClickHouse-cluster </h2><br><p>  In the previous <a href="https://habrahabr.ru/company/smi2/blog/314558/">article,</a> we already talked about our open-source <a href="https://github.com/smi2/phpClickHouse">PHP driver</a> for ClickHouse. </p><br><p>  When the number of nodes becomes large, cluster management becomes inconvenient.  Therefore, we have developed a simple and fairly functional tool for migrating DDL queries to a ClickHouse cluster.  Next, we briefly describe with examples its capabilities. </p><br><p>  To connect to the cluster, the class <code>ClickHouseDB\Cluster</code> : </p><br><pre> <code class="php hljs">$cl = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ClickHouseDB\Cluster( [<span class="hljs-string"><span class="hljs-string">'host'</span></span>=&gt;<span class="hljs-string"><span class="hljs-string">'allclickhouse.smi2'</span></span>,<span class="hljs-string"><span class="hljs-string">'port'</span></span>=&gt;<span class="hljs-string"><span class="hljs-string">'8123'</span></span>,<span class="hljs-string"><span class="hljs-string">'username'</span></span>=&gt;<span class="hljs-string"><span class="hljs-string">'x'</span></span>,<span class="hljs-string"><span class="hljs-string">'password'</span></span>=&gt;<span class="hljs-string"><span class="hljs-string">'x'</span></span>] );</code> </pre><br><p>  The <code>allclickhouse.smi2</code> DNS records list the IP addresses of all sites: <code>ch63.smi2, ch64.smi2, ch65.smi2, ch66.smi2</code> , which allows using the <a href="https://en.wikipedia.org/wiki/Round-robin_DNS">Round-robin DNS</a> mechanism. </p><br><p>  The driver connects to the cluster and sends ping requests to each node listed in the DNS records. </p><br><p>  Setting the maximum connection time to all nodes in the cluster is configured as follows: </p><br><pre> <code class="php hljs">$cl-&gt;setScanTimeOut(<span class="hljs-number"><span class="hljs-number">2.5</span></span>); <span class="hljs-comment"><span class="hljs-comment">// 2500 ms</span></span></code> </pre><br><p>  Checking the status of cluster replicas is performed as follows: </p><br><pre> <code class="php hljs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!$cl-&gt;isReplicasIsOk()) { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Exception</span></span>(<span class="hljs-string"><span class="hljs-string">'Replica state is bad , error='</span></span>.$cl-&gt;getError()); }</code> </pre><br><p>  The status of the ClickHouse cluster is checked as follows: </p><br><ul><li>  Connections are checked against all cluster nodes listed in the DNS records. </li><li>  A <a href="https://clickhouse.yandex/reference_ru.html">SQL query is</a> sent to each node, which allows you to determine the status of all replicas of the ClickHouse cluster. </li></ul><br><p>  The speed of the query can be increased if you do not read the values ‚Äã‚Äãof the <code>log_max_index, log_pointer, total_replicas, active_replicas</code> when retrieving data from which queries are made to the ZK cluster. </p><br><p>  For a light check in the driver, you need to set a special flag: </p><br><pre> <code class="php hljs">$cl-&gt;setSoftCheck(<span class="hljs-keyword"><span class="hljs-keyword">true</span></span>);</code> </pre><br><p>  Listing all available clusters is done as follows: </p><br><pre> <code class="php hljs">print_r($cl-&gt;getClusterList()); <span class="hljs-comment"><span class="hljs-comment">// result // [0] =&gt; pulse // [1] =&gt; repikator // [2] =&gt; sharovara</span></span></code> </pre> <br><p>  For example, to obtain the configuration of the clusters that were described above, you can do this: </p><br><pre> <code class="php hljs"><span class="hljs-keyword"><span class="hljs-keyword">foreach</span></span> ([<span class="hljs-string"><span class="hljs-string">'pulse'</span></span>,<span class="hljs-string"><span class="hljs-string">'repikator'</span></span>,<span class="hljs-string"><span class="hljs-string">'sharovara'</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> $name) { print_r($cl-&gt;getClusterNodes($name)); <span class="hljs-keyword"><span class="hljs-keyword">echo</span></span> <span class="hljs-string"><span class="hljs-string">"&gt; $name , count shard = "</span></span>.$cl-&gt;getClusterCountShard($name).<span class="hljs-string"><span class="hljs-string">" ; count replica = "</span></span>.$cl-&gt;getClusterCountReplica($name).<span class="hljs-string"><span class="hljs-string">"\n"</span></span>; } <span class="hljs-comment"><span class="hljs-comment">//: //&gt; pulse , count shard = 2 ; count replica = 2 //&gt; repikator , count shard = 1 ; count replica = 4 //&gt; sharovara , count shard = 4 ; count replica = 1</span></span></code> </pre><br><p>  Obtaining a list of nodes by cluster name or from shard tables: </p><br><pre> <code class="php hljs">$nodes=$cl-&gt;getNodesByTable(<span class="hljs-string"><span class="hljs-string">'sharovara.body_views_sharded'</span></span>); $nodes=$cl-&gt;getClusterNodes(<span class="hljs-string"><span class="hljs-string">'sharovara'</span></span>);</code> </pre><br><p>  Getting the size of the table or the size of all tables by sending a request to each node of the cluster: </p><br><pre> <code class="php hljs"><span class="hljs-keyword"><span class="hljs-keyword">foreach</span></span> ($nodes <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> $node) { <span class="hljs-keyword"><span class="hljs-keyword">echo</span></span> <span class="hljs-string"><span class="hljs-string">"$node &gt; \n"</span></span>; print_r($cl-&gt;client($node)-&gt;tableSize(<span class="hljs-string"><span class="hljs-string">'test_sharded'</span></span>)); print_r($cl-&gt;client($node)-&gt;tablesSize()); } <span class="hljs-comment"><span class="hljs-comment">//    $cl-&gt;getSizeTable('dbName.tableName');</span></span></code> </pre><br><p>  Getting a list of cluster tables: </p><br><pre> <code class="php hljs">$cl-&gt;getTables()</code> </pre> <br><p>  Cluster leader definition: </p><br><pre> <code class="php hljs">$cl-&gt;getMasterNodeForTable(<span class="hljs-string"><span class="hljs-string">'dbName.tableName'</span></span>) <span class="hljs-comment"><span class="hljs-comment">//     is_leader=1</span></span></code> </pre><br><p>  Requests related, for example, to deleting or changing the structure, are sent to a node with the <code>is_leader</code> flag <code>is_leader</code> . </p><br><p>  Clearing data in a table in a cluster: </p><br><pre> <code class="php hljs">$cl-&gt;truncateTable(<span class="hljs-string"><span class="hljs-string">'dbName.tableName'</span></span>)`</code> </pre> <br><h2 id="instrument-migracii-ddl-zaprosov">  DDL Migration Tool </h2><br><p>  For the migration of DDL queries for relational DBMS in our company, <a href="http://www.mybatis.org/migrations/">MyBatis Migrations is used</a> . </p><br><p>  About tools of migration on Habr√© already wrote: </p><br><ul><li>  <a href="https://habrahabr.ru/post/121265/">Versional migration of database structure: basic approaches</a> </li><li>  <a href="https://habrahabr.ru/post/315254/">Simple migrations with PHPixie Migrate</a> </li><li>  <a href="https://habrahabr.ru/post/129290/">Managing migration scripts or MyBatis Scheme Migration Extended</a> </li></ul><br><p>  To work with ClickHouse-cluster, we needed a similar tool. </p><br><p>  At the time of this writing, ClickHouse has a number of features (limitations) associated with DDL queries.  <a href="https://clickhouse.yandex/reference_ru.html">Quote</a> : </p><br><blockquote>  INSERT, ALTER are replicated (see details in the ALTER query description).  Compressed data is replicated, not the query text.  CREATE, DROP, ATTACH, DETACH, RENAME requests are not replicated ‚Äî that is, they belong to the same server.  The CREATE TABLE query creates a new replicable table on the server where the query is being executed;  and if on other servers such a table already exists, it adds a new replica.  The DROP TABLE query deletes the replica located on the server where the query is executed.  The RENAME query renames the table on one of the replicas ‚Äî that is, the replicated tables on different replicas may be called differently. </blockquote><p>  The ClickHouse development team has already announced work in this direction, but at present it is necessary to solve this problem with an external toolkit.  We have created a simple prototype of the <a href="https://github.com/smi2/phpMigrationsClickhouse">phpMigrationsClickhouse</a> tool for migrating DDL requests to the ClickHouse cluster.  And in our plans - to abstract <em>phpMigrationsClickhouse</em> from the PHP language. </p><br><p>  We describe the algorithm currently used in <em>phpMigrationsClickhouse</em> , which can be implemented in any other programming language. </p><br><p>  Currently, the migration instruction for <em>phpMigrationsClickhouse</em> consists of: </p><br><ul><li>  SQL queries that need to be rolled and rolled back in case of an error; </li><li>  name of the cluster in which you want to execute SQL queries. </li></ul><br><p>  Create a PHP file containing the following code: </p><br><pre> <code class="php hljs">$cluster_name = <span class="hljs-string"><span class="hljs-string">'pulse'</span></span>; $mclq = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> \ClickHouseDB\Cluster\Migration($cluster_name); $mclq-&gt;setTimeout(<span class="hljs-number"><span class="hljs-number">100</span></span>);</code> </pre> <br><p>  Add SQL queries that need to be rolled: </p><br><pre> <code class="php hljs">$mclq-&gt;addSqlUpdate(<span class="hljs-string"><span class="hljs-string">" CREATE DATABASE IF NOT EXISTS dbpulse "</span></span>); $mclq-&gt;addSqlUpdate(<span class="hljs-string"><span class="hljs-string">" CREATE TABLE IF NOT EXISTS dbpulse.normal_summing_sharded ( event_date Date DEFAULT toDate(event_time), event_time DateTime DEFAULT now(), body_id Int32, views Int32 ) ENGINE = ReplicatedSummingMergeTree('/clickhouse/tables/{pulse_replica}/pulse/normal_summing_sharded', '{replica}', event_date, (event_date, event_time, body_id), 8192) "</span></span>);</code> </pre> <br><p>  Add SQL queries to perform rollback in case of error: </p><br><pre> <code class="php hljs">$mclq-&gt;addSqlDowngrade(<span class="hljs-string"><span class="hljs-string">' DROP TABLE IF EXISTS dbpulse.normal_summing_sharded '</span></span>); $mclq-&gt;addSqlDowngrade(<span class="hljs-string"><span class="hljs-string">' DROP DATABASE IF EXISTS dbpulse '</span></span>);</code> </pre> <br><p>  There are 2 strategies for rolling migrations: </p><br><ul><li>  sending each separate SQL query to one server with the transition to the next SQL query; </li><li>  sending all SQL queries to one server with the transition to the next server. </li></ul><br><p>  If an error occurs, the following options are possible: </p><br><ul><li>  execution of a downgrade request for all nodes on which upgrade-requests have already been made; </li><li>  waiting before sending upgrade requests to other servers; </li><li>  execution of downgrade request on all servers in case of an error. </li></ul><br><p>  A separate place is occupied by errors when the cluster status is not known: </p><br><ul><li>  connection timeout error; </li><li>  communication error with the server. </li></ul><br><p>  The principle of the PHP code when migrating is as follows: </p><br><pre> <code class="php hljs"><span class="hljs-comment"><span class="hljs-comment">//   IP-   $node_hosts=$this-&gt;getClusterNodes($migration-&gt;getClusterName()); //  downgrade- $sql_down=$migration-&gt;getSqlDowngrade(); //  upgrade- $sql_up=$migration-&gt;getSqlUpdate(); //  upgrade-    ,   ,  downgrade- $need_undo=false; $undo_ip=[]; foreach ($sql_up as $s_u) { foreach ($node_hosts as $node) { //  upgrade- $state=$this-&gt;client($node)-&gt;write($s_u); if ($state-&gt;isError()) { $need_undo = true; } else { // OK } if ($need_undo) { //   ,    $undo_ip[$node]=1; break; } } } //    upgrade-     if (!$need_undo) { return true; // OK }</span></span></code> </pre> <br><p>  In case of an error, a downgrade request is sent to all nodes of the cluster: </p><br><pre> <code class="php hljs"><span class="hljs-keyword"><span class="hljs-keyword">foreach</span></span> ($node_hosts <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> $node) { <span class="hljs-keyword"><span class="hljs-keyword">foreach</span></span> ($sql_down <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> $s_u) { <span class="hljs-keyword"><span class="hljs-keyword">try</span></span>{ $st=<span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;client($node)-&gt;write($s_u); } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">Exception</span></span> $E) { <span class="hljs-comment"><span class="hljs-comment">//       downgrade- } } }</span></span></code> </pre> <br><p>  We will continue the series of materials dedicated to our experience with ClickHouse. </p><br><p>  In conclusion, we would like to conduct a short survey. </p></div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <p>Source: <a href="https://habr.com/ru/post/317682/">https://habr.com/ru/post/317682/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../317672/index.html">Code optimization for the Elbrus platform using simple examples</a></li>
<li><a href="../317674/index.html">Forecasts for 2017: less malware, but more effective attacks</a></li>
<li><a href="../317676/index.html">The final version of Vivaldi 1.6 - working with tabs</a></li>
<li><a href="../317678/index.html">[Peter] Dmitry Chuiko - JEP 295: Ahead-of-Time compilation for HotSpot</a></li>
<li><a href="../317680/index.html">How to make a different time zone in different databases on the same server</a></li>
<li><a href="../317684/index.html">Do you have Wi-Fi here?</a></li>
<li><a href="../317686/index.html">Around Citrix NetScaler ADC - Part 2. Citrix and Microsoft</a></li>
<li><a href="../317688/index.html">As I alone made the game and conclusions</a></li>
<li><a href="../317690/index.html">Webinar: Introduction to Data Science</a></li>
<li><a href="../317694/index.html">How I visited HolyJS Moscow and do I need to go there</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>