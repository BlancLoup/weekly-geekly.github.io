<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Learn bash scripts, write Quadronix</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="On Habr√© there are already a lot of articles about bash games, these are Chess , Xonix , Sokoban , Battleship and even Pseudo-3D Shooter . But in all ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Learn bash scripts, write Quadronix</h1><div class="post__text post__text-html js-mediator-article"> On Habr√© there are already a lot of articles about bash games, these are <a href="http://habrahabr.ru/blogs/crazydev/128549/">Chess</a> , <a href="http://habrahabr.ru/blogs/linux/122029/">Xonix</a> , <a href="http://habrahabr.ru/blogs/linux/120198">Sokoban</a> , <a href="http://habrahabr.ru/blogs/crazydev/80122/">Battleship</a> and even <a href="http://habrahabr.ru/blogs/crazydev/130021/">Pseudo-3D Shooter</a> .  But in all these games, the control takes place using the keyboard.  We will go ahead and write the game on bash, the control in which will be carried out using the mouse.  And at the same time we will analyze how to make the game resistant to resizing the terminal.  So, let's write the game Quadronix. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/c9a/a9b/686/c9aa9b6865dcf9538c6e7762301ae961.png"><br><br><a name="habracut"></a>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      I saw the Quadronix game for the first time with my brother on the phone several years ago, and I immediately liked playing it.  But since my brother almost did not give me my phone, I, without hesitation, implemented a clone of the game in the form of a Java applet, while I was studying Java. <br><br>  And now, seeing that <a href="http://habrahabr.ru/blogs/crazydev/131331/">processor emulators</a> and <a href="http://habrahabr.ru/blogs/crazydev/130021/">3D games</a> are already being done on bash, I realized that my Xonix implementation on bash is already past century, and I need to move on.  And I thought that implementing Quadronix on bash would be a good warm-up for the brain. <br><br>  The rules of the game are simple.  It is necessary to find rectangles, all four vertices of which are of the same color.  In order to remove such a rectangle, you need to click on the diagonally opposite vertices. <img src="https://habrastorage.org/getpro/habr/post_images/c64/635/46e/c6463546e0eb7e7f5a11ec7fab76a3bb.png" align="right">  At the same time, the number of points added per rectangle is proportional to its area.  And in the place of the destroyed rectangle, new squares of random color will appear.  The game is played for a while, and to make it more interesting to play, then the more points, the faster the time decreases.  Also, if a player makes a mistake with the choice of a rectangle, a penalty is deducted from the rest of the time.  Finally, in order to cancel the selection of an incorrectly marked vertex, click on it again. <br><br>  It is clear that it is not interesting to play such a game without a mouse.  Well, we realize the mouse.  We read <code>man console_codes</code> and there we find that the escape sequence <code>ESC [ ? 9 h</code>  <code>ESC [ ? 9 h</code> includes mouse tracking mode, <br>  and the escape sequence <code>ESC [ ? 9 l</code>  <code>ESC [ ? 9 l</code> turns this mode off. <br>  When tracking mode is turned on, when the state of the mouse changes, control sequences describing the state of the mouse will be written to the input stream of the console.  They have the format <code>ESC [ M bxy</code> , where in <code>b</code> will be information about the pressed button and modifier keys, and in <code>x</code> and <code>y</code> - information about the coordinates of the mouse.  The symbol <code>b</code> is not interesting to us.  And to get the coordinates of the mouse, you need to subtract <code>32</code> from both <code>x</code> and <code>y</code> . <br><br>  But not the easiest bash task to do is get the character code.  The simplest, in my opinion, the team will be the following, obtained through experiments: <br><pre> <code class="hljs perl">LC_ALL=C <span class="hljs-keyword"><span class="hljs-keyword">printf</span></span> -v code <span class="hljs-string"><span class="hljs-string">'%d'</span></span> <span class="hljs-string"><span class="hljs-string">"'$data"</span></span></code> </pre> <br>  Here you should pay attention to the single unmatched quotation mark before the dollar sign.  It simply means that it will not be the next character displayed, but its code.  And <code>LC_ALL=C</code> requires that a character with a code greater than 127 is interpreted by itself, and not as part of a multibyte character. <br><br>  So, we will write the following script. <br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#!/bin/bash declare -i mouseX declare -i mouseY declare -i mouseButton declare -r ESC_CODE=$'\e' declare -r EXIT_CODE='x' printMouseInfo() { echo button=$mouseButton column=$mouseX row=$mouseY } readMouse() { local mouseButtonData local mouseXData local mouseYData read -r -s -n 1 -t 1 mouseButtonData read -r -s -n 1 -t 1 mouseXData read -r -s -n 1 -t 1 mouseYData local -i mouseButtonCode local -i mouseXCode local -i mouseYCode LC_ALL=C printf -v mouseButtonCode '%d' "'$mouseButtonData" LC_ALL=C printf -v mouseXCode '%d' "'$mouseXData" LC_ALL=C printf -v mouseYCode '%d' "'$mouseYData" ((mouseButton = mouseButtonCode)) ((mouseX = mouseXCode - 32)) ((mouseY = mouseYCode - 32)) } declare key echo -ne "\e[?9h" while true; do key="" read -r -s -t 1 -n 1 key case "$key" in $EXIT_CODE) break;; $ESC_CODE) read -r -s -t 1 -n 1 key if [[ "$key" == '[' ]]; then read -r -s -t 1 -n 1 key if [[ "$key" == "M" ]]; then readMouse printMouseInfo fi fi;; esac done echo -ne "\e[?9l"</span></span></code> </pre><br><br>  Not to say that this is the right way, but it works: <br><pre> <code class="hljs pgsql">$ ./mouse.sh button=<span class="hljs-number"><span class="hljs-number">0</span></span> column=<span class="hljs-number"><span class="hljs-number">46</span></span> <span class="hljs-keyword"><span class="hljs-keyword">row</span></span>=<span class="hljs-number"><span class="hljs-number">17</span></span> button=<span class="hljs-number"><span class="hljs-number">0</span></span> column=<span class="hljs-number"><span class="hljs-number">61</span></span> <span class="hljs-keyword"><span class="hljs-keyword">row</span></span>=<span class="hljs-number"><span class="hljs-number">19</span></span> button=<span class="hljs-number"><span class="hljs-number">0</span></span> column=<span class="hljs-number"><span class="hljs-number">64</span></span> <span class="hljs-keyword"><span class="hljs-keyword">row</span></span>=<span class="hljs-number"><span class="hljs-number">15</span></span> button=<span class="hljs-number"><span class="hljs-number">0</span></span> column=<span class="hljs-number"><span class="hljs-number">59</span></span> <span class="hljs-keyword"><span class="hljs-keyword">row</span></span>=<span class="hljs-number"><span class="hljs-number">11</span></span> button=<span class="hljs-number"><span class="hljs-number">0</span></span> column=<span class="hljs-number"><span class="hljs-number">43</span></span> <span class="hljs-keyword"><span class="hljs-keyword">row</span></span>=<span class="hljs-number"><span class="hljs-number">9</span></span> button=<span class="hljs-number"><span class="hljs-number">0</span></span> column=<span class="hljs-number"><span class="hljs-number">36</span></span> <span class="hljs-keyword"><span class="hljs-keyword">row</span></span>=<span class="hljs-number"><span class="hljs-number">10</span></span> button=<span class="hljs-number"><span class="hljs-number">0</span></span> column=<span class="hljs-number"><span class="hljs-number">42</span></span> <span class="hljs-keyword"><span class="hljs-keyword">row</span></span>=<span class="hljs-number"><span class="hljs-number">17</span></span> button=<span class="hljs-number"><span class="hljs-number">0</span></span> column=<span class="hljs-number"><span class="hljs-number">63</span></span> <span class="hljs-keyword"><span class="hljs-keyword">row</span></span>=<span class="hljs-number"><span class="hljs-number">23</span></span> button=<span class="hljs-number"><span class="hljs-number">0</span></span> column=<span class="hljs-number"><span class="hljs-number">75</span></span> <span class="hljs-keyword"><span class="hljs-keyword">row</span></span>=<span class="hljs-number"><span class="hljs-number">22</span></span> button=<span class="hljs-number"><span class="hljs-number">0</span></span> column=<span class="hljs-number"><span class="hljs-number">91</span></span> <span class="hljs-keyword"><span class="hljs-keyword">row</span></span>=<span class="hljs-number"><span class="hljs-number">19</span></span> $</code> </pre> <br>  If you use the escape sequence <code>ESC [ ? 1000 h</code>  <code>ESC [ ? 1000 h</code> , then you can get information about clicking and releasing the mouse buttons. <br><br>  Now let's look at how to make the script less frail by user actions using signals. <br><br>  The first thing you want to do is call the <code>reset</code> command, if you press Ctrl + C while the script is running.  This is very convenient when developing, since we use colors in the game and suppress user input, and if the script is interrupted, until you randomly <code>reset</code> , the terminal will be in a state completely unsuitable for work. <br><br>  In order to execute some code when receiving a signal, the <code>trap</code> command is used: <br><pre> <code class="hljs nginx"><span class="hljs-attribute"><span class="hljs-attribute">trap</span></span>  </code> </pre> <br>  The possible values ‚Äã‚Äãof the <code></code> parameter can be found by typing <code>trap -l</code> .  If the <code></code> parameter is not present, the default action will be set.  If you specify <code>EXIT</code> as the <code></code> parameter, the specified command will be executed upon completion of the script, and this is what we need.  We write: <br><br><pre> <code class="bash hljs"><span class="hljs-keyword"><span class="hljs-keyword">function</span></span> <span class="hljs-function"><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">initApplication</span></span></span></span>() { stty -<span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> <span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> -ne <span class="hljs-variable"><span class="hljs-variable">$HIDE_CURSOR_CODE</span></span> <span class="hljs-built_in"><span class="hljs-built_in">trap</span></span> finishApplication EXIT ... } <span class="hljs-keyword"><span class="hljs-keyword">function</span></span> <span class="hljs-function"><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">finishApplication</span></span></span></span>() { <span class="hljs-built_in"><span class="hljs-built_in">trap</span></span> EXIT reset } initApplication runApplication finishApplication</code> </pre><br><br>  The second case when we need signal handlers is a window resizing.  If, for example, open the window, or vice versa, all our beautiful graphics crawl, but do not really want to.  To find out that the size of the terminal window has changed, you can use the <code>SIGWINCH</code> signal: <br><pre> <code class="bash hljs"><span class="hljs-keyword"><span class="hljs-keyword">function</span></span> <span class="hljs-function"><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">repaint</span></span></span></span>() { LINES=`tput lines` COLUMNS=`tput cols` mapXPosition=$(((COLUMNS - CELL_WIDTH * MAP_WIDTH) / 2 + 1)) mapYPosition=$(((LINES - CELL_HEIGHT * MAP_HEIGHT) / 2 + 1)) timerXPosition=$((MAP_WIDTH * CELL_WIDTH + mapXPosition + 6)) timerYPosition=$((mapYPosition)) <span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> -ne <span class="hljs-string"><span class="hljs-string">"\e[0m"</span></span> clear drawMap drawHeader drawFooter ((isInvalidated = 0)) } <span class="hljs-keyword"><span class="hljs-keyword">function</span></span> <span class="hljs-function"><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">initApplication</span></span></span></span>() { ... <span class="hljs-built_in"><span class="hljs-built_in">trap</span></span> <span class="hljs-string"><span class="hljs-string">"((isInvalidated = 1))"</span></span> SIGWINCH } <span class="hljs-keyword"><span class="hljs-keyword">function</span></span> <span class="hljs-function"><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">runGame</span></span></span></span>() { <span class="hljs-built_in"><span class="hljs-built_in">local</span></span> key ... <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> <span class="hljs-literal"><span class="hljs-literal">true</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ((isInvalidated)); <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> repaint <span class="hljs-keyword"><span class="hljs-keyword">fi</span></span> ... key=<span class="hljs-string"><span class="hljs-string">""</span></span> ... <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$key</span></span></span><span class="hljs-string">"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> <span class="hljs-variable"><span class="hljs-variable">$NEW_GAME_CODE</span></span>) <span class="hljs-built_in"><span class="hljs-built_in">continue</span></span> 2;; <span class="hljs-variable"><span class="hljs-variable">$EXIT_CODE</span></span>) <span class="hljs-built_in"><span class="hljs-built_in">break</span></span> 2;; <span class="hljs-variable"><span class="hljs-variable">$ESC_CODE</span></span>) ... <span class="hljs-keyword"><span class="hljs-keyword">esac</span></span> ... <span class="hljs-keyword"><span class="hljs-keyword">done</span></span> }</code> </pre><br><br>  I note that if you specify <code>DEBUG</code> as a <code></code> , then the specified command will be executed after each script command, sometimes it is useful when debugging. <br><br>  Well, now the link to the script code: <a href="">quadronix.sh</a> . <br><br>  And finally, I‚Äôll say that <code>man bash</code> , <code>man console_codes</code> and ABS can be read endlessly, and each time discovering newer and newer facets of bash programming. </div><p>Source: <a href="https://habr.com/ru/post/131921/">https://habr.com/ru/post/131921/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../131916/index.html">Redis, hiredis, libev and multithread. Part 1</a></li>
<li><a href="../131917/index.html">Competition for the creation of HTML5 applications with a prize pool of $ 50,000</a></li>
<li><a href="../131918/index.html">Difficult questions - simple answers or not an ordinary question and answer service</a></li>
<li><a href="../131919/index.html">Macros in Scala, Eugene Burmaco. Screencast, slides and photo with scalaby # 6</a></li>
<li><a href="../131920/index.html">PhpBB 3 spam protection without captcha</a></li>
<li><a href="../131922/index.html">DIY preamp in A class. Clone Lehmann BCL</a></li>
<li><a href="../131923/index.html">New version of Kinect for Windows SDK, new website and blog for developers released</a></li>
<li><a href="../131925/index.html">Online UML editor</a></li>
<li><a href="../131926/index.html">Why Agile doesn't suit you</a></li>
<li><a href="../131929/index.html">Apple infringed two Motorola Mobility patents. Apple may be banned in the EU</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>