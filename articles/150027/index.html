<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Practice refactoring in large projects</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Some time ago I got into game dev, where I ran into projects of 2 million lines of code written by dozens of programmers. At such a scale of the code ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Practice refactoring in large projects</h1><div class="post__text post__text-html js-mediator-article">  Some time ago I got into game dev, where I ran into projects of 2 million lines of code written by dozens of programmers.  At such a scale of the code base, problems of a previously unknown nature arise.  I want to tell you about one of them now. <br><br>  So imagine the following situation.  It just so happens that you need to refactor a very large piece of code, the whole subsystem.  Rows, commercials, at 200K.  Moreover, refactoring clearly looks very large, affecting the basic concepts by which your subsystem is built.  In fact, it is necessary to rewrite the entire architecture, preserving the business logic.  This happens if, for example, you have done one project and you have a new one ahead, and you want to correct all the mistakes of the past in it.  Suppose, according to first estimates, it is necessary to refactor month 2, no less.  In the process of refactoring, everything should work, including not to prevent other programmers from adding new features and fixing bugs in the subsystem.  Often, such refactoring is how complicated, that it is absolutely impossible to freeze the old code into a new one, and also it is impossible to roll out the result in parts.  In fact, you need to replace the engine of the aircraft on the fly. <br><br>  Examples from the practice, both mine and my colleagues: <br><ul><li>  Redo all database work from pure JDBC to Hibernate. </li><li>  Transform the service architecture from sending-receiving messages to remote procedure call (RPC). </li><li>  Completely rewrite the XML file translation subsystem into runtime objects. </li></ul>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      What to do?  Which way to approach the problem?  Below is a set of tips and practices that help us deal with this problem.  First, more general words, and then specific techniques.  In general, nothing supernatural, but someone can help. <br><a name="habracut"></a><br><h5>  Preparing for refactoring </h5><br><ul><li>  Break refactoring apart if possible.  If possible, no problem.  All other tips about what to do if it failed. </li><li>  Try to choose the period when the activity of adding new features to the subsystem will be minimal.  For example, it is convenient to remake the backend, while all the efforts of the team are focused on the frontend. </li><li>  Well read the code, why is it even needed?  What architecture is embedded in the base of the subsystem, what are the standard approaches that were used there.  Clearly define for yourself what the new concept is and what exactly you want to change.  There must be a measurable final goal. </li><li>  Determine the area of ‚Äã‚Äãcode that refactoring will capture.  If possible, isolate it in a separate module / in a separate directory.  This will be very useful in the future. </li><li>  Refactoring without tests is very dangerous.  You must have tests.  How to live without them, I do not know. </li><li>  Run the tests with the calculation of coverage, it will give a lot of information for reflection. </li><li>  Fix broken tests that relate to the desired subsystem. </li><li>  Analyzing information about the coverage of methods you can find and delete unused code.  Oddly enough, this often happens up to 10-15%.  The more code you manage to delete, the less refactoring.  Profit! </li><li>  By coverage, determine which parts of the code are not covered.  It is necessary to add the missing tests.  If unit tests are long and tedious, write at least high-level smke tests. </li><li>  Try to bring coverage up to 80-90% of the meaningful code.  Do not try to cover everything.  Kill a lot of time with little benefit.  Cover at least the main execution path. </li></ul><br><br><h5>  Refactoring </h5><br><ul><li>  Wrap your subsystem interface.  Translate all external code to use this interface.  This not only boosts the use of good programming practices, but also simplifies refactoring. </li><li>  Make sure your tests test the interface, not the implementation. </li><li>  Make it possible at startup to indicate which implementation of this interface to use.  This opportunity needs to be supported both in tests and in production. </li><li>  Record the revision of the version control system on which the writing of the new implementation began.  From this second on, every commit to your old subsystem is your enemy. </li><li>  Write a new implementation of your subsystem interface.  Sometimes you can start from scratch, sometimes you can use a favorite method - copy &amp; paste.  You need to write it in a separate module.  Periodically drive tests on the new implementation.  Your goal is to ensure that all tests pass successfully on a new and old implementation. </li><li>  No need to wait for you to write everything completely.  Fill the code in the repository as often as possible, leaving the old implementation enabled.  If you keep the code in store for a long time, you may experience problems with the fact that other people will refactor the modules you are using.  Simply renaming a method can cause you a lot of problems. </li><li>  Do not forget to write tests specific to the new implementation, if any. </li><li>  After all write, see the history of SVN in the folder with the old code to find what has changed there during your refactoring.  It is necessary to transfer these changes to the new code.  In theory, if you forgot to move something, the tests should catch it. </li><li>  After that, all tests must pass with both the old and the new subsystem. </li><li>  Immediately after you are convinced of the stability of the new version of your module, switch tests and production to it.  Block commits to the old subsystem.  Try by all means to minimize the time of existence of the two subsystems in parallel. </li><li>  Wait a week or two, collect all the baglo, start it and safely remove the old subsystem. </li></ul><br><h5>  Additional tips </h5><br><ul><li>  All new features created in parallel with refactoring should be covered by tests at 100%.  This is necessary so that when switching to a new implementation, the tests drop and signal that the new implementation lacks the code from the old one. </li><li>  Any fix bug should be done according to the principle - first we write a test that will reproduce the problem and fall, then fix it.  The reasons are the same. </li><li>  If you use TeamCity a la system, for the time being refactoring make a separate build, where all the tests on the new subsystem will run.  Automatic build makes your new, not yet used, code "official".  All the same policies and rules are beginning to apply to it as to everything else. </li><li>  It often happens that you don‚Äôt know if you fixed everything that you wanted in the old code for a new architecture.  For example, you don‚Äôt know if your code uses a direct JDBC connection somewhere, instead of Hibernate.  Or suddenly a message slipped somewhere, not an RPC call.  To find such places you need to think of a way to make the old method inoperative.  Those.  break it in tests.  For example, break the message delivery system or slip the system into a non-working JDBC driver.  Practice shows that in this way there are usually at least 5 forgotten and uncorrected places. </li><li>  Talk to other programmers, keep them informed of your progress.  If they know that you have a week left, they can sometimes move their tasks before the release of the new version of your subsystem.  No need to merge changes. </li></ul><br><br>  Experience suggests that even scary and large subsystems can be refactored with relatively little blood.  Your main assistants are tests and systematic. </div><p>Source: <a href="https://habr.com/ru/post/150027/">https://habr.com/ru/post/150027/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../150020/index.html">5 facts about the Chinese gaming market</a></li>
<li><a href="../150021/index.html">Practical metametamodeling</a></li>
<li><a href="../150022/index.html">Downloading price lists of suppliers in the online store</a></li>
<li><a href="../150023/index.html">RedBeanPHP - CodeFirst PHP Framework</a></li>
<li><a href="../150025/index.html">Comparison of client-banks of different eras</a></li>
<li><a href="../150028/index.html">Alarm clock for computer in C #</a></li>
<li><a href="../150030/index.html">CSS slider</a></li>
<li><a href="../150031/index.html">Cach√© + Java + Flex. Part 2</a></li>
<li><a href="../150032/index.html">ATLAS experiment - a simplified description of the task and a bit about the detector</a></li>
<li><a href="../150034/index.html">We implement RESTful Web Service on java</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>